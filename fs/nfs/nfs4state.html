<!DOCTYPE html>
<html><head><title>joekychen/linux » fs › nfs › nfs4state.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>nfs4state.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> *  fs/nfs/nfs4state.c</span>
<span class="cm"> *</span>
<span class="cm"> *  Client-side XDR for NFSv4.</span>
<span class="cm"> *</span>
<span class="cm"> *  Copyright (c) 2002 The Regents of the University of Michigan.</span>
<span class="cm"> *  All rights reserved.</span>
<span class="cm"> *</span>
<span class="cm"> *  Kendrick Smith &lt;kmsmith@umich.edu&gt;</span>
<span class="cm"> *</span>
<span class="cm"> *  Redistribution and use in source and binary forms, with or without</span>
<span class="cm"> *  modification, are permitted provided that the following conditions</span>
<span class="cm"> *  are met:</span>
<span class="cm"> *</span>
<span class="cm"> *  1. Redistributions of source code must retain the above copyright</span>
<span class="cm"> *     notice, this list of conditions and the following disclaimer.</span>
<span class="cm"> *  2. Redistributions in binary form must reproduce the above copyright</span>
<span class="cm"> *     notice, this list of conditions and the following disclaimer in the</span>
<span class="cm"> *     documentation and/or other materials provided with the distribution.</span>
<span class="cm"> *  3. Neither the name of the University nor the names of its</span>
<span class="cm"> *     contributors may be used to endorse or promote products derived</span>
<span class="cm"> *     from this software without specific prior written permission.</span>
<span class="cm"> *</span>
<span class="cm"> *  THIS SOFTWARE IS PROVIDED ``AS IS&#39;&#39; AND ANY EXPRESS OR IMPLIED</span>
<span class="cm"> *  WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF</span>
<span class="cm"> *  MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE</span>
<span class="cm"> *  DISCLAIMED. IN NO EVENT SHALL THE REGENTS OR CONTRIBUTORS BE LIABLE</span>
<span class="cm"> *  FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR</span>
<span class="cm"> *  CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF</span>
<span class="cm"> *  SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR</span>
<span class="cm"> *  BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF</span>
<span class="cm"> *  LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING</span>
<span class="cm"> *  NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS</span>
<span class="cm"> *  SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.</span>
<span class="cm"> *</span>
<span class="cm"> * Implementation of the NFSv4 state model.  For the time being,</span>
<span class="cm"> * this is minimal, but will be made much more complex in a</span>
<span class="cm"> * subsequent patch.</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/fs.h&gt;</span>
<span class="cp">#include &lt;linux/nfs_fs.h&gt;</span>
<span class="cp">#include &lt;linux/nfs_idmap.h&gt;</span>
<span class="cp">#include &lt;linux/kthread.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/random.h&gt;</span>
<span class="cp">#include &lt;linux/ratelimit.h&gt;</span>
<span class="cp">#include &lt;linux/workqueue.h&gt;</span>
<span class="cp">#include &lt;linux/bitops.h&gt;</span>
<span class="cp">#include &lt;linux/jiffies.h&gt;</span>

<span class="cp">#include &quot;nfs4_fs.h&quot;</span>
<span class="cp">#include &quot;callback.h&quot;</span>
<span class="cp">#include &quot;delegation.h&quot;</span>
<span class="cp">#include &quot;internal.h&quot;</span>
<span class="cp">#include &quot;pnfs.h&quot;</span>

<span class="cp">#define NFSDBG_FACILITY		NFSDBG_STATE</span>

<span class="cp">#define OPENOWNER_POOL_SIZE	8</span>

<span class="k">const</span> <span class="n">nfs4_stateid</span> <span class="n">zero_stateid</span><span class="p">;</span>

<span class="k">static</span> <span class="n">LIST_HEAD</span><span class="p">(</span><span class="n">nfs4_clientid_list</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">nfs4_init_clientid</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs_client</span> <span class="o">*</span><span class="n">clp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rpc_cred</span> <span class="o">*</span><span class="n">cred</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfs4_setclientid_res</span> <span class="n">clid</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">clientid</span> <span class="o">=</span> <span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_clientid</span><span class="p">,</span>
		<span class="p">.</span><span class="n">confirm</span> <span class="o">=</span> <span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_confirm</span><span class="p">,</span>
	<span class="p">};</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">port</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">NFS4CLNT_LEASE_CONFIRM</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_state</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">do_confirm</span><span class="p">;</span>
	<span class="n">port</span> <span class="o">=</span> <span class="n">nfs_callback_tcpport</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_addr</span><span class="p">.</span><span class="n">ss_family</span> <span class="o">==</span> <span class="n">AF_INET6</span><span class="p">)</span>
		<span class="n">port</span> <span class="o">=</span> <span class="n">nfs_callback_tcpport6</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">nfs4_proc_setclientid</span><span class="p">(</span><span class="n">clp</span><span class="p">,</span> <span class="n">NFS4_CALLBACK</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">cred</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">clid</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_clientid</span> <span class="o">=</span> <span class="n">clid</span><span class="p">.</span><span class="n">clientid</span><span class="p">;</span>
	<span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_confirm</span> <span class="o">=</span> <span class="n">clid</span><span class="p">.</span><span class="n">confirm</span><span class="p">;</span>
	<span class="n">set_bit</span><span class="p">(</span><span class="n">NFS4CLNT_LEASE_CONFIRM</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_state</span><span class="p">);</span>
<span class="nl">do_confirm:</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">nfs4_proc_setclientid_confirm</span><span class="p">(</span><span class="n">clp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">clid</span><span class="p">,</span> <span class="n">cred</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="n">clear_bit</span><span class="p">(</span><span class="n">NFS4CLNT_LEASE_CONFIRM</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_state</span><span class="p">);</span>
	<span class="n">nfs4_schedule_state_renewal</span><span class="p">(</span><span class="n">clp</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">rpc_cred</span> <span class="o">*</span><span class="nf">nfs4_get_machine_cred_locked</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs_client</span> <span class="o">*</span><span class="n">clp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rpc_cred</span> <span class="o">*</span><span class="n">cred</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_machine_cred</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">cred</span> <span class="o">=</span> <span class="n">get_rpccred</span><span class="p">(</span><span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_machine_cred</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">cred</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">nfs4_clear_machine_cred</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs_client</span> <span class="o">*</span><span class="n">clp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rpc_cred</span> <span class="o">*</span><span class="n">cred</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_lock</span><span class="p">);</span>
	<span class="n">cred</span> <span class="o">=</span> <span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_machine_cred</span><span class="p">;</span>
	<span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_machine_cred</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cred</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">put_rpccred</span><span class="p">(</span><span class="n">cred</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">rpc_cred</span> <span class="o">*</span>
<span class="nf">nfs4_get_renew_cred_server_locked</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs_server</span> <span class="o">*</span><span class="n">server</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rpc_cred</span> <span class="o">*</span><span class="n">cred</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nfs4_state_owner</span> <span class="o">*</span><span class="n">sp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rb_node</span> <span class="o">*</span><span class="n">pos</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">pos</span> <span class="o">=</span> <span class="n">rb_first</span><span class="p">(</span><span class="o">&amp;</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">state_owners</span><span class="p">);</span>
	     <span class="n">pos</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">;</span>
	     <span class="n">pos</span> <span class="o">=</span> <span class="n">rb_next</span><span class="p">(</span><span class="n">pos</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">sp</span> <span class="o">=</span> <span class="n">rb_entry</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nfs4_state_owner</span><span class="p">,</span> <span class="n">so_server_node</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">so_states</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">cred</span> <span class="o">=</span> <span class="n">get_rpccred</span><span class="p">(</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">so_cred</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">cred</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * nfs4_get_renew_cred_locked - Acquire credential for a renew operation</span>
<span class="cm"> * @clp: client state handle</span>
<span class="cm"> *</span>
<span class="cm"> * Returns an rpc_cred with reference count bumped, or NULL.</span>
<span class="cm"> * Caller must hold clp-&gt;cl_lock.</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">rpc_cred</span> <span class="o">*</span><span class="nf">nfs4_get_renew_cred_locked</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs_client</span> <span class="o">*</span><span class="n">clp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rpc_cred</span> <span class="o">*</span><span class="n">cred</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nfs_server</span> <span class="o">*</span><span class="n">server</span><span class="p">;</span>

	<span class="cm">/* Use machine credentials if available */</span>
	<span class="n">cred</span> <span class="o">=</span> <span class="n">nfs4_get_machine_cred_locked</span><span class="p">(</span><span class="n">clp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cred</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">rcu_read_lock</span><span class="p">();</span>
	<span class="n">list_for_each_entry_rcu</span><span class="p">(</span><span class="n">server</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_superblocks</span><span class="p">,</span> <span class="n">client_link</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cred</span> <span class="o">=</span> <span class="n">nfs4_get_renew_cred_server_locked</span><span class="p">(</span><span class="n">server</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cred</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">rcu_read_unlock</span><span class="p">();</span>

<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">cred</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#if defined(CONFIG_NFS_V4_1)</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">nfs41_setup_state_renewal</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs_client</span> <span class="o">*</span><span class="n">clp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nfs_fsinfo</span> <span class="n">fsinfo</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">NFS_CS_CHECK_LEASE_TIME</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_res_state</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">nfs4_schedule_state_renewal</span><span class="p">(</span><span class="n">clp</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">nfs4_proc_get_lease_time</span><span class="p">(</span><span class="n">clp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fsinfo</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Update lease time and schedule renewal */</span>
		<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_lock</span><span class="p">);</span>
		<span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_lease_time</span> <span class="o">=</span> <span class="n">fsinfo</span><span class="p">.</span><span class="n">lease_time</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">;</span>
		<span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_last_renewal</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_lock</span><span class="p">);</span>

		<span class="n">nfs4_schedule_state_renewal</span><span class="p">(</span><span class="n">clp</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Back channel returns NFS4ERR_DELAY for new requests when</span>
<span class="cm"> * NFS4_SESSION_DRAINING is set so there is no work to be done when draining</span>
<span class="cm"> * is ended.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">nfs4_end_drain_session</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs_client</span> <span class="o">*</span><span class="n">clp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfs4_session</span> <span class="o">*</span><span class="n">ses</span> <span class="o">=</span> <span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_session</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nfs4_slot_table</span> <span class="o">*</span><span class="n">tbl</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">max_slots</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ses</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">tbl</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ses</span><span class="o">-&gt;</span><span class="n">fc_slot_table</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">NFS4_SESSION_DRAINING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ses</span><span class="o">-&gt;</span><span class="n">session_state</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tbl</span><span class="o">-&gt;</span><span class="n">slot_tbl_lock</span><span class="p">);</span>
		<span class="n">max_slots</span> <span class="o">=</span> <span class="n">tbl</span><span class="o">-&gt;</span><span class="n">max_slots</span><span class="p">;</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">max_slots</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rpc_wake_up_first</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tbl</span><span class="o">-&gt;</span><span class="n">slot_tbl_waitq</span><span class="p">,</span>
						<span class="n">nfs4_set_task_privileged</span><span class="p">,</span>
						<span class="nb">NULL</span><span class="p">)</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tbl</span><span class="o">-&gt;</span><span class="n">slot_tbl_lock</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">nfs4_wait_on_slot_tbl</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs4_slot_table</span> <span class="o">*</span><span class="n">tbl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tbl</span><span class="o">-&gt;</span><span class="n">slot_tbl_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tbl</span><span class="o">-&gt;</span><span class="n">highest_used_slotid</span> <span class="o">!=</span> <span class="n">NFS4_NO_SLOT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">INIT_COMPLETION</span><span class="p">(</span><span class="n">tbl</span><span class="o">-&gt;</span><span class="n">complete</span><span class="p">);</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tbl</span><span class="o">-&gt;</span><span class="n">slot_tbl_lock</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">wait_for_completion_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tbl</span><span class="o">-&gt;</span><span class="n">complete</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tbl</span><span class="o">-&gt;</span><span class="n">slot_tbl_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">nfs4_begin_drain_session</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs_client</span> <span class="o">*</span><span class="n">clp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfs4_session</span> <span class="o">*</span><span class="n">ses</span> <span class="o">=</span> <span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_session</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">set_bit</span><span class="p">(</span><span class="n">NFS4_SESSION_DRAINING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ses</span><span class="o">-&gt;</span><span class="n">session_state</span><span class="p">);</span>
	<span class="cm">/* back channel */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">nfs4_wait_on_slot_tbl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ses</span><span class="o">-&gt;</span><span class="n">bc_slot_table</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="cm">/* fore channel */</span>
	<span class="k">return</span> <span class="n">nfs4_wait_on_slot_tbl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ses</span><span class="o">-&gt;</span><span class="n">fc_slot_table</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">nfs41_finish_session_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs_client</span> <span class="o">*</span><span class="n">clp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">clear_bit</span><span class="p">(</span><span class="n">NFS4CLNT_LEASE_CONFIRM</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_state</span><span class="p">);</span>
	<span class="n">clear_bit</span><span class="p">(</span><span class="n">NFS4CLNT_SESSION_RESET</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_state</span><span class="p">);</span>
	<span class="cm">/* create_session negotiated new slot table */</span>
	<span class="n">clear_bit</span><span class="p">(</span><span class="n">NFS4CLNT_RECALL_SLOT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_state</span><span class="p">);</span>
	<span class="n">clear_bit</span><span class="p">(</span><span class="n">NFS4CLNT_BIND_CONN_TO_SESSION</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_state</span><span class="p">);</span>
	<span class="n">nfs41_setup_state_renewal</span><span class="p">(</span><span class="n">clp</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">nfs41_init_clientid</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs_client</span> <span class="o">*</span><span class="n">clp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rpc_cred</span> <span class="o">*</span><span class="n">cred</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">NFS4CLNT_LEASE_CONFIRM</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_state</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">do_confirm</span><span class="p">;</span>
	<span class="n">nfs4_begin_drain_session</span><span class="p">(</span><span class="n">clp</span><span class="p">);</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">nfs4_proc_exchange_id</span><span class="p">(</span><span class="n">clp</span><span class="p">,</span> <span class="n">cred</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="n">set_bit</span><span class="p">(</span><span class="n">NFS4CLNT_LEASE_CONFIRM</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_state</span><span class="p">);</span>
<span class="nl">do_confirm:</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">nfs4_proc_create_session</span><span class="p">(</span><span class="n">clp</span><span class="p">,</span> <span class="n">cred</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="n">nfs41_finish_session_reset</span><span class="p">(</span><span class="n">clp</span><span class="p">);</span>
	<span class="n">nfs_mark_client_ready</span><span class="p">(</span><span class="n">clp</span><span class="p">,</span> <span class="n">NFS_CS_READY</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">rpc_cred</span> <span class="o">*</span><span class="nf">nfs4_get_exchange_id_cred</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs_client</span> <span class="o">*</span><span class="n">clp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rpc_cred</span> <span class="o">*</span><span class="n">cred</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_lock</span><span class="p">);</span>
	<span class="n">cred</span> <span class="o">=</span> <span class="n">nfs4_get_machine_cred_locked</span><span class="p">(</span><span class="n">clp</span><span class="p">);</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">cred</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#endif </span><span class="cm">/* CONFIG_NFS_V4_1 */</span><span class="cp"></span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">rpc_cred</span> <span class="o">*</span>
<span class="nf">nfs4_get_setclientid_cred_server</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs_server</span> <span class="o">*</span><span class="n">server</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfs_client</span> <span class="o">*</span><span class="n">clp</span> <span class="o">=</span> <span class="n">server</span><span class="o">-&gt;</span><span class="n">nfs_client</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rpc_cred</span> <span class="o">*</span><span class="n">cred</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nfs4_state_owner</span> <span class="o">*</span><span class="n">sp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rb_node</span> <span class="o">*</span><span class="n">pos</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_lock</span><span class="p">);</span>
	<span class="n">pos</span> <span class="o">=</span> <span class="n">rb_first</span><span class="p">(</span><span class="o">&amp;</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">state_owners</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pos</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sp</span> <span class="o">=</span> <span class="n">rb_entry</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nfs4_state_owner</span><span class="p">,</span> <span class="n">so_server_node</span><span class="p">);</span>
		<span class="n">cred</span> <span class="o">=</span> <span class="n">get_rpccred</span><span class="p">(</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">so_cred</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">cred</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * nfs4_get_setclientid_cred - Acquire credential for a setclientid operation</span>
<span class="cm"> * @clp: client state handle</span>
<span class="cm"> *</span>
<span class="cm"> * Returns an rpc_cred with reference count bumped, or NULL.</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">rpc_cred</span> <span class="o">*</span><span class="nf">nfs4_get_setclientid_cred</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs_client</span> <span class="o">*</span><span class="n">clp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfs_server</span> <span class="o">*</span><span class="n">server</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rpc_cred</span> <span class="o">*</span><span class="n">cred</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_lock</span><span class="p">);</span>
	<span class="n">cred</span> <span class="o">=</span> <span class="n">nfs4_get_machine_cred_locked</span><span class="p">(</span><span class="n">clp</span><span class="p">);</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cred</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">rcu_read_lock</span><span class="p">();</span>
	<span class="n">list_for_each_entry_rcu</span><span class="p">(</span><span class="n">server</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_superblocks</span><span class="p">,</span> <span class="n">client_link</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cred</span> <span class="o">=</span> <span class="n">nfs4_get_setclientid_cred_server</span><span class="p">(</span><span class="n">server</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cred</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">rcu_read_unlock</span><span class="p">();</span>

<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">cred</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">nfs4_state_owner</span> <span class="o">*</span>
<span class="nf">nfs4_find_state_owner_locked</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs_server</span> <span class="o">*</span><span class="n">server</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rpc_cred</span> <span class="o">*</span><span class="n">cred</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rb_node</span> <span class="o">**</span><span class="n">p</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">state_owners</span><span class="p">.</span><span class="n">rb_node</span><span class="p">,</span>
		       <span class="o">*</span><span class="n">parent</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nfs4_state_owner</span> <span class="o">*</span><span class="n">sp</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="o">*</span><span class="n">p</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">parent</span> <span class="o">=</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
		<span class="n">sp</span> <span class="o">=</span> <span class="n">rb_entry</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nfs4_state_owner</span><span class="p">,</span> <span class="n">so_server_node</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">cred</span> <span class="o">&lt;</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">so_cred</span><span class="p">)</span>
			<span class="n">p</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">parent</span><span class="o">-&gt;</span><span class="n">rb_left</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">cred</span> <span class="o">&gt;</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">so_cred</span><span class="p">)</span>
			<span class="n">p</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">parent</span><span class="o">-&gt;</span><span class="n">rb_right</span><span class="p">;</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">so_lru</span><span class="p">))</span>
				<span class="n">list_del_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">so_lru</span><span class="p">);</span>
			<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">so_count</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">sp</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">nfs4_state_owner</span> <span class="o">*</span>
<span class="nf">nfs4_insert_state_owner_locked</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs4_state_owner</span> <span class="o">*</span><span class="n">new</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfs_server</span> <span class="o">*</span><span class="n">server</span> <span class="o">=</span> <span class="n">new</span><span class="o">-&gt;</span><span class="n">so_server</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rb_node</span> <span class="o">**</span><span class="n">p</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">state_owners</span><span class="p">.</span><span class="n">rb_node</span><span class="p">,</span>
		       <span class="o">*</span><span class="n">parent</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nfs4_state_owner</span> <span class="o">*</span><span class="n">sp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="o">*</span><span class="n">p</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">parent</span> <span class="o">=</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
		<span class="n">sp</span> <span class="o">=</span> <span class="n">rb_entry</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nfs4_state_owner</span><span class="p">,</span> <span class="n">so_server_node</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">new</span><span class="o">-&gt;</span><span class="n">so_cred</span> <span class="o">&lt;</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">so_cred</span><span class="p">)</span>
			<span class="n">p</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">parent</span><span class="o">-&gt;</span><span class="n">rb_left</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">new</span><span class="o">-&gt;</span><span class="n">so_cred</span> <span class="o">&gt;</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">so_cred</span><span class="p">)</span>
			<span class="n">p</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">parent</span><span class="o">-&gt;</span><span class="n">rb_right</span><span class="p">;</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">so_lru</span><span class="p">))</span>
				<span class="n">list_del_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">so_lru</span><span class="p">);</span>
			<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">so_count</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">sp</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">ida_get_new</span><span class="p">(</span><span class="o">&amp;</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">openowner_id</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">new</span><span class="o">-&gt;</span><span class="n">so_seqid</span><span class="p">.</span><span class="n">owner_id</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="n">err</span><span class="p">);</span>
	<span class="n">rb_link_node</span><span class="p">(</span><span class="o">&amp;</span><span class="n">new</span><span class="o">-&gt;</span><span class="n">so_server_node</span><span class="p">,</span> <span class="n">parent</span><span class="p">,</span> <span class="n">p</span><span class="p">);</span>
	<span class="n">rb_insert_color</span><span class="p">(</span><span class="o">&amp;</span><span class="n">new</span><span class="o">-&gt;</span><span class="n">so_server_node</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">state_owners</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">new</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">nfs4_remove_state_owner_locked</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs4_state_owner</span> <span class="o">*</span><span class="n">sp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfs_server</span> <span class="o">*</span><span class="n">server</span> <span class="o">=</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">so_server</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">RB_EMPTY_NODE</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">so_server_node</span><span class="p">))</span>
		<span class="n">rb_erase</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">so_server_node</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">state_owners</span><span class="p">);</span>
	<span class="n">ida_remove</span><span class="p">(</span><span class="o">&amp;</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">openowner_id</span><span class="p">,</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">so_seqid</span><span class="p">.</span><span class="n">owner_id</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">nfs4_init_seqid_counter</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs_seqid_counter</span> <span class="o">*</span><span class="n">sc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">sc</span><span class="o">-&gt;</span><span class="n">create_time</span> <span class="o">=</span> <span class="n">ktime_get</span><span class="p">();</span>
	<span class="n">sc</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">sc</span><span class="o">-&gt;</span><span class="n">counter</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
	<span class="n">rpc_init_wait_queue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">wait</span><span class="p">,</span> <span class="s">&quot;Seqid_waitqueue&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">nfs4_destroy_seqid_counter</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs_seqid_counter</span> <span class="o">*</span><span class="n">sc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">rpc_destroy_wait_queue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">wait</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * nfs4_alloc_state_owner(): this is called on the OPEN or CREATE path to</span>
<span class="cm"> * create a new state_owner.</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">nfs4_state_owner</span> <span class="o">*</span>
<span class="nf">nfs4_alloc_state_owner</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs_server</span> <span class="o">*</span><span class="n">server</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">rpc_cred</span> <span class="o">*</span><span class="n">cred</span><span class="p">,</span>
		<span class="n">gfp_t</span> <span class="n">gfp_flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfs4_state_owner</span> <span class="o">*</span><span class="n">sp</span><span class="p">;</span>

	<span class="n">sp</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">sp</span><span class="p">),</span> <span class="n">gfp_flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sp</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">sp</span><span class="o">-&gt;</span><span class="n">so_server</span> <span class="o">=</span> <span class="n">server</span><span class="p">;</span>
	<span class="n">sp</span><span class="o">-&gt;</span><span class="n">so_cred</span> <span class="o">=</span> <span class="n">get_rpccred</span><span class="p">(</span><span class="n">cred</span><span class="p">);</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">so_lock</span><span class="p">);</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">so_states</span><span class="p">);</span>
	<span class="n">nfs4_init_seqid_counter</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">so_seqid</span><span class="p">);</span>
	<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">so_count</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">so_lru</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">sp</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">nfs4_drop_state_owner</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs4_state_owner</span> <span class="o">*</span><span class="n">sp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rb_node</span> <span class="o">*</span><span class="n">rb_node</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">so_server_node</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">RB_EMPTY_NODE</span><span class="p">(</span><span class="n">rb_node</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">nfs_server</span> <span class="o">*</span><span class="n">server</span> <span class="o">=</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">so_server</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">nfs_client</span> <span class="o">*</span><span class="n">clp</span> <span class="o">=</span> <span class="n">server</span><span class="o">-&gt;</span><span class="n">nfs_client</span><span class="p">;</span>

		<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_lock</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">RB_EMPTY_NODE</span><span class="p">(</span><span class="n">rb_node</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">rb_erase</span><span class="p">(</span><span class="n">rb_node</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">state_owners</span><span class="p">);</span>
			<span class="n">RB_CLEAR_NODE</span><span class="p">(</span><span class="n">rb_node</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_lock</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">nfs4_free_state_owner</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs4_state_owner</span> <span class="o">*</span><span class="n">sp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">nfs4_destroy_seqid_counter</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">so_seqid</span><span class="p">);</span>
	<span class="n">put_rpccred</span><span class="p">(</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">so_cred</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">sp</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">nfs4_gc_state_owners</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs_server</span> <span class="o">*</span><span class="n">server</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfs_client</span> <span class="o">*</span><span class="n">clp</span> <span class="o">=</span> <span class="n">server</span><span class="o">-&gt;</span><span class="n">nfs_client</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nfs4_state_owner</span> <span class="o">*</span><span class="n">sp</span><span class="p">,</span> <span class="o">*</span><span class="n">tmp</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">time_min</span><span class="p">,</span> <span class="n">time_max</span><span class="p">;</span>
	<span class="n">LIST_HEAD</span><span class="p">(</span><span class="n">doomed</span><span class="p">);</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_lock</span><span class="p">);</span>
	<span class="n">time_max</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
	<span class="n">time_min</span> <span class="o">=</span> <span class="p">(</span><span class="kt">long</span><span class="p">)</span><span class="n">time_max</span> <span class="o">-</span> <span class="p">(</span><span class="kt">long</span><span class="p">)</span><span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_lease_time</span><span class="p">;</span>
	<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">sp</span><span class="p">,</span> <span class="n">tmp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">state_owners_lru</span><span class="p">,</span> <span class="n">so_lru</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* NB: LRU is sorted so that oldest is at the head */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">time_in_range</span><span class="p">(</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">so_expires</span><span class="p">,</span> <span class="n">time_min</span><span class="p">,</span> <span class="n">time_max</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">list_move</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">so_lru</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">doomed</span><span class="p">);</span>
		<span class="n">nfs4_remove_state_owner_locked</span><span class="p">(</span><span class="n">sp</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_lock</span><span class="p">);</span>

	<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">sp</span><span class="p">,</span> <span class="n">tmp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">doomed</span><span class="p">,</span> <span class="n">so_lru</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">so_lru</span><span class="p">);</span>
		<span class="n">nfs4_free_state_owner</span><span class="p">(</span><span class="n">sp</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * nfs4_get_state_owner - Look up a state owner given a credential</span>
<span class="cm"> * @server: nfs_server to search</span>
<span class="cm"> * @cred: RPC credential to match</span>
<span class="cm"> *</span>
<span class="cm"> * Returns a pointer to an instantiated nfs4_state_owner struct, or NULL.</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">nfs4_state_owner</span> <span class="o">*</span><span class="nf">nfs4_get_state_owner</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs_server</span> <span class="o">*</span><span class="n">server</span><span class="p">,</span>
					      <span class="k">struct</span> <span class="n">rpc_cred</span> <span class="o">*</span><span class="n">cred</span><span class="p">,</span>
					      <span class="n">gfp_t</span> <span class="n">gfp_flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfs_client</span> <span class="o">*</span><span class="n">clp</span> <span class="o">=</span> <span class="n">server</span><span class="o">-&gt;</span><span class="n">nfs_client</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nfs4_state_owner</span> <span class="o">*</span><span class="n">sp</span><span class="p">,</span> <span class="o">*</span><span class="n">new</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_lock</span><span class="p">);</span>
	<span class="n">sp</span> <span class="o">=</span> <span class="n">nfs4_find_state_owner_locked</span><span class="p">(</span><span class="n">server</span><span class="p">,</span> <span class="n">cred</span><span class="p">);</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sp</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="n">new</span> <span class="o">=</span> <span class="n">nfs4_alloc_state_owner</span><span class="p">(</span><span class="n">server</span><span class="p">,</span> <span class="n">cred</span><span class="p">,</span> <span class="n">gfp_flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">new</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ida_pre_get</span><span class="p">(</span><span class="o">&amp;</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">openowner_id</span><span class="p">,</span> <span class="n">gfp_flags</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_lock</span><span class="p">);</span>
		<span class="n">sp</span> <span class="o">=</span> <span class="n">nfs4_insert_state_owner_locked</span><span class="p">(</span><span class="n">new</span><span class="p">);</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_lock</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">sp</span> <span class="o">==</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">EAGAIN</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sp</span> <span class="o">!=</span> <span class="n">new</span><span class="p">)</span>
		<span class="n">nfs4_free_state_owner</span><span class="p">(</span><span class="n">new</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="n">nfs4_gc_state_owners</span><span class="p">(</span><span class="n">server</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">sp</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * nfs4_put_state_owner - Release a nfs4_state_owner</span>
<span class="cm"> * @sp: state owner data to release</span>
<span class="cm"> *</span>
<span class="cm"> * Note that we keep released state owners on an LRU</span>
<span class="cm"> * list.</span>
<span class="cm"> * This caches valid state owners so that they can be</span>
<span class="cm"> * reused, to avoid the OPEN_CONFIRM on minor version 0.</span>
<span class="cm"> * It also pins the uniquifier of dropped state owners for</span>
<span class="cm"> * a while, to ensure that those state owner names are</span>
<span class="cm"> * never reused.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">nfs4_put_state_owner</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs4_state_owner</span> <span class="o">*</span><span class="n">sp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfs_server</span> <span class="o">*</span><span class="n">server</span> <span class="o">=</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">so_server</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nfs_client</span> <span class="o">*</span><span class="n">clp</span> <span class="o">=</span> <span class="n">server</span><span class="o">-&gt;</span><span class="n">nfs_client</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">atomic_dec_and_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">so_count</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_lock</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">sp</span><span class="o">-&gt;</span><span class="n">so_expires</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
	<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">so_lru</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">state_owners_lru</span><span class="p">);</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * nfs4_purge_state_owners - Release all cached state owners</span>
<span class="cm"> * @server: nfs_server with cached state owners to release</span>
<span class="cm"> *</span>
<span class="cm"> * Called at umount time.  Remaining state owners will be on</span>
<span class="cm"> * the LRU with ref count of zero.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">nfs4_purge_state_owners</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs_server</span> <span class="o">*</span><span class="n">server</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfs_client</span> <span class="o">*</span><span class="n">clp</span> <span class="o">=</span> <span class="n">server</span><span class="o">-&gt;</span><span class="n">nfs_client</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nfs4_state_owner</span> <span class="o">*</span><span class="n">sp</span><span class="p">,</span> <span class="o">*</span><span class="n">tmp</span><span class="p">;</span>
	<span class="n">LIST_HEAD</span><span class="p">(</span><span class="n">doomed</span><span class="p">);</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_lock</span><span class="p">);</span>
	<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">sp</span><span class="p">,</span> <span class="n">tmp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">state_owners_lru</span><span class="p">,</span> <span class="n">so_lru</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">list_move</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">so_lru</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">doomed</span><span class="p">);</span>
		<span class="n">nfs4_remove_state_owner_locked</span><span class="p">(</span><span class="n">sp</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_lock</span><span class="p">);</span>

	<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">sp</span><span class="p">,</span> <span class="n">tmp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">doomed</span><span class="p">,</span> <span class="n">so_lru</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">so_lru</span><span class="p">);</span>
		<span class="n">nfs4_free_state_owner</span><span class="p">(</span><span class="n">sp</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">nfs4_state</span> <span class="o">*</span>
<span class="nf">nfs4_alloc_open_state</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfs4_state</span> <span class="o">*</span><span class="n">state</span><span class="p">;</span>

	<span class="n">state</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">state</span><span class="p">),</span> <span class="n">GFP_NOFS</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">state</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">lock_states</span><span class="p">);</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">state_lock</span><span class="p">);</span>
	<span class="n">seqlock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">seqlock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">state</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">nfs4_state_set_mode_locked</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs4_state</span> <span class="o">*</span><span class="n">state</span><span class="p">,</span> <span class="n">fmode_t</span> <span class="n">fmode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">fmode</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="cm">/* NB! List reordering - see the reclaim code for why.  */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">fmode</span> <span class="o">&amp;</span> <span class="n">FMODE_WRITE</span><span class="p">)</span> <span class="o">!=</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">&amp;</span> <span class="n">FMODE_WRITE</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">fmode</span> <span class="o">&amp;</span> <span class="n">FMODE_WRITE</span><span class="p">)</span>
			<span class="n">list_move</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">open_states</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">owner</span><span class="o">-&gt;</span><span class="n">so_states</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">list_move_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">open_states</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">owner</span><span class="o">-&gt;</span><span class="n">so_states</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">fmode</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">nfs4_state</span> <span class="o">*</span>
<span class="nf">__nfs4_find_state_byowner</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nfs4_state_owner</span> <span class="o">*</span><span class="n">owner</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfs_inode</span> <span class="o">*</span><span class="n">nfsi</span> <span class="o">=</span> <span class="n">NFS_I</span><span class="p">(</span><span class="n">inode</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">nfs4_state</span> <span class="o">*</span><span class="n">state</span><span class="p">;</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">nfsi</span><span class="o">-&gt;</span><span class="n">open_states</span><span class="p">,</span> <span class="n">inode_states</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">owner</span> <span class="o">!=</span> <span class="n">owner</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">atomic_inc_not_zero</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">))</span>
			<span class="k">return</span> <span class="n">state</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">nfs4_free_open_state</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs4_state</span> <span class="o">*</span><span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">state</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">nfs4_state</span> <span class="o">*</span>
<span class="nf">nfs4_get_open_state</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nfs4_state_owner</span> <span class="o">*</span><span class="n">owner</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfs4_state</span> <span class="o">*</span><span class="n">state</span><span class="p">,</span> <span class="o">*</span><span class="n">new</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nfs_inode</span> <span class="o">*</span><span class="n">nfsi</span> <span class="o">=</span> <span class="n">NFS_I</span><span class="p">(</span><span class="n">inode</span><span class="p">);</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_lock</span><span class="p">);</span>
	<span class="n">state</span> <span class="o">=</span> <span class="n">__nfs4_find_state_byowner</span><span class="p">(</span><span class="n">inode</span><span class="p">,</span> <span class="n">owner</span><span class="p">);</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="n">new</span> <span class="o">=</span> <span class="n">nfs4_alloc_open_state</span><span class="p">();</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">owner</span><span class="o">-&gt;</span><span class="n">so_lock</span><span class="p">);</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_lock</span><span class="p">);</span>
	<span class="n">state</span> <span class="o">=</span> <span class="n">__nfs4_find_state_byowner</span><span class="p">(</span><span class="n">inode</span><span class="p">,</span> <span class="n">owner</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">state</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">&amp;&amp;</span> <span class="n">new</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">state</span> <span class="o">=</span> <span class="n">new</span><span class="p">;</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">owner</span> <span class="o">=</span> <span class="n">owner</span><span class="p">;</span>
		<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">owner</span><span class="o">-&gt;</span><span class="n">so_count</span><span class="p">);</span>
		<span class="n">list_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">inode_states</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">nfsi</span><span class="o">-&gt;</span><span class="n">open_states</span><span class="p">);</span>
		<span class="n">ihold</span><span class="p">(</span><span class="n">inode</span><span class="p">);</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">inode</span> <span class="o">=</span> <span class="n">inode</span><span class="p">;</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_lock</span><span class="p">);</span>
		<span class="cm">/* Note: The reclaim code dictates that we add stateless</span>
<span class="cm">		 * and read-only stateids to the end of the list */</span>
		<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">open_states</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">owner</span><span class="o">-&gt;</span><span class="n">so_states</span><span class="p">);</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">owner</span><span class="o">-&gt;</span><span class="n">so_lock</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_lock</span><span class="p">);</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">owner</span><span class="o">-&gt;</span><span class="n">so_lock</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">new</span><span class="p">)</span>
			<span class="n">nfs4_free_open_state</span><span class="p">(</span><span class="n">new</span><span class="p">);</span>
	<span class="p">}</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">state</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">nfs4_put_open_state</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs4_state</span> <span class="o">*</span><span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span> <span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">inode</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nfs4_state_owner</span> <span class="o">*</span><span class="n">owner</span> <span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">owner</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">atomic_dec_and_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">owner</span><span class="o">-&gt;</span><span class="n">so_lock</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_lock</span><span class="p">);</span>
	<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">inode_states</span><span class="p">);</span>
	<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">open_states</span><span class="p">);</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_lock</span><span class="p">);</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">owner</span><span class="o">-&gt;</span><span class="n">so_lock</span><span class="p">);</span>
	<span class="n">iput</span><span class="p">(</span><span class="n">inode</span><span class="p">);</span>
	<span class="n">nfs4_free_open_state</span><span class="p">(</span><span class="n">state</span><span class="p">);</span>
	<span class="n">nfs4_put_state_owner</span><span class="p">(</span><span class="n">owner</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Close the current file.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">__nfs4_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs4_state</span> <span class="o">*</span><span class="n">state</span><span class="p">,</span>
		<span class="n">fmode_t</span> <span class="n">fmode</span><span class="p">,</span> <span class="n">gfp_t</span> <span class="n">gfp_mask</span><span class="p">,</span> <span class="kt">int</span> <span class="n">wait</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfs4_state_owner</span> <span class="o">*</span><span class="n">owner</span> <span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">owner</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">call_close</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">fmode_t</span> <span class="n">newstate</span><span class="p">;</span>

	<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">owner</span><span class="o">-&gt;</span><span class="n">so_count</span><span class="p">);</span>
	<span class="cm">/* Protect against nfs4_find_state() */</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">owner</span><span class="o">-&gt;</span><span class="n">so_lock</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">fmode</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">FMODE_READ</span> <span class="o">|</span> <span class="n">FMODE_WRITE</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">FMODE_READ</span>:
			<span class="n">state</span><span class="o">-&gt;</span><span class="n">n_rdonly</span><span class="o">--</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">FMODE_WRITE</span>:
			<span class="n">state</span><span class="o">-&gt;</span><span class="n">n_wronly</span><span class="o">--</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">FMODE_READ</span><span class="o">|</span><span class="n">FMODE_WRITE</span>:
			<span class="n">state</span><span class="o">-&gt;</span><span class="n">n_rdwr</span><span class="o">--</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">newstate</span> <span class="o">=</span> <span class="n">FMODE_READ</span><span class="o">|</span><span class="n">FMODE_WRITE</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">n_rdwr</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">n_rdonly</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">newstate</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">FMODE_READ</span><span class="p">;</span>
			<span class="n">call_close</span> <span class="o">|=</span> <span class="n">test_bit</span><span class="p">(</span><span class="n">NFS_O_RDONLY_STATE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
			<span class="n">call_close</span> <span class="o">|=</span> <span class="n">test_bit</span><span class="p">(</span><span class="n">NFS_O_RDWR_STATE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">n_wronly</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">newstate</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">FMODE_WRITE</span><span class="p">;</span>
			<span class="n">call_close</span> <span class="o">|=</span> <span class="n">test_bit</span><span class="p">(</span><span class="n">NFS_O_WRONLY_STATE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
			<span class="n">call_close</span> <span class="o">|=</span> <span class="n">test_bit</span><span class="p">(</span><span class="n">NFS_O_RDWR_STATE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">newstate</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">clear_bit</span><span class="p">(</span><span class="n">NFS_DELEGATED_STATE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">nfs4_state_set_mode_locked</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">newstate</span><span class="p">);</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">owner</span><span class="o">-&gt;</span><span class="n">so_lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">call_close</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">nfs4_put_open_state</span><span class="p">(</span><span class="n">state</span><span class="p">);</span>
		<span class="n">nfs4_put_state_owner</span><span class="p">(</span><span class="n">owner</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">bool</span> <span class="n">roc</span> <span class="o">=</span> <span class="n">pnfs_roc</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">inode</span><span class="p">);</span>

		<span class="n">nfs4_do_close</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">gfp_mask</span><span class="p">,</span> <span class="n">wait</span><span class="p">,</span> <span class="n">roc</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">nfs4_close_state</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs4_state</span> <span class="o">*</span><span class="n">state</span><span class="p">,</span> <span class="n">fmode_t</span> <span class="n">fmode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">__nfs4_close</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">fmode</span><span class="p">,</span> <span class="n">GFP_NOFS</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">nfs4_close_sync</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs4_state</span> <span class="o">*</span><span class="n">state</span><span class="p">,</span> <span class="n">fmode_t</span> <span class="n">fmode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">__nfs4_close</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">fmode</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Search the state-&gt;lock_states for an existing lock_owner</span>
<span class="cm"> * that is compatible with current-&gt;files</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">nfs4_lock_state</span> <span class="o">*</span>
<span class="nf">__nfs4_find_lock_state</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs4_state</span> <span class="o">*</span><span class="n">state</span><span class="p">,</span> <span class="n">fl_owner_t</span> <span class="n">fl_owner</span><span class="p">,</span> <span class="n">pid_t</span> <span class="n">fl_pid</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfs4_lock_state</span> <span class="o">*</span><span class="n">pos</span><span class="p">;</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">lock_states</span><span class="p">,</span> <span class="n">ls_locks</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">!=</span> <span class="n">NFS4_ANY_LOCK_TYPE</span> <span class="o">&amp;&amp;</span> <span class="n">pos</span><span class="o">-&gt;</span><span class="n">ls_owner</span><span class="p">.</span><span class="n">lo_type</span> <span class="o">!=</span> <span class="n">type</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">pos</span><span class="o">-&gt;</span><span class="n">ls_owner</span><span class="p">.</span><span class="n">lo_type</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">NFS4_POSIX_LOCK_TYPE</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">pos</span><span class="o">-&gt;</span><span class="n">ls_owner</span><span class="p">.</span><span class="n">lo_u</span><span class="p">.</span><span class="n">posix_owner</span> <span class="o">!=</span> <span class="n">fl_owner</span><span class="p">)</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">NFS4_FLOCK_LOCK_TYPE</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">pos</span><span class="o">-&gt;</span><span class="n">ls_owner</span><span class="p">.</span><span class="n">lo_u</span><span class="p">.</span><span class="n">flock_owner</span> <span class="o">!=</span> <span class="n">fl_pid</span><span class="p">)</span>
				<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pos</span><span class="o">-&gt;</span><span class="n">ls_count</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">pos</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Return a compatible lock_state. If no initialized lock_state structure</span>
<span class="cm"> * exists, return an uninitialized one.</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">nfs4_lock_state</span> <span class="o">*</span><span class="nf">nfs4_alloc_lock_state</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs4_state</span> <span class="o">*</span><span class="n">state</span><span class="p">,</span> <span class="n">fl_owner_t</span> <span class="n">fl_owner</span><span class="p">,</span> <span class="n">pid_t</span> <span class="n">fl_pid</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfs4_lock_state</span> <span class="o">*</span><span class="n">lsp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nfs_server</span> <span class="o">*</span><span class="n">server</span> <span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">owner</span><span class="o">-&gt;</span><span class="n">so_server</span><span class="p">;</span>

	<span class="n">lsp</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">lsp</span><span class="p">),</span> <span class="n">GFP_NOFS</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lsp</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">nfs4_init_seqid_counter</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lsp</span><span class="o">-&gt;</span><span class="n">ls_seqid</span><span class="p">);</span>
	<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lsp</span><span class="o">-&gt;</span><span class="n">ls_count</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">lsp</span><span class="o">-&gt;</span><span class="n">ls_state</span> <span class="o">=</span> <span class="n">state</span><span class="p">;</span>
	<span class="n">lsp</span><span class="o">-&gt;</span><span class="n">ls_owner</span><span class="p">.</span><span class="n">lo_type</span> <span class="o">=</span> <span class="n">type</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">lsp</span><span class="o">-&gt;</span><span class="n">ls_owner</span><span class="p">.</span><span class="n">lo_type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">NFS4_FLOCK_LOCK_TYPE</span>:
		<span class="n">lsp</span><span class="o">-&gt;</span><span class="n">ls_owner</span><span class="p">.</span><span class="n">lo_u</span><span class="p">.</span><span class="n">flock_owner</span> <span class="o">=</span> <span class="n">fl_pid</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">NFS4_POSIX_LOCK_TYPE</span>:
		<span class="n">lsp</span><span class="o">-&gt;</span><span class="n">ls_owner</span><span class="p">.</span><span class="n">lo_u</span><span class="p">.</span><span class="n">posix_owner</span> <span class="o">=</span> <span class="n">fl_owner</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">goto</span> <span class="n">out_free</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">lsp</span><span class="o">-&gt;</span><span class="n">ls_seqid</span><span class="p">.</span><span class="n">owner_id</span> <span class="o">=</span> <span class="n">ida_simple_get</span><span class="p">(</span><span class="o">&amp;</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">lockowner_id</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">GFP_NOFS</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lsp</span><span class="o">-&gt;</span><span class="n">ls_seqid</span><span class="p">.</span><span class="n">owner_id</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_free</span><span class="p">;</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lsp</span><span class="o">-&gt;</span><span class="n">ls_locks</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">lsp</span><span class="p">;</span>
<span class="nl">out_free:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">lsp</span><span class="p">);</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">nfs4_free_lock_state</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs_server</span> <span class="o">*</span><span class="n">server</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nfs4_lock_state</span> <span class="o">*</span><span class="n">lsp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ida_simple_remove</span><span class="p">(</span><span class="o">&amp;</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">lockowner_id</span><span class="p">,</span> <span class="n">lsp</span><span class="o">-&gt;</span><span class="n">ls_seqid</span><span class="p">.</span><span class="n">owner_id</span><span class="p">);</span>
	<span class="n">nfs4_destroy_seqid_counter</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lsp</span><span class="o">-&gt;</span><span class="n">ls_seqid</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">lsp</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Return a compatible lock_state. If no initialized lock_state structure</span>
<span class="cm"> * exists, return an uninitialized one.</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">nfs4_lock_state</span> <span class="o">*</span><span class="nf">nfs4_get_lock_state</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs4_state</span> <span class="o">*</span><span class="n">state</span><span class="p">,</span> <span class="n">fl_owner_t</span> <span class="n">owner</span><span class="p">,</span> <span class="n">pid_t</span> <span class="n">pid</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfs4_lock_state</span> <span class="o">*</span><span class="n">lsp</span><span class="p">,</span> <span class="o">*</span><span class="n">new</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	
	<span class="k">for</span><span class="p">(;;)</span> <span class="p">{</span>
		<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">state_lock</span><span class="p">);</span>
		<span class="n">lsp</span> <span class="o">=</span> <span class="n">__nfs4_find_lock_state</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">owner</span><span class="p">,</span> <span class="n">pid</span><span class="p">,</span> <span class="n">type</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">lsp</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">new</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">list_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">new</span><span class="o">-&gt;</span><span class="n">ls_locks</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">lock_states</span><span class="p">);</span>
			<span class="n">set_bit</span><span class="p">(</span><span class="n">LK_STATE_IN_USE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
			<span class="n">lsp</span> <span class="o">=</span> <span class="n">new</span><span class="p">;</span>
			<span class="n">new</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">state_lock</span><span class="p">);</span>
		<span class="n">new</span> <span class="o">=</span> <span class="n">nfs4_alloc_lock_state</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">owner</span><span class="p">,</span> <span class="n">pid</span><span class="p">,</span> <span class="n">type</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">new</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">state_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">new</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">nfs4_free_lock_state</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">owner</span><span class="o">-&gt;</span><span class="n">so_server</span><span class="p">,</span> <span class="n">new</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">lsp</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Release reference to lock_state, and free it if we see that</span>
<span class="cm"> * it is no longer in use</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">nfs4_put_lock_state</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs4_lock_state</span> <span class="o">*</span><span class="n">lsp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfs4_state</span> <span class="o">*</span><span class="n">state</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">lsp</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">state</span> <span class="o">=</span> <span class="n">lsp</span><span class="o">-&gt;</span><span class="n">ls_state</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">atomic_dec_and_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lsp</span><span class="o">-&gt;</span><span class="n">ls_count</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">state_lock</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lsp</span><span class="o">-&gt;</span><span class="n">ls_locks</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">lock_states</span><span class="p">))</span>
		<span class="n">clear_bit</span><span class="p">(</span><span class="n">LK_STATE_IN_USE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">state_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lsp</span><span class="o">-&gt;</span><span class="n">ls_flags</span> <span class="o">&amp;</span> <span class="n">NFS_LOCK_INITIALIZED</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">nfs4_release_lockowner</span><span class="p">(</span><span class="n">lsp</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">nfs4_free_lock_state</span><span class="p">(</span><span class="n">lsp</span><span class="o">-&gt;</span><span class="n">ls_state</span><span class="o">-&gt;</span><span class="n">owner</span><span class="o">-&gt;</span><span class="n">so_server</span><span class="p">,</span> <span class="n">lsp</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">nfs4_fl_copy_lock</span><span class="p">(</span><span class="k">struct</span> <span class="n">file_lock</span> <span class="o">*</span><span class="n">dst</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file_lock</span> <span class="o">*</span><span class="n">src</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfs4_lock_state</span> <span class="o">*</span><span class="n">lsp</span> <span class="o">=</span> <span class="n">src</span><span class="o">-&gt;</span><span class="n">fl_u</span><span class="p">.</span><span class="n">nfs4_fl</span><span class="p">.</span><span class="n">owner</span><span class="p">;</span>

	<span class="n">dst</span><span class="o">-&gt;</span><span class="n">fl_u</span><span class="p">.</span><span class="n">nfs4_fl</span><span class="p">.</span><span class="n">owner</span> <span class="o">=</span> <span class="n">lsp</span><span class="p">;</span>
	<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lsp</span><span class="o">-&gt;</span><span class="n">ls_count</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">nfs4_fl_release_lock</span><span class="p">(</span><span class="k">struct</span> <span class="n">file_lock</span> <span class="o">*</span><span class="n">fl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">nfs4_put_lock_state</span><span class="p">(</span><span class="n">fl</span><span class="o">-&gt;</span><span class="n">fl_u</span><span class="p">.</span><span class="n">nfs4_fl</span><span class="p">.</span><span class="n">owner</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">file_lock_operations</span> <span class="n">nfs4_fl_lock_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">fl_copy_lock</span> <span class="o">=</span> <span class="n">nfs4_fl_copy_lock</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fl_release_private</span> <span class="o">=</span> <span class="n">nfs4_fl_release_lock</span><span class="p">,</span>
<span class="p">};</span>

<span class="kt">int</span> <span class="nf">nfs4_set_lock_state</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs4_state</span> <span class="o">*</span><span class="n">state</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file_lock</span> <span class="o">*</span><span class="n">fl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfs4_lock_state</span> <span class="o">*</span><span class="n">lsp</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fl</span><span class="o">-&gt;</span><span class="n">fl_ops</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fl</span><span class="o">-&gt;</span><span class="n">fl_flags</span> <span class="o">&amp;</span> <span class="n">FL_POSIX</span><span class="p">)</span>
		<span class="n">lsp</span> <span class="o">=</span> <span class="n">nfs4_get_lock_state</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">fl</span><span class="o">-&gt;</span><span class="n">fl_owner</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">NFS4_POSIX_LOCK_TYPE</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">fl</span><span class="o">-&gt;</span><span class="n">fl_flags</span> <span class="o">&amp;</span> <span class="n">FL_FLOCK</span><span class="p">)</span>
		<span class="n">lsp</span> <span class="o">=</span> <span class="n">nfs4_get_lock_state</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">fl</span><span class="o">-&gt;</span><span class="n">fl_pid</span><span class="p">,</span>
				<span class="n">NFS4_FLOCK_LOCK_TYPE</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lsp</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">fl</span><span class="o">-&gt;</span><span class="n">fl_u</span><span class="p">.</span><span class="n">nfs4_fl</span><span class="p">.</span><span class="n">owner</span> <span class="o">=</span> <span class="n">lsp</span><span class="p">;</span>
	<span class="n">fl</span><span class="o">-&gt;</span><span class="n">fl_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">nfs4_fl_lock_ops</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">nfs4_copy_lock_stateid</span><span class="p">(</span><span class="n">nfs4_stateid</span> <span class="o">*</span><span class="n">dst</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nfs4_state</span> <span class="o">*</span><span class="n">state</span><span class="p">,</span>
		<span class="n">fl_owner_t</span> <span class="n">fl_owner</span><span class="p">,</span> <span class="n">pid_t</span> <span class="n">fl_pid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfs4_lock_state</span> <span class="o">*</span><span class="n">lsp</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">ret</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">LK_STATE_IN_USE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">state_lock</span><span class="p">);</span>
	<span class="n">lsp</span> <span class="o">=</span> <span class="n">__nfs4_find_lock_state</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">fl_owner</span><span class="p">,</span> <span class="n">fl_pid</span><span class="p">,</span> <span class="n">NFS4_ANY_LOCK_TYPE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lsp</span> <span class="o">!=</span> <span class="nb">NULL</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">lsp</span><span class="o">-&gt;</span><span class="n">ls_flags</span> <span class="o">&amp;</span> <span class="n">NFS_LOCK_INITIALIZED</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">nfs4_stateid_copy</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">lsp</span><span class="o">-&gt;</span><span class="n">ls_stateid</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">state_lock</span><span class="p">);</span>
	<span class="n">nfs4_put_lock_state</span><span class="p">(</span><span class="n">lsp</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">nfs4_copy_open_stateid</span><span class="p">(</span><span class="n">nfs4_stateid</span> <span class="o">*</span><span class="n">dst</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nfs4_state</span> <span class="o">*</span><span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">seq</span><span class="p">;</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="n">seq</span> <span class="o">=</span> <span class="n">read_seqbegin</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">seqlock</span><span class="p">);</span>
		<span class="n">nfs4_stateid_copy</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">stateid</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">read_seqretry</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">seqlock</span><span class="p">,</span> <span class="n">seq</span><span class="p">));</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Byte-range lock aware utility to initialize the stateid of read/write</span>
<span class="cm"> * requests.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">nfs4_select_rw_stateid</span><span class="p">(</span><span class="n">nfs4_stateid</span> <span class="o">*</span><span class="n">dst</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nfs4_state</span> <span class="o">*</span><span class="n">state</span><span class="p">,</span>
		<span class="n">fmode_t</span> <span class="n">fmode</span><span class="p">,</span> <span class="n">fl_owner_t</span> <span class="n">fl_owner</span><span class="p">,</span> <span class="n">pid_t</span> <span class="n">fl_pid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nfs4_copy_delegation_stateid</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">inode</span><span class="p">,</span> <span class="n">fmode</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nfs4_copy_lock_stateid</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">fl_owner</span><span class="p">,</span> <span class="n">fl_pid</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">nfs4_copy_open_stateid</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="n">state</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">nfs_seqid</span> <span class="o">*</span><span class="nf">nfs_alloc_seqid</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs_seqid_counter</span> <span class="o">*</span><span class="n">counter</span><span class="p">,</span> <span class="n">gfp_t</span> <span class="n">gfp_mask</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfs_seqid</span> <span class="o">*</span><span class="n">new</span><span class="p">;</span>

	<span class="n">new</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">new</span><span class="p">),</span> <span class="n">gfp_mask</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">new</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">new</span><span class="o">-&gt;</span><span class="n">sequence</span> <span class="o">=</span> <span class="n">counter</span><span class="p">;</span>
		<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">new</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
		<span class="n">new</span><span class="o">-&gt;</span><span class="n">task</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">new</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">nfs_release_seqid</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs_seqid</span> <span class="o">*</span><span class="n">seqid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfs_seqid_counter</span> <span class="o">*</span><span class="n">sequence</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">seqid</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">sequence</span> <span class="o">=</span> <span class="n">seqid</span><span class="o">-&gt;</span><span class="n">sequence</span><span class="p">;</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sequence</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">list_del_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">seqid</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sequence</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">nfs_seqid</span> <span class="o">*</span><span class="n">next</span><span class="p">;</span>

		<span class="n">next</span> <span class="o">=</span> <span class="n">list_first_entry</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sequence</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">nfs_seqid</span><span class="p">,</span> <span class="n">list</span><span class="p">);</span>
		<span class="n">rpc_wake_up_queued_task</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sequence</span><span class="o">-&gt;</span><span class="n">wait</span><span class="p">,</span> <span class="n">next</span><span class="o">-&gt;</span><span class="n">task</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sequence</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">nfs_free_seqid</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs_seqid</span> <span class="o">*</span><span class="n">seqid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">nfs_release_seqid</span><span class="p">(</span><span class="n">seqid</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">seqid</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Increment the seqid if the OPEN/OPEN_DOWNGRADE/CLOSE succeeded, or</span>
<span class="cm"> * failed with a seqid incrementing error -</span>
<span class="cm"> * see comments nfs_fs.h:seqid_mutating_error()</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">nfs_increment_seqid</span><span class="p">(</span><span class="kt">int</span> <span class="n">status</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nfs_seqid</span> <span class="o">*</span><span class="n">seqid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">list_first_entry</span><span class="p">(</span><span class="o">&amp;</span><span class="n">seqid</span><span class="o">-&gt;</span><span class="n">sequence</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nfs_seqid</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="o">!=</span> <span class="n">seqid</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">0</span>:
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="o">-</span><span class="n">NFS4ERR_BAD_SEQID</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">seqid</span><span class="o">-&gt;</span><span class="n">sequence</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">NFS_SEQID_CONFIRMED</span><span class="p">)</span>
				<span class="k">return</span><span class="p">;</span>
			<span class="n">pr_warn_ratelimited</span><span class="p">(</span><span class="s">&quot;NFS: v4 server returned a bad&quot;</span>
					<span class="s">&quot; sequence-id error on an&quot;</span>
					<span class="s">&quot; unconfirmed sequence %p!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">seqid</span><span class="o">-&gt;</span><span class="n">sequence</span><span class="p">);</span>
		<span class="k">case</span> <span class="o">-</span><span class="n">NFS4ERR_STALE_CLIENTID</span>:
		<span class="k">case</span> <span class="o">-</span><span class="n">NFS4ERR_STALE_STATEID</span>:
		<span class="k">case</span> <span class="o">-</span><span class="n">NFS4ERR_BAD_STATEID</span>:
		<span class="k">case</span> <span class="o">-</span><span class="n">NFS4ERR_BADXDR</span>:
		<span class="k">case</span> <span class="o">-</span><span class="n">NFS4ERR_RESOURCE</span>:
		<span class="k">case</span> <span class="o">-</span><span class="n">NFS4ERR_NOFILEHANDLE</span>:
			<span class="cm">/* Non-seqid mutating errors */</span>
			<span class="k">return</span><span class="p">;</span>
	<span class="p">};</span>
	<span class="cm">/*</span>
<span class="cm">	 * Note: no locking needed as we are guaranteed to be first</span>
<span class="cm">	 * on the sequence list</span>
<span class="cm">	 */</span>
	<span class="n">seqid</span><span class="o">-&gt;</span><span class="n">sequence</span><span class="o">-&gt;</span><span class="n">counter</span><span class="o">++</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">nfs_increment_open_seqid</span><span class="p">(</span><span class="kt">int</span> <span class="n">status</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nfs_seqid</span> <span class="o">*</span><span class="n">seqid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfs4_state_owner</span> <span class="o">*</span><span class="n">sp</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">seqid</span><span class="o">-&gt;</span><span class="n">sequence</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">nfs4_state_owner</span><span class="p">,</span> <span class="n">so_seqid</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">nfs_server</span> <span class="o">*</span><span class="n">server</span> <span class="o">=</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">so_server</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="o">-</span><span class="n">NFS4ERR_BAD_SEQID</span><span class="p">)</span>
		<span class="n">nfs4_drop_state_owner</span><span class="p">(</span><span class="n">sp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">nfs4_has_session</span><span class="p">(</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">nfs_client</span><span class="p">))</span>
		<span class="n">nfs_increment_seqid</span><span class="p">(</span><span class="n">status</span><span class="p">,</span> <span class="n">seqid</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Increment the seqid if the LOCK/LOCKU succeeded, or</span>
<span class="cm"> * failed with a seqid incrementing error -</span>
<span class="cm"> * see comments nfs_fs.h:seqid_mutating_error()</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">nfs_increment_lock_seqid</span><span class="p">(</span><span class="kt">int</span> <span class="n">status</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nfs_seqid</span> <span class="o">*</span><span class="n">seqid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">nfs_increment_seqid</span><span class="p">(</span><span class="n">status</span><span class="p">,</span> <span class="n">seqid</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">nfs_wait_on_sequence</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs_seqid</span> <span class="o">*</span><span class="n">seqid</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rpc_task</span> <span class="o">*</span><span class="n">task</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfs_seqid_counter</span> <span class="o">*</span><span class="n">sequence</span> <span class="o">=</span> <span class="n">seqid</span><span class="o">-&gt;</span><span class="n">sequence</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sequence</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">seqid</span><span class="o">-&gt;</span><span class="n">task</span> <span class="o">=</span> <span class="n">task</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">seqid</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">))</span>
		<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">seqid</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sequence</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">list_first_entry</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sequence</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nfs_seqid</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="o">==</span> <span class="n">seqid</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">unlock</span><span class="p">;</span>
	<span class="n">rpc_sleep_on</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sequence</span><span class="o">-&gt;</span><span class="n">wait</span><span class="p">,</span> <span class="n">task</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
<span class="nl">unlock:</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sequence</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">nfs4_run_state_manager</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">nfs4_clear_state_manager_bit</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs_client</span> <span class="o">*</span><span class="n">clp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">smp_mb__before_clear_bit</span><span class="p">();</span>
	<span class="n">clear_bit</span><span class="p">(</span><span class="n">NFS4CLNT_MANAGER_RUNNING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_state</span><span class="p">);</span>
	<span class="n">smp_mb__after_clear_bit</span><span class="p">();</span>
	<span class="n">wake_up_bit</span><span class="p">(</span><span class="o">&amp;</span><span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_state</span><span class="p">,</span> <span class="n">NFS4CLNT_MANAGER_RUNNING</span><span class="p">);</span>
	<span class="n">rpc_wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_rpcwaitq</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Schedule the nfs_client asynchronous state management routine</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">nfs4_schedule_state_manager</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs_client</span> <span class="o">*</span><span class="n">clp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">task_struct</span> <span class="o">*</span><span class="n">task</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="n">INET6_ADDRSTRLEN</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="s">&quot;-manager&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_and_set_bit</span><span class="p">(</span><span class="n">NFS4CLNT_MANAGER_RUNNING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_state</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">__module_get</span><span class="p">(</span><span class="n">THIS_MODULE</span><span class="p">);</span>
	<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_count</span><span class="p">);</span>

	<span class="cm">/* The rcu_read_lock() is not strictly necessary, as the state</span>
<span class="cm">	 * manager is the only thread that ever changes the rpc_xprt</span>
<span class="cm">	 * after it&#39;s initialized.  At this point, we&#39;re single threaded. */</span>
	<span class="n">rcu_read_lock</span><span class="p">();</span>
	<span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="p">),</span> <span class="s">&quot;%s-manager&quot;</span><span class="p">,</span>
			<span class="n">rpc_peeraddr2str</span><span class="p">(</span><span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_rpcclient</span><span class="p">,</span> <span class="n">RPC_DISPLAY_ADDR</span><span class="p">));</span>
	<span class="n">rcu_read_unlock</span><span class="p">();</span>
	<span class="n">task</span> <span class="o">=</span> <span class="n">kthread_run</span><span class="p">(</span><span class="n">nfs4_run_state_manager</span><span class="p">,</span> <span class="n">clp</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">task</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: kthread_run: %ld</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">task</span><span class="p">));</span>
		<span class="n">nfs4_clear_state_manager_bit</span><span class="p">(</span><span class="n">clp</span><span class="p">);</span>
		<span class="n">nfs_put_client</span><span class="p">(</span><span class="n">clp</span><span class="p">);</span>
		<span class="n">module_put</span><span class="p">(</span><span class="n">THIS_MODULE</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Schedule a lease recovery attempt</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">nfs4_schedule_lease_recovery</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs_client</span> <span class="o">*</span><span class="n">clp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">clp</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">NFS4CLNT_LEASE_EXPIRED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_state</span><span class="p">))</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">NFS4CLNT_CHECK_LEASE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_state</span><span class="p">);</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s: scheduling lease recovery for server %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
			<span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_hostname</span><span class="p">);</span>
	<span class="n">nfs4_schedule_state_manager</span><span class="p">(</span><span class="n">clp</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">nfs4_schedule_lease_recovery</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * nfs40_handle_cb_pathdown - return all delegations after NFS4ERR_CB_PATH_DOWN</span>
<span class="cm"> * @clp: client to process</span>
<span class="cm"> *</span>
<span class="cm"> * Set the NFS4CLNT_LEASE_EXPIRED state in order to force a</span>
<span class="cm"> * resend of the SETCLIENTID and hence re-establish the</span>
<span class="cm"> * callback channel. Then return all existing delegations.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">nfs40_handle_cb_pathdown</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs_client</span> <span class="o">*</span><span class="n">clp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">set_bit</span><span class="p">(</span><span class="n">NFS4CLNT_LEASE_EXPIRED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_state</span><span class="p">);</span>
	<span class="n">nfs_expire_all_delegations</span><span class="p">(</span><span class="n">clp</span><span class="p">);</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s: handling CB_PATHDOWN recovery for server %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
			<span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_hostname</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">nfs4_schedule_path_down_recovery</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs_client</span> <span class="o">*</span><span class="n">clp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">nfs40_handle_cb_pathdown</span><span class="p">(</span><span class="n">clp</span><span class="p">);</span>
	<span class="n">nfs4_schedule_state_manager</span><span class="p">(</span><span class="n">clp</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">nfs4_state_mark_reclaim_reboot</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs_client</span> <span class="o">*</span><span class="n">clp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nfs4_state</span> <span class="o">*</span><span class="n">state</span><span class="p">)</span>
<span class="p">{</span>

	<span class="n">set_bit</span><span class="p">(</span><span class="n">NFS_STATE_RECLAIM_REBOOT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
	<span class="cm">/* Don&#39;t recover state that expired before the reboot */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">NFS_STATE_RECLAIM_NOGRACE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">clear_bit</span><span class="p">(</span><span class="n">NFS_STATE_RECLAIM_REBOOT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">set_bit</span><span class="p">(</span><span class="n">NFS_OWNER_RECLAIM_REBOOT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">owner</span><span class="o">-&gt;</span><span class="n">so_flags</span><span class="p">);</span>
	<span class="n">set_bit</span><span class="p">(</span><span class="n">NFS4CLNT_RECLAIM_REBOOT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_state</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">nfs4_state_mark_reclaim_nograce</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs_client</span> <span class="o">*</span><span class="n">clp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nfs4_state</span> <span class="o">*</span><span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">set_bit</span><span class="p">(</span><span class="n">NFS_STATE_RECLAIM_NOGRACE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">clear_bit</span><span class="p">(</span><span class="n">NFS_STATE_RECLAIM_REBOOT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">set_bit</span><span class="p">(</span><span class="n">NFS_OWNER_RECLAIM_NOGRACE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">owner</span><span class="o">-&gt;</span><span class="n">so_flags</span><span class="p">);</span>
	<span class="n">set_bit</span><span class="p">(</span><span class="n">NFS4CLNT_RECLAIM_NOGRACE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_state</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">nfs4_schedule_stateid_recovery</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">nfs_server</span> <span class="o">*</span><span class="n">server</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nfs4_state</span> <span class="o">*</span><span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfs_client</span> <span class="o">*</span><span class="n">clp</span> <span class="o">=</span> <span class="n">server</span><span class="o">-&gt;</span><span class="n">nfs_client</span><span class="p">;</span>

	<span class="n">nfs4_state_mark_reclaim_nograce</span><span class="p">(</span><span class="n">clp</span><span class="p">,</span> <span class="n">state</span><span class="p">);</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s: scheduling stateid recovery for server %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
			<span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_hostname</span><span class="p">);</span>
	<span class="n">nfs4_schedule_state_manager</span><span class="p">(</span><span class="n">clp</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">nfs4_schedule_stateid_recovery</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">nfs_inode_find_state_and_recover</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span>
		<span class="k">const</span> <span class="n">nfs4_stateid</span> <span class="o">*</span><span class="n">stateid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfs_client</span> <span class="o">*</span><span class="n">clp</span> <span class="o">=</span> <span class="n">NFS_SERVER</span><span class="p">(</span><span class="n">inode</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">nfs_client</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nfs_inode</span> <span class="o">*</span><span class="n">nfsi</span> <span class="o">=</span> <span class="n">NFS_I</span><span class="p">(</span><span class="n">inode</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">nfs_open_context</span> <span class="o">*</span><span class="n">ctx</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nfs4_state</span> <span class="o">*</span><span class="n">state</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">found</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_lock</span><span class="p">);</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">nfsi</span><span class="o">-&gt;</span><span class="n">open_files</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">state</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">state</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">NFS_DELEGATED_STATE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">nfs4_stateid_match</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">stateid</span><span class="p">,</span> <span class="n">stateid</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">nfs4_state_mark_reclaim_nograce</span><span class="p">(</span><span class="n">clp</span><span class="p">,</span> <span class="n">state</span><span class="p">);</span>
		<span class="n">found</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">found</span><span class="p">)</span>
		<span class="n">nfs4_schedule_state_manager</span><span class="p">(</span><span class="n">clp</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">nfs4_reclaim_locks</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs4_state</span> <span class="o">*</span><span class="n">state</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">nfs4_state_recovery_ops</span> <span class="o">*</span><span class="n">ops</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span> <span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">inode</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nfs_inode</span> <span class="o">*</span><span class="n">nfsi</span> <span class="o">=</span> <span class="n">NFS_I</span><span class="p">(</span><span class="n">inode</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">file_lock</span> <span class="o">*</span><span class="n">fl</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_flock</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Guard against delegation returns and new lock/unlock calls */</span>
	<span class="n">down_write</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nfsi</span><span class="o">-&gt;</span><span class="n">rwsem</span><span class="p">);</span>
	<span class="cm">/* Protect inode-&gt;i_flock using the BKL */</span>
	<span class="n">lock_flocks</span><span class="p">();</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">fl</span> <span class="o">=</span> <span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_flock</span><span class="p">;</span> <span class="n">fl</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">;</span> <span class="n">fl</span> <span class="o">=</span> <span class="n">fl</span><span class="o">-&gt;</span><span class="n">fl_next</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">fl</span><span class="o">-&gt;</span><span class="n">fl_flags</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">FL_POSIX</span><span class="o">|</span><span class="n">FL_FLOCK</span><span class="p">)))</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">nfs_file_open_context</span><span class="p">(</span><span class="n">fl</span><span class="o">-&gt;</span><span class="n">fl_file</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">!=</span> <span class="n">state</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">unlock_flocks</span><span class="p">();</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">ops</span><span class="o">-&gt;</span><span class="n">recover_lock</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">fl</span><span class="p">);</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="mi">0</span>:
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="o">-</span><span class="n">ESTALE</span>:
			<span class="k">case</span> <span class="o">-</span><span class="n">NFS4ERR_ADMIN_REVOKED</span>:
			<span class="k">case</span> <span class="o">-</span><span class="n">NFS4ERR_STALE_STATEID</span>:
			<span class="k">case</span> <span class="o">-</span><span class="n">NFS4ERR_BAD_STATEID</span>:
			<span class="k">case</span> <span class="o">-</span><span class="n">NFS4ERR_EXPIRED</span>:
			<span class="k">case</span> <span class="o">-</span><span class="n">NFS4ERR_NO_GRACE</span>:
			<span class="k">case</span> <span class="o">-</span><span class="n">NFS4ERR_STALE_CLIENTID</span>:
			<span class="k">case</span> <span class="o">-</span><span class="n">NFS4ERR_BADSESSION</span>:
			<span class="k">case</span> <span class="o">-</span><span class="n">NFS4ERR_BADSLOT</span>:
			<span class="k">case</span> <span class="o">-</span><span class="n">NFS4ERR_BAD_HIGH_SLOT</span>:
			<span class="k">case</span> <span class="o">-</span><span class="n">NFS4ERR_CONN_NOT_BOUND_TO_SESSION</span>:
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
			<span class="nl">default:</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;NFS: %s: unhandled error %d. &quot;</span>
					<span class="s">&quot;Zeroing state</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
			<span class="k">case</span> <span class="o">-</span><span class="n">ENOMEM</span>:
			<span class="k">case</span> <span class="o">-</span><span class="n">NFS4ERR_DENIED</span>:
			<span class="k">case</span> <span class="o">-</span><span class="n">NFS4ERR_RECLAIM_BAD</span>:
			<span class="k">case</span> <span class="o">-</span><span class="n">NFS4ERR_RECLAIM_CONFLICT</span>:
				<span class="cm">/* kill_proc(fl-&gt;fl_pid, SIGLOST, 1); */</span>
				<span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">lock_flocks</span><span class="p">();</span>
	<span class="p">}</span>
	<span class="n">unlock_flocks</span><span class="p">();</span>
<span class="nl">out:</span>
	<span class="n">up_write</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nfsi</span><span class="o">-&gt;</span><span class="n">rwsem</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">nfs4_reclaim_open_state</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs4_state_owner</span> <span class="o">*</span><span class="n">sp</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">nfs4_state_recovery_ops</span> <span class="o">*</span><span class="n">ops</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfs4_state</span> <span class="o">*</span><span class="n">state</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nfs4_lock_state</span> <span class="o">*</span><span class="n">lock</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Note: we rely on the sp-&gt;so_states list being ordered </span>
<span class="cm">	 * so that we always reclaim open(O_RDWR) and/or open(O_WRITE)</span>
<span class="cm">	 * states first.</span>
<span class="cm">	 * This is needed to ensure that the server won&#39;t give us any</span>
<span class="cm">	 * read delegations that we have to return if, say, we are</span>
<span class="cm">	 * recovering after a network partition or a reboot from a</span>
<span class="cm">	 * server that doesn&#39;t support a grace period.</span>
<span class="cm">	 */</span>
<span class="nl">restart:</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">so_lock</span><span class="p">);</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">so_states</span><span class="p">,</span> <span class="n">open_states</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">state_flag_bit</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">);</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">so_lock</span><span class="p">);</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">ops</span><span class="o">-&gt;</span><span class="n">recover_open</span><span class="p">(</span><span class="n">sp</span><span class="p">,</span> <span class="n">state</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">nfs4_reclaim_locks</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">ops</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">state_lock</span><span class="p">);</span>
				<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">lock</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">lock_states</span><span class="p">,</span> <span class="n">ls_locks</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">lock</span><span class="o">-&gt;</span><span class="n">ls_flags</span> <span class="o">&amp;</span> <span class="n">NFS_LOCK_INITIALIZED</span><span class="p">))</span>
						<span class="n">pr_warn_ratelimited</span><span class="p">(</span><span class="s">&quot;NFS: &quot;</span>
							<span class="s">&quot;%s: Lock reclaim &quot;</span>
							<span class="s">&quot;failed!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
				<span class="p">}</span>
				<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">state_lock</span><span class="p">);</span>
				<span class="n">nfs4_put_open_state</span><span class="p">(</span><span class="n">state</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">restart</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
			<span class="nl">default:</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;NFS: %s: unhandled error %d. &quot;</span>
					<span class="s">&quot;Zeroing state</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
			<span class="k">case</span> <span class="o">-</span><span class="n">ENOENT</span>:
			<span class="k">case</span> <span class="o">-</span><span class="n">ENOMEM</span>:
			<span class="k">case</span> <span class="o">-</span><span class="n">ESTALE</span>:
				<span class="cm">/*</span>
<span class="cm">				 * Open state on this file cannot be recovered</span>
<span class="cm">				 * All we can do is revert to using the zero stateid.</span>
<span class="cm">				 */</span>
				<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">stateid</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
					<span class="k">sizeof</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">stateid</span><span class="p">));</span>
				<span class="cm">/* Mark the file as being &#39;closed&#39; */</span>
				<span class="n">state</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="o">-</span><span class="n">EKEYEXPIRED</span>:
				<span class="cm">/*</span>
<span class="cm">				 * User RPCSEC_GSS context has expired.</span>
<span class="cm">				 * We cannot recover this stateid now, so</span>
<span class="cm">				 * skip it and allow recovery thread to</span>
<span class="cm">				 * proceed.</span>
<span class="cm">				 */</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="o">-</span><span class="n">NFS4ERR_ADMIN_REVOKED</span>:
			<span class="k">case</span> <span class="o">-</span><span class="n">NFS4ERR_STALE_STATEID</span>:
			<span class="k">case</span> <span class="o">-</span><span class="n">NFS4ERR_BAD_STATEID</span>:
			<span class="k">case</span> <span class="o">-</span><span class="n">NFS4ERR_RECLAIM_BAD</span>:
			<span class="k">case</span> <span class="o">-</span><span class="n">NFS4ERR_RECLAIM_CONFLICT</span>:
				<span class="n">nfs4_state_mark_reclaim_nograce</span><span class="p">(</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">so_server</span><span class="o">-&gt;</span><span class="n">nfs_client</span><span class="p">,</span> <span class="n">state</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="o">-</span><span class="n">NFS4ERR_EXPIRED</span>:
			<span class="k">case</span> <span class="o">-</span><span class="n">NFS4ERR_NO_GRACE</span>:
				<span class="n">nfs4_state_mark_reclaim_nograce</span><span class="p">(</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">so_server</span><span class="o">-&gt;</span><span class="n">nfs_client</span><span class="p">,</span> <span class="n">state</span><span class="p">);</span>
			<span class="k">case</span> <span class="o">-</span><span class="n">NFS4ERR_STALE_CLIENTID</span>:
			<span class="k">case</span> <span class="o">-</span><span class="n">NFS4ERR_BADSESSION</span>:
			<span class="k">case</span> <span class="o">-</span><span class="n">NFS4ERR_BADSLOT</span>:
			<span class="k">case</span> <span class="o">-</span><span class="n">NFS4ERR_BAD_HIGH_SLOT</span>:
			<span class="k">case</span> <span class="o">-</span><span class="n">NFS4ERR_CONN_NOT_BOUND_TO_SESSION</span>:
				<span class="k">goto</span> <span class="n">out_err</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">nfs4_put_open_state</span><span class="p">(</span><span class="n">state</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">restart</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">so_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">out_err:</span>
	<span class="n">nfs4_put_open_state</span><span class="p">(</span><span class="n">state</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">nfs4_clear_open_state</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs4_state</span> <span class="o">*</span><span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfs4_lock_state</span> <span class="o">*</span><span class="n">lock</span><span class="p">;</span>

	<span class="n">clear_bit</span><span class="p">(</span><span class="n">NFS_DELEGATED_STATE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">clear_bit</span><span class="p">(</span><span class="n">NFS_O_RDONLY_STATE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">clear_bit</span><span class="p">(</span><span class="n">NFS_O_WRONLY_STATE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">clear_bit</span><span class="p">(</span><span class="n">NFS_O_RDWR_STATE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">state_lock</span><span class="p">);</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">lock</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">lock_states</span><span class="p">,</span> <span class="n">ls_locks</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">lock</span><span class="o">-&gt;</span><span class="n">ls_seqid</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">lock</span><span class="o">-&gt;</span><span class="n">ls_flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">NFS_LOCK_INITIALIZED</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">state_lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">nfs4_reset_seqids</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs_server</span> <span class="o">*</span><span class="n">server</span><span class="p">,</span>
	<span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">mark_reclaim</span><span class="p">)(</span><span class="k">struct</span> <span class="n">nfs_client</span> <span class="o">*</span><span class="n">clp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nfs4_state</span> <span class="o">*</span><span class="n">state</span><span class="p">))</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfs_client</span> <span class="o">*</span><span class="n">clp</span> <span class="o">=</span> <span class="n">server</span><span class="o">-&gt;</span><span class="n">nfs_client</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nfs4_state_owner</span> <span class="o">*</span><span class="n">sp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rb_node</span> <span class="o">*</span><span class="n">pos</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nfs4_state</span> <span class="o">*</span><span class="n">state</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_lock</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">pos</span> <span class="o">=</span> <span class="n">rb_first</span><span class="p">(</span><span class="o">&amp;</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">state_owners</span><span class="p">);</span>
	     <span class="n">pos</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">;</span>
	     <span class="n">pos</span> <span class="o">=</span> <span class="n">rb_next</span><span class="p">(</span><span class="n">pos</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">sp</span> <span class="o">=</span> <span class="n">rb_entry</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nfs4_state_owner</span><span class="p">,</span> <span class="n">so_server_node</span><span class="p">);</span>
		<span class="n">sp</span><span class="o">-&gt;</span><span class="n">so_seqid</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">so_lock</span><span class="p">);</span>
		<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">so_states</span><span class="p">,</span> <span class="n">open_states</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">mark_reclaim</span><span class="p">(</span><span class="n">clp</span><span class="p">,</span> <span class="n">state</span><span class="p">))</span>
				<span class="n">nfs4_clear_open_state</span><span class="p">(</span><span class="n">state</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">so_lock</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">nfs4_state_mark_reclaim_helper</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs_client</span> <span class="o">*</span><span class="n">clp</span><span class="p">,</span>
	<span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">mark_reclaim</span><span class="p">)(</span><span class="k">struct</span> <span class="n">nfs_client</span> <span class="o">*</span><span class="n">clp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nfs4_state</span> <span class="o">*</span><span class="n">state</span><span class="p">))</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfs_server</span> <span class="o">*</span><span class="n">server</span><span class="p">;</span>

	<span class="n">rcu_read_lock</span><span class="p">();</span>
	<span class="n">list_for_each_entry_rcu</span><span class="p">(</span><span class="n">server</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_superblocks</span><span class="p">,</span> <span class="n">client_link</span><span class="p">)</span>
		<span class="n">nfs4_reset_seqids</span><span class="p">(</span><span class="n">server</span><span class="p">,</span> <span class="n">mark_reclaim</span><span class="p">);</span>
	<span class="n">rcu_read_unlock</span><span class="p">();</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">nfs4_state_start_reclaim_reboot</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs_client</span> <span class="o">*</span><span class="n">clp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Mark all delegations for reclaim */</span>
	<span class="n">nfs_delegation_mark_reclaim</span><span class="p">(</span><span class="n">clp</span><span class="p">);</span>
	<span class="n">nfs4_state_mark_reclaim_helper</span><span class="p">(</span><span class="n">clp</span><span class="p">,</span> <span class="n">nfs4_state_mark_reclaim_reboot</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">nfs4_reclaim_complete</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs_client</span> <span class="o">*</span><span class="n">clp</span><span class="p">,</span>
				 <span class="k">const</span> <span class="k">struct</span> <span class="n">nfs4_state_recovery_ops</span> <span class="o">*</span><span class="n">ops</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Notify the server we&#39;re done reclaiming our state */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">reclaim_complete</span><span class="p">)</span>
		<span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">reclaim_complete</span><span class="p">(</span><span class="n">clp</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">nfs4_clear_reclaim_server</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs_server</span> <span class="o">*</span><span class="n">server</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfs_client</span> <span class="o">*</span><span class="n">clp</span> <span class="o">=</span> <span class="n">server</span><span class="o">-&gt;</span><span class="n">nfs_client</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nfs4_state_owner</span> <span class="o">*</span><span class="n">sp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rb_node</span> <span class="o">*</span><span class="n">pos</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nfs4_state</span> <span class="o">*</span><span class="n">state</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_lock</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">pos</span> <span class="o">=</span> <span class="n">rb_first</span><span class="p">(</span><span class="o">&amp;</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">state_owners</span><span class="p">);</span>
	     <span class="n">pos</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">;</span>
	     <span class="n">pos</span> <span class="o">=</span> <span class="n">rb_next</span><span class="p">(</span><span class="n">pos</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">sp</span> <span class="o">=</span> <span class="n">rb_entry</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nfs4_state_owner</span><span class="p">,</span> <span class="n">so_server_node</span><span class="p">);</span>
		<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">so_lock</span><span class="p">);</span>
		<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">so_states</span><span class="p">,</span> <span class="n">open_states</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">NFS_STATE_RECLAIM_REBOOT</span><span class="p">,</span>
						<span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="n">nfs4_state_mark_reclaim_nograce</span><span class="p">(</span><span class="n">clp</span><span class="p">,</span> <span class="n">state</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">so_lock</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">nfs4_state_clear_reclaim_reboot</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs_client</span> <span class="o">*</span><span class="n">clp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfs_server</span> <span class="o">*</span><span class="n">server</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">NFS4CLNT_RECLAIM_REBOOT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_state</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">rcu_read_lock</span><span class="p">();</span>
	<span class="n">list_for_each_entry_rcu</span><span class="p">(</span><span class="n">server</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_superblocks</span><span class="p">,</span> <span class="n">client_link</span><span class="p">)</span>
		<span class="n">nfs4_clear_reclaim_server</span><span class="p">(</span><span class="n">server</span><span class="p">);</span>
	<span class="n">rcu_read_unlock</span><span class="p">();</span>

	<span class="n">nfs_delegation_reap_unclaimed</span><span class="p">(</span><span class="n">clp</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">nfs4_state_end_reclaim_reboot</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs_client</span> <span class="o">*</span><span class="n">clp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">nfs4_state_clear_reclaim_reboot</span><span class="p">(</span><span class="n">clp</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">nfs4_reclaim_complete</span><span class="p">(</span><span class="n">clp</span><span class="p">,</span> <span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_mvops</span><span class="o">-&gt;</span><span class="n">reboot_recovery_ops</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">nfs_delegation_clear_all</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs_client</span> <span class="o">*</span><span class="n">clp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">nfs_delegation_mark_reclaim</span><span class="p">(</span><span class="n">clp</span><span class="p">);</span>
	<span class="n">nfs_delegation_reap_unclaimed</span><span class="p">(</span><span class="n">clp</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">nfs4_state_start_reclaim_nograce</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs_client</span> <span class="o">*</span><span class="n">clp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">nfs_delegation_clear_all</span><span class="p">(</span><span class="n">clp</span><span class="p">);</span>
	<span class="n">nfs4_state_mark_reclaim_helper</span><span class="p">(</span><span class="n">clp</span><span class="p">,</span> <span class="n">nfs4_state_mark_reclaim_nograce</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">nfs4_warn_keyexpired</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">s</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">printk_ratelimited</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;Error: state manager&quot;</span>
			<span class="s">&quot; encountered RPCSEC_GSS session&quot;</span>
			<span class="s">&quot; expired against NFSv4 server %s.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">s</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">nfs4_recovery_handle_error</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs_client</span> <span class="o">*</span><span class="n">clp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">error</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">0</span>:
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="o">-</span><span class="n">NFS4ERR_CB_PATH_DOWN</span>:
			<span class="n">nfs40_handle_cb_pathdown</span><span class="p">(</span><span class="n">clp</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="o">-</span><span class="n">NFS4ERR_NO_GRACE</span>:
			<span class="n">nfs4_state_end_reclaim_reboot</span><span class="p">(</span><span class="n">clp</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="o">-</span><span class="n">NFS4ERR_STALE_CLIENTID</span>:
		<span class="k">case</span> <span class="o">-</span><span class="n">NFS4ERR_LEASE_MOVED</span>:
			<span class="n">set_bit</span><span class="p">(</span><span class="n">NFS4CLNT_LEASE_EXPIRED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_state</span><span class="p">);</span>
			<span class="n">nfs4_state_clear_reclaim_reboot</span><span class="p">(</span><span class="n">clp</span><span class="p">);</span>
			<span class="n">nfs4_state_start_reclaim_reboot</span><span class="p">(</span><span class="n">clp</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="o">-</span><span class="n">NFS4ERR_EXPIRED</span>:
			<span class="n">set_bit</span><span class="p">(</span><span class="n">NFS4CLNT_LEASE_EXPIRED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_state</span><span class="p">);</span>
			<span class="n">nfs4_state_start_reclaim_nograce</span><span class="p">(</span><span class="n">clp</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="o">-</span><span class="n">NFS4ERR_BADSESSION</span>:
		<span class="k">case</span> <span class="o">-</span><span class="n">NFS4ERR_BADSLOT</span>:
		<span class="k">case</span> <span class="o">-</span><span class="n">NFS4ERR_BAD_HIGH_SLOT</span>:
		<span class="k">case</span> <span class="o">-</span><span class="n">NFS4ERR_DEADSESSION</span>:
		<span class="k">case</span> <span class="o">-</span><span class="n">NFS4ERR_SEQ_FALSE_RETRY</span>:
		<span class="k">case</span> <span class="o">-</span><span class="n">NFS4ERR_SEQ_MISORDERED</span>:
			<span class="n">set_bit</span><span class="p">(</span><span class="n">NFS4CLNT_SESSION_RESET</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_state</span><span class="p">);</span>
			<span class="cm">/* Zero session reset errors */</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="o">-</span><span class="n">NFS4ERR_CONN_NOT_BOUND_TO_SESSION</span>:
			<span class="n">set_bit</span><span class="p">(</span><span class="n">NFS4CLNT_BIND_CONN_TO_SESSION</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_state</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="o">-</span><span class="n">EKEYEXPIRED</span>:
			<span class="cm">/* Nothing we can do */</span>
			<span class="n">nfs4_warn_keyexpired</span><span class="p">(</span><span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_hostname</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s: failed to handle error %d for server %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">__func__</span><span class="p">,</span> <span class="n">error</span><span class="p">,</span> <span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_hostname</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s: handled error %d for server %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">error</span><span class="p">,</span>
			<span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_hostname</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">nfs4_do_reclaim</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs_client</span> <span class="o">*</span><span class="n">clp</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">nfs4_state_recovery_ops</span> <span class="o">*</span><span class="n">ops</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfs4_state_owner</span> <span class="o">*</span><span class="n">sp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nfs_server</span> <span class="o">*</span><span class="n">server</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rb_node</span> <span class="o">*</span><span class="n">pos</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">restart:</span>
	<span class="n">rcu_read_lock</span><span class="p">();</span>
	<span class="n">list_for_each_entry_rcu</span><span class="p">(</span><span class="n">server</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_superblocks</span><span class="p">,</span> <span class="n">client_link</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">nfs4_purge_state_owners</span><span class="p">(</span><span class="n">server</span><span class="p">);</span>
		<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_lock</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">pos</span> <span class="o">=</span> <span class="n">rb_first</span><span class="p">(</span><span class="o">&amp;</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">state_owners</span><span class="p">);</span>
		     <span class="n">pos</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">;</span>
		     <span class="n">pos</span> <span class="o">=</span> <span class="n">rb_next</span><span class="p">(</span><span class="n">pos</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">sp</span> <span class="o">=</span> <span class="n">rb_entry</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">nfs4_state_owner</span><span class="p">,</span> <span class="n">so_server_node</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">owner_flag_bit</span><span class="p">,</span>
							<span class="o">&amp;</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">so_flags</span><span class="p">))</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">so_count</span><span class="p">);</span>
			<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_lock</span><span class="p">);</span>
			<span class="n">rcu_read_unlock</span><span class="p">();</span>

			<span class="n">status</span> <span class="o">=</span> <span class="n">nfs4_reclaim_open_state</span><span class="p">(</span><span class="n">sp</span><span class="p">,</span> <span class="n">ops</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">set_bit</span><span class="p">(</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">owner_flag_bit</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">so_flags</span><span class="p">);</span>
				<span class="n">nfs4_put_state_owner</span><span class="p">(</span><span class="n">sp</span><span class="p">);</span>
				<span class="k">return</span> <span class="n">nfs4_recovery_handle_error</span><span class="p">(</span><span class="n">clp</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
			<span class="p">}</span>

			<span class="n">nfs4_put_state_owner</span><span class="p">(</span><span class="n">sp</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">restart</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_lock</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">rcu_read_unlock</span><span class="p">();</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">nfs4_check_lease</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs_client</span> <span class="o">*</span><span class="n">clp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rpc_cred</span> <span class="o">*</span><span class="n">cred</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">nfs4_state_maintenance_ops</span> <span class="o">*</span><span class="n">ops</span> <span class="o">=</span>
		<span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_mvops</span><span class="o">-&gt;</span><span class="n">state_renewal_ops</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>

	<span class="cm">/* Is the client already known to have an expired lease? */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">NFS4CLNT_LEASE_EXPIRED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_state</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_lock</span><span class="p">);</span>
	<span class="n">cred</span> <span class="o">=</span> <span class="n">ops</span><span class="o">-&gt;</span><span class="n">get_state_renewal_cred_locked</span><span class="p">(</span><span class="n">clp</span><span class="p">);</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cred</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cred</span> <span class="o">=</span> <span class="n">nfs4_get_setclientid_cred</span><span class="p">(</span><span class="n">clp</span><span class="p">);</span>
		<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOKEY</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cred</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">ops</span><span class="o">-&gt;</span><span class="n">renew_lease</span><span class="p">(</span><span class="n">clp</span><span class="p">,</span> <span class="n">cred</span><span class="p">);</span>
	<span class="n">put_rpccred</span><span class="p">(</span><span class="n">cred</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">nfs4_recovery_handle_error</span><span class="p">(</span><span class="n">clp</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Set NFS4CLNT_LEASE_EXPIRED for all v4.0 errors and for recoverable errors</span>
<span class="cm"> * on EXCHANGE_ID for v4.1</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">nfs4_handle_reclaim_lease_error</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs_client</span> <span class="o">*</span><span class="n">clp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="o">-</span><span class="n">NFS4ERR_SEQ_MISORDERED</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">test_and_set_bit</span><span class="p">(</span><span class="n">NFS4CLNT_PURGE_STATE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_state</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ESERVERFAULT</span><span class="p">;</span>
		<span class="cm">/* Lease confirmation error: retry after purging the lease */</span>
		<span class="n">ssleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="k">case</span> <span class="o">-</span><span class="n">NFS4ERR_CLID_INUSE</span>:
	<span class="k">case</span> <span class="o">-</span><span class="n">NFS4ERR_STALE_CLIENTID</span>:
		<span class="n">clear_bit</span><span class="p">(</span><span class="n">NFS4CLNT_LEASE_CONFIRM</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_state</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="o">-</span><span class="n">EACCES</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_machine_cred</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EACCES</span><span class="p">;</span>
		<span class="cm">/* Handle case where the user hasn&#39;t set up machine creds */</span>
		<span class="n">nfs4_clear_machine_cred</span><span class="p">(</span><span class="n">clp</span><span class="p">);</span>
	<span class="k">case</span> <span class="o">-</span><span class="n">NFS4ERR_DELAY</span>:
	<span class="k">case</span> <span class="o">-</span><span class="n">ETIMEDOUT</span>:
	<span class="k">case</span> <span class="o">-</span><span class="n">EAGAIN</span>:
		<span class="n">ssleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="o">-</span><span class="n">NFS4ERR_MINOR_VERS_MISMATCH</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_cons_state</span> <span class="o">==</span> <span class="n">NFS_CS_SESSION_INITING</span><span class="p">)</span>
			<span class="n">nfs_mark_client_ready</span><span class="p">(</span><span class="n">clp</span><span class="p">,</span> <span class="o">-</span><span class="n">EPROTONOSUPPORT</span><span class="p">);</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s: exit with error %d for server %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">__func__</span><span class="p">,</span> <span class="o">-</span><span class="n">EPROTONOSUPPORT</span><span class="p">,</span> <span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_hostname</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EPROTONOSUPPORT</span><span class="p">;</span>
	<span class="k">case</span> <span class="o">-</span><span class="n">EKEYEXPIRED</span>:
		<span class="n">nfs4_warn_keyexpired</span><span class="p">(</span><span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_hostname</span><span class="p">);</span>
	<span class="k">case</span> <span class="o">-</span><span class="n">NFS4ERR_NOT_SAME</span>: <span class="cm">/* FixMe: implement recovery</span>
<span class="cm">				 * in nfs4_exchange_id */</span>
	<span class="nl">default:</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s: exit with error %d for server %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
				<span class="n">status</span><span class="p">,</span> <span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_hostname</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">set_bit</span><span class="p">(</span><span class="n">NFS4CLNT_LEASE_EXPIRED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_state</span><span class="p">);</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s: handled error %d for server %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span>
			<span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_hostname</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">nfs4_reclaim_lease</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs_client</span> <span class="o">*</span><span class="n">clp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rpc_cred</span> <span class="o">*</span><span class="n">cred</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">nfs4_state_recovery_ops</span> <span class="o">*</span><span class="n">ops</span> <span class="o">=</span>
		<span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_mvops</span><span class="o">-&gt;</span><span class="n">reboot_recovery_ops</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">cred</span> <span class="o">=</span> <span class="n">ops</span><span class="o">-&gt;</span><span class="n">get_clid_cred</span><span class="p">(</span><span class="n">clp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cred</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">ops</span><span class="o">-&gt;</span><span class="n">establish_clid</span><span class="p">(</span><span class="n">clp</span><span class="p">,</span> <span class="n">cred</span><span class="p">);</span>
	<span class="n">put_rpccred</span><span class="p">(</span><span class="n">cred</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">nfs4_handle_reclaim_lease_error</span><span class="p">(</span><span class="n">clp</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_NFS_V4_1</span>
<span class="kt">void</span> <span class="nf">nfs4_schedule_session_recovery</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs4_session</span> <span class="o">*</span><span class="n">session</span><span class="p">,</span> <span class="kt">int</span> <span class="n">err</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfs_client</span> <span class="o">*</span><span class="n">clp</span> <span class="o">=</span> <span class="n">session</span><span class="o">-&gt;</span><span class="n">clp</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
	<span class="nl">default:</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">NFS4CLNT_SESSION_RESET</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_state</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="o">-</span><span class="n">NFS4ERR_CONN_NOT_BOUND_TO_SESSION</span>:
		<span class="n">set_bit</span><span class="p">(</span><span class="n">NFS4CLNT_BIND_CONN_TO_SESSION</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_state</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">nfs4_schedule_lease_recovery</span><span class="p">(</span><span class="n">clp</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">nfs4_schedule_session_recovery</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">nfs41_handle_recall_slot</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs_client</span> <span class="o">*</span><span class="n">clp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">set_bit</span><span class="p">(</span><span class="n">NFS4CLNT_RECALL_SLOT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_state</span><span class="p">);</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s: scheduling slot recall for server %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
			<span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_hostname</span><span class="p">);</span>
	<span class="n">nfs4_schedule_state_manager</span><span class="p">(</span><span class="n">clp</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">nfs4_reset_all_state</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs_client</span> <span class="o">*</span><span class="n">clp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_and_set_bit</span><span class="p">(</span><span class="n">NFS4CLNT_LEASE_EXPIRED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_state</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">NFS4CLNT_PURGE_STATE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_state</span><span class="p">);</span>
		<span class="n">clear_bit</span><span class="p">(</span><span class="n">NFS4CLNT_LEASE_CONFIRM</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_state</span><span class="p">);</span>
		<span class="n">nfs4_state_start_reclaim_nograce</span><span class="p">(</span><span class="n">clp</span><span class="p">);</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s: scheduling reset of all state for server %s!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">__func__</span><span class="p">,</span> <span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_hostname</span><span class="p">);</span>
		<span class="n">nfs4_schedule_state_manager</span><span class="p">(</span><span class="n">clp</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">nfs41_handle_server_reboot</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs_client</span> <span class="o">*</span><span class="n">clp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_and_set_bit</span><span class="p">(</span><span class="n">NFS4CLNT_LEASE_EXPIRED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_state</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">nfs4_state_start_reclaim_reboot</span><span class="p">(</span><span class="n">clp</span><span class="p">);</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s: server %s rebooted!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
				<span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_hostname</span><span class="p">);</span>
		<span class="n">nfs4_schedule_state_manager</span><span class="p">(</span><span class="n">clp</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">nfs41_handle_state_revoked</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs_client</span> <span class="o">*</span><span class="n">clp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">nfs4_reset_all_state</span><span class="p">(</span><span class="n">clp</span><span class="p">);</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s: state revoked on server %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_hostname</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">nfs41_handle_recallable_state_revoked</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs_client</span> <span class="o">*</span><span class="n">clp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* This will need to handle layouts too */</span>
	<span class="n">nfs_expire_all_delegations</span><span class="p">(</span><span class="n">clp</span><span class="p">);</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s: Recallable state revoked on server %s!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
			<span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_hostname</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">nfs41_handle_backchannel_fault</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs_client</span> <span class="o">*</span><span class="n">clp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">nfs_expire_all_delegations</span><span class="p">(</span><span class="n">clp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_and_set_bit</span><span class="p">(</span><span class="n">NFS4CLNT_SESSION_RESET</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_state</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">nfs4_schedule_state_manager</span><span class="p">(</span><span class="n">clp</span><span class="p">);</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s: server %s declared a backchannel fault</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
			<span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_hostname</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">nfs41_handle_cb_path_down</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs_client</span> <span class="o">*</span><span class="n">clp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_and_set_bit</span><span class="p">(</span><span class="n">NFS4CLNT_BIND_CONN_TO_SESSION</span><span class="p">,</span>
		<span class="o">&amp;</span><span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_state</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">nfs4_schedule_state_manager</span><span class="p">(</span><span class="n">clp</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">nfs41_handle_sequence_flag_errors</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs_client</span> <span class="o">*</span><span class="n">clp</span><span class="p">,</span> <span class="n">u32</span> <span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">flags</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s: </span><span class="se">\&quot;</span><span class="s">%s</span><span class="se">\&quot;</span><span class="s"> (client ID %llx) flags=0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">__func__</span><span class="p">,</span> <span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_hostname</span><span class="p">,</span> <span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_clientid</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SEQ4_STATUS_RESTART_RECLAIM_NEEDED</span><span class="p">)</span>
		<span class="n">nfs41_handle_server_reboot</span><span class="p">(</span><span class="n">clp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">SEQ4_STATUS_EXPIRED_ALL_STATE_REVOKED</span> <span class="o">|</span>
			    <span class="n">SEQ4_STATUS_EXPIRED_SOME_STATE_REVOKED</span> <span class="o">|</span>
			    <span class="n">SEQ4_STATUS_ADMIN_STATE_REVOKED</span> <span class="o">|</span>
			    <span class="n">SEQ4_STATUS_LEASE_MOVED</span><span class="p">))</span>
		<span class="n">nfs41_handle_state_revoked</span><span class="p">(</span><span class="n">clp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SEQ4_STATUS_RECALLABLE_STATE_REVOKED</span><span class="p">)</span>
		<span class="n">nfs41_handle_recallable_state_revoked</span><span class="p">(</span><span class="n">clp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SEQ4_STATUS_BACKCHANNEL_FAULT</span><span class="p">)</span>
		<span class="n">nfs41_handle_backchannel_fault</span><span class="p">(</span><span class="n">clp</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">SEQ4_STATUS_CB_PATH_DOWN</span> <span class="o">|</span>
				<span class="n">SEQ4_STATUS_CB_PATH_DOWN_SESSION</span><span class="p">))</span>
		<span class="n">nfs41_handle_cb_path_down</span><span class="p">(</span><span class="n">clp</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">nfs4_reset_session</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs_client</span> <span class="o">*</span><span class="n">clp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rpc_cred</span> <span class="o">*</span><span class="n">cred</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">nfs4_begin_drain_session</span><span class="p">(</span><span class="n">clp</span><span class="p">);</span>
	<span class="n">cred</span> <span class="o">=</span> <span class="n">nfs4_get_exchange_id_cred</span><span class="p">(</span><span class="n">clp</span><span class="p">);</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">nfs4_proc_destroy_session</span><span class="p">(</span><span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_session</span><span class="p">,</span> <span class="n">cred</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;&amp;</span> <span class="n">status</span> <span class="o">!=</span> <span class="o">-</span><span class="n">NFS4ERR_BADSESSION</span> <span class="o">&amp;&amp;</span>
	    <span class="n">status</span> <span class="o">!=</span> <span class="o">-</span><span class="n">NFS4ERR_DEADSESSION</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">nfs4_recovery_handle_error</span><span class="p">(</span><span class="n">clp</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_session</span><span class="o">-&gt;</span><span class="n">sess_id</span><span class="p">.</span><span class="n">data</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">NFS4_MAX_SESSIONID_LEN</span><span class="p">);</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">nfs4_proc_create_session</span><span class="p">(</span><span class="n">clp</span><span class="p">,</span> <span class="n">cred</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s: session reset failed with status %d for server %s!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_hostname</span><span class="p">);</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">nfs4_handle_reclaim_lease_error</span><span class="p">(</span><span class="n">clp</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">nfs41_finish_session_reset</span><span class="p">(</span><span class="n">clp</span><span class="p">);</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s: session reset was successful for server %s!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span> <span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_hostname</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cred</span><span class="p">)</span>
		<span class="n">put_rpccred</span><span class="p">(</span><span class="n">cred</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">nfs4_recall_slot</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs_client</span> <span class="o">*</span><span class="n">clp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfs4_slot_table</span> <span class="o">*</span><span class="n">fc_tbl</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_session</span><span class="o">-&gt;</span><span class="n">fc_slot_table</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nfs4_channel_attrs</span> <span class="o">*</span><span class="n">fc_attrs</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_session</span><span class="o">-&gt;</span><span class="n">fc_attrs</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nfs4_slot</span> <span class="o">*</span><span class="n">new</span><span class="p">,</span> <span class="o">*</span><span class="n">old</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">nfs4_begin_drain_session</span><span class="p">(</span><span class="n">clp</span><span class="p">);</span>
	<span class="n">new</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">fc_tbl</span><span class="o">-&gt;</span><span class="n">target_max_slots</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs4_slot</span><span class="p">),</span>
		      <span class="n">GFP_NOFS</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">new</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fc_tbl</span><span class="o">-&gt;</span><span class="n">slot_tbl_lock</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">fc_tbl</span><span class="o">-&gt;</span><span class="n">target_max_slots</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">new</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">seq_nr</span> <span class="o">=</span> <span class="n">fc_tbl</span><span class="o">-&gt;</span><span class="n">slots</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">seq_nr</span><span class="p">;</span>
	<span class="n">old</span> <span class="o">=</span> <span class="n">fc_tbl</span><span class="o">-&gt;</span><span class="n">slots</span><span class="p">;</span>
	<span class="n">fc_tbl</span><span class="o">-&gt;</span><span class="n">slots</span> <span class="o">=</span> <span class="n">new</span><span class="p">;</span>
	<span class="n">fc_tbl</span><span class="o">-&gt;</span><span class="n">max_slots</span> <span class="o">=</span> <span class="n">fc_tbl</span><span class="o">-&gt;</span><span class="n">target_max_slots</span><span class="p">;</span>
	<span class="n">fc_tbl</span><span class="o">-&gt;</span><span class="n">target_max_slots</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">fc_attrs</span><span class="o">-&gt;</span><span class="n">max_reqs</span> <span class="o">=</span> <span class="n">fc_tbl</span><span class="o">-&gt;</span><span class="n">max_slots</span><span class="p">;</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fc_tbl</span><span class="o">-&gt;</span><span class="n">slot_tbl_lock</span><span class="p">);</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">old</span><span class="p">);</span>
	<span class="n">nfs4_end_drain_session</span><span class="p">(</span><span class="n">clp</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">nfs4_bind_conn_to_session</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs_client</span> <span class="o">*</span><span class="n">clp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rpc_cred</span> <span class="o">*</span><span class="n">cred</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">nfs4_begin_drain_session</span><span class="p">(</span><span class="n">clp</span><span class="p">);</span>
	<span class="n">cred</span> <span class="o">=</span> <span class="n">nfs4_get_exchange_id_cred</span><span class="p">(</span><span class="n">clp</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">nfs4_proc_bind_conn_to_session</span><span class="p">(</span><span class="n">clp</span><span class="p">,</span> <span class="n">cred</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cred</span><span class="p">)</span>
		<span class="n">put_rpccred</span><span class="p">(</span><span class="n">cred</span><span class="p">);</span>
	<span class="n">clear_bit</span><span class="p">(</span><span class="n">NFS4CLNT_BIND_CONN_TO_SESSION</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_state</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>:
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s: bind_conn_to_session was successful for server %s!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span> <span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_hostname</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="o">-</span><span class="n">NFS4ERR_DELAY</span>:
		<span class="n">ssleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">NFS4CLNT_BIND_CONN_TO_SESSION</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_state</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="n">nfs4_recovery_handle_error</span><span class="p">(</span><span class="n">clp</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#else </span><span class="cm">/* CONFIG_NFS_V4_1 */</span><span class="cp"></span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">nfs4_reset_session</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs_client</span> <span class="o">*</span><span class="n">clp</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="mi">0</span><span class="p">;</span> <span class="p">}</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">nfs4_end_drain_session</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs_client</span> <span class="o">*</span><span class="n">clp</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="mi">0</span><span class="p">;</span> <span class="p">}</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">nfs4_recall_slot</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs_client</span> <span class="o">*</span><span class="n">clp</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="mi">0</span><span class="p">;</span> <span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">nfs4_bind_conn_to_session</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs_client</span> <span class="o">*</span><span class="n">clp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_NFS_V4_1 */</span><span class="cp"></span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">nfs4_state_manager</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs_client</span> <span class="o">*</span><span class="n">clp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Ensure exclusive access to NFSv4 state */</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">NFS4CLNT_PURGE_STATE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_state</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">nfs4_reclaim_lease</span><span class="p">(</span><span class="n">clp</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">out_error</span><span class="p">;</span>
			<span class="n">clear_bit</span><span class="p">(</span><span class="n">NFS4CLNT_PURGE_STATE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_state</span><span class="p">);</span>
			<span class="n">set_bit</span><span class="p">(</span><span class="n">NFS4CLNT_LEASE_EXPIRED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_state</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">NFS4CLNT_LEASE_EXPIRED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_state</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* We&#39;re going to have to re-establish a clientid */</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">nfs4_reclaim_lease</span><span class="p">(</span><span class="n">clp</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">out_error</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">NFS4CLNT_LEASE_EXPIRED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_state</span><span class="p">))</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="n">clear_bit</span><span class="p">(</span><span class="n">NFS4CLNT_CHECK_LEASE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_state</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">NFS4CLNT_SERVER_SCOPE_MISMATCH</span><span class="p">,</span>
					       <span class="o">&amp;</span><span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_state</span><span class="p">))</span>
				<span class="n">nfs4_state_start_reclaim_nograce</span><span class="p">(</span><span class="n">clp</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">set_bit</span><span class="p">(</span><span class="n">NFS4CLNT_RECLAIM_REBOOT</span><span class="p">,</span>
					<span class="o">&amp;</span><span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_state</span><span class="p">);</span>

			<span class="n">pnfs_destroy_all_layouts</span><span class="p">(</span><span class="n">clp</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">NFS4CLNT_CHECK_LEASE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_state</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">nfs4_check_lease</span><span class="p">(</span><span class="n">clp</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">out_error</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">NFS4CLNT_LEASE_EXPIRED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_state</span><span class="p">))</span>
				<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* Initialize or reset the session */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">NFS4CLNT_SESSION_RESET</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_state</span><span class="p">)</span>
		   <span class="o">&amp;&amp;</span> <span class="n">nfs4_has_session</span><span class="p">(</span><span class="n">clp</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">nfs4_reset_session</span><span class="p">(</span><span class="n">clp</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">NFS4CLNT_LEASE_EXPIRED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_state</span><span class="p">))</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">out_error</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* Send BIND_CONN_TO_SESSION */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">NFS4CLNT_BIND_CONN_TO_SESSION</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_state</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">nfs4_has_session</span><span class="p">(</span><span class="n">clp</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">nfs4_bind_conn_to_session</span><span class="p">(</span><span class="n">clp</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">out_error</span><span class="p">;</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* First recover reboot state... */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">NFS4CLNT_RECLAIM_REBOOT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_state</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">nfs4_do_reclaim</span><span class="p">(</span><span class="n">clp</span><span class="p">,</span>
				<span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_mvops</span><span class="o">-&gt;</span><span class="n">reboot_recovery_ops</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">NFS4CLNT_LEASE_EXPIRED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_state</span><span class="p">)</span> <span class="o">||</span>
			    <span class="n">test_bit</span><span class="p">(</span><span class="n">NFS4CLNT_SESSION_RESET</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_state</span><span class="p">))</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="n">nfs4_state_end_reclaim_reboot</span><span class="p">(</span><span class="n">clp</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">NFS4CLNT_RECLAIM_NOGRACE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_state</span><span class="p">))</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">out_error</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* Now recover expired state... */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">NFS4CLNT_RECLAIM_NOGRACE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_state</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">nfs4_do_reclaim</span><span class="p">(</span><span class="n">clp</span><span class="p">,</span>
				<span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_mvops</span><span class="o">-&gt;</span><span class="n">nograce_recovery_ops</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">NFS4CLNT_LEASE_EXPIRED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_state</span><span class="p">)</span> <span class="o">||</span>
			    <span class="n">test_bit</span><span class="p">(</span><span class="n">NFS4CLNT_SESSION_RESET</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_state</span><span class="p">)</span> <span class="o">||</span>
			    <span class="n">test_bit</span><span class="p">(</span><span class="n">NFS4CLNT_RECLAIM_REBOOT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_state</span><span class="p">))</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">out_error</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">nfs4_end_drain_session</span><span class="p">(</span><span class="n">clp</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">NFS4CLNT_DELEGRETURN</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_state</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">nfs_client_return_marked_delegations</span><span class="p">(</span><span class="n">clp</span><span class="p">);</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* Recall session slots */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">NFS4CLNT_RECALL_SLOT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_state</span><span class="p">)</span>
		   <span class="o">&amp;&amp;</span> <span class="n">nfs4_has_session</span><span class="p">(</span><span class="n">clp</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">nfs4_recall_slot</span><span class="p">(</span><span class="n">clp</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">out_error</span><span class="p">;</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>


		<span class="n">nfs4_clear_state_manager_bit</span><span class="p">(</span><span class="n">clp</span><span class="p">);</span>
		<span class="cm">/* Did we race with an attempt to give us more work? */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_state</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">test_and_set_bit</span><span class="p">(</span><span class="n">NFS4CLNT_MANAGER_RUNNING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_state</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_count</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">return</span><span class="p">;</span>
<span class="nl">out_error:</span>
	<span class="n">pr_warn_ratelimited</span><span class="p">(</span><span class="s">&quot;NFS: state manager failed on NFSv4 server %s&quot;</span>
			<span class="s">&quot; with error %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_hostname</span><span class="p">,</span> <span class="o">-</span><span class="n">status</span><span class="p">);</span>
	<span class="n">nfs4_end_drain_session</span><span class="p">(</span><span class="n">clp</span><span class="p">);</span>
	<span class="n">nfs4_clear_state_manager_bit</span><span class="p">(</span><span class="n">clp</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">nfs4_run_state_manager</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">ptr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfs_client</span> <span class="o">*</span><span class="n">clp</span> <span class="o">=</span> <span class="n">ptr</span><span class="p">;</span>

	<span class="n">allow_signal</span><span class="p">(</span><span class="n">SIGKILL</span><span class="p">);</span>
	<span class="n">nfs4_state_manager</span><span class="p">(</span><span class="n">clp</span><span class="p">);</span>
	<span class="n">nfs_put_client</span><span class="p">(</span><span class="n">clp</span><span class="p">);</span>
	<span class="n">module_put_and_exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Local variables:</span>
<span class="cm"> *  c-basic-offset: 8</span>
<span class="cm"> * End:</span>
<span class="cm"> */</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
