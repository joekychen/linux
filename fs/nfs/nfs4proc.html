<!DOCTYPE html>
<html><head><title>joekychen/linux » fs › nfs › nfs4proc.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>nfs4proc.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> *  fs/nfs/nfs4proc.c</span>
<span class="cm"> *</span>
<span class="cm"> *  Client-side procedure declarations for NFSv4.</span>
<span class="cm"> *</span>
<span class="cm"> *  Copyright (c) 2002 The Regents of the University of Michigan.</span>
<span class="cm"> *  All rights reserved.</span>
<span class="cm"> *</span>
<span class="cm"> *  Kendrick Smith &lt;kmsmith@umich.edu&gt;</span>
<span class="cm"> *  Andy Adamson   &lt;andros@umich.edu&gt;</span>
<span class="cm"> *</span>
<span class="cm"> *  Redistribution and use in source and binary forms, with or without</span>
<span class="cm"> *  modification, are permitted provided that the following conditions</span>
<span class="cm"> *  are met:</span>
<span class="cm"> *</span>
<span class="cm"> *  1. Redistributions of source code must retain the above copyright</span>
<span class="cm"> *     notice, this list of conditions and the following disclaimer.</span>
<span class="cm"> *  2. Redistributions in binary form must reproduce the above copyright</span>
<span class="cm"> *     notice, this list of conditions and the following disclaimer in the</span>
<span class="cm"> *     documentation and/or other materials provided with the distribution.</span>
<span class="cm"> *  3. Neither the name of the University nor the names of its</span>
<span class="cm"> *     contributors may be used to endorse or promote products derived</span>
<span class="cm"> *     from this software without specific prior written permission.</span>
<span class="cm"> *</span>
<span class="cm"> *  THIS SOFTWARE IS PROVIDED ``AS IS&#39;&#39; AND ANY EXPRESS OR IMPLIED</span>
<span class="cm"> *  WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF</span>
<span class="cm"> *  MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE</span>
<span class="cm"> *  DISCLAIMED. IN NO EVENT SHALL THE REGENTS OR CONTRIBUTORS BE LIABLE</span>
<span class="cm"> *  FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR</span>
<span class="cm"> *  CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF</span>
<span class="cm"> *  SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR</span>
<span class="cm"> *  BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF</span>
<span class="cm"> *  LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING</span>
<span class="cm"> *  NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS</span>
<span class="cm"> *  SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/mm.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/errno.h&gt;</span>
<span class="cp">#include &lt;linux/string.h&gt;</span>
<span class="cp">#include &lt;linux/ratelimit.h&gt;</span>
<span class="cp">#include &lt;linux/printk.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/sunrpc/clnt.h&gt;</span>
<span class="cp">#include &lt;linux/sunrpc/gss_api.h&gt;</span>
<span class="cp">#include &lt;linux/nfs.h&gt;</span>
<span class="cp">#include &lt;linux/nfs4.h&gt;</span>
<span class="cp">#include &lt;linux/nfs_fs.h&gt;</span>
<span class="cp">#include &lt;linux/nfs_page.h&gt;</span>
<span class="cp">#include &lt;linux/nfs_mount.h&gt;</span>
<span class="cp">#include &lt;linux/namei.h&gt;</span>
<span class="cp">#include &lt;linux/mount.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/nfs_idmap.h&gt;</span>
<span class="cp">#include &lt;linux/sunrpc/bc_xprt.h&gt;</span>
<span class="cp">#include &lt;linux/xattr.h&gt;</span>
<span class="cp">#include &lt;linux/utsname.h&gt;</span>
<span class="cp">#include &lt;linux/freezer.h&gt;</span>

<span class="cp">#include &quot;nfs4_fs.h&quot;</span>
<span class="cp">#include &quot;delegation.h&quot;</span>
<span class="cp">#include &quot;internal.h&quot;</span>
<span class="cp">#include &quot;iostat.h&quot;</span>
<span class="cp">#include &quot;callback.h&quot;</span>
<span class="cp">#include &quot;pnfs.h&quot;</span>
<span class="cp">#include &quot;netns.h&quot;</span>

<span class="cp">#define NFSDBG_FACILITY		NFSDBG_PROC</span>

<span class="cp">#define NFS4_POLL_RETRY_MIN	(HZ/10)</span>
<span class="cp">#define NFS4_POLL_RETRY_MAX	(15*HZ)</span>

<span class="cp">#define NFS4_MAX_LOOP_ON_RECOVER (10)</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">max_session_slots</span> <span class="o">=</span> <span class="n">NFS4_DEF_SLOT_TABLE_SIZE</span><span class="p">;</span>

<span class="k">struct</span> <span class="n">nfs4_opendata</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">_nfs4_proc_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs4_opendata</span> <span class="o">*</span><span class="n">data</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">_nfs4_recover_proc_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs4_opendata</span> <span class="o">*</span><span class="n">data</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">nfs4_do_fsinfo</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs_server</span> <span class="o">*</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nfs_fh</span> <span class="o">*</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nfs_fsinfo</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">nfs4_async_handle_error</span><span class="p">(</span><span class="k">struct</span> <span class="n">rpc_task</span> <span class="o">*</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">nfs_server</span> <span class="o">*</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nfs4_state</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">nfs_fixup_referral_attributes</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs_fattr</span> <span class="o">*</span><span class="n">fattr</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">nfs4_proc_getattr</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs_server</span> <span class="o">*</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nfs_fh</span> <span class="o">*</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nfs_fattr</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">_nfs4_proc_getattr</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs_server</span> <span class="o">*</span><span class="n">server</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nfs_fh</span> <span class="o">*</span><span class="n">fhandle</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nfs_fattr</span> <span class="o">*</span><span class="n">fattr</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">nfs4_do_setattr</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rpc_cred</span> <span class="o">*</span><span class="n">cred</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">nfs_fattr</span> <span class="o">*</span><span class="n">fattr</span><span class="p">,</span> <span class="k">struct</span> <span class="n">iattr</span> <span class="o">*</span><span class="n">sattr</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">nfs4_state</span> <span class="o">*</span><span class="n">state</span><span class="p">);</span>
<span class="cp">#ifdef CONFIG_NFS_V4_1</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">nfs41_test_stateid</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs_server</span> <span class="o">*</span><span class="p">,</span> <span class="n">nfs4_stateid</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">nfs41_free_stateid</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs_server</span> <span class="o">*</span><span class="p">,</span> <span class="n">nfs4_stateid</span> <span class="o">*</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="cm">/* Prevent leaks of NFSv4 errors into userland */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">nfs4_map_errors</span><span class="p">(</span><span class="kt">int</span> <span class="n">err</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&gt;=</span> <span class="o">-</span><span class="mi">1000</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="o">-</span><span class="n">NFS4ERR_RESOURCE</span>:
		<span class="k">return</span> <span class="o">-</span><span class="n">EREMOTEIO</span><span class="p">;</span>
	<span class="k">case</span> <span class="o">-</span><span class="n">NFS4ERR_WRONGSEC</span>:
		<span class="k">return</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>
	<span class="k">case</span> <span class="o">-</span><span class="n">NFS4ERR_BADOWNER</span>:
	<span class="k">case</span> <span class="o">-</span><span class="n">NFS4ERR_BADNAME</span>:
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">case</span> <span class="o">-</span><span class="n">NFS4ERR_SHARE_DENIED</span>:
		<span class="k">return</span> <span class="o">-</span><span class="n">EACCES</span><span class="p">;</span>
	<span class="k">case</span> <span class="o">-</span><span class="n">NFS4ERR_MINOR_VERS_MISMATCH</span>:
		<span class="k">return</span> <span class="o">-</span><span class="n">EPROTONOSUPPORT</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s could not handle NFSv4 error %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">__func__</span><span class="p">,</span> <span class="o">-</span><span class="n">err</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * This is our standard bitmap for GETATTR requests.</span>
<span class="cm"> */</span>
<span class="k">const</span> <span class="n">u32</span> <span class="n">nfs4_fattr_bitmap</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">FATTR4_WORD0_TYPE</span>
	<span class="o">|</span> <span class="n">FATTR4_WORD0_CHANGE</span>
	<span class="o">|</span> <span class="n">FATTR4_WORD0_SIZE</span>
	<span class="o">|</span> <span class="n">FATTR4_WORD0_FSID</span>
	<span class="o">|</span> <span class="n">FATTR4_WORD0_FILEID</span><span class="p">,</span>
	<span class="n">FATTR4_WORD1_MODE</span>
	<span class="o">|</span> <span class="n">FATTR4_WORD1_NUMLINKS</span>
	<span class="o">|</span> <span class="n">FATTR4_WORD1_OWNER</span>
	<span class="o">|</span> <span class="n">FATTR4_WORD1_OWNER_GROUP</span>
	<span class="o">|</span> <span class="n">FATTR4_WORD1_RAWDEV</span>
	<span class="o">|</span> <span class="n">FATTR4_WORD1_SPACE_USED</span>
	<span class="o">|</span> <span class="n">FATTR4_WORD1_TIME_ACCESS</span>
	<span class="o">|</span> <span class="n">FATTR4_WORD1_TIME_METADATA</span>
	<span class="o">|</span> <span class="n">FATTR4_WORD1_TIME_MODIFY</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="n">u32</span> <span class="n">nfs4_pnfs_open_bitmap</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">FATTR4_WORD0_TYPE</span>
	<span class="o">|</span> <span class="n">FATTR4_WORD0_CHANGE</span>
	<span class="o">|</span> <span class="n">FATTR4_WORD0_SIZE</span>
	<span class="o">|</span> <span class="n">FATTR4_WORD0_FSID</span>
	<span class="o">|</span> <span class="n">FATTR4_WORD0_FILEID</span><span class="p">,</span>
	<span class="n">FATTR4_WORD1_MODE</span>
	<span class="o">|</span> <span class="n">FATTR4_WORD1_NUMLINKS</span>
	<span class="o">|</span> <span class="n">FATTR4_WORD1_OWNER</span>
	<span class="o">|</span> <span class="n">FATTR4_WORD1_OWNER_GROUP</span>
	<span class="o">|</span> <span class="n">FATTR4_WORD1_RAWDEV</span>
	<span class="o">|</span> <span class="n">FATTR4_WORD1_SPACE_USED</span>
	<span class="o">|</span> <span class="n">FATTR4_WORD1_TIME_ACCESS</span>
	<span class="o">|</span> <span class="n">FATTR4_WORD1_TIME_METADATA</span>
	<span class="o">|</span> <span class="n">FATTR4_WORD1_TIME_MODIFY</span><span class="p">,</span>
	<span class="n">FATTR4_WORD2_MDSTHRESHOLD</span>
<span class="p">};</span>

<span class="k">const</span> <span class="n">u32</span> <span class="n">nfs4_statfs_bitmap</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">FATTR4_WORD0_FILES_AVAIL</span>
	<span class="o">|</span> <span class="n">FATTR4_WORD0_FILES_FREE</span>
	<span class="o">|</span> <span class="n">FATTR4_WORD0_FILES_TOTAL</span><span class="p">,</span>
	<span class="n">FATTR4_WORD1_SPACE_AVAIL</span>
	<span class="o">|</span> <span class="n">FATTR4_WORD1_SPACE_FREE</span>
	<span class="o">|</span> <span class="n">FATTR4_WORD1_SPACE_TOTAL</span>
<span class="p">};</span>

<span class="k">const</span> <span class="n">u32</span> <span class="n">nfs4_pathconf_bitmap</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">FATTR4_WORD0_MAXLINK</span>
	<span class="o">|</span> <span class="n">FATTR4_WORD0_MAXNAME</span><span class="p">,</span>
	<span class="mi">0</span>
<span class="p">};</span>

<span class="k">const</span> <span class="n">u32</span> <span class="n">nfs4_fsinfo_bitmap</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="n">FATTR4_WORD0_MAXFILESIZE</span>
			<span class="o">|</span> <span class="n">FATTR4_WORD0_MAXREAD</span>
			<span class="o">|</span> <span class="n">FATTR4_WORD0_MAXWRITE</span>
			<span class="o">|</span> <span class="n">FATTR4_WORD0_LEASE_TIME</span><span class="p">,</span>
			<span class="n">FATTR4_WORD1_TIME_DELTA</span>
			<span class="o">|</span> <span class="n">FATTR4_WORD1_FS_LAYOUT_TYPES</span><span class="p">,</span>
			<span class="n">FATTR4_WORD2_LAYOUT_BLKSIZE</span>
<span class="p">};</span>

<span class="k">const</span> <span class="n">u32</span> <span class="n">nfs4_fs_locations_bitmap</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">FATTR4_WORD0_TYPE</span>
	<span class="o">|</span> <span class="n">FATTR4_WORD0_CHANGE</span>
	<span class="o">|</span> <span class="n">FATTR4_WORD0_SIZE</span>
	<span class="o">|</span> <span class="n">FATTR4_WORD0_FSID</span>
	<span class="o">|</span> <span class="n">FATTR4_WORD0_FILEID</span>
	<span class="o">|</span> <span class="n">FATTR4_WORD0_FS_LOCATIONS</span><span class="p">,</span>
	<span class="n">FATTR4_WORD1_MODE</span>
	<span class="o">|</span> <span class="n">FATTR4_WORD1_NUMLINKS</span>
	<span class="o">|</span> <span class="n">FATTR4_WORD1_OWNER</span>
	<span class="o">|</span> <span class="n">FATTR4_WORD1_OWNER_GROUP</span>
	<span class="o">|</span> <span class="n">FATTR4_WORD1_RAWDEV</span>
	<span class="o">|</span> <span class="n">FATTR4_WORD1_SPACE_USED</span>
	<span class="o">|</span> <span class="n">FATTR4_WORD1_TIME_ACCESS</span>
	<span class="o">|</span> <span class="n">FATTR4_WORD1_TIME_METADATA</span>
	<span class="o">|</span> <span class="n">FATTR4_WORD1_TIME_MODIFY</span>
	<span class="o">|</span> <span class="n">FATTR4_WORD1_MOUNTED_ON_FILEID</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">nfs4_setup_readdir</span><span class="p">(</span><span class="n">u64</span> <span class="n">cookie</span><span class="p">,</span> <span class="n">__be32</span> <span class="o">*</span><span class="n">verifier</span><span class="p">,</span> <span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="n">dentry</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">nfs4_readdir_arg</span> <span class="o">*</span><span class="n">readdir</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">__be32</span> <span class="o">*</span><span class="n">start</span><span class="p">,</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">readdir</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">&lt;</span> <span class="mi">80</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cookie</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">readdir</span><span class="o">-&gt;</span><span class="n">cookie</span> <span class="o">=</span> <span class="n">cookie</span><span class="p">;</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">readdir</span><span class="o">-&gt;</span><span class="n">verifier</span><span class="p">,</span> <span class="n">verifier</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">readdir</span><span class="o">-&gt;</span><span class="n">verifier</span><span class="p">));</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">readdir</span><span class="o">-&gt;</span><span class="n">cookie</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">readdir</span><span class="o">-&gt;</span><span class="n">verifier</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">readdir</span><span class="o">-&gt;</span><span class="n">verifier</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cookie</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	
	<span class="cm">/*</span>
<span class="cm">	 * NFSv4 servers do not return entries for &#39;.&#39; and &#39;..&#39;</span>
<span class="cm">	 * Therefore, we fake these entries here.  We let &#39;.&#39;</span>
<span class="cm">	 * have cookie 0 and &#39;..&#39; have cookie 1.  Note that</span>
<span class="cm">	 * when talking to the server, we always send cookie 0</span>
<span class="cm">	 * instead of 1 or 2.</span>
<span class="cm">	 */</span>
	<span class="n">start</span> <span class="o">=</span> <span class="n">p</span> <span class="o">=</span> <span class="n">kmap_atomic</span><span class="p">(</span><span class="o">*</span><span class="n">readdir</span><span class="o">-&gt;</span><span class="n">pages</span><span class="p">);</span>
	
	<span class="k">if</span> <span class="p">(</span><span class="n">cookie</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">=</span> <span class="n">xdr_one</span><span class="p">;</span>                                  <span class="cm">/* next */</span>
		<span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">=</span> <span class="n">xdr_zero</span><span class="p">;</span>                   <span class="cm">/* cookie, first word */</span>
		<span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">=</span> <span class="n">xdr_one</span><span class="p">;</span>                   <span class="cm">/* cookie, second word */</span>
		<span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">=</span> <span class="n">xdr_one</span><span class="p">;</span>                             <span class="cm">/* entry len */</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="s">&quot;.</span><span class="se">\0\0\0</span><span class="s">&quot;</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>                        <span class="cm">/* entry */</span>
		<span class="n">p</span><span class="o">++</span><span class="p">;</span>
		<span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">=</span> <span class="n">xdr_one</span><span class="p">;</span>                         <span class="cm">/* bitmap length */</span>
		<span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">FATTR4_WORD0_FILEID</span><span class="p">);</span>             <span class="cm">/* bitmap */</span>
		<span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="mi">8</span><span class="p">);</span>              <span class="cm">/* attribute buffer length */</span>
		<span class="n">p</span> <span class="o">=</span> <span class="n">xdr_encode_hyper</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">NFS_FILEID</span><span class="p">(</span><span class="n">dentry</span><span class="o">-&gt;</span><span class="n">d_inode</span><span class="p">));</span>
	<span class="p">}</span>
	
	<span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">=</span> <span class="n">xdr_one</span><span class="p">;</span>                                  <span class="cm">/* next */</span>
	<span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">=</span> <span class="n">xdr_zero</span><span class="p">;</span>                   <span class="cm">/* cookie, first word */</span>
	<span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">=</span> <span class="n">xdr_two</span><span class="p">;</span>                   <span class="cm">/* cookie, second word */</span>
	<span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">=</span> <span class="n">xdr_two</span><span class="p">;</span>                             <span class="cm">/* entry len */</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="s">&quot;..</span><span class="se">\0\0</span><span class="s">&quot;</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>                         <span class="cm">/* entry */</span>
	<span class="n">p</span><span class="o">++</span><span class="p">;</span>
	<span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">=</span> <span class="n">xdr_one</span><span class="p">;</span>                         <span class="cm">/* bitmap length */</span>
	<span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">FATTR4_WORD0_FILEID</span><span class="p">);</span>             <span class="cm">/* bitmap */</span>
	<span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="mi">8</span><span class="p">);</span>              <span class="cm">/* attribute buffer length */</span>
	<span class="n">p</span> <span class="o">=</span> <span class="n">xdr_encode_hyper</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">NFS_FILEID</span><span class="p">(</span><span class="n">dentry</span><span class="o">-&gt;</span><span class="n">d_parent</span><span class="o">-&gt;</span><span class="n">d_inode</span><span class="p">));</span>

	<span class="n">readdir</span><span class="o">-&gt;</span><span class="n">pgbase</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">p</span> <span class="o">-</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">start</span><span class="p">;</span>
	<span class="n">readdir</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">-=</span> <span class="n">readdir</span><span class="o">-&gt;</span><span class="n">pgbase</span><span class="p">;</span>
	<span class="n">kunmap_atomic</span><span class="p">(</span><span class="n">start</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">nfs4_wait_clnt_recover</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs_client</span> <span class="o">*</span><span class="n">clp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">res</span><span class="p">;</span>

	<span class="n">might_sleep</span><span class="p">();</span>

	<span class="n">res</span> <span class="o">=</span> <span class="n">wait_on_bit</span><span class="p">(</span><span class="o">&amp;</span><span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_state</span><span class="p">,</span> <span class="n">NFS4CLNT_MANAGER_RUNNING</span><span class="p">,</span>
			<span class="n">nfs_wait_bit_killable</span><span class="p">,</span> <span class="n">TASK_KILLABLE</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">nfs4_delay</span><span class="p">(</span><span class="k">struct</span> <span class="n">rpc_clnt</span> <span class="o">*</span><span class="n">clnt</span><span class="p">,</span> <span class="kt">long</span> <span class="o">*</span><span class="n">timeout</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">res</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">might_sleep</span><span class="p">();</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">timeout</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="o">*</span><span class="n">timeout</span> <span class="o">=</span> <span class="n">NFS4_POLL_RETRY_MIN</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">timeout</span> <span class="o">&gt;</span> <span class="n">NFS4_POLL_RETRY_MAX</span><span class="p">)</span>
		<span class="o">*</span><span class="n">timeout</span> <span class="o">=</span> <span class="n">NFS4_POLL_RETRY_MAX</span><span class="p">;</span>
	<span class="n">freezable_schedule_timeout_killable</span><span class="p">(</span><span class="o">*</span><span class="n">timeout</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fatal_signal_pending</span><span class="p">(</span><span class="n">current</span><span class="p">))</span>
		<span class="n">res</span> <span class="o">=</span> <span class="o">-</span><span class="n">ERESTARTSYS</span><span class="p">;</span>
	<span class="o">*</span><span class="n">timeout</span> <span class="o">&lt;&lt;=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* This is the error handling routine for processes that are allowed</span>
<span class="cm"> * to sleep.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">nfs4_handle_exception</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs_server</span> <span class="o">*</span><span class="n">server</span><span class="p">,</span> <span class="kt">int</span> <span class="n">errorcode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nfs4_exception</span> <span class="o">*</span><span class="n">exception</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfs_client</span> <span class="o">*</span><span class="n">clp</span> <span class="o">=</span> <span class="n">server</span><span class="o">-&gt;</span><span class="n">nfs_client</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nfs4_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">exception</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span> <span class="o">=</span> <span class="n">exception</span><span class="o">-&gt;</span><span class="n">inode</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">errorcode</span><span class="p">;</span>

	<span class="n">exception</span><span class="o">-&gt;</span><span class="n">retry</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">switch</span><span class="p">(</span><span class="n">errorcode</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">0</span>:
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">case</span> <span class="o">-</span><span class="n">NFS4ERR_OPENMODE</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">inode</span> <span class="o">&amp;&amp;</span> <span class="n">nfs_have_delegation</span><span class="p">(</span><span class="n">inode</span><span class="p">,</span> <span class="n">FMODE_READ</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">nfs_inode_return_delegation</span><span class="p">(</span><span class="n">inode</span><span class="p">);</span>
				<span class="n">exception</span><span class="o">-&gt;</span><span class="n">retry</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">state</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="n">nfs4_schedule_stateid_recovery</span><span class="p">(</span><span class="n">server</span><span class="p">,</span> <span class="n">state</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">wait_on_recovery</span><span class="p">;</span>
		<span class="k">case</span> <span class="o">-</span><span class="n">NFS4ERR_DELEG_REVOKED</span>:
		<span class="k">case</span> <span class="o">-</span><span class="n">NFS4ERR_ADMIN_REVOKED</span>:
		<span class="k">case</span> <span class="o">-</span><span class="n">NFS4ERR_BAD_STATEID</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">state</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="n">nfs_remove_bad_delegation</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">inode</span><span class="p">);</span>
			<span class="n">nfs4_schedule_stateid_recovery</span><span class="p">(</span><span class="n">server</span><span class="p">,</span> <span class="n">state</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">wait_on_recovery</span><span class="p">;</span>
		<span class="k">case</span> <span class="o">-</span><span class="n">NFS4ERR_EXPIRED</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">state</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
				<span class="n">nfs4_schedule_stateid_recovery</span><span class="p">(</span><span class="n">server</span><span class="p">,</span> <span class="n">state</span><span class="p">);</span>
		<span class="k">case</span> <span class="o">-</span><span class="n">NFS4ERR_STALE_STATEID</span>:
		<span class="k">case</span> <span class="o">-</span><span class="n">NFS4ERR_STALE_CLIENTID</span>:
			<span class="n">nfs4_schedule_lease_recovery</span><span class="p">(</span><span class="n">clp</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">wait_on_recovery</span><span class="p">;</span>
<span class="cp">#if defined(CONFIG_NFS_V4_1)</span>
		<span class="k">case</span> <span class="o">-</span><span class="n">NFS4ERR_BADSESSION</span>:
		<span class="k">case</span> <span class="o">-</span><span class="n">NFS4ERR_BADSLOT</span>:
		<span class="k">case</span> <span class="o">-</span><span class="n">NFS4ERR_BAD_HIGH_SLOT</span>:
		<span class="k">case</span> <span class="o">-</span><span class="n">NFS4ERR_CONN_NOT_BOUND_TO_SESSION</span>:
		<span class="k">case</span> <span class="o">-</span><span class="n">NFS4ERR_DEADSESSION</span>:
		<span class="k">case</span> <span class="o">-</span><span class="n">NFS4ERR_SEQ_FALSE_RETRY</span>:
		<span class="k">case</span> <span class="o">-</span><span class="n">NFS4ERR_SEQ_MISORDERED</span>:
			<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s ERROR: %d Reset session</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
				<span class="n">errorcode</span><span class="p">);</span>
			<span class="n">nfs4_schedule_session_recovery</span><span class="p">(</span><span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_session</span><span class="p">,</span> <span class="n">errorcode</span><span class="p">);</span>
			<span class="n">exception</span><span class="o">-&gt;</span><span class="n">retry</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
<span class="cp">#endif </span><span class="cm">/* defined(CONFIG_NFS_V4_1) */</span><span class="cp"></span>
		<span class="k">case</span> <span class="o">-</span><span class="n">NFS4ERR_FILE_OPEN</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">exception</span><span class="o">-&gt;</span><span class="n">timeout</span> <span class="o">&gt;</span> <span class="n">HZ</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* We have retried a decent amount, time to</span>
<span class="cm">				 * fail</span>
<span class="cm">				 */</span>
				<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="k">case</span> <span class="o">-</span><span class="n">NFS4ERR_GRACE</span>:
		<span class="k">case</span> <span class="o">-</span><span class="n">NFS4ERR_DELAY</span>:
		<span class="k">case</span> <span class="o">-</span><span class="n">EKEYEXPIRED</span>:
			<span class="n">ret</span> <span class="o">=</span> <span class="n">nfs4_delay</span><span class="p">(</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">client</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">exception</span><span class="o">-&gt;</span><span class="n">timeout</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="o">-</span><span class="n">NFS4ERR_RETRY_UNCACHED_REP</span>:
		<span class="k">case</span> <span class="o">-</span><span class="n">NFS4ERR_OLD_STATEID</span>:
			<span class="n">exception</span><span class="o">-&gt;</span><span class="n">retry</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="o">-</span><span class="n">NFS4ERR_BADOWNER</span>:
			<span class="cm">/* The following works around a Linux server bug! */</span>
		<span class="k">case</span> <span class="o">-</span><span class="n">NFS4ERR_BADNAME</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">caps</span> <span class="o">&amp;</span> <span class="n">NFS_CAP_UIDGID_NOMAP</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">server</span><span class="o">-&gt;</span><span class="n">caps</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">NFS_CAP_UIDGID_NOMAP</span><span class="p">;</span>
				<span class="n">exception</span><span class="o">-&gt;</span><span class="n">retry</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;NFS: v4 server %s &quot;</span>
						<span class="s">&quot;does not accept raw &quot;</span>
						<span class="s">&quot;uid/gids. &quot;</span>
						<span class="s">&quot;Reenabling the idmapper.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						<span class="n">server</span><span class="o">-&gt;</span><span class="n">nfs_client</span><span class="o">-&gt;</span><span class="n">cl_hostname</span><span class="p">);</span>
			<span class="p">}</span>
	<span class="p">}</span>
	<span class="cm">/* We failed to handle the error */</span>
	<span class="k">return</span> <span class="n">nfs4_map_errors</span><span class="p">(</span><span class="n">ret</span><span class="p">);</span>
<span class="nl">wait_on_recovery:</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">nfs4_wait_clnt_recover</span><span class="p">(</span><span class="n">clp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">exception</span><span class="o">-&gt;</span><span class="n">retry</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">do_renew_lease</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs_client</span> <span class="o">*</span><span class="n">clp</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">timestamp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">time_before</span><span class="p">(</span><span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_last_renewal</span><span class="p">,</span><span class="n">timestamp</span><span class="p">))</span>
		<span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_last_renewal</span> <span class="o">=</span> <span class="n">timestamp</span><span class="p">;</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">renew_lease</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">nfs_server</span> <span class="o">*</span><span class="n">server</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">timestamp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">do_renew_lease</span><span class="p">(</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">nfs_client</span><span class="p">,</span> <span class="n">timestamp</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#if defined(CONFIG_NFS_V4_1)</span>

<span class="cm">/*</span>
<span class="cm"> * nfs4_free_slot - free a slot and efficiently update slot table.</span>
<span class="cm"> *</span>
<span class="cm"> * freeing a slot is trivially done by clearing its respective bit</span>
<span class="cm"> * in the bitmap.</span>
<span class="cm"> * If the freed slotid equals highest_used_slotid we want to update it</span>
<span class="cm"> * so that the server would be able to size down the slot table if needed,</span>
<span class="cm"> * otherwise we know that the highest_used_slotid is still in use.</span>
<span class="cm"> * When updating highest_used_slotid there may be &quot;holes&quot; in the bitmap</span>
<span class="cm"> * so we need to scan down from highest_used_slotid to 0 looking for the now</span>
<span class="cm"> * highest slotid in use.</span>
<span class="cm"> * If none found, highest_used_slotid is set to NFS4_NO_SLOT.</span>
<span class="cm"> *</span>
<span class="cm"> * Must be called while holding tbl-&gt;slot_tbl_lock</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">nfs4_free_slot</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs4_slot_table</span> <span class="o">*</span><span class="n">tbl</span><span class="p">,</span> <span class="n">u32</span> <span class="n">slotid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">slotid</span> <span class="o">&gt;=</span> <span class="n">NFS4_MAX_SLOT_TABLE</span><span class="p">);</span>
	<span class="cm">/* clear used bit in bitmap */</span>
	<span class="n">__clear_bit</span><span class="p">(</span><span class="n">slotid</span><span class="p">,</span> <span class="n">tbl</span><span class="o">-&gt;</span><span class="n">used_slots</span><span class="p">);</span>

	<span class="cm">/* update highest_used_slotid when it is freed */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">slotid</span> <span class="o">==</span> <span class="n">tbl</span><span class="o">-&gt;</span><span class="n">highest_used_slotid</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">slotid</span> <span class="o">=</span> <span class="n">find_last_bit</span><span class="p">(</span><span class="n">tbl</span><span class="o">-&gt;</span><span class="n">used_slots</span><span class="p">,</span> <span class="n">tbl</span><span class="o">-&gt;</span><span class="n">max_slots</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">slotid</span> <span class="o">&lt;</span> <span class="n">tbl</span><span class="o">-&gt;</span><span class="n">max_slots</span><span class="p">)</span>
			<span class="n">tbl</span><span class="o">-&gt;</span><span class="n">highest_used_slotid</span> <span class="o">=</span> <span class="n">slotid</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">tbl</span><span class="o">-&gt;</span><span class="n">highest_used_slotid</span> <span class="o">=</span> <span class="n">NFS4_NO_SLOT</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s: slotid %u highest_used_slotid %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
		<span class="n">slotid</span><span class="p">,</span> <span class="n">tbl</span><span class="o">-&gt;</span><span class="n">highest_used_slotid</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">bool</span> <span class="nf">nfs4_set_task_privileged</span><span class="p">(</span><span class="k">struct</span> <span class="n">rpc_task</span> <span class="o">*</span><span class="n">task</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dummy</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">rpc_task_set_priority</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="n">RPC_PRIORITY_PRIVILEGED</span><span class="p">);</span>
	<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Signal state manager thread if session fore channel is drained</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">nfs4_check_drain_fc_complete</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs4_session</span> <span class="o">*</span><span class="n">ses</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">NFS4_SESSION_DRAINING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ses</span><span class="o">-&gt;</span><span class="n">session_state</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">rpc_wake_up_first</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ses</span><span class="o">-&gt;</span><span class="n">fc_slot_table</span><span class="p">.</span><span class="n">slot_tbl_waitq</span><span class="p">,</span>
				<span class="n">nfs4_set_task_privileged</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ses</span><span class="o">-&gt;</span><span class="n">fc_slot_table</span><span class="p">.</span><span class="n">highest_used_slotid</span> <span class="o">!=</span> <span class="n">NFS4_NO_SLOT</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s COMPLETE: Session Fore Channel Drained</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="n">complete</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ses</span><span class="o">-&gt;</span><span class="n">fc_slot_table</span><span class="p">.</span><span class="n">complete</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Signal state manager thread if session back channel is drained</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">nfs4_check_drain_bc_complete</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs4_session</span> <span class="o">*</span><span class="n">ses</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">NFS4_SESSION_DRAINING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ses</span><span class="o">-&gt;</span><span class="n">session_state</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">ses</span><span class="o">-&gt;</span><span class="n">bc_slot_table</span><span class="p">.</span><span class="n">highest_used_slotid</span> <span class="o">!=</span> <span class="n">NFS4_NO_SLOT</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s COMPLETE: Session Back Channel Drained</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="n">complete</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ses</span><span class="o">-&gt;</span><span class="n">bc_slot_table</span><span class="p">.</span><span class="n">complete</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">nfs41_sequence_free_slot</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs4_sequence_res</span> <span class="o">*</span><span class="n">res</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfs4_slot_table</span> <span class="o">*</span><span class="n">tbl</span><span class="p">;</span>

	<span class="n">tbl</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">sr_session</span><span class="o">-&gt;</span><span class="n">fc_slot_table</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">sr_slot</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* just wake up the next guy waiting since</span>
<span class="cm">		 * we may have not consumed a slot after all */</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s: No slot</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tbl</span><span class="o">-&gt;</span><span class="n">slot_tbl_lock</span><span class="p">);</span>
	<span class="n">nfs4_free_slot</span><span class="p">(</span><span class="n">tbl</span><span class="p">,</span> <span class="n">res</span><span class="o">-&gt;</span><span class="n">sr_slot</span> <span class="o">-</span> <span class="n">tbl</span><span class="o">-&gt;</span><span class="n">slots</span><span class="p">);</span>
	<span class="n">nfs4_check_drain_fc_complete</span><span class="p">(</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">sr_session</span><span class="p">);</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tbl</span><span class="o">-&gt;</span><span class="n">slot_tbl_lock</span><span class="p">);</span>
	<span class="n">res</span><span class="o">-&gt;</span><span class="n">sr_slot</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">nfs41_sequence_done</span><span class="p">(</span><span class="k">struct</span> <span class="n">rpc_task</span> <span class="o">*</span><span class="n">task</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nfs4_sequence_res</span> <span class="o">*</span><span class="n">res</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">timestamp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nfs_client</span> <span class="o">*</span><span class="n">clp</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * sr_status remains 1 if an RPC level error occurred. The server</span>
<span class="cm">	 * may or may not have processed the sequence operation..</span>
<span class="cm">	 * Proceed as if the server received and processed the sequence</span>
<span class="cm">	 * operation.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">sr_status</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">res</span><span class="o">-&gt;</span><span class="n">sr_status</span> <span class="o">=</span> <span class="n">NFS_OK</span><span class="p">;</span>

	<span class="cm">/* don&#39;t increment the sequence number if the task wasn&#39;t sent */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">RPC_WAS_SENT</span><span class="p">(</span><span class="n">task</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="cm">/* Check the SEQUENCE operation status */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">sr_status</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>:
		<span class="cm">/* Update the slot&#39;s sequence and clientid lease timer */</span>
		<span class="o">++</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">sr_slot</span><span class="o">-&gt;</span><span class="n">seq_nr</span><span class="p">;</span>
		<span class="n">timestamp</span> <span class="o">=</span> <span class="n">res</span><span class="o">-&gt;</span><span class="n">sr_renewal_time</span><span class="p">;</span>
		<span class="n">clp</span> <span class="o">=</span> <span class="n">res</span><span class="o">-&gt;</span><span class="n">sr_session</span><span class="o">-&gt;</span><span class="n">clp</span><span class="p">;</span>
		<span class="n">do_renew_lease</span><span class="p">(</span><span class="n">clp</span><span class="p">,</span> <span class="n">timestamp</span><span class="p">);</span>
		<span class="cm">/* Check sequence flags */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">sr_status_flags</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">nfs4_schedule_lease_recovery</span><span class="p">(</span><span class="n">clp</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="o">-</span><span class="n">NFS4ERR_DELAY</span>:
		<span class="cm">/* The server detected a resend of the RPC call and</span>
<span class="cm">		 * returned NFS4ERR_DELAY as per Section 2.10.6.2</span>
<span class="cm">		 * of RFC5661.</span>
<span class="cm">		 */</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s: slot=%td seq=%d: Operation in progress</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span>
			<span class="n">res</span><span class="o">-&gt;</span><span class="n">sr_slot</span> <span class="o">-</span> <span class="n">res</span><span class="o">-&gt;</span><span class="n">sr_session</span><span class="o">-&gt;</span><span class="n">fc_slot_table</span><span class="p">.</span><span class="n">slots</span><span class="p">,</span>
			<span class="n">res</span><span class="o">-&gt;</span><span class="n">sr_slot</span><span class="o">-&gt;</span><span class="n">seq_nr</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_retry</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="cm">/* Just update the slot sequence no. */</span>
		<span class="o">++</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">sr_slot</span><span class="o">-&gt;</span><span class="n">seq_nr</span><span class="p">;</span>
	<span class="p">}</span>
<span class="nl">out:</span>
	<span class="cm">/* The session may be reset by one of the error handlers. */</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s: Error %d free the slot </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">res</span><span class="o">-&gt;</span><span class="n">sr_status</span><span class="p">);</span>
	<span class="n">nfs41_sequence_free_slot</span><span class="p">(</span><span class="n">res</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="nl">out_retry:</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rpc_restart_call</span><span class="p">(</span><span class="n">task</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="n">rpc_delay</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="n">NFS4_POLL_RETRY_MAX</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">nfs4_sequence_done</span><span class="p">(</span><span class="k">struct</span> <span class="n">rpc_task</span> <span class="o">*</span><span class="n">task</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">nfs4_sequence_res</span> <span class="o">*</span><span class="n">res</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">sr_session</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">nfs41_sequence_done</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="n">res</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * nfs4_find_slot - efficiently look for a free slot</span>
<span class="cm"> *</span>
<span class="cm"> * nfs4_find_slot looks for an unset bit in the used_slots bitmap.</span>
<span class="cm"> * If found, we mark the slot as used, update the highest_used_slotid,</span>
<span class="cm"> * and respectively set up the sequence operation args.</span>
<span class="cm"> * The slot number is returned if found, or NFS4_NO_SLOT otherwise.</span>
<span class="cm"> *</span>
<span class="cm"> * Note: must be called with under the slot_tbl_lock.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">u32</span>
<span class="nf">nfs4_find_slot</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs4_slot_table</span> <span class="o">*</span><span class="n">tbl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">slotid</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">ret_id</span> <span class="o">=</span> <span class="n">NFS4_NO_SLOT</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;--&gt; %s used_slots=%04lx highest_used=%u max_slots=%u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">__func__</span><span class="p">,</span> <span class="n">tbl</span><span class="o">-&gt;</span><span class="n">used_slots</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">tbl</span><span class="o">-&gt;</span><span class="n">highest_used_slotid</span><span class="p">,</span>
		<span class="n">tbl</span><span class="o">-&gt;</span><span class="n">max_slots</span><span class="p">);</span>
	<span class="n">slotid</span> <span class="o">=</span> <span class="n">find_first_zero_bit</span><span class="p">(</span><span class="n">tbl</span><span class="o">-&gt;</span><span class="n">used_slots</span><span class="p">,</span> <span class="n">tbl</span><span class="o">-&gt;</span><span class="n">max_slots</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">slotid</span> <span class="o">&gt;=</span> <span class="n">tbl</span><span class="o">-&gt;</span><span class="n">max_slots</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="n">__set_bit</span><span class="p">(</span><span class="n">slotid</span><span class="p">,</span> <span class="n">tbl</span><span class="o">-&gt;</span><span class="n">used_slots</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">slotid</span> <span class="o">&gt;</span> <span class="n">tbl</span><span class="o">-&gt;</span><span class="n">highest_used_slotid</span> <span class="o">||</span>
			<span class="n">tbl</span><span class="o">-&gt;</span><span class="n">highest_used_slotid</span> <span class="o">==</span> <span class="n">NFS4_NO_SLOT</span><span class="p">)</span>
		<span class="n">tbl</span><span class="o">-&gt;</span><span class="n">highest_used_slotid</span> <span class="o">=</span> <span class="n">slotid</span><span class="p">;</span>
	<span class="n">ret_id</span> <span class="o">=</span> <span class="n">slotid</span><span class="p">;</span>
<span class="nl">out:</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;&lt;-- %s used_slots=%04lx highest_used=%d slotid=%d </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">__func__</span><span class="p">,</span> <span class="n">tbl</span><span class="o">-&gt;</span><span class="n">used_slots</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">tbl</span><span class="o">-&gt;</span><span class="n">highest_used_slotid</span><span class="p">,</span> <span class="n">ret_id</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret_id</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">nfs41_init_sequence</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs4_sequence_args</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">nfs4_sequence_res</span> <span class="o">*</span><span class="n">res</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cache_reply</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">args</span><span class="o">-&gt;</span><span class="n">sa_session</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">args</span><span class="o">-&gt;</span><span class="n">sa_cache_this</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cache_reply</span><span class="p">)</span>
		<span class="n">args</span><span class="o">-&gt;</span><span class="n">sa_cache_this</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">res</span><span class="o">-&gt;</span><span class="n">sr_session</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">res</span><span class="o">-&gt;</span><span class="n">sr_slot</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">nfs41_setup_sequence</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs4_session</span> <span class="o">*</span><span class="n">session</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">nfs4_sequence_args</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">nfs4_sequence_res</span> <span class="o">*</span><span class="n">res</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">rpc_task</span> <span class="o">*</span><span class="n">task</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfs4_slot</span> <span class="o">*</span><span class="n">slot</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nfs4_slot_table</span> <span class="o">*</span><span class="n">tbl</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">slotid</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;--&gt; %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="cm">/* slot already allocated? */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">sr_slot</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">tbl</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">session</span><span class="o">-&gt;</span><span class="n">fc_slot_table</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tbl</span><span class="o">-&gt;</span><span class="n">slot_tbl_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">NFS4_SESSION_DRAINING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">session</span><span class="o">-&gt;</span><span class="n">session_state</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="n">rpc_task_has_priority</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="n">RPC_PRIORITY_PRIVILEGED</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* The state manager will wait until the slot table is empty */</span>
		<span class="n">rpc_sleep_on</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tbl</span><span class="o">-&gt;</span><span class="n">slot_tbl_waitq</span><span class="p">,</span> <span class="n">task</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tbl</span><span class="o">-&gt;</span><span class="n">slot_tbl_lock</span><span class="p">);</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s session is draining</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rpc_queue_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tbl</span><span class="o">-&gt;</span><span class="n">slot_tbl_waitq</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="n">rpc_task_has_priority</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="n">RPC_PRIORITY_PRIVILEGED</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">rpc_sleep_on</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tbl</span><span class="o">-&gt;</span><span class="n">slot_tbl_waitq</span><span class="p">,</span> <span class="n">task</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tbl</span><span class="o">-&gt;</span><span class="n">slot_tbl_lock</span><span class="p">);</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s enforce FIFO order</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">slotid</span> <span class="o">=</span> <span class="n">nfs4_find_slot</span><span class="p">(</span><span class="n">tbl</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">slotid</span> <span class="o">==</span> <span class="n">NFS4_NO_SLOT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rpc_sleep_on</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tbl</span><span class="o">-&gt;</span><span class="n">slot_tbl_waitq</span><span class="p">,</span> <span class="n">task</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tbl</span><span class="o">-&gt;</span><span class="n">slot_tbl_lock</span><span class="p">);</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;&lt;-- %s: no free slots</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tbl</span><span class="o">-&gt;</span><span class="n">slot_tbl_lock</span><span class="p">);</span>

	<span class="n">rpc_task_set_priority</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="n">RPC_PRIORITY_NORMAL</span><span class="p">);</span>
	<span class="n">slot</span> <span class="o">=</span> <span class="n">tbl</span><span class="o">-&gt;</span><span class="n">slots</span> <span class="o">+</span> <span class="n">slotid</span><span class="p">;</span>
	<span class="n">args</span><span class="o">-&gt;</span><span class="n">sa_session</span> <span class="o">=</span> <span class="n">session</span><span class="p">;</span>
	<span class="n">args</span><span class="o">-&gt;</span><span class="n">sa_slotid</span> <span class="o">=</span> <span class="n">slotid</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;&lt;-- %s slotid=%d seqid=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">slotid</span><span class="p">,</span> <span class="n">slot</span><span class="o">-&gt;</span><span class="n">seq_nr</span><span class="p">);</span>

	<span class="n">res</span><span class="o">-&gt;</span><span class="n">sr_session</span> <span class="o">=</span> <span class="n">session</span><span class="p">;</span>
	<span class="n">res</span><span class="o">-&gt;</span><span class="n">sr_slot</span> <span class="o">=</span> <span class="n">slot</span><span class="p">;</span>
	<span class="n">res</span><span class="o">-&gt;</span><span class="n">sr_renewal_time</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
	<span class="n">res</span><span class="o">-&gt;</span><span class="n">sr_status_flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * sr_status is only set in decode_sequence, and so will remain</span>
<span class="cm">	 * set to 1 if an rpc level failure occurs.</span>
<span class="cm">	 */</span>
	<span class="n">res</span><span class="o">-&gt;</span><span class="n">sr_status</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">nfs41_setup_sequence</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">nfs4_setup_sequence</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">nfs_server</span> <span class="o">*</span><span class="n">server</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">nfs4_sequence_args</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">nfs4_sequence_res</span> <span class="o">*</span><span class="n">res</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">rpc_task</span> <span class="o">*</span><span class="n">task</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfs4_session</span> <span class="o">*</span><span class="n">session</span> <span class="o">=</span> <span class="n">nfs4_get_session</span><span class="p">(</span><span class="n">server</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">session</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;--&gt; %s clp %p session %p sr_slot %td</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">__func__</span><span class="p">,</span> <span class="n">session</span><span class="o">-&gt;</span><span class="n">clp</span><span class="p">,</span> <span class="n">session</span><span class="p">,</span> <span class="n">res</span><span class="o">-&gt;</span><span class="n">sr_slot</span> <span class="o">?</span>
			<span class="n">res</span><span class="o">-&gt;</span><span class="n">sr_slot</span> <span class="o">-</span> <span class="n">session</span><span class="o">-&gt;</span><span class="n">fc_slot_table</span><span class="p">.</span><span class="n">slots</span> <span class="o">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">nfs41_setup_sequence</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">res</span><span class="p">,</span> <span class="n">task</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;&lt;-- %s status=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">nfs41_call_sync_data</span> <span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">nfs_server</span> <span class="o">*</span><span class="n">seq_server</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nfs4_sequence_args</span> <span class="o">*</span><span class="n">seq_args</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nfs4_sequence_res</span> <span class="o">*</span><span class="n">seq_res</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">nfs41_call_sync_prepare</span><span class="p">(</span><span class="k">struct</span> <span class="n">rpc_task</span> <span class="o">*</span><span class="n">task</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">calldata</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfs41_call_sync_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">calldata</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;--&gt; %s data-&gt;seq_server %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">seq_server</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nfs4_setup_sequence</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">seq_server</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">seq_args</span><span class="p">,</span>
				<span class="n">data</span><span class="o">-&gt;</span><span class="n">seq_res</span><span class="p">,</span> <span class="n">task</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">rpc_call_start</span><span class="p">(</span><span class="n">task</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">nfs41_call_priv_sync_prepare</span><span class="p">(</span><span class="k">struct</span> <span class="n">rpc_task</span> <span class="o">*</span><span class="n">task</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">calldata</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">rpc_task_set_priority</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="n">RPC_PRIORITY_PRIVILEGED</span><span class="p">);</span>
	<span class="n">nfs41_call_sync_prepare</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="n">calldata</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">nfs41_call_sync_done</span><span class="p">(</span><span class="k">struct</span> <span class="n">rpc_task</span> <span class="o">*</span><span class="n">task</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">calldata</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfs41_call_sync_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">calldata</span><span class="p">;</span>

	<span class="n">nfs41_sequence_done</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">seq_res</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">rpc_call_ops</span> <span class="n">nfs41_call_sync_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">rpc_call_prepare</span> <span class="o">=</span> <span class="n">nfs41_call_sync_prepare</span><span class="p">,</span>
	<span class="p">.</span><span class="n">rpc_call_done</span> <span class="o">=</span> <span class="n">nfs41_call_sync_done</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">rpc_call_ops</span> <span class="n">nfs41_call_priv_sync_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">rpc_call_prepare</span> <span class="o">=</span> <span class="n">nfs41_call_priv_sync_prepare</span><span class="p">,</span>
	<span class="p">.</span><span class="n">rpc_call_done</span> <span class="o">=</span> <span class="n">nfs41_call_sync_done</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">nfs4_call_sync_sequence</span><span class="p">(</span><span class="k">struct</span> <span class="n">rpc_clnt</span> <span class="o">*</span><span class="n">clnt</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">nfs_server</span> <span class="o">*</span><span class="n">server</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">rpc_message</span> <span class="o">*</span><span class="n">msg</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">nfs4_sequence_args</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">nfs4_sequence_res</span> <span class="o">*</span><span class="n">res</span><span class="p">,</span>
				   <span class="kt">int</span> <span class="n">privileged</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rpc_task</span> <span class="o">*</span><span class="n">task</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nfs41_call_sync_data</span> <span class="n">data</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">seq_server</span> <span class="o">=</span> <span class="n">server</span><span class="p">,</span>
		<span class="p">.</span><span class="n">seq_args</span> <span class="o">=</span> <span class="n">args</span><span class="p">,</span>
		<span class="p">.</span><span class="n">seq_res</span> <span class="o">=</span> <span class="n">res</span><span class="p">,</span>
	<span class="p">};</span>
	<span class="k">struct</span> <span class="n">rpc_task_setup</span> <span class="n">task_setup</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">rpc_client</span> <span class="o">=</span> <span class="n">clnt</span><span class="p">,</span>
		<span class="p">.</span><span class="n">rpc_message</span> <span class="o">=</span> <span class="n">msg</span><span class="p">,</span>
		<span class="p">.</span><span class="n">callback_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">nfs41_call_sync_ops</span><span class="p">,</span>
		<span class="p">.</span><span class="n">callback_data</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">data</span>
	<span class="p">};</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">privileged</span><span class="p">)</span>
		<span class="n">task_setup</span><span class="p">.</span><span class="n">callback_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">nfs41_call_priv_sync_ops</span><span class="p">;</span>
	<span class="n">task</span> <span class="o">=</span> <span class="n">rpc_run_task</span><span class="p">(</span><span class="o">&amp;</span><span class="n">task_setup</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">task</span><span class="p">))</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">task</span><span class="p">);</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">task</span><span class="o">-&gt;</span><span class="n">tk_status</span><span class="p">;</span>
		<span class="n">rpc_put_task</span><span class="p">(</span><span class="n">task</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">_nfs4_call_sync_session</span><span class="p">(</span><span class="k">struct</span> <span class="n">rpc_clnt</span> <span class="o">*</span><span class="n">clnt</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">nfs_server</span> <span class="o">*</span><span class="n">server</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">rpc_message</span> <span class="o">*</span><span class="n">msg</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">nfs4_sequence_args</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">nfs4_sequence_res</span> <span class="o">*</span><span class="n">res</span><span class="p">,</span>
			    <span class="kt">int</span> <span class="n">cache_reply</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">nfs41_init_sequence</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">res</span><span class="p">,</span> <span class="n">cache_reply</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">nfs4_call_sync_sequence</span><span class="p">(</span><span class="n">clnt</span><span class="p">,</span> <span class="n">server</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">res</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#else</span>
<span class="k">static</span> <span class="kr">inline</span>
<span class="kt">void</span> <span class="nf">nfs41_init_sequence</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs4_sequence_args</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">nfs4_sequence_res</span> <span class="o">*</span><span class="n">res</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cache_reply</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">nfs4_sequence_done</span><span class="p">(</span><span class="k">struct</span> <span class="n">rpc_task</span> <span class="o">*</span><span class="n">task</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">nfs4_sequence_res</span> <span class="o">*</span><span class="n">res</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_NFS_V4_1 */</span><span class="cp"></span>

<span class="kt">int</span> <span class="nf">_nfs4_call_sync</span><span class="p">(</span><span class="k">struct</span> <span class="n">rpc_clnt</span> <span class="o">*</span><span class="n">clnt</span><span class="p">,</span>
		    <span class="k">struct</span> <span class="n">nfs_server</span> <span class="o">*</span><span class="n">server</span><span class="p">,</span>
		    <span class="k">struct</span> <span class="n">rpc_message</span> <span class="o">*</span><span class="n">msg</span><span class="p">,</span>
		    <span class="k">struct</span> <span class="n">nfs4_sequence_args</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span>
		    <span class="k">struct</span> <span class="n">nfs4_sequence_res</span> <span class="o">*</span><span class="n">res</span><span class="p">,</span>
		    <span class="kt">int</span> <span class="n">cache_reply</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">nfs41_init_sequence</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">res</span><span class="p">,</span> <span class="n">cache_reply</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rpc_call_sync</span><span class="p">(</span><span class="n">clnt</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span>
<span class="kt">int</span> <span class="nf">nfs4_call_sync</span><span class="p">(</span><span class="k">struct</span> <span class="n">rpc_clnt</span> <span class="o">*</span><span class="n">clnt</span><span class="p">,</span>
		   <span class="k">struct</span> <span class="n">nfs_server</span> <span class="o">*</span><span class="n">server</span><span class="p">,</span>
		   <span class="k">struct</span> <span class="n">rpc_message</span> <span class="o">*</span><span class="n">msg</span><span class="p">,</span>
		   <span class="k">struct</span> <span class="n">nfs4_sequence_args</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span>
		   <span class="k">struct</span> <span class="n">nfs4_sequence_res</span> <span class="o">*</span><span class="n">res</span><span class="p">,</span>
		   <span class="kt">int</span> <span class="n">cache_reply</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">server</span><span class="o">-&gt;</span><span class="n">nfs_client</span><span class="o">-&gt;</span><span class="n">cl_mvops</span><span class="o">-&gt;</span><span class="n">call_sync</span><span class="p">(</span><span class="n">clnt</span><span class="p">,</span> <span class="n">server</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span>
						<span class="n">args</span><span class="p">,</span> <span class="n">res</span><span class="p">,</span> <span class="n">cache_reply</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">update_changeattr</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">dir</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nfs4_change_info</span> <span class="o">*</span><span class="n">cinfo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfs_inode</span> <span class="o">*</span><span class="n">nfsi</span> <span class="o">=</span> <span class="n">NFS_I</span><span class="p">(</span><span class="n">dir</span><span class="p">);</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dir</span><span class="o">-&gt;</span><span class="n">i_lock</span><span class="p">);</span>
	<span class="n">nfsi</span><span class="o">-&gt;</span><span class="n">cache_validity</span> <span class="o">|=</span> <span class="n">NFS_INO_INVALID_ATTR</span><span class="o">|</span><span class="n">NFS_INO_INVALID_DATA</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">atomic</span> <span class="o">||</span> <span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">before</span> <span class="o">!=</span> <span class="n">dir</span><span class="o">-&gt;</span><span class="n">i_version</span><span class="p">)</span>
		<span class="n">nfs_force_lookup_revalidate</span><span class="p">(</span><span class="n">dir</span><span class="p">);</span>
	<span class="n">dir</span><span class="o">-&gt;</span><span class="n">i_version</span> <span class="o">=</span> <span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">after</span><span class="p">;</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dir</span><span class="o">-&gt;</span><span class="n">i_lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">nfs4_opendata</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">kref</span> <span class="n">kref</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nfs_openargs</span> <span class="n">o_arg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nfs_openres</span> <span class="n">o_res</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nfs_open_confirmargs</span> <span class="n">c_arg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nfs_open_confirmres</span> <span class="n">c_res</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nfs4_string</span> <span class="n">owner_name</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nfs4_string</span> <span class="n">group_name</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nfs_fattr</span> <span class="n">f_attr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="n">dir</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="n">dentry</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nfs4_state_owner</span> <span class="o">*</span><span class="n">owner</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nfs4_state</span> <span class="o">*</span><span class="n">state</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iattr</span> <span class="n">attrs</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">timestamp</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">rpc_done</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rpc_status</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">cancelled</span><span class="p">;</span>
<span class="p">};</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">nfs4_init_opendata_res</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs4_opendata</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">o_res</span><span class="p">.</span><span class="n">f_attr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">f_attr</span><span class="p">;</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">o_res</span><span class="p">.</span><span class="n">seqid</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">o_arg</span><span class="p">.</span><span class="n">seqid</span><span class="p">;</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">c_res</span><span class="p">.</span><span class="n">seqid</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">c_arg</span><span class="p">.</span><span class="n">seqid</span><span class="p">;</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">o_res</span><span class="p">.</span><span class="n">server</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">o_arg</span><span class="p">.</span><span class="n">server</span><span class="p">;</span>
	<span class="n">nfs_fattr_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">f_attr</span><span class="p">);</span>
	<span class="n">nfs_fattr_init_names</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">f_attr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">owner_name</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">group_name</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">nfs4_opendata</span> <span class="o">*</span><span class="nf">nfs4_opendata_alloc</span><span class="p">(</span><span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="n">dentry</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">nfs4_state_owner</span> <span class="o">*</span><span class="n">sp</span><span class="p">,</span> <span class="n">fmode_t</span> <span class="n">fmode</span><span class="p">,</span> <span class="kt">int</span> <span class="n">flags</span><span class="p">,</span>
		<span class="k">const</span> <span class="k">struct</span> <span class="n">iattr</span> <span class="o">*</span><span class="n">attrs</span><span class="p">,</span>
		<span class="n">gfp_t</span> <span class="n">gfp_mask</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="n">parent</span> <span class="o">=</span> <span class="n">dget_parent</span><span class="p">(</span><span class="n">dentry</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">dir</span> <span class="o">=</span> <span class="n">parent</span><span class="o">-&gt;</span><span class="n">d_inode</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nfs_server</span> <span class="o">*</span><span class="n">server</span> <span class="o">=</span> <span class="n">NFS_SERVER</span><span class="p">(</span><span class="n">dir</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">nfs4_opendata</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>

	<span class="n">p</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">p</span><span class="p">),</span> <span class="n">gfp_mask</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">p</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">o_arg</span><span class="p">.</span><span class="n">seqid</span> <span class="o">=</span> <span class="n">nfs_alloc_seqid</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">so_seqid</span><span class="p">,</span> <span class="n">gfp_mask</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">o_arg</span><span class="p">.</span><span class="n">seqid</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_free</span><span class="p">;</span>
	<span class="n">nfs_sb_active</span><span class="p">(</span><span class="n">dentry</span><span class="o">-&gt;</span><span class="n">d_sb</span><span class="p">);</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">dentry</span> <span class="o">=</span> <span class="n">dget</span><span class="p">(</span><span class="n">dentry</span><span class="p">);</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">dir</span> <span class="o">=</span> <span class="n">parent</span><span class="p">;</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">owner</span> <span class="o">=</span> <span class="n">sp</span><span class="p">;</span>
	<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">so_count</span><span class="p">);</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">o_arg</span><span class="p">.</span><span class="n">fh</span> <span class="o">=</span> <span class="n">NFS_FH</span><span class="p">(</span><span class="n">dir</span><span class="p">);</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">o_arg</span><span class="p">.</span><span class="n">open_flags</span> <span class="o">=</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">o_arg</span><span class="p">.</span><span class="n">fmode</span> <span class="o">=</span> <span class="n">fmode</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">FMODE_READ</span><span class="o">|</span><span class="n">FMODE_WRITE</span><span class="p">);</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">o_arg</span><span class="p">.</span><span class="n">clientid</span> <span class="o">=</span> <span class="n">server</span><span class="o">-&gt;</span><span class="n">nfs_client</span><span class="o">-&gt;</span><span class="n">cl_clientid</span><span class="p">;</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">o_arg</span><span class="p">.</span><span class="n">id</span><span class="p">.</span><span class="n">create_time</span> <span class="o">=</span> <span class="n">ktime_to_ns</span><span class="p">(</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">so_seqid</span><span class="p">.</span><span class="n">create_time</span><span class="p">);</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">o_arg</span><span class="p">.</span><span class="n">id</span><span class="p">.</span><span class="n">uniquifier</span> <span class="o">=</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">so_seqid</span><span class="p">.</span><span class="n">owner_id</span><span class="p">;</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">o_arg</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dentry</span><span class="o">-&gt;</span><span class="n">d_name</span><span class="p">;</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">o_arg</span><span class="p">.</span><span class="n">server</span> <span class="o">=</span> <span class="n">server</span><span class="p">;</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">o_arg</span><span class="p">.</span><span class="n">bitmask</span> <span class="o">=</span> <span class="n">server</span><span class="o">-&gt;</span><span class="n">attr_bitmask</span><span class="p">;</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">o_arg</span><span class="p">.</span><span class="n">open_bitmap</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">nfs4_fattr_bitmap</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">o_arg</span><span class="p">.</span><span class="n">claim</span> <span class="o">=</span> <span class="n">NFS4_OPEN_CLAIM_NULL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">attrs</span> <span class="o">!=</span> <span class="nb">NULL</span> <span class="o">&amp;&amp;</span> <span class="n">attrs</span><span class="o">-&gt;</span><span class="n">ia_valid</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">__be32</span> <span class="n">verf</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>

		<span class="n">p</span><span class="o">-&gt;</span><span class="n">o_arg</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">attrs</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">;</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">,</span> <span class="n">attrs</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">));</span>

		<span class="n">verf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
		<span class="n">verf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">current</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">;</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">o_arg</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">verifier</span><span class="p">.</span><span class="n">data</span><span class="p">,</span> <span class="n">verf</span><span class="p">,</span>
				<span class="k">sizeof</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">o_arg</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">verifier</span><span class="p">.</span><span class="n">data</span><span class="p">));</span>
	<span class="p">}</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">c_arg</span><span class="p">.</span><span class="n">fh</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">o_res</span><span class="p">.</span><span class="n">fh</span><span class="p">;</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">c_arg</span><span class="p">.</span><span class="n">stateid</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">o_res</span><span class="p">.</span><span class="n">stateid</span><span class="p">;</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">c_arg</span><span class="p">.</span><span class="n">seqid</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">o_arg</span><span class="p">.</span><span class="n">seqid</span><span class="p">;</span>
	<span class="n">nfs4_init_opendata_res</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
	<span class="n">kref_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">kref</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">p</span><span class="p">;</span>
<span class="nl">err_free:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
<span class="nl">err:</span>
	<span class="n">dput</span><span class="p">(</span><span class="n">parent</span><span class="p">);</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">nfs4_opendata_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">kref</span> <span class="o">*</span><span class="n">kref</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfs4_opendata</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">kref</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">nfs4_opendata</span><span class="p">,</span> <span class="n">kref</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">sb</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">dentry</span><span class="o">-&gt;</span><span class="n">d_sb</span><span class="p">;</span>

	<span class="n">nfs_free_seqid</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">o_arg</span><span class="p">.</span><span class="n">seqid</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">nfs4_put_open_state</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">);</span>
	<span class="n">nfs4_put_state_owner</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">owner</span><span class="p">);</span>
	<span class="n">dput</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">dir</span><span class="p">);</span>
	<span class="n">dput</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">dentry</span><span class="p">);</span>
	<span class="n">nfs_sb_deactive</span><span class="p">(</span><span class="n">sb</span><span class="p">);</span>
	<span class="n">nfs_fattr_free_names</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">f_attr</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">nfs4_opendata_put</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs4_opendata</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">p</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">kref_put</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">kref</span><span class="p">,</span> <span class="n">nfs4_opendata_free</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">nfs4_wait_for_completion_rpc_task</span><span class="p">(</span><span class="k">struct</span> <span class="n">rpc_task</span> <span class="o">*</span><span class="n">task</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">rpc_wait_for_completion_task</span><span class="p">(</span><span class="n">task</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">can_open_cached</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs4_state</span> <span class="o">*</span><span class="n">state</span><span class="p">,</span> <span class="n">fmode_t</span> <span class="n">mode</span><span class="p">,</span> <span class="kt">int</span> <span class="n">open_mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">open_mode</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">O_EXCL</span><span class="o">|</span><span class="n">O_TRUNC</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">mode</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">FMODE_READ</span><span class="o">|</span><span class="n">FMODE_WRITE</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">FMODE_READ</span>:
			<span class="n">ret</span> <span class="o">|=</span> <span class="n">test_bit</span><span class="p">(</span><span class="n">NFS_O_RDONLY_STATE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span>
				<span class="o">&amp;&amp;</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">n_rdonly</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">FMODE_WRITE</span>:
			<span class="n">ret</span> <span class="o">|=</span> <span class="n">test_bit</span><span class="p">(</span><span class="n">NFS_O_WRONLY_STATE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span>
				<span class="o">&amp;&amp;</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">n_wronly</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">FMODE_READ</span><span class="o">|</span><span class="n">FMODE_WRITE</span>:
			<span class="n">ret</span> <span class="o">|=</span> <span class="n">test_bit</span><span class="p">(</span><span class="n">NFS_O_RDWR_STATE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span>
				<span class="o">&amp;&amp;</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">n_rdwr</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">can_open_delegated</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs_delegation</span> <span class="o">*</span><span class="n">delegation</span><span class="p">,</span> <span class="n">fmode_t</span> <span class="n">fmode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">delegation</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">delegation</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">&amp;</span> <span class="n">fmode</span><span class="p">)</span> <span class="o">!=</span> <span class="n">fmode</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">NFS_DELEGATION_NEED_RECLAIM</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">delegation</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">nfs_mark_delegation_referenced</span><span class="p">(</span><span class="n">delegation</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">update_open_stateflags</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs4_state</span> <span class="o">*</span><span class="n">state</span><span class="p">,</span> <span class="n">fmode_t</span> <span class="n">fmode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">fmode</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">FMODE_WRITE</span>:
			<span class="n">state</span><span class="o">-&gt;</span><span class="n">n_wronly</span><span class="o">++</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">FMODE_READ</span>:
			<span class="n">state</span><span class="o">-&gt;</span><span class="n">n_rdonly</span><span class="o">++</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">FMODE_READ</span><span class="o">|</span><span class="n">FMODE_WRITE</span>:
			<span class="n">state</span><span class="o">-&gt;</span><span class="n">n_rdwr</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">nfs4_state_set_mode_locked</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">|</span> <span class="n">fmode</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">nfs_set_open_stateid_locked</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs4_state</span> <span class="o">*</span><span class="n">state</span><span class="p">,</span> <span class="n">nfs4_stateid</span> <span class="o">*</span><span class="n">stateid</span><span class="p">,</span> <span class="n">fmode_t</span> <span class="n">fmode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">NFS_DELEGATED_STATE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">nfs4_stateid_copy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">stateid</span><span class="p">,</span> <span class="n">stateid</span><span class="p">);</span>
	<span class="n">nfs4_stateid_copy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">open_stateid</span><span class="p">,</span> <span class="n">stateid</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">fmode</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">FMODE_READ</span>:
			<span class="n">set_bit</span><span class="p">(</span><span class="n">NFS_O_RDONLY_STATE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">FMODE_WRITE</span>:
			<span class="n">set_bit</span><span class="p">(</span><span class="n">NFS_O_WRONLY_STATE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">FMODE_READ</span><span class="o">|</span><span class="n">FMODE_WRITE</span>:
			<span class="n">set_bit</span><span class="p">(</span><span class="n">NFS_O_RDWR_STATE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">nfs_set_open_stateid</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs4_state</span> <span class="o">*</span><span class="n">state</span><span class="p">,</span> <span class="n">nfs4_stateid</span> <span class="o">*</span><span class="n">stateid</span><span class="p">,</span> <span class="n">fmode_t</span> <span class="n">fmode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">write_seqlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">seqlock</span><span class="p">);</span>
	<span class="n">nfs_set_open_stateid_locked</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">stateid</span><span class="p">,</span> <span class="n">fmode</span><span class="p">);</span>
	<span class="n">write_sequnlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">seqlock</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">__update_open_stateid</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs4_state</span> <span class="o">*</span><span class="n">state</span><span class="p">,</span> <span class="n">nfs4_stateid</span> <span class="o">*</span><span class="n">open_stateid</span><span class="p">,</span> <span class="k">const</span> <span class="n">nfs4_stateid</span> <span class="o">*</span><span class="n">deleg_stateid</span><span class="p">,</span> <span class="n">fmode_t</span> <span class="n">fmode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/*</span>
<span class="cm">	 * Protect the call to nfs4_state_set_mode_locked and</span>
<span class="cm">	 * serialise the stateid update</span>
<span class="cm">	 */</span>
	<span class="n">write_seqlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">seqlock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">deleg_stateid</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">nfs4_stateid_copy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">stateid</span><span class="p">,</span> <span class="n">deleg_stateid</span><span class="p">);</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">NFS_DELEGATED_STATE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">open_stateid</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">nfs_set_open_stateid_locked</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">open_stateid</span><span class="p">,</span> <span class="n">fmode</span><span class="p">);</span>
	<span class="n">write_sequnlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">seqlock</span><span class="p">);</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">owner</span><span class="o">-&gt;</span><span class="n">so_lock</span><span class="p">);</span>
	<span class="n">update_open_stateflags</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">fmode</span><span class="p">);</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">owner</span><span class="o">-&gt;</span><span class="n">so_lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">update_open_stateid</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs4_state</span> <span class="o">*</span><span class="n">state</span><span class="p">,</span> <span class="n">nfs4_stateid</span> <span class="o">*</span><span class="n">open_stateid</span><span class="p">,</span> <span class="n">nfs4_stateid</span> <span class="o">*</span><span class="n">delegation</span><span class="p">,</span> <span class="n">fmode_t</span> <span class="n">fmode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfs_inode</span> <span class="o">*</span><span class="n">nfsi</span> <span class="o">=</span> <span class="n">NFS_I</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">inode</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">nfs_delegation</span> <span class="o">*</span><span class="n">deleg_cur</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">fmode</span> <span class="o">&amp;=</span> <span class="p">(</span><span class="n">FMODE_READ</span><span class="o">|</span><span class="n">FMODE_WRITE</span><span class="p">);</span>

	<span class="n">rcu_read_lock</span><span class="p">();</span>
	<span class="n">deleg_cur</span> <span class="o">=</span> <span class="n">rcu_dereference</span><span class="p">(</span><span class="n">nfsi</span><span class="o">-&gt;</span><span class="n">delegation</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">deleg_cur</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">no_delegation</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">deleg_cur</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nfsi</span><span class="o">-&gt;</span><span class="n">delegation</span> <span class="o">!=</span> <span class="n">deleg_cur</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">deleg_cur</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">&amp;</span> <span class="n">fmode</span><span class="p">)</span> <span class="o">!=</span> <span class="n">fmode</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">no_delegation_unlock</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">delegation</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">delegation</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">deleg_cur</span><span class="o">-&gt;</span><span class="n">stateid</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">nfs4_stateid_match</span><span class="p">(</span><span class="o">&amp;</span><span class="n">deleg_cur</span><span class="o">-&gt;</span><span class="n">stateid</span><span class="p">,</span> <span class="n">delegation</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">no_delegation_unlock</span><span class="p">;</span>

	<span class="n">nfs_mark_delegation_referenced</span><span class="p">(</span><span class="n">deleg_cur</span><span class="p">);</span>
	<span class="n">__update_open_stateid</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">open_stateid</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">deleg_cur</span><span class="o">-&gt;</span><span class="n">stateid</span><span class="p">,</span> <span class="n">fmode</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="nl">no_delegation_unlock:</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">deleg_cur</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
<span class="nl">no_delegation:</span>
	<span class="n">rcu_read_unlock</span><span class="p">();</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span> <span class="o">&amp;&amp;</span> <span class="n">open_stateid</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">__update_open_stateid</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">open_stateid</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">fmode</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">nfs4_return_incompatible_delegation</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="n">fmode_t</span> <span class="n">fmode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfs_delegation</span> <span class="o">*</span><span class="n">delegation</span><span class="p">;</span>

	<span class="n">rcu_read_lock</span><span class="p">();</span>
	<span class="n">delegation</span> <span class="o">=</span> <span class="n">rcu_dereference</span><span class="p">(</span><span class="n">NFS_I</span><span class="p">(</span><span class="n">inode</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">delegation</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">delegation</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span> <span class="p">(</span><span class="n">delegation</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">&amp;</span> <span class="n">fmode</span><span class="p">)</span> <span class="o">==</span> <span class="n">fmode</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rcu_read_unlock</span><span class="p">();</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">rcu_read_unlock</span><span class="p">();</span>
	<span class="n">nfs_inode_return_delegation</span><span class="p">(</span><span class="n">inode</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">nfs4_state</span> <span class="o">*</span><span class="nf">nfs4_try_open_cached</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs4_opendata</span> <span class="o">*</span><span class="n">opendata</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfs4_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">opendata</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nfs_inode</span> <span class="o">*</span><span class="n">nfsi</span> <span class="o">=</span> <span class="n">NFS_I</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">inode</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">nfs_delegation</span> <span class="o">*</span><span class="n">delegation</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">open_mode</span> <span class="o">=</span> <span class="n">opendata</span><span class="o">-&gt;</span><span class="n">o_arg</span><span class="p">.</span><span class="n">open_flags</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">O_EXCL</span><span class="o">|</span><span class="n">O_TRUNC</span><span class="p">);</span>
	<span class="n">fmode_t</span> <span class="n">fmode</span> <span class="o">=</span> <span class="n">opendata</span><span class="o">-&gt;</span><span class="n">o_arg</span><span class="p">.</span><span class="n">fmode</span><span class="p">;</span>
	<span class="n">nfs4_stateid</span> <span class="n">stateid</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(;;)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">can_open_cached</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">fmode</span><span class="p">,</span> <span class="n">open_mode</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">owner</span><span class="o">-&gt;</span><span class="n">so_lock</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">can_open_cached</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">fmode</span><span class="p">,</span> <span class="n">open_mode</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">update_open_stateflags</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">fmode</span><span class="p">);</span>
				<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">owner</span><span class="o">-&gt;</span><span class="n">so_lock</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">out_return_state</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">owner</span><span class="o">-&gt;</span><span class="n">so_lock</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">rcu_read_lock</span><span class="p">();</span>
		<span class="n">delegation</span> <span class="o">=</span> <span class="n">rcu_dereference</span><span class="p">(</span><span class="n">nfsi</span><span class="o">-&gt;</span><span class="n">delegation</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">can_open_delegated</span><span class="p">(</span><span class="n">delegation</span><span class="p">,</span> <span class="n">fmode</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">rcu_read_unlock</span><span class="p">();</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* Save the delegation */</span>
		<span class="n">nfs4_stateid_copy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">stateid</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">delegation</span><span class="o">-&gt;</span><span class="n">stateid</span><span class="p">);</span>
		<span class="n">rcu_read_unlock</span><span class="p">();</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">nfs_may_open</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">inode</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">owner</span><span class="o">-&gt;</span><span class="n">so_cred</span><span class="p">,</span> <span class="n">open_mode</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>

		<span class="cm">/* Try to update the stateid using the delegation */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">update_open_stateid</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">stateid</span><span class="p">,</span> <span class="n">fmode</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">out_return_state</span><span class="p">;</span>
	<span class="p">}</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="n">ret</span><span class="p">);</span>
<span class="nl">out_return_state:</span>
	<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">state</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">nfs4_state</span> <span class="o">*</span><span class="nf">nfs4_opendata_to_nfs4_state</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs4_opendata</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nfs4_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nfs_delegation</span> <span class="o">*</span><span class="n">delegation</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">rpc_done</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">state</span> <span class="o">=</span> <span class="n">nfs4_try_open_cached</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">f_attr</span><span class="p">.</span><span class="n">valid</span> <span class="o">&amp;</span> <span class="n">NFS_ATTR_FATTR</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">inode</span> <span class="o">=</span> <span class="n">nfs_fhget</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">dir</span><span class="o">-&gt;</span><span class="n">d_sb</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">o_res</span><span class="p">.</span><span class="n">fh</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">f_attr</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">inode</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">inode</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">state</span> <span class="o">=</span> <span class="n">nfs4_get_open_state</span><span class="p">(</span><span class="n">inode</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">owner</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">state</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_put_inode</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">o_res</span><span class="p">.</span><span class="n">delegation_type</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">nfs_client</span> <span class="o">*</span><span class="n">clp</span> <span class="o">=</span> <span class="n">NFS_SERVER</span><span class="p">(</span><span class="n">inode</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">nfs_client</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">delegation_flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">rcu_read_lock</span><span class="p">();</span>
		<span class="n">delegation</span> <span class="o">=</span> <span class="n">rcu_dereference</span><span class="p">(</span><span class="n">NFS_I</span><span class="p">(</span><span class="n">inode</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">delegation</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">delegation</span><span class="p">)</span>
			<span class="n">delegation_flags</span> <span class="o">=</span> <span class="n">delegation</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">;</span>
		<span class="n">rcu_read_unlock</span><span class="p">();</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">o_arg</span><span class="p">.</span><span class="n">claim</span> <span class="o">==</span> <span class="n">NFS4_OPEN_CLAIM_DELEGATE_CUR</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_err_ratelimited</span><span class="p">(</span><span class="s">&quot;NFS: Broken NFSv4 server %s is &quot;</span>
					<span class="s">&quot;returning a delegation for &quot;</span>
					<span class="s">&quot;OPEN(CLAIM_DELEGATE_CUR)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_hostname</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">delegation_flags</span> <span class="o">&amp;</span> <span class="mi">1UL</span><span class="o">&lt;&lt;</span><span class="n">NFS_DELEGATION_NEED_RECLAIM</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">nfs_inode_set_delegation</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">inode</span><span class="p">,</span>
					<span class="n">data</span><span class="o">-&gt;</span><span class="n">owner</span><span class="o">-&gt;</span><span class="n">so_cred</span><span class="p">,</span>
					<span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">o_res</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">nfs_inode_reclaim_delegation</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">inode</span><span class="p">,</span>
					<span class="n">data</span><span class="o">-&gt;</span><span class="n">owner</span><span class="o">-&gt;</span><span class="n">so_cred</span><span class="p">,</span>
					<span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">o_res</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">update_open_stateid</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">o_res</span><span class="p">.</span><span class="n">stateid</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span>
			<span class="n">data</span><span class="o">-&gt;</span><span class="n">o_arg</span><span class="p">.</span><span class="n">fmode</span><span class="p">);</span>
	<span class="n">iput</span><span class="p">(</span><span class="n">inode</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">state</span><span class="p">;</span>
<span class="nl">err_put_inode:</span>
	<span class="n">iput</span><span class="p">(</span><span class="n">inode</span><span class="p">);</span>
<span class="nl">err:</span>
	<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="n">ret</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">nfs_open_context</span> <span class="o">*</span><span class="nf">nfs4_state_find_open_context</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs4_state</span> <span class="o">*</span><span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfs_inode</span> <span class="o">*</span><span class="n">nfsi</span> <span class="o">=</span> <span class="n">NFS_I</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">inode</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">nfs_open_context</span> <span class="o">*</span><span class="n">ctx</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_lock</span><span class="p">);</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">nfsi</span><span class="o">-&gt;</span><span class="n">open_files</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">!=</span> <span class="n">state</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">get_nfs_open_context</span><span class="p">(</span><span class="n">ctx</span><span class="p">);</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_lock</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ctx</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">ENOENT</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">nfs4_opendata</span> <span class="o">*</span><span class="nf">nfs4_open_recoverdata_alloc</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs_open_context</span> <span class="o">*</span><span class="n">ctx</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nfs4_state</span> <span class="o">*</span><span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfs4_opendata</span> <span class="o">*</span><span class="n">opendata</span><span class="p">;</span>

	<span class="n">opendata</span> <span class="o">=</span> <span class="n">nfs4_opendata_alloc</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">dentry</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">owner</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">GFP_NOFS</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">opendata</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">ENOMEM</span><span class="p">);</span>
	<span class="n">opendata</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">state</span><span class="p">;</span>
	<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">opendata</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">nfs4_open_recover_helper</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs4_opendata</span> <span class="o">*</span><span class="n">opendata</span><span class="p">,</span> <span class="n">fmode_t</span> <span class="n">fmode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nfs4_state</span> <span class="o">**</span><span class="n">res</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfs4_state</span> <span class="o">*</span><span class="n">newstate</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">opendata</span><span class="o">-&gt;</span><span class="n">o_arg</span><span class="p">.</span><span class="n">open_flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">opendata</span><span class="o">-&gt;</span><span class="n">o_arg</span><span class="p">.</span><span class="n">fmode</span> <span class="o">=</span> <span class="n">fmode</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">opendata</span><span class="o">-&gt;</span><span class="n">o_res</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">opendata</span><span class="o">-&gt;</span><span class="n">o_res</span><span class="p">));</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">opendata</span><span class="o">-&gt;</span><span class="n">c_res</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">opendata</span><span class="o">-&gt;</span><span class="n">c_res</span><span class="p">));</span>
	<span class="n">nfs4_init_opendata_res</span><span class="p">(</span><span class="n">opendata</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">_nfs4_recover_proc_open</span><span class="p">(</span><span class="n">opendata</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span> 
	<span class="n">newstate</span> <span class="o">=</span> <span class="n">nfs4_opendata_to_nfs4_state</span><span class="p">(</span><span class="n">opendata</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">newstate</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">newstate</span><span class="p">);</span>
	<span class="n">nfs4_close_state</span><span class="p">(</span><span class="n">newstate</span><span class="p">,</span> <span class="n">fmode</span><span class="p">);</span>
	<span class="o">*</span><span class="n">res</span> <span class="o">=</span> <span class="n">newstate</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">nfs4_open_recover</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs4_opendata</span> <span class="o">*</span><span class="n">opendata</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nfs4_state</span> <span class="o">*</span><span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfs4_state</span> <span class="o">*</span><span class="n">newstate</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/* memory barrier prior to reading state-&gt;n_* */</span>
	<span class="n">clear_bit</span><span class="p">(</span><span class="n">NFS_DELEGATED_STATE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">smp_rmb</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">n_rdwr</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">clear_bit</span><span class="p">(</span><span class="n">NFS_O_RDWR_STATE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">nfs4_open_recover_helper</span><span class="p">(</span><span class="n">opendata</span><span class="p">,</span> <span class="n">FMODE_READ</span><span class="o">|</span><span class="n">FMODE_WRITE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">newstate</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">newstate</span> <span class="o">!=</span> <span class="n">state</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ESTALE</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">n_wronly</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">clear_bit</span><span class="p">(</span><span class="n">NFS_O_WRONLY_STATE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">nfs4_open_recover_helper</span><span class="p">(</span><span class="n">opendata</span><span class="p">,</span> <span class="n">FMODE_WRITE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">newstate</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">newstate</span> <span class="o">!=</span> <span class="n">state</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ESTALE</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">n_rdonly</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">clear_bit</span><span class="p">(</span><span class="n">NFS_O_RDONLY_STATE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">nfs4_open_recover_helper</span><span class="p">(</span><span class="n">opendata</span><span class="p">,</span> <span class="n">FMODE_READ</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">newstate</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">newstate</span> <span class="o">!=</span> <span class="n">state</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ESTALE</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/*</span>
<span class="cm">	 * We may have performed cached opens for all three recoveries.</span>
<span class="cm">	 * Check if we need to update the current stateid.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">NFS_DELEGATED_STATE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="n">nfs4_stateid_match</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">stateid</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">open_stateid</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">write_seqlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">seqlock</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">NFS_DELEGATED_STATE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">nfs4_stateid_copy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">stateid</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">open_stateid</span><span class="p">);</span>
		<span class="n">write_sequnlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">seqlock</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * OPEN_RECLAIM:</span>
<span class="cm"> * 	reclaim state on the server after a reboot.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">_nfs4_do_open_reclaim</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs_open_context</span> <span class="o">*</span><span class="n">ctx</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nfs4_state</span> <span class="o">*</span><span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfs_delegation</span> <span class="o">*</span><span class="n">delegation</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nfs4_opendata</span> <span class="o">*</span><span class="n">opendata</span><span class="p">;</span>
	<span class="n">fmode_t</span> <span class="n">delegation_type</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">opendata</span> <span class="o">=</span> <span class="n">nfs4_open_recoverdata_alloc</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">state</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">opendata</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">opendata</span><span class="p">);</span>
	<span class="n">opendata</span><span class="o">-&gt;</span><span class="n">o_arg</span><span class="p">.</span><span class="n">claim</span> <span class="o">=</span> <span class="n">NFS4_OPEN_CLAIM_PREVIOUS</span><span class="p">;</span>
	<span class="n">opendata</span><span class="o">-&gt;</span><span class="n">o_arg</span><span class="p">.</span><span class="n">fh</span> <span class="o">=</span> <span class="n">NFS_FH</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">inode</span><span class="p">);</span>
	<span class="n">rcu_read_lock</span><span class="p">();</span>
	<span class="n">delegation</span> <span class="o">=</span> <span class="n">rcu_dereference</span><span class="p">(</span><span class="n">NFS_I</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">inode</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">delegation</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">delegation</span> <span class="o">!=</span> <span class="nb">NULL</span> <span class="o">&amp;&amp;</span> <span class="n">test_bit</span><span class="p">(</span><span class="n">NFS_DELEGATION_NEED_RECLAIM</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">delegation</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">delegation_type</span> <span class="o">=</span> <span class="n">delegation</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">;</span>
	<span class="n">rcu_read_unlock</span><span class="p">();</span>
	<span class="n">opendata</span><span class="o">-&gt;</span><span class="n">o_arg</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">delegation_type</span> <span class="o">=</span> <span class="n">delegation_type</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">nfs4_open_recover</span><span class="p">(</span><span class="n">opendata</span><span class="p">,</span> <span class="n">state</span><span class="p">);</span>
	<span class="n">nfs4_opendata_put</span><span class="p">(</span><span class="n">opendata</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">nfs4_do_open_reclaim</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs_open_context</span> <span class="o">*</span><span class="n">ctx</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nfs4_state</span> <span class="o">*</span><span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfs_server</span> <span class="o">*</span><span class="n">server</span> <span class="o">=</span> <span class="n">NFS_SERVER</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">inode</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">nfs4_exception</span> <span class="n">exception</span> <span class="o">=</span> <span class="p">{</span> <span class="p">};</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">_nfs4_do_open_reclaim</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">state</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">!=</span> <span class="o">-</span><span class="n">NFS4ERR_DELAY</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">nfs4_handle_exception</span><span class="p">(</span><span class="n">server</span><span class="p">,</span> <span class="n">err</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">exception</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">exception</span><span class="p">.</span><span class="n">retry</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">nfs4_open_reclaim</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs4_state_owner</span> <span class="o">*</span><span class="n">sp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nfs4_state</span> <span class="o">*</span><span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfs_open_context</span> <span class="o">*</span><span class="n">ctx</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ctx</span> <span class="o">=</span> <span class="n">nfs4_state_find_open_context</span><span class="p">(</span><span class="n">state</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">ctx</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">ctx</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">nfs4_do_open_reclaim</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">state</span><span class="p">);</span>
	<span class="n">put_nfs_open_context</span><span class="p">(</span><span class="n">ctx</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">_nfs4_open_delegation_recall</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs_open_context</span> <span class="o">*</span><span class="n">ctx</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nfs4_state</span> <span class="o">*</span><span class="n">state</span><span class="p">,</span> <span class="k">const</span> <span class="n">nfs4_stateid</span> <span class="o">*</span><span class="n">stateid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfs4_opendata</span> <span class="o">*</span><span class="n">opendata</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">opendata</span> <span class="o">=</span> <span class="n">nfs4_open_recoverdata_alloc</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">state</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">opendata</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">opendata</span><span class="p">);</span>
	<span class="n">opendata</span><span class="o">-&gt;</span><span class="n">o_arg</span><span class="p">.</span><span class="n">claim</span> <span class="o">=</span> <span class="n">NFS4_OPEN_CLAIM_DELEGATE_CUR</span><span class="p">;</span>
	<span class="n">nfs4_stateid_copy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">opendata</span><span class="o">-&gt;</span><span class="n">o_arg</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">delegation</span><span class="p">,</span> <span class="n">stateid</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">nfs4_open_recover</span><span class="p">(</span><span class="n">opendata</span><span class="p">,</span> <span class="n">state</span><span class="p">);</span>
	<span class="n">nfs4_opendata_put</span><span class="p">(</span><span class="n">opendata</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">nfs4_open_delegation_recall</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs_open_context</span> <span class="o">*</span><span class="n">ctx</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nfs4_state</span> <span class="o">*</span><span class="n">state</span><span class="p">,</span> <span class="k">const</span> <span class="n">nfs4_stateid</span> <span class="o">*</span><span class="n">stateid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfs4_exception</span> <span class="n">exception</span> <span class="o">=</span> <span class="p">{</span> <span class="p">};</span>
	<span class="k">struct</span> <span class="n">nfs_server</span> <span class="o">*</span><span class="n">server</span> <span class="o">=</span> <span class="n">NFS_SERVER</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">inode</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">_nfs4_open_delegation_recall</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">stateid</span><span class="p">);</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="mi">0</span>:
			<span class="k">case</span> <span class="o">-</span><span class="n">ENOENT</span>:
			<span class="k">case</span> <span class="o">-</span><span class="n">ESTALE</span>:
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
			<span class="k">case</span> <span class="o">-</span><span class="n">NFS4ERR_BADSESSION</span>:
			<span class="k">case</span> <span class="o">-</span><span class="n">NFS4ERR_BADSLOT</span>:
			<span class="k">case</span> <span class="o">-</span><span class="n">NFS4ERR_BAD_HIGH_SLOT</span>:
			<span class="k">case</span> <span class="o">-</span><span class="n">NFS4ERR_CONN_NOT_BOUND_TO_SESSION</span>:
			<span class="k">case</span> <span class="o">-</span><span class="n">NFS4ERR_DEADSESSION</span>:
				<span class="n">nfs4_schedule_session_recovery</span><span class="p">(</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">nfs_client</span><span class="o">-&gt;</span><span class="n">cl_session</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
			<span class="k">case</span> <span class="o">-</span><span class="n">NFS4ERR_STALE_CLIENTID</span>:
			<span class="k">case</span> <span class="o">-</span><span class="n">NFS4ERR_STALE_STATEID</span>:
			<span class="k">case</span> <span class="o">-</span><span class="n">NFS4ERR_EXPIRED</span>:
				<span class="cm">/* Don&#39;t recall a delegation if it was lost */</span>
				<span class="n">nfs4_schedule_lease_recovery</span><span class="p">(</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">nfs_client</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
			<span class="k">case</span> <span class="o">-</span><span class="n">ERESTARTSYS</span>:
				<span class="cm">/*</span>
<span class="cm">				 * The show must go on: exit, but mark the</span>
<span class="cm">				 * stateid as needing recovery.</span>
<span class="cm">				 */</span>
			<span class="k">case</span> <span class="o">-</span><span class="n">NFS4ERR_DELEG_REVOKED</span>:
			<span class="k">case</span> <span class="o">-</span><span class="n">NFS4ERR_ADMIN_REVOKED</span>:
			<span class="k">case</span> <span class="o">-</span><span class="n">NFS4ERR_BAD_STATEID</span>:
				<span class="n">nfs_inode_find_state_and_recover</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">inode</span><span class="p">,</span>
						<span class="n">stateid</span><span class="p">);</span>
				<span class="n">nfs4_schedule_stateid_recovery</span><span class="p">(</span><span class="n">server</span><span class="p">,</span> <span class="n">state</span><span class="p">);</span>
			<span class="k">case</span> <span class="o">-</span><span class="n">EKEYEXPIRED</span>:
				<span class="cm">/*</span>
<span class="cm">				 * User RPCSEC_GSS context has expired.</span>
<span class="cm">				 * We cannot recover this stateid now, so</span>
<span class="cm">				 * skip it and allow recovery thread to</span>
<span class="cm">				 * proceed.</span>
<span class="cm">				 */</span>
			<span class="k">case</span> <span class="o">-</span><span class="n">ENOMEM</span>:
				<span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">nfs4_handle_exception</span><span class="p">(</span><span class="n">server</span><span class="p">,</span> <span class="n">err</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">exception</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">exception</span><span class="p">.</span><span class="n">retry</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">nfs4_open_confirm_done</span><span class="p">(</span><span class="k">struct</span> <span class="n">rpc_task</span> <span class="o">*</span><span class="n">task</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">calldata</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfs4_opendata</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">calldata</span><span class="p">;</span>

	<span class="n">data</span><span class="o">-&gt;</span><span class="n">rpc_status</span> <span class="o">=</span> <span class="n">task</span><span class="o">-&gt;</span><span class="n">tk_status</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">rpc_status</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">nfs4_stateid_copy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">o_res</span><span class="p">.</span><span class="n">stateid</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">c_res</span><span class="p">.</span><span class="n">stateid</span><span class="p">);</span>
		<span class="n">nfs_confirm_seqid</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">owner</span><span class="o">-&gt;</span><span class="n">so_seqid</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">renew_lease</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">o_res</span><span class="p">.</span><span class="n">server</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">timestamp</span><span class="p">);</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">rpc_done</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">nfs4_open_confirm_release</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">calldata</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfs4_opendata</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">calldata</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nfs4_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="cm">/* If this request hasn&#39;t been cancelled, do nothing */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">cancelled</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_free</span><span class="p">;</span>
	<span class="cm">/* In case of error, no cleanup! */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">rpc_done</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_free</span><span class="p">;</span>
	<span class="n">state</span> <span class="o">=</span> <span class="n">nfs4_opendata_to_nfs4_state</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">state</span><span class="p">))</span>
		<span class="n">nfs4_close_state</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">o_arg</span><span class="p">.</span><span class="n">fmode</span><span class="p">);</span>
<span class="nl">out_free:</span>
	<span class="n">nfs4_opendata_put</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">rpc_call_ops</span> <span class="n">nfs4_open_confirm_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">rpc_call_done</span> <span class="o">=</span> <span class="n">nfs4_open_confirm_done</span><span class="p">,</span>
	<span class="p">.</span><span class="n">rpc_release</span> <span class="o">=</span> <span class="n">nfs4_open_confirm_release</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * Note: On error, nfs4_proc_open_confirm will free the struct nfs4_opendata</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">_nfs4_proc_open_confirm</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs4_opendata</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfs_server</span> <span class="o">*</span><span class="n">server</span> <span class="o">=</span> <span class="n">NFS_SERVER</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">dir</span><span class="o">-&gt;</span><span class="n">d_inode</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">rpc_task</span> <span class="o">*</span><span class="n">task</span><span class="p">;</span>
	<span class="k">struct</span>  <span class="n">rpc_message</span> <span class="n">msg</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">rpc_proc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">nfs4_procedures</span><span class="p">[</span><span class="n">NFSPROC4_CLNT_OPEN_CONFIRM</span><span class="p">],</span>
		<span class="p">.</span><span class="n">rpc_argp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">c_arg</span><span class="p">,</span>
		<span class="p">.</span><span class="n">rpc_resp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">c_res</span><span class="p">,</span>
		<span class="p">.</span><span class="n">rpc_cred</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">owner</span><span class="o">-&gt;</span><span class="n">so_cred</span><span class="p">,</span>
	<span class="p">};</span>
	<span class="k">struct</span> <span class="n">rpc_task_setup</span> <span class="n">task_setup_data</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">rpc_client</span> <span class="o">=</span> <span class="n">server</span><span class="o">-&gt;</span><span class="n">client</span><span class="p">,</span>
		<span class="p">.</span><span class="n">rpc_message</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">msg</span><span class="p">,</span>
		<span class="p">.</span><span class="n">callback_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">nfs4_open_confirm_ops</span><span class="p">,</span>
		<span class="p">.</span><span class="n">callback_data</span> <span class="o">=</span> <span class="n">data</span><span class="p">,</span>
		<span class="p">.</span><span class="n">workqueue</span> <span class="o">=</span> <span class="n">nfsiod_workqueue</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">RPC_TASK_ASYNC</span><span class="p">,</span>
	<span class="p">};</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">kref_get</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">kref</span><span class="p">);</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">rpc_done</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">rpc_status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">timestamp</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
	<span class="n">task</span> <span class="o">=</span> <span class="n">rpc_run_task</span><span class="p">(</span><span class="o">&amp;</span><span class="n">task_setup_data</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">task</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">task</span><span class="p">);</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">nfs4_wait_for_completion_rpc_task</span><span class="p">(</span><span class="n">task</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">cancelled</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">smp_wmb</span><span class="p">();</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">rpc_status</span><span class="p">;</span>
	<span class="n">rpc_put_task</span><span class="p">(</span><span class="n">task</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">nfs4_open_prepare</span><span class="p">(</span><span class="k">struct</span> <span class="n">rpc_task</span> <span class="o">*</span><span class="n">task</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">calldata</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfs4_opendata</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">calldata</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nfs4_state_owner</span> <span class="o">*</span><span class="n">sp</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">owner</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nfs_wait_on_sequence</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">o_arg</span><span class="p">.</span><span class="n">seqid</span><span class="p">,</span> <span class="n">task</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * Check if we still need to send an OPEN call, or if we can use</span>
<span class="cm">	 * a delegation instead.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">nfs_delegation</span> <span class="o">*</span><span class="n">delegation</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">can_open_cached</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">o_arg</span><span class="p">.</span><span class="n">fmode</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">o_arg</span><span class="p">.</span><span class="n">open_flags</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">out_no_action</span><span class="p">;</span>
		<span class="n">rcu_read_lock</span><span class="p">();</span>
		<span class="n">delegation</span> <span class="o">=</span> <span class="n">rcu_dereference</span><span class="p">(</span><span class="n">NFS_I</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">inode</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">delegation</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">o_arg</span><span class="p">.</span><span class="n">claim</span> <span class="o">!=</span> <span class="n">NFS4_OPEN_CLAIM_DELEGATE_CUR</span> <span class="o">&amp;&amp;</span>
		    <span class="n">can_open_delegated</span><span class="p">(</span><span class="n">delegation</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">o_arg</span><span class="p">.</span><span class="n">fmode</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">unlock_no_action</span><span class="p">;</span>
		<span class="n">rcu_read_unlock</span><span class="p">();</span>
	<span class="p">}</span>
	<span class="cm">/* Update client id. */</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">o_arg</span><span class="p">.</span><span class="n">clientid</span> <span class="o">=</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">so_server</span><span class="o">-&gt;</span><span class="n">nfs_client</span><span class="o">-&gt;</span><span class="n">cl_clientid</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">o_arg</span><span class="p">.</span><span class="n">claim</span> <span class="o">==</span> <span class="n">NFS4_OPEN_CLAIM_PREVIOUS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">task</span><span class="o">-&gt;</span><span class="n">tk_msg</span><span class="p">.</span><span class="n">rpc_proc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">nfs4_procedures</span><span class="p">[</span><span class="n">NFSPROC4_CLNT_OPEN_NOATTR</span><span class="p">];</span>
		<span class="n">nfs_copy_fh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">o_res</span><span class="p">.</span><span class="n">fh</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">o_arg</span><span class="p">.</span><span class="n">fh</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">timestamp</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nfs4_setup_sequence</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">o_arg</span><span class="p">.</span><span class="n">server</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">o_arg</span><span class="p">.</span><span class="n">seq_args</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">o_res</span><span class="p">.</span><span class="n">seq_res</span><span class="p">,</span> <span class="n">task</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">rpc_call_start</span><span class="p">(</span><span class="n">task</span><span class="p">);</span>
	<span class="k">return</span><span class="p">;</span>
<span class="nl">unlock_no_action:</span>
	<span class="n">rcu_read_unlock</span><span class="p">();</span>
<span class="nl">out_no_action:</span>
	<span class="n">task</span><span class="o">-&gt;</span><span class="n">tk_action</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">nfs4_recover_open_prepare</span><span class="p">(</span><span class="k">struct</span> <span class="n">rpc_task</span> <span class="o">*</span><span class="n">task</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">calldata</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">rpc_task_set_priority</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="n">RPC_PRIORITY_PRIVILEGED</span><span class="p">);</span>
	<span class="n">nfs4_open_prepare</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="n">calldata</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">nfs4_open_done</span><span class="p">(</span><span class="k">struct</span> <span class="n">rpc_task</span> <span class="o">*</span><span class="n">task</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">calldata</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfs4_opendata</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">calldata</span><span class="p">;</span>

	<span class="n">data</span><span class="o">-&gt;</span><span class="n">rpc_status</span> <span class="o">=</span> <span class="n">task</span><span class="o">-&gt;</span><span class="n">tk_status</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">nfs4_sequence_done</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">o_res</span><span class="p">.</span><span class="n">seq_res</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">task</span><span class="o">-&gt;</span><span class="n">tk_status</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">o_res</span><span class="p">.</span><span class="n">f_attr</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">&amp;</span> <span class="n">S_IFMT</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="n">S_IFREG</span>:
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">S_IFLNK</span>:
				<span class="n">data</span><span class="o">-&gt;</span><span class="n">rpc_status</span> <span class="o">=</span> <span class="o">-</span><span class="n">ELOOP</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">S_IFDIR</span>:
				<span class="n">data</span><span class="o">-&gt;</span><span class="n">rpc_status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EISDIR</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="nl">default:</span>
				<span class="n">data</span><span class="o">-&gt;</span><span class="n">rpc_status</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOTDIR</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">renew_lease</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">o_res</span><span class="p">.</span><span class="n">server</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">timestamp</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">o_res</span><span class="p">.</span><span class="n">rflags</span> <span class="o">&amp;</span> <span class="n">NFS4_OPEN_RESULT_CONFIRM</span><span class="p">))</span>
			<span class="n">nfs_confirm_seqid</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">owner</span><span class="o">-&gt;</span><span class="n">so_seqid</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">rpc_done</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">nfs4_open_release</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">calldata</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfs4_opendata</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">calldata</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nfs4_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="cm">/* If this request hasn&#39;t been cancelled, do nothing */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">cancelled</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_free</span><span class="p">;</span>
	<span class="cm">/* In case of error, no cleanup! */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">rpc_status</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">||</span> <span class="o">!</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">rpc_done</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_free</span><span class="p">;</span>
	<span class="cm">/* In case we need an open_confirm, no cleanup! */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">o_res</span><span class="p">.</span><span class="n">rflags</span> <span class="o">&amp;</span> <span class="n">NFS4_OPEN_RESULT_CONFIRM</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_free</span><span class="p">;</span>
	<span class="n">state</span> <span class="o">=</span> <span class="n">nfs4_opendata_to_nfs4_state</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">state</span><span class="p">))</span>
		<span class="n">nfs4_close_state</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">o_arg</span><span class="p">.</span><span class="n">fmode</span><span class="p">);</span>
<span class="nl">out_free:</span>
	<span class="n">nfs4_opendata_put</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">rpc_call_ops</span> <span class="n">nfs4_open_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">rpc_call_prepare</span> <span class="o">=</span> <span class="n">nfs4_open_prepare</span><span class="p">,</span>
	<span class="p">.</span><span class="n">rpc_call_done</span> <span class="o">=</span> <span class="n">nfs4_open_done</span><span class="p">,</span>
	<span class="p">.</span><span class="n">rpc_release</span> <span class="o">=</span> <span class="n">nfs4_open_release</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">rpc_call_ops</span> <span class="n">nfs4_recover_open_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">rpc_call_prepare</span> <span class="o">=</span> <span class="n">nfs4_recover_open_prepare</span><span class="p">,</span>
	<span class="p">.</span><span class="n">rpc_call_done</span> <span class="o">=</span> <span class="n">nfs4_open_done</span><span class="p">,</span>
	<span class="p">.</span><span class="n">rpc_release</span> <span class="o">=</span> <span class="n">nfs4_open_release</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">nfs4_run_open_task</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs4_opendata</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">int</span> <span class="n">isrecover</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">dir</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">dir</span><span class="o">-&gt;</span><span class="n">d_inode</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nfs_server</span> <span class="o">*</span><span class="n">server</span> <span class="o">=</span> <span class="n">NFS_SERVER</span><span class="p">(</span><span class="n">dir</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">nfs_openargs</span> <span class="o">*</span><span class="n">o_arg</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">o_arg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nfs_openres</span> <span class="o">*</span><span class="n">o_res</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">o_res</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rpc_task</span> <span class="o">*</span><span class="n">task</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rpc_message</span> <span class="n">msg</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">rpc_proc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">nfs4_procedures</span><span class="p">[</span><span class="n">NFSPROC4_CLNT_OPEN</span><span class="p">],</span>
		<span class="p">.</span><span class="n">rpc_argp</span> <span class="o">=</span> <span class="n">o_arg</span><span class="p">,</span>
		<span class="p">.</span><span class="n">rpc_resp</span> <span class="o">=</span> <span class="n">o_res</span><span class="p">,</span>
		<span class="p">.</span><span class="n">rpc_cred</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">owner</span><span class="o">-&gt;</span><span class="n">so_cred</span><span class="p">,</span>
	<span class="p">};</span>
	<span class="k">struct</span> <span class="n">rpc_task_setup</span> <span class="n">task_setup_data</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">rpc_client</span> <span class="o">=</span> <span class="n">server</span><span class="o">-&gt;</span><span class="n">client</span><span class="p">,</span>
		<span class="p">.</span><span class="n">rpc_message</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">msg</span><span class="p">,</span>
		<span class="p">.</span><span class="n">callback_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">nfs4_open_ops</span><span class="p">,</span>
		<span class="p">.</span><span class="n">callback_data</span> <span class="o">=</span> <span class="n">data</span><span class="p">,</span>
		<span class="p">.</span><span class="n">workqueue</span> <span class="o">=</span> <span class="n">nfsiod_workqueue</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">RPC_TASK_ASYNC</span><span class="p">,</span>
	<span class="p">};</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">nfs41_init_sequence</span><span class="p">(</span><span class="o">&amp;</span><span class="n">o_arg</span><span class="o">-&gt;</span><span class="n">seq_args</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">o_res</span><span class="o">-&gt;</span><span class="n">seq_res</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">kref_get</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">kref</span><span class="p">);</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">rpc_done</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">rpc_status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">cancelled</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">isrecover</span><span class="p">)</span>
		<span class="n">task_setup_data</span><span class="p">.</span><span class="n">callback_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">nfs4_recover_open_ops</span><span class="p">;</span>
	<span class="n">task</span> <span class="o">=</span> <span class="n">rpc_run_task</span><span class="p">(</span><span class="o">&amp;</span><span class="n">task_setup_data</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">task</span><span class="p">))</span>
                <span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">task</span><span class="p">);</span>
        <span class="n">status</span> <span class="o">=</span> <span class="n">nfs4_wait_for_completion_rpc_task</span><span class="p">(</span><span class="n">task</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">data</span><span class="o">-&gt;</span><span class="n">cancelled</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
                <span class="n">smp_wmb</span><span class="p">();</span>
        <span class="p">}</span> <span class="k">else</span>
                <span class="n">status</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">rpc_status</span><span class="p">;</span>
        <span class="n">rpc_put_task</span><span class="p">(</span><span class="n">task</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">_nfs4_recover_proc_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs4_opendata</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">dir</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">dir</span><span class="o">-&gt;</span><span class="n">d_inode</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nfs_openres</span> <span class="o">*</span><span class="n">o_res</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">o_res</span><span class="p">;</span>
        <span class="kt">int</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">nfs4_run_open_task</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">||</span> <span class="o">!</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">rpc_done</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">nfs_fattr_map_and_free_names</span><span class="p">(</span><span class="n">NFS_SERVER</span><span class="p">(</span><span class="n">dir</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">f_attr</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">o_res</span><span class="o">-&gt;</span><span class="n">rflags</span> <span class="o">&amp;</span> <span class="n">NFS4_OPEN_RESULT_CONFIRM</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">_nfs4_proc_open_confirm</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Note: On error, nfs4_proc_open will free the struct nfs4_opendata</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">_nfs4_proc_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs4_opendata</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">dir</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">dir</span><span class="o">-&gt;</span><span class="n">d_inode</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nfs_server</span> <span class="o">*</span><span class="n">server</span> <span class="o">=</span> <span class="n">NFS_SERVER</span><span class="p">(</span><span class="n">dir</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">nfs_openargs</span> <span class="o">*</span><span class="n">o_arg</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">o_arg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nfs_openres</span> <span class="o">*</span><span class="n">o_res</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">o_res</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">nfs4_run_open_task</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">rpc_done</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="o">-</span><span class="n">NFS4ERR_BADNAME</span> <span class="o">&amp;&amp;</span>
				<span class="o">!</span><span class="p">(</span><span class="n">o_arg</span><span class="o">-&gt;</span><span class="n">open_flags</span> <span class="o">&amp;</span> <span class="n">O_CREAT</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">nfs_fattr_map_and_free_names</span><span class="p">(</span><span class="n">server</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">f_attr</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">o_arg</span><span class="o">-&gt;</span><span class="n">open_flags</span> <span class="o">&amp;</span> <span class="n">O_CREAT</span><span class="p">)</span>
		<span class="n">update_changeattr</span><span class="p">(</span><span class="n">dir</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">o_res</span><span class="o">-&gt;</span><span class="n">cinfo</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">o_res</span><span class="o">-&gt;</span><span class="n">rflags</span> <span class="o">&amp;</span> <span class="n">NFS4_OPEN_RESULT_LOCKTYPE_POSIX</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">server</span><span class="o">-&gt;</span><span class="n">caps</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">NFS_CAP_POSIX_LOCK</span><span class="p">;</span>
	<span class="k">if</span><span class="p">(</span><span class="n">o_res</span><span class="o">-&gt;</span><span class="n">rflags</span> <span class="o">&amp;</span> <span class="n">NFS4_OPEN_RESULT_CONFIRM</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">_nfs4_proc_open_confirm</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">o_res</span><span class="o">-&gt;</span><span class="n">f_attr</span><span class="o">-&gt;</span><span class="n">valid</span> <span class="o">&amp;</span> <span class="n">NFS_ATTR_FATTR</span><span class="p">))</span>
		<span class="n">_nfs4_proc_getattr</span><span class="p">(</span><span class="n">server</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">o_res</span><span class="o">-&gt;</span><span class="n">fh</span><span class="p">,</span> <span class="n">o_res</span><span class="o">-&gt;</span><span class="n">f_attr</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">nfs4_client_recover_expired_lease</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs_client</span> <span class="o">*</span><span class="n">clp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">loop</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">loop</span> <span class="o">=</span> <span class="n">NFS4_MAX_LOOP_ON_RECOVER</span><span class="p">;</span> <span class="n">loop</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">loop</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">nfs4_wait_clnt_recover</span><span class="p">(</span><span class="n">clp</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">NFS4CLNT_LEASE_EXPIRED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_state</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">NFS4CLNT_CHECK_LEASE</span><span class="p">,</span><span class="o">&amp;</span><span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_state</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">nfs4_schedule_state_manager</span><span class="p">(</span><span class="n">clp</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">nfs4_recover_expired_lease</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs_server</span> <span class="o">*</span><span class="n">server</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">nfs4_client_recover_expired_lease</span><span class="p">(</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">nfs_client</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * OPEN_EXPIRED:</span>
<span class="cm"> * 	reclaim state on the server after a network partition.</span>
<span class="cm"> * 	Assumes caller holds the appropriate lock</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">_nfs4_open_expired</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs_open_context</span> <span class="o">*</span><span class="n">ctx</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nfs4_state</span> <span class="o">*</span><span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfs4_opendata</span> <span class="o">*</span><span class="n">opendata</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">opendata</span> <span class="o">=</span> <span class="n">nfs4_open_recoverdata_alloc</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">state</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">opendata</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">opendata</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">nfs4_open_recover</span><span class="p">(</span><span class="n">opendata</span><span class="p">,</span> <span class="n">state</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="o">-</span><span class="n">ESTALE</span><span class="p">)</span>
		<span class="n">d_drop</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">dentry</span><span class="p">);</span>
	<span class="n">nfs4_opendata_put</span><span class="p">(</span><span class="n">opendata</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">nfs4_do_open_expired</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs_open_context</span> <span class="o">*</span><span class="n">ctx</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nfs4_state</span> <span class="o">*</span><span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfs_server</span> <span class="o">*</span><span class="n">server</span> <span class="o">=</span> <span class="n">NFS_SERVER</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">inode</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">nfs4_exception</span> <span class="n">exception</span> <span class="o">=</span> <span class="p">{</span> <span class="p">};</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">_nfs4_open_expired</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">state</span><span class="p">);</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="nl">default:</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="k">case</span> <span class="o">-</span><span class="n">NFS4ERR_GRACE</span>:
		<span class="k">case</span> <span class="o">-</span><span class="n">NFS4ERR_DELAY</span>:
			<span class="n">nfs4_handle_exception</span><span class="p">(</span><span class="n">server</span><span class="p">,</span> <span class="n">err</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">exception</span><span class="p">);</span>
			<span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">exception</span><span class="p">.</span><span class="n">retry</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">nfs4_open_expired</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs4_state_owner</span> <span class="o">*</span><span class="n">sp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nfs4_state</span> <span class="o">*</span><span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfs_open_context</span> <span class="o">*</span><span class="n">ctx</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ctx</span> <span class="o">=</span> <span class="n">nfs4_state_find_open_context</span><span class="p">(</span><span class="n">state</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">ctx</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">ctx</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">nfs4_do_open_expired</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">state</span><span class="p">);</span>
	<span class="n">put_nfs_open_context</span><span class="p">(</span><span class="n">ctx</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#if defined(CONFIG_NFS_V4_1)</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">nfs41_check_expired_stateid</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs4_state</span> <span class="o">*</span><span class="n">state</span><span class="p">,</span> <span class="n">nfs4_stateid</span> <span class="o">*</span><span class="n">stateid</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="n">NFS_OK</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nfs_server</span> <span class="o">*</span><span class="n">server</span> <span class="o">=</span> <span class="n">NFS_SERVER</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">inode</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">flags</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">nfs41_test_stateid</span><span class="p">(</span><span class="n">server</span><span class="p">,</span> <span class="n">stateid</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">!=</span> <span class="n">NFS_OK</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">nfs41_free_stateid</span><span class="p">(</span><span class="n">server</span><span class="p">,</span> <span class="n">stateid</span><span class="p">);</span>
			<span class="n">state</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">flags</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">nfs41_open_expired</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs4_state_owner</span> <span class="o">*</span><span class="n">sp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nfs4_state</span> <span class="o">*</span><span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">deleg_status</span><span class="p">,</span> <span class="n">open_status</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">deleg_flags</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">NFS_DELEGATED_STATE</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">open_flags</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">NFS_O_RDONLY_STATE</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">NFS_O_WRONLY_STATE</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">NFS_O_RDWR_STATE</span><span class="p">);</span>

	<span class="n">deleg_status</span> <span class="o">=</span> <span class="n">nfs41_check_expired_stateid</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">stateid</span><span class="p">,</span> <span class="n">deleg_flags</span><span class="p">);</span>
	<span class="n">open_status</span> <span class="o">=</span> <span class="n">nfs41_check_expired_stateid</span><span class="p">(</span><span class="n">state</span><span class="p">,</span>  <span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">open_stateid</span><span class="p">,</span> <span class="n">open_flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">deleg_status</span> <span class="o">==</span> <span class="n">NFS_OK</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">open_status</span> <span class="o">==</span> <span class="n">NFS_OK</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">NFS_OK</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">nfs4_open_expired</span><span class="p">(</span><span class="n">sp</span><span class="p">,</span> <span class="n">state</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="cm">/*</span>
<span class="cm"> * on an EXCLUSIVE create, the server should send back a bitmask with FATTR4-*</span>
<span class="cm"> * fields corresponding to attributes that were used to store the verifier.</span>
<span class="cm"> * Make sure we clobber those fields in the later setattr call</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">nfs4_exclusive_attrset</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs4_opendata</span> <span class="o">*</span><span class="n">opendata</span><span class="p">,</span> <span class="k">struct</span> <span class="n">iattr</span> <span class="o">*</span><span class="n">sattr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">opendata</span><span class="o">-&gt;</span><span class="n">o_res</span><span class="p">.</span><span class="n">attrset</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">FATTR4_WORD1_TIME_ACCESS</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="p">(</span><span class="n">sattr</span><span class="o">-&gt;</span><span class="n">ia_valid</span> <span class="o">&amp;</span> <span class="n">ATTR_ATIME_SET</span><span class="p">))</span>
		<span class="n">sattr</span><span class="o">-&gt;</span><span class="n">ia_valid</span> <span class="o">|=</span> <span class="n">ATTR_ATIME</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">opendata</span><span class="o">-&gt;</span><span class="n">o_res</span><span class="p">.</span><span class="n">attrset</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">FATTR4_WORD1_TIME_MODIFY</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="p">(</span><span class="n">sattr</span><span class="o">-&gt;</span><span class="n">ia_valid</span> <span class="o">&amp;</span> <span class="n">ATTR_MTIME_SET</span><span class="p">))</span>
		<span class="n">sattr</span><span class="o">-&gt;</span><span class="n">ia_valid</span> <span class="o">|=</span> <span class="n">ATTR_MTIME</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Returns a referenced nfs4_state</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">_nfs4_do_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">dir</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="n">dentry</span><span class="p">,</span>
			<span class="n">fmode_t</span> <span class="n">fmode</span><span class="p">,</span>
			<span class="kt">int</span> <span class="n">flags</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">iattr</span> <span class="o">*</span><span class="n">sattr</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">rpc_cred</span> <span class="o">*</span><span class="n">cred</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">nfs4_state</span> <span class="o">**</span><span class="n">res</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">nfs4_threshold</span> <span class="o">**</span><span class="n">ctx_th</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfs4_state_owner</span>  <span class="o">*</span><span class="n">sp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nfs4_state</span>     <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nfs_server</span>       <span class="o">*</span><span class="n">server</span> <span class="o">=</span> <span class="n">NFS_SERVER</span><span class="p">(</span><span class="n">dir</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">nfs4_opendata</span> <span class="o">*</span><span class="n">opendata</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>

	<span class="cm">/* Protect against reboot recovery conflicts */</span>
	<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">sp</span> <span class="o">=</span> <span class="n">nfs4_get_state_owner</span><span class="p">(</span><span class="n">server</span><span class="p">,</span> <span class="n">cred</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sp</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;nfs4_do_open: nfs4_get_state_owner failed!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_err</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">nfs4_recover_expired_lease</span><span class="p">(</span><span class="n">server</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_put_state_owner</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dentry</span><span class="o">-&gt;</span><span class="n">d_inode</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">nfs4_return_incompatible_delegation</span><span class="p">(</span><span class="n">dentry</span><span class="o">-&gt;</span><span class="n">d_inode</span><span class="p">,</span> <span class="n">fmode</span><span class="p">);</span>
	<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">opendata</span> <span class="o">=</span> <span class="n">nfs4_opendata_alloc</span><span class="p">(</span><span class="n">dentry</span><span class="p">,</span> <span class="n">sp</span><span class="p">,</span> <span class="n">fmode</span><span class="p">,</span> <span class="n">flags</span><span class="p">,</span> <span class="n">sattr</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">opendata</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_put_state_owner</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ctx_th</span> <span class="o">&amp;&amp;</span> <span class="n">server</span><span class="o">-&gt;</span><span class="n">attr_bitmask</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">FATTR4_WORD2_MDSTHRESHOLD</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">opendata</span><span class="o">-&gt;</span><span class="n">f_attr</span><span class="p">.</span><span class="n">mdsthreshold</span> <span class="o">=</span> <span class="n">pnfs_mdsthreshold_alloc</span><span class="p">();</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">opendata</span><span class="o">-&gt;</span><span class="n">f_attr</span><span class="p">.</span><span class="n">mdsthreshold</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">err_opendata_put</span><span class="p">;</span>
		<span class="n">opendata</span><span class="o">-&gt;</span><span class="n">o_arg</span><span class="p">.</span><span class="n">open_bitmap</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">nfs4_pnfs_open_bitmap</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dentry</span><span class="o">-&gt;</span><span class="n">d_inode</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">opendata</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">nfs4_get_open_state</span><span class="p">(</span><span class="n">dentry</span><span class="o">-&gt;</span><span class="n">d_inode</span><span class="p">,</span> <span class="n">sp</span><span class="p">);</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">_nfs4_proc_open</span><span class="p">(</span><span class="n">opendata</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_opendata_put</span><span class="p">;</span>

	<span class="n">state</span> <span class="o">=</span> <span class="n">nfs4_opendata_to_nfs4_state</span><span class="p">(</span><span class="n">opendata</span><span class="p">);</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">state</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">state</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">err_opendata_put</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">caps</span> <span class="o">&amp;</span> <span class="n">NFS_CAP_POSIX_LOCK</span><span class="p">)</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">NFS_STATE_POSIX_LOCKS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">opendata</span><span class="o">-&gt;</span><span class="n">o_arg</span><span class="p">.</span><span class="n">open_flags</span> <span class="o">&amp;</span> <span class="n">O_EXCL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">nfs4_exclusive_attrset</span><span class="p">(</span><span class="n">opendata</span><span class="p">,</span> <span class="n">sattr</span><span class="p">);</span>

		<span class="n">nfs_fattr_init</span><span class="p">(</span><span class="n">opendata</span><span class="o">-&gt;</span><span class="n">o_res</span><span class="p">.</span><span class="n">f_attr</span><span class="p">);</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">nfs4_do_setattr</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">inode</span><span class="p">,</span> <span class="n">cred</span><span class="p">,</span>
				<span class="n">opendata</span><span class="o">-&gt;</span><span class="n">o_res</span><span class="p">.</span><span class="n">f_attr</span><span class="p">,</span> <span class="n">sattr</span><span class="p">,</span>
				<span class="n">state</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">nfs_setattr_update_inode</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">inode</span><span class="p">,</span> <span class="n">sattr</span><span class="p">);</span>
		<span class="n">nfs_post_op_update_inode</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">inode</span><span class="p">,</span> <span class="n">opendata</span><span class="o">-&gt;</span><span class="n">o_res</span><span class="p">.</span><span class="n">f_attr</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pnfs_use_threshold</span><span class="p">(</span><span class="n">ctx_th</span><span class="p">,</span> <span class="n">opendata</span><span class="o">-&gt;</span><span class="n">f_attr</span><span class="p">.</span><span class="n">mdsthreshold</span><span class="p">,</span> <span class="n">server</span><span class="p">))</span>
		<span class="o">*</span><span class="n">ctx_th</span> <span class="o">=</span> <span class="n">opendata</span><span class="o">-&gt;</span><span class="n">f_attr</span><span class="p">.</span><span class="n">mdsthreshold</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">opendata</span><span class="o">-&gt;</span><span class="n">f_attr</span><span class="p">.</span><span class="n">mdsthreshold</span><span class="p">);</span>
	<span class="n">opendata</span><span class="o">-&gt;</span><span class="n">f_attr</span><span class="p">.</span><span class="n">mdsthreshold</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">nfs4_opendata_put</span><span class="p">(</span><span class="n">opendata</span><span class="p">);</span>
	<span class="n">nfs4_put_state_owner</span><span class="p">(</span><span class="n">sp</span><span class="p">);</span>
	<span class="o">*</span><span class="n">res</span> <span class="o">=</span> <span class="n">state</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">err_opendata_put:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">opendata</span><span class="o">-&gt;</span><span class="n">f_attr</span><span class="p">.</span><span class="n">mdsthreshold</span><span class="p">);</span>
	<span class="n">nfs4_opendata_put</span><span class="p">(</span><span class="n">opendata</span><span class="p">);</span>
<span class="nl">err_put_state_owner:</span>
	<span class="n">nfs4_put_state_owner</span><span class="p">(</span><span class="n">sp</span><span class="p">);</span>
<span class="nl">out_err:</span>
	<span class="o">*</span><span class="n">res</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="k">struct</span> <span class="n">nfs4_state</span> <span class="o">*</span><span class="nf">nfs4_do_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">dir</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="n">dentry</span><span class="p">,</span>
					<span class="n">fmode_t</span> <span class="n">fmode</span><span class="p">,</span>
					<span class="kt">int</span> <span class="n">flags</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">iattr</span> <span class="o">*</span><span class="n">sattr</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">rpc_cred</span> <span class="o">*</span><span class="n">cred</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">nfs4_threshold</span> <span class="o">**</span><span class="n">ctx_th</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfs4_exception</span> <span class="n">exception</span> <span class="o">=</span> <span class="p">{</span> <span class="p">};</span>
	<span class="k">struct</span> <span class="n">nfs4_state</span> <span class="o">*</span><span class="n">res</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">fmode</span> <span class="o">&amp;=</span> <span class="n">FMODE_READ</span><span class="o">|</span><span class="n">FMODE_WRITE</span><span class="p">;</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">_nfs4_do_open</span><span class="p">(</span><span class="n">dir</span><span class="p">,</span> <span class="n">dentry</span><span class="p">,</span> <span class="n">fmode</span><span class="p">,</span> <span class="n">flags</span><span class="p">,</span> <span class="n">sattr</span><span class="p">,</span> <span class="n">cred</span><span class="p">,</span>
				       <span class="o">&amp;</span><span class="n">res</span><span class="p">,</span> <span class="n">ctx_th</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="cm">/* NOTE: BAD_SEQID means the server and client disagree about the</span>
<span class="cm">		 * book-keeping w.r.t. state-changing operations</span>
<span class="cm">		 * (OPEN/CLOSE/LOCK/LOCKU...)</span>
<span class="cm">		 * It is actually a sign of a bug on the client or on the server.</span>
<span class="cm">		 *</span>
<span class="cm">		 * If we receive a BAD_SEQID error in the particular case of</span>
<span class="cm">		 * doing an OPEN, we assume that nfs_increment_open_seqid() will</span>
<span class="cm">		 * have unhashed the old state_owner for us, and that we can</span>
<span class="cm">		 * therefore safely retry using a new one. We should still warn</span>
<span class="cm">		 * the user though...</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="o">-</span><span class="n">NFS4ERR_BAD_SEQID</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_warn_ratelimited</span><span class="p">(</span><span class="s">&quot;NFS: v4 server %s &quot;</span>
					<span class="s">&quot; returned a bad sequence-id error!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">NFS_SERVER</span><span class="p">(</span><span class="n">dir</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">nfs_client</span><span class="o">-&gt;</span><span class="n">cl_hostname</span><span class="p">);</span>
			<span class="n">exception</span><span class="p">.</span><span class="n">retry</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/*</span>
<span class="cm">		 * BAD_STATEID on OPEN means that the server cancelled our</span>
<span class="cm">		 * state before it received the OPEN_CONFIRM.</span>
<span class="cm">		 * Recover by retrying the request as per the discussion</span>
<span class="cm">		 * on Page 181 of RFC3530.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="o">-</span><span class="n">NFS4ERR_BAD_STATEID</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">exception</span><span class="p">.</span><span class="n">retry</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* We must have found a delegation */</span>
			<span class="n">exception</span><span class="p">.</span><span class="n">retry</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">res</span> <span class="o">=</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="n">nfs4_handle_exception</span><span class="p">(</span><span class="n">NFS_SERVER</span><span class="p">(</span><span class="n">dir</span><span class="p">),</span>
					<span class="n">status</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">exception</span><span class="p">));</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">exception</span><span class="p">.</span><span class="n">retry</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">_nfs4_do_setattr</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rpc_cred</span> <span class="o">*</span><span class="n">cred</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">nfs_fattr</span> <span class="o">*</span><span class="n">fattr</span><span class="p">,</span> <span class="k">struct</span> <span class="n">iattr</span> <span class="o">*</span><span class="n">sattr</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">nfs4_state</span> <span class="o">*</span><span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfs_server</span> <span class="o">*</span><span class="n">server</span> <span class="o">=</span> <span class="n">NFS_SERVER</span><span class="p">(</span><span class="n">inode</span><span class="p">);</span>
        <span class="k">struct</span> <span class="n">nfs_setattrargs</span>  <span class="n">arg</span> <span class="o">=</span> <span class="p">{</span>
                <span class="p">.</span><span class="n">fh</span>             <span class="o">=</span> <span class="n">NFS_FH</span><span class="p">(</span><span class="n">inode</span><span class="p">),</span>
                <span class="p">.</span><span class="n">iap</span>            <span class="o">=</span> <span class="n">sattr</span><span class="p">,</span>
		<span class="p">.</span><span class="n">server</span>		<span class="o">=</span> <span class="n">server</span><span class="p">,</span>
		<span class="p">.</span><span class="n">bitmask</span> <span class="o">=</span> <span class="n">server</span><span class="o">-&gt;</span><span class="n">attr_bitmask</span><span class="p">,</span>
        <span class="p">};</span>
        <span class="k">struct</span> <span class="n">nfs_setattrres</span>  <span class="n">res</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">fattr</span>		<span class="o">=</span> <span class="n">fattr</span><span class="p">,</span>
		<span class="p">.</span><span class="n">server</span>		<span class="o">=</span> <span class="n">server</span><span class="p">,</span>
        <span class="p">};</span>
        <span class="k">struct</span> <span class="n">rpc_message</span> <span class="n">msg</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">rpc_proc</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">nfs4_procedures</span><span class="p">[</span><span class="n">NFSPROC4_CLNT_SETATTR</span><span class="p">],</span>
		<span class="p">.</span><span class="n">rpc_argp</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">arg</span><span class="p">,</span>
		<span class="p">.</span><span class="n">rpc_resp</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">res</span><span class="p">,</span>
		<span class="p">.</span><span class="n">rpc_cred</span>	<span class="o">=</span> <span class="n">cred</span><span class="p">,</span>
        <span class="p">};</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">timestamp</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">nfs_fattr_init</span><span class="p">(</span><span class="n">fattr</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">state</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">nfs4_select_rw_stateid</span><span class="p">(</span><span class="o">&amp;</span><span class="n">arg</span><span class="p">.</span><span class="n">stateid</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">FMODE_WRITE</span><span class="p">,</span>
				<span class="n">current</span><span class="o">-&gt;</span><span class="n">files</span><span class="p">,</span> <span class="n">current</span><span class="o">-&gt;</span><span class="n">tgid</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">nfs4_copy_delegation_stateid</span><span class="p">(</span><span class="o">&amp;</span><span class="n">arg</span><span class="p">.</span><span class="n">stateid</span><span class="p">,</span> <span class="n">inode</span><span class="p">,</span>
				<span class="n">FMODE_WRITE</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* Use that stateid */</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">nfs4_stateid_copy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">arg</span><span class="p">.</span><span class="n">stateid</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">zero_stateid</span><span class="p">);</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">nfs4_call_sync</span><span class="p">(</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">client</span><span class="p">,</span> <span class="n">server</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">msg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">arg</span><span class="p">.</span><span class="n">seq_args</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">res</span><span class="p">.</span><span class="n">seq_res</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">state</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">renew_lease</span><span class="p">(</span><span class="n">server</span><span class="p">,</span> <span class="n">timestamp</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">nfs4_do_setattr</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rpc_cred</span> <span class="o">*</span><span class="n">cred</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">nfs_fattr</span> <span class="o">*</span><span class="n">fattr</span><span class="p">,</span> <span class="k">struct</span> <span class="n">iattr</span> <span class="o">*</span><span class="n">sattr</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">nfs4_state</span> <span class="o">*</span><span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfs_server</span> <span class="o">*</span><span class="n">server</span> <span class="o">=</span> <span class="n">NFS_SERVER</span><span class="p">(</span><span class="n">inode</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">nfs4_exception</span> <span class="n">exception</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">state</span><span class="p">,</span>
		<span class="p">.</span><span class="n">inode</span> <span class="o">=</span> <span class="n">inode</span><span class="p">,</span>
	<span class="p">};</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">_nfs4_do_setattr</span><span class="p">(</span><span class="n">inode</span><span class="p">,</span> <span class="n">cred</span><span class="p">,</span> <span class="n">fattr</span><span class="p">,</span> <span class="n">sattr</span><span class="p">,</span> <span class="n">state</span><span class="p">);</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="o">-</span><span class="n">NFS4ERR_OPENMODE</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">state</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">&amp;</span> <span class="n">FMODE_WRITE</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBADF</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">sattr</span><span class="o">-&gt;</span><span class="n">ia_valid</span> <span class="o">&amp;</span> <span class="n">ATTR_OPEN</span><span class="p">)</span>
					<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EACCES</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">nfs4_handle_exception</span><span class="p">(</span><span class="n">server</span><span class="p">,</span> <span class="n">err</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">exception</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">exception</span><span class="p">.</span><span class="n">retry</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">nfs4_closedata</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nfs4_state</span> <span class="o">*</span><span class="n">state</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nfs_closeargs</span> <span class="n">arg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nfs_closeres</span> <span class="n">res</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nfs_fattr</span> <span class="n">fattr</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">timestamp</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">roc</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">roc_barrier</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">nfs4_free_closedata</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfs4_closedata</span> <span class="o">*</span><span class="n">calldata</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nfs4_state_owner</span> <span class="o">*</span><span class="n">sp</span> <span class="o">=</span> <span class="n">calldata</span><span class="o">-&gt;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">owner</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">sb</span> <span class="o">=</span> <span class="n">calldata</span><span class="o">-&gt;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_sb</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">calldata</span><span class="o">-&gt;</span><span class="n">roc</span><span class="p">)</span>
		<span class="n">pnfs_roc_release</span><span class="p">(</span><span class="n">calldata</span><span class="o">-&gt;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">inode</span><span class="p">);</span>
	<span class="n">nfs4_put_open_state</span><span class="p">(</span><span class="n">calldata</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">);</span>
	<span class="n">nfs_free_seqid</span><span class="p">(</span><span class="n">calldata</span><span class="o">-&gt;</span><span class="n">arg</span><span class="p">.</span><span class="n">seqid</span><span class="p">);</span>
	<span class="n">nfs4_put_state_owner</span><span class="p">(</span><span class="n">sp</span><span class="p">);</span>
	<span class="n">nfs_sb_deactive</span><span class="p">(</span><span class="n">sb</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">calldata</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">nfs4_close_clear_stateid_flags</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs4_state</span> <span class="o">*</span><span class="n">state</span><span class="p">,</span>
		<span class="n">fmode_t</span> <span class="n">fmode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">owner</span><span class="o">-&gt;</span><span class="n">so_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">fmode</span> <span class="o">&amp;</span> <span class="n">FMODE_READ</span><span class="p">))</span>
		<span class="n">clear_bit</span><span class="p">(</span><span class="n">NFS_O_RDONLY_STATE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">fmode</span> <span class="o">&amp;</span> <span class="n">FMODE_WRITE</span><span class="p">))</span>
		<span class="n">clear_bit</span><span class="p">(</span><span class="n">NFS_O_WRONLY_STATE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">clear_bit</span><span class="p">(</span><span class="n">NFS_O_RDWR_STATE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">owner</span><span class="o">-&gt;</span><span class="n">so_lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">nfs4_close_done</span><span class="p">(</span><span class="k">struct</span> <span class="n">rpc_task</span> <span class="o">*</span><span class="n">task</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfs4_closedata</span> <span class="o">*</span><span class="n">calldata</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nfs4_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">calldata</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nfs_server</span> <span class="o">*</span><span class="n">server</span> <span class="o">=</span> <span class="n">NFS_SERVER</span><span class="p">(</span><span class="n">calldata</span><span class="o">-&gt;</span><span class="n">inode</span><span class="p">);</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s: begin!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">nfs4_sequence_done</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">calldata</span><span class="o">-&gt;</span><span class="n">res</span><span class="p">.</span><span class="n">seq_res</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>
        <span class="cm">/* hmm. we are done with the inode, and in the process of freeing</span>
<span class="cm">	 * the state_owner. we keep this around to process errors</span>
<span class="cm">	 */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">task</span><span class="o">-&gt;</span><span class="n">tk_status</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">0</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">calldata</span><span class="o">-&gt;</span><span class="n">roc</span><span class="p">)</span>
				<span class="n">pnfs_roc_set_barrier</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">inode</span><span class="p">,</span>
						     <span class="n">calldata</span><span class="o">-&gt;</span><span class="n">roc_barrier</span><span class="p">);</span>
			<span class="n">nfs_set_open_stateid</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">calldata</span><span class="o">-&gt;</span><span class="n">res</span><span class="p">.</span><span class="n">stateid</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">renew_lease</span><span class="p">(</span><span class="n">server</span><span class="p">,</span> <span class="n">calldata</span><span class="o">-&gt;</span><span class="n">timestamp</span><span class="p">);</span>
			<span class="n">nfs4_close_clear_stateid_flags</span><span class="p">(</span><span class="n">state</span><span class="p">,</span>
					<span class="n">calldata</span><span class="o">-&gt;</span><span class="n">arg</span><span class="p">.</span><span class="n">fmode</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="o">-</span><span class="n">NFS4ERR_STALE_STATEID</span>:
		<span class="k">case</span> <span class="o">-</span><span class="n">NFS4ERR_OLD_STATEID</span>:
		<span class="k">case</span> <span class="o">-</span><span class="n">NFS4ERR_BAD_STATEID</span>:
		<span class="k">case</span> <span class="o">-</span><span class="n">NFS4ERR_EXPIRED</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">calldata</span><span class="o">-&gt;</span><span class="n">arg</span><span class="p">.</span><span class="n">fmode</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">nfs4_async_handle_error</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="n">server</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">)</span>
				<span class="n">rpc_restart_call_prepare</span><span class="p">(</span><span class="n">task</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">nfs_release_seqid</span><span class="p">(</span><span class="n">calldata</span><span class="o">-&gt;</span><span class="n">arg</span><span class="p">.</span><span class="n">seqid</span><span class="p">);</span>
	<span class="n">nfs_refresh_inode</span><span class="p">(</span><span class="n">calldata</span><span class="o">-&gt;</span><span class="n">inode</span><span class="p">,</span> <span class="n">calldata</span><span class="o">-&gt;</span><span class="n">res</span><span class="p">.</span><span class="n">fattr</span><span class="p">);</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s: done, ret = %d!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">task</span><span class="o">-&gt;</span><span class="n">tk_status</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">nfs4_close_prepare</span><span class="p">(</span><span class="k">struct</span> <span class="n">rpc_task</span> <span class="o">*</span><span class="n">task</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfs4_closedata</span> <span class="o">*</span><span class="n">calldata</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nfs4_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">calldata</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">call_close</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s: begin!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nfs_wait_on_sequence</span><span class="p">(</span><span class="n">calldata</span><span class="o">-&gt;</span><span class="n">arg</span><span class="p">.</span><span class="n">seqid</span><span class="p">,</span> <span class="n">task</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">task</span><span class="o">-&gt;</span><span class="n">tk_msg</span><span class="p">.</span><span class="n">rpc_proc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">nfs4_procedures</span><span class="p">[</span><span class="n">NFSPROC4_CLNT_OPEN_DOWNGRADE</span><span class="p">];</span>
	<span class="n">calldata</span><span class="o">-&gt;</span><span class="n">arg</span><span class="p">.</span><span class="n">fmode</span> <span class="o">=</span> <span class="n">FMODE_READ</span><span class="o">|</span><span class="n">FMODE_WRITE</span><span class="p">;</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">owner</span><span class="o">-&gt;</span><span class="n">so_lock</span><span class="p">);</span>
	<span class="cm">/* Calculate the change in open mode */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">n_rdwr</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">n_rdonly</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">call_close</span> <span class="o">|=</span> <span class="n">test_bit</span><span class="p">(</span><span class="n">NFS_O_RDONLY_STATE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
			<span class="n">call_close</span> <span class="o">|=</span> <span class="n">test_bit</span><span class="p">(</span><span class="n">NFS_O_RDWR_STATE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
			<span class="n">calldata</span><span class="o">-&gt;</span><span class="n">arg</span><span class="p">.</span><span class="n">fmode</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">FMODE_READ</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">n_wronly</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">call_close</span> <span class="o">|=</span> <span class="n">test_bit</span><span class="p">(</span><span class="n">NFS_O_WRONLY_STATE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
			<span class="n">call_close</span> <span class="o">|=</span> <span class="n">test_bit</span><span class="p">(</span><span class="n">NFS_O_RDWR_STATE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
			<span class="n">calldata</span><span class="o">-&gt;</span><span class="n">arg</span><span class="p">.</span><span class="n">fmode</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">FMODE_WRITE</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">owner</span><span class="o">-&gt;</span><span class="n">so_lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">call_close</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Note: exit _without_ calling nfs4_close_done */</span>
		<span class="n">task</span><span class="o">-&gt;</span><span class="n">tk_action</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">calldata</span><span class="o">-&gt;</span><span class="n">arg</span><span class="p">.</span><span class="n">fmode</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">task</span><span class="o">-&gt;</span><span class="n">tk_msg</span><span class="p">.</span><span class="n">rpc_proc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">nfs4_procedures</span><span class="p">[</span><span class="n">NFSPROC4_CLNT_CLOSE</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">calldata</span><span class="o">-&gt;</span><span class="n">roc</span> <span class="o">&amp;&amp;</span>
		    <span class="n">pnfs_roc_drain</span><span class="p">(</span><span class="n">calldata</span><span class="o">-&gt;</span><span class="n">inode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">calldata</span><span class="o">-&gt;</span><span class="n">roc_barrier</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">rpc_sleep_on</span><span class="p">(</span><span class="o">&amp;</span><span class="n">NFS_SERVER</span><span class="p">(</span><span class="n">calldata</span><span class="o">-&gt;</span><span class="n">inode</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">roc_rpcwaitq</span><span class="p">,</span>
				     <span class="n">task</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">nfs_fattr_init</span><span class="p">(</span><span class="n">calldata</span><span class="o">-&gt;</span><span class="n">res</span><span class="p">.</span><span class="n">fattr</span><span class="p">);</span>
	<span class="n">calldata</span><span class="o">-&gt;</span><span class="n">timestamp</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nfs4_setup_sequence</span><span class="p">(</span><span class="n">NFS_SERVER</span><span class="p">(</span><span class="n">calldata</span><span class="o">-&gt;</span><span class="n">inode</span><span class="p">),</span>
				<span class="o">&amp;</span><span class="n">calldata</span><span class="o">-&gt;</span><span class="n">arg</span><span class="p">.</span><span class="n">seq_args</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="n">calldata</span><span class="o">-&gt;</span><span class="n">res</span><span class="p">.</span><span class="n">seq_res</span><span class="p">,</span>
				<span class="n">task</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="n">rpc_call_start</span><span class="p">(</span><span class="n">task</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s: done!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">rpc_call_ops</span> <span class="n">nfs4_close_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">rpc_call_prepare</span> <span class="o">=</span> <span class="n">nfs4_close_prepare</span><span class="p">,</span>
	<span class="p">.</span><span class="n">rpc_call_done</span> <span class="o">=</span> <span class="n">nfs4_close_done</span><span class="p">,</span>
	<span class="p">.</span><span class="n">rpc_release</span> <span class="o">=</span> <span class="n">nfs4_free_closedata</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* </span>
<span class="cm"> * It is possible for data to be read/written from a mem-mapped file </span>
<span class="cm"> * after the sys_close call (which hits the vfs layer as a flush).</span>
<span class="cm"> * This means that we can&#39;t safely call nfsv4 close on a file until </span>
<span class="cm"> * the inode is cleared. This in turn means that we are not good</span>
<span class="cm"> * NFSv4 citizens - we do not indicate to the server to update the file&#39;s </span>
<span class="cm"> * share state even when we are done with one of the three share </span>
<span class="cm"> * stateid&#39;s in the inode.</span>
<span class="cm"> *</span>
<span class="cm"> * NOTE: Caller must be holding the sp-&gt;so_owner semaphore!</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">nfs4_do_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs4_state</span> <span class="o">*</span><span class="n">state</span><span class="p">,</span> <span class="n">gfp_t</span> <span class="n">gfp_mask</span><span class="p">,</span> <span class="kt">int</span> <span class="n">wait</span><span class="p">,</span> <span class="n">bool</span> <span class="n">roc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfs_server</span> <span class="o">*</span><span class="n">server</span> <span class="o">=</span> <span class="n">NFS_SERVER</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">inode</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">nfs4_closedata</span> <span class="o">*</span><span class="n">calldata</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nfs4_state_owner</span> <span class="o">*</span><span class="n">sp</span> <span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">owner</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rpc_task</span> <span class="o">*</span><span class="n">task</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rpc_message</span> <span class="n">msg</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">rpc_proc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">nfs4_procedures</span><span class="p">[</span><span class="n">NFSPROC4_CLNT_CLOSE</span><span class="p">],</span>
		<span class="p">.</span><span class="n">rpc_cred</span> <span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">owner</span><span class="o">-&gt;</span><span class="n">so_cred</span><span class="p">,</span>
	<span class="p">};</span>
	<span class="k">struct</span> <span class="n">rpc_task_setup</span> <span class="n">task_setup_data</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">rpc_client</span> <span class="o">=</span> <span class="n">server</span><span class="o">-&gt;</span><span class="n">client</span><span class="p">,</span>
		<span class="p">.</span><span class="n">rpc_message</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">msg</span><span class="p">,</span>
		<span class="p">.</span><span class="n">callback_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">nfs4_close_ops</span><span class="p">,</span>
		<span class="p">.</span><span class="n">workqueue</span> <span class="o">=</span> <span class="n">nfsiod_workqueue</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">RPC_TASK_ASYNC</span><span class="p">,</span>
	<span class="p">};</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">calldata</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">calldata</span><span class="p">),</span> <span class="n">gfp_mask</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">calldata</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="n">nfs41_init_sequence</span><span class="p">(</span><span class="o">&amp;</span><span class="n">calldata</span><span class="o">-&gt;</span><span class="n">arg</span><span class="p">.</span><span class="n">seq_args</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">calldata</span><span class="o">-&gt;</span><span class="n">res</span><span class="p">.</span><span class="n">seq_res</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">calldata</span><span class="o">-&gt;</span><span class="n">inode</span> <span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">inode</span><span class="p">;</span>
	<span class="n">calldata</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">state</span><span class="p">;</span>
	<span class="n">calldata</span><span class="o">-&gt;</span><span class="n">arg</span><span class="p">.</span><span class="n">fh</span> <span class="o">=</span> <span class="n">NFS_FH</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">inode</span><span class="p">);</span>
	<span class="n">calldata</span><span class="o">-&gt;</span><span class="n">arg</span><span class="p">.</span><span class="n">stateid</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">open_stateid</span><span class="p">;</span>
	<span class="cm">/* Serialization for the sequence id */</span>
	<span class="n">calldata</span><span class="o">-&gt;</span><span class="n">arg</span><span class="p">.</span><span class="n">seqid</span> <span class="o">=</span> <span class="n">nfs_alloc_seqid</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">owner</span><span class="o">-&gt;</span><span class="n">so_seqid</span><span class="p">,</span> <span class="n">gfp_mask</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">calldata</span><span class="o">-&gt;</span><span class="n">arg</span><span class="p">.</span><span class="n">seqid</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_free_calldata</span><span class="p">;</span>
	<span class="n">calldata</span><span class="o">-&gt;</span><span class="n">arg</span><span class="p">.</span><span class="n">fmode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">calldata</span><span class="o">-&gt;</span><span class="n">arg</span><span class="p">.</span><span class="n">bitmask</span> <span class="o">=</span> <span class="n">server</span><span class="o">-&gt;</span><span class="n">cache_consistency_bitmask</span><span class="p">;</span>
	<span class="n">calldata</span><span class="o">-&gt;</span><span class="n">res</span><span class="p">.</span><span class="n">fattr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">calldata</span><span class="o">-&gt;</span><span class="n">fattr</span><span class="p">;</span>
	<span class="n">calldata</span><span class="o">-&gt;</span><span class="n">res</span><span class="p">.</span><span class="n">seqid</span> <span class="o">=</span> <span class="n">calldata</span><span class="o">-&gt;</span><span class="n">arg</span><span class="p">.</span><span class="n">seqid</span><span class="p">;</span>
	<span class="n">calldata</span><span class="o">-&gt;</span><span class="n">res</span><span class="p">.</span><span class="n">server</span> <span class="o">=</span> <span class="n">server</span><span class="p">;</span>
	<span class="n">calldata</span><span class="o">-&gt;</span><span class="n">roc</span> <span class="o">=</span> <span class="n">roc</span><span class="p">;</span>
	<span class="n">nfs_sb_active</span><span class="p">(</span><span class="n">calldata</span><span class="o">-&gt;</span><span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_sb</span><span class="p">);</span>

	<span class="n">msg</span><span class="p">.</span><span class="n">rpc_argp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">calldata</span><span class="o">-&gt;</span><span class="n">arg</span><span class="p">;</span>
	<span class="n">msg</span><span class="p">.</span><span class="n">rpc_resp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">calldata</span><span class="o">-&gt;</span><span class="n">res</span><span class="p">;</span>
	<span class="n">task_setup_data</span><span class="p">.</span><span class="n">callback_data</span> <span class="o">=</span> <span class="n">calldata</span><span class="p">;</span>
	<span class="n">task</span> <span class="o">=</span> <span class="n">rpc_run_task</span><span class="p">(</span><span class="o">&amp;</span><span class="n">task_setup_data</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">task</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">task</span><span class="p">);</span>
	<span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wait</span><span class="p">)</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">rpc_wait_for_completion_task</span><span class="p">(</span><span class="n">task</span><span class="p">);</span>
	<span class="n">rpc_put_task</span><span class="p">(</span><span class="n">task</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="nl">out_free_calldata:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">calldata</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">roc</span><span class="p">)</span>
		<span class="n">pnfs_roc_release</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">inode</span><span class="p">);</span>
	<span class="n">nfs4_put_open_state</span><span class="p">(</span><span class="n">state</span><span class="p">);</span>
	<span class="n">nfs4_put_state_owner</span><span class="p">(</span><span class="n">sp</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span>
<span class="nf">nfs4_atomic_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">dir</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nfs_open_context</span> <span class="o">*</span><span class="n">ctx</span><span class="p">,</span> <span class="kt">int</span> <span class="n">open_flags</span><span class="p">,</span> <span class="k">struct</span> <span class="n">iattr</span> <span class="o">*</span><span class="n">attr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfs4_state</span> <span class="o">*</span><span class="n">state</span><span class="p">;</span>

	<span class="cm">/* Protect against concurrent sillydeletes */</span>
	<span class="n">state</span> <span class="o">=</span> <span class="n">nfs4_do_open</span><span class="p">(</span><span class="n">dir</span><span class="p">,</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">dentry</span><span class="p">,</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">mode</span><span class="p">,</span> <span class="n">open_flags</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span>
			     <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">cred</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">mdsthreshold</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">state</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">ERR_CAST</span><span class="p">(</span><span class="n">state</span><span class="p">);</span>
	<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">state</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">igrab</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">inode</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">nfs4_close_context</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs_open_context</span> <span class="o">*</span><span class="n">ctx</span><span class="p">,</span> <span class="kt">int</span> <span class="n">is_sync</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">is_sync</span><span class="p">)</span>
		<span class="n">nfs4_close_sync</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">,</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">mode</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">nfs4_close_state</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">,</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">mode</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">_nfs4_server_capabilities</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs_server</span> <span class="o">*</span><span class="n">server</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nfs_fh</span> <span class="o">*</span><span class="n">fhandle</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfs4_server_caps_arg</span> <span class="n">args</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">fhandle</span> <span class="o">=</span> <span class="n">fhandle</span><span class="p">,</span>
	<span class="p">};</span>
	<span class="k">struct</span> <span class="n">nfs4_server_caps_res</span> <span class="n">res</span> <span class="o">=</span> <span class="p">{};</span>
	<span class="k">struct</span> <span class="n">rpc_message</span> <span class="n">msg</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">rpc_proc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">nfs4_procedures</span><span class="p">[</span><span class="n">NFSPROC4_CLNT_SERVER_CAPS</span><span class="p">],</span>
		<span class="p">.</span><span class="n">rpc_argp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">args</span><span class="p">,</span>
		<span class="p">.</span><span class="n">rpc_resp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">res</span><span class="p">,</span>
	<span class="p">};</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">nfs4_call_sync</span><span class="p">(</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">client</span><span class="p">,</span> <span class="n">server</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">msg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">args</span><span class="p">.</span><span class="n">seq_args</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">res</span><span class="p">.</span><span class="n">seq_res</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">attr_bitmask</span><span class="p">,</span> <span class="n">res</span><span class="p">.</span><span class="n">attr_bitmask</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">attr_bitmask</span><span class="p">));</span>
		<span class="n">server</span><span class="o">-&gt;</span><span class="n">caps</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">NFS_CAP_ACLS</span><span class="o">|</span><span class="n">NFS_CAP_HARDLINKS</span><span class="o">|</span>
				<span class="n">NFS_CAP_SYMLINKS</span><span class="o">|</span><span class="n">NFS_CAP_FILEID</span><span class="o">|</span>
				<span class="n">NFS_CAP_MODE</span><span class="o">|</span><span class="n">NFS_CAP_NLINK</span><span class="o">|</span><span class="n">NFS_CAP_OWNER</span><span class="o">|</span>
				<span class="n">NFS_CAP_OWNER_GROUP</span><span class="o">|</span><span class="n">NFS_CAP_ATIME</span><span class="o">|</span>
				<span class="n">NFS_CAP_CTIME</span><span class="o">|</span><span class="n">NFS_CAP_MTIME</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="p">.</span><span class="n">attr_bitmask</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">FATTR4_WORD0_ACL</span><span class="p">)</span>
			<span class="n">server</span><span class="o">-&gt;</span><span class="n">caps</span> <span class="o">|=</span> <span class="n">NFS_CAP_ACLS</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="p">.</span><span class="n">has_links</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">server</span><span class="o">-&gt;</span><span class="n">caps</span> <span class="o">|=</span> <span class="n">NFS_CAP_HARDLINKS</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="p">.</span><span class="n">has_symlinks</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">server</span><span class="o">-&gt;</span><span class="n">caps</span> <span class="o">|=</span> <span class="n">NFS_CAP_SYMLINKS</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="p">.</span><span class="n">attr_bitmask</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">FATTR4_WORD0_FILEID</span><span class="p">)</span>
			<span class="n">server</span><span class="o">-&gt;</span><span class="n">caps</span> <span class="o">|=</span> <span class="n">NFS_CAP_FILEID</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="p">.</span><span class="n">attr_bitmask</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">FATTR4_WORD1_MODE</span><span class="p">)</span>
			<span class="n">server</span><span class="o">-&gt;</span><span class="n">caps</span> <span class="o">|=</span> <span class="n">NFS_CAP_MODE</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="p">.</span><span class="n">attr_bitmask</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">FATTR4_WORD1_NUMLINKS</span><span class="p">)</span>
			<span class="n">server</span><span class="o">-&gt;</span><span class="n">caps</span> <span class="o">|=</span> <span class="n">NFS_CAP_NLINK</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="p">.</span><span class="n">attr_bitmask</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">FATTR4_WORD1_OWNER</span><span class="p">)</span>
			<span class="n">server</span><span class="o">-&gt;</span><span class="n">caps</span> <span class="o">|=</span> <span class="n">NFS_CAP_OWNER</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="p">.</span><span class="n">attr_bitmask</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">FATTR4_WORD1_OWNER_GROUP</span><span class="p">)</span>
			<span class="n">server</span><span class="o">-&gt;</span><span class="n">caps</span> <span class="o">|=</span> <span class="n">NFS_CAP_OWNER_GROUP</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="p">.</span><span class="n">attr_bitmask</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">FATTR4_WORD1_TIME_ACCESS</span><span class="p">)</span>
			<span class="n">server</span><span class="o">-&gt;</span><span class="n">caps</span> <span class="o">|=</span> <span class="n">NFS_CAP_ATIME</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="p">.</span><span class="n">attr_bitmask</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">FATTR4_WORD1_TIME_METADATA</span><span class="p">)</span>
			<span class="n">server</span><span class="o">-&gt;</span><span class="n">caps</span> <span class="o">|=</span> <span class="n">NFS_CAP_CTIME</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="p">.</span><span class="n">attr_bitmask</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">FATTR4_WORD1_TIME_MODIFY</span><span class="p">)</span>
			<span class="n">server</span><span class="o">-&gt;</span><span class="n">caps</span> <span class="o">|=</span> <span class="n">NFS_CAP_MTIME</span><span class="p">;</span>

		<span class="n">memcpy</span><span class="p">(</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">cache_consistency_bitmask</span><span class="p">,</span> <span class="n">res</span><span class="p">.</span><span class="n">attr_bitmask</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">cache_consistency_bitmask</span><span class="p">));</span>
		<span class="n">server</span><span class="o">-&gt;</span><span class="n">cache_consistency_bitmask</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="n">FATTR4_WORD0_CHANGE</span><span class="o">|</span><span class="n">FATTR4_WORD0_SIZE</span><span class="p">;</span>
		<span class="n">server</span><span class="o">-&gt;</span><span class="n">cache_consistency_bitmask</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="n">FATTR4_WORD1_TIME_METADATA</span><span class="o">|</span><span class="n">FATTR4_WORD1_TIME_MODIFY</span><span class="p">;</span>
		<span class="n">server</span><span class="o">-&gt;</span><span class="n">acl_bitmask</span> <span class="o">=</span> <span class="n">res</span><span class="p">.</span><span class="n">acl_bitmask</span><span class="p">;</span>
		<span class="n">server</span><span class="o">-&gt;</span><span class="n">fh_expire_type</span> <span class="o">=</span> <span class="n">res</span><span class="p">.</span><span class="n">fh_expire_type</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">nfs4_server_capabilities</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs_server</span> <span class="o">*</span><span class="n">server</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nfs_fh</span> <span class="o">*</span><span class="n">fhandle</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfs4_exception</span> <span class="n">exception</span> <span class="o">=</span> <span class="p">{</span> <span class="p">};</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">nfs4_handle_exception</span><span class="p">(</span><span class="n">server</span><span class="p">,</span>
				<span class="n">_nfs4_server_capabilities</span><span class="p">(</span><span class="n">server</span><span class="p">,</span> <span class="n">fhandle</span><span class="p">),</span>
				<span class="o">&amp;</span><span class="n">exception</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">exception</span><span class="p">.</span><span class="n">retry</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">_nfs4_lookup_root</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs_server</span> <span class="o">*</span><span class="n">server</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nfs_fh</span> <span class="o">*</span><span class="n">fhandle</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">nfs_fsinfo</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfs4_lookup_root_arg</span> <span class="n">args</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">bitmask</span> <span class="o">=</span> <span class="n">nfs4_fattr_bitmap</span><span class="p">,</span>
	<span class="p">};</span>
	<span class="k">struct</span> <span class="n">nfs4_lookup_res</span> <span class="n">res</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">server</span> <span class="o">=</span> <span class="n">server</span><span class="p">,</span>
		<span class="p">.</span><span class="n">fattr</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">fattr</span><span class="p">,</span>
		<span class="p">.</span><span class="n">fh</span> <span class="o">=</span> <span class="n">fhandle</span><span class="p">,</span>
	<span class="p">};</span>
	<span class="k">struct</span> <span class="n">rpc_message</span> <span class="n">msg</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">rpc_proc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">nfs4_procedures</span><span class="p">[</span><span class="n">NFSPROC4_CLNT_LOOKUP_ROOT</span><span class="p">],</span>
		<span class="p">.</span><span class="n">rpc_argp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">args</span><span class="p">,</span>
		<span class="p">.</span><span class="n">rpc_resp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">res</span><span class="p">,</span>
	<span class="p">};</span>

	<span class="n">nfs_fattr_init</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">fattr</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">nfs4_call_sync</span><span class="p">(</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">client</span><span class="p">,</span> <span class="n">server</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">msg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">args</span><span class="p">.</span><span class="n">seq_args</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">res</span><span class="p">.</span><span class="n">seq_res</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">nfs4_lookup_root</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs_server</span> <span class="o">*</span><span class="n">server</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nfs_fh</span> <span class="o">*</span><span class="n">fhandle</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">nfs_fsinfo</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfs4_exception</span> <span class="n">exception</span> <span class="o">=</span> <span class="p">{</span> <span class="p">};</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">_nfs4_lookup_root</span><span class="p">(</span><span class="n">server</span><span class="p">,</span> <span class="n">fhandle</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">0</span>:
		<span class="k">case</span> <span class="o">-</span><span class="n">NFS4ERR_WRONGSEC</span>:
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">nfs4_handle_exception</span><span class="p">(</span><span class="n">server</span><span class="p">,</span> <span class="n">err</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">exception</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">exception</span><span class="p">.</span><span class="n">retry</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">nfs4_lookup_root_sec</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs_server</span> <span class="o">*</span><span class="n">server</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nfs_fh</span> <span class="o">*</span><span class="n">fhandle</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">nfs_fsinfo</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="n">rpc_authflavor_t</span> <span class="n">flavor</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rpc_auth</span> <span class="o">*</span><span class="n">auth</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">auth</span> <span class="o">=</span> <span class="n">rpcauth_create</span><span class="p">(</span><span class="n">flavor</span><span class="p">,</span> <span class="n">server</span><span class="o">-&gt;</span><span class="n">client</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">auth</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">nfs4_lookup_root</span><span class="p">(</span><span class="n">server</span><span class="p">,</span> <span class="n">fhandle</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">nfs4_find_root_sec</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs_server</span> <span class="o">*</span><span class="n">server</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nfs_fh</span> <span class="o">*</span><span class="n">fhandle</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">nfs_fsinfo</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">rpc_authflavor_t</span> <span class="n">flav_array</span><span class="p">[</span><span class="n">NFS_MAX_SECFLAVORS</span><span class="p">];</span>

	<span class="n">len</span> <span class="o">=</span> <span class="n">gss_mech_list_pseudoflavors</span><span class="p">(</span><span class="o">&amp;</span><span class="n">flav_array</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="n">flav_array</span><span class="p">[</span><span class="n">len</span><span class="p">]</span> <span class="o">=</span> <span class="n">RPC_AUTH_NULL</span><span class="p">;</span>
	<span class="n">len</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">len</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">nfs4_lookup_root_sec</span><span class="p">(</span><span class="n">server</span><span class="p">,</span> <span class="n">fhandle</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="n">flav_array</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="o">-</span><span class="n">NFS4ERR_WRONGSEC</span> <span class="o">||</span> <span class="n">status</span> <span class="o">==</span> <span class="o">-</span><span class="n">EACCES</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/*</span>
<span class="cm">	 * -EACCESS could mean that the user doesn&#39;t have correct permissions</span>
<span class="cm">	 * to access the mount.  It could also mean that we tried to mount</span>
<span class="cm">	 * with a gss auth flavor, but rpc.gssd isn&#39;t running.  Either way,</span>
<span class="cm">	 * existing mount programs don&#39;t handle -EACCES very well so it should</span>
<span class="cm">	 * be mapped to -EPERM instead.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="o">-</span><span class="n">EACCES</span><span class="p">)</span>
		<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * get the file handle for the &quot;/&quot; directory on the server</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">nfs4_proc_get_rootfh</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs_server</span> <span class="o">*</span><span class="n">server</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nfs_fh</span> <span class="o">*</span><span class="n">fhandle</span><span class="p">,</span>
			 <span class="k">struct</span> <span class="n">nfs_fsinfo</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">minor_version</span> <span class="o">=</span> <span class="n">server</span><span class="o">-&gt;</span><span class="n">nfs_client</span><span class="o">-&gt;</span><span class="n">cl_minorversion</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="n">nfs4_lookup_root</span><span class="p">(</span><span class="n">server</span><span class="p">,</span> <span class="n">fhandle</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">status</span> <span class="o">==</span> <span class="o">-</span><span class="n">NFS4ERR_WRONGSEC</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">NFS_MOUNT_SECFLAVOUR</span><span class="p">))</span>
		<span class="cm">/*</span>
<span class="cm">		 * A status of -NFS4ERR_WRONGSEC will be mapped to -EPERM</span>
<span class="cm">		 * by nfs4_map_errors() as this function exits.</span>
<span class="cm">		 */</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">nfs_v4_minor_ops</span><span class="p">[</span><span class="n">minor_version</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">find_root_sec</span><span class="p">(</span><span class="n">server</span><span class="p">,</span> <span class="n">fhandle</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">nfs4_server_capabilities</span><span class="p">(</span><span class="n">server</span><span class="p">,</span> <span class="n">fhandle</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">nfs4_do_fsinfo</span><span class="p">(</span><span class="n">server</span><span class="p">,</span> <span class="n">fhandle</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">nfs4_map_errors</span><span class="p">(</span><span class="n">status</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">nfs4_proc_get_root</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs_server</span> <span class="o">*</span><span class="n">server</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nfs_fh</span> <span class="o">*</span><span class="n">mntfh</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">nfs_fsinfo</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">error</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nfs_fattr</span> <span class="o">*</span><span class="n">fattr</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">fattr</span><span class="p">;</span>

	<span class="n">error</span> <span class="o">=</span> <span class="n">nfs4_server_capabilities</span><span class="p">(</span><span class="n">server</span><span class="p">,</span> <span class="n">mntfh</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;nfs4_get_root: getcaps error = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="o">-</span><span class="n">error</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">error</span> <span class="o">=</span> <span class="n">nfs4_proc_getattr</span><span class="p">(</span><span class="n">server</span><span class="p">,</span> <span class="n">mntfh</span><span class="p">,</span> <span class="n">fattr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;nfs4_get_root: getattr error = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="o">-</span><span class="n">error</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fattr</span><span class="o">-&gt;</span><span class="n">valid</span> <span class="o">&amp;</span> <span class="n">NFS_ATTR_FATTR_FSID</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="n">nfs_fsid_equal</span><span class="p">(</span><span class="o">&amp;</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">fsid</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fattr</span><span class="o">-&gt;</span><span class="n">fsid</span><span class="p">))</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">fsid</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fattr</span><span class="o">-&gt;</span><span class="n">fsid</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">fsid</span><span class="p">));</span>

	<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Get locations and (maybe) other attributes of a referral.</span>
<span class="cm"> * Note that we&#39;ll actually follow the referral later when</span>
<span class="cm"> * we detect fsid mismatch in inode revalidation</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">nfs4_get_referral</span><span class="p">(</span><span class="k">struct</span> <span class="n">rpc_clnt</span> <span class="o">*</span><span class="n">client</span><span class="p">,</span> <span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">dir</span><span class="p">,</span>
			     <span class="k">const</span> <span class="k">struct</span> <span class="n">qstr</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nfs_fattr</span> <span class="o">*</span><span class="n">fattr</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">nfs_fh</span> <span class="o">*</span><span class="n">fhandle</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="n">page</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nfs4_fs_locations</span> <span class="o">*</span><span class="n">locations</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">page</span> <span class="o">=</span> <span class="n">alloc_page</span><span class="p">(</span><span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">page</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="n">locations</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs4_fs_locations</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">locations</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">nfs4_proc_fs_locations</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">dir</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">locations</span><span class="p">,</span> <span class="n">page</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="cm">/* Make sure server returned a different fsid for the referral */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nfs_fsid_equal</span><span class="p">(</span><span class="o">&amp;</span><span class="n">NFS_SERVER</span><span class="p">(</span><span class="n">dir</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">fsid</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">locations</span><span class="o">-&gt;</span><span class="n">fattr</span><span class="p">.</span><span class="n">fsid</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s: server did not return a different fsid for&quot;</span>
			<span class="s">&quot; a referral at %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">name</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* Fixup attributes for the nfs_lookup() call to nfs_fhget() */</span>
	<span class="n">nfs_fixup_referral_attributes</span><span class="p">(</span><span class="o">&amp;</span><span class="n">locations</span><span class="o">-&gt;</span><span class="n">fattr</span><span class="p">);</span>

	<span class="cm">/* replace the lookup nfs_fattr with the locations nfs_fattr */</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">fattr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">locations</span><span class="o">-&gt;</span><span class="n">fattr</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs_fattr</span><span class="p">));</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">fhandle</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs_fh</span><span class="p">));</span>
<span class="nl">out:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">page</span><span class="p">)</span>
		<span class="n">__free_page</span><span class="p">(</span><span class="n">page</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">locations</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">_nfs4_proc_getattr</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs_server</span> <span class="o">*</span><span class="n">server</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nfs_fh</span> <span class="o">*</span><span class="n">fhandle</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nfs_fattr</span> <span class="o">*</span><span class="n">fattr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfs4_getattr_arg</span> <span class="n">args</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">fh</span> <span class="o">=</span> <span class="n">fhandle</span><span class="p">,</span>
		<span class="p">.</span><span class="n">bitmask</span> <span class="o">=</span> <span class="n">server</span><span class="o">-&gt;</span><span class="n">attr_bitmask</span><span class="p">,</span>
	<span class="p">};</span>
	<span class="k">struct</span> <span class="n">nfs4_getattr_res</span> <span class="n">res</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">fattr</span> <span class="o">=</span> <span class="n">fattr</span><span class="p">,</span>
		<span class="p">.</span><span class="n">server</span> <span class="o">=</span> <span class="n">server</span><span class="p">,</span>
	<span class="p">};</span>
	<span class="k">struct</span> <span class="n">rpc_message</span> <span class="n">msg</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">rpc_proc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">nfs4_procedures</span><span class="p">[</span><span class="n">NFSPROC4_CLNT_GETATTR</span><span class="p">],</span>
		<span class="p">.</span><span class="n">rpc_argp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">args</span><span class="p">,</span>
		<span class="p">.</span><span class="n">rpc_resp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">res</span><span class="p">,</span>
	<span class="p">};</span>
	
	<span class="n">nfs_fattr_init</span><span class="p">(</span><span class="n">fattr</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">nfs4_call_sync</span><span class="p">(</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">client</span><span class="p">,</span> <span class="n">server</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">msg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">args</span><span class="p">.</span><span class="n">seq_args</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">res</span><span class="p">.</span><span class="n">seq_res</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">nfs4_proc_getattr</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs_server</span> <span class="o">*</span><span class="n">server</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nfs_fh</span> <span class="o">*</span><span class="n">fhandle</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nfs_fattr</span> <span class="o">*</span><span class="n">fattr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfs4_exception</span> <span class="n">exception</span> <span class="o">=</span> <span class="p">{</span> <span class="p">};</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">nfs4_handle_exception</span><span class="p">(</span><span class="n">server</span><span class="p">,</span>
				<span class="n">_nfs4_proc_getattr</span><span class="p">(</span><span class="n">server</span><span class="p">,</span> <span class="n">fhandle</span><span class="p">,</span> <span class="n">fattr</span><span class="p">),</span>
				<span class="o">&amp;</span><span class="n">exception</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">exception</span><span class="p">.</span><span class="n">retry</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* </span>
<span class="cm"> * The file is not closed if it is opened due to the a request to change</span>
<span class="cm"> * the size of the file. The open call will not be needed once the</span>
<span class="cm"> * VFS layer lookup-intents are implemented.</span>
<span class="cm"> *</span>
<span class="cm"> * Close is called when the inode is destroyed.</span>
<span class="cm"> * If we haven&#39;t opened the file for O_WRONLY, we</span>
<span class="cm"> * need to in the size_change case to obtain a stateid.</span>
<span class="cm"> *</span>
<span class="cm"> * Got race?</span>
<span class="cm"> * Because OPEN is always done by name in nfsv4, it is</span>
<span class="cm"> * possible that we opened a different file by the same</span>
<span class="cm"> * name.  We can recognize this race condition, but we</span>
<span class="cm"> * can&#39;t do anything about it besides returning an error.</span>
<span class="cm"> *</span>
<span class="cm"> * This will be fixed with VFS changes (lookup-intent).</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">nfs4_proc_setattr</span><span class="p">(</span><span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="n">dentry</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nfs_fattr</span> <span class="o">*</span><span class="n">fattr</span><span class="p">,</span>
		  <span class="k">struct</span> <span class="n">iattr</span> <span class="o">*</span><span class="n">sattr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span> <span class="o">=</span> <span class="n">dentry</span><span class="o">-&gt;</span><span class="n">d_inode</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rpc_cred</span> <span class="o">*</span><span class="n">cred</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nfs4_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pnfs_ld_layoutret_on_setattr</span><span class="p">(</span><span class="n">inode</span><span class="p">))</span>
		<span class="n">pnfs_return_layout</span><span class="p">(</span><span class="n">inode</span><span class="p">);</span>

	<span class="n">nfs_fattr_init</span><span class="p">(</span><span class="n">fattr</span><span class="p">);</span>
	
	<span class="cm">/* Deal with open(O_TRUNC) */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sattr</span><span class="o">-&gt;</span><span class="n">ia_valid</span> <span class="o">&amp;</span> <span class="n">ATTR_OPEN</span><span class="p">)</span>
		<span class="n">sattr</span><span class="o">-&gt;</span><span class="n">ia_valid</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">ATTR_MTIME</span><span class="o">|</span><span class="n">ATTR_CTIME</span><span class="o">|</span><span class="n">ATTR_OPEN</span><span class="p">);</span>

	<span class="cm">/* Optimization: if the end result is no change, don&#39;t RPC */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">sattr</span><span class="o">-&gt;</span><span class="n">ia_valid</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">ATTR_FILE</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Search for an existing open(O_WRITE) file */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sattr</span><span class="o">-&gt;</span><span class="n">ia_valid</span> <span class="o">&amp;</span> <span class="n">ATTR_FILE</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">nfs_open_context</span> <span class="o">*</span><span class="n">ctx</span><span class="p">;</span>

		<span class="n">ctx</span> <span class="o">=</span> <span class="n">nfs_file_open_context</span><span class="p">(</span><span class="n">sattr</span><span class="o">-&gt;</span><span class="n">ia_file</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ctx</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">cred</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">cred</span><span class="p">;</span>
			<span class="n">state</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">nfs4_do_setattr</span><span class="p">(</span><span class="n">inode</span><span class="p">,</span> <span class="n">cred</span><span class="p">,</span> <span class="n">fattr</span><span class="p">,</span> <span class="n">sattr</span><span class="p">,</span> <span class="n">state</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">nfs_setattr_update_inode</span><span class="p">(</span><span class="n">inode</span><span class="p">,</span> <span class="n">sattr</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">_nfs4_proc_lookup</span><span class="p">(</span><span class="k">struct</span> <span class="n">rpc_clnt</span> <span class="o">*</span><span class="n">clnt</span><span class="p">,</span> <span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">dir</span><span class="p">,</span>
		<span class="k">const</span> <span class="k">struct</span> <span class="n">qstr</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nfs_fh</span> <span class="o">*</span><span class="n">fhandle</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">nfs_fattr</span> <span class="o">*</span><span class="n">fattr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfs_server</span> <span class="o">*</span><span class="n">server</span> <span class="o">=</span> <span class="n">NFS_SERVER</span><span class="p">(</span><span class="n">dir</span><span class="p">);</span>
	<span class="kt">int</span>		       <span class="n">status</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nfs4_lookup_arg</span> <span class="n">args</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">bitmask</span> <span class="o">=</span> <span class="n">server</span><span class="o">-&gt;</span><span class="n">attr_bitmask</span><span class="p">,</span>
		<span class="p">.</span><span class="n">dir_fh</span> <span class="o">=</span> <span class="n">NFS_FH</span><span class="p">(</span><span class="n">dir</span><span class="p">),</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span><span class="p">,</span>
	<span class="p">};</span>
	<span class="k">struct</span> <span class="n">nfs4_lookup_res</span> <span class="n">res</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">server</span> <span class="o">=</span> <span class="n">server</span><span class="p">,</span>
		<span class="p">.</span><span class="n">fattr</span> <span class="o">=</span> <span class="n">fattr</span><span class="p">,</span>
		<span class="p">.</span><span class="n">fh</span> <span class="o">=</span> <span class="n">fhandle</span><span class="p">,</span>
	<span class="p">};</span>
	<span class="k">struct</span> <span class="n">rpc_message</span> <span class="n">msg</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">rpc_proc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">nfs4_procedures</span><span class="p">[</span><span class="n">NFSPROC4_CLNT_LOOKUP</span><span class="p">],</span>
		<span class="p">.</span><span class="n">rpc_argp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">args</span><span class="p">,</span>
		<span class="p">.</span><span class="n">rpc_resp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">res</span><span class="p">,</span>
	<span class="p">};</span>

	<span class="n">nfs_fattr_init</span><span class="p">(</span><span class="n">fattr</span><span class="p">);</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;NFS call  lookup %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">name</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">nfs4_call_sync</span><span class="p">(</span><span class="n">clnt</span><span class="p">,</span> <span class="n">server</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">msg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">args</span><span class="p">.</span><span class="n">seq_args</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">res</span><span class="p">.</span><span class="n">seq_res</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;NFS reply lookup: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">nfs_fixup_secinfo_attributes</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs_fattr</span> <span class="o">*</span><span class="n">fattr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">fattr</span><span class="o">-&gt;</span><span class="n">valid</span> <span class="o">|=</span> <span class="n">NFS_ATTR_FATTR_TYPE</span> <span class="o">|</span> <span class="n">NFS_ATTR_FATTR_MODE</span> <span class="o">|</span>
		<span class="n">NFS_ATTR_FATTR_NLINK</span> <span class="o">|</span> <span class="n">NFS_ATTR_FATTR_MOUNTPOINT</span><span class="p">;</span>
	<span class="n">fattr</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">=</span> <span class="n">S_IFDIR</span> <span class="o">|</span> <span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IXUGO</span><span class="p">;</span>
	<span class="n">fattr</span><span class="o">-&gt;</span><span class="n">nlink</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">nfs4_proc_lookup_common</span><span class="p">(</span><span class="k">struct</span> <span class="n">rpc_clnt</span> <span class="o">**</span><span class="n">clnt</span><span class="p">,</span> <span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">dir</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">qstr</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nfs_fh</span> <span class="o">*</span><span class="n">fhandle</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">nfs_fattr</span> <span class="o">*</span><span class="n">fattr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfs4_exception</span> <span class="n">exception</span> <span class="o">=</span> <span class="p">{</span> <span class="p">};</span>
	<span class="k">struct</span> <span class="n">rpc_clnt</span> <span class="o">*</span><span class="n">client</span> <span class="o">=</span> <span class="o">*</span><span class="n">clnt</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">_nfs4_proc_lookup</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">dir</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">fhandle</span><span class="p">,</span> <span class="n">fattr</span><span class="p">);</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="o">-</span><span class="n">NFS4ERR_BADNAME</span>:
			<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="k">case</span> <span class="o">-</span><span class="n">NFS4ERR_MOVED</span>:
			<span class="n">err</span> <span class="o">=</span> <span class="n">nfs4_get_referral</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">dir</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">fattr</span><span class="p">,</span> <span class="n">fhandle</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="k">case</span> <span class="o">-</span><span class="n">NFS4ERR_WRONGSEC</span>:
			<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">client</span> <span class="o">!=</span> <span class="o">*</span><span class="n">clnt</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

			<span class="n">client</span> <span class="o">=</span> <span class="n">nfs4_create_sec_client</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">dir</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">client</span><span class="p">))</span>
				<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>

			<span class="n">exception</span><span class="p">.</span><span class="n">retry</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">nfs4_handle_exception</span><span class="p">(</span><span class="n">NFS_SERVER</span><span class="p">(</span><span class="n">dir</span><span class="p">),</span> <span class="n">err</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">exception</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">exception</span><span class="p">.</span><span class="n">retry</span><span class="p">);</span>

<span class="nl">out:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="o">*</span><span class="n">clnt</span> <span class="o">=</span> <span class="n">client</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">client</span> <span class="o">!=</span> <span class="o">*</span><span class="n">clnt</span><span class="p">)</span>
		<span class="n">rpc_shutdown_client</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">nfs4_proc_lookup</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">dir</span><span class="p">,</span> <span class="k">struct</span> <span class="n">qstr</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">nfs_fh</span> <span class="o">*</span><span class="n">fhandle</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nfs_fattr</span> <span class="o">*</span><span class="n">fattr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rpc_clnt</span> <span class="o">*</span><span class="n">client</span> <span class="o">=</span> <span class="n">NFS_CLIENT</span><span class="p">(</span><span class="n">dir</span><span class="p">);</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">nfs4_proc_lookup_common</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="p">,</span> <span class="n">dir</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">fhandle</span><span class="p">,</span> <span class="n">fattr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">client</span> <span class="o">!=</span> <span class="n">NFS_CLIENT</span><span class="p">(</span><span class="n">dir</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">rpc_shutdown_client</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>
		<span class="n">nfs_fixup_secinfo_attributes</span><span class="p">(</span><span class="n">fattr</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">rpc_clnt</span> <span class="o">*</span>
<span class="nf">nfs4_proc_lookup_mountpoint</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">dir</span><span class="p">,</span> <span class="k">struct</span> <span class="n">qstr</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">nfs_fh</span> <span class="o">*</span><span class="n">fhandle</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nfs_fattr</span> <span class="o">*</span><span class="n">fattr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rpc_clnt</span> <span class="o">*</span><span class="n">client</span> <span class="o">=</span> <span class="n">rpc_clone_client</span><span class="p">(</span><span class="n">NFS_CLIENT</span><span class="p">(</span><span class="n">dir</span><span class="p">));</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">nfs4_proc_lookup_common</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="p">,</span> <span class="n">dir</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">fhandle</span><span class="p">,</span> <span class="n">fattr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rpc_shutdown_client</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="n">status</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">client</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">_nfs4_proc_access</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nfs_access_entry</span> <span class="o">*</span><span class="n">entry</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfs_server</span> <span class="o">*</span><span class="n">server</span> <span class="o">=</span> <span class="n">NFS_SERVER</span><span class="p">(</span><span class="n">inode</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">nfs4_accessargs</span> <span class="n">args</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">fh</span> <span class="o">=</span> <span class="n">NFS_FH</span><span class="p">(</span><span class="n">inode</span><span class="p">),</span>
		<span class="p">.</span><span class="n">bitmask</span> <span class="o">=</span> <span class="n">server</span><span class="o">-&gt;</span><span class="n">cache_consistency_bitmask</span><span class="p">,</span>
	<span class="p">};</span>
	<span class="k">struct</span> <span class="n">nfs4_accessres</span> <span class="n">res</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">server</span> <span class="o">=</span> <span class="n">server</span><span class="p">,</span>
	<span class="p">};</span>
	<span class="k">struct</span> <span class="n">rpc_message</span> <span class="n">msg</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">rpc_proc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">nfs4_procedures</span><span class="p">[</span><span class="n">NFSPROC4_CLNT_ACCESS</span><span class="p">],</span>
		<span class="p">.</span><span class="n">rpc_argp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">args</span><span class="p">,</span>
		<span class="p">.</span><span class="n">rpc_resp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">res</span><span class="p">,</span>
		<span class="p">.</span><span class="n">rpc_cred</span> <span class="o">=</span> <span class="n">entry</span><span class="o">-&gt;</span><span class="n">cred</span><span class="p">,</span>
	<span class="p">};</span>
	<span class="kt">int</span> <span class="n">mode</span> <span class="o">=</span> <span class="n">entry</span><span class="o">-&gt;</span><span class="n">mask</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Determine which access bits we want to ask for...</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mode</span> <span class="o">&amp;</span> <span class="n">MAY_READ</span><span class="p">)</span>
		<span class="n">args</span><span class="p">.</span><span class="n">access</span> <span class="o">|=</span> <span class="n">NFS4_ACCESS_READ</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">S_ISDIR</span><span class="p">(</span><span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_mode</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mode</span> <span class="o">&amp;</span> <span class="n">MAY_WRITE</span><span class="p">)</span>
			<span class="n">args</span><span class="p">.</span><span class="n">access</span> <span class="o">|=</span> <span class="n">NFS4_ACCESS_MODIFY</span> <span class="o">|</span> <span class="n">NFS4_ACCESS_EXTEND</span> <span class="o">|</span> <span class="n">NFS4_ACCESS_DELETE</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mode</span> <span class="o">&amp;</span> <span class="n">MAY_EXEC</span><span class="p">)</span>
			<span class="n">args</span><span class="p">.</span><span class="n">access</span> <span class="o">|=</span> <span class="n">NFS4_ACCESS_LOOKUP</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mode</span> <span class="o">&amp;</span> <span class="n">MAY_WRITE</span><span class="p">)</span>
			<span class="n">args</span><span class="p">.</span><span class="n">access</span> <span class="o">|=</span> <span class="n">NFS4_ACCESS_MODIFY</span> <span class="o">|</span> <span class="n">NFS4_ACCESS_EXTEND</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mode</span> <span class="o">&amp;</span> <span class="n">MAY_EXEC</span><span class="p">)</span>
			<span class="n">args</span><span class="p">.</span><span class="n">access</span> <span class="o">|=</span> <span class="n">NFS4_ACCESS_EXECUTE</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">res</span><span class="p">.</span><span class="n">fattr</span> <span class="o">=</span> <span class="n">nfs_alloc_fattr</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="p">.</span><span class="n">fattr</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">nfs4_call_sync</span><span class="p">(</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">client</span><span class="p">,</span> <span class="n">server</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">msg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">args</span><span class="p">.</span><span class="n">seq_args</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">res</span><span class="p">.</span><span class="n">seq_res</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">entry</span><span class="o">-&gt;</span><span class="n">mask</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="p">.</span><span class="n">access</span> <span class="o">&amp;</span> <span class="n">NFS4_ACCESS_READ</span><span class="p">)</span>
			<span class="n">entry</span><span class="o">-&gt;</span><span class="n">mask</span> <span class="o">|=</span> <span class="n">MAY_READ</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="p">.</span><span class="n">access</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">NFS4_ACCESS_MODIFY</span> <span class="o">|</span> <span class="n">NFS4_ACCESS_EXTEND</span> <span class="o">|</span> <span class="n">NFS4_ACCESS_DELETE</span><span class="p">))</span>
			<span class="n">entry</span><span class="o">-&gt;</span><span class="n">mask</span> <span class="o">|=</span> <span class="n">MAY_WRITE</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="p">.</span><span class="n">access</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">NFS4_ACCESS_LOOKUP</span><span class="o">|</span><span class="n">NFS4_ACCESS_EXECUTE</span><span class="p">))</span>
			<span class="n">entry</span><span class="o">-&gt;</span><span class="n">mask</span> <span class="o">|=</span> <span class="n">MAY_EXEC</span><span class="p">;</span>
		<span class="n">nfs_refresh_inode</span><span class="p">(</span><span class="n">inode</span><span class="p">,</span> <span class="n">res</span><span class="p">.</span><span class="n">fattr</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">nfs_free_fattr</span><span class="p">(</span><span class="n">res</span><span class="p">.</span><span class="n">fattr</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">nfs4_proc_access</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nfs_access_entry</span> <span class="o">*</span><span class="n">entry</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfs4_exception</span> <span class="n">exception</span> <span class="o">=</span> <span class="p">{</span> <span class="p">};</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">nfs4_handle_exception</span><span class="p">(</span><span class="n">NFS_SERVER</span><span class="p">(</span><span class="n">inode</span><span class="p">),</span>
				<span class="n">_nfs4_proc_access</span><span class="p">(</span><span class="n">inode</span><span class="p">,</span> <span class="n">entry</span><span class="p">),</span>
				<span class="o">&amp;</span><span class="n">exception</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">exception</span><span class="p">.</span><span class="n">retry</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * TODO: For the time being, we don&#39;t try to get any attributes</span>
<span class="cm"> * along with any of the zero-copy operations READ, READDIR,</span>
<span class="cm"> * READLINK, WRITE.</span>
<span class="cm"> *</span>
<span class="cm"> * In the case of the first three, we want to put the GETATTR</span>
<span class="cm"> * after the read-type operation -- this is because it is hard</span>
<span class="cm"> * to predict the length of a GETATTR response in v4, and thus</span>
<span class="cm"> * align the READ data correctly.  This means that the GETATTR</span>
<span class="cm"> * may end up partially falling into the page cache, and we should</span>
<span class="cm"> * shift it into the &#39;tail&#39; of the xdr_buf before processing.</span>
<span class="cm"> * To do this efficiently, we need to know the total length</span>
<span class="cm"> * of data received, which doesn&#39;t seem to be available outside</span>
<span class="cm"> * of the RPC layer.</span>
<span class="cm"> *</span>
<span class="cm"> * In the case of WRITE, we also want to put the GETATTR after</span>
<span class="cm"> * the operation -- in this case because we want to make sure</span>
<span class="cm"> * we get the post-operation mtime and size.  This means that</span>
<span class="cm"> * we can&#39;t use xdr_encode_pages() as written: we need a variant</span>
<span class="cm"> * of it which would leave room in the &#39;tail&#39; iovec.</span>
<span class="cm"> *</span>
<span class="cm"> * Both of these changes to the XDR layer would in fact be quite</span>
<span class="cm"> * minor, but I decided to leave them for a subsequent patch.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">_nfs4_proc_readlink</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="n">page</span><span class="p">,</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">pgbase</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">pglen</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfs4_readlink</span> <span class="n">args</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">fh</span>       <span class="o">=</span> <span class="n">NFS_FH</span><span class="p">(</span><span class="n">inode</span><span class="p">),</span>
		<span class="p">.</span><span class="n">pgbase</span>	  <span class="o">=</span> <span class="n">pgbase</span><span class="p">,</span>
		<span class="p">.</span><span class="n">pglen</span>    <span class="o">=</span> <span class="n">pglen</span><span class="p">,</span>
		<span class="p">.</span><span class="n">pages</span>    <span class="o">=</span> <span class="o">&amp;</span><span class="n">page</span><span class="p">,</span>
	<span class="p">};</span>
	<span class="k">struct</span> <span class="n">nfs4_readlink_res</span> <span class="n">res</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rpc_message</span> <span class="n">msg</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">rpc_proc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">nfs4_procedures</span><span class="p">[</span><span class="n">NFSPROC4_CLNT_READLINK</span><span class="p">],</span>
		<span class="p">.</span><span class="n">rpc_argp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">args</span><span class="p">,</span>
		<span class="p">.</span><span class="n">rpc_resp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">res</span><span class="p">,</span>
	<span class="p">};</span>

	<span class="k">return</span> <span class="n">nfs4_call_sync</span><span class="p">(</span><span class="n">NFS_SERVER</span><span class="p">(</span><span class="n">inode</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">client</span><span class="p">,</span> <span class="n">NFS_SERVER</span><span class="p">(</span><span class="n">inode</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">msg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">args</span><span class="p">.</span><span class="n">seq_args</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">res</span><span class="p">.</span><span class="n">seq_res</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">nfs4_proc_readlink</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="n">page</span><span class="p">,</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">pgbase</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">pglen</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfs4_exception</span> <span class="n">exception</span> <span class="o">=</span> <span class="p">{</span> <span class="p">};</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">nfs4_handle_exception</span><span class="p">(</span><span class="n">NFS_SERVER</span><span class="p">(</span><span class="n">inode</span><span class="p">),</span>
				<span class="n">_nfs4_proc_readlink</span><span class="p">(</span><span class="n">inode</span><span class="p">,</span> <span class="n">page</span><span class="p">,</span> <span class="n">pgbase</span><span class="p">,</span> <span class="n">pglen</span><span class="p">),</span>
				<span class="o">&amp;</span><span class="n">exception</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">exception</span><span class="p">.</span><span class="n">retry</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Got race?</span>
<span class="cm"> * We will need to arrange for the VFS layer to provide an atomic open.</span>
<span class="cm"> * Until then, this create/open method is prone to inefficiency and race</span>
<span class="cm"> * conditions due to the lookup, create, and open VFS calls from sys_open()</span>
<span class="cm"> * placed on the wire.</span>
<span class="cm"> *</span>
<span class="cm"> * Given the above sorry state of affairs, I&#39;m simply sending an OPEN.</span>
<span class="cm"> * The file will be opened again in the subsequent VFS open call</span>
<span class="cm"> * (nfs4_proc_file_open).</span>
<span class="cm"> *</span>
<span class="cm"> * The open for read will just hang around to be used by any process that</span>
<span class="cm"> * opens the file O_RDONLY. This will all be resolved with the VFS changes.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">nfs4_proc_create</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">dir</span><span class="p">,</span> <span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="n">dentry</span><span class="p">,</span> <span class="k">struct</span> <span class="n">iattr</span> <span class="o">*</span><span class="n">sattr</span><span class="p">,</span>
                 <span class="kt">int</span> <span class="n">flags</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nfs_open_context</span> <span class="o">*</span><span class="n">ctx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="n">de</span> <span class="o">=</span> <span class="n">dentry</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nfs4_state</span> <span class="o">*</span><span class="n">state</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rpc_cred</span> <span class="o">*</span><span class="n">cred</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">fmode_t</span> <span class="n">fmode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ctx</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cred</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">cred</span><span class="p">;</span>
		<span class="n">de</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">dentry</span><span class="p">;</span>
		<span class="n">fmode</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">mode</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">sattr</span><span class="o">-&gt;</span><span class="n">ia_mode</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">current_umask</span><span class="p">();</span>
	<span class="n">state</span> <span class="o">=</span> <span class="n">nfs4_do_open</span><span class="p">(</span><span class="n">dir</span><span class="p">,</span> <span class="n">de</span><span class="p">,</span> <span class="n">fmode</span><span class="p">,</span> <span class="n">flags</span><span class="p">,</span> <span class="n">sattr</span><span class="p">,</span> <span class="n">cred</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">d_drop</span><span class="p">(</span><span class="n">dentry</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">state</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">state</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">d_add</span><span class="p">(</span><span class="n">dentry</span><span class="p">,</span> <span class="n">igrab</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">inode</span><span class="p">));</span>
	<span class="n">nfs_set_verifier</span><span class="p">(</span><span class="n">dentry</span><span class="p">,</span> <span class="n">nfs_save_change_attribute</span><span class="p">(</span><span class="n">dir</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ctx</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">state</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">nfs4_close_sync</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">fmode</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">_nfs4_proc_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">dir</span><span class="p">,</span> <span class="k">struct</span> <span class="n">qstr</span> <span class="o">*</span><span class="n">name</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfs_server</span> <span class="o">*</span><span class="n">server</span> <span class="o">=</span> <span class="n">NFS_SERVER</span><span class="p">(</span><span class="n">dir</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">nfs_removeargs</span> <span class="n">args</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">fh</span> <span class="o">=</span> <span class="n">NFS_FH</span><span class="p">(</span><span class="n">dir</span><span class="p">),</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span>
	<span class="p">};</span>
	<span class="k">struct</span> <span class="n">nfs_removeres</span> <span class="n">res</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">server</span> <span class="o">=</span> <span class="n">server</span><span class="p">,</span>
	<span class="p">};</span>
	<span class="k">struct</span> <span class="n">rpc_message</span> <span class="n">msg</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">rpc_proc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">nfs4_procedures</span><span class="p">[</span><span class="n">NFSPROC4_CLNT_REMOVE</span><span class="p">],</span>
		<span class="p">.</span><span class="n">rpc_argp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">args</span><span class="p">,</span>
		<span class="p">.</span><span class="n">rpc_resp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">res</span><span class="p">,</span>
	<span class="p">};</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">nfs4_call_sync</span><span class="p">(</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">client</span><span class="p">,</span> <span class="n">server</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">msg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">args</span><span class="p">.</span><span class="n">seq_args</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">res</span><span class="p">.</span><span class="n">seq_res</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">update_changeattr</span><span class="p">(</span><span class="n">dir</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">res</span><span class="p">.</span><span class="n">cinfo</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">nfs4_proc_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">dir</span><span class="p">,</span> <span class="k">struct</span> <span class="n">qstr</span> <span class="o">*</span><span class="n">name</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfs4_exception</span> <span class="n">exception</span> <span class="o">=</span> <span class="p">{</span> <span class="p">};</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">nfs4_handle_exception</span><span class="p">(</span><span class="n">NFS_SERVER</span><span class="p">(</span><span class="n">dir</span><span class="p">),</span>
				<span class="n">_nfs4_proc_remove</span><span class="p">(</span><span class="n">dir</span><span class="p">,</span> <span class="n">name</span><span class="p">),</span>
				<span class="o">&amp;</span><span class="n">exception</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">exception</span><span class="p">.</span><span class="n">retry</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">nfs4_proc_unlink_setup</span><span class="p">(</span><span class="k">struct</span> <span class="n">rpc_message</span> <span class="o">*</span><span class="n">msg</span><span class="p">,</span> <span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">dir</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfs_server</span> <span class="o">*</span><span class="n">server</span> <span class="o">=</span> <span class="n">NFS_SERVER</span><span class="p">(</span><span class="n">dir</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">nfs_removeargs</span> <span class="o">*</span><span class="n">args</span> <span class="o">=</span> <span class="n">msg</span><span class="o">-&gt;</span><span class="n">rpc_argp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nfs_removeres</span> <span class="o">*</span><span class="n">res</span> <span class="o">=</span> <span class="n">msg</span><span class="o">-&gt;</span><span class="n">rpc_resp</span><span class="p">;</span>

	<span class="n">res</span><span class="o">-&gt;</span><span class="n">server</span> <span class="o">=</span> <span class="n">server</span><span class="p">;</span>
	<span class="n">msg</span><span class="o">-&gt;</span><span class="n">rpc_proc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">nfs4_procedures</span><span class="p">[</span><span class="n">NFSPROC4_CLNT_REMOVE</span><span class="p">];</span>
	<span class="n">nfs41_init_sequence</span><span class="p">(</span><span class="o">&amp;</span><span class="n">args</span><span class="o">-&gt;</span><span class="n">seq_args</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">seq_res</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">nfs4_proc_unlink_rpc_prepare</span><span class="p">(</span><span class="k">struct</span> <span class="n">rpc_task</span> <span class="o">*</span><span class="n">task</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nfs_unlinkdata</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nfs4_setup_sequence</span><span class="p">(</span><span class="n">NFS_SERVER</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">dir</span><span class="p">),</span>
				<span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">args</span><span class="p">.</span><span class="n">seq_args</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">res</span><span class="p">.</span><span class="n">seq_res</span><span class="p">,</span>
				<span class="n">task</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">rpc_call_start</span><span class="p">(</span><span class="n">task</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">nfs4_proc_unlink_done</span><span class="p">(</span><span class="k">struct</span> <span class="n">rpc_task</span> <span class="o">*</span><span class="n">task</span><span class="p">,</span> <span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">dir</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfs_removeres</span> <span class="o">*</span><span class="n">res</span> <span class="o">=</span> <span class="n">task</span><span class="o">-&gt;</span><span class="n">tk_msg</span><span class="p">.</span><span class="n">rpc_resp</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">nfs4_sequence_done</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">seq_res</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nfs4_async_handle_error</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="n">res</span><span class="o">-&gt;</span><span class="n">server</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">update_changeattr</span><span class="p">(</span><span class="n">dir</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">cinfo</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">nfs4_proc_rename_setup</span><span class="p">(</span><span class="k">struct</span> <span class="n">rpc_message</span> <span class="o">*</span><span class="n">msg</span><span class="p">,</span> <span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">dir</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfs_server</span> <span class="o">*</span><span class="n">server</span> <span class="o">=</span> <span class="n">NFS_SERVER</span><span class="p">(</span><span class="n">dir</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">nfs_renameargs</span> <span class="o">*</span><span class="n">arg</span> <span class="o">=</span> <span class="n">msg</span><span class="o">-&gt;</span><span class="n">rpc_argp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nfs_renameres</span> <span class="o">*</span><span class="n">res</span> <span class="o">=</span> <span class="n">msg</span><span class="o">-&gt;</span><span class="n">rpc_resp</span><span class="p">;</span>

	<span class="n">msg</span><span class="o">-&gt;</span><span class="n">rpc_proc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">nfs4_procedures</span><span class="p">[</span><span class="n">NFSPROC4_CLNT_RENAME</span><span class="p">];</span>
	<span class="n">res</span><span class="o">-&gt;</span><span class="n">server</span> <span class="o">=</span> <span class="n">server</span><span class="p">;</span>
	<span class="n">nfs41_init_sequence</span><span class="p">(</span><span class="o">&amp;</span><span class="n">arg</span><span class="o">-&gt;</span><span class="n">seq_args</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">seq_res</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">nfs4_proc_rename_rpc_prepare</span><span class="p">(</span><span class="k">struct</span> <span class="n">rpc_task</span> <span class="o">*</span><span class="n">task</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nfs_renamedata</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nfs4_setup_sequence</span><span class="p">(</span><span class="n">NFS_SERVER</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">old_dir</span><span class="p">),</span>
				<span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">args</span><span class="p">.</span><span class="n">seq_args</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">res</span><span class="p">.</span><span class="n">seq_res</span><span class="p">,</span>
				<span class="n">task</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">rpc_call_start</span><span class="p">(</span><span class="n">task</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">nfs4_proc_rename_done</span><span class="p">(</span><span class="k">struct</span> <span class="n">rpc_task</span> <span class="o">*</span><span class="n">task</span><span class="p">,</span> <span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">old_dir</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">new_dir</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfs_renameres</span> <span class="o">*</span><span class="n">res</span> <span class="o">=</span> <span class="n">task</span><span class="o">-&gt;</span><span class="n">tk_msg</span><span class="p">.</span><span class="n">rpc_resp</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">nfs4_sequence_done</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">seq_res</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nfs4_async_handle_error</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="n">res</span><span class="o">-&gt;</span><span class="n">server</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">update_changeattr</span><span class="p">(</span><span class="n">old_dir</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">old_cinfo</span><span class="p">);</span>
	<span class="n">update_changeattr</span><span class="p">(</span><span class="n">new_dir</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">new_cinfo</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">_nfs4_proc_rename</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">old_dir</span><span class="p">,</span> <span class="k">struct</span> <span class="n">qstr</span> <span class="o">*</span><span class="n">old_name</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">new_dir</span><span class="p">,</span> <span class="k">struct</span> <span class="n">qstr</span> <span class="o">*</span><span class="n">new_name</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfs_server</span> <span class="o">*</span><span class="n">server</span> <span class="o">=</span> <span class="n">NFS_SERVER</span><span class="p">(</span><span class="n">old_dir</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">nfs_renameargs</span> <span class="n">arg</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">old_dir</span> <span class="o">=</span> <span class="n">NFS_FH</span><span class="p">(</span><span class="n">old_dir</span><span class="p">),</span>
		<span class="p">.</span><span class="n">new_dir</span> <span class="o">=</span> <span class="n">NFS_FH</span><span class="p">(</span><span class="n">new_dir</span><span class="p">),</span>
		<span class="p">.</span><span class="n">old_name</span> <span class="o">=</span> <span class="n">old_name</span><span class="p">,</span>
		<span class="p">.</span><span class="n">new_name</span> <span class="o">=</span> <span class="n">new_name</span><span class="p">,</span>
	<span class="p">};</span>
	<span class="k">struct</span> <span class="n">nfs_renameres</span> <span class="n">res</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">server</span> <span class="o">=</span> <span class="n">server</span><span class="p">,</span>
	<span class="p">};</span>
	<span class="k">struct</span> <span class="n">rpc_message</span> <span class="n">msg</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">rpc_proc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">nfs4_procedures</span><span class="p">[</span><span class="n">NFSPROC4_CLNT_RENAME</span><span class="p">],</span>
		<span class="p">.</span><span class="n">rpc_argp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">arg</span><span class="p">,</span>
		<span class="p">.</span><span class="n">rpc_resp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">res</span><span class="p">,</span>
	<span class="p">};</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	
	<span class="n">status</span> <span class="o">=</span> <span class="n">nfs4_call_sync</span><span class="p">(</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">client</span><span class="p">,</span> <span class="n">server</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">msg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">arg</span><span class="p">.</span><span class="n">seq_args</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">res</span><span class="p">.</span><span class="n">seq_res</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">update_changeattr</span><span class="p">(</span><span class="n">old_dir</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">res</span><span class="p">.</span><span class="n">old_cinfo</span><span class="p">);</span>
		<span class="n">update_changeattr</span><span class="p">(</span><span class="n">new_dir</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">res</span><span class="p">.</span><span class="n">new_cinfo</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">nfs4_proc_rename</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">old_dir</span><span class="p">,</span> <span class="k">struct</span> <span class="n">qstr</span> <span class="o">*</span><span class="n">old_name</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">new_dir</span><span class="p">,</span> <span class="k">struct</span> <span class="n">qstr</span> <span class="o">*</span><span class="n">new_name</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfs4_exception</span> <span class="n">exception</span> <span class="o">=</span> <span class="p">{</span> <span class="p">};</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">nfs4_handle_exception</span><span class="p">(</span><span class="n">NFS_SERVER</span><span class="p">(</span><span class="n">old_dir</span><span class="p">),</span>
				<span class="n">_nfs4_proc_rename</span><span class="p">(</span><span class="n">old_dir</span><span class="p">,</span> <span class="n">old_name</span><span class="p">,</span>
					<span class="n">new_dir</span><span class="p">,</span> <span class="n">new_name</span><span class="p">),</span>
				<span class="o">&amp;</span><span class="n">exception</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">exception</span><span class="p">.</span><span class="n">retry</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">_nfs4_proc_link</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">dir</span><span class="p">,</span> <span class="k">struct</span> <span class="n">qstr</span> <span class="o">*</span><span class="n">name</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfs_server</span> <span class="o">*</span><span class="n">server</span> <span class="o">=</span> <span class="n">NFS_SERVER</span><span class="p">(</span><span class="n">inode</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">nfs4_link_arg</span> <span class="n">arg</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">fh</span>     <span class="o">=</span> <span class="n">NFS_FH</span><span class="p">(</span><span class="n">inode</span><span class="p">),</span>
		<span class="p">.</span><span class="n">dir_fh</span> <span class="o">=</span> <span class="n">NFS_FH</span><span class="p">(</span><span class="n">dir</span><span class="p">),</span>
		<span class="p">.</span><span class="n">name</span>   <span class="o">=</span> <span class="n">name</span><span class="p">,</span>
		<span class="p">.</span><span class="n">bitmask</span> <span class="o">=</span> <span class="n">server</span><span class="o">-&gt;</span><span class="n">attr_bitmask</span><span class="p">,</span>
	<span class="p">};</span>
	<span class="k">struct</span> <span class="n">nfs4_link_res</span> <span class="n">res</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">server</span> <span class="o">=</span> <span class="n">server</span><span class="p">,</span>
	<span class="p">};</span>
	<span class="k">struct</span> <span class="n">rpc_message</span> <span class="n">msg</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">rpc_proc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">nfs4_procedures</span><span class="p">[</span><span class="n">NFSPROC4_CLNT_LINK</span><span class="p">],</span>
		<span class="p">.</span><span class="n">rpc_argp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">arg</span><span class="p">,</span>
		<span class="p">.</span><span class="n">rpc_resp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">res</span><span class="p">,</span>
	<span class="p">};</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">res</span><span class="p">.</span><span class="n">fattr</span> <span class="o">=</span> <span class="n">nfs_alloc_fattr</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="p">.</span><span class="n">fattr</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">nfs4_call_sync</span><span class="p">(</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">client</span><span class="p">,</span> <span class="n">server</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">msg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">arg</span><span class="p">.</span><span class="n">seq_args</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">res</span><span class="p">.</span><span class="n">seq_res</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">update_changeattr</span><span class="p">(</span><span class="n">dir</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">res</span><span class="p">.</span><span class="n">cinfo</span><span class="p">);</span>
		<span class="n">nfs_post_op_update_inode</span><span class="p">(</span><span class="n">inode</span><span class="p">,</span> <span class="n">res</span><span class="p">.</span><span class="n">fattr</span><span class="p">);</span>
	<span class="p">}</span>
<span class="nl">out:</span>
	<span class="n">nfs_free_fattr</span><span class="p">(</span><span class="n">res</span><span class="p">.</span><span class="n">fattr</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">nfs4_proc_link</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">dir</span><span class="p">,</span> <span class="k">struct</span> <span class="n">qstr</span> <span class="o">*</span><span class="n">name</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfs4_exception</span> <span class="n">exception</span> <span class="o">=</span> <span class="p">{</span> <span class="p">};</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">nfs4_handle_exception</span><span class="p">(</span><span class="n">NFS_SERVER</span><span class="p">(</span><span class="n">inode</span><span class="p">),</span>
				<span class="n">_nfs4_proc_link</span><span class="p">(</span><span class="n">inode</span><span class="p">,</span> <span class="n">dir</span><span class="p">,</span> <span class="n">name</span><span class="p">),</span>
				<span class="o">&amp;</span><span class="n">exception</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">exception</span><span class="p">.</span><span class="n">retry</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">nfs4_createdata</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">rpc_message</span> <span class="n">msg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nfs4_create_arg</span> <span class="n">arg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nfs4_create_res</span> <span class="n">res</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nfs_fh</span> <span class="n">fh</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nfs_fattr</span> <span class="n">fattr</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">nfs4_createdata</span> <span class="o">*</span><span class="nf">nfs4_alloc_createdata</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">dir</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">qstr</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span> <span class="k">struct</span> <span class="n">iattr</span> <span class="o">*</span><span class="n">sattr</span><span class="p">,</span> <span class="n">u32</span> <span class="n">ftype</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfs4_createdata</span> <span class="o">*</span><span class="n">data</span><span class="p">;</span>

	<span class="n">data</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">data</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">data</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">nfs_server</span> <span class="o">*</span><span class="n">server</span> <span class="o">=</span> <span class="n">NFS_SERVER</span><span class="p">(</span><span class="n">dir</span><span class="p">);</span>

		<span class="n">data</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">.</span><span class="n">rpc_proc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">nfs4_procedures</span><span class="p">[</span><span class="n">NFSPROC4_CLNT_CREATE</span><span class="p">];</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">.</span><span class="n">rpc_argp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">arg</span><span class="p">;</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">.</span><span class="n">rpc_resp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">res</span><span class="p">;</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">arg</span><span class="p">.</span><span class="n">dir_fh</span> <span class="o">=</span> <span class="n">NFS_FH</span><span class="p">(</span><span class="n">dir</span><span class="p">);</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">arg</span><span class="p">.</span><span class="n">server</span> <span class="o">=</span> <span class="n">server</span><span class="p">;</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">arg</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span><span class="p">;</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">arg</span><span class="p">.</span><span class="n">attrs</span> <span class="o">=</span> <span class="n">sattr</span><span class="p">;</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">arg</span><span class="p">.</span><span class="n">ftype</span> <span class="o">=</span> <span class="n">ftype</span><span class="p">;</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">arg</span><span class="p">.</span><span class="n">bitmask</span> <span class="o">=</span> <span class="n">server</span><span class="o">-&gt;</span><span class="n">attr_bitmask</span><span class="p">;</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">res</span><span class="p">.</span><span class="n">server</span> <span class="o">=</span> <span class="n">server</span><span class="p">;</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">res</span><span class="p">.</span><span class="n">fh</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">fh</span><span class="p">;</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">res</span><span class="p">.</span><span class="n">fattr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">fattr</span><span class="p">;</span>
		<span class="n">nfs_fattr_init</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">res</span><span class="p">.</span><span class="n">fattr</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">data</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">nfs4_do_create</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">dir</span><span class="p">,</span> <span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="n">dentry</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nfs4_createdata</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="n">nfs4_call_sync</span><span class="p">(</span><span class="n">NFS_SERVER</span><span class="p">(</span><span class="n">dir</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">client</span><span class="p">,</span> <span class="n">NFS_SERVER</span><span class="p">(</span><span class="n">dir</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">,</span>
				    <span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">arg</span><span class="p">.</span><span class="n">seq_args</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">res</span><span class="p">.</span><span class="n">seq_res</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">update_changeattr</span><span class="p">(</span><span class="n">dir</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">res</span><span class="p">.</span><span class="n">dir_cinfo</span><span class="p">);</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">nfs_instantiate</span><span class="p">(</span><span class="n">dentry</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">res</span><span class="p">.</span><span class="n">fh</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">res</span><span class="p">.</span><span class="n">fattr</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">nfs4_free_createdata</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs4_createdata</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">_nfs4_proc_symlink</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">dir</span><span class="p">,</span> <span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="n">dentry</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="n">page</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">len</span><span class="p">,</span> <span class="k">struct</span> <span class="n">iattr</span> <span class="o">*</span><span class="n">sattr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfs4_createdata</span> <span class="o">*</span><span class="n">data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENAMETOOLONG</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;</span> <span class="n">NFS4_MAXPATHLEN</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">data</span> <span class="o">=</span> <span class="n">nfs4_alloc_createdata</span><span class="p">(</span><span class="n">dir</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dentry</span><span class="o">-&gt;</span><span class="n">d_name</span><span class="p">,</span> <span class="n">sattr</span><span class="p">,</span> <span class="n">NF4LNK</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">data</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">data</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">.</span><span class="n">rpc_proc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">nfs4_procedures</span><span class="p">[</span><span class="n">NFSPROC4_CLNT_SYMLINK</span><span class="p">];</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">arg</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">symlink</span><span class="p">.</span><span class="n">pages</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">page</span><span class="p">;</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">arg</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">symlink</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>
	
	<span class="n">status</span> <span class="o">=</span> <span class="n">nfs4_do_create</span><span class="p">(</span><span class="n">dir</span><span class="p">,</span> <span class="n">dentry</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>

	<span class="n">nfs4_free_createdata</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">nfs4_proc_symlink</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">dir</span><span class="p">,</span> <span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="n">dentry</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="n">page</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">len</span><span class="p">,</span> <span class="k">struct</span> <span class="n">iattr</span> <span class="o">*</span><span class="n">sattr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfs4_exception</span> <span class="n">exception</span> <span class="o">=</span> <span class="p">{</span> <span class="p">};</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">nfs4_handle_exception</span><span class="p">(</span><span class="n">NFS_SERVER</span><span class="p">(</span><span class="n">dir</span><span class="p">),</span>
				<span class="n">_nfs4_proc_symlink</span><span class="p">(</span><span class="n">dir</span><span class="p">,</span> <span class="n">dentry</span><span class="p">,</span> <span class="n">page</span><span class="p">,</span>
							<span class="n">len</span><span class="p">,</span> <span class="n">sattr</span><span class="p">),</span>
				<span class="o">&amp;</span><span class="n">exception</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">exception</span><span class="p">.</span><span class="n">retry</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">_nfs4_proc_mkdir</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">dir</span><span class="p">,</span> <span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="n">dentry</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">iattr</span> <span class="o">*</span><span class="n">sattr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfs4_createdata</span> <span class="o">*</span><span class="n">data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">data</span> <span class="o">=</span> <span class="n">nfs4_alloc_createdata</span><span class="p">(</span><span class="n">dir</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dentry</span><span class="o">-&gt;</span><span class="n">d_name</span><span class="p">,</span> <span class="n">sattr</span><span class="p">,</span> <span class="n">NF4DIR</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">data</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">nfs4_do_create</span><span class="p">(</span><span class="n">dir</span><span class="p">,</span> <span class="n">dentry</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>

	<span class="n">nfs4_free_createdata</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">nfs4_proc_mkdir</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">dir</span><span class="p">,</span> <span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="n">dentry</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">iattr</span> <span class="o">*</span><span class="n">sattr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfs4_exception</span> <span class="n">exception</span> <span class="o">=</span> <span class="p">{</span> <span class="p">};</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">sattr</span><span class="o">-&gt;</span><span class="n">ia_mode</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">current_umask</span><span class="p">();</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">nfs4_handle_exception</span><span class="p">(</span><span class="n">NFS_SERVER</span><span class="p">(</span><span class="n">dir</span><span class="p">),</span>
				<span class="n">_nfs4_proc_mkdir</span><span class="p">(</span><span class="n">dir</span><span class="p">,</span> <span class="n">dentry</span><span class="p">,</span> <span class="n">sattr</span><span class="p">),</span>
				<span class="o">&amp;</span><span class="n">exception</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">exception</span><span class="p">.</span><span class="n">retry</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">_nfs4_proc_readdir</span><span class="p">(</span><span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="n">dentry</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rpc_cred</span> <span class="o">*</span><span class="n">cred</span><span class="p">,</span>
		<span class="n">u64</span> <span class="n">cookie</span><span class="p">,</span> <span class="k">struct</span> <span class="n">page</span> <span class="o">**</span><span class="n">pages</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">count</span><span class="p">,</span> <span class="kt">int</span> <span class="n">plus</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">inode</span>		<span class="o">*</span><span class="n">dir</span> <span class="o">=</span> <span class="n">dentry</span><span class="o">-&gt;</span><span class="n">d_inode</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nfs4_readdir_arg</span> <span class="n">args</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">fh</span> <span class="o">=</span> <span class="n">NFS_FH</span><span class="p">(</span><span class="n">dir</span><span class="p">),</span>
		<span class="p">.</span><span class="n">pages</span> <span class="o">=</span> <span class="n">pages</span><span class="p">,</span>
		<span class="p">.</span><span class="n">pgbase</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">count</span> <span class="o">=</span> <span class="n">count</span><span class="p">,</span>
		<span class="p">.</span><span class="n">bitmask</span> <span class="o">=</span> <span class="n">NFS_SERVER</span><span class="p">(</span><span class="n">dentry</span><span class="o">-&gt;</span><span class="n">d_inode</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">attr_bitmask</span><span class="p">,</span>
		<span class="p">.</span><span class="n">plus</span> <span class="o">=</span> <span class="n">plus</span><span class="p">,</span>
	<span class="p">};</span>
	<span class="k">struct</span> <span class="n">nfs4_readdir_res</span> <span class="n">res</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rpc_message</span> <span class="n">msg</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">rpc_proc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">nfs4_procedures</span><span class="p">[</span><span class="n">NFSPROC4_CLNT_READDIR</span><span class="p">],</span>
		<span class="p">.</span><span class="n">rpc_argp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">args</span><span class="p">,</span>
		<span class="p">.</span><span class="n">rpc_resp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">res</span><span class="p">,</span>
		<span class="p">.</span><span class="n">rpc_cred</span> <span class="o">=</span> <span class="n">cred</span><span class="p">,</span>
	<span class="p">};</span>
	<span class="kt">int</span>			<span class="n">status</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s: dentry = %s/%s, cookie = %Lu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
			<span class="n">dentry</span><span class="o">-&gt;</span><span class="n">d_parent</span><span class="o">-&gt;</span><span class="n">d_name</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
			<span class="n">dentry</span><span class="o">-&gt;</span><span class="n">d_name</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
			<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">cookie</span><span class="p">);</span>
	<span class="n">nfs4_setup_readdir</span><span class="p">(</span><span class="n">cookie</span><span class="p">,</span> <span class="n">NFS_COOKIEVERF</span><span class="p">(</span><span class="n">dir</span><span class="p">),</span> <span class="n">dentry</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">args</span><span class="p">);</span>
	<span class="n">res</span><span class="p">.</span><span class="n">pgbase</span> <span class="o">=</span> <span class="n">args</span><span class="p">.</span><span class="n">pgbase</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">nfs4_call_sync</span><span class="p">(</span><span class="n">NFS_SERVER</span><span class="p">(</span><span class="n">dir</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">client</span><span class="p">,</span> <span class="n">NFS_SERVER</span><span class="p">(</span><span class="n">dir</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">msg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">args</span><span class="p">.</span><span class="n">seq_args</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">res</span><span class="p">.</span><span class="n">seq_res</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">NFS_COOKIEVERF</span><span class="p">(</span><span class="n">dir</span><span class="p">),</span> <span class="n">res</span><span class="p">.</span><span class="n">verifier</span><span class="p">.</span><span class="n">data</span><span class="p">,</span> <span class="n">NFS4_VERIFIER_SIZE</span><span class="p">);</span>
		<span class="n">status</span> <span class="o">+=</span> <span class="n">args</span><span class="p">.</span><span class="n">pgbase</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">nfs_invalidate_atime</span><span class="p">(</span><span class="n">dir</span><span class="p">);</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s: returns %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">nfs4_proc_readdir</span><span class="p">(</span><span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="n">dentry</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rpc_cred</span> <span class="o">*</span><span class="n">cred</span><span class="p">,</span>
		<span class="n">u64</span> <span class="n">cookie</span><span class="p">,</span> <span class="k">struct</span> <span class="n">page</span> <span class="o">**</span><span class="n">pages</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">count</span><span class="p">,</span> <span class="kt">int</span> <span class="n">plus</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfs4_exception</span> <span class="n">exception</span> <span class="o">=</span> <span class="p">{</span> <span class="p">};</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">nfs4_handle_exception</span><span class="p">(</span><span class="n">NFS_SERVER</span><span class="p">(</span><span class="n">dentry</span><span class="o">-&gt;</span><span class="n">d_inode</span><span class="p">),</span>
				<span class="n">_nfs4_proc_readdir</span><span class="p">(</span><span class="n">dentry</span><span class="p">,</span> <span class="n">cred</span><span class="p">,</span> <span class="n">cookie</span><span class="p">,</span>
					<span class="n">pages</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">plus</span><span class="p">),</span>
				<span class="o">&amp;</span><span class="n">exception</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">exception</span><span class="p">.</span><span class="n">retry</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">_nfs4_proc_mknod</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">dir</span><span class="p">,</span> <span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="n">dentry</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">iattr</span> <span class="o">*</span><span class="n">sattr</span><span class="p">,</span> <span class="n">dev_t</span> <span class="n">rdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfs4_createdata</span> <span class="o">*</span><span class="n">data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">mode</span> <span class="o">=</span> <span class="n">sattr</span><span class="o">-&gt;</span><span class="n">ia_mode</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">sattr</span><span class="o">-&gt;</span><span class="n">ia_valid</span> <span class="o">&amp;</span> <span class="n">ATTR_MODE</span><span class="p">));</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">S_ISFIFO</span><span class="p">(</span><span class="n">mode</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">S_ISBLK</span><span class="p">(</span><span class="n">mode</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">S_ISCHR</span><span class="p">(</span><span class="n">mode</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">S_ISSOCK</span><span class="p">(</span><span class="n">mode</span><span class="p">));</span>

	<span class="n">data</span> <span class="o">=</span> <span class="n">nfs4_alloc_createdata</span><span class="p">(</span><span class="n">dir</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dentry</span><span class="o">-&gt;</span><span class="n">d_name</span><span class="p">,</span> <span class="n">sattr</span><span class="p">,</span> <span class="n">NF4SOCK</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">data</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">S_ISFIFO</span><span class="p">(</span><span class="n">mode</span><span class="p">))</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">arg</span><span class="p">.</span><span class="n">ftype</span> <span class="o">=</span> <span class="n">NF4FIFO</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">S_ISBLK</span><span class="p">(</span><span class="n">mode</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">arg</span><span class="p">.</span><span class="n">ftype</span> <span class="o">=</span> <span class="n">NF4BLK</span><span class="p">;</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">arg</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">device</span><span class="p">.</span><span class="n">specdata1</span> <span class="o">=</span> <span class="n">MAJOR</span><span class="p">(</span><span class="n">rdev</span><span class="p">);</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">arg</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">device</span><span class="p">.</span><span class="n">specdata2</span> <span class="o">=</span> <span class="n">MINOR</span><span class="p">(</span><span class="n">rdev</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">S_ISCHR</span><span class="p">(</span><span class="n">mode</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">arg</span><span class="p">.</span><span class="n">ftype</span> <span class="o">=</span> <span class="n">NF4CHR</span><span class="p">;</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">arg</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">device</span><span class="p">.</span><span class="n">specdata1</span> <span class="o">=</span> <span class="n">MAJOR</span><span class="p">(</span><span class="n">rdev</span><span class="p">);</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">arg</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">device</span><span class="p">.</span><span class="n">specdata2</span> <span class="o">=</span> <span class="n">MINOR</span><span class="p">(</span><span class="n">rdev</span><span class="p">);</span>
	<span class="p">}</span>
	
	<span class="n">status</span> <span class="o">=</span> <span class="n">nfs4_do_create</span><span class="p">(</span><span class="n">dir</span><span class="p">,</span> <span class="n">dentry</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>

	<span class="n">nfs4_free_createdata</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">nfs4_proc_mknod</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">dir</span><span class="p">,</span> <span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="n">dentry</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">iattr</span> <span class="o">*</span><span class="n">sattr</span><span class="p">,</span> <span class="n">dev_t</span> <span class="n">rdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfs4_exception</span> <span class="n">exception</span> <span class="o">=</span> <span class="p">{</span> <span class="p">};</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">sattr</span><span class="o">-&gt;</span><span class="n">ia_mode</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">current_umask</span><span class="p">();</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">nfs4_handle_exception</span><span class="p">(</span><span class="n">NFS_SERVER</span><span class="p">(</span><span class="n">dir</span><span class="p">),</span>
				<span class="n">_nfs4_proc_mknod</span><span class="p">(</span><span class="n">dir</span><span class="p">,</span> <span class="n">dentry</span><span class="p">,</span> <span class="n">sattr</span><span class="p">,</span> <span class="n">rdev</span><span class="p">),</span>
				<span class="o">&amp;</span><span class="n">exception</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">exception</span><span class="p">.</span><span class="n">retry</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">_nfs4_proc_statfs</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs_server</span> <span class="o">*</span><span class="n">server</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nfs_fh</span> <span class="o">*</span><span class="n">fhandle</span><span class="p">,</span>
		 <span class="k">struct</span> <span class="n">nfs_fsstat</span> <span class="o">*</span><span class="n">fsstat</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfs4_statfs_arg</span> <span class="n">args</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">fh</span> <span class="o">=</span> <span class="n">fhandle</span><span class="p">,</span>
		<span class="p">.</span><span class="n">bitmask</span> <span class="o">=</span> <span class="n">server</span><span class="o">-&gt;</span><span class="n">attr_bitmask</span><span class="p">,</span>
	<span class="p">};</span>
	<span class="k">struct</span> <span class="n">nfs4_statfs_res</span> <span class="n">res</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">fsstat</span> <span class="o">=</span> <span class="n">fsstat</span><span class="p">,</span>
	<span class="p">};</span>
	<span class="k">struct</span> <span class="n">rpc_message</span> <span class="n">msg</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">rpc_proc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">nfs4_procedures</span><span class="p">[</span><span class="n">NFSPROC4_CLNT_STATFS</span><span class="p">],</span>
		<span class="p">.</span><span class="n">rpc_argp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">args</span><span class="p">,</span>
		<span class="p">.</span><span class="n">rpc_resp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">res</span><span class="p">,</span>
	<span class="p">};</span>

	<span class="n">nfs_fattr_init</span><span class="p">(</span><span class="n">fsstat</span><span class="o">-&gt;</span><span class="n">fattr</span><span class="p">);</span>
	<span class="k">return</span>  <span class="n">nfs4_call_sync</span><span class="p">(</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">client</span><span class="p">,</span> <span class="n">server</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">msg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">args</span><span class="p">.</span><span class="n">seq_args</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">res</span><span class="p">.</span><span class="n">seq_res</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">nfs4_proc_statfs</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs_server</span> <span class="o">*</span><span class="n">server</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nfs_fh</span> <span class="o">*</span><span class="n">fhandle</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nfs_fsstat</span> <span class="o">*</span><span class="n">fsstat</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfs4_exception</span> <span class="n">exception</span> <span class="o">=</span> <span class="p">{</span> <span class="p">};</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">nfs4_handle_exception</span><span class="p">(</span><span class="n">server</span><span class="p">,</span>
				<span class="n">_nfs4_proc_statfs</span><span class="p">(</span><span class="n">server</span><span class="p">,</span> <span class="n">fhandle</span><span class="p">,</span> <span class="n">fsstat</span><span class="p">),</span>
				<span class="o">&amp;</span><span class="n">exception</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">exception</span><span class="p">.</span><span class="n">retry</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">_nfs4_do_fsinfo</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs_server</span> <span class="o">*</span><span class="n">server</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nfs_fh</span> <span class="o">*</span><span class="n">fhandle</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">nfs_fsinfo</span> <span class="o">*</span><span class="n">fsinfo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfs4_fsinfo_arg</span> <span class="n">args</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">fh</span> <span class="o">=</span> <span class="n">fhandle</span><span class="p">,</span>
		<span class="p">.</span><span class="n">bitmask</span> <span class="o">=</span> <span class="n">server</span><span class="o">-&gt;</span><span class="n">attr_bitmask</span><span class="p">,</span>
	<span class="p">};</span>
	<span class="k">struct</span> <span class="n">nfs4_fsinfo_res</span> <span class="n">res</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">fsinfo</span> <span class="o">=</span> <span class="n">fsinfo</span><span class="p">,</span>
	<span class="p">};</span>
	<span class="k">struct</span> <span class="n">rpc_message</span> <span class="n">msg</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">rpc_proc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">nfs4_procedures</span><span class="p">[</span><span class="n">NFSPROC4_CLNT_FSINFO</span><span class="p">],</span>
		<span class="p">.</span><span class="n">rpc_argp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">args</span><span class="p">,</span>
		<span class="p">.</span><span class="n">rpc_resp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">res</span><span class="p">,</span>
	<span class="p">};</span>

	<span class="k">return</span> <span class="n">nfs4_call_sync</span><span class="p">(</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">client</span><span class="p">,</span> <span class="n">server</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">msg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">args</span><span class="p">.</span><span class="n">seq_args</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">res</span><span class="p">.</span><span class="n">seq_res</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">nfs4_do_fsinfo</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs_server</span> <span class="o">*</span><span class="n">server</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nfs_fh</span> <span class="o">*</span><span class="n">fhandle</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nfs_fsinfo</span> <span class="o">*</span><span class="n">fsinfo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfs4_exception</span> <span class="n">exception</span> <span class="o">=</span> <span class="p">{</span> <span class="p">};</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">nfs4_handle_exception</span><span class="p">(</span><span class="n">server</span><span class="p">,</span>
				<span class="n">_nfs4_do_fsinfo</span><span class="p">(</span><span class="n">server</span><span class="p">,</span> <span class="n">fhandle</span><span class="p">,</span> <span class="n">fsinfo</span><span class="p">),</span>
				<span class="o">&amp;</span><span class="n">exception</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">exception</span><span class="p">.</span><span class="n">retry</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">nfs4_proc_fsinfo</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs_server</span> <span class="o">*</span><span class="n">server</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nfs_fh</span> <span class="o">*</span><span class="n">fhandle</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nfs_fsinfo</span> <span class="o">*</span><span class="n">fsinfo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">nfs_fattr_init</span><span class="p">(</span><span class="n">fsinfo</span><span class="o">-&gt;</span><span class="n">fattr</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">nfs4_do_fsinfo</span><span class="p">(</span><span class="n">server</span><span class="p">,</span> <span class="n">fhandle</span><span class="p">,</span> <span class="n">fsinfo</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">_nfs4_proc_pathconf</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs_server</span> <span class="o">*</span><span class="n">server</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nfs_fh</span> <span class="o">*</span><span class="n">fhandle</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">nfs_pathconf</span> <span class="o">*</span><span class="n">pathconf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfs4_pathconf_arg</span> <span class="n">args</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">fh</span> <span class="o">=</span> <span class="n">fhandle</span><span class="p">,</span>
		<span class="p">.</span><span class="n">bitmask</span> <span class="o">=</span> <span class="n">server</span><span class="o">-&gt;</span><span class="n">attr_bitmask</span><span class="p">,</span>
	<span class="p">};</span>
	<span class="k">struct</span> <span class="n">nfs4_pathconf_res</span> <span class="n">res</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">pathconf</span> <span class="o">=</span> <span class="n">pathconf</span><span class="p">,</span>
	<span class="p">};</span>
	<span class="k">struct</span> <span class="n">rpc_message</span> <span class="n">msg</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">rpc_proc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">nfs4_procedures</span><span class="p">[</span><span class="n">NFSPROC4_CLNT_PATHCONF</span><span class="p">],</span>
		<span class="p">.</span><span class="n">rpc_argp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">args</span><span class="p">,</span>
		<span class="p">.</span><span class="n">rpc_resp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">res</span><span class="p">,</span>
	<span class="p">};</span>

	<span class="cm">/* None of the pathconf attributes are mandatory to implement */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">args</span><span class="p">.</span><span class="n">bitmask</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">nfs4_pathconf_bitmap</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">pathconf</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">pathconf</span><span class="p">));</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">nfs_fattr_init</span><span class="p">(</span><span class="n">pathconf</span><span class="o">-&gt;</span><span class="n">fattr</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">nfs4_call_sync</span><span class="p">(</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">client</span><span class="p">,</span> <span class="n">server</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">msg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">args</span><span class="p">.</span><span class="n">seq_args</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">res</span><span class="p">.</span><span class="n">seq_res</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">nfs4_proc_pathconf</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs_server</span> <span class="o">*</span><span class="n">server</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nfs_fh</span> <span class="o">*</span><span class="n">fhandle</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">nfs_pathconf</span> <span class="o">*</span><span class="n">pathconf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfs4_exception</span> <span class="n">exception</span> <span class="o">=</span> <span class="p">{</span> <span class="p">};</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">nfs4_handle_exception</span><span class="p">(</span><span class="n">server</span><span class="p">,</span>
				<span class="n">_nfs4_proc_pathconf</span><span class="p">(</span><span class="n">server</span><span class="p">,</span> <span class="n">fhandle</span><span class="p">,</span> <span class="n">pathconf</span><span class="p">),</span>
				<span class="o">&amp;</span><span class="n">exception</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">exception</span><span class="p">.</span><span class="n">retry</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">__nfs4_read_done_cb</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs_read_data</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">nfs_invalidate_atime</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">header</span><span class="o">-&gt;</span><span class="n">inode</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">nfs4_read_done_cb</span><span class="p">(</span><span class="k">struct</span> <span class="n">rpc_task</span> <span class="o">*</span><span class="n">task</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nfs_read_data</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfs_server</span> <span class="o">*</span><span class="n">server</span> <span class="o">=</span> <span class="n">NFS_SERVER</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">header</span><span class="o">-&gt;</span><span class="n">inode</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nfs4_async_handle_error</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="n">server</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">args</span><span class="p">.</span><span class="n">context</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rpc_restart_call_prepare</span><span class="p">(</span><span class="n">task</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">__nfs4_read_done_cb</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">task</span><span class="o">-&gt;</span><span class="n">tk_status</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">renew_lease</span><span class="p">(</span><span class="n">server</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">timestamp</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">nfs4_read_done</span><span class="p">(</span><span class="k">struct</span> <span class="n">rpc_task</span> <span class="o">*</span><span class="n">task</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nfs_read_data</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;--&gt; %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">nfs4_sequence_done</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">res</span><span class="p">.</span><span class="n">seq_res</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">read_done_cb</span> <span class="o">?</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">read_done_cb</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span> <span class="o">:</span>
				    <span class="n">nfs4_read_done_cb</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">nfs4_proc_read_setup</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs_read_data</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rpc_message</span> <span class="o">*</span><span class="n">msg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">timestamp</span>   <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">read_done_cb</span> <span class="o">=</span> <span class="n">nfs4_read_done_cb</span><span class="p">;</span>
	<span class="n">msg</span><span class="o">-&gt;</span><span class="n">rpc_proc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">nfs4_procedures</span><span class="p">[</span><span class="n">NFSPROC4_CLNT_READ</span><span class="p">];</span>
	<span class="n">nfs41_init_sequence</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">args</span><span class="p">.</span><span class="n">seq_args</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">res</span><span class="p">.</span><span class="n">seq_res</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">nfs4_proc_read_rpc_prepare</span><span class="p">(</span><span class="k">struct</span> <span class="n">rpc_task</span> <span class="o">*</span><span class="n">task</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nfs_read_data</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nfs4_setup_sequence</span><span class="p">(</span><span class="n">NFS_SERVER</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">header</span><span class="o">-&gt;</span><span class="n">inode</span><span class="p">),</span>
				<span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">args</span><span class="p">.</span><span class="n">seq_args</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">res</span><span class="p">.</span><span class="n">seq_res</span><span class="p">,</span>
				<span class="n">task</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">rpc_call_start</span><span class="p">(</span><span class="n">task</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">nfs4_write_done_cb</span><span class="p">(</span><span class="k">struct</span> <span class="n">rpc_task</span> <span class="o">*</span><span class="n">task</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nfs_write_data</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">header</span><span class="o">-&gt;</span><span class="n">inode</span><span class="p">;</span>
	
	<span class="k">if</span> <span class="p">(</span><span class="n">nfs4_async_handle_error</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="n">NFS_SERVER</span><span class="p">(</span><span class="n">inode</span><span class="p">),</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">args</span><span class="p">.</span><span class="n">context</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rpc_restart_call_prepare</span><span class="p">(</span><span class="n">task</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">task</span><span class="o">-&gt;</span><span class="n">tk_status</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">renew_lease</span><span class="p">(</span><span class="n">NFS_SERVER</span><span class="p">(</span><span class="n">inode</span><span class="p">),</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">timestamp</span><span class="p">);</span>
		<span class="n">nfs_post_op_update_inode_force_wcc</span><span class="p">(</span><span class="n">inode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">fattr</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">nfs4_write_done</span><span class="p">(</span><span class="k">struct</span> <span class="n">rpc_task</span> <span class="o">*</span><span class="n">task</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nfs_write_data</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">nfs4_sequence_done</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">res</span><span class="p">.</span><span class="n">seq_res</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">write_done_cb</span> <span class="o">?</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">write_done_cb</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span> <span class="o">:</span>
		<span class="n">nfs4_write_done_cb</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span>
<span class="n">bool</span> <span class="nf">nfs4_write_need_cache_consistency_data</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">nfs_write_data</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">nfs_pgio_header</span> <span class="o">*</span><span class="n">hdr</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">;</span>

	<span class="cm">/* Don&#39;t request attributes for pNFS or O_DIRECT writes */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">ds_clp</span> <span class="o">!=</span> <span class="nb">NULL</span> <span class="o">||</span> <span class="n">hdr</span><span class="o">-&gt;</span><span class="n">dreq</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
	<span class="cm">/* Otherwise, request attributes if and only if we don&#39;t hold</span>
<span class="cm">	 * a delegation</span>
<span class="cm">	 */</span>
	<span class="k">return</span> <span class="n">nfs_have_delegation</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">inode</span><span class="p">,</span> <span class="n">FMODE_READ</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">nfs4_proc_write_setup</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs_write_data</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rpc_message</span> <span class="o">*</span><span class="n">msg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfs_server</span> <span class="o">*</span><span class="n">server</span> <span class="o">=</span> <span class="n">NFS_SERVER</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">header</span><span class="o">-&gt;</span><span class="n">inode</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">nfs4_write_need_cache_consistency_data</span><span class="p">(</span><span class="n">data</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">args</span><span class="p">.</span><span class="n">bitmask</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">res</span><span class="p">.</span><span class="n">fattr</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">args</span><span class="p">.</span><span class="n">bitmask</span> <span class="o">=</span> <span class="n">server</span><span class="o">-&gt;</span><span class="n">cache_consistency_bitmask</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">write_done_cb</span><span class="p">)</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">write_done_cb</span> <span class="o">=</span> <span class="n">nfs4_write_done_cb</span><span class="p">;</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">res</span><span class="p">.</span><span class="n">server</span> <span class="o">=</span> <span class="n">server</span><span class="p">;</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">timestamp</span>   <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>

	<span class="n">msg</span><span class="o">-&gt;</span><span class="n">rpc_proc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">nfs4_procedures</span><span class="p">[</span><span class="n">NFSPROC4_CLNT_WRITE</span><span class="p">];</span>
	<span class="n">nfs41_init_sequence</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">args</span><span class="p">.</span><span class="n">seq_args</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">res</span><span class="p">.</span><span class="n">seq_res</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">nfs4_proc_write_rpc_prepare</span><span class="p">(</span><span class="k">struct</span> <span class="n">rpc_task</span> <span class="o">*</span><span class="n">task</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nfs_write_data</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nfs4_setup_sequence</span><span class="p">(</span><span class="n">NFS_SERVER</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">header</span><span class="o">-&gt;</span><span class="n">inode</span><span class="p">),</span>
				<span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">args</span><span class="p">.</span><span class="n">seq_args</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">res</span><span class="p">.</span><span class="n">seq_res</span><span class="p">,</span>
				<span class="n">task</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">rpc_call_start</span><span class="p">(</span><span class="n">task</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">nfs4_proc_commit_rpc_prepare</span><span class="p">(</span><span class="k">struct</span> <span class="n">rpc_task</span> <span class="o">*</span><span class="n">task</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nfs_commit_data</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nfs4_setup_sequence</span><span class="p">(</span><span class="n">NFS_SERVER</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">inode</span><span class="p">),</span>
				<span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">args</span><span class="p">.</span><span class="n">seq_args</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">res</span><span class="p">.</span><span class="n">seq_res</span><span class="p">,</span>
				<span class="n">task</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">rpc_call_start</span><span class="p">(</span><span class="n">task</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">nfs4_commit_done_cb</span><span class="p">(</span><span class="k">struct</span> <span class="n">rpc_task</span> <span class="o">*</span><span class="n">task</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nfs_commit_data</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">inode</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nfs4_async_handle_error</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="n">NFS_SERVER</span><span class="p">(</span><span class="n">inode</span><span class="p">),</span> <span class="nb">NULL</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rpc_restart_call_prepare</span><span class="p">(</span><span class="n">task</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">nfs4_commit_done</span><span class="p">(</span><span class="k">struct</span> <span class="n">rpc_task</span> <span class="o">*</span><span class="n">task</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nfs_commit_data</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">nfs4_sequence_done</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">res</span><span class="p">.</span><span class="n">seq_res</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">commit_done_cb</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">nfs4_proc_commit_setup</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs_commit_data</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rpc_message</span> <span class="o">*</span><span class="n">msg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfs_server</span> <span class="o">*</span><span class="n">server</span> <span class="o">=</span> <span class="n">NFS_SERVER</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">inode</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">commit_done_cb</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">commit_done_cb</span> <span class="o">=</span> <span class="n">nfs4_commit_done_cb</span><span class="p">;</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">res</span><span class="p">.</span><span class="n">server</span> <span class="o">=</span> <span class="n">server</span><span class="p">;</span>
	<span class="n">msg</span><span class="o">-&gt;</span><span class="n">rpc_proc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">nfs4_procedures</span><span class="p">[</span><span class="n">NFSPROC4_CLNT_COMMIT</span><span class="p">];</span>
	<span class="n">nfs41_init_sequence</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">args</span><span class="p">.</span><span class="n">seq_args</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">res</span><span class="p">.</span><span class="n">seq_res</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">nfs4_renewdata</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfs_client</span>	<span class="o">*</span><span class="n">client</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>		<span class="n">timestamp</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * nfs4_proc_async_renew(): This is not one of the nfs_rpc_ops; it is a special</span>
<span class="cm"> * standalone procedure for queueing an asynchronous RENEW.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">nfs4_renew_release</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">calldata</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfs4_renewdata</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">calldata</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nfs_client</span> <span class="o">*</span><span class="n">clp</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">client</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_count</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">nfs4_schedule_state_renewal</span><span class="p">(</span><span class="n">clp</span><span class="p">);</span>
	<span class="n">nfs_put_client</span><span class="p">(</span><span class="n">clp</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">nfs4_renew_done</span><span class="p">(</span><span class="k">struct</span> <span class="n">rpc_task</span> <span class="o">*</span><span class="n">task</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">calldata</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfs4_renewdata</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">calldata</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nfs_client</span> <span class="o">*</span><span class="n">clp</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">client</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">timestamp</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">timestamp</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">task</span><span class="o">-&gt;</span><span class="n">tk_status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Unless we&#39;re shutting down, schedule state recovery! */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">NFS_CS_RENEWD</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_res_state</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">task</span><span class="o">-&gt;</span><span class="n">tk_status</span> <span class="o">!=</span> <span class="n">NFS4ERR_CB_PATH_DOWN</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">nfs4_schedule_lease_recovery</span><span class="p">(</span><span class="n">clp</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">nfs4_schedule_path_down_recovery</span><span class="p">(</span><span class="n">clp</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">do_renew_lease</span><span class="p">(</span><span class="n">clp</span><span class="p">,</span> <span class="n">timestamp</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">rpc_call_ops</span> <span class="n">nfs4_renew_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">rpc_call_done</span> <span class="o">=</span> <span class="n">nfs4_renew_done</span><span class="p">,</span>
	<span class="p">.</span><span class="n">rpc_release</span> <span class="o">=</span> <span class="n">nfs4_renew_release</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">nfs4_proc_async_renew</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs_client</span> <span class="o">*</span><span class="n">clp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rpc_cred</span> <span class="o">*</span><span class="n">cred</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">renew_flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rpc_message</span> <span class="n">msg</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">rpc_proc</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">nfs4_procedures</span><span class="p">[</span><span class="n">NFSPROC4_CLNT_RENEW</span><span class="p">],</span>
		<span class="p">.</span><span class="n">rpc_argp</span>	<span class="o">=</span> <span class="n">clp</span><span class="p">,</span>
		<span class="p">.</span><span class="n">rpc_cred</span>	<span class="o">=</span> <span class="n">cred</span><span class="p">,</span>
	<span class="p">};</span>
	<span class="k">struct</span> <span class="n">nfs4_renewdata</span> <span class="o">*</span><span class="n">data</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">renew_flags</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">atomic_inc_not_zero</span><span class="p">(</span><span class="o">&amp;</span><span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_count</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="n">data</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">data</span><span class="p">),</span> <span class="n">GFP_NOFS</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">data</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">client</span> <span class="o">=</span> <span class="n">clp</span><span class="p">;</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">timestamp</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">rpc_call_async</span><span class="p">(</span><span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_rpcclient</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">msg</span><span class="p">,</span> <span class="n">RPC_TASK_SOFT</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">nfs4_renew_ops</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">nfs4_proc_renew</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs_client</span> <span class="o">*</span><span class="n">clp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rpc_cred</span> <span class="o">*</span><span class="n">cred</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rpc_message</span> <span class="n">msg</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">rpc_proc</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">nfs4_procedures</span><span class="p">[</span><span class="n">NFSPROC4_CLNT_RENEW</span><span class="p">],</span>
		<span class="p">.</span><span class="n">rpc_argp</span>	<span class="o">=</span> <span class="n">clp</span><span class="p">,</span>
		<span class="p">.</span><span class="n">rpc_cred</span>	<span class="o">=</span> <span class="n">cred</span><span class="p">,</span>
	<span class="p">};</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">now</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">rpc_call_sync</span><span class="p">(</span><span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_rpcclient</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">msg</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
	<span class="n">do_renew_lease</span><span class="p">(</span><span class="n">clp</span><span class="p">,</span> <span class="n">now</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">nfs4_server_supports_acls</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs_server</span> <span class="o">*</span><span class="n">server</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">caps</span> <span class="o">&amp;</span> <span class="n">NFS_CAP_ACLS</span><span class="p">)</span>
		<span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">acl_bitmask</span> <span class="o">&amp;</span> <span class="n">ACL4_SUPPORT_ALLOW_ACL</span><span class="p">)</span>
		<span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">acl_bitmask</span> <span class="o">&amp;</span> <span class="n">ACL4_SUPPORT_DENY_ACL</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Assuming that XATTR_SIZE_MAX is a multiple of PAGE_CACHE_SIZE, and that</span>
<span class="cm"> * it&#39;s OK to put sizeof(void) * (XATTR_SIZE_MAX/PAGE_CACHE_SIZE) bytes on</span>
<span class="cm"> * the stack.</span>
<span class="cm"> */</span>
<span class="cp">#define NFS4ACL_MAXPAGES (XATTR_SIZE_MAX &gt;&gt; PAGE_CACHE_SHIFT)</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">buf_to_pages_noslab</span><span class="p">(</span><span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">buflen</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">page</span> <span class="o">**</span><span class="n">pages</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">pgbase</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="n">newpage</span><span class="p">,</span> <span class="o">**</span><span class="n">spages</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">len</span><span class="p">;</span>
	<span class="n">spages</span> <span class="o">=</span> <span class="n">pages</span><span class="p">;</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="n">len</span> <span class="o">=</span> <span class="n">min_t</span><span class="p">(</span><span class="kt">size_t</span><span class="p">,</span> <span class="n">PAGE_CACHE_SIZE</span><span class="p">,</span> <span class="n">buflen</span><span class="p">);</span>
		<span class="n">newpage</span> <span class="o">=</span> <span class="n">alloc_page</span><span class="p">(</span><span class="n">GFP_KERNEL</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">newpage</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">unwind</span><span class="p">;</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">page_address</span><span class="p">(</span><span class="n">newpage</span><span class="p">),</span> <span class="n">buf</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
                <span class="n">buf</span> <span class="o">+=</span> <span class="n">len</span><span class="p">;</span>
                <span class="n">buflen</span> <span class="o">-=</span> <span class="n">len</span><span class="p">;</span>
		<span class="o">*</span><span class="n">pages</span><span class="o">++</span> <span class="o">=</span> <span class="n">newpage</span><span class="p">;</span>
		<span class="n">rc</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">buflen</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

<span class="nl">unwind:</span>
	<span class="k">for</span><span class="p">(;</span> <span class="n">rc</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">;</span> <span class="n">rc</span><span class="o">--</span><span class="p">)</span>
		<span class="n">__free_page</span><span class="p">(</span><span class="n">spages</span><span class="p">[</span><span class="n">rc</span><span class="o">-</span><span class="mi">1</span><span class="p">]);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">nfs4_cached_acl</span> <span class="p">{</span>
	<span class="kt">int</span> <span class="n">cached</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">len</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">nfs4_set_cached_acl</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nfs4_cached_acl</span> <span class="o">*</span><span class="n">acl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfs_inode</span> <span class="o">*</span><span class="n">nfsi</span> <span class="o">=</span> <span class="n">NFS_I</span><span class="p">(</span><span class="n">inode</span><span class="p">);</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_lock</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">nfsi</span><span class="o">-&gt;</span><span class="n">nfs4_acl</span><span class="p">);</span>
	<span class="n">nfsi</span><span class="o">-&gt;</span><span class="n">nfs4_acl</span> <span class="o">=</span> <span class="n">acl</span><span class="p">;</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">nfs4_zap_acl_attr</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">nfs4_set_cached_acl</span><span class="p">(</span><span class="n">inode</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">ssize_t</span> <span class="nf">nfs4_read_cached_acl</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">buflen</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfs_inode</span> <span class="o">*</span><span class="n">nfsi</span> <span class="o">=</span> <span class="n">NFS_I</span><span class="p">(</span><span class="n">inode</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">nfs4_cached_acl</span> <span class="o">*</span><span class="n">acl</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_lock</span><span class="p">);</span>
	<span class="n">acl</span> <span class="o">=</span> <span class="n">nfsi</span><span class="o">-&gt;</span><span class="n">nfs4_acl</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">acl</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">buf</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="cm">/* user is just asking for length */</span>
		<span class="k">goto</span> <span class="n">out_len</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">acl</span><span class="o">-&gt;</span><span class="n">cached</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ERANGE</span><span class="p">;</span> <span class="cm">/* see getxattr(2) man page */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">acl</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&gt;</span> <span class="n">buflen</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">acl</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">acl</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
<span class="nl">out_len:</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">acl</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
<span class="nl">out:</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">nfs4_write_cached_acl</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">page</span> <span class="o">**</span><span class="n">pages</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">pgbase</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">acl_len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfs4_cached_acl</span> <span class="o">*</span><span class="n">acl</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pages</span> <span class="o">&amp;&amp;</span> <span class="n">acl_len</span> <span class="o">&lt;=</span> <span class="n">PAGE_SIZE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">acl</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">acl</span><span class="p">)</span> <span class="o">+</span> <span class="n">acl_len</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">acl</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="n">acl</span><span class="o">-&gt;</span><span class="n">cached</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">_copy_from_pages</span><span class="p">(</span><span class="n">acl</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">pages</span><span class="p">,</span> <span class="n">pgbase</span><span class="p">,</span> <span class="n">acl_len</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">acl</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">acl</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">acl</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="n">acl</span><span class="o">-&gt;</span><span class="n">cached</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">acl</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="n">acl_len</span><span class="p">;</span>
<span class="nl">out:</span>
	<span class="n">nfs4_set_cached_acl</span><span class="p">(</span><span class="n">inode</span><span class="p">,</span> <span class="n">acl</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * The getxattr API returns the required buffer length when called with a</span>
<span class="cm"> * NULL buf. The NFSv4 acl tool then calls getxattr again after allocating</span>
<span class="cm"> * the required buf.  On a NULL buf, we send a page of data to the server</span>
<span class="cm"> * guessing that the ACL request can be serviced by a page. If so, we cache</span>
<span class="cm"> * up to the page of ACL data, and the 2nd call to getxattr is serviced by</span>
<span class="cm"> * the cache. If not so, we throw away the page, and cache the required</span>
<span class="cm"> * length. The next getxattr call will then produce another round trip to</span>
<span class="cm"> * the server, this time with the input buf of the required size.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">__nfs4_get_acl_uncached</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">buflen</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="n">pages</span><span class="p">[</span><span class="n">NFS4ACL_MAXPAGES</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="nb">NULL</span><span class="p">,</span> <span class="p">};</span>
	<span class="k">struct</span> <span class="n">nfs_getaclargs</span> <span class="n">args</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">fh</span> <span class="o">=</span> <span class="n">NFS_FH</span><span class="p">(</span><span class="n">inode</span><span class="p">),</span>
		<span class="p">.</span><span class="n">acl_pages</span> <span class="o">=</span> <span class="n">pages</span><span class="p">,</span>
		<span class="p">.</span><span class="n">acl_len</span> <span class="o">=</span> <span class="n">buflen</span><span class="p">,</span>
	<span class="p">};</span>
	<span class="k">struct</span> <span class="n">nfs_getaclres</span> <span class="n">res</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">acl_len</span> <span class="o">=</span> <span class="n">buflen</span><span class="p">,</span>
	<span class="p">};</span>
	<span class="k">struct</span> <span class="n">rpc_message</span> <span class="n">msg</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">rpc_proc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">nfs4_procedures</span><span class="p">[</span><span class="n">NFSPROC4_CLNT_GETACL</span><span class="p">],</span>
		<span class="p">.</span><span class="n">rpc_argp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">args</span><span class="p">,</span>
		<span class="p">.</span><span class="n">rpc_resp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">res</span><span class="p">,</span>
	<span class="p">};</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">,</span> <span class="n">npages</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">acl_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">npages</span> <span class="o">=</span> <span class="p">(</span><span class="n">buflen</span> <span class="o">+</span> <span class="n">PAGE_SIZE</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">PAGE_SHIFT</span><span class="p">;</span>
	<span class="cm">/* As long as we&#39;re doing a round trip to the server anyway,</span>
<span class="cm">	 * let&#39;s be prepared for a page of acl data. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">npages</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">npages</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* Add an extra page to handle the bitmap returned */</span>
	<span class="n">npages</span><span class="o">++</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">npages</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pages</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">alloc_page</span><span class="p">(</span><span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pages</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
			<span class="k">goto</span> <span class="n">out_free</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* for decoding across pages */</span>
	<span class="n">res</span><span class="p">.</span><span class="n">acl_scratch</span> <span class="o">=</span> <span class="n">alloc_page</span><span class="p">(</span><span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">res</span><span class="p">.</span><span class="n">acl_scratch</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_free</span><span class="p">;</span>

	<span class="n">args</span><span class="p">.</span><span class="n">acl_len</span> <span class="o">=</span> <span class="n">npages</span> <span class="o">*</span> <span class="n">PAGE_SIZE</span><span class="p">;</span>
	<span class="n">args</span><span class="p">.</span><span class="n">acl_pgbase</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Let decode_getfacl know not to fail if the ACL data is larger than</span>
<span class="cm">	 * the page we send as a guess */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">buf</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">res</span><span class="p">.</span><span class="n">acl_flags</span> <span class="o">|=</span> <span class="n">NFS4_ACL_LEN_REQUEST</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s  buf %p buflen %zu npages %d args.acl_len %zu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">__func__</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">buflen</span><span class="p">,</span> <span class="n">npages</span><span class="p">,</span> <span class="n">args</span><span class="p">.</span><span class="n">acl_len</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">nfs4_call_sync</span><span class="p">(</span><span class="n">NFS_SERVER</span><span class="p">(</span><span class="n">inode</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">client</span><span class="p">,</span> <span class="n">NFS_SERVER</span><span class="p">(</span><span class="n">inode</span><span class="p">),</span>
			     <span class="o">&amp;</span><span class="n">msg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">args</span><span class="p">.</span><span class="n">seq_args</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">res</span><span class="p">.</span><span class="n">seq_res</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_free</span><span class="p">;</span>

	<span class="n">acl_len</span> <span class="o">=</span> <span class="n">res</span><span class="p">.</span><span class="n">acl_len</span> <span class="o">-</span> <span class="n">res</span><span class="p">.</span><span class="n">acl_data_offset</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">acl_len</span> <span class="o">&gt;</span> <span class="n">args</span><span class="p">.</span><span class="n">acl_len</span><span class="p">)</span>
		<span class="n">nfs4_write_cached_acl</span><span class="p">(</span><span class="n">inode</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">acl_len</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">nfs4_write_cached_acl</span><span class="p">(</span><span class="n">inode</span><span class="p">,</span> <span class="n">pages</span><span class="p">,</span> <span class="n">res</span><span class="p">.</span><span class="n">acl_data_offset</span><span class="p">,</span>
				      <span class="n">acl_len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">buf</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ERANGE</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">acl_len</span> <span class="o">&gt;</span> <span class="n">buflen</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out_free</span><span class="p">;</span>
		<span class="n">_copy_from_pages</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">pages</span><span class="p">,</span> <span class="n">res</span><span class="p">.</span><span class="n">acl_data_offset</span><span class="p">,</span>
				<span class="n">acl_len</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">acl_len</span><span class="p">;</span>
<span class="nl">out_free:</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">npages</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pages</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
			<span class="n">__free_page</span><span class="p">(</span><span class="n">pages</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="p">.</span><span class="n">acl_scratch</span><span class="p">)</span>
		<span class="n">__free_page</span><span class="p">(</span><span class="n">res</span><span class="p">.</span><span class="n">acl_scratch</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">nfs4_get_acl_uncached</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">buflen</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfs4_exception</span> <span class="n">exception</span> <span class="o">=</span> <span class="p">{</span> <span class="p">};</span>
	<span class="kt">ssize_t</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">__nfs4_get_acl_uncached</span><span class="p">(</span><span class="n">inode</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">buflen</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">nfs4_handle_exception</span><span class="p">(</span><span class="n">NFS_SERVER</span><span class="p">(</span><span class="n">inode</span><span class="p">),</span> <span class="n">ret</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">exception</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">exception</span><span class="p">.</span><span class="n">retry</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">nfs4_proc_get_acl</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">buflen</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfs_server</span> <span class="o">*</span><span class="n">server</span> <span class="o">=</span> <span class="n">NFS_SERVER</span><span class="p">(</span><span class="n">inode</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">nfs4_server_supports_acls</span><span class="p">(</span><span class="n">server</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">nfs_revalidate_inode</span><span class="p">(</span><span class="n">server</span><span class="p">,</span> <span class="n">inode</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">NFS_I</span><span class="p">(</span><span class="n">inode</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">cache_validity</span> <span class="o">&amp;</span> <span class="n">NFS_INO_INVALID_ACL</span><span class="p">)</span>
		<span class="n">nfs_zap_acl_cache</span><span class="p">(</span><span class="n">inode</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">nfs4_read_cached_acl</span><span class="p">(</span><span class="n">inode</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">buflen</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">)</span>
		<span class="cm">/* -ENOENT is returned if there is no ACL or if there is an ACL</span>
<span class="cm">		 * but no cached acl data, just the acl length */</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">nfs4_get_acl_uncached</span><span class="p">(</span><span class="n">inode</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">buflen</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">__nfs4_proc_set_acl</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">buflen</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfs_server</span> <span class="o">*</span><span class="n">server</span> <span class="o">=</span> <span class="n">NFS_SERVER</span><span class="p">(</span><span class="n">inode</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="n">pages</span><span class="p">[</span><span class="n">NFS4ACL_MAXPAGES</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">nfs_setaclargs</span> <span class="n">arg</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">fh</span>		<span class="o">=</span> <span class="n">NFS_FH</span><span class="p">(</span><span class="n">inode</span><span class="p">),</span>
		<span class="p">.</span><span class="n">acl_pages</span>	<span class="o">=</span> <span class="n">pages</span><span class="p">,</span>
		<span class="p">.</span><span class="n">acl_len</span>	<span class="o">=</span> <span class="n">buflen</span><span class="p">,</span>
	<span class="p">};</span>
	<span class="k">struct</span> <span class="n">nfs_setaclres</span> <span class="n">res</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rpc_message</span> <span class="n">msg</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">rpc_proc</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">nfs4_procedures</span><span class="p">[</span><span class="n">NFSPROC4_CLNT_SETACL</span><span class="p">],</span>
		<span class="p">.</span><span class="n">rpc_argp</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">arg</span><span class="p">,</span>
		<span class="p">.</span><span class="n">rpc_resp</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">res</span><span class="p">,</span>
	<span class="p">};</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">nfs4_server_supports_acls</span><span class="p">(</span><span class="n">server</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
	<span class="n">i</span> <span class="o">=</span> <span class="n">buf_to_pages_noslab</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">buflen</span><span class="p">,</span> <span class="n">arg</span><span class="p">.</span><span class="n">acl_pages</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">arg</span><span class="p">.</span><span class="n">acl_pgbase</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">nfs_inode_return_delegation</span><span class="p">(</span><span class="n">inode</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">nfs4_call_sync</span><span class="p">(</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">client</span><span class="p">,</span> <span class="n">server</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">msg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">arg</span><span class="p">.</span><span class="n">seq_args</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">res</span><span class="p">.</span><span class="n">seq_res</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Free each page after tx, so the only ref left is</span>
<span class="cm">	 * held by the network stack</span>
<span class="cm">	 */</span>
	<span class="k">for</span> <span class="p">(;</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">--</span><span class="p">)</span>
		<span class="n">put_page</span><span class="p">(</span><span class="n">pages</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Acl update can result in inode attribute update.</span>
<span class="cm">	 * so mark the attribute cache invalid.</span>
<span class="cm">	 */</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_lock</span><span class="p">);</span>
	<span class="n">NFS_I</span><span class="p">(</span><span class="n">inode</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">cache_validity</span> <span class="o">|=</span> <span class="n">NFS_INO_INVALID_ATTR</span><span class="p">;</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_lock</span><span class="p">);</span>
	<span class="n">nfs_access_zap_cache</span><span class="p">(</span><span class="n">inode</span><span class="p">);</span>
	<span class="n">nfs_zap_acl_cache</span><span class="p">(</span><span class="n">inode</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">nfs4_proc_set_acl</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">buflen</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfs4_exception</span> <span class="n">exception</span> <span class="o">=</span> <span class="p">{</span> <span class="p">};</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">nfs4_handle_exception</span><span class="p">(</span><span class="n">NFS_SERVER</span><span class="p">(</span><span class="n">inode</span><span class="p">),</span>
				<span class="n">__nfs4_proc_set_acl</span><span class="p">(</span><span class="n">inode</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">buflen</span><span class="p">),</span>
				<span class="o">&amp;</span><span class="n">exception</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">exception</span><span class="p">.</span><span class="n">retry</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">nfs4_async_handle_error</span><span class="p">(</span><span class="k">struct</span> <span class="n">rpc_task</span> <span class="o">*</span><span class="n">task</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">nfs_server</span> <span class="o">*</span><span class="n">server</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nfs4_state</span> <span class="o">*</span><span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfs_client</span> <span class="o">*</span><span class="n">clp</span> <span class="o">=</span> <span class="n">server</span><span class="o">-&gt;</span><span class="n">nfs_client</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">task</span><span class="o">-&gt;</span><span class="n">tk_status</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">switch</span><span class="p">(</span><span class="n">task</span><span class="o">-&gt;</span><span class="n">tk_status</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="o">-</span><span class="n">NFS4ERR_DELEG_REVOKED</span>:
		<span class="k">case</span> <span class="o">-</span><span class="n">NFS4ERR_ADMIN_REVOKED</span>:
		<span class="k">case</span> <span class="o">-</span><span class="n">NFS4ERR_BAD_STATEID</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">state</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="n">nfs_remove_bad_delegation</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">inode</span><span class="p">);</span>
		<span class="k">case</span> <span class="o">-</span><span class="n">NFS4ERR_OPENMODE</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">state</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="n">nfs4_schedule_stateid_recovery</span><span class="p">(</span><span class="n">server</span><span class="p">,</span> <span class="n">state</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">wait_on_recovery</span><span class="p">;</span>
		<span class="k">case</span> <span class="o">-</span><span class="n">NFS4ERR_EXPIRED</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">state</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
				<span class="n">nfs4_schedule_stateid_recovery</span><span class="p">(</span><span class="n">server</span><span class="p">,</span> <span class="n">state</span><span class="p">);</span>
		<span class="k">case</span> <span class="o">-</span><span class="n">NFS4ERR_STALE_STATEID</span>:
		<span class="k">case</span> <span class="o">-</span><span class="n">NFS4ERR_STALE_CLIENTID</span>:
			<span class="n">nfs4_schedule_lease_recovery</span><span class="p">(</span><span class="n">clp</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">wait_on_recovery</span><span class="p">;</span>
<span class="cp">#if defined(CONFIG_NFS_V4_1)</span>
		<span class="k">case</span> <span class="o">-</span><span class="n">NFS4ERR_BADSESSION</span>:
		<span class="k">case</span> <span class="o">-</span><span class="n">NFS4ERR_BADSLOT</span>:
		<span class="k">case</span> <span class="o">-</span><span class="n">NFS4ERR_BAD_HIGH_SLOT</span>:
		<span class="k">case</span> <span class="o">-</span><span class="n">NFS4ERR_DEADSESSION</span>:
		<span class="k">case</span> <span class="o">-</span><span class="n">NFS4ERR_CONN_NOT_BOUND_TO_SESSION</span>:
		<span class="k">case</span> <span class="o">-</span><span class="n">NFS4ERR_SEQ_FALSE_RETRY</span>:
		<span class="k">case</span> <span class="o">-</span><span class="n">NFS4ERR_SEQ_MISORDERED</span>:
			<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s ERROR %d, Reset session</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
				<span class="n">task</span><span class="o">-&gt;</span><span class="n">tk_status</span><span class="p">);</span>
			<span class="n">nfs4_schedule_session_recovery</span><span class="p">(</span><span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_session</span><span class="p">,</span> <span class="n">task</span><span class="o">-&gt;</span><span class="n">tk_status</span><span class="p">);</span>
			<span class="n">task</span><span class="o">-&gt;</span><span class="n">tk_status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_NFS_V4_1 */</span><span class="cp"></span>
		<span class="k">case</span> <span class="o">-</span><span class="n">NFS4ERR_DELAY</span>:
			<span class="n">nfs_inc_server_stats</span><span class="p">(</span><span class="n">server</span><span class="p">,</span> <span class="n">NFSIOS_DELAY</span><span class="p">);</span>
		<span class="k">case</span> <span class="o">-</span><span class="n">NFS4ERR_GRACE</span>:
		<span class="k">case</span> <span class="o">-</span><span class="n">EKEYEXPIRED</span>:
			<span class="n">rpc_delay</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="n">NFS4_POLL_RETRY_MAX</span><span class="p">);</span>
			<span class="n">task</span><span class="o">-&gt;</span><span class="n">tk_status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
		<span class="k">case</span> <span class="o">-</span><span class="n">NFS4ERR_RETRY_UNCACHED_REP</span>:
		<span class="k">case</span> <span class="o">-</span><span class="n">NFS4ERR_OLD_STATEID</span>:
			<span class="n">task</span><span class="o">-&gt;</span><span class="n">tk_status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">task</span><span class="o">-&gt;</span><span class="n">tk_status</span> <span class="o">=</span> <span class="n">nfs4_map_errors</span><span class="p">(</span><span class="n">task</span><span class="o">-&gt;</span><span class="n">tk_status</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">wait_on_recovery:</span>
	<span class="n">rpc_sleep_on</span><span class="p">(</span><span class="o">&amp;</span><span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_rpcwaitq</span><span class="p">,</span> <span class="n">task</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">NFS4CLNT_MANAGER_RUNNING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_state</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">rpc_wake_up_queued_task</span><span class="p">(</span><span class="o">&amp;</span><span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_rpcwaitq</span><span class="p">,</span> <span class="n">task</span><span class="p">);</span>
	<span class="n">task</span><span class="o">-&gt;</span><span class="n">tk_status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">nfs4_init_boot_verifier</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">nfs_client</span> <span class="o">*</span><span class="n">clp</span><span class="p">,</span>
				    <span class="n">nfs4_verifier</span> <span class="o">*</span><span class="n">bootverf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">__be32</span> <span class="n">verf</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">NFS4CLNT_PURGE_STATE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_state</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* An impossible timestamp guarantees this value</span>
<span class="cm">		 * will never match a generated boot time. */</span>
		<span class="n">verf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">verf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">__be32</span><span class="p">)(</span><span class="n">NSEC_PER_SEC</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">nfs_net</span> <span class="o">*</span><span class="n">nn</span> <span class="o">=</span> <span class="n">net_generic</span><span class="p">(</span><span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_net</span><span class="p">,</span> <span class="n">nfs_net_id</span><span class="p">);</span>
		<span class="n">verf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">__be32</span><span class="p">)</span><span class="n">nn</span><span class="o">-&gt;</span><span class="n">boot_time</span><span class="p">.</span><span class="n">tv_sec</span><span class="p">;</span>
		<span class="n">verf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">__be32</span><span class="p">)</span><span class="n">nn</span><span class="o">-&gt;</span><span class="n">boot_time</span><span class="p">.</span><span class="n">tv_nsec</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">bootverf</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">verf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">bootverf</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">));</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">nfs4_proc_setclientid</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs_client</span> <span class="o">*</span><span class="n">clp</span><span class="p">,</span> <span class="n">u32</span> <span class="n">program</span><span class="p">,</span>
		<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">port</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rpc_cred</span> <span class="o">*</span><span class="n">cred</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">nfs4_setclientid_res</span> <span class="o">*</span><span class="n">res</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">nfs4_verifier</span> <span class="n">sc_verifier</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nfs4_setclientid</span> <span class="n">setclientid</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">sc_verifier</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sc_verifier</span><span class="p">,</span>
		<span class="p">.</span><span class="n">sc_prog</span> <span class="o">=</span> <span class="n">program</span><span class="p">,</span>
		<span class="p">.</span><span class="n">sc_cb_ident</span> <span class="o">=</span> <span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_cb_ident</span><span class="p">,</span>
	<span class="p">};</span>
	<span class="k">struct</span> <span class="n">rpc_message</span> <span class="n">msg</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">rpc_proc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">nfs4_procedures</span><span class="p">[</span><span class="n">NFSPROC4_CLNT_SETCLIENTID</span><span class="p">],</span>
		<span class="p">.</span><span class="n">rpc_argp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">setclientid</span><span class="p">,</span>
		<span class="p">.</span><span class="n">rpc_resp</span> <span class="o">=</span> <span class="n">res</span><span class="p">,</span>
		<span class="p">.</span><span class="n">rpc_cred</span> <span class="o">=</span> <span class="n">cred</span><span class="p">,</span>
	<span class="p">};</span>
	<span class="kt">int</span> <span class="n">loop</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">nfs4_init_boot_verifier</span><span class="p">(</span><span class="n">clp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sc_verifier</span><span class="p">);</span>

	<span class="k">for</span><span class="p">(;;)</span> <span class="p">{</span>
		<span class="n">rcu_read_lock</span><span class="p">();</span>
		<span class="n">setclientid</span><span class="p">.</span><span class="n">sc_name_len</span> <span class="o">=</span> <span class="n">scnprintf</span><span class="p">(</span><span class="n">setclientid</span><span class="p">.</span><span class="n">sc_name</span><span class="p">,</span>
				<span class="k">sizeof</span><span class="p">(</span><span class="n">setclientid</span><span class="p">.</span><span class="n">sc_name</span><span class="p">),</span> <span class="s">&quot;%s/%s %s %s %u&quot;</span><span class="p">,</span>
				<span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_ipaddr</span><span class="p">,</span>
				<span class="n">rpc_peeraddr2str</span><span class="p">(</span><span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_rpcclient</span><span class="p">,</span>
							<span class="n">RPC_DISPLAY_ADDR</span><span class="p">),</span>
				<span class="n">rpc_peeraddr2str</span><span class="p">(</span><span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_rpcclient</span><span class="p">,</span>
							<span class="n">RPC_DISPLAY_PROTO</span><span class="p">),</span>
				<span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_rpcclient</span><span class="o">-&gt;</span><span class="n">cl_auth</span><span class="o">-&gt;</span><span class="n">au_ops</span><span class="o">-&gt;</span><span class="n">au_name</span><span class="p">,</span>
				<span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_id_uniquifier</span><span class="p">);</span>
		<span class="n">setclientid</span><span class="p">.</span><span class="n">sc_netid_len</span> <span class="o">=</span> <span class="n">scnprintf</span><span class="p">(</span><span class="n">setclientid</span><span class="p">.</span><span class="n">sc_netid</span><span class="p">,</span>
				<span class="k">sizeof</span><span class="p">(</span><span class="n">setclientid</span><span class="p">.</span><span class="n">sc_netid</span><span class="p">),</span>
				<span class="n">rpc_peeraddr2str</span><span class="p">(</span><span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_rpcclient</span><span class="p">,</span>
							<span class="n">RPC_DISPLAY_NETID</span><span class="p">));</span>
		<span class="n">setclientid</span><span class="p">.</span><span class="n">sc_uaddr_len</span> <span class="o">=</span> <span class="n">scnprintf</span><span class="p">(</span><span class="n">setclientid</span><span class="p">.</span><span class="n">sc_uaddr</span><span class="p">,</span>
				<span class="k">sizeof</span><span class="p">(</span><span class="n">setclientid</span><span class="p">.</span><span class="n">sc_uaddr</span><span class="p">),</span> <span class="s">&quot;%s.%u.%u&quot;</span><span class="p">,</span>
				<span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_ipaddr</span><span class="p">,</span> <span class="n">port</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">,</span> <span class="n">port</span> <span class="o">&amp;</span> <span class="mi">255</span><span class="p">);</span>
		<span class="n">rcu_read_unlock</span><span class="p">();</span>

		<span class="n">status</span> <span class="o">=</span> <span class="n">rpc_call_sync</span><span class="p">(</span><span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_rpcclient</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">msg</span><span class="p">,</span> <span class="n">RPC_TASK_TIMEOUT</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">!=</span> <span class="o">-</span><span class="n">NFS4ERR_CLID_INUSE</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">loop</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="o">++</span><span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_id_uniquifier</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="o">++</span><span class="n">loop</span><span class="p">;</span>
		<span class="n">ssleep</span><span class="p">(</span><span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_lease_time</span> <span class="o">/</span> <span class="n">HZ</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">nfs4_proc_setclientid_confirm</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs_client</span> <span class="o">*</span><span class="n">clp</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">nfs4_setclientid_res</span> <span class="o">*</span><span class="n">arg</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">rpc_cred</span> <span class="o">*</span><span class="n">cred</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfs_fsinfo</span> <span class="n">fsinfo</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rpc_message</span> <span class="n">msg</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">rpc_proc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">nfs4_procedures</span><span class="p">[</span><span class="n">NFSPROC4_CLNT_SETCLIENTID_CONFIRM</span><span class="p">],</span>
		<span class="p">.</span><span class="n">rpc_argp</span> <span class="o">=</span> <span class="n">arg</span><span class="p">,</span>
		<span class="p">.</span><span class="n">rpc_resp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">fsinfo</span><span class="p">,</span>
		<span class="p">.</span><span class="n">rpc_cred</span> <span class="o">=</span> <span class="n">cred</span><span class="p">,</span>
	<span class="p">};</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">now</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">now</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">rpc_call_sync</span><span class="p">(</span><span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_rpcclient</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">msg</span><span class="p">,</span> <span class="n">RPC_TASK_TIMEOUT</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_lock</span><span class="p">);</span>
		<span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_lease_time</span> <span class="o">=</span> <span class="n">fsinfo</span><span class="p">.</span><span class="n">lease_time</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">;</span>
		<span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_last_renewal</span> <span class="o">=</span> <span class="n">now</span><span class="p">;</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_lock</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">nfs4_delegreturndata</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfs4_delegreturnargs</span> <span class="n">args</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nfs4_delegreturnres</span> <span class="n">res</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nfs_fh</span> <span class="n">fh</span><span class="p">;</span>
	<span class="n">nfs4_stateid</span> <span class="n">stateid</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">timestamp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nfs_fattr</span> <span class="n">fattr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rpc_status</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">nfs4_delegreturn_done</span><span class="p">(</span><span class="k">struct</span> <span class="n">rpc_task</span> <span class="o">*</span><span class="n">task</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">calldata</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfs4_delegreturndata</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">calldata</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">nfs4_sequence_done</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">res</span><span class="p">.</span><span class="n">seq_res</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">task</span><span class="o">-&gt;</span><span class="n">tk_status</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="o">-</span><span class="n">NFS4ERR_STALE_STATEID</span>:
	<span class="k">case</span> <span class="o">-</span><span class="n">NFS4ERR_EXPIRED</span>:
	<span class="k">case</span> <span class="mi">0</span>:
		<span class="n">renew_lease</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">res</span><span class="p">.</span><span class="n">server</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">timestamp</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">nfs4_async_handle_error</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">res</span><span class="p">.</span><span class="n">server</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">)</span> <span class="o">==</span>
				<span class="o">-</span><span class="n">EAGAIN</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rpc_restart_call_prepare</span><span class="p">(</span><span class="n">task</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">rpc_status</span> <span class="o">=</span> <span class="n">task</span><span class="o">-&gt;</span><span class="n">tk_status</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">nfs4_delegreturn_release</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">calldata</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">calldata</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#if defined(CONFIG_NFS_V4_1)</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">nfs4_delegreturn_prepare</span><span class="p">(</span><span class="k">struct</span> <span class="n">rpc_task</span> <span class="o">*</span><span class="n">task</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfs4_delegreturndata</span> <span class="o">*</span><span class="n">d_data</span><span class="p">;</span>

	<span class="n">d_data</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">nfs4_delegreturndata</span> <span class="o">*</span><span class="p">)</span><span class="n">data</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nfs4_setup_sequence</span><span class="p">(</span><span class="n">d_data</span><span class="o">-&gt;</span><span class="n">res</span><span class="p">.</span><span class="n">server</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="n">d_data</span><span class="o">-&gt;</span><span class="n">args</span><span class="p">.</span><span class="n">seq_args</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="n">d_data</span><span class="o">-&gt;</span><span class="n">res</span><span class="p">.</span><span class="n">seq_res</span><span class="p">,</span> <span class="n">task</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">rpc_call_start</span><span class="p">(</span><span class="n">task</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_NFS_V4_1 */</span><span class="cp"></span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">rpc_call_ops</span> <span class="n">nfs4_delegreturn_ops</span> <span class="o">=</span> <span class="p">{</span>
<span class="cp">#if defined(CONFIG_NFS_V4_1)</span>
	<span class="p">.</span><span class="n">rpc_call_prepare</span> <span class="o">=</span> <span class="n">nfs4_delegreturn_prepare</span><span class="p">,</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_NFS_V4_1 */</span><span class="cp"></span>
	<span class="p">.</span><span class="n">rpc_call_done</span> <span class="o">=</span> <span class="n">nfs4_delegreturn_done</span><span class="p">,</span>
	<span class="p">.</span><span class="n">rpc_release</span> <span class="o">=</span> <span class="n">nfs4_delegreturn_release</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">_nfs4_proc_delegreturn</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rpc_cred</span> <span class="o">*</span><span class="n">cred</span><span class="p">,</span> <span class="k">const</span> <span class="n">nfs4_stateid</span> <span class="o">*</span><span class="n">stateid</span><span class="p">,</span> <span class="kt">int</span> <span class="n">issync</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfs4_delegreturndata</span> <span class="o">*</span><span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nfs_server</span> <span class="o">*</span><span class="n">server</span> <span class="o">=</span> <span class="n">NFS_SERVER</span><span class="p">(</span><span class="n">inode</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">rpc_task</span> <span class="o">*</span><span class="n">task</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rpc_message</span> <span class="n">msg</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">rpc_proc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">nfs4_procedures</span><span class="p">[</span><span class="n">NFSPROC4_CLNT_DELEGRETURN</span><span class="p">],</span>
		<span class="p">.</span><span class="n">rpc_cred</span> <span class="o">=</span> <span class="n">cred</span><span class="p">,</span>
	<span class="p">};</span>
	<span class="k">struct</span> <span class="n">rpc_task_setup</span> <span class="n">task_setup_data</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">rpc_client</span> <span class="o">=</span> <span class="n">server</span><span class="o">-&gt;</span><span class="n">client</span><span class="p">,</span>
		<span class="p">.</span><span class="n">rpc_message</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">msg</span><span class="p">,</span>
		<span class="p">.</span><span class="n">callback_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">nfs4_delegreturn_ops</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">RPC_TASK_ASYNC</span><span class="p">,</span>
	<span class="p">};</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">data</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">data</span><span class="p">),</span> <span class="n">GFP_NOFS</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">data</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">nfs41_init_sequence</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">args</span><span class="p">.</span><span class="n">seq_args</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">res</span><span class="p">.</span><span class="n">seq_res</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">args</span><span class="p">.</span><span class="n">fhandle</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">fh</span><span class="p">;</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">args</span><span class="p">.</span><span class="n">stateid</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">stateid</span><span class="p">;</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">args</span><span class="p">.</span><span class="n">bitmask</span> <span class="o">=</span> <span class="n">server</span><span class="o">-&gt;</span><span class="n">cache_consistency_bitmask</span><span class="p">;</span>
	<span class="n">nfs_copy_fh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">fh</span><span class="p">,</span> <span class="n">NFS_FH</span><span class="p">(</span><span class="n">inode</span><span class="p">));</span>
	<span class="n">nfs4_stateid_copy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">stateid</span><span class="p">,</span> <span class="n">stateid</span><span class="p">);</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">res</span><span class="p">.</span><span class="n">fattr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">fattr</span><span class="p">;</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">res</span><span class="p">.</span><span class="n">server</span> <span class="o">=</span> <span class="n">server</span><span class="p">;</span>
	<span class="n">nfs_fattr_init</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">res</span><span class="p">.</span><span class="n">fattr</span><span class="p">);</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">timestamp</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">rpc_status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">task_setup_data</span><span class="p">.</span><span class="n">callback_data</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="n">msg</span><span class="p">.</span><span class="n">rpc_argp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">args</span><span class="p">;</span>
	<span class="n">msg</span><span class="p">.</span><span class="n">rpc_resp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">res</span><span class="p">;</span>
	<span class="n">task</span> <span class="o">=</span> <span class="n">rpc_run_task</span><span class="p">(</span><span class="o">&amp;</span><span class="n">task_setup_data</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">task</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">task</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">issync</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">nfs4_wait_for_completion_rpc_task</span><span class="p">(</span><span class="n">task</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">rpc_status</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">nfs_post_op_update_inode_force_wcc</span><span class="p">(</span><span class="n">inode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">fattr</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">nfs_refresh_inode</span><span class="p">(</span><span class="n">inode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">fattr</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="n">rpc_put_task</span><span class="p">(</span><span class="n">task</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">nfs4_proc_delegreturn</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rpc_cred</span> <span class="o">*</span><span class="n">cred</span><span class="p">,</span> <span class="k">const</span> <span class="n">nfs4_stateid</span> <span class="o">*</span><span class="n">stateid</span><span class="p">,</span> <span class="kt">int</span> <span class="n">issync</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfs_server</span> <span class="o">*</span><span class="n">server</span> <span class="o">=</span> <span class="n">NFS_SERVER</span><span class="p">(</span><span class="n">inode</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">nfs4_exception</span> <span class="n">exception</span> <span class="o">=</span> <span class="p">{</span> <span class="p">};</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">_nfs4_proc_delegreturn</span><span class="p">(</span><span class="n">inode</span><span class="p">,</span> <span class="n">cred</span><span class="p">,</span> <span class="n">stateid</span><span class="p">,</span> <span class="n">issync</span><span class="p">);</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="o">-</span><span class="n">NFS4ERR_STALE_STATEID</span>:
			<span class="k">case</span> <span class="o">-</span><span class="n">NFS4ERR_EXPIRED</span>:
			<span class="k">case</span> <span class="mi">0</span>:
				<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">nfs4_handle_exception</span><span class="p">(</span><span class="n">server</span><span class="p">,</span> <span class="n">err</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">exception</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">exception</span><span class="p">.</span><span class="n">retry</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define NFS4_LOCK_MINTIMEOUT (1 * HZ)</span>
<span class="cp">#define NFS4_LOCK_MAXTIMEOUT (30 * HZ)</span>

<span class="cm">/* </span>
<span class="cm"> * sleep, with exponential backoff, and retry the LOCK operation. </span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span>
<span class="nf">nfs4_set_lock_task_retry</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">timeout</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">freezable_schedule_timeout_killable</span><span class="p">(</span><span class="n">timeout</span><span class="p">);</span>
	<span class="n">timeout</span> <span class="o">&lt;&lt;=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">timeout</span> <span class="o">&gt;</span> <span class="n">NFS4_LOCK_MAXTIMEOUT</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">NFS4_LOCK_MAXTIMEOUT</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">timeout</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">_nfs4_proc_getlk</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs4_state</span> <span class="o">*</span><span class="n">state</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file_lock</span> <span class="o">*</span><span class="n">request</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span> <span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">inode</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nfs_server</span> <span class="o">*</span><span class="n">server</span> <span class="o">=</span> <span class="n">NFS_SERVER</span><span class="p">(</span><span class="n">inode</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">nfs_client</span> <span class="o">*</span><span class="n">clp</span> <span class="o">=</span> <span class="n">server</span><span class="o">-&gt;</span><span class="n">nfs_client</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nfs_lockt_args</span> <span class="n">arg</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">fh</span> <span class="o">=</span> <span class="n">NFS_FH</span><span class="p">(</span><span class="n">inode</span><span class="p">),</span>
		<span class="p">.</span><span class="n">fl</span> <span class="o">=</span> <span class="n">request</span><span class="p">,</span>
	<span class="p">};</span>
	<span class="k">struct</span> <span class="n">nfs_lockt_res</span> <span class="n">res</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">denied</span> <span class="o">=</span> <span class="n">request</span><span class="p">,</span>
	<span class="p">};</span>
	<span class="k">struct</span> <span class="n">rpc_message</span> <span class="n">msg</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">rpc_proc</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">nfs4_procedures</span><span class="p">[</span><span class="n">NFSPROC4_CLNT_LOCKT</span><span class="p">],</span>
		<span class="p">.</span><span class="n">rpc_argp</span>       <span class="o">=</span> <span class="o">&amp;</span><span class="n">arg</span><span class="p">,</span>
		<span class="p">.</span><span class="n">rpc_resp</span>       <span class="o">=</span> <span class="o">&amp;</span><span class="n">res</span><span class="p">,</span>
		<span class="p">.</span><span class="n">rpc_cred</span>	<span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">owner</span><span class="o">-&gt;</span><span class="n">so_cred</span><span class="p">,</span>
	<span class="p">};</span>
	<span class="k">struct</span> <span class="n">nfs4_lock_state</span> <span class="o">*</span><span class="n">lsp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">arg</span><span class="p">.</span><span class="n">lock_owner</span><span class="p">.</span><span class="n">clientid</span> <span class="o">=</span> <span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_clientid</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">nfs4_set_lock_state</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">request</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="n">lsp</span> <span class="o">=</span> <span class="n">request</span><span class="o">-&gt;</span><span class="n">fl_u</span><span class="p">.</span><span class="n">nfs4_fl</span><span class="p">.</span><span class="n">owner</span><span class="p">;</span>
	<span class="n">arg</span><span class="p">.</span><span class="n">lock_owner</span><span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">lsp</span><span class="o">-&gt;</span><span class="n">ls_seqid</span><span class="p">.</span><span class="n">owner_id</span><span class="p">;</span>
	<span class="n">arg</span><span class="p">.</span><span class="n">lock_owner</span><span class="p">.</span><span class="n">s_dev</span> <span class="o">=</span> <span class="n">server</span><span class="o">-&gt;</span><span class="n">s_dev</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">nfs4_call_sync</span><span class="p">(</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">client</span><span class="p">,</span> <span class="n">server</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">msg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">arg</span><span class="p">.</span><span class="n">seq_args</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">res</span><span class="p">.</span><span class="n">seq_res</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">0</span>:
			<span class="n">request</span><span class="o">-&gt;</span><span class="n">fl_type</span> <span class="o">=</span> <span class="n">F_UNLCK</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="o">-</span><span class="n">NFS4ERR_DENIED</span>:
			<span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">request</span><span class="o">-&gt;</span><span class="n">fl_ops</span><span class="o">-&gt;</span><span class="n">fl_release_private</span><span class="p">(</span><span class="n">request</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">nfs4_proc_getlk</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs4_state</span> <span class="o">*</span><span class="n">state</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file_lock</span> <span class="o">*</span><span class="n">request</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfs4_exception</span> <span class="n">exception</span> <span class="o">=</span> <span class="p">{</span> <span class="p">};</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">nfs4_handle_exception</span><span class="p">(</span><span class="n">NFS_SERVER</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">inode</span><span class="p">),</span>
				<span class="n">_nfs4_proc_getlk</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">request</span><span class="p">),</span>
				<span class="o">&amp;</span><span class="n">exception</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">exception</span><span class="p">.</span><span class="n">retry</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">do_vfs_lock</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file_lock</span> <span class="o">*</span><span class="n">fl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">res</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">fl</span><span class="o">-&gt;</span><span class="n">fl_flags</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">FL_POSIX</span><span class="o">|</span><span class="n">FL_FLOCK</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">FL_POSIX</span>:
			<span class="n">res</span> <span class="o">=</span> <span class="n">posix_lock_file_wait</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">fl</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">FL_FLOCK</span>:
			<span class="n">res</span> <span class="o">=</span> <span class="n">flock_lock_file_wait</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">fl</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">BUG</span><span class="p">();</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">nfs4_unlockdata</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfs_locku_args</span> <span class="n">arg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nfs_locku_res</span> <span class="n">res</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nfs4_lock_state</span> <span class="o">*</span><span class="n">lsp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nfs_open_context</span> <span class="o">*</span><span class="n">ctx</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">file_lock</span> <span class="n">fl</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">nfs_server</span> <span class="o">*</span><span class="n">server</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">timestamp</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">nfs4_unlockdata</span> <span class="o">*</span><span class="nf">nfs4_alloc_unlockdata</span><span class="p">(</span><span class="k">struct</span> <span class="n">file_lock</span> <span class="o">*</span><span class="n">fl</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">nfs_open_context</span> <span class="o">*</span><span class="n">ctx</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">nfs4_lock_state</span> <span class="o">*</span><span class="n">lsp</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">nfs_seqid</span> <span class="o">*</span><span class="n">seqid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfs4_unlockdata</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span> <span class="o">=</span> <span class="n">lsp</span><span class="o">-&gt;</span><span class="n">ls_state</span><span class="o">-&gt;</span><span class="n">inode</span><span class="p">;</span>

	<span class="n">p</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">p</span><span class="p">),</span> <span class="n">GFP_NOFS</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">p</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">arg</span><span class="p">.</span><span class="n">fh</span> <span class="o">=</span> <span class="n">NFS_FH</span><span class="p">(</span><span class="n">inode</span><span class="p">);</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">arg</span><span class="p">.</span><span class="n">fl</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">fl</span><span class="p">;</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">arg</span><span class="p">.</span><span class="n">seqid</span> <span class="o">=</span> <span class="n">seqid</span><span class="p">;</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">res</span><span class="p">.</span><span class="n">seqid</span> <span class="o">=</span> <span class="n">seqid</span><span class="p">;</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">arg</span><span class="p">.</span><span class="n">stateid</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">lsp</span><span class="o">-&gt;</span><span class="n">ls_stateid</span><span class="p">;</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">lsp</span> <span class="o">=</span> <span class="n">lsp</span><span class="p">;</span>
	<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lsp</span><span class="o">-&gt;</span><span class="n">ls_count</span><span class="p">);</span>
	<span class="cm">/* Ensure we don&#39;t close file until we&#39;re done freeing locks! */</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">ctx</span> <span class="o">=</span> <span class="n">get_nfs_open_context</span><span class="p">(</span><span class="n">ctx</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">fl</span><span class="p">,</span> <span class="n">fl</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">fl</span><span class="p">));</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">server</span> <span class="o">=</span> <span class="n">NFS_SERVER</span><span class="p">(</span><span class="n">inode</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">p</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">nfs4_locku_release_calldata</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfs4_unlockdata</span> <span class="o">*</span><span class="n">calldata</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="n">nfs_free_seqid</span><span class="p">(</span><span class="n">calldata</span><span class="o">-&gt;</span><span class="n">arg</span><span class="p">.</span><span class="n">seqid</span><span class="p">);</span>
	<span class="n">nfs4_put_lock_state</span><span class="p">(</span><span class="n">calldata</span><span class="o">-&gt;</span><span class="n">lsp</span><span class="p">);</span>
	<span class="n">put_nfs_open_context</span><span class="p">(</span><span class="n">calldata</span><span class="o">-&gt;</span><span class="n">ctx</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">calldata</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">nfs4_locku_done</span><span class="p">(</span><span class="k">struct</span> <span class="n">rpc_task</span> <span class="o">*</span><span class="n">task</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfs4_unlockdata</span> <span class="o">*</span><span class="n">calldata</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">nfs4_sequence_done</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">calldata</span><span class="o">-&gt;</span><span class="n">res</span><span class="p">.</span><span class="n">seq_res</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">task</span><span class="o">-&gt;</span><span class="n">tk_status</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">0</span>:
			<span class="n">nfs4_stateid_copy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">calldata</span><span class="o">-&gt;</span><span class="n">lsp</span><span class="o">-&gt;</span><span class="n">ls_stateid</span><span class="p">,</span>
					<span class="o">&amp;</span><span class="n">calldata</span><span class="o">-&gt;</span><span class="n">res</span><span class="p">.</span><span class="n">stateid</span><span class="p">);</span>
			<span class="n">renew_lease</span><span class="p">(</span><span class="n">calldata</span><span class="o">-&gt;</span><span class="n">server</span><span class="p">,</span> <span class="n">calldata</span><span class="o">-&gt;</span><span class="n">timestamp</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="o">-</span><span class="n">NFS4ERR_BAD_STATEID</span>:
		<span class="k">case</span> <span class="o">-</span><span class="n">NFS4ERR_OLD_STATEID</span>:
		<span class="k">case</span> <span class="o">-</span><span class="n">NFS4ERR_STALE_STATEID</span>:
		<span class="k">case</span> <span class="o">-</span><span class="n">NFS4ERR_EXPIRED</span>:
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">nfs4_async_handle_error</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="n">calldata</span><span class="o">-&gt;</span><span class="n">server</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">)</span>
				<span class="n">rpc_restart_call_prepare</span><span class="p">(</span><span class="n">task</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">nfs4_locku_prepare</span><span class="p">(</span><span class="k">struct</span> <span class="n">rpc_task</span> <span class="o">*</span><span class="n">task</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfs4_unlockdata</span> <span class="o">*</span><span class="n">calldata</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nfs_wait_on_sequence</span><span class="p">(</span><span class="n">calldata</span><span class="o">-&gt;</span><span class="n">arg</span><span class="p">.</span><span class="n">seqid</span><span class="p">,</span> <span class="n">task</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">calldata</span><span class="o">-&gt;</span><span class="n">lsp</span><span class="o">-&gt;</span><span class="n">ls_flags</span> <span class="o">&amp;</span> <span class="n">NFS_LOCK_INITIALIZED</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Note: exit _without_ running nfs4_locku_done */</span>
		<span class="n">task</span><span class="o">-&gt;</span><span class="n">tk_action</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">calldata</span><span class="o">-&gt;</span><span class="n">timestamp</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nfs4_setup_sequence</span><span class="p">(</span><span class="n">calldata</span><span class="o">-&gt;</span><span class="n">server</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="n">calldata</span><span class="o">-&gt;</span><span class="n">arg</span><span class="p">.</span><span class="n">seq_args</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="n">calldata</span><span class="o">-&gt;</span><span class="n">res</span><span class="p">.</span><span class="n">seq_res</span><span class="p">,</span> <span class="n">task</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">rpc_call_start</span><span class="p">(</span><span class="n">task</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">rpc_call_ops</span> <span class="n">nfs4_locku_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">rpc_call_prepare</span> <span class="o">=</span> <span class="n">nfs4_locku_prepare</span><span class="p">,</span>
	<span class="p">.</span><span class="n">rpc_call_done</span> <span class="o">=</span> <span class="n">nfs4_locku_done</span><span class="p">,</span>
	<span class="p">.</span><span class="n">rpc_release</span> <span class="o">=</span> <span class="n">nfs4_locku_release_calldata</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">rpc_task</span> <span class="o">*</span><span class="nf">nfs4_do_unlck</span><span class="p">(</span><span class="k">struct</span> <span class="n">file_lock</span> <span class="o">*</span><span class="n">fl</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">nfs_open_context</span> <span class="o">*</span><span class="n">ctx</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">nfs4_lock_state</span> <span class="o">*</span><span class="n">lsp</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">nfs_seqid</span> <span class="o">*</span><span class="n">seqid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfs4_unlockdata</span> <span class="o">*</span><span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rpc_message</span> <span class="n">msg</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">rpc_proc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">nfs4_procedures</span><span class="p">[</span><span class="n">NFSPROC4_CLNT_LOCKU</span><span class="p">],</span>
		<span class="p">.</span><span class="n">rpc_cred</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">cred</span><span class="p">,</span>
	<span class="p">};</span>
	<span class="k">struct</span> <span class="n">rpc_task_setup</span> <span class="n">task_setup_data</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">rpc_client</span> <span class="o">=</span> <span class="n">NFS_CLIENT</span><span class="p">(</span><span class="n">lsp</span><span class="o">-&gt;</span><span class="n">ls_state</span><span class="o">-&gt;</span><span class="n">inode</span><span class="p">),</span>
		<span class="p">.</span><span class="n">rpc_message</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">msg</span><span class="p">,</span>
		<span class="p">.</span><span class="n">callback_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">nfs4_locku_ops</span><span class="p">,</span>
		<span class="p">.</span><span class="n">workqueue</span> <span class="o">=</span> <span class="n">nfsiod_workqueue</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">RPC_TASK_ASYNC</span><span class="p">,</span>
	<span class="p">};</span>

	<span class="cm">/* Ensure this is an unlock - when canceling a lock, the</span>
<span class="cm">	 * canceled lock is passed in, and it won&#39;t be an unlock.</span>
<span class="cm">	 */</span>
	<span class="n">fl</span><span class="o">-&gt;</span><span class="n">fl_type</span> <span class="o">=</span> <span class="n">F_UNLCK</span><span class="p">;</span>

	<span class="n">data</span> <span class="o">=</span> <span class="n">nfs4_alloc_unlockdata</span><span class="p">(</span><span class="n">fl</span><span class="p">,</span> <span class="n">ctx</span><span class="p">,</span> <span class="n">lsp</span><span class="p">,</span> <span class="n">seqid</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">data</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">nfs_free_seqid</span><span class="p">(</span><span class="n">seqid</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">ENOMEM</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">nfs41_init_sequence</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">arg</span><span class="p">.</span><span class="n">seq_args</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">res</span><span class="p">.</span><span class="n">seq_res</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">msg</span><span class="p">.</span><span class="n">rpc_argp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">arg</span><span class="p">;</span>
	<span class="n">msg</span><span class="p">.</span><span class="n">rpc_resp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">res</span><span class="p">;</span>
	<span class="n">task_setup_data</span><span class="p">.</span><span class="n">callback_data</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">rpc_run_task</span><span class="p">(</span><span class="o">&amp;</span><span class="n">task_setup_data</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">nfs4_proc_unlck</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs4_state</span> <span class="o">*</span><span class="n">state</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file_lock</span> <span class="o">*</span><span class="n">request</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfs_inode</span> <span class="o">*</span><span class="n">nfsi</span> <span class="o">=</span> <span class="n">NFS_I</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">inode</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">nfs_seqid</span> <span class="o">*</span><span class="n">seqid</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nfs4_lock_state</span> <span class="o">*</span><span class="n">lsp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rpc_task</span> <span class="o">*</span><span class="n">task</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">fl_flags</span> <span class="o">=</span> <span class="n">request</span><span class="o">-&gt;</span><span class="n">fl_flags</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">nfs4_set_lock_state</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">request</span><span class="p">);</span>
	<span class="cm">/* Unlock _before_ we do the RPC call */</span>
	<span class="n">request</span><span class="o">-&gt;</span><span class="n">fl_flags</span> <span class="o">|=</span> <span class="n">FL_EXISTS</span><span class="p">;</span>
	<span class="n">down_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nfsi</span><span class="o">-&gt;</span><span class="n">rwsem</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">do_vfs_lock</span><span class="p">(</span><span class="n">request</span><span class="o">-&gt;</span><span class="n">fl_file</span><span class="p">,</span> <span class="n">request</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">up_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nfsi</span><span class="o">-&gt;</span><span class="n">rwsem</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">up_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nfsi</span><span class="o">-&gt;</span><span class="n">rwsem</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="cm">/* Is this a delegated lock? */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">NFS_DELEGATED_STATE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="n">lsp</span> <span class="o">=</span> <span class="n">request</span><span class="o">-&gt;</span><span class="n">fl_u</span><span class="p">.</span><span class="n">nfs4_fl</span><span class="p">.</span><span class="n">owner</span><span class="p">;</span>
	<span class="n">seqid</span> <span class="o">=</span> <span class="n">nfs_alloc_seqid</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lsp</span><span class="o">-&gt;</span><span class="n">ls_seqid</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">seqid</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="n">task</span> <span class="o">=</span> <span class="n">nfs4_do_unlck</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">nfs_file_open_context</span><span class="p">(</span><span class="n">request</span><span class="o">-&gt;</span><span class="n">fl_file</span><span class="p">),</span> <span class="n">lsp</span><span class="p">,</span> <span class="n">seqid</span><span class="p">);</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">task</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">task</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">nfs4_wait_for_completion_rpc_task</span><span class="p">(</span><span class="n">task</span><span class="p">);</span>
	<span class="n">rpc_put_task</span><span class="p">(</span><span class="n">task</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="n">request</span><span class="o">-&gt;</span><span class="n">fl_flags</span> <span class="o">=</span> <span class="n">fl_flags</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">nfs4_lockdata</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfs_lock_args</span> <span class="n">arg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nfs_lock_res</span> <span class="n">res</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nfs4_lock_state</span> <span class="o">*</span><span class="n">lsp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nfs_open_context</span> <span class="o">*</span><span class="n">ctx</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">file_lock</span> <span class="n">fl</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">timestamp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rpc_status</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">cancelled</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nfs_server</span> <span class="o">*</span><span class="n">server</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">nfs4_lockdata</span> <span class="o">*</span><span class="nf">nfs4_alloc_lockdata</span><span class="p">(</span><span class="k">struct</span> <span class="n">file_lock</span> <span class="o">*</span><span class="n">fl</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">nfs_open_context</span> <span class="o">*</span><span class="n">ctx</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nfs4_lock_state</span> <span class="o">*</span><span class="n">lsp</span><span class="p">,</span>
		<span class="n">gfp_t</span> <span class="n">gfp_mask</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfs4_lockdata</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span> <span class="o">=</span> <span class="n">lsp</span><span class="o">-&gt;</span><span class="n">ls_state</span><span class="o">-&gt;</span><span class="n">inode</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nfs_server</span> <span class="o">*</span><span class="n">server</span> <span class="o">=</span> <span class="n">NFS_SERVER</span><span class="p">(</span><span class="n">inode</span><span class="p">);</span>

	<span class="n">p</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">p</span><span class="p">),</span> <span class="n">gfp_mask</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">p</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">p</span><span class="o">-&gt;</span><span class="n">arg</span><span class="p">.</span><span class="n">fh</span> <span class="o">=</span> <span class="n">NFS_FH</span><span class="p">(</span><span class="n">inode</span><span class="p">);</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">arg</span><span class="p">.</span><span class="n">fl</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">fl</span><span class="p">;</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">arg</span><span class="p">.</span><span class="n">open_seqid</span> <span class="o">=</span> <span class="n">nfs_alloc_seqid</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lsp</span><span class="o">-&gt;</span><span class="n">ls_state</span><span class="o">-&gt;</span><span class="n">owner</span><span class="o">-&gt;</span><span class="n">so_seqid</span><span class="p">,</span> <span class="n">gfp_mask</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">arg</span><span class="p">.</span><span class="n">open_seqid</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_free</span><span class="p">;</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">arg</span><span class="p">.</span><span class="n">lock_seqid</span> <span class="o">=</span> <span class="n">nfs_alloc_seqid</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lsp</span><span class="o">-&gt;</span><span class="n">ls_seqid</span><span class="p">,</span> <span class="n">gfp_mask</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">arg</span><span class="p">.</span><span class="n">lock_seqid</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_free_seqid</span><span class="p">;</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">arg</span><span class="p">.</span><span class="n">lock_stateid</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">lsp</span><span class="o">-&gt;</span><span class="n">ls_stateid</span><span class="p">;</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">arg</span><span class="p">.</span><span class="n">lock_owner</span><span class="p">.</span><span class="n">clientid</span> <span class="o">=</span> <span class="n">server</span><span class="o">-&gt;</span><span class="n">nfs_client</span><span class="o">-&gt;</span><span class="n">cl_clientid</span><span class="p">;</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">arg</span><span class="p">.</span><span class="n">lock_owner</span><span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">lsp</span><span class="o">-&gt;</span><span class="n">ls_seqid</span><span class="p">.</span><span class="n">owner_id</span><span class="p">;</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">arg</span><span class="p">.</span><span class="n">lock_owner</span><span class="p">.</span><span class="n">s_dev</span> <span class="o">=</span> <span class="n">server</span><span class="o">-&gt;</span><span class="n">s_dev</span><span class="p">;</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">res</span><span class="p">.</span><span class="n">lock_seqid</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">arg</span><span class="p">.</span><span class="n">lock_seqid</span><span class="p">;</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">lsp</span> <span class="o">=</span> <span class="n">lsp</span><span class="p">;</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">server</span> <span class="o">=</span> <span class="n">server</span><span class="p">;</span>
	<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lsp</span><span class="o">-&gt;</span><span class="n">ls_count</span><span class="p">);</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">ctx</span> <span class="o">=</span> <span class="n">get_nfs_open_context</span><span class="p">(</span><span class="n">ctx</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">fl</span><span class="p">,</span> <span class="n">fl</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">fl</span><span class="p">));</span>
	<span class="k">return</span> <span class="n">p</span><span class="p">;</span>
<span class="nl">out_free_seqid:</span>
	<span class="n">nfs_free_seqid</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">arg</span><span class="p">.</span><span class="n">open_seqid</span><span class="p">);</span>
<span class="nl">out_free:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">nfs4_lock_prepare</span><span class="p">(</span><span class="k">struct</span> <span class="n">rpc_task</span> <span class="o">*</span><span class="n">task</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">calldata</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfs4_lockdata</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">calldata</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nfs4_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">lsp</span><span class="o">-&gt;</span><span class="n">ls_state</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s: begin!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nfs_wait_on_sequence</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">arg</span><span class="p">.</span><span class="n">lock_seqid</span><span class="p">,</span> <span class="n">task</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="cm">/* Do we need to do an open_to_lock_owner? */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">arg</span><span class="p">.</span><span class="n">lock_seqid</span><span class="o">-&gt;</span><span class="n">sequence</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">NFS_SEQID_CONFIRMED</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">nfs_wait_on_sequence</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">arg</span><span class="p">.</span><span class="n">open_seqid</span><span class="p">,</span> <span class="n">task</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">arg</span><span class="p">.</span><span class="n">open_stateid</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">stateid</span><span class="p">;</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">arg</span><span class="p">.</span><span class="n">new_lock_owner</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">res</span><span class="p">.</span><span class="n">open_seqid</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">arg</span><span class="p">.</span><span class="n">open_seqid</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">arg</span><span class="p">.</span><span class="n">new_lock_owner</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">timestamp</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nfs4_setup_sequence</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">server</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">arg</span><span class="p">.</span><span class="n">seq_args</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">res</span><span class="p">.</span><span class="n">seq_res</span><span class="p">,</span> <span class="n">task</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">rpc_call_start</span><span class="p">(</span><span class="n">task</span><span class="p">);</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s: done!, ret = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">rpc_status</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">nfs4_recover_lock_prepare</span><span class="p">(</span><span class="k">struct</span> <span class="n">rpc_task</span> <span class="o">*</span><span class="n">task</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">calldata</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">rpc_task_set_priority</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="n">RPC_PRIORITY_PRIVILEGED</span><span class="p">);</span>
	<span class="n">nfs4_lock_prepare</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="n">calldata</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">nfs4_lock_done</span><span class="p">(</span><span class="k">struct</span> <span class="n">rpc_task</span> <span class="o">*</span><span class="n">task</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">calldata</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfs4_lockdata</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">calldata</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s: begin!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">nfs4_sequence_done</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">res</span><span class="p">.</span><span class="n">seq_res</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">data</span><span class="o">-&gt;</span><span class="n">rpc_status</span> <span class="o">=</span> <span class="n">task</span><span class="o">-&gt;</span><span class="n">tk_status</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">arg</span><span class="p">.</span><span class="n">new_lock_owner</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">rpc_status</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">nfs_confirm_seqid</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">lsp</span><span class="o">-&gt;</span><span class="n">ls_seqid</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">rpc_status</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">nfs4_stateid_copy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">lsp</span><span class="o">-&gt;</span><span class="n">ls_stateid</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">res</span><span class="p">.</span><span class="n">stateid</span><span class="p">);</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">lsp</span><span class="o">-&gt;</span><span class="n">ls_flags</span> <span class="o">|=</span> <span class="n">NFS_LOCK_INITIALIZED</span><span class="p">;</span>
		<span class="n">renew_lease</span><span class="p">(</span><span class="n">NFS_SERVER</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">dentry</span><span class="o">-&gt;</span><span class="n">d_inode</span><span class="p">),</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">timestamp</span><span class="p">);</span>
	<span class="p">}</span>
<span class="nl">out:</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s: done, ret = %d!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">rpc_status</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">nfs4_lock_release</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">calldata</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfs4_lockdata</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">calldata</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s: begin!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="n">nfs_free_seqid</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">arg</span><span class="p">.</span><span class="n">open_seqid</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">cancelled</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">rpc_task</span> <span class="o">*</span><span class="n">task</span><span class="p">;</span>
		<span class="n">task</span> <span class="o">=</span> <span class="n">nfs4_do_unlck</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">fl</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">ctx</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">lsp</span><span class="p">,</span>
				<span class="n">data</span><span class="o">-&gt;</span><span class="n">arg</span><span class="p">.</span><span class="n">lock_seqid</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">task</span><span class="p">))</span>
			<span class="n">rpc_put_task_async</span><span class="p">(</span><span class="n">task</span><span class="p">);</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s: cancelling lock!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">nfs_free_seqid</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">arg</span><span class="p">.</span><span class="n">lock_seqid</span><span class="p">);</span>
	<span class="n">nfs4_put_lock_state</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">lsp</span><span class="p">);</span>
	<span class="n">put_nfs_open_context</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">ctx</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s: done!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">rpc_call_ops</span> <span class="n">nfs4_lock_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">rpc_call_prepare</span> <span class="o">=</span> <span class="n">nfs4_lock_prepare</span><span class="p">,</span>
	<span class="p">.</span><span class="n">rpc_call_done</span> <span class="o">=</span> <span class="n">nfs4_lock_done</span><span class="p">,</span>
	<span class="p">.</span><span class="n">rpc_release</span> <span class="o">=</span> <span class="n">nfs4_lock_release</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">rpc_call_ops</span> <span class="n">nfs4_recover_lock_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">rpc_call_prepare</span> <span class="o">=</span> <span class="n">nfs4_recover_lock_prepare</span><span class="p">,</span>
	<span class="p">.</span><span class="n">rpc_call_done</span> <span class="o">=</span> <span class="n">nfs4_lock_done</span><span class="p">,</span>
	<span class="p">.</span><span class="n">rpc_release</span> <span class="o">=</span> <span class="n">nfs4_lock_release</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">nfs4_handle_setlk_error</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs_server</span> <span class="o">*</span><span class="n">server</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nfs4_lock_state</span> <span class="o">*</span><span class="n">lsp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">new_lock_owner</span><span class="p">,</span> <span class="kt">int</span> <span class="n">error</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="o">-</span><span class="n">NFS4ERR_ADMIN_REVOKED</span>:
	<span class="k">case</span> <span class="o">-</span><span class="n">NFS4ERR_BAD_STATEID</span>:
		<span class="n">lsp</span><span class="o">-&gt;</span><span class="n">ls_seqid</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">NFS_SEQID_CONFIRMED</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">new_lock_owner</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">||</span>
		   <span class="p">(</span><span class="n">lsp</span><span class="o">-&gt;</span><span class="n">ls_flags</span> <span class="o">&amp;</span> <span class="n">NFS_LOCK_INITIALIZED</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">nfs4_schedule_stateid_recovery</span><span class="p">(</span><span class="n">server</span><span class="p">,</span> <span class="n">lsp</span><span class="o">-&gt;</span><span class="n">ls_state</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="o">-</span><span class="n">NFS4ERR_STALE_STATEID</span>:
		<span class="n">lsp</span><span class="o">-&gt;</span><span class="n">ls_seqid</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">NFS_SEQID_CONFIRMED</span><span class="p">;</span>
	<span class="k">case</span> <span class="o">-</span><span class="n">NFS4ERR_EXPIRED</span>:
		<span class="n">nfs4_schedule_lease_recovery</span><span class="p">(</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">nfs_client</span><span class="p">);</span>
	<span class="p">};</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">_nfs4_do_setlk</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs4_state</span> <span class="o">*</span><span class="n">state</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file_lock</span> <span class="o">*</span><span class="n">fl</span><span class="p">,</span> <span class="kt">int</span> <span class="n">recovery_type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfs4_lockdata</span> <span class="o">*</span><span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rpc_task</span> <span class="o">*</span><span class="n">task</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rpc_message</span> <span class="n">msg</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">rpc_proc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">nfs4_procedures</span><span class="p">[</span><span class="n">NFSPROC4_CLNT_LOCK</span><span class="p">],</span>
		<span class="p">.</span><span class="n">rpc_cred</span> <span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">owner</span><span class="o">-&gt;</span><span class="n">so_cred</span><span class="p">,</span>
	<span class="p">};</span>
	<span class="k">struct</span> <span class="n">rpc_task_setup</span> <span class="n">task_setup_data</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">rpc_client</span> <span class="o">=</span> <span class="n">NFS_CLIENT</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">inode</span><span class="p">),</span>
		<span class="p">.</span><span class="n">rpc_message</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">msg</span><span class="p">,</span>
		<span class="p">.</span><span class="n">callback_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">nfs4_lock_ops</span><span class="p">,</span>
		<span class="p">.</span><span class="n">workqueue</span> <span class="o">=</span> <span class="n">nfsiod_workqueue</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">RPC_TASK_ASYNC</span><span class="p">,</span>
	<span class="p">};</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s: begin!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="n">data</span> <span class="o">=</span> <span class="n">nfs4_alloc_lockdata</span><span class="p">(</span><span class="n">fl</span><span class="p">,</span> <span class="n">nfs_file_open_context</span><span class="p">(</span><span class="n">fl</span><span class="o">-&gt;</span><span class="n">fl_file</span><span class="p">),</span>
			<span class="n">fl</span><span class="o">-&gt;</span><span class="n">fl_u</span><span class="p">.</span><span class="n">nfs4_fl</span><span class="p">.</span><span class="n">owner</span><span class="p">,</span>
			<span class="n">recovery_type</span> <span class="o">==</span> <span class="n">NFS_LOCK_NEW</span> <span class="o">?</span> <span class="n">GFP_KERNEL</span> <span class="o">:</span> <span class="n">GFP_NOFS</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">data</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_SETLKW</span><span class="p">(</span><span class="n">cmd</span><span class="p">))</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">arg</span><span class="p">.</span><span class="n">block</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">recovery_type</span> <span class="o">&gt;</span> <span class="n">NFS_LOCK_NEW</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">recovery_type</span> <span class="o">==</span> <span class="n">NFS_LOCK_RECLAIM</span><span class="p">)</span>
			<span class="n">data</span><span class="o">-&gt;</span><span class="n">arg</span><span class="p">.</span><span class="n">reclaim</span> <span class="o">=</span> <span class="n">NFS_LOCK_RECLAIM</span><span class="p">;</span>
		<span class="n">task_setup_data</span><span class="p">.</span><span class="n">callback_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">nfs4_recover_lock_ops</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">nfs41_init_sequence</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">arg</span><span class="p">.</span><span class="n">seq_args</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">res</span><span class="p">.</span><span class="n">seq_res</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">msg</span><span class="p">.</span><span class="n">rpc_argp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">arg</span><span class="p">;</span>
	<span class="n">msg</span><span class="p">.</span><span class="n">rpc_resp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">res</span><span class="p">;</span>
	<span class="n">task_setup_data</span><span class="p">.</span><span class="n">callback_data</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="n">task</span> <span class="o">=</span> <span class="n">rpc_run_task</span><span class="p">(</span><span class="o">&amp;</span><span class="n">task_setup_data</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">task</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">task</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">nfs4_wait_for_completion_rpc_task</span><span class="p">(</span><span class="n">task</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">rpc_status</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="n">nfs4_handle_setlk_error</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">server</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">lsp</span><span class="p">,</span>
					<span class="n">data</span><span class="o">-&gt;</span><span class="n">arg</span><span class="p">.</span><span class="n">new_lock_owner</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">cancelled</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">rpc_put_task</span><span class="p">(</span><span class="n">task</span><span class="p">);</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s: done, ret = %d!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">nfs4_lock_reclaim</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs4_state</span> <span class="o">*</span><span class="n">state</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file_lock</span> <span class="o">*</span><span class="n">request</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfs_server</span> <span class="o">*</span><span class="n">server</span> <span class="o">=</span> <span class="n">NFS_SERVER</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">inode</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">nfs4_exception</span> <span class="n">exception</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">inode</span> <span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">inode</span><span class="p">,</span>
	<span class="p">};</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="cm">/* Cache the lock if possible... */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">NFS_DELEGATED_STATE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">_nfs4_do_setlk</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">F_SETLK</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">NFS_LOCK_RECLAIM</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">!=</span> <span class="o">-</span><span class="n">NFS4ERR_DELAY</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">nfs4_handle_exception</span><span class="p">(</span><span class="n">server</span><span class="p">,</span> <span class="n">err</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">exception</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">exception</span><span class="p">.</span><span class="n">retry</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">nfs4_lock_expired</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs4_state</span> <span class="o">*</span><span class="n">state</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file_lock</span> <span class="o">*</span><span class="n">request</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfs_server</span> <span class="o">*</span><span class="n">server</span> <span class="o">=</span> <span class="n">NFS_SERVER</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">inode</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">nfs4_exception</span> <span class="n">exception</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">inode</span> <span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">inode</span><span class="p">,</span>
	<span class="p">};</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">nfs4_set_lock_state</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">request</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">NFS_DELEGATED_STATE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">_nfs4_do_setlk</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">F_SETLK</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">NFS_LOCK_EXPIRED</span><span class="p">);</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="nl">default:</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="k">case</span> <span class="o">-</span><span class="n">NFS4ERR_GRACE</span>:
		<span class="k">case</span> <span class="o">-</span><span class="n">NFS4ERR_DELAY</span>:
			<span class="n">nfs4_handle_exception</span><span class="p">(</span><span class="n">server</span><span class="p">,</span> <span class="n">err</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">exception</span><span class="p">);</span>
			<span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">exception</span><span class="p">.</span><span class="n">retry</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#if defined(CONFIG_NFS_V4_1)</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">nfs41_check_expired_locks</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs4_state</span> <span class="o">*</span><span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">,</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">NFS_OK</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nfs4_lock_state</span> <span class="o">*</span><span class="n">lsp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nfs_server</span> <span class="o">*</span><span class="n">server</span> <span class="o">=</span> <span class="n">NFS_SERVER</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">inode</span><span class="p">);</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">lsp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">lock_states</span><span class="p">,</span> <span class="n">ls_locks</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">lsp</span><span class="o">-&gt;</span><span class="n">ls_flags</span> <span class="o">&amp;</span> <span class="n">NFS_LOCK_INITIALIZED</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">nfs41_test_stateid</span><span class="p">(</span><span class="n">server</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">lsp</span><span class="o">-&gt;</span><span class="n">ls_stateid</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">!=</span> <span class="n">NFS_OK</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">nfs41_free_stateid</span><span class="p">(</span><span class="n">server</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">lsp</span><span class="o">-&gt;</span><span class="n">ls_stateid</span><span class="p">);</span>
				<span class="n">lsp</span><span class="o">-&gt;</span><span class="n">ls_flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">NFS_LOCK_INITIALIZED</span><span class="p">;</span>
				<span class="n">ret</span> <span class="o">=</span> <span class="n">status</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">};</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">nfs41_lock_expired</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs4_state</span> <span class="o">*</span><span class="n">state</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file_lock</span> <span class="o">*</span><span class="n">request</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="n">NFS_OK</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">LK_STATE_IN_USE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">nfs41_check_expired_locks</span><span class="p">(</span><span class="n">state</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="n">NFS_OK</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">nfs4_lock_expired</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">request</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">_nfs4_proc_setlk</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs4_state</span> <span class="o">*</span><span class="n">state</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file_lock</span> <span class="o">*</span><span class="n">request</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfs_inode</span> <span class="o">*</span><span class="n">nfsi</span> <span class="o">=</span> <span class="n">NFS_I</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">inode</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">fl_flags</span> <span class="o">=</span> <span class="n">request</span><span class="o">-&gt;</span><span class="n">fl_flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOLCK</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">fl_flags</span> <span class="o">&amp;</span> <span class="n">FL_POSIX</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			<span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">NFS_STATE_POSIX_LOCKS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="cm">/* Is this a delegated open? */</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">nfs4_set_lock_state</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">request</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="n">request</span><span class="o">-&gt;</span><span class="n">fl_flags</span> <span class="o">|=</span> <span class="n">FL_ACCESS</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">do_vfs_lock</span><span class="p">(</span><span class="n">request</span><span class="o">-&gt;</span><span class="n">fl_file</span><span class="p">,</span> <span class="n">request</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="n">down_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nfsi</span><span class="o">-&gt;</span><span class="n">rwsem</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">NFS_DELEGATED_STATE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* Yes: cache locks! */</span>
		<span class="cm">/* ...but avoid races with delegation recall... */</span>
		<span class="n">request</span><span class="o">-&gt;</span><span class="n">fl_flags</span> <span class="o">=</span> <span class="n">fl_flags</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">FL_SLEEP</span><span class="p">;</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">do_vfs_lock</span><span class="p">(</span><span class="n">request</span><span class="o">-&gt;</span><span class="n">fl_file</span><span class="p">,</span> <span class="n">request</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_unlock</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">_nfs4_do_setlk</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">NFS_LOCK_NEW</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_unlock</span><span class="p">;</span>
	<span class="cm">/* Note: we always want to sleep here! */</span>
	<span class="n">request</span><span class="o">-&gt;</span><span class="n">fl_flags</span> <span class="o">=</span> <span class="n">fl_flags</span> <span class="o">|</span> <span class="n">FL_SLEEP</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">do_vfs_lock</span><span class="p">(</span><span class="n">request</span><span class="o">-&gt;</span><span class="n">fl_file</span><span class="p">,</span> <span class="n">request</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;NFS: %s: VFS is out of sync with lock &quot;</span>
			<span class="s">&quot;manager!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
<span class="nl">out_unlock:</span>
	<span class="n">up_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nfsi</span><span class="o">-&gt;</span><span class="n">rwsem</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="n">request</span><span class="o">-&gt;</span><span class="n">fl_flags</span> <span class="o">=</span> <span class="n">fl_flags</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">nfs4_proc_setlk</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs4_state</span> <span class="o">*</span><span class="n">state</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file_lock</span> <span class="o">*</span><span class="n">request</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfs4_exception</span> <span class="n">exception</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">state</span><span class="p">,</span>
		<span class="p">.</span><span class="n">inode</span> <span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">inode</span><span class="p">,</span>
	<span class="p">};</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">_nfs4_proc_setlk</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">request</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">==</span> <span class="o">-</span><span class="n">NFS4ERR_DENIED</span><span class="p">)</span>
			<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">nfs4_handle_exception</span><span class="p">(</span><span class="n">NFS_SERVER</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">inode</span><span class="p">),</span>
				<span class="n">err</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">exception</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">exception</span><span class="p">.</span><span class="n">retry</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">nfs4_proc_lock</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">filp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file_lock</span> <span class="o">*</span><span class="n">request</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfs_open_context</span> <span class="o">*</span><span class="n">ctx</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nfs4_state</span> <span class="o">*</span><span class="n">state</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">timeout</span> <span class="o">=</span> <span class="n">NFS4_LOCK_MINTIMEOUT</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>

	<span class="cm">/* verify open state */</span>
	<span class="n">ctx</span> <span class="o">=</span> <span class="n">nfs_file_open_context</span><span class="p">(</span><span class="n">filp</span><span class="p">);</span>
	<span class="n">state</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">request</span><span class="o">-&gt;</span><span class="n">fl_start</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">request</span><span class="o">-&gt;</span><span class="n">fl_end</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">IS_GETLK</span><span class="p">(</span><span class="n">cmd</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">state</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">nfs4_proc_getlk</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">F_GETLK</span><span class="p">,</span> <span class="n">request</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">IS_SETLK</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="o">||</span> <span class="n">IS_SETLKW</span><span class="p">(</span><span class="n">cmd</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">request</span><span class="o">-&gt;</span><span class="n">fl_type</span> <span class="o">==</span> <span class="n">F_UNLCK</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">state</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">nfs4_proc_unlck</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">request</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">state</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOLCK</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * Don&#39;t rely on the VFS having checked the file open mode,</span>
<span class="cm">	 * since it won&#39;t do this for flock() locks.</span>
<span class="cm">	 */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">request</span><span class="o">-&gt;</span><span class="n">fl_type</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">F_RDLCK</span><span class="o">|</span><span class="n">F_WRLCK</span><span class="o">|</span><span class="n">F_UNLCK</span><span class="p">))</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">F_RDLCK</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">filp</span><span class="o">-&gt;</span><span class="n">f_mode</span> <span class="o">&amp;</span> <span class="n">FMODE_READ</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EBADF</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">F_WRLCK</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">filp</span><span class="o">-&gt;</span><span class="n">f_mode</span> <span class="o">&amp;</span> <span class="n">FMODE_WRITE</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EBADF</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">nfs4_proc_setlk</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">request</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">status</span> <span class="o">!=</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">)</span> <span class="o">||</span> <span class="n">IS_SETLK</span><span class="p">(</span><span class="n">cmd</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">timeout</span> <span class="o">=</span> <span class="n">nfs4_set_lock_task_retry</span><span class="p">(</span><span class="n">timeout</span><span class="p">);</span>
		<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">ERESTARTSYS</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">signalled</span><span class="p">())</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">while</span><span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">nfs4_lock_delegation_recall</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs4_state</span> <span class="o">*</span><span class="n">state</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file_lock</span> <span class="o">*</span><span class="n">fl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfs_server</span> <span class="o">*</span><span class="n">server</span> <span class="o">=</span> <span class="n">NFS_SERVER</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">inode</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">nfs4_exception</span> <span class="n">exception</span> <span class="o">=</span> <span class="p">{</span> <span class="p">};</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">nfs4_set_lock_state</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">fl</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">_nfs4_do_setlk</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">F_SETLK</span><span class="p">,</span> <span class="n">fl</span><span class="p">,</span> <span class="n">NFS_LOCK_NEW</span><span class="p">);</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
			<span class="nl">default:</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;NFS: %s: unhandled error &quot;</span>
					<span class="s">&quot;%d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
			<span class="k">case</span> <span class="mi">0</span>:
			<span class="k">case</span> <span class="o">-</span><span class="n">ESTALE</span>:
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
			<span class="k">case</span> <span class="o">-</span><span class="n">NFS4ERR_EXPIRED</span>:
				<span class="n">nfs4_schedule_stateid_recovery</span><span class="p">(</span><span class="n">server</span><span class="p">,</span> <span class="n">state</span><span class="p">);</span>
			<span class="k">case</span> <span class="o">-</span><span class="n">NFS4ERR_STALE_CLIENTID</span>:
			<span class="k">case</span> <span class="o">-</span><span class="n">NFS4ERR_STALE_STATEID</span>:
				<span class="n">nfs4_schedule_lease_recovery</span><span class="p">(</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">nfs_client</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
			<span class="k">case</span> <span class="o">-</span><span class="n">NFS4ERR_BADSESSION</span>:
			<span class="k">case</span> <span class="o">-</span><span class="n">NFS4ERR_BADSLOT</span>:
			<span class="k">case</span> <span class="o">-</span><span class="n">NFS4ERR_BAD_HIGH_SLOT</span>:
			<span class="k">case</span> <span class="o">-</span><span class="n">NFS4ERR_CONN_NOT_BOUND_TO_SESSION</span>:
			<span class="k">case</span> <span class="o">-</span><span class="n">NFS4ERR_DEADSESSION</span>:
				<span class="n">nfs4_schedule_session_recovery</span><span class="p">(</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">nfs_client</span><span class="o">-&gt;</span><span class="n">cl_session</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
			<span class="k">case</span> <span class="o">-</span><span class="n">ERESTARTSYS</span>:
				<span class="cm">/*</span>
<span class="cm">				 * The show must go on: exit, but mark the</span>
<span class="cm">				 * stateid as needing recovery.</span>
<span class="cm">				 */</span>
			<span class="k">case</span> <span class="o">-</span><span class="n">NFS4ERR_DELEG_REVOKED</span>:
			<span class="k">case</span> <span class="o">-</span><span class="n">NFS4ERR_ADMIN_REVOKED</span>:
			<span class="k">case</span> <span class="o">-</span><span class="n">NFS4ERR_BAD_STATEID</span>:
			<span class="k">case</span> <span class="o">-</span><span class="n">NFS4ERR_OPENMODE</span>:
				<span class="n">nfs4_schedule_stateid_recovery</span><span class="p">(</span><span class="n">server</span><span class="p">,</span> <span class="n">state</span><span class="p">);</span>
				<span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
			<span class="k">case</span> <span class="o">-</span><span class="n">EKEYEXPIRED</span>:
				<span class="cm">/*</span>
<span class="cm">				 * User RPCSEC_GSS context has expired.</span>
<span class="cm">				 * We cannot recover this stateid now, so</span>
<span class="cm">				 * skip it and allow recovery thread to</span>
<span class="cm">				 * proceed.</span>
<span class="cm">				 */</span>
				<span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
			<span class="k">case</span> <span class="o">-</span><span class="n">ENOMEM</span>:
			<span class="k">case</span> <span class="o">-</span><span class="n">NFS4ERR_DENIED</span>:
				<span class="cm">/* kill_proc(fl-&gt;fl_pid, SIGLOST, 1); */</span>
				<span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
			<span class="k">case</span> <span class="o">-</span><span class="n">NFS4ERR_DELAY</span>:
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">nfs4_handle_exception</span><span class="p">(</span><span class="n">server</span><span class="p">,</span> <span class="n">err</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">exception</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">exception</span><span class="p">.</span><span class="n">retry</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">nfs_release_lockowner_data</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfs4_lock_state</span> <span class="o">*</span><span class="n">lsp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nfs_server</span> <span class="o">*</span><span class="n">server</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nfs_release_lockowner_args</span> <span class="n">args</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">nfs4_release_lockowner_release</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">calldata</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfs_release_lockowner_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">calldata</span><span class="p">;</span>
	<span class="n">nfs4_free_lock_state</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">server</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">lsp</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">calldata</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">rpc_call_ops</span> <span class="n">nfs4_release_lockowner_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">rpc_release</span> <span class="o">=</span> <span class="n">nfs4_release_lockowner_release</span><span class="p">,</span>
<span class="p">};</span>

<span class="kt">int</span> <span class="nf">nfs4_release_lockowner</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs4_lock_state</span> <span class="o">*</span><span class="n">lsp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfs_server</span> <span class="o">*</span><span class="n">server</span> <span class="o">=</span> <span class="n">lsp</span><span class="o">-&gt;</span><span class="n">ls_state</span><span class="o">-&gt;</span><span class="n">owner</span><span class="o">-&gt;</span><span class="n">so_server</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nfs_release_lockowner_data</span> <span class="o">*</span><span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rpc_message</span> <span class="n">msg</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">rpc_proc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">nfs4_procedures</span><span class="p">[</span><span class="n">NFSPROC4_CLNT_RELEASE_LOCKOWNER</span><span class="p">],</span>
	<span class="p">};</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">nfs_client</span><span class="o">-&gt;</span><span class="n">cl_mvops</span><span class="o">-&gt;</span><span class="n">minor_version</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">data</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">data</span><span class="p">),</span> <span class="n">GFP_NOFS</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">data</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">lsp</span> <span class="o">=</span> <span class="n">lsp</span><span class="p">;</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">server</span> <span class="o">=</span> <span class="n">server</span><span class="p">;</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">args</span><span class="p">.</span><span class="n">lock_owner</span><span class="p">.</span><span class="n">clientid</span> <span class="o">=</span> <span class="n">server</span><span class="o">-&gt;</span><span class="n">nfs_client</span><span class="o">-&gt;</span><span class="n">cl_clientid</span><span class="p">;</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">args</span><span class="p">.</span><span class="n">lock_owner</span><span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">lsp</span><span class="o">-&gt;</span><span class="n">ls_seqid</span><span class="p">.</span><span class="n">owner_id</span><span class="p">;</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">args</span><span class="p">.</span><span class="n">lock_owner</span><span class="p">.</span><span class="n">s_dev</span> <span class="o">=</span> <span class="n">server</span><span class="o">-&gt;</span><span class="n">s_dev</span><span class="p">;</span>
	<span class="n">msg</span><span class="p">.</span><span class="n">rpc_argp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">args</span><span class="p">;</span>
	<span class="n">rpc_call_async</span><span class="p">(</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">client</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">msg</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">nfs4_release_lockowner_ops</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define XATTR_NAME_NFSV4_ACL &quot;system.nfs4_acl&quot;</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">nfs4_xattr_set_nfs4_acl</span><span class="p">(</span><span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="n">dentry</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">key</span><span class="p">,</span>
				   <span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">buflen</span><span class="p">,</span>
				   <span class="kt">int</span> <span class="n">flags</span><span class="p">,</span> <span class="kt">int</span> <span class="n">type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">nfs4_proc_set_acl</span><span class="p">(</span><span class="n">dentry</span><span class="o">-&gt;</span><span class="n">d_inode</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">buflen</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">nfs4_xattr_get_nfs4_acl</span><span class="p">(</span><span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="n">dentry</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">key</span><span class="p">,</span>
				   <span class="kt">void</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">buflen</span><span class="p">,</span> <span class="kt">int</span> <span class="n">type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">nfs4_proc_get_acl</span><span class="p">(</span><span class="n">dentry</span><span class="o">-&gt;</span><span class="n">d_inode</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">buflen</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">size_t</span> <span class="nf">nfs4_xattr_list_nfs4_acl</span><span class="p">(</span><span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="n">dentry</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">list</span><span class="p">,</span>
				       <span class="kt">size_t</span> <span class="n">list_len</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span>
				       <span class="kt">size_t</span> <span class="n">name_len</span><span class="p">,</span> <span class="kt">int</span> <span class="n">type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">size_t</span> <span class="n">len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">XATTR_NAME_NFSV4_ACL</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">nfs4_server_supports_acls</span><span class="p">(</span><span class="n">NFS_SERVER</span><span class="p">(</span><span class="n">dentry</span><span class="o">-&gt;</span><span class="n">d_inode</span><span class="p">)))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">list</span> <span class="o">&amp;&amp;</span> <span class="n">len</span> <span class="o">&lt;=</span> <span class="n">list_len</span><span class="p">)</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">list</span><span class="p">,</span> <span class="n">XATTR_NAME_NFSV4_ACL</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">len</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * nfs_fhget will use either the mounted_on_fileid or the fileid</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">nfs_fixup_referral_attributes</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs_fattr</span> <span class="o">*</span><span class="n">fattr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(((</span><span class="n">fattr</span><span class="o">-&gt;</span><span class="n">valid</span> <span class="o">&amp;</span> <span class="n">NFS_ATTR_FATTR_MOUNTED_ON_FILEID</span><span class="p">)</span> <span class="o">||</span>
	       <span class="p">(</span><span class="n">fattr</span><span class="o">-&gt;</span><span class="n">valid</span> <span class="o">&amp;</span> <span class="n">NFS_ATTR_FATTR_FILEID</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
	      <span class="p">(</span><span class="n">fattr</span><span class="o">-&gt;</span><span class="n">valid</span> <span class="o">&amp;</span> <span class="n">NFS_ATTR_FATTR_FSID</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	      <span class="p">(</span><span class="n">fattr</span><span class="o">-&gt;</span><span class="n">valid</span> <span class="o">&amp;</span> <span class="n">NFS_ATTR_FATTR_V4_LOCATIONS</span><span class="p">)))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">fattr</span><span class="o">-&gt;</span><span class="n">valid</span> <span class="o">|=</span> <span class="n">NFS_ATTR_FATTR_TYPE</span> <span class="o">|</span> <span class="n">NFS_ATTR_FATTR_MODE</span> <span class="o">|</span>
		<span class="n">NFS_ATTR_FATTR_NLINK</span> <span class="o">|</span> <span class="n">NFS_ATTR_FATTR_V4_REFERRAL</span><span class="p">;</span>
	<span class="n">fattr</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">=</span> <span class="n">S_IFDIR</span> <span class="o">|</span> <span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IXUGO</span><span class="p">;</span>
	<span class="n">fattr</span><span class="o">-&gt;</span><span class="n">nlink</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">_nfs4_proc_fs_locations</span><span class="p">(</span><span class="k">struct</span> <span class="n">rpc_clnt</span> <span class="o">*</span><span class="n">client</span><span class="p">,</span> <span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">dir</span><span class="p">,</span>
				   <span class="k">const</span> <span class="k">struct</span> <span class="n">qstr</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">nfs4_fs_locations</span> <span class="o">*</span><span class="n">fs_locations</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="n">page</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfs_server</span> <span class="o">*</span><span class="n">server</span> <span class="o">=</span> <span class="n">NFS_SERVER</span><span class="p">(</span><span class="n">dir</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">bitmask</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">FATTR4_WORD0_FSID</span> <span class="o">|</span> <span class="n">FATTR4_WORD0_FS_LOCATIONS</span><span class="p">,</span>
	<span class="p">};</span>
	<span class="k">struct</span> <span class="n">nfs4_fs_locations_arg</span> <span class="n">args</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">dir_fh</span> <span class="o">=</span> <span class="n">NFS_FH</span><span class="p">(</span><span class="n">dir</span><span class="p">),</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span><span class="p">,</span>
		<span class="p">.</span><span class="n">page</span> <span class="o">=</span> <span class="n">page</span><span class="p">,</span>
		<span class="p">.</span><span class="n">bitmask</span> <span class="o">=</span> <span class="n">bitmask</span><span class="p">,</span>
	<span class="p">};</span>
	<span class="k">struct</span> <span class="n">nfs4_fs_locations_res</span> <span class="n">res</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">fs_locations</span> <span class="o">=</span> <span class="n">fs_locations</span><span class="p">,</span>
	<span class="p">};</span>
	<span class="k">struct</span> <span class="n">rpc_message</span> <span class="n">msg</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">rpc_proc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">nfs4_procedures</span><span class="p">[</span><span class="n">NFSPROC4_CLNT_FS_LOCATIONS</span><span class="p">],</span>
		<span class="p">.</span><span class="n">rpc_argp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">args</span><span class="p">,</span>
		<span class="p">.</span><span class="n">rpc_resp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">res</span><span class="p">,</span>
	<span class="p">};</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s: start</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="cm">/* Ask for the fileid of the absent filesystem if mounted_on_fileid</span>
<span class="cm">	 * is not supported */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">NFS_SERVER</span><span class="p">(</span><span class="n">dir</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">attr_bitmask</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">FATTR4_WORD1_MOUNTED_ON_FILEID</span><span class="p">)</span>
		<span class="n">bitmask</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">|=</span> <span class="n">FATTR4_WORD1_MOUNTED_ON_FILEID</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">bitmask</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">|=</span> <span class="n">FATTR4_WORD0_FILEID</span><span class="p">;</span>

	<span class="n">nfs_fattr_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fs_locations</span><span class="o">-&gt;</span><span class="n">fattr</span><span class="p">);</span>
	<span class="n">fs_locations</span><span class="o">-&gt;</span><span class="n">server</span> <span class="o">=</span> <span class="n">server</span><span class="p">;</span>
	<span class="n">fs_locations</span><span class="o">-&gt;</span><span class="n">nlocations</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">nfs4_call_sync</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">server</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">msg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">args</span><span class="p">.</span><span class="n">seq_args</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">res</span><span class="p">.</span><span class="n">seq_res</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s: returned status = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">nfs4_proc_fs_locations</span><span class="p">(</span><span class="k">struct</span> <span class="n">rpc_clnt</span> <span class="o">*</span><span class="n">client</span><span class="p">,</span> <span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">dir</span><span class="p">,</span>
			   <span class="k">const</span> <span class="k">struct</span> <span class="n">qstr</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">nfs4_fs_locations</span> <span class="o">*</span><span class="n">fs_locations</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="n">page</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfs4_exception</span> <span class="n">exception</span> <span class="o">=</span> <span class="p">{</span> <span class="p">};</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">nfs4_handle_exception</span><span class="p">(</span><span class="n">NFS_SERVER</span><span class="p">(</span><span class="n">dir</span><span class="p">),</span>
				<span class="n">_nfs4_proc_fs_locations</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">dir</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">fs_locations</span><span class="p">,</span> <span class="n">page</span><span class="p">),</span>
				<span class="o">&amp;</span><span class="n">exception</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">exception</span><span class="p">.</span><span class="n">retry</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">_nfs4_proc_secinfo</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">dir</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">qstr</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nfs4_secinfo_flavors</span> <span class="o">*</span><span class="n">flavors</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nfs4_secinfo_arg</span> <span class="n">args</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">dir_fh</span> <span class="o">=</span> <span class="n">NFS_FH</span><span class="p">(</span><span class="n">dir</span><span class="p">),</span>
		<span class="p">.</span><span class="n">name</span>   <span class="o">=</span> <span class="n">name</span><span class="p">,</span>
	<span class="p">};</span>
	<span class="k">struct</span> <span class="n">nfs4_secinfo_res</span> <span class="n">res</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">flavors</span>     <span class="o">=</span> <span class="n">flavors</span><span class="p">,</span>
	<span class="p">};</span>
	<span class="k">struct</span> <span class="n">rpc_message</span> <span class="n">msg</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">rpc_proc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">nfs4_procedures</span><span class="p">[</span><span class="n">NFSPROC4_CLNT_SECINFO</span><span class="p">],</span>
		<span class="p">.</span><span class="n">rpc_argp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">args</span><span class="p">,</span>
		<span class="p">.</span><span class="n">rpc_resp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">res</span><span class="p">,</span>
	<span class="p">};</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;NFS call  secinfo %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">name</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">nfs4_call_sync</span><span class="p">(</span><span class="n">NFS_SERVER</span><span class="p">(</span><span class="n">dir</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">client</span><span class="p">,</span> <span class="n">NFS_SERVER</span><span class="p">(</span><span class="n">dir</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">msg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">args</span><span class="p">.</span><span class="n">seq_args</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">res</span><span class="p">.</span><span class="n">seq_res</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;NFS reply  secinfo: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">nfs4_proc_secinfo</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">dir</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">qstr</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span>
		      <span class="k">struct</span> <span class="n">nfs4_secinfo_flavors</span> <span class="o">*</span><span class="n">flavors</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfs4_exception</span> <span class="n">exception</span> <span class="o">=</span> <span class="p">{</span> <span class="p">};</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">nfs4_handle_exception</span><span class="p">(</span><span class="n">NFS_SERVER</span><span class="p">(</span><span class="n">dir</span><span class="p">),</span>
				<span class="n">_nfs4_proc_secinfo</span><span class="p">(</span><span class="n">dir</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">flavors</span><span class="p">),</span>
				<span class="o">&amp;</span><span class="n">exception</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">exception</span><span class="p">.</span><span class="n">retry</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_NFS_V4_1</span>
<span class="cm">/*</span>
<span class="cm"> * Check the exchange flags returned by the server for invalid flags, having</span>
<span class="cm"> * both PNFS and NON_PNFS flags set, and not having one of NON_PNFS, PNFS, or</span>
<span class="cm"> * DS flags set.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">nfs4_check_cl_exchange_flags</span><span class="p">(</span><span class="n">u32</span> <span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">EXCHGID4_FLAG_MASK_R</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_inval</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">EXCHGID4_FLAG_USE_PNFS_MDS</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">EXCHGID4_FLAG_USE_NON_PNFS</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out_inval</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">EXCHGID4_FLAG_MASK_PNFS</span><span class="p">)))</span>
		<span class="k">goto</span> <span class="n">out_inval</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">NFS_OK</span><span class="p">;</span>
<span class="nl">out_inval:</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">NFS4ERR_INVAL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span>
<span class="nf">nfs41_same_server_scope</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs41_server_scope</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">nfs41_server_scope</span> <span class="o">*</span><span class="n">b</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">server_scope_sz</span> <span class="o">==</span> <span class="n">b</span><span class="o">-&gt;</span><span class="n">server_scope_sz</span> <span class="o">&amp;&amp;</span>
	    <span class="n">memcmp</span><span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">server_scope</span><span class="p">,</span> <span class="n">b</span><span class="o">-&gt;</span><span class="n">server_scope</span><span class="p">,</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">server_scope_sz</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>

	<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * nfs4_proc_bind_conn_to_session()</span>
<span class="cm"> *</span>
<span class="cm"> * The 4.1 client currently uses the same TCP connection for the</span>
<span class="cm"> * fore and backchannel.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">nfs4_proc_bind_conn_to_session</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs_client</span> <span class="o">*</span><span class="n">clp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rpc_cred</span> <span class="o">*</span><span class="n">cred</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nfs41_bind_conn_to_session_res</span> <span class="n">res</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rpc_message</span> <span class="n">msg</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">rpc_proc</span> <span class="o">=</span>
			<span class="o">&amp;</span><span class="n">nfs4_procedures</span><span class="p">[</span><span class="n">NFSPROC4_CLNT_BIND_CONN_TO_SESSION</span><span class="p">],</span>
		<span class="p">.</span><span class="n">rpc_argp</span> <span class="o">=</span> <span class="n">clp</span><span class="p">,</span>
		<span class="p">.</span><span class="n">rpc_resp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">res</span><span class="p">,</span>
		<span class="p">.</span><span class="n">rpc_cred</span> <span class="o">=</span> <span class="n">cred</span><span class="p">,</span>
	<span class="p">};</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;--&gt; %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">clp</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="n">res</span><span class="p">.</span><span class="n">session</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs4_session</span><span class="p">),</span> <span class="n">GFP_NOFS</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">res</span><span class="p">.</span><span class="n">session</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">rpc_call_sync</span><span class="p">(</span><span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_rpcclient</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">msg</span><span class="p">,</span> <span class="n">RPC_TASK_TIMEOUT</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">memcmp</span><span class="p">(</span><span class="n">res</span><span class="p">.</span><span class="n">session</span><span class="o">-&gt;</span><span class="n">sess_id</span><span class="p">.</span><span class="n">data</span><span class="p">,</span>
		    <span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_session</span><span class="o">-&gt;</span><span class="n">sess_id</span><span class="p">.</span><span class="n">data</span><span class="p">,</span> <span class="n">NFS4_MAX_SESSIONID_LEN</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;NFS: %s: Session ID mismatch</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
			<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out_session</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="p">.</span><span class="n">dir</span> <span class="o">!=</span> <span class="n">NFS4_CDFS4_BOTH</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;NFS: %s: Unexpected direction from server</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">__func__</span><span class="p">);</span>
			<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out_session</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="p">.</span><span class="n">use_conn_in_rdma_mode</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;NFS: %s: Server returned RDMA mode = true</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">__func__</span><span class="p">);</span>
			<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out_session</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="nl">out_session:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">res</span><span class="p">.</span><span class="n">session</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;&lt;-- %s status= %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * nfs4_proc_exchange_id()</span>
<span class="cm"> *</span>
<span class="cm"> * Since the clientid has expired, all compounds using sessions</span>
<span class="cm"> * associated with the stale clientid will be returning</span>
<span class="cm"> * NFS4ERR_BADSESSION in the sequence operation, and will therefore</span>
<span class="cm"> * be in some phase of session reset.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">nfs4_proc_exchange_id</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs_client</span> <span class="o">*</span><span class="n">clp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rpc_cred</span> <span class="o">*</span><span class="n">cred</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">nfs4_verifier</span> <span class="n">verifier</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nfs41_exchange_id_args</span> <span class="n">args</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">verifier</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">verifier</span><span class="p">,</span>
		<span class="p">.</span><span class="n">client</span> <span class="o">=</span> <span class="n">clp</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">EXCHGID4_FLAG_SUPP_MOVED_REFER</span><span class="p">,</span>
	<span class="p">};</span>
	<span class="k">struct</span> <span class="n">nfs41_exchange_id_res</span> <span class="n">res</span> <span class="o">=</span> <span class="p">{</span>
		<span class="mi">0</span>
	<span class="p">};</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rpc_message</span> <span class="n">msg</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">rpc_proc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">nfs4_procedures</span><span class="p">[</span><span class="n">NFSPROC4_CLNT_EXCHANGE_ID</span><span class="p">],</span>
		<span class="p">.</span><span class="n">rpc_argp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">args</span><span class="p">,</span>
		<span class="p">.</span><span class="n">rpc_resp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">res</span><span class="p">,</span>
		<span class="p">.</span><span class="n">rpc_cred</span> <span class="o">=</span> <span class="n">cred</span><span class="p">,</span>
	<span class="p">};</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;--&gt; %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">clp</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="n">nfs4_init_boot_verifier</span><span class="p">(</span><span class="n">clp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">verifier</span><span class="p">);</span>

	<span class="n">args</span><span class="p">.</span><span class="n">id_len</span> <span class="o">=</span> <span class="n">scnprintf</span><span class="p">(</span><span class="n">args</span><span class="p">.</span><span class="n">id</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">args</span><span class="p">.</span><span class="n">id</span><span class="p">),</span>
				<span class="s">&quot;%s/%s/%u&quot;</span><span class="p">,</span>
				<span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_ipaddr</span><span class="p">,</span>
				<span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_rpcclient</span><span class="o">-&gt;</span><span class="n">cl_nodename</span><span class="p">,</span>
				<span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_rpcclient</span><span class="o">-&gt;</span><span class="n">cl_auth</span><span class="o">-&gt;</span><span class="n">au_flavor</span><span class="p">);</span>

	<span class="n">res</span><span class="p">.</span><span class="n">server_owner</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs41_server_owner</span><span class="p">),</span>
					<span class="n">GFP_NOFS</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">res</span><span class="p">.</span><span class="n">server_owner</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">res</span><span class="p">.</span><span class="n">server_scope</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs41_server_scope</span><span class="p">),</span>
					<span class="n">GFP_NOFS</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">res</span><span class="p">.</span><span class="n">server_scope</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out_server_owner</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">res</span><span class="p">.</span><span class="n">impl_id</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs41_impl_id</span><span class="p">),</span> <span class="n">GFP_NOFS</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">res</span><span class="p">.</span><span class="n">impl_id</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out_server_scope</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">rpc_call_sync</span><span class="p">(</span><span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_rpcclient</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">msg</span><span class="p">,</span> <span class="n">RPC_TASK_TIMEOUT</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">nfs4_check_cl_exchange_flags</span><span class="p">(</span><span class="n">res</span><span class="p">.</span><span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_clientid</span> <span class="o">=</span> <span class="n">res</span><span class="p">.</span><span class="n">clientid</span><span class="p">;</span>
		<span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_exchange_flags</span> <span class="o">=</span> <span class="p">(</span><span class="n">res</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">EXCHGID4_FLAG_CONFIRMED_R</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">res</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">EXCHGID4_FLAG_CONFIRMED_R</span><span class="p">))</span>
			<span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_seqid</span> <span class="o">=</span> <span class="n">res</span><span class="p">.</span><span class="n">seqid</span><span class="p">;</span>

		<span class="n">kfree</span><span class="p">(</span><span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_serverowner</span><span class="p">);</span>
		<span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_serverowner</span> <span class="o">=</span> <span class="n">res</span><span class="p">.</span><span class="n">server_owner</span><span class="p">;</span>
		<span class="n">res</span><span class="p">.</span><span class="n">server_owner</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

		<span class="cm">/* use the most recent implementation id */</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_implid</span><span class="p">);</span>
		<span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_implid</span> <span class="o">=</span> <span class="n">res</span><span class="p">.</span><span class="n">impl_id</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_serverscope</span> <span class="o">!=</span> <span class="nb">NULL</span> <span class="o">&amp;&amp;</span>
		    <span class="o">!</span><span class="n">nfs41_same_server_scope</span><span class="p">(</span><span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_serverscope</span><span class="p">,</span>
					     <span class="n">res</span><span class="p">.</span><span class="n">server_scope</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s: server_scope mismatch detected</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">__func__</span><span class="p">);</span>
			<span class="n">set_bit</span><span class="p">(</span><span class="n">NFS4CLNT_SERVER_SCOPE_MISMATCH</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_state</span><span class="p">);</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_serverscope</span><span class="p">);</span>
			<span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_serverscope</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_serverscope</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_serverscope</span> <span class="o">=</span> <span class="n">res</span><span class="p">.</span><span class="n">server_scope</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">res</span><span class="p">.</span><span class="n">impl_id</span><span class="p">);</span>

<span class="nl">out_server_owner:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">res</span><span class="p">.</span><span class="n">server_owner</span><span class="p">);</span>
<span class="nl">out_server_scope:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">res</span><span class="p">.</span><span class="n">server_scope</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_implid</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s: Server Implementation ID: &quot;</span>
			<span class="s">&quot;domain: %s, name: %s, date: %llu,%u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span> <span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_implid</span><span class="o">-&gt;</span><span class="n">domain</span><span class="p">,</span> <span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_implid</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
			<span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_implid</span><span class="o">-&gt;</span><span class="n">date</span><span class="p">.</span><span class="n">seconds</span><span class="p">,</span>
			<span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_implid</span><span class="o">-&gt;</span><span class="n">date</span><span class="p">.</span><span class="n">nseconds</span><span class="p">);</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;&lt;-- %s status= %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">_nfs4_proc_destroy_clientid</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs_client</span> <span class="o">*</span><span class="n">clp</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">rpc_cred</span> <span class="o">*</span><span class="n">cred</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rpc_message</span> <span class="n">msg</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">rpc_proc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">nfs4_procedures</span><span class="p">[</span><span class="n">NFSPROC4_CLNT_DESTROY_CLIENTID</span><span class="p">],</span>
		<span class="p">.</span><span class="n">rpc_argp</span> <span class="o">=</span> <span class="n">clp</span><span class="p">,</span>
		<span class="p">.</span><span class="n">rpc_cred</span> <span class="o">=</span> <span class="n">cred</span><span class="p">,</span>
	<span class="p">};</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">rpc_call_sync</span><span class="p">(</span><span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_rpcclient</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">msg</span><span class="p">,</span> <span class="n">RPC_TASK_TIMEOUT</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;NFS: Got error %d from the server %s on &quot;</span>
			<span class="s">&quot;DESTROY_CLIENTID.&quot;</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_hostname</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">nfs4_proc_destroy_clientid</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs_client</span> <span class="o">*</span><span class="n">clp</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">rpc_cred</span> <span class="o">*</span><span class="n">cred</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">loop</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">loop</span> <span class="o">=</span> <span class="n">NFS4_MAX_LOOP_ON_RECOVER</span><span class="p">;</span> <span class="n">loop</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">loop</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">_nfs4_proc_destroy_clientid</span><span class="p">(</span><span class="n">clp</span><span class="p">,</span> <span class="n">cred</span><span class="p">);</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="o">-</span><span class="n">NFS4ERR_DELAY</span>:
		<span class="k">case</span> <span class="o">-</span><span class="n">NFS4ERR_CLIENTID_BUSY</span>:
			<span class="n">ssleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">nfs4_destroy_clientid</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs_client</span> <span class="o">*</span><span class="n">clp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rpc_cred</span> <span class="o">*</span><span class="n">cred</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_mvops</span><span class="o">-&gt;</span><span class="n">minor_version</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_exchange_flags</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="n">cred</span> <span class="o">=</span> <span class="n">nfs4_get_exchange_id_cred</span><span class="p">(</span><span class="n">clp</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">nfs4_proc_destroy_clientid</span><span class="p">(</span><span class="n">clp</span><span class="p">,</span> <span class="n">cred</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cred</span><span class="p">)</span>
		<span class="n">put_rpccred</span><span class="p">(</span><span class="n">cred</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>:
	<span class="k">case</span> <span class="o">-</span><span class="n">NFS4ERR_STALE_CLIENTID</span>:
		<span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_exchange_flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">nfs4_get_lease_time_data</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfs4_get_lease_time_args</span> <span class="o">*</span><span class="n">args</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nfs4_get_lease_time_res</span> <span class="o">*</span><span class="n">res</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nfs_client</span> <span class="o">*</span><span class="n">clp</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">nfs4_get_lease_time_prepare</span><span class="p">(</span><span class="k">struct</span> <span class="n">rpc_task</span> <span class="o">*</span><span class="n">task</span><span class="p">,</span>
					<span class="kt">void</span> <span class="o">*</span><span class="n">calldata</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nfs4_get_lease_time_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span>
			<span class="p">(</span><span class="k">struct</span> <span class="n">nfs4_get_lease_time_data</span> <span class="o">*</span><span class="p">)</span><span class="n">calldata</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;--&gt; %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="n">rpc_task_set_priority</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="n">RPC_PRIORITY_PRIVILEGED</span><span class="p">);</span>
	<span class="cm">/* just setup sequence, do not trigger session recovery</span>
<span class="cm">	   since we&#39;re invoked within one */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">nfs41_setup_sequence</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_session</span><span class="p">,</span>
				   <span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">args</span><span class="o">-&gt;</span><span class="n">la_seq_args</span><span class="p">,</span>
				   <span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">lr_seq_res</span><span class="p">,</span> <span class="n">task</span><span class="p">);</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">);</span>
	<span class="n">rpc_call_start</span><span class="p">(</span><span class="n">task</span><span class="p">);</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;&lt;-- %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Called from nfs4_state_manager thread for session setup, so don&#39;t recover</span>
<span class="cm"> * from sequence operation or clientid errors.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">nfs4_get_lease_time_done</span><span class="p">(</span><span class="k">struct</span> <span class="n">rpc_task</span> <span class="o">*</span><span class="n">task</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">calldata</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfs4_get_lease_time_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span>
			<span class="p">(</span><span class="k">struct</span> <span class="n">nfs4_get_lease_time_data</span> <span class="o">*</span><span class="p">)</span><span class="n">calldata</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;--&gt; %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">nfs41_sequence_done</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">lr_seq_res</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">task</span><span class="o">-&gt;</span><span class="n">tk_status</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="o">-</span><span class="n">NFS4ERR_DELAY</span>:
	<span class="k">case</span> <span class="o">-</span><span class="n">NFS4ERR_GRACE</span>:
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s Retry: tk_status %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">task</span><span class="o">-&gt;</span><span class="n">tk_status</span><span class="p">);</span>
		<span class="n">rpc_delay</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="n">NFS4_POLL_RETRY_MIN</span><span class="p">);</span>
		<span class="n">task</span><span class="o">-&gt;</span><span class="n">tk_status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="cm">/* fall through */</span>
	<span class="k">case</span> <span class="o">-</span><span class="n">NFS4ERR_RETRY_UNCACHED_REP</span>:
		<span class="n">rpc_restart_call_prepare</span><span class="p">(</span><span class="n">task</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;&lt;-- %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">rpc_call_ops</span> <span class="n">nfs4_get_lease_time_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">rpc_call_prepare</span> <span class="o">=</span> <span class="n">nfs4_get_lease_time_prepare</span><span class="p">,</span>
	<span class="p">.</span><span class="n">rpc_call_done</span> <span class="o">=</span> <span class="n">nfs4_get_lease_time_done</span><span class="p">,</span>
<span class="p">};</span>

<span class="kt">int</span> <span class="nf">nfs4_proc_get_lease_time</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs_client</span> <span class="o">*</span><span class="n">clp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nfs_fsinfo</span> <span class="o">*</span><span class="n">fsinfo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rpc_task</span> <span class="o">*</span><span class="n">task</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nfs4_get_lease_time_args</span> <span class="n">args</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nfs4_get_lease_time_res</span> <span class="n">res</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">lr_fsinfo</span> <span class="o">=</span> <span class="n">fsinfo</span><span class="p">,</span>
	<span class="p">};</span>
	<span class="k">struct</span> <span class="n">nfs4_get_lease_time_data</span> <span class="n">data</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">args</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">args</span><span class="p">,</span>
		<span class="p">.</span><span class="n">res</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">res</span><span class="p">,</span>
		<span class="p">.</span><span class="n">clp</span> <span class="o">=</span> <span class="n">clp</span><span class="p">,</span>
	<span class="p">};</span>
	<span class="k">struct</span> <span class="n">rpc_message</span> <span class="n">msg</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">rpc_proc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">nfs4_procedures</span><span class="p">[</span><span class="n">NFSPROC4_CLNT_GET_LEASE_TIME</span><span class="p">],</span>
		<span class="p">.</span><span class="n">rpc_argp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">args</span><span class="p">,</span>
		<span class="p">.</span><span class="n">rpc_resp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">res</span><span class="p">,</span>
	<span class="p">};</span>
	<span class="k">struct</span> <span class="n">rpc_task_setup</span> <span class="n">task_setup</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">rpc_client</span> <span class="o">=</span> <span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_rpcclient</span><span class="p">,</span>
		<span class="p">.</span><span class="n">rpc_message</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">msg</span><span class="p">,</span>
		<span class="p">.</span><span class="n">callback_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">nfs4_get_lease_time_ops</span><span class="p">,</span>
		<span class="p">.</span><span class="n">callback_data</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">data</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">RPC_TASK_TIMEOUT</span><span class="p">,</span>
	<span class="p">};</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">nfs41_init_sequence</span><span class="p">(</span><span class="o">&amp;</span><span class="n">args</span><span class="p">.</span><span class="n">la_seq_args</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">res</span><span class="p">.</span><span class="n">lr_seq_res</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;--&gt; %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="n">task</span> <span class="o">=</span> <span class="n">rpc_run_task</span><span class="p">(</span><span class="o">&amp;</span><span class="n">task_setup</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">task</span><span class="p">))</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">task</span><span class="p">);</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">task</span><span class="o">-&gt;</span><span class="n">tk_status</span><span class="p">;</span>
		<span class="n">rpc_put_task</span><span class="p">(</span><span class="n">task</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;&lt;-- %s return %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">nfs4_slot</span> <span class="o">*</span><span class="nf">nfs4_alloc_slots</span><span class="p">(</span><span class="n">u32</span> <span class="n">max_slots</span><span class="p">,</span> <span class="n">gfp_t</span> <span class="n">gfp_flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">kcalloc</span><span class="p">(</span><span class="n">max_slots</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs4_slot</span><span class="p">),</span> <span class="n">gfp_flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">nfs4_add_and_init_slots</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs4_slot_table</span> <span class="o">*</span><span class="n">tbl</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">nfs4_slot</span> <span class="o">*</span><span class="n">new</span><span class="p">,</span>
		<span class="n">u32</span> <span class="n">max_slots</span><span class="p">,</span>
		<span class="n">u32</span> <span class="n">ivalue</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfs4_slot</span> <span class="o">*</span><span class="n">old</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tbl</span><span class="o">-&gt;</span><span class="n">slot_tbl_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">new</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">old</span> <span class="o">=</span> <span class="n">tbl</span><span class="o">-&gt;</span><span class="n">slots</span><span class="p">;</span>
		<span class="n">tbl</span><span class="o">-&gt;</span><span class="n">slots</span> <span class="o">=</span> <span class="n">new</span><span class="p">;</span>
		<span class="n">tbl</span><span class="o">-&gt;</span><span class="n">max_slots</span> <span class="o">=</span> <span class="n">max_slots</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">tbl</span><span class="o">-&gt;</span><span class="n">highest_used_slotid</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>	<span class="cm">/* no slot is currently used */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">tbl</span><span class="o">-&gt;</span><span class="n">max_slots</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">tbl</span><span class="o">-&gt;</span><span class="n">slots</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">seq_nr</span> <span class="o">=</span> <span class="n">ivalue</span><span class="p">;</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tbl</span><span class="o">-&gt;</span><span class="n">slot_tbl_lock</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">old</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * (re)Initialise a slot table</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">nfs4_realloc_slot_table</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs4_slot_table</span> <span class="o">*</span><span class="n">tbl</span><span class="p">,</span> <span class="n">u32</span> <span class="n">max_reqs</span><span class="p">,</span>
				 <span class="n">u32</span> <span class="n">ivalue</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfs4_slot</span> <span class="o">*</span><span class="n">new</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;--&gt; %s: max_reqs=%u, tbl-&gt;max_slots %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
		<span class="n">max_reqs</span><span class="p">,</span> <span class="n">tbl</span><span class="o">-&gt;</span><span class="n">max_slots</span><span class="p">);</span>

	<span class="cm">/* Does the newly negotiated max_reqs match the existing slot table? */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">max_reqs</span> <span class="o">!=</span> <span class="n">tbl</span><span class="o">-&gt;</span><span class="n">max_slots</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">new</span> <span class="o">=</span> <span class="n">nfs4_alloc_slots</span><span class="p">(</span><span class="n">max_reqs</span><span class="p">,</span> <span class="n">GFP_NOFS</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">new</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">nfs4_add_and_init_slots</span><span class="p">(</span><span class="n">tbl</span><span class="p">,</span> <span class="n">new</span><span class="p">,</span> <span class="n">max_reqs</span><span class="p">,</span> <span class="n">ivalue</span><span class="p">);</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s: tbl=%p slots=%p max_slots=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
		<span class="n">tbl</span><span class="p">,</span> <span class="n">tbl</span><span class="o">-&gt;</span><span class="n">slots</span><span class="p">,</span> <span class="n">tbl</span><span class="o">-&gt;</span><span class="n">max_slots</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;&lt;-- %s: return %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Destroy the slot table */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">nfs4_destroy_slot_tables</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs4_session</span> <span class="o">*</span><span class="n">session</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">session</span><span class="o">-&gt;</span><span class="n">fc_slot_table</span><span class="p">.</span><span class="n">slots</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">session</span><span class="o">-&gt;</span><span class="n">fc_slot_table</span><span class="p">.</span><span class="n">slots</span><span class="p">);</span>
		<span class="n">session</span><span class="o">-&gt;</span><span class="n">fc_slot_table</span><span class="p">.</span><span class="n">slots</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">session</span><span class="o">-&gt;</span><span class="n">bc_slot_table</span><span class="p">.</span><span class="n">slots</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">session</span><span class="o">-&gt;</span><span class="n">bc_slot_table</span><span class="p">.</span><span class="n">slots</span><span class="p">);</span>
		<span class="n">session</span><span class="o">-&gt;</span><span class="n">bc_slot_table</span><span class="p">.</span><span class="n">slots</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Initialize or reset the forechannel and backchannel tables</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">nfs4_setup_session_slot_tables</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs4_session</span> <span class="o">*</span><span class="n">ses</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfs4_slot_table</span> <span class="o">*</span><span class="n">tbl</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;--&gt; %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="cm">/* Fore channel */</span>
	<span class="n">tbl</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ses</span><span class="o">-&gt;</span><span class="n">fc_slot_table</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">nfs4_realloc_slot_table</span><span class="p">(</span><span class="n">tbl</span><span class="p">,</span> <span class="n">ses</span><span class="o">-&gt;</span><span class="n">fc_attrs</span><span class="p">.</span><span class="n">max_reqs</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span> <span class="cm">/* -ENOMEM */</span>
		<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
	<span class="cm">/* Back channel */</span>
	<span class="n">tbl</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ses</span><span class="o">-&gt;</span><span class="n">bc_slot_table</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">nfs4_realloc_slot_table</span><span class="p">(</span><span class="n">tbl</span><span class="p">,</span> <span class="n">ses</span><span class="o">-&gt;</span><span class="n">bc_attrs</span><span class="p">.</span><span class="n">max_reqs</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;&amp;</span> <span class="n">tbl</span><span class="o">-&gt;</span><span class="n">slots</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="cm">/* Fore and back channel share a connection so get</span>
<span class="cm">		 * both slot tables or neither */</span>
		<span class="n">nfs4_destroy_slot_tables</span><span class="p">(</span><span class="n">ses</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">nfs4_session</span> <span class="o">*</span><span class="nf">nfs4_alloc_session</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs_client</span> <span class="o">*</span><span class="n">clp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfs4_session</span> <span class="o">*</span><span class="n">session</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nfs4_slot_table</span> <span class="o">*</span><span class="n">tbl</span><span class="p">;</span>

	<span class="n">session</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs4_session</span><span class="p">),</span> <span class="n">GFP_NOFS</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">session</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">tbl</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">session</span><span class="o">-&gt;</span><span class="n">fc_slot_table</span><span class="p">;</span>
	<span class="n">tbl</span><span class="o">-&gt;</span><span class="n">highest_used_slotid</span> <span class="o">=</span> <span class="n">NFS4_NO_SLOT</span><span class="p">;</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tbl</span><span class="o">-&gt;</span><span class="n">slot_tbl_lock</span><span class="p">);</span>
	<span class="n">rpc_init_priority_wait_queue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tbl</span><span class="o">-&gt;</span><span class="n">slot_tbl_waitq</span><span class="p">,</span> <span class="s">&quot;ForeChannel Slot table&quot;</span><span class="p">);</span>
	<span class="n">init_completion</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tbl</span><span class="o">-&gt;</span><span class="n">complete</span><span class="p">);</span>

	<span class="n">tbl</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">session</span><span class="o">-&gt;</span><span class="n">bc_slot_table</span><span class="p">;</span>
	<span class="n">tbl</span><span class="o">-&gt;</span><span class="n">highest_used_slotid</span> <span class="o">=</span> <span class="n">NFS4_NO_SLOT</span><span class="p">;</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tbl</span><span class="o">-&gt;</span><span class="n">slot_tbl_lock</span><span class="p">);</span>
	<span class="n">rpc_init_wait_queue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tbl</span><span class="o">-&gt;</span><span class="n">slot_tbl_waitq</span><span class="p">,</span> <span class="s">&quot;BackChannel Slot table&quot;</span><span class="p">);</span>
	<span class="n">init_completion</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tbl</span><span class="o">-&gt;</span><span class="n">complete</span><span class="p">);</span>

	<span class="n">session</span><span class="o">-&gt;</span><span class="n">session_state</span> <span class="o">=</span> <span class="mi">1</span><span class="o">&lt;&lt;</span><span class="n">NFS4_SESSION_INITING</span><span class="p">;</span>

	<span class="n">session</span><span class="o">-&gt;</span><span class="n">clp</span> <span class="o">=</span> <span class="n">clp</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">session</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">nfs4_destroy_session</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs4_session</span> <span class="o">*</span><span class="n">session</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rpc_xprt</span> <span class="o">*</span><span class="n">xprt</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rpc_cred</span> <span class="o">*</span><span class="n">cred</span><span class="p">;</span>

	<span class="n">cred</span> <span class="o">=</span> <span class="n">nfs4_get_exchange_id_cred</span><span class="p">(</span><span class="n">session</span><span class="o">-&gt;</span><span class="n">clp</span><span class="p">);</span>
	<span class="n">nfs4_proc_destroy_session</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">cred</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cred</span><span class="p">)</span>
		<span class="n">put_rpccred</span><span class="p">(</span><span class="n">cred</span><span class="p">);</span>

	<span class="n">rcu_read_lock</span><span class="p">();</span>
	<span class="n">xprt</span> <span class="o">=</span> <span class="n">rcu_dereference</span><span class="p">(</span><span class="n">session</span><span class="o">-&gt;</span><span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_rpcclient</span><span class="o">-&gt;</span><span class="n">cl_xprt</span><span class="p">);</span>
	<span class="n">rcu_read_unlock</span><span class="p">();</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s Destroy backchannel for xprt %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">__func__</span><span class="p">,</span> <span class="n">xprt</span><span class="p">);</span>
	<span class="n">xprt_destroy_backchannel</span><span class="p">(</span><span class="n">xprt</span><span class="p">,</span> <span class="n">NFS41_BC_MIN_CALLBACKS</span><span class="p">);</span>
	<span class="n">nfs4_destroy_slot_tables</span><span class="p">(</span><span class="n">session</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">session</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Initialize the values to be used by the client in CREATE_SESSION</span>
<span class="cm"> * If nfs4_init_session set the fore channel request and response sizes,</span>
<span class="cm"> * use them.</span>
<span class="cm"> *</span>
<span class="cm"> * Set the back channel max_resp_sz_cached to zero to force the client to</span>
<span class="cm"> * always set csa_cachethis to FALSE because the current implementation</span>
<span class="cm"> * of the back channel DRC only supports caching the CB_SEQUENCE operation.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">nfs4_init_channel_attrs</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs41_create_session_args</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfs4_session</span> <span class="o">*</span><span class="n">session</span> <span class="o">=</span> <span class="n">args</span><span class="o">-&gt;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">cl_session</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">mxrqst_sz</span> <span class="o">=</span> <span class="n">session</span><span class="o">-&gt;</span><span class="n">fc_attrs</span><span class="p">.</span><span class="n">max_rqst_sz</span><span class="p">,</span>
		     <span class="n">mxresp_sz</span> <span class="o">=</span> <span class="n">session</span><span class="o">-&gt;</span><span class="n">fc_attrs</span><span class="p">.</span><span class="n">max_resp_sz</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mxrqst_sz</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">mxrqst_sz</span> <span class="o">=</span> <span class="n">NFS_MAX_FILE_IO_SIZE</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mxresp_sz</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">mxresp_sz</span> <span class="o">=</span> <span class="n">NFS_MAX_FILE_IO_SIZE</span><span class="p">;</span>
	<span class="cm">/* Fore channel attributes */</span>
	<span class="n">args</span><span class="o">-&gt;</span><span class="n">fc_attrs</span><span class="p">.</span><span class="n">max_rqst_sz</span> <span class="o">=</span> <span class="n">mxrqst_sz</span><span class="p">;</span>
	<span class="n">args</span><span class="o">-&gt;</span><span class="n">fc_attrs</span><span class="p">.</span><span class="n">max_resp_sz</span> <span class="o">=</span> <span class="n">mxresp_sz</span><span class="p">;</span>
	<span class="n">args</span><span class="o">-&gt;</span><span class="n">fc_attrs</span><span class="p">.</span><span class="n">max_ops</span> <span class="o">=</span> <span class="n">NFS4_MAX_OPS</span><span class="p">;</span>
	<span class="n">args</span><span class="o">-&gt;</span><span class="n">fc_attrs</span><span class="p">.</span><span class="n">max_reqs</span> <span class="o">=</span> <span class="n">max_session_slots</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s: Fore Channel : max_rqst_sz=%u max_resp_sz=%u &quot;</span>
		<span class="s">&quot;max_ops=%u max_reqs=%u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">__func__</span><span class="p">,</span>
		<span class="n">args</span><span class="o">-&gt;</span><span class="n">fc_attrs</span><span class="p">.</span><span class="n">max_rqst_sz</span><span class="p">,</span> <span class="n">args</span><span class="o">-&gt;</span><span class="n">fc_attrs</span><span class="p">.</span><span class="n">max_resp_sz</span><span class="p">,</span>
		<span class="n">args</span><span class="o">-&gt;</span><span class="n">fc_attrs</span><span class="p">.</span><span class="n">max_ops</span><span class="p">,</span> <span class="n">args</span><span class="o">-&gt;</span><span class="n">fc_attrs</span><span class="p">.</span><span class="n">max_reqs</span><span class="p">);</span>

	<span class="cm">/* Back channel attributes */</span>
	<span class="n">args</span><span class="o">-&gt;</span><span class="n">bc_attrs</span><span class="p">.</span><span class="n">max_rqst_sz</span> <span class="o">=</span> <span class="n">PAGE_SIZE</span><span class="p">;</span>
	<span class="n">args</span><span class="o">-&gt;</span><span class="n">bc_attrs</span><span class="p">.</span><span class="n">max_resp_sz</span> <span class="o">=</span> <span class="n">PAGE_SIZE</span><span class="p">;</span>
	<span class="n">args</span><span class="o">-&gt;</span><span class="n">bc_attrs</span><span class="p">.</span><span class="n">max_resp_sz_cached</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">args</span><span class="o">-&gt;</span><span class="n">bc_attrs</span><span class="p">.</span><span class="n">max_ops</span> <span class="o">=</span> <span class="n">NFS4_MAX_BACK_CHANNEL_OPS</span><span class="p">;</span>
	<span class="n">args</span><span class="o">-&gt;</span><span class="n">bc_attrs</span><span class="p">.</span><span class="n">max_reqs</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s: Back Channel : max_rqst_sz=%u max_resp_sz=%u &quot;</span>
		<span class="s">&quot;max_resp_sz_cached=%u max_ops=%u max_reqs=%u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">__func__</span><span class="p">,</span>
		<span class="n">args</span><span class="o">-&gt;</span><span class="n">bc_attrs</span><span class="p">.</span><span class="n">max_rqst_sz</span><span class="p">,</span> <span class="n">args</span><span class="o">-&gt;</span><span class="n">bc_attrs</span><span class="p">.</span><span class="n">max_resp_sz</span><span class="p">,</span>
		<span class="n">args</span><span class="o">-&gt;</span><span class="n">bc_attrs</span><span class="p">.</span><span class="n">max_resp_sz_cached</span><span class="p">,</span> <span class="n">args</span><span class="o">-&gt;</span><span class="n">bc_attrs</span><span class="p">.</span><span class="n">max_ops</span><span class="p">,</span>
		<span class="n">args</span><span class="o">-&gt;</span><span class="n">bc_attrs</span><span class="p">.</span><span class="n">max_reqs</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">nfs4_verify_fore_channel_attrs</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs41_create_session_args</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nfs4_session</span> <span class="o">*</span><span class="n">session</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfs4_channel_attrs</span> <span class="o">*</span><span class="n">sent</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">args</span><span class="o">-&gt;</span><span class="n">fc_attrs</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nfs4_channel_attrs</span> <span class="o">*</span><span class="n">rcvd</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">session</span><span class="o">-&gt;</span><span class="n">fc_attrs</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rcvd</span><span class="o">-&gt;</span><span class="n">max_resp_sz</span> <span class="o">&gt;</span> <span class="n">sent</span><span class="o">-&gt;</span><span class="n">max_resp_sz</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * Our requested max_ops is the minimum we need; we&#39;re not</span>
<span class="cm">	 * prepared to break up compounds into smaller pieces than that.</span>
<span class="cm">	 * So, no point even trying to continue if the server won&#39;t</span>
<span class="cm">	 * cooperate:</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rcvd</span><span class="o">-&gt;</span><span class="n">max_ops</span> <span class="o">&lt;</span> <span class="n">sent</span><span class="o">-&gt;</span><span class="n">max_ops</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rcvd</span><span class="o">-&gt;</span><span class="n">max_reqs</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rcvd</span><span class="o">-&gt;</span><span class="n">max_reqs</span> <span class="o">&gt;</span> <span class="n">NFS4_MAX_SLOT_TABLE</span><span class="p">)</span>
		<span class="n">rcvd</span><span class="o">-&gt;</span><span class="n">max_reqs</span> <span class="o">=</span> <span class="n">NFS4_MAX_SLOT_TABLE</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">nfs4_verify_back_channel_attrs</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs41_create_session_args</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nfs4_session</span> <span class="o">*</span><span class="n">session</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfs4_channel_attrs</span> <span class="o">*</span><span class="n">sent</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">args</span><span class="o">-&gt;</span><span class="n">bc_attrs</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nfs4_channel_attrs</span> <span class="o">*</span><span class="n">rcvd</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">session</span><span class="o">-&gt;</span><span class="n">bc_attrs</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rcvd</span><span class="o">-&gt;</span><span class="n">max_rqst_sz</span> <span class="o">&gt;</span> <span class="n">sent</span><span class="o">-&gt;</span><span class="n">max_rqst_sz</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rcvd</span><span class="o">-&gt;</span><span class="n">max_resp_sz</span> <span class="o">&lt;</span> <span class="n">sent</span><span class="o">-&gt;</span><span class="n">max_resp_sz</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rcvd</span><span class="o">-&gt;</span><span class="n">max_resp_sz_cached</span> <span class="o">&gt;</span> <span class="n">sent</span><span class="o">-&gt;</span><span class="n">max_resp_sz_cached</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="cm">/* These would render the backchannel useless: */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rcvd</span><span class="o">-&gt;</span><span class="n">max_ops</span> <span class="o">!=</span> <span class="n">sent</span><span class="o">-&gt;</span><span class="n">max_ops</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rcvd</span><span class="o">-&gt;</span><span class="n">max_reqs</span> <span class="o">!=</span> <span class="n">sent</span><span class="o">-&gt;</span><span class="n">max_reqs</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">nfs4_verify_channel_attrs</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs41_create_session_args</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">nfs4_session</span> <span class="o">*</span><span class="n">session</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">nfs4_verify_fore_channel_attrs</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">session</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">nfs4_verify_back_channel_attrs</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">session</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">_nfs4_proc_create_session</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs_client</span> <span class="o">*</span><span class="n">clp</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">rpc_cred</span> <span class="o">*</span><span class="n">cred</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfs4_session</span> <span class="o">*</span><span class="n">session</span> <span class="o">=</span> <span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_session</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nfs41_create_session_args</span> <span class="n">args</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">client</span> <span class="o">=</span> <span class="n">clp</span><span class="p">,</span>
		<span class="p">.</span><span class="n">cb_program</span> <span class="o">=</span> <span class="n">NFS4_CALLBACK</span><span class="p">,</span>
	<span class="p">};</span>
	<span class="k">struct</span> <span class="n">nfs41_create_session_res</span> <span class="n">res</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">client</span> <span class="o">=</span> <span class="n">clp</span><span class="p">,</span>
	<span class="p">};</span>
	<span class="k">struct</span> <span class="n">rpc_message</span> <span class="n">msg</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">rpc_proc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">nfs4_procedures</span><span class="p">[</span><span class="n">NFSPROC4_CLNT_CREATE_SESSION</span><span class="p">],</span>
		<span class="p">.</span><span class="n">rpc_argp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">args</span><span class="p">,</span>
		<span class="p">.</span><span class="n">rpc_resp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">res</span><span class="p">,</span>
		<span class="p">.</span><span class="n">rpc_cred</span> <span class="o">=</span> <span class="n">cred</span><span class="p">,</span>
	<span class="p">};</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">nfs4_init_channel_attrs</span><span class="p">(</span><span class="o">&amp;</span><span class="n">args</span><span class="p">);</span>
	<span class="n">args</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="p">(</span><span class="n">SESSION4_PERSIST</span> <span class="o">|</span> <span class="n">SESSION4_BACK_CHAN</span><span class="p">);</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">rpc_call_sync</span><span class="p">(</span><span class="n">session</span><span class="o">-&gt;</span><span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_rpcclient</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">msg</span><span class="p">,</span> <span class="n">RPC_TASK_TIMEOUT</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">status</span><span class="p">)</span>
		<span class="cm">/* Verify the session&#39;s negotiated channel_attrs values */</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">nfs4_verify_channel_attrs</span><span class="p">(</span><span class="o">&amp;</span><span class="n">args</span><span class="p">,</span> <span class="n">session</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Increment the clientid slot sequence id */</span>
		<span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_seqid</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Issues a CREATE_SESSION operation to the server.</span>
<span class="cm"> * It is the responsibility of the caller to verify the session is</span>
<span class="cm"> * expired before calling this routine.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">nfs4_proc_create_session</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs_client</span> <span class="o">*</span><span class="n">clp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rpc_cred</span> <span class="o">*</span><span class="n">cred</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="o">*</span><span class="n">ptr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nfs4_session</span> <span class="o">*</span><span class="n">session</span> <span class="o">=</span> <span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_session</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;--&gt; %s clp=%p session=%p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">clp</span><span class="p">,</span> <span class="n">session</span><span class="p">);</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">_nfs4_proc_create_session</span><span class="p">(</span><span class="n">clp</span><span class="p">,</span> <span class="n">cred</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="cm">/* Init or reset the session slot tables */</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">nfs4_setup_session_slot_tables</span><span class="p">(</span><span class="n">session</span><span class="p">);</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;slot table setup returned %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">ptr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">session</span><span class="o">-&gt;</span><span class="n">sess_id</span><span class="p">.</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s client&gt;seqid %d sessionid %u:%u:%u:%u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
		<span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_seqid</span><span class="p">,</span> <span class="n">ptr</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ptr</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">ptr</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">ptr</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>
<span class="nl">out:</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;&lt;-- %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Issue the over-the-wire RPC DESTROY_SESSION.</span>
<span class="cm"> * The caller must serialize access to this routine.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">nfs4_proc_destroy_session</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs4_session</span> <span class="o">*</span><span class="n">session</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">rpc_cred</span> <span class="o">*</span><span class="n">cred</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rpc_message</span> <span class="n">msg</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">rpc_proc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">nfs4_procedures</span><span class="p">[</span><span class="n">NFSPROC4_CLNT_DESTROY_SESSION</span><span class="p">],</span>
		<span class="p">.</span><span class="n">rpc_argp</span> <span class="o">=</span> <span class="n">session</span><span class="p">,</span>
		<span class="p">.</span><span class="n">rpc_cred</span> <span class="o">=</span> <span class="n">cred</span><span class="p">,</span>
	<span class="p">};</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;--&gt; nfs4_proc_destroy_session</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/* session is still being setup */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">session</span><span class="o">-&gt;</span><span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_cons_state</span> <span class="o">!=</span> <span class="n">NFS_CS_READY</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">rpc_call_sync</span><span class="p">(</span><span class="n">session</span><span class="o">-&gt;</span><span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_rpcclient</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">msg</span><span class="p">,</span> <span class="n">RPC_TASK_TIMEOUT</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;NFS: Got error %d from the server on DESTROY_SESSION. &quot;</span>
			<span class="s">&quot;Session has been destroyed regardless...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;&lt;-- nfs4_proc_destroy_session</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * With sessions, the client is not marked ready until after a</span>
<span class="cm"> * successful EXCHANGE_ID and CREATE_SESSION.</span>
<span class="cm"> *</span>
<span class="cm"> * Map errors cl_cons_state errors to EPROTONOSUPPORT to indicate</span>
<span class="cm"> * other versions of NFS can be tried.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">nfs41_check_session_ready</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs_client</span> <span class="o">*</span><span class="n">clp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	
	<span class="k">if</span> <span class="p">(</span><span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_cons_state</span> <span class="o">==</span> <span class="n">NFS_CS_SESSION_INITING</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">nfs4_client_recover_expired_lease</span><span class="p">(</span><span class="n">clp</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_cons_state</span> <span class="o">&lt;</span> <span class="n">NFS_CS_READY</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EPROTONOSUPPORT</span><span class="p">;</span>
	<span class="n">smp_rmb</span><span class="p">();</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">nfs4_init_session</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs_server</span> <span class="o">*</span><span class="n">server</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfs_client</span> <span class="o">*</span><span class="n">clp</span> <span class="o">=</span> <span class="n">server</span><span class="o">-&gt;</span><span class="n">nfs_client</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nfs4_session</span> <span class="o">*</span><span class="n">session</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">rsize</span><span class="p">,</span> <span class="n">wsize</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">nfs4_has_session</span><span class="p">(</span><span class="n">clp</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">session</span> <span class="o">=</span> <span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_session</span><span class="p">;</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">NFS4_SESSION_INITING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">session</span><span class="o">-&gt;</span><span class="n">session_state</span><span class="p">))</span> <span class="p">{</span>

		<span class="n">rsize</span> <span class="o">=</span> <span class="n">server</span><span class="o">-&gt;</span><span class="n">rsize</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rsize</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">rsize</span> <span class="o">=</span> <span class="n">NFS_MAX_FILE_IO_SIZE</span><span class="p">;</span>
		<span class="n">wsize</span> <span class="o">=</span> <span class="n">server</span><span class="o">-&gt;</span><span class="n">wsize</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">wsize</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">wsize</span> <span class="o">=</span> <span class="n">NFS_MAX_FILE_IO_SIZE</span><span class="p">;</span>

		<span class="n">session</span><span class="o">-&gt;</span><span class="n">fc_attrs</span><span class="p">.</span><span class="n">max_rqst_sz</span> <span class="o">=</span> <span class="n">wsize</span> <span class="o">+</span> <span class="n">nfs41_maxwrite_overhead</span><span class="p">;</span>
		<span class="n">session</span><span class="o">-&gt;</span><span class="n">fc_attrs</span><span class="p">.</span><span class="n">max_resp_sz</span> <span class="o">=</span> <span class="n">rsize</span> <span class="o">+</span> <span class="n">nfs41_maxread_overhead</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">nfs41_check_session_ready</span><span class="p">(</span><span class="n">clp</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">nfs4_init_ds_session</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs_client</span> <span class="o">*</span><span class="n">clp</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">lease_time</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfs4_session</span> <span class="o">*</span><span class="n">session</span> <span class="o">=</span> <span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_session</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">NFS4_SESSION_INITING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">session</span><span class="o">-&gt;</span><span class="n">session_state</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Do not set NFS_CS_CHECK_LEASE_TIME instead set the</span>
<span class="cm">		 * DS lease to be equal to the MDS lease.</span>
<span class="cm">		 */</span>
		<span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_lease_time</span> <span class="o">=</span> <span class="n">lease_time</span><span class="p">;</span>
		<span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_last_renewal</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_lock</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">nfs41_check_session_ready</span><span class="p">(</span><span class="n">clp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="cm">/* Test for the DS role */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_ds_client</span><span class="p">(</span><span class="n">clp</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">nfs4_init_ds_session</span><span class="p">);</span>


<span class="cm">/*</span>
<span class="cm"> * Renew the cl_session lease.</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">nfs4_sequence_data</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfs_client</span> <span class="o">*</span><span class="n">clp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nfs4_sequence_args</span> <span class="n">args</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nfs4_sequence_res</span> <span class="n">res</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">nfs41_sequence_release</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfs4_sequence_data</span> <span class="o">*</span><span class="n">calldata</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nfs_client</span> <span class="o">*</span><span class="n">clp</span> <span class="o">=</span> <span class="n">calldata</span><span class="o">-&gt;</span><span class="n">clp</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_count</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">nfs4_schedule_state_renewal</span><span class="p">(</span><span class="n">clp</span><span class="p">);</span>
	<span class="n">nfs_put_client</span><span class="p">(</span><span class="n">clp</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">calldata</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">nfs41_sequence_handle_errors</span><span class="p">(</span><span class="k">struct</span> <span class="n">rpc_task</span> <span class="o">*</span><span class="n">task</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nfs_client</span> <span class="o">*</span><span class="n">clp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span><span class="p">(</span><span class="n">task</span><span class="o">-&gt;</span><span class="n">tk_status</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="o">-</span><span class="n">NFS4ERR_DELAY</span>:
		<span class="n">rpc_delay</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="n">NFS4_POLL_RETRY_MAX</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">nfs4_schedule_lease_recovery</span><span class="p">(</span><span class="n">clp</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">nfs41_sequence_call_done</span><span class="p">(</span><span class="k">struct</span> <span class="n">rpc_task</span> <span class="o">*</span><span class="n">task</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfs4_sequence_data</span> <span class="o">*</span><span class="n">calldata</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nfs_client</span> <span class="o">*</span><span class="n">clp</span> <span class="o">=</span> <span class="n">calldata</span><span class="o">-&gt;</span><span class="n">clp</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">nfs41_sequence_done</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="n">task</span><span class="o">-&gt;</span><span class="n">tk_msg</span><span class="p">.</span><span class="n">rpc_resp</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">task</span><span class="o">-&gt;</span><span class="n">tk_status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s ERROR %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">task</span><span class="o">-&gt;</span><span class="n">tk_status</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_count</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">nfs41_sequence_handle_errors</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="n">clp</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rpc_restart_call_prepare</span><span class="p">(</span><span class="n">task</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s rpc_cred %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">task</span><span class="o">-&gt;</span><span class="n">tk_msg</span><span class="p">.</span><span class="n">rpc_cred</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;&lt;-- %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">nfs41_sequence_prepare</span><span class="p">(</span><span class="k">struct</span> <span class="n">rpc_task</span> <span class="o">*</span><span class="n">task</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfs4_sequence_data</span> <span class="o">*</span><span class="n">calldata</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nfs_client</span> <span class="o">*</span><span class="n">clp</span> <span class="o">=</span> <span class="n">calldata</span><span class="o">-&gt;</span><span class="n">clp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nfs4_sequence_args</span> <span class="o">*</span><span class="n">args</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nfs4_sequence_res</span> <span class="o">*</span><span class="n">res</span><span class="p">;</span>

	<span class="n">args</span> <span class="o">=</span> <span class="n">task</span><span class="o">-&gt;</span><span class="n">tk_msg</span><span class="p">.</span><span class="n">rpc_argp</span><span class="p">;</span>
	<span class="n">res</span> <span class="o">=</span> <span class="n">task</span><span class="o">-&gt;</span><span class="n">tk_msg</span><span class="p">.</span><span class="n">rpc_resp</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nfs41_setup_sequence</span><span class="p">(</span><span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_session</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">res</span><span class="p">,</span> <span class="n">task</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">rpc_call_start</span><span class="p">(</span><span class="n">task</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">rpc_call_ops</span> <span class="n">nfs41_sequence_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">rpc_call_done</span> <span class="o">=</span> <span class="n">nfs41_sequence_call_done</span><span class="p">,</span>
	<span class="p">.</span><span class="n">rpc_call_prepare</span> <span class="o">=</span> <span class="n">nfs41_sequence_prepare</span><span class="p">,</span>
	<span class="p">.</span><span class="n">rpc_release</span> <span class="o">=</span> <span class="n">nfs41_sequence_release</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">rpc_task</span> <span class="o">*</span><span class="nf">_nfs41_proc_sequence</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs_client</span> <span class="o">*</span><span class="n">clp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rpc_cred</span> <span class="o">*</span><span class="n">cred</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfs4_sequence_data</span> <span class="o">*</span><span class="n">calldata</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rpc_message</span> <span class="n">msg</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">rpc_proc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">nfs4_procedures</span><span class="p">[</span><span class="n">NFSPROC4_CLNT_SEQUENCE</span><span class="p">],</span>
		<span class="p">.</span><span class="n">rpc_cred</span> <span class="o">=</span> <span class="n">cred</span><span class="p">,</span>
	<span class="p">};</span>
	<span class="k">struct</span> <span class="n">rpc_task_setup</span> <span class="n">task_setup_data</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">rpc_client</span> <span class="o">=</span> <span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_rpcclient</span><span class="p">,</span>
		<span class="p">.</span><span class="n">rpc_message</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">msg</span><span class="p">,</span>
		<span class="p">.</span><span class="n">callback_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">nfs41_sequence_ops</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">RPC_TASK_ASYNC</span> <span class="o">|</span> <span class="n">RPC_TASK_SOFT</span><span class="p">,</span>
	<span class="p">};</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">atomic_inc_not_zero</span><span class="p">(</span><span class="o">&amp;</span><span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_count</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">EIO</span><span class="p">);</span>
	<span class="n">calldata</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">calldata</span><span class="p">),</span> <span class="n">GFP_NOFS</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">calldata</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">nfs_put_client</span><span class="p">(</span><span class="n">clp</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">ENOMEM</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">nfs41_init_sequence</span><span class="p">(</span><span class="o">&amp;</span><span class="n">calldata</span><span class="o">-&gt;</span><span class="n">args</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">calldata</span><span class="o">-&gt;</span><span class="n">res</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">msg</span><span class="p">.</span><span class="n">rpc_argp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">calldata</span><span class="o">-&gt;</span><span class="n">args</span><span class="p">;</span>
	<span class="n">msg</span><span class="p">.</span><span class="n">rpc_resp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">calldata</span><span class="o">-&gt;</span><span class="n">res</span><span class="p">;</span>
	<span class="n">calldata</span><span class="o">-&gt;</span><span class="n">clp</span> <span class="o">=</span> <span class="n">clp</span><span class="p">;</span>
	<span class="n">task_setup_data</span><span class="p">.</span><span class="n">callback_data</span> <span class="o">=</span> <span class="n">calldata</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">rpc_run_task</span><span class="p">(</span><span class="o">&amp;</span><span class="n">task_setup_data</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">nfs41_proc_async_sequence</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs_client</span> <span class="o">*</span><span class="n">clp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rpc_cred</span> <span class="o">*</span><span class="n">cred</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">renew_flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rpc_task</span> <span class="o">*</span><span class="n">task</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">renew_flags</span> <span class="o">&amp;</span> <span class="n">NFS4_RENEW_TIMEOUT</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">task</span> <span class="o">=</span> <span class="n">_nfs41_proc_sequence</span><span class="p">(</span><span class="n">clp</span><span class="p">,</span> <span class="n">cred</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">task</span><span class="p">))</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">task</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">rpc_put_task_async</span><span class="p">(</span><span class="n">task</span><span class="p">);</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;&lt;-- %s status=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">nfs4_proc_sequence</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs_client</span> <span class="o">*</span><span class="n">clp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rpc_cred</span> <span class="o">*</span><span class="n">cred</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rpc_task</span> <span class="o">*</span><span class="n">task</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">task</span> <span class="o">=</span> <span class="n">_nfs41_proc_sequence</span><span class="p">(</span><span class="n">clp</span><span class="p">,</span> <span class="n">cred</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">task</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">task</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">rpc_wait_for_completion_task</span><span class="p">(</span><span class="n">task</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">nfs4_sequence_res</span> <span class="o">*</span><span class="n">res</span> <span class="o">=</span> <span class="n">task</span><span class="o">-&gt;</span><span class="n">tk_msg</span><span class="p">.</span><span class="n">rpc_resp</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">task</span><span class="o">-&gt;</span><span class="n">tk_status</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">nfs41_handle_sequence_flag_errors</span><span class="p">(</span><span class="n">clp</span><span class="p">,</span> <span class="n">res</span><span class="o">-&gt;</span><span class="n">sr_status_flags</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">task</span><span class="o">-&gt;</span><span class="n">tk_status</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">rpc_put_task</span><span class="p">(</span><span class="n">task</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;&lt;-- %s status=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">nfs4_reclaim_complete_data</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfs_client</span> <span class="o">*</span><span class="n">clp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nfs41_reclaim_complete_args</span> <span class="n">arg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nfs41_reclaim_complete_res</span> <span class="n">res</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">nfs4_reclaim_complete_prepare</span><span class="p">(</span><span class="k">struct</span> <span class="n">rpc_task</span> <span class="o">*</span><span class="n">task</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfs4_reclaim_complete_data</span> <span class="o">*</span><span class="n">calldata</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>

	<span class="n">rpc_task_set_priority</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="n">RPC_PRIORITY_PRIVILEGED</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nfs41_setup_sequence</span><span class="p">(</span><span class="n">calldata</span><span class="o">-&gt;</span><span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_session</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="n">calldata</span><span class="o">-&gt;</span><span class="n">arg</span><span class="p">.</span><span class="n">seq_args</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="n">calldata</span><span class="o">-&gt;</span><span class="n">res</span><span class="p">.</span><span class="n">seq_res</span><span class="p">,</span> <span class="n">task</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">rpc_call_start</span><span class="p">(</span><span class="n">task</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">nfs41_reclaim_complete_handle_errors</span><span class="p">(</span><span class="k">struct</span> <span class="n">rpc_task</span> <span class="o">*</span><span class="n">task</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nfs_client</span> <span class="o">*</span><span class="n">clp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span><span class="p">(</span><span class="n">task</span><span class="o">-&gt;</span><span class="n">tk_status</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>:
	<span class="k">case</span> <span class="o">-</span><span class="n">NFS4ERR_COMPLETE_ALREADY</span>:
	<span class="k">case</span> <span class="o">-</span><span class="n">NFS4ERR_WRONG_CRED</span>: <span class="cm">/* What to do here? */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="o">-</span><span class="n">NFS4ERR_DELAY</span>:
		<span class="n">rpc_delay</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="n">NFS4_POLL_RETRY_MAX</span><span class="p">);</span>
		<span class="cm">/* fall through */</span>
	<span class="k">case</span> <span class="o">-</span><span class="n">NFS4ERR_RETRY_UNCACHED_REP</span>:
		<span class="k">return</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">nfs4_schedule_lease_recovery</span><span class="p">(</span><span class="n">clp</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">nfs4_reclaim_complete_done</span><span class="p">(</span><span class="k">struct</span> <span class="n">rpc_task</span> <span class="o">*</span><span class="n">task</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfs4_reclaim_complete_data</span> <span class="o">*</span><span class="n">calldata</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nfs_client</span> <span class="o">*</span><span class="n">clp</span> <span class="o">=</span> <span class="n">calldata</span><span class="o">-&gt;</span><span class="n">clp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nfs4_sequence_res</span> <span class="o">*</span><span class="n">res</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">calldata</span><span class="o">-&gt;</span><span class="n">res</span><span class="p">.</span><span class="n">seq_res</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;--&gt; %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">nfs41_sequence_done</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="n">res</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nfs41_reclaim_complete_handle_errors</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="n">clp</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rpc_restart_call_prepare</span><span class="p">(</span><span class="n">task</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;&lt;-- %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">nfs4_free_reclaim_complete_data</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfs4_reclaim_complete_data</span> <span class="o">*</span><span class="n">calldata</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">calldata</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">rpc_call_ops</span> <span class="n">nfs4_reclaim_complete_call_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">rpc_call_prepare</span> <span class="o">=</span> <span class="n">nfs4_reclaim_complete_prepare</span><span class="p">,</span>
	<span class="p">.</span><span class="n">rpc_call_done</span> <span class="o">=</span> <span class="n">nfs4_reclaim_complete_done</span><span class="p">,</span>
	<span class="p">.</span><span class="n">rpc_release</span> <span class="o">=</span> <span class="n">nfs4_free_reclaim_complete_data</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * Issue a global reclaim complete.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">nfs41_proc_reclaim_complete</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs_client</span> <span class="o">*</span><span class="n">clp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfs4_reclaim_complete_data</span> <span class="o">*</span><span class="n">calldata</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rpc_task</span> <span class="o">*</span><span class="n">task</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rpc_message</span> <span class="n">msg</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">rpc_proc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">nfs4_procedures</span><span class="p">[</span><span class="n">NFSPROC4_CLNT_RECLAIM_COMPLETE</span><span class="p">],</span>
	<span class="p">};</span>
	<span class="k">struct</span> <span class="n">rpc_task_setup</span> <span class="n">task_setup_data</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">rpc_client</span> <span class="o">=</span> <span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_rpcclient</span><span class="p">,</span>
		<span class="p">.</span><span class="n">rpc_message</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">msg</span><span class="p">,</span>
		<span class="p">.</span><span class="n">callback_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">nfs4_reclaim_complete_call_ops</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">RPC_TASK_ASYNC</span><span class="p">,</span>
	<span class="p">};</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;--&gt; %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="n">calldata</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">calldata</span><span class="p">),</span> <span class="n">GFP_NOFS</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">calldata</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="n">calldata</span><span class="o">-&gt;</span><span class="n">clp</span> <span class="o">=</span> <span class="n">clp</span><span class="p">;</span>
	<span class="n">calldata</span><span class="o">-&gt;</span><span class="n">arg</span><span class="p">.</span><span class="n">one_fs</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">nfs41_init_sequence</span><span class="p">(</span><span class="o">&amp;</span><span class="n">calldata</span><span class="o">-&gt;</span><span class="n">arg</span><span class="p">.</span><span class="n">seq_args</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">calldata</span><span class="o">-&gt;</span><span class="n">res</span><span class="p">.</span><span class="n">seq_res</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">msg</span><span class="p">.</span><span class="n">rpc_argp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">calldata</span><span class="o">-&gt;</span><span class="n">arg</span><span class="p">;</span>
	<span class="n">msg</span><span class="p">.</span><span class="n">rpc_resp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">calldata</span><span class="o">-&gt;</span><span class="n">res</span><span class="p">;</span>
	<span class="n">task_setup_data</span><span class="p">.</span><span class="n">callback_data</span> <span class="o">=</span> <span class="n">calldata</span><span class="p">;</span>
	<span class="n">task</span> <span class="o">=</span> <span class="n">rpc_run_task</span><span class="p">(</span><span class="o">&amp;</span><span class="n">task_setup_data</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">task</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">task</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">nfs4_wait_for_completion_rpc_task</span><span class="p">(</span><span class="n">task</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">task</span><span class="o">-&gt;</span><span class="n">tk_status</span><span class="p">;</span>
	<span class="n">rpc_put_task</span><span class="p">(</span><span class="n">task</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">out:</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;&lt;-- %s status=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">nfs4_layoutget_prepare</span><span class="p">(</span><span class="k">struct</span> <span class="n">rpc_task</span> <span class="o">*</span><span class="n">task</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">calldata</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfs4_layoutget</span> <span class="o">*</span><span class="n">lgp</span> <span class="o">=</span> <span class="n">calldata</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nfs_server</span> <span class="o">*</span><span class="n">server</span> <span class="o">=</span> <span class="n">NFS_SERVER</span><span class="p">(</span><span class="n">lgp</span><span class="o">-&gt;</span><span class="n">args</span><span class="p">.</span><span class="n">inode</span><span class="p">);</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;--&gt; %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="cm">/* Note the is a race here, where a CB_LAYOUTRECALL can come in</span>
<span class="cm">	 * right now covering the LAYOUTGET we are about to send.</span>
<span class="cm">	 * However, that is not so catastrophic, and there seems</span>
<span class="cm">	 * to be no way to prevent it completely.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nfs4_setup_sequence</span><span class="p">(</span><span class="n">server</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">lgp</span><span class="o">-&gt;</span><span class="n">args</span><span class="p">.</span><span class="n">seq_args</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="n">lgp</span><span class="o">-&gt;</span><span class="n">res</span><span class="p">.</span><span class="n">seq_res</span><span class="p">,</span> <span class="n">task</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pnfs_choose_layoutget_stateid</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lgp</span><span class="o">-&gt;</span><span class="n">args</span><span class="p">.</span><span class="n">stateid</span><span class="p">,</span>
					  <span class="n">NFS_I</span><span class="p">(</span><span class="n">lgp</span><span class="o">-&gt;</span><span class="n">args</span><span class="p">.</span><span class="n">inode</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">layout</span><span class="p">,</span>
					  <span class="n">lgp</span><span class="o">-&gt;</span><span class="n">args</span><span class="p">.</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">rpc_exit</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="n">NFS4_OK</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">rpc_call_start</span><span class="p">(</span><span class="n">task</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">nfs4_layoutget_done</span><span class="p">(</span><span class="k">struct</span> <span class="n">rpc_task</span> <span class="o">*</span><span class="n">task</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">calldata</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfs4_layoutget</span> <span class="o">*</span><span class="n">lgp</span> <span class="o">=</span> <span class="n">calldata</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nfs_server</span> <span class="o">*</span><span class="n">server</span> <span class="o">=</span> <span class="n">NFS_SERVER</span><span class="p">(</span><span class="n">lgp</span><span class="o">-&gt;</span><span class="n">args</span><span class="p">.</span><span class="n">inode</span><span class="p">);</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;--&gt; %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">nfs4_sequence_done</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">lgp</span><span class="o">-&gt;</span><span class="n">res</span><span class="p">.</span><span class="n">seq_res</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">task</span><span class="o">-&gt;</span><span class="n">tk_status</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="o">-</span><span class="n">NFS4ERR_LAYOUTTRYLATER</span>:
	<span class="k">case</span> <span class="o">-</span><span class="n">NFS4ERR_RECALLCONFLICT</span>:
		<span class="n">task</span><span class="o">-&gt;</span><span class="n">tk_status</span> <span class="o">=</span> <span class="o">-</span><span class="n">NFS4ERR_DELAY</span><span class="p">;</span>
		<span class="cm">/* Fall through */</span>
	<span class="nl">default:</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">nfs4_async_handle_error</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="n">server</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rpc_restart_call_prepare</span><span class="p">(</span><span class="n">task</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;&lt;-- %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">nfs4_layoutget_release</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">calldata</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfs4_layoutget</span> <span class="o">*</span><span class="n">lgp</span> <span class="o">=</span> <span class="n">calldata</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;--&gt; %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="n">put_nfs_open_context</span><span class="p">(</span><span class="n">lgp</span><span class="o">-&gt;</span><span class="n">args</span><span class="p">.</span><span class="n">ctx</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">calldata</span><span class="p">);</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;&lt;-- %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">rpc_call_ops</span> <span class="n">nfs4_layoutget_call_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">rpc_call_prepare</span> <span class="o">=</span> <span class="n">nfs4_layoutget_prepare</span><span class="p">,</span>
	<span class="p">.</span><span class="n">rpc_call_done</span> <span class="o">=</span> <span class="n">nfs4_layoutget_done</span><span class="p">,</span>
	<span class="p">.</span><span class="n">rpc_release</span> <span class="o">=</span> <span class="n">nfs4_layoutget_release</span><span class="p">,</span>
<span class="p">};</span>

<span class="kt">int</span> <span class="nf">nfs4_proc_layoutget</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs4_layoutget</span> <span class="o">*</span><span class="n">lgp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfs_server</span> <span class="o">*</span><span class="n">server</span> <span class="o">=</span> <span class="n">NFS_SERVER</span><span class="p">(</span><span class="n">lgp</span><span class="o">-&gt;</span><span class="n">args</span><span class="p">.</span><span class="n">inode</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">rpc_task</span> <span class="o">*</span><span class="n">task</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rpc_message</span> <span class="n">msg</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">rpc_proc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">nfs4_procedures</span><span class="p">[</span><span class="n">NFSPROC4_CLNT_LAYOUTGET</span><span class="p">],</span>
		<span class="p">.</span><span class="n">rpc_argp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">lgp</span><span class="o">-&gt;</span><span class="n">args</span><span class="p">,</span>
		<span class="p">.</span><span class="n">rpc_resp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">lgp</span><span class="o">-&gt;</span><span class="n">res</span><span class="p">,</span>
	<span class="p">};</span>
	<span class="k">struct</span> <span class="n">rpc_task_setup</span> <span class="n">task_setup_data</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">rpc_client</span> <span class="o">=</span> <span class="n">server</span><span class="o">-&gt;</span><span class="n">client</span><span class="p">,</span>
		<span class="p">.</span><span class="n">rpc_message</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">msg</span><span class="p">,</span>
		<span class="p">.</span><span class="n">callback_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">nfs4_layoutget_call_ops</span><span class="p">,</span>
		<span class="p">.</span><span class="n">callback_data</span> <span class="o">=</span> <span class="n">lgp</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">RPC_TASK_ASYNC</span><span class="p">,</span>
	<span class="p">};</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;--&gt; %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="n">lgp</span><span class="o">-&gt;</span><span class="n">res</span><span class="p">.</span><span class="n">layoutp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">lgp</span><span class="o">-&gt;</span><span class="n">args</span><span class="p">.</span><span class="n">layout</span><span class="p">;</span>
	<span class="n">lgp</span><span class="o">-&gt;</span><span class="n">res</span><span class="p">.</span><span class="n">seq_res</span><span class="p">.</span><span class="n">sr_slot</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">nfs41_init_sequence</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lgp</span><span class="o">-&gt;</span><span class="n">args</span><span class="p">.</span><span class="n">seq_args</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">lgp</span><span class="o">-&gt;</span><span class="n">res</span><span class="p">.</span><span class="n">seq_res</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">task</span> <span class="o">=</span> <span class="n">rpc_run_task</span><span class="p">(</span><span class="o">&amp;</span><span class="n">task_setup_data</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">task</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">task</span><span class="p">);</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">nfs4_wait_for_completion_rpc_task</span><span class="p">(</span><span class="n">task</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">task</span><span class="o">-&gt;</span><span class="n">tk_status</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">pnfs_layout_process</span><span class="p">(</span><span class="n">lgp</span><span class="p">);</span>
	<span class="n">rpc_put_task</span><span class="p">(</span><span class="n">task</span><span class="p">);</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;&lt;-- %s status=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">nfs4_layoutreturn_prepare</span><span class="p">(</span><span class="k">struct</span> <span class="n">rpc_task</span> <span class="o">*</span><span class="n">task</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">calldata</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfs4_layoutreturn</span> <span class="o">*</span><span class="n">lrp</span> <span class="o">=</span> <span class="n">calldata</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;--&gt; %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nfs41_setup_sequence</span><span class="p">(</span><span class="n">lrp</span><span class="o">-&gt;</span><span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_session</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">lrp</span><span class="o">-&gt;</span><span class="n">args</span><span class="p">.</span><span class="n">seq_args</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="n">lrp</span><span class="o">-&gt;</span><span class="n">res</span><span class="p">.</span><span class="n">seq_res</span><span class="p">,</span> <span class="n">task</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">rpc_call_start</span><span class="p">(</span><span class="n">task</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">nfs4_layoutreturn_done</span><span class="p">(</span><span class="k">struct</span> <span class="n">rpc_task</span> <span class="o">*</span><span class="n">task</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">calldata</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfs4_layoutreturn</span> <span class="o">*</span><span class="n">lrp</span> <span class="o">=</span> <span class="n">calldata</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nfs_server</span> <span class="o">*</span><span class="n">server</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pnfs_layout_hdr</span> <span class="o">*</span><span class="n">lo</span> <span class="o">=</span> <span class="n">lrp</span><span class="o">-&gt;</span><span class="n">args</span><span class="p">.</span><span class="n">layout</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;--&gt; %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">nfs4_sequence_done</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">lrp</span><span class="o">-&gt;</span><span class="n">res</span><span class="p">.</span><span class="n">seq_res</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">server</span> <span class="o">=</span> <span class="n">NFS_SERVER</span><span class="p">(</span><span class="n">lrp</span><span class="o">-&gt;</span><span class="n">args</span><span class="p">.</span><span class="n">inode</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nfs4_async_handle_error</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="n">server</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rpc_restart_call_prepare</span><span class="p">(</span><span class="n">task</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lo</span><span class="o">-&gt;</span><span class="n">plh_inode</span><span class="o">-&gt;</span><span class="n">i_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">task</span><span class="o">-&gt;</span><span class="n">tk_status</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">lrp</span><span class="o">-&gt;</span><span class="n">res</span><span class="p">.</span><span class="n">lrs_present</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pnfs_set_layout_stateid</span><span class="p">(</span><span class="n">lo</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">lrp</span><span class="o">-&gt;</span><span class="n">res</span><span class="p">.</span><span class="n">stateid</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lo</span><span class="o">-&gt;</span><span class="n">plh_segs</span><span class="p">));</span>
	<span class="p">}</span>
	<span class="n">lo</span><span class="o">-&gt;</span><span class="n">plh_block_lgets</span><span class="o">--</span><span class="p">;</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lo</span><span class="o">-&gt;</span><span class="n">plh_inode</span><span class="o">-&gt;</span><span class="n">i_lock</span><span class="p">);</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;&lt;-- %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">nfs4_layoutreturn_release</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">calldata</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfs4_layoutreturn</span> <span class="o">*</span><span class="n">lrp</span> <span class="o">=</span> <span class="n">calldata</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;--&gt; %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="n">put_layout_hdr</span><span class="p">(</span><span class="n">lrp</span><span class="o">-&gt;</span><span class="n">args</span><span class="p">.</span><span class="n">layout</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">calldata</span><span class="p">);</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;&lt;-- %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">rpc_call_ops</span> <span class="n">nfs4_layoutreturn_call_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">rpc_call_prepare</span> <span class="o">=</span> <span class="n">nfs4_layoutreturn_prepare</span><span class="p">,</span>
	<span class="p">.</span><span class="n">rpc_call_done</span> <span class="o">=</span> <span class="n">nfs4_layoutreturn_done</span><span class="p">,</span>
	<span class="p">.</span><span class="n">rpc_release</span> <span class="o">=</span> <span class="n">nfs4_layoutreturn_release</span><span class="p">,</span>
<span class="p">};</span>

<span class="kt">int</span> <span class="nf">nfs4_proc_layoutreturn</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs4_layoutreturn</span> <span class="o">*</span><span class="n">lrp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rpc_task</span> <span class="o">*</span><span class="n">task</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rpc_message</span> <span class="n">msg</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">rpc_proc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">nfs4_procedures</span><span class="p">[</span><span class="n">NFSPROC4_CLNT_LAYOUTRETURN</span><span class="p">],</span>
		<span class="p">.</span><span class="n">rpc_argp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">lrp</span><span class="o">-&gt;</span><span class="n">args</span><span class="p">,</span>
		<span class="p">.</span><span class="n">rpc_resp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">lrp</span><span class="o">-&gt;</span><span class="n">res</span><span class="p">,</span>
	<span class="p">};</span>
	<span class="k">struct</span> <span class="n">rpc_task_setup</span> <span class="n">task_setup_data</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">rpc_client</span> <span class="o">=</span> <span class="n">lrp</span><span class="o">-&gt;</span><span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_rpcclient</span><span class="p">,</span>
		<span class="p">.</span><span class="n">rpc_message</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">msg</span><span class="p">,</span>
		<span class="p">.</span><span class="n">callback_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">nfs4_layoutreturn_call_ops</span><span class="p">,</span>
		<span class="p">.</span><span class="n">callback_data</span> <span class="o">=</span> <span class="n">lrp</span><span class="p">,</span>
	<span class="p">};</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;--&gt; %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="n">nfs41_init_sequence</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lrp</span><span class="o">-&gt;</span><span class="n">args</span><span class="p">.</span><span class="n">seq_args</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">lrp</span><span class="o">-&gt;</span><span class="n">res</span><span class="p">.</span><span class="n">seq_res</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">task</span> <span class="o">=</span> <span class="n">rpc_run_task</span><span class="p">(</span><span class="o">&amp;</span><span class="n">task_setup_data</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">task</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">task</span><span class="p">);</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">task</span><span class="o">-&gt;</span><span class="n">tk_status</span><span class="p">;</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;&lt;-- %s status=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
	<span class="n">rpc_put_task</span><span class="p">(</span><span class="n">task</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Retrieve the list of Data Server devices from the MDS.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">_nfs4_getdevicelist</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs_server</span> <span class="o">*</span><span class="n">server</span><span class="p">,</span>
				    <span class="k">const</span> <span class="k">struct</span> <span class="n">nfs_fh</span> <span class="o">*</span><span class="n">fh</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">pnfs_devicelist</span> <span class="o">*</span><span class="n">devlist</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfs4_getdevicelist_args</span> <span class="n">args</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">fh</span> <span class="o">=</span> <span class="n">fh</span><span class="p">,</span>
		<span class="p">.</span><span class="n">layoutclass</span> <span class="o">=</span> <span class="n">server</span><span class="o">-&gt;</span><span class="n">pnfs_curr_ld</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span>
	<span class="p">};</span>
	<span class="k">struct</span> <span class="n">nfs4_getdevicelist_res</span> <span class="n">res</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">devlist</span> <span class="o">=</span> <span class="n">devlist</span><span class="p">,</span>
	<span class="p">};</span>
	<span class="k">struct</span> <span class="n">rpc_message</span> <span class="n">msg</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">rpc_proc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">nfs4_procedures</span><span class="p">[</span><span class="n">NFSPROC4_CLNT_GETDEVICELIST</span><span class="p">],</span>
		<span class="p">.</span><span class="n">rpc_argp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">args</span><span class="p">,</span>
		<span class="p">.</span><span class="n">rpc_resp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">res</span><span class="p">,</span>
	<span class="p">};</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;--&gt; %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">nfs4_call_sync</span><span class="p">(</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">client</span><span class="p">,</span> <span class="n">server</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">msg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">args</span><span class="p">.</span><span class="n">seq_args</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="n">res</span><span class="p">.</span><span class="n">seq_res</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;&lt;-- %s status=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">nfs4_proc_getdevicelist</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs_server</span> <span class="o">*</span><span class="n">server</span><span class="p">,</span>
			    <span class="k">const</span> <span class="k">struct</span> <span class="n">nfs_fh</span> <span class="o">*</span><span class="n">fh</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">pnfs_devicelist</span> <span class="o">*</span><span class="n">devlist</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfs4_exception</span> <span class="n">exception</span> <span class="o">=</span> <span class="p">{</span> <span class="p">};</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">nfs4_handle_exception</span><span class="p">(</span><span class="n">server</span><span class="p">,</span>
				<span class="n">_nfs4_getdevicelist</span><span class="p">(</span><span class="n">server</span><span class="p">,</span> <span class="n">fh</span><span class="p">,</span> <span class="n">devlist</span><span class="p">),</span>
				<span class="o">&amp;</span><span class="n">exception</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">exception</span><span class="p">.</span><span class="n">retry</span><span class="p">);</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s: err=%d, num_devs=%u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
		<span class="n">err</span><span class="p">,</span> <span class="n">devlist</span><span class="o">-&gt;</span><span class="n">num_devs</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">nfs4_proc_getdevicelist</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">_nfs4_proc_getdeviceinfo</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs_server</span> <span class="o">*</span><span class="n">server</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pnfs_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfs4_getdeviceinfo_args</span> <span class="n">args</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">pdev</span><span class="p">,</span>
	<span class="p">};</span>
	<span class="k">struct</span> <span class="n">nfs4_getdeviceinfo_res</span> <span class="n">res</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">pdev</span><span class="p">,</span>
	<span class="p">};</span>
	<span class="k">struct</span> <span class="n">rpc_message</span> <span class="n">msg</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">rpc_proc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">nfs4_procedures</span><span class="p">[</span><span class="n">NFSPROC4_CLNT_GETDEVICEINFO</span><span class="p">],</span>
		<span class="p">.</span><span class="n">rpc_argp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">args</span><span class="p">,</span>
		<span class="p">.</span><span class="n">rpc_resp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">res</span><span class="p">,</span>
	<span class="p">};</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;--&gt; %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">nfs4_call_sync</span><span class="p">(</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">client</span><span class="p">,</span> <span class="n">server</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">msg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">args</span><span class="p">.</span><span class="n">seq_args</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">res</span><span class="p">.</span><span class="n">seq_res</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;&lt;-- %s status=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">nfs4_proc_getdeviceinfo</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs_server</span> <span class="o">*</span><span class="n">server</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pnfs_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfs4_exception</span> <span class="n">exception</span> <span class="o">=</span> <span class="p">{</span> <span class="p">};</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">nfs4_handle_exception</span><span class="p">(</span><span class="n">server</span><span class="p">,</span>
					<span class="n">_nfs4_proc_getdeviceinfo</span><span class="p">(</span><span class="n">server</span><span class="p">,</span> <span class="n">pdev</span><span class="p">),</span>
					<span class="o">&amp;</span><span class="n">exception</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">exception</span><span class="p">.</span><span class="n">retry</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">nfs4_proc_getdeviceinfo</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">nfs4_layoutcommit_prepare</span><span class="p">(</span><span class="k">struct</span> <span class="n">rpc_task</span> <span class="o">*</span><span class="n">task</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">calldata</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfs4_layoutcommit_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">calldata</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nfs_server</span> <span class="o">*</span><span class="n">server</span> <span class="o">=</span> <span class="n">NFS_SERVER</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">args</span><span class="p">.</span><span class="n">inode</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nfs4_setup_sequence</span><span class="p">(</span><span class="n">server</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">args</span><span class="p">.</span><span class="n">seq_args</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">res</span><span class="p">.</span><span class="n">seq_res</span><span class="p">,</span> <span class="n">task</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">rpc_call_start</span><span class="p">(</span><span class="n">task</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">nfs4_layoutcommit_done</span><span class="p">(</span><span class="k">struct</span> <span class="n">rpc_task</span> <span class="o">*</span><span class="n">task</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">calldata</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfs4_layoutcommit_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">calldata</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nfs_server</span> <span class="o">*</span><span class="n">server</span> <span class="o">=</span> <span class="n">NFS_SERVER</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">args</span><span class="p">.</span><span class="n">inode</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">nfs4_sequence_done</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">res</span><span class="p">.</span><span class="n">seq_res</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">task</span><span class="o">-&gt;</span><span class="n">tk_status</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* Just ignore these failures */</span>
	<span class="k">case</span> <span class="o">-</span><span class="n">NFS4ERR_DELEG_REVOKED</span>: <span class="cm">/* layout was recalled */</span>
	<span class="k">case</span> <span class="o">-</span><span class="n">NFS4ERR_BADIOMODE</span>:     <span class="cm">/* no IOMODE_RW layout for range */</span>
	<span class="k">case</span> <span class="o">-</span><span class="n">NFS4ERR_BADLAYOUT</span>:     <span class="cm">/* no layout */</span>
	<span class="k">case</span> <span class="o">-</span><span class="n">NFS4ERR_GRACE</span>:	    <span class="cm">/* loca_recalim always false */</span>
		<span class="n">task</span><span class="o">-&gt;</span><span class="n">tk_status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">0</span>:
		<span class="n">nfs_post_op_update_inode_force_wcc</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">args</span><span class="p">.</span><span class="n">inode</span><span class="p">,</span>
						   <span class="n">data</span><span class="o">-&gt;</span><span class="n">res</span><span class="p">.</span><span class="n">fattr</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">nfs4_async_handle_error</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="n">server</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rpc_restart_call_prepare</span><span class="p">(</span><span class="n">task</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">nfs4_layoutcommit_release</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">calldata</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfs4_layoutcommit_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">calldata</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pnfs_layout_segment</span> <span class="o">*</span><span class="n">lseg</span><span class="p">,</span> <span class="o">*</span><span class="n">tmp</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">bitlock</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">NFS_I</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">args</span><span class="p">.</span><span class="n">inode</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">;</span>

	<span class="n">pnfs_cleanup_layoutcommit</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>
	<span class="cm">/* Matched by references in pnfs_set_layoutcommit */</span>
	<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">lseg</span><span class="p">,</span> <span class="n">tmp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">lseg_list</span><span class="p">,</span> <span class="n">pls_lc_list</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">list_del_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lseg</span><span class="o">-&gt;</span><span class="n">pls_lc_list</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">NFS_LSEG_LAYOUTCOMMIT</span><span class="p">,</span>
				       <span class="o">&amp;</span><span class="n">lseg</span><span class="o">-&gt;</span><span class="n">pls_flags</span><span class="p">))</span>
			<span class="n">put_lseg</span><span class="p">(</span><span class="n">lseg</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">clear_bit_unlock</span><span class="p">(</span><span class="n">NFS_INO_LAYOUTCOMMITTING</span><span class="p">,</span> <span class="n">bitlock</span><span class="p">);</span>
	<span class="n">smp_mb__after_clear_bit</span><span class="p">();</span>
	<span class="n">wake_up_bit</span><span class="p">(</span><span class="n">bitlock</span><span class="p">,</span> <span class="n">NFS_INO_LAYOUTCOMMITTING</span><span class="p">);</span>

	<span class="n">put_rpccred</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">cred</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">rpc_call_ops</span> <span class="n">nfs4_layoutcommit_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">rpc_call_prepare</span> <span class="o">=</span> <span class="n">nfs4_layoutcommit_prepare</span><span class="p">,</span>
	<span class="p">.</span><span class="n">rpc_call_done</span> <span class="o">=</span> <span class="n">nfs4_layoutcommit_done</span><span class="p">,</span>
	<span class="p">.</span><span class="n">rpc_release</span> <span class="o">=</span> <span class="n">nfs4_layoutcommit_release</span><span class="p">,</span>
<span class="p">};</span>

<span class="kt">int</span>
<span class="nf">nfs4_proc_layoutcommit</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs4_layoutcommit_data</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="n">bool</span> <span class="n">sync</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rpc_message</span> <span class="n">msg</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">rpc_proc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">nfs4_procedures</span><span class="p">[</span><span class="n">NFSPROC4_CLNT_LAYOUTCOMMIT</span><span class="p">],</span>
		<span class="p">.</span><span class="n">rpc_argp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">args</span><span class="p">,</span>
		<span class="p">.</span><span class="n">rpc_resp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">res</span><span class="p">,</span>
		<span class="p">.</span><span class="n">rpc_cred</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">cred</span><span class="p">,</span>
	<span class="p">};</span>
	<span class="k">struct</span> <span class="n">rpc_task_setup</span> <span class="n">task_setup_data</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">task</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">task</span><span class="p">,</span>
		<span class="p">.</span><span class="n">rpc_client</span> <span class="o">=</span> <span class="n">NFS_CLIENT</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">args</span><span class="p">.</span><span class="n">inode</span><span class="p">),</span>
		<span class="p">.</span><span class="n">rpc_message</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">msg</span><span class="p">,</span>
		<span class="p">.</span><span class="n">callback_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">nfs4_layoutcommit_ops</span><span class="p">,</span>
		<span class="p">.</span><span class="n">callback_data</span> <span class="o">=</span> <span class="n">data</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">RPC_TASK_ASYNC</span><span class="p">,</span>
	<span class="p">};</span>
	<span class="k">struct</span> <span class="n">rpc_task</span> <span class="o">*</span><span class="n">task</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;NFS: %4d initiating layoutcommit call. sync %d &quot;</span>
		<span class="s">&quot;lbw: %llu inode %lu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">task</span><span class="p">.</span><span class="n">tk_pid</span><span class="p">,</span> <span class="n">sync</span><span class="p">,</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">args</span><span class="p">.</span><span class="n">lastbytewritten</span><span class="p">,</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">args</span><span class="p">.</span><span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_ino</span><span class="p">);</span>

	<span class="n">nfs41_init_sequence</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">args</span><span class="p">.</span><span class="n">seq_args</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">res</span><span class="p">.</span><span class="n">seq_res</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">task</span> <span class="o">=</span> <span class="n">rpc_run_task</span><span class="p">(</span><span class="o">&amp;</span><span class="n">task_setup_data</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">task</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">task</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sync</span> <span class="o">==</span> <span class="nb">false</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">nfs4_wait_for_completion_rpc_task</span><span class="p">(</span><span class="n">task</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">task</span><span class="o">-&gt;</span><span class="n">tk_status</span><span class="p">;</span>
<span class="nl">out:</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s: status %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
	<span class="n">rpc_put_task</span><span class="p">(</span><span class="n">task</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">_nfs41_proc_secinfo_no_name</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs_server</span> <span class="o">*</span><span class="n">server</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nfs_fh</span> <span class="o">*</span><span class="n">fhandle</span><span class="p">,</span>
		    <span class="k">struct</span> <span class="n">nfs_fsinfo</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nfs4_secinfo_flavors</span> <span class="o">*</span><span class="n">flavors</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfs41_secinfo_no_name_args</span> <span class="n">args</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">style</span> <span class="o">=</span> <span class="n">SECINFO_STYLE_CURRENT_FH</span><span class="p">,</span>
	<span class="p">};</span>
	<span class="k">struct</span> <span class="n">nfs4_secinfo_res</span> <span class="n">res</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">flavors</span> <span class="o">=</span> <span class="n">flavors</span><span class="p">,</span>
	<span class="p">};</span>
	<span class="k">struct</span> <span class="n">rpc_message</span> <span class="n">msg</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">rpc_proc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">nfs4_procedures</span><span class="p">[</span><span class="n">NFSPROC4_CLNT_SECINFO_NO_NAME</span><span class="p">],</span>
		<span class="p">.</span><span class="n">rpc_argp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">args</span><span class="p">,</span>
		<span class="p">.</span><span class="n">rpc_resp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">res</span><span class="p">,</span>
	<span class="p">};</span>
	<span class="k">return</span> <span class="n">nfs4_call_sync</span><span class="p">(</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">client</span><span class="p">,</span> <span class="n">server</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">msg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">args</span><span class="p">.</span><span class="n">seq_args</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">res</span><span class="p">.</span><span class="n">seq_res</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">nfs41_proc_secinfo_no_name</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs_server</span> <span class="o">*</span><span class="n">server</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nfs_fh</span> <span class="o">*</span><span class="n">fhandle</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">nfs_fsinfo</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nfs4_secinfo_flavors</span> <span class="o">*</span><span class="n">flavors</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfs4_exception</span> <span class="n">exception</span> <span class="o">=</span> <span class="p">{</span> <span class="p">};</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">_nfs41_proc_secinfo_no_name</span><span class="p">(</span><span class="n">server</span><span class="p">,</span> <span class="n">fhandle</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="n">flavors</span><span class="p">);</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">0</span>:
		<span class="k">case</span> <span class="o">-</span><span class="n">NFS4ERR_WRONGSEC</span>:
		<span class="k">case</span> <span class="o">-</span><span class="n">NFS4ERR_NOTSUPP</span>:
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">nfs4_handle_exception</span><span class="p">(</span><span class="n">server</span><span class="p">,</span> <span class="n">err</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">exception</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">exception</span><span class="p">.</span><span class="n">retry</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">nfs41_find_root_sec</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs_server</span> <span class="o">*</span><span class="n">server</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nfs_fh</span> <span class="o">*</span><span class="n">fhandle</span><span class="p">,</span>
		    <span class="k">struct</span> <span class="n">nfs_fsinfo</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="n">page</span><span class="p">;</span>
	<span class="n">rpc_authflavor_t</span> <span class="n">flavor</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nfs4_secinfo_flavors</span> <span class="o">*</span><span class="n">flavors</span><span class="p">;</span>

	<span class="n">page</span> <span class="o">=</span> <span class="n">alloc_page</span><span class="p">(</span><span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">page</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">flavors</span> <span class="o">=</span> <span class="n">page_address</span><span class="p">(</span><span class="n">page</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">nfs41_proc_secinfo_no_name</span><span class="p">(</span><span class="n">server</span><span class="p">,</span> <span class="n">fhandle</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="n">flavors</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Fall back on &quot;guess and check&quot; method if</span>
<span class="cm">	 * the server doesn&#39;t support SECINFO_NO_NAME</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">==</span> <span class="o">-</span><span class="n">NFS4ERR_WRONGSEC</span> <span class="o">||</span> <span class="n">err</span> <span class="o">==</span> <span class="o">-</span><span class="n">NFS4ERR_NOTSUPP</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">nfs4_find_root_sec</span><span class="p">(</span><span class="n">server</span><span class="p">,</span> <span class="n">fhandle</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_freepage</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_freepage</span><span class="p">;</span>

	<span class="n">flavor</span> <span class="o">=</span> <span class="n">nfs_find_best_sec</span><span class="p">(</span><span class="n">flavors</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">nfs4_lookup_root_sec</span><span class="p">(</span><span class="n">server</span><span class="p">,</span> <span class="n">fhandle</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="n">flavor</span><span class="p">);</span>

<span class="nl">out_freepage:</span>
	<span class="n">put_page</span><span class="p">(</span><span class="n">page</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">==</span> <span class="o">-</span><span class="n">EACCES</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">_nfs41_test_stateid</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs_server</span> <span class="o">*</span><span class="n">server</span><span class="p">,</span> <span class="n">nfs4_stateid</span> <span class="o">*</span><span class="n">stateid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nfs41_test_stateid_args</span> <span class="n">args</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">stateid</span> <span class="o">=</span> <span class="n">stateid</span><span class="p">,</span>
	<span class="p">};</span>
	<span class="k">struct</span> <span class="n">nfs41_test_stateid_res</span> <span class="n">res</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rpc_message</span> <span class="n">msg</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">rpc_proc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">nfs4_procedures</span><span class="p">[</span><span class="n">NFSPROC4_CLNT_TEST_STATEID</span><span class="p">],</span>
		<span class="p">.</span><span class="n">rpc_argp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">args</span><span class="p">,</span>
		<span class="p">.</span><span class="n">rpc_resp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">res</span><span class="p">,</span>
	<span class="p">};</span>

	<span class="n">nfs41_init_sequence</span><span class="p">(</span><span class="o">&amp;</span><span class="n">args</span><span class="p">.</span><span class="n">seq_args</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">res</span><span class="p">.</span><span class="n">seq_res</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">nfs4_call_sync_sequence</span><span class="p">(</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">client</span><span class="p">,</span> <span class="n">server</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">msg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">args</span><span class="p">.</span><span class="n">seq_args</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">res</span><span class="p">.</span><span class="n">seq_res</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="n">NFS_OK</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">res</span><span class="p">.</span><span class="n">status</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">nfs41_test_stateid</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs_server</span> <span class="o">*</span><span class="n">server</span><span class="p">,</span> <span class="n">nfs4_stateid</span> <span class="o">*</span><span class="n">stateid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfs4_exception</span> <span class="n">exception</span> <span class="o">=</span> <span class="p">{</span> <span class="p">};</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">nfs4_handle_exception</span><span class="p">(</span><span class="n">server</span><span class="p">,</span>
				<span class="n">_nfs41_test_stateid</span><span class="p">(</span><span class="n">server</span><span class="p">,</span> <span class="n">stateid</span><span class="p">),</span>
				<span class="o">&amp;</span><span class="n">exception</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">exception</span><span class="p">.</span><span class="n">retry</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">_nfs4_free_stateid</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs_server</span> <span class="o">*</span><span class="n">server</span><span class="p">,</span> <span class="n">nfs4_stateid</span> <span class="o">*</span><span class="n">stateid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfs41_free_stateid_args</span> <span class="n">args</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">stateid</span> <span class="o">=</span> <span class="n">stateid</span><span class="p">,</span>
	<span class="p">};</span>
	<span class="k">struct</span> <span class="n">nfs41_free_stateid_res</span> <span class="n">res</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rpc_message</span> <span class="n">msg</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">rpc_proc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">nfs4_procedures</span><span class="p">[</span><span class="n">NFSPROC4_CLNT_FREE_STATEID</span><span class="p">],</span>
		<span class="p">.</span><span class="n">rpc_argp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">args</span><span class="p">,</span>
		<span class="p">.</span><span class="n">rpc_resp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">res</span><span class="p">,</span>
	<span class="p">};</span>

	<span class="n">nfs41_init_sequence</span><span class="p">(</span><span class="o">&amp;</span><span class="n">args</span><span class="p">.</span><span class="n">seq_args</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">res</span><span class="p">.</span><span class="n">seq_res</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">nfs4_call_sync_sequence</span><span class="p">(</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">client</span><span class="p">,</span> <span class="n">server</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">msg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">args</span><span class="p">.</span><span class="n">seq_args</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">res</span><span class="p">.</span><span class="n">seq_res</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">nfs41_free_stateid</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs_server</span> <span class="o">*</span><span class="n">server</span><span class="p">,</span> <span class="n">nfs4_stateid</span> <span class="o">*</span><span class="n">stateid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfs4_exception</span> <span class="n">exception</span> <span class="o">=</span> <span class="p">{</span> <span class="p">};</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">nfs4_handle_exception</span><span class="p">(</span><span class="n">server</span><span class="p">,</span>
				<span class="n">_nfs4_free_stateid</span><span class="p">(</span><span class="n">server</span><span class="p">,</span> <span class="n">stateid</span><span class="p">),</span>
				<span class="o">&amp;</span><span class="n">exception</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">exception</span><span class="p">.</span><span class="n">retry</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">nfs41_match_stateid</span><span class="p">(</span><span class="k">const</span> <span class="n">nfs4_stateid</span> <span class="o">*</span><span class="n">s1</span><span class="p">,</span>
		<span class="k">const</span> <span class="n">nfs4_stateid</span> <span class="o">*</span><span class="n">s2</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">memcmp</span><span class="p">(</span><span class="n">s1</span><span class="o">-&gt;</span><span class="n">other</span><span class="p">,</span> <span class="n">s2</span><span class="o">-&gt;</span><span class="n">other</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">s1</span><span class="o">-&gt;</span><span class="n">other</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">s1</span><span class="o">-&gt;</span><span class="n">seqid</span> <span class="o">==</span> <span class="n">s2</span><span class="o">-&gt;</span><span class="n">seqid</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">s1</span><span class="o">-&gt;</span><span class="n">seqid</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">s2</span><span class="o">-&gt;</span><span class="n">seqid</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>

	<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#endif </span><span class="cm">/* CONFIG_NFS_V4_1 */</span><span class="cp"></span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">nfs4_match_stateid</span><span class="p">(</span><span class="k">const</span> <span class="n">nfs4_stateid</span> <span class="o">*</span><span class="n">s1</span><span class="p">,</span>
		<span class="k">const</span> <span class="n">nfs4_stateid</span> <span class="o">*</span><span class="n">s2</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">nfs4_stateid_match</span><span class="p">(</span><span class="n">s1</span><span class="p">,</span> <span class="n">s2</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">nfs4_state_recovery_ops</span> <span class="n">nfs40_reboot_recovery_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">owner_flag_bit</span> <span class="o">=</span> <span class="n">NFS_OWNER_RECLAIM_REBOOT</span><span class="p">,</span>
	<span class="p">.</span><span class="n">state_flag_bit</span>	<span class="o">=</span> <span class="n">NFS_STATE_RECLAIM_REBOOT</span><span class="p">,</span>
	<span class="p">.</span><span class="n">recover_open</span>	<span class="o">=</span> <span class="n">nfs4_open_reclaim</span><span class="p">,</span>
	<span class="p">.</span><span class="n">recover_lock</span>	<span class="o">=</span> <span class="n">nfs4_lock_reclaim</span><span class="p">,</span>
	<span class="p">.</span><span class="n">establish_clid</span> <span class="o">=</span> <span class="n">nfs4_init_clientid</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_clid_cred</span>	<span class="o">=</span> <span class="n">nfs4_get_setclientid_cred</span><span class="p">,</span>
<span class="p">};</span>

<span class="cp">#if defined(CONFIG_NFS_V4_1)</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">nfs4_state_recovery_ops</span> <span class="n">nfs41_reboot_recovery_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">owner_flag_bit</span> <span class="o">=</span> <span class="n">NFS_OWNER_RECLAIM_REBOOT</span><span class="p">,</span>
	<span class="p">.</span><span class="n">state_flag_bit</span>	<span class="o">=</span> <span class="n">NFS_STATE_RECLAIM_REBOOT</span><span class="p">,</span>
	<span class="p">.</span><span class="n">recover_open</span>	<span class="o">=</span> <span class="n">nfs4_open_reclaim</span><span class="p">,</span>
	<span class="p">.</span><span class="n">recover_lock</span>	<span class="o">=</span> <span class="n">nfs4_lock_reclaim</span><span class="p">,</span>
	<span class="p">.</span><span class="n">establish_clid</span> <span class="o">=</span> <span class="n">nfs41_init_clientid</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_clid_cred</span>	<span class="o">=</span> <span class="n">nfs4_get_exchange_id_cred</span><span class="p">,</span>
	<span class="p">.</span><span class="n">reclaim_complete</span> <span class="o">=</span> <span class="n">nfs41_proc_reclaim_complete</span><span class="p">,</span>
<span class="p">};</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_NFS_V4_1 */</span><span class="cp"></span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">nfs4_state_recovery_ops</span> <span class="n">nfs40_nograce_recovery_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">owner_flag_bit</span> <span class="o">=</span> <span class="n">NFS_OWNER_RECLAIM_NOGRACE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">state_flag_bit</span>	<span class="o">=</span> <span class="n">NFS_STATE_RECLAIM_NOGRACE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">recover_open</span>	<span class="o">=</span> <span class="n">nfs4_open_expired</span><span class="p">,</span>
	<span class="p">.</span><span class="n">recover_lock</span>	<span class="o">=</span> <span class="n">nfs4_lock_expired</span><span class="p">,</span>
	<span class="p">.</span><span class="n">establish_clid</span> <span class="o">=</span> <span class="n">nfs4_init_clientid</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_clid_cred</span>	<span class="o">=</span> <span class="n">nfs4_get_setclientid_cred</span><span class="p">,</span>
<span class="p">};</span>

<span class="cp">#if defined(CONFIG_NFS_V4_1)</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">nfs4_state_recovery_ops</span> <span class="n">nfs41_nograce_recovery_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">owner_flag_bit</span> <span class="o">=</span> <span class="n">NFS_OWNER_RECLAIM_NOGRACE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">state_flag_bit</span>	<span class="o">=</span> <span class="n">NFS_STATE_RECLAIM_NOGRACE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">recover_open</span>	<span class="o">=</span> <span class="n">nfs41_open_expired</span><span class="p">,</span>
	<span class="p">.</span><span class="n">recover_lock</span>	<span class="o">=</span> <span class="n">nfs41_lock_expired</span><span class="p">,</span>
	<span class="p">.</span><span class="n">establish_clid</span> <span class="o">=</span> <span class="n">nfs41_init_clientid</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_clid_cred</span>	<span class="o">=</span> <span class="n">nfs4_get_exchange_id_cred</span><span class="p">,</span>
<span class="p">};</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_NFS_V4_1 */</span><span class="cp"></span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">nfs4_state_maintenance_ops</span> <span class="n">nfs40_state_renewal_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">sched_state_renewal</span> <span class="o">=</span> <span class="n">nfs4_proc_async_renew</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_state_renewal_cred_locked</span> <span class="o">=</span> <span class="n">nfs4_get_renew_cred_locked</span><span class="p">,</span>
	<span class="p">.</span><span class="n">renew_lease</span> <span class="o">=</span> <span class="n">nfs4_proc_renew</span><span class="p">,</span>
<span class="p">};</span>

<span class="cp">#if defined(CONFIG_NFS_V4_1)</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">nfs4_state_maintenance_ops</span> <span class="n">nfs41_state_renewal_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">sched_state_renewal</span> <span class="o">=</span> <span class="n">nfs41_proc_async_sequence</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_state_renewal_cred_locked</span> <span class="o">=</span> <span class="n">nfs4_get_machine_cred_locked</span><span class="p">,</span>
	<span class="p">.</span><span class="n">renew_lease</span> <span class="o">=</span> <span class="n">nfs4_proc_sequence</span><span class="p">,</span>
<span class="p">};</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">nfs4_minor_version_ops</span> <span class="n">nfs_v4_0_minor_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">minor_version</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">call_sync</span> <span class="o">=</span> <span class="n">_nfs4_call_sync</span><span class="p">,</span>
	<span class="p">.</span><span class="n">match_stateid</span> <span class="o">=</span> <span class="n">nfs4_match_stateid</span><span class="p">,</span>
	<span class="p">.</span><span class="n">find_root_sec</span> <span class="o">=</span> <span class="n">nfs4_find_root_sec</span><span class="p">,</span>
	<span class="p">.</span><span class="n">reboot_recovery_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">nfs40_reboot_recovery_ops</span><span class="p">,</span>
	<span class="p">.</span><span class="n">nograce_recovery_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">nfs40_nograce_recovery_ops</span><span class="p">,</span>
	<span class="p">.</span><span class="n">state_renewal_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">nfs40_state_renewal_ops</span><span class="p">,</span>
<span class="p">};</span>

<span class="cp">#if defined(CONFIG_NFS_V4_1)</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">nfs4_minor_version_ops</span> <span class="n">nfs_v4_1_minor_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">minor_version</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">call_sync</span> <span class="o">=</span> <span class="n">_nfs4_call_sync_session</span><span class="p">,</span>
	<span class="p">.</span><span class="n">match_stateid</span> <span class="o">=</span> <span class="n">nfs41_match_stateid</span><span class="p">,</span>
	<span class="p">.</span><span class="n">find_root_sec</span> <span class="o">=</span> <span class="n">nfs41_find_root_sec</span><span class="p">,</span>
	<span class="p">.</span><span class="n">reboot_recovery_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">nfs41_reboot_recovery_ops</span><span class="p">,</span>
	<span class="p">.</span><span class="n">nograce_recovery_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">nfs41_nograce_recovery_ops</span><span class="p">,</span>
	<span class="p">.</span><span class="n">state_renewal_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">nfs41_state_renewal_ops</span><span class="p">,</span>
<span class="p">};</span>
<span class="cp">#endif</span>

<span class="k">const</span> <span class="k">struct</span> <span class="n">nfs4_minor_version_ops</span> <span class="o">*</span><span class="n">nfs_v4_minor_ops</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">nfs_v4_0_minor_ops</span><span class="p">,</span>
<span class="cp">#if defined(CONFIG_NFS_V4_1)</span>
	<span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">nfs_v4_1_minor_ops</span><span class="p">,</span>
<span class="cp">#endif</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">inode_operations</span> <span class="n">nfs4_file_inode_operations</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">permission</span>	<span class="o">=</span> <span class="n">nfs_permission</span><span class="p">,</span>
	<span class="p">.</span><span class="n">getattr</span>	<span class="o">=</span> <span class="n">nfs_getattr</span><span class="p">,</span>
	<span class="p">.</span><span class="n">setattr</span>	<span class="o">=</span> <span class="n">nfs_setattr</span><span class="p">,</span>
	<span class="p">.</span><span class="n">getxattr</span>	<span class="o">=</span> <span class="n">generic_getxattr</span><span class="p">,</span>
	<span class="p">.</span><span class="n">setxattr</span>	<span class="o">=</span> <span class="n">generic_setxattr</span><span class="p">,</span>
	<span class="p">.</span><span class="n">listxattr</span>	<span class="o">=</span> <span class="n">generic_listxattr</span><span class="p">,</span>
	<span class="p">.</span><span class="n">removexattr</span>	<span class="o">=</span> <span class="n">generic_removexattr</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">const</span> <span class="k">struct</span> <span class="n">nfs_rpc_ops</span> <span class="n">nfs_v4_clientops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">version</span>	<span class="o">=</span> <span class="mi">4</span><span class="p">,</span>			<span class="cm">/* protocol version */</span>
	<span class="p">.</span><span class="n">dentry_ops</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">nfs4_dentry_operations</span><span class="p">,</span>
	<span class="p">.</span><span class="n">dir_inode_ops</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">nfs4_dir_inode_operations</span><span class="p">,</span>
	<span class="p">.</span><span class="n">file_inode_ops</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">nfs4_file_inode_operations</span><span class="p">,</span>
	<span class="p">.</span><span class="n">file_ops</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">nfs4_file_operations</span><span class="p">,</span>
	<span class="p">.</span><span class="n">getroot</span>	<span class="o">=</span> <span class="n">nfs4_proc_get_root</span><span class="p">,</span>
	<span class="p">.</span><span class="n">submount</span>	<span class="o">=</span> <span class="n">nfs4_submount</span><span class="p">,</span>
	<span class="p">.</span><span class="n">getattr</span>	<span class="o">=</span> <span class="n">nfs4_proc_getattr</span><span class="p">,</span>
	<span class="p">.</span><span class="n">setattr</span>	<span class="o">=</span> <span class="n">nfs4_proc_setattr</span><span class="p">,</span>
	<span class="p">.</span><span class="n">lookup</span>		<span class="o">=</span> <span class="n">nfs4_proc_lookup</span><span class="p">,</span>
	<span class="p">.</span><span class="n">access</span>		<span class="o">=</span> <span class="n">nfs4_proc_access</span><span class="p">,</span>
	<span class="p">.</span><span class="n">readlink</span>	<span class="o">=</span> <span class="n">nfs4_proc_readlink</span><span class="p">,</span>
	<span class="p">.</span><span class="n">create</span>		<span class="o">=</span> <span class="n">nfs4_proc_create</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span>		<span class="o">=</span> <span class="n">nfs4_proc_remove</span><span class="p">,</span>
	<span class="p">.</span><span class="n">unlink_setup</span>	<span class="o">=</span> <span class="n">nfs4_proc_unlink_setup</span><span class="p">,</span>
	<span class="p">.</span><span class="n">unlink_rpc_prepare</span> <span class="o">=</span> <span class="n">nfs4_proc_unlink_rpc_prepare</span><span class="p">,</span>
	<span class="p">.</span><span class="n">unlink_done</span>	<span class="o">=</span> <span class="n">nfs4_proc_unlink_done</span><span class="p">,</span>
	<span class="p">.</span><span class="n">rename</span>		<span class="o">=</span> <span class="n">nfs4_proc_rename</span><span class="p">,</span>
	<span class="p">.</span><span class="n">rename_setup</span>	<span class="o">=</span> <span class="n">nfs4_proc_rename_setup</span><span class="p">,</span>
	<span class="p">.</span><span class="n">rename_rpc_prepare</span> <span class="o">=</span> <span class="n">nfs4_proc_rename_rpc_prepare</span><span class="p">,</span>
	<span class="p">.</span><span class="n">rename_done</span>	<span class="o">=</span> <span class="n">nfs4_proc_rename_done</span><span class="p">,</span>
	<span class="p">.</span><span class="n">link</span>		<span class="o">=</span> <span class="n">nfs4_proc_link</span><span class="p">,</span>
	<span class="p">.</span><span class="n">symlink</span>	<span class="o">=</span> <span class="n">nfs4_proc_symlink</span><span class="p">,</span>
	<span class="p">.</span><span class="n">mkdir</span>		<span class="o">=</span> <span class="n">nfs4_proc_mkdir</span><span class="p">,</span>
	<span class="p">.</span><span class="n">rmdir</span>		<span class="o">=</span> <span class="n">nfs4_proc_remove</span><span class="p">,</span>
	<span class="p">.</span><span class="n">readdir</span>	<span class="o">=</span> <span class="n">nfs4_proc_readdir</span><span class="p">,</span>
	<span class="p">.</span><span class="n">mknod</span>		<span class="o">=</span> <span class="n">nfs4_proc_mknod</span><span class="p">,</span>
	<span class="p">.</span><span class="n">statfs</span>		<span class="o">=</span> <span class="n">nfs4_proc_statfs</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fsinfo</span>		<span class="o">=</span> <span class="n">nfs4_proc_fsinfo</span><span class="p">,</span>
	<span class="p">.</span><span class="n">pathconf</span>	<span class="o">=</span> <span class="n">nfs4_proc_pathconf</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_capabilities</span> <span class="o">=</span> <span class="n">nfs4_server_capabilities</span><span class="p">,</span>
	<span class="p">.</span><span class="n">decode_dirent</span>	<span class="o">=</span> <span class="n">nfs4_decode_dirent</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read_setup</span>	<span class="o">=</span> <span class="n">nfs4_proc_read_setup</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read_rpc_prepare</span> <span class="o">=</span> <span class="n">nfs4_proc_read_rpc_prepare</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read_done</span>	<span class="o">=</span> <span class="n">nfs4_read_done</span><span class="p">,</span>
	<span class="p">.</span><span class="n">write_setup</span>	<span class="o">=</span> <span class="n">nfs4_proc_write_setup</span><span class="p">,</span>
	<span class="p">.</span><span class="n">write_rpc_prepare</span> <span class="o">=</span> <span class="n">nfs4_proc_write_rpc_prepare</span><span class="p">,</span>
	<span class="p">.</span><span class="n">write_done</span>	<span class="o">=</span> <span class="n">nfs4_write_done</span><span class="p">,</span>
	<span class="p">.</span><span class="n">commit_setup</span>	<span class="o">=</span> <span class="n">nfs4_proc_commit_setup</span><span class="p">,</span>
	<span class="p">.</span><span class="n">commit_rpc_prepare</span> <span class="o">=</span> <span class="n">nfs4_proc_commit_rpc_prepare</span><span class="p">,</span>
	<span class="p">.</span><span class="n">commit_done</span>	<span class="o">=</span> <span class="n">nfs4_commit_done</span><span class="p">,</span>
	<span class="p">.</span><span class="n">lock</span>		<span class="o">=</span> <span class="n">nfs4_proc_lock</span><span class="p">,</span>
	<span class="p">.</span><span class="n">clear_acl_cache</span> <span class="o">=</span> <span class="n">nfs4_zap_acl_attr</span><span class="p">,</span>
	<span class="p">.</span><span class="n">close_context</span>  <span class="o">=</span> <span class="n">nfs4_close_context</span><span class="p">,</span>
	<span class="p">.</span><span class="n">open_context</span>	<span class="o">=</span> <span class="n">nfs4_atomic_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">init_client</span>	<span class="o">=</span> <span class="n">nfs4_init_client</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">xattr_handler</span> <span class="n">nfs4_xattr_nfs4_acl_handler</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">prefix</span>	<span class="o">=</span> <span class="n">XATTR_NAME_NFSV4_ACL</span><span class="p">,</span>
	<span class="p">.</span><span class="n">list</span>	<span class="o">=</span> <span class="n">nfs4_xattr_list_nfs4_acl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get</span>	<span class="o">=</span> <span class="n">nfs4_xattr_get_nfs4_acl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set</span>	<span class="o">=</span> <span class="n">nfs4_xattr_set_nfs4_acl</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">const</span> <span class="k">struct</span> <span class="n">xattr_handler</span> <span class="o">*</span><span class="n">nfs4_xattr_handlers</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="o">&amp;</span><span class="n">nfs4_xattr_nfs4_acl_handler</span><span class="p">,</span>
	<span class="nb">NULL</span>
<span class="p">};</span>

<span class="n">module_param</span><span class="p">(</span><span class="n">max_session_slots</span><span class="p">,</span> <span class="n">ushort</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">max_session_slots</span><span class="p">,</span> <span class="s">&quot;Maximum number of outstanding NFSv4.1 &quot;</span>
		<span class="s">&quot;requests the client will negotiate&quot;</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * Local variables:</span>
<span class="cm"> *  c-basic-offset: 8</span>
<span class="cm"> * End:</span>
<span class="cm"> */</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
