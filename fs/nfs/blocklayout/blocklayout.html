<!DOCTYPE html>
<html><head><title>joekychen/linux » fs › nfs › blocklayout › blocklayout.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>blocklayout.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> *  linux/fs/nfs/blocklayout/blocklayout.c</span>
<span class="cm"> *</span>
<span class="cm"> *  Module for the NFSv4.1 pNFS block layout driver.</span>
<span class="cm"> *</span>
<span class="cm"> *  Copyright (c) 2006 The Regents of the University of Michigan.</span>
<span class="cm"> *  All rights reserved.</span>
<span class="cm"> *</span>
<span class="cm"> *  Andy Adamson &lt;andros@citi.umich.edu&gt;</span>
<span class="cm"> *  Fred Isaman &lt;iisaman@umich.edu&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * permission is granted to use, copy, create derivative works and</span>
<span class="cm"> * redistribute this software and such derivative works for any purpose,</span>
<span class="cm"> * so long as the name of the university of michigan is not used in</span>
<span class="cm"> * any advertising or publicity pertaining to the use or distribution</span>
<span class="cm"> * of this software without specific, written prior authorization.  if</span>
<span class="cm"> * the above copyright notice or any other identification of the</span>
<span class="cm"> * university of michigan is included in any copy of any portion of</span>
<span class="cm"> * this software, then the disclaimer below must also be included.</span>
<span class="cm"> *</span>
<span class="cm"> * this software is provided as is, without representation from the</span>
<span class="cm"> * university of michigan as to its fitness for any purpose, and without</span>
<span class="cm"> * warranty by the university of michigan of any kind, either express</span>
<span class="cm"> * or implied, including without limitation the implied warranties of</span>
<span class="cm"> * merchantability and fitness for a particular purpose.  the regents</span>
<span class="cm"> * of the university of michigan shall not be liable for any damages,</span>
<span class="cm"> * including special, indirect, incidental, or consequential damages,</span>
<span class="cm"> * with respect to any claim arising out or in connection with the use</span>
<span class="cm"> * of the software, even if it has been or is hereafter advised of the</span>
<span class="cm"> * possibility of such damages.</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/mount.h&gt;</span>
<span class="cp">#include &lt;linux/namei.h&gt;</span>
<span class="cp">#include &lt;linux/bio.h&gt;		</span><span class="cm">/* struct bio */</span><span class="cp"></span>
<span class="cp">#include &lt;linux/buffer_head.h&gt;	</span><span class="cm">/* various write calls */</span><span class="cp"></span>
<span class="cp">#include &lt;linux/prefetch.h&gt;</span>

<span class="cp">#include &quot;../pnfs.h&quot;</span>
<span class="cp">#include &quot;../internal.h&quot;</span>
<span class="cp">#include &quot;blocklayout.h&quot;</span>

<span class="cp">#define NFSDBG_FACILITY	NFSDBG_PNFS_LD</span>

<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>
<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Andy Adamson &lt;andros@citi.umich.edu&gt;&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;The NFSv4.1 pNFS Block layout driver&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">print_page</span><span class="p">(</span><span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="n">page</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;PRINTPAGE page %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">page</span><span class="p">);</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;	PagePrivate %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">PagePrivate</span><span class="p">(</span><span class="n">page</span><span class="p">));</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;	PageUptodate %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">PageUptodate</span><span class="p">(</span><span class="n">page</span><span class="p">));</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;	PageError %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">PageError</span><span class="p">(</span><span class="n">page</span><span class="p">));</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;	PageDirty %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">PageDirty</span><span class="p">(</span><span class="n">page</span><span class="p">));</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;	PageReferenced %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">PageReferenced</span><span class="p">(</span><span class="n">page</span><span class="p">));</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;	PageLocked %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">PageLocked</span><span class="p">(</span><span class="n">page</span><span class="p">));</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;	PageWriteback %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">PageWriteback</span><span class="p">(</span><span class="n">page</span><span class="p">));</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;	PageMappedToDisk %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">PageMappedToDisk</span><span class="p">(</span><span class="n">page</span><span class="p">));</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Given the be associated with isect, determine if page data needs to be</span>
<span class="cm"> * initialized.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">is_hole</span><span class="p">(</span><span class="k">struct</span> <span class="n">pnfs_block_extent</span> <span class="o">*</span><span class="n">be</span><span class="p">,</span> <span class="n">sector_t</span> <span class="n">isect</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">be</span><span class="o">-&gt;</span><span class="n">be_state</span> <span class="o">==</span> <span class="n">PNFS_BLOCK_NONE_DATA</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">be</span><span class="o">-&gt;</span><span class="n">be_state</span> <span class="o">!=</span> <span class="n">PNFS_BLOCK_INVALID_DATA</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="o">!</span><span class="n">bl_is_sector_init</span><span class="p">(</span><span class="n">be</span><span class="o">-&gt;</span><span class="n">be_inval</span><span class="p">,</span> <span class="n">isect</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Given the be associated with isect, determine if page data can be</span>
<span class="cm"> * written to disk.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">is_writable</span><span class="p">(</span><span class="k">struct</span> <span class="n">pnfs_block_extent</span> <span class="o">*</span><span class="n">be</span><span class="p">,</span> <span class="n">sector_t</span> <span class="n">isect</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">be</span><span class="o">-&gt;</span><span class="n">be_state</span> <span class="o">==</span> <span class="n">PNFS_BLOCK_READWRITE_DATA</span> <span class="o">||</span>
		<span class="n">be</span><span class="o">-&gt;</span><span class="n">be_state</span> <span class="o">==</span> <span class="n">PNFS_BLOCK_INVALID_DATA</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* The data we are handed might be spread across several bios.  We need</span>
<span class="cm"> * to track when the last one is finished.</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">parallel_io</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">kref</span> <span class="n">refcnt</span><span class="p">;</span>
	<span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">pnfs_callback</span><span class="p">)</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">int</span> <span class="n">num_se</span><span class="p">);</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">bse_count</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="k">struct</span> <span class="n">parallel_io</span> <span class="o">*</span><span class="nf">alloc_parallel</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">parallel_io</span> <span class="o">*</span><span class="n">rv</span><span class="p">;</span>

	<span class="n">rv</span>  <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">rv</span><span class="p">),</span> <span class="n">GFP_NOFS</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rv</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rv</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
		<span class="n">kref_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rv</span><span class="o">-&gt;</span><span class="n">refcnt</span><span class="p">);</span>
		<span class="n">rv</span><span class="o">-&gt;</span><span class="n">bse_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">rv</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">get_parallel</span><span class="p">(</span><span class="k">struct</span> <span class="n">parallel_io</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">kref_get</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">refcnt</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">destroy_parallel</span><span class="p">(</span><span class="k">struct</span> <span class="n">kref</span> <span class="o">*</span><span class="n">kref</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">parallel_io</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">kref</span><span class="p">,</span> <span class="k">struct</span> <span class="n">parallel_io</span><span class="p">,</span> <span class="n">refcnt</span><span class="p">);</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s enter</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">pnfs_callback</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">bse_count</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">put_parallel</span><span class="p">(</span><span class="k">struct</span> <span class="n">parallel_io</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">kref_put</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">refcnt</span><span class="p">,</span> <span class="n">destroy_parallel</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">bio</span> <span class="o">*</span>
<span class="nf">bl_submit_bio</span><span class="p">(</span><span class="kt">int</span> <span class="n">rw</span><span class="p">,</span> <span class="k">struct</span> <span class="n">bio</span> <span class="o">*</span><span class="n">bio</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bio</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">get_parallel</span><span class="p">(</span><span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_private</span><span class="p">);</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s submitting %s bio %u@%llu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
			<span class="n">rw</span> <span class="o">==</span> <span class="n">READ</span> <span class="o">?</span> <span class="s">&quot;read&quot;</span> <span class="o">:</span> <span class="s">&quot;write&quot;</span><span class="p">,</span>
			<span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_size</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_sector</span><span class="p">);</span>
		<span class="n">submit_bio</span><span class="p">(</span><span class="n">rw</span><span class="p">,</span> <span class="n">bio</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">bio</span> <span class="o">*</span><span class="nf">bl_alloc_init_bio</span><span class="p">(</span><span class="kt">int</span> <span class="n">npg</span><span class="p">,</span> <span class="n">sector_t</span> <span class="n">isect</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">pnfs_block_extent</span> <span class="o">*</span><span class="n">be</span><span class="p">,</span>
				     <span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">end_io</span><span class="p">)(</span><span class="k">struct</span> <span class="n">bio</span> <span class="o">*</span><span class="p">,</span> <span class="kt">int</span> <span class="n">err</span><span class="p">),</span>
				     <span class="k">struct</span> <span class="n">parallel_io</span> <span class="o">*</span><span class="n">par</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bio</span> <span class="o">*</span><span class="n">bio</span><span class="p">;</span>

	<span class="n">npg</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">npg</span><span class="p">,</span> <span class="n">BIO_MAX_PAGES</span><span class="p">);</span>
	<span class="n">bio</span> <span class="o">=</span> <span class="n">bio_alloc</span><span class="p">(</span><span class="n">GFP_NOIO</span><span class="p">,</span> <span class="n">npg</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bio</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">current</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">PF_MEMALLOC</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">bio</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">npg</span> <span class="o">/=</span> <span class="mi">2</span><span class="p">))</span>
			<span class="n">bio</span> <span class="o">=</span> <span class="n">bio_alloc</span><span class="p">(</span><span class="n">GFP_NOIO</span><span class="p">,</span> <span class="n">npg</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bio</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_sector</span> <span class="o">=</span> <span class="n">isect</span> <span class="o">-</span> <span class="n">be</span><span class="o">-&gt;</span><span class="n">be_f_offset</span> <span class="o">+</span> <span class="n">be</span><span class="o">-&gt;</span><span class="n">be_v_offset</span><span class="p">;</span>
		<span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_bdev</span> <span class="o">=</span> <span class="n">be</span><span class="o">-&gt;</span><span class="n">be_mdev</span><span class="p">;</span>
		<span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_end_io</span> <span class="o">=</span> <span class="n">end_io</span><span class="p">;</span>
		<span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_private</span> <span class="o">=</span> <span class="n">par</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">bio</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">bio</span> <span class="o">*</span><span class="nf">bl_add_page_to_bio</span><span class="p">(</span><span class="k">struct</span> <span class="n">bio</span> <span class="o">*</span><span class="n">bio</span><span class="p">,</span> <span class="kt">int</span> <span class="n">npg</span><span class="p">,</span> <span class="kt">int</span> <span class="n">rw</span><span class="p">,</span>
				      <span class="n">sector_t</span> <span class="n">isect</span><span class="p">,</span> <span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="n">page</span><span class="p">,</span>
				      <span class="k">struct</span> <span class="n">pnfs_block_extent</span> <span class="o">*</span><span class="n">be</span><span class="p">,</span>
				      <span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">end_io</span><span class="p">)(</span><span class="k">struct</span> <span class="n">bio</span> <span class="o">*</span><span class="p">,</span> <span class="kt">int</span> <span class="n">err</span><span class="p">),</span>
				      <span class="k">struct</span> <span class="n">parallel_io</span> <span class="o">*</span><span class="n">par</span><span class="p">)</span>
<span class="p">{</span>
<span class="nl">retry:</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bio</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bio</span> <span class="o">=</span> <span class="n">bl_alloc_init_bio</span><span class="p">(</span><span class="n">npg</span><span class="p">,</span> <span class="n">isect</span><span class="p">,</span> <span class="n">be</span><span class="p">,</span> <span class="n">end_io</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bio</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">ENOMEM</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bio_add_page</span><span class="p">(</span><span class="n">bio</span><span class="p">,</span> <span class="n">page</span><span class="p">,</span> <span class="n">PAGE_CACHE_SIZE</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">PAGE_CACHE_SIZE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bio</span> <span class="o">=</span> <span class="n">bl_submit_bio</span><span class="p">(</span><span class="n">rw</span><span class="p">,</span> <span class="n">bio</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">retry</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">bio</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* This is basically copied from mpage_end_io_read */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">bl_end_io_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">bio</span> <span class="o">*</span><span class="n">bio</span><span class="p">,</span> <span class="kt">int</span> <span class="n">err</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">parallel_io</span> <span class="o">*</span><span class="n">par</span> <span class="o">=</span> <span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_private</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">int</span> <span class="n">uptodate</span> <span class="o">=</span> <span class="n">test_bit</span><span class="p">(</span><span class="n">BIO_UPTODATE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_flags</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">bio_vec</span> <span class="o">*</span><span class="n">bvec</span> <span class="o">=</span> <span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_io_vec</span> <span class="o">+</span> <span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_vcnt</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="n">page</span> <span class="o">=</span> <span class="n">bvec</span><span class="o">-&gt;</span><span class="n">bv_page</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">--</span><span class="n">bvec</span> <span class="o">&gt;=</span> <span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_io_vec</span><span class="p">)</span>
			<span class="n">prefetchw</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bvec</span><span class="o">-&gt;</span><span class="n">bv_page</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">uptodate</span><span class="p">)</span>
			<span class="n">SetPageUptodate</span><span class="p">(</span><span class="n">page</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">bvec</span> <span class="o">&gt;=</span> <span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_io_vec</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">uptodate</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">nfs_read_data</span> <span class="o">*</span><span class="n">rdata</span> <span class="o">=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">nfs_pgio_header</span> <span class="o">*</span><span class="n">header</span> <span class="o">=</span> <span class="n">rdata</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">header</span><span class="o">-&gt;</span><span class="n">pnfs_error</span><span class="p">)</span>
			<span class="n">header</span><span class="o">-&gt;</span><span class="n">pnfs_error</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="n">pnfs_set_lo_fail</span><span class="p">(</span><span class="n">header</span><span class="o">-&gt;</span><span class="n">lseg</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">bio_put</span><span class="p">(</span><span class="n">bio</span><span class="p">);</span>
	<span class="n">put_parallel</span><span class="p">(</span><span class="n">par</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">bl_read_cleanup</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rpc_task</span> <span class="o">*</span><span class="n">task</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nfs_read_data</span> <span class="o">*</span><span class="n">rdata</span><span class="p">;</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s enter</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="n">task</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rpc_task</span><span class="p">,</span> <span class="n">u</span><span class="p">.</span><span class="n">tk_work</span><span class="p">);</span>
	<span class="n">rdata</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nfs_read_data</span><span class="p">,</span> <span class="n">task</span><span class="p">);</span>
	<span class="n">pnfs_ld_read_done</span><span class="p">(</span><span class="n">rdata</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bl_end_par_io_read</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">int</span> <span class="n">unused</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfs_read_data</span> <span class="o">*</span><span class="n">rdata</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>

	<span class="n">rdata</span><span class="o">-&gt;</span><span class="n">task</span><span class="p">.</span><span class="n">tk_status</span> <span class="o">=</span> <span class="n">rdata</span><span class="o">-&gt;</span><span class="n">header</span><span class="o">-&gt;</span><span class="n">pnfs_error</span><span class="p">;</span>
	<span class="n">INIT_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdata</span><span class="o">-&gt;</span><span class="n">task</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">tk_work</span><span class="p">,</span> <span class="n">bl_read_cleanup</span><span class="p">);</span>
	<span class="n">schedule_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdata</span><span class="o">-&gt;</span><span class="n">task</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">tk_work</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">enum</span> <span class="n">pnfs_try_status</span>
<span class="nf">bl_read_pagelist</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs_read_data</span> <span class="o">*</span><span class="n">rdata</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfs_pgio_header</span> <span class="o">*</span><span class="n">header</span> <span class="o">=</span> <span class="n">rdata</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">hole</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bio</span> <span class="o">*</span><span class="n">bio</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pnfs_block_extent</span> <span class="o">*</span><span class="n">be</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">*</span><span class="n">cow_read</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">sector_t</span> <span class="n">isect</span><span class="p">,</span> <span class="n">extent_length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">parallel_io</span> <span class="o">*</span><span class="n">par</span><span class="p">;</span>
	<span class="n">loff_t</span> <span class="n">f_offset</span> <span class="o">=</span> <span class="n">rdata</span><span class="o">-&gt;</span><span class="n">args</span><span class="p">.</span><span class="n">offset</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">page</span> <span class="o">**</span><span class="n">pages</span> <span class="o">=</span> <span class="n">rdata</span><span class="o">-&gt;</span><span class="n">args</span><span class="p">.</span><span class="n">pages</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">pg_index</span> <span class="o">=</span> <span class="n">rdata</span><span class="o">-&gt;</span><span class="n">args</span><span class="p">.</span><span class="n">pgbase</span> <span class="o">&gt;&gt;</span> <span class="n">PAGE_CACHE_SHIFT</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s enter nr_pages %u offset %lld count %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
	       <span class="n">rdata</span><span class="o">-&gt;</span><span class="n">pages</span><span class="p">.</span><span class="n">npages</span><span class="p">,</span> <span class="n">f_offset</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span><span class="n">rdata</span><span class="o">-&gt;</span><span class="n">args</span><span class="p">.</span><span class="n">count</span><span class="p">);</span>

	<span class="n">par</span> <span class="o">=</span> <span class="n">alloc_parallel</span><span class="p">(</span><span class="n">rdata</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">par</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">use_mds</span><span class="p">;</span>
	<span class="n">par</span><span class="o">-&gt;</span><span class="n">pnfs_callback</span> <span class="o">=</span> <span class="n">bl_end_par_io_read</span><span class="p">;</span>
	<span class="cm">/* At this point, we can no longer jump to use_mds */</span>

	<span class="n">isect</span> <span class="o">=</span> <span class="p">(</span><span class="n">sector_t</span><span class="p">)</span> <span class="p">(</span><span class="n">f_offset</span> <span class="o">&gt;&gt;</span> <span class="n">SECTOR_SHIFT</span><span class="p">);</span>
	<span class="cm">/* Code assumes extents are page-aligned */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">pg_index</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">rdata</span><span class="o">-&gt;</span><span class="n">pages</span><span class="p">.</span><span class="n">npages</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">extent_length</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* We&#39;ve used up the previous extent */</span>
			<span class="n">bl_put_extent</span><span class="p">(</span><span class="n">be</span><span class="p">);</span>
			<span class="n">bl_put_extent</span><span class="p">(</span><span class="n">cow_read</span><span class="p">);</span>
			<span class="n">bio</span> <span class="o">=</span> <span class="n">bl_submit_bio</span><span class="p">(</span><span class="n">READ</span><span class="p">,</span> <span class="n">bio</span><span class="p">);</span>
			<span class="cm">/* Get the next one */</span>
			<span class="n">be</span> <span class="o">=</span> <span class="n">bl_find_get_extent</span><span class="p">(</span><span class="n">BLK_LSEG2EXT</span><span class="p">(</span><span class="n">header</span><span class="o">-&gt;</span><span class="n">lseg</span><span class="p">),</span>
					     <span class="n">isect</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cow_read</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">be</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">header</span><span class="o">-&gt;</span><span class="n">pnfs_error</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">extent_length</span> <span class="o">=</span> <span class="n">be</span><span class="o">-&gt;</span><span class="n">be_length</span> <span class="o">-</span>
				<span class="p">(</span><span class="n">isect</span> <span class="o">-</span> <span class="n">be</span><span class="o">-&gt;</span><span class="n">be_f_offset</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">cow_read</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">sector_t</span> <span class="n">cow_length</span> <span class="o">=</span> <span class="n">cow_read</span><span class="o">-&gt;</span><span class="n">be_length</span> <span class="o">-</span>
					<span class="p">(</span><span class="n">isect</span> <span class="o">-</span> <span class="n">cow_read</span><span class="o">-&gt;</span><span class="n">be_f_offset</span><span class="p">);</span>
				<span class="n">extent_length</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">extent_length</span><span class="p">,</span> <span class="n">cow_length</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">hole</span> <span class="o">=</span> <span class="n">is_hole</span><span class="p">(</span><span class="n">be</span><span class="p">,</span> <span class="n">isect</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hole</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">cow_read</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">bio</span> <span class="o">=</span> <span class="n">bl_submit_bio</span><span class="p">(</span><span class="n">READ</span><span class="p">,</span> <span class="n">bio</span><span class="p">);</span>
			<span class="cm">/* Fill hole w/ zeroes w/o accessing device */</span>
			<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s Zeroing page for hole</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
			<span class="n">zero_user_segment</span><span class="p">(</span><span class="n">pages</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="n">PAGE_CACHE_SIZE</span><span class="p">);</span>
			<span class="n">print_page</span><span class="p">(</span><span class="n">pages</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
			<span class="n">SetPageUptodate</span><span class="p">(</span><span class="n">pages</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">pnfs_block_extent</span> <span class="o">*</span><span class="n">be_read</span><span class="p">;</span>

			<span class="n">be_read</span> <span class="o">=</span> <span class="p">(</span><span class="n">hole</span> <span class="o">&amp;&amp;</span> <span class="n">cow_read</span><span class="p">)</span> <span class="o">?</span> <span class="n">cow_read</span> <span class="o">:</span> <span class="n">be</span><span class="p">;</span>
			<span class="n">bio</span> <span class="o">=</span> <span class="n">bl_add_page_to_bio</span><span class="p">(</span><span class="n">bio</span><span class="p">,</span> <span class="n">rdata</span><span class="o">-&gt;</span><span class="n">pages</span><span class="p">.</span><span class="n">npages</span> <span class="o">-</span> <span class="n">i</span><span class="p">,</span>
						 <span class="n">READ</span><span class="p">,</span>
						 <span class="n">isect</span><span class="p">,</span> <span class="n">pages</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">be_read</span><span class="p">,</span>
						 <span class="n">bl_end_io_read</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">bio</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">header</span><span class="o">-&gt;</span><span class="n">pnfs_error</span> <span class="o">=</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">bio</span><span class="p">);</span>
				<span class="n">bio</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">isect</span> <span class="o">+=</span> <span class="n">PAGE_CACHE_SECTORS</span><span class="p">;</span>
		<span class="n">extent_length</span> <span class="o">-=</span> <span class="n">PAGE_CACHE_SECTORS</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">isect</span> <span class="o">&lt;&lt;</span> <span class="n">SECTOR_SHIFT</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">header</span><span class="o">-&gt;</span><span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_size</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rdata</span><span class="o">-&gt;</span><span class="n">res</span><span class="p">.</span><span class="n">eof</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">rdata</span><span class="o">-&gt;</span><span class="n">res</span><span class="p">.</span><span class="n">count</span> <span class="o">=</span> <span class="n">header</span><span class="o">-&gt;</span><span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_size</span> <span class="o">-</span> <span class="n">f_offset</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">rdata</span><span class="o">-&gt;</span><span class="n">res</span><span class="p">.</span><span class="n">count</span> <span class="o">=</span> <span class="p">(</span><span class="n">isect</span> <span class="o">&lt;&lt;</span> <span class="n">SECTOR_SHIFT</span><span class="p">)</span> <span class="o">-</span> <span class="n">f_offset</span><span class="p">;</span>
	<span class="p">}</span>
<span class="nl">out:</span>
	<span class="n">bl_put_extent</span><span class="p">(</span><span class="n">be</span><span class="p">);</span>
	<span class="n">bl_put_extent</span><span class="p">(</span><span class="n">cow_read</span><span class="p">);</span>
	<span class="n">bl_submit_bio</span><span class="p">(</span><span class="n">READ</span><span class="p">,</span> <span class="n">bio</span><span class="p">);</span>
	<span class="n">put_parallel</span><span class="p">(</span><span class="n">par</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">PNFS_ATTEMPTED</span><span class="p">;</span>

 <span class="nl">use_mds:</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;Giving up and using normal NFS</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">PNFS_NOT_ATTEMPTED</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">mark_extents_written</span><span class="p">(</span><span class="k">struct</span> <span class="n">pnfs_block_layout</span> <span class="o">*</span><span class="n">bl</span><span class="p">,</span>
				 <span class="n">__u64</span> <span class="n">offset</span><span class="p">,</span> <span class="n">__u32</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">sector_t</span> <span class="n">isect</span><span class="p">,</span> <span class="n">end</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pnfs_block_extent</span> <span class="o">*</span><span class="n">be</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pnfs_block_short_extent</span> <span class="o">*</span><span class="n">se</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s(%llu, %u)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">isect</span> <span class="o">=</span> <span class="p">(</span><span class="n">offset</span> <span class="o">&amp;</span> <span class="p">(</span><span class="kt">long</span><span class="p">)(</span><span class="n">PAGE_CACHE_MASK</span><span class="p">))</span> <span class="o">&gt;&gt;</span> <span class="n">SECTOR_SHIFT</span><span class="p">;</span>
	<span class="n">end</span> <span class="o">=</span> <span class="p">(</span><span class="n">offset</span> <span class="o">+</span> <span class="n">count</span> <span class="o">+</span> <span class="n">PAGE_CACHE_SIZE</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="kt">long</span><span class="p">)(</span><span class="n">PAGE_CACHE_MASK</span><span class="p">);</span>
	<span class="n">end</span> <span class="o">&gt;&gt;=</span> <span class="n">SECTOR_SHIFT</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">isect</span> <span class="o">&lt;</span> <span class="n">end</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sector_t</span> <span class="n">len</span><span class="p">;</span>
		<span class="n">be</span> <span class="o">=</span> <span class="n">bl_find_get_extent</span><span class="p">(</span><span class="n">bl</span><span class="p">,</span> <span class="n">isect</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">be</span><span class="p">);</span> <span class="cm">/* FIXME */</span>
		<span class="n">len</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">end</span><span class="p">,</span> <span class="n">be</span><span class="o">-&gt;</span><span class="n">be_f_offset</span> <span class="o">+</span> <span class="n">be</span><span class="o">-&gt;</span><span class="n">be_length</span><span class="p">)</span> <span class="o">-</span> <span class="n">isect</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">be</span><span class="o">-&gt;</span><span class="n">be_state</span> <span class="o">==</span> <span class="n">PNFS_BLOCK_INVALID_DATA</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">se</span> <span class="o">=</span> <span class="n">bl_pop_one_short_extent</span><span class="p">(</span><span class="n">be</span><span class="o">-&gt;</span><span class="n">be_inval</span><span class="p">);</span>
			<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">se</span><span class="p">);</span>
			<span class="n">bl_mark_for_commit</span><span class="p">(</span><span class="n">be</span><span class="p">,</span> <span class="n">isect</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">se</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">isect</span> <span class="o">+=</span> <span class="n">len</span><span class="p">;</span>
		<span class="n">bl_put_extent</span><span class="p">(</span><span class="n">be</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">bl_end_io_write_zero</span><span class="p">(</span><span class="k">struct</span> <span class="n">bio</span> <span class="o">*</span><span class="n">bio</span><span class="p">,</span> <span class="kt">int</span> <span class="n">err</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">parallel_io</span> <span class="o">*</span><span class="n">par</span> <span class="o">=</span> <span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_private</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">int</span> <span class="n">uptodate</span> <span class="o">=</span> <span class="n">test_bit</span><span class="p">(</span><span class="n">BIO_UPTODATE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_flags</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">bio_vec</span> <span class="o">*</span><span class="n">bvec</span> <span class="o">=</span> <span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_io_vec</span> <span class="o">+</span> <span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_vcnt</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="n">page</span> <span class="o">=</span> <span class="n">bvec</span><span class="o">-&gt;</span><span class="n">bv_page</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">--</span><span class="n">bvec</span> <span class="o">&gt;=</span> <span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_io_vec</span><span class="p">)</span>
			<span class="n">prefetchw</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bvec</span><span class="o">-&gt;</span><span class="n">bv_page</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
		<span class="cm">/* This is the zeroing page we added */</span>
		<span class="n">end_page_writeback</span><span class="p">(</span><span class="n">page</span><span class="p">);</span>
		<span class="n">page_cache_release</span><span class="p">(</span><span class="n">page</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">bvec</span> <span class="o">&gt;=</span> <span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_io_vec</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">uptodate</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">nfs_write_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">nfs_pgio_header</span> <span class="o">*</span><span class="n">header</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">header</span><span class="o">-&gt;</span><span class="n">pnfs_error</span><span class="p">)</span>
			<span class="n">header</span><span class="o">-&gt;</span><span class="n">pnfs_error</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="n">pnfs_set_lo_fail</span><span class="p">(</span><span class="n">header</span><span class="o">-&gt;</span><span class="n">lseg</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">bio_put</span><span class="p">(</span><span class="n">bio</span><span class="p">);</span>
	<span class="n">put_parallel</span><span class="p">(</span><span class="n">par</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">bl_end_io_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">bio</span> <span class="o">*</span><span class="n">bio</span><span class="p">,</span> <span class="kt">int</span> <span class="n">err</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">parallel_io</span> <span class="o">*</span><span class="n">par</span> <span class="o">=</span> <span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_private</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">int</span> <span class="n">uptodate</span> <span class="o">=</span> <span class="n">test_bit</span><span class="p">(</span><span class="n">BIO_UPTODATE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_flags</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">nfs_write_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nfs_pgio_header</span> <span class="o">*</span><span class="n">header</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">uptodate</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">header</span><span class="o">-&gt;</span><span class="n">pnfs_error</span><span class="p">)</span>
			<span class="n">header</span><span class="o">-&gt;</span><span class="n">pnfs_error</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="n">pnfs_set_lo_fail</span><span class="p">(</span><span class="n">header</span><span class="o">-&gt;</span><span class="n">lseg</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">bio_put</span><span class="p">(</span><span class="n">bio</span><span class="p">);</span>
	<span class="n">put_parallel</span><span class="p">(</span><span class="n">par</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Function scheduled for call during bl_end_par_io_write,</span>
<span class="cm"> * it marks sectors as written and extends the commitlist.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">bl_write_cleanup</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rpc_task</span> <span class="o">*</span><span class="n">task</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nfs_write_data</span> <span class="o">*</span><span class="n">wdata</span><span class="p">;</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s enter</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="n">task</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rpc_task</span><span class="p">,</span> <span class="n">u</span><span class="p">.</span><span class="n">tk_work</span><span class="p">);</span>
	<span class="n">wdata</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nfs_write_data</span><span class="p">,</span> <span class="n">task</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="o">!</span><span class="n">wdata</span><span class="o">-&gt;</span><span class="n">header</span><span class="o">-&gt;</span><span class="n">pnfs_error</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* Marks for LAYOUTCOMMIT */</span>
		<span class="n">mark_extents_written</span><span class="p">(</span><span class="n">BLK_LSEG2EXT</span><span class="p">(</span><span class="n">wdata</span><span class="o">-&gt;</span><span class="n">header</span><span class="o">-&gt;</span><span class="n">lseg</span><span class="p">),</span>
				     <span class="n">wdata</span><span class="o">-&gt;</span><span class="n">args</span><span class="p">.</span><span class="n">offset</span><span class="p">,</span> <span class="n">wdata</span><span class="o">-&gt;</span><span class="n">args</span><span class="p">.</span><span class="n">count</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">pnfs_ld_write_done</span><span class="p">(</span><span class="n">wdata</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Called when last of bios associated with a bl_write_pagelist call finishes */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">bl_end_par_io_write</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">int</span> <span class="n">num_se</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfs_write_data</span> <span class="o">*</span><span class="n">wdata</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">wdata</span><span class="o">-&gt;</span><span class="n">header</span><span class="o">-&gt;</span><span class="n">pnfs_error</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">bl_free_short_extents</span><span class="p">(</span><span class="o">&amp;</span><span class="n">BLK_LSEG2EXT</span><span class="p">(</span><span class="n">wdata</span><span class="o">-&gt;</span><span class="n">header</span><span class="o">-&gt;</span><span class="n">lseg</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">bl_inval</span><span class="p">,</span>
					<span class="n">num_se</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">wdata</span><span class="o">-&gt;</span><span class="n">task</span><span class="p">.</span><span class="n">tk_status</span> <span class="o">=</span> <span class="n">wdata</span><span class="o">-&gt;</span><span class="n">header</span><span class="o">-&gt;</span><span class="n">pnfs_error</span><span class="p">;</span>
	<span class="n">wdata</span><span class="o">-&gt;</span><span class="n">verf</span><span class="p">.</span><span class="n">committed</span> <span class="o">=</span> <span class="n">NFS_FILE_SYNC</span><span class="p">;</span>
	<span class="n">INIT_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wdata</span><span class="o">-&gt;</span><span class="n">task</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">tk_work</span><span class="p">,</span> <span class="n">bl_write_cleanup</span><span class="p">);</span>
	<span class="n">schedule_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wdata</span><span class="o">-&gt;</span><span class="n">task</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">tk_work</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* FIXME STUB - mark intersection of layout and page as bad, so is not</span>
<span class="cm"> * used again.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">mark_bad_read</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * map_block:  map a requested I/0 block (isect) into an offset in the LVM</span>
<span class="cm"> * block_device</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">map_block</span><span class="p">(</span><span class="k">struct</span> <span class="n">buffer_head</span> <span class="o">*</span><span class="n">bh</span><span class="p">,</span> <span class="n">sector_t</span> <span class="n">isect</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pnfs_block_extent</span> <span class="o">*</span><span class="n">be</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s enter be=%p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">be</span><span class="p">);</span>

	<span class="n">set_buffer_mapped</span><span class="p">(</span><span class="n">bh</span><span class="p">);</span>
	<span class="n">bh</span><span class="o">-&gt;</span><span class="n">b_bdev</span> <span class="o">=</span> <span class="n">be</span><span class="o">-&gt;</span><span class="n">be_mdev</span><span class="p">;</span>
	<span class="n">bh</span><span class="o">-&gt;</span><span class="n">b_blocknr</span> <span class="o">=</span> <span class="p">(</span><span class="n">isect</span> <span class="o">-</span> <span class="n">be</span><span class="o">-&gt;</span><span class="n">be_f_offset</span> <span class="o">+</span> <span class="n">be</span><span class="o">-&gt;</span><span class="n">be_v_offset</span><span class="p">)</span> <span class="o">&gt;&gt;</span>
	    <span class="p">(</span><span class="n">be</span><span class="o">-&gt;</span><span class="n">be_mdev</span><span class="o">-&gt;</span><span class="n">bd_inode</span><span class="o">-&gt;</span><span class="n">i_blkbits</span> <span class="o">-</span> <span class="n">SECTOR_SHIFT</span><span class="p">);</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s isect %llu, bh-&gt;b_blocknr %ld, using bsize %Zd</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">__func__</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">isect</span><span class="p">,</span> <span class="p">(</span><span class="kt">long</span><span class="p">)</span><span class="n">bh</span><span class="o">-&gt;</span><span class="n">b_blocknr</span><span class="p">,</span>
		<span class="n">bh</span><span class="o">-&gt;</span><span class="n">b_size</span><span class="p">);</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Given an unmapped page, zero it or read in page for COW, page is locked</span>
<span class="cm"> * by caller.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">init_page_for_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="n">page</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pnfs_block_extent</span> <span class="o">*</span><span class="n">cow_read</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">buffer_head</span> <span class="o">*</span><span class="n">bh</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">sector_t</span> <span class="n">isect</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s enter, %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">page</span><span class="p">);</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">PageUptodate</span><span class="p">(</span><span class="n">page</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cow_read</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">zero_user_segment</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">);</span>
		<span class="n">SetPageUptodate</span><span class="p">(</span><span class="n">page</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">cleanup</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">bh</span> <span class="o">=</span> <span class="n">alloc_page_buffers</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="n">PAGE_CACHE_SIZE</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bh</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">cleanup</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">isect</span> <span class="o">=</span> <span class="p">(</span><span class="n">sector_t</span><span class="p">)</span> <span class="n">page</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">&lt;&lt;</span> <span class="n">PAGE_CACHE_SECTOR_SHIFT</span><span class="p">;</span>
	<span class="n">map_block</span><span class="p">(</span><span class="n">bh</span><span class="p">,</span> <span class="n">isect</span><span class="p">,</span> <span class="n">cow_read</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bh_uptodate_or_lock</span><span class="p">(</span><span class="n">bh</span><span class="p">))</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">bh_submit_read</span><span class="p">(</span><span class="n">bh</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">cleanup</span><span class="p">;</span>
	<span class="n">SetPageUptodate</span><span class="p">(</span><span class="n">page</span><span class="p">);</span>

<span class="nl">cleanup:</span>
	<span class="n">bl_put_extent</span><span class="p">(</span><span class="n">cow_read</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bh</span><span class="p">)</span>
		<span class="n">free_buffer_head</span><span class="p">(</span><span class="n">bh</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Need to mark layout with bad read...should now</span>
<span class="cm">		 * just use nfs4 for reads and writes.</span>
<span class="cm">		 */</span>
		<span class="n">mark_bad_read</span><span class="p">();</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Find or create a zeroing page marked being writeback.</span>
<span class="cm"> * Return ERR_PTR on error, NULL to indicate skip this page and page itself</span>
<span class="cm"> * to indicate write out.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">page</span> <span class="o">*</span>
<span class="nf">bl_find_get_zeroing_page</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="n">pgoff_t</span> <span class="n">index</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">pnfs_block_extent</span> <span class="o">*</span><span class="n">cow_read</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="n">page</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">locked</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">page</span> <span class="o">=</span> <span class="n">find_get_page</span><span class="p">(</span><span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_mapping</span><span class="p">,</span> <span class="n">index</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">page</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">check_page</span><span class="p">;</span>

	<span class="n">page</span> <span class="o">=</span> <span class="n">find_or_create_page</span><span class="p">(</span><span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_mapping</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">GFP_NOFS</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">page</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s oom</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">ENOMEM</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">locked</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

<span class="nl">check_page:</span>
	<span class="cm">/* PageDirty: Other will write this out</span>
<span class="cm">	 * PageWriteback: Other is writing this out</span>
<span class="cm">	 * PageUptodate: It was read before</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">PageDirty</span><span class="p">(</span><span class="n">page</span><span class="p">)</span> <span class="o">||</span> <span class="n">PageWriteback</span><span class="p">(</span><span class="n">page</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">print_page</span><span class="p">(</span><span class="n">page</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">locked</span><span class="p">)</span>
			<span class="n">unlock_page</span><span class="p">(</span><span class="n">page</span><span class="p">);</span>
		<span class="n">page_cache_release</span><span class="p">(</span><span class="n">page</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">locked</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">lock_page</span><span class="p">(</span><span class="n">page</span><span class="p">);</span>
		<span class="n">locked</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">check_page</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">PageUptodate</span><span class="p">(</span><span class="n">page</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* New page, readin or zero it */</span>
		<span class="n">init_page_for_write</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="n">cow_read</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">set_page_writeback</span><span class="p">(</span><span class="n">page</span><span class="p">);</span>
	<span class="n">unlock_page</span><span class="p">(</span><span class="n">page</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">page</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">enum</span> <span class="n">pnfs_try_status</span>
<span class="nf">bl_write_pagelist</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs_write_data</span> <span class="o">*</span><span class="n">wdata</span><span class="p">,</span> <span class="kt">int</span> <span class="n">sync</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfs_pgio_header</span> <span class="o">*</span><span class="n">header</span> <span class="o">=</span> <span class="n">wdata</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">ret</span><span class="p">,</span> <span class="n">npg_zero</span><span class="p">,</span> <span class="n">pg_index</span><span class="p">,</span> <span class="n">last</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bio</span> <span class="o">*</span><span class="n">bio</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pnfs_block_extent</span> <span class="o">*</span><span class="n">be</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">*</span><span class="n">cow_read</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">sector_t</span> <span class="n">isect</span><span class="p">,</span> <span class="n">last_isect</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">extent_length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">parallel_io</span> <span class="o">*</span><span class="n">par</span><span class="p">;</span>
	<span class="n">loff_t</span> <span class="n">offset</span> <span class="o">=</span> <span class="n">wdata</span><span class="o">-&gt;</span><span class="n">args</span><span class="p">.</span><span class="n">offset</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">count</span> <span class="o">=</span> <span class="n">wdata</span><span class="o">-&gt;</span><span class="n">args</span><span class="p">.</span><span class="n">count</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">page</span> <span class="o">**</span><span class="n">pages</span> <span class="o">=</span> <span class="n">wdata</span><span class="o">-&gt;</span><span class="n">args</span><span class="p">.</span><span class="n">pages</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="n">page</span><span class="p">;</span>
	<span class="n">pgoff_t</span> <span class="n">index</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">temp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">npg_per_block</span> <span class="o">=</span>
	    <span class="n">NFS_SERVER</span><span class="p">(</span><span class="n">header</span><span class="o">-&gt;</span><span class="n">inode</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">pnfs_blksize</span> <span class="o">&gt;&gt;</span> <span class="n">PAGE_CACHE_SHIFT</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s enter, %Zu@%lld</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">offset</span><span class="p">);</span>
	<span class="cm">/* At this point, wdata-&gt;pages is a (sequential) list of nfs_pages.</span>
<span class="cm">	 * We want to write each, and if there is an error set pnfs_error</span>
<span class="cm">	 * to have it redone using nfs.</span>
<span class="cm">	 */</span>
	<span class="n">par</span> <span class="o">=</span> <span class="n">alloc_parallel</span><span class="p">(</span><span class="n">wdata</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">par</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_mds</span><span class="p">;</span>
	<span class="n">par</span><span class="o">-&gt;</span><span class="n">pnfs_callback</span> <span class="o">=</span> <span class="n">bl_end_par_io_write</span><span class="p">;</span>
	<span class="cm">/* At this point, have to be more careful with error handling */</span>

	<span class="n">isect</span> <span class="o">=</span> <span class="p">(</span><span class="n">sector_t</span><span class="p">)</span> <span class="p">((</span><span class="n">offset</span> <span class="o">&amp;</span> <span class="p">(</span><span class="kt">long</span><span class="p">)</span><span class="n">PAGE_CACHE_MASK</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">SECTOR_SHIFT</span><span class="p">);</span>
	<span class="n">be</span> <span class="o">=</span> <span class="n">bl_find_get_extent</span><span class="p">(</span><span class="n">BLK_LSEG2EXT</span><span class="p">(</span><span class="n">header</span><span class="o">-&gt;</span><span class="n">lseg</span><span class="p">),</span> <span class="n">isect</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cow_read</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">be</span> <span class="o">||</span> <span class="o">!</span><span class="n">is_writable</span><span class="p">(</span><span class="n">be</span><span class="p">,</span> <span class="n">isect</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s no matching extents!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_mds</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* First page inside INVALID extent */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">be</span><span class="o">-&gt;</span><span class="n">be_state</span> <span class="o">==</span> <span class="n">PNFS_BLOCK_INVALID_DATA</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="o">!</span><span class="n">bl_push_one_short_extent</span><span class="p">(</span><span class="n">be</span><span class="o">-&gt;</span><span class="n">be_inval</span><span class="p">)))</span>
			<span class="n">par</span><span class="o">-&gt;</span><span class="n">bse_count</span><span class="o">++</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="k">goto</span> <span class="n">out_mds</span><span class="p">;</span>
		<span class="n">temp</span> <span class="o">=</span> <span class="n">offset</span> <span class="o">&gt;&gt;</span> <span class="n">PAGE_CACHE_SHIFT</span><span class="p">;</span>
		<span class="n">npg_zero</span> <span class="o">=</span> <span class="n">do_div</span><span class="p">(</span><span class="n">temp</span><span class="p">,</span> <span class="n">npg_per_block</span><span class="p">);</span>
		<span class="n">isect</span> <span class="o">=</span> <span class="p">(</span><span class="n">sector_t</span><span class="p">)</span> <span class="p">(((</span><span class="n">offset</span> <span class="o">-</span> <span class="n">npg_zero</span> <span class="o">*</span> <span class="n">PAGE_CACHE_SIZE</span><span class="p">)</span> <span class="o">&amp;</span>
				     <span class="p">(</span><span class="kt">long</span><span class="p">)</span><span class="n">PAGE_CACHE_MASK</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">SECTOR_SHIFT</span><span class="p">);</span>
		<span class="n">extent_length</span> <span class="o">=</span> <span class="n">be</span><span class="o">-&gt;</span><span class="n">be_length</span> <span class="o">-</span> <span class="p">(</span><span class="n">isect</span> <span class="o">-</span> <span class="n">be</span><span class="o">-&gt;</span><span class="n">be_f_offset</span><span class="p">);</span>

<span class="nl">fill_invalid_ext:</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s need to zero %d pages</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">npg_zero</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(;</span><span class="n">npg_zero</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">;</span> <span class="n">npg_zero</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">bl_is_sector_init</span><span class="p">(</span><span class="n">be</span><span class="o">-&gt;</span><span class="n">be_inval</span><span class="p">,</span> <span class="n">isect</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;isect %llu already init</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">isect</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">next_page</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="cm">/* page ref released in bl_end_io_write_zero */</span>
			<span class="n">index</span> <span class="o">=</span> <span class="n">isect</span> <span class="o">&gt;&gt;</span> <span class="n">PAGE_CACHE_SECTOR_SHIFT</span><span class="p">;</span>
			<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s zero %dth page: index %lu isect %llu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">__func__</span><span class="p">,</span> <span class="n">npg_zero</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span>
				<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">isect</span><span class="p">);</span>
			<span class="n">page</span> <span class="o">=</span> <span class="n">bl_find_get_zeroing_page</span><span class="p">(</span><span class="n">header</span><span class="o">-&gt;</span><span class="n">inode</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span>
							<span class="n">cow_read</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">page</span><span class="p">)))</span> <span class="p">{</span>
				<span class="n">header</span><span class="o">-&gt;</span><span class="n">pnfs_error</span> <span class="o">=</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">page</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">page</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">next_page</span><span class="p">;</span>

			<span class="n">ret</span> <span class="o">=</span> <span class="n">bl_mark_sectors_init</span><span class="p">(</span><span class="n">be</span><span class="o">-&gt;</span><span class="n">be_inval</span><span class="p">,</span> <span class="n">isect</span><span class="p">,</span>
						       <span class="n">PAGE_CACHE_SECTORS</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">ret</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s bl_mark_sectors_init fail %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">__func__</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
				<span class="n">end_page_writeback</span><span class="p">(</span><span class="n">page</span><span class="p">);</span>
				<span class="n">page_cache_release</span><span class="p">(</span><span class="n">page</span><span class="p">);</span>
				<span class="n">header</span><span class="o">-&gt;</span><span class="n">pnfs_error</span> <span class="o">=</span> <span class="n">ret</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="o">!</span><span class="n">bl_push_one_short_extent</span><span class="p">(</span><span class="n">be</span><span class="o">-&gt;</span><span class="n">be_inval</span><span class="p">)))</span>
				<span class="n">par</span><span class="o">-&gt;</span><span class="n">bse_count</span><span class="o">++</span><span class="p">;</span>
			<span class="k">else</span> <span class="p">{</span>
				<span class="n">end_page_writeback</span><span class="p">(</span><span class="n">page</span><span class="p">);</span>
				<span class="n">page_cache_release</span><span class="p">(</span><span class="n">page</span><span class="p">);</span>
				<span class="n">header</span><span class="o">-&gt;</span><span class="n">pnfs_error</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="cm">/* FIXME: This should be done in bi_end_io */</span>
			<span class="n">mark_extents_written</span><span class="p">(</span><span class="n">BLK_LSEG2EXT</span><span class="p">(</span><span class="n">header</span><span class="o">-&gt;</span><span class="n">lseg</span><span class="p">),</span>
					     <span class="n">page</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">&lt;&lt;</span> <span class="n">PAGE_CACHE_SHIFT</span><span class="p">,</span>
					     <span class="n">PAGE_CACHE_SIZE</span><span class="p">);</span>

			<span class="n">bio</span> <span class="o">=</span> <span class="n">bl_add_page_to_bio</span><span class="p">(</span><span class="n">bio</span><span class="p">,</span> <span class="n">npg_zero</span><span class="p">,</span> <span class="n">WRITE</span><span class="p">,</span>
						 <span class="n">isect</span><span class="p">,</span> <span class="n">page</span><span class="p">,</span> <span class="n">be</span><span class="p">,</span>
						 <span class="n">bl_end_io_write_zero</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">bio</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">header</span><span class="o">-&gt;</span><span class="n">pnfs_error</span> <span class="o">=</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">bio</span><span class="p">);</span>
				<span class="n">bio</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
			<span class="p">}</span>
<span class="nl">next_page:</span>
			<span class="n">isect</span> <span class="o">+=</span> <span class="n">PAGE_CACHE_SECTORS</span><span class="p">;</span>
			<span class="n">extent_length</span> <span class="o">-=</span> <span class="n">PAGE_CACHE_SECTORS</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">last</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">write_done</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">bio</span> <span class="o">=</span> <span class="n">bl_submit_bio</span><span class="p">(</span><span class="n">WRITE</span><span class="p">,</span> <span class="n">bio</span><span class="p">);</span>

	<span class="cm">/* Middle pages */</span>
	<span class="n">pg_index</span> <span class="o">=</span> <span class="n">wdata</span><span class="o">-&gt;</span><span class="n">args</span><span class="p">.</span><span class="n">pgbase</span> <span class="o">&gt;&gt;</span> <span class="n">PAGE_CACHE_SHIFT</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">pg_index</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">wdata</span><span class="o">-&gt;</span><span class="n">pages</span><span class="p">.</span><span class="n">npages</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">extent_length</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* We&#39;ve used up the previous extent */</span>
			<span class="n">bl_put_extent</span><span class="p">(</span><span class="n">be</span><span class="p">);</span>
			<span class="n">bio</span> <span class="o">=</span> <span class="n">bl_submit_bio</span><span class="p">(</span><span class="n">WRITE</span><span class="p">,</span> <span class="n">bio</span><span class="p">);</span>
			<span class="cm">/* Get the next one */</span>
			<span class="n">be</span> <span class="o">=</span> <span class="n">bl_find_get_extent</span><span class="p">(</span><span class="n">BLK_LSEG2EXT</span><span class="p">(</span><span class="n">header</span><span class="o">-&gt;</span><span class="n">lseg</span><span class="p">),</span>
					     <span class="n">isect</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">be</span> <span class="o">||</span> <span class="o">!</span><span class="n">is_writable</span><span class="p">(</span><span class="n">be</span><span class="p">,</span> <span class="n">isect</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">header</span><span class="o">-&gt;</span><span class="n">pnfs_error</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">be</span><span class="o">-&gt;</span><span class="n">be_state</span> <span class="o">==</span> <span class="n">PNFS_BLOCK_INVALID_DATA</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="o">!</span><span class="n">bl_push_one_short_extent</span><span class="p">(</span>
								<span class="n">be</span><span class="o">-&gt;</span><span class="n">be_inval</span><span class="p">)))</span>
					<span class="n">par</span><span class="o">-&gt;</span><span class="n">bse_count</span><span class="o">++</span><span class="p">;</span>
				<span class="k">else</span> <span class="p">{</span>
					<span class="n">header</span><span class="o">-&gt;</span><span class="n">pnfs_error</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
					<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="n">extent_length</span> <span class="o">=</span> <span class="n">be</span><span class="o">-&gt;</span><span class="n">be_length</span> <span class="o">-</span>
			    <span class="p">(</span><span class="n">isect</span> <span class="o">-</span> <span class="n">be</span><span class="o">-&gt;</span><span class="n">be_f_offset</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">be</span><span class="o">-&gt;</span><span class="n">be_state</span> <span class="o">==</span> <span class="n">PNFS_BLOCK_INVALID_DATA</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">bl_mark_sectors_init</span><span class="p">(</span><span class="n">be</span><span class="o">-&gt;</span><span class="n">be_inval</span><span class="p">,</span> <span class="n">isect</span><span class="p">,</span>
						       <span class="n">PAGE_CACHE_SECTORS</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">ret</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s bl_mark_sectors_init fail %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">__func__</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
				<span class="n">header</span><span class="o">-&gt;</span><span class="n">pnfs_error</span> <span class="o">=</span> <span class="n">ret</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">bio</span> <span class="o">=</span> <span class="n">bl_add_page_to_bio</span><span class="p">(</span><span class="n">bio</span><span class="p">,</span> <span class="n">wdata</span><span class="o">-&gt;</span><span class="n">pages</span><span class="p">.</span><span class="n">npages</span> <span class="o">-</span> <span class="n">i</span><span class="p">,</span> <span class="n">WRITE</span><span class="p">,</span>
					 <span class="n">isect</span><span class="p">,</span> <span class="n">pages</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">be</span><span class="p">,</span>
					 <span class="n">bl_end_io_write</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">bio</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">header</span><span class="o">-&gt;</span><span class="n">pnfs_error</span> <span class="o">=</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">bio</span><span class="p">);</span>
			<span class="n">bio</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">isect</span> <span class="o">+=</span> <span class="n">PAGE_CACHE_SECTORS</span><span class="p">;</span>
		<span class="n">last_isect</span> <span class="o">=</span> <span class="n">isect</span><span class="p">;</span>
		<span class="n">extent_length</span> <span class="o">-=</span> <span class="n">PAGE_CACHE_SECTORS</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Last page inside INVALID extent */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">be</span><span class="o">-&gt;</span><span class="n">be_state</span> <span class="o">==</span> <span class="n">PNFS_BLOCK_INVALID_DATA</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bio</span> <span class="o">=</span> <span class="n">bl_submit_bio</span><span class="p">(</span><span class="n">WRITE</span><span class="p">,</span> <span class="n">bio</span><span class="p">);</span>
		<span class="n">temp</span> <span class="o">=</span> <span class="n">last_isect</span> <span class="o">&gt;&gt;</span> <span class="n">PAGE_CACHE_SECTOR_SHIFT</span><span class="p">;</span>
		<span class="n">npg_zero</span> <span class="o">=</span> <span class="n">npg_per_block</span> <span class="o">-</span> <span class="n">do_div</span><span class="p">(</span><span class="n">temp</span><span class="p">,</span> <span class="n">npg_per_block</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">npg_zero</span> <span class="o">&lt;</span> <span class="n">npg_per_block</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">last</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">fill_invalid_ext</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

<span class="nl">write_done:</span>
	<span class="n">wdata</span><span class="o">-&gt;</span><span class="n">res</span><span class="p">.</span><span class="n">count</span> <span class="o">=</span> <span class="p">(</span><span class="n">last_isect</span> <span class="o">&lt;&lt;</span> <span class="n">SECTOR_SHIFT</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="n">offset</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">&lt;</span> <span class="n">wdata</span><span class="o">-&gt;</span><span class="n">res</span><span class="p">.</span><span class="n">count</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wdata</span><span class="o">-&gt;</span><span class="n">res</span><span class="p">.</span><span class="n">count</span> <span class="o">=</span> <span class="n">count</span><span class="p">;</span>
	<span class="p">}</span>
<span class="nl">out:</span>
	<span class="n">bl_put_extent</span><span class="p">(</span><span class="n">be</span><span class="p">);</span>
	<span class="n">bl_submit_bio</span><span class="p">(</span><span class="n">WRITE</span><span class="p">,</span> <span class="n">bio</span><span class="p">);</span>
	<span class="n">put_parallel</span><span class="p">(</span><span class="n">par</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">PNFS_ATTEMPTED</span><span class="p">;</span>
<span class="nl">out_mds:</span>
	<span class="n">bl_put_extent</span><span class="p">(</span><span class="n">be</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">par</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">PNFS_NOT_ATTEMPTED</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* FIXME - range ignored */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">release_extents</span><span class="p">(</span><span class="k">struct</span> <span class="n">pnfs_block_layout</span> <span class="o">*</span><span class="n">bl</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pnfs_layout_range</span> <span class="o">*</span><span class="n">range</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pnfs_block_extent</span> <span class="o">*</span><span class="n">be</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bl</span><span class="o">-&gt;</span><span class="n">bl_ext_lock</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">EXTENT_LISTS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bl</span><span class="o">-&gt;</span><span class="n">bl_extents</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span> <span class="p">{</span>
			<span class="n">be</span> <span class="o">=</span> <span class="n">list_first_entry</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bl</span><span class="o">-&gt;</span><span class="n">bl_extents</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
					      <span class="k">struct</span> <span class="n">pnfs_block_extent</span><span class="p">,</span>
					      <span class="n">be_node</span><span class="p">);</span>
			<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">be</span><span class="o">-&gt;</span><span class="n">be_node</span><span class="p">);</span>
			<span class="n">bl_put_extent</span><span class="p">(</span><span class="n">be</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bl</span><span class="o">-&gt;</span><span class="n">bl_ext_lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">release_inval_marks</span><span class="p">(</span><span class="k">struct</span> <span class="n">pnfs_inval_markings</span> <span class="o">*</span><span class="n">marks</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pnfs_inval_tracking</span> <span class="o">*</span><span class="n">pos</span><span class="p">,</span> <span class="o">*</span><span class="n">temp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pnfs_block_short_extent</span> <span class="o">*</span><span class="n">se</span><span class="p">,</span> <span class="o">*</span><span class="n">stemp</span><span class="p">;</span>

	<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="n">temp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">marks</span><span class="o">-&gt;</span><span class="n">im_tree</span><span class="p">.</span><span class="n">mtt_stub</span><span class="p">,</span> <span class="n">it_link</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pos</span><span class="o">-&gt;</span><span class="n">it_link</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">pos</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">se</span><span class="p">,</span> <span class="n">stemp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">marks</span><span class="o">-&gt;</span><span class="n">im_extents</span><span class="p">,</span> <span class="n">bse_node</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">se</span><span class="o">-&gt;</span><span class="n">bse_node</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">se</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">bl_free_layout_hdr</span><span class="p">(</span><span class="k">struct</span> <span class="n">pnfs_layout_hdr</span> <span class="o">*</span><span class="n">lo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pnfs_block_layout</span> <span class="o">*</span><span class="n">bl</span> <span class="o">=</span> <span class="n">BLK_LO2EXT</span><span class="p">(</span><span class="n">lo</span><span class="p">);</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s enter</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="n">release_extents</span><span class="p">(</span><span class="n">bl</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">release_inval_marks</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bl</span><span class="o">-&gt;</span><span class="n">bl_inval</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">bl</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">pnfs_layout_hdr</span> <span class="o">*</span><span class="nf">bl_alloc_layout_hdr</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span>
						   <span class="n">gfp_t</span> <span class="n">gfp_flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pnfs_block_layout</span> <span class="o">*</span><span class="n">bl</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s enter</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="n">bl</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">bl</span><span class="p">),</span> <span class="n">gfp_flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bl</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bl</span><span class="o">-&gt;</span><span class="n">bl_ext_lock</span><span class="p">);</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bl</span><span class="o">-&gt;</span><span class="n">bl_extents</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bl</span><span class="o">-&gt;</span><span class="n">bl_extents</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bl</span><span class="o">-&gt;</span><span class="n">bl_commit</span><span class="p">);</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bl</span><span class="o">-&gt;</span><span class="n">bl_committing</span><span class="p">);</span>
	<span class="n">bl</span><span class="o">-&gt;</span><span class="n">bl_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">bl</span><span class="o">-&gt;</span><span class="n">bl_blocksize</span> <span class="o">=</span> <span class="n">NFS_SERVER</span><span class="p">(</span><span class="n">inode</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">pnfs_blksize</span> <span class="o">&gt;&gt;</span> <span class="n">SECTOR_SHIFT</span><span class="p">;</span>
	<span class="n">BL_INIT_INVAL_MARKS</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bl</span><span class="o">-&gt;</span><span class="n">bl_inval</span><span class="p">,</span> <span class="n">bl</span><span class="o">-&gt;</span><span class="n">bl_blocksize</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">&amp;</span><span class="n">bl</span><span class="o">-&gt;</span><span class="n">bl_layout</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">bl_free_lseg</span><span class="p">(</span><span class="k">struct</span> <span class="n">pnfs_layout_segment</span> <span class="o">*</span><span class="n">lseg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s enter</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">lseg</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* We pretty much ignore lseg, and store all data layout wide, so we</span>
<span class="cm"> * can correctly merge.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">pnfs_layout_segment</span> <span class="o">*</span><span class="nf">bl_alloc_lseg</span><span class="p">(</span><span class="k">struct</span> <span class="n">pnfs_layout_hdr</span> <span class="o">*</span><span class="n">lo</span><span class="p">,</span>
						 <span class="k">struct</span> <span class="n">nfs4_layoutget_res</span> <span class="o">*</span><span class="n">lgr</span><span class="p">,</span>
						 <span class="n">gfp_t</span> <span class="n">gfp_flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pnfs_layout_segment</span> <span class="o">*</span><span class="n">lseg</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s enter</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="n">lseg</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">lseg</span><span class="p">),</span> <span class="n">gfp_flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">lseg</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">ENOMEM</span><span class="p">);</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">nfs4_blk_process_layoutget</span><span class="p">(</span><span class="n">lo</span><span class="p">,</span> <span class="n">lgr</span><span class="p">,</span> <span class="n">gfp_flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* We don&#39;t want to call the full-blown bl_free_lseg,</span>
<span class="cm">		 * since on error extents were not touched.</span>
<span class="cm">		 */</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">lseg</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="n">status</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">lseg</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bl_encode_layoutcommit</span><span class="p">(</span><span class="k">struct</span> <span class="n">pnfs_layout_hdr</span> <span class="o">*</span><span class="n">lo</span><span class="p">,</span> <span class="k">struct</span> <span class="n">xdr_stream</span> <span class="o">*</span><span class="n">xdr</span><span class="p">,</span>
		       <span class="k">const</span> <span class="k">struct</span> <span class="n">nfs4_layoutcommit_args</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s enter</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="n">encode_pnfs_block_layoutupdate</span><span class="p">(</span><span class="n">BLK_LO2EXT</span><span class="p">(</span><span class="n">lo</span><span class="p">),</span> <span class="n">xdr</span><span class="p">,</span> <span class="n">arg</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bl_cleanup_layoutcommit</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs4_layoutcommit_data</span> <span class="o">*</span><span class="n">lcdata</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pnfs_layout_hdr</span> <span class="o">*</span><span class="n">lo</span> <span class="o">=</span> <span class="n">NFS_I</span><span class="p">(</span><span class="n">lcdata</span><span class="o">-&gt;</span><span class="n">args</span><span class="p">.</span><span class="n">inode</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">layout</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s enter</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="n">clean_pnfs_block_layoutupdate</span><span class="p">(</span><span class="n">BLK_LO2EXT</span><span class="p">(</span><span class="n">lo</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">lcdata</span><span class="o">-&gt;</span><span class="n">args</span><span class="p">,</span> <span class="n">lcdata</span><span class="o">-&gt;</span><span class="n">res</span><span class="p">.</span><span class="n">status</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">free_blk_mountid</span><span class="p">(</span><span class="k">struct</span> <span class="n">block_mount_id</span> <span class="o">*</span><span class="n">mid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mid</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">pnfs_block_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="o">*</span><span class="n">tmp</span><span class="p">;</span>

		<span class="cm">/* No need to take bm_lock as we are last user freeing bm_devlist */</span>
		<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">tmp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mid</span><span class="o">-&gt;</span><span class="n">bm_devlist</span><span class="p">,</span> <span class="n">bm_node</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">bm_node</span><span class="p">);</span>
			<span class="n">bl_free_block_dev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">mid</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* This is mostly copied from the filelayout&#39;s get_device_info function.</span>
<span class="cm"> * It seems much of this should be at the generic pnfs level.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">pnfs_block_dev</span> <span class="o">*</span>
<span class="nf">nfs4_blk_get_deviceinfo</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs_server</span> <span class="o">*</span><span class="n">server</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">nfs_fh</span> <span class="o">*</span><span class="n">fh</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">nfs4_deviceid</span> <span class="o">*</span><span class="n">d_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pnfs_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pnfs_block_dev</span> <span class="o">*</span><span class="n">rv</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">max_resp_sz</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">max_pages</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">page</span> <span class="o">**</span><span class="n">pages</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">rc</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Use the session max response size as the basis for setting</span>
<span class="cm">	 * GETDEVICEINFO&#39;s maxcount</span>
<span class="cm">	 */</span>
	<span class="n">max_resp_sz</span> <span class="o">=</span> <span class="n">server</span><span class="o">-&gt;</span><span class="n">nfs_client</span><span class="o">-&gt;</span><span class="n">cl_session</span><span class="o">-&gt;</span><span class="n">fc_attrs</span><span class="p">.</span><span class="n">max_resp_sz</span><span class="p">;</span>
	<span class="n">max_pages</span> <span class="o">=</span> <span class="n">nfs_page_array_len</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">max_resp_sz</span><span class="p">);</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s max_resp_sz %u max_pages %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">__func__</span><span class="p">,</span> <span class="n">max_resp_sz</span><span class="p">,</span> <span class="n">max_pages</span><span class="p">);</span>

	<span class="n">dev</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">dev</span><span class="p">),</span> <span class="n">GFP_NOFS</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s kmalloc failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">ENOMEM</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">pages</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="n">max_pages</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="p">),</span> <span class="n">GFP_NOFS</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pages</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">ENOMEM</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">max_pages</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pages</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">alloc_page</span><span class="p">(</span><span class="n">GFP_NOFS</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pages</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="p">{</span>
			<span class="n">rv</span> <span class="o">=</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">ENOMEM</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">out_free</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_id</span><span class="p">,</span> <span class="n">d_id</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">d_id</span><span class="p">));</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">layout_type</span> <span class="o">=</span> <span class="n">LAYOUT_BLOCK_VOLUME</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">pages</span> <span class="o">=</span> <span class="n">pages</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">pgbase</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">pglen</span> <span class="o">=</span> <span class="n">PAGE_SIZE</span> <span class="o">*</span> <span class="n">max_pages</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">mincount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s: dev_id: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_id</span><span class="p">.</span><span class="n">data</span><span class="p">);</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">nfs4_proc_getdeviceinfo</span><span class="p">(</span><span class="n">server</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s getdevice info returns %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rv</span> <span class="o">=</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="n">rc</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_free</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rv</span> <span class="o">=</span> <span class="n">nfs4_blk_decode_device</span><span class="p">(</span><span class="n">server</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
 <span class="nl">out_free:</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">max_pages</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">__free_page</span><span class="p">(</span><span class="n">pages</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">pages</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rv</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">bl_set_layoutdriver</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs_server</span> <span class="o">*</span><span class="n">server</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">nfs_fh</span> <span class="o">*</span><span class="n">fh</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">block_mount_id</span> <span class="o">*</span><span class="n">b_mt_id</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pnfs_devicelist</span> <span class="o">*</span><span class="n">dlist</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pnfs_block_dev</span> <span class="o">*</span><span class="n">bdev</span><span class="p">;</span>
	<span class="n">LIST_HEAD</span><span class="p">(</span><span class="n">block_disklist</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s enter</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">pnfs_blksize</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s Server did not return blksize</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">b_mt_id</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">block_mount_id</span><span class="p">),</span> <span class="n">GFP_NOFS</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">b_mt_id</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out_error</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* Initialize nfs4 block layout mount id */</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">b_mt_id</span><span class="o">-&gt;</span><span class="n">bm_lock</span><span class="p">);</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">b_mt_id</span><span class="o">-&gt;</span><span class="n">bm_devlist</span><span class="p">);</span>

	<span class="n">dlist</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">pnfs_devicelist</span><span class="p">),</span> <span class="n">GFP_NOFS</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dlist</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out_error</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">dlist</span><span class="o">-&gt;</span><span class="n">eof</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">dlist</span><span class="o">-&gt;</span><span class="n">eof</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">nfs4_proc_getdevicelist</span><span class="p">(</span><span class="n">server</span><span class="p">,</span> <span class="n">fh</span><span class="p">,</span> <span class="n">dlist</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out_error</span><span class="p">;</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s GETDEVICELIST numdevs=%i, eof=%i</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span> <span class="n">dlist</span><span class="o">-&gt;</span><span class="n">num_devs</span><span class="p">,</span> <span class="n">dlist</span><span class="o">-&gt;</span><span class="n">eof</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">dlist</span><span class="o">-&gt;</span><span class="n">num_devs</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">bdev</span> <span class="o">=</span> <span class="n">nfs4_blk_get_deviceinfo</span><span class="p">(</span><span class="n">server</span><span class="p">,</span> <span class="n">fh</span><span class="p">,</span>
						       <span class="o">&amp;</span><span class="n">dlist</span><span class="o">-&gt;</span><span class="n">dev_id</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">bdev</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">status</span> <span class="o">=</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">bdev</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">out_error</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">b_mt_id</span><span class="o">-&gt;</span><span class="n">bm_lock</span><span class="p">);</span>
			<span class="n">list_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bdev</span><span class="o">-&gt;</span><span class="n">bm_node</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">b_mt_id</span><span class="o">-&gt;</span><span class="n">bm_devlist</span><span class="p">);</span>
			<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">b_mt_id</span><span class="o">-&gt;</span><span class="n">bm_lock</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s SUCCESS</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="n">server</span><span class="o">-&gt;</span><span class="n">pnfs_ld_data</span> <span class="o">=</span> <span class="n">b_mt_id</span><span class="p">;</span>

 <span class="nl">out_return:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">dlist</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>

 <span class="nl">out_error:</span>
	<span class="n">free_blk_mountid</span><span class="p">(</span><span class="n">b_mt_id</span><span class="p">);</span>
	<span class="k">goto</span> <span class="n">out_return</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">bl_clear_layoutdriver</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs_server</span> <span class="o">*</span><span class="n">server</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">block_mount_id</span> <span class="o">*</span><span class="n">b_mt_id</span> <span class="o">=</span> <span class="n">server</span><span class="o">-&gt;</span><span class="n">pnfs_ld_data</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s enter</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="n">free_blk_mountid</span><span class="p">(</span><span class="n">b_mt_id</span><span class="p">);</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s RETURNS</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">nfs_pageio_ops</span> <span class="n">bl_pg_read_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">pg_init</span> <span class="o">=</span> <span class="n">pnfs_generic_pg_init_read</span><span class="p">,</span>
	<span class="p">.</span><span class="n">pg_test</span> <span class="o">=</span> <span class="n">pnfs_generic_pg_test</span><span class="p">,</span>
	<span class="p">.</span><span class="n">pg_doio</span> <span class="o">=</span> <span class="n">pnfs_generic_pg_readpages</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">nfs_pageio_ops</span> <span class="n">bl_pg_write_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">pg_init</span> <span class="o">=</span> <span class="n">pnfs_generic_pg_init_write</span><span class="p">,</span>
	<span class="p">.</span><span class="n">pg_test</span> <span class="o">=</span> <span class="n">pnfs_generic_pg_test</span><span class="p">,</span>
	<span class="p">.</span><span class="n">pg_doio</span> <span class="o">=</span> <span class="n">pnfs_generic_pg_writepages</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">pnfs_layoutdriver_type</span> <span class="n">blocklayout_type</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">id</span>				<span class="o">=</span> <span class="n">LAYOUT_BLOCK_VOLUME</span><span class="p">,</span>
	<span class="p">.</span><span class="n">name</span>				<span class="o">=</span> <span class="s">&quot;LAYOUT_BLOCK_VOLUME&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read_pagelist</span>			<span class="o">=</span> <span class="n">bl_read_pagelist</span><span class="p">,</span>
	<span class="p">.</span><span class="n">write_pagelist</span>			<span class="o">=</span> <span class="n">bl_write_pagelist</span><span class="p">,</span>
	<span class="p">.</span><span class="n">alloc_layout_hdr</span>		<span class="o">=</span> <span class="n">bl_alloc_layout_hdr</span><span class="p">,</span>
	<span class="p">.</span><span class="n">free_layout_hdr</span>		<span class="o">=</span> <span class="n">bl_free_layout_hdr</span><span class="p">,</span>
	<span class="p">.</span><span class="n">alloc_lseg</span>			<span class="o">=</span> <span class="n">bl_alloc_lseg</span><span class="p">,</span>
	<span class="p">.</span><span class="n">free_lseg</span>			<span class="o">=</span> <span class="n">bl_free_lseg</span><span class="p">,</span>
	<span class="p">.</span><span class="n">encode_layoutcommit</span>		<span class="o">=</span> <span class="n">bl_encode_layoutcommit</span><span class="p">,</span>
	<span class="p">.</span><span class="n">cleanup_layoutcommit</span>		<span class="o">=</span> <span class="n">bl_cleanup_layoutcommit</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_layoutdriver</span>		<span class="o">=</span> <span class="n">bl_set_layoutdriver</span><span class="p">,</span>
	<span class="p">.</span><span class="n">clear_layoutdriver</span>		<span class="o">=</span> <span class="n">bl_clear_layoutdriver</span><span class="p">,</span>
	<span class="p">.</span><span class="n">pg_read_ops</span>			<span class="o">=</span> <span class="o">&amp;</span><span class="n">bl_pg_read_ops</span><span class="p">,</span>
	<span class="p">.</span><span class="n">pg_write_ops</span>			<span class="o">=</span> <span class="o">&amp;</span><span class="n">bl_pg_write_ops</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">rpc_pipe_ops</span> <span class="n">bl_upcall_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">upcall</span>		<span class="o">=</span> <span class="n">rpc_pipe_generic_upcall</span><span class="p">,</span>
	<span class="p">.</span><span class="n">downcall</span>	<span class="o">=</span> <span class="n">bl_pipe_downcall</span><span class="p">,</span>
	<span class="p">.</span><span class="n">destroy_msg</span>	<span class="o">=</span> <span class="n">bl_pipe_destroy_msg</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="nf">nfs4blocklayout_register_sb</span><span class="p">(</span><span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">sb</span><span class="p">,</span>
					    <span class="k">struct</span> <span class="n">rpc_pipe</span> <span class="o">*</span><span class="n">pipe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="n">dir</span><span class="p">,</span> <span class="o">*</span><span class="n">dentry</span><span class="p">;</span>

	<span class="n">dir</span> <span class="o">=</span> <span class="n">rpc_d_lookup_sb</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">NFS_PIPE_DIRNAME</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dir</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">ENOENT</span><span class="p">);</span>
	<span class="n">dentry</span> <span class="o">=</span> <span class="n">rpc_mkpipe_dentry</span><span class="p">(</span><span class="n">dir</span><span class="p">,</span> <span class="s">&quot;blocklayout&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">pipe</span><span class="p">);</span>
	<span class="n">dput</span><span class="p">(</span><span class="n">dir</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">dentry</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">nfs4blocklayout_unregister_sb</span><span class="p">(</span><span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">sb</span><span class="p">,</span>
					  <span class="k">struct</span> <span class="n">rpc_pipe</span> <span class="o">*</span><span class="n">pipe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pipe</span><span class="o">-&gt;</span><span class="n">dentry</span><span class="p">)</span>
		<span class="n">rpc_unlink</span><span class="p">(</span><span class="n">pipe</span><span class="o">-&gt;</span><span class="n">dentry</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">rpc_pipefs_event</span><span class="p">(</span><span class="k">struct</span> <span class="n">notifier_block</span> <span class="o">*</span><span class="n">nb</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">event</span><span class="p">,</span>
			   <span class="kt">void</span> <span class="o">*</span><span class="n">ptr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">sb</span> <span class="o">=</span> <span class="n">ptr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net</span> <span class="o">*</span><span class="n">net</span> <span class="o">=</span> <span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_fs_info</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nfs_net</span> <span class="o">*</span><span class="n">nn</span> <span class="o">=</span> <span class="n">net_generic</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">nfs_net_id</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="n">dentry</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">try_module_get</span><span class="p">(</span><span class="n">THIS_MODULE</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nn</span><span class="o">-&gt;</span><span class="n">bl_device_pipe</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">module_put</span><span class="p">(</span><span class="n">THIS_MODULE</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">event</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">RPC_PIPEFS_MOUNT</span>:
		<span class="n">dentry</span> <span class="o">=</span> <span class="n">nfs4blocklayout_register_sb</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">nn</span><span class="o">-&gt;</span><span class="n">bl_device_pipe</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">dentry</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">dentry</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">nn</span><span class="o">-&gt;</span><span class="n">bl_device_pipe</span><span class="o">-&gt;</span><span class="n">dentry</span> <span class="o">=</span> <span class="n">dentry</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">RPC_PIPEFS_UMOUNT</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">nn</span><span class="o">-&gt;</span><span class="n">bl_device_pipe</span><span class="o">-&gt;</span><span class="n">dentry</span><span class="p">)</span>
			<span class="n">nfs4blocklayout_unregister_sb</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">nn</span><span class="o">-&gt;</span><span class="n">bl_device_pipe</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOTSUPP</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">module_put</span><span class="p">(</span><span class="n">THIS_MODULE</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">notifier_block</span> <span class="n">nfs4blocklayout_block</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">notifier_call</span> <span class="o">=</span> <span class="n">rpc_pipefs_event</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="nf">nfs4blocklayout_register_net</span><span class="p">(</span><span class="k">struct</span> <span class="n">net</span> <span class="o">*</span><span class="n">net</span><span class="p">,</span>
						   <span class="k">struct</span> <span class="n">rpc_pipe</span> <span class="o">*</span><span class="n">pipe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">pipefs_sb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="n">dentry</span><span class="p">;</span>

	<span class="n">pipefs_sb</span> <span class="o">=</span> <span class="n">rpc_get_sb_net</span><span class="p">(</span><span class="n">net</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pipefs_sb</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">dentry</span> <span class="o">=</span> <span class="n">nfs4blocklayout_register_sb</span><span class="p">(</span><span class="n">pipefs_sb</span><span class="p">,</span> <span class="n">pipe</span><span class="p">);</span>
	<span class="n">rpc_put_sb_net</span><span class="p">(</span><span class="n">net</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">dentry</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">nfs4blocklayout_unregister_net</span><span class="p">(</span><span class="k">struct</span> <span class="n">net</span> <span class="o">*</span><span class="n">net</span><span class="p">,</span>
					   <span class="k">struct</span> <span class="n">rpc_pipe</span> <span class="o">*</span><span class="n">pipe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">pipefs_sb</span><span class="p">;</span>

	<span class="n">pipefs_sb</span> <span class="o">=</span> <span class="n">rpc_get_sb_net</span><span class="p">(</span><span class="n">net</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pipefs_sb</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">nfs4blocklayout_unregister_sb</span><span class="p">(</span><span class="n">pipefs_sb</span><span class="p">,</span> <span class="n">pipe</span><span class="p">);</span>
		<span class="n">rpc_put_sb_net</span><span class="p">(</span><span class="n">net</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">nfs4blocklayout_net_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">net</span> <span class="o">*</span><span class="n">net</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfs_net</span> <span class="o">*</span><span class="n">nn</span> <span class="o">=</span> <span class="n">net_generic</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">nfs_net_id</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="n">dentry</span><span class="p">;</span>

	<span class="n">init_waitqueue_head</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nn</span><span class="o">-&gt;</span><span class="n">bl_wq</span><span class="p">);</span>
	<span class="n">nn</span><span class="o">-&gt;</span><span class="n">bl_device_pipe</span> <span class="o">=</span> <span class="n">rpc_mkpipe_data</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bl_upcall_ops</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">nn</span><span class="o">-&gt;</span><span class="n">bl_device_pipe</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">nn</span><span class="o">-&gt;</span><span class="n">bl_device_pipe</span><span class="p">);</span>
	<span class="n">dentry</span> <span class="o">=</span> <span class="n">nfs4blocklayout_register_net</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">nn</span><span class="o">-&gt;</span><span class="n">bl_device_pipe</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">dentry</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">rpc_destroy_pipe_data</span><span class="p">(</span><span class="n">nn</span><span class="o">-&gt;</span><span class="n">bl_device_pipe</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">dentry</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">nn</span><span class="o">-&gt;</span><span class="n">bl_device_pipe</span><span class="o">-&gt;</span><span class="n">dentry</span> <span class="o">=</span> <span class="n">dentry</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">nfs4blocklayout_net_exit</span><span class="p">(</span><span class="k">struct</span> <span class="n">net</span> <span class="o">*</span><span class="n">net</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfs_net</span> <span class="o">*</span><span class="n">nn</span> <span class="o">=</span> <span class="n">net_generic</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">nfs_net_id</span><span class="p">);</span>

	<span class="n">nfs4blocklayout_unregister_net</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">nn</span><span class="o">-&gt;</span><span class="n">bl_device_pipe</span><span class="p">);</span>
	<span class="n">rpc_destroy_pipe_data</span><span class="p">(</span><span class="n">nn</span><span class="o">-&gt;</span><span class="n">bl_device_pipe</span><span class="p">);</span>
	<span class="n">nn</span><span class="o">-&gt;</span><span class="n">bl_device_pipe</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">pernet_operations</span> <span class="n">nfs4blocklayout_net_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">init</span> <span class="o">=</span> <span class="n">nfs4blocklayout_net_init</span><span class="p">,</span>
	<span class="p">.</span><span class="n">exit</span> <span class="o">=</span> <span class="n">nfs4blocklayout_net_exit</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">nfs4blocklayout_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s: NFSv4 Block Layout Driver Registering...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">pnfs_register_layoutdriver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">blocklayout_type</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">rpc_pipefs_notifier_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nfs4blocklayout_block</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_remove</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">register_pernet_subsys</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nfs4blocklayout_net_ops</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_notifier</span><span class="p">;</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

<span class="nl">out_notifier:</span>
	<span class="n">rpc_pipefs_notifier_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nfs4blocklayout_block</span><span class="p">);</span>
<span class="nl">out_remove:</span>
	<span class="n">pnfs_unregister_layoutdriver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">blocklayout_type</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">nfs4blocklayout_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s: NFSv4 Block Layout Driver Unregistering...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">__func__</span><span class="p">);</span>

	<span class="n">rpc_pipefs_notifier_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nfs4blocklayout_block</span><span class="p">);</span>
	<span class="n">unregister_pernet_subsys</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nfs4blocklayout_net_ops</span><span class="p">);</span>
	<span class="n">pnfs_unregister_layoutdriver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">blocklayout_type</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">MODULE_ALIAS</span><span class="p">(</span><span class="s">&quot;nfs-layouttype4-3&quot;</span><span class="p">);</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">nfs4blocklayout_init</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">nfs4blocklayout_exit</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
