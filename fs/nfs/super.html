<!DOCTYPE html>
<html><head><title>joekychen/linux » fs › nfs › super.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>super.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> *  linux/fs/nfs/super.c</span>
<span class="cm"> *</span>
<span class="cm"> *  Copyright (C) 1992  Rick Sladkey</span>
<span class="cm"> *</span>
<span class="cm"> *  nfs superblock handling functions</span>
<span class="cm"> *</span>
<span class="cm"> *  Modularised by Alan Cox &lt;alan@lxorguk.ukuu.org.uk&gt;, while hacking some</span>
<span class="cm"> *  experimental NFS changes. Modularisation taken straight from SYS5 fs.</span>
<span class="cm"> *</span>
<span class="cm"> *  Change to nfs_read_super() to permit NFS mounts to multi-homed hosts.</span>
<span class="cm"> *  J.S.Peatfield@damtp.cam.ac.uk</span>
<span class="cm"> *</span>
<span class="cm"> *  Split from inode.c by David Howells &lt;dhowells@redhat.com&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * - superblocks are indexed on server only - all inodes, dentries, etc. associated with a</span>
<span class="cm"> *   particular server are held in the same superblock</span>
<span class="cm"> * - NFS superblocks can have several effective roots to the dentry tree</span>
<span class="cm"> * - directory type roots are spliced into the tree when a path from one root reaches the root</span>
<span class="cm"> *   of another (see nfs_lookup())</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>

<span class="cp">#include &lt;linux/time.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/mm.h&gt;</span>
<span class="cp">#include &lt;linux/string.h&gt;</span>
<span class="cp">#include &lt;linux/stat.h&gt;</span>
<span class="cp">#include &lt;linux/errno.h&gt;</span>
<span class="cp">#include &lt;linux/unistd.h&gt;</span>
<span class="cp">#include &lt;linux/sunrpc/clnt.h&gt;</span>
<span class="cp">#include &lt;linux/sunrpc/stats.h&gt;</span>
<span class="cp">#include &lt;linux/sunrpc/metrics.h&gt;</span>
<span class="cp">#include &lt;linux/sunrpc/xprtsock.h&gt;</span>
<span class="cp">#include &lt;linux/sunrpc/xprtrdma.h&gt;</span>
<span class="cp">#include &lt;linux/nfs_fs.h&gt;</span>
<span class="cp">#include &lt;linux/nfs_mount.h&gt;</span>
<span class="cp">#include &lt;linux/nfs4_mount.h&gt;</span>
<span class="cp">#include &lt;linux/lockd/bind.h&gt;</span>
<span class="cp">#include &lt;linux/seq_file.h&gt;</span>
<span class="cp">#include &lt;linux/mount.h&gt;</span>
<span class="cp">#include &lt;linux/namei.h&gt;</span>
<span class="cp">#include &lt;linux/nfs_idmap.h&gt;</span>
<span class="cp">#include &lt;linux/vfs.h&gt;</span>
<span class="cp">#include &lt;linux/inet.h&gt;</span>
<span class="cp">#include &lt;linux/in6.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;net/ipv6.h&gt;</span>
<span class="cp">#include &lt;linux/netdevice.h&gt;</span>
<span class="cp">#include &lt;linux/nfs_xdr.h&gt;</span>
<span class="cp">#include &lt;linux/magic.h&gt;</span>
<span class="cp">#include &lt;linux/parser.h&gt;</span>
<span class="cp">#include &lt;linux/nsproxy.h&gt;</span>
<span class="cp">#include &lt;linux/rcupdate.h&gt;</span>

<span class="cp">#include &lt;asm/uaccess.h&gt;</span>

<span class="cp">#include &quot;nfs4_fs.h&quot;</span>
<span class="cp">#include &quot;callback.h&quot;</span>
<span class="cp">#include &quot;delegation.h&quot;</span>
<span class="cp">#include &quot;iostat.h&quot;</span>
<span class="cp">#include &quot;internal.h&quot;</span>
<span class="cp">#include &quot;fscache.h&quot;</span>
<span class="cp">#include &quot;pnfs.h&quot;</span>

<span class="cp">#define NFSDBG_FACILITY		NFSDBG_VFS</span>
<span class="cp">#define NFS_TEXT_DATA		1</span>

<span class="cp">#ifdef CONFIG_NFS_V3</span>
<span class="cp">#define NFS_DEFAULT_VERSION 3</span>
<span class="cp">#else</span>
<span class="cp">#define NFS_DEFAULT_VERSION 2</span>
<span class="cp">#endif</span>

<span class="k">enum</span> <span class="p">{</span>
	<span class="cm">/* Mount options that take no arguments */</span>
	<span class="n">Opt_soft</span><span class="p">,</span> <span class="n">Opt_hard</span><span class="p">,</span>
	<span class="n">Opt_posix</span><span class="p">,</span> <span class="n">Opt_noposix</span><span class="p">,</span>
	<span class="n">Opt_cto</span><span class="p">,</span> <span class="n">Opt_nocto</span><span class="p">,</span>
	<span class="n">Opt_ac</span><span class="p">,</span> <span class="n">Opt_noac</span><span class="p">,</span>
	<span class="n">Opt_lock</span><span class="p">,</span> <span class="n">Opt_nolock</span><span class="p">,</span>
	<span class="n">Opt_udp</span><span class="p">,</span> <span class="n">Opt_tcp</span><span class="p">,</span> <span class="n">Opt_rdma</span><span class="p">,</span>
	<span class="n">Opt_acl</span><span class="p">,</span> <span class="n">Opt_noacl</span><span class="p">,</span>
	<span class="n">Opt_rdirplus</span><span class="p">,</span> <span class="n">Opt_nordirplus</span><span class="p">,</span>
	<span class="n">Opt_sharecache</span><span class="p">,</span> <span class="n">Opt_nosharecache</span><span class="p">,</span>
	<span class="n">Opt_resvport</span><span class="p">,</span> <span class="n">Opt_noresvport</span><span class="p">,</span>
	<span class="n">Opt_fscache</span><span class="p">,</span> <span class="n">Opt_nofscache</span><span class="p">,</span>

	<span class="cm">/* Mount options that take integer arguments */</span>
	<span class="n">Opt_port</span><span class="p">,</span>
	<span class="n">Opt_rsize</span><span class="p">,</span> <span class="n">Opt_wsize</span><span class="p">,</span> <span class="n">Opt_bsize</span><span class="p">,</span>
	<span class="n">Opt_timeo</span><span class="p">,</span> <span class="n">Opt_retrans</span><span class="p">,</span>
	<span class="n">Opt_acregmin</span><span class="p">,</span> <span class="n">Opt_acregmax</span><span class="p">,</span>
	<span class="n">Opt_acdirmin</span><span class="p">,</span> <span class="n">Opt_acdirmax</span><span class="p">,</span>
	<span class="n">Opt_actimeo</span><span class="p">,</span>
	<span class="n">Opt_namelen</span><span class="p">,</span>
	<span class="n">Opt_mountport</span><span class="p">,</span>
	<span class="n">Opt_mountvers</span><span class="p">,</span>
	<span class="n">Opt_minorversion</span><span class="p">,</span>

	<span class="cm">/* Mount options that take string arguments */</span>
	<span class="n">Opt_nfsvers</span><span class="p">,</span>
	<span class="n">Opt_sec</span><span class="p">,</span> <span class="n">Opt_proto</span><span class="p">,</span> <span class="n">Opt_mountproto</span><span class="p">,</span> <span class="n">Opt_mounthost</span><span class="p">,</span>
	<span class="n">Opt_addr</span><span class="p">,</span> <span class="n">Opt_mountaddr</span><span class="p">,</span> <span class="n">Opt_clientaddr</span><span class="p">,</span>
	<span class="n">Opt_lookupcache</span><span class="p">,</span>
	<span class="n">Opt_fscache_uniq</span><span class="p">,</span>
	<span class="n">Opt_local_lock</span><span class="p">,</span>

	<span class="cm">/* Special mount options */</span>
	<span class="n">Opt_userspace</span><span class="p">,</span> <span class="n">Opt_deprecated</span><span class="p">,</span> <span class="n">Opt_sloppy</span><span class="p">,</span>

	<span class="n">Opt_err</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="n">match_table_t</span> <span class="n">nfs_mount_option_tokens</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="n">Opt_userspace</span><span class="p">,</span> <span class="s">&quot;bg&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">Opt_userspace</span><span class="p">,</span> <span class="s">&quot;fg&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">Opt_userspace</span><span class="p">,</span> <span class="s">&quot;retry=%s&quot;</span> <span class="p">},</span>

	<span class="p">{</span> <span class="n">Opt_sloppy</span><span class="p">,</span> <span class="s">&quot;sloppy&quot;</span> <span class="p">},</span>

	<span class="p">{</span> <span class="n">Opt_soft</span><span class="p">,</span> <span class="s">&quot;soft&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">Opt_hard</span><span class="p">,</span> <span class="s">&quot;hard&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">Opt_deprecated</span><span class="p">,</span> <span class="s">&quot;intr&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">Opt_deprecated</span><span class="p">,</span> <span class="s">&quot;nointr&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">Opt_posix</span><span class="p">,</span> <span class="s">&quot;posix&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">Opt_noposix</span><span class="p">,</span> <span class="s">&quot;noposix&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">Opt_cto</span><span class="p">,</span> <span class="s">&quot;cto&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">Opt_nocto</span><span class="p">,</span> <span class="s">&quot;nocto&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">Opt_ac</span><span class="p">,</span> <span class="s">&quot;ac&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">Opt_noac</span><span class="p">,</span> <span class="s">&quot;noac&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">Opt_lock</span><span class="p">,</span> <span class="s">&quot;lock&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">Opt_nolock</span><span class="p">,</span> <span class="s">&quot;nolock&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">Opt_udp</span><span class="p">,</span> <span class="s">&quot;udp&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">Opt_tcp</span><span class="p">,</span> <span class="s">&quot;tcp&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">Opt_rdma</span><span class="p">,</span> <span class="s">&quot;rdma&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">Opt_acl</span><span class="p">,</span> <span class="s">&quot;acl&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">Opt_noacl</span><span class="p">,</span> <span class="s">&quot;noacl&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">Opt_rdirplus</span><span class="p">,</span> <span class="s">&quot;rdirplus&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">Opt_nordirplus</span><span class="p">,</span> <span class="s">&quot;nordirplus&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">Opt_sharecache</span><span class="p">,</span> <span class="s">&quot;sharecache&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">Opt_nosharecache</span><span class="p">,</span> <span class="s">&quot;nosharecache&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">Opt_resvport</span><span class="p">,</span> <span class="s">&quot;resvport&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">Opt_noresvport</span><span class="p">,</span> <span class="s">&quot;noresvport&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">Opt_fscache</span><span class="p">,</span> <span class="s">&quot;fsc&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">Opt_nofscache</span><span class="p">,</span> <span class="s">&quot;nofsc&quot;</span> <span class="p">},</span>

	<span class="p">{</span> <span class="n">Opt_port</span><span class="p">,</span> <span class="s">&quot;port=%s&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">Opt_rsize</span><span class="p">,</span> <span class="s">&quot;rsize=%s&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">Opt_wsize</span><span class="p">,</span> <span class="s">&quot;wsize=%s&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">Opt_bsize</span><span class="p">,</span> <span class="s">&quot;bsize=%s&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">Opt_timeo</span><span class="p">,</span> <span class="s">&quot;timeo=%s&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">Opt_retrans</span><span class="p">,</span> <span class="s">&quot;retrans=%s&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">Opt_acregmin</span><span class="p">,</span> <span class="s">&quot;acregmin=%s&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">Opt_acregmax</span><span class="p">,</span> <span class="s">&quot;acregmax=%s&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">Opt_acdirmin</span><span class="p">,</span> <span class="s">&quot;acdirmin=%s&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">Opt_acdirmax</span><span class="p">,</span> <span class="s">&quot;acdirmax=%s&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">Opt_actimeo</span><span class="p">,</span> <span class="s">&quot;actimeo=%s&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">Opt_namelen</span><span class="p">,</span> <span class="s">&quot;namlen=%s&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">Opt_mountport</span><span class="p">,</span> <span class="s">&quot;mountport=%s&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">Opt_mountvers</span><span class="p">,</span> <span class="s">&quot;mountvers=%s&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">Opt_minorversion</span><span class="p">,</span> <span class="s">&quot;minorversion=%s&quot;</span> <span class="p">},</span>

	<span class="p">{</span> <span class="n">Opt_nfsvers</span><span class="p">,</span> <span class="s">&quot;nfsvers=%s&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">Opt_nfsvers</span><span class="p">,</span> <span class="s">&quot;vers=%s&quot;</span> <span class="p">},</span>

	<span class="p">{</span> <span class="n">Opt_sec</span><span class="p">,</span> <span class="s">&quot;sec=%s&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">Opt_proto</span><span class="p">,</span> <span class="s">&quot;proto=%s&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">Opt_mountproto</span><span class="p">,</span> <span class="s">&quot;mountproto=%s&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">Opt_addr</span><span class="p">,</span> <span class="s">&quot;addr=%s&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">Opt_clientaddr</span><span class="p">,</span> <span class="s">&quot;clientaddr=%s&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">Opt_mounthost</span><span class="p">,</span> <span class="s">&quot;mounthost=%s&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">Opt_mountaddr</span><span class="p">,</span> <span class="s">&quot;mountaddr=%s&quot;</span> <span class="p">},</span>

	<span class="p">{</span> <span class="n">Opt_lookupcache</span><span class="p">,</span> <span class="s">&quot;lookupcache=%s&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">Opt_fscache_uniq</span><span class="p">,</span> <span class="s">&quot;fsc=%s&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">Opt_local_lock</span><span class="p">,</span> <span class="s">&quot;local_lock=%s&quot;</span> <span class="p">},</span>

	<span class="cm">/* The following needs to be listed after all other options */</span>
	<span class="p">{</span> <span class="n">Opt_nfsvers</span><span class="p">,</span> <span class="s">&quot;v%s&quot;</span> <span class="p">},</span>

	<span class="p">{</span> <span class="n">Opt_err</span><span class="p">,</span> <span class="nb">NULL</span> <span class="p">}</span>
<span class="p">};</span>

<span class="k">enum</span> <span class="p">{</span>
	<span class="n">Opt_xprt_udp</span><span class="p">,</span> <span class="n">Opt_xprt_udp6</span><span class="p">,</span> <span class="n">Opt_xprt_tcp</span><span class="p">,</span> <span class="n">Opt_xprt_tcp6</span><span class="p">,</span> <span class="n">Opt_xprt_rdma</span><span class="p">,</span>

	<span class="n">Opt_xprt_err</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="n">match_table_t</span> <span class="n">nfs_xprt_protocol_tokens</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="n">Opt_xprt_udp</span><span class="p">,</span> <span class="s">&quot;udp&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">Opt_xprt_udp6</span><span class="p">,</span> <span class="s">&quot;udp6&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">Opt_xprt_tcp</span><span class="p">,</span> <span class="s">&quot;tcp&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">Opt_xprt_tcp6</span><span class="p">,</span> <span class="s">&quot;tcp6&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">Opt_xprt_rdma</span><span class="p">,</span> <span class="s">&quot;rdma&quot;</span> <span class="p">},</span>

	<span class="p">{</span> <span class="n">Opt_xprt_err</span><span class="p">,</span> <span class="nb">NULL</span> <span class="p">}</span>
<span class="p">};</span>

<span class="k">enum</span> <span class="p">{</span>
	<span class="n">Opt_sec_none</span><span class="p">,</span> <span class="n">Opt_sec_sys</span><span class="p">,</span>
	<span class="n">Opt_sec_krb5</span><span class="p">,</span> <span class="n">Opt_sec_krb5i</span><span class="p">,</span> <span class="n">Opt_sec_krb5p</span><span class="p">,</span>
	<span class="n">Opt_sec_lkey</span><span class="p">,</span> <span class="n">Opt_sec_lkeyi</span><span class="p">,</span> <span class="n">Opt_sec_lkeyp</span><span class="p">,</span>
	<span class="n">Opt_sec_spkm</span><span class="p">,</span> <span class="n">Opt_sec_spkmi</span><span class="p">,</span> <span class="n">Opt_sec_spkmp</span><span class="p">,</span>

	<span class="n">Opt_sec_err</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="n">match_table_t</span> <span class="n">nfs_secflavor_tokens</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="n">Opt_sec_none</span><span class="p">,</span> <span class="s">&quot;none&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">Opt_sec_none</span><span class="p">,</span> <span class="s">&quot;null&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">Opt_sec_sys</span><span class="p">,</span> <span class="s">&quot;sys&quot;</span> <span class="p">},</span>

	<span class="p">{</span> <span class="n">Opt_sec_krb5</span><span class="p">,</span> <span class="s">&quot;krb5&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">Opt_sec_krb5i</span><span class="p">,</span> <span class="s">&quot;krb5i&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">Opt_sec_krb5p</span><span class="p">,</span> <span class="s">&quot;krb5p&quot;</span> <span class="p">},</span>

	<span class="p">{</span> <span class="n">Opt_sec_lkey</span><span class="p">,</span> <span class="s">&quot;lkey&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">Opt_sec_lkeyi</span><span class="p">,</span> <span class="s">&quot;lkeyi&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">Opt_sec_lkeyp</span><span class="p">,</span> <span class="s">&quot;lkeyp&quot;</span> <span class="p">},</span>

	<span class="p">{</span> <span class="n">Opt_sec_spkm</span><span class="p">,</span> <span class="s">&quot;spkm3&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">Opt_sec_spkmi</span><span class="p">,</span> <span class="s">&quot;spkm3i&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">Opt_sec_spkmp</span><span class="p">,</span> <span class="s">&quot;spkm3p&quot;</span> <span class="p">},</span>

	<span class="p">{</span> <span class="n">Opt_sec_err</span><span class="p">,</span> <span class="nb">NULL</span> <span class="p">}</span>
<span class="p">};</span>

<span class="k">enum</span> <span class="p">{</span>
	<span class="n">Opt_lookupcache_all</span><span class="p">,</span> <span class="n">Opt_lookupcache_positive</span><span class="p">,</span>
	<span class="n">Opt_lookupcache_none</span><span class="p">,</span>

	<span class="n">Opt_lookupcache_err</span>
<span class="p">};</span>

<span class="k">static</span> <span class="n">match_table_t</span> <span class="n">nfs_lookupcache_tokens</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="n">Opt_lookupcache_all</span><span class="p">,</span> <span class="s">&quot;all&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">Opt_lookupcache_positive</span><span class="p">,</span> <span class="s">&quot;pos&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">Opt_lookupcache_positive</span><span class="p">,</span> <span class="s">&quot;positive&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">Opt_lookupcache_none</span><span class="p">,</span> <span class="s">&quot;none&quot;</span> <span class="p">},</span>

	<span class="p">{</span> <span class="n">Opt_lookupcache_err</span><span class="p">,</span> <span class="nb">NULL</span> <span class="p">}</span>
<span class="p">};</span>

<span class="k">enum</span> <span class="p">{</span>
	<span class="n">Opt_local_lock_all</span><span class="p">,</span> <span class="n">Opt_local_lock_flock</span><span class="p">,</span> <span class="n">Opt_local_lock_posix</span><span class="p">,</span>
	<span class="n">Opt_local_lock_none</span><span class="p">,</span>

	<span class="n">Opt_local_lock_err</span>
<span class="p">};</span>

<span class="k">static</span> <span class="n">match_table_t</span> <span class="n">nfs_local_lock_tokens</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="n">Opt_local_lock_all</span><span class="p">,</span> <span class="s">&quot;all&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">Opt_local_lock_flock</span><span class="p">,</span> <span class="s">&quot;flock&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">Opt_local_lock_posix</span><span class="p">,</span> <span class="s">&quot;posix&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">Opt_local_lock_none</span><span class="p">,</span> <span class="s">&quot;none&quot;</span> <span class="p">},</span>

	<span class="p">{</span> <span class="n">Opt_local_lock_err</span><span class="p">,</span> <span class="nb">NULL</span> <span class="p">}</span>
<span class="p">};</span>

<span class="k">enum</span> <span class="p">{</span>
	<span class="n">Opt_vers_2</span><span class="p">,</span> <span class="n">Opt_vers_3</span><span class="p">,</span> <span class="n">Opt_vers_4</span><span class="p">,</span> <span class="n">Opt_vers_4_0</span><span class="p">,</span>
	<span class="n">Opt_vers_4_1</span><span class="p">,</span>

	<span class="n">Opt_vers_err</span>
<span class="p">};</span>

<span class="k">static</span> <span class="n">match_table_t</span> <span class="n">nfs_vers_tokens</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="n">Opt_vers_2</span><span class="p">,</span> <span class="s">&quot;2&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">Opt_vers_3</span><span class="p">,</span> <span class="s">&quot;3&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">Opt_vers_4</span><span class="p">,</span> <span class="s">&quot;4&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">Opt_vers_4_0</span><span class="p">,</span> <span class="s">&quot;4.0&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">Opt_vers_4_1</span><span class="p">,</span> <span class="s">&quot;4.1&quot;</span> <span class="p">},</span>

	<span class="p">{</span> <span class="n">Opt_vers_err</span><span class="p">,</span> <span class="nb">NULL</span> <span class="p">}</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">nfs_mount_info</span> <span class="p">{</span>
	<span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">fill_super</span><span class="p">)(</span><span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nfs_mount_info</span> <span class="o">*</span><span class="p">);</span>
	<span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">set_security</span><span class="p">)(</span><span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="p">,</span> <span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nfs_mount_info</span> <span class="o">*</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">nfs_parsed_mount_data</span> <span class="o">*</span><span class="n">parsed</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nfs_clone_mount</span> <span class="o">*</span><span class="n">cloned</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nfs_fh</span> <span class="o">*</span><span class="n">mntfh</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">nfs_umount_begin</span><span class="p">(</span><span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span>  <span class="n">nfs_statfs</span><span class="p">(</span><span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="p">,</span> <span class="k">struct</span> <span class="n">kstatfs</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span>  <span class="n">nfs_show_options</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="p">,</span> <span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span>  <span class="n">nfs_show_devname</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="p">,</span> <span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span>  <span class="n">nfs_show_path</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="p">,</span> <span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span>  <span class="n">nfs_show_stats</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="p">,</span> <span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="n">nfs_fs_mount_common</span><span class="p">(</span><span class="k">struct</span> <span class="n">file_system_type</span> <span class="o">*</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">nfs_server</span> <span class="o">*</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nfs_mount_info</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="n">nfs_fs_mount</span><span class="p">(</span><span class="k">struct</span> <span class="n">file_system_type</span> <span class="o">*</span><span class="p">,</span>
		<span class="kt">int</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="n">nfs_xdev_mount</span><span class="p">(</span><span class="k">struct</span> <span class="n">file_system_type</span> <span class="o">*</span><span class="n">fs_type</span><span class="p">,</span>
		<span class="kt">int</span> <span class="n">flags</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">dev_name</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">raw_data</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">nfs_put_super</span><span class="p">(</span><span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">nfs_kill_super</span><span class="p">(</span><span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">nfs_remount</span><span class="p">(</span><span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">sb</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">flags</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">raw_data</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">file_system_type</span> <span class="n">nfs_fs_type</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span>		<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;nfs&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">mount</span>		<span class="o">=</span> <span class="n">nfs_fs_mount</span><span class="p">,</span>
	<span class="p">.</span><span class="n">kill_sb</span>	<span class="o">=</span> <span class="n">nfs_kill_super</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fs_flags</span>	<span class="o">=</span> <span class="n">FS_RENAME_DOES_D_MOVE</span><span class="o">|</span><span class="n">FS_REVAL_DOT</span><span class="o">|</span><span class="n">FS_BINARY_MOUNTDATA</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">file_system_type</span> <span class="n">nfs_xdev_fs_type</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span>		<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;nfs&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">mount</span>		<span class="o">=</span> <span class="n">nfs_xdev_mount</span><span class="p">,</span>
	<span class="p">.</span><span class="n">kill_sb</span>	<span class="o">=</span> <span class="n">nfs_kill_super</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fs_flags</span>	<span class="o">=</span> <span class="n">FS_RENAME_DOES_D_MOVE</span><span class="o">|</span><span class="n">FS_REVAL_DOT</span><span class="o">|</span><span class="n">FS_BINARY_MOUNTDATA</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">super_operations</span> <span class="n">nfs_sops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">alloc_inode</span>	<span class="o">=</span> <span class="n">nfs_alloc_inode</span><span class="p">,</span>
	<span class="p">.</span><span class="n">destroy_inode</span>	<span class="o">=</span> <span class="n">nfs_destroy_inode</span><span class="p">,</span>
	<span class="p">.</span><span class="n">write_inode</span>	<span class="o">=</span> <span class="n">nfs_write_inode</span><span class="p">,</span>
	<span class="p">.</span><span class="n">put_super</span>	<span class="o">=</span> <span class="n">nfs_put_super</span><span class="p">,</span>
	<span class="p">.</span><span class="n">statfs</span>		<span class="o">=</span> <span class="n">nfs_statfs</span><span class="p">,</span>
	<span class="p">.</span><span class="n">evict_inode</span>	<span class="o">=</span> <span class="n">nfs_evict_inode</span><span class="p">,</span>
	<span class="p">.</span><span class="n">umount_begin</span>	<span class="o">=</span> <span class="n">nfs_umount_begin</span><span class="p">,</span>
	<span class="p">.</span><span class="n">show_options</span>	<span class="o">=</span> <span class="n">nfs_show_options</span><span class="p">,</span>
	<span class="p">.</span><span class="n">show_devname</span>	<span class="o">=</span> <span class="n">nfs_show_devname</span><span class="p">,</span>
	<span class="p">.</span><span class="n">show_path</span>	<span class="o">=</span> <span class="n">nfs_show_path</span><span class="p">,</span>
	<span class="p">.</span><span class="n">show_stats</span>	<span class="o">=</span> <span class="n">nfs_show_stats</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remount_fs</span>	<span class="o">=</span> <span class="n">nfs_remount</span><span class="p">,</span>
<span class="p">};</span>

<span class="cp">#ifdef CONFIG_NFS_V4</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">nfs4_validate_mount_flags</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs_parsed_mount_data</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">nfs4_validate_mount_data</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">options</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">nfs_parsed_mount_data</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">dev_name</span><span class="p">);</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="n">nfs4_try_mount</span><span class="p">(</span><span class="kt">int</span> <span class="n">flags</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">dev_name</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">nfs_mount_info</span> <span class="o">*</span><span class="n">mount_info</span><span class="p">);</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="n">nfs4_remote_mount</span><span class="p">(</span><span class="k">struct</span> <span class="n">file_system_type</span> <span class="o">*</span><span class="n">fs_type</span><span class="p">,</span>
	<span class="kt">int</span> <span class="n">flags</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">dev_name</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">raw_data</span><span class="p">);</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="n">nfs4_xdev_mount</span><span class="p">(</span><span class="k">struct</span> <span class="n">file_system_type</span> <span class="o">*</span><span class="n">fs_type</span><span class="p">,</span>
	<span class="kt">int</span> <span class="n">flags</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">dev_name</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">raw_data</span><span class="p">);</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="n">nfs4_referral_mount</span><span class="p">(</span><span class="k">struct</span> <span class="n">file_system_type</span> <span class="o">*</span><span class="n">fs_type</span><span class="p">,</span>
	<span class="kt">int</span> <span class="n">flags</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">dev_name</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">raw_data</span><span class="p">);</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="n">nfs4_remote_referral_mount</span><span class="p">(</span><span class="k">struct</span> <span class="n">file_system_type</span> <span class="o">*</span><span class="n">fs_type</span><span class="p">,</span>
	<span class="kt">int</span> <span class="n">flags</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">dev_name</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">raw_data</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">nfs4_kill_super</span><span class="p">(</span><span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">sb</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">file_system_type</span> <span class="n">nfs4_fs_type</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span>		<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;nfs4&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">mount</span>		<span class="o">=</span> <span class="n">nfs_fs_mount</span><span class="p">,</span>
	<span class="p">.</span><span class="n">kill_sb</span>	<span class="o">=</span> <span class="n">nfs4_kill_super</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fs_flags</span>	<span class="o">=</span> <span class="n">FS_RENAME_DOES_D_MOVE</span><span class="o">|</span><span class="n">FS_REVAL_DOT</span><span class="o">|</span><span class="n">FS_BINARY_MOUNTDATA</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">file_system_type</span> <span class="n">nfs4_remote_fs_type</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span>		<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;nfs4&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">mount</span>		<span class="o">=</span> <span class="n">nfs4_remote_mount</span><span class="p">,</span>
	<span class="p">.</span><span class="n">kill_sb</span>	<span class="o">=</span> <span class="n">nfs4_kill_super</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fs_flags</span>	<span class="o">=</span> <span class="n">FS_RENAME_DOES_D_MOVE</span><span class="o">|</span><span class="n">FS_REVAL_DOT</span><span class="o">|</span><span class="n">FS_BINARY_MOUNTDATA</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">file_system_type</span> <span class="n">nfs4_xdev_fs_type</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span>		<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;nfs4&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">mount</span>		<span class="o">=</span> <span class="n">nfs4_xdev_mount</span><span class="p">,</span>
	<span class="p">.</span><span class="n">kill_sb</span>	<span class="o">=</span> <span class="n">nfs4_kill_super</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fs_flags</span>	<span class="o">=</span> <span class="n">FS_RENAME_DOES_D_MOVE</span><span class="o">|</span><span class="n">FS_REVAL_DOT</span><span class="o">|</span><span class="n">FS_BINARY_MOUNTDATA</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">file_system_type</span> <span class="n">nfs4_remote_referral_fs_type</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span>		<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;nfs4&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">mount</span>		<span class="o">=</span> <span class="n">nfs4_remote_referral_mount</span><span class="p">,</span>
	<span class="p">.</span><span class="n">kill_sb</span>	<span class="o">=</span> <span class="n">nfs4_kill_super</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fs_flags</span>	<span class="o">=</span> <span class="n">FS_RENAME_DOES_D_MOVE</span><span class="o">|</span><span class="n">FS_REVAL_DOT</span><span class="o">|</span><span class="n">FS_BINARY_MOUNTDATA</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">file_system_type</span> <span class="n">nfs4_referral_fs_type</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span>		<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;nfs4&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">mount</span>		<span class="o">=</span> <span class="n">nfs4_referral_mount</span><span class="p">,</span>
	<span class="p">.</span><span class="n">kill_sb</span>	<span class="o">=</span> <span class="n">nfs4_kill_super</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fs_flags</span>	<span class="o">=</span> <span class="n">FS_RENAME_DOES_D_MOVE</span><span class="o">|</span><span class="n">FS_REVAL_DOT</span><span class="o">|</span><span class="n">FS_BINARY_MOUNTDATA</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">super_operations</span> <span class="n">nfs4_sops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">alloc_inode</span>	<span class="o">=</span> <span class="n">nfs_alloc_inode</span><span class="p">,</span>
	<span class="p">.</span><span class="n">destroy_inode</span>	<span class="o">=</span> <span class="n">nfs_destroy_inode</span><span class="p">,</span>
	<span class="p">.</span><span class="n">write_inode</span>	<span class="o">=</span> <span class="n">nfs_write_inode</span><span class="p">,</span>
	<span class="p">.</span><span class="n">put_super</span>	<span class="o">=</span> <span class="n">nfs_put_super</span><span class="p">,</span>
	<span class="p">.</span><span class="n">statfs</span>		<span class="o">=</span> <span class="n">nfs_statfs</span><span class="p">,</span>
	<span class="p">.</span><span class="n">evict_inode</span>	<span class="o">=</span> <span class="n">nfs4_evict_inode</span><span class="p">,</span>
	<span class="p">.</span><span class="n">umount_begin</span>	<span class="o">=</span> <span class="n">nfs_umount_begin</span><span class="p">,</span>
	<span class="p">.</span><span class="n">show_options</span>	<span class="o">=</span> <span class="n">nfs_show_options</span><span class="p">,</span>
	<span class="p">.</span><span class="n">show_devname</span>	<span class="o">=</span> <span class="n">nfs_show_devname</span><span class="p">,</span>
	<span class="p">.</span><span class="n">show_path</span>	<span class="o">=</span> <span class="n">nfs_show_path</span><span class="p">,</span>
	<span class="p">.</span><span class="n">show_stats</span>	<span class="o">=</span> <span class="n">nfs_show_stats</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remount_fs</span>	<span class="o">=</span> <span class="n">nfs_remount</span><span class="p">,</span>
<span class="p">};</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">shrinker</span> <span class="n">acl_shrinker</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">shrink</span>		<span class="o">=</span> <span class="n">nfs_access_cache_shrinker</span><span class="p">,</span>
	<span class="p">.</span><span class="n">seeks</span>		<span class="o">=</span> <span class="n">DEFAULT_SEEKS</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * Register the NFS filesystems</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="n">__init</span> <span class="nf">register_nfs_fs</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

        <span class="n">ret</span> <span class="o">=</span> <span class="n">register_filesystem</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nfs_fs_type</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error_0</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">nfs_register_sysctl</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error_1</span><span class="p">;</span>
<span class="cp">#ifdef CONFIG_NFS_V4</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">register_filesystem</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nfs4_fs_type</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error_2</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="n">register_shrinker</span><span class="p">(</span><span class="o">&amp;</span><span class="n">acl_shrinker</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_NFS_V4</span>
<span class="nl">error_2:</span>
	<span class="n">nfs_unregister_sysctl</span><span class="p">();</span>
<span class="cp">#endif</span>
<span class="nl">error_1:</span>
	<span class="n">unregister_filesystem</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nfs_fs_type</span><span class="p">);</span>
<span class="nl">error_0:</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Unregister the NFS filesystems</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="n">__exit</span> <span class="nf">unregister_nfs_fs</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">unregister_shrinker</span><span class="p">(</span><span class="o">&amp;</span><span class="n">acl_shrinker</span><span class="p">);</span>
<span class="cp">#ifdef CONFIG_NFS_V4</span>
	<span class="n">unregister_filesystem</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nfs4_fs_type</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="n">nfs_unregister_sysctl</span><span class="p">();</span>
	<span class="n">unregister_filesystem</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nfs_fs_type</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">nfs_sb_active</span><span class="p">(</span><span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">sb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfs_server</span> <span class="o">*</span><span class="n">server</span> <span class="o">=</span> <span class="n">NFS_SB</span><span class="p">(</span><span class="n">sb</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">atomic_inc_return</span><span class="p">(</span><span class="o">&amp;</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">active</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_active</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">nfs_sb_deactive</span><span class="p">(</span><span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">sb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfs_server</span> <span class="o">*</span><span class="n">server</span> <span class="o">=</span> <span class="n">NFS_SB</span><span class="p">(</span><span class="n">sb</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">atomic_dec_and_test</span><span class="p">(</span><span class="o">&amp;</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">active</span><span class="p">))</span>
		<span class="n">deactivate_super</span><span class="p">(</span><span class="n">sb</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Deliver file system statistics to userspace</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">nfs_statfs</span><span class="p">(</span><span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="n">dentry</span><span class="p">,</span> <span class="k">struct</span> <span class="n">kstatfs</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfs_server</span> <span class="o">*</span><span class="n">server</span> <span class="o">=</span> <span class="n">NFS_SB</span><span class="p">(</span><span class="n">dentry</span><span class="o">-&gt;</span><span class="n">d_sb</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">blockbits</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">blockres</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nfs_fh</span> <span class="o">*</span><span class="n">fh</span> <span class="o">=</span> <span class="n">NFS_FH</span><span class="p">(</span><span class="n">dentry</span><span class="o">-&gt;</span><span class="n">d_inode</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">nfs_fsstat</span> <span class="n">res</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">res</span><span class="p">.</span><span class="n">fattr</span> <span class="o">=</span> <span class="n">nfs_alloc_fattr</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="p">.</span><span class="n">fattr</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_err</span><span class="p">;</span>

	<span class="n">error</span> <span class="o">=</span> <span class="n">server</span><span class="o">-&gt;</span><span class="n">nfs_client</span><span class="o">-&gt;</span><span class="n">rpc_ops</span><span class="o">-&gt;</span><span class="n">statfs</span><span class="p">(</span><span class="n">server</span><span class="p">,</span> <span class="n">fh</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">res</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">error</span> <span class="o">==</span> <span class="o">-</span><span class="n">ESTALE</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="n">pd_dentry</span><span class="p">;</span>

		<span class="n">pd_dentry</span> <span class="o">=</span> <span class="n">dget_parent</span><span class="p">(</span><span class="n">dentry</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pd_dentry</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">nfs_zap_caches</span><span class="p">(</span><span class="n">pd_dentry</span><span class="o">-&gt;</span><span class="n">d_inode</span><span class="p">);</span>
			<span class="n">dput</span><span class="p">(</span><span class="n">pd_dentry</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">nfs_free_fattr</span><span class="p">(</span><span class="n">res</span><span class="p">.</span><span class="n">fattr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_err</span><span class="p">;</span>

	<span class="n">buf</span><span class="o">-&gt;</span><span class="n">f_type</span> <span class="o">=</span> <span class="n">NFS_SUPER_MAGIC</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Current versions of glibc do not correctly handle the</span>
<span class="cm">	 * case where f_frsize != f_bsize.  Eventually we want to</span>
<span class="cm">	 * report the value of wtmult in this field.</span>
<span class="cm">	 */</span>
	<span class="n">buf</span><span class="o">-&gt;</span><span class="n">f_frsize</span> <span class="o">=</span> <span class="n">dentry</span><span class="o">-&gt;</span><span class="n">d_sb</span><span class="o">-&gt;</span><span class="n">s_blocksize</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * On most *nix systems, f_blocks, f_bfree, and f_bavail</span>
<span class="cm">	 * are reported in units of f_frsize.  Linux hasn&#39;t had</span>
<span class="cm">	 * an f_frsize field in its statfs struct until recently,</span>
<span class="cm">	 * thus historically Linux&#39;s sys_statfs reports these</span>
<span class="cm">	 * fields in units of f_bsize.</span>
<span class="cm">	 */</span>
	<span class="n">buf</span><span class="o">-&gt;</span><span class="n">f_bsize</span> <span class="o">=</span> <span class="n">dentry</span><span class="o">-&gt;</span><span class="n">d_sb</span><span class="o">-&gt;</span><span class="n">s_blocksize</span><span class="p">;</span>
	<span class="n">blockbits</span> <span class="o">=</span> <span class="n">dentry</span><span class="o">-&gt;</span><span class="n">d_sb</span><span class="o">-&gt;</span><span class="n">s_blocksize_bits</span><span class="p">;</span>
	<span class="n">blockres</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">blockbits</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">buf</span><span class="o">-&gt;</span><span class="n">f_blocks</span> <span class="o">=</span> <span class="p">(</span><span class="n">res</span><span class="p">.</span><span class="n">tbytes</span> <span class="o">+</span> <span class="n">blockres</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">blockbits</span><span class="p">;</span>
	<span class="n">buf</span><span class="o">-&gt;</span><span class="n">f_bfree</span> <span class="o">=</span> <span class="p">(</span><span class="n">res</span><span class="p">.</span><span class="n">fbytes</span> <span class="o">+</span> <span class="n">blockres</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">blockbits</span><span class="p">;</span>
	<span class="n">buf</span><span class="o">-&gt;</span><span class="n">f_bavail</span> <span class="o">=</span> <span class="p">(</span><span class="n">res</span><span class="p">.</span><span class="n">abytes</span> <span class="o">+</span> <span class="n">blockres</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">blockbits</span><span class="p">;</span>

	<span class="n">buf</span><span class="o">-&gt;</span><span class="n">f_files</span> <span class="o">=</span> <span class="n">res</span><span class="p">.</span><span class="n">tfiles</span><span class="p">;</span>
	<span class="n">buf</span><span class="o">-&gt;</span><span class="n">f_ffree</span> <span class="o">=</span> <span class="n">res</span><span class="p">.</span><span class="n">afiles</span><span class="p">;</span>

	<span class="n">buf</span><span class="o">-&gt;</span><span class="n">f_namelen</span> <span class="o">=</span> <span class="n">server</span><span class="o">-&gt;</span><span class="n">namelen</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

 <span class="nl">out_err:</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s: statfs error = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="o">-</span><span class="n">error</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Map the security flavour number to a name</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="nf">nfs_pseudoflavour_to_name</span><span class="p">(</span><span class="n">rpc_authflavor_t</span> <span class="n">flavour</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="p">{</span>
		<span class="n">rpc_authflavor_t</span> <span class="n">flavour</span><span class="p">;</span>
		<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">str</span><span class="p">;</span>
	<span class="p">}</span> <span class="n">sec_flavours</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">{</span> <span class="n">RPC_AUTH_NULL</span><span class="p">,</span> <span class="s">&quot;null&quot;</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">RPC_AUTH_UNIX</span><span class="p">,</span> <span class="s">&quot;sys&quot;</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">RPC_AUTH_GSS_KRB5</span><span class="p">,</span> <span class="s">&quot;krb5&quot;</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">RPC_AUTH_GSS_KRB5I</span><span class="p">,</span> <span class="s">&quot;krb5i&quot;</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">RPC_AUTH_GSS_KRB5P</span><span class="p">,</span> <span class="s">&quot;krb5p&quot;</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">RPC_AUTH_GSS_LKEY</span><span class="p">,</span> <span class="s">&quot;lkey&quot;</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">RPC_AUTH_GSS_LKEYI</span><span class="p">,</span> <span class="s">&quot;lkeyi&quot;</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">RPC_AUTH_GSS_LKEYP</span><span class="p">,</span> <span class="s">&quot;lkeyp&quot;</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">RPC_AUTH_GSS_SPKM</span><span class="p">,</span> <span class="s">&quot;spkm&quot;</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">RPC_AUTH_GSS_SPKMI</span><span class="p">,</span> <span class="s">&quot;spkmi&quot;</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">RPC_AUTH_GSS_SPKMP</span><span class="p">,</span> <span class="s">&quot;spkmp&quot;</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">UINT_MAX</span><span class="p">,</span> <span class="s">&quot;unknown&quot;</span> <span class="p">}</span>
	<span class="p">};</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">sec_flavours</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">flavour</span> <span class="o">!=</span> <span class="n">UINT_MAX</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sec_flavours</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">flavour</span> <span class="o">==</span> <span class="n">flavour</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">sec_flavours</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">str</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">nfs_show_mountd_netid</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">m</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nfs_server</span> <span class="o">*</span><span class="n">nfss</span><span class="p">,</span>
				  <span class="kt">int</span> <span class="n">showdefaults</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="n">sap</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">nfss</span><span class="o">-&gt;</span><span class="n">mountd_address</span><span class="p">;</span>

	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;,mountproto=&quot;</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">sap</span><span class="o">-&gt;</span><span class="n">sa_family</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">AF_INET</span>:
		<span class="k">switch</span> <span class="p">(</span><span class="n">nfss</span><span class="o">-&gt;</span><span class="n">mountd_protocol</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">IPPROTO_UDP</span>:
			<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">RPCBIND_NETID_UDP</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">IPPROTO_TCP</span>:
			<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">RPCBIND_NETID_TCP</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">showdefaults</span><span class="p">)</span>
				<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;auto&quot;</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">AF_INET6</span>:
		<span class="k">switch</span> <span class="p">(</span><span class="n">nfss</span><span class="o">-&gt;</span><span class="n">mountd_protocol</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">IPPROTO_UDP</span>:
			<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">RPCBIND_NETID_UDP6</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">IPPROTO_TCP</span>:
			<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">RPCBIND_NETID_TCP6</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">showdefaults</span><span class="p">)</span>
				<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;auto&quot;</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">showdefaults</span><span class="p">)</span>
			<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;auto&quot;</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">nfs_show_mountd_options</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">m</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nfs_server</span> <span class="o">*</span><span class="n">nfss</span><span class="p">,</span>
				    <span class="kt">int</span> <span class="n">showdefaults</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="n">sap</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">nfss</span><span class="o">-&gt;</span><span class="n">mountd_address</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nfss</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">NFS_MOUNT_LEGACY_INTERFACE</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">sap</span><span class="o">-&gt;</span><span class="n">sa_family</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">AF_INET</span>: <span class="p">{</span>
		<span class="k">struct</span> <span class="n">sockaddr_in</span> <span class="o">*</span><span class="n">sin</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr_in</span> <span class="o">*</span><span class="p">)</span><span class="n">sap</span><span class="p">;</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;,mountaddr=%pI4&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sin</span><span class="o">-&gt;</span><span class="n">sin_addr</span><span class="p">.</span><span class="n">s_addr</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">case</span> <span class="n">AF_INET6</span>: <span class="p">{</span>
		<span class="k">struct</span> <span class="n">sockaddr_in6</span> <span class="o">*</span><span class="n">sin6</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr_in6</span> <span class="o">*</span><span class="p">)</span><span class="n">sap</span><span class="p">;</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;,mountaddr=%pI6c&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sin6</span><span class="o">-&gt;</span><span class="n">sin6_addr</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="nl">default:</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">showdefaults</span><span class="p">)</span>
			<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;,mountaddr=unspecified&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nfss</span><span class="o">-&gt;</span><span class="n">mountd_version</span> <span class="o">||</span> <span class="n">showdefaults</span><span class="p">)</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;,mountvers=%u&quot;</span><span class="p">,</span> <span class="n">nfss</span><span class="o">-&gt;</span><span class="n">mountd_version</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">nfss</span><span class="o">-&gt;</span><span class="n">mountd_port</span> <span class="o">&amp;&amp;</span>
		<span class="n">nfss</span><span class="o">-&gt;</span><span class="n">mountd_port</span> <span class="o">!=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">short</span><span class="p">)</span><span class="n">NFS_UNSPEC_PORT</span><span class="p">)</span> <span class="o">||</span>
		<span class="n">showdefaults</span><span class="p">)</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;,mountport=%u&quot;</span><span class="p">,</span> <span class="n">nfss</span><span class="o">-&gt;</span><span class="n">mountd_port</span><span class="p">);</span>

	<span class="n">nfs_show_mountd_netid</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">nfss</span><span class="p">,</span> <span class="n">showdefaults</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_NFS_V4</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">nfs_show_nfsv4_options</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">m</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nfs_server</span> <span class="o">*</span><span class="n">nfss</span><span class="p">,</span>
				    <span class="kt">int</span> <span class="n">showdefaults</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfs_client</span> <span class="o">*</span><span class="n">clp</span> <span class="o">=</span> <span class="n">nfss</span><span class="o">-&gt;</span><span class="n">nfs_client</span><span class="p">;</span>

	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;,clientaddr=%s&quot;</span><span class="p">,</span> <span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_ipaddr</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#else</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">nfs_show_nfsv4_options</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">m</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nfs_server</span> <span class="o">*</span><span class="n">nfss</span><span class="p">,</span>
				    <span class="kt">int</span> <span class="n">showdefaults</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">nfs_show_nfs_version</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">m</span><span class="p">,</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">version</span><span class="p">,</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">minorversion</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;,vers=%u&quot;</span><span class="p">,</span> <span class="n">version</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">version</span> <span class="o">==</span> <span class="mi">4</span><span class="p">)</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;.%u&quot;</span><span class="p">,</span> <span class="n">minorversion</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Describe the mount options in force on this server representation</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">nfs_show_mount_options</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">m</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nfs_server</span> <span class="o">*</span><span class="n">nfss</span><span class="p">,</span>
				   <span class="kt">int</span> <span class="n">showdefaults</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">proc_nfs_info</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">flag</span><span class="p">;</span>
		<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">str</span><span class="p">;</span>
		<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">nostr</span><span class="p">;</span>
	<span class="p">}</span> <span class="n">nfs_info</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">{</span> <span class="n">NFS_MOUNT_SOFT</span><span class="p">,</span> <span class="s">&quot;,soft&quot;</span><span class="p">,</span> <span class="s">&quot;,hard&quot;</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">NFS_MOUNT_POSIX</span><span class="p">,</span> <span class="s">&quot;,posix&quot;</span><span class="p">,</span> <span class="s">&quot;&quot;</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">NFS_MOUNT_NOCTO</span><span class="p">,</span> <span class="s">&quot;,nocto&quot;</span><span class="p">,</span> <span class="s">&quot;&quot;</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">NFS_MOUNT_NOAC</span><span class="p">,</span> <span class="s">&quot;,noac&quot;</span><span class="p">,</span> <span class="s">&quot;&quot;</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">NFS_MOUNT_NONLM</span><span class="p">,</span> <span class="s">&quot;,nolock&quot;</span><span class="p">,</span> <span class="s">&quot;&quot;</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">NFS_MOUNT_NOACL</span><span class="p">,</span> <span class="s">&quot;,noacl&quot;</span><span class="p">,</span> <span class="s">&quot;&quot;</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">NFS_MOUNT_NORDIRPLUS</span><span class="p">,</span> <span class="s">&quot;,nordirplus&quot;</span><span class="p">,</span> <span class="s">&quot;&quot;</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">NFS_MOUNT_UNSHARED</span><span class="p">,</span> <span class="s">&quot;,nosharecache&quot;</span><span class="p">,</span> <span class="s">&quot;&quot;</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">NFS_MOUNT_NORESVPORT</span><span class="p">,</span> <span class="s">&quot;,noresvport&quot;</span><span class="p">,</span> <span class="s">&quot;&quot;</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span> <span class="p">}</span>
	<span class="p">};</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">proc_nfs_info</span> <span class="o">*</span><span class="n">nfs_infop</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nfs_client</span> <span class="o">*</span><span class="n">clp</span> <span class="o">=</span> <span class="n">nfss</span><span class="o">-&gt;</span><span class="n">nfs_client</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">version</span> <span class="o">=</span> <span class="n">clp</span><span class="o">-&gt;</span><span class="n">rpc_ops</span><span class="o">-&gt;</span><span class="n">version</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">local_flock</span><span class="p">,</span> <span class="n">local_fcntl</span><span class="p">;</span>

	<span class="n">nfs_show_nfs_version</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">version</span><span class="p">,</span> <span class="n">clp</span><span class="o">-&gt;</span><span class="n">cl_minorversion</span><span class="p">);</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;,rsize=%u&quot;</span><span class="p">,</span> <span class="n">nfss</span><span class="o">-&gt;</span><span class="n">rsize</span><span class="p">);</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;,wsize=%u&quot;</span><span class="p">,</span> <span class="n">nfss</span><span class="o">-&gt;</span><span class="n">wsize</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nfss</span><span class="o">-&gt;</span><span class="n">bsize</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;,bsize=%u&quot;</span><span class="p">,</span> <span class="n">nfss</span><span class="o">-&gt;</span><span class="n">bsize</span><span class="p">);</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;,namlen=%u&quot;</span><span class="p">,</span> <span class="n">nfss</span><span class="o">-&gt;</span><span class="n">namelen</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nfss</span><span class="o">-&gt;</span><span class="n">acregmin</span> <span class="o">!=</span> <span class="n">NFS_DEF_ACREGMIN</span><span class="o">*</span><span class="n">HZ</span> <span class="o">||</span> <span class="n">showdefaults</span><span class="p">)</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;,acregmin=%u&quot;</span><span class="p">,</span> <span class="n">nfss</span><span class="o">-&gt;</span><span class="n">acregmin</span><span class="o">/</span><span class="n">HZ</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nfss</span><span class="o">-&gt;</span><span class="n">acregmax</span> <span class="o">!=</span> <span class="n">NFS_DEF_ACREGMAX</span><span class="o">*</span><span class="n">HZ</span> <span class="o">||</span> <span class="n">showdefaults</span><span class="p">)</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;,acregmax=%u&quot;</span><span class="p">,</span> <span class="n">nfss</span><span class="o">-&gt;</span><span class="n">acregmax</span><span class="o">/</span><span class="n">HZ</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nfss</span><span class="o">-&gt;</span><span class="n">acdirmin</span> <span class="o">!=</span> <span class="n">NFS_DEF_ACDIRMIN</span><span class="o">*</span><span class="n">HZ</span> <span class="o">||</span> <span class="n">showdefaults</span><span class="p">)</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;,acdirmin=%u&quot;</span><span class="p">,</span> <span class="n">nfss</span><span class="o">-&gt;</span><span class="n">acdirmin</span><span class="o">/</span><span class="n">HZ</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nfss</span><span class="o">-&gt;</span><span class="n">acdirmax</span> <span class="o">!=</span> <span class="n">NFS_DEF_ACDIRMAX</span><span class="o">*</span><span class="n">HZ</span> <span class="o">||</span> <span class="n">showdefaults</span><span class="p">)</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;,acdirmax=%u&quot;</span><span class="p">,</span> <span class="n">nfss</span><span class="o">-&gt;</span><span class="n">acdirmax</span><span class="o">/</span><span class="n">HZ</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">nfs_infop</span> <span class="o">=</span> <span class="n">nfs_info</span><span class="p">;</span> <span class="n">nfs_infop</span><span class="o">-&gt;</span><span class="n">flag</span><span class="p">;</span> <span class="n">nfs_infop</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">nfss</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">nfs_infop</span><span class="o">-&gt;</span><span class="n">flag</span><span class="p">)</span>
			<span class="n">seq_puts</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">nfs_infop</span><span class="o">-&gt;</span><span class="n">str</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">seq_puts</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">nfs_infop</span><span class="o">-&gt;</span><span class="n">nostr</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">rcu_read_lock</span><span class="p">();</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;,proto=%s&quot;</span><span class="p">,</span>
		   <span class="n">rpc_peeraddr2str</span><span class="p">(</span><span class="n">nfss</span><span class="o">-&gt;</span><span class="n">client</span><span class="p">,</span> <span class="n">RPC_DISPLAY_NETID</span><span class="p">));</span>
	<span class="n">rcu_read_unlock</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">version</span> <span class="o">==</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">nfss</span><span class="o">-&gt;</span><span class="n">port</span> <span class="o">!=</span> <span class="n">NFS_PORT</span><span class="p">)</span>
			<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;,port=%u&quot;</span><span class="p">,</span> <span class="n">nfss</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">nfss</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">)</span>
			<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;,port=%u&quot;</span><span class="p">,</span> <span class="n">nfss</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">);</span>

	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;,timeo=%lu&quot;</span><span class="p">,</span> <span class="mi">10U</span> <span class="o">*</span> <span class="n">nfss</span><span class="o">-&gt;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">cl_timeout</span><span class="o">-&gt;</span><span class="n">to_initval</span> <span class="o">/</span> <span class="n">HZ</span><span class="p">);</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;,retrans=%u&quot;</span><span class="p">,</span> <span class="n">nfss</span><span class="o">-&gt;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">cl_timeout</span><span class="o">-&gt;</span><span class="n">to_retries</span><span class="p">);</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;,sec=%s&quot;</span><span class="p">,</span> <span class="n">nfs_pseudoflavour_to_name</span><span class="p">(</span><span class="n">nfss</span><span class="o">-&gt;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">cl_auth</span><span class="o">-&gt;</span><span class="n">au_flavor</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">version</span> <span class="o">!=</span> <span class="mi">4</span><span class="p">)</span>
		<span class="n">nfs_show_mountd_options</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">nfss</span><span class="p">,</span> <span class="n">showdefaults</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">nfs_show_nfsv4_options</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">nfss</span><span class="p">,</span> <span class="n">showdefaults</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nfss</span><span class="o">-&gt;</span><span class="n">options</span> <span class="o">&amp;</span> <span class="n">NFS_OPTION_FSCACHE</span><span class="p">)</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;,fsc&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nfss</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">NFS_MOUNT_LOOKUP_CACHE_NONEG</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">nfss</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">NFS_MOUNT_LOOKUP_CACHE_NONE</span><span class="p">)</span>
			<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;,lookupcache=none&quot;</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;,lookupcache=pos&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">local_flock</span> <span class="o">=</span> <span class="n">nfss</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">NFS_MOUNT_LOCAL_FLOCK</span><span class="p">;</span>
	<span class="n">local_fcntl</span> <span class="o">=</span> <span class="n">nfss</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">NFS_MOUNT_LOCAL_FCNTL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">local_flock</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">local_fcntl</span><span class="p">)</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;,local_lock=none&quot;</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">local_flock</span> <span class="o">&amp;&amp;</span> <span class="n">local_fcntl</span><span class="p">)</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;,local_lock=all&quot;</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">local_flock</span><span class="p">)</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;,local_lock=flock&quot;</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;,local_lock=posix&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Describe the mount options on this VFS mountpoint</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">nfs_show_options</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">m</span><span class="p">,</span> <span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="n">root</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfs_server</span> <span class="o">*</span><span class="n">nfss</span> <span class="o">=</span> <span class="n">NFS_SB</span><span class="p">(</span><span class="n">root</span><span class="o">-&gt;</span><span class="n">d_sb</span><span class="p">);</span>

	<span class="n">nfs_show_mount_options</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">nfss</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">rcu_read_lock</span><span class="p">();</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;,addr=%s&quot;</span><span class="p">,</span>
			<span class="n">rpc_peeraddr2str</span><span class="p">(</span><span class="n">nfss</span><span class="o">-&gt;</span><span class="n">nfs_client</span><span class="o">-&gt;</span><span class="n">cl_rpcclient</span><span class="p">,</span>
							<span class="n">RPC_DISPLAY_ADDR</span><span class="p">));</span>
	<span class="n">rcu_read_unlock</span><span class="p">();</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_NFS_V4</span>
<span class="cp">#ifdef CONFIG_NFS_V4_1</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">show_sessions</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">m</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nfs_server</span> <span class="o">*</span><span class="n">server</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nfs4_has_session</span><span class="p">(</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">nfs_client</span><span class="p">))</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;,sessions&quot;</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#else</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">show_sessions</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">m</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nfs_server</span> <span class="o">*</span><span class="n">server</span><span class="p">)</span> <span class="p">{}</span>
<span class="cp">#endif</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef CONFIG_NFS_V4_1</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">show_pnfs</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">m</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nfs_server</span> <span class="o">*</span><span class="n">server</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;,pnfs=&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">pnfs_curr_ld</span><span class="p">)</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">server</span><span class="o">-&gt;</span><span class="n">pnfs_curr_ld</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;not configured&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">show_implementation_id</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">m</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nfs_server</span> <span class="o">*</span><span class="n">nfss</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nfss</span><span class="o">-&gt;</span><span class="n">nfs_client</span> <span class="o">&amp;&amp;</span> <span class="n">nfss</span><span class="o">-&gt;</span><span class="n">nfs_client</span><span class="o">-&gt;</span><span class="n">cl_implid</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">nfs41_impl_id</span> <span class="o">*</span><span class="n">impl_id</span> <span class="o">=</span> <span class="n">nfss</span><span class="o">-&gt;</span><span class="n">nfs_client</span><span class="o">-&gt;</span><span class="n">cl_implid</span><span class="p">;</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n\t</span><span class="s">impl_id:</span><span class="se">\t</span><span class="s">name=&#39;%s&#39;,domain=&#39;%s&#39;,&quot;</span>
			   <span class="s">&quot;date=&#39;%llu,%u&#39;&quot;</span><span class="p">,</span>
			   <span class="n">impl_id</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">impl_id</span><span class="o">-&gt;</span><span class="n">domain</span><span class="p">,</span>
			   <span class="n">impl_id</span><span class="o">-&gt;</span><span class="n">date</span><span class="p">.</span><span class="n">seconds</span><span class="p">,</span> <span class="n">impl_id</span><span class="o">-&gt;</span><span class="n">date</span><span class="p">.</span><span class="n">nseconds</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>
<span class="cp">#else</span>
<span class="cp">#ifdef CONFIG_NFS_V4</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">show_pnfs</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">m</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nfs_server</span> <span class="o">*</span><span class="n">server</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">}</span>
<span class="cp">#endif</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">show_implementation_id</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">m</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nfs_server</span> <span class="o">*</span><span class="n">nfss</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">nfs_show_devname</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">m</span><span class="p">,</span> <span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="n">root</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">page</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">__get_free_page</span><span class="p">(</span><span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">devname</span><span class="p">,</span> <span class="o">*</span><span class="n">dummy</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">page</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">devname</span> <span class="o">=</span> <span class="n">nfs_path</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dummy</span><span class="p">,</span> <span class="n">root</span><span class="p">,</span> <span class="n">page</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">devname</span><span class="p">))</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">devname</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">seq_escape</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">devname</span><span class="p">,</span> <span class="s">&quot; </span><span class="se">\t\n\\</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">free_page</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">page</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">nfs_show_path</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">m</span><span class="p">,</span> <span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="n">dentry</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">seq_puts</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;/&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Present statistical information for this VFS mountpoint</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">nfs_show_stats</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">m</span><span class="p">,</span> <span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="n">root</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">cpu</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nfs_server</span> <span class="o">*</span><span class="n">nfss</span> <span class="o">=</span> <span class="n">NFS_SB</span><span class="p">(</span><span class="n">root</span><span class="o">-&gt;</span><span class="n">d_sb</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">rpc_auth</span> <span class="o">*</span><span class="n">auth</span> <span class="o">=</span> <span class="n">nfss</span><span class="o">-&gt;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">cl_auth</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nfs_iostats</span> <span class="n">totals</span> <span class="o">=</span> <span class="p">{</span> <span class="p">};</span>

	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;statvers=%s&quot;</span><span class="p">,</span> <span class="n">NFS_IOSTAT_VERS</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Display all mount option settings</span>
<span class="cm">	 */</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n\t</span><span class="s">opts:</span><span class="se">\t</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">seq_puts</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">root</span><span class="o">-&gt;</span><span class="n">d_sb</span><span class="o">-&gt;</span><span class="n">s_flags</span> <span class="o">&amp;</span> <span class="n">MS_RDONLY</span> <span class="o">?</span> <span class="s">&quot;ro&quot;</span> <span class="o">:</span> <span class="s">&quot;rw&quot;</span><span class="p">);</span>
	<span class="n">seq_puts</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">root</span><span class="o">-&gt;</span><span class="n">d_sb</span><span class="o">-&gt;</span><span class="n">s_flags</span> <span class="o">&amp;</span> <span class="n">MS_SYNCHRONOUS</span> <span class="o">?</span> <span class="s">&quot;,sync&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">);</span>
	<span class="n">seq_puts</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">root</span><span class="o">-&gt;</span><span class="n">d_sb</span><span class="o">-&gt;</span><span class="n">s_flags</span> <span class="o">&amp;</span> <span class="n">MS_NOATIME</span> <span class="o">?</span> <span class="s">&quot;,noatime&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">);</span>
	<span class="n">seq_puts</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">root</span><span class="o">-&gt;</span><span class="n">d_sb</span><span class="o">-&gt;</span><span class="n">s_flags</span> <span class="o">&amp;</span> <span class="n">MS_NODIRATIME</span> <span class="o">?</span> <span class="s">&quot;,nodiratime&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">);</span>
	<span class="n">nfs_show_mount_options</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">nfss</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n\t</span><span class="s">age:</span><span class="se">\t</span><span class="s">%lu&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">jiffies</span> <span class="o">-</span> <span class="n">nfss</span><span class="o">-&gt;</span><span class="n">mount_time</span><span class="p">)</span> <span class="o">/</span> <span class="n">HZ</span><span class="p">);</span>

	<span class="n">show_implementation_id</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">nfss</span><span class="p">);</span>

	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n\t</span><span class="s">caps:</span><span class="se">\t</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;caps=0x%x&quot;</span><span class="p">,</span> <span class="n">nfss</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">);</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;,wtmult=%u&quot;</span><span class="p">,</span> <span class="n">nfss</span><span class="o">-&gt;</span><span class="n">wtmult</span><span class="p">);</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;,dtsize=%u&quot;</span><span class="p">,</span> <span class="n">nfss</span><span class="o">-&gt;</span><span class="n">dtsize</span><span class="p">);</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;,bsize=%u&quot;</span><span class="p">,</span> <span class="n">nfss</span><span class="o">-&gt;</span><span class="n">bsize</span><span class="p">);</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;,namlen=%u&quot;</span><span class="p">,</span> <span class="n">nfss</span><span class="o">-&gt;</span><span class="n">namelen</span><span class="p">);</span>

<span class="cp">#ifdef CONFIG_NFS_V4</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nfss</span><span class="o">-&gt;</span><span class="n">nfs_client</span><span class="o">-&gt;</span><span class="n">rpc_ops</span><span class="o">-&gt;</span><span class="n">version</span> <span class="o">==</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n\t</span><span class="s">nfsv4:</span><span class="se">\t</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;bm0=0x%x&quot;</span><span class="p">,</span> <span class="n">nfss</span><span class="o">-&gt;</span><span class="n">attr_bitmask</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;,bm1=0x%x&quot;</span><span class="p">,</span> <span class="n">nfss</span><span class="o">-&gt;</span><span class="n">attr_bitmask</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;,acl=0x%x&quot;</span><span class="p">,</span> <span class="n">nfss</span><span class="o">-&gt;</span><span class="n">acl_bitmask</span><span class="p">);</span>
		<span class="n">show_sessions</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">nfss</span><span class="p">);</span>
		<span class="n">show_pnfs</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">nfss</span><span class="p">);</span>
	<span class="p">}</span>
<span class="cp">#endif</span>

	<span class="cm">/*</span>
<span class="cm">	 * Display security flavor in effect for this mount</span>
<span class="cm">	 */</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n\t</span><span class="s">sec:</span><span class="se">\t</span><span class="s">flavor=%u&quot;</span><span class="p">,</span> <span class="n">auth</span><span class="o">-&gt;</span><span class="n">au_ops</span><span class="o">-&gt;</span><span class="n">au_flavor</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">auth</span><span class="o">-&gt;</span><span class="n">au_flavor</span><span class="p">)</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;,pseudoflavor=%u&quot;</span><span class="p">,</span> <span class="n">auth</span><span class="o">-&gt;</span><span class="n">au_flavor</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Display superblock I/O counters</span>
<span class="cm">	 */</span>
	<span class="n">for_each_possible_cpu</span><span class="p">(</span><span class="n">cpu</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">nfs_iostats</span> <span class="o">*</span><span class="n">stats</span><span class="p">;</span>

		<span class="n">preempt_disable</span><span class="p">();</span>
		<span class="n">stats</span> <span class="o">=</span> <span class="n">per_cpu_ptr</span><span class="p">(</span><span class="n">nfss</span><span class="o">-&gt;</span><span class="n">io_stats</span><span class="p">,</span> <span class="n">cpu</span><span class="p">);</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">__NFSIOS_COUNTSMAX</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">totals</span><span class="p">.</span><span class="n">events</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+=</span> <span class="n">stats</span><span class="o">-&gt;</span><span class="n">events</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">__NFSIOS_BYTESMAX</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">totals</span><span class="p">.</span><span class="n">bytes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+=</span> <span class="n">stats</span><span class="o">-&gt;</span><span class="n">bytes</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
<span class="cp">#ifdef CONFIG_NFS_FSCACHE</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">__NFSIOS_FSCACHEMAX</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">totals</span><span class="p">.</span><span class="n">fscache</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+=</span> <span class="n">stats</span><span class="o">-&gt;</span><span class="n">fscache</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
<span class="cp">#endif</span>

		<span class="n">preempt_enable</span><span class="p">();</span>
	<span class="p">}</span>

	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n\t</span><span class="s">events:</span><span class="se">\t</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">__NFSIOS_COUNTSMAX</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;%lu &quot;</span><span class="p">,</span> <span class="n">totals</span><span class="p">.</span><span class="n">events</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n\t</span><span class="s">bytes:</span><span class="se">\t</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">__NFSIOS_BYTESMAX</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;%Lu &quot;</span><span class="p">,</span> <span class="n">totals</span><span class="p">.</span><span class="n">bytes</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
<span class="cp">#ifdef CONFIG_NFS_FSCACHE</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nfss</span><span class="o">-&gt;</span><span class="n">options</span> <span class="o">&amp;</span> <span class="n">NFS_OPTION_FSCACHE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n\t</span><span class="s">fsc:</span><span class="se">\t</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">__NFSIOS_FSCACHEMAX</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;%Lu &quot;</span><span class="p">,</span> <span class="n">totals</span><span class="p">.</span><span class="n">bytes</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">rpc_print_iostats</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">nfss</span><span class="o">-&gt;</span><span class="n">client</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Begin unmount by attempting to remove all automounted mountpoints we added</span>
<span class="cm"> * in response to xdev traversals and referrals</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">nfs_umount_begin</span><span class="p">(</span><span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">sb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfs_server</span> <span class="o">*</span><span class="n">server</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rpc_clnt</span> <span class="o">*</span><span class="n">rpc</span><span class="p">;</span>

	<span class="n">server</span> <span class="o">=</span> <span class="n">NFS_SB</span><span class="p">(</span><span class="n">sb</span><span class="p">);</span>
	<span class="cm">/* -EIO all pending I/O */</span>
	<span class="n">rpc</span> <span class="o">=</span> <span class="n">server</span><span class="o">-&gt;</span><span class="n">client_acl</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">rpc</span><span class="p">))</span>
		<span class="n">rpc_killall_tasks</span><span class="p">(</span><span class="n">rpc</span><span class="p">);</span>
	<span class="n">rpc</span> <span class="o">=</span> <span class="n">server</span><span class="o">-&gt;</span><span class="n">client</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">rpc</span><span class="p">))</span>
		<span class="n">rpc_killall_tasks</span><span class="p">(</span><span class="n">rpc</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">nfs_parsed_mount_data</span> <span class="o">*</span><span class="nf">nfs_alloc_parsed_mount_data</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfs_parsed_mount_data</span> <span class="o">*</span><span class="n">data</span><span class="p">;</span>

	<span class="n">data</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">data</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">acregmin</span>		<span class="o">=</span> <span class="n">NFS_DEF_ACREGMIN</span><span class="p">;</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">acregmax</span>		<span class="o">=</span> <span class="n">NFS_DEF_ACREGMAX</span><span class="p">;</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">acdirmin</span>		<span class="o">=</span> <span class="n">NFS_DEF_ACDIRMIN</span><span class="p">;</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">acdirmax</span>		<span class="o">=</span> <span class="n">NFS_DEF_ACDIRMAX</span><span class="p">;</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">mount_server</span><span class="p">.</span><span class="n">port</span>	<span class="o">=</span> <span class="n">NFS_UNSPEC_PORT</span><span class="p">;</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">nfs_server</span><span class="p">.</span><span class="n">port</span>	<span class="o">=</span> <span class="n">NFS_UNSPEC_PORT</span><span class="p">;</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">nfs_server</span><span class="p">.</span><span class="n">protocol</span> <span class="o">=</span> <span class="n">XPRT_TRANSPORT_TCP</span><span class="p">;</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">auth_flavors</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>	<span class="o">=</span> <span class="n">RPC_AUTH_UNIX</span><span class="p">;</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">auth_flavor_len</span>	<span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">minorversion</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">need_mount</span>	<span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">net</span>		<span class="o">=</span> <span class="n">current</span><span class="o">-&gt;</span><span class="n">nsproxy</span><span class="o">-&gt;</span><span class="n">net_ns</span><span class="p">;</span>
		<span class="n">security_init_mnt_opts</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">lsm_opts</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">data</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">nfs_free_parsed_mount_data</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs_parsed_mount_data</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">client_address</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">mount_server</span><span class="p">.</span><span class="n">hostname</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">nfs_server</span><span class="p">.</span><span class="n">export_path</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">nfs_server</span><span class="p">.</span><span class="n">hostname</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">fscache_uniq</span><span class="p">);</span>
		<span class="n">security_free_mnt_opts</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">lsm_opts</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Sanity-check a server address provided by the mount command.</span>
<span class="cm"> *</span>
<span class="cm"> * Address family must be initialized, and address must not be</span>
<span class="cm"> * the ANY address for that family.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">nfs_verify_server_address</span><span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">addr</span><span class="o">-&gt;</span><span class="n">sa_family</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">AF_INET</span>: <span class="p">{</span>
		<span class="k">struct</span> <span class="n">sockaddr_in</span> <span class="o">*</span><span class="n">sa</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr_in</span> <span class="o">*</span><span class="p">)</span><span class="n">addr</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">sa</span><span class="o">-&gt;</span><span class="n">sin_addr</span><span class="p">.</span><span class="n">s_addr</span> <span class="o">!=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">INADDR_ANY</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">case</span> <span class="n">AF_INET6</span>: <span class="p">{</span>
		<span class="k">struct</span> <span class="n">in6_addr</span> <span class="o">*</span><span class="n">sa</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">((</span><span class="k">struct</span> <span class="n">sockaddr_in6</span> <span class="o">*</span><span class="p">)</span><span class="n">addr</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">sin6_addr</span><span class="p">;</span>
		<span class="k">return</span> <span class="o">!</span><span class="n">ipv6_addr_any</span><span class="p">(</span><span class="n">sa</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">dfprintk</span><span class="p">(</span><span class="n">MOUNT</span><span class="p">,</span> <span class="s">&quot;NFS: Invalid IP address specified</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Select between a default port value and a user-specified port value.</span>
<span class="cm"> * If a zero value is set, then autobind will be used.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">nfs_set_port</span><span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="n">sap</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">port</span><span class="p">,</span>
				 <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">default_port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">port</span> <span class="o">==</span> <span class="n">NFS_UNSPEC_PORT</span><span class="p">)</span>
		<span class="o">*</span><span class="n">port</span> <span class="o">=</span> <span class="n">default_port</span><span class="p">;</span>

	<span class="n">rpc_set_port</span><span class="p">(</span><span class="n">sap</span><span class="p">,</span> <span class="o">*</span><span class="n">port</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Sanity check the NFS transport protocol.</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">nfs_validate_transport_protocol</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs_parsed_mount_data</span> <span class="o">*</span><span class="n">mnt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">mnt</span><span class="o">-&gt;</span><span class="n">nfs_server</span><span class="p">.</span><span class="n">protocol</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">XPRT_TRANSPORT_UDP</span>:
	<span class="k">case</span> <span class="n">XPRT_TRANSPORT_TCP</span>:
	<span class="k">case</span> <span class="n">XPRT_TRANSPORT_RDMA</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">mnt</span><span class="o">-&gt;</span><span class="n">nfs_server</span><span class="p">.</span><span class="n">protocol</span> <span class="o">=</span> <span class="n">XPRT_TRANSPORT_TCP</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * For text based NFSv2/v3 mounts, the mount protocol transport default</span>
<span class="cm"> * settings should depend upon the specified NFS transport.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">nfs_set_mount_transport_protocol</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs_parsed_mount_data</span> <span class="o">*</span><span class="n">mnt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">nfs_validate_transport_protocol</span><span class="p">(</span><span class="n">mnt</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mnt</span><span class="o">-&gt;</span><span class="n">mount_server</span><span class="p">.</span><span class="n">protocol</span> <span class="o">==</span> <span class="n">XPRT_TRANSPORT_UDP</span> <span class="o">||</span>
	    <span class="n">mnt</span><span class="o">-&gt;</span><span class="n">mount_server</span><span class="p">.</span><span class="n">protocol</span> <span class="o">==</span> <span class="n">XPRT_TRANSPORT_TCP</span><span class="p">)</span>
			<span class="k">return</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">mnt</span><span class="o">-&gt;</span><span class="n">nfs_server</span><span class="p">.</span><span class="n">protocol</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">XPRT_TRANSPORT_UDP</span>:
		<span class="n">mnt</span><span class="o">-&gt;</span><span class="n">mount_server</span><span class="p">.</span><span class="n">protocol</span> <span class="o">=</span> <span class="n">XPRT_TRANSPORT_UDP</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">XPRT_TRANSPORT_TCP</span>:
	<span class="k">case</span> <span class="n">XPRT_TRANSPORT_RDMA</span>:
		<span class="n">mnt</span><span class="o">-&gt;</span><span class="n">mount_server</span><span class="p">.</span><span class="n">protocol</span> <span class="o">=</span> <span class="n">XPRT_TRANSPORT_TCP</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Parse the value of the &#39;sec=&#39; option.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">nfs_parse_security_flavors</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">value</span><span class="p">,</span>
				      <span class="k">struct</span> <span class="n">nfs_parsed_mount_data</span> <span class="o">*</span><span class="n">mnt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">substring_t</span> <span class="n">args</span><span class="p">[</span><span class="n">MAX_OPT_ARGS</span><span class="p">];</span>

	<span class="n">dfprintk</span><span class="p">(</span><span class="n">MOUNT</span><span class="p">,</span> <span class="s">&quot;NFS: parsing sec=%s option</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">match_token</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">nfs_secflavor_tokens</span><span class="p">,</span> <span class="n">args</span><span class="p">))</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">Opt_sec_none</span>:
		<span class="n">mnt</span><span class="o">-&gt;</span><span class="n">auth_flavors</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">RPC_AUTH_NULL</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">Opt_sec_sys</span>:
		<span class="n">mnt</span><span class="o">-&gt;</span><span class="n">auth_flavors</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">RPC_AUTH_UNIX</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">Opt_sec_krb5</span>:
		<span class="n">mnt</span><span class="o">-&gt;</span><span class="n">auth_flavors</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">RPC_AUTH_GSS_KRB5</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">Opt_sec_krb5i</span>:
		<span class="n">mnt</span><span class="o">-&gt;</span><span class="n">auth_flavors</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">RPC_AUTH_GSS_KRB5I</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">Opt_sec_krb5p</span>:
		<span class="n">mnt</span><span class="o">-&gt;</span><span class="n">auth_flavors</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">RPC_AUTH_GSS_KRB5P</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">Opt_sec_lkey</span>:
		<span class="n">mnt</span><span class="o">-&gt;</span><span class="n">auth_flavors</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">RPC_AUTH_GSS_LKEY</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">Opt_sec_lkeyi</span>:
		<span class="n">mnt</span><span class="o">-&gt;</span><span class="n">auth_flavors</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">RPC_AUTH_GSS_LKEYI</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">Opt_sec_lkeyp</span>:
		<span class="n">mnt</span><span class="o">-&gt;</span><span class="n">auth_flavors</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">RPC_AUTH_GSS_LKEYP</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">Opt_sec_spkm</span>:
		<span class="n">mnt</span><span class="o">-&gt;</span><span class="n">auth_flavors</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">RPC_AUTH_GSS_SPKM</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">Opt_sec_spkmi</span>:
		<span class="n">mnt</span><span class="o">-&gt;</span><span class="n">auth_flavors</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">RPC_AUTH_GSS_SPKMI</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">Opt_sec_spkmp</span>:
		<span class="n">mnt</span><span class="o">-&gt;</span><span class="n">auth_flavors</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">RPC_AUTH_GSS_SPKMP</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mnt</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">NFS_MOUNT_SECFLAVOUR</span><span class="p">;</span>
	<span class="n">mnt</span><span class="o">-&gt;</span><span class="n">auth_flavor_len</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">nfs_parse_version_string</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">string</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">nfs_parsed_mount_data</span> <span class="o">*</span><span class="n">mnt</span><span class="p">,</span>
		<span class="n">substring_t</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">mnt</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">NFS_MOUNT_VER3</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">match_token</span><span class="p">(</span><span class="n">string</span><span class="p">,</span> <span class="n">nfs_vers_tokens</span><span class="p">,</span> <span class="n">args</span><span class="p">))</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">Opt_vers_2</span>:
		<span class="n">mnt</span><span class="o">-&gt;</span><span class="n">version</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">Opt_vers_3</span>:
		<span class="n">mnt</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">NFS_MOUNT_VER3</span><span class="p">;</span>
		<span class="n">mnt</span><span class="o">-&gt;</span><span class="n">version</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">Opt_vers_4</span>:
		<span class="cm">/* Backward compatibility option. In future,</span>
<span class="cm">		 * the mount program should always supply</span>
<span class="cm">		 * a NFSv4 minor version number.</span>
<span class="cm">		 */</span>
		<span class="n">mnt</span><span class="o">-&gt;</span><span class="n">version</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">Opt_vers_4_0</span>:
		<span class="n">mnt</span><span class="o">-&gt;</span><span class="n">version</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
		<span class="n">mnt</span><span class="o">-&gt;</span><span class="n">minorversion</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">Opt_vers_4_1</span>:
		<span class="n">mnt</span><span class="o">-&gt;</span><span class="n">version</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
		<span class="n">mnt</span><span class="o">-&gt;</span><span class="n">minorversion</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">nfs_get_option_str</span><span class="p">(</span><span class="n">substring_t</span> <span class="n">args</span><span class="p">[],</span> <span class="kt">char</span> <span class="o">**</span><span class="n">option</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">kfree</span><span class="p">(</span><span class="o">*</span><span class="n">option</span><span class="p">);</span>
	<span class="o">*</span><span class="n">option</span> <span class="o">=</span> <span class="n">match_strdup</span><span class="p">(</span><span class="n">args</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">!</span><span class="n">option</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">nfs_get_option_ul</span><span class="p">(</span><span class="n">substring_t</span> <span class="n">args</span><span class="p">[],</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">option</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">string</span><span class="p">;</span>

	<span class="n">string</span> <span class="o">=</span> <span class="n">match_strdup</span><span class="p">(</span><span class="n">args</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">string</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">strict_strtoul</span><span class="p">(</span><span class="n">string</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="n">option</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">string</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Error-check and convert a string of mount options from user space into</span>
<span class="cm"> * a data structure.  The whole mount string is processed; bad options are</span>
<span class="cm"> * skipped as they are encountered.  If there were no errors, return 1;</span>
<span class="cm"> * otherwise return 0 (zero).</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">nfs_parse_mount_options</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">raw</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">nfs_parsed_mount_data</span> <span class="o">*</span><span class="n">mnt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="o">*</span><span class="n">string</span><span class="p">,</span> <span class="o">*</span><span class="n">secdata</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">,</span> <span class="n">sloppy</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">invalid_option</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">protofamily</span> <span class="o">=</span> <span class="n">AF_UNSPEC</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">mountfamily</span> <span class="o">=</span> <span class="n">AF_UNSPEC</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">raw</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dfprintk</span><span class="p">(</span><span class="n">MOUNT</span><span class="p">,</span> <span class="s">&quot;NFS: mount options string was NULL.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">dfprintk</span><span class="p">(</span><span class="n">MOUNT</span><span class="p">,</span> <span class="s">&quot;NFS: nfs mount opts=&#39;%s&#39;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">raw</span><span class="p">);</span>

	<span class="n">secdata</span> <span class="o">=</span> <span class="n">alloc_secdata</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">secdata</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_nomem</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">security_sb_copy_data</span><span class="p">(</span><span class="n">raw</span><span class="p">,</span> <span class="n">secdata</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_security_failure</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">security_sb_parse_opts_str</span><span class="p">(</span><span class="n">secdata</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mnt</span><span class="o">-&gt;</span><span class="n">lsm_opts</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_security_failure</span><span class="p">;</span>

	<span class="n">free_secdata</span><span class="p">(</span><span class="n">secdata</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">((</span><span class="n">p</span> <span class="o">=</span> <span class="n">strsep</span><span class="p">(</span><span class="o">&amp;</span><span class="n">raw</span><span class="p">,</span> <span class="s">&quot;,&quot;</span><span class="p">))</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">substring_t</span> <span class="n">args</span><span class="p">[</span><span class="n">MAX_OPT_ARGS</span><span class="p">];</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">option</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">token</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!*</span><span class="n">p</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">dfprintk</span><span class="p">(</span><span class="n">MOUNT</span><span class="p">,</span> <span class="s">&quot;NFS:   parsing nfs mount option &#39;%s&#39;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">p</span><span class="p">);</span>

		<span class="n">token</span> <span class="o">=</span> <span class="n">match_token</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">nfs_mount_option_tokens</span><span class="p">,</span> <span class="n">args</span><span class="p">);</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">token</span><span class="p">)</span> <span class="p">{</span>

		<span class="cm">/*</span>
<span class="cm">		 * boolean options:  foo/nofoo</span>
<span class="cm">		 */</span>
		<span class="k">case</span> <span class="n">Opt_soft</span>:
			<span class="n">mnt</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">NFS_MOUNT_SOFT</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">Opt_hard</span>:
			<span class="n">mnt</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">NFS_MOUNT_SOFT</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">Opt_posix</span>:
			<span class="n">mnt</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">NFS_MOUNT_POSIX</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">Opt_noposix</span>:
			<span class="n">mnt</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">NFS_MOUNT_POSIX</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">Opt_cto</span>:
			<span class="n">mnt</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">NFS_MOUNT_NOCTO</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">Opt_nocto</span>:
			<span class="n">mnt</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">NFS_MOUNT_NOCTO</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">Opt_ac</span>:
			<span class="n">mnt</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">NFS_MOUNT_NOAC</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">Opt_noac</span>:
			<span class="n">mnt</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">NFS_MOUNT_NOAC</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">Opt_lock</span>:
			<span class="n">mnt</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">NFS_MOUNT_NONLM</span><span class="p">;</span>
			<span class="n">mnt</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">NFS_MOUNT_LOCAL_FLOCK</span> <span class="o">|</span>
					<span class="n">NFS_MOUNT_LOCAL_FCNTL</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">Opt_nolock</span>:
			<span class="n">mnt</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">NFS_MOUNT_NONLM</span><span class="p">;</span>
			<span class="n">mnt</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="p">(</span><span class="n">NFS_MOUNT_LOCAL_FLOCK</span> <span class="o">|</span>
				       <span class="n">NFS_MOUNT_LOCAL_FCNTL</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">Opt_udp</span>:
			<span class="n">mnt</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">NFS_MOUNT_TCP</span><span class="p">;</span>
			<span class="n">mnt</span><span class="o">-&gt;</span><span class="n">nfs_server</span><span class="p">.</span><span class="n">protocol</span> <span class="o">=</span> <span class="n">XPRT_TRANSPORT_UDP</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">Opt_tcp</span>:
			<span class="n">mnt</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">NFS_MOUNT_TCP</span><span class="p">;</span>
			<span class="n">mnt</span><span class="o">-&gt;</span><span class="n">nfs_server</span><span class="p">.</span><span class="n">protocol</span> <span class="o">=</span> <span class="n">XPRT_TRANSPORT_TCP</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">Opt_rdma</span>:
			<span class="n">mnt</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">NFS_MOUNT_TCP</span><span class="p">;</span> <span class="cm">/* for side protocols */</span>
			<span class="n">mnt</span><span class="o">-&gt;</span><span class="n">nfs_server</span><span class="p">.</span><span class="n">protocol</span> <span class="o">=</span> <span class="n">XPRT_TRANSPORT_RDMA</span><span class="p">;</span>
			<span class="n">xprt_load_transport</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">Opt_acl</span>:
			<span class="n">mnt</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">NFS_MOUNT_NOACL</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">Opt_noacl</span>:
			<span class="n">mnt</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">NFS_MOUNT_NOACL</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">Opt_rdirplus</span>:
			<span class="n">mnt</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">NFS_MOUNT_NORDIRPLUS</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">Opt_nordirplus</span>:
			<span class="n">mnt</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">NFS_MOUNT_NORDIRPLUS</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">Opt_sharecache</span>:
			<span class="n">mnt</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">NFS_MOUNT_UNSHARED</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">Opt_nosharecache</span>:
			<span class="n">mnt</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">NFS_MOUNT_UNSHARED</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">Opt_resvport</span>:
			<span class="n">mnt</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">NFS_MOUNT_NORESVPORT</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">Opt_noresvport</span>:
			<span class="n">mnt</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">NFS_MOUNT_NORESVPORT</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">Opt_fscache</span>:
			<span class="n">mnt</span><span class="o">-&gt;</span><span class="n">options</span> <span class="o">|=</span> <span class="n">NFS_OPTION_FSCACHE</span><span class="p">;</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">mnt</span><span class="o">-&gt;</span><span class="n">fscache_uniq</span><span class="p">);</span>
			<span class="n">mnt</span><span class="o">-&gt;</span><span class="n">fscache_uniq</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">Opt_nofscache</span>:
			<span class="n">mnt</span><span class="o">-&gt;</span><span class="n">options</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">NFS_OPTION_FSCACHE</span><span class="p">;</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">mnt</span><span class="o">-&gt;</span><span class="n">fscache_uniq</span><span class="p">);</span>
			<span class="n">mnt</span><span class="o">-&gt;</span><span class="n">fscache_uniq</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * options that take numeric values</span>
<span class="cm">		 */</span>
		<span class="k">case</span> <span class="n">Opt_port</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">nfs_get_option_ul</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">option</span><span class="p">)</span> <span class="o">||</span>
			    <span class="n">option</span> <span class="o">&gt;</span> <span class="n">USHRT_MAX</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">out_invalid_value</span><span class="p">;</span>
			<span class="n">mnt</span><span class="o">-&gt;</span><span class="n">nfs_server</span><span class="p">.</span><span class="n">port</span> <span class="o">=</span> <span class="n">option</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">Opt_rsize</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">nfs_get_option_ul</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">option</span><span class="p">))</span>
				<span class="k">goto</span> <span class="n">out_invalid_value</span><span class="p">;</span>
			<span class="n">mnt</span><span class="o">-&gt;</span><span class="n">rsize</span> <span class="o">=</span> <span class="n">option</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">Opt_wsize</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">nfs_get_option_ul</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">option</span><span class="p">))</span>
				<span class="k">goto</span> <span class="n">out_invalid_value</span><span class="p">;</span>
			<span class="n">mnt</span><span class="o">-&gt;</span><span class="n">wsize</span> <span class="o">=</span> <span class="n">option</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">Opt_bsize</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">nfs_get_option_ul</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">option</span><span class="p">))</span>
				<span class="k">goto</span> <span class="n">out_invalid_value</span><span class="p">;</span>
			<span class="n">mnt</span><span class="o">-&gt;</span><span class="n">bsize</span> <span class="o">=</span> <span class="n">option</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">Opt_timeo</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">nfs_get_option_ul</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">option</span><span class="p">)</span> <span class="o">||</span> <span class="n">option</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">out_invalid_value</span><span class="p">;</span>
			<span class="n">mnt</span><span class="o">-&gt;</span><span class="n">timeo</span> <span class="o">=</span> <span class="n">option</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">Opt_retrans</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">nfs_get_option_ul</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">option</span><span class="p">)</span> <span class="o">||</span> <span class="n">option</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">out_invalid_value</span><span class="p">;</span>
			<span class="n">mnt</span><span class="o">-&gt;</span><span class="n">retrans</span> <span class="o">=</span> <span class="n">option</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">Opt_acregmin</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">nfs_get_option_ul</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">option</span><span class="p">))</span>
				<span class="k">goto</span> <span class="n">out_invalid_value</span><span class="p">;</span>
			<span class="n">mnt</span><span class="o">-&gt;</span><span class="n">acregmin</span> <span class="o">=</span> <span class="n">option</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">Opt_acregmax</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">nfs_get_option_ul</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">option</span><span class="p">))</span>
				<span class="k">goto</span> <span class="n">out_invalid_value</span><span class="p">;</span>
			<span class="n">mnt</span><span class="o">-&gt;</span><span class="n">acregmax</span> <span class="o">=</span> <span class="n">option</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">Opt_acdirmin</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">nfs_get_option_ul</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">option</span><span class="p">))</span>
				<span class="k">goto</span> <span class="n">out_invalid_value</span><span class="p">;</span>
			<span class="n">mnt</span><span class="o">-&gt;</span><span class="n">acdirmin</span> <span class="o">=</span> <span class="n">option</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">Opt_acdirmax</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">nfs_get_option_ul</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">option</span><span class="p">))</span>
				<span class="k">goto</span> <span class="n">out_invalid_value</span><span class="p">;</span>
			<span class="n">mnt</span><span class="o">-&gt;</span><span class="n">acdirmax</span> <span class="o">=</span> <span class="n">option</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">Opt_actimeo</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">nfs_get_option_ul</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">option</span><span class="p">))</span>
				<span class="k">goto</span> <span class="n">out_invalid_value</span><span class="p">;</span>
			<span class="n">mnt</span><span class="o">-&gt;</span><span class="n">acregmin</span> <span class="o">=</span> <span class="n">mnt</span><span class="o">-&gt;</span><span class="n">acregmax</span> <span class="o">=</span>
			<span class="n">mnt</span><span class="o">-&gt;</span><span class="n">acdirmin</span> <span class="o">=</span> <span class="n">mnt</span><span class="o">-&gt;</span><span class="n">acdirmax</span> <span class="o">=</span> <span class="n">option</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">Opt_namelen</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">nfs_get_option_ul</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">option</span><span class="p">))</span>
				<span class="k">goto</span> <span class="n">out_invalid_value</span><span class="p">;</span>
			<span class="n">mnt</span><span class="o">-&gt;</span><span class="n">namlen</span> <span class="o">=</span> <span class="n">option</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">Opt_mountport</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">nfs_get_option_ul</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">option</span><span class="p">)</span> <span class="o">||</span>
			    <span class="n">option</span> <span class="o">&gt;</span> <span class="n">USHRT_MAX</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">out_invalid_value</span><span class="p">;</span>
			<span class="n">mnt</span><span class="o">-&gt;</span><span class="n">mount_server</span><span class="p">.</span><span class="n">port</span> <span class="o">=</span> <span class="n">option</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">Opt_mountvers</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">nfs_get_option_ul</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">option</span><span class="p">)</span> <span class="o">||</span>
			    <span class="n">option</span> <span class="o">&lt;</span> <span class="n">NFS_MNT_VERSION</span> <span class="o">||</span>
			    <span class="n">option</span> <span class="o">&gt;</span> <span class="n">NFS_MNT3_VERSION</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">out_invalid_value</span><span class="p">;</span>
			<span class="n">mnt</span><span class="o">-&gt;</span><span class="n">mount_server</span><span class="p">.</span><span class="n">version</span> <span class="o">=</span> <span class="n">option</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">Opt_minorversion</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">nfs_get_option_ul</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">option</span><span class="p">))</span>
				<span class="k">goto</span> <span class="n">out_invalid_value</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">option</span> <span class="o">&gt;</span> <span class="n">NFS4_MAX_MINOR_VERSION</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">out_invalid_value</span><span class="p">;</span>
			<span class="n">mnt</span><span class="o">-&gt;</span><span class="n">minorversion</span> <span class="o">=</span> <span class="n">option</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * options that take text values</span>
<span class="cm">		 */</span>
		<span class="k">case</span> <span class="n">Opt_nfsvers</span>:
			<span class="n">string</span> <span class="o">=</span> <span class="n">match_strdup</span><span class="p">(</span><span class="n">args</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">string</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">out_nomem</span><span class="p">;</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="n">nfs_parse_version_string</span><span class="p">(</span><span class="n">string</span><span class="p">,</span> <span class="n">mnt</span><span class="p">,</span> <span class="n">args</span><span class="p">);</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">string</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rc</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">out_invalid_value</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">Opt_sec</span>:
			<span class="n">string</span> <span class="o">=</span> <span class="n">match_strdup</span><span class="p">(</span><span class="n">args</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">string</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">out_nomem</span><span class="p">;</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="n">nfs_parse_security_flavors</span><span class="p">(</span><span class="n">string</span><span class="p">,</span> <span class="n">mnt</span><span class="p">);</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">string</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">dfprintk</span><span class="p">(</span><span class="n">MOUNT</span><span class="p">,</span> <span class="s">&quot;NFS:   unrecognized &quot;</span>
						<span class="s">&quot;security flavor</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">Opt_proto</span>:
			<span class="n">string</span> <span class="o">=</span> <span class="n">match_strdup</span><span class="p">(</span><span class="n">args</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">string</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">out_nomem</span><span class="p">;</span>
			<span class="n">token</span> <span class="o">=</span> <span class="n">match_token</span><span class="p">(</span><span class="n">string</span><span class="p">,</span>
					    <span class="n">nfs_xprt_protocol_tokens</span><span class="p">,</span> <span class="n">args</span><span class="p">);</span>

			<span class="n">protofamily</span> <span class="o">=</span> <span class="n">AF_INET</span><span class="p">;</span>
			<span class="k">switch</span> <span class="p">(</span><span class="n">token</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="n">Opt_xprt_udp6</span>:
				<span class="n">protofamily</span> <span class="o">=</span> <span class="n">AF_INET6</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">Opt_xprt_udp</span>:
				<span class="n">mnt</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">NFS_MOUNT_TCP</span><span class="p">;</span>
				<span class="n">mnt</span><span class="o">-&gt;</span><span class="n">nfs_server</span><span class="p">.</span><span class="n">protocol</span> <span class="o">=</span> <span class="n">XPRT_TRANSPORT_UDP</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">Opt_xprt_tcp6</span>:
				<span class="n">protofamily</span> <span class="o">=</span> <span class="n">AF_INET6</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">Opt_xprt_tcp</span>:
				<span class="n">mnt</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">NFS_MOUNT_TCP</span><span class="p">;</span>
				<span class="n">mnt</span><span class="o">-&gt;</span><span class="n">nfs_server</span><span class="p">.</span><span class="n">protocol</span> <span class="o">=</span> <span class="n">XPRT_TRANSPORT_TCP</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">Opt_xprt_rdma</span>:
				<span class="cm">/* vector side protocols to TCP */</span>
				<span class="n">mnt</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">NFS_MOUNT_TCP</span><span class="p">;</span>
				<span class="n">mnt</span><span class="o">-&gt;</span><span class="n">nfs_server</span><span class="p">.</span><span class="n">protocol</span> <span class="o">=</span> <span class="n">XPRT_TRANSPORT_RDMA</span><span class="p">;</span>
				<span class="n">xprt_load_transport</span><span class="p">(</span><span class="n">string</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="nl">default:</span>
				<span class="n">dfprintk</span><span class="p">(</span><span class="n">MOUNT</span><span class="p">,</span> <span class="s">&quot;NFS:   unrecognized &quot;</span>
						<span class="s">&quot;transport protocol</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">kfree</span><span class="p">(</span><span class="n">string</span><span class="p">);</span>
				<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">string</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">Opt_mountproto</span>:
			<span class="n">string</span> <span class="o">=</span> <span class="n">match_strdup</span><span class="p">(</span><span class="n">args</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">string</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">out_nomem</span><span class="p">;</span>
			<span class="n">token</span> <span class="o">=</span> <span class="n">match_token</span><span class="p">(</span><span class="n">string</span><span class="p">,</span>
					    <span class="n">nfs_xprt_protocol_tokens</span><span class="p">,</span> <span class="n">args</span><span class="p">);</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">string</span><span class="p">);</span>

			<span class="n">mountfamily</span> <span class="o">=</span> <span class="n">AF_INET</span><span class="p">;</span>
			<span class="k">switch</span> <span class="p">(</span><span class="n">token</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="n">Opt_xprt_udp6</span>:
				<span class="n">mountfamily</span> <span class="o">=</span> <span class="n">AF_INET6</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">Opt_xprt_udp</span>:
				<span class="n">mnt</span><span class="o">-&gt;</span><span class="n">mount_server</span><span class="p">.</span><span class="n">protocol</span> <span class="o">=</span> <span class="n">XPRT_TRANSPORT_UDP</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">Opt_xprt_tcp6</span>:
				<span class="n">mountfamily</span> <span class="o">=</span> <span class="n">AF_INET6</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">Opt_xprt_tcp</span>:
				<span class="n">mnt</span><span class="o">-&gt;</span><span class="n">mount_server</span><span class="p">.</span><span class="n">protocol</span> <span class="o">=</span> <span class="n">XPRT_TRANSPORT_TCP</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">Opt_xprt_rdma</span>: <span class="cm">/* not used for side protocols */</span>
			<span class="nl">default:</span>
				<span class="n">dfprintk</span><span class="p">(</span><span class="n">MOUNT</span><span class="p">,</span> <span class="s">&quot;NFS:   unrecognized &quot;</span>
						<span class="s">&quot;transport protocol</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">Opt_addr</span>:
			<span class="n">string</span> <span class="o">=</span> <span class="n">match_strdup</span><span class="p">(</span><span class="n">args</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">string</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">out_nomem</span><span class="p">;</span>
			<span class="n">mnt</span><span class="o">-&gt;</span><span class="n">nfs_server</span><span class="p">.</span><span class="n">addrlen</span> <span class="o">=</span>
				<span class="n">rpc_pton</span><span class="p">(</span><span class="n">mnt</span><span class="o">-&gt;</span><span class="n">net</span><span class="p">,</span> <span class="n">string</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="n">string</span><span class="p">),</span>
					<span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="p">)</span>
					<span class="o">&amp;</span><span class="n">mnt</span><span class="o">-&gt;</span><span class="n">nfs_server</span><span class="p">.</span><span class="n">address</span><span class="p">,</span>
					<span class="k">sizeof</span><span class="p">(</span><span class="n">mnt</span><span class="o">-&gt;</span><span class="n">nfs_server</span><span class="p">.</span><span class="n">address</span><span class="p">));</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">string</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">mnt</span><span class="o">-&gt;</span><span class="n">nfs_server</span><span class="p">.</span><span class="n">addrlen</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">out_invalid_address</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">Opt_clientaddr</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">nfs_get_option_str</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mnt</span><span class="o">-&gt;</span><span class="n">client_address</span><span class="p">))</span>
				<span class="k">goto</span> <span class="n">out_nomem</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">Opt_mounthost</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">nfs_get_option_str</span><span class="p">(</span><span class="n">args</span><span class="p">,</span>
					       <span class="o">&amp;</span><span class="n">mnt</span><span class="o">-&gt;</span><span class="n">mount_server</span><span class="p">.</span><span class="n">hostname</span><span class="p">))</span>
				<span class="k">goto</span> <span class="n">out_nomem</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">Opt_mountaddr</span>:
			<span class="n">string</span> <span class="o">=</span> <span class="n">match_strdup</span><span class="p">(</span><span class="n">args</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">string</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">out_nomem</span><span class="p">;</span>
			<span class="n">mnt</span><span class="o">-&gt;</span><span class="n">mount_server</span><span class="p">.</span><span class="n">addrlen</span> <span class="o">=</span>
				<span class="n">rpc_pton</span><span class="p">(</span><span class="n">mnt</span><span class="o">-&gt;</span><span class="n">net</span><span class="p">,</span> <span class="n">string</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="n">string</span><span class="p">),</span>
					<span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="p">)</span>
					<span class="o">&amp;</span><span class="n">mnt</span><span class="o">-&gt;</span><span class="n">mount_server</span><span class="p">.</span><span class="n">address</span><span class="p">,</span>
					<span class="k">sizeof</span><span class="p">(</span><span class="n">mnt</span><span class="o">-&gt;</span><span class="n">mount_server</span><span class="p">.</span><span class="n">address</span><span class="p">));</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">string</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">mnt</span><span class="o">-&gt;</span><span class="n">mount_server</span><span class="p">.</span><span class="n">addrlen</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">out_invalid_address</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">Opt_lookupcache</span>:
			<span class="n">string</span> <span class="o">=</span> <span class="n">match_strdup</span><span class="p">(</span><span class="n">args</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">string</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">out_nomem</span><span class="p">;</span>
			<span class="n">token</span> <span class="o">=</span> <span class="n">match_token</span><span class="p">(</span><span class="n">string</span><span class="p">,</span>
					<span class="n">nfs_lookupcache_tokens</span><span class="p">,</span> <span class="n">args</span><span class="p">);</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">string</span><span class="p">);</span>
			<span class="k">switch</span> <span class="p">(</span><span class="n">token</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">case</span> <span class="n">Opt_lookupcache_all</span>:
					<span class="n">mnt</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">NFS_MOUNT_LOOKUP_CACHE_NONEG</span><span class="o">|</span><span class="n">NFS_MOUNT_LOOKUP_CACHE_NONE</span><span class="p">);</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="k">case</span> <span class="n">Opt_lookupcache_positive</span>:
					<span class="n">mnt</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">NFS_MOUNT_LOOKUP_CACHE_NONE</span><span class="p">;</span>
					<span class="n">mnt</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">NFS_MOUNT_LOOKUP_CACHE_NONEG</span><span class="p">;</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="k">case</span> <span class="n">Opt_lookupcache_none</span>:
					<span class="n">mnt</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">NFS_MOUNT_LOOKUP_CACHE_NONEG</span><span class="o">|</span><span class="n">NFS_MOUNT_LOOKUP_CACHE_NONE</span><span class="p">;</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="nl">default:</span>
					<span class="n">dfprintk</span><span class="p">(</span><span class="n">MOUNT</span><span class="p">,</span> <span class="s">&quot;NFS:   invalid &quot;</span>
							<span class="s">&quot;lookupcache argument</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
					<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">};</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">Opt_fscache_uniq</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">nfs_get_option_str</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mnt</span><span class="o">-&gt;</span><span class="n">fscache_uniq</span><span class="p">))</span>
				<span class="k">goto</span> <span class="n">out_nomem</span><span class="p">;</span>
			<span class="n">mnt</span><span class="o">-&gt;</span><span class="n">options</span> <span class="o">|=</span> <span class="n">NFS_OPTION_FSCACHE</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">Opt_local_lock</span>:
			<span class="n">string</span> <span class="o">=</span> <span class="n">match_strdup</span><span class="p">(</span><span class="n">args</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">string</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">out_nomem</span><span class="p">;</span>
			<span class="n">token</span> <span class="o">=</span> <span class="n">match_token</span><span class="p">(</span><span class="n">string</span><span class="p">,</span> <span class="n">nfs_local_lock_tokens</span><span class="p">,</span>
					<span class="n">args</span><span class="p">);</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">string</span><span class="p">);</span>
			<span class="k">switch</span> <span class="p">(</span><span class="n">token</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="n">Opt_local_lock_all</span>:
				<span class="n">mnt</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="p">(</span><span class="n">NFS_MOUNT_LOCAL_FLOCK</span> <span class="o">|</span>
					       <span class="n">NFS_MOUNT_LOCAL_FCNTL</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">Opt_local_lock_flock</span>:
				<span class="n">mnt</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">NFS_MOUNT_LOCAL_FLOCK</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">Opt_local_lock_posix</span>:
				<span class="n">mnt</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">NFS_MOUNT_LOCAL_FCNTL</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">Opt_local_lock_none</span>:
				<span class="n">mnt</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">NFS_MOUNT_LOCAL_FLOCK</span> <span class="o">|</span>
						<span class="n">NFS_MOUNT_LOCAL_FCNTL</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="nl">default:</span>
				<span class="n">dfprintk</span><span class="p">(</span><span class="n">MOUNT</span><span class="p">,</span> <span class="s">&quot;NFS:	invalid	&quot;</span>
						<span class="s">&quot;local_lock argument</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">};</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * Special options</span>
<span class="cm">		 */</span>
		<span class="k">case</span> <span class="n">Opt_sloppy</span>:
			<span class="n">sloppy</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">dfprintk</span><span class="p">(</span><span class="n">MOUNT</span><span class="p">,</span> <span class="s">&quot;NFS:   relaxing parsing rules</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">Opt_userspace</span>:
		<span class="k">case</span> <span class="n">Opt_deprecated</span>:
			<span class="n">dfprintk</span><span class="p">(</span><span class="n">MOUNT</span><span class="p">,</span> <span class="s">&quot;NFS:   ignoring mount option &quot;</span>
					<span class="s">&quot;&#39;%s&#39;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">p</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="nl">default:</span>
			<span class="n">invalid_option</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">dfprintk</span><span class="p">(</span><span class="n">MOUNT</span><span class="p">,</span> <span class="s">&quot;NFS:   unrecognized mount option &quot;</span>
					<span class="s">&quot;&#39;%s&#39;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">p</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sloppy</span> <span class="o">&amp;&amp;</span> <span class="n">invalid_option</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mnt</span><span class="o">-&gt;</span><span class="n">minorversion</span> <span class="o">&amp;&amp;</span> <span class="n">mnt</span><span class="o">-&gt;</span><span class="n">version</span> <span class="o">!=</span> <span class="mi">4</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_minorversion_mismatch</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * verify that any proto=/mountproto= options match the address</span>
<span class="cm">	 * familiies in the addr=/mountaddr= options.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">protofamily</span> <span class="o">!=</span> <span class="n">AF_UNSPEC</span> <span class="o">&amp;&amp;</span>
	    <span class="n">protofamily</span> <span class="o">!=</span> <span class="n">mnt</span><span class="o">-&gt;</span><span class="n">nfs_server</span><span class="p">.</span><span class="n">address</span><span class="p">.</span><span class="n">ss_family</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_proto_mismatch</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mountfamily</span> <span class="o">!=</span> <span class="n">AF_UNSPEC</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mnt</span><span class="o">-&gt;</span><span class="n">mount_server</span><span class="p">.</span><span class="n">addrlen</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">mountfamily</span> <span class="o">!=</span> <span class="n">mnt</span><span class="o">-&gt;</span><span class="n">mount_server</span><span class="p">.</span><span class="n">address</span><span class="p">.</span><span class="n">ss_family</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">out_mountproto_mismatch</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">mountfamily</span> <span class="o">!=</span> <span class="n">mnt</span><span class="o">-&gt;</span><span class="n">nfs_server</span><span class="p">.</span><span class="n">address</span><span class="p">.</span><span class="n">ss_family</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">out_mountproto_mismatch</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

<span class="nl">out_mountproto_mismatch:</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;NFS: mount server address does not match mountproto= &quot;</span>
			 <span class="s">&quot;option</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">out_proto_mismatch:</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;NFS: server address does not match proto= option</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">out_invalid_address:</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;NFS: bad IP address specified: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">p</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">out_invalid_value:</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;NFS: bad mount option value specified: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">p</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">out_minorversion_mismatch:</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;NFS: mount option vers=%u does not support &quot;</span>
			 <span class="s">&quot;minorversion=%u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">mnt</span><span class="o">-&gt;</span><span class="n">version</span><span class="p">,</span> <span class="n">mnt</span><span class="o">-&gt;</span><span class="n">minorversion</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">out_nomem:</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;NFS: not enough memory to parse option</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">out_security_failure:</span>
	<span class="n">free_secdata</span><span class="p">(</span><span class="n">secdata</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;NFS: security options invalid: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Match the requested auth flavors with the list returned by</span>
<span class="cm"> * the server.  Returns zero and sets the mount&#39;s authentication</span>
<span class="cm"> * flavor on success; returns -EACCES if server does not support</span>
<span class="cm"> * the requested flavor.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">nfs_walk_authlist</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs_parsed_mount_data</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">nfs_mount_request</span> <span class="o">*</span><span class="n">request</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">server_authlist_len</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">request</span><span class="o">-&gt;</span><span class="n">auth_flav_len</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Certain releases of Linux&#39;s mountd return an empty</span>
<span class="cm">	 * flavor list.  To prevent behavioral regression with</span>
<span class="cm">	 * these servers (ie. rejecting mounts that used to</span>
<span class="cm">	 * succeed), revert to pre-2.6.32 behavior (no checking)</span>
<span class="cm">	 * if the returned flavor list is empty.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">server_authlist_len</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * We avoid sophisticated negotiating here, as there are</span>
<span class="cm">	 * plenty of cases where we can get it wrong, providing</span>
<span class="cm">	 * either too little or too much security.</span>
<span class="cm">	 *</span>
<span class="cm">	 * RFC 2623, section 2.7 suggests we SHOULD prefer the</span>
<span class="cm">	 * flavor listed first.  However, some servers list</span>
<span class="cm">	 * AUTH_NULL first.  Our caller plants AUTH_SYS, the</span>
<span class="cm">	 * preferred default, in args-&gt;auth_flavors[0] if user</span>
<span class="cm">	 * didn&#39;t specify sec= mount option.</span>
<span class="cm">	 */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">args</span><span class="o">-&gt;</span><span class="n">auth_flavor_len</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">server_authlist_len</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">args</span><span class="o">-&gt;</span><span class="n">auth_flavors</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">request</span><span class="o">-&gt;</span><span class="n">auth_flavs</span><span class="p">[</span><span class="n">j</span><span class="p">])</span> <span class="p">{</span>
				<span class="n">dfprintk</span><span class="p">(</span><span class="n">MOUNT</span><span class="p">,</span> <span class="s">&quot;NFS: using auth flavor %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">request</span><span class="o">-&gt;</span><span class="n">auth_flavs</span><span class="p">[</span><span class="n">j</span><span class="p">]);</span>
				<span class="n">args</span><span class="o">-&gt;</span><span class="n">auth_flavors</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">request</span><span class="o">-&gt;</span><span class="n">auth_flavs</span><span class="p">[</span><span class="n">j</span><span class="p">];</span>
				<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>

	<span class="n">dfprintk</span><span class="p">(</span><span class="n">MOUNT</span><span class="p">,</span> <span class="s">&quot;NFS: server does not support requested auth flavor</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">nfs_umount</span><span class="p">(</span><span class="n">request</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EACCES</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Use the remote server&#39;s MOUNT service to request the NFS file handle</span>
<span class="cm"> * corresponding to the provided path.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">nfs_request_mount</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs_parsed_mount_data</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">nfs_fh</span> <span class="o">*</span><span class="n">root_fh</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">rpc_authflavor_t</span> <span class="n">server_authlist</span><span class="p">[</span><span class="n">NFS_MAX_SECFLAVORS</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">server_authlist_len</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">server_authlist</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">nfs_mount_request</span> <span class="n">request</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">sap</span>		<span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="p">)</span>
						<span class="o">&amp;</span><span class="n">args</span><span class="o">-&gt;</span><span class="n">mount_server</span><span class="p">.</span><span class="n">address</span><span class="p">,</span>
		<span class="p">.</span><span class="n">dirpath</span>	<span class="o">=</span> <span class="n">args</span><span class="o">-&gt;</span><span class="n">nfs_server</span><span class="p">.</span><span class="n">export_path</span><span class="p">,</span>
		<span class="p">.</span><span class="n">protocol</span>	<span class="o">=</span> <span class="n">args</span><span class="o">-&gt;</span><span class="n">mount_server</span><span class="p">.</span><span class="n">protocol</span><span class="p">,</span>
		<span class="p">.</span><span class="n">fh</span>		<span class="o">=</span> <span class="n">root_fh</span><span class="p">,</span>
		<span class="p">.</span><span class="n">noresvport</span>	<span class="o">=</span> <span class="n">args</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">NFS_MOUNT_NORESVPORT</span><span class="p">,</span>
		<span class="p">.</span><span class="n">auth_flav_len</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">server_authlist_len</span><span class="p">,</span>
		<span class="p">.</span><span class="n">auth_flavs</span>	<span class="o">=</span> <span class="n">server_authlist</span><span class="p">,</span>
		<span class="p">.</span><span class="n">net</span>		<span class="o">=</span> <span class="n">args</span><span class="o">-&gt;</span><span class="n">net</span><span class="p">,</span>
	<span class="p">};</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">args</span><span class="o">-&gt;</span><span class="n">mount_server</span><span class="p">.</span><span class="n">version</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">args</span><span class="o">-&gt;</span><span class="n">version</span><span class="p">)</span> <span class="p">{</span>
			<span class="nl">default:</span>
				<span class="n">args</span><span class="o">-&gt;</span><span class="n">mount_server</span><span class="p">.</span><span class="n">version</span> <span class="o">=</span> <span class="n">NFS_MNT3_VERSION</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mi">2</span>:
				<span class="n">args</span><span class="o">-&gt;</span><span class="n">mount_server</span><span class="p">.</span><span class="n">version</span> <span class="o">=</span> <span class="n">NFS_MNT_VERSION</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">request</span><span class="p">.</span><span class="n">version</span> <span class="o">=</span> <span class="n">args</span><span class="o">-&gt;</span><span class="n">mount_server</span><span class="p">.</span><span class="n">version</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">args</span><span class="o">-&gt;</span><span class="n">mount_server</span><span class="p">.</span><span class="n">hostname</span><span class="p">)</span>
		<span class="n">request</span><span class="p">.</span><span class="n">hostname</span> <span class="o">=</span> <span class="n">args</span><span class="o">-&gt;</span><span class="n">mount_server</span><span class="p">.</span><span class="n">hostname</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">request</span><span class="p">.</span><span class="n">hostname</span> <span class="o">=</span> <span class="n">args</span><span class="o">-&gt;</span><span class="n">nfs_server</span><span class="p">.</span><span class="n">hostname</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Construct the mount server&#39;s address.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">args</span><span class="o">-&gt;</span><span class="n">mount_server</span><span class="p">.</span><span class="n">address</span><span class="p">.</span><span class="n">ss_family</span> <span class="o">==</span> <span class="n">AF_UNSPEC</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">request</span><span class="p">.</span><span class="n">sap</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">args</span><span class="o">-&gt;</span><span class="n">nfs_server</span><span class="p">.</span><span class="n">address</span><span class="p">,</span>
		       <span class="n">args</span><span class="o">-&gt;</span><span class="n">nfs_server</span><span class="p">.</span><span class="n">addrlen</span><span class="p">);</span>
		<span class="n">args</span><span class="o">-&gt;</span><span class="n">mount_server</span><span class="p">.</span><span class="n">addrlen</span> <span class="o">=</span> <span class="n">args</span><span class="o">-&gt;</span><span class="n">nfs_server</span><span class="p">.</span><span class="n">addrlen</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">request</span><span class="p">.</span><span class="n">salen</span> <span class="o">=</span> <span class="n">args</span><span class="o">-&gt;</span><span class="n">mount_server</span><span class="p">.</span><span class="n">addrlen</span><span class="p">;</span>
	<span class="n">nfs_set_port</span><span class="p">(</span><span class="n">request</span><span class="p">.</span><span class="n">sap</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">args</span><span class="o">-&gt;</span><span class="n">mount_server</span><span class="p">.</span><span class="n">port</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Now ask the mount server to map our export path</span>
<span class="cm">	 * to a file handle.</span>
<span class="cm">	 */</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">nfs_mount</span><span class="p">(</span><span class="o">&amp;</span><span class="n">request</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dfprintk</span><span class="p">(</span><span class="n">MOUNT</span><span class="p">,</span> <span class="s">&quot;NFS: unable to mount server %s, error %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">request</span><span class="p">.</span><span class="n">hostname</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * MNTv1 (NFSv2) does not support auth flavor negotiation.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">args</span><span class="o">-&gt;</span><span class="n">mount_server</span><span class="p">.</span><span class="n">version</span> <span class="o">!=</span> <span class="n">NFS_MNT3_VERSION</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">nfs_walk_authlist</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">request</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="nf">nfs_try_mount</span><span class="p">(</span><span class="kt">int</span> <span class="n">flags</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">dev_name</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">nfs_mount_info</span> <span class="o">*</span><span class="n">mount_info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nfs_server</span> <span class="o">*</span><span class="n">server</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mount_info</span><span class="o">-&gt;</span><span class="n">parsed</span><span class="o">-&gt;</span><span class="n">need_mount</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">nfs_request_mount</span><span class="p">(</span><span class="n">mount_info</span><span class="o">-&gt;</span><span class="n">parsed</span><span class="p">,</span> <span class="n">mount_info</span><span class="o">-&gt;</span><span class="n">mntfh</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="n">status</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Get a volume representation */</span>
	<span class="n">server</span> <span class="o">=</span> <span class="n">nfs_create_server</span><span class="p">(</span><span class="n">mount_info</span><span class="o">-&gt;</span><span class="n">parsed</span><span class="p">,</span> <span class="n">mount_info</span><span class="o">-&gt;</span><span class="n">mntfh</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">server</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">ERR_CAST</span><span class="p">(</span><span class="n">server</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">nfs_fs_mount_common</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nfs_fs_type</span><span class="p">,</span> <span class="n">server</span><span class="p">,</span> <span class="n">flags</span><span class="p">,</span> <span class="n">dev_name</span><span class="p">,</span> <span class="n">mount_info</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Split &quot;dev_name&quot; into &quot;hostname:export_path&quot;.</span>
<span class="cm"> *</span>
<span class="cm"> * The leftmost colon demarks the split between the server&#39;s hostname</span>
<span class="cm"> * and the export path.  If the hostname starts with a left square</span>
<span class="cm"> * bracket, then it may contain colons.</span>
<span class="cm"> *</span>
<span class="cm"> * Note: caller frees hostname and export path, even on error.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">nfs_parse_devname</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">dev_name</span><span class="p">,</span>
			     <span class="kt">char</span> <span class="o">**</span><span class="n">hostname</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">maxnamlen</span><span class="p">,</span>
			     <span class="kt">char</span> <span class="o">**</span><span class="n">export_path</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">maxpathlen</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">size_t</span> <span class="n">len</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">end</span><span class="p">;</span>

	<span class="cm">/* Is the host name protected with square brakcets? */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">dev_name</span> <span class="o">==</span> <span class="sc">&#39;[&#39;</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">end</span> <span class="o">=</span> <span class="n">strchr</span><span class="p">(</span><span class="o">++</span><span class="n">dev_name</span><span class="p">,</span> <span class="sc">&#39;]&#39;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">end</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span> <span class="n">end</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="sc">&#39;:&#39;</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out_bad_devname</span><span class="p">;</span>

		<span class="n">len</span> <span class="o">=</span> <span class="n">end</span> <span class="o">-</span> <span class="n">dev_name</span><span class="p">;</span>
		<span class="n">end</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="kt">char</span> <span class="o">*</span><span class="n">comma</span><span class="p">;</span>

		<span class="n">end</span> <span class="o">=</span> <span class="n">strchr</span><span class="p">(</span><span class="n">dev_name</span><span class="p">,</span> <span class="sc">&#39;:&#39;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">end</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out_bad_devname</span><span class="p">;</span>
		<span class="n">len</span> <span class="o">=</span> <span class="n">end</span> <span class="o">-</span> <span class="n">dev_name</span><span class="p">;</span>

		<span class="cm">/* kill possible hostname list: not supported */</span>
		<span class="n">comma</span> <span class="o">=</span> <span class="n">strchr</span><span class="p">(</span><span class="n">dev_name</span><span class="p">,</span> <span class="sc">&#39;,&#39;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">comma</span> <span class="o">!=</span> <span class="nb">NULL</span> <span class="o">&amp;&amp;</span> <span class="n">comma</span> <span class="o">&lt;</span> <span class="n">end</span><span class="p">)</span>
			<span class="o">*</span><span class="n">comma</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;</span> <span class="n">maxnamlen</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_hostname</span><span class="p">;</span>

	<span class="cm">/* N.B. caller will free nfs_server.hostname in all cases */</span>
	<span class="o">*</span><span class="n">hostname</span> <span class="o">=</span> <span class="n">kstrndup</span><span class="p">(</span><span class="n">dev_name</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">hostname</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_nomem</span><span class="p">;</span>
	<span class="n">len</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="o">++</span><span class="n">end</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;</span> <span class="n">maxpathlen</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_path</span><span class="p">;</span>
	<span class="o">*</span><span class="n">export_path</span> <span class="o">=</span> <span class="n">kstrndup</span><span class="p">(</span><span class="n">end</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!*</span><span class="n">export_path</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_nomem</span><span class="p">;</span>

	<span class="n">dfprintk</span><span class="p">(</span><span class="n">MOUNT</span><span class="p">,</span> <span class="s">&quot;NFS: MNTPATH: &#39;%s&#39;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="o">*</span><span class="n">export_path</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">out_bad_devname:</span>
	<span class="n">dfprintk</span><span class="p">(</span><span class="n">MOUNT</span><span class="p">,</span> <span class="s">&quot;NFS: device name not in host:path format</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

<span class="nl">out_nomem:</span>
	<span class="n">dfprintk</span><span class="p">(</span><span class="n">MOUNT</span><span class="p">,</span> <span class="s">&quot;NFS: not enough memory to parse device name</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

<span class="nl">out_hostname:</span>
	<span class="n">dfprintk</span><span class="p">(</span><span class="n">MOUNT</span><span class="p">,</span> <span class="s">&quot;NFS: server hostname too long</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENAMETOOLONG</span><span class="p">;</span>

<span class="nl">out_path:</span>
	<span class="n">dfprintk</span><span class="p">(</span><span class="n">MOUNT</span><span class="p">,</span> <span class="s">&quot;NFS: export pathname too long</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENAMETOOLONG</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Validate the NFS2/NFS3 mount data</span>
<span class="cm"> * - fills in the mount root filehandle</span>
<span class="cm"> *</span>
<span class="cm"> * For option strings, user space handles the following behaviors:</span>
<span class="cm"> *</span>
<span class="cm"> * + DNS: mapping server host name to IP address (&quot;addr=&quot; option)</span>
<span class="cm"> *</span>
<span class="cm"> * + failure mode: how to behave if a mount request can&#39;t be handled</span>
<span class="cm"> *   immediately (&quot;fg/bg&quot; option)</span>
<span class="cm"> *</span>
<span class="cm"> * + retry: how often to retry a mount request (&quot;retry=&quot; option)</span>
<span class="cm"> *</span>
<span class="cm"> * + breaking back: trying proto=udp after proto=tcp, v2 after v3,</span>
<span class="cm"> *   mountproto=tcp after mountproto=udp, and so on</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">nfs23_validate_mount_data</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">options</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">nfs_parsed_mount_data</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">nfs_fh</span> <span class="o">*</span><span class="n">mntfh</span><span class="p">,</span>
				     <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">dev_name</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfs_mount_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">nfs_mount_data</span> <span class="o">*</span><span class="p">)</span><span class="n">options</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="n">sap</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">args</span><span class="o">-&gt;</span><span class="n">nfs_server</span><span class="p">.</span><span class="n">address</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">data</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_no_data</span><span class="p">;</span>

	<span class="n">args</span><span class="o">-&gt;</span><span class="n">version</span> <span class="o">=</span> <span class="n">NFS_DEFAULT_VERSION</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">version</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">1</span>:
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">namlen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">2</span>:
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">bsize</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">3</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">NFS_MOUNT_VER3</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out_no_v3</span><span class="p">;</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">root</span><span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="n">NFS2_FHSIZE</span><span class="p">;</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">root</span><span class="p">.</span><span class="n">data</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">old_root</span><span class="p">.</span><span class="n">data</span><span class="p">,</span> <span class="n">NFS2_FHSIZE</span><span class="p">);</span>
	<span class="k">case</span> <span class="mi">4</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">NFS_MOUNT_SECFLAVOUR</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out_no_sec</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">5</span>:
		<span class="n">memset</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">));</span>
	<span class="k">case</span> <span class="mi">6</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">NFS_MOUNT_VER3</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">root</span><span class="p">.</span><span class="n">size</span> <span class="o">&gt;</span> <span class="n">NFS3_FHSIZE</span> <span class="o">||</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">root</span><span class="p">.</span><span class="n">size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">out_invalid_fh</span><span class="p">;</span>
			<span class="n">mntfh</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">root</span><span class="p">.</span><span class="n">size</span><span class="p">;</span>
			<span class="n">args</span><span class="o">-&gt;</span><span class="n">version</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">mntfh</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">=</span> <span class="n">NFS2_FHSIZE</span><span class="p">;</span>
			<span class="n">args</span><span class="o">-&gt;</span><span class="n">version</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="p">}</span>


		<span class="n">memcpy</span><span class="p">(</span><span class="n">mntfh</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">root</span><span class="p">.</span><span class="n">data</span><span class="p">,</span> <span class="n">mntfh</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mntfh</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">mntfh</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">))</span>
			<span class="n">memset</span><span class="p">(</span><span class="n">mntfh</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">+</span> <span class="n">mntfh</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
			       <span class="k">sizeof</span><span class="p">(</span><span class="n">mntfh</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">)</span> <span class="o">-</span> <span class="n">mntfh</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">);</span>

		<span class="cm">/*</span>
<span class="cm">		 * Translate to nfs_parsed_mount_data, which nfs_fill_super</span>
<span class="cm">		 * can deal with.</span>
<span class="cm">		 */</span>
		<span class="n">args</span><span class="o">-&gt;</span><span class="n">flags</span>		<span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">NFS_MOUNT_FLAGMASK</span><span class="p">;</span>
		<span class="n">args</span><span class="o">-&gt;</span><span class="n">flags</span>		<span class="o">|=</span> <span class="n">NFS_MOUNT_LEGACY_INTERFACE</span><span class="p">;</span>
		<span class="n">args</span><span class="o">-&gt;</span><span class="n">rsize</span>		<span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">rsize</span><span class="p">;</span>
		<span class="n">args</span><span class="o">-&gt;</span><span class="n">wsize</span>		<span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">wsize</span><span class="p">;</span>
		<span class="n">args</span><span class="o">-&gt;</span><span class="n">timeo</span>		<span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">timeo</span><span class="p">;</span>
		<span class="n">args</span><span class="o">-&gt;</span><span class="n">retrans</span>		<span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">retrans</span><span class="p">;</span>
		<span class="n">args</span><span class="o">-&gt;</span><span class="n">acregmin</span>		<span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">acregmin</span><span class="p">;</span>
		<span class="n">args</span><span class="o">-&gt;</span><span class="n">acregmax</span>		<span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">acregmax</span><span class="p">;</span>
		<span class="n">args</span><span class="o">-&gt;</span><span class="n">acdirmin</span>		<span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">acdirmin</span><span class="p">;</span>
		<span class="n">args</span><span class="o">-&gt;</span><span class="n">acdirmax</span>		<span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">acdirmax</span><span class="p">;</span>
		<span class="n">args</span><span class="o">-&gt;</span><span class="n">need_mount</span>	<span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

		<span class="n">memcpy</span><span class="p">(</span><span class="n">sap</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">));</span>
		<span class="n">args</span><span class="o">-&gt;</span><span class="n">nfs_server</span><span class="p">.</span><span class="n">addrlen</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">nfs_verify_server_address</span><span class="p">(</span><span class="n">sap</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">out_no_address</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">NFS_MOUNT_TCP</span><span class="p">))</span>
			<span class="n">args</span><span class="o">-&gt;</span><span class="n">nfs_server</span><span class="p">.</span><span class="n">protocol</span> <span class="o">=</span> <span class="n">XPRT_TRANSPORT_UDP</span><span class="p">;</span>
		<span class="cm">/* N.B. caller will free nfs_server.hostname in all cases */</span>
		<span class="n">args</span><span class="o">-&gt;</span><span class="n">nfs_server</span><span class="p">.</span><span class="n">hostname</span> <span class="o">=</span> <span class="n">kstrdup</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">hostname</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="n">args</span><span class="o">-&gt;</span><span class="n">namlen</span>		<span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">namlen</span><span class="p">;</span>
		<span class="n">args</span><span class="o">-&gt;</span><span class="n">bsize</span>		<span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">bsize</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">NFS_MOUNT_SECFLAVOUR</span><span class="p">)</span>
			<span class="n">args</span><span class="o">-&gt;</span><span class="n">auth_flavors</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">pseudoflavor</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">args</span><span class="o">-&gt;</span><span class="n">nfs_server</span><span class="p">.</span><span class="n">hostname</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out_nomem</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">NFS_MOUNT_NONLM</span><span class="p">))</span>
			<span class="n">args</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">NFS_MOUNT_LOCAL_FLOCK</span><span class="o">|</span>
					 <span class="n">NFS_MOUNT_LOCAL_FCNTL</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">args</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="p">(</span><span class="n">NFS_MOUNT_LOCAL_FLOCK</span><span class="o">|</span>
					<span class="n">NFS_MOUNT_LOCAL_FCNTL</span><span class="p">);</span>
		<span class="cm">/*</span>
<span class="cm">		 * The legacy version 6 binary mount data from userspace has a</span>
<span class="cm">		 * field used only to transport selinux information into the</span>
<span class="cm">		 * the kernel.  To continue to support that functionality we</span>
<span class="cm">		 * have a touch of selinux knowledge here in the NFS code. The</span>
<span class="cm">		 * userspace code converted context=blah to just blah so we are</span>
<span class="cm">		 * converting back to the full string selinux understands.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">[</span><span class="mi">0</span><span class="p">]){</span>
<span class="cp">#ifdef CONFIG_SECURITY_SELINUX</span>
			<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>
			<span class="kt">char</span> <span class="o">*</span><span class="n">opts_str</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">)</span> <span class="o">+</span> <span class="mi">8</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">opts_str</span><span class="p">)</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
			<span class="n">strcpy</span><span class="p">(</span><span class="n">opts_str</span><span class="p">,</span> <span class="s">&quot;context=&quot;</span><span class="p">);</span>
			<span class="n">data</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">[</span><span class="n">NFS_MAX_CONTEXT_LEN</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
			<span class="n">strcat</span><span class="p">(</span><span class="n">opts_str</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="n">security_sb_parse_opts_str</span><span class="p">(</span><span class="n">opts_str</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">args</span><span class="o">-&gt;</span><span class="n">lsm_opts</span><span class="p">);</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">opts_str</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="cp">#else</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="cp">#endif</span>
		<span class="p">}</span>

		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="n">NFS_TEXT_DATA</span><span class="p">;</span>
	<span class="p">}</span>

<span class="cp">#ifndef CONFIG_NFS_V3</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">args</span><span class="o">-&gt;</span><span class="n">version</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_v3_not_compiled</span><span class="p">;</span>
<span class="cp">#endif </span><span class="cm">/* !CONFIG_NFS_V3 */</span><span class="cp"></span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">out_no_data:</span>
	<span class="n">dfprintk</span><span class="p">(</span><span class="n">MOUNT</span><span class="p">,</span> <span class="s">&quot;NFS: mount program didn&#39;t pass any mount data</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

<span class="nl">out_no_v3:</span>
	<span class="n">dfprintk</span><span class="p">(</span><span class="n">MOUNT</span><span class="p">,</span> <span class="s">&quot;NFS: nfs_mount_data version %d does not support v3</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">data</span><span class="o">-&gt;</span><span class="n">version</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

<span class="nl">out_no_sec:</span>
	<span class="n">dfprintk</span><span class="p">(</span><span class="n">MOUNT</span><span class="p">,</span> <span class="s">&quot;NFS: nfs_mount_data version supports only AUTH_SYS</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

<span class="cp">#ifndef CONFIG_NFS_V3</span>
<span class="nl">out_v3_not_compiled:</span>
	<span class="n">dfprintk</span><span class="p">(</span><span class="n">MOUNT</span><span class="p">,</span> <span class="s">&quot;NFS: NFSv3 is not compiled into kernel</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EPROTONOSUPPORT</span><span class="p">;</span>
<span class="cp">#endif </span><span class="cm">/* !CONFIG_NFS_V3 */</span><span class="cp"></span>

<span class="nl">out_nomem:</span>
	<span class="n">dfprintk</span><span class="p">(</span><span class="n">MOUNT</span><span class="p">,</span> <span class="s">&quot;NFS: not enough memory to handle mount options</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

<span class="nl">out_no_address:</span>
	<span class="n">dfprintk</span><span class="p">(</span><span class="n">MOUNT</span><span class="p">,</span> <span class="s">&quot;NFS: mount program didn&#39;t pass remote address</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

<span class="nl">out_invalid_fh:</span>
	<span class="n">dfprintk</span><span class="p">(</span><span class="n">MOUNT</span><span class="p">,</span> <span class="s">&quot;NFS: invalid root filehandle</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_NFS_V4</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">nfs_validate_mount_data</span><span class="p">(</span><span class="k">struct</span> <span class="n">file_system_type</span> <span class="o">*</span><span class="n">fs_type</span><span class="p">,</span>
				   <span class="kt">void</span> <span class="o">*</span><span class="n">options</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">nfs_parsed_mount_data</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">nfs_fh</span> <span class="o">*</span><span class="n">mntfh</span><span class="p">,</span>
				   <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">dev_name</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fs_type</span> <span class="o">==</span> <span class="o">&amp;</span><span class="n">nfs_fs_type</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">nfs23_validate_mount_data</span><span class="p">(</span><span class="n">options</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">mntfh</span><span class="p">,</span> <span class="n">dev_name</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">nfs4_validate_mount_data</span><span class="p">(</span><span class="n">options</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">dev_name</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#else</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">nfs_validate_mount_data</span><span class="p">(</span><span class="k">struct</span> <span class="n">file_system_type</span> <span class="o">*</span><span class="n">fs_type</span><span class="p">,</span>
				   <span class="kt">void</span> <span class="o">*</span><span class="n">options</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">nfs_parsed_mount_data</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">nfs_fh</span> <span class="o">*</span><span class="n">mntfh</span><span class="p">,</span>
				   <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">dev_name</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">nfs23_validate_mount_data</span><span class="p">(</span><span class="n">options</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">mntfh</span><span class="p">,</span> <span class="n">dev_name</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">nfs_validate_text_mount_data</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">options</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">nfs_parsed_mount_data</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span>
					<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">dev_name</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">port</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">max_namelen</span> <span class="o">=</span> <span class="n">PAGE_SIZE</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">max_pathlen</span> <span class="o">=</span> <span class="n">NFS_MAXPATHLEN</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="n">sap</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">args</span><span class="o">-&gt;</span><span class="n">nfs_server</span><span class="p">.</span><span class="n">address</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nfs_parse_mount_options</span><span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">options</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">nfs_verify_server_address</span><span class="p">(</span><span class="n">sap</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out_no_address</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">args</span><span class="o">-&gt;</span><span class="n">version</span> <span class="o">==</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#ifdef CONFIG_NFS_V4</span>
		<span class="n">port</span> <span class="o">=</span> <span class="n">NFS_PORT</span><span class="p">;</span>
		<span class="n">max_namelen</span> <span class="o">=</span> <span class="n">NFS4_MAXNAMLEN</span><span class="p">;</span>
		<span class="n">max_pathlen</span> <span class="o">=</span> <span class="n">NFS4_MAXPATHLEN</span><span class="p">;</span>
		<span class="n">nfs_validate_transport_protocol</span><span class="p">(</span><span class="n">args</span><span class="p">);</span>
		<span class="n">nfs4_validate_mount_flags</span><span class="p">(</span><span class="n">args</span><span class="p">);</span>
<span class="cp">#else</span>
		<span class="k">goto</span> <span class="n">out_v4_not_compiled</span><span class="p">;</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_NFS_V4 */</span><span class="cp"></span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">nfs_set_mount_transport_protocol</span><span class="p">(</span><span class="n">args</span><span class="p">);</span>

	<span class="n">nfs_set_port</span><span class="p">(</span><span class="n">sap</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">args</span><span class="o">-&gt;</span><span class="n">nfs_server</span><span class="p">.</span><span class="n">port</span><span class="p">,</span> <span class="n">port</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">args</span><span class="o">-&gt;</span><span class="n">auth_flavor_len</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_bad_auth</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">nfs_parse_devname</span><span class="p">(</span><span class="n">dev_name</span><span class="p">,</span>
				   <span class="o">&amp;</span><span class="n">args</span><span class="o">-&gt;</span><span class="n">nfs_server</span><span class="p">.</span><span class="n">hostname</span><span class="p">,</span>
				   <span class="n">max_namelen</span><span class="p">,</span>
				   <span class="o">&amp;</span><span class="n">args</span><span class="o">-&gt;</span><span class="n">nfs_server</span><span class="p">.</span><span class="n">export_path</span><span class="p">,</span>
				   <span class="n">max_pathlen</span><span class="p">);</span>

<span class="cp">#ifndef CONFIG_NFS_V4</span>
<span class="nl">out_v4_not_compiled:</span>
	<span class="n">dfprintk</span><span class="p">(</span><span class="n">MOUNT</span><span class="p">,</span> <span class="s">&quot;NFS: NFSv4 is not compiled into kernel</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EPROTONOSUPPORT</span><span class="p">;</span>
<span class="cp">#endif </span><span class="cm">/* !CONFIG_NFS_V4 */</span><span class="cp"></span>

<span class="nl">out_no_address:</span>
	<span class="n">dfprintk</span><span class="p">(</span><span class="n">MOUNT</span><span class="p">,</span> <span class="s">&quot;NFS: mount program didn&#39;t pass remote address</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

<span class="nl">out_bad_auth:</span>
	<span class="n">dfprintk</span><span class="p">(</span><span class="n">MOUNT</span><span class="p">,</span> <span class="s">&quot;NFS: Too many RPC auth flavours specified</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">nfs_compare_remount_data</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs_server</span> <span class="o">*</span><span class="n">nfss</span><span class="p">,</span>
			 <span class="k">struct</span> <span class="n">nfs_parsed_mount_data</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">!=</span> <span class="n">nfss</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">||</span>
	    <span class="n">data</span><span class="o">-&gt;</span><span class="n">rsize</span> <span class="o">!=</span> <span class="n">nfss</span><span class="o">-&gt;</span><span class="n">rsize</span> <span class="o">||</span>
	    <span class="n">data</span><span class="o">-&gt;</span><span class="n">wsize</span> <span class="o">!=</span> <span class="n">nfss</span><span class="o">-&gt;</span><span class="n">wsize</span> <span class="o">||</span>
	    <span class="n">data</span><span class="o">-&gt;</span><span class="n">retrans</span> <span class="o">!=</span> <span class="n">nfss</span><span class="o">-&gt;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">cl_timeout</span><span class="o">-&gt;</span><span class="n">to_retries</span> <span class="o">||</span>
	    <span class="n">data</span><span class="o">-&gt;</span><span class="n">auth_flavors</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">nfss</span><span class="o">-&gt;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">cl_auth</span><span class="o">-&gt;</span><span class="n">au_flavor</span> <span class="o">||</span>
	    <span class="n">data</span><span class="o">-&gt;</span><span class="n">acregmin</span> <span class="o">!=</span> <span class="n">nfss</span><span class="o">-&gt;</span><span class="n">acregmin</span> <span class="o">/</span> <span class="n">HZ</span> <span class="o">||</span>
	    <span class="n">data</span><span class="o">-&gt;</span><span class="n">acregmax</span> <span class="o">!=</span> <span class="n">nfss</span><span class="o">-&gt;</span><span class="n">acregmax</span> <span class="o">/</span> <span class="n">HZ</span> <span class="o">||</span>
	    <span class="n">data</span><span class="o">-&gt;</span><span class="n">acdirmin</span> <span class="o">!=</span> <span class="n">nfss</span><span class="o">-&gt;</span><span class="n">acdirmin</span> <span class="o">/</span> <span class="n">HZ</span> <span class="o">||</span>
	    <span class="n">data</span><span class="o">-&gt;</span><span class="n">acdirmax</span> <span class="o">!=</span> <span class="n">nfss</span><span class="o">-&gt;</span><span class="n">acdirmax</span> <span class="o">/</span> <span class="n">HZ</span> <span class="o">||</span>
	    <span class="n">data</span><span class="o">-&gt;</span><span class="n">timeo</span> <span class="o">!=</span> <span class="p">(</span><span class="mi">10U</span> <span class="o">*</span> <span class="n">nfss</span><span class="o">-&gt;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">cl_timeout</span><span class="o">-&gt;</span><span class="n">to_initval</span> <span class="o">/</span> <span class="n">HZ</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">data</span><span class="o">-&gt;</span><span class="n">nfs_server</span><span class="p">.</span><span class="n">port</span> <span class="o">!=</span> <span class="n">nfss</span><span class="o">-&gt;</span><span class="n">port</span> <span class="o">||</span>
	    <span class="n">data</span><span class="o">-&gt;</span><span class="n">nfs_server</span><span class="p">.</span><span class="n">addrlen</span> <span class="o">!=</span> <span class="n">nfss</span><span class="o">-&gt;</span><span class="n">nfs_client</span><span class="o">-&gt;</span><span class="n">cl_addrlen</span> <span class="o">||</span>
	    <span class="o">!</span><span class="n">rpc_cmp_addr</span><span class="p">((</span><span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">nfs_server</span><span class="p">.</span><span class="n">address</span><span class="p">,</span>
			  <span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">nfss</span><span class="o">-&gt;</span><span class="n">nfs_client</span><span class="o">-&gt;</span><span class="n">cl_addr</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">nfs_remount</span><span class="p">(</span><span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">sb</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">flags</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">raw_data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">error</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nfs_server</span> <span class="o">*</span><span class="n">nfss</span> <span class="o">=</span> <span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_fs_info</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nfs_parsed_mount_data</span> <span class="o">*</span><span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nfs_mount_data</span> <span class="o">*</span><span class="n">options</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">nfs_mount_data</span> <span class="o">*</span><span class="p">)</span><span class="n">raw_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nfs4_mount_data</span> <span class="o">*</span><span class="n">options4</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">nfs4_mount_data</span> <span class="o">*</span><span class="p">)</span><span class="n">raw_data</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">nfsvers</span> <span class="o">=</span> <span class="n">nfss</span><span class="o">-&gt;</span><span class="n">nfs_client</span><span class="o">-&gt;</span><span class="n">rpc_ops</span><span class="o">-&gt;</span><span class="n">version</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Userspace mount programs that send binary options generally send</span>
<span class="cm">	 * them populated with default values. We have no way to know which</span>
<span class="cm">	 * ones were explicitly specified. Fall back to legacy behavior and</span>
<span class="cm">	 * just return success.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">nfsvers</span> <span class="o">==</span> <span class="mi">4</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="o">!</span><span class="n">options4</span> <span class="o">||</span> <span class="n">options4</span><span class="o">-&gt;</span><span class="n">version</span> <span class="o">==</span> <span class="mi">1</span><span class="p">))</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">nfsvers</span> <span class="o">&lt;=</span> <span class="mi">3</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="o">!</span><span class="n">options</span> <span class="o">||</span> <span class="p">(</span><span class="n">options</span><span class="o">-&gt;</span><span class="n">version</span> <span class="o">&gt;=</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span>
					   <span class="n">options</span><span class="o">-&gt;</span><span class="n">version</span> <span class="o">&lt;=</span> <span class="mi">6</span><span class="p">))))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">data</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">data</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">data</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="cm">/* fill out struct with values from existing mount */</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">nfss</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">;</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">rsize</span> <span class="o">=</span> <span class="n">nfss</span><span class="o">-&gt;</span><span class="n">rsize</span><span class="p">;</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">wsize</span> <span class="o">=</span> <span class="n">nfss</span><span class="o">-&gt;</span><span class="n">wsize</span><span class="p">;</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">retrans</span> <span class="o">=</span> <span class="n">nfss</span><span class="o">-&gt;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">cl_timeout</span><span class="o">-&gt;</span><span class="n">to_retries</span><span class="p">;</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">auth_flavors</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">nfss</span><span class="o">-&gt;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">cl_auth</span><span class="o">-&gt;</span><span class="n">au_flavor</span><span class="p">;</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">acregmin</span> <span class="o">=</span> <span class="n">nfss</span><span class="o">-&gt;</span><span class="n">acregmin</span> <span class="o">/</span> <span class="n">HZ</span><span class="p">;</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">acregmax</span> <span class="o">=</span> <span class="n">nfss</span><span class="o">-&gt;</span><span class="n">acregmax</span> <span class="o">/</span> <span class="n">HZ</span><span class="p">;</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">acdirmin</span> <span class="o">=</span> <span class="n">nfss</span><span class="o">-&gt;</span><span class="n">acdirmin</span> <span class="o">/</span> <span class="n">HZ</span><span class="p">;</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">acdirmax</span> <span class="o">=</span> <span class="n">nfss</span><span class="o">-&gt;</span><span class="n">acdirmax</span> <span class="o">/</span> <span class="n">HZ</span><span class="p">;</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">timeo</span> <span class="o">=</span> <span class="mi">10U</span> <span class="o">*</span> <span class="n">nfss</span><span class="o">-&gt;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">cl_timeout</span><span class="o">-&gt;</span><span class="n">to_initval</span> <span class="o">/</span> <span class="n">HZ</span><span class="p">;</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">nfs_server</span><span class="p">.</span><span class="n">port</span> <span class="o">=</span> <span class="n">nfss</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">;</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">nfs_server</span><span class="p">.</span><span class="n">addrlen</span> <span class="o">=</span> <span class="n">nfss</span><span class="o">-&gt;</span><span class="n">nfs_client</span><span class="o">-&gt;</span><span class="n">cl_addrlen</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">nfs_server</span><span class="p">.</span><span class="n">address</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">nfss</span><span class="o">-&gt;</span><span class="n">nfs_client</span><span class="o">-&gt;</span><span class="n">cl_addr</span><span class="p">,</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">nfs_server</span><span class="p">.</span><span class="n">addrlen</span><span class="p">);</span>

	<span class="cm">/* overwrite those values with any that were specified */</span>
	<span class="n">error</span> <span class="o">=</span> <span class="n">nfs_parse_mount_options</span><span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">options</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * noac is a special case. It implies -o sync, but that&#39;s not</span>
<span class="cm">	 * necessarily reflected in the mtab options. do_remount_sb</span>
<span class="cm">	 * will clear MS_SYNCHRONOUS if -o sync wasn&#39;t specified in the</span>
<span class="cm">	 * remount options, so we have to explicitly reset it.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">NFS_MOUNT_NOAC</span><span class="p">)</span>
		<span class="o">*</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">MS_SYNCHRONOUS</span><span class="p">;</span>

	<span class="cm">/* compare new mount options with old ones */</span>
	<span class="n">error</span> <span class="o">=</span> <span class="n">nfs_compare_remount_data</span><span class="p">(</span><span class="n">nfss</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Initialise the common bits of the superblock</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">nfs_initialise_sb</span><span class="p">(</span><span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">sb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfs_server</span> <span class="o">*</span><span class="n">server</span> <span class="o">=</span> <span class="n">NFS_SB</span><span class="p">(</span><span class="n">sb</span><span class="p">);</span>

	<span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_magic</span> <span class="o">=</span> <span class="n">NFS_SUPER_MAGIC</span><span class="p">;</span>

	<span class="cm">/* We probably want something more informative here */</span>
	<span class="n">snprintf</span><span class="p">(</span><span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_id</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_id</span><span class="p">),</span>
		 <span class="s">&quot;%u:%u&quot;</span><span class="p">,</span> <span class="n">MAJOR</span><span class="p">(</span><span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_dev</span><span class="p">),</span> <span class="n">MINOR</span><span class="p">(</span><span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_dev</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_blocksize</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_blocksize</span> <span class="o">=</span> <span class="n">nfs_block_bits</span><span class="p">(</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">wsize</span><span class="p">,</span>
						 <span class="o">&amp;</span><span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_blocksize_bits</span><span class="p">);</span>

	<span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_bdi</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">backing_dev_info</span><span class="p">;</span>

	<span class="n">nfs_super_set_maxbytes</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">server</span><span class="o">-&gt;</span><span class="n">maxfilesize</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Finish setting up an NFS2/3 superblock</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">nfs_fill_super</span><span class="p">(</span><span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">sb</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">nfs_mount_info</span> <span class="o">*</span><span class="n">mount_info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfs_parsed_mount_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">mount_info</span><span class="o">-&gt;</span><span class="n">parsed</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nfs_server</span> <span class="o">*</span><span class="n">server</span> <span class="o">=</span> <span class="n">NFS_SB</span><span class="p">(</span><span class="n">sb</span><span class="p">);</span>

	<span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_blocksize_bits</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_blocksize</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">bsize</span><span class="p">)</span>
		<span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_blocksize</span> <span class="o">=</span> <span class="n">nfs_block_size</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">bsize</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_blocksize_bits</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">nfs_client</span><span class="o">-&gt;</span><span class="n">rpc_ops</span><span class="o">-&gt;</span><span class="n">version</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* The VFS shouldn&#39;t apply the umask to mode bits. We will do</span>
<span class="cm">		 * so ourselves when necessary.</span>
<span class="cm">		 */</span>
		<span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_flags</span> <span class="o">|=</span> <span class="n">MS_POSIXACL</span><span class="p">;</span>
		<span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_time_gran</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_op</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">nfs_sops</span><span class="p">;</span>
 	<span class="n">nfs_initialise_sb</span><span class="p">(</span><span class="n">sb</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Finish setting up a cloned NFS2/3 superblock</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">nfs_clone_super</span><span class="p">(</span><span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">sb</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">nfs_mount_info</span> <span class="o">*</span><span class="n">mount_info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">old_sb</span> <span class="o">=</span> <span class="n">mount_info</span><span class="o">-&gt;</span><span class="n">cloned</span><span class="o">-&gt;</span><span class="n">sb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nfs_server</span> <span class="o">*</span><span class="n">server</span> <span class="o">=</span> <span class="n">NFS_SB</span><span class="p">(</span><span class="n">sb</span><span class="p">);</span>

	<span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_blocksize_bits</span> <span class="o">=</span> <span class="n">old_sb</span><span class="o">-&gt;</span><span class="n">s_blocksize_bits</span><span class="p">;</span>
	<span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_blocksize</span> <span class="o">=</span> <span class="n">old_sb</span><span class="o">-&gt;</span><span class="n">s_blocksize</span><span class="p">;</span>
	<span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_maxbytes</span> <span class="o">=</span> <span class="n">old_sb</span><span class="o">-&gt;</span><span class="n">s_maxbytes</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">nfs_client</span><span class="o">-&gt;</span><span class="n">rpc_ops</span><span class="o">-&gt;</span><span class="n">version</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* The VFS shouldn&#39;t apply the umask to mode bits. We will do</span>
<span class="cm">		 * so ourselves when necessary.</span>
<span class="cm">		 */</span>
		<span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_flags</span> <span class="o">|=</span> <span class="n">MS_POSIXACL</span><span class="p">;</span>
		<span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_time_gran</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_op</span> <span class="o">=</span> <span class="n">old_sb</span><span class="o">-&gt;</span><span class="n">s_op</span><span class="p">;</span>
 	<span class="n">nfs_initialise_sb</span><span class="p">(</span><span class="n">sb</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">nfs_compare_mount_options</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">nfs_server</span> <span class="o">*</span><span class="n">b</span><span class="p">,</span> <span class="kt">int</span> <span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">nfs_server</span> <span class="o">*</span><span class="n">a</span> <span class="o">=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">s_fs_info</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">rpc_clnt</span> <span class="o">*</span><span class="n">clnt_a</span> <span class="o">=</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">client</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">rpc_clnt</span> <span class="o">*</span><span class="n">clnt_b</span> <span class="o">=</span> <span class="n">b</span><span class="o">-&gt;</span><span class="n">client</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">s_flags</span> <span class="o">&amp;</span> <span class="n">NFS_MS_MASK</span><span class="p">)</span> <span class="o">!=</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">NFS_MS_MASK</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">Ebusy</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">nfs_client</span> <span class="o">!=</span> <span class="n">b</span><span class="o">-&gt;</span><span class="n">nfs_client</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">Ebusy</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">!=</span> <span class="n">b</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">Ebusy</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">wsize</span> <span class="o">!=</span> <span class="n">b</span><span class="o">-&gt;</span><span class="n">wsize</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">Ebusy</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">rsize</span> <span class="o">!=</span> <span class="n">b</span><span class="o">-&gt;</span><span class="n">rsize</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">Ebusy</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">acregmin</span> <span class="o">!=</span> <span class="n">b</span><span class="o">-&gt;</span><span class="n">acregmin</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">Ebusy</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">acregmax</span> <span class="o">!=</span> <span class="n">b</span><span class="o">-&gt;</span><span class="n">acregmax</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">Ebusy</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">acdirmin</span> <span class="o">!=</span> <span class="n">b</span><span class="o">-&gt;</span><span class="n">acdirmin</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">Ebusy</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">acdirmax</span> <span class="o">!=</span> <span class="n">b</span><span class="o">-&gt;</span><span class="n">acdirmax</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">Ebusy</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">clnt_a</span><span class="o">-&gt;</span><span class="n">cl_auth</span><span class="o">-&gt;</span><span class="n">au_flavor</span> <span class="o">!=</span> <span class="n">clnt_b</span><span class="o">-&gt;</span><span class="n">cl_auth</span><span class="o">-&gt;</span><span class="n">au_flavor</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">Ebusy</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="nl">Ebusy:</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">nfs_sb_mountdata</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfs_server</span> <span class="o">*</span><span class="n">server</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">mntflags</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">nfs_set_super</span><span class="p">(</span><span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfs_sb_mountdata</span> <span class="o">*</span><span class="n">sb_mntdata</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nfs_server</span> <span class="o">*</span><span class="n">server</span> <span class="o">=</span> <span class="n">sb_mntdata</span><span class="o">-&gt;</span><span class="n">server</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">s</span><span class="o">-&gt;</span><span class="n">s_flags</span> <span class="o">=</span> <span class="n">sb_mntdata</span><span class="o">-&gt;</span><span class="n">mntflags</span><span class="p">;</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">s_fs_info</span> <span class="o">=</span> <span class="n">server</span><span class="p">;</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">s_d_op</span> <span class="o">=</span> <span class="n">server</span><span class="o">-&gt;</span><span class="n">nfs_client</span><span class="o">-&gt;</span><span class="n">rpc_ops</span><span class="o">-&gt;</span><span class="n">dentry_ops</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">set_anon_super</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">server</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">server</span><span class="o">-&gt;</span><span class="n">s_dev</span> <span class="o">=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">s_dev</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">nfs_compare_super_address</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs_server</span> <span class="o">*</span><span class="n">server1</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">nfs_server</span> <span class="o">*</span><span class="n">server2</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="n">sap1</span><span class="p">,</span> <span class="o">*</span><span class="n">sap2</span><span class="p">;</span>

	<span class="n">sap1</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">server1</span><span class="o">-&gt;</span><span class="n">nfs_client</span><span class="o">-&gt;</span><span class="n">cl_addr</span><span class="p">;</span>
	<span class="n">sap2</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">server2</span><span class="o">-&gt;</span><span class="n">nfs_client</span><span class="o">-&gt;</span><span class="n">cl_addr</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sap1</span><span class="o">-&gt;</span><span class="n">sa_family</span> <span class="o">!=</span> <span class="n">sap2</span><span class="o">-&gt;</span><span class="n">sa_family</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">sap1</span><span class="o">-&gt;</span><span class="n">sa_family</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">AF_INET</span>: <span class="p">{</span>
		<span class="k">struct</span> <span class="n">sockaddr_in</span> <span class="o">*</span><span class="n">sin1</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr_in</span> <span class="o">*</span><span class="p">)</span><span class="n">sap1</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">sockaddr_in</span> <span class="o">*</span><span class="n">sin2</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr_in</span> <span class="o">*</span><span class="p">)</span><span class="n">sap2</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sin1</span><span class="o">-&gt;</span><span class="n">sin_addr</span><span class="p">.</span><span class="n">s_addr</span> <span class="o">!=</span> <span class="n">sin2</span><span class="o">-&gt;</span><span class="n">sin_addr</span><span class="p">.</span><span class="n">s_addr</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sin1</span><span class="o">-&gt;</span><span class="n">sin_port</span> <span class="o">!=</span> <span class="n">sin2</span><span class="o">-&gt;</span><span class="n">sin_port</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">case</span> <span class="n">AF_INET6</span>: <span class="p">{</span>
		<span class="k">struct</span> <span class="n">sockaddr_in6</span> <span class="o">*</span><span class="n">sin1</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr_in6</span> <span class="o">*</span><span class="p">)</span><span class="n">sap1</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">sockaddr_in6</span> <span class="o">*</span><span class="n">sin2</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr_in6</span> <span class="o">*</span><span class="p">)</span><span class="n">sap2</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ipv6_addr_equal</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sin1</span><span class="o">-&gt;</span><span class="n">sin6_addr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sin2</span><span class="o">-&gt;</span><span class="n">sin6_addr</span><span class="p">))</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sin1</span><span class="o">-&gt;</span><span class="n">sin6_port</span> <span class="o">!=</span> <span class="n">sin2</span><span class="o">-&gt;</span><span class="n">sin6_port</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">nfs_compare_super</span><span class="p">(</span><span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">sb</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfs_sb_mountdata</span> <span class="o">*</span><span class="n">sb_mntdata</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nfs_server</span> <span class="o">*</span><span class="n">server</span> <span class="o">=</span> <span class="n">sb_mntdata</span><span class="o">-&gt;</span><span class="n">server</span><span class="p">,</span> <span class="o">*</span><span class="n">old</span> <span class="o">=</span> <span class="n">NFS_SB</span><span class="p">(</span><span class="n">sb</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">mntflags</span> <span class="o">=</span> <span class="n">sb_mntdata</span><span class="o">-&gt;</span><span class="n">mntflags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">nfs_compare_super_address</span><span class="p">(</span><span class="n">old</span><span class="p">,</span> <span class="n">server</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="cm">/* Note: NFS_MOUNT_UNSHARED == NFS4_MOUNT_UNSHARED */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">old</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">NFS_MOUNT_UNSHARED</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">memcmp</span><span class="p">(</span><span class="o">&amp;</span><span class="n">old</span><span class="o">-&gt;</span><span class="n">fsid</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">fsid</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">old</span><span class="o">-&gt;</span><span class="n">fsid</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">nfs_compare_mount_options</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">server</span><span class="p">,</span> <span class="n">mntflags</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_NFS_FSCACHE</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">nfs_get_cache_cookie</span><span class="p">(</span><span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">sb</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">nfs_parsed_mount_data</span> <span class="o">*</span><span class="n">parsed</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">nfs_clone_mount</span> <span class="o">*</span><span class="n">cloned</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">uniq</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ulen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">parsed</span> <span class="o">&amp;&amp;</span> <span class="n">parsed</span><span class="o">-&gt;</span><span class="n">fscache_uniq</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">uniq</span> <span class="o">=</span> <span class="n">parsed</span><span class="o">-&gt;</span><span class="n">fscache_uniq</span><span class="p">;</span>
		<span class="n">ulen</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">parsed</span><span class="o">-&gt;</span><span class="n">fscache_uniq</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">cloned</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">nfs_server</span> <span class="o">*</span><span class="n">mnt_s</span> <span class="o">=</span> <span class="n">NFS_SB</span><span class="p">(</span><span class="n">cloned</span><span class="o">-&gt;</span><span class="n">sb</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mnt_s</span><span class="o">-&gt;</span><span class="n">fscache_key</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">uniq</span> <span class="o">=</span> <span class="n">mnt_s</span><span class="o">-&gt;</span><span class="n">fscache_key</span><span class="o">-&gt;</span><span class="n">key</span><span class="p">.</span><span class="n">uniquifier</span><span class="p">;</span>
			<span class="n">ulen</span> <span class="o">=</span> <span class="n">mnt_s</span><span class="o">-&gt;</span><span class="n">fscache_key</span><span class="o">-&gt;</span><span class="n">key</span><span class="p">.</span><span class="n">uniq_len</span><span class="p">;</span>
		<span class="p">};</span>
	<span class="p">}</span>

	<span class="n">nfs_fscache_get_super_cookie</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">uniq</span><span class="p">,</span> <span class="n">ulen</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#else</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">nfs_get_cache_cookie</span><span class="p">(</span><span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">sb</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">nfs_parsed_mount_data</span> <span class="o">*</span><span class="n">parsed</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">nfs_clone_mount</span> <span class="o">*</span><span class="n">cloned</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">nfs_bdi_register</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs_server</span> <span class="o">*</span><span class="n">server</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">bdi_register_dev</span><span class="p">(</span><span class="o">&amp;</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">backing_dev_info</span><span class="p">,</span> <span class="n">server</span><span class="o">-&gt;</span><span class="n">s_dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">nfs_set_sb_security</span><span class="p">(</span><span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="n">mntroot</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">nfs_mount_info</span> <span class="o">*</span><span class="n">mount_info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">security_sb_set_mnt_opts</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mount_info</span><span class="o">-&gt;</span><span class="n">parsed</span><span class="o">-&gt;</span><span class="n">lsm_opts</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">nfs_clone_sb_security</span><span class="p">(</span><span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="n">mntroot</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">nfs_mount_info</span> <span class="o">*</span><span class="n">mount_info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* clone any lsm security options from the parent to the new sb */</span>
	<span class="n">security_sb_clone_mnt_opts</span><span class="p">(</span><span class="n">mount_info</span><span class="o">-&gt;</span><span class="n">cloned</span><span class="o">-&gt;</span><span class="n">sb</span><span class="p">,</span> <span class="n">s</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mntroot</span><span class="o">-&gt;</span><span class="n">d_inode</span><span class="o">-&gt;</span><span class="n">i_op</span> <span class="o">!=</span> <span class="n">NFS_SB</span><span class="p">(</span><span class="n">s</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">nfs_client</span><span class="o">-&gt;</span><span class="n">rpc_ops</span><span class="o">-&gt;</span><span class="n">dir_inode_ops</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ESTALE</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="nf">nfs_fs_mount_common</span><span class="p">(</span><span class="k">struct</span> <span class="n">file_system_type</span> <span class="o">*</span><span class="n">fs_type</span><span class="p">,</span>
					  <span class="k">struct</span> <span class="n">nfs_server</span> <span class="o">*</span><span class="n">server</span><span class="p">,</span>
					  <span class="kt">int</span> <span class="n">flags</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">dev_name</span><span class="p">,</span>
					  <span class="k">struct</span> <span class="n">nfs_mount_info</span> <span class="o">*</span><span class="n">mount_info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">s</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="n">mntroot</span> <span class="o">=</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">ENOMEM</span><span class="p">);</span>
	<span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">compare_super</span><span class="p">)(</span><span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="o">=</span> <span class="n">nfs_compare_super</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nfs_sb_mountdata</span> <span class="n">sb_mntdata</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">mntflags</span> <span class="o">=</span> <span class="n">flags</span><span class="p">,</span>
		<span class="p">.</span><span class="n">server</span> <span class="o">=</span> <span class="n">server</span><span class="p">,</span>
	<span class="p">};</span>
	<span class="kt">int</span> <span class="n">error</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">NFS_MOUNT_UNSHARED</span><span class="p">)</span>
		<span class="n">compare_super</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="cm">/* -o noac implies -o sync */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">NFS_MOUNT_NOAC</span><span class="p">)</span>
		<span class="n">sb_mntdata</span><span class="p">.</span><span class="n">mntflags</span> <span class="o">|=</span> <span class="n">MS_SYNCHRONOUS</span><span class="p">;</span>

	<span class="cm">/* Get a superblock - note that we may end up sharing one that already exists */</span>
	<span class="n">s</span> <span class="o">=</span> <span class="n">sget</span><span class="p">(</span><span class="n">fs_type</span><span class="p">,</span> <span class="n">compare_super</span><span class="p">,</span> <span class="n">nfs_set_super</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sb_mntdata</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">s</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">mntroot</span> <span class="o">=</span> <span class="n">ERR_CAST</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_err_nosb</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">s_fs_info</span> <span class="o">!=</span> <span class="n">server</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">nfs_free_server</span><span class="p">(</span><span class="n">server</span><span class="p">);</span>
		<span class="n">server</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">error</span> <span class="o">=</span> <span class="n">nfs_bdi_register</span><span class="p">(</span><span class="n">server</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">mntroot</span> <span class="o">=</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="n">error</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">error_splat_bdi</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">s_root</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* initial superblock/root creation */</span>
		<span class="n">mount_info</span><span class="o">-&gt;</span><span class="n">fill_super</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">mount_info</span><span class="p">);</span>
		<span class="n">nfs_get_cache_cookie</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">mount_info</span><span class="o">-&gt;</span><span class="n">parsed</span><span class="p">,</span> <span class="n">mount_info</span><span class="o">-&gt;</span><span class="n">cloned</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">mntroot</span> <span class="o">=</span> <span class="n">nfs_get_root</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">mount_info</span><span class="o">-&gt;</span><span class="n">mntfh</span><span class="p">,</span> <span class="n">dev_name</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">mntroot</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">error_splat_super</span><span class="p">;</span>

	<span class="n">error</span> <span class="o">=</span> <span class="n">mount_info</span><span class="o">-&gt;</span><span class="n">set_security</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">mntroot</span><span class="p">,</span> <span class="n">mount_info</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error_splat_root</span><span class="p">;</span>

	<span class="n">s</span><span class="o">-&gt;</span><span class="n">s_flags</span> <span class="o">|=</span> <span class="n">MS_ACTIVE</span><span class="p">;</span>

<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">mntroot</span><span class="p">;</span>

<span class="nl">out_err_nosb:</span>
	<span class="n">nfs_free_server</span><span class="p">(</span><span class="n">server</span><span class="p">);</span>
	<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

<span class="nl">error_splat_root:</span>
	<span class="n">dput</span><span class="p">(</span><span class="n">mntroot</span><span class="p">);</span>
	<span class="n">mntroot</span> <span class="o">=</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="n">error</span><span class="p">);</span>
<span class="nl">error_splat_super:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">server</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">s_root</span><span class="p">)</span>
		<span class="n">bdi_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">backing_dev_info</span><span class="p">);</span>
<span class="nl">error_splat_bdi:</span>
	<span class="n">deactivate_locked_super</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
	<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="nf">nfs_fs_mount</span><span class="p">(</span><span class="k">struct</span> <span class="n">file_system_type</span> <span class="o">*</span><span class="n">fs_type</span><span class="p">,</span>
	<span class="kt">int</span> <span class="n">flags</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">dev_name</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">raw_data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfs_mount_info</span> <span class="n">mount_info</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">fill_super</span> <span class="o">=</span> <span class="n">nfs_fill_super</span><span class="p">,</span>
		<span class="p">.</span><span class="n">set_security</span> <span class="o">=</span> <span class="n">nfs_set_sb_security</span><span class="p">,</span>
	<span class="p">};</span>
	<span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="n">mntroot</span> <span class="o">=</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">ENOMEM</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">error</span><span class="p">;</span>

	<span class="n">mount_info</span><span class="p">.</span><span class="n">parsed</span> <span class="o">=</span> <span class="n">nfs_alloc_parsed_mount_data</span><span class="p">();</span>
	<span class="n">mount_info</span><span class="p">.</span><span class="n">mntfh</span> <span class="o">=</span> <span class="n">nfs_alloc_fhandle</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mount_info</span><span class="p">.</span><span class="n">parsed</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span> <span class="n">mount_info</span><span class="p">.</span><span class="n">mntfh</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="cm">/* Validate the mount data */</span>
	<span class="n">error</span> <span class="o">=</span> <span class="n">nfs_validate_mount_data</span><span class="p">(</span><span class="n">fs_type</span><span class="p">,</span> <span class="n">raw_data</span><span class="p">,</span> <span class="n">mount_info</span><span class="p">.</span><span class="n">parsed</span><span class="p">,</span> <span class="n">mount_info</span><span class="p">.</span><span class="n">mntfh</span><span class="p">,</span> <span class="n">dev_name</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span> <span class="o">==</span> <span class="n">NFS_TEXT_DATA</span><span class="p">)</span>
		<span class="n">error</span> <span class="o">=</span> <span class="n">nfs_validate_text_mount_data</span><span class="p">(</span><span class="n">raw_data</span><span class="p">,</span> <span class="n">mount_info</span><span class="p">.</span><span class="n">parsed</span><span class="p">,</span> <span class="n">dev_name</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mntroot</span> <span class="o">=</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="n">error</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

<span class="cp">#ifdef CONFIG_NFS_V4</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mount_info</span><span class="p">.</span><span class="n">parsed</span><span class="o">-&gt;</span><span class="n">version</span> <span class="o">==</span> <span class="mi">4</span><span class="p">)</span>
		<span class="n">mntroot</span> <span class="o">=</span> <span class="n">nfs4_try_mount</span><span class="p">(</span><span class="n">flags</span><span class="p">,</span> <span class="n">dev_name</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mount_info</span><span class="p">);</span>
	<span class="k">else</span>
<span class="cp">#endif	</span><span class="cm">/* CONFIG_NFS_V4 */</span><span class="cp"></span>
		<span class="n">mntroot</span> <span class="o">=</span> <span class="n">nfs_try_mount</span><span class="p">(</span><span class="n">flags</span><span class="p">,</span> <span class="n">dev_name</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mount_info</span><span class="p">);</span>

<span class="nl">out:</span>
	<span class="n">nfs_free_parsed_mount_data</span><span class="p">(</span><span class="n">mount_info</span><span class="p">.</span><span class="n">parsed</span><span class="p">);</span>
	<span class="n">nfs_free_fhandle</span><span class="p">(</span><span class="n">mount_info</span><span class="p">.</span><span class="n">mntfh</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">mntroot</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Ensure that we unregister the bdi before kill_anon_super</span>
<span class="cm"> * releases the device name</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">nfs_put_super</span><span class="p">(</span><span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">s</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfs_server</span> <span class="o">*</span><span class="n">server</span> <span class="o">=</span> <span class="n">NFS_SB</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>

	<span class="n">bdi_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">backing_dev_info</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Destroy an NFS2/3 superblock</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">nfs_kill_super</span><span class="p">(</span><span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">s</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfs_server</span> <span class="o">*</span><span class="n">server</span> <span class="o">=</span> <span class="n">NFS_SB</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>

	<span class="n">kill_anon_super</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
	<span class="n">nfs_fscache_release_super_cookie</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
	<span class="n">nfs_free_server</span><span class="p">(</span><span class="n">server</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Clone an NFS2/3/4 server record on xdev traversal (FSID-change)</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span>
<span class="nf">nfs_xdev_mount_common</span><span class="p">(</span><span class="k">struct</span> <span class="n">file_system_type</span> <span class="o">*</span><span class="n">fs_type</span><span class="p">,</span> <span class="kt">int</span> <span class="n">flags</span><span class="p">,</span>
		<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">dev_name</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nfs_mount_info</span> <span class="o">*</span><span class="n">mount_info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfs_clone_mount</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">mount_info</span><span class="o">-&gt;</span><span class="n">cloned</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nfs_server</span> <span class="o">*</span><span class="n">server</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="n">mntroot</span> <span class="o">=</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">ENOMEM</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">error</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;--&gt; nfs_xdev_mount_common()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">mount_info</span><span class="o">-&gt;</span><span class="n">mntfh</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">fh</span><span class="p">;</span>

	<span class="cm">/* create a new volume representation */</span>
	<span class="n">server</span> <span class="o">=</span> <span class="n">nfs_clone_server</span><span class="p">(</span><span class="n">NFS_SB</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">sb</span><span class="p">),</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">fh</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">fattr</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">authflavor</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">server</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">error</span> <span class="o">=</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">server</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mntroot</span> <span class="o">=</span> <span class="n">nfs_fs_mount_common</span><span class="p">(</span><span class="n">fs_type</span><span class="p">,</span> <span class="n">server</span><span class="p">,</span> <span class="n">flags</span><span class="p">,</span> <span class="n">dev_name</span><span class="p">,</span> <span class="n">mount_info</span><span class="p">);</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;&lt;-- nfs_xdev_mount_common() = 0</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">mntroot</span><span class="p">;</span>

<span class="nl">out_err:</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;&lt;-- nfs_xdev_mount_common() = %d [error]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">error</span><span class="p">);</span>
	<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Clone an NFS2/3 server record on xdev traversal (FSID-change)</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span>
<span class="nf">nfs_xdev_mount</span><span class="p">(</span><span class="k">struct</span> <span class="n">file_system_type</span> <span class="o">*</span><span class="n">fs_type</span><span class="p">,</span> <span class="kt">int</span> <span class="n">flags</span><span class="p">,</span>
		<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">dev_name</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">raw_data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfs_mount_info</span> <span class="n">mount_info</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">fill_super</span> <span class="o">=</span> <span class="n">nfs_clone_super</span><span class="p">,</span>
		<span class="p">.</span><span class="n">set_security</span> <span class="o">=</span> <span class="n">nfs_clone_sb_security</span><span class="p">,</span>
		<span class="p">.</span><span class="n">cloned</span>   <span class="o">=</span> <span class="n">raw_data</span><span class="p">,</span>
	<span class="p">};</span>
	<span class="k">return</span> <span class="n">nfs_xdev_mount_common</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nfs_fs_type</span><span class="p">,</span> <span class="n">flags</span><span class="p">,</span> <span class="n">dev_name</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mount_info</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_NFS_V4</span>

<span class="cm">/*</span>
<span class="cm"> * Finish setting up a cloned NFS4 superblock</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">nfs4_clone_super</span><span class="p">(</span><span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">sb</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">nfs_mount_info</span> <span class="o">*</span><span class="n">mount_info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">old_sb</span> <span class="o">=</span> <span class="n">mount_info</span><span class="o">-&gt;</span><span class="n">cloned</span><span class="o">-&gt;</span><span class="n">sb</span><span class="p">;</span>
	<span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_blocksize_bits</span> <span class="o">=</span> <span class="n">old_sb</span><span class="o">-&gt;</span><span class="n">s_blocksize_bits</span><span class="p">;</span>
	<span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_blocksize</span> <span class="o">=</span> <span class="n">old_sb</span><span class="o">-&gt;</span><span class="n">s_blocksize</span><span class="p">;</span>
	<span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_maxbytes</span> <span class="o">=</span> <span class="n">old_sb</span><span class="o">-&gt;</span><span class="n">s_maxbytes</span><span class="p">;</span>
	<span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_time_gran</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_op</span> <span class="o">=</span> <span class="n">old_sb</span><span class="o">-&gt;</span><span class="n">s_op</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * The VFS shouldn&#39;t apply the umask to mode bits. We will do</span>
<span class="cm">	 * so ourselves when necessary.</span>
<span class="cm">	 */</span>
	<span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_flags</span>  <span class="o">|=</span> <span class="n">MS_POSIXACL</span><span class="p">;</span>
	<span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_xattr</span>  <span class="o">=</span> <span class="n">old_sb</span><span class="o">-&gt;</span><span class="n">s_xattr</span><span class="p">;</span>
	<span class="n">nfs_initialise_sb</span><span class="p">(</span><span class="n">sb</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Set up an NFS4 superblock</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">nfs4_fill_super</span><span class="p">(</span><span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">sb</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">nfs_mount_info</span> <span class="o">*</span><span class="n">mount_info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_time_gran</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_op</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">nfs4_sops</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * The VFS shouldn&#39;t apply the umask to mode bits. We will do</span>
<span class="cm">	 * so ourselves when necessary.</span>
<span class="cm">	 */</span>
	<span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_flags</span>  <span class="o">|=</span> <span class="n">MS_POSIXACL</span><span class="p">;</span>
	<span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_xattr</span> <span class="o">=</span> <span class="n">nfs4_xattr_handlers</span><span class="p">;</span>
	<span class="n">nfs_initialise_sb</span><span class="p">(</span><span class="n">sb</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">nfs4_validate_mount_flags</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs_parsed_mount_data</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">args</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">NFS_MOUNT_NONLM</span><span class="o">|</span><span class="n">NFS_MOUNT_NOACL</span><span class="o">|</span><span class="n">NFS_MOUNT_VER3</span><span class="o">|</span>
			 <span class="n">NFS_MOUNT_LOCAL_FLOCK</span><span class="o">|</span><span class="n">NFS_MOUNT_LOCAL_FCNTL</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Validate NFSv4 mount options</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">nfs4_validate_mount_data</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">options</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">nfs_parsed_mount_data</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span>
				    <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">dev_name</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="n">sap</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">args</span><span class="o">-&gt;</span><span class="n">nfs_server</span><span class="p">.</span><span class="n">address</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nfs4_mount_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">nfs4_mount_data</span> <span class="o">*</span><span class="p">)</span><span class="n">options</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">c</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">data</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_no_data</span><span class="p">;</span>

	<span class="n">args</span><span class="o">-&gt;</span><span class="n">version</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">version</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">1</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">host_addrlen</span> <span class="o">&gt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">args</span><span class="o">-&gt;</span><span class="n">nfs_server</span><span class="p">.</span><span class="n">address</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">out_no_address</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">host_addrlen</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out_no_address</span><span class="p">;</span>
		<span class="n">args</span><span class="o">-&gt;</span><span class="n">nfs_server</span><span class="p">.</span><span class="n">addrlen</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">host_addrlen</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="n">sap</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">host_addr</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">host_addrlen</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">nfs_verify_server_address</span><span class="p">(</span><span class="n">sap</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">out_no_address</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">auth_flavourlen</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">auth_flavourlen</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">out_inval_auth</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">args</span><span class="o">-&gt;</span><span class="n">auth_flavors</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
					   <span class="n">data</span><span class="o">-&gt;</span><span class="n">auth_flavours</span><span class="p">,</span>
					   <span class="k">sizeof</span><span class="p">(</span><span class="n">args</span><span class="o">-&gt;</span><span class="n">auth_flavors</span><span class="p">[</span><span class="mi">0</span><span class="p">])))</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">c</span> <span class="o">=</span> <span class="n">strndup_user</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">hostname</span><span class="p">.</span><span class="n">data</span><span class="p">,</span> <span class="n">NFS4_MAXNAMLEN</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">c</span><span class="p">))</span>
			<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">c</span><span class="p">);</span>
		<span class="n">args</span><span class="o">-&gt;</span><span class="n">nfs_server</span><span class="p">.</span><span class="n">hostname</span> <span class="o">=</span> <span class="n">c</span><span class="p">;</span>

		<span class="n">c</span> <span class="o">=</span> <span class="n">strndup_user</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">mnt_path</span><span class="p">.</span><span class="n">data</span><span class="p">,</span> <span class="n">NFS4_MAXPATHLEN</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">c</span><span class="p">))</span>
			<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">c</span><span class="p">);</span>
		<span class="n">args</span><span class="o">-&gt;</span><span class="n">nfs_server</span><span class="p">.</span><span class="n">export_path</span> <span class="o">=</span> <span class="n">c</span><span class="p">;</span>
		<span class="n">dfprintk</span><span class="p">(</span><span class="n">MOUNT</span><span class="p">,</span> <span class="s">&quot;NFS: MNTPATH: &#39;%s&#39;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">c</span><span class="p">);</span>

		<span class="n">c</span> <span class="o">=</span> <span class="n">strndup_user</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">client_addr</span><span class="p">.</span><span class="n">data</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">c</span><span class="p">))</span>
			<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">c</span><span class="p">);</span>
		<span class="n">args</span><span class="o">-&gt;</span><span class="n">client_address</span> <span class="o">=</span> <span class="n">c</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * Translate to nfs_parsed_mount_data, which nfs4_fill_super</span>
<span class="cm">		 * can deal with.</span>
<span class="cm">		 */</span>

		<span class="n">args</span><span class="o">-&gt;</span><span class="n">flags</span>	<span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">NFS4_MOUNT_FLAGMASK</span><span class="p">;</span>
		<span class="n">args</span><span class="o">-&gt;</span><span class="n">rsize</span>	<span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">rsize</span><span class="p">;</span>
		<span class="n">args</span><span class="o">-&gt;</span><span class="n">wsize</span>	<span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">wsize</span><span class="p">;</span>
		<span class="n">args</span><span class="o">-&gt;</span><span class="n">timeo</span>	<span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">timeo</span><span class="p">;</span>
		<span class="n">args</span><span class="o">-&gt;</span><span class="n">retrans</span>	<span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">retrans</span><span class="p">;</span>
		<span class="n">args</span><span class="o">-&gt;</span><span class="n">acregmin</span>	<span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">acregmin</span><span class="p">;</span>
		<span class="n">args</span><span class="o">-&gt;</span><span class="n">acregmax</span>	<span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">acregmax</span><span class="p">;</span>
		<span class="n">args</span><span class="o">-&gt;</span><span class="n">acdirmin</span>	<span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">acdirmin</span><span class="p">;</span>
		<span class="n">args</span><span class="o">-&gt;</span><span class="n">acdirmax</span>	<span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">acdirmax</span><span class="p">;</span>
		<span class="n">args</span><span class="o">-&gt;</span><span class="n">nfs_server</span><span class="p">.</span><span class="n">protocol</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">proto</span><span class="p">;</span>
		<span class="n">nfs_validate_transport_protocol</span><span class="p">(</span><span class="n">args</span><span class="p">);</span>

		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="n">NFS_TEXT_DATA</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">out_no_data:</span>
	<span class="n">dfprintk</span><span class="p">(</span><span class="n">MOUNT</span><span class="p">,</span> <span class="s">&quot;NFS4: mount program didn&#39;t pass any mount data</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

<span class="nl">out_inval_auth:</span>
	<span class="n">dfprintk</span><span class="p">(</span><span class="n">MOUNT</span><span class="p">,</span> <span class="s">&quot;NFS4: Invalid number of RPC auth flavours %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">data</span><span class="o">-&gt;</span><span class="n">auth_flavourlen</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

<span class="nl">out_no_address:</span>
	<span class="n">dfprintk</span><span class="p">(</span><span class="n">MOUNT</span><span class="p">,</span> <span class="s">&quot;NFS4: mount program didn&#39;t pass remote address</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Get the superblock for the NFS4 root partition</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span>
<span class="nf">nfs4_remote_mount</span><span class="p">(</span><span class="k">struct</span> <span class="n">file_system_type</span> <span class="o">*</span><span class="n">fs_type</span><span class="p">,</span> <span class="kt">int</span> <span class="n">flags</span><span class="p">,</span>
		  <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">dev_name</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfs_mount_info</span> <span class="o">*</span><span class="n">mount_info</span> <span class="o">=</span> <span class="n">info</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nfs_server</span> <span class="o">*</span><span class="n">server</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="n">mntroot</span> <span class="o">=</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">ENOMEM</span><span class="p">);</span>

	<span class="n">mount_info</span><span class="o">-&gt;</span><span class="n">fill_super</span> <span class="o">=</span> <span class="n">nfs4_fill_super</span><span class="p">;</span>
	<span class="n">mount_info</span><span class="o">-&gt;</span><span class="n">set_security</span> <span class="o">=</span> <span class="n">nfs_set_sb_security</span><span class="p">;</span>

	<span class="cm">/* Get a volume representation */</span>
	<span class="n">server</span> <span class="o">=</span> <span class="n">nfs4_create_server</span><span class="p">(</span><span class="n">mount_info</span><span class="o">-&gt;</span><span class="n">parsed</span><span class="p">,</span> <span class="n">mount_info</span><span class="o">-&gt;</span><span class="n">mntfh</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">server</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">mntroot</span> <span class="o">=</span> <span class="n">ERR_CAST</span><span class="p">(</span><span class="n">server</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mntroot</span> <span class="o">=</span> <span class="n">nfs_fs_mount_common</span><span class="p">(</span><span class="n">fs_type</span><span class="p">,</span> <span class="n">server</span><span class="p">,</span> <span class="n">flags</span><span class="p">,</span> <span class="n">dev_name</span><span class="p">,</span> <span class="n">mount_info</span><span class="p">);</span>

<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">mntroot</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">vfsmount</span> <span class="o">*</span><span class="nf">nfs_do_root_mount</span><span class="p">(</span><span class="k">struct</span> <span class="n">file_system_type</span> <span class="o">*</span><span class="n">fs_type</span><span class="p">,</span>
		<span class="kt">int</span> <span class="n">flags</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">hostname</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">vfsmount</span> <span class="o">*</span><span class="n">root_mnt</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">root_devname</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">len</span><span class="p">;</span>

	<span class="n">len</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">hostname</span><span class="p">)</span> <span class="o">+</span> <span class="mi">5</span><span class="p">;</span>
	<span class="n">root_devname</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">len</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">root_devname</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">ENOMEM</span><span class="p">);</span>
	<span class="cm">/* Does hostname needs to be enclosed in brackets? */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">strchr</span><span class="p">(</span><span class="n">hostname</span><span class="p">,</span> <span class="sc">&#39;:&#39;</span><span class="p">))</span>
		<span class="n">snprintf</span><span class="p">(</span><span class="n">root_devname</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="s">&quot;[%s]:/&quot;</span><span class="p">,</span> <span class="n">hostname</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">snprintf</span><span class="p">(</span><span class="n">root_devname</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="s">&quot;%s:/&quot;</span><span class="p">,</span> <span class="n">hostname</span><span class="p">);</span>
	<span class="n">root_mnt</span> <span class="o">=</span> <span class="n">vfs_kern_mount</span><span class="p">(</span><span class="n">fs_type</span><span class="p">,</span> <span class="n">flags</span><span class="p">,</span> <span class="n">root_devname</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">root_devname</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">root_mnt</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">nfs_referral_count</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="n">list</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">task_struct</span> <span class="o">*</span><span class="n">task</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">referral_count</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="n">LIST_HEAD</span><span class="p">(</span><span class="n">nfs_referral_count_list</span><span class="p">);</span>
<span class="k">static</span> <span class="n">DEFINE_SPINLOCK</span><span class="p">(</span><span class="n">nfs_referral_count_list_lock</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">nfs_referral_count</span> <span class="o">*</span><span class="nf">nfs_find_referral_count</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfs_referral_count</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">nfs_referral_count_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">task</span> <span class="o">==</span> <span class="n">current</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">p</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define NFS_MAX_NESTED_REFERRALS 2</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">nfs_referral_loop_protect</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfs_referral_count</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="o">*</span><span class="n">new</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">new</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">new</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">new</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="n">new</span><span class="o">-&gt;</span><span class="n">task</span> <span class="o">=</span> <span class="n">current</span><span class="p">;</span>
	<span class="n">new</span><span class="o">-&gt;</span><span class="n">referral_count</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nfs_referral_count_list_lock</span><span class="p">);</span>
	<span class="n">p</span> <span class="o">=</span> <span class="n">nfs_find_referral_count</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">p</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">referral_count</span> <span class="o">&gt;=</span> <span class="n">NFS_MAX_NESTED_REFERRALS</span><span class="p">)</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ELOOP</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">p</span><span class="o">-&gt;</span><span class="n">referral_count</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">list_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">new</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">nfs_referral_count_list</span><span class="p">);</span>
		<span class="n">new</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nfs_referral_count_list_lock</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">new</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">nfs_referral_loop_unprotect</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfs_referral_count</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nfs_referral_count_list_lock</span><span class="p">);</span>
	<span class="n">p</span> <span class="o">=</span> <span class="n">nfs_find_referral_count</span><span class="p">();</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">referral_count</span><span class="o">--</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">referral_count</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">p</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nfs_referral_count_list_lock</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="nf">nfs_follow_remote_path</span><span class="p">(</span><span class="k">struct</span> <span class="n">vfsmount</span> <span class="o">*</span><span class="n">root_mnt</span><span class="p">,</span>
		<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">export_path</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="n">dentry</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">root_mnt</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">ERR_CAST</span><span class="p">(</span><span class="n">root_mnt</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">nfs_referral_loop_protect</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mntput</span><span class="p">(</span><span class="n">root_mnt</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="n">err</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">dentry</span> <span class="o">=</span> <span class="n">mount_subtree</span><span class="p">(</span><span class="n">root_mnt</span><span class="p">,</span> <span class="n">export_path</span><span class="p">);</span>
	<span class="n">nfs_referral_loop_unprotect</span><span class="p">();</span>

	<span class="k">return</span> <span class="n">dentry</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="nf">nfs4_try_mount</span><span class="p">(</span><span class="kt">int</span> <span class="n">flags</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">dev_name</span><span class="p">,</span>
			 <span class="k">struct</span> <span class="n">nfs_mount_info</span> <span class="o">*</span><span class="n">mount_info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">export_path</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">vfsmount</span> <span class="o">*</span><span class="n">root_mnt</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="n">res</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nfs_parsed_mount_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">mount_info</span><span class="o">-&gt;</span><span class="n">parsed</span><span class="p">;</span>

	<span class="n">dfprintk</span><span class="p">(</span><span class="n">MOUNT</span><span class="p">,</span> <span class="s">&quot;--&gt; nfs4_try_mount()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">export_path</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">nfs_server</span><span class="p">.</span><span class="n">export_path</span><span class="p">;</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">nfs_server</span><span class="p">.</span><span class="n">export_path</span> <span class="o">=</span> <span class="s">&quot;/&quot;</span><span class="p">;</span>
	<span class="n">root_mnt</span> <span class="o">=</span> <span class="n">nfs_do_root_mount</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nfs4_remote_fs_type</span><span class="p">,</span> <span class="n">flags</span><span class="p">,</span> <span class="n">mount_info</span><span class="p">,</span>
			<span class="n">data</span><span class="o">-&gt;</span><span class="n">nfs_server</span><span class="p">.</span><span class="n">hostname</span><span class="p">);</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">nfs_server</span><span class="p">.</span><span class="n">export_path</span> <span class="o">=</span> <span class="n">export_path</span><span class="p">;</span>

	<span class="n">res</span> <span class="o">=</span> <span class="n">nfs_follow_remote_path</span><span class="p">(</span><span class="n">root_mnt</span><span class="p">,</span> <span class="n">export_path</span><span class="p">);</span>

	<span class="n">dfprintk</span><span class="p">(</span><span class="n">MOUNT</span><span class="p">,</span> <span class="s">&quot;&lt;-- nfs4_try_mount() = %ld%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">IS_ERR</span><span class="p">(</span><span class="n">res</span><span class="p">)</span> <span class="o">?</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">res</span><span class="p">)</span> <span class="o">:</span> <span class="mi">0</span><span class="p">,</span>
			<span class="n">IS_ERR</span><span class="p">(</span><span class="n">res</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot; [error]&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">nfs4_kill_super</span><span class="p">(</span><span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">sb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfs_server</span> <span class="o">*</span><span class="n">server</span> <span class="o">=</span> <span class="n">NFS_SB</span><span class="p">(</span><span class="n">sb</span><span class="p">);</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;--&gt; %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="n">nfs_super_return_all_delegations</span><span class="p">(</span><span class="n">sb</span><span class="p">);</span>
	<span class="n">kill_anon_super</span><span class="p">(</span><span class="n">sb</span><span class="p">);</span>
	<span class="n">nfs_fscache_release_super_cookie</span><span class="p">(</span><span class="n">sb</span><span class="p">);</span>
	<span class="n">nfs_free_server</span><span class="p">(</span><span class="n">server</span><span class="p">);</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;&lt;-- %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Clone an NFS4 server record on xdev traversal (FSID-change)</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span>
<span class="nf">nfs4_xdev_mount</span><span class="p">(</span><span class="k">struct</span> <span class="n">file_system_type</span> <span class="o">*</span><span class="n">fs_type</span><span class="p">,</span> <span class="kt">int</span> <span class="n">flags</span><span class="p">,</span>
		 <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">dev_name</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">raw_data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfs_mount_info</span> <span class="n">mount_info</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">fill_super</span> <span class="o">=</span> <span class="n">nfs4_clone_super</span><span class="p">,</span>
		<span class="p">.</span><span class="n">set_security</span> <span class="o">=</span> <span class="n">nfs_clone_sb_security</span><span class="p">,</span>
		<span class="p">.</span><span class="n">cloned</span> <span class="o">=</span> <span class="n">raw_data</span><span class="p">,</span>
	<span class="p">};</span>
	<span class="k">return</span> <span class="n">nfs_xdev_mount_common</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nfs4_fs_type</span><span class="p">,</span> <span class="n">flags</span><span class="p">,</span> <span class="n">dev_name</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mount_info</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span>
<span class="nf">nfs4_remote_referral_mount</span><span class="p">(</span><span class="k">struct</span> <span class="n">file_system_type</span> <span class="o">*</span><span class="n">fs_type</span><span class="p">,</span> <span class="kt">int</span> <span class="n">flags</span><span class="p">,</span>
			   <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">dev_name</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">raw_data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfs_mount_info</span> <span class="n">mount_info</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">fill_super</span> <span class="o">=</span> <span class="n">nfs4_fill_super</span><span class="p">,</span>
		<span class="p">.</span><span class="n">set_security</span> <span class="o">=</span> <span class="n">nfs_clone_sb_security</span><span class="p">,</span>
		<span class="p">.</span><span class="n">cloned</span> <span class="o">=</span> <span class="n">raw_data</span><span class="p">,</span>
	<span class="p">};</span>
	<span class="k">struct</span> <span class="n">nfs_server</span> <span class="o">*</span><span class="n">server</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="n">mntroot</span> <span class="o">=</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">ENOMEM</span><span class="p">);</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;--&gt; nfs4_referral_get_sb()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">mount_info</span><span class="p">.</span><span class="n">mntfh</span> <span class="o">=</span> <span class="n">nfs_alloc_fhandle</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mount_info</span><span class="p">.</span><span class="n">cloned</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span> <span class="n">mount_info</span><span class="p">.</span><span class="n">mntfh</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="cm">/* create a new volume representation */</span>
	<span class="n">server</span> <span class="o">=</span> <span class="n">nfs4_create_referral_server</span><span class="p">(</span><span class="n">mount_info</span><span class="p">.</span><span class="n">cloned</span><span class="p">,</span> <span class="n">mount_info</span><span class="p">.</span><span class="n">mntfh</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">server</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">mntroot</span> <span class="o">=</span> <span class="n">ERR_CAST</span><span class="p">(</span><span class="n">server</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mntroot</span> <span class="o">=</span> <span class="n">nfs_fs_mount_common</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nfs4_fs_type</span><span class="p">,</span> <span class="n">server</span><span class="p">,</span> <span class="n">flags</span><span class="p">,</span> <span class="n">dev_name</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mount_info</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="n">nfs_free_fhandle</span><span class="p">(</span><span class="n">mount_info</span><span class="p">.</span><span class="n">mntfh</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">mntroot</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Create an NFS4 server record on referral traversal</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="nf">nfs4_referral_mount</span><span class="p">(</span><span class="k">struct</span> <span class="n">file_system_type</span> <span class="o">*</span><span class="n">fs_type</span><span class="p">,</span>
		<span class="kt">int</span> <span class="n">flags</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">dev_name</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">raw_data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nfs_clone_mount</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">raw_data</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">export_path</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">vfsmount</span> <span class="o">*</span><span class="n">root_mnt</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="n">res</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;--&gt; nfs4_referral_mount()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">export_path</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">mnt_path</span><span class="p">;</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">mnt_path</span> <span class="o">=</span> <span class="s">&quot;/&quot;</span><span class="p">;</span>

	<span class="n">root_mnt</span> <span class="o">=</span> <span class="n">nfs_do_root_mount</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nfs4_remote_referral_fs_type</span><span class="p">,</span>
			<span class="n">flags</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">hostname</span><span class="p">);</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">mnt_path</span> <span class="o">=</span> <span class="n">export_path</span><span class="p">;</span>

	<span class="n">res</span> <span class="o">=</span> <span class="n">nfs_follow_remote_path</span><span class="p">(</span><span class="n">root_mnt</span><span class="p">,</span> <span class="n">export_path</span><span class="p">);</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;&lt;-- nfs4_referral_mount() = %ld%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">IS_ERR</span><span class="p">(</span><span class="n">res</span><span class="p">)</span> <span class="o">?</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">res</span><span class="p">)</span> <span class="o">:</span> <span class="mi">0</span><span class="p">,</span>
			<span class="n">IS_ERR</span><span class="p">(</span><span class="n">res</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot; [error]&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#endif </span><span class="cm">/* CONFIG_NFS_V4 */</span><span class="cp"></span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
