<!DOCTYPE html>
<html><head><title>joekychen/linux » fs › ufs › super.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>super.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> *  linux/fs/ufs/super.c</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 1998</span>
<span class="cm"> * Daniel Pirkl &lt;daniel.pirkl@email.cz&gt;</span>
<span class="cm"> * Charles University, Faculty of Mathematics and Physics</span>
<span class="cm"> */</span>

<span class="cm">/* Derived from</span>
<span class="cm"> *</span>
<span class="cm"> *  linux/fs/ext2/super.c</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 1992, 1993, 1994, 1995</span>
<span class="cm"> * Remy Card (card@masi.ibp.fr)</span>
<span class="cm"> * Laboratoire MASI - Institut Blaise Pascal</span>
<span class="cm"> * Universite Pierre et Marie Curie (Paris VI)</span>
<span class="cm"> *</span>
<span class="cm"> *  from</span>
<span class="cm"> *</span>
<span class="cm"> *  linux/fs/minix/inode.c</span>
<span class="cm"> *</span>
<span class="cm"> *  Copyright (C) 1991, 1992  Linus Torvalds</span>
<span class="cm"> *</span>
<span class="cm"> *  Big-endian to little-endian byte-swapping/bitmaps by</span>
<span class="cm"> *        David S. Miller (davem@caip.rutgers.edu), 1995</span>
<span class="cm"> */</span>
 
<span class="cm">/*</span>
<span class="cm"> * Inspired by</span>
<span class="cm"> *</span>
<span class="cm"> *  linux/fs/ufs/super.c</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 1996</span>
<span class="cm"> * Adrian Rodriguez (adrian@franklins-tower.rutgers.edu)</span>
<span class="cm"> * Laboratory for Computer Science Research Computing Facility</span>
<span class="cm"> * Rutgers, The State University of New Jersey</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 1996  Eddie C. Dost  (ecd@skynet.be)</span>
<span class="cm"> *</span>
<span class="cm"> * Kernel module support added on 96/04/26 by</span>
<span class="cm"> * Stefan Reinauer &lt;stepan@home.culture.mipt.ru&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * Module usage counts added on 96/04/29 by</span>
<span class="cm"> * Gertjan van Wingerde &lt;gwingerde@gmail.com&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * Clean swab support on 19970406 by</span>
<span class="cm"> * Francois-Rene Rideau &lt;fare@tunes.org&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * 4.4BSD (FreeBSD) support added on February 1st 1998 by</span>
<span class="cm"> * Niels Kristian Bech Jensen &lt;nkbj@image.dk&gt; partially based</span>
<span class="cm"> * on code by Martin von Loewis &lt;martin@mira.isdn.cs.tu-berlin.de&gt;.</span>
<span class="cm"> *</span>
<span class="cm"> * NeXTstep support added on February 5th 1998 by</span>
<span class="cm"> * Niels Kristian Bech Jensen &lt;nkbj@image.dk&gt;.</span>
<span class="cm"> *</span>
<span class="cm"> * write support Daniel Pirkl &lt;daniel.pirkl@email.cz&gt; 1998</span>
<span class="cm"> * </span>
<span class="cm"> * HP/UX hfs filesystem support added by</span>
<span class="cm"> * Martin K. Petersen &lt;mkp@mkp.net&gt;, August 1999</span>
<span class="cm"> *</span>
<span class="cm"> * UFS2 (of FreeBSD 5.x) support added by</span>
<span class="cm"> * Niraj Kumar &lt;niraj17@iitbombay.org&gt;, Jan 2004</span>
<span class="cm"> *</span>
<span class="cm"> * UFS2 write support added by</span>
<span class="cm"> * Evgeniy Dushistov &lt;dushistov@mail.ru&gt;, 2007</span>
<span class="cm"> */</span>


<span class="cp">#include &lt;linux/exportfs.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/bitops.h&gt;</span>

<span class="cp">#include &lt;stdarg.h&gt;</span>

<span class="cp">#include &lt;asm/uaccess.h&gt;</span>

<span class="cp">#include &lt;linux/errno.h&gt;</span>
<span class="cp">#include &lt;linux/fs.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/time.h&gt;</span>
<span class="cp">#include &lt;linux/stat.h&gt;</span>
<span class="cp">#include &lt;linux/string.h&gt;</span>
<span class="cp">#include &lt;linux/blkdev.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/parser.h&gt;</span>
<span class="cp">#include &lt;linux/buffer_head.h&gt;</span>
<span class="cp">#include &lt;linux/vfs.h&gt;</span>
<span class="cp">#include &lt;linux/log2.h&gt;</span>
<span class="cp">#include &lt;linux/mount.h&gt;</span>
<span class="cp">#include &lt;linux/seq_file.h&gt;</span>

<span class="cp">#include &quot;ufs_fs.h&quot;</span>
<span class="cp">#include &quot;ufs.h&quot;</span>
<span class="cp">#include &quot;swab.h&quot;</span>
<span class="cp">#include &quot;util.h&quot;</span>

<span class="kt">void</span> <span class="nf">lock_ufs</span><span class="p">(</span><span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">sb</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#if defined(CONFIG_SMP) || defined (CONFIG_PREEMPT)</span>
	<span class="k">struct</span> <span class="n">ufs_sb_info</span> <span class="o">*</span><span class="n">sbi</span> <span class="o">=</span> <span class="n">UFS_SB</span><span class="p">(</span><span class="n">sb</span><span class="p">);</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="n">sbi</span><span class="o">-&gt;</span><span class="n">mutex_owner</span> <span class="o">=</span> <span class="n">current</span><span class="p">;</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">unlock_ufs</span><span class="p">(</span><span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">sb</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#if defined(CONFIG_SMP) || defined (CONFIG_PREEMPT)</span>
	<span class="k">struct</span> <span class="n">ufs_sb_info</span> <span class="o">*</span><span class="n">sbi</span> <span class="o">=</span> <span class="n">UFS_SB</span><span class="p">(</span><span class="n">sb</span><span class="p">);</span>

	<span class="n">sbi</span><span class="o">-&gt;</span><span class="n">mutex_owner</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="nf">ufs_nfs_get_inode</span><span class="p">(</span><span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">sb</span><span class="p">,</span> <span class="n">u64</span> <span class="n">ino</span><span class="p">,</span> <span class="n">u32</span> <span class="n">generation</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ufs_sb_private_info</span> <span class="o">*</span><span class="n">uspi</span> <span class="o">=</span> <span class="n">UFS_SB</span><span class="p">(</span><span class="n">sb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">s_uspi</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ino</span> <span class="o">&lt;</span> <span class="n">UFS_ROOTINO</span> <span class="o">||</span> <span class="n">ino</span> <span class="o">&gt;</span> <span class="n">uspi</span><span class="o">-&gt;</span><span class="n">s_ncg</span> <span class="o">*</span> <span class="n">uspi</span><span class="o">-&gt;</span><span class="n">s_ipg</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">ESTALE</span><span class="p">);</span>

	<span class="n">inode</span> <span class="o">=</span> <span class="n">ufs_iget</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">ino</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">inode</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">ERR_CAST</span><span class="p">(</span><span class="n">inode</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">generation</span> <span class="o">&amp;&amp;</span> <span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_generation</span> <span class="o">!=</span> <span class="n">generation</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">iput</span><span class="p">(</span><span class="n">inode</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">ESTALE</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">inode</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="nf">ufs_fh_to_dentry</span><span class="p">(</span><span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">sb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fid</span> <span class="o">*</span><span class="n">fid</span><span class="p">,</span>
				       <span class="kt">int</span> <span class="n">fh_len</span><span class="p">,</span> <span class="kt">int</span> <span class="n">fh_type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">generic_fh_to_dentry</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">fid</span><span class="p">,</span> <span class="n">fh_len</span><span class="p">,</span> <span class="n">fh_type</span><span class="p">,</span> <span class="n">ufs_nfs_get_inode</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="nf">ufs_fh_to_parent</span><span class="p">(</span><span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">sb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fid</span> <span class="o">*</span><span class="n">fid</span><span class="p">,</span>
				       <span class="kt">int</span> <span class="n">fh_len</span><span class="p">,</span> <span class="kt">int</span> <span class="n">fh_type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">generic_fh_to_parent</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">fid</span><span class="p">,</span> <span class="n">fh_len</span><span class="p">,</span> <span class="n">fh_type</span><span class="p">,</span> <span class="n">ufs_nfs_get_inode</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="nf">ufs_get_parent</span><span class="p">(</span><span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="n">child</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qstr</span> <span class="n">dot_dot</span> <span class="o">=</span> <span class="n">QSTR_INIT</span><span class="p">(</span><span class="s">&quot;..&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
	<span class="n">ino_t</span> <span class="n">ino</span><span class="p">;</span>

	<span class="n">ino</span> <span class="o">=</span> <span class="n">ufs_inode_by_name</span><span class="p">(</span><span class="n">child</span><span class="o">-&gt;</span><span class="n">d_inode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dot_dot</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ino</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">ENOENT</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">d_obtain_alias</span><span class="p">(</span><span class="n">ufs_iget</span><span class="p">(</span><span class="n">child</span><span class="o">-&gt;</span><span class="n">d_inode</span><span class="o">-&gt;</span><span class="n">i_sb</span><span class="p">,</span> <span class="n">ino</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">export_operations</span> <span class="n">ufs_export_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">fh_to_dentry</span>	<span class="o">=</span> <span class="n">ufs_fh_to_dentry</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fh_to_parent</span>	<span class="o">=</span> <span class="n">ufs_fh_to_parent</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_parent</span>	<span class="o">=</span> <span class="n">ufs_get_parent</span><span class="p">,</span>
<span class="p">};</span>

<span class="cp">#ifdef CONFIG_UFS_DEBUG</span>
<span class="cm">/*</span>
<span class="cm"> * Print contents of ufs_super_block, useful for debugging</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ufs_print_super_stuff</span><span class="p">(</span><span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">sb</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">ufs_super_block_first</span> <span class="o">*</span><span class="n">usb1</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">ufs_super_block_second</span> <span class="o">*</span><span class="n">usb2</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">ufs_super_block_third</span> <span class="o">*</span><span class="n">usb3</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">magic</span> <span class="o">=</span> <span class="n">fs32_to_cpu</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">usb3</span><span class="o">-&gt;</span><span class="n">fs_magic</span><span class="p">);</span>

	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;ufs_print_super_stuff</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;  magic:     0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">magic</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fs32_to_cpu</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">usb3</span><span class="o">-&gt;</span><span class="n">fs_magic</span><span class="p">)</span> <span class="o">==</span> <span class="n">UFS2_MAGIC</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;  fs_size:   %llu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span>
		       <span class="n">fs64_to_cpu</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">usb3</span><span class="o">-&gt;</span><span class="n">fs_un1</span><span class="p">.</span><span class="n">fs_u2</span><span class="p">.</span><span class="n">fs_size</span><span class="p">));</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;  fs_dsize:  %llu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span>
		       <span class="n">fs64_to_cpu</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">usb3</span><span class="o">-&gt;</span><span class="n">fs_un1</span><span class="p">.</span><span class="n">fs_u2</span><span class="p">.</span><span class="n">fs_dsize</span><span class="p">));</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;  bsize:         %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">fs32_to_cpu</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">usb1</span><span class="o">-&gt;</span><span class="n">fs_bsize</span><span class="p">));</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;  fsize:         %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">fs32_to_cpu</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">usb1</span><span class="o">-&gt;</span><span class="n">fs_fsize</span><span class="p">));</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;  fs_volname:  %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">usb2</span><span class="o">-&gt;</span><span class="n">fs_un</span><span class="p">.</span><span class="n">fs_u2</span><span class="p">.</span><span class="n">fs_volname</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;  fs_sblockloc: %llu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span>
		       <span class="n">fs64_to_cpu</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">usb2</span><span class="o">-&gt;</span><span class="n">fs_un</span><span class="p">.</span><span class="n">fs_u2</span><span class="p">.</span><span class="n">fs_sblockloc</span><span class="p">));</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;  cs_ndir(No of dirs):  %llu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span>
		       <span class="n">fs64_to_cpu</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">usb2</span><span class="o">-&gt;</span><span class="n">fs_un</span><span class="p">.</span><span class="n">fs_u2</span><span class="p">.</span><span class="n">cs_ndir</span><span class="p">));</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;  cs_nbfree(No of free blocks):  %llu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span>
		       <span class="n">fs64_to_cpu</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">usb2</span><span class="o">-&gt;</span><span class="n">fs_un</span><span class="p">.</span><span class="n">fs_u2</span><span class="p">.</span><span class="n">cs_nbfree</span><span class="p">));</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="s">&quot;  cs_nifree(Num of free inodes): %llu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span>
		       <span class="n">fs64_to_cpu</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">usb3</span><span class="o">-&gt;</span><span class="n">fs_un1</span><span class="p">.</span><span class="n">fs_u2</span><span class="p">.</span><span class="n">cs_nifree</span><span class="p">));</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="s">&quot;  cs_nffree(Num of free frags): %llu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span>
		       <span class="n">fs64_to_cpu</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">usb3</span><span class="o">-&gt;</span><span class="n">fs_un1</span><span class="p">.</span><span class="n">fs_u2</span><span class="p">.</span><span class="n">cs_nffree</span><span class="p">));</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="s">&quot;  fs_maxsymlinklen: %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">fs32_to_cpu</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">usb3</span><span class="o">-&gt;</span><span class="n">fs_un2</span><span class="p">.</span><span class="n">fs_44</span><span class="p">.</span><span class="n">fs_maxsymlinklen</span><span class="p">));</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot; sblkno:      %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">fs32_to_cpu</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">usb1</span><span class="o">-&gt;</span><span class="n">fs_sblkno</span><span class="p">));</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot; cblkno:      %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">fs32_to_cpu</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">usb1</span><span class="o">-&gt;</span><span class="n">fs_cblkno</span><span class="p">));</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot; iblkno:      %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">fs32_to_cpu</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">usb1</span><span class="o">-&gt;</span><span class="n">fs_iblkno</span><span class="p">));</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot; dblkno:      %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">fs32_to_cpu</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">usb1</span><span class="o">-&gt;</span><span class="n">fs_dblkno</span><span class="p">));</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot; cgoffset:    %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">fs32_to_cpu</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">usb1</span><span class="o">-&gt;</span><span class="n">fs_cgoffset</span><span class="p">));</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot; ~cgmask:     0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="o">~</span><span class="n">fs32_to_cpu</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">usb1</span><span class="o">-&gt;</span><span class="n">fs_cgmask</span><span class="p">));</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot; size:        %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">fs32_to_cpu</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">usb1</span><span class="o">-&gt;</span><span class="n">fs_size</span><span class="p">));</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot; dsize:       %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">fs32_to_cpu</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">usb1</span><span class="o">-&gt;</span><span class="n">fs_dsize</span><span class="p">));</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot; ncg:         %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">fs32_to_cpu</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">usb1</span><span class="o">-&gt;</span><span class="n">fs_ncg</span><span class="p">));</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot; bsize:       %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">fs32_to_cpu</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">usb1</span><span class="o">-&gt;</span><span class="n">fs_bsize</span><span class="p">));</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot; fsize:       %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">fs32_to_cpu</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">usb1</span><span class="o">-&gt;</span><span class="n">fs_fsize</span><span class="p">));</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot; frag:        %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">fs32_to_cpu</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">usb1</span><span class="o">-&gt;</span><span class="n">fs_frag</span><span class="p">));</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot; fragshift:   %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">fs32_to_cpu</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">usb1</span><span class="o">-&gt;</span><span class="n">fs_fragshift</span><span class="p">));</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot; ~fmask:      %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="o">~</span><span class="n">fs32_to_cpu</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">usb1</span><span class="o">-&gt;</span><span class="n">fs_fmask</span><span class="p">));</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot; fshift:      %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">fs32_to_cpu</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">usb1</span><span class="o">-&gt;</span><span class="n">fs_fshift</span><span class="p">));</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot; sbsize:      %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">fs32_to_cpu</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">usb1</span><span class="o">-&gt;</span><span class="n">fs_sbsize</span><span class="p">));</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot; spc:         %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">fs32_to_cpu</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">usb1</span><span class="o">-&gt;</span><span class="n">fs_spc</span><span class="p">));</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot; cpg:         %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">fs32_to_cpu</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">usb1</span><span class="o">-&gt;</span><span class="n">fs_cpg</span><span class="p">));</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot; ipg:         %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">fs32_to_cpu</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">usb1</span><span class="o">-&gt;</span><span class="n">fs_ipg</span><span class="p">));</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot; fpg:         %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">fs32_to_cpu</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">usb1</span><span class="o">-&gt;</span><span class="n">fs_fpg</span><span class="p">));</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot; csaddr:      %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">fs32_to_cpu</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">usb1</span><span class="o">-&gt;</span><span class="n">fs_csaddr</span><span class="p">));</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot; cssize:      %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">fs32_to_cpu</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">usb1</span><span class="o">-&gt;</span><span class="n">fs_cssize</span><span class="p">));</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot; cgsize:      %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">fs32_to_cpu</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">usb1</span><span class="o">-&gt;</span><span class="n">fs_cgsize</span><span class="p">));</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot; fstodb:      %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">fs32_to_cpu</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">usb1</span><span class="o">-&gt;</span><span class="n">fs_fsbtodb</span><span class="p">));</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot; nrpos:       %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">fs32_to_cpu</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">usb3</span><span class="o">-&gt;</span><span class="n">fs_nrpos</span><span class="p">));</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot; ndir         %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">fs32_to_cpu</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">usb1</span><span class="o">-&gt;</span><span class="n">fs_cstotal</span><span class="p">.</span><span class="n">cs_ndir</span><span class="p">));</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot; nifree       %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">fs32_to_cpu</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">usb1</span><span class="o">-&gt;</span><span class="n">fs_cstotal</span><span class="p">.</span><span class="n">cs_nifree</span><span class="p">));</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot; nbfree       %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">fs32_to_cpu</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">usb1</span><span class="o">-&gt;</span><span class="n">fs_cstotal</span><span class="p">.</span><span class="n">cs_nbfree</span><span class="p">));</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot; nffree       %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">fs32_to_cpu</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">usb1</span><span class="o">-&gt;</span><span class="n">fs_cstotal</span><span class="p">.</span><span class="n">cs_nffree</span><span class="p">));</span>
	<span class="p">}</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Print contents of ufs_cylinder_group, useful for debugging</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ufs_print_cylinder_stuff</span><span class="p">(</span><span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">sb</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">ufs_cylinder_group</span> <span class="o">*</span><span class="n">cg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">ufs_print_cylinder_stuff</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;size of ucg: %zu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ufs_cylinder_group</span><span class="p">));</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;  magic:        %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">fs32_to_cpu</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">cg</span><span class="o">-&gt;</span><span class="n">cg_magic</span><span class="p">));</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;  time:         %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">fs32_to_cpu</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">cg</span><span class="o">-&gt;</span><span class="n">cg_time</span><span class="p">));</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;  cgx:          %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">fs32_to_cpu</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">cg</span><span class="o">-&gt;</span><span class="n">cg_cgx</span><span class="p">));</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;  ncyl:         %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">fs16_to_cpu</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">cg</span><span class="o">-&gt;</span><span class="n">cg_ncyl</span><span class="p">));</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;  niblk:        %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">fs16_to_cpu</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">cg</span><span class="o">-&gt;</span><span class="n">cg_niblk</span><span class="p">));</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;  ndblk:        %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">fs32_to_cpu</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">cg</span><span class="o">-&gt;</span><span class="n">cg_ndblk</span><span class="p">));</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;  cs_ndir:      %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">fs32_to_cpu</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">cg</span><span class="o">-&gt;</span><span class="n">cg_cs</span><span class="p">.</span><span class="n">cs_ndir</span><span class="p">));</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;  cs_nbfree:    %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">fs32_to_cpu</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">cg</span><span class="o">-&gt;</span><span class="n">cg_cs</span><span class="p">.</span><span class="n">cs_nbfree</span><span class="p">));</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;  cs_nifree:    %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">fs32_to_cpu</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">cg</span><span class="o">-&gt;</span><span class="n">cg_cs</span><span class="p">.</span><span class="n">cs_nifree</span><span class="p">));</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;  cs_nffree:    %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">fs32_to_cpu</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">cg</span><span class="o">-&gt;</span><span class="n">cg_cs</span><span class="p">.</span><span class="n">cs_nffree</span><span class="p">));</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;  rotor:        %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">fs32_to_cpu</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">cg</span><span class="o">-&gt;</span><span class="n">cg_rotor</span><span class="p">));</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;  frotor:       %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">fs32_to_cpu</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">cg</span><span class="o">-&gt;</span><span class="n">cg_frotor</span><span class="p">));</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;  irotor:       %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">fs32_to_cpu</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">cg</span><span class="o">-&gt;</span><span class="n">cg_irotor</span><span class="p">));</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;  frsum:        %u, %u, %u, %u, %u, %u, %u, %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	    <span class="n">fs32_to_cpu</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">cg</span><span class="o">-&gt;</span><span class="n">cg_frsum</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">fs32_to_cpu</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">cg</span><span class="o">-&gt;</span><span class="n">cg_frsum</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span>
	    <span class="n">fs32_to_cpu</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">cg</span><span class="o">-&gt;</span><span class="n">cg_frsum</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span> <span class="n">fs32_to_cpu</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">cg</span><span class="o">-&gt;</span><span class="n">cg_frsum</span><span class="p">[</span><span class="mi">3</span><span class="p">]),</span>
	    <span class="n">fs32_to_cpu</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">cg</span><span class="o">-&gt;</span><span class="n">cg_frsum</span><span class="p">[</span><span class="mi">4</span><span class="p">]),</span> <span class="n">fs32_to_cpu</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">cg</span><span class="o">-&gt;</span><span class="n">cg_frsum</span><span class="p">[</span><span class="mi">5</span><span class="p">]),</span>
	    <span class="n">fs32_to_cpu</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">cg</span><span class="o">-&gt;</span><span class="n">cg_frsum</span><span class="p">[</span><span class="mi">6</span><span class="p">]),</span> <span class="n">fs32_to_cpu</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">cg</span><span class="o">-&gt;</span><span class="n">cg_frsum</span><span class="p">[</span><span class="mi">7</span><span class="p">]));</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;  btotoff:      %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">fs32_to_cpu</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">cg</span><span class="o">-&gt;</span><span class="n">cg_btotoff</span><span class="p">));</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;  boff:         %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">fs32_to_cpu</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">cg</span><span class="o">-&gt;</span><span class="n">cg_boff</span><span class="p">));</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;  iuseoff:      %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">fs32_to_cpu</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">cg</span><span class="o">-&gt;</span><span class="n">cg_iusedoff</span><span class="p">));</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;  freeoff:      %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">fs32_to_cpu</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">cg</span><span class="o">-&gt;</span><span class="n">cg_freeoff</span><span class="p">));</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;  nextfreeoff:  %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">fs32_to_cpu</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">cg</span><span class="o">-&gt;</span><span class="n">cg_nextfreeoff</span><span class="p">));</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;  clustersumoff %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">fs32_to_cpu</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">cg</span><span class="o">-&gt;</span><span class="n">cg_u</span><span class="p">.</span><span class="n">cg_44</span><span class="p">.</span><span class="n">cg_clustersumoff</span><span class="p">));</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;  clusteroff    %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">fs32_to_cpu</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">cg</span><span class="o">-&gt;</span><span class="n">cg_u</span><span class="p">.</span><span class="n">cg_44</span><span class="p">.</span><span class="n">cg_clusteroff</span><span class="p">));</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;  nclusterblks  %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">fs32_to_cpu</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">cg</span><span class="o">-&gt;</span><span class="n">cg_u</span><span class="p">.</span><span class="n">cg_44</span><span class="p">.</span><span class="n">cg_nclusterblks</span><span class="p">));</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#else</span>
<span class="cp">#  define ufs_print_super_stuff(sb, usb1, usb2, usb3) </span><span class="cm">/**/</span><span class="cp"></span>
<span class="cp">#  define ufs_print_cylinder_stuff(sb, cg) </span><span class="cm">/**/</span><span class="cp"></span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_UFS_DEBUG */</span><span class="cp"></span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">super_operations</span> <span class="n">ufs_super_ops</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">char</span> <span class="n">error_buf</span><span class="p">[</span><span class="mi">1024</span><span class="p">];</span>

<span class="kt">void</span> <span class="nf">ufs_error</span> <span class="p">(</span><span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span> <span class="n">sb</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span> <span class="n">function</span><span class="p">,</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span> <span class="n">fmt</span><span class="p">,</span> <span class="p">...)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ufs_sb_private_info</span> <span class="o">*</span> <span class="n">uspi</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ufs_super_block_first</span> <span class="o">*</span> <span class="n">usb1</span><span class="p">;</span>
	<span class="kt">va_list</span> <span class="n">args</span><span class="p">;</span>

	<span class="n">uspi</span> <span class="o">=</span> <span class="n">UFS_SB</span><span class="p">(</span><span class="n">sb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">s_uspi</span><span class="p">;</span>
	<span class="n">usb1</span> <span class="o">=</span> <span class="n">ubh_get_usb_first</span><span class="p">(</span><span class="n">uspi</span><span class="p">);</span>
	
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_flags</span> <span class="o">&amp;</span> <span class="n">MS_RDONLY</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">usb1</span><span class="o">-&gt;</span><span class="n">fs_clean</span> <span class="o">=</span> <span class="n">UFS_FSBAD</span><span class="p">;</span>
		<span class="n">ubh_mark_buffer_dirty</span><span class="p">(</span><span class="n">USPI_UBH</span><span class="p">(</span><span class="n">uspi</span><span class="p">));</span>
		<span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_dirt</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_flags</span> <span class="o">|=</span> <span class="n">MS_RDONLY</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">va_start</span> <span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">fmt</span><span class="p">);</span>
	<span class="n">vsnprintf</span> <span class="p">(</span><span class="n">error_buf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">error_buf</span><span class="p">),</span> <span class="n">fmt</span><span class="p">,</span> <span class="n">args</span><span class="p">);</span>
	<span class="n">va_end</span> <span class="p">(</span><span class="n">args</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">UFS_SB</span><span class="p">(</span><span class="n">sb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">s_mount_opt</span> <span class="o">&amp;</span> <span class="n">UFS_MOUNT_ONERROR</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">UFS_MOUNT_ONERROR_PANIC</span>:
		<span class="n">panic</span> <span class="p">(</span><span class="s">&quot;UFS-fs panic (device %s): %s: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> 
			<span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_id</span><span class="p">,</span> <span class="n">function</span><span class="p">,</span> <span class="n">error_buf</span><span class="p">);</span>

	<span class="k">case</span> <span class="n">UFS_MOUNT_ONERROR_LOCK</span>:
	<span class="k">case</span> <span class="n">UFS_MOUNT_ONERROR_UMOUNT</span>:
	<span class="k">case</span> <span class="n">UFS_MOUNT_ONERROR_REPAIR</span>:
		<span class="n">printk</span> <span class="p">(</span><span class="n">KERN_CRIT</span> <span class="s">&quot;UFS-fs error (device %s): %s: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_id</span><span class="p">,</span> <span class="n">function</span><span class="p">,</span> <span class="n">error_buf</span><span class="p">);</span>
	<span class="p">}</span>		
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">ufs_panic</span> <span class="p">(</span><span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span> <span class="n">sb</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span> <span class="n">function</span><span class="p">,</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span> <span class="n">fmt</span><span class="p">,</span> <span class="p">...)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ufs_sb_private_info</span> <span class="o">*</span> <span class="n">uspi</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ufs_super_block_first</span> <span class="o">*</span> <span class="n">usb1</span><span class="p">;</span>
	<span class="kt">va_list</span> <span class="n">args</span><span class="p">;</span>
	
	<span class="n">uspi</span> <span class="o">=</span> <span class="n">UFS_SB</span><span class="p">(</span><span class="n">sb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">s_uspi</span><span class="p">;</span>
	<span class="n">usb1</span> <span class="o">=</span> <span class="n">ubh_get_usb_first</span><span class="p">(</span><span class="n">uspi</span><span class="p">);</span>
	
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_flags</span> <span class="o">&amp;</span> <span class="n">MS_RDONLY</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">usb1</span><span class="o">-&gt;</span><span class="n">fs_clean</span> <span class="o">=</span> <span class="n">UFS_FSBAD</span><span class="p">;</span>
		<span class="n">ubh_mark_buffer_dirty</span><span class="p">(</span><span class="n">USPI_UBH</span><span class="p">(</span><span class="n">uspi</span><span class="p">));</span>
		<span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_dirt</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">va_start</span> <span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">fmt</span><span class="p">);</span>
	<span class="n">vsnprintf</span> <span class="p">(</span><span class="n">error_buf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">error_buf</span><span class="p">),</span> <span class="n">fmt</span><span class="p">,</span> <span class="n">args</span><span class="p">);</span>
	<span class="n">va_end</span> <span class="p">(</span><span class="n">args</span><span class="p">);</span>
	<span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_flags</span> <span class="o">|=</span> <span class="n">MS_RDONLY</span><span class="p">;</span>
	<span class="n">printk</span> <span class="p">(</span><span class="n">KERN_CRIT</span> <span class="s">&quot;UFS-fs panic (device %s): %s: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_id</span><span class="p">,</span> <span class="n">function</span><span class="p">,</span> <span class="n">error_buf</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">ufs_warning</span> <span class="p">(</span><span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span> <span class="n">sb</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span> <span class="n">function</span><span class="p">,</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span> <span class="n">fmt</span><span class="p">,</span> <span class="p">...)</span>
<span class="p">{</span>
	<span class="kt">va_list</span> <span class="n">args</span><span class="p">;</span>

	<span class="n">va_start</span> <span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">fmt</span><span class="p">);</span>
	<span class="n">vsnprintf</span> <span class="p">(</span><span class="n">error_buf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">error_buf</span><span class="p">),</span> <span class="n">fmt</span><span class="p">,</span> <span class="n">args</span><span class="p">);</span>
	<span class="n">va_end</span> <span class="p">(</span><span class="n">args</span><span class="p">);</span>
	<span class="n">printk</span> <span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;UFS-fs warning (device %s): %s: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_id</span><span class="p">,</span> <span class="n">function</span><span class="p">,</span> <span class="n">error_buf</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">enum</span> <span class="p">{</span>
       <span class="n">Opt_type_old</span> <span class="o">=</span> <span class="n">UFS_MOUNT_UFSTYPE_OLD</span><span class="p">,</span>
       <span class="n">Opt_type_sunx86</span> <span class="o">=</span> <span class="n">UFS_MOUNT_UFSTYPE_SUNx86</span><span class="p">,</span>
       <span class="n">Opt_type_sun</span> <span class="o">=</span> <span class="n">UFS_MOUNT_UFSTYPE_SUN</span><span class="p">,</span>
       <span class="n">Opt_type_sunos</span> <span class="o">=</span> <span class="n">UFS_MOUNT_UFSTYPE_SUNOS</span><span class="p">,</span>
       <span class="n">Opt_type_44bsd</span> <span class="o">=</span> <span class="n">UFS_MOUNT_UFSTYPE_44BSD</span><span class="p">,</span>
       <span class="n">Opt_type_ufs2</span> <span class="o">=</span> <span class="n">UFS_MOUNT_UFSTYPE_UFS2</span><span class="p">,</span>
       <span class="n">Opt_type_hp</span> <span class="o">=</span> <span class="n">UFS_MOUNT_UFSTYPE_HP</span><span class="p">,</span>
       <span class="n">Opt_type_nextstepcd</span> <span class="o">=</span> <span class="n">UFS_MOUNT_UFSTYPE_NEXTSTEP_CD</span><span class="p">,</span>
       <span class="n">Opt_type_nextstep</span> <span class="o">=</span> <span class="n">UFS_MOUNT_UFSTYPE_NEXTSTEP</span><span class="p">,</span>
       <span class="n">Opt_type_openstep</span> <span class="o">=</span> <span class="n">UFS_MOUNT_UFSTYPE_OPENSTEP</span><span class="p">,</span>
       <span class="n">Opt_onerror_panic</span> <span class="o">=</span> <span class="n">UFS_MOUNT_ONERROR_PANIC</span><span class="p">,</span>
       <span class="n">Opt_onerror_lock</span> <span class="o">=</span> <span class="n">UFS_MOUNT_ONERROR_LOCK</span><span class="p">,</span>
       <span class="n">Opt_onerror_umount</span> <span class="o">=</span> <span class="n">UFS_MOUNT_ONERROR_UMOUNT</span><span class="p">,</span>
       <span class="n">Opt_onerror_repair</span> <span class="o">=</span> <span class="n">UFS_MOUNT_ONERROR_REPAIR</span><span class="p">,</span>
       <span class="n">Opt_err</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="n">match_table_t</span> <span class="n">tokens</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span><span class="n">Opt_type_old</span><span class="p">,</span> <span class="s">&quot;ufstype=old&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">Opt_type_sunx86</span><span class="p">,</span> <span class="s">&quot;ufstype=sunx86&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">Opt_type_sun</span><span class="p">,</span> <span class="s">&quot;ufstype=sun&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">Opt_type_sunos</span><span class="p">,</span> <span class="s">&quot;ufstype=sunos&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">Opt_type_44bsd</span><span class="p">,</span> <span class="s">&quot;ufstype=44bsd&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">Opt_type_ufs2</span><span class="p">,</span> <span class="s">&quot;ufstype=ufs2&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">Opt_type_ufs2</span><span class="p">,</span> <span class="s">&quot;ufstype=5xbsd&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">Opt_type_hp</span><span class="p">,</span> <span class="s">&quot;ufstype=hp&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">Opt_type_nextstepcd</span><span class="p">,</span> <span class="s">&quot;ufstype=nextstep-cd&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">Opt_type_nextstep</span><span class="p">,</span> <span class="s">&quot;ufstype=nextstep&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">Opt_type_openstep</span><span class="p">,</span> <span class="s">&quot;ufstype=openstep&quot;</span><span class="p">},</span>
<span class="cm">/*end of possible ufs types */</span>
	<span class="p">{</span><span class="n">Opt_onerror_panic</span><span class="p">,</span> <span class="s">&quot;onerror=panic&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">Opt_onerror_lock</span><span class="p">,</span> <span class="s">&quot;onerror=lock&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">Opt_onerror_umount</span><span class="p">,</span> <span class="s">&quot;onerror=umount&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">Opt_onerror_repair</span><span class="p">,</span> <span class="s">&quot;onerror=repair&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">Opt_err</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ufs_parse_options</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span> <span class="n">options</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="o">*</span> <span class="n">mount_options</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span> <span class="n">p</span><span class="p">;</span>
	
	<span class="n">UFSD</span><span class="p">(</span><span class="s">&quot;ENTER</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">options</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">((</span><span class="n">p</span> <span class="o">=</span> <span class="n">strsep</span><span class="p">(</span><span class="o">&amp;</span><span class="n">options</span><span class="p">,</span> <span class="s">&quot;,&quot;</span><span class="p">))</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">substring_t</span> <span class="n">args</span><span class="p">[</span><span class="n">MAX_OPT_ARGS</span><span class="p">];</span>
		<span class="kt">int</span> <span class="n">token</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!*</span><span class="n">p</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">token</span> <span class="o">=</span> <span class="n">match_token</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">tokens</span><span class="p">,</span> <span class="n">args</span><span class="p">);</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">token</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">Opt_type_old</span>:
			<span class="n">ufs_clear_opt</span> <span class="p">(</span><span class="o">*</span><span class="n">mount_options</span><span class="p">,</span> <span class="n">UFSTYPE</span><span class="p">);</span>
			<span class="n">ufs_set_opt</span> <span class="p">(</span><span class="o">*</span><span class="n">mount_options</span><span class="p">,</span> <span class="n">UFSTYPE_OLD</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">Opt_type_sunx86</span>:
			<span class="n">ufs_clear_opt</span> <span class="p">(</span><span class="o">*</span><span class="n">mount_options</span><span class="p">,</span> <span class="n">UFSTYPE</span><span class="p">);</span>
			<span class="n">ufs_set_opt</span> <span class="p">(</span><span class="o">*</span><span class="n">mount_options</span><span class="p">,</span> <span class="n">UFSTYPE_SUNx86</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">Opt_type_sun</span>:
			<span class="n">ufs_clear_opt</span> <span class="p">(</span><span class="o">*</span><span class="n">mount_options</span><span class="p">,</span> <span class="n">UFSTYPE</span><span class="p">);</span>
			<span class="n">ufs_set_opt</span> <span class="p">(</span><span class="o">*</span><span class="n">mount_options</span><span class="p">,</span> <span class="n">UFSTYPE_SUN</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">Opt_type_sunos</span>:
			<span class="n">ufs_clear_opt</span><span class="p">(</span><span class="o">*</span><span class="n">mount_options</span><span class="p">,</span> <span class="n">UFSTYPE</span><span class="p">);</span>
			<span class="n">ufs_set_opt</span><span class="p">(</span><span class="o">*</span><span class="n">mount_options</span><span class="p">,</span> <span class="n">UFSTYPE_SUNOS</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">Opt_type_44bsd</span>:
			<span class="n">ufs_clear_opt</span> <span class="p">(</span><span class="o">*</span><span class="n">mount_options</span><span class="p">,</span> <span class="n">UFSTYPE</span><span class="p">);</span>
			<span class="n">ufs_set_opt</span> <span class="p">(</span><span class="o">*</span><span class="n">mount_options</span><span class="p">,</span> <span class="n">UFSTYPE_44BSD</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">Opt_type_ufs2</span>:
			<span class="n">ufs_clear_opt</span><span class="p">(</span><span class="o">*</span><span class="n">mount_options</span><span class="p">,</span> <span class="n">UFSTYPE</span><span class="p">);</span>
			<span class="n">ufs_set_opt</span><span class="p">(</span><span class="o">*</span><span class="n">mount_options</span><span class="p">,</span> <span class="n">UFSTYPE_UFS2</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">Opt_type_hp</span>:
			<span class="n">ufs_clear_opt</span> <span class="p">(</span><span class="o">*</span><span class="n">mount_options</span><span class="p">,</span> <span class="n">UFSTYPE</span><span class="p">);</span>
			<span class="n">ufs_set_opt</span> <span class="p">(</span><span class="o">*</span><span class="n">mount_options</span><span class="p">,</span> <span class="n">UFSTYPE_HP</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">Opt_type_nextstepcd</span>:
			<span class="n">ufs_clear_opt</span> <span class="p">(</span><span class="o">*</span><span class="n">mount_options</span><span class="p">,</span> <span class="n">UFSTYPE</span><span class="p">);</span>
			<span class="n">ufs_set_opt</span> <span class="p">(</span><span class="o">*</span><span class="n">mount_options</span><span class="p">,</span> <span class="n">UFSTYPE_NEXTSTEP_CD</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">Opt_type_nextstep</span>:
			<span class="n">ufs_clear_opt</span> <span class="p">(</span><span class="o">*</span><span class="n">mount_options</span><span class="p">,</span> <span class="n">UFSTYPE</span><span class="p">);</span>
			<span class="n">ufs_set_opt</span> <span class="p">(</span><span class="o">*</span><span class="n">mount_options</span><span class="p">,</span> <span class="n">UFSTYPE_NEXTSTEP</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">Opt_type_openstep</span>:
			<span class="n">ufs_clear_opt</span> <span class="p">(</span><span class="o">*</span><span class="n">mount_options</span><span class="p">,</span> <span class="n">UFSTYPE</span><span class="p">);</span>
			<span class="n">ufs_set_opt</span> <span class="p">(</span><span class="o">*</span><span class="n">mount_options</span><span class="p">,</span> <span class="n">UFSTYPE_OPENSTEP</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">Opt_onerror_panic</span>:
			<span class="n">ufs_clear_opt</span> <span class="p">(</span><span class="o">*</span><span class="n">mount_options</span><span class="p">,</span> <span class="n">ONERROR</span><span class="p">);</span>
			<span class="n">ufs_set_opt</span> <span class="p">(</span><span class="o">*</span><span class="n">mount_options</span><span class="p">,</span> <span class="n">ONERROR_PANIC</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">Opt_onerror_lock</span>:
			<span class="n">ufs_clear_opt</span> <span class="p">(</span><span class="o">*</span><span class="n">mount_options</span><span class="p">,</span> <span class="n">ONERROR</span><span class="p">);</span>
			<span class="n">ufs_set_opt</span> <span class="p">(</span><span class="o">*</span><span class="n">mount_options</span><span class="p">,</span> <span class="n">ONERROR_LOCK</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">Opt_onerror_umount</span>:
			<span class="n">ufs_clear_opt</span> <span class="p">(</span><span class="o">*</span><span class="n">mount_options</span><span class="p">,</span> <span class="n">ONERROR</span><span class="p">);</span>
			<span class="n">ufs_set_opt</span> <span class="p">(</span><span class="o">*</span><span class="n">mount_options</span><span class="p">,</span> <span class="n">ONERROR_UMOUNT</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">Opt_onerror_repair</span>:
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;UFS-fs: Unable to do repair on error, &quot;</span>
				<span class="s">&quot;will lock lock instead</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">ufs_clear_opt</span> <span class="p">(</span><span class="o">*</span><span class="n">mount_options</span><span class="p">,</span> <span class="n">ONERROR</span><span class="p">);</span>
			<span class="n">ufs_set_opt</span> <span class="p">(</span><span class="o">*</span><span class="n">mount_options</span><span class="p">,</span> <span class="n">ONERROR_REPAIR</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;UFS-fs: Invalid option: </span><span class="se">\&quot;</span><span class="s">%s</span><span class="se">\&quot;</span><span class="s"> &quot;</span>
					<span class="s">&quot;or missing value</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">p</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Different types of UFS hold fs_cstotal in different</span>
<span class="cm"> * places, and use different data structure for it.</span>
<span class="cm"> * To make things simpler we just copy fs_cstotal to ufs_sb_private_info</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ufs_setup_cstotal</span><span class="p">(</span><span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">sb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ufs_sb_info</span> <span class="o">*</span><span class="n">sbi</span> <span class="o">=</span> <span class="n">UFS_SB</span><span class="p">(</span><span class="n">sb</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ufs_sb_private_info</span> <span class="o">*</span><span class="n">uspi</span> <span class="o">=</span> <span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_uspi</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ufs_super_block_first</span> <span class="o">*</span><span class="n">usb1</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ufs_super_block_second</span> <span class="o">*</span><span class="n">usb2</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ufs_super_block_third</span> <span class="o">*</span><span class="n">usb3</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">mtype</span> <span class="o">=</span> <span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_mount_opt</span> <span class="o">&amp;</span> <span class="n">UFS_MOUNT_UFSTYPE</span><span class="p">;</span>

	<span class="n">UFSD</span><span class="p">(</span><span class="s">&quot;ENTER, mtype=%u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">mtype</span><span class="p">);</span>
	<span class="n">usb1</span> <span class="o">=</span> <span class="n">ubh_get_usb_first</span><span class="p">(</span><span class="n">uspi</span><span class="p">);</span>
	<span class="n">usb2</span> <span class="o">=</span> <span class="n">ubh_get_usb_second</span><span class="p">(</span><span class="n">uspi</span><span class="p">);</span>
	<span class="n">usb3</span> <span class="o">=</span> <span class="n">ubh_get_usb_third</span><span class="p">(</span><span class="n">uspi</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">mtype</span> <span class="o">==</span> <span class="n">UFS_MOUNT_UFSTYPE_44BSD</span> <span class="o">&amp;&amp;</span>
	     <span class="p">(</span><span class="n">usb1</span><span class="o">-&gt;</span><span class="n">fs_flags</span> <span class="o">&amp;</span> <span class="n">UFS_FLAGS_UPDATED</span><span class="p">))</span> <span class="o">||</span>
	    <span class="n">mtype</span> <span class="o">==</span> <span class="n">UFS_MOUNT_UFSTYPE_UFS2</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*we have statistic in different place, then usual*/</span>
		<span class="n">uspi</span><span class="o">-&gt;</span><span class="n">cs_total</span><span class="p">.</span><span class="n">cs_ndir</span> <span class="o">=</span> <span class="n">fs64_to_cpu</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">usb2</span><span class="o">-&gt;</span><span class="n">fs_un</span><span class="p">.</span><span class="n">fs_u2</span><span class="p">.</span><span class="n">cs_ndir</span><span class="p">);</span>
		<span class="n">uspi</span><span class="o">-&gt;</span><span class="n">cs_total</span><span class="p">.</span><span class="n">cs_nbfree</span> <span class="o">=</span> <span class="n">fs64_to_cpu</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">usb2</span><span class="o">-&gt;</span><span class="n">fs_un</span><span class="p">.</span><span class="n">fs_u2</span><span class="p">.</span><span class="n">cs_nbfree</span><span class="p">);</span>
		<span class="n">uspi</span><span class="o">-&gt;</span><span class="n">cs_total</span><span class="p">.</span><span class="n">cs_nifree</span> <span class="o">=</span> <span class="n">fs64_to_cpu</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">usb3</span><span class="o">-&gt;</span><span class="n">fs_un1</span><span class="p">.</span><span class="n">fs_u2</span><span class="p">.</span><span class="n">cs_nifree</span><span class="p">);</span>
		<span class="n">uspi</span><span class="o">-&gt;</span><span class="n">cs_total</span><span class="p">.</span><span class="n">cs_nffree</span> <span class="o">=</span> <span class="n">fs64_to_cpu</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">usb3</span><span class="o">-&gt;</span><span class="n">fs_un1</span><span class="p">.</span><span class="n">fs_u2</span><span class="p">.</span><span class="n">cs_nffree</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">uspi</span><span class="o">-&gt;</span><span class="n">cs_total</span><span class="p">.</span><span class="n">cs_ndir</span> <span class="o">=</span> <span class="n">fs32_to_cpu</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">usb1</span><span class="o">-&gt;</span><span class="n">fs_cstotal</span><span class="p">.</span><span class="n">cs_ndir</span><span class="p">);</span>
		<span class="n">uspi</span><span class="o">-&gt;</span><span class="n">cs_total</span><span class="p">.</span><span class="n">cs_nbfree</span> <span class="o">=</span> <span class="n">fs32_to_cpu</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">usb1</span><span class="o">-&gt;</span><span class="n">fs_cstotal</span><span class="p">.</span><span class="n">cs_nbfree</span><span class="p">);</span>
		<span class="n">uspi</span><span class="o">-&gt;</span><span class="n">cs_total</span><span class="p">.</span><span class="n">cs_nifree</span> <span class="o">=</span> <span class="n">fs32_to_cpu</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">usb1</span><span class="o">-&gt;</span><span class="n">fs_cstotal</span><span class="p">.</span><span class="n">cs_nifree</span><span class="p">);</span>
		<span class="n">uspi</span><span class="o">-&gt;</span><span class="n">cs_total</span><span class="p">.</span><span class="n">cs_nffree</span> <span class="o">=</span> <span class="n">fs32_to_cpu</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">usb1</span><span class="o">-&gt;</span><span class="n">fs_cstotal</span><span class="p">.</span><span class="n">cs_nffree</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">UFSD</span><span class="p">(</span><span class="s">&quot;EXIT</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Read on-disk structures associated with cylinder groups</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ufs_read_cylinder_structures</span><span class="p">(</span><span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">sb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ufs_sb_info</span> <span class="o">*</span><span class="n">sbi</span> <span class="o">=</span> <span class="n">UFS_SB</span><span class="p">(</span><span class="n">sb</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ufs_sb_private_info</span> <span class="o">*</span><span class="n">uspi</span> <span class="o">=</span> <span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_uspi</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ufs_buffer_head</span> <span class="o">*</span> <span class="n">ubh</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span> <span class="n">base</span><span class="p">,</span> <span class="o">*</span> <span class="n">space</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">size</span><span class="p">,</span> <span class="n">blks</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ufs_super_block_third</span> <span class="o">*</span><span class="n">usb3</span><span class="p">;</span>

	<span class="n">UFSD</span><span class="p">(</span><span class="s">&quot;ENTER</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">usb3</span> <span class="o">=</span> <span class="n">ubh_get_usb_third</span><span class="p">(</span><span class="n">uspi</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 * Read cs structures from (usually) first data block</span>
<span class="cm">	 * on the device. </span>
<span class="cm">	 */</span>
	<span class="n">size</span> <span class="o">=</span> <span class="n">uspi</span><span class="o">-&gt;</span><span class="n">s_cssize</span><span class="p">;</span>
	<span class="n">blks</span> <span class="o">=</span> <span class="p">(</span><span class="n">size</span> <span class="o">+</span> <span class="n">uspi</span><span class="o">-&gt;</span><span class="n">s_fsize</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">uspi</span><span class="o">-&gt;</span><span class="n">s_fshift</span><span class="p">;</span>
	<span class="n">base</span> <span class="o">=</span> <span class="n">space</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">GFP_NOFS</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">base</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">failed</span><span class="p">;</span> 
	<span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_csp</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ufs_csum</span> <span class="o">*</span><span class="p">)</span><span class="n">space</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">blks</span><span class="p">;</span> <span class="n">i</span> <span class="o">+=</span> <span class="n">uspi</span><span class="o">-&gt;</span><span class="n">s_fpb</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">size</span> <span class="o">=</span> <span class="n">uspi</span><span class="o">-&gt;</span><span class="n">s_bsize</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="n">uspi</span><span class="o">-&gt;</span><span class="n">s_fpb</span> <span class="o">&gt;</span> <span class="n">blks</span><span class="p">)</span>
			<span class="n">size</span> <span class="o">=</span> <span class="p">(</span><span class="n">blks</span> <span class="o">-</span> <span class="n">i</span><span class="p">)</span> <span class="o">*</span> <span class="n">uspi</span><span class="o">-&gt;</span><span class="n">s_fsize</span><span class="p">;</span>

		<span class="n">ubh</span> <span class="o">=</span> <span class="n">ubh_bread</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">uspi</span><span class="o">-&gt;</span><span class="n">s_csaddr</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
		
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ubh</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">failed</span><span class="p">;</span>

		<span class="n">ubh_ubhcpymem</span> <span class="p">(</span><span class="n">space</span><span class="p">,</span> <span class="n">ubh</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>

		<span class="n">space</span> <span class="o">+=</span> <span class="n">size</span><span class="p">;</span>
		<span class="n">ubh_brelse</span> <span class="p">(</span><span class="n">ubh</span><span class="p">);</span>
		<span class="n">ubh</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Read cylinder group (we read only first fragment from block</span>
<span class="cm">	 * at this time) and prepare internal data structures for cg caching.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_ucg</span> <span class="o">=</span> <span class="n">kmalloc</span> <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">buffer_head</span> <span class="o">*</span><span class="p">)</span> <span class="o">*</span> <span class="n">uspi</span><span class="o">-&gt;</span><span class="n">s_ncg</span><span class="p">,</span> <span class="n">GFP_NOFS</span><span class="p">)))</span>
		<span class="k">goto</span> <span class="n">failed</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">uspi</span><span class="o">-&gt;</span><span class="n">s_ncg</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> 
		<span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_ucg</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">UFS_MAX_GROUP_LOADED</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_ucpi</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_cgno</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">UFS_CGNO_EMPTY</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">uspi</span><span class="o">-&gt;</span><span class="n">s_ncg</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">UFSD</span><span class="p">(</span><span class="s">&quot;read cg %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_ucg</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">sb_bread</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">ufs_cgcmin</span><span class="p">(</span><span class="n">i</span><span class="p">))))</span>
			<span class="k">goto</span> <span class="n">failed</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ufs_cg_chkmagic</span> <span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ufs_cylinder_group</span> <span class="o">*</span><span class="p">)</span> <span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_ucg</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">b_data</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">failed</span><span class="p">;</span>

		<span class="n">ufs_print_cylinder_stuff</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ufs_cylinder_group</span> <span class="o">*</span><span class="p">)</span> <span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_ucg</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">b_data</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">UFS_MAX_GROUP_LOADED</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_ucpi</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">kmalloc</span> <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ufs_cg_private_info</span><span class="p">),</span> <span class="n">GFP_NOFS</span><span class="p">)))</span>
			<span class="k">goto</span> <span class="n">failed</span><span class="p">;</span>
		<span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_cgno</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">UFS_CGNO_EMPTY</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_cg_loaded</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">UFSD</span><span class="p">(</span><span class="s">&quot;EXIT</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

<span class="nl">failed:</span>
	<span class="n">kfree</span> <span class="p">(</span><span class="n">base</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_ucg</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">uspi</span><span class="o">-&gt;</span><span class="n">s_ncg</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_ucg</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
				<span class="n">brelse</span> <span class="p">(</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_ucg</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="n">kfree</span> <span class="p">(</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_ucg</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">UFS_MAX_GROUP_LOADED</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">kfree</span> <span class="p">(</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_ucpi</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="p">}</span>
	<span class="n">UFSD</span><span class="p">(</span><span class="s">&quot;EXIT (FAILED)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Sync our internal copy of fs_cstotal with disk</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ufs_put_cstotal</span><span class="p">(</span><span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">sb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="n">mtype</span> <span class="o">=</span> <span class="n">UFS_SB</span><span class="p">(</span><span class="n">sb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">s_mount_opt</span> <span class="o">&amp;</span> <span class="n">UFS_MOUNT_UFSTYPE</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ufs_sb_private_info</span> <span class="o">*</span><span class="n">uspi</span> <span class="o">=</span> <span class="n">UFS_SB</span><span class="p">(</span><span class="n">sb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">s_uspi</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ufs_super_block_first</span> <span class="o">*</span><span class="n">usb1</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ufs_super_block_second</span> <span class="o">*</span><span class="n">usb2</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ufs_super_block_third</span> <span class="o">*</span><span class="n">usb3</span><span class="p">;</span>

	<span class="n">UFSD</span><span class="p">(</span><span class="s">&quot;ENTER</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">usb1</span> <span class="o">=</span> <span class="n">ubh_get_usb_first</span><span class="p">(</span><span class="n">uspi</span><span class="p">);</span>
	<span class="n">usb2</span> <span class="o">=</span> <span class="n">ubh_get_usb_second</span><span class="p">(</span><span class="n">uspi</span><span class="p">);</span>
	<span class="n">usb3</span> <span class="o">=</span> <span class="n">ubh_get_usb_third</span><span class="p">(</span><span class="n">uspi</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">mtype</span> <span class="o">==</span> <span class="n">UFS_MOUNT_UFSTYPE_44BSD</span> <span class="o">&amp;&amp;</span>
	     <span class="p">(</span><span class="n">usb1</span><span class="o">-&gt;</span><span class="n">fs_flags</span> <span class="o">&amp;</span> <span class="n">UFS_FLAGS_UPDATED</span><span class="p">))</span> <span class="o">||</span>
	    <span class="n">mtype</span> <span class="o">==</span> <span class="n">UFS_MOUNT_UFSTYPE_UFS2</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*we have statistic in different place, then usual*/</span>
		<span class="n">usb2</span><span class="o">-&gt;</span><span class="n">fs_un</span><span class="p">.</span><span class="n">fs_u2</span><span class="p">.</span><span class="n">cs_ndir</span> <span class="o">=</span>
			<span class="n">cpu_to_fs64</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">uspi</span><span class="o">-&gt;</span><span class="n">cs_total</span><span class="p">.</span><span class="n">cs_ndir</span><span class="p">);</span>
		<span class="n">usb2</span><span class="o">-&gt;</span><span class="n">fs_un</span><span class="p">.</span><span class="n">fs_u2</span><span class="p">.</span><span class="n">cs_nbfree</span> <span class="o">=</span>
			<span class="n">cpu_to_fs64</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">uspi</span><span class="o">-&gt;</span><span class="n">cs_total</span><span class="p">.</span><span class="n">cs_nbfree</span><span class="p">);</span>
		<span class="n">usb3</span><span class="o">-&gt;</span><span class="n">fs_un1</span><span class="p">.</span><span class="n">fs_u2</span><span class="p">.</span><span class="n">cs_nifree</span> <span class="o">=</span>
			<span class="n">cpu_to_fs64</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">uspi</span><span class="o">-&gt;</span><span class="n">cs_total</span><span class="p">.</span><span class="n">cs_nifree</span><span class="p">);</span>
		<span class="n">usb3</span><span class="o">-&gt;</span><span class="n">fs_un1</span><span class="p">.</span><span class="n">fs_u2</span><span class="p">.</span><span class="n">cs_nffree</span> <span class="o">=</span>
			<span class="n">cpu_to_fs64</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">uspi</span><span class="o">-&gt;</span><span class="n">cs_total</span><span class="p">.</span><span class="n">cs_nffree</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">usb1</span><span class="o">-&gt;</span><span class="n">fs_cstotal</span><span class="p">.</span><span class="n">cs_ndir</span> <span class="o">=</span>
			<span class="n">cpu_to_fs32</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">uspi</span><span class="o">-&gt;</span><span class="n">cs_total</span><span class="p">.</span><span class="n">cs_ndir</span><span class="p">);</span>
		<span class="n">usb1</span><span class="o">-&gt;</span><span class="n">fs_cstotal</span><span class="p">.</span><span class="n">cs_nbfree</span> <span class="o">=</span>
			<span class="n">cpu_to_fs32</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">uspi</span><span class="o">-&gt;</span><span class="n">cs_total</span><span class="p">.</span><span class="n">cs_nbfree</span><span class="p">);</span>
		<span class="n">usb1</span><span class="o">-&gt;</span><span class="n">fs_cstotal</span><span class="p">.</span><span class="n">cs_nifree</span> <span class="o">=</span>
			<span class="n">cpu_to_fs32</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">uspi</span><span class="o">-&gt;</span><span class="n">cs_total</span><span class="p">.</span><span class="n">cs_nifree</span><span class="p">);</span>
		<span class="n">usb1</span><span class="o">-&gt;</span><span class="n">fs_cstotal</span><span class="p">.</span><span class="n">cs_nffree</span> <span class="o">=</span>
			<span class="n">cpu_to_fs32</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">uspi</span><span class="o">-&gt;</span><span class="n">cs_total</span><span class="p">.</span><span class="n">cs_nffree</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">ubh_mark_buffer_dirty</span><span class="p">(</span><span class="n">USPI_UBH</span><span class="p">(</span><span class="n">uspi</span><span class="p">));</span>
	<span class="n">ufs_print_super_stuff</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">usb1</span><span class="p">,</span> <span class="n">usb2</span><span class="p">,</span> <span class="n">usb3</span><span class="p">);</span>
	<span class="n">UFSD</span><span class="p">(</span><span class="s">&quot;EXIT</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ufs_put_super_internal() - put on-disk intrenal structures</span>
<span class="cm"> * @sb: pointer to super_block structure</span>
<span class="cm"> * Put on-disk structures associated with cylinder groups</span>
<span class="cm"> * and write them back to disk, also update cs_total on disk</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ufs_put_super_internal</span><span class="p">(</span><span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">sb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ufs_sb_info</span> <span class="o">*</span><span class="n">sbi</span> <span class="o">=</span> <span class="n">UFS_SB</span><span class="p">(</span><span class="n">sb</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ufs_sb_private_info</span> <span class="o">*</span><span class="n">uspi</span> <span class="o">=</span> <span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_uspi</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ufs_buffer_head</span> <span class="o">*</span> <span class="n">ubh</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span> <span class="n">base</span><span class="p">,</span> <span class="o">*</span> <span class="n">space</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">blks</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>

	
	<span class="n">UFSD</span><span class="p">(</span><span class="s">&quot;ENTER</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">ufs_put_cstotal</span><span class="p">(</span><span class="n">sb</span><span class="p">);</span>
	<span class="n">size</span> <span class="o">=</span> <span class="n">uspi</span><span class="o">-&gt;</span><span class="n">s_cssize</span><span class="p">;</span>
	<span class="n">blks</span> <span class="o">=</span> <span class="p">(</span><span class="n">size</span> <span class="o">+</span> <span class="n">uspi</span><span class="o">-&gt;</span><span class="n">s_fsize</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">uspi</span><span class="o">-&gt;</span><span class="n">s_fshift</span><span class="p">;</span>
	<span class="n">base</span> <span class="o">=</span> <span class="n">space</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span> <span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_csp</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">blks</span><span class="p">;</span> <span class="n">i</span> <span class="o">+=</span> <span class="n">uspi</span><span class="o">-&gt;</span><span class="n">s_fpb</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">size</span> <span class="o">=</span> <span class="n">uspi</span><span class="o">-&gt;</span><span class="n">s_bsize</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="n">uspi</span><span class="o">-&gt;</span><span class="n">s_fpb</span> <span class="o">&gt;</span> <span class="n">blks</span><span class="p">)</span>
			<span class="n">size</span> <span class="o">=</span> <span class="p">(</span><span class="n">blks</span> <span class="o">-</span> <span class="n">i</span><span class="p">)</span> <span class="o">*</span> <span class="n">uspi</span><span class="o">-&gt;</span><span class="n">s_fsize</span><span class="p">;</span>

		<span class="n">ubh</span> <span class="o">=</span> <span class="n">ubh_bread</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">uspi</span><span class="o">-&gt;</span><span class="n">s_csaddr</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>

		<span class="n">ubh_memcpyubh</span> <span class="p">(</span><span class="n">ubh</span><span class="p">,</span> <span class="n">space</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
		<span class="n">space</span> <span class="o">+=</span> <span class="n">size</span><span class="p">;</span>
		<span class="n">ubh_mark_buffer_uptodate</span> <span class="p">(</span><span class="n">ubh</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">ubh_mark_buffer_dirty</span> <span class="p">(</span><span class="n">ubh</span><span class="p">);</span>
		<span class="n">ubh_brelse</span> <span class="p">(</span><span class="n">ubh</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_cg_loaded</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ufs_put_cylinder</span> <span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
		<span class="n">kfree</span> <span class="p">(</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_ucpi</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="p">}</span>
	<span class="k">for</span> <span class="p">(;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">UFS_MAX_GROUP_LOADED</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> 
		<span class="n">kfree</span> <span class="p">(</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_ucpi</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">uspi</span><span class="o">-&gt;</span><span class="n">s_ncg</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> 
		<span class="n">brelse</span> <span class="p">(</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_ucg</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="n">kfree</span> <span class="p">(</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_ucg</span><span class="p">);</span>
	<span class="n">kfree</span> <span class="p">(</span><span class="n">base</span><span class="p">);</span>

	<span class="n">UFSD</span><span class="p">(</span><span class="s">&quot;EXIT</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ufs_fill_super</span><span class="p">(</span><span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">sb</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">int</span> <span class="n">silent</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ufs_sb_info</span> <span class="o">*</span> <span class="n">sbi</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ufs_sb_private_info</span> <span class="o">*</span> <span class="n">uspi</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ufs_super_block_first</span> <span class="o">*</span> <span class="n">usb1</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ufs_super_block_second</span> <span class="o">*</span> <span class="n">usb2</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ufs_super_block_third</span> <span class="o">*</span> <span class="n">usb3</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ufs_buffer_head</span> <span class="o">*</span> <span class="n">ubh</span><span class="p">;</span>	
	<span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">block_size</span><span class="p">,</span> <span class="n">super_block_size</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">super_block_offset</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">maxsymlen</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">uspi</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">ubh</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	
	<span class="n">UFSD</span><span class="p">(</span><span class="s">&quot;ENTER</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		
	<span class="n">sbi</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ufs_sb_info</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sbi</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">failed_nomem</span><span class="p">;</span>
	<span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_fs_info</span> <span class="o">=</span> <span class="n">sbi</span><span class="p">;</span>

	<span class="n">UFSD</span><span class="p">(</span><span class="s">&quot;flag %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)(</span><span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_flags</span> <span class="o">&amp;</span> <span class="n">MS_RDONLY</span><span class="p">));</span>
	
<span class="cp">#ifndef CONFIG_UFS_FS_WRITE</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_flags</span> <span class="o">&amp;</span> <span class="n">MS_RDONLY</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;ufs was compiled with read-only support, &quot;</span>
		<span class="s">&quot;can&#39;t be mounted as read-write</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">failed</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
	<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 * Set default mount options</span>
<span class="cm">	 * Parse mount options</span>
<span class="cm">	 */</span>
	<span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_mount_opt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ufs_set_opt</span> <span class="p">(</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_mount_opt</span><span class="p">,</span> <span class="n">ONERROR_LOCK</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ufs_parse_options</span> <span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">data</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_mount_opt</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;wrong mount options</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">failed</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_mount_opt</span> <span class="o">&amp;</span> <span class="n">UFS_MOUNT_UFSTYPE</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">silent</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;You didn&#39;t specify the type of your ufs filesystem</span><span class="se">\n\n</span><span class="s">&quot;</span>
			<span class="s">&quot;mount -t ufs -o ufstype=&quot;</span>
			<span class="s">&quot;sun|sunx86|44bsd|ufs2|5xbsd|old|hp|nextstep|nextstep-cd|openstep ...</span><span class="se">\n\n</span><span class="s">&quot;</span>
			<span class="s">&quot;&gt;&gt;&gt;WARNING&lt;&lt;&lt; Wrong ufstype may corrupt your filesystem, &quot;</span>
			<span class="s">&quot;default is ufstype=old</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ufs_set_opt</span> <span class="p">(</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_mount_opt</span><span class="p">,</span> <span class="n">UFSTYPE_OLD</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">uspi</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ufs_sb_private_info</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_uspi</span> <span class="o">=</span> <span class="n">uspi</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">uspi</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">failed</span><span class="p">;</span>
	<span class="n">uspi</span><span class="o">-&gt;</span><span class="n">s_dirblksize</span> <span class="o">=</span> <span class="n">UFS_SECTOR_SIZE</span><span class="p">;</span>
	<span class="n">super_block_offset</span><span class="o">=</span><span class="n">UFS_SBLOCK</span><span class="p">;</span>

	<span class="cm">/* Keep 2Gig file limit. Some UFS variants need to override </span>
<span class="cm">	   this but as I don&#39;t know which I&#39;ll let those in the know loosen</span>
<span class="cm">	   the rules */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_mount_opt</span> <span class="o">&amp;</span> <span class="n">UFS_MOUNT_UFSTYPE</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">UFS_MOUNT_UFSTYPE_44BSD</span>:
		<span class="n">UFSD</span><span class="p">(</span><span class="s">&quot;ufstype=44bsd</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">uspi</span><span class="o">-&gt;</span><span class="n">s_fsize</span> <span class="o">=</span> <span class="n">block_size</span> <span class="o">=</span> <span class="mi">512</span><span class="p">;</span>
		<span class="n">uspi</span><span class="o">-&gt;</span><span class="n">s_fmask</span> <span class="o">=</span> <span class="o">~</span><span class="p">(</span><span class="mi">512</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">uspi</span><span class="o">-&gt;</span><span class="n">s_fshift</span> <span class="o">=</span> <span class="mi">9</span><span class="p">;</span>
		<span class="n">uspi</span><span class="o">-&gt;</span><span class="n">s_sbsize</span> <span class="o">=</span> <span class="n">super_block_size</span> <span class="o">=</span> <span class="mi">1536</span><span class="p">;</span>
		<span class="n">uspi</span><span class="o">-&gt;</span><span class="n">s_sbbase</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">flags</span> <span class="o">|=</span> <span class="n">UFS_DE_44BSD</span> <span class="o">|</span> <span class="n">UFS_UID_44BSD</span> <span class="o">|</span> <span class="n">UFS_ST_44BSD</span> <span class="o">|</span> <span class="n">UFS_CG_44BSD</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">UFS_MOUNT_UFSTYPE_UFS2</span>:
		<span class="n">UFSD</span><span class="p">(</span><span class="s">&quot;ufstype=ufs2</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">super_block_offset</span><span class="o">=</span><span class="n">SBLOCK_UFS2</span><span class="p">;</span>
		<span class="n">uspi</span><span class="o">-&gt;</span><span class="n">s_fsize</span> <span class="o">=</span> <span class="n">block_size</span> <span class="o">=</span> <span class="mi">512</span><span class="p">;</span>
		<span class="n">uspi</span><span class="o">-&gt;</span><span class="n">s_fmask</span> <span class="o">=</span> <span class="o">~</span><span class="p">(</span><span class="mi">512</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">uspi</span><span class="o">-&gt;</span><span class="n">s_fshift</span> <span class="o">=</span> <span class="mi">9</span><span class="p">;</span>
		<span class="n">uspi</span><span class="o">-&gt;</span><span class="n">s_sbsize</span> <span class="o">=</span> <span class="n">super_block_size</span> <span class="o">=</span> <span class="mi">1536</span><span class="p">;</span>
		<span class="n">uspi</span><span class="o">-&gt;</span><span class="n">s_sbbase</span> <span class="o">=</span>  <span class="mi">0</span><span class="p">;</span>
		<span class="n">flags</span> <span class="o">|=</span> <span class="n">UFS_TYPE_UFS2</span> <span class="o">|</span> <span class="n">UFS_DE_44BSD</span> <span class="o">|</span> <span class="n">UFS_UID_44BSD</span> <span class="o">|</span> <span class="n">UFS_ST_44BSD</span> <span class="o">|</span> <span class="n">UFS_CG_44BSD</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
		
	<span class="k">case</span> <span class="n">UFS_MOUNT_UFSTYPE_SUN</span>:
		<span class="n">UFSD</span><span class="p">(</span><span class="s">&quot;ufstype=sun</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">uspi</span><span class="o">-&gt;</span><span class="n">s_fsize</span> <span class="o">=</span> <span class="n">block_size</span> <span class="o">=</span> <span class="mi">1024</span><span class="p">;</span>
		<span class="n">uspi</span><span class="o">-&gt;</span><span class="n">s_fmask</span> <span class="o">=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1024</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">uspi</span><span class="o">-&gt;</span><span class="n">s_fshift</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
		<span class="n">uspi</span><span class="o">-&gt;</span><span class="n">s_sbsize</span> <span class="o">=</span> <span class="n">super_block_size</span> <span class="o">=</span> <span class="mi">2048</span><span class="p">;</span>
		<span class="n">uspi</span><span class="o">-&gt;</span><span class="n">s_sbbase</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">uspi</span><span class="o">-&gt;</span><span class="n">s_maxsymlinklen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* Not supported on disk */</span>
		<span class="n">flags</span> <span class="o">|=</span> <span class="n">UFS_DE_OLD</span> <span class="o">|</span> <span class="n">UFS_UID_EFT</span> <span class="o">|</span> <span class="n">UFS_ST_SUN</span> <span class="o">|</span> <span class="n">UFS_CG_SUN</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">UFS_MOUNT_UFSTYPE_SUNOS</span>:
		<span class="n">UFSD</span><span class="p">((</span><span class="s">&quot;ufstype=sunos</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">))</span>
		<span class="n">uspi</span><span class="o">-&gt;</span><span class="n">s_fsize</span> <span class="o">=</span> <span class="n">block_size</span> <span class="o">=</span> <span class="mi">1024</span><span class="p">;</span>
		<span class="n">uspi</span><span class="o">-&gt;</span><span class="n">s_fmask</span> <span class="o">=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1024</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">uspi</span><span class="o">-&gt;</span><span class="n">s_fshift</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
		<span class="n">uspi</span><span class="o">-&gt;</span><span class="n">s_sbsize</span> <span class="o">=</span> <span class="mi">2048</span><span class="p">;</span>
		<span class="n">super_block_size</span> <span class="o">=</span> <span class="mi">2048</span><span class="p">;</span>
		<span class="n">uspi</span><span class="o">-&gt;</span><span class="n">s_sbbase</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">uspi</span><span class="o">-&gt;</span><span class="n">s_maxsymlinklen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* Not supported on disk */</span>
		<span class="n">flags</span> <span class="o">|=</span> <span class="n">UFS_DE_OLD</span> <span class="o">|</span> <span class="n">UFS_UID_OLD</span> <span class="o">|</span> <span class="n">UFS_ST_SUNOS</span> <span class="o">|</span> <span class="n">UFS_CG_SUN</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">UFS_MOUNT_UFSTYPE_SUNx86</span>:
		<span class="n">UFSD</span><span class="p">(</span><span class="s">&quot;ufstype=sunx86</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">uspi</span><span class="o">-&gt;</span><span class="n">s_fsize</span> <span class="o">=</span> <span class="n">block_size</span> <span class="o">=</span> <span class="mi">1024</span><span class="p">;</span>
		<span class="n">uspi</span><span class="o">-&gt;</span><span class="n">s_fmask</span> <span class="o">=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1024</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">uspi</span><span class="o">-&gt;</span><span class="n">s_fshift</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
		<span class="n">uspi</span><span class="o">-&gt;</span><span class="n">s_sbsize</span> <span class="o">=</span> <span class="n">super_block_size</span> <span class="o">=</span> <span class="mi">2048</span><span class="p">;</span>
		<span class="n">uspi</span><span class="o">-&gt;</span><span class="n">s_sbbase</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">uspi</span><span class="o">-&gt;</span><span class="n">s_maxsymlinklen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* Not supported on disk */</span>
		<span class="n">flags</span> <span class="o">|=</span> <span class="n">UFS_DE_OLD</span> <span class="o">|</span> <span class="n">UFS_UID_EFT</span> <span class="o">|</span> <span class="n">UFS_ST_SUNx86</span> <span class="o">|</span> <span class="n">UFS_CG_SUN</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">UFS_MOUNT_UFSTYPE_OLD</span>:
		<span class="n">UFSD</span><span class="p">(</span><span class="s">&quot;ufstype=old</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">uspi</span><span class="o">-&gt;</span><span class="n">s_fsize</span> <span class="o">=</span> <span class="n">block_size</span> <span class="o">=</span> <span class="mi">1024</span><span class="p">;</span>
		<span class="n">uspi</span><span class="o">-&gt;</span><span class="n">s_fmask</span> <span class="o">=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1024</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">uspi</span><span class="o">-&gt;</span><span class="n">s_fshift</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
		<span class="n">uspi</span><span class="o">-&gt;</span><span class="n">s_sbsize</span> <span class="o">=</span> <span class="n">super_block_size</span> <span class="o">=</span> <span class="mi">2048</span><span class="p">;</span>
		<span class="n">uspi</span><span class="o">-&gt;</span><span class="n">s_sbbase</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">flags</span> <span class="o">|=</span> <span class="n">UFS_DE_OLD</span> <span class="o">|</span> <span class="n">UFS_UID_OLD</span> <span class="o">|</span> <span class="n">UFS_ST_OLD</span> <span class="o">|</span> <span class="n">UFS_CG_OLD</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_flags</span> <span class="o">&amp;</span> <span class="n">MS_RDONLY</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">silent</span><span class="p">)</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;ufstype=old is supported read-only</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_flags</span> <span class="o">|=</span> <span class="n">MS_RDONLY</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	
	<span class="k">case</span> <span class="n">UFS_MOUNT_UFSTYPE_NEXTSTEP</span>:
		<span class="n">UFSD</span><span class="p">(</span><span class="s">&quot;ufstype=nextstep</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">uspi</span><span class="o">-&gt;</span><span class="n">s_fsize</span> <span class="o">=</span> <span class="n">block_size</span> <span class="o">=</span> <span class="mi">1024</span><span class="p">;</span>
		<span class="n">uspi</span><span class="o">-&gt;</span><span class="n">s_fmask</span> <span class="o">=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1024</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">uspi</span><span class="o">-&gt;</span><span class="n">s_fshift</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
		<span class="n">uspi</span><span class="o">-&gt;</span><span class="n">s_sbsize</span> <span class="o">=</span> <span class="n">super_block_size</span> <span class="o">=</span> <span class="mi">2048</span><span class="p">;</span>
		<span class="n">uspi</span><span class="o">-&gt;</span><span class="n">s_sbbase</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">uspi</span><span class="o">-&gt;</span><span class="n">s_dirblksize</span> <span class="o">=</span> <span class="mi">1024</span><span class="p">;</span>
		<span class="n">flags</span> <span class="o">|=</span> <span class="n">UFS_DE_OLD</span> <span class="o">|</span> <span class="n">UFS_UID_OLD</span> <span class="o">|</span> <span class="n">UFS_ST_OLD</span> <span class="o">|</span> <span class="n">UFS_CG_OLD</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_flags</span> <span class="o">&amp;</span> <span class="n">MS_RDONLY</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">silent</span><span class="p">)</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;ufstype=nextstep is supported read-only</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_flags</span> <span class="o">|=</span> <span class="n">MS_RDONLY</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	
	<span class="k">case</span> <span class="n">UFS_MOUNT_UFSTYPE_NEXTSTEP_CD</span>:
		<span class="n">UFSD</span><span class="p">(</span><span class="s">&quot;ufstype=nextstep-cd</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">uspi</span><span class="o">-&gt;</span><span class="n">s_fsize</span> <span class="o">=</span> <span class="n">block_size</span> <span class="o">=</span> <span class="mi">2048</span><span class="p">;</span>
		<span class="n">uspi</span><span class="o">-&gt;</span><span class="n">s_fmask</span> <span class="o">=</span> <span class="o">~</span><span class="p">(</span><span class="mi">2048</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">uspi</span><span class="o">-&gt;</span><span class="n">s_fshift</span> <span class="o">=</span> <span class="mi">11</span><span class="p">;</span>
		<span class="n">uspi</span><span class="o">-&gt;</span><span class="n">s_sbsize</span> <span class="o">=</span> <span class="n">super_block_size</span> <span class="o">=</span> <span class="mi">2048</span><span class="p">;</span>
		<span class="n">uspi</span><span class="o">-&gt;</span><span class="n">s_sbbase</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">uspi</span><span class="o">-&gt;</span><span class="n">s_dirblksize</span> <span class="o">=</span> <span class="mi">1024</span><span class="p">;</span>
		<span class="n">flags</span> <span class="o">|=</span> <span class="n">UFS_DE_OLD</span> <span class="o">|</span> <span class="n">UFS_UID_OLD</span> <span class="o">|</span> <span class="n">UFS_ST_OLD</span> <span class="o">|</span> <span class="n">UFS_CG_OLD</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_flags</span> <span class="o">&amp;</span> <span class="n">MS_RDONLY</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">silent</span><span class="p">)</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;ufstype=nextstep-cd is supported read-only</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_flags</span> <span class="o">|=</span> <span class="n">MS_RDONLY</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	
	<span class="k">case</span> <span class="n">UFS_MOUNT_UFSTYPE_OPENSTEP</span>:
		<span class="n">UFSD</span><span class="p">(</span><span class="s">&quot;ufstype=openstep</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">uspi</span><span class="o">-&gt;</span><span class="n">s_fsize</span> <span class="o">=</span> <span class="n">block_size</span> <span class="o">=</span> <span class="mi">1024</span><span class="p">;</span>
		<span class="n">uspi</span><span class="o">-&gt;</span><span class="n">s_fmask</span> <span class="o">=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1024</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">uspi</span><span class="o">-&gt;</span><span class="n">s_fshift</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
		<span class="n">uspi</span><span class="o">-&gt;</span><span class="n">s_sbsize</span> <span class="o">=</span> <span class="n">super_block_size</span> <span class="o">=</span> <span class="mi">2048</span><span class="p">;</span>
		<span class="n">uspi</span><span class="o">-&gt;</span><span class="n">s_sbbase</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">uspi</span><span class="o">-&gt;</span><span class="n">s_dirblksize</span> <span class="o">=</span> <span class="mi">1024</span><span class="p">;</span>
		<span class="n">flags</span> <span class="o">|=</span> <span class="n">UFS_DE_44BSD</span> <span class="o">|</span> <span class="n">UFS_UID_44BSD</span> <span class="o">|</span> <span class="n">UFS_ST_44BSD</span> <span class="o">|</span> <span class="n">UFS_CG_44BSD</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_flags</span> <span class="o">&amp;</span> <span class="n">MS_RDONLY</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">silent</span><span class="p">)</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;ufstype=openstep is supported read-only</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_flags</span> <span class="o">|=</span> <span class="n">MS_RDONLY</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	
	<span class="k">case</span> <span class="n">UFS_MOUNT_UFSTYPE_HP</span>:
		<span class="n">UFSD</span><span class="p">(</span><span class="s">&quot;ufstype=hp</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">uspi</span><span class="o">-&gt;</span><span class="n">s_fsize</span> <span class="o">=</span> <span class="n">block_size</span> <span class="o">=</span> <span class="mi">1024</span><span class="p">;</span>
		<span class="n">uspi</span><span class="o">-&gt;</span><span class="n">s_fmask</span> <span class="o">=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1024</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">uspi</span><span class="o">-&gt;</span><span class="n">s_fshift</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
		<span class="n">uspi</span><span class="o">-&gt;</span><span class="n">s_sbsize</span> <span class="o">=</span> <span class="n">super_block_size</span> <span class="o">=</span> <span class="mi">2048</span><span class="p">;</span>
		<span class="n">uspi</span><span class="o">-&gt;</span><span class="n">s_sbbase</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">flags</span> <span class="o">|=</span> <span class="n">UFS_DE_OLD</span> <span class="o">|</span> <span class="n">UFS_UID_OLD</span> <span class="o">|</span> <span class="n">UFS_ST_OLD</span> <span class="o">|</span> <span class="n">UFS_CG_OLD</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_flags</span> <span class="o">&amp;</span> <span class="n">MS_RDONLY</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">silent</span><span class="p">)</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;ufstype=hp is supported read-only</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_flags</span> <span class="o">|=</span> <span class="n">MS_RDONLY</span><span class="p">;</span>
 		<span class="p">}</span>
 		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">silent</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;unknown ufstype</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">failed</span><span class="p">;</span>
	<span class="p">}</span>
	
<span class="nl">again:</span>	
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sb_set_blocksize</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">block_size</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;UFS: failed to set blocksize</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">failed</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * read ufs super block from device</span>
<span class="cm">	 */</span>

	<span class="n">ubh</span> <span class="o">=</span> <span class="n">ubh_bread_uspi</span><span class="p">(</span><span class="n">uspi</span><span class="p">,</span> <span class="n">sb</span><span class="p">,</span> <span class="n">uspi</span><span class="o">-&gt;</span><span class="n">s_sbbase</span> <span class="o">+</span> <span class="n">super_block_offset</span><span class="o">/</span><span class="n">block_size</span><span class="p">,</span> <span class="n">super_block_size</span><span class="p">);</span>
	
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ubh</span><span class="p">)</span> 
            <span class="k">goto</span> <span class="n">failed</span><span class="p">;</span>

	<span class="n">usb1</span> <span class="o">=</span> <span class="n">ubh_get_usb_first</span><span class="p">(</span><span class="n">uspi</span><span class="p">);</span>
	<span class="n">usb2</span> <span class="o">=</span> <span class="n">ubh_get_usb_second</span><span class="p">(</span><span class="n">uspi</span><span class="p">);</span>
	<span class="n">usb3</span> <span class="o">=</span> <span class="n">ubh_get_usb_third</span><span class="p">(</span><span class="n">uspi</span><span class="p">);</span>

	<span class="cm">/* Sort out mod used on SunOS 4.1.3 for fs_state */</span>
	<span class="n">uspi</span><span class="o">-&gt;</span><span class="n">s_postblformat</span> <span class="o">=</span> <span class="n">fs32_to_cpu</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">usb3</span><span class="o">-&gt;</span><span class="n">fs_postblformat</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(((</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">UFS_ST_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="n">UFS_ST_SUNOS</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">uspi</span><span class="o">-&gt;</span><span class="n">s_postblformat</span> <span class="o">!=</span> <span class="n">UFS_42POSTBLFMT</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">UFS_ST_MASK</span><span class="p">;</span>
		<span class="n">flags</span> <span class="o">|=</span>  <span class="n">UFS_ST_SUN</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Check ufs magic number</span>
<span class="cm">	 */</span>
	<span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_bytesex</span> <span class="o">=</span> <span class="n">BYTESEX_LE</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">((</span><span class="n">uspi</span><span class="o">-&gt;</span><span class="n">fs_magic</span> <span class="o">=</span> <span class="n">fs32_to_cpu</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">usb3</span><span class="o">-&gt;</span><span class="n">fs_magic</span><span class="p">)))</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">UFS_MAGIC</span>:
		<span class="k">case</span> <span class="n">UFS_MAGIC_BW</span>:
		<span class="k">case</span> <span class="n">UFS2_MAGIC</span>:
		<span class="k">case</span> <span class="n">UFS_MAGIC_LFN</span>:
	        <span class="k">case</span> <span class="n">UFS_MAGIC_FEA</span>:
	        <span class="k">case</span> <span class="n">UFS_MAGIC_4GB</span>:
			<span class="k">goto</span> <span class="n">magic_found</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_bytesex</span> <span class="o">=</span> <span class="n">BYTESEX_BE</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">((</span><span class="n">uspi</span><span class="o">-&gt;</span><span class="n">fs_magic</span> <span class="o">=</span> <span class="n">fs32_to_cpu</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">usb3</span><span class="o">-&gt;</span><span class="n">fs_magic</span><span class="p">)))</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">UFS_MAGIC</span>:
		<span class="k">case</span> <span class="n">UFS_MAGIC_BW</span>:
		<span class="k">case</span> <span class="n">UFS2_MAGIC</span>:
		<span class="k">case</span> <span class="n">UFS_MAGIC_LFN</span>:
	        <span class="k">case</span> <span class="n">UFS_MAGIC_FEA</span>:
	        <span class="k">case</span> <span class="n">UFS_MAGIC_4GB</span>:
			<span class="k">goto</span> <span class="n">magic_found</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((((</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_mount_opt</span> <span class="o">&amp;</span> <span class="n">UFS_MOUNT_UFSTYPE</span><span class="p">)</span> <span class="o">==</span> <span class="n">UFS_MOUNT_UFSTYPE_NEXTSTEP</span><span class="p">)</span> 
	  <span class="o">||</span> <span class="p">((</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_mount_opt</span> <span class="o">&amp;</span> <span class="n">UFS_MOUNT_UFSTYPE</span><span class="p">)</span> <span class="o">==</span> <span class="n">UFS_MOUNT_UFSTYPE_NEXTSTEP_CD</span><span class="p">)</span> 
	  <span class="o">||</span> <span class="p">((</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_mount_opt</span> <span class="o">&amp;</span> <span class="n">UFS_MOUNT_UFSTYPE</span><span class="p">)</span> <span class="o">==</span> <span class="n">UFS_MOUNT_UFSTYPE_OPENSTEP</span><span class="p">))</span> 
	  <span class="o">&amp;&amp;</span> <span class="n">uspi</span><span class="o">-&gt;</span><span class="n">s_sbbase</span> <span class="o">&lt;</span> <span class="mi">256</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ubh_brelse_uspi</span><span class="p">(</span><span class="n">uspi</span><span class="p">);</span>
		<span class="n">ubh</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">uspi</span><span class="o">-&gt;</span><span class="n">s_sbbase</span> <span class="o">+=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">again</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">silent</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;ufs_read_super: bad magic number</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">goto</span> <span class="n">failed</span><span class="p">;</span>

<span class="nl">magic_found:</span>
	<span class="cm">/*</span>
<span class="cm">	 * Check block and fragment sizes</span>
<span class="cm">	 */</span>
	<span class="n">uspi</span><span class="o">-&gt;</span><span class="n">s_bsize</span> <span class="o">=</span> <span class="n">fs32_to_cpu</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">usb1</span><span class="o">-&gt;</span><span class="n">fs_bsize</span><span class="p">);</span>
	<span class="n">uspi</span><span class="o">-&gt;</span><span class="n">s_fsize</span> <span class="o">=</span> <span class="n">fs32_to_cpu</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">usb1</span><span class="o">-&gt;</span><span class="n">fs_fsize</span><span class="p">);</span>
	<span class="n">uspi</span><span class="o">-&gt;</span><span class="n">s_sbsize</span> <span class="o">=</span> <span class="n">fs32_to_cpu</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">usb1</span><span class="o">-&gt;</span><span class="n">fs_sbsize</span><span class="p">);</span>
	<span class="n">uspi</span><span class="o">-&gt;</span><span class="n">s_fmask</span> <span class="o">=</span> <span class="n">fs32_to_cpu</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">usb1</span><span class="o">-&gt;</span><span class="n">fs_fmask</span><span class="p">);</span>
	<span class="n">uspi</span><span class="o">-&gt;</span><span class="n">s_fshift</span> <span class="o">=</span> <span class="n">fs32_to_cpu</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">usb1</span><span class="o">-&gt;</span><span class="n">fs_fshift</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_power_of_2</span><span class="p">(</span><span class="n">uspi</span><span class="o">-&gt;</span><span class="n">s_fsize</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;ufs_read_super: fragment size %u is not a power of 2</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">uspi</span><span class="o">-&gt;</span><span class="n">s_fsize</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">failed</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">uspi</span><span class="o">-&gt;</span><span class="n">s_fsize</span> <span class="o">&lt;</span> <span class="mi">512</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;ufs_read_super: fragment size %u is too small</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">uspi</span><span class="o">-&gt;</span><span class="n">s_fsize</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">failed</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">uspi</span><span class="o">-&gt;</span><span class="n">s_fsize</span> <span class="o">&gt;</span> <span class="mi">4096</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;ufs_read_super: fragment size %u is too large</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">uspi</span><span class="o">-&gt;</span><span class="n">s_fsize</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">failed</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_power_of_2</span><span class="p">(</span><span class="n">uspi</span><span class="o">-&gt;</span><span class="n">s_bsize</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;ufs_read_super: block size %u is not a power of 2</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">uspi</span><span class="o">-&gt;</span><span class="n">s_bsize</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">failed</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">uspi</span><span class="o">-&gt;</span><span class="n">s_bsize</span> <span class="o">&lt;</span> <span class="mi">4096</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;ufs_read_super: block size %u is too small</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">uspi</span><span class="o">-&gt;</span><span class="n">s_bsize</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">failed</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">uspi</span><span class="o">-&gt;</span><span class="n">s_bsize</span> <span class="o">/</span> <span class="n">uspi</span><span class="o">-&gt;</span><span class="n">s_fsize</span> <span class="o">&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;ufs_read_super: too many fragments per block (%u)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">uspi</span><span class="o">-&gt;</span><span class="n">s_bsize</span> <span class="o">/</span> <span class="n">uspi</span><span class="o">-&gt;</span><span class="n">s_fsize</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">failed</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">uspi</span><span class="o">-&gt;</span><span class="n">s_fsize</span> <span class="o">!=</span> <span class="n">block_size</span> <span class="o">||</span> <span class="n">uspi</span><span class="o">-&gt;</span><span class="n">s_sbsize</span> <span class="o">!=</span> <span class="n">super_block_size</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ubh_brelse_uspi</span><span class="p">(</span><span class="n">uspi</span><span class="p">);</span>
		<span class="n">ubh</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">block_size</span> <span class="o">=</span> <span class="n">uspi</span><span class="o">-&gt;</span><span class="n">s_fsize</span><span class="p">;</span>
		<span class="n">super_block_size</span> <span class="o">=</span> <span class="n">uspi</span><span class="o">-&gt;</span><span class="n">s_sbsize</span><span class="p">;</span>
		<span class="n">UFSD</span><span class="p">(</span><span class="s">&quot;another value of block_size or super_block_size %u, %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">block_size</span><span class="p">,</span> <span class="n">super_block_size</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">again</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_flags</span> <span class="o">=</span> <span class="n">flags</span><span class="p">;</span><span class="cm">/*after that line some functions use s_flags*/</span>
	<span class="n">ufs_print_super_stuff</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">usb1</span><span class="p">,</span> <span class="n">usb2</span><span class="p">,</span> <span class="n">usb3</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Check, if file system was correctly unmounted.</span>
<span class="cm">	 * If not, make it read only.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(((</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">UFS_ST_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="n">UFS_ST_44BSD</span><span class="p">)</span> <span class="o">||</span>
	  <span class="p">((</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">UFS_ST_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="n">UFS_ST_OLD</span><span class="p">)</span> <span class="o">||</span>
	  <span class="p">(((</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">UFS_ST_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="n">UFS_ST_SUN</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">UFS_ST_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="n">UFS_ST_SUNOS</span> <span class="o">||</span>
	  <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">UFS_ST_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="n">UFS_ST_SUNx86</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	  <span class="p">(</span><span class="n">ufs_get_fs_state</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">usb1</span><span class="p">,</span> <span class="n">usb3</span><span class="p">)</span> <span class="o">==</span> <span class="p">(</span><span class="n">UFS_FSOK</span> <span class="o">-</span> <span class="n">fs32_to_cpu</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">usb1</span><span class="o">-&gt;</span><span class="n">fs_time</span><span class="p">)))))</span> <span class="p">{</span>
		<span class="k">switch</span><span class="p">(</span><span class="n">usb1</span><span class="o">-&gt;</span><span class="n">fs_clean</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">UFS_FSCLEAN</span>:
			<span class="n">UFSD</span><span class="p">(</span><span class="s">&quot;fs is clean</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">UFS_FSSTABLE</span>:
			<span class="n">UFSD</span><span class="p">(</span><span class="s">&quot;fs is stable</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">UFS_FSLOG</span>:
			<span class="n">UFSD</span><span class="p">(</span><span class="s">&quot;fs is logging fs</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">UFS_FSOSF1</span>:
			<span class="n">UFSD</span><span class="p">(</span><span class="s">&quot;fs is DEC OSF/1</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">UFS_FSACTIVE</span>:
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;ufs_read_super: fs is active</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_flags</span> <span class="o">|=</span> <span class="n">MS_RDONLY</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">UFS_FSBAD</span>:
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;ufs_read_super: fs is bad</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_flags</span> <span class="o">|=</span> <span class="n">MS_RDONLY</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;ufs_read_super: can&#39;t grok fs_clean 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">usb1</span><span class="o">-&gt;</span><span class="n">fs_clean</span><span class="p">);</span>
			<span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_flags</span> <span class="o">|=</span> <span class="n">MS_RDONLY</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;ufs_read_super: fs needs fsck</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_flags</span> <span class="o">|=</span> <span class="n">MS_RDONLY</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Read ufs_super_block into internal data structures</span>
<span class="cm">	 */</span>
	<span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_op</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ufs_super_ops</span><span class="p">;</span>
	<span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_export_op</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ufs_export_ops</span><span class="p">;</span>

	<span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_magic</span> <span class="o">=</span> <span class="n">fs32_to_cpu</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">usb3</span><span class="o">-&gt;</span><span class="n">fs_magic</span><span class="p">);</span>

	<span class="n">uspi</span><span class="o">-&gt;</span><span class="n">s_sblkno</span> <span class="o">=</span> <span class="n">fs32_to_cpu</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">usb1</span><span class="o">-&gt;</span><span class="n">fs_sblkno</span><span class="p">);</span>
	<span class="n">uspi</span><span class="o">-&gt;</span><span class="n">s_cblkno</span> <span class="o">=</span> <span class="n">fs32_to_cpu</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">usb1</span><span class="o">-&gt;</span><span class="n">fs_cblkno</span><span class="p">);</span>
	<span class="n">uspi</span><span class="o">-&gt;</span><span class="n">s_iblkno</span> <span class="o">=</span> <span class="n">fs32_to_cpu</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">usb1</span><span class="o">-&gt;</span><span class="n">fs_iblkno</span><span class="p">);</span>
	<span class="n">uspi</span><span class="o">-&gt;</span><span class="n">s_dblkno</span> <span class="o">=</span> <span class="n">fs32_to_cpu</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">usb1</span><span class="o">-&gt;</span><span class="n">fs_dblkno</span><span class="p">);</span>
	<span class="n">uspi</span><span class="o">-&gt;</span><span class="n">s_cgoffset</span> <span class="o">=</span> <span class="n">fs32_to_cpu</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">usb1</span><span class="o">-&gt;</span><span class="n">fs_cgoffset</span><span class="p">);</span>
	<span class="n">uspi</span><span class="o">-&gt;</span><span class="n">s_cgmask</span> <span class="o">=</span> <span class="n">fs32_to_cpu</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">usb1</span><span class="o">-&gt;</span><span class="n">fs_cgmask</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">UFS_TYPE_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="n">UFS_TYPE_UFS2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">uspi</span><span class="o">-&gt;</span><span class="n">s_u2_size</span>  <span class="o">=</span> <span class="n">fs64_to_cpu</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">usb3</span><span class="o">-&gt;</span><span class="n">fs_un1</span><span class="p">.</span><span class="n">fs_u2</span><span class="p">.</span><span class="n">fs_size</span><span class="p">);</span>
		<span class="n">uspi</span><span class="o">-&gt;</span><span class="n">s_u2_dsize</span> <span class="o">=</span> <span class="n">fs64_to_cpu</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">usb3</span><span class="o">-&gt;</span><span class="n">fs_un1</span><span class="p">.</span><span class="n">fs_u2</span><span class="p">.</span><span class="n">fs_dsize</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">uspi</span><span class="o">-&gt;</span><span class="n">s_size</span>  <span class="o">=</span>  <span class="n">fs32_to_cpu</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">usb1</span><span class="o">-&gt;</span><span class="n">fs_size</span><span class="p">);</span>
		<span class="n">uspi</span><span class="o">-&gt;</span><span class="n">s_dsize</span> <span class="o">=</span>  <span class="n">fs32_to_cpu</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">usb1</span><span class="o">-&gt;</span><span class="n">fs_dsize</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">uspi</span><span class="o">-&gt;</span><span class="n">s_ncg</span> <span class="o">=</span> <span class="n">fs32_to_cpu</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">usb1</span><span class="o">-&gt;</span><span class="n">fs_ncg</span><span class="p">);</span>
	<span class="cm">/* s_bsize already set */</span>
	<span class="cm">/* s_fsize already set */</span>
	<span class="n">uspi</span><span class="o">-&gt;</span><span class="n">s_fpb</span> <span class="o">=</span> <span class="n">fs32_to_cpu</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">usb1</span><span class="o">-&gt;</span><span class="n">fs_frag</span><span class="p">);</span>
	<span class="n">uspi</span><span class="o">-&gt;</span><span class="n">s_minfree</span> <span class="o">=</span> <span class="n">fs32_to_cpu</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">usb1</span><span class="o">-&gt;</span><span class="n">fs_minfree</span><span class="p">);</span>
	<span class="n">uspi</span><span class="o">-&gt;</span><span class="n">s_bmask</span> <span class="o">=</span> <span class="n">fs32_to_cpu</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">usb1</span><span class="o">-&gt;</span><span class="n">fs_bmask</span><span class="p">);</span>
	<span class="n">uspi</span><span class="o">-&gt;</span><span class="n">s_fmask</span> <span class="o">=</span> <span class="n">fs32_to_cpu</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">usb1</span><span class="o">-&gt;</span><span class="n">fs_fmask</span><span class="p">);</span>
	<span class="n">uspi</span><span class="o">-&gt;</span><span class="n">s_bshift</span> <span class="o">=</span> <span class="n">fs32_to_cpu</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">usb1</span><span class="o">-&gt;</span><span class="n">fs_bshift</span><span class="p">);</span>
	<span class="n">uspi</span><span class="o">-&gt;</span><span class="n">s_fshift</span> <span class="o">=</span> <span class="n">fs32_to_cpu</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">usb1</span><span class="o">-&gt;</span><span class="n">fs_fshift</span><span class="p">);</span>
	<span class="n">UFSD</span><span class="p">(</span><span class="s">&quot;uspi-&gt;s_bshift = %d,uspi-&gt;s_fshift = %d&quot;</span><span class="p">,</span> <span class="n">uspi</span><span class="o">-&gt;</span><span class="n">s_bshift</span><span class="p">,</span>
		<span class="n">uspi</span><span class="o">-&gt;</span><span class="n">s_fshift</span><span class="p">);</span>
	<span class="n">uspi</span><span class="o">-&gt;</span><span class="n">s_fpbshift</span> <span class="o">=</span> <span class="n">fs32_to_cpu</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">usb1</span><span class="o">-&gt;</span><span class="n">fs_fragshift</span><span class="p">);</span>
	<span class="n">uspi</span><span class="o">-&gt;</span><span class="n">s_fsbtodb</span> <span class="o">=</span> <span class="n">fs32_to_cpu</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">usb1</span><span class="o">-&gt;</span><span class="n">fs_fsbtodb</span><span class="p">);</span>
	<span class="cm">/* s_sbsize already set */</span>
	<span class="n">uspi</span><span class="o">-&gt;</span><span class="n">s_csmask</span> <span class="o">=</span> <span class="n">fs32_to_cpu</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">usb1</span><span class="o">-&gt;</span><span class="n">fs_csmask</span><span class="p">);</span>
	<span class="n">uspi</span><span class="o">-&gt;</span><span class="n">s_csshift</span> <span class="o">=</span> <span class="n">fs32_to_cpu</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">usb1</span><span class="o">-&gt;</span><span class="n">fs_csshift</span><span class="p">);</span>
	<span class="n">uspi</span><span class="o">-&gt;</span><span class="n">s_nindir</span> <span class="o">=</span> <span class="n">fs32_to_cpu</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">usb1</span><span class="o">-&gt;</span><span class="n">fs_nindir</span><span class="p">);</span>
	<span class="n">uspi</span><span class="o">-&gt;</span><span class="n">s_inopb</span> <span class="o">=</span> <span class="n">fs32_to_cpu</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">usb1</span><span class="o">-&gt;</span><span class="n">fs_inopb</span><span class="p">);</span>
	<span class="n">uspi</span><span class="o">-&gt;</span><span class="n">s_nspf</span> <span class="o">=</span> <span class="n">fs32_to_cpu</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">usb1</span><span class="o">-&gt;</span><span class="n">fs_nspf</span><span class="p">);</span>
	<span class="n">uspi</span><span class="o">-&gt;</span><span class="n">s_npsect</span> <span class="o">=</span> <span class="n">ufs_get_fs_npsect</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">usb1</span><span class="p">,</span> <span class="n">usb3</span><span class="p">);</span>
	<span class="n">uspi</span><span class="o">-&gt;</span><span class="n">s_interleave</span> <span class="o">=</span> <span class="n">fs32_to_cpu</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">usb1</span><span class="o">-&gt;</span><span class="n">fs_interleave</span><span class="p">);</span>
	<span class="n">uspi</span><span class="o">-&gt;</span><span class="n">s_trackskew</span> <span class="o">=</span> <span class="n">fs32_to_cpu</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">usb1</span><span class="o">-&gt;</span><span class="n">fs_trackskew</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">uspi</span><span class="o">-&gt;</span><span class="n">fs_magic</span> <span class="o">==</span> <span class="n">UFS2_MAGIC</span><span class="p">)</span>
		<span class="n">uspi</span><span class="o">-&gt;</span><span class="n">s_csaddr</span> <span class="o">=</span> <span class="n">fs64_to_cpu</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">usb3</span><span class="o">-&gt;</span><span class="n">fs_un1</span><span class="p">.</span><span class="n">fs_u2</span><span class="p">.</span><span class="n">fs_csaddr</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">uspi</span><span class="o">-&gt;</span><span class="n">s_csaddr</span> <span class="o">=</span> <span class="n">fs32_to_cpu</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">usb1</span><span class="o">-&gt;</span><span class="n">fs_csaddr</span><span class="p">);</span>

	<span class="n">uspi</span><span class="o">-&gt;</span><span class="n">s_cssize</span> <span class="o">=</span> <span class="n">fs32_to_cpu</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">usb1</span><span class="o">-&gt;</span><span class="n">fs_cssize</span><span class="p">);</span>
	<span class="n">uspi</span><span class="o">-&gt;</span><span class="n">s_cgsize</span> <span class="o">=</span> <span class="n">fs32_to_cpu</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">usb1</span><span class="o">-&gt;</span><span class="n">fs_cgsize</span><span class="p">);</span>
	<span class="n">uspi</span><span class="o">-&gt;</span><span class="n">s_ntrak</span> <span class="o">=</span> <span class="n">fs32_to_cpu</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">usb1</span><span class="o">-&gt;</span><span class="n">fs_ntrak</span><span class="p">);</span>
	<span class="n">uspi</span><span class="o">-&gt;</span><span class="n">s_nsect</span> <span class="o">=</span> <span class="n">fs32_to_cpu</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">usb1</span><span class="o">-&gt;</span><span class="n">fs_nsect</span><span class="p">);</span>
	<span class="n">uspi</span><span class="o">-&gt;</span><span class="n">s_spc</span> <span class="o">=</span> <span class="n">fs32_to_cpu</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">usb1</span><span class="o">-&gt;</span><span class="n">fs_spc</span><span class="p">);</span>
	<span class="n">uspi</span><span class="o">-&gt;</span><span class="n">s_ipg</span> <span class="o">=</span> <span class="n">fs32_to_cpu</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">usb1</span><span class="o">-&gt;</span><span class="n">fs_ipg</span><span class="p">);</span>
	<span class="n">uspi</span><span class="o">-&gt;</span><span class="n">s_fpg</span> <span class="o">=</span> <span class="n">fs32_to_cpu</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">usb1</span><span class="o">-&gt;</span><span class="n">fs_fpg</span><span class="p">);</span>
	<span class="n">uspi</span><span class="o">-&gt;</span><span class="n">s_cpc</span> <span class="o">=</span> <span class="n">fs32_to_cpu</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">usb2</span><span class="o">-&gt;</span><span class="n">fs_un</span><span class="p">.</span><span class="n">fs_u1</span><span class="p">.</span><span class="n">fs_cpc</span><span class="p">);</span>
	<span class="n">uspi</span><span class="o">-&gt;</span><span class="n">s_contigsumsize</span> <span class="o">=</span> <span class="n">fs32_to_cpu</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">usb3</span><span class="o">-&gt;</span><span class="n">fs_un2</span><span class="p">.</span><span class="n">fs_44</span><span class="p">.</span><span class="n">fs_contigsumsize</span><span class="p">);</span>
	<span class="n">uspi</span><span class="o">-&gt;</span><span class="n">s_qbmask</span> <span class="o">=</span> <span class="n">ufs_get_fs_qbmask</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">usb3</span><span class="p">);</span>
	<span class="n">uspi</span><span class="o">-&gt;</span><span class="n">s_qfmask</span> <span class="o">=</span> <span class="n">ufs_get_fs_qfmask</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">usb3</span><span class="p">);</span>
	<span class="n">uspi</span><span class="o">-&gt;</span><span class="n">s_nrpos</span> <span class="o">=</span> <span class="n">fs32_to_cpu</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">usb3</span><span class="o">-&gt;</span><span class="n">fs_nrpos</span><span class="p">);</span>
	<span class="n">uspi</span><span class="o">-&gt;</span><span class="n">s_postbloff</span> <span class="o">=</span> <span class="n">fs32_to_cpu</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">usb3</span><span class="o">-&gt;</span><span class="n">fs_postbloff</span><span class="p">);</span>
	<span class="n">uspi</span><span class="o">-&gt;</span><span class="n">s_rotbloff</span> <span class="o">=</span> <span class="n">fs32_to_cpu</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">usb3</span><span class="o">-&gt;</span><span class="n">fs_rotbloff</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Compute another frequently used values</span>
<span class="cm">	 */</span>
	<span class="n">uspi</span><span class="o">-&gt;</span><span class="n">s_fpbmask</span> <span class="o">=</span> <span class="n">uspi</span><span class="o">-&gt;</span><span class="n">s_fpb</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">UFS_TYPE_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="n">UFS_TYPE_UFS2</span><span class="p">)</span>
		<span class="n">uspi</span><span class="o">-&gt;</span><span class="n">s_apbshift</span> <span class="o">=</span> <span class="n">uspi</span><span class="o">-&gt;</span><span class="n">s_bshift</span> <span class="o">-</span> <span class="mi">3</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">uspi</span><span class="o">-&gt;</span><span class="n">s_apbshift</span> <span class="o">=</span> <span class="n">uspi</span><span class="o">-&gt;</span><span class="n">s_bshift</span> <span class="o">-</span> <span class="mi">2</span><span class="p">;</span>

	<span class="n">uspi</span><span class="o">-&gt;</span><span class="n">s_2apbshift</span> <span class="o">=</span> <span class="n">uspi</span><span class="o">-&gt;</span><span class="n">s_apbshift</span> <span class="o">*</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">uspi</span><span class="o">-&gt;</span><span class="n">s_3apbshift</span> <span class="o">=</span> <span class="n">uspi</span><span class="o">-&gt;</span><span class="n">s_apbshift</span> <span class="o">*</span> <span class="mi">3</span><span class="p">;</span>
	<span class="n">uspi</span><span class="o">-&gt;</span><span class="n">s_apb</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">uspi</span><span class="o">-&gt;</span><span class="n">s_apbshift</span><span class="p">;</span>
	<span class="n">uspi</span><span class="o">-&gt;</span><span class="n">s_2apb</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">uspi</span><span class="o">-&gt;</span><span class="n">s_2apbshift</span><span class="p">;</span>
	<span class="n">uspi</span><span class="o">-&gt;</span><span class="n">s_3apb</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">uspi</span><span class="o">-&gt;</span><span class="n">s_3apbshift</span><span class="p">;</span>
	<span class="n">uspi</span><span class="o">-&gt;</span><span class="n">s_apbmask</span> <span class="o">=</span> <span class="n">uspi</span><span class="o">-&gt;</span><span class="n">s_apb</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">uspi</span><span class="o">-&gt;</span><span class="n">s_nspfshift</span> <span class="o">=</span> <span class="n">uspi</span><span class="o">-&gt;</span><span class="n">s_fshift</span> <span class="o">-</span> <span class="n">UFS_SECTOR_BITS</span><span class="p">;</span>
	<span class="n">uspi</span><span class="o">-&gt;</span><span class="n">s_nspb</span> <span class="o">=</span> <span class="n">uspi</span><span class="o">-&gt;</span><span class="n">s_nspf</span> <span class="o">&lt;&lt;</span> <span class="n">uspi</span><span class="o">-&gt;</span><span class="n">s_fpbshift</span><span class="p">;</span>
	<span class="n">uspi</span><span class="o">-&gt;</span><span class="n">s_inopf</span> <span class="o">=</span> <span class="n">uspi</span><span class="o">-&gt;</span><span class="n">s_inopb</span> <span class="o">&gt;&gt;</span> <span class="n">uspi</span><span class="o">-&gt;</span><span class="n">s_fpbshift</span><span class="p">;</span>
	<span class="n">uspi</span><span class="o">-&gt;</span><span class="n">s_bpf</span> <span class="o">=</span> <span class="n">uspi</span><span class="o">-&gt;</span><span class="n">s_fsize</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">;</span>
	<span class="n">uspi</span><span class="o">-&gt;</span><span class="n">s_bpfshift</span> <span class="o">=</span> <span class="n">uspi</span><span class="o">-&gt;</span><span class="n">s_fshift</span> <span class="o">+</span> <span class="mi">3</span><span class="p">;</span>
	<span class="n">uspi</span><span class="o">-&gt;</span><span class="n">s_bpfmask</span> <span class="o">=</span> <span class="n">uspi</span><span class="o">-&gt;</span><span class="n">s_bpf</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_mount_opt</span> <span class="o">&amp;</span> <span class="n">UFS_MOUNT_UFSTYPE</span><span class="p">)</span> <span class="o">==</span> <span class="n">UFS_MOUNT_UFSTYPE_44BSD</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_mount_opt</span> <span class="o">&amp;</span> <span class="n">UFS_MOUNT_UFSTYPE</span><span class="p">)</span> <span class="o">==</span> <span class="n">UFS_MOUNT_UFSTYPE_UFS2</span><span class="p">)</span>
		<span class="n">uspi</span><span class="o">-&gt;</span><span class="n">s_maxsymlinklen</span> <span class="o">=</span>
		    <span class="n">fs32_to_cpu</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">usb3</span><span class="o">-&gt;</span><span class="n">fs_un2</span><span class="p">.</span><span class="n">fs_44</span><span class="p">.</span><span class="n">fs_maxsymlinklen</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">uspi</span><span class="o">-&gt;</span><span class="n">fs_magic</span> <span class="o">==</span> <span class="n">UFS2_MAGIC</span><span class="p">)</span>
		<span class="n">maxsymlen</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="mi">4</span> <span class="o">*</span> <span class="p">(</span><span class="n">UFS_NDADDR</span> <span class="o">+</span> <span class="n">UFS_NINDIR</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">maxsymlen</span> <span class="o">=</span> <span class="mi">4</span> <span class="o">*</span> <span class="p">(</span><span class="n">UFS_NDADDR</span> <span class="o">+</span> <span class="n">UFS_NINDIR</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">uspi</span><span class="o">-&gt;</span><span class="n">s_maxsymlinklen</span> <span class="o">&gt;</span> <span class="n">maxsymlen</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ufs_warning</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="s">&quot;ufs_read_super: excessive maximum &quot;</span>
			    <span class="s">&quot;fast symlink size (%u)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">uspi</span><span class="o">-&gt;</span><span class="n">s_maxsymlinklen</span><span class="p">);</span>
		<span class="n">uspi</span><span class="o">-&gt;</span><span class="n">s_maxsymlinklen</span> <span class="o">=</span> <span class="n">maxsymlen</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_max_links</span> <span class="o">=</span> <span class="n">UFS_LINK_MAX</span><span class="p">;</span>

	<span class="n">inode</span> <span class="o">=</span> <span class="n">ufs_iget</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">UFS_ROOTINO</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">inode</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">inode</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">failed</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_root</span> <span class="o">=</span> <span class="n">d_make_root</span><span class="p">(</span><span class="n">inode</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_root</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">failed</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ufs_setup_cstotal</span><span class="p">(</span><span class="n">sb</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 * Read cylinder group structures</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_flags</span> <span class="o">&amp;</span> <span class="n">MS_RDONLY</span><span class="p">))</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ufs_read_cylinder_structures</span><span class="p">(</span><span class="n">sb</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">failed</span><span class="p">;</span>

	<span class="n">UFSD</span><span class="p">(</span><span class="s">&quot;EXIT</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">failed:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ubh</span><span class="p">)</span>
		<span class="n">ubh_brelse_uspi</span> <span class="p">(</span><span class="n">uspi</span><span class="p">);</span>
	<span class="n">kfree</span> <span class="p">(</span><span class="n">uspi</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">sbi</span><span class="p">);</span>
	<span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_fs_info</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">UFSD</span><span class="p">(</span><span class="s">&quot;EXIT (FAILED)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

<span class="nl">failed_nomem:</span>
	<span class="n">UFSD</span><span class="p">(</span><span class="s">&quot;EXIT (NOMEM)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ufs_sync_fs</span><span class="p">(</span><span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">sb</span><span class="p">,</span> <span class="kt">int</span> <span class="n">wait</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ufs_sb_private_info</span> <span class="o">*</span> <span class="n">uspi</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ufs_super_block_first</span> <span class="o">*</span> <span class="n">usb1</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ufs_super_block_third</span> <span class="o">*</span> <span class="n">usb3</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">lock_ufs</span><span class="p">(</span><span class="n">sb</span><span class="p">);</span>
	<span class="n">lock_super</span><span class="p">(</span><span class="n">sb</span><span class="p">);</span>

	<span class="n">UFSD</span><span class="p">(</span><span class="s">&quot;ENTER</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">flags</span> <span class="o">=</span> <span class="n">UFS_SB</span><span class="p">(</span><span class="n">sb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">s_flags</span><span class="p">;</span>
	<span class="n">uspi</span> <span class="o">=</span> <span class="n">UFS_SB</span><span class="p">(</span><span class="n">sb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">s_uspi</span><span class="p">;</span>
	<span class="n">usb1</span> <span class="o">=</span> <span class="n">ubh_get_usb_first</span><span class="p">(</span><span class="n">uspi</span><span class="p">);</span>
	<span class="n">usb3</span> <span class="o">=</span> <span class="n">ubh_get_usb_third</span><span class="p">(</span><span class="n">uspi</span><span class="p">);</span>

	<span class="n">usb1</span><span class="o">-&gt;</span><span class="n">fs_time</span> <span class="o">=</span> <span class="n">cpu_to_fs32</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">get_seconds</span><span class="p">());</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">UFS_ST_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="n">UFS_ST_SUN</span>  <span class="o">||</span>
	    <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">UFS_ST_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="n">UFS_ST_SUNOS</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">UFS_ST_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="n">UFS_ST_SUNx86</span><span class="p">)</span>
		<span class="n">ufs_set_fs_state</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">usb1</span><span class="p">,</span> <span class="n">usb3</span><span class="p">,</span>
				<span class="n">UFS_FSOK</span> <span class="o">-</span> <span class="n">fs32_to_cpu</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">usb1</span><span class="o">-&gt;</span><span class="n">fs_time</span><span class="p">));</span>
	<span class="n">ufs_put_cstotal</span><span class="p">(</span><span class="n">sb</span><span class="p">);</span>
	<span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_dirt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">UFSD</span><span class="p">(</span><span class="s">&quot;EXIT</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">unlock_super</span><span class="p">(</span><span class="n">sb</span><span class="p">);</span>
	<span class="n">unlock_ufs</span><span class="p">(</span><span class="n">sb</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ufs_write_super</span><span class="p">(</span><span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">sb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_flags</span> <span class="o">&amp;</span> <span class="n">MS_RDONLY</span><span class="p">))</span>
		<span class="n">ufs_sync_fs</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_dirt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ufs_put_super</span><span class="p">(</span><span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">sb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ufs_sb_info</span> <span class="o">*</span> <span class="n">sbi</span> <span class="o">=</span> <span class="n">UFS_SB</span><span class="p">(</span><span class="n">sb</span><span class="p">);</span>
		
	<span class="n">UFSD</span><span class="p">(</span><span class="s">&quot;ENTER</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_dirt</span><span class="p">)</span>
		<span class="n">ufs_write_super</span><span class="p">(</span><span class="n">sb</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_flags</span> <span class="o">&amp;</span> <span class="n">MS_RDONLY</span><span class="p">))</span>
		<span class="n">ufs_put_super_internal</span><span class="p">(</span><span class="n">sb</span><span class="p">);</span>
	
	<span class="n">ubh_brelse_uspi</span> <span class="p">(</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_uspi</span><span class="p">);</span>
	<span class="n">kfree</span> <span class="p">(</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_uspi</span><span class="p">);</span>
	<span class="n">kfree</span> <span class="p">(</span><span class="n">sbi</span><span class="p">);</span>
	<span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_fs_info</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">UFSD</span><span class="p">(</span><span class="s">&quot;EXIT</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">ufs_remount</span> <span class="p">(</span><span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">sb</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">mount_flags</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ufs_sb_private_info</span> <span class="o">*</span> <span class="n">uspi</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ufs_super_block_first</span> <span class="o">*</span> <span class="n">usb1</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ufs_super_block_third</span> <span class="o">*</span> <span class="n">usb3</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">new_mount_opt</span><span class="p">,</span> <span class="n">ufstype</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">lock_ufs</span><span class="p">(</span><span class="n">sb</span><span class="p">);</span>
	<span class="n">lock_super</span><span class="p">(</span><span class="n">sb</span><span class="p">);</span>
	<span class="n">uspi</span> <span class="o">=</span> <span class="n">UFS_SB</span><span class="p">(</span><span class="n">sb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">s_uspi</span><span class="p">;</span>
	<span class="n">flags</span> <span class="o">=</span> <span class="n">UFS_SB</span><span class="p">(</span><span class="n">sb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">s_flags</span><span class="p">;</span>
	<span class="n">usb1</span> <span class="o">=</span> <span class="n">ubh_get_usb_first</span><span class="p">(</span><span class="n">uspi</span><span class="p">);</span>
	<span class="n">usb3</span> <span class="o">=</span> <span class="n">ubh_get_usb_third</span><span class="p">(</span><span class="n">uspi</span><span class="p">);</span>
	
	<span class="cm">/*</span>
<span class="cm">	 * Allow the &quot;check&quot; option to be passed as a remount option.</span>
<span class="cm">	 * It is not possible to change ufstype option during remount</span>
<span class="cm">	 */</span>
	<span class="n">ufstype</span> <span class="o">=</span> <span class="n">UFS_SB</span><span class="p">(</span><span class="n">sb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">s_mount_opt</span> <span class="o">&amp;</span> <span class="n">UFS_MOUNT_UFSTYPE</span><span class="p">;</span>
	<span class="n">new_mount_opt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ufs_set_opt</span> <span class="p">(</span><span class="n">new_mount_opt</span><span class="p">,</span> <span class="n">ONERROR_LOCK</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ufs_parse_options</span> <span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">new_mount_opt</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">unlock_super</span><span class="p">(</span><span class="n">sb</span><span class="p">);</span>
		<span class="n">unlock_ufs</span><span class="p">(</span><span class="n">sb</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">new_mount_opt</span> <span class="o">&amp;</span> <span class="n">UFS_MOUNT_UFSTYPE</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">new_mount_opt</span> <span class="o">|=</span> <span class="n">ufstype</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">new_mount_opt</span> <span class="o">&amp;</span> <span class="n">UFS_MOUNT_UFSTYPE</span><span class="p">)</span> <span class="o">!=</span> <span class="n">ufstype</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;ufstype can&#39;t be changed during remount</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">unlock_super</span><span class="p">(</span><span class="n">sb</span><span class="p">);</span>
		<span class="n">unlock_ufs</span><span class="p">(</span><span class="n">sb</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="o">*</span><span class="n">mount_flags</span> <span class="o">&amp;</span> <span class="n">MS_RDONLY</span><span class="p">)</span> <span class="o">==</span> <span class="p">(</span><span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_flags</span> <span class="o">&amp;</span> <span class="n">MS_RDONLY</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">UFS_SB</span><span class="p">(</span><span class="n">sb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">s_mount_opt</span> <span class="o">=</span> <span class="n">new_mount_opt</span><span class="p">;</span>
		<span class="n">unlock_super</span><span class="p">(</span><span class="n">sb</span><span class="p">);</span>
		<span class="n">unlock_ufs</span><span class="p">(</span><span class="n">sb</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	
	<span class="cm">/*</span>
<span class="cm">	 * fs was mouted as rw, remounting ro</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">mount_flags</span> <span class="o">&amp;</span> <span class="n">MS_RDONLY</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ufs_put_super_internal</span><span class="p">(</span><span class="n">sb</span><span class="p">);</span>
		<span class="n">usb1</span><span class="o">-&gt;</span><span class="n">fs_time</span> <span class="o">=</span> <span class="n">cpu_to_fs32</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">get_seconds</span><span class="p">());</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">UFS_ST_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="n">UFS_ST_SUN</span>
		  <span class="o">||</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">UFS_ST_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="n">UFS_ST_SUNOS</span>
		  <span class="o">||</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">UFS_ST_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="n">UFS_ST_SUNx86</span><span class="p">)</span> 
			<span class="n">ufs_set_fs_state</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">usb1</span><span class="p">,</span> <span class="n">usb3</span><span class="p">,</span>
				<span class="n">UFS_FSOK</span> <span class="o">-</span> <span class="n">fs32_to_cpu</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">usb1</span><span class="o">-&gt;</span><span class="n">fs_time</span><span class="p">));</span>
		<span class="n">ubh_mark_buffer_dirty</span> <span class="p">(</span><span class="n">USPI_UBH</span><span class="p">(</span><span class="n">uspi</span><span class="p">));</span>
		<span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_dirt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_flags</span> <span class="o">|=</span> <span class="n">MS_RDONLY</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
	<span class="cm">/*</span>
<span class="cm">	 * fs was mounted as ro, remounting rw</span>
<span class="cm">	 */</span>
<span class="cp">#ifndef CONFIG_UFS_FS_WRITE</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;ufs was compiled with read-only support, &quot;</span>
		<span class="s">&quot;can&#39;t be mounted as read-write</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">unlock_super</span><span class="p">(</span><span class="n">sb</span><span class="p">);</span>
		<span class="n">unlock_ufs</span><span class="p">(</span><span class="n">sb</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="cp">#else</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ufstype</span> <span class="o">!=</span> <span class="n">UFS_MOUNT_UFSTYPE_SUN</span> <span class="o">&amp;&amp;</span> 
		    <span class="n">ufstype</span> <span class="o">!=</span> <span class="n">UFS_MOUNT_UFSTYPE_SUNOS</span> <span class="o">&amp;&amp;</span>
		    <span class="n">ufstype</span> <span class="o">!=</span> <span class="n">UFS_MOUNT_UFSTYPE_44BSD</span> <span class="o">&amp;&amp;</span>
		    <span class="n">ufstype</span> <span class="o">!=</span> <span class="n">UFS_MOUNT_UFSTYPE_SUNx86</span> <span class="o">&amp;&amp;</span>
		    <span class="n">ufstype</span> <span class="o">!=</span> <span class="n">UFS_MOUNT_UFSTYPE_UFS2</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;this ufstype is read-only supported</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">unlock_super</span><span class="p">(</span><span class="n">sb</span><span class="p">);</span>
			<span class="n">unlock_ufs</span><span class="p">(</span><span class="n">sb</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ufs_read_cylinder_structures</span><span class="p">(</span><span class="n">sb</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;failed during remounting</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">unlock_super</span><span class="p">(</span><span class="n">sb</span><span class="p">);</span>
			<span class="n">unlock_ufs</span><span class="p">(</span><span class="n">sb</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">MS_RDONLY</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="p">}</span>
	<span class="n">UFS_SB</span><span class="p">(</span><span class="n">sb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">s_mount_opt</span> <span class="o">=</span> <span class="n">new_mount_opt</span><span class="p">;</span>
	<span class="n">unlock_super</span><span class="p">(</span><span class="n">sb</span><span class="p">);</span>
	<span class="n">unlock_ufs</span><span class="p">(</span><span class="n">sb</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ufs_show_options</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">seq</span><span class="p">,</span> <span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="n">root</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ufs_sb_info</span> <span class="o">*</span><span class="n">sbi</span> <span class="o">=</span> <span class="n">UFS_SB</span><span class="p">(</span><span class="n">root</span><span class="o">-&gt;</span><span class="n">d_sb</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="n">mval</span> <span class="o">=</span> <span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_mount_opt</span> <span class="o">&amp;</span> <span class="n">UFS_MOUNT_UFSTYPE</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">match_token</span> <span class="o">*</span><span class="n">tp</span> <span class="o">=</span> <span class="n">tokens</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">token</span> <span class="o">!=</span> <span class="n">Opt_onerror_panic</span> <span class="o">&amp;&amp;</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">token</span> <span class="o">!=</span> <span class="n">mval</span><span class="p">)</span>
		<span class="o">++</span><span class="n">tp</span><span class="p">;</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">token</span> <span class="o">==</span> <span class="n">Opt_onerror_panic</span><span class="p">);</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;,%s&quot;</span><span class="p">,</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">pattern</span><span class="p">);</span>

	<span class="n">mval</span> <span class="o">=</span> <span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_mount_opt</span> <span class="o">&amp;</span> <span class="n">UFS_MOUNT_ONERROR</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">token</span> <span class="o">!=</span> <span class="n">Opt_err</span> <span class="o">&amp;&amp;</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">token</span> <span class="o">!=</span> <span class="n">mval</span><span class="p">)</span>
		<span class="o">++</span><span class="n">tp</span><span class="p">;</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">token</span> <span class="o">==</span> <span class="n">Opt_err</span><span class="p">);</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;,%s&quot;</span><span class="p">,</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">pattern</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ufs_statfs</span><span class="p">(</span><span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="n">dentry</span><span class="p">,</span> <span class="k">struct</span> <span class="n">kstatfs</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">sb</span> <span class="o">=</span> <span class="n">dentry</span><span class="o">-&gt;</span><span class="n">d_sb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ufs_sb_private_info</span> <span class="o">*</span><span class="n">uspi</span><span class="o">=</span> <span class="n">UFS_SB</span><span class="p">(</span><span class="n">sb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">s_uspi</span><span class="p">;</span>
	<span class="kt">unsigned</span>  <span class="n">flags</span> <span class="o">=</span> <span class="n">UFS_SB</span><span class="p">(</span><span class="n">sb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">s_flags</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ufs_super_block_first</span> <span class="o">*</span><span class="n">usb1</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ufs_super_block_second</span> <span class="o">*</span><span class="n">usb2</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ufs_super_block_third</span> <span class="o">*</span><span class="n">usb3</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">id</span> <span class="o">=</span> <span class="n">huge_encode_dev</span><span class="p">(</span><span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_bdev</span><span class="o">-&gt;</span><span class="n">bd_dev</span><span class="p">);</span>

	<span class="n">lock_ufs</span><span class="p">(</span><span class="n">sb</span><span class="p">);</span>

	<span class="n">usb1</span> <span class="o">=</span> <span class="n">ubh_get_usb_first</span><span class="p">(</span><span class="n">uspi</span><span class="p">);</span>
	<span class="n">usb2</span> <span class="o">=</span> <span class="n">ubh_get_usb_second</span><span class="p">(</span><span class="n">uspi</span><span class="p">);</span>
	<span class="n">usb3</span> <span class="o">=</span> <span class="n">ubh_get_usb_third</span><span class="p">(</span><span class="n">uspi</span><span class="p">);</span>
	
	<span class="k">if</span> <span class="p">((</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">UFS_TYPE_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="n">UFS_TYPE_UFS2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">buf</span><span class="o">-&gt;</span><span class="n">f_type</span> <span class="o">=</span> <span class="n">UFS2_MAGIC</span><span class="p">;</span>
		<span class="n">buf</span><span class="o">-&gt;</span><span class="n">f_blocks</span> <span class="o">=</span> <span class="n">fs64_to_cpu</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">usb3</span><span class="o">-&gt;</span><span class="n">fs_un1</span><span class="p">.</span><span class="n">fs_u2</span><span class="p">.</span><span class="n">fs_dsize</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">buf</span><span class="o">-&gt;</span><span class="n">f_type</span> <span class="o">=</span> <span class="n">UFS_MAGIC</span><span class="p">;</span>
		<span class="n">buf</span><span class="o">-&gt;</span><span class="n">f_blocks</span> <span class="o">=</span> <span class="n">uspi</span><span class="o">-&gt;</span><span class="n">s_dsize</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">buf</span><span class="o">-&gt;</span><span class="n">f_bfree</span> <span class="o">=</span> <span class="n">ufs_blkstofrags</span><span class="p">(</span><span class="n">uspi</span><span class="o">-&gt;</span><span class="n">cs_total</span><span class="p">.</span><span class="n">cs_nbfree</span><span class="p">)</span> <span class="o">+</span>
		<span class="n">uspi</span><span class="o">-&gt;</span><span class="n">cs_total</span><span class="p">.</span><span class="n">cs_nffree</span><span class="p">;</span>
	<span class="n">buf</span><span class="o">-&gt;</span><span class="n">f_ffree</span> <span class="o">=</span> <span class="n">uspi</span><span class="o">-&gt;</span><span class="n">cs_total</span><span class="p">.</span><span class="n">cs_nifree</span><span class="p">;</span>
	<span class="n">buf</span><span class="o">-&gt;</span><span class="n">f_bsize</span> <span class="o">=</span> <span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_blocksize</span><span class="p">;</span>
	<span class="n">buf</span><span class="o">-&gt;</span><span class="n">f_bavail</span> <span class="o">=</span> <span class="p">(</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">f_bfree</span> <span class="o">&gt;</span> <span class="p">(((</span><span class="kt">long</span><span class="p">)</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">f_blocks</span> <span class="o">/</span> <span class="mi">100</span><span class="p">)</span> <span class="o">*</span> <span class="n">uspi</span><span class="o">-&gt;</span><span class="n">s_minfree</span><span class="p">))</span>
		<span class="o">?</span> <span class="p">(</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">f_bfree</span> <span class="o">-</span> <span class="p">(((</span><span class="kt">long</span><span class="p">)</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">f_blocks</span> <span class="o">/</span> <span class="mi">100</span><span class="p">)</span> <span class="o">*</span> <span class="n">uspi</span><span class="o">-&gt;</span><span class="n">s_minfree</span><span class="p">))</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">buf</span><span class="o">-&gt;</span><span class="n">f_files</span> <span class="o">=</span> <span class="n">uspi</span><span class="o">-&gt;</span><span class="n">s_ncg</span> <span class="o">*</span> <span class="n">uspi</span><span class="o">-&gt;</span><span class="n">s_ipg</span><span class="p">;</span>
	<span class="n">buf</span><span class="o">-&gt;</span><span class="n">f_namelen</span> <span class="o">=</span> <span class="n">UFS_MAXNAMLEN</span><span class="p">;</span>
	<span class="n">buf</span><span class="o">-&gt;</span><span class="n">f_fsid</span><span class="p">.</span><span class="n">val</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">id</span><span class="p">;</span>
	<span class="n">buf</span><span class="o">-&gt;</span><span class="n">f_fsid</span><span class="p">.</span><span class="n">val</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)(</span><span class="n">id</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">);</span>

	<span class="n">unlock_ufs</span><span class="p">(</span><span class="n">sb</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">kmem_cache</span> <span class="o">*</span> <span class="n">ufs_inode_cachep</span><span class="p">;</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="nf">ufs_alloc_inode</span><span class="p">(</span><span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">sb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ufs_inode_info</span> <span class="o">*</span><span class="n">ei</span><span class="p">;</span>
	<span class="n">ei</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ufs_inode_info</span> <span class="o">*</span><span class="p">)</span><span class="n">kmem_cache_alloc</span><span class="p">(</span><span class="n">ufs_inode_cachep</span><span class="p">,</span> <span class="n">GFP_NOFS</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ei</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">ei</span><span class="o">-&gt;</span><span class="n">vfs_inode</span><span class="p">.</span><span class="n">i_version</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="o">&amp;</span><span class="n">ei</span><span class="o">-&gt;</span><span class="n">vfs_inode</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ufs_i_callback</span><span class="p">(</span><span class="k">struct</span> <span class="n">rcu_head</span> <span class="o">*</span><span class="n">head</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">head</span><span class="p">,</span> <span class="k">struct</span> <span class="n">inode</span><span class="p">,</span> <span class="n">i_rcu</span><span class="p">);</span>
	<span class="n">kmem_cache_free</span><span class="p">(</span><span class="n">ufs_inode_cachep</span><span class="p">,</span> <span class="n">UFS_I</span><span class="p">(</span><span class="n">inode</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ufs_destroy_inode</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">call_rcu</span><span class="p">(</span><span class="o">&amp;</span><span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_rcu</span><span class="p">,</span> <span class="n">ufs_i_callback</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">init_once</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">foo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ufs_inode_info</span> <span class="o">*</span><span class="n">ei</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ufs_inode_info</span> <span class="o">*</span><span class="p">)</span> <span class="n">foo</span><span class="p">;</span>

	<span class="n">inode_init_once</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ei</span><span class="o">-&gt;</span><span class="n">vfs_inode</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">init_inodecache</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ufs_inode_cachep</span> <span class="o">=</span> <span class="n">kmem_cache_create</span><span class="p">(</span><span class="s">&quot;ufs_inode_cache&quot;</span><span class="p">,</span>
					     <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ufs_inode_info</span><span class="p">),</span>
					     <span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="n">SLAB_RECLAIM_ACCOUNT</span><span class="o">|</span>
						<span class="n">SLAB_MEM_SPREAD</span><span class="p">),</span>
					     <span class="n">init_once</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ufs_inode_cachep</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">destroy_inodecache</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">kmem_cache_destroy</span><span class="p">(</span><span class="n">ufs_inode_cachep</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">super_operations</span> <span class="n">ufs_super_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">alloc_inode</span>	<span class="o">=</span> <span class="n">ufs_alloc_inode</span><span class="p">,</span>
	<span class="p">.</span><span class="n">destroy_inode</span>	<span class="o">=</span> <span class="n">ufs_destroy_inode</span><span class="p">,</span>
	<span class="p">.</span><span class="n">write_inode</span>	<span class="o">=</span> <span class="n">ufs_write_inode</span><span class="p">,</span>
	<span class="p">.</span><span class="n">evict_inode</span>	<span class="o">=</span> <span class="n">ufs_evict_inode</span><span class="p">,</span>
	<span class="p">.</span><span class="n">put_super</span>	<span class="o">=</span> <span class="n">ufs_put_super</span><span class="p">,</span>
	<span class="p">.</span><span class="n">write_super</span>	<span class="o">=</span> <span class="n">ufs_write_super</span><span class="p">,</span>
	<span class="p">.</span><span class="n">sync_fs</span>	<span class="o">=</span> <span class="n">ufs_sync_fs</span><span class="p">,</span>
	<span class="p">.</span><span class="n">statfs</span>		<span class="o">=</span> <span class="n">ufs_statfs</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remount_fs</span>	<span class="o">=</span> <span class="n">ufs_remount</span><span class="p">,</span>
	<span class="p">.</span><span class="n">show_options</span>   <span class="o">=</span> <span class="n">ufs_show_options</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="nf">ufs_mount</span><span class="p">(</span><span class="k">struct</span> <span class="n">file_system_type</span> <span class="o">*</span><span class="n">fs_type</span><span class="p">,</span>
	<span class="kt">int</span> <span class="n">flags</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">dev_name</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">mount_bdev</span><span class="p">(</span><span class="n">fs_type</span><span class="p">,</span> <span class="n">flags</span><span class="p">,</span> <span class="n">dev_name</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">ufs_fill_super</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">file_system_type</span> <span class="n">ufs_fs_type</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span>		<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;ufs&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">mount</span>		<span class="o">=</span> <span class="n">ufs_mount</span><span class="p">,</span>
	<span class="p">.</span><span class="n">kill_sb</span>	<span class="o">=</span> <span class="n">kill_block_super</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fs_flags</span>	<span class="o">=</span> <span class="n">FS_REQUIRES_DEV</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">init_ufs_fs</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="n">init_inodecache</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out1</span><span class="p">;</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">register_filesystem</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ufs_fs_type</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">out:</span>
	<span class="n">destroy_inodecache</span><span class="p">();</span>
<span class="nl">out1:</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">exit_ufs_fs</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">unregister_filesystem</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ufs_fs_type</span><span class="p">);</span>
	<span class="n">destroy_inodecache</span><span class="p">();</span>
<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">init_ufs_fs</span><span class="p">)</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">exit_ufs_fs</span><span class="p">)</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
