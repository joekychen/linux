<!DOCTYPE html>
<html><head><title>joekychen/linux » fs › compat_ioctl.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../index.html"></a><h1>compat_ioctl.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * ioctl32.c: Conversion between 32bit and 64bit native ioctls.</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 1997-2000  Jakub Jelinek  (jakub@redhat.com)</span>
<span class="cm"> * Copyright (C) 1998  Eddie C. Dost  (ecd@skynet.be)</span>
<span class="cm"> * Copyright (C) 2001,2002  Andi Kleen, SuSE Labs </span>
<span class="cm"> * Copyright (C) 2003       Pavel Machek (pavel@ucw.cz)</span>
<span class="cm"> *</span>
<span class="cm"> * These routines maintain argument size conversion between 32bit and 64bit</span>
<span class="cm"> * ioctls.</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/joystick.h&gt;</span>

<span class="cp">#include &lt;linux/types.h&gt;</span>
<span class="cp">#include &lt;linux/compat.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/capability.h&gt;</span>
<span class="cp">#include &lt;linux/compiler.h&gt;</span>
<span class="cp">#include &lt;linux/sched.h&gt;</span>
<span class="cp">#include &lt;linux/smp.h&gt;</span>
<span class="cp">#include &lt;linux/ioctl.h&gt;</span>
<span class="cp">#include &lt;linux/if.h&gt;</span>
<span class="cp">#include &lt;linux/if_bridge.h&gt;</span>
<span class="cp">#include &lt;linux/raid/md_u.h&gt;</span>
<span class="cp">#include &lt;linux/kd.h&gt;</span>
<span class="cp">#include &lt;linux/route.h&gt;</span>
<span class="cp">#include &lt;linux/in6.h&gt;</span>
<span class="cp">#include &lt;linux/ipv6_route.h&gt;</span>
<span class="cp">#include &lt;linux/skbuff.h&gt;</span>
<span class="cp">#include &lt;linux/netlink.h&gt;</span>
<span class="cp">#include &lt;linux/vt.h&gt;</span>
<span class="cp">#include &lt;linux/falloc.h&gt;</span>
<span class="cp">#include &lt;linux/fs.h&gt;</span>
<span class="cp">#include &lt;linux/file.h&gt;</span>
<span class="cp">#include &lt;linux/ppp_defs.h&gt;</span>
<span class="cp">#include &lt;linux/ppp-ioctl.h&gt;</span>
<span class="cp">#include &lt;linux/if_pppox.h&gt;</span>
<span class="cp">#include &lt;linux/mtio.h&gt;</span>
<span class="cp">#include &lt;linux/auto_fs.h&gt;</span>
<span class="cp">#include &lt;linux/auto_fs4.h&gt;</span>
<span class="cp">#include &lt;linux/tty.h&gt;</span>
<span class="cp">#include &lt;linux/vt_kern.h&gt;</span>
<span class="cp">#include &lt;linux/fb.h&gt;</span>
<span class="cp">#include &lt;linux/videodev2.h&gt;</span>
<span class="cp">#include &lt;linux/netdevice.h&gt;</span>
<span class="cp">#include &lt;linux/raw.h&gt;</span>
<span class="cp">#include &lt;linux/blkdev.h&gt;</span>
<span class="cp">#include &lt;linux/elevator.h&gt;</span>
<span class="cp">#include &lt;linux/rtc.h&gt;</span>
<span class="cp">#include &lt;linux/pci.h&gt;</span>
<span class="cp">#include &lt;linux/serial.h&gt;</span>
<span class="cp">#include &lt;linux/if_tun.h&gt;</span>
<span class="cp">#include &lt;linux/ctype.h&gt;</span>
<span class="cp">#include &lt;linux/syscalls.h&gt;</span>
<span class="cp">#include &lt;linux/i2c.h&gt;</span>
<span class="cp">#include &lt;linux/i2c-dev.h&gt;</span>
<span class="cp">#include &lt;linux/atalk.h&gt;</span>
<span class="cp">#include &lt;linux/gfp.h&gt;</span>

<span class="cp">#include &lt;net/bluetooth/bluetooth.h&gt;</span>
<span class="cp">#include &lt;net/bluetooth/hci.h&gt;</span>
<span class="cp">#include &lt;net/bluetooth/rfcomm.h&gt;</span>

<span class="cp">#include &lt;linux/capi.h&gt;</span>
<span class="cp">#include &lt;linux/gigaset_dev.h&gt;</span>

<span class="cp">#ifdef CONFIG_BLOCK</span>
<span class="cp">#include &lt;linux/loop.h&gt;</span>
<span class="cp">#include &lt;linux/cdrom.h&gt;</span>
<span class="cp">#include &lt;linux/fd.h&gt;</span>
<span class="cp">#include &lt;scsi/scsi.h&gt;</span>
<span class="cp">#include &lt;scsi/scsi_ioctl.h&gt;</span>
<span class="cp">#include &lt;scsi/sg.h&gt;</span>
<span class="cp">#endif</span>

<span class="cp">#include &lt;asm/uaccess.h&gt;</span>
<span class="cp">#include &lt;linux/ethtool.h&gt;</span>
<span class="cp">#include &lt;linux/mii.h&gt;</span>
<span class="cp">#include &lt;linux/if_bonding.h&gt;</span>
<span class="cp">#include &lt;linux/watchdog.h&gt;</span>

<span class="cp">#include &lt;linux/soundcard.h&gt;</span>
<span class="cp">#include &lt;linux/lp.h&gt;</span>
<span class="cp">#include &lt;linux/ppdev.h&gt;</span>

<span class="cp">#include &lt;linux/atm.h&gt;</span>
<span class="cp">#include &lt;linux/atmarp.h&gt;</span>
<span class="cp">#include &lt;linux/atmclip.h&gt;</span>
<span class="cp">#include &lt;linux/atmdev.h&gt;</span>
<span class="cp">#include &lt;linux/atmioc.h&gt;</span>
<span class="cp">#include &lt;linux/atmlec.h&gt;</span>
<span class="cp">#include &lt;linux/atmmpc.h&gt;</span>
<span class="cp">#include &lt;linux/atmsvc.h&gt;</span>
<span class="cp">#include &lt;linux/atm_tcp.h&gt;</span>
<span class="cp">#include &lt;linux/sonet.h&gt;</span>
<span class="cp">#include &lt;linux/atm_suni.h&gt;</span>

<span class="cp">#include &lt;linux/usb.h&gt;</span>
<span class="cp">#include &lt;linux/usbdevice_fs.h&gt;</span>
<span class="cp">#include &lt;linux/nbd.h&gt;</span>
<span class="cp">#include &lt;linux/random.h&gt;</span>
<span class="cp">#include &lt;linux/filter.h&gt;</span>

<span class="cp">#include &lt;linux/hiddev.h&gt;</span>

<span class="cp">#define __DVB_CORE__</span>
<span class="cp">#include &lt;linux/dvb/audio.h&gt;</span>
<span class="cp">#include &lt;linux/dvb/dmx.h&gt;</span>
<span class="cp">#include &lt;linux/dvb/frontend.h&gt;</span>
<span class="cp">#include &lt;linux/dvb/video.h&gt;</span>

<span class="cp">#include &lt;linux/sort.h&gt;</span>

<span class="cp">#ifdef CONFIG_SPARC</span>
<span class="cp">#include &lt;asm/fbio.h&gt;</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">w_long</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">fd</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span>
		<span class="n">compat_ulong_t</span> <span class="n">__user</span> <span class="o">*</span><span class="n">argp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">mm_segment_t</span> <span class="n">old_fs</span> <span class="o">=</span> <span class="n">get_fs</span><span class="p">();</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">val</span><span class="p">;</span>

	<span class="n">set_fs</span> <span class="p">(</span><span class="n">KERNEL_DS</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">sys_ioctl</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
	<span class="n">set_fs</span> <span class="p">(</span><span class="n">old_fs</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span> <span class="o">&amp;&amp;</span> <span class="n">put_user</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">argp</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">compat_video_event</span> <span class="p">{</span>
	<span class="kt">int32_t</span>		<span class="n">type</span><span class="p">;</span>
	<span class="n">compat_time_t</span>	<span class="n">timestamp</span><span class="p">;</span>
	<span class="k">union</span> <span class="p">{</span>
	        <span class="n">video_size_t</span> <span class="n">size</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">frame_rate</span><span class="p">;</span>
	<span class="p">}</span> <span class="n">u</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">do_video_get_event</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">fd</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">compat_video_event</span> <span class="n">__user</span> <span class="o">*</span><span class="n">up</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">video_event</span> <span class="n">kevent</span><span class="p">;</span>
	<span class="n">mm_segment_t</span> <span class="n">old_fs</span> <span class="o">=</span> <span class="n">get_fs</span><span class="p">();</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">set_fs</span><span class="p">(</span><span class="n">KERNEL_DS</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">sys_ioctl</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">kevent</span><span class="p">);</span>
	<span class="n">set_fs</span><span class="p">(</span><span class="n">old_fs</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span>  <span class="o">=</span> <span class="n">put_user</span><span class="p">(</span><span class="n">kevent</span><span class="p">.</span><span class="n">type</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">|=</span> <span class="n">put_user</span><span class="p">(</span><span class="n">kevent</span><span class="p">.</span><span class="n">timestamp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">timestamp</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">|=</span> <span class="n">put_user</span><span class="p">(</span><span class="n">kevent</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">size</span><span class="p">.</span><span class="n">w</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">size</span><span class="p">.</span><span class="n">w</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">|=</span> <span class="n">put_user</span><span class="p">(</span><span class="n">kevent</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">size</span><span class="p">.</span><span class="n">h</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">size</span><span class="p">.</span><span class="n">h</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">|=</span> <span class="n">put_user</span><span class="p">(</span><span class="n">kevent</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">size</span><span class="p">.</span><span class="n">aspect_ratio</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">size</span><span class="p">.</span><span class="n">aspect_ratio</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">compat_video_still_picture</span> <span class="p">{</span>
        <span class="n">compat_uptr_t</span> <span class="n">iFrame</span><span class="p">;</span>
        <span class="kt">int32_t</span> <span class="n">size</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">do_video_stillpicture</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">fd</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">compat_video_still_picture</span> <span class="n">__user</span> <span class="o">*</span><span class="n">up</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">video_still_picture</span> <span class="n">__user</span> <span class="o">*</span><span class="n">up_native</span><span class="p">;</span>
	<span class="n">compat_uptr_t</span> <span class="n">fp</span><span class="p">;</span>
	<span class="kt">int32_t</span> <span class="n">size</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span>  <span class="o">=</span> <span class="n">get_user</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">iFrame</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">|=</span> <span class="n">get_user</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

	<span class="n">up_native</span> <span class="o">=</span>
		<span class="n">compat_alloc_user_space</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">video_still_picture</span><span class="p">));</span>

	<span class="n">err</span> <span class="o">=</span>  <span class="n">put_user</span><span class="p">(</span><span class="n">compat_ptr</span><span class="p">(</span><span class="n">fp</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">up_native</span><span class="o">-&gt;</span><span class="n">iFrame</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">|=</span> <span class="n">put_user</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">up_native</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">sys_ioctl</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">up_native</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">compat_video_spu_palette</span> <span class="p">{</span>
	<span class="kt">int</span> <span class="n">length</span><span class="p">;</span>
	<span class="n">compat_uptr_t</span> <span class="n">palette</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">do_video_set_spu_palette</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">fd</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">compat_video_spu_palette</span> <span class="n">__user</span> <span class="o">*</span><span class="n">up</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">video_spu_palette</span> <span class="n">__user</span> <span class="o">*</span><span class="n">up_native</span><span class="p">;</span>
	<span class="n">compat_uptr_t</span> <span class="n">palp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">length</span><span class="p">,</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span>  <span class="o">=</span> <span class="n">get_user</span><span class="p">(</span><span class="n">palp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">palette</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">|=</span> <span class="n">get_user</span><span class="p">(</span><span class="n">length</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">);</span>

	<span class="n">up_native</span> <span class="o">=</span> <span class="n">compat_alloc_user_space</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">video_spu_palette</span><span class="p">));</span>
	<span class="n">err</span>  <span class="o">=</span> <span class="n">put_user</span><span class="p">(</span><span class="n">compat_ptr</span><span class="p">(</span><span class="n">palp</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">up_native</span><span class="o">-&gt;</span><span class="n">palette</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">|=</span> <span class="n">put_user</span><span class="p">(</span><span class="n">length</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">up_native</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">sys_ioctl</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">up_native</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_BLOCK</span>
<span class="k">typedef</span> <span class="k">struct</span> <span class="n">sg_io_hdr32</span> <span class="p">{</span>
	<span class="n">compat_int_t</span> <span class="n">interface_id</span><span class="p">;</span>	<span class="cm">/* [i] &#39;S&#39; for SCSI generic (required) */</span>
	<span class="n">compat_int_t</span> <span class="n">dxfer_direction</span><span class="p">;</span>	<span class="cm">/* [i] data transfer direction  */</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">cmd_len</span><span class="p">;</span>		<span class="cm">/* [i] SCSI command length ( &lt;= 16 bytes) */</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">mx_sb_len</span><span class="p">;</span>		<span class="cm">/* [i] max length to write to sbp */</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">iovec_count</span><span class="p">;</span>	<span class="cm">/* [i] 0 implies no scatter gather */</span>
	<span class="n">compat_uint_t</span> <span class="n">dxfer_len</span><span class="p">;</span>		<span class="cm">/* [i] byte count of data transfer */</span>
	<span class="n">compat_uint_t</span> <span class="n">dxferp</span><span class="p">;</span>		<span class="cm">/* [i], [*io] points to data transfer memory</span>
<span class="cm">					      or scatter gather list */</span>
	<span class="n">compat_uptr_t</span> <span class="n">cmdp</span><span class="p">;</span>		<span class="cm">/* [i], [*i] points to command to perform */</span>
	<span class="n">compat_uptr_t</span> <span class="n">sbp</span><span class="p">;</span>		<span class="cm">/* [i], [*o] points to sense_buffer memory */</span>
	<span class="n">compat_uint_t</span> <span class="n">timeout</span><span class="p">;</span>		<span class="cm">/* [i] MAX_UINT-&gt;no timeout (unit: millisec) */</span>
	<span class="n">compat_uint_t</span> <span class="n">flags</span><span class="p">;</span>		<span class="cm">/* [i] 0 -&gt; default, see SG_FLAG... */</span>
	<span class="n">compat_int_t</span> <span class="n">pack_id</span><span class="p">;</span>		<span class="cm">/* [i-&gt;o] unused internally (normally) */</span>
	<span class="n">compat_uptr_t</span> <span class="n">usr_ptr</span><span class="p">;</span>		<span class="cm">/* [i-&gt;o] unused internally */</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">status</span><span class="p">;</span>		<span class="cm">/* [o] scsi status */</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">masked_status</span><span class="p">;</span>	<span class="cm">/* [o] shifted, masked scsi status */</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">msg_status</span><span class="p">;</span>		<span class="cm">/* [o] messaging level data (optional) */</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">sb_len_wr</span><span class="p">;</span>		<span class="cm">/* [o] byte count actually written to sbp */</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">host_status</span><span class="p">;</span>	<span class="cm">/* [o] errors from host adapter */</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">driver_status</span><span class="p">;</span>	<span class="cm">/* [o] errors from software driver */</span>
	<span class="n">compat_int_t</span> <span class="n">resid</span><span class="p">;</span>		<span class="cm">/* [o] dxfer_len - actual_transferred */</span>
	<span class="n">compat_uint_t</span> <span class="n">duration</span><span class="p">;</span>		<span class="cm">/* [o] time taken by cmd (unit: millisec) */</span>
	<span class="n">compat_uint_t</span> <span class="n">info</span><span class="p">;</span>		<span class="cm">/* [o] auxiliary information */</span>
<span class="p">}</span> <span class="n">sg_io_hdr32_t</span><span class="p">;</span>  <span class="cm">/* 64 bytes long (on sparc32) */</span>

<span class="k">typedef</span> <span class="k">struct</span> <span class="n">sg_iovec32</span> <span class="p">{</span>
	<span class="n">compat_uint_t</span> <span class="n">iov_base</span><span class="p">;</span>
	<span class="n">compat_uint_t</span> <span class="n">iov_len</span><span class="p">;</span>
<span class="p">}</span> <span class="n">sg_iovec32_t</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sg_build_iovec</span><span class="p">(</span><span class="n">sg_io_hdr_t</span> <span class="n">__user</span> <span class="o">*</span><span class="n">sgio</span><span class="p">,</span> <span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="n">dxferp</span><span class="p">,</span> <span class="n">u16</span> <span class="n">iovec_count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">sg_iovec_t</span> <span class="n">__user</span> <span class="o">*</span><span class="n">iov</span> <span class="o">=</span> <span class="p">(</span><span class="n">sg_iovec_t</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">sgio</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">sg_iovec32_t</span> <span class="n">__user</span> <span class="o">*</span><span class="n">iov32</span> <span class="o">=</span> <span class="n">dxferp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">iovec_count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">base</span><span class="p">,</span> <span class="n">len</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">get_user</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">iov32</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">iov_base</span><span class="p">)</span> <span class="o">||</span>
		    <span class="n">get_user</span><span class="p">(</span><span class="n">len</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">iov32</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">iov_len</span><span class="p">)</span> <span class="o">||</span>
		    <span class="n">put_user</span><span class="p">(</span><span class="n">compat_ptr</span><span class="p">(</span><span class="n">base</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">iov</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">iov_base</span><span class="p">)</span> <span class="o">||</span>
		    <span class="n">put_user</span><span class="p">(</span><span class="n">len</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">iov</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">iov_len</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">put_user</span><span class="p">(</span><span class="n">iov</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sgio</span><span class="o">-&gt;</span><span class="n">dxferp</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sg_ioctl_trans</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">fd</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span>
			<span class="n">sg_io_hdr32_t</span> <span class="n">__user</span> <span class="o">*</span><span class="n">sgio32</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">sg_io_hdr_t</span> <span class="n">__user</span> <span class="o">*</span><span class="n">sgio</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">iovec_count</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">data</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="n">dxferp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">interface_id</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">get_user</span><span class="p">(</span><span class="n">interface_id</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sgio32</span><span class="o">-&gt;</span><span class="n">interface_id</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">interface_id</span> <span class="o">!=</span> <span class="sc">&#39;S&#39;</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">sys_ioctl</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">sgio32</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">get_user</span><span class="p">(</span><span class="n">iovec_count</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sgio32</span><span class="o">-&gt;</span><span class="n">iovec_count</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

	<span class="p">{</span>
		<span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="n">top</span> <span class="o">=</span> <span class="n">compat_alloc_user_space</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
		<span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="n">new</span> <span class="o">=</span> <span class="n">compat_alloc_user_space</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">sg_io_hdr_t</span><span class="p">)</span> <span class="o">+</span>
				       <span class="p">(</span><span class="n">iovec_count</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">sg_iovec_t</span><span class="p">)));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">new</span> <span class="o">&gt;</span> <span class="n">top</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

		<span class="n">sgio</span> <span class="o">=</span> <span class="n">new</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Ok, now construct.  */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">copy_in_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sgio</span><span class="o">-&gt;</span><span class="n">interface_id</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sgio32</span><span class="o">-&gt;</span><span class="n">interface_id</span><span class="p">,</span>
			 <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">))</span> <span class="o">+</span>
			 <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">))</span> <span class="o">+</span>
			 <span class="p">(</span><span class="mi">1</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">short</span><span class="p">))</span> <span class="o">+</span>
			 <span class="p">(</span><span class="mi">1</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">))))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">get_user</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sgio32</span><span class="o">-&gt;</span><span class="n">dxferp</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="n">dxferp</span> <span class="o">=</span> <span class="n">compat_ptr</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">iovec_count</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sg_build_iovec</span><span class="p">(</span><span class="n">sgio</span><span class="p">,</span> <span class="n">dxferp</span><span class="p">,</span> <span class="n">iovec_count</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">put_user</span><span class="p">(</span><span class="n">dxferp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sgio</span><span class="o">-&gt;</span><span class="n">dxferp</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">cmdp</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">sbp</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">get_user</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sgio32</span><span class="o">-&gt;</span><span class="n">cmdp</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="n">cmdp</span> <span class="o">=</span> <span class="n">compat_ptr</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">get_user</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sgio32</span><span class="o">-&gt;</span><span class="n">sbp</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="n">sbp</span> <span class="o">=</span> <span class="n">compat_ptr</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">put_user</span><span class="p">(</span><span class="n">cmdp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sgio</span><span class="o">-&gt;</span><span class="n">cmdp</span><span class="p">)</span> <span class="o">||</span>
		    <span class="n">put_user</span><span class="p">(</span><span class="n">sbp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sgio</span><span class="o">-&gt;</span><span class="n">sbp</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">copy_in_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sgio</span><span class="o">-&gt;</span><span class="n">timeout</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sgio32</span><span class="o">-&gt;</span><span class="n">timeout</span><span class="p">,</span>
			 <span class="mi">3</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">get_user</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sgio32</span><span class="o">-&gt;</span><span class="n">usr_ptr</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">put_user</span><span class="p">(</span><span class="n">compat_ptr</span><span class="p">(</span><span class="n">data</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">sgio</span><span class="o">-&gt;</span><span class="n">usr_ptr</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">sys_ioctl</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">sgio</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="n">datap</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">copy_in_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sgio32</span><span class="o">-&gt;</span><span class="n">pack_id</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sgio</span><span class="o">-&gt;</span><span class="n">pack_id</span><span class="p">,</span>
				 <span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">))</span> <span class="o">||</span>
		    <span class="n">get_user</span><span class="p">(</span><span class="n">datap</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sgio</span><span class="o">-&gt;</span><span class="n">usr_ptr</span><span class="p">)</span> <span class="o">||</span>
		    <span class="n">put_user</span><span class="p">((</span><span class="n">u32</span><span class="p">)(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">datap</span><span class="p">,</span>
			     <span class="o">&amp;</span><span class="n">sgio32</span><span class="o">-&gt;</span><span class="n">usr_ptr</span><span class="p">)</span> <span class="o">||</span>
		    <span class="n">copy_in_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sgio32</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sgio</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">,</span>
				 <span class="p">(</span><span class="mi">4</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">))</span> <span class="o">+</span>
				 <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">short</span><span class="p">))</span> <span class="o">+</span>
				 <span class="p">(</span><span class="mi">3</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">))))</span>
			<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">compat_sg_req_info</span> <span class="p">{</span> <span class="cm">/* used by SG_GET_REQUEST_TABLE ioctl() */</span>
	<span class="kt">char</span> <span class="n">req_state</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">orphan</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">sg_io_owned</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">problem</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">pack_id</span><span class="p">;</span>
	<span class="n">compat_uptr_t</span> <span class="n">usr_ptr</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">duration</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">unused</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sg_grt_trans</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">fd</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span> <span class="k">struct</span>
			<span class="n">compat_sg_req_info</span> <span class="n">__user</span> <span class="o">*</span><span class="n">o</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">sg_req_info_t</span> <span class="n">__user</span> <span class="o">*</span><span class="n">r</span><span class="p">;</span>
	<span class="n">r</span> <span class="o">=</span> <span class="n">compat_alloc_user_space</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">sg_req_info_t</span><span class="p">)</span><span class="o">*</span><span class="n">SG_MAX_QUEUE</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">sys_ioctl</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span><span class="n">cmd</span><span class="p">,(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">r</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">SG_MAX_QUEUE</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="n">ptr</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">d</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">copy_in_user</span><span class="p">(</span><span class="n">o</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span> <span class="n">r</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span> <span class="n">offsetof</span><span class="p">(</span><span class="n">sg_req_info_t</span><span class="p">,</span> <span class="n">usr_ptr</span><span class="p">))</span> <span class="o">||</span>
		    <span class="n">get_user</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">r</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">usr_ptr</span><span class="p">)</span> <span class="o">||</span>
		    <span class="n">get_user</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">r</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">duration</span><span class="p">)</span> <span class="o">||</span>
		    <span class="n">put_user</span><span class="p">((</span><span class="n">u32</span><span class="p">)(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)(</span><span class="n">ptr</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">o</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">usr_ptr</span><span class="p">)</span> <span class="o">||</span>
		    <span class="n">put_user</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">o</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">duration</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_BLOCK */</span><span class="cp"></span>

<span class="k">struct</span> <span class="n">sock_fprog32</span> <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">short</span>	<span class="n">len</span><span class="p">;</span>
	<span class="n">compat_caddr_t</span>	<span class="n">filter</span><span class="p">;</span>
<span class="p">};</span>

<span class="cp">#define PPPIOCSPASS32	_IOW(&#39;t&#39;, 71, struct sock_fprog32)</span>
<span class="cp">#define PPPIOCSACTIVE32	_IOW(&#39;t&#39;, 70, struct sock_fprog32)</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ppp_sock_fprog_ioctl_trans</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">fd</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">sock_fprog32</span> <span class="n">__user</span> <span class="o">*</span><span class="n">u_fprog32</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sock_fprog</span> <span class="n">__user</span> <span class="o">*</span><span class="n">u_fprog64</span> <span class="o">=</span> <span class="n">compat_alloc_user_space</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock_fprog</span><span class="p">));</span>
	<span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="n">fptr64</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">fptr32</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">flen</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">get_user</span><span class="p">(</span><span class="n">flen</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">u_fprog32</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">get_user</span><span class="p">(</span><span class="n">fptr32</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">u_fprog32</span><span class="o">-&gt;</span><span class="n">filter</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

	<span class="n">fptr64</span> <span class="o">=</span> <span class="n">compat_ptr</span><span class="p">(</span><span class="n">fptr32</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">put_user</span><span class="p">(</span><span class="n">flen</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">u_fprog64</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">put_user</span><span class="p">(</span><span class="n">fptr64</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">u_fprog64</span><span class="o">-&gt;</span><span class="n">filter</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span> <span class="o">==</span> <span class="n">PPPIOCSPASS32</span><span class="p">)</span>
		<span class="n">cmd</span> <span class="o">=</span> <span class="n">PPPIOCSPASS</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">cmd</span> <span class="o">=</span> <span class="n">PPPIOCSACTIVE</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">sys_ioctl</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">u_fprog64</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">ppp_option_data32</span> <span class="p">{</span>
	<span class="n">compat_caddr_t</span>	<span class="n">ptr</span><span class="p">;</span>
	<span class="n">u32</span>			<span class="n">length</span><span class="p">;</span>
	<span class="n">compat_int_t</span>		<span class="n">transmit</span><span class="p">;</span>
<span class="p">};</span>
<span class="cp">#define PPPIOCSCOMPRESS32	_IOW(&#39;t&#39;, 77, struct ppp_option_data32)</span>

<span class="k">struct</span> <span class="n">ppp_idle32</span> <span class="p">{</span>
	<span class="n">compat_time_t</span> <span class="n">xmit_idle</span><span class="p">;</span>
	<span class="n">compat_time_t</span> <span class="n">recv_idle</span><span class="p">;</span>
<span class="p">};</span>
<span class="cp">#define PPPIOCGIDLE32		_IOR(&#39;t&#39;, 63, struct ppp_idle32)</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ppp_gidle</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">fd</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">ppp_idle32</span> <span class="n">__user</span> <span class="o">*</span><span class="n">idle32</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ppp_idle</span> <span class="n">__user</span> <span class="o">*</span><span class="n">idle</span><span class="p">;</span>
	<span class="n">__kernel_time_t</span> <span class="n">xmit</span><span class="p">,</span> <span class="n">recv</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">idle</span> <span class="o">=</span> <span class="n">compat_alloc_user_space</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">idle</span><span class="p">));</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">sys_ioctl</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">PPPIOCGIDLE</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">idle</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">get_user</span><span class="p">(</span><span class="n">xmit</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">idle</span><span class="o">-&gt;</span><span class="n">xmit_idle</span><span class="p">)</span> <span class="o">||</span>
		    <span class="n">get_user</span><span class="p">(</span><span class="n">recv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">idle</span><span class="o">-&gt;</span><span class="n">recv_idle</span><span class="p">)</span> <span class="o">||</span>
		    <span class="n">put_user</span><span class="p">(</span><span class="n">xmit</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">idle32</span><span class="o">-&gt;</span><span class="n">xmit_idle</span><span class="p">)</span> <span class="o">||</span>
		    <span class="n">put_user</span><span class="p">(</span><span class="n">recv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">idle32</span><span class="o">-&gt;</span><span class="n">recv_idle</span><span class="p">))</span>
			<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ppp_scompress</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">fd</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">ppp_option_data32</span> <span class="n">__user</span> <span class="o">*</span><span class="n">odata32</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ppp_option_data</span> <span class="n">__user</span> <span class="o">*</span><span class="n">odata</span><span class="p">;</span>
	<span class="n">__u32</span> <span class="n">data</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="n">datap</span><span class="p">;</span>

	<span class="n">odata</span> <span class="o">=</span> <span class="n">compat_alloc_user_space</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">odata</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">get_user</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">odata32</span><span class="o">-&gt;</span><span class="n">ptr</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

	<span class="n">datap</span> <span class="o">=</span> <span class="n">compat_ptr</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">put_user</span><span class="p">(</span><span class="n">datap</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">odata</span><span class="o">-&gt;</span><span class="n">ptr</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">copy_in_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">odata</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">odata32</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">,</span>
			 <span class="k">sizeof</span><span class="p">(</span><span class="n">__u32</span><span class="p">)</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">sys_ioctl</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">PPPIOCSCOMPRESS</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">odata</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_BLOCK</span>
<span class="k">struct</span> <span class="n">mtget32</span> <span class="p">{</span>
	<span class="n">compat_long_t</span>	<span class="n">mt_type</span><span class="p">;</span>
	<span class="n">compat_long_t</span>	<span class="n">mt_resid</span><span class="p">;</span>
	<span class="n">compat_long_t</span>	<span class="n">mt_dsreg</span><span class="p">;</span>
	<span class="n">compat_long_t</span>	<span class="n">mt_gstat</span><span class="p">;</span>
	<span class="n">compat_long_t</span>	<span class="n">mt_erreg</span><span class="p">;</span>
	<span class="n">compat_daddr_t</span>	<span class="n">mt_fileno</span><span class="p">;</span>
	<span class="n">compat_daddr_t</span>	<span class="n">mt_blkno</span><span class="p">;</span>
<span class="p">};</span>
<span class="cp">#define MTIOCGET32	_IOR(&#39;m&#39;, 2, struct mtget32)</span>

<span class="k">struct</span> <span class="n">mtpos32</span> <span class="p">{</span>
	<span class="n">compat_long_t</span>	<span class="n">mt_blkno</span><span class="p">;</span>
<span class="p">};</span>
<span class="cp">#define MTIOCPOS32	_IOR(&#39;m&#39;, 3, struct mtpos32)</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mt_ioctl_trans</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">fd</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span> <span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="n">argp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">mm_segment_t</span> <span class="n">old_fs</span> <span class="o">=</span> <span class="n">get_fs</span><span class="p">();</span>
	<span class="k">struct</span> <span class="n">mtget</span> <span class="n">get</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mtget32</span> <span class="n">__user</span> <span class="o">*</span><span class="n">umget32</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mtpos</span> <span class="n">pos</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mtpos32</span> <span class="n">__user</span> <span class="o">*</span><span class="n">upos32</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">kcmd</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">karg</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">switch</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">MTIOCPOS32</span>:
		<span class="n">kcmd</span> <span class="o">=</span> <span class="n">MTIOCPOS</span><span class="p">;</span>
		<span class="n">karg</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pos</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>	<span class="cm">/* MTIOCGET32 */</span>
		<span class="n">kcmd</span> <span class="o">=</span> <span class="n">MTIOCGET</span><span class="p">;</span>
		<span class="n">karg</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">get</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">set_fs</span> <span class="p">(</span><span class="n">KERNEL_DS</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">sys_ioctl</span> <span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">kcmd</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">karg</span><span class="p">);</span>
	<span class="n">set_fs</span> <span class="p">(</span><span class="n">old_fs</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">MTIOCPOS32</span>:
		<span class="n">upos32</span> <span class="o">=</span> <span class="n">argp</span><span class="p">;</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">__put_user</span><span class="p">(</span><span class="n">pos</span><span class="p">.</span><span class="n">mt_blkno</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">upos32</span><span class="o">-&gt;</span><span class="n">mt_blkno</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MTIOCGET32</span>:
		<span class="n">umget32</span> <span class="o">=</span> <span class="n">argp</span><span class="p">;</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">__put_user</span><span class="p">(</span><span class="n">get</span><span class="p">.</span><span class="n">mt_type</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">umget32</span><span class="o">-&gt;</span><span class="n">mt_type</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">|=</span> <span class="n">__put_user</span><span class="p">(</span><span class="n">get</span><span class="p">.</span><span class="n">mt_resid</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">umget32</span><span class="o">-&gt;</span><span class="n">mt_resid</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">|=</span> <span class="n">__put_user</span><span class="p">(</span><span class="n">get</span><span class="p">.</span><span class="n">mt_dsreg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">umget32</span><span class="o">-&gt;</span><span class="n">mt_dsreg</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">|=</span> <span class="n">__put_user</span><span class="p">(</span><span class="n">get</span><span class="p">.</span><span class="n">mt_gstat</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">umget32</span><span class="o">-&gt;</span><span class="n">mt_gstat</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">|=</span> <span class="n">__put_user</span><span class="p">(</span><span class="n">get</span><span class="p">.</span><span class="n">mt_erreg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">umget32</span><span class="o">-&gt;</span><span class="n">mt_erreg</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">|=</span> <span class="n">__put_user</span><span class="p">(</span><span class="n">get</span><span class="p">.</span><span class="n">mt_fileno</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">umget32</span><span class="o">-&gt;</span><span class="n">mt_fileno</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">|=</span> <span class="n">__put_user</span><span class="p">(</span><span class="n">get</span><span class="p">.</span><span class="n">mt_blkno</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">umget32</span><span class="o">-&gt;</span><span class="n">mt_blkno</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">err</span> <span class="o">?</span> <span class="o">-</span><span class="n">EFAULT</span><span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#endif </span><span class="cm">/* CONFIG_BLOCK */</span><span class="cp"></span>

<span class="cm">/* Bluetooth ioctls */</span>
<span class="cp">#define HCIUARTSETPROTO		_IOW(&#39;U&#39;, 200, int)</span>
<span class="cp">#define HCIUARTGETPROTO		_IOR(&#39;U&#39;, 201, int)</span>
<span class="cp">#define HCIUARTGETDEVICE	_IOR(&#39;U&#39;, 202, int)</span>
<span class="cp">#define HCIUARTSETFLAGS		_IOW(&#39;U&#39;, 203, int)</span>
<span class="cp">#define HCIUARTGETFLAGS		_IOR(&#39;U&#39;, 204, int)</span>

<span class="cp">#define BNEPCONNADD	_IOW(&#39;B&#39;, 200, int)</span>
<span class="cp">#define BNEPCONNDEL	_IOW(&#39;B&#39;, 201, int)</span>
<span class="cp">#define BNEPGETCONNLIST	_IOR(&#39;B&#39;, 210, int)</span>
<span class="cp">#define BNEPGETCONNINFO	_IOR(&#39;B&#39;, 211, int)</span>

<span class="cp">#define CMTPCONNADD	_IOW(&#39;C&#39;, 200, int)</span>
<span class="cp">#define CMTPCONNDEL	_IOW(&#39;C&#39;, 201, int)</span>
<span class="cp">#define CMTPGETCONNLIST	_IOR(&#39;C&#39;, 210, int)</span>
<span class="cp">#define CMTPGETCONNINFO	_IOR(&#39;C&#39;, 211, int)</span>

<span class="cp">#define HIDPCONNADD	_IOW(&#39;H&#39;, 200, int)</span>
<span class="cp">#define HIDPCONNDEL	_IOW(&#39;H&#39;, 201, int)</span>
<span class="cp">#define HIDPGETCONNLIST	_IOR(&#39;H&#39;, 210, int)</span>
<span class="cp">#define HIDPGETCONNINFO	_IOR(&#39;H&#39;, 211, int)</span>


<span class="k">struct</span> <span class="n">serial_struct32</span> <span class="p">{</span>
        <span class="n">compat_int_t</span>    <span class="n">type</span><span class="p">;</span>
        <span class="n">compat_int_t</span>    <span class="n">line</span><span class="p">;</span>
        <span class="n">compat_uint_t</span>   <span class="n">port</span><span class="p">;</span>
        <span class="n">compat_int_t</span>    <span class="n">irq</span><span class="p">;</span>
        <span class="n">compat_int_t</span>    <span class="n">flags</span><span class="p">;</span>
        <span class="n">compat_int_t</span>    <span class="n">xmit_fifo_size</span><span class="p">;</span>
        <span class="n">compat_int_t</span>    <span class="n">custom_divisor</span><span class="p">;</span>
        <span class="n">compat_int_t</span>    <span class="n">baud_base</span><span class="p">;</span>
        <span class="kt">unsigned</span> <span class="kt">short</span>  <span class="n">close_delay</span><span class="p">;</span>
        <span class="kt">char</span>    <span class="n">io_type</span><span class="p">;</span>
        <span class="kt">char</span>    <span class="n">reserved_char</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
        <span class="n">compat_int_t</span>    <span class="n">hub6</span><span class="p">;</span>
        <span class="kt">unsigned</span> <span class="kt">short</span>  <span class="n">closing_wait</span><span class="p">;</span> <span class="cm">/* time to wait before closing */</span>
        <span class="kt">unsigned</span> <span class="kt">short</span>  <span class="n">closing_wait2</span><span class="p">;</span> <span class="cm">/* no longer used... */</span>
        <span class="n">compat_uint_t</span>   <span class="n">iomem_base</span><span class="p">;</span>
        <span class="kt">unsigned</span> <span class="kt">short</span>  <span class="n">iomem_reg_shift</span><span class="p">;</span>
        <span class="kt">unsigned</span> <span class="kt">int</span>    <span class="n">port_high</span><span class="p">;</span>
     <span class="cm">/* compat_ulong_t  iomap_base FIXME */</span>
        <span class="n">compat_int_t</span>    <span class="n">reserved</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">serial_struct_ioctl</span><span class="p">(</span><span class="kt">unsigned</span> <span class="n">fd</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">cmd</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">serial_struct32</span> <span class="n">__user</span> <span class="o">*</span><span class="n">ss32</span><span class="p">)</span>
<span class="p">{</span>
        <span class="k">typedef</span> <span class="k">struct</span> <span class="n">serial_struct</span> <span class="n">SS</span><span class="p">;</span>
        <span class="k">typedef</span> <span class="k">struct</span> <span class="n">serial_struct32</span> <span class="n">SS32</span><span class="p">;</span>
        <span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
        <span class="k">struct</span> <span class="n">serial_struct</span> <span class="n">ss</span><span class="p">;</span>
        <span class="n">mm_segment_t</span> <span class="n">oldseg</span> <span class="o">=</span> <span class="n">get_fs</span><span class="p">();</span>
        <span class="n">__u32</span> <span class="n">udata</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">base</span><span class="p">;</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">cmd</span> <span class="o">==</span> <span class="n">TIOCSSERIAL</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">access_ok</span><span class="p">(</span><span class="n">VERIFY_READ</span><span class="p">,</span> <span class="n">ss32</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">SS32</span><span class="p">)))</span>
                        <span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">__copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ss</span><span class="p">,</span> <span class="n">ss32</span><span class="p">,</span> <span class="n">offsetof</span><span class="p">(</span><span class="n">SS32</span><span class="p">,</span> <span class="n">iomem_base</span><span class="p">)))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">__get_user</span><span class="p">(</span><span class="n">udata</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ss32</span><span class="o">-&gt;</span><span class="n">iomem_base</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
                <span class="n">ss</span><span class="p">.</span><span class="n">iomem_base</span> <span class="o">=</span> <span class="n">compat_ptr</span><span class="p">(</span><span class="n">udata</span><span class="p">);</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">__get_user</span><span class="p">(</span><span class="n">ss</span><span class="p">.</span><span class="n">iomem_reg_shift</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ss32</span><span class="o">-&gt;</span><span class="n">iomem_reg_shift</span><span class="p">)</span> <span class="o">||</span>
		    <span class="n">__get_user</span><span class="p">(</span><span class="n">ss</span><span class="p">.</span><span class="n">port_high</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ss32</span><span class="o">-&gt;</span><span class="n">port_high</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
                <span class="n">ss</span><span class="p">.</span><span class="n">iomap_base</span> <span class="o">=</span> <span class="mi">0UL</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="n">set_fs</span><span class="p">(</span><span class="n">KERNEL_DS</span><span class="p">);</span>
                <span class="n">err</span> <span class="o">=</span> <span class="n">sys_ioctl</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span><span class="n">cmd</span><span class="p">,(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)(</span><span class="o">&amp;</span><span class="n">ss</span><span class="p">));</span>
        <span class="n">set_fs</span><span class="p">(</span><span class="n">oldseg</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">cmd</span> <span class="o">==</span> <span class="n">TIOCGSERIAL</span> <span class="o">&amp;&amp;</span> <span class="n">err</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">access_ok</span><span class="p">(</span><span class="n">VERIFY_WRITE</span><span class="p">,</span> <span class="n">ss32</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">SS32</span><span class="p">)))</span>
                        <span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">__copy_to_user</span><span class="p">(</span><span class="n">ss32</span><span class="p">,</span><span class="o">&amp;</span><span class="n">ss</span><span class="p">,</span><span class="n">offsetof</span><span class="p">(</span><span class="n">SS32</span><span class="p">,</span><span class="n">iomem_base</span><span class="p">)))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="n">base</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">ss</span><span class="p">.</span><span class="n">iomem_base</span>  <span class="o">&gt;&gt;</span> <span class="mi">32</span> <span class="o">?</span>
			<span class="mh">0xffffffff</span> <span class="o">:</span> <span class="p">(</span><span class="kt">unsigned</span><span class="p">)(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">ss</span><span class="p">.</span><span class="n">iomem_base</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">__put_user</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ss32</span><span class="o">-&gt;</span><span class="n">iomem_base</span><span class="p">)</span> <span class="o">||</span>
		    <span class="n">__put_user</span><span class="p">(</span><span class="n">ss</span><span class="p">.</span><span class="n">iomem_reg_shift</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ss32</span><span class="o">-&gt;</span><span class="n">iomem_reg_shift</span><span class="p">)</span> <span class="o">||</span>
		    <span class="n">__put_user</span><span class="p">(</span><span class="n">ss</span><span class="p">.</span><span class="n">port_high</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ss32</span><span class="o">-&gt;</span><span class="n">port_high</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * I2C layer ioctls</span>
<span class="cm"> */</span>

<span class="k">struct</span> <span class="n">i2c_msg32</span> <span class="p">{</span>
	<span class="n">u16</span> <span class="n">addr</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">len</span><span class="p">;</span>
	<span class="n">compat_caddr_t</span> <span class="n">buf</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">i2c_rdwr_ioctl_data32</span> <span class="p">{</span>
	<span class="n">compat_caddr_t</span> <span class="n">msgs</span><span class="p">;</span> <span class="cm">/* struct i2c_msg __user *msgs */</span>
	<span class="n">u32</span> <span class="n">nmsgs</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">i2c_smbus_ioctl_data32</span> <span class="p">{</span>
	<span class="n">u8</span> <span class="n">read_write</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">command</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">size</span><span class="p">;</span>
	<span class="n">compat_caddr_t</span> <span class="n">data</span><span class="p">;</span> <span class="cm">/* union i2c_smbus_data *data */</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">i2c_rdwr_aligned</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">i2c_rdwr_ioctl_data</span> <span class="n">cmd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">i2c_msg</span> <span class="n">msgs</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">do_i2c_rdwr_ioctl</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">fd</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">i2c_rdwr_ioctl_data32</span>    <span class="n">__user</span> <span class="o">*</span><span class="n">udata</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">i2c_rdwr_aligned</span>		<span class="n">__user</span> <span class="o">*</span><span class="n">tdata</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">i2c_msg</span>			<span class="n">__user</span> <span class="o">*</span><span class="n">tmsgs</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">i2c_msg32</span>		<span class="n">__user</span> <span class="o">*</span><span class="n">umsgs</span><span class="p">;</span>
	<span class="n">compat_caddr_t</span>			<span class="n">datap</span><span class="p">;</span>
	<span class="kt">int</span>				<span class="n">nmsgs</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">get_user</span><span class="p">(</span><span class="n">nmsgs</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">udata</span><span class="o">-&gt;</span><span class="n">nmsgs</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nmsgs</span> <span class="o">&gt;</span> <span class="n">I2C_RDRW_IOCTL_MAX_MSGS</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">get_user</span><span class="p">(</span><span class="n">datap</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">udata</span><span class="o">-&gt;</span><span class="n">msgs</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="n">umsgs</span> <span class="o">=</span> <span class="n">compat_ptr</span><span class="p">(</span><span class="n">datap</span><span class="p">);</span>

	<span class="n">tdata</span> <span class="o">=</span> <span class="n">compat_alloc_user_space</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">tdata</span><span class="p">)</span> <span class="o">+</span>
				      <span class="n">nmsgs</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_msg</span><span class="p">));</span>
	<span class="n">tmsgs</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">tdata</span><span class="o">-&gt;</span><span class="n">msgs</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">put_user</span><span class="p">(</span><span class="n">nmsgs</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tdata</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">nmsgs</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">put_user</span><span class="p">(</span><span class="n">tmsgs</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tdata</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">msgs</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">nmsgs</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">copy_in_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tmsgs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">addr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">umsgs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">addr</span><span class="p">,</span> <span class="mi">3</span><span class="o">*</span><span class="k">sizeof</span><span class="p">(</span><span class="n">u16</span><span class="p">)))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">get_user</span><span class="p">(</span><span class="n">datap</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">umsgs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">buf</span><span class="p">)</span> <span class="o">||</span>
		    <span class="n">put_user</span><span class="p">(</span><span class="n">compat_ptr</span><span class="p">(</span><span class="n">datap</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">tmsgs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">buf</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">sys_ioctl</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">tdata</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">do_i2c_smbus_ioctl</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">fd</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">i2c_smbus_ioctl_data32</span>   <span class="n">__user</span> <span class="o">*</span><span class="n">udata</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">i2c_smbus_ioctl_data</span>	<span class="n">__user</span> <span class="o">*</span><span class="n">tdata</span><span class="p">;</span>
	<span class="n">compat_caddr_t</span>			<span class="n">datap</span><span class="p">;</span>

	<span class="n">tdata</span> <span class="o">=</span> <span class="n">compat_alloc_user_space</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">tdata</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tdata</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">access_ok</span><span class="p">(</span><span class="n">VERIFY_WRITE</span><span class="p">,</span> <span class="n">tdata</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">tdata</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">access_ok</span><span class="p">(</span><span class="n">VERIFY_READ</span><span class="p">,</span> <span class="n">udata</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">udata</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">__copy_in_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tdata</span><span class="o">-&gt;</span><span class="n">read_write</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">udata</span><span class="o">-&gt;</span><span class="n">read_write</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u8</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">__copy_in_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tdata</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">udata</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">__get_user</span><span class="p">(</span><span class="n">datap</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">udata</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">__put_user</span><span class="p">(</span><span class="n">compat_ptr</span><span class="p">(</span><span class="n">datap</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">tdata</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">sys_ioctl</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">tdata</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#define RTC_IRQP_READ32		_IOR(&#39;p&#39;, 0x0b, compat_ulong_t)</span>
<span class="cp">#define RTC_IRQP_SET32		_IOW(&#39;p&#39;, 0x0c, compat_ulong_t)</span>
<span class="cp">#define RTC_EPOCH_READ32	_IOR(&#39;p&#39;, 0x0d, compat_ulong_t)</span>
<span class="cp">#define RTC_EPOCH_SET32		_IOW(&#39;p&#39;, 0x0e, compat_ulong_t)</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">rtc_ioctl</span><span class="p">(</span><span class="kt">unsigned</span> <span class="n">fd</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">cmd</span><span class="p">,</span> <span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="n">argp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">mm_segment_t</span> <span class="n">oldfs</span> <span class="o">=</span> <span class="n">get_fs</span><span class="p">();</span>
	<span class="n">compat_ulong_t</span> <span class="n">val32</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">kval</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">RTC_IRQP_READ32</span>:
	<span class="k">case</span> <span class="n">RTC_EPOCH_READ32</span>:
		<span class="n">set_fs</span><span class="p">(</span><span class="n">KERNEL_DS</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">sys_ioctl</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="p">(</span><span class="n">cmd</span> <span class="o">==</span> <span class="n">RTC_IRQP_READ32</span><span class="p">)</span> <span class="o">?</span>
					<span class="n">RTC_IRQP_READ</span> <span class="o">:</span> <span class="n">RTC_EPOCH_READ</span><span class="p">,</span>
					<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="o">&amp;</span><span class="n">kval</span><span class="p">);</span>
		<span class="n">set_fs</span><span class="p">(</span><span class="n">oldfs</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
		<span class="n">val32</span> <span class="o">=</span> <span class="n">kval</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">put_user</span><span class="p">(</span><span class="n">val32</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">argp</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">RTC_IRQP_SET32</span>:
		<span class="k">return</span> <span class="n">sys_ioctl</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">RTC_IRQP_SET</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">argp</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">RTC_EPOCH_SET32</span>:
		<span class="k">return</span> <span class="n">sys_ioctl</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">RTC_EPOCH_SET</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">argp</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="o">-</span><span class="n">ENOIOCTLCMD</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* on ia32 l_start is on a 32-bit boundary */</span>
<span class="cp">#if defined(CONFIG_IA64) || defined(CONFIG_X86_64)</span>
<span class="k">struct</span> <span class="n">space_resv_32</span> <span class="p">{</span>
	<span class="n">__s16</span>		<span class="n">l_type</span><span class="p">;</span>
	<span class="n">__s16</span>		<span class="n">l_whence</span><span class="p">;</span>
	<span class="n">__s64</span>		<span class="n">l_start</span>	<span class="n">__attribute__</span><span class="p">((</span><span class="n">packed</span><span class="p">));</span>
			<span class="cm">/* len == 0 means until end of file */</span>
	<span class="n">__s64</span>		<span class="n">l_len</span> <span class="n">__attribute__</span><span class="p">((</span><span class="n">packed</span><span class="p">));</span>
	<span class="n">__s32</span>		<span class="n">l_sysid</span><span class="p">;</span>
	<span class="n">__u32</span>		<span class="n">l_pid</span><span class="p">;</span>
	<span class="n">__s32</span>		<span class="n">l_pad</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>	<span class="cm">/* reserve area */</span>
<span class="p">};</span>

<span class="cp">#define FS_IOC_RESVSP_32		_IOW (&#39;X&#39;, 40, struct space_resv_32)</span>
<span class="cp">#define FS_IOC_RESVSP64_32	_IOW (&#39;X&#39;, 42, struct space_resv_32)</span>

<span class="cm">/* just account for different alignment */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">compat_ioctl_preallocate</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">space_resv_32</span>    <span class="n">__user</span> <span class="o">*</span><span class="n">p32</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">space_resv</span>	<span class="n">__user</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">compat_alloc_user_space</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">p</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">copy_in_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">l_type</span><span class="p">,</span>	<span class="o">&amp;</span><span class="n">p32</span><span class="o">-&gt;</span><span class="n">l_type</span><span class="p">,</span>	<span class="k">sizeof</span><span class="p">(</span><span class="n">s16</span><span class="p">))</span> <span class="o">||</span>
	    <span class="n">copy_in_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">l_whence</span><span class="p">,</span>	<span class="o">&amp;</span><span class="n">p32</span><span class="o">-&gt;</span><span class="n">l_whence</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">s16</span><span class="p">))</span> <span class="o">||</span>
	    <span class="n">copy_in_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">l_start</span><span class="p">,</span>	<span class="o">&amp;</span><span class="n">p32</span><span class="o">-&gt;</span><span class="n">l_start</span><span class="p">,</span>	<span class="k">sizeof</span><span class="p">(</span><span class="n">s64</span><span class="p">))</span> <span class="o">||</span>
	    <span class="n">copy_in_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">l_len</span><span class="p">,</span>	<span class="o">&amp;</span><span class="n">p32</span><span class="o">-&gt;</span><span class="n">l_len</span><span class="p">,</span>	<span class="k">sizeof</span><span class="p">(</span><span class="n">s64</span><span class="p">))</span> <span class="o">||</span>
	    <span class="n">copy_in_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">l_sysid</span><span class="p">,</span>	<span class="o">&amp;</span><span class="n">p32</span><span class="o">-&gt;</span><span class="n">l_sysid</span><span class="p">,</span>	<span class="k">sizeof</span><span class="p">(</span><span class="n">s32</span><span class="p">))</span> <span class="o">||</span>
	    <span class="n">copy_in_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">l_pid</span><span class="p">,</span>	<span class="o">&amp;</span><span class="n">p32</span><span class="o">-&gt;</span><span class="n">l_pid</span><span class="p">,</span>	<span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">))</span> <span class="o">||</span>
	    <span class="n">copy_in_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">l_pad</span><span class="p">,</span>	<span class="o">&amp;</span><span class="n">p32</span><span class="o">-&gt;</span><span class="n">l_pad</span><span class="p">,</span>	<span class="mi">4</span><span class="o">*</span><span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">ioctl_preallocate</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">p</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="cm">/*</span>
<span class="cm"> * simple reversible transform to make our table more evenly</span>
<span class="cm"> * distributed after sorting.</span>
<span class="cm"> */</span>
<span class="cp">#define XFORM(i) (((i) ^ ((i) &lt;&lt; 27) ^ ((i) &lt;&lt; 17)) &amp; 0xffffffff)</span>

<span class="cp">#define COMPATIBLE_IOCTL(cmd) XFORM(cmd),</span>
<span class="cm">/* ioctl should not be warned about even if it&#39;s not implemented.</span>
<span class="cm">   Valid reasons to use this:</span>
<span class="cm">   - It is implemented with -&gt;compat_ioctl on some device, but programs</span>
<span class="cm">   call it on others too.</span>
<span class="cm">   - The ioctl is not implemented in the native kernel, but programs</span>
<span class="cm">   call it commonly anyways.</span>
<span class="cm">   Most other reasons are not valid. */</span>
<span class="cp">#define IGNORE_IOCTL(cmd) COMPATIBLE_IOCTL(cmd)</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ioctl_pointer</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
<span class="cm">/* compatible ioctls first */</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="mh">0x4B50</span><span class="p">)</span>   <span class="cm">/* KDGHWCLK - not in the kernel, but don&#39;t complain */</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="mh">0x4B51</span><span class="p">)</span>   <span class="cm">/* KDSHWCLK - not in the kernel, but don&#39;t complain */</span>

<span class="cm">/* Big T */</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">TCGETA</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">TCSETA</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">TCSETAW</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">TCSETAF</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">TCSBRK</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">TCXONC</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">TCFLSH</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">TCGETS</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">TCSETS</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">TCSETSW</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">TCSETSF</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">TIOCLINUX</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">TIOCSBRK</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">TIOCGDEV</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">TIOCCBRK</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">TIOCGSID</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">TIOCGICOUNT</span><span class="p">)</span>
<span class="cm">/* Little t */</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">TIOCGETD</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">TIOCSETD</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">TIOCEXCL</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">TIOCNXCL</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">TIOCCONS</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">TIOCGSOFTCAR</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">TIOCSSOFTCAR</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">TIOCSWINSZ</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">TIOCGWINSZ</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">TIOCMGET</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">TIOCMBIC</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">TIOCMBIS</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">TIOCMSET</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">TIOCPKT</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">TIOCNOTTY</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">TIOCSTI</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">TIOCOUTQ</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">TIOCSPGRP</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">TIOCGPGRP</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">TIOCGPTN</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">TIOCSPTLCK</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">TIOCSERGETLSR</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">TIOCSIG</span><span class="p">)</span>
<span class="cp">#ifdef TCGETS2</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">TCGETS2</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">TCSETS2</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">TCSETSW2</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">TCSETSF2</span><span class="p">)</span>
<span class="cp">#endif</span>
<span class="cm">/* Little f */</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">FIOCLEX</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">FIONCLEX</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">FIOASYNC</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">FIONBIO</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">FIONREAD</span><span class="p">)</span>  <span class="cm">/* This is also TIOCINQ */</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">FS_IOC_FIEMAP</span><span class="p">)</span>
<span class="cm">/* 0x00 */</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">FIBMAP</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">FIGETBSZ</span><span class="p">)</span>
<span class="cm">/* &#39;X&#39; - originally XFS but some now in the VFS */</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">FIFREEZE</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">FITHAW</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">KDGETKEYCODE</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">KDSETKEYCODE</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">KDGKBTYPE</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">KDGETMODE</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">KDGKBMODE</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">KDGKBMETA</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">KDGKBENT</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">KDSKBENT</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">KDGKBSENT</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">KDSKBSENT</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">KDGKBDIACR</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">KDSKBDIACR</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">KDKBDREP</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">KDGKBLED</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">KDGETLED</span><span class="p">)</span>
<span class="cp">#ifdef CONFIG_BLOCK</span>
<span class="cm">/* Big S */</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">SCSI_IOCTL_GET_IDLUN</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">SCSI_IOCTL_DOORLOCK</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">SCSI_IOCTL_DOORUNLOCK</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">SCSI_IOCTL_TEST_UNIT_READY</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">SCSI_IOCTL_GET_BUS_NUMBER</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">SCSI_IOCTL_SEND_COMMAND</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">SCSI_IOCTL_PROBE_HOST</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">SCSI_IOCTL_GET_PCI</span><span class="p">)</span>
<span class="cp">#endif</span>
<span class="cm">/* Big V (don&#39;t complain on serial console) */</span>
<span class="n">IGNORE_IOCTL</span><span class="p">(</span><span class="n">VT_OPENQRY</span><span class="p">)</span>
<span class="n">IGNORE_IOCTL</span><span class="p">(</span><span class="n">VT_GETMODE</span><span class="p">)</span>
<span class="cm">/* Little p (/dev/rtc, /dev/envctrl, etc.) */</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">RTC_AIE_ON</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">RTC_AIE_OFF</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">RTC_UIE_ON</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">RTC_UIE_OFF</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">RTC_PIE_ON</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">RTC_PIE_OFF</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">RTC_WIE_ON</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">RTC_WIE_OFF</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">RTC_ALM_SET</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">RTC_ALM_READ</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">RTC_RD_TIME</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">RTC_SET_TIME</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">RTC_WKALM_SET</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">RTC_WKALM_RD</span><span class="p">)</span>
<span class="cm">/*</span>
<span class="cm"> * These two are only for the sbus rtc driver, but</span>
<span class="cm"> * hwclock tries them on every rtc device first when</span>
<span class="cm"> * running on sparc.  On other architectures the entries</span>
<span class="cm"> * are useless but harmless.</span>
<span class="cm"> */</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">_IOR</span><span class="p">(</span><span class="sc">&#39;p&#39;</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="kt">int</span><span class="p">[</span><span class="mi">7</span><span class="p">]))</span> <span class="cm">/* RTCGET */</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">_IOW</span><span class="p">(</span><span class="sc">&#39;p&#39;</span><span class="p">,</span> <span class="mi">21</span><span class="p">,</span> <span class="kt">int</span><span class="p">[</span><span class="mi">7</span><span class="p">]))</span> <span class="cm">/* RTCSET */</span>
<span class="cm">/* Little m */</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">MTIOCTOP</span><span class="p">)</span>
<span class="cm">/* Socket level stuff */</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">FIOQSIZE</span><span class="p">)</span>
<span class="cp">#ifdef CONFIG_BLOCK</span>
<span class="cm">/* loop */</span>
<span class="n">IGNORE_IOCTL</span><span class="p">(</span><span class="n">LOOP_CLR_FD</span><span class="p">)</span>
<span class="cm">/* md calls this on random blockdevs */</span>
<span class="n">IGNORE_IOCTL</span><span class="p">(</span><span class="n">RAID_VERSION</span><span class="p">)</span>
<span class="cm">/* qemu/qemu-img might call these two on plain files for probing */</span>
<span class="n">IGNORE_IOCTL</span><span class="p">(</span><span class="n">CDROM_DRIVE_STATUS</span><span class="p">)</span>
<span class="n">IGNORE_IOCTL</span><span class="p">(</span><span class="n">FDGETPRM32</span><span class="p">)</span>
<span class="cm">/* SG stuff */</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">SG_SET_TIMEOUT</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">SG_GET_TIMEOUT</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">SG_EMULATED_HOST</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">SG_GET_TRANSFORM</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">SG_SET_RESERVED_SIZE</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">SG_GET_RESERVED_SIZE</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">SG_GET_SCSI_ID</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">SG_SET_FORCE_LOW_DMA</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">SG_GET_LOW_DMA</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">SG_SET_FORCE_PACK_ID</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">SG_GET_PACK_ID</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">SG_GET_NUM_WAITING</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">SG_SET_DEBUG</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">SG_GET_SG_TABLESIZE</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">SG_GET_COMMAND_Q</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">SG_SET_COMMAND_Q</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">SG_GET_VERSION_NUM</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">SG_NEXT_CMD_LEN</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">SG_SCSI_RESET</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">SG_GET_REQUEST_TABLE</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">SG_SET_KEEP_ORPHAN</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">SG_GET_KEEP_ORPHAN</span><span class="p">)</span>
<span class="cp">#endif</span>
<span class="cm">/* PPP stuff */</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">PPPIOCGFLAGS</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">PPPIOCSFLAGS</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">PPPIOCGASYNCMAP</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">PPPIOCSASYNCMAP</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">PPPIOCGUNIT</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">PPPIOCGRASYNCMAP</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">PPPIOCSRASYNCMAP</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">PPPIOCGMRU</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">PPPIOCSMRU</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">PPPIOCSMAXCID</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">PPPIOCGXASYNCMAP</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">PPPIOCSXASYNCMAP</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">PPPIOCXFERUNIT</span><span class="p">)</span>
<span class="cm">/* PPPIOCSCOMPRESS is translated */</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">PPPIOCGNPMODE</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">PPPIOCSNPMODE</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">PPPIOCGDEBUG</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">PPPIOCSDEBUG</span><span class="p">)</span>
<span class="cm">/* PPPIOCSPASS is translated */</span>
<span class="cm">/* PPPIOCSACTIVE is translated */</span>
<span class="cm">/* PPPIOCGIDLE is translated */</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">PPPIOCNEWUNIT</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">PPPIOCATTACH</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">PPPIOCDETACH</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">PPPIOCSMRRU</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">PPPIOCCONNECT</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">PPPIOCDISCONN</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">PPPIOCATTCHAN</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">PPPIOCGCHAN</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">PPPIOCGL2TPSTATS</span><span class="p">)</span>
<span class="cm">/* PPPOX */</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">PPPOEIOCSFWD</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">PPPOEIOCDFWD</span><span class="p">)</span>
<span class="cm">/* ppdev */</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">PPSETMODE</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">PPRSTATUS</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">PPRCONTROL</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">PPWCONTROL</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">PPFCONTROL</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">PPRDATA</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">PPWDATA</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">PPCLAIM</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">PPRELEASE</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">PPYIELD</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">PPEXCL</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">PPDATADIR</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">PPNEGOT</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">PPWCTLONIRQ</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">PPCLRIRQ</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">PPSETPHASE</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">PPGETMODES</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">PPGETMODE</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">PPGETPHASE</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">PPGETFLAGS</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">PPSETFLAGS</span><span class="p">)</span>
<span class="cm">/* Big A */</span>
<span class="cm">/* sparc only */</span>
<span class="cm">/* Big Q for sound/OSS */</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">SNDCTL_SEQ_RESET</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">SNDCTL_SEQ_SYNC</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">SNDCTL_SYNTH_INFO</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">SNDCTL_SEQ_CTRLRATE</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">SNDCTL_SEQ_GETOUTCOUNT</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">SNDCTL_SEQ_GETINCOUNT</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">SNDCTL_SEQ_PERCMODE</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">SNDCTL_FM_LOAD_INSTR</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">SNDCTL_SEQ_TESTMIDI</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">SNDCTL_SEQ_RESETSAMPLES</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">SNDCTL_SEQ_NRSYNTHS</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">SNDCTL_SEQ_NRMIDIS</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">SNDCTL_MIDI_INFO</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">SNDCTL_SEQ_THRESHOLD</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">SNDCTL_SYNTH_MEMAVL</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">SNDCTL_FM_4OP_ENABLE</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">SNDCTL_SEQ_PANIC</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">SNDCTL_SEQ_OUTOFBAND</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">SNDCTL_SEQ_GETTIME</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">SNDCTL_SYNTH_ID</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">SNDCTL_SYNTH_CONTROL</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">SNDCTL_SYNTH_REMOVESAMPLE</span><span class="p">)</span>
<span class="cm">/* Big T for sound/OSS */</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">SNDCTL_TMR_TIMEBASE</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">SNDCTL_TMR_START</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">SNDCTL_TMR_STOP</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">SNDCTL_TMR_CONTINUE</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">SNDCTL_TMR_TEMPO</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">SNDCTL_TMR_SOURCE</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">SNDCTL_TMR_METRONOME</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">SNDCTL_TMR_SELECT</span><span class="p">)</span>
<span class="cm">/* Little m for sound/OSS */</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">SNDCTL_MIDI_PRETIME</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">SNDCTL_MIDI_MPUMODE</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">SNDCTL_MIDI_MPUCMD</span><span class="p">)</span>
<span class="cm">/* Big P for sound/OSS */</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">SNDCTL_DSP_RESET</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">SNDCTL_DSP_SYNC</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">SNDCTL_DSP_SPEED</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">SNDCTL_DSP_STEREO</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">SNDCTL_DSP_GETBLKSIZE</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">SNDCTL_DSP_CHANNELS</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">SOUND_PCM_WRITE_FILTER</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">SNDCTL_DSP_POST</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">SNDCTL_DSP_SUBDIVIDE</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">SNDCTL_DSP_SETFRAGMENT</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">SNDCTL_DSP_GETFMTS</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">SNDCTL_DSP_SETFMT</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">SNDCTL_DSP_GETOSPACE</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">SNDCTL_DSP_GETISPACE</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">SNDCTL_DSP_NONBLOCK</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">SNDCTL_DSP_GETCAPS</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">SNDCTL_DSP_GETTRIGGER</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">SNDCTL_DSP_SETTRIGGER</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">SNDCTL_DSP_GETIPTR</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">SNDCTL_DSP_GETOPTR</span><span class="p">)</span>
<span class="cm">/* SNDCTL_DSP_MAPINBUF,  XXX needs translation */</span>
<span class="cm">/* SNDCTL_DSP_MAPOUTBUF,  XXX needs translation */</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">SNDCTL_DSP_SETSYNCRO</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">SNDCTL_DSP_SETDUPLEX</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">SNDCTL_DSP_GETODELAY</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">SNDCTL_DSP_PROFILE</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">SOUND_PCM_READ_RATE</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">SOUND_PCM_READ_CHANNELS</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">SOUND_PCM_READ_BITS</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">SOUND_PCM_READ_FILTER</span><span class="p">)</span>
<span class="cm">/* Big C for sound/OSS */</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">SNDCTL_COPR_RESET</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">SNDCTL_COPR_LOAD</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">SNDCTL_COPR_RDATA</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">SNDCTL_COPR_RCODE</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">SNDCTL_COPR_WDATA</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">SNDCTL_COPR_WCODE</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">SNDCTL_COPR_RUN</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">SNDCTL_COPR_HALT</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">SNDCTL_COPR_SENDMSG</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">SNDCTL_COPR_RCVMSG</span><span class="p">)</span>
<span class="cm">/* Big M for sound/OSS */</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">SOUND_MIXER_READ_VOLUME</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">SOUND_MIXER_READ_BASS</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">SOUND_MIXER_READ_TREBLE</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">SOUND_MIXER_READ_SYNTH</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">SOUND_MIXER_READ_PCM</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">SOUND_MIXER_READ_SPEAKER</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">SOUND_MIXER_READ_LINE</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">SOUND_MIXER_READ_MIC</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">SOUND_MIXER_READ_CD</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">SOUND_MIXER_READ_IMIX</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">SOUND_MIXER_READ_ALTPCM</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">SOUND_MIXER_READ_RECLEV</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">SOUND_MIXER_READ_IGAIN</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">SOUND_MIXER_READ_OGAIN</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">SOUND_MIXER_READ_LINE1</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">SOUND_MIXER_READ_LINE2</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">SOUND_MIXER_READ_LINE3</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">MIXER_READ</span><span class="p">(</span><span class="n">SOUND_MIXER_DIGITAL1</span><span class="p">))</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">MIXER_READ</span><span class="p">(</span><span class="n">SOUND_MIXER_DIGITAL2</span><span class="p">))</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">MIXER_READ</span><span class="p">(</span><span class="n">SOUND_MIXER_DIGITAL3</span><span class="p">))</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">MIXER_READ</span><span class="p">(</span><span class="n">SOUND_MIXER_PHONEIN</span><span class="p">))</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">MIXER_READ</span><span class="p">(</span><span class="n">SOUND_MIXER_PHONEOUT</span><span class="p">))</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">MIXER_READ</span><span class="p">(</span><span class="n">SOUND_MIXER_VIDEO</span><span class="p">))</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">MIXER_READ</span><span class="p">(</span><span class="n">SOUND_MIXER_RADIO</span><span class="p">))</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">MIXER_READ</span><span class="p">(</span><span class="n">SOUND_MIXER_MONITOR</span><span class="p">))</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">SOUND_MIXER_READ_MUTE</span><span class="p">)</span>
<span class="cm">/* SOUND_MIXER_READ_ENHANCE,  same value as READ_MUTE */</span>
<span class="cm">/* SOUND_MIXER_READ_LOUD,  same value as READ_MUTE */</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">SOUND_MIXER_READ_RECSRC</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">SOUND_MIXER_READ_DEVMASK</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">SOUND_MIXER_READ_RECMASK</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">SOUND_MIXER_READ_STEREODEVS</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">SOUND_MIXER_READ_CAPS</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">SOUND_MIXER_WRITE_VOLUME</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">SOUND_MIXER_WRITE_BASS</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">SOUND_MIXER_WRITE_TREBLE</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">SOUND_MIXER_WRITE_SYNTH</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">SOUND_MIXER_WRITE_PCM</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">SOUND_MIXER_WRITE_SPEAKER</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">SOUND_MIXER_WRITE_LINE</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">SOUND_MIXER_WRITE_MIC</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">SOUND_MIXER_WRITE_CD</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">SOUND_MIXER_WRITE_IMIX</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">SOUND_MIXER_WRITE_ALTPCM</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">SOUND_MIXER_WRITE_RECLEV</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">SOUND_MIXER_WRITE_IGAIN</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">SOUND_MIXER_WRITE_OGAIN</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">SOUND_MIXER_WRITE_LINE1</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">SOUND_MIXER_WRITE_LINE2</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">SOUND_MIXER_WRITE_LINE3</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">MIXER_WRITE</span><span class="p">(</span><span class="n">SOUND_MIXER_DIGITAL1</span><span class="p">))</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">MIXER_WRITE</span><span class="p">(</span><span class="n">SOUND_MIXER_DIGITAL2</span><span class="p">))</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">MIXER_WRITE</span><span class="p">(</span><span class="n">SOUND_MIXER_DIGITAL3</span><span class="p">))</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">MIXER_WRITE</span><span class="p">(</span><span class="n">SOUND_MIXER_PHONEIN</span><span class="p">))</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">MIXER_WRITE</span><span class="p">(</span><span class="n">SOUND_MIXER_PHONEOUT</span><span class="p">))</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">MIXER_WRITE</span><span class="p">(</span><span class="n">SOUND_MIXER_VIDEO</span><span class="p">))</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">MIXER_WRITE</span><span class="p">(</span><span class="n">SOUND_MIXER_RADIO</span><span class="p">))</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">MIXER_WRITE</span><span class="p">(</span><span class="n">SOUND_MIXER_MONITOR</span><span class="p">))</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">SOUND_MIXER_WRITE_MUTE</span><span class="p">)</span>
<span class="cm">/* SOUND_MIXER_WRITE_ENHANCE,  same value as WRITE_MUTE */</span>
<span class="cm">/* SOUND_MIXER_WRITE_LOUD,  same value as WRITE_MUTE */</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">SOUND_MIXER_WRITE_RECSRC</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">SOUND_MIXER_INFO</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">SOUND_OLD_MIXER_INFO</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">SOUND_MIXER_ACCESS</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">SOUND_MIXER_AGC</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">SOUND_MIXER_3DSE</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">SOUND_MIXER_PRIVATE1</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">SOUND_MIXER_PRIVATE2</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">SOUND_MIXER_PRIVATE3</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">SOUND_MIXER_PRIVATE4</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">SOUND_MIXER_PRIVATE5</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">SOUND_MIXER_GETLEVELS</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">SOUND_MIXER_SETLEVELS</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">OSS_GETVERSION</span><span class="p">)</span>
<span class="cm">/* Raw devices */</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">RAW_SETBIND</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">RAW_GETBIND</span><span class="p">)</span>
<span class="cm">/* Watchdog */</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">WDIOC_GETSUPPORT</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">WDIOC_GETSTATUS</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">WDIOC_GETBOOTSTATUS</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">WDIOC_GETTEMP</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">WDIOC_SETOPTIONS</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">WDIOC_KEEPALIVE</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">WDIOC_SETTIMEOUT</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">WDIOC_GETTIMEOUT</span><span class="p">)</span>
<span class="cm">/* Big R */</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">RNDGETENTCNT</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">RNDADDTOENTCNT</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">RNDGETPOOL</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">RNDADDENTROPY</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">RNDZAPENTCNT</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">RNDCLEARPOOL</span><span class="p">)</span>
<span class="cm">/* Bluetooth */</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">HCIDEVUP</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">HCIDEVDOWN</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">HCIDEVRESET</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">HCIDEVRESTAT</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">HCIGETDEVLIST</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">HCIGETDEVINFO</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">HCIGETCONNLIST</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">HCIGETCONNINFO</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">HCIGETAUTHINFO</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">HCISETRAW</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">HCISETSCAN</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">HCISETAUTH</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">HCISETENCRYPT</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">HCISETPTYPE</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">HCISETLINKPOL</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">HCISETLINKMODE</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">HCISETACLMTU</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">HCISETSCOMTU</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">HCIBLOCKADDR</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">HCIUNBLOCKADDR</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">HCIINQUIRY</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">HCIUARTSETPROTO</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">HCIUARTGETPROTO</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">RFCOMMCREATEDEV</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">RFCOMMRELEASEDEV</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">RFCOMMGETDEVLIST</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">RFCOMMGETDEVINFO</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">RFCOMMSTEALDLC</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">BNEPCONNADD</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">BNEPCONNDEL</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">BNEPGETCONNLIST</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">BNEPGETCONNINFO</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">CMTPCONNADD</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">CMTPCONNDEL</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">CMTPGETCONNLIST</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">CMTPGETCONNINFO</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">HIDPCONNADD</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">HIDPCONNDEL</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">HIDPGETCONNLIST</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">HIDPGETCONNINFO</span><span class="p">)</span>
<span class="cm">/* CAPI */</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">CAPI_REGISTER</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">CAPI_GET_MANUFACTURER</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">CAPI_GET_VERSION</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">CAPI_GET_SERIAL</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">CAPI_GET_PROFILE</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">CAPI_MANUFACTURER_CMD</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">CAPI_GET_ERRCODE</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">CAPI_INSTALLED</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">CAPI_GET_FLAGS</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">CAPI_SET_FLAGS</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">CAPI_CLR_FLAGS</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">CAPI_NCCI_OPENCOUNT</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">CAPI_NCCI_GETUNIT</span><span class="p">)</span>
<span class="cm">/* Siemens Gigaset */</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">GIGASET_REDIR</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">GIGASET_CONFIG</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">GIGASET_BRKCHARS</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">GIGASET_VERSION</span><span class="p">)</span>
<span class="cm">/* Misc. */</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="mh">0x41545900</span><span class="p">)</span>		<span class="cm">/* ATYIO_CLKR */</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="mh">0x41545901</span><span class="p">)</span>		<span class="cm">/* ATYIO_CLKW */</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">PCIIOC_CONTROLLER</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">PCIIOC_MMAP_IS_IO</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">PCIIOC_MMAP_IS_MEM</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">PCIIOC_WRITE_COMBINE</span><span class="p">)</span>
<span class="cm">/* NBD */</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">NBD_DO_IT</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">NBD_CLEAR_SOCK</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">NBD_CLEAR_QUE</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">NBD_PRINT_DEBUG</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">NBD_DISCONNECT</span><span class="p">)</span>
<span class="cm">/* i2c */</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">I2C_SLAVE</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">I2C_SLAVE_FORCE</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">I2C_TENBIT</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">I2C_PEC</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">I2C_RETRIES</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">I2C_TIMEOUT</span><span class="p">)</span>
<span class="cm">/* hiddev */</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">HIDIOCGVERSION</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">HIDIOCAPPLICATION</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">HIDIOCGDEVINFO</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">HIDIOCGSTRING</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">HIDIOCINITREPORT</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">HIDIOCGREPORT</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">HIDIOCSREPORT</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">HIDIOCGREPORTINFO</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">HIDIOCGFIELDINFO</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">HIDIOCGUSAGE</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">HIDIOCSUSAGE</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">HIDIOCGUCODE</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">HIDIOCGFLAG</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">HIDIOCSFLAG</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">HIDIOCGCOLLECTIONINDEX</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">HIDIOCGCOLLECTIONINFO</span><span class="p">)</span>
<span class="cm">/* dvb */</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">AUDIO_STOP</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">AUDIO_PLAY</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">AUDIO_PAUSE</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">AUDIO_CONTINUE</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">AUDIO_SELECT_SOURCE</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">AUDIO_SET_MUTE</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">AUDIO_SET_AV_SYNC</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">AUDIO_SET_BYPASS_MODE</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">AUDIO_CHANNEL_SELECT</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">AUDIO_GET_STATUS</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">AUDIO_GET_CAPABILITIES</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">AUDIO_CLEAR_BUFFER</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">AUDIO_SET_ID</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">AUDIO_SET_MIXER</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">AUDIO_SET_STREAMTYPE</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">AUDIO_SET_EXT_ID</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">AUDIO_SET_ATTRIBUTES</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">AUDIO_SET_KARAOKE</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">DMX_START</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">DMX_STOP</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">DMX_SET_FILTER</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">DMX_SET_PES_FILTER</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">DMX_SET_BUFFER_SIZE</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">DMX_GET_PES_PIDS</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">DMX_GET_CAPS</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">DMX_SET_SOURCE</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">DMX_GET_STC</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">FE_GET_INFO</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">FE_DISEQC_RESET_OVERLOAD</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">FE_DISEQC_SEND_MASTER_CMD</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">FE_DISEQC_RECV_SLAVE_REPLY</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">FE_DISEQC_SEND_BURST</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">FE_SET_TONE</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">FE_SET_VOLTAGE</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">FE_ENABLE_HIGH_LNB_VOLTAGE</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">FE_READ_STATUS</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">FE_READ_BER</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">FE_READ_SIGNAL_STRENGTH</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">FE_READ_SNR</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">FE_READ_UNCORRECTED_BLOCKS</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">FE_SET_FRONTEND</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">FE_GET_FRONTEND</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">FE_GET_EVENT</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">FE_DISHNETWORK_SEND_LEGACY_CMD</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">VIDEO_STOP</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">VIDEO_PLAY</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">VIDEO_FREEZE</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">VIDEO_CONTINUE</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">VIDEO_SELECT_SOURCE</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">VIDEO_SET_BLANK</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">VIDEO_GET_STATUS</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">VIDEO_SET_DISPLAY_FORMAT</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">VIDEO_FAST_FORWARD</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">VIDEO_SLOWMOTION</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">VIDEO_GET_CAPABILITIES</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">VIDEO_CLEAR_BUFFER</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">VIDEO_SET_ID</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">VIDEO_SET_STREAMTYPE</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">VIDEO_SET_FORMAT</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">VIDEO_SET_SYSTEM</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">VIDEO_SET_HIGHLIGHT</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">VIDEO_SET_SPU</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">VIDEO_GET_NAVI</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">VIDEO_SET_ATTRIBUTES</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">VIDEO_GET_SIZE</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">VIDEO_GET_FRAME_RATE</span><span class="p">)</span>

<span class="cm">/* joystick */</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">JSIOCGVERSION</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">JSIOCGAXES</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">JSIOCGBUTTONS</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">JSIOCGNAME</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>

<span class="cp">#ifdef TIOCGLTC</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">TIOCGLTC</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">TIOCSLTC</span><span class="p">)</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef TIOCSTART</span>
<span class="cm">/*</span>
<span class="cm"> * For these two we have definitions in ioctls.h and/or termios.h on</span>
<span class="cm"> * some architectures but no actual implemention.  Some applications</span>
<span class="cm"> * like bash call them if they are defined in the headers, so we provide</span>
<span class="cm"> * entries here to avoid syslog message spew.</span>
<span class="cm"> */</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">TIOCSTART</span><span class="p">)</span>
<span class="n">COMPATIBLE_IOCTL</span><span class="p">(</span><span class="n">TIOCSTOP</span><span class="p">)</span>
<span class="cp">#endif</span>

<span class="cm">/* fat &#39;r&#39; ioctls. These are handled by fat with -&gt;compat_ioctl,</span>
<span class="cm">   but we don&#39;t want warnings on other file systems. So declare</span>
<span class="cm">   them as compatible here. */</span>
<span class="cp">#define VFAT_IOCTL_READDIR_BOTH32       _IOR(&#39;r&#39;, 1, struct compat_dirent[2])</span>
<span class="cp">#define VFAT_IOCTL_READDIR_SHORT32      _IOR(&#39;r&#39;, 2, struct compat_dirent[2])</span>

<span class="n">IGNORE_IOCTL</span><span class="p">(</span><span class="n">VFAT_IOCTL_READDIR_BOTH32</span><span class="p">)</span>
<span class="n">IGNORE_IOCTL</span><span class="p">(</span><span class="n">VFAT_IOCTL_READDIR_SHORT32</span><span class="p">)</span>

<span class="cp">#ifdef CONFIG_SPARC</span>
<span class="cm">/* Sparc framebuffers, handled in sbusfb_compat_ioctl() */</span>
<span class="n">IGNORE_IOCTL</span><span class="p">(</span><span class="n">FBIOGTYPE</span><span class="p">)</span>
<span class="n">IGNORE_IOCTL</span><span class="p">(</span><span class="n">FBIOSATTR</span><span class="p">)</span>
<span class="n">IGNORE_IOCTL</span><span class="p">(</span><span class="n">FBIOGATTR</span><span class="p">)</span>
<span class="n">IGNORE_IOCTL</span><span class="p">(</span><span class="n">FBIOSVIDEO</span><span class="p">)</span>
<span class="n">IGNORE_IOCTL</span><span class="p">(</span><span class="n">FBIOGVIDEO</span><span class="p">)</span>
<span class="n">IGNORE_IOCTL</span><span class="p">(</span><span class="n">FBIOSCURPOS</span><span class="p">)</span>
<span class="n">IGNORE_IOCTL</span><span class="p">(</span><span class="n">FBIOGCURPOS</span><span class="p">)</span>
<span class="n">IGNORE_IOCTL</span><span class="p">(</span><span class="n">FBIOGCURMAX</span><span class="p">)</span>
<span class="n">IGNORE_IOCTL</span><span class="p">(</span><span class="n">FBIOPUTCMAP32</span><span class="p">)</span>
<span class="n">IGNORE_IOCTL</span><span class="p">(</span><span class="n">FBIOGETCMAP32</span><span class="p">)</span>
<span class="n">IGNORE_IOCTL</span><span class="p">(</span><span class="n">FBIOSCURSOR32</span><span class="p">)</span>
<span class="n">IGNORE_IOCTL</span><span class="p">(</span><span class="n">FBIOGCURSOR32</span><span class="p">)</span>
<span class="cp">#endif</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * Convert common ioctl arguments based on their command number</span>
<span class="cm"> *</span>
<span class="cm"> * Please do not add any code in here. Instead, implement</span>
<span class="cm"> * a compat_ioctl operation in the place that handleѕ the</span>
<span class="cm"> * ioctl for the native case.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">long</span> <span class="nf">do_ioctl_trans</span><span class="p">(</span><span class="kt">int</span> <span class="n">fd</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span>
		 <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">arg</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="n">argp</span> <span class="o">=</span> <span class="n">compat_ptr</span><span class="p">(</span><span class="n">arg</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">PPPIOCGIDLE32</span>:
		<span class="k">return</span> <span class="n">ppp_gidle</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">argp</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">PPPIOCSCOMPRESS32</span>:
		<span class="k">return</span> <span class="n">ppp_scompress</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">argp</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">PPPIOCSPASS32</span>:
	<span class="k">case</span> <span class="n">PPPIOCSACTIVE32</span>:
		<span class="k">return</span> <span class="n">ppp_sock_fprog_ioctl_trans</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">argp</span><span class="p">);</span>
<span class="cp">#ifdef CONFIG_BLOCK</span>
	<span class="k">case</span> <span class="n">SG_IO</span>:
		<span class="k">return</span> <span class="n">sg_ioctl_trans</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">argp</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">SG_GET_REQUEST_TABLE</span>:
		<span class="k">return</span> <span class="n">sg_grt_trans</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">argp</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">MTIOCGET32</span>:
	<span class="k">case</span> <span class="n">MTIOCPOS32</span>:
		<span class="k">return</span> <span class="n">mt_ioctl_trans</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">argp</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="cm">/* Serial */</span>
	<span class="k">case</span> <span class="n">TIOCGSERIAL</span>:
	<span class="k">case</span> <span class="n">TIOCSSERIAL</span>:
		<span class="k">return</span> <span class="n">serial_struct_ioctl</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">argp</span><span class="p">);</span>
	<span class="cm">/* i2c */</span>
	<span class="k">case</span> <span class="n">I2C_FUNCS</span>:
		<span class="k">return</span> <span class="n">w_long</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">argp</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">I2C_RDWR</span>:
		<span class="k">return</span> <span class="n">do_i2c_rdwr_ioctl</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">argp</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">I2C_SMBUS</span>:
		<span class="k">return</span> <span class="n">do_i2c_smbus_ioctl</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">argp</span><span class="p">);</span>
	<span class="cm">/* Not implemented in the native kernel */</span>
	<span class="k">case</span> <span class="n">RTC_IRQP_READ32</span>:
	<span class="k">case</span> <span class="n">RTC_IRQP_SET32</span>:
	<span class="k">case</span> <span class="n">RTC_EPOCH_READ32</span>:
	<span class="k">case</span> <span class="n">RTC_EPOCH_SET32</span>:
		<span class="k">return</span> <span class="n">rtc_ioctl</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">argp</span><span class="p">);</span>

	<span class="cm">/* dvb */</span>
	<span class="k">case</span> <span class="n">VIDEO_GET_EVENT</span>:
		<span class="k">return</span> <span class="n">do_video_get_event</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">argp</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">VIDEO_STILLPICTURE</span>:
		<span class="k">return</span> <span class="n">do_video_stillpicture</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">argp</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">VIDEO_SET_SPU_PALETTE</span>:
		<span class="k">return</span> <span class="n">do_video_set_spu_palette</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">argp</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * These take an integer instead of a pointer as &#39;arg&#39;,</span>
<span class="cm">	 * so we must not do a compat_ptr() translation.</span>
<span class="cm">	 */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
	<span class="cm">/* Big T */</span>
	<span class="k">case</span> <span class="n">TCSBRKP</span>:
	<span class="k">case</span> <span class="n">TIOCMIWAIT</span>:
	<span class="k">case</span> <span class="n">TIOCSCTTY</span>:
	<span class="cm">/* RAID */</span>
	<span class="k">case</span> <span class="n">HOT_REMOVE_DISK</span>:
	<span class="k">case</span> <span class="n">HOT_ADD_DISK</span>:
	<span class="k">case</span> <span class="n">SET_DISK_FAULTY</span>:
	<span class="k">case</span> <span class="n">SET_BITMAP_FILE</span>:
	<span class="cm">/* Big K */</span>
	<span class="k">case</span> <span class="n">KDSIGACCEPT</span>:
	<span class="k">case</span> <span class="n">KIOCSOUND</span>:
	<span class="k">case</span> <span class="n">KDMKTONE</span>:
	<span class="k">case</span> <span class="n">KDSETMODE</span>:
	<span class="k">case</span> <span class="n">KDSKBMODE</span>:
	<span class="k">case</span> <span class="n">KDSKBMETA</span>:
	<span class="k">case</span> <span class="n">KDSKBLED</span>:
	<span class="k">case</span> <span class="n">KDSETLED</span>:
	<span class="cm">/* NBD */</span>
	<span class="k">case</span> <span class="n">NBD_SET_SOCK</span>:
	<span class="k">case</span> <span class="n">NBD_SET_BLKSIZE</span>:
	<span class="k">case</span> <span class="n">NBD_SET_SIZE</span>:
	<span class="k">case</span> <span class="n">NBD_SET_SIZE_BLOCKS</span>:
		<span class="k">return</span> <span class="n">do_vfs_ioctl</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">fd</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">arg</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="o">-</span><span class="n">ENOIOCTLCMD</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">compat_ioctl_check_table</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">xcmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">int</span> <span class="n">max</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">ioctl_pointer</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">BUILD_BUG_ON</span><span class="p">(</span><span class="n">max</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">));</span>

	<span class="cm">/* guess initial offset into table, assuming a</span>
<span class="cm">	   normalized distribution */</span>
	<span class="n">i</span> <span class="o">=</span> <span class="p">((</span><span class="n">xcmd</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">*</span> <span class="n">max</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">;</span>

	<span class="cm">/* do linear search up first, until greater or equal */</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">ioctl_pointer</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">xcmd</span> <span class="o">&amp;&amp;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">max</span><span class="p">)</span>
		<span class="n">i</span><span class="o">++</span><span class="p">;</span>

	<span class="cm">/* then do linear search down */</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">ioctl_pointer</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">xcmd</span> <span class="o">&amp;&amp;</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">i</span><span class="o">--</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">ioctl_pointer</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">xcmd</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">asmlinkage</span> <span class="kt">long</span> <span class="nf">compat_sys_ioctl</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">fd</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span>
				<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">filp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBADF</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">fput_needed</span><span class="p">;</span>

	<span class="n">filp</span> <span class="o">=</span> <span class="n">fget_light</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fput_needed</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">filp</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="cm">/* RED-PEN how should LSM module know it&#39;s handling 32bit? */</span>
	<span class="n">error</span> <span class="o">=</span> <span class="n">security_file_ioctl</span><span class="p">(</span><span class="n">filp</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">arg</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_fput</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * To allow the compat_ioctl handlers to be self contained</span>
<span class="cm">	 * we need to check the common ioctls here first.</span>
<span class="cm">	 * Just handle them with the standard handlers below.</span>
<span class="cm">	 */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">FIOCLEX</span>:
	<span class="k">case</span> <span class="n">FIONCLEX</span>:
	<span class="k">case</span> <span class="n">FIONBIO</span>:
	<span class="k">case</span> <span class="n">FIOASYNC</span>:
	<span class="k">case</span> <span class="n">FIOQSIZE</span>:
		<span class="k">break</span><span class="p">;</span>

<span class="cp">#if defined(CONFIG_IA64) || defined(CONFIG_X86_64)</span>
	<span class="k">case</span> <span class="n">FS_IOC_RESVSP_32</span>:
	<span class="k">case</span> <span class="n">FS_IOC_RESVSP64_32</span>:
		<span class="n">error</span> <span class="o">=</span> <span class="n">compat_ioctl_preallocate</span><span class="p">(</span><span class="n">filp</span><span class="p">,</span> <span class="n">compat_ptr</span><span class="p">(</span><span class="n">arg</span><span class="p">));</span>
		<span class="k">goto</span> <span class="n">out_fput</span><span class="p">;</span>
<span class="cp">#else</span>
	<span class="k">case</span> <span class="n">FS_IOC_RESVSP</span>:
	<span class="k">case</span> <span class="n">FS_IOC_RESVSP64</span>:
		<span class="n">error</span> <span class="o">=</span> <span class="n">ioctl_preallocate</span><span class="p">(</span><span class="n">filp</span><span class="p">,</span> <span class="n">compat_ptr</span><span class="p">(</span><span class="n">arg</span><span class="p">));</span>
		<span class="k">goto</span> <span class="n">out_fput</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="k">case</span> <span class="n">FIBMAP</span>:
	<span class="k">case</span> <span class="n">FIGETBSZ</span>:
	<span class="k">case</span> <span class="n">FIONREAD</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">S_ISREG</span><span class="p">(</span><span class="n">filp</span><span class="o">-&gt;</span><span class="n">f_path</span><span class="p">.</span><span class="n">dentry</span><span class="o">-&gt;</span><span class="n">d_inode</span><span class="o">-&gt;</span><span class="n">i_mode</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="cm">/*FALL THROUGH*/</span>

	<span class="nl">default:</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">filp</span><span class="o">-&gt;</span><span class="n">f_op</span> <span class="o">&amp;&amp;</span> <span class="n">filp</span><span class="o">-&gt;</span><span class="n">f_op</span><span class="o">-&gt;</span><span class="n">compat_ioctl</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">error</span> <span class="o">=</span> <span class="n">filp</span><span class="o">-&gt;</span><span class="n">f_op</span><span class="o">-&gt;</span><span class="n">compat_ioctl</span><span class="p">(</span><span class="n">filp</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">arg</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">error</span> <span class="o">!=</span> <span class="o">-</span><span class="n">ENOIOCTLCMD</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">out_fput</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">filp</span><span class="o">-&gt;</span><span class="n">f_op</span> <span class="o">||</span> <span class="o">!</span><span class="n">filp</span><span class="o">-&gt;</span><span class="n">f_op</span><span class="o">-&gt;</span><span class="n">unlocked_ioctl</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">do_ioctl</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">compat_ioctl_check_table</span><span class="p">(</span><span class="n">XFORM</span><span class="p">(</span><span class="n">cmd</span><span class="p">)))</span>
		<span class="k">goto</span> <span class="n">found_handler</span><span class="p">;</span>

	<span class="n">error</span> <span class="o">=</span> <span class="n">do_ioctl_trans</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">arg</span><span class="p">,</span> <span class="n">filp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span> <span class="o">==</span> <span class="o">-</span><span class="n">ENOIOCTLCMD</span><span class="p">)</span>
		<span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOTTY</span><span class="p">;</span>

	<span class="k">goto</span> <span class="n">out_fput</span><span class="p">;</span>

 <span class="nl">found_handler:</span>
	<span class="n">arg</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">compat_ptr</span><span class="p">(</span><span class="n">arg</span><span class="p">);</span>
 <span class="nl">do_ioctl:</span>
	<span class="n">error</span> <span class="o">=</span> <span class="n">do_vfs_ioctl</span><span class="p">(</span><span class="n">filp</span><span class="p">,</span> <span class="n">fd</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">arg</span><span class="p">);</span>
 <span class="nl">out_fput:</span>
	<span class="n">fput_light</span><span class="p">(</span><span class="n">filp</span><span class="p">,</span> <span class="n">fput_needed</span><span class="p">);</span>
 <span class="nl">out:</span>
	<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">init_sys32_ioctl_cmp</span><span class="p">(</span><span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">q</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">;</span>
	<span class="n">a</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="p">)</span><span class="n">p</span><span class="p">;</span>
	<span class="n">b</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="p">)</span><span class="n">q</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">a</span> <span class="o">&gt;</span> <span class="n">b</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">a</span> <span class="o">&lt;</span> <span class="n">b</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">init_sys32_ioctl</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">sort</span><span class="p">(</span><span class="n">ioctl_pointer</span><span class="p">,</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">ioctl_pointer</span><span class="p">),</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">ioctl_pointer</span><span class="p">),</span>
		<span class="n">init_sys32_ioctl_cmp</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">__initcall</span><span class="p">(</span><span class="n">init_sys32_ioctl</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:1}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../javascript/docco.min.js"></script>
</html>
