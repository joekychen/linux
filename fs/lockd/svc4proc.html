<!DOCTYPE html>
<html><head><title>joekychen/linux » fs › lockd › svc4proc.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>svc4proc.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * linux/fs/lockd/svc4proc.c</span>
<span class="cm"> *</span>
<span class="cm"> * Lockd server procedures. We don&#39;t implement the NLM_*_RES </span>
<span class="cm"> * procedures because we don&#39;t use the async procedures.</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 1996, Olaf Kirch &lt;okir@monad.swb.de&gt;</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/types.h&gt;</span>
<span class="cp">#include &lt;linux/time.h&gt;</span>
<span class="cp">#include &lt;linux/lockd/lockd.h&gt;</span>
<span class="cp">#include &lt;linux/lockd/share.h&gt;</span>

<span class="cp">#define NLMDBG_FACILITY		NLMDBG_CLIENT</span>

<span class="cm">/*</span>
<span class="cm"> * Obtain client and file from arguments</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">__be32</span>
<span class="nf">nlm4svc_retrieve_args</span><span class="p">(</span><span class="k">struct</span> <span class="n">svc_rqst</span> <span class="o">*</span><span class="n">rqstp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nlm_args</span> <span class="o">*</span><span class="n">argp</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">nlm_host</span> <span class="o">**</span><span class="n">hostp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nlm_file</span> <span class="o">**</span><span class="n">filp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nlm_host</span>		<span class="o">*</span><span class="n">host</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nlm_file</span>		<span class="o">*</span><span class="n">file</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nlm_lock</span>		<span class="o">*</span><span class="n">lock</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">argp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">;</span>
	<span class="n">__be32</span>			<span class="n">error</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* nfsd callbacks must have been installed for this procedure */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">nlmsvc_ops</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">nlm_lck_denied_nolocks</span><span class="p">;</span>

	<span class="cm">/* Obtain host handle */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">host</span> <span class="o">=</span> <span class="n">nlmsvc_lookup_host</span><span class="p">(</span><span class="n">rqstp</span><span class="p">,</span> <span class="n">lock</span><span class="o">-&gt;</span><span class="n">caller</span><span class="p">,</span> <span class="n">lock</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">))</span>
	 <span class="o">||</span> <span class="p">(</span><span class="n">argp</span><span class="o">-&gt;</span><span class="n">monitor</span> <span class="o">&amp;&amp;</span> <span class="n">nsm_monitor</span><span class="p">(</span><span class="n">host</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">no_locks</span><span class="p">;</span>
	<span class="o">*</span><span class="n">hostp</span> <span class="o">=</span> <span class="n">host</span><span class="p">;</span>

	<span class="cm">/* Obtain file pointer. Not used by FREE_ALL call. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">filp</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">error</span> <span class="o">=</span> <span class="n">nlm_lookup_file</span><span class="p">(</span><span class="n">rqstp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">file</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">lock</span><span class="o">-&gt;</span><span class="n">fh</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">no_locks</span><span class="p">;</span>
		<span class="o">*</span><span class="n">filp</span> <span class="o">=</span> <span class="n">file</span><span class="p">;</span>

		<span class="cm">/* Set up the missing parts of the file_lock structure */</span>
		<span class="n">lock</span><span class="o">-&gt;</span><span class="n">fl</span><span class="p">.</span><span class="n">fl_file</span>  <span class="o">=</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">f_file</span><span class="p">;</span>
		<span class="n">lock</span><span class="o">-&gt;</span><span class="n">fl</span><span class="p">.</span><span class="n">fl_owner</span> <span class="o">=</span> <span class="p">(</span><span class="n">fl_owner_t</span><span class="p">)</span> <span class="n">host</span><span class="p">;</span>
		<span class="n">lock</span><span class="o">-&gt;</span><span class="n">fl</span><span class="p">.</span><span class="n">fl_lmops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">nlmsvc_lock_operations</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">no_locks:</span>
	<span class="n">nlmsvc_release_host</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>
 	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">error</span><span class="p">;</span>	
	<span class="k">return</span> <span class="n">nlm_lck_denied_nolocks</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * NULL: Test for presence of service</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">__be32</span>
<span class="nf">nlm4svc_proc_null</span><span class="p">(</span><span class="k">struct</span> <span class="n">svc_rqst</span> <span class="o">*</span><span class="n">rqstp</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">argp</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">resp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;lockd: NULL          called</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rpc_success</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * TEST: Check for conflicting lock</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">__be32</span>
<span class="nf">nlm4svc_proc_test</span><span class="p">(</span><span class="k">struct</span> <span class="n">svc_rqst</span> <span class="o">*</span><span class="n">rqstp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nlm_args</span> <span class="o">*</span><span class="n">argp</span><span class="p">,</span>
				         <span class="k">struct</span> <span class="n">nlm_res</span>  <span class="o">*</span><span class="n">resp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nlm_host</span>	<span class="o">*</span><span class="n">host</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nlm_file</span>	<span class="o">*</span><span class="n">file</span><span class="p">;</span>
	<span class="n">__be32</span> <span class="n">rc</span> <span class="o">=</span> <span class="n">rpc_success</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;lockd: TEST4        called</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">resp</span><span class="o">-&gt;</span><span class="n">cookie</span> <span class="o">=</span> <span class="n">argp</span><span class="o">-&gt;</span><span class="n">cookie</span><span class="p">;</span>

	<span class="cm">/* Obtain client and file */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">resp</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">nlm4svc_retrieve_args</span><span class="p">(</span><span class="n">rqstp</span><span class="p">,</span> <span class="n">argp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">host</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">file</span><span class="p">)))</span>
		<span class="k">return</span> <span class="n">resp</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">==</span> <span class="n">nlm_drop_reply</span> <span class="o">?</span> <span class="n">rpc_drop_reply</span> <span class="o">:</span><span class="n">rpc_success</span><span class="p">;</span>

	<span class="cm">/* Now check for conflicting locks */</span>
	<span class="n">resp</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">nlmsvc_testlock</span><span class="p">(</span><span class="n">rqstp</span><span class="p">,</span> <span class="n">file</span><span class="p">,</span> <span class="n">host</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">argp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">resp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">resp</span><span class="o">-&gt;</span><span class="n">cookie</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">resp</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">==</span> <span class="n">nlm_drop_reply</span><span class="p">)</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">rpc_drop_reply</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;lockd: TEST4        status %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ntohl</span><span class="p">(</span><span class="n">resp</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">));</span>

	<span class="n">nlmsvc_release_host</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>
	<span class="n">nlm_release_file</span><span class="p">(</span><span class="n">file</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">__be32</span>
<span class="nf">nlm4svc_proc_lock</span><span class="p">(</span><span class="k">struct</span> <span class="n">svc_rqst</span> <span class="o">*</span><span class="n">rqstp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nlm_args</span> <span class="o">*</span><span class="n">argp</span><span class="p">,</span>
				         <span class="k">struct</span> <span class="n">nlm_res</span>  <span class="o">*</span><span class="n">resp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nlm_host</span>	<span class="o">*</span><span class="n">host</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nlm_file</span>	<span class="o">*</span><span class="n">file</span><span class="p">;</span>
	<span class="n">__be32</span> <span class="n">rc</span> <span class="o">=</span> <span class="n">rpc_success</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;lockd: LOCK          called</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">resp</span><span class="o">-&gt;</span><span class="n">cookie</span> <span class="o">=</span> <span class="n">argp</span><span class="o">-&gt;</span><span class="n">cookie</span><span class="p">;</span>

	<span class="cm">/* Obtain client and file */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">resp</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">nlm4svc_retrieve_args</span><span class="p">(</span><span class="n">rqstp</span><span class="p">,</span> <span class="n">argp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">host</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">file</span><span class="p">)))</span>
		<span class="k">return</span> <span class="n">resp</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">==</span> <span class="n">nlm_drop_reply</span> <span class="o">?</span> <span class="n">rpc_drop_reply</span> <span class="o">:</span><span class="n">rpc_success</span><span class="p">;</span>

<span class="cp">#if 0</span><span class="c"></span>
<span class="c">	/* If supplied state doesn&#39;t match current state, we assume it&#39;s</span>
<span class="c">	 * an old request that time-warped somehow. Any error return would</span>
<span class="c">	 * do in this case because it&#39;s irrelevant anyway.</span>
<span class="c">	 *</span>
<span class="c">	 * NB: We don&#39;t retrieve the remote host&#39;s state yet.</span>
<span class="c">	 */</span>
<span class="c">	if (host-&gt;h_nsmstate &amp;&amp; host-&gt;h_nsmstate != argp-&gt;state) {</span>
<span class="c">		resp-&gt;status = nlm_lck_denied_nolocks;</span>
<span class="c">	} else</span>
<span class="cp">#endif</span>

	<span class="cm">/* Now try to lock the file */</span>
	<span class="n">resp</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">nlmsvc_lock</span><span class="p">(</span><span class="n">rqstp</span><span class="p">,</span> <span class="n">file</span><span class="p">,</span> <span class="n">host</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">argp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span>
					<span class="n">argp</span><span class="o">-&gt;</span><span class="n">block</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">argp</span><span class="o">-&gt;</span><span class="n">cookie</span><span class="p">,</span>
					<span class="n">argp</span><span class="o">-&gt;</span><span class="n">reclaim</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">resp</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">==</span> <span class="n">nlm_drop_reply</span><span class="p">)</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">rpc_drop_reply</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;lockd: LOCK         status %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ntohl</span><span class="p">(</span><span class="n">resp</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">));</span>

	<span class="n">nlmsvc_release_host</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>
	<span class="n">nlm_release_file</span><span class="p">(</span><span class="n">file</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">__be32</span>
<span class="nf">nlm4svc_proc_cancel</span><span class="p">(</span><span class="k">struct</span> <span class="n">svc_rqst</span> <span class="o">*</span><span class="n">rqstp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nlm_args</span> <span class="o">*</span><span class="n">argp</span><span class="p">,</span>
				           <span class="k">struct</span> <span class="n">nlm_res</span>  <span class="o">*</span><span class="n">resp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nlm_host</span>	<span class="o">*</span><span class="n">host</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nlm_file</span>	<span class="o">*</span><span class="n">file</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;lockd: CANCEL        called</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">resp</span><span class="o">-&gt;</span><span class="n">cookie</span> <span class="o">=</span> <span class="n">argp</span><span class="o">-&gt;</span><span class="n">cookie</span><span class="p">;</span>

	<span class="cm">/* Don&#39;t accept requests during grace period */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">locks_in_grace</span><span class="p">())</span> <span class="p">{</span>
		<span class="n">resp</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">nlm_lck_denied_grace_period</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">rpc_success</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Obtain client and file */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">resp</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">nlm4svc_retrieve_args</span><span class="p">(</span><span class="n">rqstp</span><span class="p">,</span> <span class="n">argp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">host</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">file</span><span class="p">)))</span>
		<span class="k">return</span> <span class="n">resp</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">==</span> <span class="n">nlm_drop_reply</span> <span class="o">?</span> <span class="n">rpc_drop_reply</span> <span class="o">:</span><span class="n">rpc_success</span><span class="p">;</span>

	<span class="cm">/* Try to cancel request. */</span>
	<span class="n">resp</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">nlmsvc_cancel_blocked</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">argp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;lockd: CANCEL        status %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ntohl</span><span class="p">(</span><span class="n">resp</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">));</span>
	<span class="n">nlmsvc_release_host</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>
	<span class="n">nlm_release_file</span><span class="p">(</span><span class="n">file</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rpc_success</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * UNLOCK: release a lock</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">__be32</span>
<span class="nf">nlm4svc_proc_unlock</span><span class="p">(</span><span class="k">struct</span> <span class="n">svc_rqst</span> <span class="o">*</span><span class="n">rqstp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nlm_args</span> <span class="o">*</span><span class="n">argp</span><span class="p">,</span>
				           <span class="k">struct</span> <span class="n">nlm_res</span>  <span class="o">*</span><span class="n">resp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nlm_host</span>	<span class="o">*</span><span class="n">host</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nlm_file</span>	<span class="o">*</span><span class="n">file</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;lockd: UNLOCK        called</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">resp</span><span class="o">-&gt;</span><span class="n">cookie</span> <span class="o">=</span> <span class="n">argp</span><span class="o">-&gt;</span><span class="n">cookie</span><span class="p">;</span>

	<span class="cm">/* Don&#39;t accept new lock requests during grace period */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">locks_in_grace</span><span class="p">())</span> <span class="p">{</span>
		<span class="n">resp</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">nlm_lck_denied_grace_period</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">rpc_success</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Obtain client and file */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">resp</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">nlm4svc_retrieve_args</span><span class="p">(</span><span class="n">rqstp</span><span class="p">,</span> <span class="n">argp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">host</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">file</span><span class="p">)))</span>
		<span class="k">return</span> <span class="n">resp</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">==</span> <span class="n">nlm_drop_reply</span> <span class="o">?</span> <span class="n">rpc_drop_reply</span> <span class="o">:</span><span class="n">rpc_success</span><span class="p">;</span>

	<span class="cm">/* Now try to remove the lock */</span>
	<span class="n">resp</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">nlmsvc_unlock</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">argp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;lockd: UNLOCK        status %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ntohl</span><span class="p">(</span><span class="n">resp</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">));</span>
	<span class="n">nlmsvc_release_host</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>
	<span class="n">nlm_release_file</span><span class="p">(</span><span class="n">file</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rpc_success</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * GRANTED: A server calls us to tell that a process&#39; lock request</span>
<span class="cm"> * was granted</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">__be32</span>
<span class="nf">nlm4svc_proc_granted</span><span class="p">(</span><span class="k">struct</span> <span class="n">svc_rqst</span> <span class="o">*</span><span class="n">rqstp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nlm_args</span> <span class="o">*</span><span class="n">argp</span><span class="p">,</span>
				            <span class="k">struct</span> <span class="n">nlm_res</span>  <span class="o">*</span><span class="n">resp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">resp</span><span class="o">-&gt;</span><span class="n">cookie</span> <span class="o">=</span> <span class="n">argp</span><span class="o">-&gt;</span><span class="n">cookie</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;lockd: GRANTED       called</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">resp</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">nlmclnt_grant</span><span class="p">(</span><span class="n">svc_addr</span><span class="p">(</span><span class="n">rqstp</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">argp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;lockd: GRANTED       status %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ntohl</span><span class="p">(</span><span class="n">resp</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">));</span>
	<span class="k">return</span> <span class="n">rpc_success</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * This is the generic lockd callback for async RPC calls</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">nlm4svc_callback_exit</span><span class="p">(</span><span class="k">struct</span> <span class="n">rpc_task</span> <span class="o">*</span><span class="n">task</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;lockd: %5u callback returned %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">task</span><span class="o">-&gt;</span><span class="n">tk_pid</span><span class="p">,</span>
			<span class="o">-</span><span class="n">task</span><span class="o">-&gt;</span><span class="n">tk_status</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">nlm4svc_callback_release</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">nlmsvc_release_call</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">rpc_call_ops</span> <span class="n">nlm4svc_callback_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">rpc_call_done</span> <span class="o">=</span> <span class="n">nlm4svc_callback_exit</span><span class="p">,</span>
	<span class="p">.</span><span class="n">rpc_release</span> <span class="o">=</span> <span class="n">nlm4svc_callback_release</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * `Async&#39; versions of the above service routines. They aren&#39;t really,</span>
<span class="cm"> * because we send the callback before the reply proper. I hope this</span>
<span class="cm"> * doesn&#39;t break any clients.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">__be32</span> <span class="nf">nlm4svc_callback</span><span class="p">(</span><span class="k">struct</span> <span class="n">svc_rqst</span> <span class="o">*</span><span class="n">rqstp</span><span class="p">,</span> <span class="n">u32</span> <span class="n">proc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nlm_args</span> <span class="o">*</span><span class="n">argp</span><span class="p">,</span>
		<span class="n">__be32</span> <span class="p">(</span><span class="o">*</span><span class="n">func</span><span class="p">)(</span><span class="k">struct</span> <span class="n">svc_rqst</span> <span class="o">*</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nlm_args</span> <span class="o">*</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nlm_res</span>  <span class="o">*</span><span class="p">))</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nlm_host</span>	<span class="o">*</span><span class="n">host</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nlm_rqst</span>	<span class="o">*</span><span class="n">call</span><span class="p">;</span>
	<span class="n">__be32</span> <span class="n">stat</span><span class="p">;</span>

	<span class="n">host</span> <span class="o">=</span> <span class="n">nlmsvc_lookup_host</span><span class="p">(</span><span class="n">rqstp</span><span class="p">,</span>
				  <span class="n">argp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">.</span><span class="n">caller</span><span class="p">,</span>
				  <span class="n">argp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">.</span><span class="n">len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">host</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rpc_system_err</span><span class="p">;</span>

	<span class="n">call</span> <span class="o">=</span> <span class="n">nlm_alloc_call</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">call</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rpc_system_err</span><span class="p">;</span>

	<span class="n">stat</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="n">rqstp</span><span class="p">,</span> <span class="n">argp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">call</span><span class="o">-&gt;</span><span class="n">a_res</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">stat</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">nlmsvc_release_call</span><span class="p">(</span><span class="n">call</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">stat</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">call</span><span class="o">-&gt;</span><span class="n">a_flags</span> <span class="o">=</span> <span class="n">RPC_TASK_ASYNC</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nlm_async_reply</span><span class="p">(</span><span class="n">call</span><span class="p">,</span> <span class="n">proc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">nlm4svc_callback_ops</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rpc_system_err</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">rpc_success</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">__be32</span> <span class="nf">nlm4svc_proc_test_msg</span><span class="p">(</span><span class="k">struct</span> <span class="n">svc_rqst</span> <span class="o">*</span><span class="n">rqstp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nlm_args</span> <span class="o">*</span><span class="n">argp</span><span class="p">,</span>
					     <span class="kt">void</span>	     <span class="o">*</span><span class="n">resp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;lockd: TEST_MSG      called</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">nlm4svc_callback</span><span class="p">(</span><span class="n">rqstp</span><span class="p">,</span> <span class="n">NLMPROC_TEST_RES</span><span class="p">,</span> <span class="n">argp</span><span class="p">,</span> <span class="n">nlm4svc_proc_test</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">__be32</span> <span class="nf">nlm4svc_proc_lock_msg</span><span class="p">(</span><span class="k">struct</span> <span class="n">svc_rqst</span> <span class="o">*</span><span class="n">rqstp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nlm_args</span> <span class="o">*</span><span class="n">argp</span><span class="p">,</span>
					     <span class="kt">void</span>	     <span class="o">*</span><span class="n">resp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;lockd: LOCK_MSG      called</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">nlm4svc_callback</span><span class="p">(</span><span class="n">rqstp</span><span class="p">,</span> <span class="n">NLMPROC_LOCK_RES</span><span class="p">,</span> <span class="n">argp</span><span class="p">,</span> <span class="n">nlm4svc_proc_lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">__be32</span> <span class="nf">nlm4svc_proc_cancel_msg</span><span class="p">(</span><span class="k">struct</span> <span class="n">svc_rqst</span> <span class="o">*</span><span class="n">rqstp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nlm_args</span> <span class="o">*</span><span class="n">argp</span><span class="p">,</span>
					       <span class="kt">void</span>	       <span class="o">*</span><span class="n">resp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;lockd: CANCEL_MSG    called</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">nlm4svc_callback</span><span class="p">(</span><span class="n">rqstp</span><span class="p">,</span> <span class="n">NLMPROC_CANCEL_RES</span><span class="p">,</span> <span class="n">argp</span><span class="p">,</span> <span class="n">nlm4svc_proc_cancel</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">__be32</span> <span class="nf">nlm4svc_proc_unlock_msg</span><span class="p">(</span><span class="k">struct</span> <span class="n">svc_rqst</span> <span class="o">*</span><span class="n">rqstp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nlm_args</span> <span class="o">*</span><span class="n">argp</span><span class="p">,</span>
                                               <span class="kt">void</span>            <span class="o">*</span><span class="n">resp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;lockd: UNLOCK_MSG    called</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">nlm4svc_callback</span><span class="p">(</span><span class="n">rqstp</span><span class="p">,</span> <span class="n">NLMPROC_UNLOCK_RES</span><span class="p">,</span> <span class="n">argp</span><span class="p">,</span> <span class="n">nlm4svc_proc_unlock</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">__be32</span> <span class="nf">nlm4svc_proc_granted_msg</span><span class="p">(</span><span class="k">struct</span> <span class="n">svc_rqst</span> <span class="o">*</span><span class="n">rqstp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nlm_args</span> <span class="o">*</span><span class="n">argp</span><span class="p">,</span>
                                                <span class="kt">void</span>            <span class="o">*</span><span class="n">resp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;lockd: GRANTED_MSG   called</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">nlm4svc_callback</span><span class="p">(</span><span class="n">rqstp</span><span class="p">,</span> <span class="n">NLMPROC_GRANTED_RES</span><span class="p">,</span> <span class="n">argp</span><span class="p">,</span> <span class="n">nlm4svc_proc_granted</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * SHARE: create a DOS share or alter existing share.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">__be32</span>
<span class="nf">nlm4svc_proc_share</span><span class="p">(</span><span class="k">struct</span> <span class="n">svc_rqst</span> <span class="o">*</span><span class="n">rqstp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nlm_args</span> <span class="o">*</span><span class="n">argp</span><span class="p">,</span>
				          <span class="k">struct</span> <span class="n">nlm_res</span>  <span class="o">*</span><span class="n">resp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nlm_host</span>	<span class="o">*</span><span class="n">host</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nlm_file</span>	<span class="o">*</span><span class="n">file</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;lockd: SHARE         called</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">resp</span><span class="o">-&gt;</span><span class="n">cookie</span> <span class="o">=</span> <span class="n">argp</span><span class="o">-&gt;</span><span class="n">cookie</span><span class="p">;</span>

	<span class="cm">/* Don&#39;t accept new lock requests during grace period */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">locks_in_grace</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">argp</span><span class="o">-&gt;</span><span class="n">reclaim</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">resp</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">nlm_lck_denied_grace_period</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">rpc_success</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Obtain client and file */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">resp</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">nlm4svc_retrieve_args</span><span class="p">(</span><span class="n">rqstp</span><span class="p">,</span> <span class="n">argp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">host</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">file</span><span class="p">)))</span>
		<span class="k">return</span> <span class="n">resp</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">==</span> <span class="n">nlm_drop_reply</span> <span class="o">?</span> <span class="n">rpc_drop_reply</span> <span class="o">:</span><span class="n">rpc_success</span><span class="p">;</span>

	<span class="cm">/* Now try to create the share */</span>
	<span class="n">resp</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">nlmsvc_share_file</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">file</span><span class="p">,</span> <span class="n">argp</span><span class="p">);</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;lockd: SHARE         status %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ntohl</span><span class="p">(</span><span class="n">resp</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">));</span>
	<span class="n">nlmsvc_release_host</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>
	<span class="n">nlm_release_file</span><span class="p">(</span><span class="n">file</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rpc_success</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * UNSHARE: Release a DOS share.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">__be32</span>
<span class="nf">nlm4svc_proc_unshare</span><span class="p">(</span><span class="k">struct</span> <span class="n">svc_rqst</span> <span class="o">*</span><span class="n">rqstp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nlm_args</span> <span class="o">*</span><span class="n">argp</span><span class="p">,</span>
				            <span class="k">struct</span> <span class="n">nlm_res</span>  <span class="o">*</span><span class="n">resp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nlm_host</span>	<span class="o">*</span><span class="n">host</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nlm_file</span>	<span class="o">*</span><span class="n">file</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;lockd: UNSHARE       called</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">resp</span><span class="o">-&gt;</span><span class="n">cookie</span> <span class="o">=</span> <span class="n">argp</span><span class="o">-&gt;</span><span class="n">cookie</span><span class="p">;</span>

	<span class="cm">/* Don&#39;t accept requests during grace period */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">locks_in_grace</span><span class="p">())</span> <span class="p">{</span>
		<span class="n">resp</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">nlm_lck_denied_grace_period</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">rpc_success</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Obtain client and file */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">resp</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">nlm4svc_retrieve_args</span><span class="p">(</span><span class="n">rqstp</span><span class="p">,</span> <span class="n">argp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">host</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">file</span><span class="p">)))</span>
		<span class="k">return</span> <span class="n">resp</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">==</span> <span class="n">nlm_drop_reply</span> <span class="o">?</span> <span class="n">rpc_drop_reply</span> <span class="o">:</span><span class="n">rpc_success</span><span class="p">;</span>

	<span class="cm">/* Now try to lock the file */</span>
	<span class="n">resp</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">nlmsvc_unshare_file</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">file</span><span class="p">,</span> <span class="n">argp</span><span class="p">);</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;lockd: UNSHARE       status %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ntohl</span><span class="p">(</span><span class="n">resp</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">));</span>
	<span class="n">nlmsvc_release_host</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>
	<span class="n">nlm_release_file</span><span class="p">(</span><span class="n">file</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rpc_success</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * NM_LOCK: Create an unmonitored lock</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">__be32</span>
<span class="nf">nlm4svc_proc_nm_lock</span><span class="p">(</span><span class="k">struct</span> <span class="n">svc_rqst</span> <span class="o">*</span><span class="n">rqstp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nlm_args</span> <span class="o">*</span><span class="n">argp</span><span class="p">,</span>
				            <span class="k">struct</span> <span class="n">nlm_res</span>  <span class="o">*</span><span class="n">resp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;lockd: NM_LOCK       called</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">argp</span><span class="o">-&gt;</span><span class="n">monitor</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>		<span class="cm">/* just clean the monitor flag */</span>
	<span class="k">return</span> <span class="n">nlm4svc_proc_lock</span><span class="p">(</span><span class="n">rqstp</span><span class="p">,</span> <span class="n">argp</span><span class="p">,</span> <span class="n">resp</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * FREE_ALL: Release all locks and shares held by client</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">__be32</span>
<span class="nf">nlm4svc_proc_free_all</span><span class="p">(</span><span class="k">struct</span> <span class="n">svc_rqst</span> <span class="o">*</span><span class="n">rqstp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nlm_args</span> <span class="o">*</span><span class="n">argp</span><span class="p">,</span>
					     <span class="kt">void</span>            <span class="o">*</span><span class="n">resp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nlm_host</span>	<span class="o">*</span><span class="n">host</span><span class="p">;</span>

	<span class="cm">/* Obtain client */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nlm4svc_retrieve_args</span><span class="p">(</span><span class="n">rqstp</span><span class="p">,</span> <span class="n">argp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">host</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">rpc_success</span><span class="p">;</span>

	<span class="n">nlmsvc_free_host_resources</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>
	<span class="n">nlmsvc_release_host</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rpc_success</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * SM_NOTIFY: private callback from statd (not part of official NLM proto)</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">__be32</span>
<span class="nf">nlm4svc_proc_sm_notify</span><span class="p">(</span><span class="k">struct</span> <span class="n">svc_rqst</span> <span class="o">*</span><span class="n">rqstp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nlm_reboot</span> <span class="o">*</span><span class="n">argp</span><span class="p">,</span>
					      <span class="kt">void</span>	        <span class="o">*</span><span class="n">resp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;lockd: SM_NOTIFY     called</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">nlm_privileged_requester</span><span class="p">(</span><span class="n">rqstp</span><span class="p">))</span> <span class="p">{</span>
		<span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="n">RPC_MAX_ADDRBUFLEN</span><span class="p">];</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;lockd: rejected NSM callback from %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">svc_print_addr</span><span class="p">(</span><span class="n">rqstp</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="p">)));</span>
		<span class="k">return</span> <span class="n">rpc_system_err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">nlm_host_rebooted</span><span class="p">(</span><span class="n">argp</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rpc_success</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * client sent a GRANTED_RES, let&#39;s remove the associated block</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">__be32</span>
<span class="nf">nlm4svc_proc_granted_res</span><span class="p">(</span><span class="k">struct</span> <span class="n">svc_rqst</span> <span class="o">*</span><span class="n">rqstp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nlm_res</span>  <span class="o">*</span><span class="n">argp</span><span class="p">,</span>
                                                <span class="kt">void</span>            <span class="o">*</span><span class="n">resp</span><span class="p">)</span>
<span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">nlmsvc_ops</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">rpc_success</span><span class="p">;</span>

        <span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;lockd: GRANTED_RES   called</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

        <span class="n">nlmsvc_grant_reply</span><span class="p">(</span><span class="o">&amp;</span><span class="n">argp</span><span class="o">-&gt;</span><span class="n">cookie</span><span class="p">,</span> <span class="n">argp</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>
        <span class="k">return</span> <span class="n">rpc_success</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * NLM Server procedures.</span>
<span class="cm"> */</span>

<span class="cp">#define nlm4svc_encode_norep	nlm4svc_encode_void</span>
<span class="cp">#define nlm4svc_decode_norep	nlm4svc_decode_void</span>
<span class="cp">#define nlm4svc_decode_testres	nlm4svc_decode_void</span>
<span class="cp">#define nlm4svc_decode_lockres	nlm4svc_decode_void</span>
<span class="cp">#define nlm4svc_decode_unlockres	nlm4svc_decode_void</span>
<span class="cp">#define nlm4svc_decode_cancelres	nlm4svc_decode_void</span>
<span class="cp">#define nlm4svc_decode_grantedres	nlm4svc_decode_void</span>

<span class="cp">#define nlm4svc_proc_none	nlm4svc_proc_null</span>
<span class="cp">#define nlm4svc_proc_test_res	nlm4svc_proc_null</span>
<span class="cp">#define nlm4svc_proc_lock_res	nlm4svc_proc_null</span>
<span class="cp">#define nlm4svc_proc_cancel_res	nlm4svc_proc_null</span>
<span class="cp">#define nlm4svc_proc_unlock_res	nlm4svc_proc_null</span>

<span class="k">struct</span> <span class="n">nlm_void</span>			<span class="p">{</span> <span class="kt">int</span> <span class="n">dummy</span><span class="p">;</span> <span class="p">};</span>

<span class="cp">#define PROC(name, xargt, xrest, argt, rest, respsize)	\</span>
<span class="cp"> { .pc_func	= (svc_procfunc) nlm4svc_proc_##name,	\</span>
<span class="cp">   .pc_decode	= (kxdrproc_t) nlm4svc_decode_##xargt,	\</span>
<span class="cp">   .pc_encode	= (kxdrproc_t) nlm4svc_encode_##xrest,	\</span>
<span class="cp">   .pc_release	= NULL,					\</span>
<span class="cp">   .pc_argsize	= sizeof(struct nlm_##argt),		\</span>
<span class="cp">   .pc_ressize	= sizeof(struct nlm_##rest),		\</span>
<span class="cp">   .pc_xdrressize = respsize,				\</span>
<span class="cp"> }</span>
<span class="cp">#define	Ck	(1+XDR_QUADLEN(NLM_MAXCOOKIELEN))	</span><span class="cm">/* cookie */</span><span class="cp"></span>
<span class="cp">#define	No	(1+1024/4)				</span><span class="cm">/* netobj */</span><span class="cp"></span>
<span class="cp">#define	St	1					</span><span class="cm">/* status */</span><span class="cp"></span>
<span class="cp">#define	Rg	4					</span><span class="cm">/* range (offset + length) */</span><span class="cp"></span>
<span class="k">struct</span> <span class="n">svc_procedure</span>		<span class="n">nlmsvc_procedures4</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
  <span class="n">PROC</span><span class="p">(</span><span class="n">null</span><span class="p">,</span>		<span class="kt">void</span><span class="p">,</span>		<span class="kt">void</span><span class="p">,</span>		<span class="kt">void</span><span class="p">,</span>	<span class="kt">void</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
  <span class="n">PROC</span><span class="p">(</span><span class="n">test</span><span class="p">,</span>		<span class="n">testargs</span><span class="p">,</span>	<span class="n">testres</span><span class="p">,</span>	<span class="n">args</span><span class="p">,</span>	<span class="n">res</span><span class="p">,</span> <span class="n">Ck</span><span class="o">+</span><span class="n">St</span><span class="o">+</span><span class="mi">2</span><span class="o">+</span><span class="n">No</span><span class="o">+</span><span class="n">Rg</span><span class="p">),</span>
  <span class="n">PROC</span><span class="p">(</span><span class="n">lock</span><span class="p">,</span>		<span class="n">lockargs</span><span class="p">,</span>	<span class="n">res</span><span class="p">,</span>		<span class="n">args</span><span class="p">,</span>	<span class="n">res</span><span class="p">,</span> <span class="n">Ck</span><span class="o">+</span><span class="n">St</span><span class="p">),</span>
  <span class="n">PROC</span><span class="p">(</span><span class="n">cancel</span><span class="p">,</span>		<span class="n">cancargs</span><span class="p">,</span>	<span class="n">res</span><span class="p">,</span>		<span class="n">args</span><span class="p">,</span>	<span class="n">res</span><span class="p">,</span> <span class="n">Ck</span><span class="o">+</span><span class="n">St</span><span class="p">),</span>
  <span class="n">PROC</span><span class="p">(</span><span class="n">unlock</span><span class="p">,</span>		<span class="n">unlockargs</span><span class="p">,</span>	<span class="n">res</span><span class="p">,</span>		<span class="n">args</span><span class="p">,</span>	<span class="n">res</span><span class="p">,</span> <span class="n">Ck</span><span class="o">+</span><span class="n">St</span><span class="p">),</span>
  <span class="n">PROC</span><span class="p">(</span><span class="n">granted</span><span class="p">,</span>		<span class="n">testargs</span><span class="p">,</span>	<span class="n">res</span><span class="p">,</span>		<span class="n">args</span><span class="p">,</span>	<span class="n">res</span><span class="p">,</span> <span class="n">Ck</span><span class="o">+</span><span class="n">St</span><span class="p">),</span>
  <span class="n">PROC</span><span class="p">(</span><span class="n">test_msg</span><span class="p">,</span>	<span class="n">testargs</span><span class="p">,</span>	<span class="n">norep</span><span class="p">,</span>		<span class="n">args</span><span class="p">,</span>	<span class="kt">void</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
  <span class="n">PROC</span><span class="p">(</span><span class="n">lock_msg</span><span class="p">,</span>	<span class="n">lockargs</span><span class="p">,</span>	<span class="n">norep</span><span class="p">,</span>		<span class="n">args</span><span class="p">,</span>	<span class="kt">void</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
  <span class="n">PROC</span><span class="p">(</span><span class="n">cancel_msg</span><span class="p">,</span>	<span class="n">cancargs</span><span class="p">,</span>	<span class="n">norep</span><span class="p">,</span>		<span class="n">args</span><span class="p">,</span>	<span class="kt">void</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
  <span class="n">PROC</span><span class="p">(</span><span class="n">unlock_msg</span><span class="p">,</span>	<span class="n">unlockargs</span><span class="p">,</span>	<span class="n">norep</span><span class="p">,</span>		<span class="n">args</span><span class="p">,</span>	<span class="kt">void</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
  <span class="n">PROC</span><span class="p">(</span><span class="n">granted_msg</span><span class="p">,</span>	<span class="n">testargs</span><span class="p">,</span>	<span class="n">norep</span><span class="p">,</span>		<span class="n">args</span><span class="p">,</span>	<span class="kt">void</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
  <span class="n">PROC</span><span class="p">(</span><span class="n">test_res</span><span class="p">,</span>	<span class="n">testres</span><span class="p">,</span>	<span class="n">norep</span><span class="p">,</span>		<span class="n">res</span><span class="p">,</span>	<span class="kt">void</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
  <span class="n">PROC</span><span class="p">(</span><span class="n">lock_res</span><span class="p">,</span>	<span class="n">lockres</span><span class="p">,</span>	<span class="n">norep</span><span class="p">,</span>		<span class="n">res</span><span class="p">,</span>	<span class="kt">void</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
  <span class="n">PROC</span><span class="p">(</span><span class="n">cancel_res</span><span class="p">,</span>	<span class="n">cancelres</span><span class="p">,</span>	<span class="n">norep</span><span class="p">,</span>		<span class="n">res</span><span class="p">,</span>	<span class="kt">void</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
  <span class="n">PROC</span><span class="p">(</span><span class="n">unlock_res</span><span class="p">,</span>	<span class="n">unlockres</span><span class="p">,</span>	<span class="n">norep</span><span class="p">,</span>		<span class="n">res</span><span class="p">,</span>	<span class="kt">void</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
  <span class="n">PROC</span><span class="p">(</span><span class="n">granted_res</span><span class="p">,</span>	<span class="n">res</span><span class="p">,</span>		<span class="n">norep</span><span class="p">,</span>		<span class="n">res</span><span class="p">,</span>	<span class="kt">void</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
  <span class="cm">/* statd callback */</span>
  <span class="n">PROC</span><span class="p">(</span><span class="n">sm_notify</span><span class="p">,</span>	<span class="n">reboot</span><span class="p">,</span>		<span class="kt">void</span><span class="p">,</span>		<span class="n">reboot</span><span class="p">,</span>	<span class="kt">void</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
  <span class="n">PROC</span><span class="p">(</span><span class="n">none</span><span class="p">,</span>		<span class="kt">void</span><span class="p">,</span>		<span class="kt">void</span><span class="p">,</span>		<span class="kt">void</span><span class="p">,</span>	<span class="kt">void</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
  <span class="n">PROC</span><span class="p">(</span><span class="n">none</span><span class="p">,</span>		<span class="kt">void</span><span class="p">,</span>		<span class="kt">void</span><span class="p">,</span>		<span class="kt">void</span><span class="p">,</span>	<span class="kt">void</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
  <span class="n">PROC</span><span class="p">(</span><span class="n">none</span><span class="p">,</span>		<span class="kt">void</span><span class="p">,</span>		<span class="kt">void</span><span class="p">,</span>		<span class="kt">void</span><span class="p">,</span>	<span class="kt">void</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
  <span class="n">PROC</span><span class="p">(</span><span class="n">share</span><span class="p">,</span>		<span class="n">shareargs</span><span class="p">,</span>	<span class="n">shareres</span><span class="p">,</span>	<span class="n">args</span><span class="p">,</span>	<span class="n">res</span><span class="p">,</span> <span class="n">Ck</span><span class="o">+</span><span class="n">St</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span>
  <span class="n">PROC</span><span class="p">(</span><span class="n">unshare</span><span class="p">,</span>		<span class="n">shareargs</span><span class="p">,</span>	<span class="n">shareres</span><span class="p">,</span>	<span class="n">args</span><span class="p">,</span>	<span class="n">res</span><span class="p">,</span> <span class="n">Ck</span><span class="o">+</span><span class="n">St</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span>
  <span class="n">PROC</span><span class="p">(</span><span class="n">nm_lock</span><span class="p">,</span>		<span class="n">lockargs</span><span class="p">,</span>	<span class="n">res</span><span class="p">,</span>		<span class="n">args</span><span class="p">,</span>	<span class="n">res</span><span class="p">,</span> <span class="n">Ck</span><span class="o">+</span><span class="n">St</span><span class="p">),</span>
  <span class="n">PROC</span><span class="p">(</span><span class="n">free_all</span><span class="p">,</span>	<span class="n">notify</span><span class="p">,</span>		<span class="kt">void</span><span class="p">,</span>		<span class="n">args</span><span class="p">,</span>	<span class="kt">void</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>

<span class="p">};</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
