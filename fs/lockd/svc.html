<!DOCTYPE html>
<html><head><title>joekychen/linux » fs › lockd › svc.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>svc.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * linux/fs/lockd/svc.c</span>
<span class="cm"> *</span>
<span class="cm"> * This is the central lockd service.</span>
<span class="cm"> *</span>
<span class="cm"> * FIXME: Separate the lockd NFS server functionality from the lockd NFS</span>
<span class="cm"> * 	  client functionality. Oh why didn&#39;t Sun create two separate</span>
<span class="cm"> *	  services in the first place?</span>
<span class="cm"> *</span>
<span class="cm"> * Authors:	Olaf Kirch (okir@monad.swb.de)</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 1995, 1996 Olaf Kirch &lt;okir@monad.swb.de&gt;</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/sysctl.h&gt;</span>
<span class="cp">#include &lt;linux/moduleparam.h&gt;</span>

<span class="cp">#include &lt;linux/sched.h&gt;</span>
<span class="cp">#include &lt;linux/errno.h&gt;</span>
<span class="cp">#include &lt;linux/in.h&gt;</span>
<span class="cp">#include &lt;linux/uio.h&gt;</span>
<span class="cp">#include &lt;linux/smp.h&gt;</span>
<span class="cp">#include &lt;linux/mutex.h&gt;</span>
<span class="cp">#include &lt;linux/kthread.h&gt;</span>
<span class="cp">#include &lt;linux/freezer.h&gt;</span>

<span class="cp">#include &lt;linux/sunrpc/types.h&gt;</span>
<span class="cp">#include &lt;linux/sunrpc/stats.h&gt;</span>
<span class="cp">#include &lt;linux/sunrpc/clnt.h&gt;</span>
<span class="cp">#include &lt;linux/sunrpc/svc.h&gt;</span>
<span class="cp">#include &lt;linux/sunrpc/svcsock.h&gt;</span>
<span class="cp">#include &lt;net/ip.h&gt;</span>
<span class="cp">#include &lt;linux/lockd/lockd.h&gt;</span>
<span class="cp">#include &lt;linux/nfs.h&gt;</span>

<span class="cp">#include &quot;netns.h&quot;</span>

<span class="cp">#define NLMDBG_FACILITY		NLMDBG_SVC</span>
<span class="cp">#define LOCKD_BUFSIZE		(1024 + NLMSVC_XDRSIZE)</span>
<span class="cp">#define ALLOWED_SIGS		(sigmask(SIGKILL))</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">svc_program</span>	<span class="n">nlmsvc_program</span><span class="p">;</span>

<span class="k">struct</span> <span class="n">nlmsvc_binding</span> <span class="o">*</span>		<span class="n">nlmsvc_ops</span><span class="p">;</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">nlmsvc_ops</span><span class="p">);</span>

<span class="k">static</span> <span class="n">DEFINE_MUTEX</span><span class="p">(</span><span class="n">nlmsvc_mutex</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span>		<span class="n">nlmsvc_users</span><span class="p">;</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">task_struct</span>	<span class="o">*</span><span class="n">nlmsvc_task</span><span class="p">;</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">svc_rqst</span>		<span class="o">*</span><span class="n">nlmsvc_rqst</span><span class="p">;</span>
<span class="kt">unsigned</span> <span class="kt">long</span>			<span class="n">nlmsvc_timeout</span><span class="p">;</span>

<span class="kt">int</span> <span class="n">lockd_net_id</span><span class="p">;</span>

<span class="cm">/*</span>
<span class="cm"> * These can be set at insmod time (useful for NFS as root filesystem),</span>
<span class="cm"> * and also changed through the sysctl interface.  -- Jamie Lokier, Aug 2003</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span>		<span class="n">nlm_grace_period</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span>		<span class="n">nlm_timeout</span> <span class="o">=</span> <span class="n">LOCKD_DFLT_TIMEO</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span>			<span class="n">nlm_udpport</span><span class="p">,</span> <span class="n">nlm_tcpport</span><span class="p">;</span>

<span class="cm">/* RLIM_NOFILE defaults to 1024. That seems like a reasonable default here. */</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span>		<span class="n">nlm_max_connections</span> <span class="o">=</span> <span class="mi">1024</span><span class="p">;</span>

<span class="cm">/*</span>
<span class="cm"> * Constants needed for the sysctl interface.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">long</span>	<span class="n">nlm_grace_period_min</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">long</span>	<span class="n">nlm_grace_period_max</span> <span class="o">=</span> <span class="mi">240</span><span class="p">;</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">long</span>	<span class="n">nlm_timeout_min</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">long</span>	<span class="n">nlm_timeout_max</span> <span class="o">=</span> <span class="mi">20</span><span class="p">;</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">int</span>		<span class="n">nlm_port_min</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">nlm_port_max</span> <span class="o">=</span> <span class="mi">65535</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_SYSCTL</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">ctl_table_header</span> <span class="o">*</span> <span class="n">nlm_sysctl_table</span><span class="p">;</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="nf">get_lockd_grace_period</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Note: nlm_timeout should always be nonzero */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nlm_grace_period</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">roundup</span><span class="p">(</span><span class="n">nlm_grace_period</span><span class="p">,</span> <span class="n">nlm_timeout</span><span class="p">)</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="n">nlm_timeout</span> <span class="o">*</span> <span class="mi">5</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">lock_manager</span> <span class="n">lockd_manager</span> <span class="o">=</span> <span class="p">{</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">grace_ender</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">not_used</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">locks_end_grace</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lockd_manager</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">DECLARE_DELAYED_WORK</span><span class="p">(</span><span class="n">grace_period_end</span><span class="p">,</span> <span class="n">grace_ender</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">set_grace_period</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">grace_period</span> <span class="o">=</span> <span class="n">get_lockd_grace_period</span><span class="p">();</span>

	<span class="n">locks_start_grace</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lockd_manager</span><span class="p">);</span>
	<span class="n">cancel_delayed_work_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">grace_period_end</span><span class="p">);</span>
	<span class="n">schedule_delayed_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">grace_period_end</span><span class="p">,</span> <span class="n">grace_period</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">restart_grace</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nlmsvc_ops</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cancel_delayed_work_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">grace_period_end</span><span class="p">);</span>
		<span class="n">locks_end_grace</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lockd_manager</span><span class="p">);</span>
		<span class="n">nlmsvc_invalidate_all</span><span class="p">();</span>
		<span class="n">set_grace_period</span><span class="p">();</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * This is the lockd kernel thread</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">lockd</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">vrqstp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span>		<span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">preverr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">svc_rqst</span> <span class="o">*</span><span class="n">rqstp</span> <span class="o">=</span> <span class="n">vrqstp</span><span class="p">;</span>

	<span class="cm">/* try_to_freeze() is called from svc_recv() */</span>
	<span class="n">set_freezable</span><span class="p">();</span>

	<span class="cm">/* Allow SIGKILL to tell lockd to drop all of its locks */</span>
	<span class="n">allow_signal</span><span class="p">(</span><span class="n">SIGKILL</span><span class="p">);</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;NFS locking service started (ver &quot;</span> <span class="n">LOCKD_VERSION</span> <span class="s">&quot;).</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">nlm_timeout</span><span class="p">)</span>
		<span class="n">nlm_timeout</span> <span class="o">=</span> <span class="n">LOCKD_DFLT_TIMEO</span><span class="p">;</span>
	<span class="n">nlmsvc_timeout</span> <span class="o">=</span> <span class="n">nlm_timeout</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">;</span>

	<span class="n">set_grace_period</span><span class="p">();</span>

	<span class="cm">/*</span>
<span class="cm">	 * The main request loop. We don&#39;t terminate until the last</span>
<span class="cm">	 * NFS mount or NFS daemon has gone away.</span>
<span class="cm">	 */</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">kthread_should_stop</span><span class="p">())</span> <span class="p">{</span>
		<span class="kt">long</span> <span class="n">timeout</span> <span class="o">=</span> <span class="n">MAX_SCHEDULE_TIMEOUT</span><span class="p">;</span>
		<span class="n">RPC_IFDEBUG</span><span class="p">(</span><span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="n">RPC_MAX_ADDRBUFLEN</span><span class="p">]);</span>

		<span class="cm">/* update sv_maxconn if it has changed */</span>
		<span class="n">rqstp</span><span class="o">-&gt;</span><span class="n">rq_server</span><span class="o">-&gt;</span><span class="n">sv_maxconn</span> <span class="o">=</span> <span class="n">nlm_max_connections</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">signalled</span><span class="p">())</span> <span class="p">{</span>
			<span class="n">flush_signals</span><span class="p">(</span><span class="n">current</span><span class="p">);</span>
			<span class="n">restart_grace</span><span class="p">();</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">timeout</span> <span class="o">=</span> <span class="n">nlmsvc_retry_blocked</span><span class="p">();</span>

		<span class="cm">/*</span>
<span class="cm">		 * Find a socket with data available and call its</span>
<span class="cm">		 * recvfrom routine.</span>
<span class="cm">		 */</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">svc_recv</span><span class="p">(</span><span class="n">rqstp</span><span class="p">,</span> <span class="n">timeout</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">==</span> <span class="o">-</span><span class="n">EAGAIN</span> <span class="o">||</span> <span class="n">err</span> <span class="o">==</span> <span class="o">-</span><span class="n">EINTR</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">preverr</span> <span class="o">=</span> <span class="n">err</span><span class="p">;</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">!=</span> <span class="n">preverr</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s: unexpected error &quot;</span>
					<span class="s">&quot;from svc_recv (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
				<span class="n">preverr</span> <span class="o">=</span> <span class="n">err</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">schedule_timeout_interruptible</span><span class="p">(</span><span class="n">HZ</span><span class="p">);</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">preverr</span> <span class="o">=</span> <span class="n">err</span><span class="p">;</span>

		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;lockd: request from %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">svc_print_addr</span><span class="p">(</span><span class="n">rqstp</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="p">)));</span>

		<span class="n">svc_process</span><span class="p">(</span><span class="n">rqstp</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">flush_signals</span><span class="p">(</span><span class="n">current</span><span class="p">);</span>
	<span class="n">cancel_delayed_work_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">grace_period_end</span><span class="p">);</span>
	<span class="n">locks_end_grace</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lockd_manager</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nlmsvc_ops</span><span class="p">)</span>
		<span class="n">nlmsvc_invalidate_all</span><span class="p">();</span>
	<span class="n">nlm_shutdown_hosts</span><span class="p">();</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">create_lockd_listener</span><span class="p">(</span><span class="k">struct</span> <span class="n">svc_serv</span> <span class="o">*</span><span class="n">serv</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">net</span> <span class="o">*</span><span class="n">net</span><span class="p">,</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">family</span><span class="p">,</span>
				 <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">svc_xprt</span> <span class="o">*</span><span class="n">xprt</span><span class="p">;</span>

	<span class="n">xprt</span> <span class="o">=</span> <span class="n">svc_find_xprt</span><span class="p">(</span><span class="n">serv</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">net</span><span class="p">,</span> <span class="n">family</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">xprt</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">svc_create_xprt</span><span class="p">(</span><span class="n">serv</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">net</span><span class="p">,</span> <span class="n">family</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span>
						<span class="n">SVC_SOCK_DEFAULTS</span><span class="p">);</span>
	<span class="n">svc_xprt_put</span><span class="p">(</span><span class="n">xprt</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">create_lockd_family</span><span class="p">(</span><span class="k">struct</span> <span class="n">svc_serv</span> <span class="o">*</span><span class="n">serv</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net</span> <span class="o">*</span><span class="n">net</span><span class="p">,</span>
			       <span class="k">const</span> <span class="kt">int</span> <span class="n">family</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">create_lockd_listener</span><span class="p">(</span><span class="n">serv</span><span class="p">,</span> <span class="s">&quot;udp&quot;</span><span class="p">,</span> <span class="n">net</span><span class="p">,</span> <span class="n">family</span><span class="p">,</span> <span class="n">nlm_udpport</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">create_lockd_listener</span><span class="p">(</span><span class="n">serv</span><span class="p">,</span> <span class="s">&quot;tcp&quot;</span><span class="p">,</span> <span class="n">net</span><span class="p">,</span> <span class="n">family</span><span class="p">,</span> <span class="n">nlm_tcpport</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Ensure there are active UDP and TCP listeners for lockd.</span>
<span class="cm"> *</span>
<span class="cm"> * Even if we have only TCP NFS mounts and/or TCP NFSDs, some</span>
<span class="cm"> * local services (such as rpc.statd) still require UDP, and</span>
<span class="cm"> * some NFS servers do not yet support NLM over TCP.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns zero if all listeners are available; otherwise a</span>
<span class="cm"> * negative errno value is returned.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">make_socks</span><span class="p">(</span><span class="k">struct</span> <span class="n">svc_serv</span> <span class="o">*</span><span class="n">serv</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net</span> <span class="o">*</span><span class="n">net</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="kt">int</span> <span class="n">warned</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">create_lockd_family</span><span class="p">(</span><span class="n">serv</span><span class="p">,</span> <span class="n">net</span><span class="p">,</span> <span class="n">PF_INET</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">create_lockd_family</span><span class="p">(</span><span class="n">serv</span><span class="p">,</span> <span class="n">net</span><span class="p">,</span> <span class="n">PF_INET6</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">err</span> <span class="o">!=</span> <span class="o">-</span><span class="n">EAFNOSUPPORT</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_err</span><span class="p">;</span>

	<span class="n">warned</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">out_err:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">warned</span><span class="o">++</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span>
			<span class="s">&quot;lockd_up: makesock failed, error=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">lockd_up_net</span><span class="p">(</span><span class="k">struct</span> <span class="n">svc_serv</span> <span class="o">*</span><span class="n">serv</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net</span> <span class="o">*</span><span class="n">net</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lockd_net</span> <span class="o">*</span><span class="n">ln</span> <span class="o">=</span> <span class="n">net_generic</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">lockd_net_id</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">error</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ln</span><span class="o">-&gt;</span><span class="n">nlmsvc_users</span><span class="o">++</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">error</span> <span class="o">=</span> <span class="n">svc_bind</span><span class="p">(</span><span class="n">serv</span><span class="p">,</span> <span class="n">net</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_bind</span><span class="p">;</span>

	<span class="n">error</span> <span class="o">=</span> <span class="n">make_socks</span><span class="p">(</span><span class="n">serv</span><span class="p">,</span> <span class="n">net</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_socks</span><span class="p">;</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;lockd_up_net: per-net data created; net=%p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">net</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">err_socks:</span>
	<span class="n">svc_rpcb_cleanup</span><span class="p">(</span><span class="n">serv</span><span class="p">,</span> <span class="n">net</span><span class="p">);</span>
<span class="nl">err_bind:</span>
	<span class="n">ln</span><span class="o">-&gt;</span><span class="n">nlmsvc_users</span><span class="o">--</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">lockd_down_net</span><span class="p">(</span><span class="k">struct</span> <span class="n">svc_serv</span> <span class="o">*</span><span class="n">serv</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net</span> <span class="o">*</span><span class="n">net</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lockd_net</span> <span class="o">*</span><span class="n">ln</span> <span class="o">=</span> <span class="n">net_generic</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">lockd_net_id</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ln</span><span class="o">-&gt;</span><span class="n">nlmsvc_users</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">--</span><span class="n">ln</span><span class="o">-&gt;</span><span class="n">nlmsvc_users</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">nlm_shutdown_hosts_net</span><span class="p">(</span><span class="n">net</span><span class="p">);</span>
			<span class="n">svc_shutdown_net</span><span class="p">(</span><span class="n">serv</span><span class="p">,</span> <span class="n">net</span><span class="p">);</span>
			<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;lockd_down_net: per-net data destroyed; net=%p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">net</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;lockd_down_net: no users! task=%p, net=%p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">nlmsvc_task</span><span class="p">,</span> <span class="n">net</span><span class="p">);</span>
		<span class="n">BUG</span><span class="p">();</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">lockd_start_svc</span><span class="p">(</span><span class="k">struct</span> <span class="n">svc_serv</span> <span class="o">*</span><span class="n">serv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">error</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nlmsvc_rqst</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Create the kernel thread and wait for it to start.</span>
<span class="cm">	 */</span>
	<span class="n">nlmsvc_rqst</span> <span class="o">=</span> <span class="n">svc_prepare_thread</span><span class="p">(</span><span class="n">serv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">serv</span><span class="o">-&gt;</span><span class="n">sv_pools</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">NUMA_NO_NODE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">nlmsvc_rqst</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">error</span> <span class="o">=</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">nlmsvc_rqst</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span>
			<span class="s">&quot;lockd_up: svc_rqst allocation failed, error=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">error</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_rqst</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">svc_sock_update_bufs</span><span class="p">(</span><span class="n">serv</span><span class="p">);</span>
	<span class="n">serv</span><span class="o">-&gt;</span><span class="n">sv_maxconn</span> <span class="o">=</span> <span class="n">nlm_max_connections</span><span class="p">;</span>

	<span class="n">nlmsvc_task</span> <span class="o">=</span> <span class="n">kthread_run</span><span class="p">(</span><span class="n">lockd</span><span class="p">,</span> <span class="n">nlmsvc_rqst</span><span class="p">,</span> <span class="n">serv</span><span class="o">-&gt;</span><span class="n">sv_name</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">nlmsvc_task</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">error</span> <span class="o">=</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">nlmsvc_task</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span>
			<span class="s">&quot;lockd_up: kthread_run failed, error=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">error</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_task</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;lockd_up: service started</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">out_task:</span>
	<span class="n">svc_exit_thread</span><span class="p">(</span><span class="n">nlmsvc_rqst</span><span class="p">);</span>
	<span class="n">nlmsvc_task</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="nl">out_rqst:</span>
	<span class="n">nlmsvc_rqst</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">svc_serv</span> <span class="o">*</span><span class="nf">lockd_create_svc</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">svc_serv</span> <span class="o">*</span><span class="n">serv</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Check whether we&#39;re already up and running.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nlmsvc_rqst</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Note: increase service usage, because later in case of error</span>
<span class="cm">		 * svc_destroy() will be called.</span>
<span class="cm">		 */</span>
		<span class="n">svc_get</span><span class="p">(</span><span class="n">nlmsvc_rqst</span><span class="o">-&gt;</span><span class="n">rq_server</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">nlmsvc_rqst</span><span class="o">-&gt;</span><span class="n">rq_server</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Sanity check: if there&#39;s no pid,</span>
<span class="cm">	 * we should be the first user ...</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nlmsvc_users</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span>
			<span class="s">&quot;lockd_up: no pid, %d users??</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">nlmsvc_users</span><span class="p">);</span>

	<span class="n">serv</span> <span class="o">=</span> <span class="n">svc_create</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nlmsvc_program</span><span class="p">,</span> <span class="n">LOCKD_BUFSIZE</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">serv</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;lockd_up: create service failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">ENOMEM</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;lockd_up: service created</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">serv</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Bring up the lockd process if it&#39;s not already up.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">lockd_up</span><span class="p">(</span><span class="k">struct</span> <span class="n">net</span> <span class="o">*</span><span class="n">net</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">svc_serv</span> <span class="o">*</span><span class="n">serv</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">error</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nlmsvc_mutex</span><span class="p">);</span>

	<span class="n">serv</span> <span class="o">=</span> <span class="n">lockd_create_svc</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">serv</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">error</span> <span class="o">=</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">serv</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_create</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">error</span> <span class="o">=</span> <span class="n">lockd_up_net</span><span class="p">(</span><span class="n">serv</span><span class="p">,</span> <span class="n">net</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_net</span><span class="p">;</span>

	<span class="n">error</span> <span class="o">=</span> <span class="n">lockd_start_svc</span><span class="p">(</span><span class="n">serv</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_start</span><span class="p">;</span>

	<span class="n">nlmsvc_users</span><span class="o">++</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * Note: svc_serv structures have an initial use count of 1,</span>
<span class="cm">	 * so we exit through here on both success and failure.</span>
<span class="cm">	 */</span>
<span class="nl">err_net:</span>
	<span class="n">svc_destroy</span><span class="p">(</span><span class="n">serv</span><span class="p">);</span>
<span class="nl">err_create:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nlmsvc_mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">error</span><span class="p">;</span>

<span class="nl">err_start:</span>
	<span class="n">lockd_down_net</span><span class="p">(</span><span class="n">serv</span><span class="p">,</span> <span class="n">net</span><span class="p">);</span>
	<span class="k">goto</span> <span class="n">err_net</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">lockd_up</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * Decrement the user count and bring down lockd if we&#39;re the last.</span>
<span class="cm"> */</span>
<span class="kt">void</span>
<span class="nf">lockd_down</span><span class="p">(</span><span class="k">struct</span> <span class="n">net</span> <span class="o">*</span><span class="n">net</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nlmsvc_mutex</span><span class="p">);</span>
	<span class="n">lockd_down_net</span><span class="p">(</span><span class="n">nlmsvc_rqst</span><span class="o">-&gt;</span><span class="n">rq_server</span><span class="p">,</span> <span class="n">net</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nlmsvc_users</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">--</span><span class="n">nlmsvc_users</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;lockd_down: no users! task=%p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">nlmsvc_task</span><span class="p">);</span>
		<span class="n">BUG</span><span class="p">();</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">nlmsvc_task</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;lockd_down: no lockd running.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">BUG</span><span class="p">();</span>
	<span class="p">}</span>
	<span class="n">kthread_stop</span><span class="p">(</span><span class="n">nlmsvc_task</span><span class="p">);</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;lockd_down: service stopped</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">svc_exit_thread</span><span class="p">(</span><span class="n">nlmsvc_rqst</span><span class="p">);</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;lockd_down: service destroyed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">nlmsvc_task</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">nlmsvc_rqst</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="nl">out:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nlmsvc_mutex</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">lockd_down</span><span class="p">);</span>

<span class="cp">#ifdef CONFIG_SYSCTL</span>

<span class="cm">/*</span>
<span class="cm"> * Sysctl parameters (same as module parameters, different interface).</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="n">ctl_table</span> <span class="n">nlm_sysctls</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">procname</span>	<span class="o">=</span> <span class="s">&quot;nlm_grace_period&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">data</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">nlm_grace_period</span><span class="p">,</span>
		<span class="p">.</span><span class="n">maxlen</span>		<span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">),</span>
		<span class="p">.</span><span class="n">mode</span>		<span class="o">=</span> <span class="mo">0644</span><span class="p">,</span>
		<span class="p">.</span><span class="n">proc_handler</span>	<span class="o">=</span> <span class="n">proc_doulongvec_minmax</span><span class="p">,</span>
		<span class="p">.</span><span class="n">extra1</span>		<span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">nlm_grace_period_min</span><span class="p">,</span>
		<span class="p">.</span><span class="n">extra2</span>		<span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">nlm_grace_period_max</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">procname</span>	<span class="o">=</span> <span class="s">&quot;nlm_timeout&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">data</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">nlm_timeout</span><span class="p">,</span>
		<span class="p">.</span><span class="n">maxlen</span>		<span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">),</span>
		<span class="p">.</span><span class="n">mode</span>		<span class="o">=</span> <span class="mo">0644</span><span class="p">,</span>
		<span class="p">.</span><span class="n">proc_handler</span>	<span class="o">=</span> <span class="n">proc_doulongvec_minmax</span><span class="p">,</span>
		<span class="p">.</span><span class="n">extra1</span>		<span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">nlm_timeout_min</span><span class="p">,</span>
		<span class="p">.</span><span class="n">extra2</span>		<span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">nlm_timeout_max</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">procname</span>	<span class="o">=</span> <span class="s">&quot;nlm_udpport&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">data</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">nlm_udpport</span><span class="p">,</span>
		<span class="p">.</span><span class="n">maxlen</span>		<span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">),</span>
		<span class="p">.</span><span class="n">mode</span>		<span class="o">=</span> <span class="mo">0644</span><span class="p">,</span>
		<span class="p">.</span><span class="n">proc_handler</span>	<span class="o">=</span> <span class="n">proc_dointvec_minmax</span><span class="p">,</span>
		<span class="p">.</span><span class="n">extra1</span>		<span class="o">=</span> <span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">nlm_port_min</span><span class="p">,</span>
		<span class="p">.</span><span class="n">extra2</span>		<span class="o">=</span> <span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">nlm_port_max</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">procname</span>	<span class="o">=</span> <span class="s">&quot;nlm_tcpport&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">data</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">nlm_tcpport</span><span class="p">,</span>
		<span class="p">.</span><span class="n">maxlen</span>		<span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">),</span>
		<span class="p">.</span><span class="n">mode</span>		<span class="o">=</span> <span class="mo">0644</span><span class="p">,</span>
		<span class="p">.</span><span class="n">proc_handler</span>	<span class="o">=</span> <span class="n">proc_dointvec_minmax</span><span class="p">,</span>
		<span class="p">.</span><span class="n">extra1</span>		<span class="o">=</span> <span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">nlm_port_min</span><span class="p">,</span>
		<span class="p">.</span><span class="n">extra2</span>		<span class="o">=</span> <span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">nlm_port_max</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">procname</span>	<span class="o">=</span> <span class="s">&quot;nsm_use_hostnames&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">data</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">nsm_use_hostnames</span><span class="p">,</span>
		<span class="p">.</span><span class="n">maxlen</span>		<span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">),</span>
		<span class="p">.</span><span class="n">mode</span>		<span class="o">=</span> <span class="mo">0644</span><span class="p">,</span>
		<span class="p">.</span><span class="n">proc_handler</span>	<span class="o">=</span> <span class="n">proc_dointvec</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">procname</span>	<span class="o">=</span> <span class="s">&quot;nsm_local_state&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">data</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">nsm_local_state</span><span class="p">,</span>
		<span class="p">.</span><span class="n">maxlen</span>		<span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">),</span>
		<span class="p">.</span><span class="n">mode</span>		<span class="o">=</span> <span class="mo">0644</span><span class="p">,</span>
		<span class="p">.</span><span class="n">proc_handler</span>	<span class="o">=</span> <span class="n">proc_dointvec</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span> <span class="p">}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="n">ctl_table</span> <span class="n">nlm_sysctl_dir</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">procname</span>	<span class="o">=</span> <span class="s">&quot;nfs&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">mode</span>		<span class="o">=</span> <span class="mo">0555</span><span class="p">,</span>
		<span class="p">.</span><span class="n">child</span>		<span class="o">=</span> <span class="n">nlm_sysctls</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span> <span class="p">}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="n">ctl_table</span> <span class="n">nlm_sysctl_root</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">procname</span>	<span class="o">=</span> <span class="s">&quot;fs&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">mode</span>		<span class="o">=</span> <span class="mo">0555</span><span class="p">,</span>
		<span class="p">.</span><span class="n">child</span>		<span class="o">=</span> <span class="n">nlm_sysctl_dir</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span> <span class="p">}</span>
<span class="p">};</span>

<span class="cp">#endif	</span><span class="cm">/* CONFIG_SYSCTL */</span><span class="cp"></span>

<span class="cm">/*</span>
<span class="cm"> * Module (and sysfs) parameters.</span>
<span class="cm"> */</span>

<span class="cp">#define param_set_min_max(name, type, which_strtol, min, max)		\</span>
<span class="cp">static int param_set_##name(const char *val, struct kernel_param *kp)	\</span>
<span class="cp">{									\</span>
<span class="cp">	char *endp;							\</span>
<span class="cp">	__typeof__(type) num = which_strtol(val, &amp;endp, 0);		\</span>
<span class="cp">	if (endp == val || *endp || num &lt; (min) || num &gt; (max))		\</span>
<span class="cp">		return -EINVAL;						\</span>
<span class="cp">	*((type *) kp-&gt;arg) = num;					\</span>
<span class="cp">	return 0;							\</span>
<span class="cp">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">is_callback</span><span class="p">(</span><span class="n">u32</span> <span class="n">proc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">proc</span> <span class="o">==</span> <span class="n">NLMPROC_GRANTED</span>
		<span class="o">||</span> <span class="n">proc</span> <span class="o">==</span> <span class="n">NLMPROC_GRANTED_MSG</span>
		<span class="o">||</span> <span class="n">proc</span> <span class="o">==</span> <span class="n">NLMPROC_TEST_RES</span>
		<span class="o">||</span> <span class="n">proc</span> <span class="o">==</span> <span class="n">NLMPROC_LOCK_RES</span>
		<span class="o">||</span> <span class="n">proc</span> <span class="o">==</span> <span class="n">NLMPROC_CANCEL_RES</span>
		<span class="o">||</span> <span class="n">proc</span> <span class="o">==</span> <span class="n">NLMPROC_UNLOCK_RES</span>
		<span class="o">||</span> <span class="n">proc</span> <span class="o">==</span> <span class="n">NLMPROC_NSM_NOTIFY</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">lockd_authenticate</span><span class="p">(</span><span class="k">struct</span> <span class="n">svc_rqst</span> <span class="o">*</span><span class="n">rqstp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">rqstp</span><span class="o">-&gt;</span><span class="n">rq_client</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">rqstp</span><span class="o">-&gt;</span><span class="n">rq_authop</span><span class="o">-&gt;</span><span class="n">flavour</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">RPC_AUTH_NULL</span>:
		<span class="k">case</span> <span class="n">RPC_AUTH_UNIX</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">rqstp</span><span class="o">-&gt;</span><span class="n">rq_proc</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">SVC_OK</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">is_callback</span><span class="p">(</span><span class="n">rqstp</span><span class="o">-&gt;</span><span class="n">rq_proc</span><span class="p">))</span> <span class="p">{</span>
				<span class="cm">/* Leave it to individual procedures to</span>
<span class="cm">				 * call nlmsvc_lookup_host(rqstp)</span>
<span class="cm">				 */</span>
				<span class="k">return</span> <span class="n">SVC_OK</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">return</span> <span class="n">svc_set_client</span><span class="p">(</span><span class="n">rqstp</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">SVC_DENIED</span><span class="p">;</span>
<span class="p">}</span>


<span class="n">param_set_min_max</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="n">simple_strtol</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">65535</span><span class="p">)</span>
<span class="n">param_set_min_max</span><span class="p">(</span><span class="n">grace_period</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span><span class="p">,</span> <span class="n">simple_strtoul</span><span class="p">,</span>
		  <span class="n">nlm_grace_period_min</span><span class="p">,</span> <span class="n">nlm_grace_period_max</span><span class="p">)</span>
<span class="n">param_set_min_max</span><span class="p">(</span><span class="n">timeout</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span><span class="p">,</span> <span class="n">simple_strtoul</span><span class="p">,</span>
		  <span class="n">nlm_timeout_min</span><span class="p">,</span> <span class="n">nlm_timeout_max</span><span class="p">)</span>

<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Olaf Kirch &lt;okir@monad.swb.de&gt;&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;NFS file locking service version &quot;</span> <span class="n">LOCKD_VERSION</span> <span class="s">&quot;.&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

<span class="n">module_param_call</span><span class="p">(</span><span class="n">nlm_grace_period</span><span class="p">,</span> <span class="n">param_set_grace_period</span><span class="p">,</span> <span class="n">param_get_ulong</span><span class="p">,</span>
		  <span class="o">&amp;</span><span class="n">nlm_grace_period</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>
<span class="n">module_param_call</span><span class="p">(</span><span class="n">nlm_timeout</span><span class="p">,</span> <span class="n">param_set_timeout</span><span class="p">,</span> <span class="n">param_get_ulong</span><span class="p">,</span>
		  <span class="o">&amp;</span><span class="n">nlm_timeout</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>
<span class="n">module_param_call</span><span class="p">(</span><span class="n">nlm_udpport</span><span class="p">,</span> <span class="n">param_set_port</span><span class="p">,</span> <span class="n">param_get_int</span><span class="p">,</span>
		  <span class="o">&amp;</span><span class="n">nlm_udpport</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>
<span class="n">module_param_call</span><span class="p">(</span><span class="n">nlm_tcpport</span><span class="p">,</span> <span class="n">param_set_port</span><span class="p">,</span> <span class="n">param_get_int</span><span class="p">,</span>
		  <span class="o">&amp;</span><span class="n">nlm_tcpport</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">nsm_use_hostnames</span><span class="p">,</span> <span class="n">bool</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">nlm_max_connections</span><span class="p">,</span> <span class="n">uint</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">lockd_init_net</span><span class="p">(</span><span class="k">struct</span> <span class="n">net</span> <span class="o">*</span><span class="n">net</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">lockd_exit_net</span><span class="p">(</span><span class="k">struct</span> <span class="n">net</span> <span class="o">*</span><span class="n">net</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">pernet_operations</span> <span class="n">lockd_net_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">init</span> <span class="o">=</span> <span class="n">lockd_init_net</span><span class="p">,</span>
	<span class="p">.</span><span class="n">exit</span> <span class="o">=</span> <span class="n">lockd_exit_net</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">lockd_net_id</span><span class="p">,</span>
	<span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">lockd_net</span><span class="p">),</span>
<span class="p">};</span>


<span class="cm">/*</span>
<span class="cm"> * Initialising and terminating the module.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">init_nlm</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_SYSCTL</span>
	<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">nlm_sysctl_table</span> <span class="o">=</span> <span class="n">register_sysctl_table</span><span class="p">(</span><span class="n">nlm_sysctl_root</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nlm_sysctl_table</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_sysctl</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">register_pernet_subsys</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lockd_net_ops</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_pernet</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">err_pernet:</span>
<span class="cp">#ifdef CONFIG_SYSCTL</span>
	<span class="n">unregister_sysctl_table</span><span class="p">(</span><span class="n">nlm_sysctl_table</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="nl">err_sysctl:</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">exit_nlm</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* FIXME: delete all NLM clients */</span>
	<span class="n">nlm_shutdown_hosts</span><span class="p">();</span>
	<span class="n">unregister_pernet_subsys</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lockd_net_ops</span><span class="p">);</span>
<span class="cp">#ifdef CONFIG_SYSCTL</span>
	<span class="n">unregister_sysctl_table</span><span class="p">(</span><span class="n">nlm_sysctl_table</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">init_nlm</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">exit_nlm</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * Define NLM program and procedures</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">svc_version</span>	<span class="n">nlmsvc_version1</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">vs_vers</span>	<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">vs_nproc</span>	<span class="o">=</span> <span class="mi">17</span><span class="p">,</span>
		<span class="p">.</span><span class="n">vs_proc</span>	<span class="o">=</span> <span class="n">nlmsvc_procedures</span><span class="p">,</span>
		<span class="p">.</span><span class="n">vs_xdrsize</span>	<span class="o">=</span> <span class="n">NLMSVC_XDRSIZE</span><span class="p">,</span>
<span class="p">};</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">svc_version</span>	<span class="n">nlmsvc_version3</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">vs_vers</span>	<span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
		<span class="p">.</span><span class="n">vs_nproc</span>	<span class="o">=</span> <span class="mi">24</span><span class="p">,</span>
		<span class="p">.</span><span class="n">vs_proc</span>	<span class="o">=</span> <span class="n">nlmsvc_procedures</span><span class="p">,</span>
		<span class="p">.</span><span class="n">vs_xdrsize</span>	<span class="o">=</span> <span class="n">NLMSVC_XDRSIZE</span><span class="p">,</span>
<span class="p">};</span>
<span class="cp">#ifdef CONFIG_LOCKD_V4</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">svc_version</span>	<span class="n">nlmsvc_version4</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">vs_vers</span>	<span class="o">=</span> <span class="mi">4</span><span class="p">,</span>
		<span class="p">.</span><span class="n">vs_nproc</span>	<span class="o">=</span> <span class="mi">24</span><span class="p">,</span>
		<span class="p">.</span><span class="n">vs_proc</span>	<span class="o">=</span> <span class="n">nlmsvc_procedures4</span><span class="p">,</span>
		<span class="p">.</span><span class="n">vs_xdrsize</span>	<span class="o">=</span> <span class="n">NLMSVC_XDRSIZE</span><span class="p">,</span>
<span class="p">};</span>
<span class="cp">#endif</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">svc_version</span> <span class="o">*</span>	<span class="n">nlmsvc_version</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">nlmsvc_version1</span><span class="p">,</span>
	<span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">nlmsvc_version3</span><span class="p">,</span>
<span class="cp">#ifdef CONFIG_LOCKD_V4</span>
	<span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">nlmsvc_version4</span><span class="p">,</span>
<span class="cp">#endif</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">svc_stat</span>		<span class="n">nlmsvc_stats</span><span class="p">;</span>

<span class="cp">#define NLM_NRVERS	ARRAY_SIZE(nlmsvc_version)</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">svc_program</span>	<span class="n">nlmsvc_program</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">pg_prog</span>		<span class="o">=</span> <span class="n">NLM_PROGRAM</span><span class="p">,</span>		<span class="cm">/* program number */</span>
	<span class="p">.</span><span class="n">pg_nvers</span>		<span class="o">=</span> <span class="n">NLM_NRVERS</span><span class="p">,</span>		<span class="cm">/* number of entries in nlmsvc_version */</span>
	<span class="p">.</span><span class="n">pg_vers</span>		<span class="o">=</span> <span class="n">nlmsvc_version</span><span class="p">,</span>	<span class="cm">/* version table */</span>
	<span class="p">.</span><span class="n">pg_name</span>		<span class="o">=</span> <span class="s">&quot;lockd&quot;</span><span class="p">,</span>		<span class="cm">/* service name */</span>
	<span class="p">.</span><span class="n">pg_class</span>		<span class="o">=</span> <span class="s">&quot;nfsd&quot;</span><span class="p">,</span>		<span class="cm">/* share authentication with nfsd */</span>
	<span class="p">.</span><span class="n">pg_stats</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">nlmsvc_stats</span><span class="p">,</span>	<span class="cm">/* stats table */</span>
	<span class="p">.</span><span class="n">pg_authenticate</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">lockd_authenticate</span>	<span class="cm">/* export authentication */</span>
<span class="p">};</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
