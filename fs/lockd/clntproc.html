<!DOCTYPE html>
<html><head><title>joekychen/linux » fs › lockd › clntproc.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>clntproc.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * linux/fs/lockd/clntproc.c</span>
<span class="cm"> *</span>
<span class="cm"> * RPC procedures for the client side NLM implementation</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 1996, Olaf Kirch &lt;okir@monad.swb.de&gt;</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/types.h&gt;</span>
<span class="cp">#include &lt;linux/errno.h&gt;</span>
<span class="cp">#include &lt;linux/fs.h&gt;</span>
<span class="cp">#include &lt;linux/nfs_fs.h&gt;</span>
<span class="cp">#include &lt;linux/utsname.h&gt;</span>
<span class="cp">#include &lt;linux/freezer.h&gt;</span>
<span class="cp">#include &lt;linux/sunrpc/clnt.h&gt;</span>
<span class="cp">#include &lt;linux/sunrpc/svc.h&gt;</span>
<span class="cp">#include &lt;linux/lockd/lockd.h&gt;</span>

<span class="cp">#define NLMDBG_FACILITY		NLMDBG_CLIENT</span>
<span class="cp">#define NLMCLNT_GRACE_WAIT	(5*HZ)</span>
<span class="cp">#define NLMCLNT_POLL_TIMEOUT	(30*HZ)</span>
<span class="cp">#define NLMCLNT_MAX_RETRIES	3</span>

<span class="k">static</span> <span class="kt">int</span>	<span class="n">nlmclnt_test</span><span class="p">(</span><span class="k">struct</span> <span class="n">nlm_rqst</span> <span class="o">*</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file_lock</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span>	<span class="n">nlmclnt_lock</span><span class="p">(</span><span class="k">struct</span> <span class="n">nlm_rqst</span> <span class="o">*</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file_lock</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span>	<span class="n">nlmclnt_unlock</span><span class="p">(</span><span class="k">struct</span> <span class="n">nlm_rqst</span> <span class="o">*</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file_lock</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span>	<span class="n">nlm_stat_to_errno</span><span class="p">(</span><span class="n">__be32</span> <span class="n">stat</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>	<span class="n">nlmclnt_locks_init_private</span><span class="p">(</span><span class="k">struct</span> <span class="n">file_lock</span> <span class="o">*</span><span class="n">fl</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nlm_host</span> <span class="o">*</span><span class="n">host</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span>	<span class="n">nlmclnt_cancel</span><span class="p">(</span><span class="k">struct</span> <span class="n">nlm_host</span> <span class="o">*</span><span class="p">,</span> <span class="kt">int</span> <span class="p">,</span> <span class="k">struct</span> <span class="n">file_lock</span> <span class="o">*</span><span class="p">);</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">rpc_call_ops</span> <span class="n">nlmclnt_unlock_ops</span><span class="p">;</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">rpc_call_ops</span> <span class="n">nlmclnt_cancel_ops</span><span class="p">;</span>

<span class="cm">/*</span>
<span class="cm"> * Cookie counter for NLM requests</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">atomic_t</span>	<span class="n">nlm_cookie</span> <span class="o">=</span> <span class="n">ATOMIC_INIT</span><span class="p">(</span><span class="mh">0x1234</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">nlmclnt_next_cookie</span><span class="p">(</span><span class="k">struct</span> <span class="n">nlm_cookie</span> <span class="o">*</span><span class="n">c</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span>	<span class="n">cookie</span> <span class="o">=</span> <span class="n">atomic_inc_return</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nlm_cookie</span><span class="p">);</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cookie</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">len</span><span class="o">=</span><span class="mi">4</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">nlm_lockowner</span> <span class="o">*</span><span class="nf">nlm_get_lockowner</span><span class="p">(</span><span class="k">struct</span> <span class="n">nlm_lockowner</span> <span class="o">*</span><span class="n">lockowner</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lockowner</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">lockowner</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">nlm_put_lockowner</span><span class="p">(</span><span class="k">struct</span> <span class="n">nlm_lockowner</span> <span class="o">*</span><span class="n">lockowner</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">atomic_dec_and_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lockowner</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">lockowner</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">h_lock</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lockowner</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lockowner</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">h_lock</span><span class="p">);</span>
	<span class="n">nlmclnt_release_host</span><span class="p">(</span><span class="n">lockowner</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">lockowner</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">nlm_pidbusy</span><span class="p">(</span><span class="k">struct</span> <span class="n">nlm_host</span> <span class="o">*</span><span class="n">host</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">pid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nlm_lockowner</span> <span class="o">*</span><span class="n">lockowner</span><span class="p">;</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">lockowner</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">h_lockowners</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">lockowner</span><span class="o">-&gt;</span><span class="n">pid</span> <span class="o">==</span> <span class="n">pid</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">uint32_t</span> <span class="nf">__nlm_alloc_pid</span><span class="p">(</span><span class="k">struct</span> <span class="n">nlm_host</span> <span class="o">*</span><span class="n">host</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">uint32_t</span> <span class="n">res</span><span class="p">;</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="n">res</span> <span class="o">=</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">h_pidcount</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">nlm_pidbusy</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">res</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">nlm_lockowner</span> <span class="o">*</span><span class="nf">__nlm_find_lockowner</span><span class="p">(</span><span class="k">struct</span> <span class="n">nlm_host</span> <span class="o">*</span><span class="n">host</span><span class="p">,</span> <span class="n">fl_owner_t</span> <span class="n">owner</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nlm_lockowner</span> <span class="o">*</span><span class="n">lockowner</span><span class="p">;</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">lockowner</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">h_lockowners</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">lockowner</span><span class="o">-&gt;</span><span class="n">owner</span> <span class="o">!=</span> <span class="n">owner</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">nlm_get_lockowner</span><span class="p">(</span><span class="n">lockowner</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">nlm_lockowner</span> <span class="o">*</span><span class="nf">nlm_find_lockowner</span><span class="p">(</span><span class="k">struct</span> <span class="n">nlm_host</span> <span class="o">*</span><span class="n">host</span><span class="p">,</span> <span class="n">fl_owner_t</span> <span class="n">owner</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nlm_lockowner</span> <span class="o">*</span><span class="n">res</span><span class="p">,</span> <span class="o">*</span><span class="n">new</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">h_lock</span><span class="p">);</span>
	<span class="n">res</span> <span class="o">=</span> <span class="n">__nlm_find_lockowner</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">owner</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">res</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">h_lock</span><span class="p">);</span>
		<span class="n">new</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">new</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">h_lock</span><span class="p">);</span>
		<span class="n">res</span> <span class="o">=</span> <span class="n">__nlm_find_lockowner</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">owner</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">res</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">&amp;&amp;</span> <span class="n">new</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">res</span> <span class="o">=</span> <span class="n">new</span><span class="p">;</span>
			<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">new</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
			<span class="n">new</span><span class="o">-&gt;</span><span class="n">owner</span> <span class="o">=</span> <span class="n">owner</span><span class="p">;</span>
			<span class="n">new</span><span class="o">-&gt;</span><span class="n">pid</span> <span class="o">=</span> <span class="n">__nlm_alloc_pid</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>
			<span class="n">new</span><span class="o">-&gt;</span><span class="n">host</span> <span class="o">=</span> <span class="n">nlm_get_host</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>
			<span class="n">list_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">new</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">h_lockowners</span><span class="p">);</span>
			<span class="n">new</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">h_lock</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">new</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Initialize arguments for TEST/LOCK/UNLOCK/CANCEL calls</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">nlmclnt_setlockargs</span><span class="p">(</span><span class="k">struct</span> <span class="n">nlm_rqst</span> <span class="o">*</span><span class="n">req</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file_lock</span> <span class="o">*</span><span class="n">fl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nlm_args</span>	<span class="o">*</span><span class="n">argp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">a_args</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nlm_lock</span>	<span class="o">*</span><span class="n">lock</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">argp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">;</span>

	<span class="n">nlmclnt_next_cookie</span><span class="p">(</span><span class="o">&amp;</span><span class="n">argp</span><span class="o">-&gt;</span><span class="n">cookie</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lock</span><span class="o">-&gt;</span><span class="n">fh</span><span class="p">,</span> <span class="n">NFS_FH</span><span class="p">(</span><span class="n">fl</span><span class="o">-&gt;</span><span class="n">fl_file</span><span class="o">-&gt;</span><span class="n">f_path</span><span class="p">.</span><span class="n">dentry</span><span class="o">-&gt;</span><span class="n">d_inode</span><span class="p">),</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">nfs_fh</span><span class="p">));</span>
	<span class="n">lock</span><span class="o">-&gt;</span><span class="n">caller</span>  <span class="o">=</span> <span class="n">utsname</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">nodename</span><span class="p">;</span>
	<span class="n">lock</span><span class="o">-&gt;</span><span class="n">oh</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">a_owner</span><span class="p">;</span>
	<span class="n">lock</span><span class="o">-&gt;</span><span class="n">oh</span><span class="p">.</span><span class="n">len</span>  <span class="o">=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">a_owner</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">a_owner</span><span class="p">),</span> <span class="s">&quot;%u@%s&quot;</span><span class="p">,</span>
				<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span><span class="n">fl</span><span class="o">-&gt;</span><span class="n">fl_u</span><span class="p">.</span><span class="n">nfs_fl</span><span class="p">.</span><span class="n">owner</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">,</span>
				<span class="n">utsname</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">nodename</span><span class="p">);</span>
	<span class="n">lock</span><span class="o">-&gt;</span><span class="n">svid</span> <span class="o">=</span> <span class="n">fl</span><span class="o">-&gt;</span><span class="n">fl_u</span><span class="p">.</span><span class="n">nfs_fl</span><span class="p">.</span><span class="n">owner</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">;</span>
	<span class="n">lock</span><span class="o">-&gt;</span><span class="n">fl</span><span class="p">.</span><span class="n">fl_start</span> <span class="o">=</span> <span class="n">fl</span><span class="o">-&gt;</span><span class="n">fl_start</span><span class="p">;</span>
	<span class="n">lock</span><span class="o">-&gt;</span><span class="n">fl</span><span class="p">.</span><span class="n">fl_end</span> <span class="o">=</span> <span class="n">fl</span><span class="o">-&gt;</span><span class="n">fl_end</span><span class="p">;</span>
	<span class="n">lock</span><span class="o">-&gt;</span><span class="n">fl</span><span class="p">.</span><span class="n">fl_type</span> <span class="o">=</span> <span class="n">fl</span><span class="o">-&gt;</span><span class="n">fl_type</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">nlmclnt_release_lockargs</span><span class="p">(</span><span class="k">struct</span> <span class="n">nlm_rqst</span> <span class="o">*</span><span class="n">req</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">a_args</span><span class="p">.</span><span class="n">lock</span><span class="p">.</span><span class="n">fl</span><span class="p">.</span><span class="n">fl_ops</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * nlmclnt_proc - Perform a single client-side lock request</span>
<span class="cm"> * @host: address of a valid nlm_host context representing the NLM server</span>
<span class="cm"> * @cmd: fcntl-style file lock operation to perform</span>
<span class="cm"> * @fl: address of arguments for the lock operation</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">nlmclnt_proc</span><span class="p">(</span><span class="k">struct</span> <span class="n">nlm_host</span> <span class="o">*</span><span class="n">host</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file_lock</span> <span class="o">*</span><span class="n">fl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nlm_rqst</span>		<span class="o">*</span><span class="n">call</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">status</span><span class="p">;</span>

	<span class="n">nlm_get_host</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>
	<span class="n">call</span> <span class="o">=</span> <span class="n">nlm_alloc_call</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">call</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">nlmclnt_locks_init_private</span><span class="p">(</span><span class="n">fl</span><span class="p">,</span> <span class="n">host</span><span class="p">);</span>
	<span class="cm">/* Set up the argument struct */</span>
	<span class="n">nlmclnt_setlockargs</span><span class="p">(</span><span class="n">call</span><span class="p">,</span> <span class="n">fl</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">IS_SETLK</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="o">||</span> <span class="n">IS_SETLKW</span><span class="p">(</span><span class="n">cmd</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">fl</span><span class="o">-&gt;</span><span class="n">fl_type</span> <span class="o">!=</span> <span class="n">F_UNLCK</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">call</span><span class="o">-&gt;</span><span class="n">a_args</span><span class="p">.</span><span class="n">block</span> <span class="o">=</span> <span class="n">IS_SETLKW</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">nlmclnt_lock</span><span class="p">(</span><span class="n">call</span><span class="p">,</span> <span class="n">fl</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">nlmclnt_unlock</span><span class="p">(</span><span class="n">call</span><span class="p">,</span> <span class="n">fl</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">IS_GETLK</span><span class="p">(</span><span class="n">cmd</span><span class="p">))</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">nlmclnt_test</span><span class="p">(</span><span class="n">call</span><span class="p">,</span> <span class="n">fl</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">fl</span><span class="o">-&gt;</span><span class="n">fl_ops</span><span class="o">-&gt;</span><span class="n">fl_release_private</span><span class="p">(</span><span class="n">fl</span><span class="p">);</span>
	<span class="n">fl</span><span class="o">-&gt;</span><span class="n">fl_ops</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;lockd: clnt proc returns %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">nlmclnt_proc</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * Allocate an NLM RPC call struct</span>
<span class="cm"> *</span>
<span class="cm"> * Note: the caller must hold a reference to host. In case of failure,</span>
<span class="cm"> * this reference will be released.</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">nlm_rqst</span> <span class="o">*</span><span class="nf">nlm_alloc_call</span><span class="p">(</span><span class="k">struct</span> <span class="n">nlm_host</span> <span class="o">*</span><span class="n">host</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nlm_rqst</span>	<span class="o">*</span><span class="n">call</span><span class="p">;</span>

	<span class="k">for</span><span class="p">(;;)</span> <span class="p">{</span>
		<span class="n">call</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">call</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">call</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">call</span><span class="o">-&gt;</span><span class="n">a_count</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
			<span class="n">locks_init_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">call</span><span class="o">-&gt;</span><span class="n">a_args</span><span class="p">.</span><span class="n">lock</span><span class="p">.</span><span class="n">fl</span><span class="p">);</span>
			<span class="n">locks_init_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">call</span><span class="o">-&gt;</span><span class="n">a_res</span><span class="p">.</span><span class="n">lock</span><span class="p">.</span><span class="n">fl</span><span class="p">);</span>
			<span class="n">call</span><span class="o">-&gt;</span><span class="n">a_host</span> <span class="o">=</span> <span class="n">host</span><span class="p">;</span>
			<span class="k">return</span> <span class="n">call</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">signalled</span><span class="p">())</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;nlm_alloc_call: failed, waiting for memory</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">schedule_timeout_interruptible</span><span class="p">(</span><span class="mi">5</span><span class="o">*</span><span class="n">HZ</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">nlmclnt_release_host</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">nlmclnt_release_call</span><span class="p">(</span><span class="k">struct</span> <span class="n">nlm_rqst</span> <span class="o">*</span><span class="n">call</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">atomic_dec_and_test</span><span class="p">(</span><span class="o">&amp;</span><span class="n">call</span><span class="o">-&gt;</span><span class="n">a_count</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">nlmclnt_release_host</span><span class="p">(</span><span class="n">call</span><span class="o">-&gt;</span><span class="n">a_host</span><span class="p">);</span>
	<span class="n">nlmclnt_release_lockargs</span><span class="p">(</span><span class="n">call</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">call</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">nlmclnt_rpc_release</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">nlmclnt_release_call</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">nlm_wait_on_grace</span><span class="p">(</span><span class="n">wait_queue_head_t</span> <span class="o">*</span><span class="n">queue</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">DEFINE_WAIT</span><span class="p">(</span><span class="n">wait</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINTR</span><span class="p">;</span>

	<span class="n">prepare_to_wait</span><span class="p">(</span><span class="n">queue</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wait</span><span class="p">,</span> <span class="n">TASK_INTERRUPTIBLE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">signalled</span> <span class="p">())</span> <span class="p">{</span>
		<span class="n">schedule_timeout</span><span class="p">(</span><span class="n">NLMCLNT_GRACE_WAIT</span><span class="p">);</span>
		<span class="n">try_to_freeze</span><span class="p">();</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">signalled</span> <span class="p">())</span>
			<span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">finish_wait</span><span class="p">(</span><span class="n">queue</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wait</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Generic NLM call</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">nlmclnt_call</span><span class="p">(</span><span class="k">struct</span> <span class="n">rpc_cred</span> <span class="o">*</span><span class="n">cred</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nlm_rqst</span> <span class="o">*</span><span class="n">req</span><span class="p">,</span> <span class="n">u32</span> <span class="n">proc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nlm_host</span>	<span class="o">*</span><span class="n">host</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">a_host</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rpc_clnt</span>	<span class="o">*</span><span class="n">clnt</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nlm_args</span>	<span class="o">*</span><span class="n">argp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">a_args</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nlm_res</span>	<span class="o">*</span><span class="n">resp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">a_res</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rpc_message</span> <span class="n">msg</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">rpc_argp</span>	<span class="o">=</span> <span class="n">argp</span><span class="p">,</span>
		<span class="p">.</span><span class="n">rpc_resp</span>	<span class="o">=</span> <span class="n">resp</span><span class="p">,</span>
		<span class="p">.</span><span class="n">rpc_cred</span>	<span class="o">=</span> <span class="n">cred</span><span class="p">,</span>
	<span class="p">};</span>
	<span class="kt">int</span>		<span class="n">status</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;lockd: call procedure %d on %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">proc</span><span class="p">,</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">h_name</span><span class="p">);</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">h_reclaiming</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">argp</span><span class="o">-&gt;</span><span class="n">reclaim</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">in_grace_period</span><span class="p">;</span>

		<span class="cm">/* If we have no RPC client yet, create one. */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">clnt</span> <span class="o">=</span> <span class="n">nlm_bind_host</span><span class="p">(</span><span class="n">host</span><span class="p">))</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOLCK</span><span class="p">;</span>
		<span class="n">msg</span><span class="p">.</span><span class="n">rpc_proc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">clnt</span><span class="o">-&gt;</span><span class="n">cl_procinfo</span><span class="p">[</span><span class="n">proc</span><span class="p">];</span>

		<span class="cm">/* Perform the RPC call. If an error occurs, try again */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">status</span> <span class="o">=</span> <span class="n">rpc_call_sync</span><span class="p">(</span><span class="n">clnt</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">msg</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;lockd: rpc_call returned error %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="o">-</span><span class="n">status</span><span class="p">);</span>
			<span class="k">switch</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="o">-</span><span class="n">EPROTONOSUPPORT</span>:
				<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="o">-</span><span class="n">ECONNREFUSED</span>:
			<span class="k">case</span> <span class="o">-</span><span class="n">ETIMEDOUT</span>:
			<span class="k">case</span> <span class="o">-</span><span class="n">ENOTCONN</span>:
				<span class="n">nlm_rebind_host</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>
				<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="o">-</span><span class="n">ERESTARTSYS</span>:
				<span class="k">return</span> <span class="n">signalled</span> <span class="p">()</span> <span class="o">?</span> <span class="o">-</span><span class="n">EINTR</span> <span class="o">:</span> <span class="n">status</span><span class="p">;</span>
			<span class="nl">default:</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">resp</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">==</span> <span class="n">nlm_lck_denied_grace_period</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;lockd: server in grace period</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">argp</span><span class="o">-&gt;</span><span class="n">reclaim</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span>
				     <span class="s">&quot;lockd: spurious grace period reject?!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">ENOLCK</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">argp</span><span class="o">-&gt;</span><span class="n">reclaim</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* We appear to be out of the grace period */</span>
				<span class="n">wake_up_all</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">h_gracewait</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;lockd: server returns status %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">ntohl</span><span class="p">(</span><span class="n">resp</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">));</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* Okay, call complete */</span>
		<span class="p">}</span>

<span class="nl">in_grace_period:</span>
		<span class="cm">/*</span>
<span class="cm">		 * The server has rebooted and appears to be in the grace</span>
<span class="cm">		 * period during which locks are only allowed to be</span>
<span class="cm">		 * reclaimed.</span>
<span class="cm">		 * We can only back off and try again later.</span>
<span class="cm">		 */</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">nlm_wait_on_grace</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">h_gracewait</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Generic NLM call, async version.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">rpc_task</span> <span class="o">*</span><span class="nf">__nlm_async_call</span><span class="p">(</span><span class="k">struct</span> <span class="n">nlm_rqst</span> <span class="o">*</span><span class="n">req</span><span class="p">,</span> <span class="n">u32</span> <span class="n">proc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rpc_message</span> <span class="o">*</span><span class="n">msg</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">rpc_call_ops</span> <span class="o">*</span><span class="n">tk_ops</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nlm_host</span>	<span class="o">*</span><span class="n">host</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">a_host</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rpc_clnt</span>	<span class="o">*</span><span class="n">clnt</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rpc_task_setup</span> <span class="n">task_setup_data</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">rpc_message</span> <span class="o">=</span> <span class="n">msg</span><span class="p">,</span>
		<span class="p">.</span><span class="n">callback_ops</span> <span class="o">=</span> <span class="n">tk_ops</span><span class="p">,</span>
		<span class="p">.</span><span class="n">callback_data</span> <span class="o">=</span> <span class="n">req</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">RPC_TASK_ASYNC</span><span class="p">,</span>
	<span class="p">};</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;lockd: call procedure %d on %s (async)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">proc</span><span class="p">,</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">h_name</span><span class="p">);</span>

	<span class="cm">/* If we have no RPC client yet, create one. */</span>
	<span class="n">clnt</span> <span class="o">=</span> <span class="n">nlm_bind_host</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">clnt</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_err</span><span class="p">;</span>
	<span class="n">msg</span><span class="o">-&gt;</span><span class="n">rpc_proc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">clnt</span><span class="o">-&gt;</span><span class="n">cl_procinfo</span><span class="p">[</span><span class="n">proc</span><span class="p">];</span>
	<span class="n">task_setup_data</span><span class="p">.</span><span class="n">rpc_client</span> <span class="o">=</span> <span class="n">clnt</span><span class="p">;</span>

        <span class="cm">/* bootstrap and kick off the async RPC call */</span>
	<span class="k">return</span> <span class="n">rpc_run_task</span><span class="p">(</span><span class="o">&amp;</span><span class="n">task_setup_data</span><span class="p">);</span>
<span class="nl">out_err:</span>
	<span class="n">tk_ops</span><span class="o">-&gt;</span><span class="n">rpc_release</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">ENOLCK</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">nlm_do_async_call</span><span class="p">(</span><span class="k">struct</span> <span class="n">nlm_rqst</span> <span class="o">*</span><span class="n">req</span><span class="p">,</span> <span class="n">u32</span> <span class="n">proc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rpc_message</span> <span class="o">*</span><span class="n">msg</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">rpc_call_ops</span> <span class="o">*</span><span class="n">tk_ops</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rpc_task</span> <span class="o">*</span><span class="n">task</span><span class="p">;</span>

	<span class="n">task</span> <span class="o">=</span> <span class="n">__nlm_async_call</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="n">proc</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">tk_ops</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">task</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">task</span><span class="p">);</span>
	<span class="n">rpc_put_task</span><span class="p">(</span><span class="n">task</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * NLM asynchronous call.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">nlm_async_call</span><span class="p">(</span><span class="k">struct</span> <span class="n">nlm_rqst</span> <span class="o">*</span><span class="n">req</span><span class="p">,</span> <span class="n">u32</span> <span class="n">proc</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">rpc_call_ops</span> <span class="o">*</span><span class="n">tk_ops</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rpc_message</span> <span class="n">msg</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">rpc_argp</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">a_args</span><span class="p">,</span>
		<span class="p">.</span><span class="n">rpc_resp</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">a_res</span><span class="p">,</span>
	<span class="p">};</span>
	<span class="k">return</span> <span class="n">nlm_do_async_call</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="n">proc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">msg</span><span class="p">,</span> <span class="n">tk_ops</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">nlm_async_reply</span><span class="p">(</span><span class="k">struct</span> <span class="n">nlm_rqst</span> <span class="o">*</span><span class="n">req</span><span class="p">,</span> <span class="n">u32</span> <span class="n">proc</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">rpc_call_ops</span> <span class="o">*</span><span class="n">tk_ops</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rpc_message</span> <span class="n">msg</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">rpc_argp</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">a_res</span><span class="p">,</span>
	<span class="p">};</span>
	<span class="k">return</span> <span class="n">nlm_do_async_call</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="n">proc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">msg</span><span class="p">,</span> <span class="n">tk_ops</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * NLM client asynchronous call.</span>
<span class="cm"> *</span>
<span class="cm"> * Note that although the calls are asynchronous, and are therefore</span>
<span class="cm"> *      guaranteed to complete, we still always attempt to wait for</span>
<span class="cm"> *      completion in order to be able to correctly track the lock</span>
<span class="cm"> *      state.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">nlmclnt_async_call</span><span class="p">(</span><span class="k">struct</span> <span class="n">rpc_cred</span> <span class="o">*</span><span class="n">cred</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nlm_rqst</span> <span class="o">*</span><span class="n">req</span><span class="p">,</span> <span class="n">u32</span> <span class="n">proc</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">rpc_call_ops</span> <span class="o">*</span><span class="n">tk_ops</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rpc_message</span> <span class="n">msg</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">rpc_argp</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">a_args</span><span class="p">,</span>
		<span class="p">.</span><span class="n">rpc_resp</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">a_res</span><span class="p">,</span>
		<span class="p">.</span><span class="n">rpc_cred</span>	<span class="o">=</span> <span class="n">cred</span><span class="p">,</span>
	<span class="p">};</span>
	<span class="k">struct</span> <span class="n">rpc_task</span> <span class="o">*</span><span class="n">task</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">task</span> <span class="o">=</span> <span class="n">__nlm_async_call</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="n">proc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">msg</span><span class="p">,</span> <span class="n">tk_ops</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">task</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">task</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">rpc_wait_for_completion_task</span><span class="p">(</span><span class="n">task</span><span class="p">);</span>
	<span class="n">rpc_put_task</span><span class="p">(</span><span class="n">task</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * TEST for the presence of a conflicting lock</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">nlmclnt_test</span><span class="p">(</span><span class="k">struct</span> <span class="n">nlm_rqst</span> <span class="o">*</span><span class="n">req</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file_lock</span> <span class="o">*</span><span class="n">fl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span>	<span class="n">status</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">nlmclnt_call</span><span class="p">(</span><span class="n">nfs_file_cred</span><span class="p">(</span><span class="n">fl</span><span class="o">-&gt;</span><span class="n">fl_file</span><span class="p">),</span> <span class="n">req</span><span class="p">,</span> <span class="n">NLMPROC_TEST</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">a_res</span><span class="p">.</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">nlm_granted</span>:
			<span class="n">fl</span><span class="o">-&gt;</span><span class="n">fl_type</span> <span class="o">=</span> <span class="n">F_UNLCK</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">nlm_lck_denied</span>:
			<span class="cm">/*</span>
<span class="cm">			 * Report the conflicting lock back to the application.</span>
<span class="cm">			 */</span>
			<span class="n">fl</span><span class="o">-&gt;</span><span class="n">fl_start</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">a_res</span><span class="p">.</span><span class="n">lock</span><span class="p">.</span><span class="n">fl</span><span class="p">.</span><span class="n">fl_start</span><span class="p">;</span>
			<span class="n">fl</span><span class="o">-&gt;</span><span class="n">fl_end</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">a_res</span><span class="p">.</span><span class="n">lock</span><span class="p">.</span><span class="n">fl</span><span class="p">.</span><span class="n">fl_end</span><span class="p">;</span>
			<span class="n">fl</span><span class="o">-&gt;</span><span class="n">fl_type</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">a_res</span><span class="p">.</span><span class="n">lock</span><span class="p">.</span><span class="n">fl</span><span class="p">.</span><span class="n">fl_type</span><span class="p">;</span>
			<span class="n">fl</span><span class="o">-&gt;</span><span class="n">fl_pid</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">nlm_stat_to_errno</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">a_res</span><span class="p">.</span><span class="n">status</span><span class="p">);</span>
	<span class="p">}</span>
<span class="nl">out:</span>
	<span class="n">nlmclnt_release_call</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">nlmclnt_locks_copy_lock</span><span class="p">(</span><span class="k">struct</span> <span class="n">file_lock</span> <span class="o">*</span><span class="n">new</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file_lock</span> <span class="o">*</span><span class="n">fl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fl</span><span class="o">-&gt;</span><span class="n">fl_u</span><span class="p">.</span><span class="n">nfs_fl</span><span class="p">.</span><span class="n">owner</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">h_lock</span><span class="p">);</span>
	<span class="n">new</span><span class="o">-&gt;</span><span class="n">fl_u</span><span class="p">.</span><span class="n">nfs_fl</span><span class="p">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">fl</span><span class="o">-&gt;</span><span class="n">fl_u</span><span class="p">.</span><span class="n">nfs_fl</span><span class="p">.</span><span class="n">state</span><span class="p">;</span>
	<span class="n">new</span><span class="o">-&gt;</span><span class="n">fl_u</span><span class="p">.</span><span class="n">nfs_fl</span><span class="p">.</span><span class="n">owner</span> <span class="o">=</span> <span class="n">nlm_get_lockowner</span><span class="p">(</span><span class="n">fl</span><span class="o">-&gt;</span><span class="n">fl_u</span><span class="p">.</span><span class="n">nfs_fl</span><span class="p">.</span><span class="n">owner</span><span class="p">);</span>
	<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">new</span><span class="o">-&gt;</span><span class="n">fl_u</span><span class="p">.</span><span class="n">nfs_fl</span><span class="p">.</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fl</span><span class="o">-&gt;</span><span class="n">fl_u</span><span class="p">.</span><span class="n">nfs_fl</span><span class="p">.</span><span class="n">owner</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">h_granted</span><span class="p">);</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fl</span><span class="o">-&gt;</span><span class="n">fl_u</span><span class="p">.</span><span class="n">nfs_fl</span><span class="p">.</span><span class="n">owner</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">h_lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">nlmclnt_locks_release_private</span><span class="p">(</span><span class="k">struct</span> <span class="n">file_lock</span> <span class="o">*</span><span class="n">fl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fl</span><span class="o">-&gt;</span><span class="n">fl_u</span><span class="p">.</span><span class="n">nfs_fl</span><span class="p">.</span><span class="n">owner</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">h_lock</span><span class="p">);</span>
	<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fl</span><span class="o">-&gt;</span><span class="n">fl_u</span><span class="p">.</span><span class="n">nfs_fl</span><span class="p">.</span><span class="n">list</span><span class="p">);</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fl</span><span class="o">-&gt;</span><span class="n">fl_u</span><span class="p">.</span><span class="n">nfs_fl</span><span class="p">.</span><span class="n">owner</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">h_lock</span><span class="p">);</span>
	<span class="n">nlm_put_lockowner</span><span class="p">(</span><span class="n">fl</span><span class="o">-&gt;</span><span class="n">fl_u</span><span class="p">.</span><span class="n">nfs_fl</span><span class="p">.</span><span class="n">owner</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">file_lock_operations</span> <span class="n">nlmclnt_lock_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">fl_copy_lock</span> <span class="o">=</span> <span class="n">nlmclnt_locks_copy_lock</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fl_release_private</span> <span class="o">=</span> <span class="n">nlmclnt_locks_release_private</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">nlmclnt_locks_init_private</span><span class="p">(</span><span class="k">struct</span> <span class="n">file_lock</span> <span class="o">*</span><span class="n">fl</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nlm_host</span> <span class="o">*</span><span class="n">host</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">fl</span><span class="o">-&gt;</span><span class="n">fl_ops</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">fl</span><span class="o">-&gt;</span><span class="n">fl_u</span><span class="p">.</span><span class="n">nfs_fl</span><span class="p">.</span><span class="n">state</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">fl</span><span class="o">-&gt;</span><span class="n">fl_u</span><span class="p">.</span><span class="n">nfs_fl</span><span class="p">.</span><span class="n">owner</span> <span class="o">=</span> <span class="n">nlm_find_lockowner</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">fl</span><span class="o">-&gt;</span><span class="n">fl_owner</span><span class="p">);</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fl</span><span class="o">-&gt;</span><span class="n">fl_u</span><span class="p">.</span><span class="n">nfs_fl</span><span class="p">.</span><span class="n">list</span><span class="p">);</span>
	<span class="n">fl</span><span class="o">-&gt;</span><span class="n">fl_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">nlmclnt_lock_ops</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">do_vfs_lock</span><span class="p">(</span><span class="k">struct</span> <span class="n">file_lock</span> <span class="o">*</span><span class="n">fl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">res</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">fl</span><span class="o">-&gt;</span><span class="n">fl_flags</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">FL_POSIX</span><span class="o">|</span><span class="n">FL_FLOCK</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">FL_POSIX</span>:
			<span class="n">res</span> <span class="o">=</span> <span class="n">posix_lock_file_wait</span><span class="p">(</span><span class="n">fl</span><span class="o">-&gt;</span><span class="n">fl_file</span><span class="p">,</span> <span class="n">fl</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">FL_FLOCK</span>:
			<span class="n">res</span> <span class="o">=</span> <span class="n">flock_lock_file_wait</span><span class="p">(</span><span class="n">fl</span><span class="o">-&gt;</span><span class="n">fl_file</span><span class="p">,</span> <span class="n">fl</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">BUG</span><span class="p">();</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * LOCK: Try to create a lock</span>
<span class="cm"> *</span>
<span class="cm"> *			Programmer Harassment Alert</span>
<span class="cm"> *</span>
<span class="cm"> * When given a blocking lock request in a sync RPC call, the HPUX lockd</span>
<span class="cm"> * will faithfully return LCK_BLOCKED but never cares to notify us when</span>
<span class="cm"> * the lock could be granted. This way, our local process could hang</span>
<span class="cm"> * around forever waiting for the callback.</span>
<span class="cm"> *</span>
<span class="cm"> *  Solution A:	Implement busy-waiting</span>
<span class="cm"> *  Solution B: Use the async version of the call (NLM_LOCK_{MSG,RES})</span>
<span class="cm"> *</span>
<span class="cm"> * For now I am implementing solution A, because I hate the idea of</span>
<span class="cm"> * re-implementing lockd for a third time in two months. The async</span>
<span class="cm"> * calls shouldn&#39;t be too hard to do, however.</span>
<span class="cm"> *</span>
<span class="cm"> * This is one of the lovely things about standards in the NFS area:</span>
<span class="cm"> * they&#39;re so soft and squishy you can&#39;t really blame HP for doing this.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">nlmclnt_lock</span><span class="p">(</span><span class="k">struct</span> <span class="n">nlm_rqst</span> <span class="o">*</span><span class="n">req</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file_lock</span> <span class="o">*</span><span class="n">fl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rpc_cred</span> <span class="o">*</span><span class="n">cred</span> <span class="o">=</span> <span class="n">nfs_file_cred</span><span class="p">(</span><span class="n">fl</span><span class="o">-&gt;</span><span class="n">fl_file</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">nlm_host</span>	<span class="o">*</span><span class="n">host</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">a_host</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nlm_res</span>	<span class="o">*</span><span class="n">resp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">a_res</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nlm_wait</span> <span class="o">*</span><span class="n">block</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">fl_flags</span> <span class="o">=</span> <span class="n">fl</span><span class="o">-&gt;</span><span class="n">fl_flags</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">fl_type</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOLCK</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nsm_monitor</span><span class="p">(</span><span class="n">host</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">a_args</span><span class="p">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">nsm_local_state</span><span class="p">;</span>

	<span class="n">fl</span><span class="o">-&gt;</span><span class="n">fl_flags</span> <span class="o">|=</span> <span class="n">FL_ACCESS</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">do_vfs_lock</span><span class="p">(</span><span class="n">fl</span><span class="p">);</span>
	<span class="n">fl</span><span class="o">-&gt;</span><span class="n">fl_flags</span> <span class="o">=</span> <span class="n">fl_flags</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">block</span> <span class="o">=</span> <span class="n">nlmclnt_prepare_block</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">fl</span><span class="p">);</span>
<span class="nl">again:</span>
	<span class="cm">/*</span>
<span class="cm">	 * Initialise resp-&gt;status to a valid non-zero value,</span>
<span class="cm">	 * since 0 == nlm_lck_granted</span>
<span class="cm">	 */</span>
	<span class="n">resp</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">nlm_lck_blocked</span><span class="p">;</span>
	<span class="k">for</span><span class="p">(;;)</span> <span class="p">{</span>
		<span class="cm">/* Reboot protection */</span>
		<span class="n">fl</span><span class="o">-&gt;</span><span class="n">fl_u</span><span class="p">.</span><span class="n">nfs_fl</span><span class="p">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">h_state</span><span class="p">;</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">nlmclnt_call</span><span class="p">(</span><span class="n">cred</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="n">NLMPROC_LOCK</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="cm">/* Did a reclaimer thread notify us of a server reboot? */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">resp</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">==</span>  <span class="n">nlm_lck_denied_grace_period</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">resp</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">!=</span> <span class="n">nlm_lck_blocked</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="cm">/* Wait on an NLM blocking lock */</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">nlmclnt_block</span><span class="p">(</span><span class="n">block</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="n">NLMCLNT_POLL_TIMEOUT</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">resp</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">!=</span> <span class="n">nlm_lck_blocked</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* if we were interrupted while blocking, then cancel the lock request</span>
<span class="cm">	 * and exit</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">resp</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">==</span> <span class="n">nlm_lck_blocked</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">a_args</span><span class="p">.</span><span class="n">block</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out_unlock</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">nlmclnt_cancel</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">a_args</span><span class="p">.</span><span class="n">block</span><span class="p">,</span> <span class="n">fl</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out_unblock</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">resp</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">==</span> <span class="n">nlm_granted</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">down_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">h_rwsem</span><span class="p">);</span>
		<span class="cm">/* Check whether or not the server has rebooted */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">fl</span><span class="o">-&gt;</span><span class="n">fl_u</span><span class="p">.</span><span class="n">nfs_fl</span><span class="p">.</span><span class="n">state</span> <span class="o">!=</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">h_state</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">up_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">h_rwsem</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">again</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* Ensure the resulting lock will get added to granted list */</span>
		<span class="n">fl</span><span class="o">-&gt;</span><span class="n">fl_flags</span> <span class="o">|=</span> <span class="n">FL_SLEEP</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">do_vfs_lock</span><span class="p">(</span><span class="n">fl</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s: VFS is out of sync with lock manager!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="n">up_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">h_rwsem</span><span class="p">);</span>
		<span class="n">fl</span><span class="o">-&gt;</span><span class="n">fl_flags</span> <span class="o">=</span> <span class="n">fl_flags</span><span class="p">;</span>
		<span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_unlock</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * EAGAIN doesn&#39;t make sense for sleeping locks, and in some</span>
<span class="cm">	 * cases NLM_LCK_DENIED is returned for a permanent error.  So</span>
<span class="cm">	 * turn it into an ENOLCK.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">resp</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">==</span> <span class="n">nlm_lck_denied</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">fl_flags</span> <span class="o">&amp;</span> <span class="n">FL_SLEEP</span><span class="p">))</span>
		<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOLCK</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">nlm_stat_to_errno</span><span class="p">(</span><span class="n">resp</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>
<span class="nl">out_unblock:</span>
	<span class="n">nlmclnt_finish_block</span><span class="p">(</span><span class="n">block</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="n">nlmclnt_release_call</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="nl">out_unlock:</span>
	<span class="cm">/* Fatal error: ensure that we remove the lock altogether */</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;lockd: lock attempt ended in fatal error.</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;       Attempting to unlock.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">nlmclnt_finish_block</span><span class="p">(</span><span class="n">block</span><span class="p">);</span>
	<span class="n">fl_type</span> <span class="o">=</span> <span class="n">fl</span><span class="o">-&gt;</span><span class="n">fl_type</span><span class="p">;</span>
	<span class="n">fl</span><span class="o">-&gt;</span><span class="n">fl_type</span> <span class="o">=</span> <span class="n">F_UNLCK</span><span class="p">;</span>
	<span class="n">down_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">h_rwsem</span><span class="p">);</span>
	<span class="n">do_vfs_lock</span><span class="p">(</span><span class="n">fl</span><span class="p">);</span>
	<span class="n">up_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">h_rwsem</span><span class="p">);</span>
	<span class="n">fl</span><span class="o">-&gt;</span><span class="n">fl_type</span> <span class="o">=</span> <span class="n">fl_type</span><span class="p">;</span>
	<span class="n">fl</span><span class="o">-&gt;</span><span class="n">fl_flags</span> <span class="o">=</span> <span class="n">fl_flags</span><span class="p">;</span>
	<span class="n">nlmclnt_async_call</span><span class="p">(</span><span class="n">cred</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="n">NLMPROC_UNLOCK</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">nlmclnt_unlock_ops</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * RECLAIM: Try to reclaim a lock</span>
<span class="cm"> */</span>
<span class="kt">int</span>
<span class="nf">nlmclnt_reclaim</span><span class="p">(</span><span class="k">struct</span> <span class="n">nlm_host</span> <span class="o">*</span><span class="n">host</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file_lock</span> <span class="o">*</span><span class="n">fl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nlm_rqst</span> <span class="n">reqst</span><span class="p">,</span> <span class="o">*</span><span class="n">req</span><span class="p">;</span>
	<span class="kt">int</span>		<span class="n">status</span><span class="p">;</span>

	<span class="n">req</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">reqst</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">req</span><span class="p">));</span>
	<span class="n">locks_init_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">a_args</span><span class="p">.</span><span class="n">lock</span><span class="p">.</span><span class="n">fl</span><span class="p">);</span>
	<span class="n">locks_init_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">a_res</span><span class="p">.</span><span class="n">lock</span><span class="p">.</span><span class="n">fl</span><span class="p">);</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">a_host</span>  <span class="o">=</span> <span class="n">host</span><span class="p">;</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">a_flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Set up the argument struct */</span>
	<span class="n">nlmclnt_setlockargs</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="n">fl</span><span class="p">);</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">a_args</span><span class="p">.</span><span class="n">reclaim</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">nlmclnt_call</span><span class="p">(</span><span class="n">nfs_file_cred</span><span class="p">(</span><span class="n">fl</span><span class="o">-&gt;</span><span class="n">fl_file</span><span class="p">),</span> <span class="n">req</span><span class="p">,</span> <span class="n">NLMPROC_LOCK</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">a_res</span><span class="p">.</span><span class="n">status</span> <span class="o">==</span> <span class="n">nlm_granted</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;lockd: failed to reclaim lock for pid %d &quot;</span>
				<span class="s">&quot;(errno %d, status %d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">fl</span><span class="o">-&gt;</span><span class="n">fl_pid</span><span class="p">,</span>
				<span class="n">status</span><span class="p">,</span> <span class="n">ntohl</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">a_res</span><span class="p">.</span><span class="n">status</span><span class="p">));</span>

	<span class="cm">/*</span>
<span class="cm">	 * FIXME: This is a serious failure. We can</span>
<span class="cm">	 *</span>
<span class="cm">	 *  a.	Ignore the problem</span>
<span class="cm">	 *  b.	Send the owning process some signal (Linux doesn&#39;t have</span>
<span class="cm">	 *	SIGLOST, though...)</span>
<span class="cm">	 *  c.	Retry the operation</span>
<span class="cm">	 *</span>
<span class="cm">	 * Until someone comes up with a simple implementation</span>
<span class="cm">	 * for b or c, I&#39;ll choose option a.</span>
<span class="cm">	 */</span>

	<span class="k">return</span> <span class="o">-</span><span class="n">ENOLCK</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * UNLOCK: remove an existing lock</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">nlmclnt_unlock</span><span class="p">(</span><span class="k">struct</span> <span class="n">nlm_rqst</span> <span class="o">*</span><span class="n">req</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file_lock</span> <span class="o">*</span><span class="n">fl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nlm_host</span>	<span class="o">*</span><span class="n">host</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">a_host</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nlm_res</span>	<span class="o">*</span><span class="n">resp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">a_res</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">fl_flags</span> <span class="o">=</span> <span class="n">fl</span><span class="o">-&gt;</span><span class="n">fl_flags</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Note: the server is supposed to either grant us the unlock</span>
<span class="cm">	 * request, or to deny it with NLM_LCK_DENIED_GRACE_PERIOD. In either</span>
<span class="cm">	 * case, we want to unlock.</span>
<span class="cm">	 */</span>
	<span class="n">fl</span><span class="o">-&gt;</span><span class="n">fl_flags</span> <span class="o">|=</span> <span class="n">FL_EXISTS</span><span class="p">;</span>
	<span class="n">down_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">h_rwsem</span><span class="p">);</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">do_vfs_lock</span><span class="p">(</span><span class="n">fl</span><span class="p">);</span>
	<span class="n">up_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">h_rwsem</span><span class="p">);</span>
	<span class="n">fl</span><span class="o">-&gt;</span><span class="n">fl_flags</span> <span class="o">=</span> <span class="n">fl_flags</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">a_count</span><span class="p">);</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">nlmclnt_async_call</span><span class="p">(</span><span class="n">nfs_file_cred</span><span class="p">(</span><span class="n">fl</span><span class="o">-&gt;</span><span class="n">fl_file</span><span class="p">),</span> <span class="n">req</span><span class="p">,</span>
			<span class="n">NLMPROC_UNLOCK</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">nlmclnt_unlock_ops</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">resp</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">==</span> <span class="n">nlm_granted</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">resp</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">!=</span> <span class="n">nlm_lck_denied_nolocks</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;lockd: unexpected unlock status: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">ntohl</span><span class="p">(</span><span class="n">resp</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">));</span>
	<span class="cm">/* What to do now? I&#39;m out of my depth... */</span>
	<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOLCK</span><span class="p">;</span>
<span class="nl">out:</span>
	<span class="n">nlmclnt_release_call</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">nlmclnt_unlock_callback</span><span class="p">(</span><span class="k">struct</span> <span class="n">rpc_task</span> <span class="o">*</span><span class="n">task</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nlm_rqst</span>	<span class="o">*</span><span class="n">req</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">status</span> <span class="o">=</span> <span class="n">ntohl</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">a_res</span><span class="p">.</span><span class="n">status</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">RPC_ASSASSINATED</span><span class="p">(</span><span class="n">task</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">die</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">task</span><span class="o">-&gt;</span><span class="n">tk_status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;lockd: unlock failed (err = %d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="o">-</span><span class="n">task</span><span class="o">-&gt;</span><span class="n">tk_status</span><span class="p">);</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">task</span><span class="o">-&gt;</span><span class="n">tk_status</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="o">-</span><span class="n">EACCES</span>:
		<span class="k">case</span> <span class="o">-</span><span class="n">EIO</span>:
			<span class="k">goto</span> <span class="n">die</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="k">goto</span> <span class="n">retry_rebind</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="n">NLM_LCK_DENIED_GRACE_PERIOD</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rpc_delay</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="n">NLMCLNT_GRACE_WAIT</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">retry_unlock</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">!=</span> <span class="n">NLM_LCK_GRANTED</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;lockd: unexpected unlock status: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
<span class="nl">die:</span>
	<span class="k">return</span><span class="p">;</span>
 <span class="nl">retry_rebind:</span>
	<span class="n">nlm_rebind_host</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">a_host</span><span class="p">);</span>
 <span class="nl">retry_unlock:</span>
	<span class="n">rpc_restart_call</span><span class="p">(</span><span class="n">task</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">rpc_call_ops</span> <span class="n">nlmclnt_unlock_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">rpc_call_done</span> <span class="o">=</span> <span class="n">nlmclnt_unlock_callback</span><span class="p">,</span>
	<span class="p">.</span><span class="n">rpc_release</span> <span class="o">=</span> <span class="n">nlmclnt_rpc_release</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * Cancel a blocked lock request.</span>
<span class="cm"> * We always use an async RPC call for this in order not to hang a</span>
<span class="cm"> * process that has been Ctrl-C&#39;ed.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">nlmclnt_cancel</span><span class="p">(</span><span class="k">struct</span> <span class="n">nlm_host</span> <span class="o">*</span><span class="n">host</span><span class="p">,</span> <span class="kt">int</span> <span class="n">block</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file_lock</span> <span class="o">*</span><span class="n">fl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nlm_rqst</span>	<span class="o">*</span><span class="n">req</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;lockd: blocking lock attempt was interrupted by a signal.</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;       Attempting to cancel lock.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">req</span> <span class="o">=</span> <span class="n">nlm_alloc_call</span><span class="p">(</span><span class="n">nlm_get_host</span><span class="p">(</span><span class="n">host</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">req</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">a_flags</span> <span class="o">=</span> <span class="n">RPC_TASK_ASYNC</span><span class="p">;</span>

	<span class="n">nlmclnt_setlockargs</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="n">fl</span><span class="p">);</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">a_args</span><span class="p">.</span><span class="n">block</span> <span class="o">=</span> <span class="n">block</span><span class="p">;</span>

	<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">a_count</span><span class="p">);</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">nlmclnt_async_call</span><span class="p">(</span><span class="n">nfs_file_cred</span><span class="p">(</span><span class="n">fl</span><span class="o">-&gt;</span><span class="n">fl_file</span><span class="p">),</span> <span class="n">req</span><span class="p">,</span>
			<span class="n">NLMPROC_CANCEL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">nlmclnt_cancel_ops</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">a_res</span><span class="p">.</span><span class="n">status</span> <span class="o">==</span> <span class="n">nlm_lck_denied</span><span class="p">)</span>
		<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOLCK</span><span class="p">;</span>
	<span class="n">nlmclnt_release_call</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">nlmclnt_cancel_callback</span><span class="p">(</span><span class="k">struct</span> <span class="n">rpc_task</span> <span class="o">*</span><span class="n">task</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nlm_rqst</span>	<span class="o">*</span><span class="n">req</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">status</span> <span class="o">=</span> <span class="n">ntohl</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">a_res</span><span class="p">.</span><span class="n">status</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">RPC_ASSASSINATED</span><span class="p">(</span><span class="n">task</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">die</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">task</span><span class="o">-&gt;</span><span class="n">tk_status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;lockd: CANCEL call error %d, retrying.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">task</span><span class="o">-&gt;</span><span class="n">tk_status</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">retry_cancel</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;lockd: cancel status %u (task %u)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">status</span><span class="p">,</span> <span class="n">task</span><span class="o">-&gt;</span><span class="n">tk_pid</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">NLM_LCK_GRANTED</span>:
	<span class="k">case</span> <span class="n">NLM_LCK_DENIED_GRACE_PERIOD</span>:
	<span class="k">case</span> <span class="n">NLM_LCK_DENIED</span>:
		<span class="cm">/* Everything&#39;s good */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">NLM_LCK_DENIED_NOLOCKS</span>:
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;lockd: CANCEL failed (server has no locks)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">retry_cancel</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_NOTICE</span> <span class="s">&quot;lockd: weird return %d for CANCEL call</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">status</span><span class="p">);</span>
	<span class="p">}</span>

<span class="nl">die:</span>
	<span class="k">return</span><span class="p">;</span>

<span class="nl">retry_cancel:</span>
	<span class="cm">/* Don&#39;t ever retry more than 3 times */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">a_retries</span><span class="o">++</span> <span class="o">&gt;=</span> <span class="n">NLMCLNT_MAX_RETRIES</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">die</span><span class="p">;</span>
	<span class="n">nlm_rebind_host</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">a_host</span><span class="p">);</span>
	<span class="n">rpc_restart_call</span><span class="p">(</span><span class="n">task</span><span class="p">);</span>
	<span class="n">rpc_delay</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="mi">30</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">rpc_call_ops</span> <span class="n">nlmclnt_cancel_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">rpc_call_done</span> <span class="o">=</span> <span class="n">nlmclnt_cancel_callback</span><span class="p">,</span>
	<span class="p">.</span><span class="n">rpc_release</span> <span class="o">=</span> <span class="n">nlmclnt_rpc_release</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * Convert an NLM status code to a generic kernel errno</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">nlm_stat_to_errno</span><span class="p">(</span><span class="n">__be32</span> <span class="n">status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span><span class="p">(</span><span class="n">ntohl</span><span class="p">(</span><span class="n">status</span><span class="p">))</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">NLM_LCK_GRANTED</span>:
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">NLM_LCK_DENIED</span>:
		<span class="k">return</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">NLM_LCK_DENIED_NOLOCKS</span>:
	<span class="k">case</span> <span class="n">NLM_LCK_DENIED_GRACE_PERIOD</span>:
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOLCK</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">NLM_LCK_BLOCKED</span>:
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_NOTICE</span> <span class="s">&quot;lockd: unexpected status NLM_BLOCKED</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOLCK</span><span class="p">;</span>
<span class="cp">#ifdef CONFIG_LOCKD_V4</span>
	<span class="k">case</span> <span class="n">NLM_DEADLCK</span>:
		<span class="k">return</span> <span class="o">-</span><span class="n">EDEADLK</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">NLM_ROFS</span>:
		<span class="k">return</span> <span class="o">-</span><span class="n">EROFS</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">NLM_STALE_FH</span>:
		<span class="k">return</span> <span class="o">-</span><span class="n">ESTALE</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">NLM_FBIG</span>:
		<span class="k">return</span> <span class="o">-</span><span class="n">EOVERFLOW</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">NLM_FAILED</span>:
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOLCK</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="p">}</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_NOTICE</span> <span class="s">&quot;lockd: unexpected server status %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">ntohl</span><span class="p">(</span><span class="n">status</span><span class="p">));</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENOLCK</span><span class="p">;</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
