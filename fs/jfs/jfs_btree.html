<!DOCTYPE html>
<html><head><title>joekychen/linux » fs › jfs › jfs_btree.h

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>jfs_btree.h</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> *   Copyright (C) International Business Machines Corp., 2000-2004</span>
<span class="cm"> *</span>
<span class="cm"> *   This program is free software;  you can redistribute it and/or modify</span>
<span class="cm"> *   it under the terms of the GNU General Public License as published by</span>
<span class="cm"> *   the Free Software Foundation; either version 2 of the License, or</span>
<span class="cm"> *   (at your option) any later version.</span>
<span class="cm"> *</span>
<span class="cm"> *   This program is distributed in the hope that it will be useful,</span>
<span class="cm"> *   but WITHOUT ANY WARRANTY;  without even the implied warranty of</span>
<span class="cm"> *   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See</span>
<span class="cm"> *   the GNU General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> *   You should have received a copy of the GNU General Public License</span>
<span class="cm"> *   along with this program;  if not, write to the Free Software</span>
<span class="cm"> *   Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA 02111-1307 USA</span>
<span class="cm"> */</span>
<span class="cp">#ifndef	_H_JFS_BTREE</span>
<span class="cp">#define _H_JFS_BTREE</span>

<span class="cm">/*</span>
<span class="cm"> *	jfs_btree.h: B+-tree</span>
<span class="cm"> *</span>
<span class="cm"> * JFS B+-tree (dtree and xtree) common definitions</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> *	basic btree page - btpage</span>
<span class="cm"> *</span>
<span class="cm">struct btpage {</span>
<span class="cm">	s64 next;		right sibling bn</span>
<span class="cm">	s64 prev;		left sibling bn</span>

<span class="cm">	u8 flag;</span>
<span class="cm">	u8 rsrvd[7];		type specific</span>
<span class="cm">	s64 self;		self address</span>

<span class="cm">	u8 entry[4064];</span>
<span class="cm">};						*/</span>

<span class="cm">/* btpaget_t flag */</span>
<span class="cp">#define BT_TYPE		0x07	</span><span class="cm">/* B+-tree index */</span><span class="cp"></span>
<span class="cp">#define	BT_ROOT		0x01	</span><span class="cm">/* root page */</span><span class="cp"></span>
<span class="cp">#define	BT_LEAF		0x02	</span><span class="cm">/* leaf page */</span><span class="cp"></span>
<span class="cp">#define	BT_INTERNAL	0x04	</span><span class="cm">/* internal page */</span><span class="cp"></span>
<span class="cp">#define	BT_RIGHTMOST	0x10	</span><span class="cm">/* rightmost page */</span><span class="cp"></span>
<span class="cp">#define	BT_LEFTMOST	0x20	</span><span class="cm">/* leftmost page */</span><span class="cp"></span>
<span class="cp">#define	BT_SWAPPED	0x80	</span><span class="cm">/* used by fsck for endian swapping */</span><span class="cp"></span>

<span class="cm">/* btorder (in inode) */</span>
<span class="cp">#define	BT_RANDOM		0x0000</span>
<span class="cp">#define	BT_SEQUENTIAL		0x0001</span>
<span class="cp">#define	BT_LOOKUP		0x0010</span>
<span class="cp">#define	BT_INSERT		0x0020</span>
<span class="cp">#define	BT_DELETE		0x0040</span>

<span class="cm">/*</span>
<span class="cm"> *	btree page buffer cache access</span>
<span class="cm"> */</span>
<span class="cp">#define BT_IS_ROOT(MP) (((MP)-&gt;xflag &amp; COMMIT_PAGE) == 0)</span>

<span class="cm">/* get page from buffer page */</span>
<span class="cp">#define BT_PAGE(IP, MP, TYPE, ROOT)\</span>
<span class="cp">	(BT_IS_ROOT(MP) ? (TYPE *)&amp;JFS_IP(IP)-&gt;ROOT : (TYPE *)(MP)-&gt;data)</span>

<span class="cm">/* get the page buffer and the page for specified block address */</span>
<span class="cp">#define BT_GETPAGE(IP, BN, MP, TYPE, SIZE, P, RC, ROOT)\</span>
<span class="cp">{\</span>
<span class="cp">	if ((BN) == 0)\</span>
<span class="cp">	{\</span>
<span class="cp">		MP = (struct metapage *)&amp;JFS_IP(IP)-&gt;bxflag;\</span>
<span class="cp">		P = (TYPE *)&amp;JFS_IP(IP)-&gt;ROOT;\</span>
<span class="cp">		RC = 0;\</span>
<span class="cp">	}\</span>
<span class="cp">	else\</span>
<span class="cp">	{\</span>
<span class="cp">		MP = read_metapage((IP), BN, SIZE, 1);\</span>
<span class="cp">		if (MP) {\</span>
<span class="cp">			RC = 0;\</span>
<span class="cp">			P = (MP)-&gt;data;\</span>
<span class="cp">		} else {\</span>
<span class="cp">			P = NULL;\</span>
<span class="cp">			jfs_err(&quot;bread failed!&quot;);\</span>
<span class="cp">			RC = -EIO;\</span>
<span class="cp">		}\</span>
<span class="cp">	}\</span>
<span class="cp">}</span>

<span class="cp">#define BT_MARK_DIRTY(MP, IP)\</span>
<span class="cp">{\</span>
<span class="cp">	if (BT_IS_ROOT(MP))\</span>
<span class="cp">		mark_inode_dirty(IP);\</span>
<span class="cp">	else\</span>
<span class="cp">		mark_metapage_dirty(MP);\</span>
<span class="cp">}</span>

<span class="cm">/* put the page buffer */</span>
<span class="cp">#define BT_PUTPAGE(MP)\</span>
<span class="cp">{\</span>
<span class="cp">	if (! BT_IS_ROOT(MP)) \</span>
<span class="cp">		release_metapage(MP); \</span>
<span class="cp">}</span>


<span class="cm">/*</span>
<span class="cm"> *	btree traversal stack</span>
<span class="cm"> *</span>
<span class="cm"> * record the path traversed during the search;</span>
<span class="cm"> * top frame record the leaf page/entry selected.</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">btframe</span> <span class="p">{</span>	<span class="cm">/* stack frame */</span>
	<span class="n">s64</span> <span class="n">bn</span><span class="p">;</span>			<span class="cm">/* 8: */</span>
	<span class="n">s16</span> <span class="n">index</span><span class="p">;</span>		<span class="cm">/* 2: */</span>
	<span class="n">s16</span> <span class="n">lastindex</span><span class="p">;</span>		<span class="cm">/* 2: unused */</span>
	<span class="k">struct</span> <span class="n">metapage</span> <span class="o">*</span><span class="n">mp</span><span class="p">;</span>	<span class="cm">/* 4/8: */</span>
<span class="p">};</span>				<span class="cm">/* (16/24) */</span>

<span class="k">struct</span> <span class="n">btstack</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">btframe</span> <span class="o">*</span><span class="n">top</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">nsplit</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">btframe</span> <span class="n">stack</span><span class="p">[</span><span class="n">MAXTREEHEIGHT</span><span class="p">];</span>
<span class="p">};</span>

<span class="cp">#define BT_CLR(btstack)\</span>
<span class="cp">	(btstack)-&gt;top = (btstack)-&gt;stack</span>

<span class="cp">#define BT_STACK_FULL(btstack)\</span>
<span class="cp">	( (btstack)-&gt;top == &amp;((btstack)-&gt;stack[MAXTREEHEIGHT-1]))</span>

<span class="cp">#define BT_PUSH(BTSTACK, BN, INDEX)\</span>
<span class="cp">{\</span>
<span class="cp">	assert(!BT_STACK_FULL(BTSTACK));\</span>
<span class="cp">	(BTSTACK)-&gt;top-&gt;bn = BN;\</span>
<span class="cp">	(BTSTACK)-&gt;top-&gt;index = INDEX;\</span>
<span class="cp">	++(BTSTACK)-&gt;top;\</span>
<span class="cp">}</span>

<span class="cp">#define BT_POP(btstack)\</span>
<span class="cp">	( (btstack)-&gt;top == (btstack)-&gt;stack ? NULL : --(btstack)-&gt;top )</span>

<span class="cp">#define BT_STACK(btstack)\</span>
<span class="cp">	( (btstack)-&gt;top == (btstack)-&gt;stack ? NULL : (btstack)-&gt;top )</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">BT_STACK_DUMP</span><span class="p">(</span><span class="k">struct</span> <span class="n">btstack</span> <span class="o">*</span><span class="n">btstack</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;btstack dump:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MAXTREEHEIGHT</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;bn = %Lx, index = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="p">(</span><span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">btstack</span><span class="o">-&gt;</span><span class="n">stack</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">bn</span><span class="p">,</span>
		       <span class="n">btstack</span><span class="o">-&gt;</span><span class="n">stack</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">index</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* retrieve search results */</span>
<span class="cp">#define BT_GETSEARCH(IP, LEAF, BN, MP, TYPE, P, INDEX, ROOT)\</span>
<span class="cp">{\</span>
<span class="cp">	BN = (LEAF)-&gt;bn;\</span>
<span class="cp">	MP = (LEAF)-&gt;mp;\</span>
<span class="cp">	if (BN)\</span>
<span class="cp">		P = (TYPE *)MP-&gt;data;\</span>
<span class="cp">	else\</span>
<span class="cp">		P = (TYPE *)&amp;JFS_IP(IP)-&gt;ROOT;\</span>
<span class="cp">	INDEX = (LEAF)-&gt;index;\</span>
<span class="cp">}</span>

<span class="cm">/* put the page buffer of search */</span>
<span class="cp">#define BT_PUTSEARCH(BTSTACK)\</span>
<span class="cp">{\</span>
<span class="cp">	if (! BT_IS_ROOT((BTSTACK)-&gt;top-&gt;mp))\</span>
<span class="cp">		release_metapage((BTSTACK)-&gt;top-&gt;mp);\</span>
<span class="cp">}</span>
<span class="cp">#endif				</span><span class="cm">/* _H_JFS_BTREE */</span><span class="cp"></span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
