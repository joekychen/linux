<!DOCTYPE html>
<html><head><title>joekychen/linux » fs › jfs › namei.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>namei.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> *   Copyright (C) International Business Machines Corp., 2000-2004</span>
<span class="cm"> *   Portions Copyright (C) Christoph Hellwig, 2001-2002</span>
<span class="cm"> *</span>
<span class="cm"> *   This program is free software;  you can redistribute it and/or modify</span>
<span class="cm"> *   it under the terms of the GNU General Public License as published by</span>
<span class="cm"> *   the Free Software Foundation; either version 2 of the License, or</span>
<span class="cm"> *   (at your option) any later version.</span>
<span class="cm"> *</span>
<span class="cm"> *   This program is distributed in the hope that it will be useful,</span>
<span class="cm"> *   but WITHOUT ANY WARRANTY;  without even the implied warranty of</span>
<span class="cm"> *   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See</span>
<span class="cm"> *   the GNU General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> *   You should have received a copy of the GNU General Public License</span>
<span class="cm"> *   along with this program;  if not, write to the Free Software</span>
<span class="cm"> *   Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA 02111-1307 USA</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/fs.h&gt;</span>
<span class="cp">#include &lt;linux/namei.h&gt;</span>
<span class="cp">#include &lt;linux/ctype.h&gt;</span>
<span class="cp">#include &lt;linux/quotaops.h&gt;</span>
<span class="cp">#include &lt;linux/exportfs.h&gt;</span>
<span class="cp">#include &quot;jfs_incore.h&quot;</span>
<span class="cp">#include &quot;jfs_superblock.h&quot;</span>
<span class="cp">#include &quot;jfs_inode.h&quot;</span>
<span class="cp">#include &quot;jfs_dinode.h&quot;</span>
<span class="cp">#include &quot;jfs_dmap.h&quot;</span>
<span class="cp">#include &quot;jfs_unicode.h&quot;</span>
<span class="cp">#include &quot;jfs_metapage.h&quot;</span>
<span class="cp">#include &quot;jfs_xattr.h&quot;</span>
<span class="cp">#include &quot;jfs_acl.h&quot;</span>
<span class="cp">#include &quot;jfs_debug.h&quot;</span>

<span class="cm">/*</span>
<span class="cm"> * forward references</span>
<span class="cm"> */</span>
<span class="k">const</span> <span class="k">struct</span> <span class="n">dentry_operations</span> <span class="n">jfs_ci_dentry_operations</span><span class="p">;</span>

<span class="k">static</span> <span class="n">s64</span> <span class="n">commitZeroLink</span><span class="p">(</span><span class="n">tid_t</span><span class="p">,</span> <span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * NAME:	free_ea_wmap(inode)</span>
<span class="cm"> *</span>
<span class="cm"> * FUNCTION:	free uncommitted extended attributes from working map</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">free_ea_wmap</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dxd_t</span> <span class="o">*</span><span class="n">ea</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">JFS_IP</span><span class="p">(</span><span class="n">inode</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">ea</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ea</span><span class="o">-&gt;</span><span class="n">flag</span> <span class="o">&amp;</span> <span class="n">DXD_EXTENT</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* free EA pages from cache */</span>
		<span class="n">invalidate_dxd_metapages</span><span class="p">(</span><span class="n">inode</span><span class="p">,</span> <span class="o">*</span><span class="n">ea</span><span class="p">);</span>
		<span class="n">dbFree</span><span class="p">(</span><span class="n">inode</span><span class="p">,</span> <span class="n">addressDXD</span><span class="p">(</span><span class="n">ea</span><span class="p">),</span> <span class="n">lengthDXD</span><span class="p">(</span><span class="n">ea</span><span class="p">));</span>
	<span class="p">}</span>
	<span class="n">ea</span><span class="o">-&gt;</span><span class="n">flag</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * NAME:	jfs_create(dip, dentry, mode)</span>
<span class="cm"> *</span>
<span class="cm"> * FUNCTION:	create a regular file in the parent directory &lt;dip&gt;</span>
<span class="cm"> *		with name = &lt;from dentry&gt; and mode = &lt;mode&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * PARAMETER:	dip	- parent directory vnode</span>
<span class="cm"> *		dentry	- dentry of new file</span>
<span class="cm"> *		mode	- create mode (rwxrwxrwx).</span>
<span class="cm"> *		nd- nd struct</span>
<span class="cm"> *</span>
<span class="cm"> * RETURN:	Errors from subroutines</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">jfs_create</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">dip</span><span class="p">,</span> <span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="n">dentry</span><span class="p">,</span> <span class="n">umode_t</span> <span class="n">mode</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">nameidata</span> <span class="o">*</span><span class="n">nd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">tid_t</span> <span class="n">tid</span><span class="p">;</span>		<span class="cm">/* transaction id */</span>
	<span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">ip</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>	<span class="cm">/* child directory inode */</span>
	<span class="n">ino_t</span> <span class="n">ino</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">component_name</span> <span class="n">dname</span><span class="p">;</span>	<span class="cm">/* child directory name */</span>
	<span class="k">struct</span> <span class="n">btstack</span> <span class="n">btstack</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">iplist</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">tblock</span> <span class="o">*</span><span class="n">tblk</span><span class="p">;</span>

	<span class="n">jfs_info</span><span class="p">(</span><span class="s">&quot;jfs_create: dip:0x%p name:%s&quot;</span><span class="p">,</span> <span class="n">dip</span><span class="p">,</span> <span class="n">dentry</span><span class="o">-&gt;</span><span class="n">d_name</span><span class="p">.</span><span class="n">name</span><span class="p">);</span>

	<span class="n">dquot_initialize</span><span class="p">(</span><span class="n">dip</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * search parent directory for entry/freespace</span>
<span class="cm">	 * (dtSearch() returns parent directory page pinned)</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">rc</span> <span class="o">=</span> <span class="n">get_UCSname</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dname</span><span class="p">,</span> <span class="n">dentry</span><span class="p">)))</span>
		<span class="k">goto</span> <span class="n">out1</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Either iAlloc() or txBegin() may block.  Deadlock can occur if we</span>
<span class="cm">	 * block there while holding dtree page, so we allocate the inode &amp;</span>
<span class="cm">	 * begin the transaction before we search the directory.</span>
<span class="cm">	 */</span>
	<span class="n">ip</span> <span class="o">=</span> <span class="n">ialloc</span><span class="p">(</span><span class="n">dip</span><span class="p">,</span> <span class="n">mode</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">ip</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">ip</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out2</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">tid</span> <span class="o">=</span> <span class="n">txBegin</span><span class="p">(</span><span class="n">dip</span><span class="o">-&gt;</span><span class="n">i_sb</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">mutex_lock_nested</span><span class="p">(</span><span class="o">&amp;</span><span class="n">JFS_IP</span><span class="p">(</span><span class="n">dip</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">commit_mutex</span><span class="p">,</span> <span class="n">COMMIT_MUTEX_PARENT</span><span class="p">);</span>
	<span class="n">mutex_lock_nested</span><span class="p">(</span><span class="o">&amp;</span><span class="n">JFS_IP</span><span class="p">(</span><span class="n">ip</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">commit_mutex</span><span class="p">,</span> <span class="n">COMMIT_MUTEX_CHILD</span><span class="p">);</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">jfs_init_acl</span><span class="p">(</span><span class="n">tid</span><span class="p">,</span> <span class="n">ip</span><span class="p">,</span> <span class="n">dip</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out3</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">jfs_init_security</span><span class="p">(</span><span class="n">tid</span><span class="p">,</span> <span class="n">ip</span><span class="p">,</span> <span class="n">dip</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dentry</span><span class="o">-&gt;</span><span class="n">d_name</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">txAbort</span><span class="p">(</span><span class="n">tid</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out3</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">rc</span> <span class="o">=</span> <span class="n">dtSearch</span><span class="p">(</span><span class="n">dip</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dname</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ino</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">btstack</span><span class="p">,</span> <span class="n">JFS_CREATE</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">jfs_err</span><span class="p">(</span><span class="s">&quot;jfs_create: dtSearch returned %d&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
		<span class="n">txAbort</span><span class="p">(</span><span class="n">tid</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out3</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">tblk</span> <span class="o">=</span> <span class="n">tid_to_tblock</span><span class="p">(</span><span class="n">tid</span><span class="p">);</span>
	<span class="n">tblk</span><span class="o">-&gt;</span><span class="n">xflag</span> <span class="o">|=</span> <span class="n">COMMIT_CREATE</span><span class="p">;</span>
	<span class="n">tblk</span><span class="o">-&gt;</span><span class="n">ino</span> <span class="o">=</span> <span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_ino</span><span class="p">;</span>
	<span class="n">tblk</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">ixpxd</span> <span class="o">=</span> <span class="n">JFS_IP</span><span class="p">(</span><span class="n">ip</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">ixpxd</span><span class="p">;</span>

	<span class="n">iplist</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">dip</span><span class="p">;</span>
	<span class="n">iplist</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">ip</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * initialize the child XAD tree root in-line in inode</span>
<span class="cm">	 */</span>
	<span class="n">xtInitRoot</span><span class="p">(</span><span class="n">tid</span><span class="p">,</span> <span class="n">ip</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * create entry in parent directory for child directory</span>
<span class="cm">	 * (dtInsert() releases parent directory page)</span>
<span class="cm">	 */</span>
	<span class="n">ino</span> <span class="o">=</span> <span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_ino</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">rc</span> <span class="o">=</span> <span class="n">dtInsert</span><span class="p">(</span><span class="n">tid</span><span class="p">,</span> <span class="n">dip</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dname</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ino</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">btstack</span><span class="p">)))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="o">-</span><span class="n">EIO</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">jfs_err</span><span class="p">(</span><span class="s">&quot;jfs_create: dtInsert returned -EIO&quot;</span><span class="p">);</span>
			<span class="n">txAbort</span><span class="p">(</span><span class="n">tid</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>	<span class="cm">/* Marks Filesystem dirty */</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">txAbort</span><span class="p">(</span><span class="n">tid</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>	<span class="cm">/* Filesystem full */</span>
		<span class="k">goto</span> <span class="n">out3</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_op</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">jfs_file_inode_operations</span><span class="p">;</span>
	<span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_fop</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">jfs_file_operations</span><span class="p">;</span>
	<span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_mapping</span><span class="o">-&gt;</span><span class="n">a_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">jfs_aops</span><span class="p">;</span>

	<span class="n">mark_inode_dirty</span><span class="p">(</span><span class="n">ip</span><span class="p">);</span>

	<span class="n">dip</span><span class="o">-&gt;</span><span class="n">i_ctime</span> <span class="o">=</span> <span class="n">dip</span><span class="o">-&gt;</span><span class="n">i_mtime</span> <span class="o">=</span> <span class="n">CURRENT_TIME</span><span class="p">;</span>

	<span class="n">mark_inode_dirty</span><span class="p">(</span><span class="n">dip</span><span class="p">);</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">txCommit</span><span class="p">(</span><span class="n">tid</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">iplist</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">);</span>

      <span class="nl">out3:</span>
	<span class="n">txEnd</span><span class="p">(</span><span class="n">tid</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">JFS_IP</span><span class="p">(</span><span class="n">ip</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">commit_mutex</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">JFS_IP</span><span class="p">(</span><span class="n">dip</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">commit_mutex</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">free_ea_wmap</span><span class="p">(</span><span class="n">ip</span><span class="p">);</span>
		<span class="n">clear_nlink</span><span class="p">(</span><span class="n">ip</span><span class="p">);</span>
		<span class="n">unlock_new_inode</span><span class="p">(</span><span class="n">ip</span><span class="p">);</span>
		<span class="n">iput</span><span class="p">(</span><span class="n">ip</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">d_instantiate</span><span class="p">(</span><span class="n">dentry</span><span class="p">,</span> <span class="n">ip</span><span class="p">);</span>
		<span class="n">unlock_new_inode</span><span class="p">(</span><span class="n">ip</span><span class="p">);</span>
	<span class="p">}</span>

      <span class="nl">out2:</span>
	<span class="n">free_UCSname</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dname</span><span class="p">);</span>

      <span class="nl">out1:</span>

	<span class="n">jfs_info</span><span class="p">(</span><span class="s">&quot;jfs_create: rc:%d&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * NAME:	jfs_mkdir(dip, dentry, mode)</span>
<span class="cm"> *</span>
<span class="cm"> * FUNCTION:	create a child directory in the parent directory &lt;dip&gt;</span>
<span class="cm"> *		with name = &lt;from dentry&gt; and mode = &lt;mode&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * PARAMETER:	dip	- parent directory vnode</span>
<span class="cm"> *		dentry	- dentry of child directory</span>
<span class="cm"> *		mode	- create mode (rwxrwxrwx).</span>
<span class="cm"> *</span>
<span class="cm"> * RETURN:	Errors from subroutines</span>
<span class="cm"> *</span>
<span class="cm"> * note:</span>
<span class="cm"> * EACCESS: user needs search+write permission on the parent directory</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">jfs_mkdir</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">dip</span><span class="p">,</span> <span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="n">dentry</span><span class="p">,</span> <span class="n">umode_t</span> <span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">tid_t</span> <span class="n">tid</span><span class="p">;</span>		<span class="cm">/* transaction id */</span>
	<span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">ip</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>	<span class="cm">/* child directory inode */</span>
	<span class="n">ino_t</span> <span class="n">ino</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">component_name</span> <span class="n">dname</span><span class="p">;</span>	<span class="cm">/* child directory name */</span>
	<span class="k">struct</span> <span class="n">btstack</span> <span class="n">btstack</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">iplist</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">tblock</span> <span class="o">*</span><span class="n">tblk</span><span class="p">;</span>

	<span class="n">jfs_info</span><span class="p">(</span><span class="s">&quot;jfs_mkdir: dip:0x%p name:%s&quot;</span><span class="p">,</span> <span class="n">dip</span><span class="p">,</span> <span class="n">dentry</span><span class="o">-&gt;</span><span class="n">d_name</span><span class="p">.</span><span class="n">name</span><span class="p">);</span>

	<span class="n">dquot_initialize</span><span class="p">(</span><span class="n">dip</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * search parent directory for entry/freespace</span>
<span class="cm">	 * (dtSearch() returns parent directory page pinned)</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">rc</span> <span class="o">=</span> <span class="n">get_UCSname</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dname</span><span class="p">,</span> <span class="n">dentry</span><span class="p">)))</span>
		<span class="k">goto</span> <span class="n">out1</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Either iAlloc() or txBegin() may block.  Deadlock can occur if we</span>
<span class="cm">	 * block there while holding dtree page, so we allocate the inode &amp;</span>
<span class="cm">	 * begin the transaction before we search the directory.</span>
<span class="cm">	 */</span>
	<span class="n">ip</span> <span class="o">=</span> <span class="n">ialloc</span><span class="p">(</span><span class="n">dip</span><span class="p">,</span> <span class="n">S_IFDIR</span> <span class="o">|</span> <span class="n">mode</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">ip</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">ip</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out2</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">tid</span> <span class="o">=</span> <span class="n">txBegin</span><span class="p">(</span><span class="n">dip</span><span class="o">-&gt;</span><span class="n">i_sb</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">mutex_lock_nested</span><span class="p">(</span><span class="o">&amp;</span><span class="n">JFS_IP</span><span class="p">(</span><span class="n">dip</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">commit_mutex</span><span class="p">,</span> <span class="n">COMMIT_MUTEX_PARENT</span><span class="p">);</span>
	<span class="n">mutex_lock_nested</span><span class="p">(</span><span class="o">&amp;</span><span class="n">JFS_IP</span><span class="p">(</span><span class="n">ip</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">commit_mutex</span><span class="p">,</span> <span class="n">COMMIT_MUTEX_CHILD</span><span class="p">);</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">jfs_init_acl</span><span class="p">(</span><span class="n">tid</span><span class="p">,</span> <span class="n">ip</span><span class="p">,</span> <span class="n">dip</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out3</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">jfs_init_security</span><span class="p">(</span><span class="n">tid</span><span class="p">,</span> <span class="n">ip</span><span class="p">,</span> <span class="n">dip</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dentry</span><span class="o">-&gt;</span><span class="n">d_name</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">txAbort</span><span class="p">(</span><span class="n">tid</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out3</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">rc</span> <span class="o">=</span> <span class="n">dtSearch</span><span class="p">(</span><span class="n">dip</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dname</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ino</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">btstack</span><span class="p">,</span> <span class="n">JFS_CREATE</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">jfs_err</span><span class="p">(</span><span class="s">&quot;jfs_mkdir: dtSearch returned %d&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
		<span class="n">txAbort</span><span class="p">(</span><span class="n">tid</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out3</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">tblk</span> <span class="o">=</span> <span class="n">tid_to_tblock</span><span class="p">(</span><span class="n">tid</span><span class="p">);</span>
	<span class="n">tblk</span><span class="o">-&gt;</span><span class="n">xflag</span> <span class="o">|=</span> <span class="n">COMMIT_CREATE</span><span class="p">;</span>
	<span class="n">tblk</span><span class="o">-&gt;</span><span class="n">ino</span> <span class="o">=</span> <span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_ino</span><span class="p">;</span>
	<span class="n">tblk</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">ixpxd</span> <span class="o">=</span> <span class="n">JFS_IP</span><span class="p">(</span><span class="n">ip</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">ixpxd</span><span class="p">;</span>

	<span class="n">iplist</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">dip</span><span class="p">;</span>
	<span class="n">iplist</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">ip</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * initialize the child directory in-line in inode</span>
<span class="cm">	 */</span>
	<span class="n">dtInitRoot</span><span class="p">(</span><span class="n">tid</span><span class="p">,</span> <span class="n">ip</span><span class="p">,</span> <span class="n">dip</span><span class="o">-&gt;</span><span class="n">i_ino</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * create entry in parent directory for child directory</span>
<span class="cm">	 * (dtInsert() releases parent directory page)</span>
<span class="cm">	 */</span>
	<span class="n">ino</span> <span class="o">=</span> <span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_ino</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">rc</span> <span class="o">=</span> <span class="n">dtInsert</span><span class="p">(</span><span class="n">tid</span><span class="p">,</span> <span class="n">dip</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dname</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ino</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">btstack</span><span class="p">)))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="o">-</span><span class="n">EIO</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">jfs_err</span><span class="p">(</span><span class="s">&quot;jfs_mkdir: dtInsert returned -EIO&quot;</span><span class="p">);</span>
			<span class="n">txAbort</span><span class="p">(</span><span class="n">tid</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>	<span class="cm">/* Marks Filesystem dirty */</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">txAbort</span><span class="p">(</span><span class="n">tid</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>	<span class="cm">/* Filesystem full */</span>
		<span class="k">goto</span> <span class="n">out3</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">set_nlink</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>	<span class="cm">/* for &#39;.&#39; */</span>
	<span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_op</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">jfs_dir_inode_operations</span><span class="p">;</span>
	<span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_fop</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">jfs_dir_operations</span><span class="p">;</span>

	<span class="n">mark_inode_dirty</span><span class="p">(</span><span class="n">ip</span><span class="p">);</span>

	<span class="cm">/* update parent directory inode */</span>
	<span class="n">inc_nlink</span><span class="p">(</span><span class="n">dip</span><span class="p">);</span>		<span class="cm">/* for &#39;..&#39; from child directory */</span>
	<span class="n">dip</span><span class="o">-&gt;</span><span class="n">i_ctime</span> <span class="o">=</span> <span class="n">dip</span><span class="o">-&gt;</span><span class="n">i_mtime</span> <span class="o">=</span> <span class="n">CURRENT_TIME</span><span class="p">;</span>
	<span class="n">mark_inode_dirty</span><span class="p">(</span><span class="n">dip</span><span class="p">);</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">txCommit</span><span class="p">(</span><span class="n">tid</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">iplist</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">);</span>

      <span class="nl">out3:</span>
	<span class="n">txEnd</span><span class="p">(</span><span class="n">tid</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">JFS_IP</span><span class="p">(</span><span class="n">ip</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">commit_mutex</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">JFS_IP</span><span class="p">(</span><span class="n">dip</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">commit_mutex</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">free_ea_wmap</span><span class="p">(</span><span class="n">ip</span><span class="p">);</span>
		<span class="n">clear_nlink</span><span class="p">(</span><span class="n">ip</span><span class="p">);</span>
		<span class="n">unlock_new_inode</span><span class="p">(</span><span class="n">ip</span><span class="p">);</span>
		<span class="n">iput</span><span class="p">(</span><span class="n">ip</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">d_instantiate</span><span class="p">(</span><span class="n">dentry</span><span class="p">,</span> <span class="n">ip</span><span class="p">);</span>
		<span class="n">unlock_new_inode</span><span class="p">(</span><span class="n">ip</span><span class="p">);</span>
	<span class="p">}</span>

      <span class="nl">out2:</span>
	<span class="n">free_UCSname</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dname</span><span class="p">);</span>


      <span class="nl">out1:</span>

	<span class="n">jfs_info</span><span class="p">(</span><span class="s">&quot;jfs_mkdir: rc:%d&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * NAME:	jfs_rmdir(dip, dentry)</span>
<span class="cm"> *</span>
<span class="cm"> * FUNCTION:	remove a link to child directory</span>
<span class="cm"> *</span>
<span class="cm"> * PARAMETER:	dip	- parent inode</span>
<span class="cm"> *		dentry	- child directory dentry</span>
<span class="cm"> *</span>
<span class="cm"> * RETURN:	-EINVAL	- if name is . or ..</span>
<span class="cm"> *		-EINVAL - if . or .. exist but are invalid.</span>
<span class="cm"> *		errors from subroutines</span>
<span class="cm"> *</span>
<span class="cm"> * note:</span>
<span class="cm"> * if other threads have the directory open when the last link</span>
<span class="cm"> * is removed, the &quot;.&quot; and &quot;..&quot; entries, if present, are removed before</span>
<span class="cm"> * rmdir() returns and no new entries may be created in the directory,</span>
<span class="cm"> * but the directory is not removed until the last reference to</span>
<span class="cm"> * the directory is released (cf.unlink() of regular file).</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">jfs_rmdir</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">dip</span><span class="p">,</span> <span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="n">dentry</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>
	<span class="n">tid_t</span> <span class="n">tid</span><span class="p">;</span>		<span class="cm">/* transaction id */</span>
	<span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">ip</span> <span class="o">=</span> <span class="n">dentry</span><span class="o">-&gt;</span><span class="n">d_inode</span><span class="p">;</span>
	<span class="n">ino_t</span> <span class="n">ino</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">component_name</span> <span class="n">dname</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">iplist</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">tblock</span> <span class="o">*</span><span class="n">tblk</span><span class="p">;</span>

	<span class="n">jfs_info</span><span class="p">(</span><span class="s">&quot;jfs_rmdir: dip:0x%p name:%s&quot;</span><span class="p">,</span> <span class="n">dip</span><span class="p">,</span> <span class="n">dentry</span><span class="o">-&gt;</span><span class="n">d_name</span><span class="p">.</span><span class="n">name</span><span class="p">);</span>

	<span class="cm">/* Init inode for quota operations. */</span>
	<span class="n">dquot_initialize</span><span class="p">(</span><span class="n">dip</span><span class="p">);</span>
	<span class="n">dquot_initialize</span><span class="p">(</span><span class="n">ip</span><span class="p">);</span>

	<span class="cm">/* directory must be empty to be removed */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dtEmpty</span><span class="p">(</span><span class="n">ip</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOTEMPTY</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">rc</span> <span class="o">=</span> <span class="n">get_UCSname</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dname</span><span class="p">,</span> <span class="n">dentry</span><span class="p">)))</span> <span class="p">{</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">tid</span> <span class="o">=</span> <span class="n">txBegin</span><span class="p">(</span><span class="n">dip</span><span class="o">-&gt;</span><span class="n">i_sb</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">mutex_lock_nested</span><span class="p">(</span><span class="o">&amp;</span><span class="n">JFS_IP</span><span class="p">(</span><span class="n">dip</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">commit_mutex</span><span class="p">,</span> <span class="n">COMMIT_MUTEX_PARENT</span><span class="p">);</span>
	<span class="n">mutex_lock_nested</span><span class="p">(</span><span class="o">&amp;</span><span class="n">JFS_IP</span><span class="p">(</span><span class="n">ip</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">commit_mutex</span><span class="p">,</span> <span class="n">COMMIT_MUTEX_CHILD</span><span class="p">);</span>

	<span class="n">iplist</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">dip</span><span class="p">;</span>
	<span class="n">iplist</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">ip</span><span class="p">;</span>

	<span class="n">tblk</span> <span class="o">=</span> <span class="n">tid_to_tblock</span><span class="p">(</span><span class="n">tid</span><span class="p">);</span>
	<span class="n">tblk</span><span class="o">-&gt;</span><span class="n">xflag</span> <span class="o">|=</span> <span class="n">COMMIT_DELETE</span><span class="p">;</span>
	<span class="n">tblk</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">ip</span> <span class="o">=</span> <span class="n">ip</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * delete the entry of target directory from parent directory</span>
<span class="cm">	 */</span>
	<span class="n">ino</span> <span class="o">=</span> <span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_ino</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">rc</span> <span class="o">=</span> <span class="n">dtDelete</span><span class="p">(</span><span class="n">tid</span><span class="p">,</span> <span class="n">dip</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dname</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ino</span><span class="p">,</span> <span class="n">JFS_REMOVE</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">jfs_err</span><span class="p">(</span><span class="s">&quot;jfs_rmdir: dtDelete returned %d&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="o">-</span><span class="n">EIO</span><span class="p">)</span>
			<span class="n">txAbort</span><span class="p">(</span><span class="n">tid</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">txEnd</span><span class="p">(</span><span class="n">tid</span><span class="p">);</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">JFS_IP</span><span class="p">(</span><span class="n">ip</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">commit_mutex</span><span class="p">);</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">JFS_IP</span><span class="p">(</span><span class="n">dip</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">commit_mutex</span><span class="p">);</span>

		<span class="k">goto</span> <span class="n">out2</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* update parent directory&#39;s link count corresponding</span>
<span class="cm">	 * to &quot;..&quot; entry of the target directory deleted</span>
<span class="cm">	 */</span>
	<span class="n">dip</span><span class="o">-&gt;</span><span class="n">i_ctime</span> <span class="o">=</span> <span class="n">dip</span><span class="o">-&gt;</span><span class="n">i_mtime</span> <span class="o">=</span> <span class="n">CURRENT_TIME</span><span class="p">;</span>
	<span class="n">inode_dec_link_count</span><span class="p">(</span><span class="n">dip</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * OS/2 could have created EA and/or ACL</span>
<span class="cm">	 */</span>
	<span class="cm">/* free EA from both persistent and working map */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">JFS_IP</span><span class="p">(</span><span class="n">ip</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">ea</span><span class="p">.</span><span class="n">flag</span> <span class="o">&amp;</span> <span class="n">DXD_EXTENT</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* free EA pages */</span>
		<span class="n">txEA</span><span class="p">(</span><span class="n">tid</span><span class="p">,</span> <span class="n">ip</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">JFS_IP</span><span class="p">(</span><span class="n">ip</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">ea</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">JFS_IP</span><span class="p">(</span><span class="n">ip</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">ea</span><span class="p">.</span><span class="n">flag</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* free ACL from both persistent and working map */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">JFS_IP</span><span class="p">(</span><span class="n">ip</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">acl</span><span class="p">.</span><span class="n">flag</span> <span class="o">&amp;</span> <span class="n">DXD_EXTENT</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* free ACL pages */</span>
		<span class="n">txEA</span><span class="p">(</span><span class="n">tid</span><span class="p">,</span> <span class="n">ip</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">JFS_IP</span><span class="p">(</span><span class="n">ip</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">acl</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">JFS_IP</span><span class="p">(</span><span class="n">ip</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">acl</span><span class="p">.</span><span class="n">flag</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* mark the target directory as deleted */</span>
	<span class="n">clear_nlink</span><span class="p">(</span><span class="n">ip</span><span class="p">);</span>
	<span class="n">mark_inode_dirty</span><span class="p">(</span><span class="n">ip</span><span class="p">);</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">txCommit</span><span class="p">(</span><span class="n">tid</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">iplist</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">txEnd</span><span class="p">(</span><span class="n">tid</span><span class="p">);</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">JFS_IP</span><span class="p">(</span><span class="n">ip</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">commit_mutex</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">JFS_IP</span><span class="p">(</span><span class="n">dip</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">commit_mutex</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Truncating the directory index table is not guaranteed.  It</span>
<span class="cm">	 * may need to be done iteratively</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_cflag</span><span class="p">(</span><span class="n">COMMIT_Stale</span><span class="p">,</span> <span class="n">dip</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dip</span><span class="o">-&gt;</span><span class="n">i_size</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
			<span class="n">jfs_truncate_nolock</span><span class="p">(</span><span class="n">dip</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

		<span class="n">clear_cflag</span><span class="p">(</span><span class="n">COMMIT_Stale</span><span class="p">,</span> <span class="n">dip</span><span class="p">);</span>
	<span class="p">}</span>

      <span class="nl">out2:</span>
	<span class="n">free_UCSname</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dname</span><span class="p">);</span>

      <span class="nl">out:</span>
	<span class="n">jfs_info</span><span class="p">(</span><span class="s">&quot;jfs_rmdir: rc:%d&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * NAME:	jfs_unlink(dip, dentry)</span>
<span class="cm"> *</span>
<span class="cm"> * FUNCTION:	remove a link to object &lt;vp&gt; named by &lt;name&gt;</span>
<span class="cm"> *		from parent directory &lt;dvp&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * PARAMETER:	dip	- inode of parent directory</span>
<span class="cm"> *		dentry	- dentry of object to be removed</span>
<span class="cm"> *</span>
<span class="cm"> * RETURN:	errors from subroutines</span>
<span class="cm"> *</span>
<span class="cm"> * note:</span>
<span class="cm"> * temporary file: if one or more processes have the file open</span>
<span class="cm"> * when the last link is removed, the link will be removed before</span>
<span class="cm"> * unlink() returns, but the removal of the file contents will be</span>
<span class="cm"> * postponed until all references to the files are closed.</span>
<span class="cm"> *</span>
<span class="cm"> * JFS does NOT support unlink() on directories.</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">jfs_unlink</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">dip</span><span class="p">,</span> <span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="n">dentry</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>
	<span class="n">tid_t</span> <span class="n">tid</span><span class="p">;</span>		<span class="cm">/* transaction id */</span>
	<span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">ip</span> <span class="o">=</span> <span class="n">dentry</span><span class="o">-&gt;</span><span class="n">d_inode</span><span class="p">;</span>
	<span class="n">ino_t</span> <span class="n">ino</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">component_name</span> <span class="n">dname</span><span class="p">;</span>	<span class="cm">/* object name */</span>
	<span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">iplist</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">tblock</span> <span class="o">*</span><span class="n">tblk</span><span class="p">;</span>
	<span class="n">s64</span> <span class="n">new_size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">commit_flag</span><span class="p">;</span>

	<span class="n">jfs_info</span><span class="p">(</span><span class="s">&quot;jfs_unlink: dip:0x%p name:%s&quot;</span><span class="p">,</span> <span class="n">dip</span><span class="p">,</span> <span class="n">dentry</span><span class="o">-&gt;</span><span class="n">d_name</span><span class="p">.</span><span class="n">name</span><span class="p">);</span>

	<span class="cm">/* Init inode for quota operations. */</span>
	<span class="n">dquot_initialize</span><span class="p">(</span><span class="n">dip</span><span class="p">);</span>
	<span class="n">dquot_initialize</span><span class="p">(</span><span class="n">ip</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">rc</span> <span class="o">=</span> <span class="n">get_UCSname</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dname</span><span class="p">,</span> <span class="n">dentry</span><span class="p">)))</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">IWRITE_LOCK</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">RDWRLOCK_NORMAL</span><span class="p">);</span>

	<span class="n">tid</span> <span class="o">=</span> <span class="n">txBegin</span><span class="p">(</span><span class="n">dip</span><span class="o">-&gt;</span><span class="n">i_sb</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">mutex_lock_nested</span><span class="p">(</span><span class="o">&amp;</span><span class="n">JFS_IP</span><span class="p">(</span><span class="n">dip</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">commit_mutex</span><span class="p">,</span> <span class="n">COMMIT_MUTEX_PARENT</span><span class="p">);</span>
	<span class="n">mutex_lock_nested</span><span class="p">(</span><span class="o">&amp;</span><span class="n">JFS_IP</span><span class="p">(</span><span class="n">ip</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">commit_mutex</span><span class="p">,</span> <span class="n">COMMIT_MUTEX_CHILD</span><span class="p">);</span>

	<span class="n">iplist</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">dip</span><span class="p">;</span>
	<span class="n">iplist</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">ip</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * delete the entry of target file from parent directory</span>
<span class="cm">	 */</span>
	<span class="n">ino</span> <span class="o">=</span> <span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_ino</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">rc</span> <span class="o">=</span> <span class="n">dtDelete</span><span class="p">(</span><span class="n">tid</span><span class="p">,</span> <span class="n">dip</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dname</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ino</span><span class="p">,</span> <span class="n">JFS_REMOVE</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">jfs_err</span><span class="p">(</span><span class="s">&quot;jfs_unlink: dtDelete returned %d&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="o">-</span><span class="n">EIO</span><span class="p">)</span>
			<span class="n">txAbort</span><span class="p">(</span><span class="n">tid</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>	<span class="cm">/* Marks FS Dirty */</span>
		<span class="n">txEnd</span><span class="p">(</span><span class="n">tid</span><span class="p">);</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">JFS_IP</span><span class="p">(</span><span class="n">ip</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">commit_mutex</span><span class="p">);</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">JFS_IP</span><span class="p">(</span><span class="n">dip</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">commit_mutex</span><span class="p">);</span>
		<span class="n">IWRITE_UNLOCK</span><span class="p">(</span><span class="n">ip</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ASSERT</span><span class="p">(</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_nlink</span><span class="p">);</span>

	<span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_ctime</span> <span class="o">=</span> <span class="n">dip</span><span class="o">-&gt;</span><span class="n">i_ctime</span> <span class="o">=</span> <span class="n">dip</span><span class="o">-&gt;</span><span class="n">i_mtime</span> <span class="o">=</span> <span class="n">CURRENT_TIME</span><span class="p">;</span>
	<span class="n">mark_inode_dirty</span><span class="p">(</span><span class="n">dip</span><span class="p">);</span>

	<span class="cm">/* update target&#39;s inode */</span>
	<span class="n">inode_dec_link_count</span><span class="p">(</span><span class="n">ip</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 *	commit zero link count object</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_nlink</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">assert</span><span class="p">(</span><span class="o">!</span><span class="n">test_cflag</span><span class="p">(</span><span class="n">COMMIT_Nolink</span><span class="p">,</span> <span class="n">ip</span><span class="p">));</span>
		<span class="cm">/* free block resources */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">new_size</span> <span class="o">=</span> <span class="n">commitZeroLink</span><span class="p">(</span><span class="n">tid</span><span class="p">,</span> <span class="n">ip</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">txAbort</span><span class="p">(</span><span class="n">tid</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>	<span class="cm">/* Marks FS Dirty */</span>
			<span class="n">txEnd</span><span class="p">(</span><span class="n">tid</span><span class="p">);</span>
			<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">JFS_IP</span><span class="p">(</span><span class="n">ip</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">commit_mutex</span><span class="p">);</span>
			<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">JFS_IP</span><span class="p">(</span><span class="n">dip</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">commit_mutex</span><span class="p">);</span>
			<span class="n">IWRITE_UNLOCK</span><span class="p">(</span><span class="n">ip</span><span class="p">);</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="n">new_size</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">tblk</span> <span class="o">=</span> <span class="n">tid_to_tblock</span><span class="p">(</span><span class="n">tid</span><span class="p">);</span>
		<span class="n">tblk</span><span class="o">-&gt;</span><span class="n">xflag</span> <span class="o">|=</span> <span class="n">COMMIT_DELETE</span><span class="p">;</span>
		<span class="n">tblk</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">ip</span> <span class="o">=</span> <span class="n">ip</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Incomplete truncate of file data can</span>
<span class="cm">	 * result in timing problems unless we synchronously commit the</span>
<span class="cm">	 * transaction.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">new_size</span><span class="p">)</span>
		<span class="n">commit_flag</span> <span class="o">=</span> <span class="n">COMMIT_SYNC</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">commit_flag</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * If xtTruncate was incomplete, commit synchronously to avoid</span>
<span class="cm">	 * timing complications</span>
<span class="cm">	 */</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">txCommit</span><span class="p">(</span><span class="n">tid</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">iplist</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">commit_flag</span><span class="p">);</span>

	<span class="n">txEnd</span><span class="p">(</span><span class="n">tid</span><span class="p">);</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">JFS_IP</span><span class="p">(</span><span class="n">ip</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">commit_mutex</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">JFS_IP</span><span class="p">(</span><span class="n">dip</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">commit_mutex</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">new_size</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">tid</span> <span class="o">=</span> <span class="n">txBegin</span><span class="p">(</span><span class="n">dip</span><span class="o">-&gt;</span><span class="n">i_sb</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">JFS_IP</span><span class="p">(</span><span class="n">ip</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">commit_mutex</span><span class="p">);</span>
		<span class="n">new_size</span> <span class="o">=</span> <span class="n">xtTruncate_pmap</span><span class="p">(</span><span class="n">tid</span><span class="p">,</span> <span class="n">ip</span><span class="p">,</span> <span class="n">new_size</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">new_size</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">txAbort</span><span class="p">(</span><span class="n">tid</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>	<span class="cm">/* Marks FS Dirty */</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="n">new_size</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="n">txCommit</span><span class="p">(</span><span class="n">tid</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">iplist</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">COMMIT_SYNC</span><span class="p">);</span>
		<span class="n">txEnd</span><span class="p">(</span><span class="n">tid</span><span class="p">);</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">JFS_IP</span><span class="p">(</span><span class="n">ip</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">commit_mutex</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_nlink</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">set_cflag</span><span class="p">(</span><span class="n">COMMIT_Nolink</span><span class="p">,</span> <span class="n">ip</span><span class="p">);</span>

	<span class="n">IWRITE_UNLOCK</span><span class="p">(</span><span class="n">ip</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Truncating the directory index table is not guaranteed.  It</span>
<span class="cm">	 * may need to be done iteratively</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_cflag</span><span class="p">(</span><span class="n">COMMIT_Stale</span><span class="p">,</span> <span class="n">dip</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dip</span><span class="o">-&gt;</span><span class="n">i_size</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
			<span class="n">jfs_truncate_nolock</span><span class="p">(</span><span class="n">dip</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

		<span class="n">clear_cflag</span><span class="p">(</span><span class="n">COMMIT_Stale</span><span class="p">,</span> <span class="n">dip</span><span class="p">);</span>
	<span class="p">}</span>

      <span class="nl">out1:</span>
	<span class="n">free_UCSname</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dname</span><span class="p">);</span>
      <span class="nl">out:</span>
	<span class="n">jfs_info</span><span class="p">(</span><span class="s">&quot;jfs_unlink: rc:%d&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * NAME:	commitZeroLink()</span>
<span class="cm"> *</span>
<span class="cm"> * FUNCTION:	for non-directory, called by jfs_remove(),</span>
<span class="cm"> *		truncate a regular file, directory or symbolic</span>
<span class="cm"> *		link to zero length. return 0 if type is not</span>
<span class="cm"> *		one of these.</span>
<span class="cm"> *</span>
<span class="cm"> *		if the file is currently associated with a VM segment</span>
<span class="cm"> *		only permanent disk and inode map resources are freed,</span>
<span class="cm"> *		and neither the inode nor indirect blocks are modified</span>
<span class="cm"> *		so that the resources can be later freed in the work</span>
<span class="cm"> *		map by ctrunc1.</span>
<span class="cm"> *		if there is no VM segment on entry, the resources are</span>
<span class="cm"> *		freed in both work and permanent map.</span>
<span class="cm"> *		(? for temporary file - memory object is cached even</span>
<span class="cm"> *		after no reference:</span>
<span class="cm"> *		reference count &gt; 0 -   )</span>
<span class="cm"> *</span>
<span class="cm"> * PARAMETERS:	cd	- pointer to commit data structure.</span>
<span class="cm"> *			  current inode is the one to truncate.</span>
<span class="cm"> *</span>
<span class="cm"> * RETURN:	Errors from subroutines</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">s64</span> <span class="nf">commitZeroLink</span><span class="p">(</span><span class="n">tid_t</span> <span class="n">tid</span><span class="p">,</span> <span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">ip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">filetype</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tblock</span> <span class="o">*</span><span class="n">tblk</span><span class="p">;</span>

	<span class="n">jfs_info</span><span class="p">(</span><span class="s">&quot;commitZeroLink: tid = %d, ip = 0x%p&quot;</span><span class="p">,</span> <span class="n">tid</span><span class="p">,</span> <span class="n">ip</span><span class="p">);</span>

	<span class="n">filetype</span> <span class="o">=</span> <span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_mode</span> <span class="o">&amp;</span> <span class="n">S_IFMT</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">filetype</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">S_IFREG</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">S_IFLNK</span>:
		<span class="cm">/* fast symbolic link */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_size</span> <span class="o">&lt;</span> <span class="n">IDATASIZE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">assert</span><span class="p">(</span><span class="n">filetype</span> <span class="o">!=</span> <span class="n">S_IFDIR</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">set_cflag</span><span class="p">(</span><span class="n">COMMIT_Freewmap</span><span class="p">,</span> <span class="n">ip</span><span class="p">);</span>

	<span class="cm">/* mark transaction of block map update type */</span>
	<span class="n">tblk</span> <span class="o">=</span> <span class="n">tid_to_tblock</span><span class="p">(</span><span class="n">tid</span><span class="p">);</span>
	<span class="n">tblk</span><span class="o">-&gt;</span><span class="n">xflag</span> <span class="o">|=</span> <span class="n">COMMIT_PMAP</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * free EA</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">JFS_IP</span><span class="p">(</span><span class="n">ip</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">ea</span><span class="p">.</span><span class="n">flag</span> <span class="o">&amp;</span> <span class="n">DXD_EXTENT</span><span class="p">)</span>
		<span class="cm">/* acquire maplock on EA to be freed from block map */</span>
		<span class="n">txEA</span><span class="p">(</span><span class="n">tid</span><span class="p">,</span> <span class="n">ip</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">JFS_IP</span><span class="p">(</span><span class="n">ip</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">ea</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * free ACL</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">JFS_IP</span><span class="p">(</span><span class="n">ip</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">acl</span><span class="p">.</span><span class="n">flag</span> <span class="o">&amp;</span> <span class="n">DXD_EXTENT</span><span class="p">)</span>
		<span class="cm">/* acquire maplock on EA to be freed from block map */</span>
		<span class="n">txEA</span><span class="p">(</span><span class="n">tid</span><span class="p">,</span> <span class="n">ip</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">JFS_IP</span><span class="p">(</span><span class="n">ip</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">acl</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * free xtree/data (truncate to zero length):</span>
<span class="cm">	 * free xtree/data pages from cache if COMMIT_PWMAP,</span>
<span class="cm">	 * free xtree/data blocks from persistent block map, and</span>
<span class="cm">	 * free xtree/data blocks from working block map if COMMIT_PWMAP;</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_size</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">xtTruncate_pmap</span><span class="p">(</span><span class="n">tid</span><span class="p">,</span> <span class="n">ip</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * NAME:	jfs_free_zero_link()</span>
<span class="cm"> *</span>
<span class="cm"> * FUNCTION:	for non-directory, called by iClose(),</span>
<span class="cm"> *		free resources of a file from cache and WORKING map</span>
<span class="cm"> *		for a file previously committed with zero link count</span>
<span class="cm"> *		while associated with a pager object,</span>
<span class="cm"> *</span>
<span class="cm"> * PARAMETER:	ip	- pointer to inode of file.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">jfs_free_zero_link</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">ip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">type</span><span class="p">;</span>

	<span class="n">jfs_info</span><span class="p">(</span><span class="s">&quot;jfs_free_zero_link: ip = 0x%p&quot;</span><span class="p">,</span> <span class="n">ip</span><span class="p">);</span>

	<span class="cm">/* return if not reg or symbolic link or if size is</span>
<span class="cm">	 * already ok.</span>
<span class="cm">	 */</span>
	<span class="n">type</span> <span class="o">=</span> <span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_mode</span> <span class="o">&amp;</span> <span class="n">S_IFMT</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">S_IFREG</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">S_IFLNK</span>:
		<span class="cm">/* if its contained in inode nothing to do */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_size</span> <span class="o">&lt;</span> <span class="n">IDATASIZE</span><span class="p">)</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * free EA</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">JFS_IP</span><span class="p">(</span><span class="n">ip</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">ea</span><span class="p">.</span><span class="n">flag</span> <span class="o">&amp;</span> <span class="n">DXD_EXTENT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">s64</span> <span class="n">xaddr</span> <span class="o">=</span> <span class="n">addressDXD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">JFS_IP</span><span class="p">(</span><span class="n">ip</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">ea</span><span class="p">);</span>
		<span class="kt">int</span> <span class="n">xlen</span> <span class="o">=</span> <span class="n">lengthDXD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">JFS_IP</span><span class="p">(</span><span class="n">ip</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">ea</span><span class="p">);</span>
		<span class="k">struct</span> <span class="n">maplock</span> <span class="n">maplock</span><span class="p">;</span>	<span class="cm">/* maplock for COMMIT_WMAP */</span>
		<span class="k">struct</span> <span class="n">pxd_lock</span> <span class="o">*</span><span class="n">pxdlock</span><span class="p">;</span>	<span class="cm">/* maplock for COMMIT_WMAP */</span>

		<span class="cm">/* free EA pages from cache */</span>
		<span class="n">invalidate_dxd_metapages</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">JFS_IP</span><span class="p">(</span><span class="n">ip</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">ea</span><span class="p">);</span>

		<span class="cm">/* free EA extent from working block map */</span>
		<span class="n">maplock</span><span class="p">.</span><span class="n">index</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">pxdlock</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">pxd_lock</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">maplock</span><span class="p">;</span>
		<span class="n">pxdlock</span><span class="o">-&gt;</span><span class="n">flag</span> <span class="o">=</span> <span class="n">mlckFREEPXD</span><span class="p">;</span>
		<span class="n">PXDaddress</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pxdlock</span><span class="o">-&gt;</span><span class="n">pxd</span><span class="p">,</span> <span class="n">xaddr</span><span class="p">);</span>
		<span class="n">PXDlength</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pxdlock</span><span class="o">-&gt;</span><span class="n">pxd</span><span class="p">,</span> <span class="n">xlen</span><span class="p">);</span>
		<span class="n">txFreeMap</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">pxdlock</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">COMMIT_WMAP</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * free ACL</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">JFS_IP</span><span class="p">(</span><span class="n">ip</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">acl</span><span class="p">.</span><span class="n">flag</span> <span class="o">&amp;</span> <span class="n">DXD_EXTENT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">s64</span> <span class="n">xaddr</span> <span class="o">=</span> <span class="n">addressDXD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">JFS_IP</span><span class="p">(</span><span class="n">ip</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">acl</span><span class="p">);</span>
		<span class="kt">int</span> <span class="n">xlen</span> <span class="o">=</span> <span class="n">lengthDXD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">JFS_IP</span><span class="p">(</span><span class="n">ip</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">acl</span><span class="p">);</span>
		<span class="k">struct</span> <span class="n">maplock</span> <span class="n">maplock</span><span class="p">;</span>	<span class="cm">/* maplock for COMMIT_WMAP */</span>
		<span class="k">struct</span> <span class="n">pxd_lock</span> <span class="o">*</span><span class="n">pxdlock</span><span class="p">;</span>	<span class="cm">/* maplock for COMMIT_WMAP */</span>

		<span class="n">invalidate_dxd_metapages</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">JFS_IP</span><span class="p">(</span><span class="n">ip</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">acl</span><span class="p">);</span>

		<span class="cm">/* free ACL extent from working block map */</span>
		<span class="n">maplock</span><span class="p">.</span><span class="n">index</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">pxdlock</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">pxd_lock</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">maplock</span><span class="p">;</span>
		<span class="n">pxdlock</span><span class="o">-&gt;</span><span class="n">flag</span> <span class="o">=</span> <span class="n">mlckFREEPXD</span><span class="p">;</span>
		<span class="n">PXDaddress</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pxdlock</span><span class="o">-&gt;</span><span class="n">pxd</span><span class="p">,</span> <span class="n">xaddr</span><span class="p">);</span>
		<span class="n">PXDlength</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pxdlock</span><span class="o">-&gt;</span><span class="n">pxd</span><span class="p">,</span> <span class="n">xlen</span><span class="p">);</span>
		<span class="n">txFreeMap</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">pxdlock</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">COMMIT_WMAP</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * free xtree/data (truncate to zero length):</span>
<span class="cm">	 * free xtree/data pages from cache, and</span>
<span class="cm">	 * free xtree/data blocks from working block map;</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_size</span><span class="p">)</span>
		<span class="n">xtTruncate</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">ip</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">COMMIT_WMAP</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * NAME:	jfs_link(vp, dvp, name, crp)</span>
<span class="cm"> *</span>
<span class="cm"> * FUNCTION:	create a link to &lt;vp&gt; by the name = &lt;name&gt;</span>
<span class="cm"> *		in the parent directory &lt;dvp&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * PARAMETER:	vp	- target object</span>
<span class="cm"> *		dvp	- parent directory of new link</span>
<span class="cm"> *		name	- name of new link to target object</span>
<span class="cm"> *		crp	- credential</span>
<span class="cm"> *</span>
<span class="cm"> * RETURN:	Errors from subroutines</span>
<span class="cm"> *</span>
<span class="cm"> * note:</span>
<span class="cm"> * JFS does NOT support link() on directories (to prevent circular</span>
<span class="cm"> * path in the directory hierarchy);</span>
<span class="cm"> * EPERM: the target object is a directory, and either the caller</span>
<span class="cm"> * does not have appropriate privileges or the implementation prohibits</span>
<span class="cm"> * using link() on directories [XPG4.2].</span>
<span class="cm"> *</span>
<span class="cm"> * JFS does NOT support links between file systems:</span>
<span class="cm"> * EXDEV: target object and new link are on different file systems and</span>
<span class="cm"> * implementation does not support links between file systems [XPG4.2].</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">jfs_link</span><span class="p">(</span><span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="n">old_dentry</span><span class="p">,</span>
	     <span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">dir</span><span class="p">,</span> <span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="n">dentry</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>
	<span class="n">tid_t</span> <span class="n">tid</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">ip</span> <span class="o">=</span> <span class="n">old_dentry</span><span class="o">-&gt;</span><span class="n">d_inode</span><span class="p">;</span>
	<span class="n">ino_t</span> <span class="n">ino</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">component_name</span> <span class="n">dname</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">btstack</span> <span class="n">btstack</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">iplist</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>

	<span class="n">jfs_info</span><span class="p">(</span><span class="s">&quot;jfs_link: %s %s&quot;</span><span class="p">,</span> <span class="n">old_dentry</span><span class="o">-&gt;</span><span class="n">d_name</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
		 <span class="n">dentry</span><span class="o">-&gt;</span><span class="n">d_name</span><span class="p">.</span><span class="n">name</span><span class="p">);</span>

	<span class="n">dquot_initialize</span><span class="p">(</span><span class="n">dir</span><span class="p">);</span>

	<span class="n">tid</span> <span class="o">=</span> <span class="n">txBegin</span><span class="p">(</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_sb</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">mutex_lock_nested</span><span class="p">(</span><span class="o">&amp;</span><span class="n">JFS_IP</span><span class="p">(</span><span class="n">dir</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">commit_mutex</span><span class="p">,</span> <span class="n">COMMIT_MUTEX_PARENT</span><span class="p">);</span>
	<span class="n">mutex_lock_nested</span><span class="p">(</span><span class="o">&amp;</span><span class="n">JFS_IP</span><span class="p">(</span><span class="n">ip</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">commit_mutex</span><span class="p">,</span> <span class="n">COMMIT_MUTEX_CHILD</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * scan parent directory for entry/freespace</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">rc</span> <span class="o">=</span> <span class="n">get_UCSname</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dname</span><span class="p">,</span> <span class="n">dentry</span><span class="p">)))</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">rc</span> <span class="o">=</span> <span class="n">dtSearch</span><span class="p">(</span><span class="n">dir</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dname</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ino</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">btstack</span><span class="p">,</span> <span class="n">JFS_CREATE</span><span class="p">)))</span>
		<span class="k">goto</span> <span class="n">free_dname</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * create entry for new link in parent directory</span>
<span class="cm">	 */</span>
	<span class="n">ino</span> <span class="o">=</span> <span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_ino</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">rc</span> <span class="o">=</span> <span class="n">dtInsert</span><span class="p">(</span><span class="n">tid</span><span class="p">,</span> <span class="n">dir</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dname</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ino</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">btstack</span><span class="p">)))</span>
		<span class="k">goto</span> <span class="n">free_dname</span><span class="p">;</span>

	<span class="cm">/* update object inode */</span>
	<span class="n">inc_nlink</span><span class="p">(</span><span class="n">ip</span><span class="p">);</span>		<span class="cm">/* for new link */</span>
	<span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_ctime</span> <span class="o">=</span> <span class="n">CURRENT_TIME</span><span class="p">;</span>
	<span class="n">dir</span><span class="o">-&gt;</span><span class="n">i_ctime</span> <span class="o">=</span> <span class="n">dir</span><span class="o">-&gt;</span><span class="n">i_mtime</span> <span class="o">=</span> <span class="n">CURRENT_TIME</span><span class="p">;</span>
	<span class="n">mark_inode_dirty</span><span class="p">(</span><span class="n">dir</span><span class="p">);</span>
	<span class="n">ihold</span><span class="p">(</span><span class="n">ip</span><span class="p">);</span>

	<span class="n">iplist</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">ip</span><span class="p">;</span>
	<span class="n">iplist</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">dir</span><span class="p">;</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">txCommit</span><span class="p">(</span><span class="n">tid</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">iplist</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">drop_nlink</span><span class="p">(</span><span class="n">ip</span><span class="p">);</span> <span class="cm">/* never instantiated */</span>
		<span class="n">iput</span><span class="p">(</span><span class="n">ip</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">d_instantiate</span><span class="p">(</span><span class="n">dentry</span><span class="p">,</span> <span class="n">ip</span><span class="p">);</span>

      <span class="nl">free_dname:</span>
	<span class="n">free_UCSname</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dname</span><span class="p">);</span>

      <span class="nl">out:</span>
	<span class="n">txEnd</span><span class="p">(</span><span class="n">tid</span><span class="p">);</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">JFS_IP</span><span class="p">(</span><span class="n">ip</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">commit_mutex</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">JFS_IP</span><span class="p">(</span><span class="n">dir</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">commit_mutex</span><span class="p">);</span>

	<span class="n">jfs_info</span><span class="p">(</span><span class="s">&quot;jfs_link: rc:%d&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * NAME:	jfs_symlink(dip, dentry, name)</span>
<span class="cm"> *</span>
<span class="cm"> * FUNCTION:	creates a symbolic link to &lt;symlink&gt; by name &lt;name&gt;</span>
<span class="cm"> *			in directory &lt;dip&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * PARAMETER:	dip	- parent directory vnode</span>
<span class="cm"> *		dentry	- dentry of symbolic link</span>
<span class="cm"> *		name	- the path name of the existing object</span>
<span class="cm"> *			  that will be the source of the link</span>
<span class="cm"> *</span>
<span class="cm"> * RETURN:	errors from subroutines</span>
<span class="cm"> *</span>
<span class="cm"> * note:</span>
<span class="cm"> * ENAMETOOLONG: pathname resolution of a symbolic link produced</span>
<span class="cm"> * an intermediate result whose length exceeds PATH_MAX [XPG4.2]</span>
<span class="cm">*/</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">jfs_symlink</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">dip</span><span class="p">,</span> <span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="n">dentry</span><span class="p">,</span>
		<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>
	<span class="n">tid_t</span> <span class="n">tid</span><span class="p">;</span>
	<span class="n">ino_t</span> <span class="n">ino</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">component_name</span> <span class="n">dname</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ssize</span><span class="p">;</span>		<span class="cm">/* source pathname size */</span>
	<span class="k">struct</span> <span class="n">btstack</span> <span class="n">btstack</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">ip</span> <span class="o">=</span> <span class="n">dentry</span><span class="o">-&gt;</span><span class="n">d_inode</span><span class="p">;</span>
	<span class="n">unchar</span> <span class="o">*</span><span class="n">i_fastsymlink</span><span class="p">;</span>
	<span class="n">s64</span> <span class="n">xlen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">bmask</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">xsize</span><span class="p">;</span>
	<span class="n">s64</span> <span class="n">xaddr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">metapage</span> <span class="o">*</span><span class="n">mp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">sb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tblock</span> <span class="o">*</span><span class="n">tblk</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">iplist</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>

	<span class="n">jfs_info</span><span class="p">(</span><span class="s">&quot;jfs_symlink: dip:0x%p name:%s&quot;</span><span class="p">,</span> <span class="n">dip</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>

	<span class="n">dquot_initialize</span><span class="p">(</span><span class="n">dip</span><span class="p">);</span>

	<span class="n">ssize</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">name</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * search parent directory for entry/freespace</span>
<span class="cm">	 * (dtSearch() returns parent directory page pinned)</span>
<span class="cm">	 */</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">rc</span> <span class="o">=</span> <span class="n">get_UCSname</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dname</span><span class="p">,</span> <span class="n">dentry</span><span class="p">)))</span>
		<span class="k">goto</span> <span class="n">out1</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * allocate on-disk/in-memory inode for symbolic link:</span>
<span class="cm">	 * (iAlloc() returns new, locked inode)</span>
<span class="cm">	 */</span>
	<span class="n">ip</span> <span class="o">=</span> <span class="n">ialloc</span><span class="p">(</span><span class="n">dip</span><span class="p">,</span> <span class="n">S_IFLNK</span> <span class="o">|</span> <span class="mo">0777</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">ip</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">ip</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out2</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">tid</span> <span class="o">=</span> <span class="n">txBegin</span><span class="p">(</span><span class="n">dip</span><span class="o">-&gt;</span><span class="n">i_sb</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">mutex_lock_nested</span><span class="p">(</span><span class="o">&amp;</span><span class="n">JFS_IP</span><span class="p">(</span><span class="n">dip</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">commit_mutex</span><span class="p">,</span> <span class="n">COMMIT_MUTEX_PARENT</span><span class="p">);</span>
	<span class="n">mutex_lock_nested</span><span class="p">(</span><span class="o">&amp;</span><span class="n">JFS_IP</span><span class="p">(</span><span class="n">ip</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">commit_mutex</span><span class="p">,</span> <span class="n">COMMIT_MUTEX_CHILD</span><span class="p">);</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">jfs_init_security</span><span class="p">(</span><span class="n">tid</span><span class="p">,</span> <span class="n">ip</span><span class="p">,</span> <span class="n">dip</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dentry</span><span class="o">-&gt;</span><span class="n">d_name</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out3</span><span class="p">;</span>

	<span class="n">tblk</span> <span class="o">=</span> <span class="n">tid_to_tblock</span><span class="p">(</span><span class="n">tid</span><span class="p">);</span>
	<span class="n">tblk</span><span class="o">-&gt;</span><span class="n">xflag</span> <span class="o">|=</span> <span class="n">COMMIT_CREATE</span><span class="p">;</span>
	<span class="n">tblk</span><span class="o">-&gt;</span><span class="n">ino</span> <span class="o">=</span> <span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_ino</span><span class="p">;</span>
	<span class="n">tblk</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">ixpxd</span> <span class="o">=</span> <span class="n">JFS_IP</span><span class="p">(</span><span class="n">ip</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">ixpxd</span><span class="p">;</span>

	<span class="cm">/* fix symlink access permission</span>
<span class="cm">	 * (dir_create() ANDs in the u.u_cmask,</span>
<span class="cm">	 * but symlinks really need to be 777 access)</span>
<span class="cm">	 */</span>
	<span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_mode</span> <span class="o">|=</span> <span class="mo">0777</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * write symbolic link target path name</span>
<span class="cm">	 */</span>
	<span class="n">xtInitRoot</span><span class="p">(</span><span class="n">tid</span><span class="p">,</span> <span class="n">ip</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * write source path name inline in on-disk inode (fast symbolic link)</span>
<span class="cm">	 */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ssize</span> <span class="o">&lt;=</span> <span class="n">IDATASIZE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_op</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">jfs_fast_symlink_inode_operations</span><span class="p">;</span>

		<span class="n">i_fastsymlink</span> <span class="o">=</span> <span class="n">JFS_IP</span><span class="p">(</span><span class="n">ip</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">i_inline</span><span class="p">;</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">i_fastsymlink</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">ssize</span><span class="p">);</span>
		<span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_size</span> <span class="o">=</span> <span class="n">ssize</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * if symlink is &gt; 128 bytes, we don&#39;t have the space to</span>
<span class="cm">		 * store inline extended attributes</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ssize</span> <span class="o">&gt;</span> <span class="k">sizeof</span> <span class="p">(</span><span class="n">JFS_IP</span><span class="p">(</span><span class="n">ip</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">i_inline</span><span class="p">))</span>
			<span class="n">JFS_IP</span><span class="p">(</span><span class="n">ip</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">mode2</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">INLINEEA</span><span class="p">;</span>

		<span class="n">jfs_info</span><span class="p">(</span><span class="s">&quot;jfs_symlink: fast symlink added  ssize:%d name:%s &quot;</span><span class="p">,</span>
			 <span class="n">ssize</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="cm">/*</span>
<span class="cm">	 * write source path name in a single extent</span>
<span class="cm">	 */</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">jfs_info</span><span class="p">(</span><span class="s">&quot;jfs_symlink: allocate extent ip:0x%p&quot;</span><span class="p">,</span> <span class="n">ip</span><span class="p">);</span>

		<span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_op</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">jfs_symlink_inode_operations</span><span class="p">;</span>
		<span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_mapping</span><span class="o">-&gt;</span><span class="n">a_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">jfs_aops</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * even though the data of symlink object (source</span>
<span class="cm">		 * path name) is treated as non-journaled user data,</span>
<span class="cm">		 * it is read/written thru buffer cache for performance.</span>
<span class="cm">		 */</span>
		<span class="n">sb</span> <span class="o">=</span> <span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_sb</span><span class="p">;</span>
		<span class="n">bmask</span> <span class="o">=</span> <span class="n">JFS_SBI</span><span class="p">(</span><span class="n">sb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">bsize</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">xsize</span> <span class="o">=</span> <span class="p">(</span><span class="n">ssize</span> <span class="o">+</span> <span class="n">bmask</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">bmask</span><span class="p">;</span>
		<span class="n">xaddr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">xlen</span> <span class="o">=</span> <span class="n">xsize</span> <span class="o">&gt;&gt;</span> <span class="n">JFS_SBI</span><span class="p">(</span><span class="n">sb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">l2bsize</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">rc</span> <span class="o">=</span> <span class="n">xtInsert</span><span class="p">(</span><span class="n">tid</span><span class="p">,</span> <span class="n">ip</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">xlen</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">xaddr</span><span class="p">,</span> <span class="mi">0</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">txAbort</span><span class="p">(</span><span class="n">tid</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">out3</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_size</span> <span class="o">=</span> <span class="n">ssize</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">ssize</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* This is kind of silly since PATH_MAX == 4K */</span>
			<span class="kt">int</span> <span class="n">copy_size</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">ssize</span><span class="p">,</span> <span class="n">PSIZE</span><span class="p">);</span>

			<span class="n">mp</span> <span class="o">=</span> <span class="n">get_metapage</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">xaddr</span><span class="p">,</span> <span class="n">PSIZE</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">mp</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">xtTruncate</span><span class="p">(</span><span class="n">tid</span><span class="p">,</span> <span class="n">ip</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">COMMIT_PWMAP</span><span class="p">);</span>
				<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
				<span class="n">txAbort</span><span class="p">(</span><span class="n">tid</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">out3</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">copy_size</span><span class="p">);</span>
			<span class="n">flush_metapage</span><span class="p">(</span><span class="n">mp</span><span class="p">);</span>
			<span class="n">ssize</span> <span class="o">-=</span> <span class="n">copy_size</span><span class="p">;</span>
			<span class="n">name</span> <span class="o">+=</span> <span class="n">copy_size</span><span class="p">;</span>
			<span class="n">xaddr</span> <span class="o">+=</span> <span class="n">JFS_SBI</span><span class="p">(</span><span class="n">sb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">nbperpage</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * create entry for symbolic link in parent directory</span>
<span class="cm">	 */</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">dtSearch</span><span class="p">(</span><span class="n">dip</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dname</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ino</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">btstack</span><span class="p">,</span> <span class="n">JFS_CREATE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ino</span> <span class="o">=</span> <span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_ino</span><span class="p">;</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">dtInsert</span><span class="p">(</span><span class="n">tid</span><span class="p">,</span> <span class="n">dip</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dname</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ino</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">btstack</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">xlen</span><span class="p">)</span>
			<span class="n">xtTruncate</span><span class="p">(</span><span class="n">tid</span><span class="p">,</span> <span class="n">ip</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">COMMIT_PWMAP</span><span class="p">);</span>
		<span class="n">txAbort</span><span class="p">(</span><span class="n">tid</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="cm">/* discard new inode */</span>
		<span class="k">goto</span> <span class="n">out3</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mark_inode_dirty</span><span class="p">(</span><span class="n">ip</span><span class="p">);</span>

	<span class="n">dip</span><span class="o">-&gt;</span><span class="n">i_ctime</span> <span class="o">=</span> <span class="n">dip</span><span class="o">-&gt;</span><span class="n">i_mtime</span> <span class="o">=</span> <span class="n">CURRENT_TIME</span><span class="p">;</span>
	<span class="n">mark_inode_dirty</span><span class="p">(</span><span class="n">dip</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 * commit update of parent directory and link object</span>
<span class="cm">	 */</span>

	<span class="n">iplist</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">dip</span><span class="p">;</span>
	<span class="n">iplist</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">ip</span><span class="p">;</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">txCommit</span><span class="p">(</span><span class="n">tid</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">iplist</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">);</span>

      <span class="nl">out3:</span>
	<span class="n">txEnd</span><span class="p">(</span><span class="n">tid</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">JFS_IP</span><span class="p">(</span><span class="n">ip</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">commit_mutex</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">JFS_IP</span><span class="p">(</span><span class="n">dip</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">commit_mutex</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">free_ea_wmap</span><span class="p">(</span><span class="n">ip</span><span class="p">);</span>
		<span class="n">clear_nlink</span><span class="p">(</span><span class="n">ip</span><span class="p">);</span>
		<span class="n">unlock_new_inode</span><span class="p">(</span><span class="n">ip</span><span class="p">);</span>
		<span class="n">iput</span><span class="p">(</span><span class="n">ip</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">d_instantiate</span><span class="p">(</span><span class="n">dentry</span><span class="p">,</span> <span class="n">ip</span><span class="p">);</span>
		<span class="n">unlock_new_inode</span><span class="p">(</span><span class="n">ip</span><span class="p">);</span>
	<span class="p">}</span>

      <span class="nl">out2:</span>
	<span class="n">free_UCSname</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dname</span><span class="p">);</span>

      <span class="nl">out1:</span>
	<span class="n">jfs_info</span><span class="p">(</span><span class="s">&quot;jfs_symlink: rc:%d&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * NAME:	jfs_rename</span>
<span class="cm"> *</span>
<span class="cm"> * FUNCTION:	rename a file or directory</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">jfs_rename</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">old_dir</span><span class="p">,</span> <span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="n">old_dentry</span><span class="p">,</span>
	       <span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">new_dir</span><span class="p">,</span> <span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="n">new_dentry</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">btstack</span> <span class="n">btstack</span><span class="p">;</span>
	<span class="n">ino_t</span> <span class="n">ino</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">component_name</span> <span class="n">new_dname</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">new_ip</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">component_name</span> <span class="n">old_dname</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">old_ip</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>
	<span class="n">tid_t</span> <span class="n">tid</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tlock</span> <span class="o">*</span><span class="n">tlck</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dt_lock</span> <span class="o">*</span><span class="n">dtlck</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lv</span> <span class="o">*</span><span class="n">lv</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ipcount</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">iplist</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">tblock</span> <span class="o">*</span><span class="n">tblk</span><span class="p">;</span>
	<span class="n">s64</span> <span class="n">new_size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">commit_flag</span><span class="p">;</span>


	<span class="n">jfs_info</span><span class="p">(</span><span class="s">&quot;jfs_rename: %s %s&quot;</span><span class="p">,</span> <span class="n">old_dentry</span><span class="o">-&gt;</span><span class="n">d_name</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
		 <span class="n">new_dentry</span><span class="o">-&gt;</span><span class="n">d_name</span><span class="p">.</span><span class="n">name</span><span class="p">);</span>

	<span class="n">dquot_initialize</span><span class="p">(</span><span class="n">old_dir</span><span class="p">);</span>
	<span class="n">dquot_initialize</span><span class="p">(</span><span class="n">new_dir</span><span class="p">);</span>

	<span class="n">old_ip</span> <span class="o">=</span> <span class="n">old_dentry</span><span class="o">-&gt;</span><span class="n">d_inode</span><span class="p">;</span>
	<span class="n">new_ip</span> <span class="o">=</span> <span class="n">new_dentry</span><span class="o">-&gt;</span><span class="n">d_inode</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">rc</span> <span class="o">=</span> <span class="n">get_UCSname</span><span class="p">(</span><span class="o">&amp;</span><span class="n">old_dname</span><span class="p">,</span> <span class="n">old_dentry</span><span class="p">)))</span>
		<span class="k">goto</span> <span class="n">out1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">rc</span> <span class="o">=</span> <span class="n">get_UCSname</span><span class="p">(</span><span class="o">&amp;</span><span class="n">new_dname</span><span class="p">,</span> <span class="n">new_dentry</span><span class="p">)))</span>
		<span class="k">goto</span> <span class="n">out2</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Make sure source inode number is what we think it is</span>
<span class="cm">	 */</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">dtSearch</span><span class="p">(</span><span class="n">old_dir</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">old_dname</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ino</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">btstack</span><span class="p">,</span> <span class="n">JFS_LOOKUP</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">||</span> <span class="p">(</span><span class="n">ino</span> <span class="o">!=</span> <span class="n">old_ip</span><span class="o">-&gt;</span><span class="n">i_ino</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out3</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Make sure dest inode number (if any) is what we think it is</span>
<span class="cm">	 */</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">dtSearch</span><span class="p">(</span><span class="n">new_dir</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">new_dname</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ino</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">btstack</span><span class="p">,</span> <span class="n">JFS_LOOKUP</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="o">!</span><span class="n">new_ip</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">ino</span> <span class="o">!=</span> <span class="n">new_ip</span><span class="o">-&gt;</span><span class="n">i_ino</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ESTALE</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out3</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">!=</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out3</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">new_ip</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* no entry exists, but one was expected */</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ESTALE</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out3</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">S_ISDIR</span><span class="p">(</span><span class="n">old_ip</span><span class="o">-&gt;</span><span class="n">i_mode</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">new_ip</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dtEmpty</span><span class="p">(</span><span class="n">new_ip</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOTEMPTY</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">out3</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">new_ip</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">IWRITE_LOCK</span><span class="p">(</span><span class="n">new_ip</span><span class="p">,</span> <span class="n">RDWRLOCK_NORMAL</span><span class="p">);</span>
		<span class="cm">/* Init inode for quota operations. */</span>
		<span class="n">dquot_initialize</span><span class="p">(</span><span class="n">new_ip</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * The real work starts here</span>
<span class="cm">	 */</span>
	<span class="n">tid</span> <span class="o">=</span> <span class="n">txBegin</span><span class="p">(</span><span class="n">new_dir</span><span class="o">-&gt;</span><span class="n">i_sb</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * How do we know the locking is safe from deadlocks?</span>
<span class="cm">	 * The vfs does the hard part for us.  Any time we are taking nested</span>
<span class="cm">	 * commit_mutexes, the vfs already has i_mutex held on the parent.</span>
<span class="cm">	 * Here, the vfs has already taken i_mutex on both old_dir and new_dir.</span>
<span class="cm">	 */</span>
	<span class="n">mutex_lock_nested</span><span class="p">(</span><span class="o">&amp;</span><span class="n">JFS_IP</span><span class="p">(</span><span class="n">new_dir</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">commit_mutex</span><span class="p">,</span> <span class="n">COMMIT_MUTEX_PARENT</span><span class="p">);</span>
	<span class="n">mutex_lock_nested</span><span class="p">(</span><span class="o">&amp;</span><span class="n">JFS_IP</span><span class="p">(</span><span class="n">old_ip</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">commit_mutex</span><span class="p">,</span> <span class="n">COMMIT_MUTEX_CHILD</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">old_dir</span> <span class="o">!=</span> <span class="n">new_dir</span><span class="p">)</span>
		<span class="n">mutex_lock_nested</span><span class="p">(</span><span class="o">&amp;</span><span class="n">JFS_IP</span><span class="p">(</span><span class="n">old_dir</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">commit_mutex</span><span class="p">,</span>
				  <span class="n">COMMIT_MUTEX_SECOND_PARENT</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">new_ip</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mutex_lock_nested</span><span class="p">(</span><span class="o">&amp;</span><span class="n">JFS_IP</span><span class="p">(</span><span class="n">new_ip</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">commit_mutex</span><span class="p">,</span>
				  <span class="n">COMMIT_MUTEX_VICTIM</span><span class="p">);</span>
		<span class="cm">/*</span>
<span class="cm">		 * Change existing directory entry to new inode number</span>
<span class="cm">		 */</span>
		<span class="n">ino</span> <span class="o">=</span> <span class="n">new_ip</span><span class="o">-&gt;</span><span class="n">i_ino</span><span class="p">;</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">dtModify</span><span class="p">(</span><span class="n">tid</span><span class="p">,</span> <span class="n">new_dir</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">new_dname</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ino</span><span class="p">,</span>
			      <span class="n">old_ip</span><span class="o">-&gt;</span><span class="n">i_ino</span><span class="p">,</span> <span class="n">JFS_RENAME</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out4</span><span class="p">;</span>
		<span class="n">drop_nlink</span><span class="p">(</span><span class="n">new_ip</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">S_ISDIR</span><span class="p">(</span><span class="n">new_ip</span><span class="o">-&gt;</span><span class="n">i_mode</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">drop_nlink</span><span class="p">(</span><span class="n">new_ip</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">new_ip</span><span class="o">-&gt;</span><span class="n">i_nlink</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">JFS_IP</span><span class="p">(</span><span class="n">new_ip</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">commit_mutex</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">old_dir</span> <span class="o">!=</span> <span class="n">new_dir</span><span class="p">)</span>
					<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">JFS_IP</span><span class="p">(</span><span class="n">old_dir</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">commit_mutex</span><span class="p">);</span>
				<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">JFS_IP</span><span class="p">(</span><span class="n">old_ip</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">commit_mutex</span><span class="p">);</span>
				<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">JFS_IP</span><span class="p">(</span><span class="n">new_dir</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">commit_mutex</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">S_ISDIR</span><span class="p">(</span><span class="n">old_ip</span><span class="o">-&gt;</span><span class="n">i_mode</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">new_ip</span><span class="p">)</span>
					<span class="n">IWRITE_UNLOCK</span><span class="p">(</span><span class="n">new_ip</span><span class="p">);</span>
				<span class="n">jfs_error</span><span class="p">(</span><span class="n">new_ip</span><span class="o">-&gt;</span><span class="n">i_sb</span><span class="p">,</span>
					  <span class="s">&quot;jfs_rename: new_ip-&gt;i_nlink != 0&quot;</span><span class="p">);</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">tblk</span> <span class="o">=</span> <span class="n">tid_to_tblock</span><span class="p">(</span><span class="n">tid</span><span class="p">);</span>
			<span class="n">tblk</span><span class="o">-&gt;</span><span class="n">xflag</span> <span class="o">|=</span> <span class="n">COMMIT_DELETE</span><span class="p">;</span>
			<span class="n">tblk</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">ip</span> <span class="o">=</span> <span class="n">new_ip</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">new_ip</span><span class="o">-&gt;</span><span class="n">i_nlink</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">assert</span><span class="p">(</span><span class="o">!</span><span class="n">test_cflag</span><span class="p">(</span><span class="n">COMMIT_Nolink</span><span class="p">,</span> <span class="n">new_ip</span><span class="p">));</span>
			<span class="cm">/* free block resources */</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">new_size</span> <span class="o">=</span> <span class="n">commitZeroLink</span><span class="p">(</span><span class="n">tid</span><span class="p">,</span> <span class="n">new_ip</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">txAbort</span><span class="p">(</span><span class="n">tid</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>	<span class="cm">/* Marks FS Dirty */</span>
				<span class="n">rc</span> <span class="o">=</span> <span class="n">new_size</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">out4</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">tblk</span> <span class="o">=</span> <span class="n">tid_to_tblock</span><span class="p">(</span><span class="n">tid</span><span class="p">);</span>
			<span class="n">tblk</span><span class="o">-&gt;</span><span class="n">xflag</span> <span class="o">|=</span> <span class="n">COMMIT_DELETE</span><span class="p">;</span>
			<span class="n">tblk</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">ip</span> <span class="o">=</span> <span class="n">new_ip</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">new_ip</span><span class="o">-&gt;</span><span class="n">i_ctime</span> <span class="o">=</span> <span class="n">CURRENT_TIME</span><span class="p">;</span>
			<span class="n">mark_inode_dirty</span><span class="p">(</span><span class="n">new_ip</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Add new directory entry</span>
<span class="cm">		 */</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">dtSearch</span><span class="p">(</span><span class="n">new_dir</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">new_dname</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ino</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">btstack</span><span class="p">,</span>
			      <span class="n">JFS_CREATE</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">jfs_err</span><span class="p">(</span><span class="s">&quot;jfs_rename didn&#39;t expect dtSearch to fail &quot;</span>
				<span class="s">&quot;w/rc = %d&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">out4</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">ino</span> <span class="o">=</span> <span class="n">old_ip</span><span class="o">-&gt;</span><span class="n">i_ino</span><span class="p">;</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">dtInsert</span><span class="p">(</span><span class="n">tid</span><span class="p">,</span> <span class="n">new_dir</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">new_dname</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ino</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">btstack</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="o">-</span><span class="n">EIO</span><span class="p">)</span>
				<span class="n">jfs_err</span><span class="p">(</span><span class="s">&quot;jfs_rename: dtInsert returned -EIO&quot;</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">out4</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">S_ISDIR</span><span class="p">(</span><span class="n">old_ip</span><span class="o">-&gt;</span><span class="n">i_mode</span><span class="p">))</span>
			<span class="n">inc_nlink</span><span class="p">(</span><span class="n">new_dir</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="cm">/*</span>
<span class="cm">	 * Remove old directory entry</span>
<span class="cm">	 */</span>

	<span class="n">ino</span> <span class="o">=</span> <span class="n">old_ip</span><span class="o">-&gt;</span><span class="n">i_ino</span><span class="p">;</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">dtDelete</span><span class="p">(</span><span class="n">tid</span><span class="p">,</span> <span class="n">old_dir</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">old_dname</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ino</span><span class="p">,</span> <span class="n">JFS_REMOVE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">jfs_err</span><span class="p">(</span><span class="s">&quot;jfs_rename did not expect dtDelete to return rc = %d&quot;</span><span class="p">,</span>
			<span class="n">rc</span><span class="p">);</span>
		<span class="n">txAbort</span><span class="p">(</span><span class="n">tid</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>	<span class="cm">/* Marks Filesystem dirty */</span>
		<span class="k">goto</span> <span class="n">out4</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">S_ISDIR</span><span class="p">(</span><span class="n">old_ip</span><span class="o">-&gt;</span><span class="n">i_mode</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">drop_nlink</span><span class="p">(</span><span class="n">old_dir</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">old_dir</span> <span class="o">!=</span> <span class="n">new_dir</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * Change inode number of parent for moved directory</span>
<span class="cm">			 */</span>

			<span class="n">JFS_IP</span><span class="p">(</span><span class="n">old_ip</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">i_dtroot</span><span class="p">.</span><span class="n">header</span><span class="p">.</span><span class="n">idotdot</span> <span class="o">=</span>
				<span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">new_dir</span><span class="o">-&gt;</span><span class="n">i_ino</span><span class="p">);</span>

			<span class="cm">/* Linelock header of dtree */</span>
			<span class="n">tlck</span> <span class="o">=</span> <span class="n">txLock</span><span class="p">(</span><span class="n">tid</span><span class="p">,</span> <span class="n">old_ip</span><span class="p">,</span>
				    <span class="p">(</span><span class="k">struct</span> <span class="n">metapage</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">JFS_IP</span><span class="p">(</span><span class="n">old_ip</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">bxflag</span><span class="p">,</span>
				      <span class="n">tlckDTREE</span> <span class="o">|</span> <span class="n">tlckBTROOT</span> <span class="o">|</span> <span class="n">tlckRELINK</span><span class="p">);</span>
			<span class="n">dtlck</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">dt_lock</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">tlck</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">;</span>
			<span class="n">ASSERT</span><span class="p">(</span><span class="n">dtlck</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">==</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">lv</span> <span class="o">=</span> <span class="o">&amp;</span> <span class="n">dtlck</span><span class="o">-&gt;</span><span class="n">lv</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
			<span class="n">lv</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">lv</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">dtlck</span><span class="o">-&gt;</span><span class="n">index</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Update ctime on changed/moved inodes &amp; mark dirty</span>
<span class="cm">	 */</span>
	<span class="n">old_ip</span><span class="o">-&gt;</span><span class="n">i_ctime</span> <span class="o">=</span> <span class="n">CURRENT_TIME</span><span class="p">;</span>
	<span class="n">mark_inode_dirty</span><span class="p">(</span><span class="n">old_ip</span><span class="p">);</span>

	<span class="n">new_dir</span><span class="o">-&gt;</span><span class="n">i_ctime</span> <span class="o">=</span> <span class="n">new_dir</span><span class="o">-&gt;</span><span class="n">i_mtime</span> <span class="o">=</span> <span class="n">current_fs_time</span><span class="p">(</span><span class="n">new_dir</span><span class="o">-&gt;</span><span class="n">i_sb</span><span class="p">);</span>
	<span class="n">mark_inode_dirty</span><span class="p">(</span><span class="n">new_dir</span><span class="p">);</span>

	<span class="cm">/* Build list of inodes modified by this transaction */</span>
	<span class="n">ipcount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">iplist</span><span class="p">[</span><span class="n">ipcount</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">old_ip</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">new_ip</span><span class="p">)</span>
		<span class="n">iplist</span><span class="p">[</span><span class="n">ipcount</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_ip</span><span class="p">;</span>
	<span class="n">iplist</span><span class="p">[</span><span class="n">ipcount</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">old_dir</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">old_dir</span> <span class="o">!=</span> <span class="n">new_dir</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">iplist</span><span class="p">[</span><span class="n">ipcount</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_dir</span><span class="p">;</span>
		<span class="n">old_dir</span><span class="o">-&gt;</span><span class="n">i_ctime</span> <span class="o">=</span> <span class="n">old_dir</span><span class="o">-&gt;</span><span class="n">i_mtime</span> <span class="o">=</span> <span class="n">CURRENT_TIME</span><span class="p">;</span>
		<span class="n">mark_inode_dirty</span><span class="p">(</span><span class="n">old_dir</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Incomplete truncate of file data can</span>
<span class="cm">	 * result in timing problems unless we synchronously commit the</span>
<span class="cm">	 * transaction.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">new_size</span><span class="p">)</span>
		<span class="n">commit_flag</span> <span class="o">=</span> <span class="n">COMMIT_SYNC</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">commit_flag</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">txCommit</span><span class="p">(</span><span class="n">tid</span><span class="p">,</span> <span class="n">ipcount</span><span class="p">,</span> <span class="n">iplist</span><span class="p">,</span> <span class="n">commit_flag</span><span class="p">);</span>

      <span class="nl">out4:</span>
	<span class="n">txEnd</span><span class="p">(</span><span class="n">tid</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">new_ip</span><span class="p">)</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">JFS_IP</span><span class="p">(</span><span class="n">new_ip</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">commit_mutex</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">old_dir</span> <span class="o">!=</span> <span class="n">new_dir</span><span class="p">)</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">JFS_IP</span><span class="p">(</span><span class="n">old_dir</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">commit_mutex</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">JFS_IP</span><span class="p">(</span><span class="n">old_ip</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">commit_mutex</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">JFS_IP</span><span class="p">(</span><span class="n">new_dir</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">commit_mutex</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">new_size</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">tid</span> <span class="o">=</span> <span class="n">txBegin</span><span class="p">(</span><span class="n">new_ip</span><span class="o">-&gt;</span><span class="n">i_sb</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">JFS_IP</span><span class="p">(</span><span class="n">new_ip</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">commit_mutex</span><span class="p">);</span>
		<span class="n">new_size</span> <span class="o">=</span> <span class="n">xtTruncate_pmap</span><span class="p">(</span><span class="n">tid</span><span class="p">,</span> <span class="n">new_ip</span><span class="p">,</span> <span class="n">new_size</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">new_size</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">txAbort</span><span class="p">(</span><span class="n">tid</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="n">new_size</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="n">txCommit</span><span class="p">(</span><span class="n">tid</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">new_ip</span><span class="p">,</span> <span class="n">COMMIT_SYNC</span><span class="p">);</span>
		<span class="n">txEnd</span><span class="p">(</span><span class="n">tid</span><span class="p">);</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">JFS_IP</span><span class="p">(</span><span class="n">new_ip</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">commit_mutex</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">new_ip</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">new_ip</span><span class="o">-&gt;</span><span class="n">i_nlink</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span>
		<span class="n">set_cflag</span><span class="p">(</span><span class="n">COMMIT_Nolink</span><span class="p">,</span> <span class="n">new_ip</span><span class="p">);</span>
      <span class="nl">out3:</span>
	<span class="n">free_UCSname</span><span class="p">(</span><span class="o">&amp;</span><span class="n">new_dname</span><span class="p">);</span>
      <span class="nl">out2:</span>
	<span class="n">free_UCSname</span><span class="p">(</span><span class="o">&amp;</span><span class="n">old_dname</span><span class="p">);</span>
      <span class="nl">out1:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">new_ip</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">S_ISDIR</span><span class="p">(</span><span class="n">new_ip</span><span class="o">-&gt;</span><span class="n">i_mode</span><span class="p">))</span>
		<span class="n">IWRITE_UNLOCK</span><span class="p">(</span><span class="n">new_ip</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 * Truncating the directory index table is not guaranteed.  It</span>
<span class="cm">	 * may need to be done iteratively</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_cflag</span><span class="p">(</span><span class="n">COMMIT_Stale</span><span class="p">,</span> <span class="n">old_dir</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">old_dir</span><span class="o">-&gt;</span><span class="n">i_size</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
			<span class="n">jfs_truncate_nolock</span><span class="p">(</span><span class="n">old_dir</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

		<span class="n">clear_cflag</span><span class="p">(</span><span class="n">COMMIT_Stale</span><span class="p">,</span> <span class="n">old_dir</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">jfs_info</span><span class="p">(</span><span class="s">&quot;jfs_rename: returning %d&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * NAME:	jfs_mknod</span>
<span class="cm"> *</span>
<span class="cm"> * FUNCTION:	Create a special file (device)</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">jfs_mknod</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">dir</span><span class="p">,</span> <span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="n">dentry</span><span class="p">,</span>
		<span class="n">umode_t</span> <span class="n">mode</span><span class="p">,</span> <span class="n">dev_t</span> <span class="n">rdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">jfs_inode_info</span> <span class="o">*</span><span class="n">jfs_ip</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">btstack</span> <span class="n">btstack</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">component_name</span> <span class="n">dname</span><span class="p">;</span>
	<span class="n">ino_t</span> <span class="n">ino</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">ip</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">iplist</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>
	<span class="n">tid_t</span> <span class="n">tid</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tblock</span> <span class="o">*</span><span class="n">tblk</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">new_valid_dev</span><span class="p">(</span><span class="n">rdev</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">jfs_info</span><span class="p">(</span><span class="s">&quot;jfs_mknod: %s&quot;</span><span class="p">,</span> <span class="n">dentry</span><span class="o">-&gt;</span><span class="n">d_name</span><span class="p">.</span><span class="n">name</span><span class="p">);</span>

	<span class="n">dquot_initialize</span><span class="p">(</span><span class="n">dir</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">rc</span> <span class="o">=</span> <span class="n">get_UCSname</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dname</span><span class="p">,</span> <span class="n">dentry</span><span class="p">)))</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">ip</span> <span class="o">=</span> <span class="n">ialloc</span><span class="p">(</span><span class="n">dir</span><span class="p">,</span> <span class="n">mode</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">ip</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">ip</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">jfs_ip</span> <span class="o">=</span> <span class="n">JFS_IP</span><span class="p">(</span><span class="n">ip</span><span class="p">);</span>

	<span class="n">tid</span> <span class="o">=</span> <span class="n">txBegin</span><span class="p">(</span><span class="n">dir</span><span class="o">-&gt;</span><span class="n">i_sb</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">mutex_lock_nested</span><span class="p">(</span><span class="o">&amp;</span><span class="n">JFS_IP</span><span class="p">(</span><span class="n">dir</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">commit_mutex</span><span class="p">,</span> <span class="n">COMMIT_MUTEX_PARENT</span><span class="p">);</span>
	<span class="n">mutex_lock_nested</span><span class="p">(</span><span class="o">&amp;</span><span class="n">JFS_IP</span><span class="p">(</span><span class="n">ip</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">commit_mutex</span><span class="p">,</span> <span class="n">COMMIT_MUTEX_CHILD</span><span class="p">);</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">jfs_init_acl</span><span class="p">(</span><span class="n">tid</span><span class="p">,</span> <span class="n">ip</span><span class="p">,</span> <span class="n">dir</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out3</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">jfs_init_security</span><span class="p">(</span><span class="n">tid</span><span class="p">,</span> <span class="n">ip</span><span class="p">,</span> <span class="n">dir</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dentry</span><span class="o">-&gt;</span><span class="n">d_name</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">txAbort</span><span class="p">(</span><span class="n">tid</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out3</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">rc</span> <span class="o">=</span> <span class="n">dtSearch</span><span class="p">(</span><span class="n">dir</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dname</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ino</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">btstack</span><span class="p">,</span> <span class="n">JFS_CREATE</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">txAbort</span><span class="p">(</span><span class="n">tid</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out3</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">tblk</span> <span class="o">=</span> <span class="n">tid_to_tblock</span><span class="p">(</span><span class="n">tid</span><span class="p">);</span>
	<span class="n">tblk</span><span class="o">-&gt;</span><span class="n">xflag</span> <span class="o">|=</span> <span class="n">COMMIT_CREATE</span><span class="p">;</span>
	<span class="n">tblk</span><span class="o">-&gt;</span><span class="n">ino</span> <span class="o">=</span> <span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_ino</span><span class="p">;</span>
	<span class="n">tblk</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">ixpxd</span> <span class="o">=</span> <span class="n">JFS_IP</span><span class="p">(</span><span class="n">ip</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">ixpxd</span><span class="p">;</span>

	<span class="n">ino</span> <span class="o">=</span> <span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_ino</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">rc</span> <span class="o">=</span> <span class="n">dtInsert</span><span class="p">(</span><span class="n">tid</span><span class="p">,</span> <span class="n">dir</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dname</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ino</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">btstack</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">txAbort</span><span class="p">(</span><span class="n">tid</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out3</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_op</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">jfs_file_inode_operations</span><span class="p">;</span>
	<span class="n">jfs_ip</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">new_encode_dev</span><span class="p">(</span><span class="n">rdev</span><span class="p">);</span>
	<span class="n">init_special_inode</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_mode</span><span class="p">,</span> <span class="n">rdev</span><span class="p">);</span>

	<span class="n">mark_inode_dirty</span><span class="p">(</span><span class="n">ip</span><span class="p">);</span>

	<span class="n">dir</span><span class="o">-&gt;</span><span class="n">i_ctime</span> <span class="o">=</span> <span class="n">dir</span><span class="o">-&gt;</span><span class="n">i_mtime</span> <span class="o">=</span> <span class="n">CURRENT_TIME</span><span class="p">;</span>

	<span class="n">mark_inode_dirty</span><span class="p">(</span><span class="n">dir</span><span class="p">);</span>

	<span class="n">iplist</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">dir</span><span class="p">;</span>
	<span class="n">iplist</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">ip</span><span class="p">;</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">txCommit</span><span class="p">(</span><span class="n">tid</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">iplist</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

      <span class="nl">out3:</span>
	<span class="n">txEnd</span><span class="p">(</span><span class="n">tid</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">JFS_IP</span><span class="p">(</span><span class="n">ip</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">commit_mutex</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">JFS_IP</span><span class="p">(</span><span class="n">dir</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">commit_mutex</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">free_ea_wmap</span><span class="p">(</span><span class="n">ip</span><span class="p">);</span>
		<span class="n">clear_nlink</span><span class="p">(</span><span class="n">ip</span><span class="p">);</span>
		<span class="n">unlock_new_inode</span><span class="p">(</span><span class="n">ip</span><span class="p">);</span>
		<span class="n">iput</span><span class="p">(</span><span class="n">ip</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">d_instantiate</span><span class="p">(</span><span class="n">dentry</span><span class="p">,</span> <span class="n">ip</span><span class="p">);</span>
		<span class="n">unlock_new_inode</span><span class="p">(</span><span class="n">ip</span><span class="p">);</span>
	<span class="p">}</span>

      <span class="nl">out1:</span>
	<span class="n">free_UCSname</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dname</span><span class="p">);</span>

      <span class="nl">out:</span>
	<span class="n">jfs_info</span><span class="p">(</span><span class="s">&quot;jfs_mknod: returning %d&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="nf">jfs_lookup</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">dip</span><span class="p">,</span> <span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="n">dentry</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nameidata</span> <span class="o">*</span><span class="n">nd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">btstack</span> <span class="n">btstack</span><span class="p">;</span>
	<span class="n">ino_t</span> <span class="n">inum</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">ip</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">component_name</span> <span class="n">key</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">jfs_info</span><span class="p">(</span><span class="s">&quot;jfs_lookup: name = %s&quot;</span><span class="p">,</span> <span class="n">dentry</span><span class="o">-&gt;</span><span class="n">d_name</span><span class="p">.</span><span class="n">name</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">rc</span> <span class="o">=</span> <span class="n">get_UCSname</span><span class="p">(</span><span class="o">&amp;</span><span class="n">key</span><span class="p">,</span> <span class="n">dentry</span><span class="p">)))</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="n">rc</span><span class="p">);</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">dtSearch</span><span class="p">(</span><span class="n">dip</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">key</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">inum</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">btstack</span><span class="p">,</span> <span class="n">JFS_LOOKUP</span><span class="p">);</span>
	<span class="n">free_UCSname</span><span class="p">(</span><span class="o">&amp;</span><span class="n">key</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ip</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">jfs_err</span><span class="p">(</span><span class="s">&quot;jfs_lookup: dtSearch returned %d&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
		<span class="n">ip</span> <span class="o">=</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="n">rc</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ip</span> <span class="o">=</span> <span class="n">jfs_iget</span><span class="p">(</span><span class="n">dip</span><span class="o">-&gt;</span><span class="n">i_sb</span><span class="p">,</span> <span class="n">inum</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">ip</span><span class="p">))</span>
			<span class="n">jfs_err</span><span class="p">(</span><span class="s">&quot;jfs_lookup: iget failed on inum %d&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">uint</span><span class="p">)</span><span class="n">inum</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">d_splice_alias</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">dentry</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="nf">jfs_nfs_get_inode</span><span class="p">(</span><span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">sb</span><span class="p">,</span>
		<span class="n">u64</span> <span class="n">ino</span><span class="p">,</span> <span class="n">u32</span> <span class="n">generation</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ino</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">ESTALE</span><span class="p">);</span>
	<span class="n">inode</span> <span class="o">=</span> <span class="n">jfs_iget</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">ino</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">inode</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">ERR_CAST</span><span class="p">(</span><span class="n">inode</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">generation</span> <span class="o">&amp;&amp;</span> <span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_generation</span> <span class="o">!=</span> <span class="n">generation</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">iput</span><span class="p">(</span><span class="n">inode</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">ESTALE</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">inode</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="nf">jfs_fh_to_dentry</span><span class="p">(</span><span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">sb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fid</span> <span class="o">*</span><span class="n">fid</span><span class="p">,</span>
		<span class="kt">int</span> <span class="n">fh_len</span><span class="p">,</span> <span class="kt">int</span> <span class="n">fh_type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">generic_fh_to_dentry</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">fid</span><span class="p">,</span> <span class="n">fh_len</span><span class="p">,</span> <span class="n">fh_type</span><span class="p">,</span>
				    <span class="n">jfs_nfs_get_inode</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="nf">jfs_fh_to_parent</span><span class="p">(</span><span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">sb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fid</span> <span class="o">*</span><span class="n">fid</span><span class="p">,</span>
		<span class="kt">int</span> <span class="n">fh_len</span><span class="p">,</span> <span class="kt">int</span> <span class="n">fh_type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">generic_fh_to_parent</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">fid</span><span class="p">,</span> <span class="n">fh_len</span><span class="p">,</span> <span class="n">fh_type</span><span class="p">,</span>
				    <span class="n">jfs_nfs_get_inode</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="nf">jfs_get_parent</span><span class="p">(</span><span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="n">dentry</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">parent_ino</span><span class="p">;</span>

	<span class="n">parent_ino</span> <span class="o">=</span>
		<span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">JFS_IP</span><span class="p">(</span><span class="n">dentry</span><span class="o">-&gt;</span><span class="n">d_inode</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">i_dtroot</span><span class="p">.</span><span class="n">header</span><span class="p">.</span><span class="n">idotdot</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">d_obtain_alias</span><span class="p">(</span><span class="n">jfs_iget</span><span class="p">(</span><span class="n">dentry</span><span class="o">-&gt;</span><span class="n">d_inode</span><span class="o">-&gt;</span><span class="n">i_sb</span><span class="p">,</span> <span class="n">parent_ino</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">const</span> <span class="k">struct</span> <span class="n">inode_operations</span> <span class="n">jfs_dir_inode_operations</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">create</span>		<span class="o">=</span> <span class="n">jfs_create</span><span class="p">,</span>
	<span class="p">.</span><span class="n">lookup</span>		<span class="o">=</span> <span class="n">jfs_lookup</span><span class="p">,</span>
	<span class="p">.</span><span class="n">link</span>		<span class="o">=</span> <span class="n">jfs_link</span><span class="p">,</span>
	<span class="p">.</span><span class="n">unlink</span>		<span class="o">=</span> <span class="n">jfs_unlink</span><span class="p">,</span>
	<span class="p">.</span><span class="n">symlink</span>	<span class="o">=</span> <span class="n">jfs_symlink</span><span class="p">,</span>
	<span class="p">.</span><span class="n">mkdir</span>		<span class="o">=</span> <span class="n">jfs_mkdir</span><span class="p">,</span>
	<span class="p">.</span><span class="n">rmdir</span>		<span class="o">=</span> <span class="n">jfs_rmdir</span><span class="p">,</span>
	<span class="p">.</span><span class="n">mknod</span>		<span class="o">=</span> <span class="n">jfs_mknod</span><span class="p">,</span>
	<span class="p">.</span><span class="n">rename</span>		<span class="o">=</span> <span class="n">jfs_rename</span><span class="p">,</span>
	<span class="p">.</span><span class="n">setxattr</span>	<span class="o">=</span> <span class="n">jfs_setxattr</span><span class="p">,</span>
	<span class="p">.</span><span class="n">getxattr</span>	<span class="o">=</span> <span class="n">jfs_getxattr</span><span class="p">,</span>
	<span class="p">.</span><span class="n">listxattr</span>	<span class="o">=</span> <span class="n">jfs_listxattr</span><span class="p">,</span>
	<span class="p">.</span><span class="n">removexattr</span>	<span class="o">=</span> <span class="n">jfs_removexattr</span><span class="p">,</span>
	<span class="p">.</span><span class="n">setattr</span>	<span class="o">=</span> <span class="n">jfs_setattr</span><span class="p">,</span>
<span class="cp">#ifdef CONFIG_JFS_POSIX_ACL</span>
	<span class="p">.</span><span class="n">get_acl</span>	<span class="o">=</span> <span class="n">jfs_get_acl</span><span class="p">,</span>
<span class="cp">#endif</span>
<span class="p">};</span>

<span class="k">const</span> <span class="k">struct</span> <span class="n">file_operations</span> <span class="n">jfs_dir_operations</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">read</span>		<span class="o">=</span> <span class="n">generic_read_dir</span><span class="p">,</span>
	<span class="p">.</span><span class="n">readdir</span>	<span class="o">=</span> <span class="n">jfs_readdir</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fsync</span>		<span class="o">=</span> <span class="n">jfs_fsync</span><span class="p">,</span>
	<span class="p">.</span><span class="n">unlocked_ioctl</span> <span class="o">=</span> <span class="n">jfs_ioctl</span><span class="p">,</span>
<span class="cp">#ifdef CONFIG_COMPAT</span>
	<span class="p">.</span><span class="n">compat_ioctl</span>	<span class="o">=</span> <span class="n">jfs_compat_ioctl</span><span class="p">,</span>
<span class="cp">#endif</span>
	<span class="p">.</span><span class="n">llseek</span>		<span class="o">=</span> <span class="n">generic_file_llseek</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">jfs_ci_hash</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="n">dir</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">qstr</span> <span class="o">*</span><span class="n">this</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">hash</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">hash</span> <span class="o">=</span> <span class="n">init_name_hash</span><span class="p">();</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">hash</span> <span class="o">=</span> <span class="n">partial_name_hash</span><span class="p">(</span><span class="n">tolower</span><span class="p">(</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span> <span class="n">hash</span><span class="p">);</span>
	<span class="n">this</span><span class="o">-&gt;</span><span class="n">hash</span> <span class="o">=</span> <span class="n">end_name_hash</span><span class="p">(</span><span class="n">hash</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">jfs_ci_compare</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="n">parent</span><span class="p">,</span>
		<span class="k">const</span> <span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">pinode</span><span class="p">,</span>
		<span class="k">const</span> <span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="n">dentry</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">len</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">str</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">qstr</span> <span class="o">*</span><span class="n">name</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">result</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">!=</span> <span class="n">name</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">len</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tolower</span><span class="p">(</span><span class="n">str</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">!=</span> <span class="n">tolower</span><span class="p">(</span><span class="n">name</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">result</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">jfs_ci_revalidate</span><span class="p">(</span><span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="n">dentry</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nameidata</span> <span class="o">*</span><span class="n">nd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/*</span>
<span class="cm">	 * This is not negative dentry. Always valid.</span>
<span class="cm">	 *</span>
<span class="cm">	 * Note, rename() to existing directory entry will have -&gt;d_inode,</span>
<span class="cm">	 * and will use existing name which isn&#39;t specified name by user.</span>
<span class="cm">	 *</span>
<span class="cm">	 * We may be able to drop this positive dentry here. But dropping</span>
<span class="cm">	 * positive dentry isn&#39;t good idea. So it&#39;s unsupported like</span>
<span class="cm">	 * rename(&quot;filename&quot;, &quot;FILENAME&quot;) for now.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dentry</span><span class="o">-&gt;</span><span class="n">d_inode</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * This may be nfsd (or something), anyway, we can&#39;t see the</span>
<span class="cm">	 * intent of this. So, since this can be for creation, drop it.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">nd</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Drop the negative dentry, in order to make sure to use the</span>
<span class="cm">	 * case sensitive name which is specified by user if this is</span>
<span class="cm">	 * for creation.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nd</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">LOOKUP_CREATE</span> <span class="o">|</span> <span class="n">LOOKUP_RENAME_TARGET</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">const</span> <span class="k">struct</span> <span class="n">dentry_operations</span> <span class="n">jfs_ci_dentry_operations</span> <span class="o">=</span>
<span class="p">{</span>
	<span class="p">.</span><span class="n">d_hash</span> <span class="o">=</span> <span class="n">jfs_ci_hash</span><span class="p">,</span>
	<span class="p">.</span><span class="n">d_compare</span> <span class="o">=</span> <span class="n">jfs_ci_compare</span><span class="p">,</span>
	<span class="p">.</span><span class="n">d_revalidate</span> <span class="o">=</span> <span class="n">jfs_ci_revalidate</span><span class="p">,</span>
<span class="p">};</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
