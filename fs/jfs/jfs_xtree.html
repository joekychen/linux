<!DOCTYPE html>
<html><head><title>joekychen/linux » fs › jfs › jfs_xtree.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>jfs_xtree.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> *   Copyright (C) International Business Machines Corp., 2000-2005</span>
<span class="cm"> *</span>
<span class="cm"> *   This program is free software;  you can redistribute it and/or modify</span>
<span class="cm"> *   it under the terms of the GNU General Public License as published by</span>
<span class="cm"> *   the Free Software Foundation; either version 2 of the License, or</span>
<span class="cm"> *   (at your option) any later version.</span>
<span class="cm"> *</span>
<span class="cm"> *   This program is distributed in the hope that it will be useful,</span>
<span class="cm"> *   but WITHOUT ANY WARRANTY;  without even the implied warranty of</span>
<span class="cm"> *   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See</span>
<span class="cm"> *   the GNU General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> *   You should have received a copy of the GNU General Public License</span>
<span class="cm"> *   along with this program;  if not, write to the Free Software</span>
<span class="cm"> *   Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA 02111-1307 USA</span>
<span class="cm"> */</span>
<span class="cm">/*</span>
<span class="cm"> *	jfs_xtree.c: extent allocation descriptor B+-tree manager</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/fs.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/quotaops.h&gt;</span>
<span class="cp">#include &lt;linux/seq_file.h&gt;</span>
<span class="cp">#include &quot;jfs_incore.h&quot;</span>
<span class="cp">#include &quot;jfs_filsys.h&quot;</span>
<span class="cp">#include &quot;jfs_metapage.h&quot;</span>
<span class="cp">#include &quot;jfs_dmap.h&quot;</span>
<span class="cp">#include &quot;jfs_dinode.h&quot;</span>
<span class="cp">#include &quot;jfs_superblock.h&quot;</span>
<span class="cp">#include &quot;jfs_debug.h&quot;</span>

<span class="cm">/*</span>
<span class="cm"> * xtree local flag</span>
<span class="cm"> */</span>
<span class="cp">#define XT_INSERT	0x00000001</span>

<span class="cm">/*</span>
<span class="cm"> *	xtree key/entry comparison: extent offset</span>
<span class="cm"> *</span>
<span class="cm"> * return:</span>
<span class="cm"> *	-1: k &lt; start of extent</span>
<span class="cm"> *	 0: start_of_extent &lt;= k &lt;= end_of_extent</span>
<span class="cm"> *	 1: k &gt; end_of_extent</span>
<span class="cm"> */</span>
<span class="cp">#define XT_CMP(CMP, K, X, OFFSET64)\</span>
<span class="cp">{\</span>
<span class="cp">	OFFSET64 = offsetXAD(X);\</span>
<span class="cp">	(CMP) = ((K) &gt;= OFFSET64 + lengthXAD(X)) ? 1 :\</span>
<span class="cp">		((K) &lt; OFFSET64) ? -1 : 0;\</span>
<span class="cp">}</span>

<span class="cm">/* write a xad entry */</span>
<span class="cp">#define XT_PUTENTRY(XAD, FLAG, OFF, LEN, ADDR)\</span>
<span class="cp">{\</span>
<span class="cp">	(XAD)-&gt;flag = (FLAG);\</span>
<span class="cp">	XADoffset((XAD), (OFF));\</span>
<span class="cp">	XADlength((XAD), (LEN));\</span>
<span class="cp">	XADaddress((XAD), (ADDR));\</span>
<span class="cp">}</span>

<span class="cp">#define XT_PAGE(IP, MP) BT_PAGE(IP, MP, xtpage_t, i_xtroot)</span>

<span class="cm">/* get page buffer for specified block address */</span>
<span class="cm">/* ToDo: Replace this ugly macro with a function */</span>
<span class="cp">#define XT_GETPAGE(IP, BN, MP, SIZE, P, RC)\</span>
<span class="cp">{\</span>
<span class="cp">	BT_GETPAGE(IP, BN, MP, xtpage_t, SIZE, P, RC, i_xtroot)\</span>
<span class="cp">	if (!(RC))\</span>
<span class="cp">	{\</span>
<span class="cp">		if ((le16_to_cpu((P)-&gt;header.nextindex) &lt; XTENTRYSTART) ||\</span>
<span class="cp">		    (le16_to_cpu((P)-&gt;header.nextindex) &gt; le16_to_cpu((P)-&gt;header.maxentry)) ||\</span>
<span class="cp">		    (le16_to_cpu((P)-&gt;header.maxentry) &gt; (((BN)==0)?XTROOTMAXSLOT:PSIZE&gt;&gt;L2XTSLOTSIZE)))\</span>
<span class="cp">		{\</span>
<span class="cp">			jfs_error((IP)-&gt;i_sb, &quot;XT_GETPAGE: xtree page corrupt&quot;);\</span>
<span class="cp">			BT_PUTPAGE(MP);\</span>
<span class="cp">			MP = NULL;\</span>
<span class="cp">			RC = -EIO;\</span>
<span class="cp">		}\</span>
<span class="cp">	}\</span>
<span class="cp">}</span>

<span class="cm">/* for consistency */</span>
<span class="cp">#define XT_PUTPAGE(MP) BT_PUTPAGE(MP)</span>

<span class="cp">#define XT_GETSEARCH(IP, LEAF, BN, MP, P, INDEX) \</span>
<span class="cp">	BT_GETSEARCH(IP, LEAF, BN, MP, xtpage_t, P, INDEX, i_xtroot)</span>
<span class="cm">/* xtree entry parameter descriptor */</span>
<span class="k">struct</span> <span class="n">xtsplit</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">metapage</span> <span class="o">*</span><span class="n">mp</span><span class="p">;</span>
	<span class="n">s16</span> <span class="n">index</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">flag</span><span class="p">;</span>
	<span class="n">s64</span> <span class="n">off</span><span class="p">;</span>
	<span class="n">s64</span> <span class="n">addr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">len</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pxdlist</span> <span class="o">*</span><span class="n">pxdlist</span><span class="p">;</span>
<span class="p">};</span>


<span class="cm">/*</span>
<span class="cm"> *	statistics</span>
<span class="cm"> */</span>
<span class="cp">#ifdef CONFIG_JFS_STATISTICS</span>
<span class="k">static</span> <span class="k">struct</span> <span class="p">{</span>
	<span class="n">uint</span> <span class="n">search</span><span class="p">;</span>
	<span class="n">uint</span> <span class="n">fastSearch</span><span class="p">;</span>
	<span class="n">uint</span> <span class="n">split</span><span class="p">;</span>
<span class="p">}</span> <span class="n">xtStat</span><span class="p">;</span>
<span class="cp">#endif</span>


<span class="cm">/*</span>
<span class="cm"> * forward references</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">xtSearch</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">ip</span><span class="p">,</span> <span class="n">s64</span> <span class="n">xoff</span><span class="p">,</span> <span class="n">s64</span> <span class="o">*</span><span class="n">next</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">cmpp</span><span class="p">,</span>
		    <span class="k">struct</span> <span class="n">btstack</span> <span class="o">*</span> <span class="n">btstack</span><span class="p">,</span> <span class="kt">int</span> <span class="n">flag</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">xtSplitUp</span><span class="p">(</span><span class="n">tid_t</span> <span class="n">tid</span><span class="p">,</span>
		     <span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">ip</span><span class="p">,</span>
		     <span class="k">struct</span> <span class="n">xtsplit</span> <span class="o">*</span> <span class="n">split</span><span class="p">,</span> <span class="k">struct</span> <span class="n">btstack</span> <span class="o">*</span> <span class="n">btstack</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">xtSplitPage</span><span class="p">(</span><span class="n">tid_t</span> <span class="n">tid</span><span class="p">,</span> <span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">ip</span><span class="p">,</span> <span class="k">struct</span> <span class="n">xtsplit</span> <span class="o">*</span> <span class="n">split</span><span class="p">,</span>
		       <span class="k">struct</span> <span class="n">metapage</span> <span class="o">**</span> <span class="n">rmpp</span><span class="p">,</span> <span class="n">s64</span> <span class="o">*</span> <span class="n">rbnp</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">xtSplitRoot</span><span class="p">(</span><span class="n">tid_t</span> <span class="n">tid</span><span class="p">,</span> <span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">ip</span><span class="p">,</span>
		       <span class="k">struct</span> <span class="n">xtsplit</span> <span class="o">*</span> <span class="n">split</span><span class="p">,</span> <span class="k">struct</span> <span class="n">metapage</span> <span class="o">**</span> <span class="n">rmpp</span><span class="p">);</span>

<span class="cp">#ifdef _STILL_TO_PORT</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">xtDeleteUp</span><span class="p">(</span><span class="n">tid_t</span> <span class="n">tid</span><span class="p">,</span> <span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">ip</span><span class="p">,</span> <span class="k">struct</span> <span class="n">metapage</span> <span class="o">*</span> <span class="n">fmp</span><span class="p">,</span>
		      <span class="n">xtpage_t</span> <span class="o">*</span> <span class="n">fp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">btstack</span> <span class="o">*</span> <span class="n">btstack</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">xtSearchNode</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">ip</span><span class="p">,</span>
			<span class="n">xad_t</span> <span class="o">*</span> <span class="n">xad</span><span class="p">,</span>
			<span class="kt">int</span> <span class="o">*</span><span class="n">cmpp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">btstack</span> <span class="o">*</span> <span class="n">btstack</span><span class="p">,</span> <span class="kt">int</span> <span class="n">flag</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">xtRelink</span><span class="p">(</span><span class="n">tid_t</span> <span class="n">tid</span><span class="p">,</span> <span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">ip</span><span class="p">,</span> <span class="n">xtpage_t</span> <span class="o">*</span> <span class="n">fp</span><span class="p">);</span>
<span class="cp">#endif				</span><span class="cm">/*  _STILL_TO_PORT */</span><span class="cp"></span>

<span class="cm">/*</span>
<span class="cm"> *	xtLookup()</span>
<span class="cm"> *</span>
<span class="cm"> * function: map a single page into a physical extent;</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">xtLookup</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">ip</span><span class="p">,</span> <span class="n">s64</span> <span class="n">lstart</span><span class="p">,</span>
	     <span class="n">s64</span> <span class="n">llen</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">pflag</span><span class="p">,</span> <span class="n">s64</span> <span class="o">*</span> <span class="n">paddr</span><span class="p">,</span> <span class="n">s32</span> <span class="o">*</span> <span class="n">plen</span><span class="p">,</span> <span class="kt">int</span> <span class="n">no_check</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">btstack</span> <span class="n">btstack</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">cmp</span><span class="p">;</span>
	<span class="n">s64</span> <span class="n">bn</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">metapage</span> <span class="o">*</span><span class="n">mp</span><span class="p">;</span>
	<span class="n">xtpage_t</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">index</span><span class="p">;</span>
	<span class="n">xad_t</span> <span class="o">*</span><span class="n">xad</span><span class="p">;</span>
	<span class="n">s64</span> <span class="n">next</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">xoff</span><span class="p">,</span> <span class="n">xend</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">xlen</span><span class="p">;</span>
	<span class="n">s64</span> <span class="n">xaddr</span><span class="p">;</span>

	<span class="o">*</span><span class="n">paddr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="o">*</span><span class="n">plen</span> <span class="o">=</span> <span class="n">llen</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">no_check</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* is lookup offset beyond eof ? */</span>
		<span class="n">size</span> <span class="o">=</span> <span class="p">((</span><span class="n">u64</span><span class="p">)</span> <span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_size</span> <span class="o">+</span> <span class="p">(</span><span class="n">JFS_SBI</span><span class="p">(</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_sb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">bsize</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="o">&gt;&gt;</span>
		    <span class="n">JFS_SBI</span><span class="p">(</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_sb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">l2bsize</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">lstart</span> <span class="o">&gt;=</span> <span class="n">size</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * search for the xad entry covering the logical extent</span>
<span class="cm">	 */</span></pre></div></td></tr>


<tr id="section-2"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-2">&#182;</a></div><p>search:</p></td><td class="code"><div class="highlight"><pre>	<span class="k">if</span> <span class="p">((</span><span class="n">rc</span> <span class="o">=</span> <span class="n">xtSearch</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">lstart</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">next</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">btstack</span><span class="p">,</span> <span class="mi">0</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">jfs_err</span><span class="p">(</span><span class="s">&quot;xtLookup: xtSearch returned %d&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 *	compute the physical extent covering logical extent</span>
<span class="cm">	 *</span>
<span class="cm">	 * N.B. search may have failed (e.g., hole in sparse file),</span>
<span class="cm">	 * and returned the index of the next entry.</span>
<span class="cm">	 */</span>
	<span class="cm">/* retrieve search result */</span>
	<span class="n">XT_GETSEARCH</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">btstack</span><span class="p">.</span><span class="n">top</span><span class="p">,</span> <span class="n">bn</span><span class="p">,</span> <span class="n">mp</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">index</span><span class="p">);</span>

	<span class="cm">/* is xad found covering start of logical extent ?</span>
<span class="cm">	 * lstart is a page start address,</span>
<span class="cm">	 * i.e., lstart cannot start in a hole;</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmp</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">next</span><span class="p">)</span>
			<span class="o">*</span><span class="n">plen</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">next</span> <span class="o">-</span> <span class="n">lstart</span><span class="p">,</span> <span class="n">llen</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * lxd covered by xad</span>
<span class="cm">	 */</span>
	<span class="n">xad</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">xad</span><span class="p">[</span><span class="n">index</span><span class="p">];</span>
	<span class="n">xoff</span> <span class="o">=</span> <span class="n">offsetXAD</span><span class="p">(</span><span class="n">xad</span><span class="p">);</span>
	<span class="n">xlen</span> <span class="o">=</span> <span class="n">lengthXAD</span><span class="p">(</span><span class="n">xad</span><span class="p">);</span>
	<span class="n">xend</span> <span class="o">=</span> <span class="n">xoff</span> <span class="o">+</span> <span class="n">xlen</span><span class="p">;</span>
	<span class="n">xaddr</span> <span class="o">=</span> <span class="n">addressXAD</span><span class="p">(</span><span class="n">xad</span><span class="p">);</span>

	<span class="cm">/* initialize new pxd */</span>
	<span class="o">*</span><span class="n">pflag</span> <span class="o">=</span> <span class="n">xad</span><span class="o">-&gt;</span><span class="n">flag</span><span class="p">;</span>
	<span class="o">*</span><span class="n">paddr</span> <span class="o">=</span> <span class="n">xaddr</span> <span class="o">+</span> <span class="p">(</span><span class="n">lstart</span> <span class="o">-</span> <span class="n">xoff</span><span class="p">);</span>
	<span class="cm">/* a page must be fully covered by an xad */</span>
	<span class="o">*</span><span class="n">plen</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">xend</span> <span class="o">-</span> <span class="n">lstart</span><span class="p">,</span> <span class="n">llen</span><span class="p">);</span>

      <span class="nl">out:</span>
	<span class="n">XT_PUTPAGE</span><span class="p">(</span><span class="n">mp</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *	xtSearch()</span>
<span class="cm"> *</span>
<span class="cm"> * function:	search for the xad entry covering specified offset.</span>
<span class="cm"> *</span>
<span class="cm"> * parameters:</span>
<span class="cm"> *	ip	- file object;</span>
<span class="cm"> *	xoff	- extent offset;</span>
<span class="cm"> *	nextp	- address of next extent (if any) for search miss</span>
<span class="cm"> *	cmpp	- comparison result:</span>
<span class="cm"> *	btstack - traverse stack;</span>
<span class="cm"> *	flag	- search process flag (XT_INSERT);</span>
<span class="cm"> *</span>
<span class="cm"> * returns:</span>
<span class="cm"> *	btstack contains (bn, index) of search path traversed to the entry.</span>
<span class="cm"> *	*cmpp is set to result of comparison with the entry returned.</span>
<span class="cm"> *	the page containing the entry is pinned at exit.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">xtSearch</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">ip</span><span class="p">,</span> <span class="n">s64</span> <span class="n">xoff</span><span class="p">,</span>	<span class="n">s64</span> <span class="o">*</span><span class="n">nextp</span><span class="p">,</span>
		    <span class="kt">int</span> <span class="o">*</span><span class="n">cmpp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">btstack</span> <span class="o">*</span> <span class="n">btstack</span><span class="p">,</span> <span class="kt">int</span> <span class="n">flag</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">jfs_inode_info</span> <span class="o">*</span><span class="n">jfs_ip</span> <span class="o">=</span> <span class="n">JFS_IP</span><span class="p">(</span><span class="n">ip</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">cmp</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>		<span class="cm">/* init for empty page */</span>
	<span class="n">s64</span> <span class="n">bn</span><span class="p">;</span>			<span class="cm">/* block number */</span>
	<span class="k">struct</span> <span class="n">metapage</span> <span class="o">*</span><span class="n">mp</span><span class="p">;</span>	<span class="cm">/* page buffer */</span>
	<span class="n">xtpage_t</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>		<span class="cm">/* page */</span>
	<span class="n">xad_t</span> <span class="o">*</span><span class="n">xad</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">base</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">lim</span><span class="p">,</span> <span class="n">btindex</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">btframe</span> <span class="o">*</span><span class="n">btsp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">nsplit</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>		<span class="cm">/* number of pages to split */</span>
	<span class="n">s64</span> <span class="n">t64</span><span class="p">;</span>
	<span class="n">s64</span> <span class="n">next</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">INCREMENT</span><span class="p">(</span><span class="n">xtStat</span><span class="p">.</span><span class="n">search</span><span class="p">);</span>

	<span class="n">BT_CLR</span><span class="p">(</span><span class="n">btstack</span><span class="p">);</span>

	<span class="n">btstack</span><span class="o">-&gt;</span><span class="n">nsplit</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 *	search down tree from root:</span>
<span class="cm">	 *</span>
<span class="cm">	 * between two consecutive entries of &lt;Ki, Pi&gt; and &lt;Kj, Pj&gt; of</span>
<span class="cm">	 * internal page, child page Pi contains entry with k, Ki &lt;= K &lt; Kj.</span>
<span class="cm">	 *</span>
<span class="cm">	 * if entry with search key K is not found</span>
<span class="cm">	 * internal page search find the entry with largest key Ki</span>
<span class="cm">	 * less than K which point to the child page to search;</span>
<span class="cm">	 * leaf page search find the entry with smallest key Kj</span>
<span class="cm">	 * greater than K so that the returned index is the position of</span>
<span class="cm">	 * the entry to be shifted right for insertion of new entry.</span>
<span class="cm">	 * for empty tree, search key is greater than any key of the tree.</span>
<span class="cm">	 *</span>
<span class="cm">	 * by convention, root bn = 0.</span>
<span class="cm">	 */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">bn</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;;)</span> <span class="p">{</span>
		<span class="cm">/* get/pin the page to search */</span>
		<span class="n">XT_GETPAGE</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">bn</span><span class="p">,</span> <span class="n">mp</span><span class="p">,</span> <span class="n">PSIZE</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

		<span class="cm">/* try sequential access heuristics with the previous</span>
<span class="cm">		 * access entry in target leaf page:</span>
<span class="cm">		 * once search narrowed down into the target leaf,</span>
<span class="cm">		 * key must either match an entry in the leaf or</span>
<span class="cm">		 * key entry does not exist in the tree;</span>
<span class="cm">		 */</span></pre></div></td></tr>


<tr id="section-3"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-3">&#182;</a></div><p>fastSearch:</p></td><td class="code"><div class="highlight"><pre>		<span class="k">if</span> <span class="p">((</span><span class="n">jfs_ip</span><span class="o">-&gt;</span><span class="n">btorder</span> <span class="o">&amp;</span> <span class="n">BT_SEQUENTIAL</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">flag</span> <span class="o">&amp;</span> <span class="n">BT_LEAF</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">index</span> <span class="o">=</span> <span class="n">jfs_ip</span><span class="o">-&gt;</span><span class="n">btindex</span><span class="p">)</span> <span class="o">&lt;</span>
		    <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">nextindex</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">xad</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">xad</span><span class="p">[</span><span class="n">index</span><span class="p">];</span>
			<span class="n">t64</span> <span class="o">=</span> <span class="n">offsetXAD</span><span class="p">(</span><span class="n">xad</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">xoff</span> <span class="o">&lt;</span> <span class="n">t64</span> <span class="o">+</span> <span class="n">lengthXAD</span><span class="p">(</span><span class="n">xad</span><span class="p">))</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">xoff</span> <span class="o">&gt;=</span> <span class="n">t64</span><span class="p">)</span> <span class="p">{</span>
					<span class="o">*</span><span class="n">cmpp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
					<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
				<span class="p">}</span>

				<span class="cm">/* stop sequential access heuristics */</span>
				<span class="k">goto</span> <span class="n">binarySearch</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>	<span class="cm">/* (t64 + lengthXAD(xad)) &lt;= xoff */</span>

				<span class="cm">/* try next sequential entry */</span>
				<span class="n">index</span><span class="o">++</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">index</span> <span class="o">&lt;</span>
				    <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">nextindex</span><span class="p">))</span> <span class="p">{</span>
					<span class="n">xad</span><span class="o">++</span><span class="p">;</span>
					<span class="n">t64</span> <span class="o">=</span> <span class="n">offsetXAD</span><span class="p">(</span><span class="n">xad</span><span class="p">);</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">xoff</span> <span class="o">&lt;</span> <span class="n">t64</span> <span class="o">+</span> <span class="n">lengthXAD</span><span class="p">(</span><span class="n">xad</span><span class="p">))</span> <span class="p">{</span>
						<span class="k">if</span> <span class="p">(</span><span class="n">xoff</span> <span class="o">&gt;=</span> <span class="n">t64</span><span class="p">)</span> <span class="p">{</span>
							<span class="o">*</span><span class="n">cmpp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
							<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
						<span class="p">}</span>

						<span class="cm">/* miss: key falls between</span>
<span class="cm">						 * previous and this entry</span>
<span class="cm">						 */</span>
						<span class="o">*</span><span class="n">cmpp</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
						<span class="n">next</span> <span class="o">=</span> <span class="n">t64</span><span class="p">;</span>
						<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
					<span class="p">}</span>

					<span class="cm">/* (xoff &gt;= t64 + lengthXAD(xad));</span>
<span class="cm">					 * matching entry may be further out:</span>
<span class="cm">					 * stop heuristic search</span>
<span class="cm">					 */</span>
					<span class="cm">/* stop sequential access heuristics */</span>
					<span class="k">goto</span> <span class="n">binarySearch</span><span class="p">;</span>
				<span class="p">}</span>

				<span class="cm">/* (index == p-&gt;header.nextindex);</span>
<span class="cm">				 * miss: key entry does not exist in</span>
<span class="cm">				 * the target leaf/tree</span>
<span class="cm">				 */</span>
				<span class="o">*</span><span class="n">cmpp</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="cm">/*</span>
<span class="cm">			 * if hit, return index of the entry found, and</span>
<span class="cm">			 * if miss, where new entry with search key is</span>
<span class="cm">			 * to be inserted;</span>
<span class="cm">			 */</span>
		      <span class="nl">out:</span>
			<span class="cm">/* compute number of pages to split */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">flag</span> <span class="o">&amp;</span> <span class="n">XT_INSERT</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">nextindex</span> <span class="o">==</span>	<span class="cm">/* little-endian */</span>
				    <span class="n">p</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">maxentry</span><span class="p">)</span>
					<span class="n">nsplit</span><span class="o">++</span><span class="p">;</span>
				<span class="k">else</span>
					<span class="n">nsplit</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">btstack</span><span class="o">-&gt;</span><span class="n">nsplit</span> <span class="o">=</span> <span class="n">nsplit</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="cm">/* save search result */</span>
			<span class="n">btsp</span> <span class="o">=</span> <span class="n">btstack</span><span class="o">-&gt;</span><span class="n">top</span><span class="p">;</span>
			<span class="n">btsp</span><span class="o">-&gt;</span><span class="n">bn</span> <span class="o">=</span> <span class="n">bn</span><span class="p">;</span>
			<span class="n">btsp</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">=</span> <span class="n">index</span><span class="p">;</span>
			<span class="n">btsp</span><span class="o">-&gt;</span><span class="n">mp</span> <span class="o">=</span> <span class="n">mp</span><span class="p">;</span>

			<span class="cm">/* update sequential access heuristics */</span>
			<span class="n">jfs_ip</span><span class="o">-&gt;</span><span class="n">btindex</span> <span class="o">=</span> <span class="n">index</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">nextp</span><span class="p">)</span>
				<span class="o">*</span><span class="n">nextp</span> <span class="o">=</span> <span class="n">next</span><span class="p">;</span>

			<span class="n">INCREMENT</span><span class="p">(</span><span class="n">xtStat</span><span class="p">.</span><span class="n">fastSearch</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* well, ... full search now */</span>
	      <span class="nl">binarySearch:</span>
		<span class="n">lim</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">nextindex</span><span class="p">)</span> <span class="o">-</span> <span class="n">XTENTRYSTART</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * binary search with search key K on the current page</span>
<span class="cm">		 */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">base</span> <span class="o">=</span> <span class="n">XTENTRYSTART</span><span class="p">;</span> <span class="n">lim</span><span class="p">;</span> <span class="n">lim</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">index</span> <span class="o">=</span> <span class="n">base</span> <span class="o">+</span> <span class="p">(</span><span class="n">lim</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">);</span>

			<span class="n">XT_CMP</span><span class="p">(</span><span class="n">cmp</span><span class="p">,</span> <span class="n">xoff</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">xad</span><span class="p">[</span><span class="n">index</span><span class="p">],</span> <span class="n">t64</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">cmp</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/*</span>
<span class="cm">				 *	search hit</span>
<span class="cm">				 */</span>
				<span class="cm">/* search hit - leaf page:</span>
<span class="cm">				 * return the entry found</span>
<span class="cm">				 */</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">flag</span> <span class="o">&amp;</span> <span class="n">BT_LEAF</span><span class="p">)</span> <span class="p">{</span>
					<span class="o">*</span><span class="n">cmpp</span> <span class="o">=</span> <span class="n">cmp</span><span class="p">;</span>

					<span class="cm">/* compute number of pages to split */</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">flag</span> <span class="o">&amp;</span> <span class="n">XT_INSERT</span><span class="p">)</span> <span class="p">{</span>
						<span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">nextindex</span> <span class="o">==</span>
						    <span class="n">p</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">maxentry</span><span class="p">)</span>
							<span class="n">nsplit</span><span class="o">++</span><span class="p">;</span>
						<span class="k">else</span>
							<span class="n">nsplit</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
						<span class="n">btstack</span><span class="o">-&gt;</span><span class="n">nsplit</span> <span class="o">=</span> <span class="n">nsplit</span><span class="p">;</span>
					<span class="p">}</span>

					<span class="cm">/* save search result */</span>
					<span class="n">btsp</span> <span class="o">=</span> <span class="n">btstack</span><span class="o">-&gt;</span><span class="n">top</span><span class="p">;</span>
					<span class="n">btsp</span><span class="o">-&gt;</span><span class="n">bn</span> <span class="o">=</span> <span class="n">bn</span><span class="p">;</span>
					<span class="n">btsp</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">=</span> <span class="n">index</span><span class="p">;</span>
					<span class="n">btsp</span><span class="o">-&gt;</span><span class="n">mp</span> <span class="o">=</span> <span class="n">mp</span><span class="p">;</span>

					<span class="cm">/* init sequential access heuristics */</span>
					<span class="n">btindex</span> <span class="o">=</span> <span class="n">jfs_ip</span><span class="o">-&gt;</span><span class="n">btindex</span><span class="p">;</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">index</span> <span class="o">==</span> <span class="n">btindex</span> <span class="o">||</span>
					    <span class="n">index</span> <span class="o">==</span> <span class="n">btindex</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
						<span class="n">jfs_ip</span><span class="o">-&gt;</span><span class="n">btorder</span> <span class="o">=</span> <span class="n">BT_SEQUENTIAL</span><span class="p">;</span>
					<span class="k">else</span>
						<span class="n">jfs_ip</span><span class="o">-&gt;</span><span class="n">btorder</span> <span class="o">=</span> <span class="n">BT_RANDOM</span><span class="p">;</span>
					<span class="n">jfs_ip</span><span class="o">-&gt;</span><span class="n">btindex</span> <span class="o">=</span> <span class="n">index</span><span class="p">;</span>

					<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="cm">/* search hit - internal page:</span>
<span class="cm">				 * descend/search its child page</span>
<span class="cm">				 */</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">index</span> <span class="o">&lt;</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">nextindex</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
					<span class="n">next</span> <span class="o">=</span> <span class="n">offsetXAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">xad</span><span class="p">[</span><span class="n">index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]);</span>
				<span class="k">goto</span> <span class="n">next</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">cmp</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">base</span> <span class="o">=</span> <span class="n">index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
				<span class="o">--</span><span class="n">lim</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="cm">/*</span>
<span class="cm">		 *	search miss</span>
<span class="cm">		 *</span>
<span class="cm">		 * base is the smallest index with key (Kj) greater than</span>
<span class="cm">		 * search key (K) and may be zero or maxentry index.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">base</span> <span class="o">&lt;</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">nextindex</span><span class="p">))</span>
			<span class="n">next</span> <span class="o">=</span> <span class="n">offsetXAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">xad</span><span class="p">[</span><span class="n">base</span><span class="p">]);</span>
		<span class="cm">/*</span>
<span class="cm">		 * search miss - leaf page:</span>
<span class="cm">		 *</span>
<span class="cm">		 * return location of entry (base) where new entry with</span>
<span class="cm">		 * search key K is to be inserted.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">flag</span> <span class="o">&amp;</span> <span class="n">BT_LEAF</span><span class="p">)</span> <span class="p">{</span>
			<span class="o">*</span><span class="n">cmpp</span> <span class="o">=</span> <span class="n">cmp</span><span class="p">;</span>

			<span class="cm">/* compute number of pages to split */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">flag</span> <span class="o">&amp;</span> <span class="n">XT_INSERT</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">nextindex</span> <span class="o">==</span>
				    <span class="n">p</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">maxentry</span><span class="p">)</span>
					<span class="n">nsplit</span><span class="o">++</span><span class="p">;</span>
				<span class="k">else</span>
					<span class="n">nsplit</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">btstack</span><span class="o">-&gt;</span><span class="n">nsplit</span> <span class="o">=</span> <span class="n">nsplit</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="cm">/* save search result */</span>
			<span class="n">btsp</span> <span class="o">=</span> <span class="n">btstack</span><span class="o">-&gt;</span><span class="n">top</span><span class="p">;</span>
			<span class="n">btsp</span><span class="o">-&gt;</span><span class="n">bn</span> <span class="o">=</span> <span class="n">bn</span><span class="p">;</span>
			<span class="n">btsp</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">=</span> <span class="n">base</span><span class="p">;</span>
			<span class="n">btsp</span><span class="o">-&gt;</span><span class="n">mp</span> <span class="o">=</span> <span class="n">mp</span><span class="p">;</span>

			<span class="cm">/* init sequential access heuristics */</span>
			<span class="n">btindex</span> <span class="o">=</span> <span class="n">jfs_ip</span><span class="o">-&gt;</span><span class="n">btindex</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">base</span> <span class="o">==</span> <span class="n">btindex</span> <span class="o">||</span> <span class="n">base</span> <span class="o">==</span> <span class="n">btindex</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
				<span class="n">jfs_ip</span><span class="o">-&gt;</span><span class="n">btorder</span> <span class="o">=</span> <span class="n">BT_SEQUENTIAL</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">jfs_ip</span><span class="o">-&gt;</span><span class="n">btorder</span> <span class="o">=</span> <span class="n">BT_RANDOM</span><span class="p">;</span>
			<span class="n">jfs_ip</span><span class="o">-&gt;</span><span class="n">btindex</span> <span class="o">=</span> <span class="n">base</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">nextp</span><span class="p">)</span>
				<span class="o">*</span><span class="n">nextp</span> <span class="o">=</span> <span class="n">next</span><span class="p">;</span>

			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/*</span>
<span class="cm">		 * search miss - non-leaf page:</span>
<span class="cm">		 *</span>
<span class="cm">		 * if base is non-zero, decrement base by one to get the parent</span>
<span class="cm">		 * entry of the child page to search.</span>
<span class="cm">		 */</span>
		<span class="n">index</span> <span class="o">=</span> <span class="n">base</span> <span class="o">?</span> <span class="n">base</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">:</span> <span class="n">base</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * go down to child page</span>
<span class="cm">		 */</span>
	      <span class="nl">next:</span>
		<span class="cm">/* update number of pages to split */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">nextindex</span> <span class="o">==</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">maxentry</span><span class="p">)</span>
			<span class="n">nsplit</span><span class="o">++</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">nsplit</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="cm">/* push (bn, index) of the parent page/entry */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">BT_STACK_FULL</span><span class="p">(</span><span class="n">btstack</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">jfs_error</span><span class="p">(</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_sb</span><span class="p">,</span> <span class="s">&quot;stack overrun in xtSearch!&quot;</span><span class="p">);</span>
			<span class="n">XT_PUTPAGE</span><span class="p">(</span><span class="n">mp</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">BT_PUSH</span><span class="p">(</span><span class="n">btstack</span><span class="p">,</span> <span class="n">bn</span><span class="p">,</span> <span class="n">index</span><span class="p">);</span>

		<span class="cm">/* get the child page block number */</span>
		<span class="n">bn</span> <span class="o">=</span> <span class="n">addressXAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">xad</span><span class="p">[</span><span class="n">index</span><span class="p">]);</span>

		<span class="cm">/* unpin the parent page */</span>
		<span class="n">XT_PUTPAGE</span><span class="p">(</span><span class="n">mp</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *	xtInsert()</span>
<span class="cm"> *</span>
<span class="cm"> * function:</span>
<span class="cm"> *</span>
<span class="cm"> * parameter:</span>
<span class="cm"> *	tid	- transaction id;</span>
<span class="cm"> *	ip	- file object;</span>
<span class="cm"> *	xflag	- extent flag (XAD_NOTRECORDED):</span>
<span class="cm"> *	xoff	- extent offset;</span>
<span class="cm"> *	xlen	- extent length;</span>
<span class="cm"> *	xaddrp	- extent address pointer (in/out):</span>
<span class="cm"> *		if (*xaddrp)</span>
<span class="cm"> *			caller allocated data extent at *xaddrp;</span>
<span class="cm"> *		else</span>
<span class="cm"> *			allocate data extent and return its xaddr;</span>
<span class="cm"> *	flag	-</span>
<span class="cm"> *</span>
<span class="cm"> * return:</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">xtInsert</span><span class="p">(</span><span class="n">tid_t</span> <span class="n">tid</span><span class="p">,</span>		<span class="cm">/* transaction id */</span>
	     <span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">ip</span><span class="p">,</span> <span class="kt">int</span> <span class="n">xflag</span><span class="p">,</span> <span class="n">s64</span> <span class="n">xoff</span><span class="p">,</span> <span class="n">s32</span> <span class="n">xlen</span><span class="p">,</span> <span class="n">s64</span> <span class="o">*</span> <span class="n">xaddrp</span><span class="p">,</span>
	     <span class="kt">int</span> <span class="n">flag</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">s64</span> <span class="n">xaddr</span><span class="p">,</span> <span class="n">hint</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">metapage</span> <span class="o">*</span><span class="n">mp</span><span class="p">;</span>	<span class="cm">/* meta-page buffer */</span>
	<span class="n">xtpage_t</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>		<span class="cm">/* base B+-tree index page */</span>
	<span class="n">s64</span> <span class="n">bn</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">index</span><span class="p">,</span> <span class="n">nextindex</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">btstack</span> <span class="n">btstack</span><span class="p">;</span>	<span class="cm">/* traverse stack */</span>
	<span class="k">struct</span> <span class="n">xtsplit</span> <span class="n">split</span><span class="p">;</span>	<span class="cm">/* split information */</span>
	<span class="n">xad_t</span> <span class="o">*</span><span class="n">xad</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">cmp</span><span class="p">;</span>
	<span class="n">s64</span> <span class="n">next</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tlock</span> <span class="o">*</span><span class="n">tlck</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">xtlock</span> <span class="o">*</span><span class="n">xtlck</span><span class="p">;</span>

	<span class="n">jfs_info</span><span class="p">(</span><span class="s">&quot;xtInsert: nxoff:0x%lx nxlen:0x%x&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">ulong</span><span class="p">)</span> <span class="n">xoff</span><span class="p">,</span> <span class="n">xlen</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 *	search for the entry location at which to insert:</span>
<span class="cm">	 *</span>
<span class="cm">	 * xtFastSearch() and xtSearch() both returns (leaf page</span>
<span class="cm">	 * pinned, index at which to insert).</span>
<span class="cm">	 * n.b. xtSearch() may return index of maxentry of</span>
<span class="cm">	 * the full page.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">rc</span> <span class="o">=</span> <span class="n">xtSearch</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">xoff</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">next</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">btstack</span><span class="p">,</span> <span class="n">XT_INSERT</span><span class="p">)))</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

	<span class="cm">/* retrieve search result */</span>
	<span class="n">XT_GETSEARCH</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">btstack</span><span class="p">.</span><span class="n">top</span><span class="p">,</span> <span class="n">bn</span><span class="p">,</span> <span class="n">mp</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">index</span><span class="p">);</span>

	<span class="cm">/* This test must follow XT_GETSEARCH since mp must be valid if</span>
<span class="cm">	 * we branch to out: */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">cmp</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">next</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">xlen</span> <span class="o">&gt;</span> <span class="n">next</span> <span class="o">-</span> <span class="n">xoff</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EEXIST</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * allocate data extent requested</span>
<span class="cm">	 *</span>
<span class="cm">	 * allocation hint: last xad</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">xaddr</span> <span class="o">=</span> <span class="o">*</span><span class="n">xaddrp</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">index</span> <span class="o">&gt;</span> <span class="n">XTENTRYSTART</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">xad</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">xad</span><span class="p">[</span><span class="n">index</span> <span class="o">-</span> <span class="mi">1</span><span class="p">];</span>
			<span class="n">hint</span> <span class="o">=</span> <span class="n">addressXAD</span><span class="p">(</span><span class="n">xad</span><span class="p">)</span> <span class="o">+</span> <span class="n">lengthXAD</span><span class="p">(</span><span class="n">xad</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">hint</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">rc</span> <span class="o">=</span> <span class="n">dquot_alloc_block</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">xlen</span><span class="p">)))</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">rc</span> <span class="o">=</span> <span class="n">dbAlloc</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">hint</span><span class="p">,</span> <span class="p">(</span><span class="n">s64</span><span class="p">)</span> <span class="n">xlen</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">xaddr</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">dquot_free_block</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">xlen</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 *	insert entry for new extent</span>
<span class="cm">	 */</span>
	<span class="n">xflag</span> <span class="o">|=</span> <span class="n">XAD_NEW</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 *	if the leaf page is full, split the page and</span>
<span class="cm">	 *	propagate up the router entry for the new page from split</span>
<span class="cm">	 *</span>
<span class="cm">	 * The xtSplitUp() will insert the entry and unpin the leaf page.</span>
<span class="cm">	 */</span>
	<span class="n">nextindex</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">nextindex</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nextindex</span> <span class="o">==</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">maxentry</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">split</span><span class="p">.</span><span class="n">mp</span> <span class="o">=</span> <span class="n">mp</span><span class="p">;</span>
		<span class="n">split</span><span class="p">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">index</span><span class="p">;</span>
		<span class="n">split</span><span class="p">.</span><span class="n">flag</span> <span class="o">=</span> <span class="n">xflag</span><span class="p">;</span>
		<span class="n">split</span><span class="p">.</span><span class="n">off</span> <span class="o">=</span> <span class="n">xoff</span><span class="p">;</span>
		<span class="n">split</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="n">xlen</span><span class="p">;</span>
		<span class="n">split</span><span class="p">.</span><span class="n">addr</span> <span class="o">=</span> <span class="n">xaddr</span><span class="p">;</span>
		<span class="n">split</span><span class="p">.</span><span class="n">pxdlist</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">rc</span> <span class="o">=</span> <span class="n">xtSplitUp</span><span class="p">(</span><span class="n">tid</span><span class="p">,</span> <span class="n">ip</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">split</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">btstack</span><span class="p">)))</span> <span class="p">{</span>
			<span class="cm">/* undo data extent allocation */</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">xaddrp</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">dbFree</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">xaddr</span><span class="p">,</span> <span class="p">(</span><span class="n">s64</span><span class="p">)</span> <span class="n">xlen</span><span class="p">);</span>
				<span class="n">dquot_free_block</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">xlen</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="o">*</span><span class="n">xaddrp</span> <span class="o">=</span> <span class="n">xaddr</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 *	insert the new entry into the leaf page</span>
<span class="cm">	 */</span>
	<span class="cm">/*</span>
<span class="cm">	 * acquire a transaction lock on the leaf page;</span>
<span class="cm">	 *</span>
<span class="cm">	 * action: xad insertion/extension;</span>
<span class="cm">	 */</span>
	<span class="n">BT_MARK_DIRTY</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="n">ip</span><span class="p">);</span>

	<span class="cm">/* if insert into middle, shift right remaining entries. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">index</span> <span class="o">&lt;</span> <span class="n">nextindex</span><span class="p">)</span>
		<span class="n">memmove</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">xad</span><span class="p">[</span><span class="n">index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">xad</span><span class="p">[</span><span class="n">index</span><span class="p">],</span>
			<span class="p">(</span><span class="n">nextindex</span> <span class="o">-</span> <span class="n">index</span><span class="p">)</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">xad_t</span><span class="p">));</span>

	<span class="cm">/* insert the new entry: mark the entry NEW */</span>
	<span class="n">xad</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">xad</span><span class="p">[</span><span class="n">index</span><span class="p">];</span>
	<span class="n">XT_PUTENTRY</span><span class="p">(</span><span class="n">xad</span><span class="p">,</span> <span class="n">xflag</span><span class="p">,</span> <span class="n">xoff</span><span class="p">,</span> <span class="n">xlen</span><span class="p">,</span> <span class="n">xaddr</span><span class="p">);</span>

	<span class="cm">/* advance next available entry index */</span>
	<span class="n">le16_add_cpu</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">nextindex</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="cm">/* Don&#39;t log it if there are no links to the file */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_cflag</span><span class="p">(</span><span class="n">COMMIT_Nolink</span><span class="p">,</span> <span class="n">ip</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">tlck</span> <span class="o">=</span> <span class="n">txLock</span><span class="p">(</span><span class="n">tid</span><span class="p">,</span> <span class="n">ip</span><span class="p">,</span> <span class="n">mp</span><span class="p">,</span> <span class="n">tlckXTREE</span> <span class="o">|</span> <span class="n">tlckGROW</span><span class="p">);</span>
		<span class="n">xtlck</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">xtlock</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">tlck</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">;</span>
		<span class="n">xtlck</span><span class="o">-&gt;</span><span class="n">lwm</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span>
		    <span class="p">(</span><span class="n">xtlck</span><span class="o">-&gt;</span><span class="n">lwm</span><span class="p">.</span><span class="n">offset</span><span class="p">)</span> <span class="o">?</span> <span class="n">min</span><span class="p">(</span><span class="n">index</span><span class="p">,</span>
					      <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">xtlck</span><span class="o">-&gt;</span><span class="n">lwm</span><span class="p">.</span><span class="n">offset</span><span class="p">)</span> <span class="o">:</span> <span class="n">index</span><span class="p">;</span>
		<span class="n">xtlck</span><span class="o">-&gt;</span><span class="n">lwm</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span>
		    <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">nextindex</span><span class="p">)</span> <span class="o">-</span> <span class="n">xtlck</span><span class="o">-&gt;</span><span class="n">lwm</span><span class="p">.</span><span class="n">offset</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="o">*</span><span class="n">xaddrp</span> <span class="o">=</span> <span class="n">xaddr</span><span class="p">;</span>

      <span class="nl">out:</span>
	<span class="cm">/* unpin the leaf page */</span>
	<span class="n">XT_PUTPAGE</span><span class="p">(</span><span class="n">mp</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> *	xtSplitUp()</span>
<span class="cm"> *</span>
<span class="cm"> * function:</span>
<span class="cm"> *	split full pages as propagating insertion up the tree</span>
<span class="cm"> *</span>
<span class="cm"> * parameter:</span>
<span class="cm"> *	tid	- transaction id;</span>
<span class="cm"> *	ip	- file object;</span>
<span class="cm"> *	split	- entry parameter descriptor;</span>
<span class="cm"> *	btstack - traverse stack from xtSearch()</span>
<span class="cm"> *</span>
<span class="cm"> * return:</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">xtSplitUp</span><span class="p">(</span><span class="n">tid_t</span> <span class="n">tid</span><span class="p">,</span>
	  <span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">ip</span><span class="p">,</span> <span class="k">struct</span> <span class="n">xtsplit</span> <span class="o">*</span> <span class="n">split</span><span class="p">,</span> <span class="k">struct</span> <span class="n">btstack</span> <span class="o">*</span> <span class="n">btstack</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">metapage</span> <span class="o">*</span><span class="n">smp</span><span class="p">;</span>
	<span class="n">xtpage_t</span> <span class="o">*</span><span class="n">sp</span><span class="p">;</span>		<span class="cm">/* split page */</span>
	<span class="k">struct</span> <span class="n">metapage</span> <span class="o">*</span><span class="n">rmp</span><span class="p">;</span>
	<span class="n">s64</span> <span class="n">rbn</span><span class="p">;</span>		<span class="cm">/* new right page block number */</span>
	<span class="k">struct</span> <span class="n">metapage</span> <span class="o">*</span><span class="n">rcmp</span><span class="p">;</span>
	<span class="n">xtpage_t</span> <span class="o">*</span><span class="n">rcp</span><span class="p">;</span>		<span class="cm">/* right child page */</span>
	<span class="n">s64</span> <span class="n">rcbn</span><span class="p">;</span>		<span class="cm">/* right child page block number */</span>
	<span class="kt">int</span> <span class="n">skip</span><span class="p">;</span>		<span class="cm">/* index of entry of insertion */</span>
	<span class="kt">int</span> <span class="n">nextindex</span><span class="p">;</span>		<span class="cm">/* next available entry index of p */</span>
	<span class="k">struct</span> <span class="n">btframe</span> <span class="o">*</span><span class="n">parent</span><span class="p">;</span>	<span class="cm">/* parent page entry on traverse stack */</span>
	<span class="n">xad_t</span> <span class="o">*</span><span class="n">xad</span><span class="p">;</span>
	<span class="n">s64</span> <span class="n">xaddr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">xlen</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">nsplit</span><span class="p">;</span>		<span class="cm">/* number of pages split */</span>
	<span class="k">struct</span> <span class="n">pxdlist</span> <span class="n">pxdlist</span><span class="p">;</span>
	<span class="n">pxd_t</span> <span class="o">*</span><span class="n">pxd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tlock</span> <span class="o">*</span><span class="n">tlck</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">xtlock</span> <span class="o">*</span><span class="n">xtlck</span><span class="p">;</span>

	<span class="n">smp</span> <span class="o">=</span> <span class="n">split</span><span class="o">-&gt;</span><span class="n">mp</span><span class="p">;</span>
	<span class="n">sp</span> <span class="o">=</span> <span class="n">XT_PAGE</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">smp</span><span class="p">);</span>

	<span class="cm">/* is inode xtree root extension/inline EA area free ? */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">flag</span> <span class="o">&amp;</span> <span class="n">BT_ROOT</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="o">!</span><span class="n">S_ISDIR</span><span class="p">(</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_mode</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">maxentry</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">XTROOTMAXSLOT</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">JFS_IP</span><span class="p">(</span><span class="n">ip</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">mode2</span> <span class="o">&amp;</span> <span class="n">INLINEEA</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">sp</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">maxentry</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">XTROOTMAXSLOT</span><span class="p">);</span>
		<span class="n">JFS_IP</span><span class="p">(</span><span class="n">ip</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">mode2</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">INLINEEA</span><span class="p">;</span>

		<span class="n">BT_MARK_DIRTY</span><span class="p">(</span><span class="n">smp</span><span class="p">,</span> <span class="n">ip</span><span class="p">);</span>
		<span class="cm">/*</span>
<span class="cm">		 * acquire a transaction lock on the leaf page;</span>
<span class="cm">		 *</span>
<span class="cm">		 * action: xad insertion/extension;</span>
<span class="cm">		 */</span>

		<span class="cm">/* if insert into middle, shift right remaining entries. */</span>
		<span class="n">skip</span> <span class="o">=</span> <span class="n">split</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">;</span>
		<span class="n">nextindex</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">nextindex</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">skip</span> <span class="o">&lt;</span> <span class="n">nextindex</span><span class="p">)</span>
			<span class="n">memmove</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">xad</span><span class="p">[</span><span class="n">skip</span> <span class="o">+</span> <span class="mi">1</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">xad</span><span class="p">[</span><span class="n">skip</span><span class="p">],</span>
				<span class="p">(</span><span class="n">nextindex</span> <span class="o">-</span> <span class="n">skip</span><span class="p">)</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">xad_t</span><span class="p">));</span>

		<span class="cm">/* insert the new entry: mark the entry NEW */</span>
		<span class="n">xad</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">xad</span><span class="p">[</span><span class="n">skip</span><span class="p">];</span>
		<span class="n">XT_PUTENTRY</span><span class="p">(</span><span class="n">xad</span><span class="p">,</span> <span class="n">split</span><span class="o">-&gt;</span><span class="n">flag</span><span class="p">,</span> <span class="n">split</span><span class="o">-&gt;</span><span class="n">off</span><span class="p">,</span> <span class="n">split</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span>
			    <span class="n">split</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">);</span>

		<span class="cm">/* advance next available entry index */</span>
		<span class="n">le16_add_cpu</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">nextindex</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

		<span class="cm">/* Don&#39;t log it if there are no links to the file */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_cflag</span><span class="p">(</span><span class="n">COMMIT_Nolink</span><span class="p">,</span> <span class="n">ip</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">tlck</span> <span class="o">=</span> <span class="n">txLock</span><span class="p">(</span><span class="n">tid</span><span class="p">,</span> <span class="n">ip</span><span class="p">,</span> <span class="n">smp</span><span class="p">,</span> <span class="n">tlckXTREE</span> <span class="o">|</span> <span class="n">tlckGROW</span><span class="p">);</span>
			<span class="n">xtlck</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">xtlock</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">tlck</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">;</span>
			<span class="n">xtlck</span><span class="o">-&gt;</span><span class="n">lwm</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="p">(</span><span class="n">xtlck</span><span class="o">-&gt;</span><span class="n">lwm</span><span class="p">.</span><span class="n">offset</span><span class="p">)</span> <span class="o">?</span>
			    <span class="n">min</span><span class="p">(</span><span class="n">skip</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">xtlck</span><span class="o">-&gt;</span><span class="n">lwm</span><span class="p">.</span><span class="n">offset</span><span class="p">)</span> <span class="o">:</span> <span class="n">skip</span><span class="p">;</span>
			<span class="n">xtlck</span><span class="o">-&gt;</span><span class="n">lwm</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span>
			    <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">nextindex</span><span class="p">)</span> <span class="o">-</span>
			    <span class="n">xtlck</span><span class="o">-&gt;</span><span class="n">lwm</span><span class="p">.</span><span class="n">offset</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * allocate new index blocks to cover index page split(s)</span>
<span class="cm">	 *</span>
<span class="cm">	 * allocation hint: ?</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">split</span><span class="o">-&gt;</span><span class="n">pxdlist</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">nsplit</span> <span class="o">=</span> <span class="n">btstack</span><span class="o">-&gt;</span><span class="n">nsplit</span><span class="p">;</span>
		<span class="n">split</span><span class="o">-&gt;</span><span class="n">pxdlist</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pxdlist</span><span class="p">;</span>
		<span class="n">pxdlist</span><span class="p">.</span><span class="n">maxnpxd</span> <span class="o">=</span> <span class="n">pxdlist</span><span class="p">.</span><span class="n">npxd</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">pxd</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pxdlist</span><span class="p">.</span><span class="n">pxd</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
		<span class="n">xlen</span> <span class="o">=</span> <span class="n">JFS_SBI</span><span class="p">(</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_sb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">nbperpage</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(;</span> <span class="n">nsplit</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">;</span> <span class="n">nsplit</span><span class="o">--</span><span class="p">,</span> <span class="n">pxd</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">rc</span> <span class="o">=</span> <span class="n">dbAlloc</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="p">(</span><span class="n">s64</span><span class="p">)</span> <span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="n">s64</span><span class="p">)</span> <span class="n">xlen</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">xaddr</span><span class="p">))</span>
			    <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">PXDaddress</span><span class="p">(</span><span class="n">pxd</span><span class="p">,</span> <span class="n">xaddr</span><span class="p">);</span>
				<span class="n">PXDlength</span><span class="p">(</span><span class="n">pxd</span><span class="p">,</span> <span class="n">xlen</span><span class="p">);</span>

				<span class="n">pxdlist</span><span class="p">.</span><span class="n">maxnpxd</span><span class="o">++</span><span class="p">;</span>

				<span class="k">continue</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="cm">/* undo allocation */</span>

			<span class="n">XT_PUTPAGE</span><span class="p">(</span><span class="n">smp</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Split leaf page &lt;sp&gt; into &lt;sp&gt; and a new right page &lt;rp&gt;.</span>
<span class="cm">	 *</span>
<span class="cm">	 * The split routines insert the new entry into the leaf page,</span>
<span class="cm">	 * and acquire txLock as appropriate.</span>
<span class="cm">	 * return &lt;rp&gt; pinned and its block number &lt;rpbn&gt;.</span>
<span class="cm">	 */</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="p">(</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">flag</span> <span class="o">&amp;</span> <span class="n">BT_ROOT</span><span class="p">)</span> <span class="o">?</span>
	    <span class="n">xtSplitRoot</span><span class="p">(</span><span class="n">tid</span><span class="p">,</span> <span class="n">ip</span><span class="p">,</span> <span class="n">split</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rmp</span><span class="p">)</span> <span class="o">:</span>
	    <span class="n">xtSplitPage</span><span class="p">(</span><span class="n">tid</span><span class="p">,</span> <span class="n">ip</span><span class="p">,</span> <span class="n">split</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rmp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rbn</span><span class="p">);</span>

	<span class="n">XT_PUTPAGE</span><span class="p">(</span><span class="n">smp</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * propagate up the router entry for the leaf page just split</span>
<span class="cm">	 *</span>
<span class="cm">	 * insert a router entry for the new page into the parent page,</span>
<span class="cm">	 * propagate the insert/split up the tree by walking back the stack</span>
<span class="cm">	 * of (bn of parent page, index of child page entry in parent page)</span>
<span class="cm">	 * that were traversed during the search for the page that split.</span>
<span class="cm">	 *</span>
<span class="cm">	 * the propagation of insert/split up the tree stops if the root</span>
<span class="cm">	 * splits or the page inserted into doesn&#39;t have to split to hold</span>
<span class="cm">	 * the new entry.</span>
<span class="cm">	 *</span>
<span class="cm">	 * the parent entry for the split page remains the same, and</span>
<span class="cm">	 * a new entry is inserted at its right with the first key and</span>
<span class="cm">	 * block number of the new right page.</span>
<span class="cm">	 *</span>
<span class="cm">	 * There are a maximum of 3 pages pinned at any time:</span>
<span class="cm">	 * right child, left parent and right parent (when the parent splits)</span>
<span class="cm">	 * to keep the child page pinned while working on the parent.</span>
<span class="cm">	 * make sure that all pins are released at exit.</span>
<span class="cm">	 */</span>
	<span class="k">while</span> <span class="p">((</span><span class="n">parent</span> <span class="o">=</span> <span class="n">BT_POP</span><span class="p">(</span><span class="n">btstack</span><span class="p">))</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* parent page specified by stack frame &lt;parent&gt; */</span>

		<span class="cm">/* keep current child pages &lt;rcp&gt; pinned */</span>
		<span class="n">rcmp</span> <span class="o">=</span> <span class="n">rmp</span><span class="p">;</span>
		<span class="n">rcbn</span> <span class="o">=</span> <span class="n">rbn</span><span class="p">;</span>
		<span class="n">rcp</span> <span class="o">=</span> <span class="n">XT_PAGE</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">rcmp</span><span class="p">);</span>

		<span class="cm">/*</span>
<span class="cm">		 * insert router entry in parent for new right child page &lt;rp&gt;</span>
<span class="cm">		 */</span>
		<span class="cm">/* get/pin the parent page &lt;sp&gt; */</span>
		<span class="n">XT_GETPAGE</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">parent</span><span class="o">-&gt;</span><span class="n">bn</span><span class="p">,</span> <span class="n">smp</span><span class="p">,</span> <span class="n">PSIZE</span><span class="p">,</span> <span class="n">sp</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">XT_PUTPAGE</span><span class="p">(</span><span class="n">rcmp</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/*</span>
<span class="cm">		 * The new key entry goes ONE AFTER the index of parent entry,</span>
<span class="cm">		 * because the split was to the right.</span>
<span class="cm">		 */</span>
		<span class="n">skip</span> <span class="o">=</span> <span class="n">parent</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * split or shift right remaining entries of the parent page</span>
<span class="cm">		 */</span>
		<span class="n">nextindex</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">nextindex</span><span class="p">);</span>
		<span class="cm">/*</span>
<span class="cm">		 * parent page is full - split the parent page</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">nextindex</span> <span class="o">==</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">maxentry</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* init for parent page split */</span>
			<span class="n">split</span><span class="o">-&gt;</span><span class="n">mp</span> <span class="o">=</span> <span class="n">smp</span><span class="p">;</span>
			<span class="n">split</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">=</span> <span class="n">skip</span><span class="p">;</span>	<span class="cm">/* index at insert */</span>
			<span class="n">split</span><span class="o">-&gt;</span><span class="n">flag</span> <span class="o">=</span> <span class="n">XAD_NEW</span><span class="p">;</span>
			<span class="n">split</span><span class="o">-&gt;</span><span class="n">off</span> <span class="o">=</span> <span class="n">offsetXAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rcp</span><span class="o">-&gt;</span><span class="n">xad</span><span class="p">[</span><span class="n">XTENTRYSTART</span><span class="p">]);</span>
			<span class="n">split</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="n">JFS_SBI</span><span class="p">(</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_sb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">nbperpage</span><span class="p">;</span>
			<span class="n">split</span><span class="o">-&gt;</span><span class="n">addr</span> <span class="o">=</span> <span class="n">rcbn</span><span class="p">;</span>

			<span class="cm">/* unpin previous right child page */</span>
			<span class="n">XT_PUTPAGE</span><span class="p">(</span><span class="n">rcmp</span><span class="p">);</span>

			<span class="cm">/* The split routines insert the new entry,</span>
<span class="cm">			 * and acquire txLock as appropriate.</span>
<span class="cm">			 * return &lt;rp&gt; pinned and its block number &lt;rpbn&gt;.</span>
<span class="cm">			 */</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="p">(</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">flag</span> <span class="o">&amp;</span> <span class="n">BT_ROOT</span><span class="p">)</span> <span class="o">?</span>
			    <span class="n">xtSplitRoot</span><span class="p">(</span><span class="n">tid</span><span class="p">,</span> <span class="n">ip</span><span class="p">,</span> <span class="n">split</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rmp</span><span class="p">)</span> <span class="o">:</span>
			    <span class="n">xtSplitPage</span><span class="p">(</span><span class="n">tid</span><span class="p">,</span> <span class="n">ip</span><span class="p">,</span> <span class="n">split</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rmp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rbn</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">XT_PUTPAGE</span><span class="p">(</span><span class="n">smp</span><span class="p">);</span>
				<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">XT_PUTPAGE</span><span class="p">(</span><span class="n">smp</span><span class="p">);</span>
			<span class="cm">/* keep new child page &lt;rp&gt; pinned */</span>
		<span class="p">}</span>
		<span class="cm">/*</span>
<span class="cm">		 * parent page is not full - insert in parent page</span>
<span class="cm">		 */</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * insert router entry in parent for the right child</span>
<span class="cm">			 * page from the first entry of the right child page:</span>
<span class="cm">			 */</span>
			<span class="cm">/*</span>
<span class="cm">			 * acquire a transaction lock on the parent page;</span>
<span class="cm">			 *</span>
<span class="cm">			 * action: router xad insertion;</span>
<span class="cm">			 */</span>
			<span class="n">BT_MARK_DIRTY</span><span class="p">(</span><span class="n">smp</span><span class="p">,</span> <span class="n">ip</span><span class="p">);</span>

			<span class="cm">/*</span>
<span class="cm">			 * if insert into middle, shift right remaining entries</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">skip</span> <span class="o">&lt;</span> <span class="n">nextindex</span><span class="p">)</span>
				<span class="n">memmove</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">xad</span><span class="p">[</span><span class="n">skip</span> <span class="o">+</span> <span class="mi">1</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">xad</span><span class="p">[</span><span class="n">skip</span><span class="p">],</span>
					<span class="p">(</span><span class="n">nextindex</span> <span class="o">-</span>
					 <span class="n">skip</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">L2XTSLOTSIZE</span><span class="p">);</span>

			<span class="cm">/* insert the router entry */</span>
			<span class="n">xad</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">xad</span><span class="p">[</span><span class="n">skip</span><span class="p">];</span>
			<span class="n">XT_PUTENTRY</span><span class="p">(</span><span class="n">xad</span><span class="p">,</span> <span class="n">XAD_NEW</span><span class="p">,</span>
				    <span class="n">offsetXAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rcp</span><span class="o">-&gt;</span><span class="n">xad</span><span class="p">[</span><span class="n">XTENTRYSTART</span><span class="p">]),</span>
				    <span class="n">JFS_SBI</span><span class="p">(</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_sb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">nbperpage</span><span class="p">,</span> <span class="n">rcbn</span><span class="p">);</span>

			<span class="cm">/* advance next available entry index. */</span>
			<span class="n">le16_add_cpu</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">nextindex</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

			<span class="cm">/* Don&#39;t log it if there are no links to the file */</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_cflag</span><span class="p">(</span><span class="n">COMMIT_Nolink</span><span class="p">,</span> <span class="n">ip</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">tlck</span> <span class="o">=</span> <span class="n">txLock</span><span class="p">(</span><span class="n">tid</span><span class="p">,</span> <span class="n">ip</span><span class="p">,</span> <span class="n">smp</span><span class="p">,</span>
					      <span class="n">tlckXTREE</span> <span class="o">|</span> <span class="n">tlckGROW</span><span class="p">);</span>
				<span class="n">xtlck</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">xtlock</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">tlck</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">;</span>
				<span class="n">xtlck</span><span class="o">-&gt;</span><span class="n">lwm</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="p">(</span><span class="n">xtlck</span><span class="o">-&gt;</span><span class="n">lwm</span><span class="p">.</span><span class="n">offset</span><span class="p">)</span> <span class="o">?</span>
				    <span class="n">min</span><span class="p">(</span><span class="n">skip</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">xtlck</span><span class="o">-&gt;</span><span class="n">lwm</span><span class="p">.</span><span class="n">offset</span><span class="p">)</span> <span class="o">:</span> <span class="n">skip</span><span class="p">;</span>
				<span class="n">xtlck</span><span class="o">-&gt;</span><span class="n">lwm</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span>
				    <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">nextindex</span><span class="p">)</span> <span class="o">-</span>
				    <span class="n">xtlck</span><span class="o">-&gt;</span><span class="n">lwm</span><span class="p">.</span><span class="n">offset</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="cm">/* unpin parent page */</span>
			<span class="n">XT_PUTPAGE</span><span class="p">(</span><span class="n">smp</span><span class="p">);</span>

			<span class="cm">/* exit propagate up */</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* unpin current right page */</span>
	<span class="n">XT_PUTPAGE</span><span class="p">(</span><span class="n">rmp</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> *	xtSplitPage()</span>
<span class="cm"> *</span>
<span class="cm"> * function:</span>
<span class="cm"> *	split a full non-root page into</span>
<span class="cm"> *	original/split/left page and new right page</span>
<span class="cm"> *	i.e., the original/split page remains as left page.</span>
<span class="cm"> *</span>
<span class="cm"> * parameter:</span>
<span class="cm"> *	int		tid,</span>
<span class="cm"> *	struct inode	*ip,</span>
<span class="cm"> *	struct xtsplit	*split,</span>
<span class="cm"> *	struct metapage	**rmpp,</span>
<span class="cm"> *	u64		*rbnp,</span>
<span class="cm"> *</span>
<span class="cm"> * return:</span>
<span class="cm"> *	Pointer to page in which to insert or NULL on error.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">xtSplitPage</span><span class="p">(</span><span class="n">tid_t</span> <span class="n">tid</span><span class="p">,</span> <span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">ip</span><span class="p">,</span>
	    <span class="k">struct</span> <span class="n">xtsplit</span> <span class="o">*</span> <span class="n">split</span><span class="p">,</span> <span class="k">struct</span> <span class="n">metapage</span> <span class="o">**</span> <span class="n">rmpp</span><span class="p">,</span> <span class="n">s64</span> <span class="o">*</span> <span class="n">rbnp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">metapage</span> <span class="o">*</span><span class="n">smp</span><span class="p">;</span>
	<span class="n">xtpage_t</span> <span class="o">*</span><span class="n">sp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">metapage</span> <span class="o">*</span><span class="n">rmp</span><span class="p">;</span>
	<span class="n">xtpage_t</span> <span class="o">*</span><span class="n">rp</span><span class="p">;</span>		<span class="cm">/* new right page allocated */</span>
	<span class="n">s64</span> <span class="n">rbn</span><span class="p">;</span>		<span class="cm">/* new right page block number */</span>
	<span class="k">struct</span> <span class="n">metapage</span> <span class="o">*</span><span class="n">mp</span><span class="p">;</span>
	<span class="n">xtpage_t</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
	<span class="n">s64</span> <span class="n">nextbn</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">skip</span><span class="p">,</span> <span class="n">maxentry</span><span class="p">,</span> <span class="n">middle</span><span class="p">,</span> <span class="n">righthalf</span><span class="p">,</span> <span class="n">n</span><span class="p">;</span>
	<span class="n">xad_t</span> <span class="o">*</span><span class="n">xad</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pxdlist</span> <span class="o">*</span><span class="n">pxdlist</span><span class="p">;</span>
	<span class="n">pxd_t</span> <span class="o">*</span><span class="n">pxd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tlock</span> <span class="o">*</span><span class="n">tlck</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">xtlock</span> <span class="o">*</span><span class="n">sxtlck</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">*</span><span class="n">rxtlck</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">quota_allocation</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">smp</span> <span class="o">=</span> <span class="n">split</span><span class="o">-&gt;</span><span class="n">mp</span><span class="p">;</span>
	<span class="n">sp</span> <span class="o">=</span> <span class="n">XT_PAGE</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">smp</span><span class="p">);</span>

	<span class="n">INCREMENT</span><span class="p">(</span><span class="n">xtStat</span><span class="p">.</span><span class="n">split</span><span class="p">);</span>

	<span class="n">pxdlist</span> <span class="o">=</span> <span class="n">split</span><span class="o">-&gt;</span><span class="n">pxdlist</span><span class="p">;</span>
	<span class="n">pxd</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pxdlist</span><span class="o">-&gt;</span><span class="n">pxd</span><span class="p">[</span><span class="n">pxdlist</span><span class="o">-&gt;</span><span class="n">npxd</span><span class="p">];</span>
	<span class="n">pxdlist</span><span class="o">-&gt;</span><span class="n">npxd</span><span class="o">++</span><span class="p">;</span>
	<span class="n">rbn</span> <span class="o">=</span> <span class="n">addressPXD</span><span class="p">(</span><span class="n">pxd</span><span class="p">);</span>

	<span class="cm">/* Allocate blocks to quota. */</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">dquot_alloc_block</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">lengthPXD</span><span class="p">(</span><span class="n">pxd</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">clean_up</span><span class="p">;</span>

	<span class="n">quota_allocation</span> <span class="o">+=</span> <span class="n">lengthPXD</span><span class="p">(</span><span class="n">pxd</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * allocate the new right page for the split</span>
<span class="cm">	 */</span>
	<span class="n">rmp</span> <span class="o">=</span> <span class="n">get_metapage</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">rbn</span><span class="p">,</span> <span class="n">PSIZE</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rmp</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">clean_up</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">jfs_info</span><span class="p">(</span><span class="s">&quot;xtSplitPage: ip:0x%p smp:0x%p rmp:0x%p&quot;</span><span class="p">,</span> <span class="n">ip</span><span class="p">,</span> <span class="n">smp</span><span class="p">,</span> <span class="n">rmp</span><span class="p">);</span>

	<span class="n">BT_MARK_DIRTY</span><span class="p">(</span><span class="n">rmp</span><span class="p">,</span> <span class="n">ip</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 * action: new page;</span>
<span class="cm">	 */</span>

	<span class="n">rp</span> <span class="o">=</span> <span class="p">(</span><span class="n">xtpage_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">rmp</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="n">rp</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">self</span> <span class="o">=</span> <span class="o">*</span><span class="n">pxd</span><span class="p">;</span>
	<span class="n">rp</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">flag</span> <span class="o">=</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">flag</span> <span class="o">&amp;</span> <span class="n">BT_TYPE</span><span class="p">;</span>
	<span class="n">rp</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">maxentry</span> <span class="o">=</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">maxentry</span><span class="p">;</span>	<span class="cm">/* little-endian */</span>
	<span class="n">rp</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">nextindex</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">XTENTRYSTART</span><span class="p">);</span>

	<span class="n">BT_MARK_DIRTY</span><span class="p">(</span><span class="n">smp</span><span class="p">,</span> <span class="n">ip</span><span class="p">);</span>
	<span class="cm">/* Don&#39;t log it if there are no links to the file */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_cflag</span><span class="p">(</span><span class="n">COMMIT_Nolink</span><span class="p">,</span> <span class="n">ip</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * acquire a transaction lock on the new right page;</span>
<span class="cm">		 */</span>
		<span class="n">tlck</span> <span class="o">=</span> <span class="n">txLock</span><span class="p">(</span><span class="n">tid</span><span class="p">,</span> <span class="n">ip</span><span class="p">,</span> <span class="n">rmp</span><span class="p">,</span> <span class="n">tlckXTREE</span> <span class="o">|</span> <span class="n">tlckNEW</span><span class="p">);</span>
		<span class="n">rxtlck</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">xtlock</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">tlck</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">;</span>
		<span class="n">rxtlck</span><span class="o">-&gt;</span><span class="n">lwm</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="n">XTENTRYSTART</span><span class="p">;</span>
		<span class="cm">/*</span>
<span class="cm">		 * acquire a transaction lock on the split page</span>
<span class="cm">		 */</span>
		<span class="n">tlck</span> <span class="o">=</span> <span class="n">txLock</span><span class="p">(</span><span class="n">tid</span><span class="p">,</span> <span class="n">ip</span><span class="p">,</span> <span class="n">smp</span><span class="p">,</span> <span class="n">tlckXTREE</span> <span class="o">|</span> <span class="n">tlckGROW</span><span class="p">);</span>
		<span class="n">sxtlck</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">xtlock</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">tlck</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * initialize/update sibling pointers of &lt;sp&gt; and &lt;rp&gt;</span>
<span class="cm">	 */</span>
	<span class="n">nextbn</span> <span class="o">=</span> <span class="n">le64_to_cpu</span><span class="p">(</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">next</span><span class="p">);</span>
	<span class="n">rp</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">next</span> <span class="o">=</span> <span class="n">cpu_to_le64</span><span class="p">(</span><span class="n">nextbn</span><span class="p">);</span>
	<span class="n">rp</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">prev</span> <span class="o">=</span> <span class="n">cpu_to_le64</span><span class="p">(</span><span class="n">addressPXD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">self</span><span class="p">));</span>
	<span class="n">sp</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">next</span> <span class="o">=</span> <span class="n">cpu_to_le64</span><span class="p">(</span><span class="n">rbn</span><span class="p">);</span>

	<span class="n">skip</span> <span class="o">=</span> <span class="n">split</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 *	sequential append at tail (after last entry of last page)</span>
<span class="cm">	 *</span>
<span class="cm">	 * if splitting the last page on a level because of appending</span>
<span class="cm">	 * a entry to it (skip is maxentry), it&#39;s likely that the access is</span>
<span class="cm">	 * sequential. adding an empty page on the side of the level is less</span>
<span class="cm">	 * work and can push the fill factor much higher than normal.</span>
<span class="cm">	 * if we&#39;re wrong it&#39;s no big deal -  we will do the split the right</span>
<span class="cm">	 * way next time.</span>
<span class="cm">	 * (it may look like it&#39;s equally easy to do a similar hack for</span>
<span class="cm">	 * reverse sorted data, that is, split the tree left, but it&#39;s not.</span>
<span class="cm">	 * Be my guest.)</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nextbn</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">skip</span> <span class="o">==</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">maxentry</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * acquire a transaction lock on the new/right page;</span>
<span class="cm">		 *</span>
<span class="cm">		 * action: xad insertion;</span>
<span class="cm">		 */</span>
		<span class="cm">/* insert entry at the first entry of the new right page */</span>
		<span class="n">xad</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">rp</span><span class="o">-&gt;</span><span class="n">xad</span><span class="p">[</span><span class="n">XTENTRYSTART</span><span class="p">];</span>
		<span class="n">XT_PUTENTRY</span><span class="p">(</span><span class="n">xad</span><span class="p">,</span> <span class="n">split</span><span class="o">-&gt;</span><span class="n">flag</span><span class="p">,</span> <span class="n">split</span><span class="o">-&gt;</span><span class="n">off</span><span class="p">,</span> <span class="n">split</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span>
			    <span class="n">split</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">);</span>

		<span class="n">rp</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">nextindex</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">XTENTRYSTART</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_cflag</span><span class="p">(</span><span class="n">COMMIT_Nolink</span><span class="p">,</span> <span class="n">ip</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* rxtlck-&gt;lwm.offset = XTENTRYSTART; */</span>
			<span class="n">rxtlck</span><span class="o">-&gt;</span><span class="n">lwm</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="o">*</span><span class="n">rmpp</span> <span class="o">=</span> <span class="n">rmp</span><span class="p">;</span>
		<span class="o">*</span><span class="n">rbnp</span> <span class="o">=</span> <span class="n">rbn</span><span class="p">;</span>

		<span class="n">jfs_info</span><span class="p">(</span><span class="s">&quot;xtSplitPage: sp:0x%p rp:0x%p&quot;</span><span class="p">,</span> <span class="n">sp</span><span class="p">,</span> <span class="n">rp</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 *	non-sequential insert (at possibly middle page)</span>
<span class="cm">	 */</span>

	<span class="cm">/*</span>
<span class="cm">	 * update previous pointer of old next/right page of &lt;sp&gt;</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nextbn</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">XT_GETPAGE</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">nextbn</span><span class="p">,</span> <span class="n">mp</span><span class="p">,</span> <span class="n">PSIZE</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">XT_PUTPAGE</span><span class="p">(</span><span class="n">rmp</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">clean_up</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">BT_MARK_DIRTY</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="n">ip</span><span class="p">);</span>
		<span class="cm">/*</span>
<span class="cm">		 * acquire a transaction lock on the next page;</span>
<span class="cm">		 *</span>
<span class="cm">		 * action:sibling pointer update;</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_cflag</span><span class="p">(</span><span class="n">COMMIT_Nolink</span><span class="p">,</span> <span class="n">ip</span><span class="p">))</span>
			<span class="n">tlck</span> <span class="o">=</span> <span class="n">txLock</span><span class="p">(</span><span class="n">tid</span><span class="p">,</span> <span class="n">ip</span><span class="p">,</span> <span class="n">mp</span><span class="p">,</span> <span class="n">tlckXTREE</span> <span class="o">|</span> <span class="n">tlckRELINK</span><span class="p">);</span>

		<span class="n">p</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">prev</span> <span class="o">=</span> <span class="n">cpu_to_le64</span><span class="p">(</span><span class="n">rbn</span><span class="p">);</span>

		<span class="cm">/* sibling page may have been updated previously, or</span>
<span class="cm">		 * it may be updated later;</span>
<span class="cm">		 */</span>

		<span class="n">XT_PUTPAGE</span><span class="p">(</span><span class="n">mp</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * split the data between the split and new/right pages</span>
<span class="cm">	 */</span>
	<span class="n">maxentry</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">maxentry</span><span class="p">);</span>
	<span class="n">middle</span> <span class="o">=</span> <span class="n">maxentry</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">righthalf</span> <span class="o">=</span> <span class="n">maxentry</span> <span class="o">-</span> <span class="n">middle</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * skip index in old split/left page - insert into left page:</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">skip</span> <span class="o">&lt;=</span> <span class="n">middle</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* move right half of split page to the new right page */</span>
		<span class="n">memmove</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rp</span><span class="o">-&gt;</span><span class="n">xad</span><span class="p">[</span><span class="n">XTENTRYSTART</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">xad</span><span class="p">[</span><span class="n">middle</span><span class="p">],</span>
			<span class="n">righthalf</span> <span class="o">&lt;&lt;</span> <span class="n">L2XTSLOTSIZE</span><span class="p">);</span>

		<span class="cm">/* shift right tail of left half to make room for new entry */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">skip</span> <span class="o">&lt;</span> <span class="n">middle</span><span class="p">)</span>
			<span class="n">memmove</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">xad</span><span class="p">[</span><span class="n">skip</span> <span class="o">+</span> <span class="mi">1</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">xad</span><span class="p">[</span><span class="n">skip</span><span class="p">],</span>
				<span class="p">(</span><span class="n">middle</span> <span class="o">-</span> <span class="n">skip</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">L2XTSLOTSIZE</span><span class="p">);</span>

		<span class="cm">/* insert new entry */</span>
		<span class="n">xad</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">xad</span><span class="p">[</span><span class="n">skip</span><span class="p">];</span>
		<span class="n">XT_PUTENTRY</span><span class="p">(</span><span class="n">xad</span><span class="p">,</span> <span class="n">split</span><span class="o">-&gt;</span><span class="n">flag</span><span class="p">,</span> <span class="n">split</span><span class="o">-&gt;</span><span class="n">off</span><span class="p">,</span> <span class="n">split</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span>
			    <span class="n">split</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">);</span>

		<span class="cm">/* update page header */</span>
		<span class="n">sp</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">nextindex</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">middle</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_cflag</span><span class="p">(</span><span class="n">COMMIT_Nolink</span><span class="p">,</span> <span class="n">ip</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">sxtlck</span><span class="o">-&gt;</span><span class="n">lwm</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="p">(</span><span class="n">sxtlck</span><span class="o">-&gt;</span><span class="n">lwm</span><span class="p">.</span><span class="n">offset</span><span class="p">)</span> <span class="o">?</span>
			    <span class="n">min</span><span class="p">(</span><span class="n">skip</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">sxtlck</span><span class="o">-&gt;</span><span class="n">lwm</span><span class="p">.</span><span class="n">offset</span><span class="p">)</span> <span class="o">:</span> <span class="n">skip</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">rp</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">nextindex</span> <span class="o">=</span>
		    <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">XTENTRYSTART</span> <span class="o">+</span> <span class="n">righthalf</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="cm">/*</span>
<span class="cm">	 * skip index in new right page - insert into right page:</span>
<span class="cm">	 */</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* move left head of right half to right page */</span>
		<span class="n">n</span> <span class="o">=</span> <span class="n">skip</span> <span class="o">-</span> <span class="n">middle</span><span class="p">;</span>
		<span class="n">memmove</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rp</span><span class="o">-&gt;</span><span class="n">xad</span><span class="p">[</span><span class="n">XTENTRYSTART</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">xad</span><span class="p">[</span><span class="n">middle</span><span class="p">],</span>
			<span class="n">n</span> <span class="o">&lt;&lt;</span> <span class="n">L2XTSLOTSIZE</span><span class="p">);</span>

		<span class="cm">/* insert new entry */</span>
		<span class="n">n</span> <span class="o">+=</span> <span class="n">XTENTRYSTART</span><span class="p">;</span>
		<span class="n">xad</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">rp</span><span class="o">-&gt;</span><span class="n">xad</span><span class="p">[</span><span class="n">n</span><span class="p">];</span>
		<span class="n">XT_PUTENTRY</span><span class="p">(</span><span class="n">xad</span><span class="p">,</span> <span class="n">split</span><span class="o">-&gt;</span><span class="n">flag</span><span class="p">,</span> <span class="n">split</span><span class="o">-&gt;</span><span class="n">off</span><span class="p">,</span> <span class="n">split</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span>
			    <span class="n">split</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">);</span>

		<span class="cm">/* move right tail of right half to right page */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">skip</span> <span class="o">&lt;</span> <span class="n">maxentry</span><span class="p">)</span>
			<span class="n">memmove</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rp</span><span class="o">-&gt;</span><span class="n">xad</span><span class="p">[</span><span class="n">n</span> <span class="o">+</span> <span class="mi">1</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">xad</span><span class="p">[</span><span class="n">skip</span><span class="p">],</span>
				<span class="p">(</span><span class="n">maxentry</span> <span class="o">-</span> <span class="n">skip</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">L2XTSLOTSIZE</span><span class="p">);</span>

		<span class="cm">/* update page header */</span>
		<span class="n">sp</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">nextindex</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">middle</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_cflag</span><span class="p">(</span><span class="n">COMMIT_Nolink</span><span class="p">,</span> <span class="n">ip</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">sxtlck</span><span class="o">-&gt;</span><span class="n">lwm</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="p">(</span><span class="n">sxtlck</span><span class="o">-&gt;</span><span class="n">lwm</span><span class="p">.</span><span class="n">offset</span><span class="p">)</span> <span class="o">?</span>
			    <span class="n">min</span><span class="p">(</span><span class="n">middle</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">sxtlck</span><span class="o">-&gt;</span><span class="n">lwm</span><span class="p">.</span><span class="n">offset</span><span class="p">)</span> <span class="o">:</span> <span class="n">middle</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">rp</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">nextindex</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">XTENTRYSTART</span> <span class="o">+</span>
						   <span class="n">righthalf</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_cflag</span><span class="p">(</span><span class="n">COMMIT_Nolink</span><span class="p">,</span> <span class="n">ip</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">sxtlck</span><span class="o">-&gt;</span><span class="n">lwm</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">nextindex</span><span class="p">)</span> <span class="o">-</span>
		    <span class="n">sxtlck</span><span class="o">-&gt;</span><span class="n">lwm</span><span class="p">.</span><span class="n">offset</span><span class="p">;</span>

		<span class="cm">/* rxtlck-&gt;lwm.offset = XTENTRYSTART; */</span>
		<span class="n">rxtlck</span><span class="o">-&gt;</span><span class="n">lwm</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">rp</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">nextindex</span><span class="p">)</span> <span class="o">-</span>
		    <span class="n">XTENTRYSTART</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="o">*</span><span class="n">rmpp</span> <span class="o">=</span> <span class="n">rmp</span><span class="p">;</span>
	<span class="o">*</span><span class="n">rbnp</span> <span class="o">=</span> <span class="n">rbn</span><span class="p">;</span>

	<span class="n">jfs_info</span><span class="p">(</span><span class="s">&quot;xtSplitPage: sp:0x%p rp:0x%p&quot;</span><span class="p">,</span> <span class="n">sp</span><span class="p">,</span> <span class="n">rp</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

      <span class="nl">clean_up:</span>

	<span class="cm">/* Rollback quota allocation. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">quota_allocation</span><span class="p">)</span>
		<span class="n">dquot_free_block</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">quota_allocation</span><span class="p">);</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">rc</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> *	xtSplitRoot()</span>
<span class="cm"> *</span>
<span class="cm"> * function:</span>
<span class="cm"> *	split the full root page into original/root/split page and new</span>
<span class="cm"> *	right page</span>
<span class="cm"> *	i.e., root remains fixed in tree anchor (inode) and the root is</span>
<span class="cm"> *	copied to a single new right child page since root page &lt;&lt;</span>
<span class="cm"> *	non-root page, and the split root page contains a single entry</span>
<span class="cm"> *	for the new right child page.</span>
<span class="cm"> *</span>
<span class="cm"> * parameter:</span>
<span class="cm"> *	int		tid,</span>
<span class="cm"> *	struct inode	*ip,</span>
<span class="cm"> *	struct xtsplit	*split,</span>
<span class="cm"> *	struct metapage	**rmpp)</span>
<span class="cm"> *</span>
<span class="cm"> * return:</span>
<span class="cm"> *	Pointer to page in which to insert or NULL on error.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">xtSplitRoot</span><span class="p">(</span><span class="n">tid_t</span> <span class="n">tid</span><span class="p">,</span>
	    <span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">ip</span><span class="p">,</span> <span class="k">struct</span> <span class="n">xtsplit</span> <span class="o">*</span> <span class="n">split</span><span class="p">,</span> <span class="k">struct</span> <span class="n">metapage</span> <span class="o">**</span> <span class="n">rmpp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">xtpage_t</span> <span class="o">*</span><span class="n">sp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">metapage</span> <span class="o">*</span><span class="n">rmp</span><span class="p">;</span>
	<span class="n">xtpage_t</span> <span class="o">*</span><span class="n">rp</span><span class="p">;</span>
	<span class="n">s64</span> <span class="n">rbn</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">skip</span><span class="p">,</span> <span class="n">nextindex</span><span class="p">;</span>
	<span class="n">xad_t</span> <span class="o">*</span><span class="n">xad</span><span class="p">;</span>
	<span class="n">pxd_t</span> <span class="o">*</span><span class="n">pxd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pxdlist</span> <span class="o">*</span><span class="n">pxdlist</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tlock</span> <span class="o">*</span><span class="n">tlck</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">xtlock</span> <span class="o">*</span><span class="n">xtlck</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">sp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">JFS_IP</span><span class="p">(</span><span class="n">ip</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">i_xtroot</span><span class="p">;</span>

	<span class="n">INCREMENT</span><span class="p">(</span><span class="n">xtStat</span><span class="p">.</span><span class="n">split</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 *	allocate a single (right) child page</span>
<span class="cm">	 */</span>
	<span class="n">pxdlist</span> <span class="o">=</span> <span class="n">split</span><span class="o">-&gt;</span><span class="n">pxdlist</span><span class="p">;</span>
	<span class="n">pxd</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pxdlist</span><span class="o">-&gt;</span><span class="n">pxd</span><span class="p">[</span><span class="n">pxdlist</span><span class="o">-&gt;</span><span class="n">npxd</span><span class="p">];</span>
	<span class="n">pxdlist</span><span class="o">-&gt;</span><span class="n">npxd</span><span class="o">++</span><span class="p">;</span>
	<span class="n">rbn</span> <span class="o">=</span> <span class="n">addressPXD</span><span class="p">(</span><span class="n">pxd</span><span class="p">);</span>
	<span class="n">rmp</span> <span class="o">=</span> <span class="n">get_metapage</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">rbn</span><span class="p">,</span> <span class="n">PSIZE</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rmp</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="cm">/* Allocate blocks to quota. */</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">dquot_alloc_block</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">lengthPXD</span><span class="p">(</span><span class="n">pxd</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">release_metapage</span><span class="p">(</span><span class="n">rmp</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">jfs_info</span><span class="p">(</span><span class="s">&quot;xtSplitRoot: ip:0x%p rmp:0x%p&quot;</span><span class="p">,</span> <span class="n">ip</span><span class="p">,</span> <span class="n">rmp</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * acquire a transaction lock on the new right page;</span>
<span class="cm">	 *</span>
<span class="cm">	 * action: new page;</span>
<span class="cm">	 */</span>
	<span class="n">BT_MARK_DIRTY</span><span class="p">(</span><span class="n">rmp</span><span class="p">,</span> <span class="n">ip</span><span class="p">);</span>

	<span class="n">rp</span> <span class="o">=</span> <span class="p">(</span><span class="n">xtpage_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">rmp</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="n">rp</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">flag</span> <span class="o">=</span>
	    <span class="p">(</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">flag</span> <span class="o">&amp;</span> <span class="n">BT_LEAF</span><span class="p">)</span> <span class="o">?</span> <span class="n">BT_LEAF</span> <span class="o">:</span> <span class="n">BT_INTERNAL</span><span class="p">;</span>
	<span class="n">rp</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">self</span> <span class="o">=</span> <span class="o">*</span><span class="n">pxd</span><span class="p">;</span>
	<span class="n">rp</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">nextindex</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">XTENTRYSTART</span><span class="p">);</span>
	<span class="n">rp</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">maxentry</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">PSIZE</span> <span class="o">&gt;&gt;</span> <span class="n">L2XTSLOTSIZE</span><span class="p">);</span>

	<span class="cm">/* initialize sibling pointers */</span>
	<span class="n">rp</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">next</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">rp</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">prev</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * copy the in-line root page into new right page extent</span>
<span class="cm">	 */</span>
	<span class="n">nextindex</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">maxentry</span><span class="p">);</span>
	<span class="n">memmove</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rp</span><span class="o">-&gt;</span><span class="n">xad</span><span class="p">[</span><span class="n">XTENTRYSTART</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">xad</span><span class="p">[</span><span class="n">XTENTRYSTART</span><span class="p">],</span>
		<span class="p">(</span><span class="n">nextindex</span> <span class="o">-</span> <span class="n">XTENTRYSTART</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">L2XTSLOTSIZE</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * insert the new entry into the new right/child page</span>
<span class="cm">	 * (skip index in the new right page will not change)</span>
<span class="cm">	 */</span>
	<span class="n">skip</span> <span class="o">=</span> <span class="n">split</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">;</span>
	<span class="cm">/* if insert into middle, shift right remaining entries */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">skip</span> <span class="o">!=</span> <span class="n">nextindex</span><span class="p">)</span>
		<span class="n">memmove</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rp</span><span class="o">-&gt;</span><span class="n">xad</span><span class="p">[</span><span class="n">skip</span> <span class="o">+</span> <span class="mi">1</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">rp</span><span class="o">-&gt;</span><span class="n">xad</span><span class="p">[</span><span class="n">skip</span><span class="p">],</span>
			<span class="p">(</span><span class="n">nextindex</span> <span class="o">-</span> <span class="n">skip</span><span class="p">)</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">xad_t</span><span class="p">));</span>

	<span class="n">xad</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">rp</span><span class="o">-&gt;</span><span class="n">xad</span><span class="p">[</span><span class="n">skip</span><span class="p">];</span>
	<span class="n">XT_PUTENTRY</span><span class="p">(</span><span class="n">xad</span><span class="p">,</span> <span class="n">split</span><span class="o">-&gt;</span><span class="n">flag</span><span class="p">,</span> <span class="n">split</span><span class="o">-&gt;</span><span class="n">off</span><span class="p">,</span> <span class="n">split</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span> <span class="n">split</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">);</span>

	<span class="cm">/* update page header */</span>
	<span class="n">rp</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">nextindex</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">nextindex</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_cflag</span><span class="p">(</span><span class="n">COMMIT_Nolink</span><span class="p">,</span> <span class="n">ip</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">tlck</span> <span class="o">=</span> <span class="n">txLock</span><span class="p">(</span><span class="n">tid</span><span class="p">,</span> <span class="n">ip</span><span class="p">,</span> <span class="n">rmp</span><span class="p">,</span> <span class="n">tlckXTREE</span> <span class="o">|</span> <span class="n">tlckNEW</span><span class="p">);</span>
		<span class="n">xtlck</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">xtlock</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">tlck</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">;</span>
		<span class="n">xtlck</span><span class="o">-&gt;</span><span class="n">lwm</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="n">XTENTRYSTART</span><span class="p">;</span>
		<span class="n">xtlck</span><span class="o">-&gt;</span><span class="n">lwm</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">rp</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">nextindex</span><span class="p">)</span> <span class="o">-</span>
		    <span class="n">XTENTRYSTART</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 *	reset the root</span>
<span class="cm">	 *</span>
<span class="cm">	 * init root with the single entry for the new right page</span>
<span class="cm">	 * set the 1st entry offset to 0, which force the left-most key</span>
<span class="cm">	 * at any level of the tree to be less than any search key.</span>
<span class="cm">	 */</span>
	<span class="cm">/*</span>
<span class="cm">	 * acquire a transaction lock on the root page (in-memory inode);</span>
<span class="cm">	 *</span>
<span class="cm">	 * action: root split;</span>
<span class="cm">	 */</span>
	<span class="n">BT_MARK_DIRTY</span><span class="p">(</span><span class="n">split</span><span class="o">-&gt;</span><span class="n">mp</span><span class="p">,</span> <span class="n">ip</span><span class="p">);</span>

	<span class="n">xad</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">xad</span><span class="p">[</span><span class="n">XTENTRYSTART</span><span class="p">];</span>
	<span class="n">XT_PUTENTRY</span><span class="p">(</span><span class="n">xad</span><span class="p">,</span> <span class="n">XAD_NEW</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">JFS_SBI</span><span class="p">(</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_sb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">nbperpage</span><span class="p">,</span> <span class="n">rbn</span><span class="p">);</span>

	<span class="cm">/* update page header of root */</span>
	<span class="n">sp</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">flag</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">BT_LEAF</span><span class="p">;</span>
	<span class="n">sp</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">flag</span> <span class="o">|=</span> <span class="n">BT_INTERNAL</span><span class="p">;</span>

	<span class="n">sp</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">nextindex</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">XTENTRYSTART</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_cflag</span><span class="p">(</span><span class="n">COMMIT_Nolink</span><span class="p">,</span> <span class="n">ip</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">tlck</span> <span class="o">=</span> <span class="n">txLock</span><span class="p">(</span><span class="n">tid</span><span class="p">,</span> <span class="n">ip</span><span class="p">,</span> <span class="n">split</span><span class="o">-&gt;</span><span class="n">mp</span><span class="p">,</span> <span class="n">tlckXTREE</span> <span class="o">|</span> <span class="n">tlckGROW</span><span class="p">);</span>
		<span class="n">xtlck</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">xtlock</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">tlck</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">;</span>
		<span class="n">xtlck</span><span class="o">-&gt;</span><span class="n">lwm</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="n">XTENTRYSTART</span><span class="p">;</span>
		<span class="n">xtlck</span><span class="o">-&gt;</span><span class="n">lwm</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="o">*</span><span class="n">rmpp</span> <span class="o">=</span> <span class="n">rmp</span><span class="p">;</span>

	<span class="n">jfs_info</span><span class="p">(</span><span class="s">&quot;xtSplitRoot: sp:0x%p rp:0x%p&quot;</span><span class="p">,</span> <span class="n">sp</span><span class="p">,</span> <span class="n">rp</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> *	xtExtend()</span>
<span class="cm"> *</span>
<span class="cm"> * function: extend in-place;</span>
<span class="cm"> *</span>
<span class="cm"> * note: existing extent may or may not have been committed.</span>
<span class="cm"> * caller is responsible for pager buffer cache update, and</span>
<span class="cm"> * working block allocation map update;</span>
<span class="cm"> * update pmap: alloc whole extended extent;</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">xtExtend</span><span class="p">(</span><span class="n">tid_t</span> <span class="n">tid</span><span class="p">,</span>		<span class="cm">/* transaction id */</span>
	     <span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">ip</span><span class="p">,</span> <span class="n">s64</span> <span class="n">xoff</span><span class="p">,</span>	<span class="cm">/* delta extent offset */</span>
	     <span class="n">s32</span> <span class="n">xlen</span><span class="p">,</span>		<span class="cm">/* delta extent length */</span>
	     <span class="kt">int</span> <span class="n">flag</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">cmp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">metapage</span> <span class="o">*</span><span class="n">mp</span><span class="p">;</span>	<span class="cm">/* meta-page buffer */</span>
	<span class="n">xtpage_t</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>		<span class="cm">/* base B+-tree index page */</span>
	<span class="n">s64</span> <span class="n">bn</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">index</span><span class="p">,</span> <span class="n">nextindex</span><span class="p">,</span> <span class="n">len</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">btstack</span> <span class="n">btstack</span><span class="p">;</span>	<span class="cm">/* traverse stack */</span>
	<span class="k">struct</span> <span class="n">xtsplit</span> <span class="n">split</span><span class="p">;</span>	<span class="cm">/* split information */</span>
	<span class="n">xad_t</span> <span class="o">*</span><span class="n">xad</span><span class="p">;</span>
	<span class="n">s64</span> <span class="n">xaddr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tlock</span> <span class="o">*</span><span class="n">tlck</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">xtlock</span> <span class="o">*</span><span class="n">xtlck</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">jfs_info</span><span class="p">(</span><span class="s">&quot;xtExtend: nxoff:0x%lx nxlen:0x%x&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">ulong</span><span class="p">)</span> <span class="n">xoff</span><span class="p">,</span> <span class="n">xlen</span><span class="p">);</span>

	<span class="cm">/* there must exist extent to be extended */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">rc</span> <span class="o">=</span> <span class="n">xtSearch</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">xoff</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">btstack</span><span class="p">,</span> <span class="n">XT_INSERT</span><span class="p">)))</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

	<span class="cm">/* retrieve search result */</span>
	<span class="n">XT_GETSEARCH</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">btstack</span><span class="p">.</span><span class="n">top</span><span class="p">,</span> <span class="n">bn</span><span class="p">,</span> <span class="n">mp</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">index</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cmp</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">XT_PUTPAGE</span><span class="p">(</span><span class="n">mp</span><span class="p">);</span>
		<span class="n">jfs_error</span><span class="p">(</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_sb</span><span class="p">,</span> <span class="s">&quot;xtExtend: xtSearch did not find extent&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* extension must be contiguous */</span>
	<span class="n">xad</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">xad</span><span class="p">[</span><span class="n">index</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">offsetXAD</span><span class="p">(</span><span class="n">xad</span><span class="p">)</span> <span class="o">+</span> <span class="n">lengthXAD</span><span class="p">(</span><span class="n">xad</span><span class="p">))</span> <span class="o">!=</span> <span class="n">xoff</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">XT_PUTPAGE</span><span class="p">(</span><span class="n">mp</span><span class="p">);</span>
		<span class="n">jfs_error</span><span class="p">(</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_sb</span><span class="p">,</span> <span class="s">&quot;xtExtend: extension is not contiguous&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * acquire a transaction lock on the leaf page;</span>
<span class="cm">	 *</span>
<span class="cm">	 * action: xad insertion/extension;</span>
<span class="cm">	 */</span>
	<span class="n">BT_MARK_DIRTY</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="n">ip</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_cflag</span><span class="p">(</span><span class="n">COMMIT_Nolink</span><span class="p">,</span> <span class="n">ip</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">tlck</span> <span class="o">=</span> <span class="n">txLock</span><span class="p">(</span><span class="n">tid</span><span class="p">,</span> <span class="n">ip</span><span class="p">,</span> <span class="n">mp</span><span class="p">,</span> <span class="n">tlckXTREE</span> <span class="o">|</span> <span class="n">tlckGROW</span><span class="p">);</span>
		<span class="n">xtlck</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">xtlock</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">tlck</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* extend will overflow extent ? */</span>
	<span class="n">xlen</span> <span class="o">=</span> <span class="n">lengthXAD</span><span class="p">(</span><span class="n">xad</span><span class="p">)</span> <span class="o">+</span> <span class="n">xlen</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">len</span> <span class="o">=</span> <span class="n">xlen</span> <span class="o">-</span> <span class="n">MAXXLEN</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">extendOld</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 *	extent overflow: insert entry for new extent</span>
<span class="cm">	 */</span></pre></div></td></tr>


<tr id="section-4"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-4">&#182;</a></div><p>insertNew:</p></td><td class="code"><div class="highlight"><pre>	<span class="n">xoff</span> <span class="o">=</span> <span class="n">offsetXAD</span><span class="p">(</span><span class="n">xad</span><span class="p">)</span> <span class="o">+</span> <span class="n">MAXXLEN</span><span class="p">;</span>
	<span class="n">xaddr</span> <span class="o">=</span> <span class="n">addressXAD</span><span class="p">(</span><span class="n">xad</span><span class="p">)</span> <span class="o">+</span> <span class="n">MAXXLEN</span><span class="p">;</span>
	<span class="n">nextindex</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">nextindex</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 *	if the leaf page is full, insert the new entry and</span>
<span class="cm">	 *	propagate up the router entry for the new page from split</span>
<span class="cm">	 *</span>
<span class="cm">	 * The xtSplitUp() will insert the entry and unpin the leaf page.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nextindex</span> <span class="o">==</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">maxentry</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* xtSpliUp() unpins leaf pages */</span>
		<span class="n">split</span><span class="p">.</span><span class="n">mp</span> <span class="o">=</span> <span class="n">mp</span><span class="p">;</span>
		<span class="n">split</span><span class="p">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">split</span><span class="p">.</span><span class="n">flag</span> <span class="o">=</span> <span class="n">XAD_NEW</span><span class="p">;</span>
		<span class="n">split</span><span class="p">.</span><span class="n">off</span> <span class="o">=</span> <span class="n">xoff</span><span class="p">;</span>	<span class="cm">/* split offset */</span>
		<span class="n">split</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>
		<span class="n">split</span><span class="p">.</span><span class="n">addr</span> <span class="o">=</span> <span class="n">xaddr</span><span class="p">;</span>
		<span class="n">split</span><span class="p">.</span><span class="n">pxdlist</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">rc</span> <span class="o">=</span> <span class="n">xtSplitUp</span><span class="p">(</span><span class="n">tid</span><span class="p">,</span> <span class="n">ip</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">split</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">btstack</span><span class="p">)))</span>
			<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

		<span class="cm">/* get back old page */</span>
		<span class="n">XT_GETPAGE</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">bn</span><span class="p">,</span> <span class="n">mp</span><span class="p">,</span> <span class="n">PSIZE</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
		<span class="cm">/*</span>
<span class="cm">		 * if leaf root has been split, original root has been</span>
<span class="cm">		 * copied to new child page, i.e., original entry now</span>
<span class="cm">		 * resides on the new child page;</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">flag</span> <span class="o">&amp;</span> <span class="n">BT_INTERNAL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ASSERT</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">nextindex</span> <span class="o">==</span>
			       <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">XTENTRYSTART</span> <span class="o">+</span> <span class="mi">1</span><span class="p">));</span>
			<span class="n">xad</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">xad</span><span class="p">[</span><span class="n">XTENTRYSTART</span><span class="p">];</span>
			<span class="n">bn</span> <span class="o">=</span> <span class="n">addressXAD</span><span class="p">(</span><span class="n">xad</span><span class="p">);</span>
			<span class="n">XT_PUTPAGE</span><span class="p">(</span><span class="n">mp</span><span class="p">);</span>

			<span class="cm">/* get new child page */</span>
			<span class="n">XT_GETPAGE</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">bn</span><span class="p">,</span> <span class="n">mp</span><span class="p">,</span> <span class="n">PSIZE</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

			<span class="n">BT_MARK_DIRTY</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="n">ip</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_cflag</span><span class="p">(</span><span class="n">COMMIT_Nolink</span><span class="p">,</span> <span class="n">ip</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">tlck</span> <span class="o">=</span> <span class="n">txLock</span><span class="p">(</span><span class="n">tid</span><span class="p">,</span> <span class="n">ip</span><span class="p">,</span> <span class="n">mp</span><span class="p">,</span> <span class="n">tlckXTREE</span><span class="o">|</span><span class="n">tlckGROW</span><span class="p">);</span>
				<span class="n">xtlck</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">xtlock</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">tlck</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="cm">/*</span>
<span class="cm">	 *	insert the new entry into the leaf page</span>
<span class="cm">	 */</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* insert the new entry: mark the entry NEW */</span>
		<span class="n">xad</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">xad</span><span class="p">[</span><span class="n">index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];</span>
		<span class="n">XT_PUTENTRY</span><span class="p">(</span><span class="n">xad</span><span class="p">,</span> <span class="n">XAD_NEW</span><span class="p">,</span> <span class="n">xoff</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">xaddr</span><span class="p">);</span>

		<span class="cm">/* advance next available entry index */</span>
		<span class="n">le16_add_cpu</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">nextindex</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* get back old entry */</span>
	<span class="n">xad</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">xad</span><span class="p">[</span><span class="n">index</span><span class="p">];</span>
	<span class="n">xlen</span> <span class="o">=</span> <span class="n">MAXXLEN</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * extend old extent</span>
<span class="cm">	 */</span>
      <span class="nl">extendOld:</span>
	<span class="n">XADlength</span><span class="p">(</span><span class="n">xad</span><span class="p">,</span> <span class="n">xlen</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">xad</span><span class="o">-&gt;</span><span class="n">flag</span> <span class="o">&amp;</span> <span class="n">XAD_NEW</span><span class="p">))</span>
		<span class="n">xad</span><span class="o">-&gt;</span><span class="n">flag</span> <span class="o">|=</span> <span class="n">XAD_EXTENDED</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_cflag</span><span class="p">(</span><span class="n">COMMIT_Nolink</span><span class="p">,</span> <span class="n">ip</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">xtlck</span><span class="o">-&gt;</span><span class="n">lwm</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span>
		    <span class="p">(</span><span class="n">xtlck</span><span class="o">-&gt;</span><span class="n">lwm</span><span class="p">.</span><span class="n">offset</span><span class="p">)</span> <span class="o">?</span> <span class="n">min</span><span class="p">(</span><span class="n">index</span><span class="p">,</span>
					      <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">xtlck</span><span class="o">-&gt;</span><span class="n">lwm</span><span class="p">.</span><span class="n">offset</span><span class="p">)</span> <span class="o">:</span> <span class="n">index</span><span class="p">;</span>
		<span class="n">xtlck</span><span class="o">-&gt;</span><span class="n">lwm</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span>
		    <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">nextindex</span><span class="p">)</span> <span class="o">-</span> <span class="n">xtlck</span><span class="o">-&gt;</span><span class="n">lwm</span><span class="p">.</span><span class="n">offset</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* unpin the leaf page */</span>
	<span class="n">XT_PUTPAGE</span><span class="p">(</span><span class="n">mp</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef _NOTYET</span>
<span class="cm">/*</span>
<span class="cm"> *	xtTailgate()</span>
<span class="cm"> *</span>
<span class="cm"> * function: split existing &#39;tail&#39; extent</span>
<span class="cm"> *	(split offset &gt;= start offset of tail extent), and</span>
<span class="cm"> *	relocate and extend the split tail half;</span>
<span class="cm"> *</span>
<span class="cm"> * note: existing extent may or may not have been committed.</span>
<span class="cm"> * caller is responsible for pager buffer cache update, and</span>
<span class="cm"> * working block allocation map update;</span>
<span class="cm"> * update pmap: free old split tail extent, alloc new extent;</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">xtTailgate</span><span class="p">(</span><span class="n">tid_t</span> <span class="n">tid</span><span class="p">,</span>		<span class="cm">/* transaction id */</span>
	       <span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">ip</span><span class="p">,</span> <span class="n">s64</span> <span class="n">xoff</span><span class="p">,</span>	<span class="cm">/* split/new extent offset */</span>
	       <span class="n">s32</span> <span class="n">xlen</span><span class="p">,</span>	<span class="cm">/* new extent length */</span>
	       <span class="n">s64</span> <span class="n">xaddr</span><span class="p">,</span>	<span class="cm">/* new extent address */</span>
	       <span class="kt">int</span> <span class="n">flag</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">cmp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">metapage</span> <span class="o">*</span><span class="n">mp</span><span class="p">;</span>	<span class="cm">/* meta-page buffer */</span>
	<span class="n">xtpage_t</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>		<span class="cm">/* base B+-tree index page */</span>
	<span class="n">s64</span> <span class="n">bn</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">index</span><span class="p">,</span> <span class="n">nextindex</span><span class="p">,</span> <span class="n">llen</span><span class="p">,</span> <span class="n">rlen</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">btstack</span> <span class="n">btstack</span><span class="p">;</span>	<span class="cm">/* traverse stack */</span>
	<span class="k">struct</span> <span class="n">xtsplit</span> <span class="n">split</span><span class="p">;</span>	<span class="cm">/* split information */</span>
	<span class="n">xad_t</span> <span class="o">*</span><span class="n">xad</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tlock</span> <span class="o">*</span><span class="n">tlck</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">xtlock</span> <span class="o">*</span><span class="n">xtlck</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tlock</span> <span class="o">*</span><span class="n">mtlck</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">maplock</span> <span class="o">*</span><span class="n">pxdlock</span><span class="p">;</span>

<span class="cm">/*</span>
<span class="cm">printf(&quot;xtTailgate: nxoff:0x%lx nxlen:0x%x nxaddr:0x%lx\n&quot;,</span>
<span class="cm">	(ulong)xoff, xlen, (ulong)xaddr);</span>
<span class="cm">*/</span>

	<span class="cm">/* there must exist extent to be tailgated */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">rc</span> <span class="o">=</span> <span class="n">xtSearch</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">xoff</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">btstack</span><span class="p">,</span> <span class="n">XT_INSERT</span><span class="p">)))</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

	<span class="cm">/* retrieve search result */</span>
	<span class="n">XT_GETSEARCH</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">btstack</span><span class="p">.</span><span class="n">top</span><span class="p">,</span> <span class="n">bn</span><span class="p">,</span> <span class="n">mp</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">index</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cmp</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">XT_PUTPAGE</span><span class="p">(</span><span class="n">mp</span><span class="p">);</span>
		<span class="n">jfs_error</span><span class="p">(</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_sb</span><span class="p">,</span> <span class="s">&quot;xtTailgate: couldn&#39;t find extent&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* entry found must be last entry */</span>
	<span class="n">nextindex</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">nextindex</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">index</span> <span class="o">!=</span> <span class="n">nextindex</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">XT_PUTPAGE</span><span class="p">(</span><span class="n">mp</span><span class="p">);</span>
		<span class="n">jfs_error</span><span class="p">(</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_sb</span><span class="p">,</span>
			  <span class="s">&quot;xtTailgate: the entry found is not the last entry&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">BT_MARK_DIRTY</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="n">ip</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 * acquire tlock of the leaf page containing original entry</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_cflag</span><span class="p">(</span><span class="n">COMMIT_Nolink</span><span class="p">,</span> <span class="n">ip</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">tlck</span> <span class="o">=</span> <span class="n">txLock</span><span class="p">(</span><span class="n">tid</span><span class="p">,</span> <span class="n">ip</span><span class="p">,</span> <span class="n">mp</span><span class="p">,</span> <span class="n">tlckXTREE</span> <span class="o">|</span> <span class="n">tlckGROW</span><span class="p">);</span>
		<span class="n">xtlck</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">xtlock</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">tlck</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* completely replace extent ? */</span>
	<span class="n">xad</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">xad</span><span class="p">[</span><span class="n">index</span><span class="p">];</span>
<span class="cm">/*</span>
<span class="cm">printf(&quot;xtTailgate: xoff:0x%lx xlen:0x%x xaddr:0x%lx\n&quot;,</span>
<span class="cm">	(ulong)offsetXAD(xad), lengthXAD(xad), (ulong)addressXAD(xad));</span>
<span class="cm">*/</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">llen</span> <span class="o">=</span> <span class="n">xoff</span> <span class="o">-</span> <span class="n">offsetXAD</span><span class="p">(</span><span class="n">xad</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">updateOld</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 *	partially replace extent: insert entry for new extent</span>
<span class="cm">	 */</span></pre></div></td></tr>


<tr id="section-5"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-5">&#182;</a></div><p>insertNew:</p></td><td class="code"><div class="highlight"><pre>	<span class="cm">/*</span>
<span class="cm">	 *	if the leaf page is full, insert the new entry and</span>
<span class="cm">	 *	propagate up the router entry for the new page from split</span>
<span class="cm">	 *</span>
<span class="cm">	 * The xtSplitUp() will insert the entry and unpin the leaf page.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nextindex</span> <span class="o">==</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">maxentry</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* xtSpliUp() unpins leaf pages */</span>
		<span class="n">split</span><span class="p">.</span><span class="n">mp</span> <span class="o">=</span> <span class="n">mp</span><span class="p">;</span>
		<span class="n">split</span><span class="p">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">split</span><span class="p">.</span><span class="n">flag</span> <span class="o">=</span> <span class="n">XAD_NEW</span><span class="p">;</span>
		<span class="n">split</span><span class="p">.</span><span class="n">off</span> <span class="o">=</span> <span class="n">xoff</span><span class="p">;</span>	<span class="cm">/* split offset */</span>
		<span class="n">split</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="n">xlen</span><span class="p">;</span>
		<span class="n">split</span><span class="p">.</span><span class="n">addr</span> <span class="o">=</span> <span class="n">xaddr</span><span class="p">;</span>
		<span class="n">split</span><span class="p">.</span><span class="n">pxdlist</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">rc</span> <span class="o">=</span> <span class="n">xtSplitUp</span><span class="p">(</span><span class="n">tid</span><span class="p">,</span> <span class="n">ip</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">split</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">btstack</span><span class="p">)))</span>
			<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

		<span class="cm">/* get back old page */</span>
		<span class="n">XT_GETPAGE</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">bn</span><span class="p">,</span> <span class="n">mp</span><span class="p">,</span> <span class="n">PSIZE</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
		<span class="cm">/*</span>
<span class="cm">		 * if leaf root has been split, original root has been</span>
<span class="cm">		 * copied to new child page, i.e., original entry now</span>
<span class="cm">		 * resides on the new child page;</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">flag</span> <span class="o">&amp;</span> <span class="n">BT_INTERNAL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ASSERT</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">nextindex</span> <span class="o">==</span>
			       <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">XTENTRYSTART</span> <span class="o">+</span> <span class="mi">1</span><span class="p">));</span>
			<span class="n">xad</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">xad</span><span class="p">[</span><span class="n">XTENTRYSTART</span><span class="p">];</span>
			<span class="n">bn</span> <span class="o">=</span> <span class="n">addressXAD</span><span class="p">(</span><span class="n">xad</span><span class="p">);</span>
			<span class="n">XT_PUTPAGE</span><span class="p">(</span><span class="n">mp</span><span class="p">);</span>

			<span class="cm">/* get new child page */</span>
			<span class="n">XT_GETPAGE</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">bn</span><span class="p">,</span> <span class="n">mp</span><span class="p">,</span> <span class="n">PSIZE</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

			<span class="n">BT_MARK_DIRTY</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="n">ip</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_cflag</span><span class="p">(</span><span class="n">COMMIT_Nolink</span><span class="p">,</span> <span class="n">ip</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">tlck</span> <span class="o">=</span> <span class="n">txLock</span><span class="p">(</span><span class="n">tid</span><span class="p">,</span> <span class="n">ip</span><span class="p">,</span> <span class="n">mp</span><span class="p">,</span> <span class="n">tlckXTREE</span><span class="o">|</span><span class="n">tlckGROW</span><span class="p">);</span>
				<span class="n">xtlck</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">xtlock</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">tlck</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="cm">/*</span>
<span class="cm">	 *	insert the new entry into the leaf page</span>
<span class="cm">	 */</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* insert the new entry: mark the entry NEW */</span>
		<span class="n">xad</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">xad</span><span class="p">[</span><span class="n">index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];</span>
		<span class="n">XT_PUTENTRY</span><span class="p">(</span><span class="n">xad</span><span class="p">,</span> <span class="n">XAD_NEW</span><span class="p">,</span> <span class="n">xoff</span><span class="p">,</span> <span class="n">xlen</span><span class="p">,</span> <span class="n">xaddr</span><span class="p">);</span>

		<span class="cm">/* advance next available entry index */</span>
		<span class="n">le16_add_cpu</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">nextindex</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* get back old XAD */</span>
	<span class="n">xad</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">xad</span><span class="p">[</span><span class="n">index</span><span class="p">];</span>

	<span class="cm">/*</span>
<span class="cm">	 * truncate/relocate old extent at split offset</span>
<span class="cm">	 */</span>
      <span class="nl">updateOld:</span>
	<span class="cm">/* update dmap for old/committed/truncated extent */</span>
	<span class="n">rlen</span> <span class="o">=</span> <span class="n">lengthXAD</span><span class="p">(</span><span class="n">xad</span><span class="p">)</span> <span class="o">-</span> <span class="n">llen</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">xad</span><span class="o">-&gt;</span><span class="n">flag</span> <span class="o">&amp;</span> <span class="n">XAD_NEW</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* free from PWMAP at commit */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_cflag</span><span class="p">(</span><span class="n">COMMIT_Nolink</span><span class="p">,</span> <span class="n">ip</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">mtlck</span> <span class="o">=</span> <span class="n">txMaplock</span><span class="p">(</span><span class="n">tid</span><span class="p">,</span> <span class="n">ip</span><span class="p">,</span> <span class="n">tlckMAP</span><span class="p">);</span>
			<span class="n">pxdlock</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">maplock</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">mtlck</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">;</span>
			<span class="n">pxdlock</span><span class="o">-&gt;</span><span class="n">flag</span> <span class="o">=</span> <span class="n">mlckFREEPXD</span><span class="p">;</span>
			<span class="n">PXDaddress</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pxdlock</span><span class="o">-&gt;</span><span class="n">pxd</span><span class="p">,</span> <span class="n">addressXAD</span><span class="p">(</span><span class="n">xad</span><span class="p">)</span> <span class="o">+</span> <span class="n">llen</span><span class="p">);</span>
			<span class="n">PXDlength</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pxdlock</span><span class="o">-&gt;</span><span class="n">pxd</span><span class="p">,</span> <span class="n">rlen</span><span class="p">);</span>
			<span class="n">pxdlock</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="cm">/* free from WMAP */</span>
		<span class="n">dbFree</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">addressXAD</span><span class="p">(</span><span class="n">xad</span><span class="p">)</span> <span class="o">+</span> <span class="n">llen</span><span class="p">,</span> <span class="p">(</span><span class="n">s64</span><span class="p">)</span> <span class="n">rlen</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">llen</span><span class="p">)</span>
		<span class="cm">/* truncate */</span>
		<span class="n">XADlength</span><span class="p">(</span><span class="n">xad</span><span class="p">,</span> <span class="n">llen</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="cm">/* replace */</span>
		<span class="n">XT_PUTENTRY</span><span class="p">(</span><span class="n">xad</span><span class="p">,</span> <span class="n">XAD_NEW</span><span class="p">,</span> <span class="n">xoff</span><span class="p">,</span> <span class="n">xlen</span><span class="p">,</span> <span class="n">xaddr</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_cflag</span><span class="p">(</span><span class="n">COMMIT_Nolink</span><span class="p">,</span> <span class="n">ip</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">xtlck</span><span class="o">-&gt;</span><span class="n">lwm</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="p">(</span><span class="n">xtlck</span><span class="o">-&gt;</span><span class="n">lwm</span><span class="p">.</span><span class="n">offset</span><span class="p">)</span> <span class="o">?</span>
		    <span class="n">min</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">xtlck</span><span class="o">-&gt;</span><span class="n">lwm</span><span class="p">.</span><span class="n">offset</span><span class="p">)</span> <span class="o">:</span> <span class="n">index</span><span class="p">;</span>
		<span class="n">xtlck</span><span class="o">-&gt;</span><span class="n">lwm</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">nextindex</span><span class="p">)</span> <span class="o">-</span>
		    <span class="n">xtlck</span><span class="o">-&gt;</span><span class="n">lwm</span><span class="p">.</span><span class="n">offset</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* unpin the leaf page */</span>
	<span class="n">XT_PUTPAGE</span><span class="p">(</span><span class="n">mp</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* _NOTYET */</span><span class="cp"></span>

<span class="cm">/*</span>
<span class="cm"> *	xtUpdate()</span>
<span class="cm"> *</span>
<span class="cm"> * function: update XAD;</span>
<span class="cm"> *</span>
<span class="cm"> *	update extent for allocated_but_not_recorded or</span>
<span class="cm"> *	compressed extent;</span>
<span class="cm"> *</span>
<span class="cm"> * parameter:</span>
<span class="cm"> *	nxad	- new XAD;</span>
<span class="cm"> *		logical extent of the specified XAD must be completely</span>
<span class="cm"> *		contained by an existing XAD;</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">xtUpdate</span><span class="p">(</span><span class="n">tid_t</span> <span class="n">tid</span><span class="p">,</span> <span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">ip</span><span class="p">,</span> <span class="n">xad_t</span> <span class="o">*</span> <span class="n">nxad</span><span class="p">)</span>
<span class="p">{</span>				<span class="cm">/* new XAD */</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">cmp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">metapage</span> <span class="o">*</span><span class="n">mp</span><span class="p">;</span>	<span class="cm">/* meta-page buffer */</span>
	<span class="n">xtpage_t</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>		<span class="cm">/* base B+-tree index page */</span>
	<span class="n">s64</span> <span class="n">bn</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">index0</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">newindex</span><span class="p">,</span> <span class="n">nextindex</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">btstack</span> <span class="n">btstack</span><span class="p">;</span>	<span class="cm">/* traverse stack */</span>
	<span class="k">struct</span> <span class="n">xtsplit</span> <span class="n">split</span><span class="p">;</span>	<span class="cm">/* split information */</span>
	<span class="n">xad_t</span> <span class="o">*</span><span class="n">xad</span><span class="p">,</span> <span class="o">*</span><span class="n">lxad</span><span class="p">,</span> <span class="o">*</span><span class="n">rxad</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">xflag</span><span class="p">;</span>
	<span class="n">s64</span> <span class="n">nxoff</span><span class="p">,</span> <span class="n">xoff</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">nxlen</span><span class="p">,</span> <span class="n">xlen</span><span class="p">,</span> <span class="n">lxlen</span><span class="p">,</span> <span class="n">rxlen</span><span class="p">;</span>
	<span class="n">s64</span> <span class="n">nxaddr</span><span class="p">,</span> <span class="n">xaddr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tlock</span> <span class="o">*</span><span class="n">tlck</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">xtlock</span> <span class="o">*</span><span class="n">xtlck</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">newpage</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* there must exist extent to be tailgated */</span>
	<span class="n">nxoff</span> <span class="o">=</span> <span class="n">offsetXAD</span><span class="p">(</span><span class="n">nxad</span><span class="p">);</span>
	<span class="n">nxlen</span> <span class="o">=</span> <span class="n">lengthXAD</span><span class="p">(</span><span class="n">nxad</span><span class="p">);</span>
	<span class="n">nxaddr</span> <span class="o">=</span> <span class="n">addressXAD</span><span class="p">(</span><span class="n">nxad</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">rc</span> <span class="o">=</span> <span class="n">xtSearch</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">nxoff</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">btstack</span><span class="p">,</span> <span class="n">XT_INSERT</span><span class="p">)))</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

	<span class="cm">/* retrieve search result */</span>
	<span class="n">XT_GETSEARCH</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">btstack</span><span class="p">.</span><span class="n">top</span><span class="p">,</span> <span class="n">bn</span><span class="p">,</span> <span class="n">mp</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">index0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cmp</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">XT_PUTPAGE</span><span class="p">(</span><span class="n">mp</span><span class="p">);</span>
		<span class="n">jfs_error</span><span class="p">(</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_sb</span><span class="p">,</span> <span class="s">&quot;xtUpdate: Could not find extent&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">BT_MARK_DIRTY</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="n">ip</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 * acquire tlock of the leaf page containing original entry</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_cflag</span><span class="p">(</span><span class="n">COMMIT_Nolink</span><span class="p">,</span> <span class="n">ip</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">tlck</span> <span class="o">=</span> <span class="n">txLock</span><span class="p">(</span><span class="n">tid</span><span class="p">,</span> <span class="n">ip</span><span class="p">,</span> <span class="n">mp</span><span class="p">,</span> <span class="n">tlckXTREE</span> <span class="o">|</span> <span class="n">tlckGROW</span><span class="p">);</span>
		<span class="n">xtlck</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">xtlock</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">tlck</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">xad</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">xad</span><span class="p">[</span><span class="n">index0</span><span class="p">];</span>
	<span class="n">xflag</span> <span class="o">=</span> <span class="n">xad</span><span class="o">-&gt;</span><span class="n">flag</span><span class="p">;</span>
	<span class="n">xoff</span> <span class="o">=</span> <span class="n">offsetXAD</span><span class="p">(</span><span class="n">xad</span><span class="p">);</span>
	<span class="n">xlen</span> <span class="o">=</span> <span class="n">lengthXAD</span><span class="p">(</span><span class="n">xad</span><span class="p">);</span>
	<span class="n">xaddr</span> <span class="o">=</span> <span class="n">addressXAD</span><span class="p">(</span><span class="n">xad</span><span class="p">);</span>

	<span class="cm">/* nXAD must be completely contained within XAD */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">xoff</span> <span class="o">&gt;</span> <span class="n">nxoff</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">nxoff</span> <span class="o">+</span> <span class="n">nxlen</span> <span class="o">&gt;</span> <span class="n">xoff</span> <span class="o">+</span> <span class="n">xlen</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">XT_PUTPAGE</span><span class="p">(</span><span class="n">mp</span><span class="p">);</span>
		<span class="n">jfs_error</span><span class="p">(</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_sb</span><span class="p">,</span>
			  <span class="s">&quot;xtUpdate: nXAD in not completely contained within XAD&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">index</span> <span class="o">=</span> <span class="n">index0</span><span class="p">;</span>
	<span class="n">newindex</span> <span class="o">=</span> <span class="n">index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">nextindex</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">nextindex</span><span class="p">);</span>

<span class="cp">#ifdef  _JFS_WIP_NOCOALESCE</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">xoff</span> <span class="o">&lt;</span> <span class="n">nxoff</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">updateRight</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * replace XAD with nXAD</span>
<span class="cm">	 */</span>
      <span class="nl">replace:</span>			<span class="cm">/* (nxoff == xoff) */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nxlen</span> <span class="o">==</span> <span class="n">xlen</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* replace XAD with nXAD:recorded */</span>
		<span class="o">*</span><span class="n">xad</span> <span class="o">=</span> <span class="o">*</span><span class="n">nxad</span><span class="p">;</span>
		<span class="n">xad</span><span class="o">-&gt;</span><span class="n">flag</span> <span class="o">=</span> <span class="n">xflag</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">XAD_NOTRECORDED</span><span class="p">;</span>

		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>			<span class="cm">/* (nxlen &lt; xlen) */</span>
		<span class="k">goto</span> <span class="n">updateLeft</span><span class="p">;</span>
<span class="cp">#endif				</span><span class="cm">/* _JFS_WIP_NOCOALESCE */</span><span class="cp"></span>

<span class="cm">/* #ifdef _JFS_WIP_COALESCE */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">xoff</span> <span class="o">&lt;</span> <span class="n">nxoff</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">coalesceRight</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * coalesce with left XAD</span>
<span class="cm">	 */</span></pre></div></td></tr>


<tr id="section-6"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-6">&#182;</a></div><p>coalesceLeft: /* (xoff == nxoff) */</p></td><td class="code"><div class="highlight"><pre>	<span class="cm">/* is XAD first entry of page ? */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">index</span> <span class="o">==</span> <span class="n">XTENTRYSTART</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">replace</span><span class="p">;</span>

	<span class="cm">/* is nXAD logically and physically contiguous with lXAD ? */</span>
	<span class="n">lxad</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">xad</span><span class="p">[</span><span class="n">index</span> <span class="o">-</span> <span class="mi">1</span><span class="p">];</span>
	<span class="n">lxlen</span> <span class="o">=</span> <span class="n">lengthXAD</span><span class="p">(</span><span class="n">lxad</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">lxad</span><span class="o">-&gt;</span><span class="n">flag</span> <span class="o">&amp;</span> <span class="n">XAD_NOTRECORDED</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">nxoff</span> <span class="o">==</span> <span class="n">offsetXAD</span><span class="p">(</span><span class="n">lxad</span><span class="p">)</span> <span class="o">+</span> <span class="n">lxlen</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">nxaddr</span> <span class="o">==</span> <span class="n">addressXAD</span><span class="p">(</span><span class="n">lxad</span><span class="p">)</span> <span class="o">+</span> <span class="n">lxlen</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">lxlen</span> <span class="o">+</span> <span class="n">nxlen</span> <span class="o">&lt;</span> <span class="n">MAXXLEN</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* extend right lXAD */</span>
		<span class="n">index0</span> <span class="o">=</span> <span class="n">index</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">XADlength</span><span class="p">(</span><span class="n">lxad</span><span class="p">,</span> <span class="n">lxlen</span> <span class="o">+</span> <span class="n">nxlen</span><span class="p">);</span>

		<span class="cm">/* If we just merged two extents together, need to make sure the</span>
<span class="cm">		 * right extent gets logged.  If the left one is marked XAD_NEW,</span>
<span class="cm">		 * then we know it will be logged.  Otherwise, mark as</span>
<span class="cm">		 * XAD_EXTENDED</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">lxad</span><span class="o">-&gt;</span><span class="n">flag</span> <span class="o">&amp;</span> <span class="n">XAD_NEW</span><span class="p">))</span>
			<span class="n">lxad</span><span class="o">-&gt;</span><span class="n">flag</span> <span class="o">|=</span> <span class="n">XAD_EXTENDED</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">xlen</span> <span class="o">&gt;</span> <span class="n">nxlen</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* truncate XAD */</span>
			<span class="n">XADoffset</span><span class="p">(</span><span class="n">xad</span><span class="p">,</span> <span class="n">xoff</span> <span class="o">+</span> <span class="n">nxlen</span><span class="p">);</span>
			<span class="n">XADlength</span><span class="p">(</span><span class="n">xad</span><span class="p">,</span> <span class="n">xlen</span> <span class="o">-</span> <span class="n">nxlen</span><span class="p">);</span>
			<span class="n">XADaddress</span><span class="p">(</span><span class="n">xad</span><span class="p">,</span> <span class="n">xaddr</span> <span class="o">+</span> <span class="n">nxlen</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>	<span class="cm">/* (xlen == nxlen) */</span>

			<span class="cm">/* remove XAD */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">index</span> <span class="o">&lt;</span> <span class="n">nextindex</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
				<span class="n">memmove</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">xad</span><span class="p">[</span><span class="n">index</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">xad</span><span class="p">[</span><span class="n">index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">],</span>
					<span class="p">(</span><span class="n">nextindex</span> <span class="o">-</span> <span class="n">index</span> <span class="o">-</span>
					 <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">L2XTSLOTSIZE</span><span class="p">);</span>

			<span class="n">p</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">nextindex</span> <span class="o">=</span>
			    <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">nextindex</span><span class="p">)</span> <span class="o">-</span>
					<span class="mi">1</span><span class="p">);</span>

			<span class="n">index</span> <span class="o">=</span> <span class="n">index0</span><span class="p">;</span>
			<span class="n">newindex</span> <span class="o">=</span> <span class="n">index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">nextindex</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">nextindex</span><span class="p">);</span>
			<span class="n">xoff</span> <span class="o">=</span> <span class="n">nxoff</span> <span class="o">=</span> <span class="n">offsetXAD</span><span class="p">(</span><span class="n">lxad</span><span class="p">);</span>
			<span class="n">xlen</span> <span class="o">=</span> <span class="n">nxlen</span> <span class="o">=</span> <span class="n">lxlen</span> <span class="o">+</span> <span class="n">nxlen</span><span class="p">;</span>
			<span class="n">xaddr</span> <span class="o">=</span> <span class="n">nxaddr</span> <span class="o">=</span> <span class="n">addressXAD</span><span class="p">(</span><span class="n">lxad</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">coalesceRight</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * replace XAD with nXAD</span>
<span class="cm">	 */</span>
      <span class="nl">replace:</span>			<span class="cm">/* (nxoff == xoff) */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nxlen</span> <span class="o">==</span> <span class="n">xlen</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* replace XAD with nXAD:recorded */</span>
		<span class="o">*</span><span class="n">xad</span> <span class="o">=</span> <span class="o">*</span><span class="n">nxad</span><span class="p">;</span>
		<span class="n">xad</span><span class="o">-&gt;</span><span class="n">flag</span> <span class="o">=</span> <span class="n">xflag</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">XAD_NOTRECORDED</span><span class="p">;</span>

		<span class="k">goto</span> <span class="n">coalesceRight</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>			<span class="cm">/* (nxlen &lt; xlen) */</span>
		<span class="k">goto</span> <span class="n">updateLeft</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * coalesce with right XAD</span>
<span class="cm">	 */</span>
      <span class="nl">coalesceRight:</span>		<span class="cm">/* (xoff &lt;= nxoff) */</span>
	<span class="cm">/* is XAD last entry of page ? */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">newindex</span> <span class="o">==</span> <span class="n">nextindex</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">xoff</span> <span class="o">==</span> <span class="n">nxoff</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">updateRight</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* is nXAD logically and physically contiguous with rXAD ? */</span>
	<span class="n">rxad</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">xad</span><span class="p">[</span><span class="n">index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];</span>
	<span class="n">rxlen</span> <span class="o">=</span> <span class="n">lengthXAD</span><span class="p">(</span><span class="n">rxad</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">rxad</span><span class="o">-&gt;</span><span class="n">flag</span> <span class="o">&amp;</span> <span class="n">XAD_NOTRECORDED</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">nxoff</span> <span class="o">+</span> <span class="n">nxlen</span> <span class="o">==</span> <span class="n">offsetXAD</span><span class="p">(</span><span class="n">rxad</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">nxaddr</span> <span class="o">+</span> <span class="n">nxlen</span> <span class="o">==</span> <span class="n">addressXAD</span><span class="p">(</span><span class="n">rxad</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">rxlen</span> <span class="o">+</span> <span class="n">nxlen</span> <span class="o">&lt;</span> <span class="n">MAXXLEN</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* extend left rXAD */</span>
		<span class="n">XADoffset</span><span class="p">(</span><span class="n">rxad</span><span class="p">,</span> <span class="n">nxoff</span><span class="p">);</span>
		<span class="n">XADlength</span><span class="p">(</span><span class="n">rxad</span><span class="p">,</span> <span class="n">rxlen</span> <span class="o">+</span> <span class="n">nxlen</span><span class="p">);</span>
		<span class="n">XADaddress</span><span class="p">(</span><span class="n">rxad</span><span class="p">,</span> <span class="n">nxaddr</span><span class="p">);</span>

		<span class="cm">/* If we just merged two extents together, need to make sure</span>
<span class="cm">		 * the left extent gets logged.  If the right one is marked</span>
<span class="cm">		 * XAD_NEW, then we know it will be logged.  Otherwise, mark as</span>
<span class="cm">		 * XAD_EXTENDED</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">rxad</span><span class="o">-&gt;</span><span class="n">flag</span> <span class="o">&amp;</span> <span class="n">XAD_NEW</span><span class="p">))</span>
			<span class="n">rxad</span><span class="o">-&gt;</span><span class="n">flag</span> <span class="o">|=</span> <span class="n">XAD_EXTENDED</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">xlen</span> <span class="o">&gt;</span> <span class="n">nxlen</span><span class="p">)</span>
			<span class="cm">/* truncate XAD */</span>
			<span class="n">XADlength</span><span class="p">(</span><span class="n">xad</span><span class="p">,</span> <span class="n">xlen</span> <span class="o">-</span> <span class="n">nxlen</span><span class="p">);</span>
		<span class="k">else</span> <span class="p">{</span>		<span class="cm">/* (xlen == nxlen) */</span>

			<span class="cm">/* remove XAD */</span>
			<span class="n">memmove</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">xad</span><span class="p">[</span><span class="n">index</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">xad</span><span class="p">[</span><span class="n">index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">],</span>
				<span class="p">(</span><span class="n">nextindex</span> <span class="o">-</span> <span class="n">index</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">L2XTSLOTSIZE</span><span class="p">);</span>

			<span class="n">p</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">nextindex</span> <span class="o">=</span>
			    <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">nextindex</span><span class="p">)</span> <span class="o">-</span>
					<span class="mi">1</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">xoff</span> <span class="o">==</span> <span class="n">nxoff</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">xoff</span> <span class="o">&gt;=</span> <span class="n">nxoff</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">XT_PUTPAGE</span><span class="p">(</span><span class="n">mp</span><span class="p">);</span>
		<span class="n">jfs_error</span><span class="p">(</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_sb</span><span class="p">,</span> <span class="s">&quot;xtUpdate: xoff &gt;= nxoff&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cm">/* #endif _JFS_WIP_COALESCE */</span>

	<span class="cm">/*</span>
<span class="cm">	 * split XAD into (lXAD, nXAD):</span>
<span class="cm">	 *</span>
<span class="cm">	 *          |---nXAD---&gt;</span>
<span class="cm">	 * --|----------XAD----------|--</span>
<span class="cm">	 *   |-lXAD-|</span>
<span class="cm">	 */</span>
      <span class="nl">updateRight:</span>		<span class="cm">/* (xoff &lt; nxoff) */</span>
	<span class="cm">/* truncate old XAD as lXAD:not_recorded */</span>
	<span class="n">xad</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">xad</span><span class="p">[</span><span class="n">index</span><span class="p">];</span>
	<span class="n">XADlength</span><span class="p">(</span><span class="n">xad</span><span class="p">,</span> <span class="n">nxoff</span> <span class="o">-</span> <span class="n">xoff</span><span class="p">);</span>

	<span class="cm">/* insert nXAD:recorded */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nextindex</span> <span class="o">==</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">maxentry</span><span class="p">))</span> <span class="p">{</span>

		<span class="cm">/* xtSpliUp() unpins leaf pages */</span>
		<span class="n">split</span><span class="p">.</span><span class="n">mp</span> <span class="o">=</span> <span class="n">mp</span><span class="p">;</span>
		<span class="n">split</span><span class="p">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">newindex</span><span class="p">;</span>
		<span class="n">split</span><span class="p">.</span><span class="n">flag</span> <span class="o">=</span> <span class="n">xflag</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">XAD_NOTRECORDED</span><span class="p">;</span>
		<span class="n">split</span><span class="p">.</span><span class="n">off</span> <span class="o">=</span> <span class="n">nxoff</span><span class="p">;</span>
		<span class="n">split</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="n">nxlen</span><span class="p">;</span>
		<span class="n">split</span><span class="p">.</span><span class="n">addr</span> <span class="o">=</span> <span class="n">nxaddr</span><span class="p">;</span>
		<span class="n">split</span><span class="p">.</span><span class="n">pxdlist</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">rc</span> <span class="o">=</span> <span class="n">xtSplitUp</span><span class="p">(</span><span class="n">tid</span><span class="p">,</span> <span class="n">ip</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">split</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">btstack</span><span class="p">)))</span>
			<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

		<span class="cm">/* get back old page */</span>
		<span class="n">XT_GETPAGE</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">bn</span><span class="p">,</span> <span class="n">mp</span><span class="p">,</span> <span class="n">PSIZE</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
		<span class="cm">/*</span>
<span class="cm">		 * if leaf root has been split, original root has been</span>
<span class="cm">		 * copied to new child page, i.e., original entry now</span>
<span class="cm">		 * resides on the new child page;</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">flag</span> <span class="o">&amp;</span> <span class="n">BT_INTERNAL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ASSERT</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">nextindex</span> <span class="o">==</span>
			       <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">XTENTRYSTART</span> <span class="o">+</span> <span class="mi">1</span><span class="p">));</span>
			<span class="n">xad</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">xad</span><span class="p">[</span><span class="n">XTENTRYSTART</span><span class="p">];</span>
			<span class="n">bn</span> <span class="o">=</span> <span class="n">addressXAD</span><span class="p">(</span><span class="n">xad</span><span class="p">);</span>
			<span class="n">XT_PUTPAGE</span><span class="p">(</span><span class="n">mp</span><span class="p">);</span>

			<span class="cm">/* get new child page */</span>
			<span class="n">XT_GETPAGE</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">bn</span><span class="p">,</span> <span class="n">mp</span><span class="p">,</span> <span class="n">PSIZE</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

			<span class="n">BT_MARK_DIRTY</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="n">ip</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_cflag</span><span class="p">(</span><span class="n">COMMIT_Nolink</span><span class="p">,</span> <span class="n">ip</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">tlck</span> <span class="o">=</span> <span class="n">txLock</span><span class="p">(</span><span class="n">tid</span><span class="p">,</span> <span class="n">ip</span><span class="p">,</span> <span class="n">mp</span><span class="p">,</span> <span class="n">tlckXTREE</span><span class="o">|</span><span class="n">tlckGROW</span><span class="p">);</span>
				<span class="n">xtlck</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">xtlock</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">tlck</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* is nXAD on new page ? */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">newindex</span> <span class="o">&gt;</span>
			    <span class="p">(</span><span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">maxentry</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">newindex</span> <span class="o">=</span>
				    <span class="n">newindex</span> <span class="o">-</span>
				    <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">nextindex</span><span class="p">)</span> <span class="o">+</span>
				    <span class="n">XTENTRYSTART</span><span class="p">;</span>
				<span class="n">newpage</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* if insert into middle, shift right remaining entries */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">newindex</span> <span class="o">&lt;</span> <span class="n">nextindex</span><span class="p">)</span>
			<span class="n">memmove</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">xad</span><span class="p">[</span><span class="n">newindex</span> <span class="o">+</span> <span class="mi">1</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">xad</span><span class="p">[</span><span class="n">newindex</span><span class="p">],</span>
				<span class="p">(</span><span class="n">nextindex</span> <span class="o">-</span> <span class="n">newindex</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">L2XTSLOTSIZE</span><span class="p">);</span>

		<span class="cm">/* insert the entry */</span>
		<span class="n">xad</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">xad</span><span class="p">[</span><span class="n">newindex</span><span class="p">];</span>
		<span class="o">*</span><span class="n">xad</span> <span class="o">=</span> <span class="o">*</span><span class="n">nxad</span><span class="p">;</span>
		<span class="n">xad</span><span class="o">-&gt;</span><span class="n">flag</span> <span class="o">=</span> <span class="n">xflag</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">XAD_NOTRECORDED</span><span class="p">;</span>

		<span class="cm">/* advance next available entry index. */</span>
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">nextindex</span> <span class="o">=</span>
		    <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">nextindex</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * does nXAD force 3-way split ?</span>
<span class="cm">	 *</span>
<span class="cm">	 *          |---nXAD---&gt;|</span>
<span class="cm">	 * --|----------XAD-------------|--</span>
<span class="cm">	 *   |-lXAD-|           |-rXAD -|</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nxoff</span> <span class="o">+</span> <span class="n">nxlen</span> <span class="o">==</span> <span class="n">xoff</span> <span class="o">+</span> <span class="n">xlen</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="cm">/* reorient nXAD as XAD for further split XAD into (nXAD, rXAD) */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">newpage</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* close out old page */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_cflag</span><span class="p">(</span><span class="n">COMMIT_Nolink</span><span class="p">,</span> <span class="n">ip</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">xtlck</span><span class="o">-&gt;</span><span class="n">lwm</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="p">(</span><span class="n">xtlck</span><span class="o">-&gt;</span><span class="n">lwm</span><span class="p">.</span><span class="n">offset</span><span class="p">)</span> <span class="o">?</span>
			    <span class="n">min</span><span class="p">(</span><span class="n">index0</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">xtlck</span><span class="o">-&gt;</span><span class="n">lwm</span><span class="p">.</span><span class="n">offset</span><span class="p">)</span> <span class="o">:</span> <span class="n">index0</span><span class="p">;</span>
			<span class="n">xtlck</span><span class="o">-&gt;</span><span class="n">lwm</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span>
			    <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">nextindex</span><span class="p">)</span> <span class="o">-</span>
			    <span class="n">xtlck</span><span class="o">-&gt;</span><span class="n">lwm</span><span class="p">.</span><span class="n">offset</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">bn</span> <span class="o">=</span> <span class="n">le64_to_cpu</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">next</span><span class="p">);</span>
		<span class="n">XT_PUTPAGE</span><span class="p">(</span><span class="n">mp</span><span class="p">);</span>

		<span class="cm">/* get new right page */</span>
		<span class="n">XT_GETPAGE</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">bn</span><span class="p">,</span> <span class="n">mp</span><span class="p">,</span> <span class="n">PSIZE</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

		<span class="n">BT_MARK_DIRTY</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="n">ip</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_cflag</span><span class="p">(</span><span class="n">COMMIT_Nolink</span><span class="p">,</span> <span class="n">ip</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">tlck</span> <span class="o">=</span> <span class="n">txLock</span><span class="p">(</span><span class="n">tid</span><span class="p">,</span> <span class="n">ip</span><span class="p">,</span> <span class="n">mp</span><span class="p">,</span> <span class="n">tlckXTREE</span> <span class="o">|</span> <span class="n">tlckGROW</span><span class="p">);</span>
			<span class="n">xtlck</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">xtlock</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">tlck</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">index0</span> <span class="o">=</span> <span class="n">index</span> <span class="o">=</span> <span class="n">newindex</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">index</span><span class="o">++</span><span class="p">;</span>

	<span class="n">newindex</span> <span class="o">=</span> <span class="n">index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">nextindex</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">nextindex</span><span class="p">);</span>
	<span class="n">xlen</span> <span class="o">=</span> <span class="n">xlen</span> <span class="o">-</span> <span class="p">(</span><span class="n">nxoff</span> <span class="o">-</span> <span class="n">xoff</span><span class="p">);</span>
	<span class="n">xoff</span> <span class="o">=</span> <span class="n">nxoff</span><span class="p">;</span>
	<span class="n">xaddr</span> <span class="o">=</span> <span class="n">nxaddr</span><span class="p">;</span>

	<span class="cm">/* recompute split pages */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nextindex</span> <span class="o">==</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">maxentry</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">XT_PUTPAGE</span><span class="p">(</span><span class="n">mp</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">rc</span> <span class="o">=</span> <span class="n">xtSearch</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">nxoff</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">btstack</span><span class="p">,</span> <span class="n">XT_INSERT</span><span class="p">)))</span>
			<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

		<span class="cm">/* retrieve search result */</span>
		<span class="n">XT_GETSEARCH</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">btstack</span><span class="p">.</span><span class="n">top</span><span class="p">,</span> <span class="n">bn</span><span class="p">,</span> <span class="n">mp</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">index0</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">cmp</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">XT_PUTPAGE</span><span class="p">(</span><span class="n">mp</span><span class="p">);</span>
			<span class="n">jfs_error</span><span class="p">(</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_sb</span><span class="p">,</span> <span class="s">&quot;xtUpdate: xtSearch failed&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">index0</span> <span class="o">!=</span> <span class="n">index</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">XT_PUTPAGE</span><span class="p">(</span><span class="n">mp</span><span class="p">);</span>
			<span class="n">jfs_error</span><span class="p">(</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_sb</span><span class="p">,</span>
				  <span class="s">&quot;xtUpdate: unexpected value of index&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * split XAD into (nXAD, rXAD)</span>
<span class="cm">	 *</span>
<span class="cm">	 *          ---nXAD---|</span>
<span class="cm">	 * --|----------XAD----------|--</span>
<span class="cm">	 *                    |-rXAD-|</span>
<span class="cm">	 */</span>
      <span class="nl">updateLeft:</span>		<span class="cm">/* (nxoff == xoff) &amp;&amp; (nxlen &lt; xlen) */</span>
	<span class="cm">/* update old XAD with nXAD:recorded */</span>
	<span class="n">xad</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">xad</span><span class="p">[</span><span class="n">index</span><span class="p">];</span>
	<span class="o">*</span><span class="n">xad</span> <span class="o">=</span> <span class="o">*</span><span class="n">nxad</span><span class="p">;</span>
	<span class="n">xad</span><span class="o">-&gt;</span><span class="n">flag</span> <span class="o">=</span> <span class="n">xflag</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">XAD_NOTRECORDED</span><span class="p">;</span>

	<span class="cm">/* insert rXAD:not_recorded */</span>
	<span class="n">xoff</span> <span class="o">=</span> <span class="n">xoff</span> <span class="o">+</span> <span class="n">nxlen</span><span class="p">;</span>
	<span class="n">xlen</span> <span class="o">=</span> <span class="n">xlen</span> <span class="o">-</span> <span class="n">nxlen</span><span class="p">;</span>
	<span class="n">xaddr</span> <span class="o">=</span> <span class="n">xaddr</span> <span class="o">+</span> <span class="n">nxlen</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nextindex</span> <span class="o">==</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">maxentry</span><span class="p">))</span> <span class="p">{</span>
<span class="cm">/*</span>
<span class="cm">printf(&quot;xtUpdate.updateLeft.split p:0x%p\n&quot;, p);</span>
<span class="cm">*/</span>
		<span class="cm">/* xtSpliUp() unpins leaf pages */</span>
		<span class="n">split</span><span class="p">.</span><span class="n">mp</span> <span class="o">=</span> <span class="n">mp</span><span class="p">;</span>
		<span class="n">split</span><span class="p">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">newindex</span><span class="p">;</span>
		<span class="n">split</span><span class="p">.</span><span class="n">flag</span> <span class="o">=</span> <span class="n">xflag</span><span class="p">;</span>
		<span class="n">split</span><span class="p">.</span><span class="n">off</span> <span class="o">=</span> <span class="n">xoff</span><span class="p">;</span>
		<span class="n">split</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="n">xlen</span><span class="p">;</span>
		<span class="n">split</span><span class="p">.</span><span class="n">addr</span> <span class="o">=</span> <span class="n">xaddr</span><span class="p">;</span>
		<span class="n">split</span><span class="p">.</span><span class="n">pxdlist</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">rc</span> <span class="o">=</span> <span class="n">xtSplitUp</span><span class="p">(</span><span class="n">tid</span><span class="p">,</span> <span class="n">ip</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">split</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">btstack</span><span class="p">)))</span>
			<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

		<span class="cm">/* get back old page */</span>
		<span class="n">XT_GETPAGE</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">bn</span><span class="p">,</span> <span class="n">mp</span><span class="p">,</span> <span class="n">PSIZE</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * if leaf root has been split, original root has been</span>
<span class="cm">		 * copied to new child page, i.e., original entry now</span>
<span class="cm">		 * resides on the new child page;</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">flag</span> <span class="o">&amp;</span> <span class="n">BT_INTERNAL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ASSERT</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">nextindex</span> <span class="o">==</span>
			       <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">XTENTRYSTART</span> <span class="o">+</span> <span class="mi">1</span><span class="p">));</span>
			<span class="n">xad</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">xad</span><span class="p">[</span><span class="n">XTENTRYSTART</span><span class="p">];</span>
			<span class="n">bn</span> <span class="o">=</span> <span class="n">addressXAD</span><span class="p">(</span><span class="n">xad</span><span class="p">);</span>
			<span class="n">XT_PUTPAGE</span><span class="p">(</span><span class="n">mp</span><span class="p">);</span>

			<span class="cm">/* get new child page */</span>
			<span class="n">XT_GETPAGE</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">bn</span><span class="p">,</span> <span class="n">mp</span><span class="p">,</span> <span class="n">PSIZE</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

			<span class="n">BT_MARK_DIRTY</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="n">ip</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_cflag</span><span class="p">(</span><span class="n">COMMIT_Nolink</span><span class="p">,</span> <span class="n">ip</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">tlck</span> <span class="o">=</span> <span class="n">txLock</span><span class="p">(</span><span class="n">tid</span><span class="p">,</span> <span class="n">ip</span><span class="p">,</span> <span class="n">mp</span><span class="p">,</span> <span class="n">tlckXTREE</span><span class="o">|</span><span class="n">tlckGROW</span><span class="p">);</span>
				<span class="n">xtlck</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">xtlock</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">tlck</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* if insert into middle, shift right remaining entries */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">newindex</span> <span class="o">&lt;</span> <span class="n">nextindex</span><span class="p">)</span>
			<span class="n">memmove</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">xad</span><span class="p">[</span><span class="n">newindex</span> <span class="o">+</span> <span class="mi">1</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">xad</span><span class="p">[</span><span class="n">newindex</span><span class="p">],</span>
				<span class="p">(</span><span class="n">nextindex</span> <span class="o">-</span> <span class="n">newindex</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">L2XTSLOTSIZE</span><span class="p">);</span>

		<span class="cm">/* insert the entry */</span>
		<span class="n">xad</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">xad</span><span class="p">[</span><span class="n">newindex</span><span class="p">];</span>
		<span class="n">XT_PUTENTRY</span><span class="p">(</span><span class="n">xad</span><span class="p">,</span> <span class="n">xflag</span><span class="p">,</span> <span class="n">xoff</span><span class="p">,</span> <span class="n">xlen</span><span class="p">,</span> <span class="n">xaddr</span><span class="p">);</span>

		<span class="cm">/* advance next available entry index. */</span>
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">nextindex</span> <span class="o">=</span>
		    <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">nextindex</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>

      <span class="nl">out:</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_cflag</span><span class="p">(</span><span class="n">COMMIT_Nolink</span><span class="p">,</span> <span class="n">ip</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">xtlck</span><span class="o">-&gt;</span><span class="n">lwm</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="p">(</span><span class="n">xtlck</span><span class="o">-&gt;</span><span class="n">lwm</span><span class="p">.</span><span class="n">offset</span><span class="p">)</span> <span class="o">?</span>
		    <span class="n">min</span><span class="p">(</span><span class="n">index0</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">xtlck</span><span class="o">-&gt;</span><span class="n">lwm</span><span class="p">.</span><span class="n">offset</span><span class="p">)</span> <span class="o">:</span> <span class="n">index0</span><span class="p">;</span>
		<span class="n">xtlck</span><span class="o">-&gt;</span><span class="n">lwm</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">nextindex</span><span class="p">)</span> <span class="o">-</span>
		    <span class="n">xtlck</span><span class="o">-&gt;</span><span class="n">lwm</span><span class="p">.</span><span class="n">offset</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* unpin the leaf page */</span>
	<span class="n">XT_PUTPAGE</span><span class="p">(</span><span class="n">mp</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> *	xtAppend()</span>
<span class="cm"> *</span>
<span class="cm"> * function: grow in append mode from contiguous region specified ;</span>
<span class="cm"> *</span>
<span class="cm"> * parameter:</span>
<span class="cm"> *	tid		- transaction id;</span>
<span class="cm"> *	ip		- file object;</span>
<span class="cm"> *	xflag		- extent flag:</span>
<span class="cm"> *	xoff		- extent offset;</span>
<span class="cm"> *	maxblocks	- max extent length;</span>
<span class="cm"> *	xlen		- extent length (in/out);</span>
<span class="cm"> *	xaddrp		- extent address pointer (in/out):</span>
<span class="cm"> *	flag		-</span>
<span class="cm"> *</span>
<span class="cm"> * return:</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">xtAppend</span><span class="p">(</span><span class="n">tid_t</span> <span class="n">tid</span><span class="p">,</span>		<span class="cm">/* transaction id */</span>
	     <span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">ip</span><span class="p">,</span> <span class="kt">int</span> <span class="n">xflag</span><span class="p">,</span> <span class="n">s64</span> <span class="n">xoff</span><span class="p">,</span> <span class="n">s32</span> <span class="n">maxblocks</span><span class="p">,</span>
	     <span class="n">s32</span> <span class="o">*</span> <span class="n">xlenp</span><span class="p">,</span>	<span class="cm">/* (in/out) */</span>
	     <span class="n">s64</span> <span class="o">*</span> <span class="n">xaddrp</span><span class="p">,</span>	<span class="cm">/* (in/out) */</span>
	     <span class="kt">int</span> <span class="n">flag</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">metapage</span> <span class="o">*</span><span class="n">mp</span><span class="p">;</span>	<span class="cm">/* meta-page buffer */</span>
	<span class="n">xtpage_t</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>		<span class="cm">/* base B+-tree index page */</span>
	<span class="n">s64</span> <span class="n">bn</span><span class="p">,</span> <span class="n">xaddr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">index</span><span class="p">,</span> <span class="n">nextindex</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">btstack</span> <span class="n">btstack</span><span class="p">;</span>	<span class="cm">/* traverse stack */</span>
	<span class="k">struct</span> <span class="n">xtsplit</span> <span class="n">split</span><span class="p">;</span>	<span class="cm">/* split information */</span>
	<span class="n">xad_t</span> <span class="o">*</span><span class="n">xad</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">cmp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tlock</span> <span class="o">*</span><span class="n">tlck</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">xtlock</span> <span class="o">*</span><span class="n">xtlck</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">nsplit</span><span class="p">,</span> <span class="n">nblocks</span><span class="p">,</span> <span class="n">xlen</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pxdlist</span> <span class="n">pxdlist</span><span class="p">;</span>
	<span class="n">pxd_t</span> <span class="o">*</span><span class="n">pxd</span><span class="p">;</span>
	<span class="n">s64</span> <span class="n">next</span><span class="p">;</span>

	<span class="n">xaddr</span> <span class="o">=</span> <span class="o">*</span><span class="n">xaddrp</span><span class="p">;</span>
	<span class="n">xlen</span> <span class="o">=</span> <span class="o">*</span><span class="n">xlenp</span><span class="p">;</span>
	<span class="n">jfs_info</span><span class="p">(</span><span class="s">&quot;xtAppend: xoff:0x%lx maxblocks:%d xlen:%d xaddr:0x%lx&quot;</span><span class="p">,</span>
		 <span class="p">(</span><span class="n">ulong</span><span class="p">)</span> <span class="n">xoff</span><span class="p">,</span> <span class="n">maxblocks</span><span class="p">,</span> <span class="n">xlen</span><span class="p">,</span> <span class="p">(</span><span class="n">ulong</span><span class="p">)</span> <span class="n">xaddr</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 *	search for the entry location at which to insert:</span>
<span class="cm">	 *</span>
<span class="cm">	 * xtFastSearch() and xtSearch() both returns (leaf page</span>
<span class="cm">	 * pinned, index at which to insert).</span>
<span class="cm">	 * n.b. xtSearch() may return index of maxentry of</span>
<span class="cm">	 * the full page.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">rc</span> <span class="o">=</span> <span class="n">xtSearch</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">xoff</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">next</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">btstack</span><span class="p">,</span> <span class="n">XT_INSERT</span><span class="p">)))</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

	<span class="cm">/* retrieve search result */</span>
	<span class="n">XT_GETSEARCH</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">btstack</span><span class="p">.</span><span class="n">top</span><span class="p">,</span> <span class="n">bn</span><span class="p">,</span> <span class="n">mp</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">index</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cmp</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EEXIST</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">next</span><span class="p">)</span>
		<span class="n">xlen</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">xlen</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)(</span><span class="n">next</span> <span class="o">-</span> <span class="n">xoff</span><span class="p">));</span></pre></div></td></tr>


<tr id="section-7"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-7">&#182;</a></div><p>insert:</p></td><td class="code"><div class="highlight"><pre>	<span class="cm">/*</span>
<span class="cm">	 *	insert entry for new extent</span>
<span class="cm">	 */</span>
	<span class="n">xflag</span> <span class="o">|=</span> <span class="n">XAD_NEW</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 *	if the leaf page is full, split the page and</span>
<span class="cm">	 *	propagate up the router entry for the new page from split</span>
<span class="cm">	 *</span>
<span class="cm">	 * The xtSplitUp() will insert the entry and unpin the leaf page.</span>
<span class="cm">	 */</span>
	<span class="n">nextindex</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">nextindex</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nextindex</span> <span class="o">&lt;</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">maxentry</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">insertLeaf</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * allocate new index blocks to cover index page split(s)</span>
<span class="cm">	 */</span>
	<span class="n">nsplit</span> <span class="o">=</span> <span class="n">btstack</span><span class="p">.</span><span class="n">nsplit</span><span class="p">;</span>
	<span class="n">split</span><span class="p">.</span><span class="n">pxdlist</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pxdlist</span><span class="p">;</span>
	<span class="n">pxdlist</span><span class="p">.</span><span class="n">maxnpxd</span> <span class="o">=</span> <span class="n">pxdlist</span><span class="p">.</span><span class="n">npxd</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pxd</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pxdlist</span><span class="p">.</span><span class="n">pxd</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">nblocks</span> <span class="o">=</span> <span class="n">JFS_SBI</span><span class="p">(</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_sb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">nbperpage</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(;</span> <span class="n">nsplit</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">;</span> <span class="n">nsplit</span><span class="o">--</span><span class="p">,</span> <span class="n">pxd</span><span class="o">++</span><span class="p">,</span> <span class="n">xaddr</span> <span class="o">+=</span> <span class="n">nblocks</span><span class="p">,</span> <span class="n">maxblocks</span> <span class="o">-=</span> <span class="n">nblocks</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">rc</span> <span class="o">=</span> <span class="n">dbAllocBottomUp</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">xaddr</span><span class="p">,</span> <span class="p">(</span><span class="n">s64</span><span class="p">)</span> <span class="n">nblocks</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">PXDaddress</span><span class="p">(</span><span class="n">pxd</span><span class="p">,</span> <span class="n">xaddr</span><span class="p">);</span>
			<span class="n">PXDlength</span><span class="p">(</span><span class="n">pxd</span><span class="p">,</span> <span class="n">nblocks</span><span class="p">);</span>

			<span class="n">pxdlist</span><span class="p">.</span><span class="n">maxnpxd</span><span class="o">++</span><span class="p">;</span>

			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* undo allocation */</span>

		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">xlen</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">xlen</span><span class="p">,</span> <span class="n">maxblocks</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * allocate data extent requested</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">rc</span> <span class="o">=</span> <span class="n">dbAllocBottomUp</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">xaddr</span><span class="p">,</span> <span class="p">(</span><span class="n">s64</span><span class="p">)</span> <span class="n">xlen</span><span class="p">)))</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">split</span><span class="p">.</span><span class="n">mp</span> <span class="o">=</span> <span class="n">mp</span><span class="p">;</span>
	<span class="n">split</span><span class="p">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">index</span><span class="p">;</span>
	<span class="n">split</span><span class="p">.</span><span class="n">flag</span> <span class="o">=</span> <span class="n">xflag</span><span class="p">;</span>
	<span class="n">split</span><span class="p">.</span><span class="n">off</span> <span class="o">=</span> <span class="n">xoff</span><span class="p">;</span>
	<span class="n">split</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="n">xlen</span><span class="p">;</span>
	<span class="n">split</span><span class="p">.</span><span class="n">addr</span> <span class="o">=</span> <span class="n">xaddr</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">rc</span> <span class="o">=</span> <span class="n">xtSplitUp</span><span class="p">(</span><span class="n">tid</span><span class="p">,</span> <span class="n">ip</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">split</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">btstack</span><span class="p">)))</span> <span class="p">{</span>
		<span class="cm">/* undo data extent allocation */</span>
		<span class="n">dbFree</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="o">*</span><span class="n">xaddrp</span><span class="p">,</span> <span class="p">(</span><span class="n">s64</span><span class="p">)</span> <span class="o">*</span> <span class="n">xlenp</span><span class="p">);</span>

		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="o">*</span><span class="n">xaddrp</span> <span class="o">=</span> <span class="n">xaddr</span><span class="p">;</span>
	<span class="o">*</span><span class="n">xlenp</span> <span class="o">=</span> <span class="n">xlen</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 *	insert the new entry into the leaf page</span>
<span class="cm">	 */</span>
      <span class="nl">insertLeaf:</span>
	<span class="cm">/*</span>
<span class="cm">	 * allocate data extent requested</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">rc</span> <span class="o">=</span> <span class="n">dbAllocBottomUp</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">xaddr</span><span class="p">,</span> <span class="p">(</span><span class="n">s64</span><span class="p">)</span> <span class="n">xlen</span><span class="p">)))</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">BT_MARK_DIRTY</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="n">ip</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 * acquire a transaction lock on the leaf page;</span>
<span class="cm">	 *</span>
<span class="cm">	 * action: xad insertion/extension;</span>
<span class="cm">	 */</span>
	<span class="n">tlck</span> <span class="o">=</span> <span class="n">txLock</span><span class="p">(</span><span class="n">tid</span><span class="p">,</span> <span class="n">ip</span><span class="p">,</span> <span class="n">mp</span><span class="p">,</span> <span class="n">tlckXTREE</span> <span class="o">|</span> <span class="n">tlckGROW</span><span class="p">);</span>
	<span class="n">xtlck</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">xtlock</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">tlck</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">;</span>

	<span class="cm">/* insert the new entry: mark the entry NEW */</span>
	<span class="n">xad</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">xad</span><span class="p">[</span><span class="n">index</span><span class="p">];</span>
	<span class="n">XT_PUTENTRY</span><span class="p">(</span><span class="n">xad</span><span class="p">,</span> <span class="n">xflag</span><span class="p">,</span> <span class="n">xoff</span><span class="p">,</span> <span class="n">xlen</span><span class="p">,</span> <span class="n">xaddr</span><span class="p">);</span>

	<span class="cm">/* advance next available entry index */</span>
	<span class="n">le16_add_cpu</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">nextindex</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">xtlck</span><span class="o">-&gt;</span><span class="n">lwm</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span>
	    <span class="p">(</span><span class="n">xtlck</span><span class="o">-&gt;</span><span class="n">lwm</span><span class="p">.</span><span class="n">offset</span><span class="p">)</span> <span class="o">?</span> <span class="n">min</span><span class="p">(</span><span class="n">index</span><span class="p">,(</span><span class="kt">int</span><span class="p">)</span> <span class="n">xtlck</span><span class="o">-&gt;</span><span class="n">lwm</span><span class="p">.</span><span class="n">offset</span><span class="p">)</span> <span class="o">:</span> <span class="n">index</span><span class="p">;</span>
	<span class="n">xtlck</span><span class="o">-&gt;</span><span class="n">lwm</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">nextindex</span><span class="p">)</span> <span class="o">-</span>
	    <span class="n">xtlck</span><span class="o">-&gt;</span><span class="n">lwm</span><span class="p">.</span><span class="n">offset</span><span class="p">;</span>

	<span class="o">*</span><span class="n">xaddrp</span> <span class="o">=</span> <span class="n">xaddr</span><span class="p">;</span>
	<span class="o">*</span><span class="n">xlenp</span> <span class="o">=</span> <span class="n">xlen</span><span class="p">;</span>

      <span class="nl">out:</span>
	<span class="cm">/* unpin the leaf page */</span>
	<span class="n">XT_PUTPAGE</span><span class="p">(</span><span class="n">mp</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#ifdef _STILL_TO_PORT</span>

<span class="cm">/* - TBD for defragmentaion/reorganization -</span>
<span class="cm"> *</span>
<span class="cm"> *	xtDelete()</span>
<span class="cm"> *</span>
<span class="cm"> * function:</span>
<span class="cm"> *	delete the entry with the specified key.</span>
<span class="cm"> *</span>
<span class="cm"> *	N.B.: whole extent of the entry is assumed to be deleted.</span>
<span class="cm"> *</span>
<span class="cm"> * parameter:</span>
<span class="cm"> *</span>
<span class="cm"> * return:</span>
<span class="cm"> *	ENOENT: if the entry is not found.</span>
<span class="cm"> *</span>
<span class="cm"> * exception:</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">xtDelete</span><span class="p">(</span><span class="n">tid_t</span> <span class="n">tid</span><span class="p">,</span> <span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">ip</span><span class="p">,</span> <span class="n">s64</span> <span class="n">xoff</span><span class="p">,</span> <span class="n">s32</span> <span class="n">xlen</span><span class="p">,</span> <span class="kt">int</span> <span class="n">flag</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">btstack</span> <span class="n">btstack</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">cmp</span><span class="p">;</span>
	<span class="n">s64</span> <span class="n">bn</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">metapage</span> <span class="o">*</span><span class="n">mp</span><span class="p">;</span>
	<span class="n">xtpage_t</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">index</span><span class="p">,</span> <span class="n">nextindex</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tlock</span> <span class="o">*</span><span class="n">tlck</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">xtlock</span> <span class="o">*</span><span class="n">xtlck</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * find the matching entry; xtSearch() pins the page</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">rc</span> <span class="o">=</span> <span class="n">xtSearch</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">xoff</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">btstack</span><span class="p">,</span> <span class="mi">0</span><span class="p">)))</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">XT_GETSEARCH</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">btstack</span><span class="p">.</span><span class="n">top</span><span class="p">,</span> <span class="n">bn</span><span class="p">,</span> <span class="n">mp</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">index</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmp</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* unpin the leaf page */</span>
		<span class="n">XT_PUTPAGE</span><span class="p">(</span><span class="n">mp</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * delete the entry from the leaf page</span>
<span class="cm">	 */</span>
	<span class="n">nextindex</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">nextindex</span><span class="p">);</span>
	<span class="n">le16_add_cpu</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">nextindex</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * if the leaf page bocome empty, free the page</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">nextindex</span> <span class="o">==</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">XTENTRYSTART</span><span class="p">))</span>
		<span class="k">return</span> <span class="p">(</span><span class="n">xtDeleteUp</span><span class="p">(</span><span class="n">tid</span><span class="p">,</span> <span class="n">ip</span><span class="p">,</span> <span class="n">mp</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">btstack</span><span class="p">));</span>

	<span class="n">BT_MARK_DIRTY</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="n">ip</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 * acquire a transaction lock on the leaf page;</span>
<span class="cm">	 *</span>
<span class="cm">	 * action:xad deletion;</span>
<span class="cm">	 */</span>
	<span class="n">tlck</span> <span class="o">=</span> <span class="n">txLock</span><span class="p">(</span><span class="n">tid</span><span class="p">,</span> <span class="n">ip</span><span class="p">,</span> <span class="n">mp</span><span class="p">,</span> <span class="n">tlckXTREE</span><span class="p">);</span>
	<span class="n">xtlck</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">xtlock</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">tlck</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">;</span>
	<span class="n">xtlck</span><span class="o">-&gt;</span><span class="n">lwm</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span>
	    <span class="p">(</span><span class="n">xtlck</span><span class="o">-&gt;</span><span class="n">lwm</span><span class="p">.</span><span class="n">offset</span><span class="p">)</span> <span class="o">?</span> <span class="n">min</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">xtlck</span><span class="o">-&gt;</span><span class="n">lwm</span><span class="p">.</span><span class="n">offset</span><span class="p">)</span> <span class="o">:</span> <span class="n">index</span><span class="p">;</span>

	<span class="cm">/* if delete from middle, shift left/compact the remaining entries */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">index</span> <span class="o">&lt;</span> <span class="n">nextindex</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">memmove</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">xad</span><span class="p">[</span><span class="n">index</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">xad</span><span class="p">[</span><span class="n">index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">],</span>
			<span class="p">(</span><span class="n">nextindex</span> <span class="o">-</span> <span class="n">index</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">xad_t</span><span class="p">));</span>

	<span class="n">XT_PUTPAGE</span><span class="p">(</span><span class="n">mp</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/* - TBD for defragmentaion/reorganization -</span>
<span class="cm"> *</span>
<span class="cm"> *	xtDeleteUp()</span>
<span class="cm"> *</span>
<span class="cm"> * function:</span>
<span class="cm"> *	free empty pages as propagating deletion up the tree</span>
<span class="cm"> *</span>
<span class="cm"> * parameter:</span>
<span class="cm"> *</span>
<span class="cm"> * return:</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">xtDeleteUp</span><span class="p">(</span><span class="n">tid_t</span> <span class="n">tid</span><span class="p">,</span> <span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">ip</span><span class="p">,</span>
	   <span class="k">struct</span> <span class="n">metapage</span> <span class="o">*</span> <span class="n">fmp</span><span class="p">,</span> <span class="n">xtpage_t</span> <span class="o">*</span> <span class="n">fp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">btstack</span> <span class="o">*</span> <span class="n">btstack</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">metapage</span> <span class="o">*</span><span class="n">mp</span><span class="p">;</span>
	<span class="n">xtpage_t</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">index</span><span class="p">,</span> <span class="n">nextindex</span><span class="p">;</span>
	<span class="n">s64</span> <span class="n">xaddr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">xlen</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">btframe</span> <span class="o">*</span><span class="n">parent</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tlock</span> <span class="o">*</span><span class="n">tlck</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">xtlock</span> <span class="o">*</span><span class="n">xtlck</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * keep root leaf page which has become empty</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">flag</span> <span class="o">&amp;</span> <span class="n">BT_ROOT</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* keep the root page */</span>
		<span class="n">fp</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">flag</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">BT_INTERNAL</span><span class="p">;</span>
		<span class="n">fp</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">flag</span> <span class="o">|=</span> <span class="n">BT_LEAF</span><span class="p">;</span>
		<span class="n">fp</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">nextindex</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">XTENTRYSTART</span><span class="p">);</span>

		<span class="cm">/* XT_PUTPAGE(fmp); */</span>

		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * free non-root leaf page</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">rc</span> <span class="o">=</span> <span class="n">xtRelink</span><span class="p">(</span><span class="n">tid</span><span class="p">,</span> <span class="n">ip</span><span class="p">,</span> <span class="n">fp</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">XT_PUTPAGE</span><span class="p">(</span><span class="n">fmp</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">xaddr</span> <span class="o">=</span> <span class="n">addressPXD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">self</span><span class="p">);</span>
	<span class="n">xlen</span> <span class="o">=</span> <span class="n">lengthPXD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">self</span><span class="p">);</span>
	<span class="cm">/* free the page extent */</span>
	<span class="n">dbFree</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">xaddr</span><span class="p">,</span> <span class="p">(</span><span class="n">s64</span><span class="p">)</span> <span class="n">xlen</span><span class="p">);</span>

	<span class="cm">/* free the buffer page */</span>
	<span class="n">discard_metapage</span><span class="p">(</span><span class="n">fmp</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * propagate page deletion up the index tree</span>
<span class="cm">	 *</span>
<span class="cm">	 * If the delete from the parent page makes it empty,</span>
<span class="cm">	 * continue all the way up the tree.</span>
<span class="cm">	 * stop if the root page is reached (which is never deleted) or</span>
<span class="cm">	 * if the entry deletion does not empty the page.</span>
<span class="cm">	 */</span>
	<span class="k">while</span> <span class="p">((</span><span class="n">parent</span> <span class="o">=</span> <span class="n">BT_POP</span><span class="p">(</span><span class="n">btstack</span><span class="p">))</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* get/pin the parent page &lt;sp&gt; */</span>
		<span class="n">XT_GETPAGE</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">parent</span><span class="o">-&gt;</span><span class="n">bn</span><span class="p">,</span> <span class="n">mp</span><span class="p">,</span> <span class="n">PSIZE</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

		<span class="n">index</span> <span class="o">=</span> <span class="n">parent</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">;</span>

		<span class="cm">/* delete the entry for the freed child page from parent.</span>
<span class="cm">		 */</span>
		<span class="n">nextindex</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">nextindex</span><span class="p">);</span>

		<span class="cm">/*</span>
<span class="cm">		 * the parent has the single entry being deleted:</span>
<span class="cm">		 * free the parent page which has become empty.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">nextindex</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">flag</span> <span class="o">&amp;</span> <span class="n">BT_ROOT</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* keep the root page */</span>
				<span class="n">p</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">flag</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">BT_INTERNAL</span><span class="p">;</span>
				<span class="n">p</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">flag</span> <span class="o">|=</span> <span class="n">BT_LEAF</span><span class="p">;</span>
				<span class="n">p</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">nextindex</span> <span class="o">=</span>
				    <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">XTENTRYSTART</span><span class="p">);</span>

				<span class="cm">/* XT_PUTPAGE(mp); */</span>

				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="cm">/* free the parent page */</span>
				<span class="k">if</span> <span class="p">((</span><span class="n">rc</span> <span class="o">=</span> <span class="n">xtRelink</span><span class="p">(</span><span class="n">tid</span><span class="p">,</span> <span class="n">ip</span><span class="p">,</span> <span class="n">p</span><span class="p">)))</span>
					<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

				<span class="n">xaddr</span> <span class="o">=</span> <span class="n">addressPXD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">self</span><span class="p">);</span>
				<span class="cm">/* free the page extent */</span>
				<span class="n">dbFree</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">xaddr</span><span class="p">,</span>
				       <span class="p">(</span><span class="n">s64</span><span class="p">)</span> <span class="n">JFS_SBI</span><span class="p">(</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_sb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">nbperpage</span><span class="p">);</span>

				<span class="cm">/* unpin/free the buffer page */</span>
				<span class="n">discard_metapage</span><span class="p">(</span><span class="n">mp</span><span class="p">);</span>

				<span class="cm">/* propagate up */</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="cm">/*</span>
<span class="cm">		 * the parent has other entries remaining:</span>
<span class="cm">		 * delete the router entry from the parent page.</span>
<span class="cm">		 */</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="n">BT_MARK_DIRTY</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="n">ip</span><span class="p">);</span>
			<span class="cm">/*</span>
<span class="cm">			 * acquire a transaction lock on the leaf page;</span>
<span class="cm">			 *</span>
<span class="cm">			 * action:xad deletion;</span>
<span class="cm">			 */</span>
			<span class="n">tlck</span> <span class="o">=</span> <span class="n">txLock</span><span class="p">(</span><span class="n">tid</span><span class="p">,</span> <span class="n">ip</span><span class="p">,</span> <span class="n">mp</span><span class="p">,</span> <span class="n">tlckXTREE</span><span class="p">);</span>
			<span class="n">xtlck</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">xtlock</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">tlck</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">;</span>
			<span class="n">xtlck</span><span class="o">-&gt;</span><span class="n">lwm</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span>
			    <span class="p">(</span><span class="n">xtlck</span><span class="o">-&gt;</span><span class="n">lwm</span><span class="p">.</span><span class="n">offset</span><span class="p">)</span> <span class="o">?</span> <span class="n">min</span><span class="p">(</span><span class="n">index</span><span class="p">,</span>
						      <span class="n">xtlck</span><span class="o">-&gt;</span><span class="n">lwm</span><span class="p">.</span>
						      <span class="n">offset</span><span class="p">)</span> <span class="o">:</span> <span class="n">index</span><span class="p">;</span>

			<span class="cm">/* if delete from middle,</span>
<span class="cm">			 * shift left/compact the remaining entries in the page</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">index</span> <span class="o">&lt;</span> <span class="n">nextindex</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
				<span class="n">memmove</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">xad</span><span class="p">[</span><span class="n">index</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">xad</span><span class="p">[</span><span class="n">index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">],</span>
					<span class="p">(</span><span class="n">nextindex</span> <span class="o">-</span> <span class="n">index</span> <span class="o">-</span>
					 <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">L2XTSLOTSIZE</span><span class="p">);</span>

			<span class="n">le16_add_cpu</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">nextindex</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
			<span class="n">jfs_info</span><span class="p">(</span><span class="s">&quot;xtDeleteUp(entry): 0x%lx[%d]&quot;</span><span class="p">,</span>
				 <span class="p">(</span><span class="n">ulong</span><span class="p">)</span> <span class="n">parent</span><span class="o">-&gt;</span><span class="n">bn</span><span class="p">,</span> <span class="n">index</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="cm">/* unpin the parent page */</span>
		<span class="n">XT_PUTPAGE</span><span class="p">(</span><span class="n">mp</span><span class="p">);</span>

		<span class="cm">/* exit propagation up */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * NAME:	xtRelocate()</span>
<span class="cm"> *</span>
<span class="cm"> * FUNCTION:	relocate xtpage or data extent of regular file;</span>
<span class="cm"> *		This function is mainly used by defragfs utility.</span>
<span class="cm"> *</span>
<span class="cm"> * NOTE:	This routine does not have the logic to handle</span>
<span class="cm"> *		uncommitted allocated extent. The caller should call</span>
<span class="cm"> *		txCommit() to commit all the allocation before call</span>
<span class="cm"> *		this routine.</span>
<span class="cm"> */</span>
<span class="kt">int</span>
<span class="nf">xtRelocate</span><span class="p">(</span><span class="n">tid_t</span> <span class="n">tid</span><span class="p">,</span> <span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span> <span class="n">ip</span><span class="p">,</span> <span class="n">xad_t</span> <span class="o">*</span> <span class="n">oxad</span><span class="p">,</span>	<span class="cm">/* old XAD */</span>
	   <span class="n">s64</span> <span class="n">nxaddr</span><span class="p">,</span>		<span class="cm">/* new xaddr */</span>
	   <span class="kt">int</span> <span class="n">xtype</span><span class="p">)</span>
<span class="p">{</span>				<span class="cm">/* extent type: XTPAGE or DATAEXT */</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tblock</span> <span class="o">*</span><span class="n">tblk</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tlock</span> <span class="o">*</span><span class="n">tlck</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">xtlock</span> <span class="o">*</span><span class="n">xtlck</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">metapage</span> <span class="o">*</span><span class="n">mp</span><span class="p">,</span> <span class="o">*</span><span class="n">pmp</span><span class="p">,</span> <span class="o">*</span><span class="n">lmp</span><span class="p">,</span> <span class="o">*</span><span class="n">rmp</span><span class="p">;</span>	<span class="cm">/* meta-page buffer */</span>
	<span class="n">xtpage_t</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="o">*</span><span class="n">pp</span><span class="p">,</span> <span class="o">*</span><span class="n">rp</span><span class="p">,</span> <span class="o">*</span><span class="n">lp</span><span class="p">;</span>	<span class="cm">/* base B+-tree index page */</span>
	<span class="n">xad_t</span> <span class="o">*</span><span class="n">xad</span><span class="p">;</span>
	<span class="n">pxd_t</span> <span class="o">*</span><span class="n">pxd</span><span class="p">;</span>
	<span class="n">s64</span> <span class="n">xoff</span><span class="p">,</span> <span class="n">xsize</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">xlen</span><span class="p">;</span>
	<span class="n">s64</span> <span class="n">oxaddr</span><span class="p">,</span> <span class="n">sxaddr</span><span class="p">,</span> <span class="n">dxaddr</span><span class="p">,</span> <span class="n">nextbn</span><span class="p">,</span> <span class="n">prevbn</span><span class="p">;</span>
	<span class="n">cbuf_t</span> <span class="o">*</span><span class="n">cp</span><span class="p">;</span>
	<span class="n">s64</span> <span class="n">offset</span><span class="p">,</span> <span class="n">nbytes</span><span class="p">,</span> <span class="n">nbrd</span><span class="p">,</span> <span class="n">pno</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">nb</span><span class="p">,</span> <span class="n">npages</span><span class="p">,</span> <span class="n">nblks</span><span class="p">;</span>
	<span class="n">s64</span> <span class="n">bn</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">cmp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">index</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pxd_lock</span> <span class="o">*</span><span class="n">pxdlock</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">btstack</span> <span class="n">btstack</span><span class="p">;</span>	<span class="cm">/* traverse stack */</span>

	<span class="n">xtype</span> <span class="o">=</span> <span class="n">xtype</span> <span class="o">&amp;</span> <span class="n">EXTENT_TYPE</span><span class="p">;</span>

	<span class="n">xoff</span> <span class="o">=</span> <span class="n">offsetXAD</span><span class="p">(</span><span class="n">oxad</span><span class="p">);</span>
	<span class="n">oxaddr</span> <span class="o">=</span> <span class="n">addressXAD</span><span class="p">(</span><span class="n">oxad</span><span class="p">);</span>
	<span class="n">xlen</span> <span class="o">=</span> <span class="n">lengthXAD</span><span class="p">(</span><span class="n">oxad</span><span class="p">);</span>

	<span class="cm">/* validate extent offset */</span>
	<span class="n">offset</span> <span class="o">=</span> <span class="n">xoff</span> <span class="o">&lt;&lt;</span> <span class="n">JFS_SBI</span><span class="p">(</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_sb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">l2bsize</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">offset</span> <span class="o">&gt;=</span> <span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_size</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ESTALE</span><span class="p">;</span>	<span class="cm">/* stale extent */</span>

	<span class="n">jfs_info</span><span class="p">(</span><span class="s">&quot;xtRelocate: xtype:%d xoff:0x%lx xlen:0x%x xaddr:0x%lx:0x%lx&quot;</span><span class="p">,</span>
		 <span class="n">xtype</span><span class="p">,</span> <span class="p">(</span><span class="n">ulong</span><span class="p">)</span> <span class="n">xoff</span><span class="p">,</span> <span class="n">xlen</span><span class="p">,</span> <span class="p">(</span><span class="n">ulong</span><span class="p">)</span> <span class="n">oxaddr</span><span class="p">,</span> <span class="p">(</span><span class="n">ulong</span><span class="p">)</span> <span class="n">nxaddr</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 *	1. get and validate the parent xtpage/xad entry</span>
<span class="cm">	 *	covering the source extent to be relocated;</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">xtype</span> <span class="o">==</span> <span class="n">DATAEXT</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* search in leaf entry */</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">xtSearch</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">xoff</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">btstack</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

		<span class="cm">/* retrieve search result */</span>
		<span class="n">XT_GETSEARCH</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">btstack</span><span class="p">.</span><span class="n">top</span><span class="p">,</span> <span class="n">bn</span><span class="p">,</span> <span class="n">pmp</span><span class="p">,</span> <span class="n">pp</span><span class="p">,</span> <span class="n">index</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">cmp</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">XT_PUTPAGE</span><span class="p">(</span><span class="n">pmp</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ESTALE</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* validate for exact match with a single entry */</span>
		<span class="n">xad</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pp</span><span class="o">-&gt;</span><span class="n">xad</span><span class="p">[</span><span class="n">index</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">addressXAD</span><span class="p">(</span><span class="n">xad</span><span class="p">)</span> <span class="o">!=</span> <span class="n">oxaddr</span> <span class="o">||</span> <span class="n">lengthXAD</span><span class="p">(</span><span class="n">xad</span><span class="p">)</span> <span class="o">!=</span> <span class="n">xlen</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">XT_PUTPAGE</span><span class="p">(</span><span class="n">pmp</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ESTALE</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>		<span class="cm">/* (xtype == XTPAGE) */</span>

		<span class="cm">/* search in internal entry */</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">xtSearchNode</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">oxad</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">btstack</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

		<span class="cm">/* retrieve search result */</span>
		<span class="n">XT_GETSEARCH</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">btstack</span><span class="p">.</span><span class="n">top</span><span class="p">,</span> <span class="n">bn</span><span class="p">,</span> <span class="n">pmp</span><span class="p">,</span> <span class="n">pp</span><span class="p">,</span> <span class="n">index</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">cmp</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">XT_PUTPAGE</span><span class="p">(</span><span class="n">pmp</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ESTALE</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* xtSearchNode() validated for exact match with a single entry</span>
<span class="cm">		 */</span>
		<span class="n">xad</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pp</span><span class="o">-&gt;</span><span class="n">xad</span><span class="p">[</span><span class="n">index</span><span class="p">];</span>
	<span class="p">}</span>
	<span class="n">jfs_info</span><span class="p">(</span><span class="s">&quot;xtRelocate: parent xad entry validated.&quot;</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 *	2. relocate the extent</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">xtype</span> <span class="o">==</span> <span class="n">DATAEXT</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* if the extent is allocated-but-not-recorded</span>
<span class="cm">		 * there is no real data to be moved in this extent,</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">xad</span><span class="o">-&gt;</span><span class="n">flag</span> <span class="o">&amp;</span> <span class="n">XAD_NOTRECORDED</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="cm">/* release xtpage for cmRead()/xtLookup() */</span>
			<span class="n">XT_PUTPAGE</span><span class="p">(</span><span class="n">pmp</span><span class="p">);</span>

		<span class="cm">/*</span>
<span class="cm">		 *	cmRelocate()</span>
<span class="cm">		 *</span>
<span class="cm">		 * copy target data pages to be relocated;</span>
<span class="cm">		 *</span>
<span class="cm">		 * data extent must start at page boundary and</span>
<span class="cm">		 * multiple of page size (except the last data extent);</span>
<span class="cm">		 * read in each page of the source data extent into cbuf,</span>
<span class="cm">		 * update the cbuf extent descriptor of the page to be</span>
<span class="cm">		 * homeward bound to new dst data extent</span>
<span class="cm">		 * copy the data from the old extent to new extent.</span>
<span class="cm">		 * copy is essential for compressed files to avoid problems</span>
<span class="cm">		 * that can arise if there was a change in compression</span>
<span class="cm">		 * algorithms.</span>
<span class="cm">		 * it is a good strategy because it may disrupt cache</span>
<span class="cm">		 * policy to keep the pages in memory afterwards.</span>
<span class="cm">		 */</span>
		<span class="n">offset</span> <span class="o">=</span> <span class="n">xoff</span> <span class="o">&lt;&lt;</span> <span class="n">JFS_SBI</span><span class="p">(</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_sb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">l2bsize</span><span class="p">;</span>
		<span class="n">assert</span><span class="p">((</span><span class="n">offset</span> <span class="o">&amp;</span> <span class="n">CM_OFFSET</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">nbytes</span> <span class="o">=</span> <span class="n">xlen</span> <span class="o">&lt;&lt;</span> <span class="n">JFS_SBI</span><span class="p">(</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_sb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">l2bsize</span><span class="p">;</span>
		<span class="n">pno</span> <span class="o">=</span> <span class="n">offset</span> <span class="o">&gt;&gt;</span> <span class="n">CM_L2BSIZE</span><span class="p">;</span>
		<span class="n">npages</span> <span class="o">=</span> <span class="p">(</span><span class="n">nbytes</span> <span class="o">+</span> <span class="p">(</span><span class="n">CM_BSIZE</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="o">&gt;&gt;</span> <span class="n">CM_L2BSIZE</span><span class="p">;</span>
<span class="cm">/*</span>
<span class="cm">		npages = ((offset + nbytes - 1) &gt;&gt; CM_L2BSIZE) -</span>
<span class="cm">			  (offset &gt;&gt; CM_L2BSIZE) + 1;</span>
<span class="cm">*/</span>
		<span class="n">sxaddr</span> <span class="o">=</span> <span class="n">oxaddr</span><span class="p">;</span>
		<span class="n">dxaddr</span> <span class="o">=</span> <span class="n">nxaddr</span><span class="p">;</span>

		<span class="cm">/* process the request one cache buffer at a time */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">nbrd</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">nbrd</span> <span class="o">&lt;</span> <span class="n">nbytes</span><span class="p">;</span> <span class="n">nbrd</span> <span class="o">+=</span> <span class="n">nb</span><span class="p">,</span>
		     <span class="n">offset</span> <span class="o">+=</span> <span class="n">nb</span><span class="p">,</span> <span class="n">pno</span><span class="o">++</span><span class="p">,</span> <span class="n">npages</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* compute page size */</span>
			<span class="n">nb</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">nbytes</span> <span class="o">-</span> <span class="n">nbrd</span><span class="p">,</span> <span class="n">CM_BSIZE</span><span class="p">);</span>

			<span class="cm">/* get the cache buffer of the page */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">=</span> <span class="n">cmRead</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">npages</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cp</span><span class="p">))</span>
				<span class="k">break</span><span class="p">;</span>

			<span class="n">assert</span><span class="p">(</span><span class="n">addressPXD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cp</span><span class="o">-&gt;</span><span class="n">cm_pxd</span><span class="p">)</span> <span class="o">==</span> <span class="n">sxaddr</span><span class="p">);</span>
			<span class="n">assert</span><span class="p">(</span><span class="o">!</span><span class="n">cp</span><span class="o">-&gt;</span><span class="n">cm_modified</span><span class="p">);</span>

			<span class="cm">/* bind buffer with the new extent address */</span>
			<span class="n">nblks</span> <span class="o">=</span> <span class="n">nb</span> <span class="o">&gt;&gt;</span> <span class="n">JFS_IP</span><span class="p">(</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_sb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">l2bsize</span><span class="p">;</span>
			<span class="n">cmSetXD</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">cp</span><span class="p">,</span> <span class="n">pno</span><span class="p">,</span> <span class="n">dxaddr</span><span class="p">,</span> <span class="n">nblks</span><span class="p">);</span>

			<span class="cm">/* release the cbuf, mark it as modified */</span>
			<span class="n">cmPut</span><span class="p">(</span><span class="n">cp</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>

			<span class="n">dxaddr</span> <span class="o">+=</span> <span class="n">nblks</span><span class="p">;</span>
			<span class="n">sxaddr</span> <span class="o">+=</span> <span class="n">nblks</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* get back parent page */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">rc</span> <span class="o">=</span> <span class="n">xtSearch</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">xoff</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">btstack</span><span class="p">,</span> <span class="mi">0</span><span class="p">)))</span>
			<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

		<span class="n">XT_GETSEARCH</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">btstack</span><span class="p">.</span><span class="n">top</span><span class="p">,</span> <span class="n">bn</span><span class="p">,</span> <span class="n">pmp</span><span class="p">,</span> <span class="n">pp</span><span class="p">,</span> <span class="n">index</span><span class="p">);</span>
		<span class="n">jfs_info</span><span class="p">(</span><span class="s">&quot;xtRelocate: target data extent relocated.&quot;</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>		<span class="cm">/* (xtype == XTPAGE) */</span>

		<span class="cm">/*</span>
<span class="cm">		 * read in the target xtpage from the source extent;</span>
<span class="cm">		 */</span>
		<span class="n">XT_GETPAGE</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">oxaddr</span><span class="p">,</span> <span class="n">mp</span><span class="p">,</span> <span class="n">PSIZE</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">XT_PUTPAGE</span><span class="p">(</span><span class="n">pmp</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/*</span>
<span class="cm">		 * read in sibling pages if any to update sibling pointers;</span>
<span class="cm">		 */</span>
		<span class="n">rmp</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">next</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">nextbn</span> <span class="o">=</span> <span class="n">le64_to_cpu</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">next</span><span class="p">);</span>
			<span class="n">XT_GETPAGE</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">nextbn</span><span class="p">,</span> <span class="n">rmp</span><span class="p">,</span> <span class="n">PSIZE</span><span class="p">,</span> <span class="n">rp</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">XT_PUTPAGE</span><span class="p">(</span><span class="n">pmp</span><span class="p">);</span>
				<span class="n">XT_PUTPAGE</span><span class="p">(</span><span class="n">mp</span><span class="p">);</span>
				<span class="k">return</span> <span class="p">(</span><span class="n">rc</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="n">lmp</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">prev</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">prevbn</span> <span class="o">=</span> <span class="n">le64_to_cpu</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">prev</span><span class="p">);</span>
			<span class="n">XT_GETPAGE</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">prevbn</span><span class="p">,</span> <span class="n">lmp</span><span class="p">,</span> <span class="n">PSIZE</span><span class="p">,</span> <span class="n">lp</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">XT_PUTPAGE</span><span class="p">(</span><span class="n">pmp</span><span class="p">);</span>
				<span class="n">XT_PUTPAGE</span><span class="p">(</span><span class="n">mp</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">rmp</span><span class="p">)</span>
					<span class="n">XT_PUTPAGE</span><span class="p">(</span><span class="n">rmp</span><span class="p">);</span>
				<span class="k">return</span> <span class="p">(</span><span class="n">rc</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="cm">/* at this point, all xtpages to be updated are in memory */</span>

		<span class="cm">/*</span>
<span class="cm">		 * update sibling pointers of sibling xtpages if any;</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">lmp</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">BT_MARK_DIRTY</span><span class="p">(</span><span class="n">lmp</span><span class="p">,</span> <span class="n">ip</span><span class="p">);</span>
			<span class="n">tlck</span> <span class="o">=</span> <span class="n">txLock</span><span class="p">(</span><span class="n">tid</span><span class="p">,</span> <span class="n">ip</span><span class="p">,</span> <span class="n">lmp</span><span class="p">,</span> <span class="n">tlckXTREE</span> <span class="o">|</span> <span class="n">tlckRELINK</span><span class="p">);</span>
			<span class="n">lp</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">next</span> <span class="o">=</span> <span class="n">cpu_to_le64</span><span class="p">(</span><span class="n">nxaddr</span><span class="p">);</span>
			<span class="n">XT_PUTPAGE</span><span class="p">(</span><span class="n">lmp</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">rmp</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">BT_MARK_DIRTY</span><span class="p">(</span><span class="n">rmp</span><span class="p">,</span> <span class="n">ip</span><span class="p">);</span>
			<span class="n">tlck</span> <span class="o">=</span> <span class="n">txLock</span><span class="p">(</span><span class="n">tid</span><span class="p">,</span> <span class="n">ip</span><span class="p">,</span> <span class="n">rmp</span><span class="p">,</span> <span class="n">tlckXTREE</span> <span class="o">|</span> <span class="n">tlckRELINK</span><span class="p">);</span>
			<span class="n">rp</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">prev</span> <span class="o">=</span> <span class="n">cpu_to_le64</span><span class="p">(</span><span class="n">nxaddr</span><span class="p">);</span>
			<span class="n">XT_PUTPAGE</span><span class="p">(</span><span class="n">rmp</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="cm">/*</span>
<span class="cm">		 * update the target xtpage to be relocated</span>
<span class="cm">		 *</span>
<span class="cm">		 * update the self address of the target page</span>
<span class="cm">		 * and write to destination extent;</span>
<span class="cm">		 * redo image covers the whole xtpage since it is new page</span>
<span class="cm">		 * to the destination extent;</span>
<span class="cm">		 * update of bmap for the free of source extent</span>
<span class="cm">		 * of the target xtpage itself:</span>
<span class="cm">		 * update of bmap for the allocation of destination extent</span>
<span class="cm">		 * of the target xtpage itself:</span>
<span class="cm">		 * update of bmap for the extents covered by xad entries in</span>
<span class="cm">		 * the target xtpage is not necessary since they are not</span>
<span class="cm">		 * updated;</span>
<span class="cm">		 * if not committed before this relocation,</span>
<span class="cm">		 * target page may contain XAD_NEW entries which must</span>
<span class="cm">		 * be scanned for bmap update (logredo() always</span>
<span class="cm">		 * scan xtpage REDOPAGE image for bmap update);</span>
<span class="cm">		 * if committed before this relocation (tlckRELOCATE),</span>
<span class="cm">		 * scan may be skipped by commit() and logredo();</span>
<span class="cm">		 */</span>
		<span class="n">BT_MARK_DIRTY</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="n">ip</span><span class="p">);</span>
		<span class="cm">/* tlckNEW init xtlck-&gt;lwm.offset = XTENTRYSTART; */</span>
		<span class="n">tlck</span> <span class="o">=</span> <span class="n">txLock</span><span class="p">(</span><span class="n">tid</span><span class="p">,</span> <span class="n">ip</span><span class="p">,</span> <span class="n">mp</span><span class="p">,</span> <span class="n">tlckXTREE</span> <span class="o">|</span> <span class="n">tlckNEW</span><span class="p">);</span>
		<span class="n">xtlck</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">xtlock</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">tlck</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">;</span>

		<span class="cm">/* update the self address in the xtpage header */</span>
		<span class="n">pxd</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">self</span><span class="p">;</span>
		<span class="n">PXDaddress</span><span class="p">(</span><span class="n">pxd</span><span class="p">,</span> <span class="n">nxaddr</span><span class="p">);</span>

		<span class="cm">/* linelock for the after image of the whole page */</span>
		<span class="n">xtlck</span><span class="o">-&gt;</span><span class="n">lwm</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span>
		    <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">nextindex</span><span class="p">)</span> <span class="o">-</span> <span class="n">xtlck</span><span class="o">-&gt;</span><span class="n">lwm</span><span class="p">.</span><span class="n">offset</span><span class="p">;</span>

		<span class="cm">/* update the buffer extent descriptor of target xtpage */</span>
		<span class="n">xsize</span> <span class="o">=</span> <span class="n">xlen</span> <span class="o">&lt;&lt;</span> <span class="n">JFS_SBI</span><span class="p">(</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_sb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">l2bsize</span><span class="p">;</span>
		<span class="n">bmSetXD</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="n">nxaddr</span><span class="p">,</span> <span class="n">xsize</span><span class="p">);</span>

		<span class="cm">/* unpin the target page to new homeward bound */</span>
		<span class="n">XT_PUTPAGE</span><span class="p">(</span><span class="n">mp</span><span class="p">);</span>
		<span class="n">jfs_info</span><span class="p">(</span><span class="s">&quot;xtRelocate: target xtpage relocated.&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 *	3. acquire maplock for the source extent to be freed;</span>
<span class="cm">	 *</span>
<span class="cm">	 * acquire a maplock saving the src relocated extent address;</span>
<span class="cm">	 * to free of the extent at commit time;</span>
<span class="cm">	 */</span>
      <span class="nl">out:</span>
	<span class="cm">/* if DATAEXT relocation, write a LOG_UPDATEMAP record for</span>
<span class="cm">	 * free PXD of the source data extent (logredo() will update</span>
<span class="cm">	 * bmap for free of source data extent), and update bmap for</span>
<span class="cm">	 * free of the source data extent;</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">xtype</span> <span class="o">==</span> <span class="n">DATAEXT</span><span class="p">)</span>
		<span class="n">tlck</span> <span class="o">=</span> <span class="n">txMaplock</span><span class="p">(</span><span class="n">tid</span><span class="p">,</span> <span class="n">ip</span><span class="p">,</span> <span class="n">tlckMAP</span><span class="p">);</span>
	<span class="cm">/* if XTPAGE relocation, write a LOG_NOREDOPAGE record</span>
<span class="cm">	 * for the source xtpage (logredo() will init NoRedoPage</span>
<span class="cm">	 * filter and will also update bmap for free of the source</span>
<span class="cm">	 * xtpage), and update bmap for free of the source xtpage;</span>
<span class="cm">	 * N.B. We use tlckMAP instead of tlkcXTREE because there</span>
<span class="cm">	 *      is no buffer associated with this lock since the buffer</span>
<span class="cm">	 *      has been redirected to the target location.</span>
<span class="cm">	 */</span>
	<span class="k">else</span>			<span class="cm">/* (xtype == XTPAGE) */</span>
		<span class="n">tlck</span> <span class="o">=</span> <span class="n">txMaplock</span><span class="p">(</span><span class="n">tid</span><span class="p">,</span> <span class="n">ip</span><span class="p">,</span> <span class="n">tlckMAP</span> <span class="o">|</span> <span class="n">tlckRELOCATE</span><span class="p">);</span>

	<span class="n">pxdlock</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">pxd_lock</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">tlck</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">;</span>
	<span class="n">pxdlock</span><span class="o">-&gt;</span><span class="n">flag</span> <span class="o">=</span> <span class="n">mlckFREEPXD</span><span class="p">;</span>
	<span class="n">PXDaddress</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pxdlock</span><span class="o">-&gt;</span><span class="n">pxd</span><span class="p">,</span> <span class="n">oxaddr</span><span class="p">);</span>
	<span class="n">PXDlength</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pxdlock</span><span class="o">-&gt;</span><span class="n">pxd</span><span class="p">,</span> <span class="n">xlen</span><span class="p">);</span>
	<span class="n">pxdlock</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 *	4. update the parent xad entry for relocation;</span>
<span class="cm">	 *</span>
<span class="cm">	 * acquire tlck for the parent entry with XAD_NEW as entry</span>
<span class="cm">	 * update which will write LOG_REDOPAGE and update bmap for</span>
<span class="cm">	 * allocation of XAD_NEW destination extent;</span>
<span class="cm">	 */</span>
	<span class="n">jfs_info</span><span class="p">(</span><span class="s">&quot;xtRelocate: update parent xad entry.&quot;</span><span class="p">);</span>
	<span class="n">BT_MARK_DIRTY</span><span class="p">(</span><span class="n">pmp</span><span class="p">,</span> <span class="n">ip</span><span class="p">);</span>
	<span class="n">tlck</span> <span class="o">=</span> <span class="n">txLock</span><span class="p">(</span><span class="n">tid</span><span class="p">,</span> <span class="n">ip</span><span class="p">,</span> <span class="n">pmp</span><span class="p">,</span> <span class="n">tlckXTREE</span> <span class="o">|</span> <span class="n">tlckGROW</span><span class="p">);</span>
	<span class="n">xtlck</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">xtlock</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">tlck</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">;</span>

	<span class="cm">/* update the XAD with the new destination extent; */</span>
	<span class="n">xad</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pp</span><span class="o">-&gt;</span><span class="n">xad</span><span class="p">[</span><span class="n">index</span><span class="p">];</span>
	<span class="n">xad</span><span class="o">-&gt;</span><span class="n">flag</span> <span class="o">|=</span> <span class="n">XAD_NEW</span><span class="p">;</span>
	<span class="n">XADaddress</span><span class="p">(</span><span class="n">xad</span><span class="p">,</span> <span class="n">nxaddr</span><span class="p">);</span>

	<span class="n">xtlck</span><span class="o">-&gt;</span><span class="n">lwm</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">xtlck</span><span class="o">-&gt;</span><span class="n">lwm</span><span class="p">.</span><span class="n">offset</span><span class="p">);</span>
	<span class="n">xtlck</span><span class="o">-&gt;</span><span class="n">lwm</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">pp</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">nextindex</span><span class="p">)</span> <span class="o">-</span>
	    <span class="n">xtlck</span><span class="o">-&gt;</span><span class="n">lwm</span><span class="p">.</span><span class="n">offset</span><span class="p">;</span>

	<span class="cm">/* unpin the parent xtpage */</span>
	<span class="n">XT_PUTPAGE</span><span class="p">(</span><span class="n">pmp</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> *	xtSearchNode()</span>
<span class="cm"> *</span>
<span class="cm"> * function:	search for the internal xad entry covering specified extent.</span>
<span class="cm"> *		This function is mainly used by defragfs utility.</span>
<span class="cm"> *</span>
<span class="cm"> * parameters:</span>
<span class="cm"> *	ip	- file object;</span>
<span class="cm"> *	xad	- extent to find;</span>
<span class="cm"> *	cmpp	- comparison result:</span>
<span class="cm"> *	btstack - traverse stack;</span>
<span class="cm"> *	flag	- search process flag;</span>
<span class="cm"> *</span>
<span class="cm"> * returns:</span>
<span class="cm"> *	btstack contains (bn, index) of search path traversed to the entry.</span>
<span class="cm"> *	*cmpp is set to result of comparison with the entry returned.</span>
<span class="cm"> *	the page containing the entry is pinned at exit.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">xtSearchNode</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">ip</span><span class="p">,</span> <span class="n">xad_t</span> <span class="o">*</span> <span class="n">xad</span><span class="p">,</span>	<span class="cm">/* required XAD entry */</span>
			<span class="kt">int</span> <span class="o">*</span><span class="n">cmpp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">btstack</span> <span class="o">*</span> <span class="n">btstack</span><span class="p">,</span> <span class="kt">int</span> <span class="n">flag</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">s64</span> <span class="n">xoff</span><span class="p">,</span> <span class="n">xaddr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">xlen</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">cmp</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>		<span class="cm">/* init for empty page */</span>
	<span class="n">s64</span> <span class="n">bn</span><span class="p">;</span>			<span class="cm">/* block number */</span>
	<span class="k">struct</span> <span class="n">metapage</span> <span class="o">*</span><span class="n">mp</span><span class="p">;</span>	<span class="cm">/* meta-page buffer */</span>
	<span class="n">xtpage_t</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>		<span class="cm">/* page */</span>
	<span class="kt">int</span> <span class="n">base</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">lim</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">btframe</span> <span class="o">*</span><span class="n">btsp</span><span class="p">;</span>
	<span class="n">s64</span> <span class="n">t64</span><span class="p">;</span>

	<span class="n">BT_CLR</span><span class="p">(</span><span class="n">btstack</span><span class="p">);</span>

	<span class="n">xoff</span> <span class="o">=</span> <span class="n">offsetXAD</span><span class="p">(</span><span class="n">xad</span><span class="p">);</span>
	<span class="n">xlen</span> <span class="o">=</span> <span class="n">lengthXAD</span><span class="p">(</span><span class="n">xad</span><span class="p">);</span>
	<span class="n">xaddr</span> <span class="o">=</span> <span class="n">addressXAD</span><span class="p">(</span><span class="n">xad</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 *	search down tree from root:</span>
<span class="cm">	 *</span>
<span class="cm">	 * between two consecutive entries of &lt;Ki, Pi&gt; and &lt;Kj, Pj&gt; of</span>
<span class="cm">	 * internal page, child page Pi contains entry with k, Ki &lt;= K &lt; Kj.</span>
<span class="cm">	 *</span>
<span class="cm">	 * if entry with search key K is not found</span>
<span class="cm">	 * internal page search find the entry with largest key Ki</span>
<span class="cm">	 * less than K which point to the child page to search;</span>
<span class="cm">	 * leaf page search find the entry with smallest key Kj</span>
<span class="cm">	 * greater than K so that the returned index is the position of</span>
<span class="cm">	 * the entry to be shifted right for insertion of new entry.</span>
<span class="cm">	 * for empty tree, search key is greater than any key of the tree.</span>
<span class="cm">	 *</span>
<span class="cm">	 * by convention, root bn = 0.</span>
<span class="cm">	 */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">bn</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;;)</span> <span class="p">{</span>
		<span class="cm">/* get/pin the page to search */</span>
		<span class="n">XT_GETPAGE</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">bn</span><span class="p">,</span> <span class="n">mp</span><span class="p">,</span> <span class="n">PSIZE</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">flag</span> <span class="o">&amp;</span> <span class="n">BT_LEAF</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">XT_PUTPAGE</span><span class="p">(</span><span class="n">mp</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ESTALE</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">lim</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">nextindex</span><span class="p">)</span> <span class="o">-</span> <span class="n">XTENTRYSTART</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * binary search with search key K on the current page</span>
<span class="cm">		 */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">base</span> <span class="o">=</span> <span class="n">XTENTRYSTART</span><span class="p">;</span> <span class="n">lim</span><span class="p">;</span> <span class="n">lim</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">index</span> <span class="o">=</span> <span class="n">base</span> <span class="o">+</span> <span class="p">(</span><span class="n">lim</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">);</span>

			<span class="n">XT_CMP</span><span class="p">(</span><span class="n">cmp</span><span class="p">,</span> <span class="n">xoff</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">xad</span><span class="p">[</span><span class="n">index</span><span class="p">],</span> <span class="n">t64</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">cmp</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/*</span>
<span class="cm">				 *	search hit</span>
<span class="cm">				 *</span>
<span class="cm">				 * verify for exact match;</span>
<span class="cm">				 */</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">xaddr</span> <span class="o">==</span> <span class="n">addressXAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">xad</span><span class="p">[</span><span class="n">index</span><span class="p">])</span> <span class="o">&amp;&amp;</span>
				    <span class="n">xoff</span> <span class="o">==</span> <span class="n">offsetXAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">xad</span><span class="p">[</span><span class="n">index</span><span class="p">]))</span> <span class="p">{</span>
					<span class="o">*</span><span class="n">cmpp</span> <span class="o">=</span> <span class="n">cmp</span><span class="p">;</span>

					<span class="cm">/* save search result */</span>
					<span class="n">btsp</span> <span class="o">=</span> <span class="n">btstack</span><span class="o">-&gt;</span><span class="n">top</span><span class="p">;</span>
					<span class="n">btsp</span><span class="o">-&gt;</span><span class="n">bn</span> <span class="o">=</span> <span class="n">bn</span><span class="p">;</span>
					<span class="n">btsp</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">=</span> <span class="n">index</span><span class="p">;</span>
					<span class="n">btsp</span><span class="o">-&gt;</span><span class="n">mp</span> <span class="o">=</span> <span class="n">mp</span><span class="p">;</span>

					<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
				<span class="p">}</span>

				<span class="cm">/* descend/search its child page */</span>
				<span class="k">goto</span> <span class="n">next</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">cmp</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">base</span> <span class="o">=</span> <span class="n">index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
				<span class="o">--</span><span class="n">lim</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="cm">/*</span>
<span class="cm">		 *	search miss - non-leaf page:</span>
<span class="cm">		 *</span>
<span class="cm">		 * base is the smallest index with key (Kj) greater than</span>
<span class="cm">		 * search key (K) and may be zero or maxentry index.</span>
<span class="cm">		 * if base is non-zero, decrement base by one to get the parent</span>
<span class="cm">		 * entry of the child page to search.</span>
<span class="cm">		 */</span>
		<span class="n">index</span> <span class="o">=</span> <span class="n">base</span> <span class="o">?</span> <span class="n">base</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">:</span> <span class="n">base</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * go down to child page</span>
<span class="cm">		 */</span>
	      <span class="nl">next:</span>
		<span class="cm">/* get the child page block number */</span>
		<span class="n">bn</span> <span class="o">=</span> <span class="n">addressXAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">xad</span><span class="p">[</span><span class="n">index</span><span class="p">]);</span>

		<span class="cm">/* unpin the parent page */</span>
		<span class="n">XT_PUTPAGE</span><span class="p">(</span><span class="n">mp</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> *	xtRelink()</span>
<span class="cm"> *</span>
<span class="cm"> * function:</span>
<span class="cm"> *	link around a freed page.</span>
<span class="cm"> *</span>
<span class="cm"> * Parameter:</span>
<span class="cm"> *	int		tid,</span>
<span class="cm"> *	struct inode	*ip,</span>
<span class="cm"> *	xtpage_t	*p)</span>
<span class="cm"> *</span>
<span class="cm"> * returns:</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">xtRelink</span><span class="p">(</span><span class="n">tid_t</span> <span class="n">tid</span><span class="p">,</span> <span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">ip</span><span class="p">,</span> <span class="n">xtpage_t</span> <span class="o">*</span> <span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">metapage</span> <span class="o">*</span><span class="n">mp</span><span class="p">;</span>
	<span class="n">s64</span> <span class="n">nextbn</span><span class="p">,</span> <span class="n">prevbn</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tlock</span> <span class="o">*</span><span class="n">tlck</span><span class="p">;</span>

	<span class="n">nextbn</span> <span class="o">=</span> <span class="n">le64_to_cpu</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">next</span><span class="p">);</span>
	<span class="n">prevbn</span> <span class="o">=</span> <span class="n">le64_to_cpu</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">prev</span><span class="p">);</span>

	<span class="cm">/* update prev pointer of the next page */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nextbn</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">XT_GETPAGE</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">nextbn</span><span class="p">,</span> <span class="n">mp</span><span class="p">,</span> <span class="n">PSIZE</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * acquire a transaction lock on the page;</span>
<span class="cm">		 *</span>
<span class="cm">		 * action: update prev pointer;</span>
<span class="cm">		 */</span>
		<span class="n">BT_MARK_DIRTY</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="n">ip</span><span class="p">);</span>
		<span class="n">tlck</span> <span class="o">=</span> <span class="n">txLock</span><span class="p">(</span><span class="n">tid</span><span class="p">,</span> <span class="n">ip</span><span class="p">,</span> <span class="n">mp</span><span class="p">,</span> <span class="n">tlckXTREE</span> <span class="o">|</span> <span class="n">tlckRELINK</span><span class="p">);</span>

		<span class="cm">/* the page may already have been tlock&#39;d */</span>

		<span class="n">p</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">prev</span> <span class="o">=</span> <span class="n">cpu_to_le64</span><span class="p">(</span><span class="n">prevbn</span><span class="p">);</span>

		<span class="n">XT_PUTPAGE</span><span class="p">(</span><span class="n">mp</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* update next pointer of the previous page */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">prevbn</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">XT_GETPAGE</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">prevbn</span><span class="p">,</span> <span class="n">mp</span><span class="p">,</span> <span class="n">PSIZE</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * acquire a transaction lock on the page;</span>
<span class="cm">		 *</span>
<span class="cm">		 * action: update next pointer;</span>
<span class="cm">		 */</span>
		<span class="n">BT_MARK_DIRTY</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="n">ip</span><span class="p">);</span>
		<span class="n">tlck</span> <span class="o">=</span> <span class="n">txLock</span><span class="p">(</span><span class="n">tid</span><span class="p">,</span> <span class="n">ip</span><span class="p">,</span> <span class="n">mp</span><span class="p">,</span> <span class="n">tlckXTREE</span> <span class="o">|</span> <span class="n">tlckRELINK</span><span class="p">);</span>

		<span class="cm">/* the page may already have been tlock&#39;d */</span>

		<span class="n">p</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">next</span> <span class="o">=</span> <span class="n">le64_to_cpu</span><span class="p">(</span><span class="n">nextbn</span><span class="p">);</span>

		<span class="n">XT_PUTPAGE</span><span class="p">(</span><span class="n">mp</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif				</span><span class="cm">/*  _STILL_TO_PORT */</span><span class="cp"></span>


<span class="cm">/*</span>
<span class="cm"> *	xtInitRoot()</span>
<span class="cm"> *</span>
<span class="cm"> * initialize file root (inline in inode)</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">xtInitRoot</span><span class="p">(</span><span class="n">tid_t</span> <span class="n">tid</span><span class="p">,</span> <span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">ip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">xtpage_t</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * acquire a transaction lock on the root</span>
<span class="cm">	 *</span>
<span class="cm">	 * action:</span>
<span class="cm">	 */</span>
	<span class="n">txLock</span><span class="p">(</span><span class="n">tid</span><span class="p">,</span> <span class="n">ip</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">metapage</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">JFS_IP</span><span class="p">(</span><span class="n">ip</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">bxflag</span><span class="p">,</span>
		      <span class="n">tlckXTREE</span> <span class="o">|</span> <span class="n">tlckNEW</span><span class="p">);</span>
	<span class="n">p</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">JFS_IP</span><span class="p">(</span><span class="n">ip</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">i_xtroot</span><span class="p">;</span>

	<span class="n">p</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">flag</span> <span class="o">=</span> <span class="n">DXD_INDEX</span> <span class="o">|</span> <span class="n">BT_ROOT</span> <span class="o">|</span> <span class="n">BT_LEAF</span><span class="p">;</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">nextindex</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">XTENTRYSTART</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">S_ISDIR</span><span class="p">(</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_mode</span><span class="p">))</span>
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">maxentry</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">XTROOTINITSLOT_DIR</span><span class="p">);</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">maxentry</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">XTROOTINITSLOT</span><span class="p">);</span>
		<span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>


	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * We can run into a deadlock truncating a file with a large number of</span>
<span class="cm"> * xtree pages (large fragmented file).  A robust fix would entail a</span>
<span class="cm"> * reservation system where we would reserve a number of metadata pages</span>
<span class="cm"> * and tlocks which we would be guaranteed without a deadlock.  Without</span>
<span class="cm"> * this, a partial fix is to limit number of metadata pages we will lock</span>
<span class="cm"> * in a single transaction.  Currently we will truncate the file so that</span>
<span class="cm"> * no more than 50 leaf pages will be locked.  The caller of xtTruncate</span>
<span class="cm"> * will be responsible for ensuring that the current transaction gets</span>
<span class="cm"> * committed, and that subsequent transactions are created to truncate</span>
<span class="cm"> * the file further if needed.</span>
<span class="cm"> */</span>
<span class="cp">#define MAX_TRUNCATE_LEAVES 50</span>

<span class="cm">/*</span>
<span class="cm"> *	xtTruncate()</span>
<span class="cm"> *</span>
<span class="cm"> * function:</span>
<span class="cm"> *	traverse for truncation logging backward bottom up;</span>
<span class="cm"> *	terminate at the last extent entry at the current subtree</span>
<span class="cm"> *	root page covering new down size.</span>
<span class="cm"> *	truncation may occur within the last extent entry.</span>
<span class="cm"> *</span>
<span class="cm"> * parameter:</span>
<span class="cm"> *	int		tid,</span>
<span class="cm"> *	struct inode	*ip,</span>
<span class="cm"> *	s64		newsize,</span>
<span class="cm"> *	int		type)	{PWMAP, PMAP, WMAP; DELETE, TRUNCATE}</span>
<span class="cm"> *</span>
<span class="cm"> * return:</span>
<span class="cm"> *</span>
<span class="cm"> * note:</span>
<span class="cm"> *	PWMAP:</span>
<span class="cm"> *	 1. truncate (non-COMMIT_NOLINK file)</span>
<span class="cm"> *	    by jfs_truncate() or jfs_open(O_TRUNC):</span>
<span class="cm"> *	    xtree is updated;</span>
<span class="cm"> *	 2. truncate index table of directory when last entry removed</span>
<span class="cm"> *	map update via tlock at commit time;</span>
<span class="cm"> *	PMAP:</span>
<span class="cm"> *	 Call xtTruncate_pmap instead</span>
<span class="cm"> *	WMAP:</span>
<span class="cm"> *	 1. remove (free zero link count) on last reference release</span>
<span class="cm"> *	    (pmap has been freed at commit zero link count);</span>
<span class="cm"> *	 2. truncate (COMMIT_NOLINK file, i.e., tmp file):</span>
<span class="cm"> *	    xtree is updated;</span>
<span class="cm"> *	 map update directly at truncation time;</span>
<span class="cm"> *</span>
<span class="cm"> *	if (DELETE)</span>
<span class="cm"> *		no LOG_NOREDOPAGE is required (NOREDOFILE is sufficient);</span>
<span class="cm"> *	else if (TRUNCATE)</span>
<span class="cm"> *		must write LOG_NOREDOPAGE for deleted index page;</span>
<span class="cm"> *</span>
<span class="cm"> * pages may already have been tlocked by anonymous transactions</span>
<span class="cm"> * during file growth (i.e., write) before truncation;</span>
<span class="cm"> *</span>
<span class="cm"> * except last truncated entry, deleted entries remains as is</span>
<span class="cm"> * in the page (nextindex is updated) for other use</span>
<span class="cm"> * (e.g., log/update allocation map): this avoid copying the page</span>
<span class="cm"> * info but delay free of pages;</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="n">s64</span> <span class="nf">xtTruncate</span><span class="p">(</span><span class="n">tid_t</span> <span class="n">tid</span><span class="p">,</span> <span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">ip</span><span class="p">,</span> <span class="n">s64</span> <span class="n">newsize</span><span class="p">,</span> <span class="kt">int</span> <span class="n">flag</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">s64</span> <span class="n">teof</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">metapage</span> <span class="o">*</span><span class="n">mp</span><span class="p">;</span>
	<span class="n">xtpage_t</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
	<span class="n">s64</span> <span class="n">bn</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">index</span><span class="p">,</span> <span class="n">nextindex</span><span class="p">;</span>
	<span class="n">xad_t</span> <span class="o">*</span><span class="n">xad</span><span class="p">;</span>
	<span class="n">s64</span> <span class="n">xoff</span><span class="p">,</span> <span class="n">xaddr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">xlen</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">freexlen</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">btstack</span> <span class="n">btstack</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">btframe</span> <span class="o">*</span><span class="n">parent</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tblock</span> <span class="o">*</span><span class="n">tblk</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tlock</span> <span class="o">*</span><span class="n">tlck</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">xtlock</span> <span class="o">*</span><span class="n">xtlck</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">xdlistlock</span> <span class="n">xadlock</span><span class="p">;</span>	<span class="cm">/* maplock for COMMIT_WMAP */</span>
	<span class="k">struct</span> <span class="n">pxd_lock</span> <span class="o">*</span><span class="n">pxdlock</span><span class="p">;</span>		<span class="cm">/* maplock for COMMIT_WMAP */</span>
	<span class="n">s64</span> <span class="n">nfreed</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">freed</span><span class="p">,</span> <span class="n">log</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">locked_leaves</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* save object truncation type */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tid</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tblk</span> <span class="o">=</span> <span class="n">tid_to_tblock</span><span class="p">(</span><span class="n">tid</span><span class="p">);</span>
		<span class="n">tblk</span><span class="o">-&gt;</span><span class="n">xflag</span> <span class="o">|=</span> <span class="n">flag</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">nfreed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">flag</span> <span class="o">&amp;=</span> <span class="n">COMMIT_MAP</span><span class="p">;</span>
	<span class="n">assert</span><span class="p">(</span><span class="n">flag</span> <span class="o">!=</span> <span class="n">COMMIT_PMAP</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">flag</span> <span class="o">==</span> <span class="n">COMMIT_PWMAP</span><span class="p">)</span>
		<span class="n">log</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">log</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">xadlock</span><span class="p">.</span><span class="n">flag</span> <span class="o">=</span> <span class="n">mlckFREEXADLIST</span><span class="p">;</span>
		<span class="n">xadlock</span><span class="p">.</span><span class="n">index</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * if the newsize is not an integral number of pages,</span>
<span class="cm">	 * the file between newsize and next page boundary will</span>
<span class="cm">	 * be cleared.</span>
<span class="cm">	 * if truncating into a file hole, it will cause</span>
<span class="cm">	 * a full block to be allocated for the logical block.</span>
<span class="cm">	 */</span>

	<span class="cm">/*</span>
<span class="cm">	 * release page blocks of truncated region &lt;teof, eof&gt;</span>
<span class="cm">	 *</span>
<span class="cm">	 * free the data blocks from the leaf index blocks.</span>
<span class="cm">	 * delete the parent index entries corresponding to</span>
<span class="cm">	 * the freed child data/index blocks.</span>
<span class="cm">	 * free the index blocks themselves which aren&#39;t needed</span>
<span class="cm">	 * in new sized file.</span>
<span class="cm">	 *</span>
<span class="cm">	 * index blocks are updated only if the blocks are to be</span>
<span class="cm">	 * retained in the new sized file.</span>
<span class="cm">	 * if type is PMAP, the data and index pages are NOT</span>
<span class="cm">	 * freed, and the data and index blocks are NOT freed</span>
<span class="cm">	 * from working map.</span>
<span class="cm">	 * (this will allow continued access of data/index of</span>
<span class="cm">	 * temporary file (zerolink count file truncated to zero-length)).</span>
<span class="cm">	 */</span>
	<span class="n">teof</span> <span class="o">=</span> <span class="p">(</span><span class="n">newsize</span> <span class="o">+</span> <span class="p">(</span><span class="n">JFS_SBI</span><span class="p">(</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_sb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">bsize</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="o">&gt;&gt;</span>
	    <span class="n">JFS_SBI</span><span class="p">(</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_sb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">l2bsize</span><span class="p">;</span>

	<span class="cm">/* clear stack */</span>
	<span class="n">BT_CLR</span><span class="p">(</span><span class="o">&amp;</span><span class="n">btstack</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * start with root</span>
<span class="cm">	 *</span>
<span class="cm">	 * root resides in the inode</span>
<span class="cm">	 */</span>
	<span class="n">bn</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * first access of each page:</span>
<span class="cm">	 */</span>
      <span class="nl">getPage:</span>
	<span class="n">XT_GETPAGE</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">bn</span><span class="p">,</span> <span class="n">mp</span><span class="p">,</span> <span class="n">PSIZE</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

	<span class="cm">/* process entries backward from last index */</span>
	<span class="n">index</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">nextindex</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>


	<span class="cm">/* Since this is the rightmost page at this level, and we may have</span>
<span class="cm">	 * already freed a page that was formerly to the right, let&#39;s make</span>
<span class="cm">	 * sure that the next pointer is zero.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">next</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">log</span><span class="p">)</span>
			<span class="cm">/*</span>
<span class="cm">			 * Make sure this change to the header is logged.</span>
<span class="cm">			 * If we really truncate this leaf, the flag</span>
<span class="cm">			 * will be changed to tlckTRUNCATE</span>
<span class="cm">			 */</span>
			<span class="n">tlck</span> <span class="o">=</span> <span class="n">txLock</span><span class="p">(</span><span class="n">tid</span><span class="p">,</span> <span class="n">ip</span><span class="p">,</span> <span class="n">mp</span><span class="p">,</span> <span class="n">tlckXTREE</span><span class="o">|</span><span class="n">tlckGROW</span><span class="p">);</span>
		<span class="n">BT_MARK_DIRTY</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="n">ip</span><span class="p">);</span>
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">next</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">flag</span> <span class="o">&amp;</span> <span class="n">BT_INTERNAL</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">getChild</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 *	leaf page</span>
<span class="cm">	 */</span>
	<span class="n">freed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* does region covered by leaf page precede Teof ? */</span>
	<span class="n">xad</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">xad</span><span class="p">[</span><span class="n">index</span><span class="p">];</span>
	<span class="n">xoff</span> <span class="o">=</span> <span class="n">offsetXAD</span><span class="p">(</span><span class="n">xad</span><span class="p">);</span>
	<span class="n">xlen</span> <span class="o">=</span> <span class="n">lengthXAD</span><span class="p">(</span><span class="n">xad</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">teof</span> <span class="o">&gt;=</span> <span class="n">xoff</span> <span class="o">+</span> <span class="n">xlen</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">XT_PUTPAGE</span><span class="p">(</span><span class="n">mp</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">getParent</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* (re)acquire tlock of the leaf page */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">log</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="n">locked_leaves</span> <span class="o">&gt;</span> <span class="n">MAX_TRUNCATE_LEAVES</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * We need to limit the size of the transaction</span>
<span class="cm">			 * to avoid exhausting pagecache &amp; tlocks</span>
<span class="cm">			 */</span>
			<span class="n">XT_PUTPAGE</span><span class="p">(</span><span class="n">mp</span><span class="p">);</span>
			<span class="n">newsize</span> <span class="o">=</span> <span class="p">(</span><span class="n">xoff</span> <span class="o">+</span> <span class="n">xlen</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">JFS_SBI</span><span class="p">(</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_sb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">l2bsize</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">getParent</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">tlck</span> <span class="o">=</span> <span class="n">txLock</span><span class="p">(</span><span class="n">tid</span><span class="p">,</span> <span class="n">ip</span><span class="p">,</span> <span class="n">mp</span><span class="p">,</span> <span class="n">tlckXTREE</span><span class="p">);</span>
		<span class="n">tlck</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">tlckXTREE</span> <span class="o">|</span> <span class="n">tlckTRUNCATE</span><span class="p">;</span>
		<span class="n">xtlck</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">xtlock</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">tlck</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">;</span>
		<span class="n">xtlck</span><span class="o">-&gt;</span><span class="n">hwm</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">nextindex</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">BT_MARK_DIRTY</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="n">ip</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * scan backward leaf page entries</span>
<span class="cm">	 */</span>
	<span class="k">for</span> <span class="p">(;</span> <span class="n">index</span> <span class="o">&gt;=</span> <span class="n">XTENTRYSTART</span><span class="p">;</span> <span class="n">index</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">xad</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">xad</span><span class="p">[</span><span class="n">index</span><span class="p">];</span>
		<span class="n">xoff</span> <span class="o">=</span> <span class="n">offsetXAD</span><span class="p">(</span><span class="n">xad</span><span class="p">);</span>
		<span class="n">xlen</span> <span class="o">=</span> <span class="n">lengthXAD</span><span class="p">(</span><span class="n">xad</span><span class="p">);</span>
		<span class="n">xaddr</span> <span class="o">=</span> <span class="n">addressXAD</span><span class="p">(</span><span class="n">xad</span><span class="p">);</span>

		<span class="cm">/*</span>
<span class="cm">		 * The &quot;data&quot; for a directory is indexed by the block</span>
<span class="cm">		 * device&#39;s address space.  This metadata must be invalidated</span>
<span class="cm">		 * here</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">S_ISDIR</span><span class="p">(</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_mode</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">teof</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span>
			<span class="n">invalidate_xad_metapages</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="o">*</span><span class="n">xad</span><span class="p">);</span>
		<span class="cm">/*</span>
<span class="cm">		 * entry beyond eof: continue scan of current page</span>
<span class="cm">		 *          xad</span>
<span class="cm">		 * ---|---=======-------&gt;</span>
<span class="cm">		 *   eof</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">teof</span> <span class="o">&lt;</span> <span class="n">xoff</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">nfreed</span> <span class="o">+=</span> <span class="n">xlen</span><span class="p">;</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/*</span>
<span class="cm">		 * (xoff &lt;= teof): last entry to be deleted from page;</span>
<span class="cm">		 * If other entries remain in page: keep and update the page.</span>
<span class="cm">		 */</span>

		<span class="cm">/*</span>
<span class="cm">		 * eof == entry_start: delete the entry</span>
<span class="cm">		 *           xad</span>
<span class="cm">		 * -------|=======-------&gt;</span>
<span class="cm">		 *       eof</span>
<span class="cm">		 *</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">teof</span> <span class="o">==</span> <span class="n">xoff</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">nfreed</span> <span class="o">+=</span> <span class="n">xlen</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">index</span> <span class="o">==</span> <span class="n">XTENTRYSTART</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>

			<span class="n">nextindex</span> <span class="o">=</span> <span class="n">index</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/*</span>
<span class="cm">		 * eof within the entry: truncate the entry.</span>
<span class="cm">		 *          xad</span>
<span class="cm">		 * -------===|===-------&gt;</span>
<span class="cm">		 *          eof</span>
<span class="cm">		 */</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">teof</span> <span class="o">&lt;</span> <span class="n">xoff</span> <span class="o">+</span> <span class="n">xlen</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* update truncated entry */</span>
			<span class="n">len</span> <span class="o">=</span> <span class="n">teof</span> <span class="o">-</span> <span class="n">xoff</span><span class="p">;</span>
			<span class="n">freexlen</span> <span class="o">=</span> <span class="n">xlen</span> <span class="o">-</span> <span class="n">len</span><span class="p">;</span>
			<span class="n">XADlength</span><span class="p">(</span><span class="n">xad</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>

			<span class="cm">/* save pxd of truncated extent in tlck */</span>
			<span class="n">xaddr</span> <span class="o">+=</span> <span class="n">len</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">log</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* COMMIT_PWMAP */</span>
				<span class="n">xtlck</span><span class="o">-&gt;</span><span class="n">lwm</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="p">(</span><span class="n">xtlck</span><span class="o">-&gt;</span><span class="n">lwm</span><span class="p">.</span><span class="n">offset</span><span class="p">)</span> <span class="o">?</span>
				    <span class="n">min</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">xtlck</span><span class="o">-&gt;</span><span class="n">lwm</span><span class="p">.</span><span class="n">offset</span><span class="p">)</span> <span class="o">:</span> <span class="n">index</span><span class="p">;</span>
				<span class="n">xtlck</span><span class="o">-&gt;</span><span class="n">lwm</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="n">index</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">-</span>
				    <span class="n">xtlck</span><span class="o">-&gt;</span><span class="n">lwm</span><span class="p">.</span><span class="n">offset</span><span class="p">;</span>
				<span class="n">xtlck</span><span class="o">-&gt;</span><span class="n">twm</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="n">index</span><span class="p">;</span>
				<span class="n">pxdlock</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">pxd_lock</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">xtlck</span><span class="o">-&gt;</span><span class="n">pxdlock</span><span class="p">;</span>
				<span class="n">pxdlock</span><span class="o">-&gt;</span><span class="n">flag</span> <span class="o">=</span> <span class="n">mlckFREEPXD</span><span class="p">;</span>
				<span class="n">PXDaddress</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pxdlock</span><span class="o">-&gt;</span><span class="n">pxd</span><span class="p">,</span> <span class="n">xaddr</span><span class="p">);</span>
				<span class="n">PXDlength</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pxdlock</span><span class="o">-&gt;</span><span class="n">pxd</span><span class="p">,</span> <span class="n">freexlen</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="cm">/* free truncated extent */</span>
			<span class="k">else</span> <span class="p">{</span>	<span class="cm">/* COMMIT_WMAP */</span>

				<span class="n">pxdlock</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">pxd_lock</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">xadlock</span><span class="p">;</span>
				<span class="n">pxdlock</span><span class="o">-&gt;</span><span class="n">flag</span> <span class="o">=</span> <span class="n">mlckFREEPXD</span><span class="p">;</span>
				<span class="n">PXDaddress</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pxdlock</span><span class="o">-&gt;</span><span class="n">pxd</span><span class="p">,</span> <span class="n">xaddr</span><span class="p">);</span>
				<span class="n">PXDlength</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pxdlock</span><span class="o">-&gt;</span><span class="n">pxd</span><span class="p">,</span> <span class="n">freexlen</span><span class="p">);</span>
				<span class="n">txFreeMap</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">pxdlock</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">COMMIT_WMAP</span><span class="p">);</span>

				<span class="cm">/* reset map lock */</span>
				<span class="n">xadlock</span><span class="p">.</span><span class="n">flag</span> <span class="o">=</span> <span class="n">mlckFREEXADLIST</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="cm">/* current entry is new last entry; */</span>
			<span class="n">nextindex</span> <span class="o">=</span> <span class="n">index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>

			<span class="n">nfreed</span> <span class="o">+=</span> <span class="n">freexlen</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/*</span>
<span class="cm">		 * eof beyond the entry:</span>
<span class="cm">		 *          xad</span>
<span class="cm">		 * -------=======---|---&gt;</span>
<span class="cm">		 *                 eof</span>
<span class="cm">		 */</span>
		<span class="k">else</span> <span class="p">{</span>		<span class="cm">/* (xoff + xlen &lt; teof) */</span>

			<span class="n">nextindex</span> <span class="o">=</span> <span class="n">index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">nextindex</span> <span class="o">&lt;</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">nextindex</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">log</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* COMMIT_WAMP */</span>
				<span class="n">xadlock</span><span class="p">.</span><span class="n">xdlist</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">xad</span><span class="p">[</span><span class="n">nextindex</span><span class="p">];</span>
				<span class="n">xadlock</span><span class="p">.</span><span class="n">count</span> <span class="o">=</span>
				    <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">nextindex</span><span class="p">)</span> <span class="o">-</span>
				    <span class="n">nextindex</span><span class="p">;</span>
				<span class="n">txFreeMap</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">maplock</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">xadlock</span><span class="p">,</span>
					  <span class="nb">NULL</span><span class="p">,</span> <span class="n">COMMIT_WMAP</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">p</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">nextindex</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">nextindex</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">XT_PUTPAGE</span><span class="p">(</span><span class="n">mp</span><span class="p">);</span>

		<span class="cm">/* assert(freed == 0); */</span>
		<span class="k">goto</span> <span class="n">getParent</span><span class="p">;</span>
	<span class="p">}</span>			<span class="cm">/* end scan of leaf page entries */</span>

	<span class="n">freed</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * leaf page become empty: free the page if type != PMAP</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">log</span><span class="p">)</span> <span class="p">{</span>		<span class="cm">/* COMMIT_PWMAP */</span>
		<span class="cm">/* txCommit() with tlckFREE:</span>
<span class="cm">		 * free data extents covered by leaf [XTENTRYSTART:hwm);</span>
<span class="cm">		 * invalidate leaf if COMMIT_PWMAP;</span>
<span class="cm">		 * if (TRUNCATE), will write LOG_NOREDOPAGE;</span>
<span class="cm">		 */</span>
		<span class="n">tlck</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">tlckXTREE</span> <span class="o">|</span> <span class="n">tlckFREE</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>		<span class="cm">/* COMMIT_WAMP */</span>

		<span class="cm">/* free data extents covered by leaf */</span>
		<span class="n">xadlock</span><span class="p">.</span><span class="n">xdlist</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">xad</span><span class="p">[</span><span class="n">XTENTRYSTART</span><span class="p">];</span>
		<span class="n">xadlock</span><span class="p">.</span><span class="n">count</span> <span class="o">=</span>
		    <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">nextindex</span><span class="p">)</span> <span class="o">-</span> <span class="n">XTENTRYSTART</span><span class="p">;</span>
		<span class="n">txFreeMap</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">maplock</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">xadlock</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">COMMIT_WMAP</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">flag</span> <span class="o">&amp;</span> <span class="n">BT_ROOT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">flag</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">BT_INTERNAL</span><span class="p">;</span>
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">flag</span> <span class="o">|=</span> <span class="n">BT_LEAF</span><span class="p">;</span>
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">nextindex</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">XTENTRYSTART</span><span class="p">);</span>

		<span class="n">XT_PUTPAGE</span><span class="p">(</span><span class="n">mp</span><span class="p">);</span>	<span class="cm">/* debug */</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">log</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* COMMIT_PWMAP */</span>
			<span class="cm">/* page will be invalidated at tx completion</span>
<span class="cm">			 */</span>
			<span class="n">XT_PUTPAGE</span><span class="p">(</span><span class="n">mp</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>	<span class="cm">/* COMMIT_WMAP */</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">lid</span><span class="p">)</span>
				<span class="n">lid_to_tlock</span><span class="p">(</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">lid</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">flag</span> <span class="o">|=</span> <span class="n">tlckFREELOCK</span><span class="p">;</span>

			<span class="cm">/* invalidate empty leaf page */</span>
			<span class="n">discard_metapage</span><span class="p">(</span><span class="n">mp</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * the leaf page become empty: delete the parent entry</span>
<span class="cm">	 * for the leaf page if the parent page is to be kept</span>
<span class="cm">	 * in the new sized file.</span>
<span class="cm">	 */</span>

	<span class="cm">/*</span>
<span class="cm">	 * go back up to the parent page</span>
<span class="cm">	 */</span>
      <span class="nl">getParent:</span>
	<span class="cm">/* pop/restore parent entry for the current child page */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">parent</span> <span class="o">=</span> <span class="n">BT_POP</span><span class="p">(</span><span class="o">&amp;</span><span class="n">btstack</span><span class="p">))</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="cm">/* current page must have been root */</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="cm">/* get back the parent page */</span>
	<span class="n">bn</span> <span class="o">=</span> <span class="n">parent</span><span class="o">-&gt;</span><span class="n">bn</span><span class="p">;</span>
	<span class="n">XT_GETPAGE</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">bn</span><span class="p">,</span> <span class="n">mp</span><span class="p">,</span> <span class="n">PSIZE</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">index</span> <span class="o">=</span> <span class="n">parent</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * child page was not empty:</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">freed</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* has any entry deleted from parent ? */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">index</span> <span class="o">&lt;</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">nextindex</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* (re)acquire tlock on the parent page */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">log</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* COMMIT_PWMAP */</span>
				<span class="cm">/* txCommit() with tlckTRUNCATE:</span>
<span class="cm">				 * free child extents covered by parent [);</span>
<span class="cm">				 */</span>
				<span class="n">tlck</span> <span class="o">=</span> <span class="n">txLock</span><span class="p">(</span><span class="n">tid</span><span class="p">,</span> <span class="n">ip</span><span class="p">,</span> <span class="n">mp</span><span class="p">,</span> <span class="n">tlckXTREE</span><span class="p">);</span>
				<span class="n">xtlck</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">xtlock</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">tlck</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">tlck</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">&amp;</span> <span class="n">tlckTRUNCATE</span><span class="p">))</span> <span class="p">{</span>
					<span class="n">xtlck</span><span class="o">-&gt;</span><span class="n">hwm</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span>
					    <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span>
							<span class="n">nextindex</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
					<span class="n">tlck</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span>
					    <span class="n">tlckXTREE</span> <span class="o">|</span> <span class="n">tlckTRUNCATE</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>	<span class="cm">/* COMMIT_WMAP */</span>

				<span class="cm">/* free child extents covered by parent */</span>
				<span class="n">xadlock</span><span class="p">.</span><span class="n">xdlist</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">xad</span><span class="p">[</span><span class="n">index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];</span>
				<span class="n">xadlock</span><span class="p">.</span><span class="n">count</span> <span class="o">=</span>
				    <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">nextindex</span><span class="p">)</span> <span class="o">-</span>
				    <span class="n">index</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
				<span class="n">txFreeMap</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">maplock</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">xadlock</span><span class="p">,</span>
					  <span class="nb">NULL</span><span class="p">,</span> <span class="n">COMMIT_WMAP</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">BT_MARK_DIRTY</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="n">ip</span><span class="p">);</span>

			<span class="n">p</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">nextindex</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">XT_PUTPAGE</span><span class="p">(</span><span class="n">mp</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">getParent</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * child page was empty:</span>
<span class="cm">	 */</span>
	<span class="n">nfreed</span> <span class="o">+=</span> <span class="n">lengthXAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">xad</span><span class="p">[</span><span class="n">index</span><span class="p">]);</span>

	<span class="cm">/*</span>
<span class="cm">	 * During working map update, child page&#39;s tlock must be handled</span>
<span class="cm">	 * before parent&#39;s.  This is because the parent&#39;s tlock will cause</span>
<span class="cm">	 * the child&#39;s disk space to be marked available in the wmap, so</span>
<span class="cm">	 * it&#39;s important that the child page be released by that time.</span>
<span class="cm">	 *</span>
<span class="cm">	 * ToDo:  tlocks should be on doubly-linked list, so we can</span>
<span class="cm">	 * quickly remove it and add it to the end.</span>
<span class="cm">	 */</span>

	<span class="cm">/*</span>
<span class="cm">	 * Move parent page&#39;s tlock to the end of the tid&#39;s tlock list</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">log</span> <span class="o">&amp;&amp;</span> <span class="n">mp</span><span class="o">-&gt;</span><span class="n">lid</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">tblk</span><span class="o">-&gt;</span><span class="n">last</span> <span class="o">!=</span> <span class="n">mp</span><span class="o">-&gt;</span><span class="n">lid</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">lid_to_tlock</span><span class="p">(</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">lid</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">tid</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">lid_t</span> <span class="n">lid</span> <span class="o">=</span> <span class="n">mp</span><span class="o">-&gt;</span><span class="n">lid</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">tlock</span> <span class="o">*</span><span class="n">prev</span><span class="p">;</span>

		<span class="n">tlck</span> <span class="o">=</span> <span class="n">lid_to_tlock</span><span class="p">(</span><span class="n">lid</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">tblk</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">==</span> <span class="n">lid</span><span class="p">)</span>
			<span class="n">tblk</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">tlck</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">prev</span> <span class="o">=</span> <span class="n">lid_to_tlock</span><span class="p">(</span><span class="n">tblk</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">);</span>
			     <span class="n">prev</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">!=</span> <span class="n">lid</span><span class="p">;</span>
			     <span class="n">prev</span> <span class="o">=</span> <span class="n">lid_to_tlock</span><span class="p">(</span><span class="n">prev</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">assert</span><span class="p">(</span><span class="n">prev</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">prev</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">tlck</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">lid_to_tlock</span><span class="p">(</span><span class="n">tblk</span><span class="o">-&gt;</span><span class="n">last</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">lid</span><span class="p">;</span>
		<span class="n">tlck</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">tblk</span><span class="o">-&gt;</span><span class="n">last</span> <span class="o">=</span> <span class="n">lid</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * parent page become empty: free the page</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">index</span> <span class="o">==</span> <span class="n">XTENTRYSTART</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">log</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* COMMIT_PWMAP */</span>
			<span class="cm">/* txCommit() with tlckFREE:</span>
<span class="cm">			 * free child extents covered by parent;</span>
<span class="cm">			 * invalidate parent if COMMIT_PWMAP;</span>
<span class="cm">			 */</span>
			<span class="n">tlck</span> <span class="o">=</span> <span class="n">txLock</span><span class="p">(</span><span class="n">tid</span><span class="p">,</span> <span class="n">ip</span><span class="p">,</span> <span class="n">mp</span><span class="p">,</span> <span class="n">tlckXTREE</span><span class="p">);</span>
			<span class="n">xtlck</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">xtlock</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">tlck</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">;</span>
			<span class="n">xtlck</span><span class="o">-&gt;</span><span class="n">hwm</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span>
			    <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">nextindex</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">tlck</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">tlckXTREE</span> <span class="o">|</span> <span class="n">tlckFREE</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>	<span class="cm">/* COMMIT_WMAP */</span>

			<span class="cm">/* free child extents covered by parent */</span>
			<span class="n">xadlock</span><span class="p">.</span><span class="n">xdlist</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">xad</span><span class="p">[</span><span class="n">XTENTRYSTART</span><span class="p">];</span>
			<span class="n">xadlock</span><span class="p">.</span><span class="n">count</span> <span class="o">=</span>
			    <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">nextindex</span><span class="p">)</span> <span class="o">-</span>
			    <span class="n">XTENTRYSTART</span><span class="p">;</span>
			<span class="n">txFreeMap</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">maplock</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">xadlock</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span>
				  <span class="n">COMMIT_WMAP</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">BT_MARK_DIRTY</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="n">ip</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">flag</span> <span class="o">&amp;</span> <span class="n">BT_ROOT</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">p</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">flag</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">BT_INTERNAL</span><span class="p">;</span>
			<span class="n">p</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">flag</span> <span class="o">|=</span> <span class="n">BT_LEAF</span><span class="p">;</span>
			<span class="n">p</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">nextindex</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">XTENTRYSTART</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">maxentry</span><span class="p">)</span> <span class="o">==</span> <span class="n">XTROOTMAXSLOT</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/*</span>
<span class="cm">				 * Shrink root down to allow inline</span>
<span class="cm">				 * EA (otherwise fsck complains)</span>
<span class="cm">				 */</span>
				<span class="n">p</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">maxentry</span> <span class="o">=</span>
				    <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">XTROOTINITSLOT</span><span class="p">);</span>
				<span class="n">JFS_IP</span><span class="p">(</span><span class="n">ip</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">mode2</span> <span class="o">|=</span> <span class="n">INLINEEA</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">XT_PUTPAGE</span><span class="p">(</span><span class="n">mp</span><span class="p">);</span>	<span class="cm">/* debug */</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">log</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* COMMIT_PWMAP */</span>
				<span class="cm">/* page will be invalidated at tx completion</span>
<span class="cm">				 */</span>
				<span class="n">XT_PUTPAGE</span><span class="p">(</span><span class="n">mp</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>	<span class="cm">/* COMMIT_WMAP */</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">lid</span><span class="p">)</span>
					<span class="n">lid_to_tlock</span><span class="p">(</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">lid</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">flag</span> <span class="o">|=</span>
						<span class="n">tlckFREELOCK</span><span class="p">;</span>

				<span class="cm">/* invalidate parent page */</span>
				<span class="n">discard_metapage</span><span class="p">(</span><span class="n">mp</span><span class="p">);</span>
			<span class="p">}</span>

			<span class="cm">/* parent has become empty and freed:</span>
<span class="cm">			 * go back up to its parent page</span>
<span class="cm">			 */</span>
			<span class="cm">/* freed = 1; */</span>
			<span class="k">goto</span> <span class="n">getParent</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="cm">/*</span>
<span class="cm">	 * parent page still has entries for front region;</span>
<span class="cm">	 */</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* try truncate region covered by preceding entry</span>
<span class="cm">		 * (process backward)</span>
<span class="cm">		 */</span>
		<span class="n">index</span><span class="o">--</span><span class="p">;</span>

		<span class="cm">/* go back down to the child page corresponding</span>
<span class="cm">		 * to the entry</span>
<span class="cm">		 */</span>
		<span class="k">goto</span> <span class="n">getChild</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 *	internal page: go down to child page of current entry</span>
<span class="cm">	 */</span>
      <span class="nl">getChild:</span>
	<span class="cm">/* save current parent entry for the child page */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">BT_STACK_FULL</span><span class="p">(</span><span class="o">&amp;</span><span class="n">btstack</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">jfs_error</span><span class="p">(</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_sb</span><span class="p">,</span> <span class="s">&quot;stack overrun in xtTruncate!&quot;</span><span class="p">);</span>
		<span class="n">XT_PUTPAGE</span><span class="p">(</span><span class="n">mp</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">BT_PUSH</span><span class="p">(</span><span class="o">&amp;</span><span class="n">btstack</span><span class="p">,</span> <span class="n">bn</span><span class="p">,</span> <span class="n">index</span><span class="p">);</span>

	<span class="cm">/* get child page */</span>
	<span class="n">xad</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">xad</span><span class="p">[</span><span class="n">index</span><span class="p">];</span>
	<span class="n">bn</span> <span class="o">=</span> <span class="n">addressXAD</span><span class="p">(</span><span class="n">xad</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * first access of each internal entry:</span>
<span class="cm">	 */</span>
	<span class="cm">/* release parent page */</span>
	<span class="n">XT_PUTPAGE</span><span class="p">(</span><span class="n">mp</span><span class="p">);</span>

	<span class="cm">/* process the child page */</span>
	<span class="k">goto</span> <span class="n">getPage</span><span class="p">;</span>

      <span class="nl">out:</span>
	<span class="cm">/*</span>
<span class="cm">	 * update file resource stat</span>
<span class="cm">	 */</span>
	<span class="cm">/* set size</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">S_ISDIR</span><span class="p">(</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_mode</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">newsize</span><span class="p">)</span>
		<span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_size</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>	<span class="cm">/* fsck hates zero-length directories */</span>
	<span class="k">else</span>
		<span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_size</span> <span class="o">=</span> <span class="n">newsize</span><span class="p">;</span>

	<span class="cm">/* update quota allocation to reflect freed blocks */</span>
	<span class="n">dquot_free_block</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">nfreed</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * free tlock of invalidated pages</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">flag</span> <span class="o">==</span> <span class="n">COMMIT_WMAP</span><span class="p">)</span>
		<span class="n">txFreelock</span><span class="p">(</span><span class="n">ip</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">newsize</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> *	xtTruncate_pmap()</span>
<span class="cm"> *</span>
<span class="cm"> * function:</span>
<span class="cm"> *	Perform truncate to zero length for deleted file, leaving the</span>
<span class="cm"> *	the xtree and working map untouched.  This allows the file to</span>
<span class="cm"> *	be accessed via open file handles, while the delete of the file</span>
<span class="cm"> *	is committed to disk.</span>
<span class="cm"> *</span>
<span class="cm"> * parameter:</span>
<span class="cm"> *	tid_t		tid,</span>
<span class="cm"> *	struct inode	*ip,</span>
<span class="cm"> *	s64		committed_size)</span>
<span class="cm"> *</span>
<span class="cm"> * return: new committed size</span>
<span class="cm"> *</span>
<span class="cm"> * note:</span>
<span class="cm"> *</span>
<span class="cm"> *	To avoid deadlock by holding too many transaction locks, the</span>
<span class="cm"> *	truncation may be broken up into multiple transactions.</span>
<span class="cm"> *	The committed_size keeps track of part of the file has been</span>
<span class="cm"> *	freed from the pmaps.</span>
<span class="cm"> */</span>
<span class="n">s64</span> <span class="nf">xtTruncate_pmap</span><span class="p">(</span><span class="n">tid_t</span> <span class="n">tid</span><span class="p">,</span> <span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">ip</span><span class="p">,</span> <span class="n">s64</span> <span class="n">committed_size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">s64</span> <span class="n">bn</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">btstack</span> <span class="n">btstack</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">cmp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">index</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">locked_leaves</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">metapage</span> <span class="o">*</span><span class="n">mp</span><span class="p">;</span>
	<span class="n">xtpage_t</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">btframe</span> <span class="o">*</span><span class="n">parent</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tblock</span> <span class="o">*</span><span class="n">tblk</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tlock</span> <span class="o">*</span><span class="n">tlck</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">xad_t</span> <span class="o">*</span><span class="n">xad</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">xlen</span><span class="p">;</span>
	<span class="n">s64</span> <span class="n">xoff</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">xtlock</span> <span class="o">*</span><span class="n">xtlck</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="cm">/* save object truncation type */</span>
	<span class="n">tblk</span> <span class="o">=</span> <span class="n">tid_to_tblock</span><span class="p">(</span><span class="n">tid</span><span class="p">);</span>
	<span class="n">tblk</span><span class="o">-&gt;</span><span class="n">xflag</span> <span class="o">|=</span> <span class="n">COMMIT_PMAP</span><span class="p">;</span>

	<span class="cm">/* clear stack */</span>
	<span class="n">BT_CLR</span><span class="p">(</span><span class="o">&amp;</span><span class="n">btstack</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">committed_size</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">xoff</span> <span class="o">=</span> <span class="p">(</span><span class="n">committed_size</span> <span class="o">&gt;&gt;</span> <span class="n">JFS_SBI</span><span class="p">(</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_sb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">l2bsize</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">xtSearch</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">xoff</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">btstack</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

		<span class="n">XT_GETSEARCH</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">btstack</span><span class="p">.</span><span class="n">top</span><span class="p">,</span> <span class="n">bn</span><span class="p">,</span> <span class="n">mp</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">index</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">cmp</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">XT_PUTPAGE</span><span class="p">(</span><span class="n">mp</span><span class="p">);</span>
			<span class="n">jfs_error</span><span class="p">(</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_sb</span><span class="p">,</span>
				  <span class="s">&quot;xtTruncate_pmap: did not find extent&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * start with root</span>
<span class="cm">		 *</span>
<span class="cm">		 * root resides in the inode</span>
<span class="cm">		 */</span>
		<span class="n">bn</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * first access of each page:</span>
<span class="cm">		 */</span>
      <span class="nl">getPage:</span>
		<span class="n">XT_GETPAGE</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">bn</span><span class="p">,</span> <span class="n">mp</span><span class="p">,</span> <span class="n">PSIZE</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

		<span class="cm">/* process entries backward from last index */</span>
		<span class="n">index</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">nextindex</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">flag</span> <span class="o">&amp;</span> <span class="n">BT_INTERNAL</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">getChild</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 *	leaf page</span>
<span class="cm">	 */</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="n">locked_leaves</span> <span class="o">&gt;</span> <span class="n">MAX_TRUNCATE_LEAVES</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * We need to limit the size of the transaction</span>
<span class="cm">		 * to avoid exhausting pagecache &amp; tlocks</span>
<span class="cm">		 */</span>
		<span class="n">xad</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">xad</span><span class="p">[</span><span class="n">index</span><span class="p">];</span>
		<span class="n">xoff</span> <span class="o">=</span> <span class="n">offsetXAD</span><span class="p">(</span><span class="n">xad</span><span class="p">);</span>
		<span class="n">xlen</span> <span class="o">=</span> <span class="n">lengthXAD</span><span class="p">(</span><span class="n">xad</span><span class="p">);</span>
		<span class="n">XT_PUTPAGE</span><span class="p">(</span><span class="n">mp</span><span class="p">);</span>
		<span class="k">return</span> <span class="p">(</span><span class="n">xoff</span> <span class="o">+</span> <span class="n">xlen</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">JFS_SBI</span><span class="p">(</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_sb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">l2bsize</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">tlck</span> <span class="o">=</span> <span class="n">txLock</span><span class="p">(</span><span class="n">tid</span><span class="p">,</span> <span class="n">ip</span><span class="p">,</span> <span class="n">mp</span><span class="p">,</span> <span class="n">tlckXTREE</span><span class="p">);</span>
	<span class="n">tlck</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">tlckXTREE</span> <span class="o">|</span> <span class="n">tlckFREE</span><span class="p">;</span>
	<span class="n">xtlck</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">xtlock</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">tlck</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">;</span>
	<span class="n">xtlck</span><span class="o">-&gt;</span><span class="n">hwm</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="n">index</span><span class="p">;</span>


	<span class="n">XT_PUTPAGE</span><span class="p">(</span><span class="n">mp</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * go back up to the parent page</span>
<span class="cm">	 */</span>
      <span class="nl">getParent:</span>
	<span class="cm">/* pop/restore parent entry for the current child page */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">parent</span> <span class="o">=</span> <span class="n">BT_POP</span><span class="p">(</span><span class="o">&amp;</span><span class="n">btstack</span><span class="p">))</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="cm">/* current page must have been root */</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="cm">/* get back the parent page */</span>
	<span class="n">bn</span> <span class="o">=</span> <span class="n">parent</span><span class="o">-&gt;</span><span class="n">bn</span><span class="p">;</span>
	<span class="n">XT_GETPAGE</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">bn</span><span class="p">,</span> <span class="n">mp</span><span class="p">,</span> <span class="n">PSIZE</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">index</span> <span class="o">=</span> <span class="n">parent</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * parent page become empty: free the page</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">index</span> <span class="o">==</span> <span class="n">XTENTRYSTART</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* txCommit() with tlckFREE:</span>
<span class="cm">		 * free child extents covered by parent;</span>
<span class="cm">		 * invalidate parent if COMMIT_PWMAP;</span>
<span class="cm">		 */</span>
		<span class="n">tlck</span> <span class="o">=</span> <span class="n">txLock</span><span class="p">(</span><span class="n">tid</span><span class="p">,</span> <span class="n">ip</span><span class="p">,</span> <span class="n">mp</span><span class="p">,</span> <span class="n">tlckXTREE</span><span class="p">);</span>
		<span class="n">xtlck</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">xtlock</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">tlck</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">;</span>
		<span class="n">xtlck</span><span class="o">-&gt;</span><span class="n">hwm</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">nextindex</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">tlck</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">tlckXTREE</span> <span class="o">|</span> <span class="n">tlckFREE</span><span class="p">;</span>

		<span class="n">XT_PUTPAGE</span><span class="p">(</span><span class="n">mp</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">flag</span> <span class="o">&amp;</span> <span class="n">BT_ROOT</span><span class="p">)</span> <span class="p">{</span>

			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">goto</span> <span class="n">getParent</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="cm">/*</span>
<span class="cm">	 * parent page still has entries for front region;</span>
<span class="cm">	 */</span>
	<span class="k">else</span>
		<span class="n">index</span><span class="o">--</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 *	internal page: go down to child page of current entry</span>
<span class="cm">	 */</span>
      <span class="nl">getChild:</span>
	<span class="cm">/* save current parent entry for the child page */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">BT_STACK_FULL</span><span class="p">(</span><span class="o">&amp;</span><span class="n">btstack</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">jfs_error</span><span class="p">(</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_sb</span><span class="p">,</span> <span class="s">&quot;stack overrun in xtTruncate_pmap!&quot;</span><span class="p">);</span>
		<span class="n">XT_PUTPAGE</span><span class="p">(</span><span class="n">mp</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">BT_PUSH</span><span class="p">(</span><span class="o">&amp;</span><span class="n">btstack</span><span class="p">,</span> <span class="n">bn</span><span class="p">,</span> <span class="n">index</span><span class="p">);</span>

	<span class="cm">/* get child page */</span>
	<span class="n">xad</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">xad</span><span class="p">[</span><span class="n">index</span><span class="p">];</span>
	<span class="n">bn</span> <span class="o">=</span> <span class="n">addressXAD</span><span class="p">(</span><span class="n">xad</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * first access of each internal entry:</span>
<span class="cm">	 */</span>
	<span class="cm">/* release parent page */</span>
	<span class="n">XT_PUTPAGE</span><span class="p">(</span><span class="n">mp</span><span class="p">);</span>

	<span class="cm">/* process the child page */</span>
	<span class="k">goto</span> <span class="n">getPage</span><span class="p">;</span>

      <span class="nl">out:</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_JFS_STATISTICS</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">jfs_xtstat_proc_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">m</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">v</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span>
		       <span class="s">&quot;JFS Xtree statistics</span><span class="se">\n</span><span class="s">&quot;</span>
		       <span class="s">&quot;====================</span><span class="se">\n</span><span class="s">&quot;</span>
		       <span class="s">&quot;searches = %d</span><span class="se">\n</span><span class="s">&quot;</span>
		       <span class="s">&quot;fast searches = %d</span><span class="se">\n</span><span class="s">&quot;</span>
		       <span class="s">&quot;splits = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">xtStat</span><span class="p">.</span><span class="n">search</span><span class="p">,</span>
		       <span class="n">xtStat</span><span class="p">.</span><span class="n">fastSearch</span><span class="p">,</span>
		       <span class="n">xtStat</span><span class="p">.</span><span class="n">split</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">jfs_xtstat_proc_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">single_open</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">jfs_xtstat_proc_show</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">const</span> <span class="k">struct</span> <span class="n">file_operations</span> <span class="n">jfs_xtstat_proc_fops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span>		<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">open</span>		<span class="o">=</span> <span class="n">jfs_xtstat_proc_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read</span>		<span class="o">=</span> <span class="n">seq_read</span><span class="p">,</span>
	<span class="p">.</span><span class="n">llseek</span>		<span class="o">=</span> <span class="n">seq_lseek</span><span class="p">,</span>
	<span class="p">.</span><span class="n">release</span>	<span class="o">=</span> <span class="n">single_release</span><span class="p">,</span>
<span class="p">};</span>
<span class="cp">#endif</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
