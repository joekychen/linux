<!DOCTYPE html>
<html><head><title>joekychen/linux » fs › hpfs › ea.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>ea.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> *  linux/fs/hpfs/ea.c</span>
<span class="cm"> *</span>
<span class="cm"> *  Mikulas Patocka (mikulas@artax.karlin.mff.cuni.cz), 1998-1999</span>
<span class="cm"> *</span>
<span class="cm"> *  handling extended attributes</span>
<span class="cm"> */</span>

<span class="cp">#include &quot;hpfs_fn.h&quot;</span>

<span class="cm">/* Remove external extended attributes. ano specifies whether a is a </span>
<span class="cm">   direct sector where eas starts or an anode */</span>

<span class="kt">void</span> <span class="nf">hpfs_ea_ext_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="n">secno</span> <span class="n">a</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ano</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="n">pos</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">pos</span> <span class="o">&lt;</span> <span class="n">len</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">char</span> <span class="n">ex</span><span class="p">[</span><span class="mi">4</span> <span class="o">+</span> <span class="mi">255</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">+</span> <span class="mi">8</span><span class="p">];</span>
		<span class="k">struct</span> <span class="n">extended_attribute</span> <span class="o">*</span><span class="n">ea</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">extended_attribute</span> <span class="o">*</span><span class="p">)</span><span class="n">ex</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pos</span> <span class="o">+</span> <span class="mi">4</span> <span class="o">&gt;</span> <span class="n">len</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">hpfs_error</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;EAs don&#39;t end correctly, %s %08x, len %08x&quot;</span><span class="p">,</span>
				<span class="n">ano</span> <span class="o">?</span> <span class="s">&quot;anode&quot;</span> <span class="o">:</span> <span class="s">&quot;sectors&quot;</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hpfs_ea_read</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">ano</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">ex</span><span class="p">))</span> <span class="k">return</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ea_indirect</span><span class="p">(</span><span class="n">ea</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ea_valuelen</span><span class="p">(</span><span class="n">ea</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">8</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">hpfs_error</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;ea_indirect(ea) set while ea-&gt;valuelen!=8, %s %08x, pos %08x&quot;</span><span class="p">,</span>
					<span class="n">ano</span> <span class="o">?</span> <span class="s">&quot;anode&quot;</span> <span class="o">:</span> <span class="s">&quot;sectors&quot;</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">pos</span><span class="p">);</span>
				<span class="k">return</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">hpfs_ea_read</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">ano</span><span class="p">,</span> <span class="n">pos</span> <span class="o">+</span> <span class="mi">4</span><span class="p">,</span> <span class="n">ea</span><span class="o">-&gt;</span><span class="n">namelen</span> <span class="o">+</span> <span class="mi">9</span><span class="p">,</span> <span class="n">ex</span><span class="o">+</span><span class="mi">4</span><span class="p">))</span>
				<span class="k">return</span><span class="p">;</span>
			<span class="n">hpfs_ea_remove</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">ea_sec</span><span class="p">(</span><span class="n">ea</span><span class="p">),</span> <span class="n">ea_in_anode</span><span class="p">(</span><span class="n">ea</span><span class="p">),</span> <span class="n">ea_len</span><span class="p">(</span><span class="n">ea</span><span class="p">));</span>
		<span class="p">}</span>
		<span class="n">pos</span> <span class="o">+=</span> <span class="n">ea</span><span class="o">-&gt;</span><span class="n">namelen</span> <span class="o">+</span> <span class="n">ea_valuelen</span><span class="p">(</span><span class="n">ea</span><span class="p">)</span> <span class="o">+</span> <span class="mi">5</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ano</span><span class="p">)</span> <span class="n">hpfs_free_sectors</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="p">(</span><span class="n">len</span><span class="o">+</span><span class="mi">511</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">9</span><span class="p">);</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">buffer_head</span> <span class="o">*</span><span class="n">bh</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">anode</span> <span class="o">*</span><span class="n">anode</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">anode</span> <span class="o">=</span> <span class="n">hpfs_map_anode</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bh</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">hpfs_remove_btree</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">anode</span><span class="o">-&gt;</span><span class="n">btree</span><span class="p">);</span>
			<span class="n">brelse</span><span class="p">(</span><span class="n">bh</span><span class="p">);</span>
			<span class="n">hpfs_free_sectors</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="nf">get_indirect_ea</span><span class="p">(</span><span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ano</span><span class="p">,</span> <span class="n">secno</span> <span class="n">a</span><span class="p">,</span> <span class="kt">int</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">ret</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ret</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">size</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">GFP_NOFS</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;HPFS: out of memory for EA</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hpfs_ea_read</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">ano</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">ret</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">ret</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ret</span><span class="p">[</span><span class="n">size</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">set_indirect_ea</span><span class="p">(</span><span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ano</span><span class="p">,</span> <span class="n">secno</span> <span class="n">a</span><span class="p">,</span>
			    <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">int</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">hpfs_ea_write</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">ano</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Read an extended attribute named &#39;key&#39; into the provided buffer */</span>

<span class="kt">int</span> <span class="nf">hpfs_read_ea</span><span class="p">(</span><span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fnode</span> <span class="o">*</span><span class="n">fnode</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">key</span><span class="p">,</span>
		<span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="n">pos</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ano</span><span class="p">,</span> <span class="n">len</span><span class="p">;</span>
	<span class="n">secno</span> <span class="n">a</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">ex</span><span class="p">[</span><span class="mi">4</span> <span class="o">+</span> <span class="mi">255</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">+</span> <span class="mi">8</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">extended_attribute</span> <span class="o">*</span><span class="n">ea</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">extended_attribute</span> <span class="o">*</span><span class="n">ea_end</span> <span class="o">=</span> <span class="n">fnode_end_ea</span><span class="p">(</span><span class="n">fnode</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">ea</span> <span class="o">=</span> <span class="n">fnode_ea</span><span class="p">(</span><span class="n">fnode</span><span class="p">);</span> <span class="n">ea</span> <span class="o">&lt;</span> <span class="n">ea_end</span><span class="p">;</span> <span class="n">ea</span> <span class="o">=</span> <span class="n">next_ea</span><span class="p">(</span><span class="n">ea</span><span class="p">))</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">ea</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">key</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ea_indirect</span><span class="p">(</span><span class="n">ea</span><span class="p">))</span>
				<span class="k">goto</span> <span class="n">indirect</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ea_valuelen</span><span class="p">(</span><span class="n">ea</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">size</span><span class="p">)</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">ea_data</span><span class="p">(</span><span class="n">ea</span><span class="p">),</span> <span class="n">ea_valuelen</span><span class="p">(</span><span class="n">ea</span><span class="p">));</span>
			<span class="n">buf</span><span class="p">[</span><span class="n">ea_valuelen</span><span class="p">(</span><span class="n">ea</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="n">a</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">fnode</span><span class="o">-&gt;</span><span class="n">ea_secno</span><span class="p">);</span>
	<span class="n">len</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">fnode</span><span class="o">-&gt;</span><span class="n">ea_size_l</span><span class="p">);</span>
	<span class="n">ano</span> <span class="o">=</span> <span class="n">fnode_in_anode</span><span class="p">(</span><span class="n">fnode</span><span class="p">);</span>
	<span class="n">pos</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">pos</span> <span class="o">&lt;</span> <span class="n">len</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ea</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">extended_attribute</span> <span class="o">*</span><span class="p">)</span><span class="n">ex</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pos</span> <span class="o">+</span> <span class="mi">4</span> <span class="o">&gt;</span> <span class="n">len</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">hpfs_error</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;EAs don&#39;t end correctly, %s %08x, len %08x&quot;</span><span class="p">,</span>
				<span class="n">ano</span> <span class="o">?</span> <span class="s">&quot;anode&quot;</span> <span class="o">:</span> <span class="s">&quot;sectors&quot;</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hpfs_ea_read</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">ano</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">ex</span><span class="p">))</span> <span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hpfs_ea_read</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">ano</span><span class="p">,</span> <span class="n">pos</span> <span class="o">+</span> <span class="mi">4</span><span class="p">,</span> <span class="n">ea</span><span class="o">-&gt;</span><span class="n">namelen</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">+</span> <span class="p">(</span><span class="n">ea_indirect</span><span class="p">(</span><span class="n">ea</span><span class="p">)</span> <span class="o">?</span> <span class="mi">8</span> <span class="o">:</span> <span class="mi">0</span><span class="p">),</span> <span class="n">ex</span> <span class="o">+</span> <span class="mi">4</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">ea</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">key</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ea_indirect</span><span class="p">(</span><span class="n">ea</span><span class="p">))</span>
				<span class="k">goto</span> <span class="n">indirect</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ea_valuelen</span><span class="p">(</span><span class="n">ea</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">size</span><span class="p">)</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">hpfs_ea_read</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">ano</span><span class="p">,</span> <span class="n">pos</span> <span class="o">+</span> <span class="mi">4</span> <span class="o">+</span> <span class="n">ea</span><span class="o">-&gt;</span><span class="n">namelen</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ea_valuelen</span><span class="p">(</span><span class="n">ea</span><span class="p">),</span> <span class="n">buf</span><span class="p">))</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
			<span class="n">buf</span><span class="p">[</span><span class="n">ea_valuelen</span><span class="p">(</span><span class="n">ea</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">pos</span> <span class="o">+=</span> <span class="n">ea</span><span class="o">-&gt;</span><span class="n">namelen</span> <span class="o">+</span> <span class="n">ea_valuelen</span><span class="p">(</span><span class="n">ea</span><span class="p">)</span> <span class="o">+</span> <span class="mi">5</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>
<span class="nl">indirect:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ea_len</span><span class="p">(</span><span class="n">ea</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">size</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hpfs_ea_read</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">ea_sec</span><span class="p">(</span><span class="n">ea</span><span class="p">),</span> <span class="n">ea_in_anode</span><span class="p">(</span><span class="n">ea</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ea_len</span><span class="p">(</span><span class="n">ea</span><span class="p">),</span> <span class="n">buf</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="n">buf</span><span class="p">[</span><span class="n">ea_len</span><span class="p">(</span><span class="n">ea</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Read an extended attribute named &#39;key&#39; */</span>
<span class="kt">char</span> <span class="o">*</span><span class="nf">hpfs_get_ea</span><span class="p">(</span><span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fnode</span> <span class="o">*</span><span class="n">fnode</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">key</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">ret</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">pos</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ano</span><span class="p">,</span> <span class="n">len</span><span class="p">;</span>
	<span class="n">secno</span> <span class="n">a</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">extended_attribute</span> <span class="o">*</span><span class="n">ea</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">extended_attribute</span> <span class="o">*</span><span class="n">ea_end</span> <span class="o">=</span> <span class="n">fnode_end_ea</span><span class="p">(</span><span class="n">fnode</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">ea</span> <span class="o">=</span> <span class="n">fnode_ea</span><span class="p">(</span><span class="n">fnode</span><span class="p">);</span> <span class="n">ea</span> <span class="o">&lt;</span> <span class="n">ea_end</span><span class="p">;</span> <span class="n">ea</span> <span class="o">=</span> <span class="n">next_ea</span><span class="p">(</span><span class="n">ea</span><span class="p">))</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">ea</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">key</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ea_indirect</span><span class="p">(</span><span class="n">ea</span><span class="p">))</span>
				<span class="k">return</span> <span class="n">get_indirect_ea</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">ea_in_anode</span><span class="p">(</span><span class="n">ea</span><span class="p">),</span> <span class="n">ea_sec</span><span class="p">(</span><span class="n">ea</span><span class="p">),</span> <span class="o">*</span><span class="n">size</span> <span class="o">=</span> <span class="n">ea_len</span><span class="p">(</span><span class="n">ea</span><span class="p">));</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ret</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">((</span><span class="o">*</span><span class="n">size</span> <span class="o">=</span> <span class="n">ea_valuelen</span><span class="p">(</span><span class="n">ea</span><span class="p">))</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">GFP_NOFS</span><span class="p">)))</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="s">&quot;HPFS: out of memory for EA</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">ret</span><span class="p">,</span> <span class="n">ea_data</span><span class="p">(</span><span class="n">ea</span><span class="p">),</span> <span class="n">ea_valuelen</span><span class="p">(</span><span class="n">ea</span><span class="p">));</span>
			<span class="n">ret</span><span class="p">[</span><span class="n">ea_valuelen</span><span class="p">(</span><span class="n">ea</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="n">a</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">fnode</span><span class="o">-&gt;</span><span class="n">ea_secno</span><span class="p">);</span>
	<span class="n">len</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">fnode</span><span class="o">-&gt;</span><span class="n">ea_size_l</span><span class="p">);</span>
	<span class="n">ano</span> <span class="o">=</span> <span class="n">fnode_in_anode</span><span class="p">(</span><span class="n">fnode</span><span class="p">);</span>
	<span class="n">pos</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">pos</span> <span class="o">&lt;</span> <span class="n">len</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">char</span> <span class="n">ex</span><span class="p">[</span><span class="mi">4</span> <span class="o">+</span> <span class="mi">255</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">+</span> <span class="mi">8</span><span class="p">];</span>
		<span class="n">ea</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">extended_attribute</span> <span class="o">*</span><span class="p">)</span><span class="n">ex</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pos</span> <span class="o">+</span> <span class="mi">4</span> <span class="o">&gt;</span> <span class="n">len</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">hpfs_error</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;EAs don&#39;t end correctly, %s %08x, len %08x&quot;</span><span class="p">,</span>
				<span class="n">ano</span> <span class="o">?</span> <span class="s">&quot;anode&quot;</span> <span class="o">:</span> <span class="s">&quot;sectors&quot;</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
			<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hpfs_ea_read</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">ano</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">ex</span><span class="p">))</span> <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hpfs_ea_read</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">ano</span><span class="p">,</span> <span class="n">pos</span> <span class="o">+</span> <span class="mi">4</span><span class="p">,</span> <span class="n">ea</span><span class="o">-&gt;</span><span class="n">namelen</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">+</span> <span class="p">(</span><span class="n">ea_indirect</span><span class="p">(</span><span class="n">ea</span><span class="p">)</span> <span class="o">?</span> <span class="mi">8</span> <span class="o">:</span> <span class="mi">0</span><span class="p">),</span> <span class="n">ex</span> <span class="o">+</span> <span class="mi">4</span><span class="p">))</span>
			<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">ea</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">key</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ea_indirect</span><span class="p">(</span><span class="n">ea</span><span class="p">))</span>
				<span class="k">return</span> <span class="n">get_indirect_ea</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">ea_in_anode</span><span class="p">(</span><span class="n">ea</span><span class="p">),</span> <span class="n">ea_sec</span><span class="p">(</span><span class="n">ea</span><span class="p">),</span> <span class="o">*</span><span class="n">size</span> <span class="o">=</span> <span class="n">ea_len</span><span class="p">(</span><span class="n">ea</span><span class="p">));</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ret</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">((</span><span class="o">*</span><span class="n">size</span> <span class="o">=</span> <span class="n">ea_valuelen</span><span class="p">(</span><span class="n">ea</span><span class="p">))</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">GFP_NOFS</span><span class="p">)))</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="s">&quot;HPFS: out of memory for EA</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">hpfs_ea_read</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">ano</span><span class="p">,</span> <span class="n">pos</span> <span class="o">+</span> <span class="mi">4</span> <span class="o">+</span> <span class="n">ea</span><span class="o">-&gt;</span><span class="n">namelen</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ea_valuelen</span><span class="p">(</span><span class="n">ea</span><span class="p">),</span> <span class="n">ret</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">kfree</span><span class="p">(</span><span class="n">ret</span><span class="p">);</span>
				<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">ret</span><span class="p">[</span><span class="n">ea_valuelen</span><span class="p">(</span><span class="n">ea</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">pos</span> <span class="o">+=</span> <span class="n">ea</span><span class="o">-&gt;</span><span class="n">namelen</span> <span class="o">+</span> <span class="n">ea_valuelen</span><span class="p">(</span><span class="n">ea</span><span class="p">)</span> <span class="o">+</span> <span class="mi">5</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* </span>
<span class="cm"> * Update or create extended attribute &#39;key&#39; with value &#39;data&#39;. Note that</span>
<span class="cm"> * when this ea exists, it MUST have the same size as size of data.</span>
<span class="cm"> * This driver can&#39;t change sizes of eas (&#39;cause I just don&#39;t need it).</span>
<span class="cm"> */</span>

<span class="kt">void</span> <span class="nf">hpfs_set_ea</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fnode</span> <span class="o">*</span><span class="n">fnode</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">key</span><span class="p">,</span>
		 <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">int</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">fnode_secno</span> <span class="n">fno</span> <span class="o">=</span> <span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_ino</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">s</span> <span class="o">=</span> <span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_sb</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">pos</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ano</span><span class="p">,</span> <span class="n">len</span><span class="p">;</span>
	<span class="n">secno</span> <span class="n">a</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">h</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">extended_attribute</span> <span class="o">*</span><span class="n">ea</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">extended_attribute</span> <span class="o">*</span><span class="n">ea_end</span> <span class="o">=</span> <span class="n">fnode_end_ea</span><span class="p">(</span><span class="n">fnode</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">ea</span> <span class="o">=</span> <span class="n">fnode_ea</span><span class="p">(</span><span class="n">fnode</span><span class="p">);</span> <span class="n">ea</span> <span class="o">&lt;</span> <span class="n">ea_end</span><span class="p">;</span> <span class="n">ea</span> <span class="o">=</span> <span class="n">next_ea</span><span class="p">(</span><span class="n">ea</span><span class="p">))</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">ea</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">key</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ea_indirect</span><span class="p">(</span><span class="n">ea</span><span class="p">))</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">ea_len</span><span class="p">(</span><span class="n">ea</span><span class="p">)</span> <span class="o">==</span> <span class="n">size</span><span class="p">)</span>
					<span class="n">set_indirect_ea</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">ea_in_anode</span><span class="p">(</span><span class="n">ea</span><span class="p">),</span> <span class="n">ea_sec</span><span class="p">(</span><span class="n">ea</span><span class="p">),</span> <span class="n">data</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ea_valuelen</span><span class="p">(</span><span class="n">ea</span><span class="p">)</span> <span class="o">==</span> <span class="n">size</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">memcpy</span><span class="p">(</span><span class="n">ea_data</span><span class="p">(</span><span class="n">ea</span><span class="p">),</span> <span class="n">data</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="n">a</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">fnode</span><span class="o">-&gt;</span><span class="n">ea_secno</span><span class="p">);</span>
	<span class="n">len</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">fnode</span><span class="o">-&gt;</span><span class="n">ea_size_l</span><span class="p">);</span>
	<span class="n">ano</span> <span class="o">=</span> <span class="n">fnode_in_anode</span><span class="p">(</span><span class="n">fnode</span><span class="p">);</span>
	<span class="n">pos</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">pos</span> <span class="o">&lt;</span> <span class="n">len</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">char</span> <span class="n">ex</span><span class="p">[</span><span class="mi">4</span> <span class="o">+</span> <span class="mi">255</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">+</span> <span class="mi">8</span><span class="p">];</span>
		<span class="n">ea</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">extended_attribute</span> <span class="o">*</span><span class="p">)</span><span class="n">ex</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pos</span> <span class="o">+</span> <span class="mi">4</span> <span class="o">&gt;</span> <span class="n">len</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">hpfs_error</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;EAs don&#39;t end correctly, %s %08x, len %08x&quot;</span><span class="p">,</span>
				<span class="n">ano</span> <span class="o">?</span> <span class="s">&quot;anode&quot;</span> <span class="o">:</span> <span class="s">&quot;sectors&quot;</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hpfs_ea_read</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">ano</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">ex</span><span class="p">))</span> <span class="k">return</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hpfs_ea_read</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">ano</span><span class="p">,</span> <span class="n">pos</span> <span class="o">+</span> <span class="mi">4</span><span class="p">,</span> <span class="n">ea</span><span class="o">-&gt;</span><span class="n">namelen</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">+</span> <span class="p">(</span><span class="n">ea_indirect</span><span class="p">(</span><span class="n">ea</span><span class="p">)</span> <span class="o">?</span> <span class="mi">8</span> <span class="o">:</span> <span class="mi">0</span><span class="p">),</span> <span class="n">ex</span> <span class="o">+</span> <span class="mi">4</span><span class="p">))</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">ea</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">key</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ea_indirect</span><span class="p">(</span><span class="n">ea</span><span class="p">))</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">ea_len</span><span class="p">(</span><span class="n">ea</span><span class="p">)</span> <span class="o">==</span> <span class="n">size</span><span class="p">)</span>
					<span class="n">set_indirect_ea</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">ea_in_anode</span><span class="p">(</span><span class="n">ea</span><span class="p">),</span> <span class="n">ea_sec</span><span class="p">(</span><span class="n">ea</span><span class="p">),</span> <span class="n">data</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">else</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">ea_valuelen</span><span class="p">(</span><span class="n">ea</span><span class="p">)</span> <span class="o">==</span> <span class="n">size</span><span class="p">)</span>
					<span class="n">hpfs_ea_write</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">ano</span><span class="p">,</span> <span class="n">pos</span> <span class="o">+</span> <span class="mi">4</span> <span class="o">+</span> <span class="n">ea</span><span class="o">-&gt;</span><span class="n">namelen</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">pos</span> <span class="o">+=</span> <span class="n">ea</span><span class="o">-&gt;</span><span class="n">namelen</span> <span class="o">+</span> <span class="n">ea_valuelen</span><span class="p">(</span><span class="n">ea</span><span class="p">)</span> <span class="o">+</span> <span class="mi">5</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">fnode</span><span class="o">-&gt;</span><span class="n">ea_offs</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/*if (le16_to_cpu(fnode-&gt;ea_size_s)) {</span>
<span class="cm">			hpfs_error(s, &quot;fnode %08x: ea_size_s == %03x, ea_offs == 0&quot;,</span>
<span class="cm">				inode-&gt;i_ino, le16_to_cpu(fnode-&gt;ea_size_s));</span>
<span class="cm">			return;</span>
<span class="cm">		}*/</span>
		<span class="n">fnode</span><span class="o">-&gt;</span><span class="n">ea_offs</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="mh">0xc4</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">fnode</span><span class="o">-&gt;</span><span class="n">ea_offs</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mh">0xc4</span> <span class="o">||</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">fnode</span><span class="o">-&gt;</span><span class="n">ea_offs</span><span class="p">)</span> <span class="o">+</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">fnode</span><span class="o">-&gt;</span><span class="n">acl_size_s</span><span class="p">)</span> <span class="o">+</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">fnode</span><span class="o">-&gt;</span><span class="n">ea_size_s</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mh">0x200</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">hpfs_error</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;fnode %08lx: ea_offs == %03x, ea_size_s == %03x&quot;</span><span class="p">,</span>
			<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_ino</span><span class="p">,</span>
			<span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">fnode</span><span class="o">-&gt;</span><span class="n">ea_offs</span><span class="p">),</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">fnode</span><span class="o">-&gt;</span><span class="n">ea_size_s</span><span class="p">));</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">fnode</span><span class="o">-&gt;</span><span class="n">ea_size_s</span><span class="p">)</span> <span class="o">||</span> <span class="o">!</span><span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">fnode</span><span class="o">-&gt;</span><span class="n">ea_size_l</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
	     <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">fnode</span><span class="o">-&gt;</span><span class="n">ea_offs</span><span class="p">)</span> <span class="o">+</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">fnode</span><span class="o">-&gt;</span><span class="n">acl_size_s</span><span class="p">)</span> <span class="o">+</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">fnode</span><span class="o">-&gt;</span><span class="n">ea_size_s</span><span class="p">)</span> <span class="o">+</span> <span class="n">strlen</span><span class="p">(</span><span class="n">key</span><span class="p">)</span> <span class="o">+</span> <span class="n">size</span> <span class="o">+</span> <span class="mi">5</span> <span class="o">&lt;=</span> <span class="mh">0x200</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ea</span> <span class="o">=</span> <span class="n">fnode_end_ea</span><span class="p">(</span><span class="n">fnode</span><span class="p">);</span>
		<span class="o">*</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">ea</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">ea</span><span class="o">-&gt;</span><span class="n">namelen</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">key</span><span class="p">);</span>
		<span class="n">ea</span><span class="o">-&gt;</span><span class="n">valuelen_lo</span> <span class="o">=</span> <span class="n">size</span><span class="p">;</span>
		<span class="n">ea</span><span class="o">-&gt;</span><span class="n">valuelen_hi</span> <span class="o">=</span> <span class="n">size</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">strcpy</span><span class="p">(</span><span class="n">ea</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">key</span><span class="p">);</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">ea_data</span><span class="p">(</span><span class="n">ea</span><span class="p">),</span> <span class="n">data</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
		<span class="n">fnode</span><span class="o">-&gt;</span><span class="n">ea_size_s</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">fnode</span><span class="o">-&gt;</span><span class="n">ea_size_s</span><span class="p">)</span> <span class="o">+</span> <span class="n">strlen</span><span class="p">(</span><span class="n">key</span><span class="p">)</span> <span class="o">+</span> <span class="n">size</span> <span class="o">+</span> <span class="mi">5</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* Most the code here is 99.9993422% unused. I hope there are no bugs.</span>
<span class="cm">	   But what .. HPFS.IFS has also bugs in ea management. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">fnode</span><span class="o">-&gt;</span><span class="n">ea_size_s</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">fnode</span><span class="o">-&gt;</span><span class="n">ea_size_l</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">secno</span> <span class="n">n</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">buffer_head</span> <span class="o">*</span><span class="n">bh</span><span class="p">;</span>
		<span class="kt">char</span> <span class="o">*</span><span class="n">data</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">n</span> <span class="o">=</span> <span class="n">hpfs_alloc_sector</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">fno</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)))</span> <span class="k">return</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">data</span> <span class="o">=</span> <span class="n">hpfs_get_sector</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bh</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">hpfs_free_sectors</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">fnode_ea</span><span class="p">(</span><span class="n">fnode</span><span class="p">),</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">fnode</span><span class="o">-&gt;</span><span class="n">ea_size_s</span><span class="p">));</span>
		<span class="n">fnode</span><span class="o">-&gt;</span><span class="n">ea_size_l</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">fnode</span><span class="o">-&gt;</span><span class="n">ea_size_s</span><span class="p">));</span>
		<span class="n">fnode</span><span class="o">-&gt;</span><span class="n">ea_size_s</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
		<span class="n">fnode</span><span class="o">-&gt;</span><span class="n">ea_secno</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">n</span><span class="p">);</span>
		<span class="n">fnode</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">FNODE_anode</span><span class="p">;</span>
		<span class="n">mark_buffer_dirty</span><span class="p">(</span><span class="n">bh</span><span class="p">);</span>
		<span class="n">brelse</span><span class="p">(</span><span class="n">bh</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">pos</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">fnode</span><span class="o">-&gt;</span><span class="n">ea_size_l</span><span class="p">)</span> <span class="o">+</span> <span class="mi">5</span> <span class="o">+</span> <span class="n">strlen</span><span class="p">(</span><span class="n">key</span><span class="p">)</span> <span class="o">+</span> <span class="n">size</span><span class="p">;</span>
	<span class="n">len</span> <span class="o">=</span> <span class="p">(</span><span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">fnode</span><span class="o">-&gt;</span><span class="n">ea_size_l</span><span class="p">)</span> <span class="o">+</span> <span class="mi">511</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">9</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pos</span> <span class="o">&gt;=</span> <span class="mi">30000</span><span class="p">)</span> <span class="k">goto</span> <span class="n">bail</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(((</span><span class="n">pos</span> <span class="o">+</span> <span class="mi">511</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">9</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">len</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">len</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">secno</span> <span class="n">q</span> <span class="o">=</span> <span class="n">hpfs_alloc_sector</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">fno</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">q</span><span class="p">)</span> <span class="k">goto</span> <span class="n">bail</span><span class="p">;</span>
			<span class="n">fnode</span><span class="o">-&gt;</span><span class="n">ea_secno</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">q</span><span class="p">);</span>
			<span class="n">fnode</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">FNODE_anode</span><span class="p">;</span>
			<span class="n">len</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fnode_in_anode</span><span class="p">(</span><span class="n">fnode</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">hpfs_alloc_if_possible</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">fnode</span><span class="o">-&gt;</span><span class="n">ea_secno</span><span class="p">)</span> <span class="o">+</span> <span class="n">len</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">len</span><span class="o">++</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="cm">/* Aargh... don&#39;t know how to create ea anodes :-( */</span>
				<span class="cm">/*struct buffer_head *bh;</span>
<span class="cm">				struct anode *anode;</span>
<span class="cm">				anode_secno a_s;</span>
<span class="cm">				if (!(anode = hpfs_alloc_anode(s, fno, &amp;a_s, &amp;bh)))</span>
<span class="cm">					goto bail;</span>
<span class="cm">				anode-&gt;up = cpu_to_le32(fno);</span>
<span class="cm">				anode-&gt;btree.fnode_parent = 1;</span>
<span class="cm">				anode-&gt;btree.n_free_nodes--;</span>
<span class="cm">				anode-&gt;btree.n_used_nodes++;</span>
<span class="cm">				anode-&gt;btree.first_free = cpu_to_le16(le16_to_cpu(anode-&gt;btree.first_free) + 12);</span>
<span class="cm">				anode-&gt;u.external[0].disk_secno = cpu_to_le32(le32_to_cpu(fnode-&gt;ea_secno));</span>
<span class="cm">				anode-&gt;u.external[0].file_secno = cpu_to_le32(0);</span>
<span class="cm">				anode-&gt;u.external[0].length = cpu_to_le32(len);</span>
<span class="cm">				mark_buffer_dirty(bh);</span>
<span class="cm">				brelse(bh);</span>
<span class="cm">				fnode-&gt;flags |= FNODE_anode;</span>
<span class="cm">				fnode-&gt;ea_secno = cpu_to_le32(a_s);*/</span>
				<span class="n">secno</span> <span class="n">new_sec</span><span class="p">;</span>
				<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">new_sec</span> <span class="o">=</span> <span class="n">hpfs_alloc_sector</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">fno</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="o">-</span> <span class="p">((</span><span class="n">pos</span> <span class="o">+</span> <span class="mi">511</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">9</span><span class="p">))))</span>
					<span class="k">goto</span> <span class="n">bail</span><span class="p">;</span>
				<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">len</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">struct</span> <span class="n">buffer_head</span> <span class="o">*</span><span class="n">bh1</span><span class="p">,</span> <span class="o">*</span><span class="n">bh2</span><span class="p">;</span>
					<span class="kt">void</span> <span class="o">*</span><span class="n">b1</span><span class="p">,</span> <span class="o">*</span><span class="n">b2</span><span class="p">;</span>
					<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">b1</span> <span class="o">=</span> <span class="n">hpfs_map_sector</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">fnode</span><span class="o">-&gt;</span><span class="n">ea_secno</span><span class="p">)</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bh1</span><span class="p">,</span> <span class="n">len</span> <span class="o">-</span> <span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)))</span> <span class="p">{</span>
						<span class="n">hpfs_free_sectors</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">new_sec</span><span class="p">,</span> <span class="p">(</span><span class="n">pos</span> <span class="o">+</span> <span class="mi">511</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">9</span><span class="p">);</span>
						<span class="k">goto</span> <span class="n">bail</span><span class="p">;</span>
					<span class="p">}</span>
					<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">b2</span> <span class="o">=</span> <span class="n">hpfs_get_sector</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">new_sec</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bh2</span><span class="p">)))</span> <span class="p">{</span>
						<span class="n">brelse</span><span class="p">(</span><span class="n">bh1</span><span class="p">);</span>
						<span class="n">hpfs_free_sectors</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">new_sec</span><span class="p">,</span> <span class="p">(</span><span class="n">pos</span> <span class="o">+</span> <span class="mi">511</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">9</span><span class="p">);</span>
						<span class="k">goto</span> <span class="n">bail</span><span class="p">;</span>
					<span class="p">}</span>
					<span class="n">memcpy</span><span class="p">(</span><span class="n">b2</span><span class="p">,</span> <span class="n">b1</span><span class="p">,</span> <span class="mi">512</span><span class="p">);</span>
					<span class="n">brelse</span><span class="p">(</span><span class="n">bh1</span><span class="p">);</span>
					<span class="n">mark_buffer_dirty</span><span class="p">(</span><span class="n">bh2</span><span class="p">);</span>
					<span class="n">brelse</span><span class="p">(</span><span class="n">bh2</span><span class="p">);</span>
				<span class="p">}</span>
				<span class="n">hpfs_free_sectors</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">fnode</span><span class="o">-&gt;</span><span class="n">ea_secno</span><span class="p">),</span> <span class="n">len</span><span class="p">);</span>
				<span class="n">fnode</span><span class="o">-&gt;</span><span class="n">ea_secno</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">new_sec</span><span class="p">);</span>
				<span class="n">len</span> <span class="o">=</span> <span class="p">(</span><span class="n">pos</span> <span class="o">+</span> <span class="mi">511</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">9</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">fnode_in_anode</span><span class="p">(</span><span class="n">fnode</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">hpfs_add_sector_to_btree</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">fnode</span><span class="o">-&gt;</span><span class="n">ea_secno</span><span class="p">),</span>
						     <span class="mi">0</span><span class="p">,</span> <span class="n">len</span><span class="p">)</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">len</span><span class="o">++</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="k">goto</span> <span class="n">bail</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">h</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">h</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">key</span><span class="p">);</span>
	<span class="n">h</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">size</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">h</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">size</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hpfs_ea_write</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">fnode</span><span class="o">-&gt;</span><span class="n">ea_secno</span><span class="p">),</span> <span class="n">fnode_in_anode</span><span class="p">(</span><span class="n">fnode</span><span class="p">),</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">fnode</span><span class="o">-&gt;</span><span class="n">ea_size_l</span><span class="p">),</span> <span class="mi">4</span><span class="p">,</span> <span class="n">h</span><span class="p">))</span> <span class="k">goto</span> <span class="n">bail</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hpfs_ea_write</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">fnode</span><span class="o">-&gt;</span><span class="n">ea_secno</span><span class="p">),</span> <span class="n">fnode_in_anode</span><span class="p">(</span><span class="n">fnode</span><span class="p">),</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">fnode</span><span class="o">-&gt;</span><span class="n">ea_size_l</span><span class="p">)</span> <span class="o">+</span> <span class="mi">4</span><span class="p">,</span> <span class="n">h</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">key</span><span class="p">))</span> <span class="k">goto</span> <span class="n">bail</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hpfs_ea_write</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">fnode</span><span class="o">-&gt;</span><span class="n">ea_secno</span><span class="p">),</span> <span class="n">fnode_in_anode</span><span class="p">(</span><span class="n">fnode</span><span class="p">),</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">fnode</span><span class="o">-&gt;</span><span class="n">ea_size_l</span><span class="p">)</span> <span class="o">+</span> <span class="mi">5</span> <span class="o">+</span> <span class="n">h</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">size</span><span class="p">,</span> <span class="n">data</span><span class="p">))</span> <span class="k">goto</span> <span class="n">bail</span><span class="p">;</span>
	<span class="n">fnode</span><span class="o">-&gt;</span><span class="n">ea_size_l</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">pos</span><span class="p">);</span>
	<span class="nl">ret:</span>
	<span class="n">hpfs_i</span><span class="p">(</span><span class="n">inode</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">i_ea_size</span> <span class="o">+=</span> <span class="mi">5</span> <span class="o">+</span> <span class="n">strlen</span><span class="p">(</span><span class="n">key</span><span class="p">)</span> <span class="o">+</span> <span class="n">size</span><span class="p">;</span>
	<span class="k">return</span><span class="p">;</span>
	<span class="nl">bail:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">fnode</span><span class="o">-&gt;</span><span class="n">ea_secno</span><span class="p">))</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">fnode_in_anode</span><span class="p">(</span><span class="n">fnode</span><span class="p">))</span> <span class="n">hpfs_truncate_btree</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">fnode</span><span class="o">-&gt;</span><span class="n">ea_secno</span><span class="p">),</span> <span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">fnode</span><span class="o">-&gt;</span><span class="n">ea_size_l</span><span class="p">)</span> <span class="o">+</span> <span class="mi">511</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">9</span><span class="p">);</span>
		<span class="k">else</span> <span class="n">hpfs_free_sectors</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">fnode</span><span class="o">-&gt;</span><span class="n">ea_secno</span><span class="p">)</span> <span class="o">+</span> <span class="p">((</span><span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">fnode</span><span class="o">-&gt;</span><span class="n">ea_size_l</span><span class="p">)</span> <span class="o">+</span> <span class="mi">511</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">9</span><span class="p">),</span> <span class="n">len</span> <span class="o">-</span> <span class="p">((</span><span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">fnode</span><span class="o">-&gt;</span><span class="n">ea_size_l</span><span class="p">)</span> <span class="o">+</span> <span class="mi">511</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">9</span><span class="p">));</span>
	<span class="k">else</span> <span class="n">fnode</span><span class="o">-&gt;</span><span class="n">ea_secno</span> <span class="o">=</span> <span class="n">fnode</span><span class="o">-&gt;</span><span class="n">ea_size_l</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>
	

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
