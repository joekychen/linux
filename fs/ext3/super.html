<!DOCTYPE html>
<html><head><title>joekychen/linux » fs › ext3 › super.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>super.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> *  linux/fs/ext3/super.c</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 1992, 1993, 1994, 1995</span>
<span class="cm"> * Remy Card (card@masi.ibp.fr)</span>
<span class="cm"> * Laboratoire MASI - Institut Blaise Pascal</span>
<span class="cm"> * Universite Pierre et Marie Curie (Paris VI)</span>
<span class="cm"> *</span>
<span class="cm"> *  from</span>
<span class="cm"> *</span>
<span class="cm"> *  linux/fs/minix/inode.c</span>
<span class="cm"> *</span>
<span class="cm"> *  Copyright (C) 1991, 1992  Linus Torvalds</span>
<span class="cm"> *</span>
<span class="cm"> *  Big-endian to little-endian byte-swapping/bitmaps by</span>
<span class="cm"> *        David S. Miller (davem@caip.rutgers.edu), 1995</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/blkdev.h&gt;</span>
<span class="cp">#include &lt;linux/parser.h&gt;</span>
<span class="cp">#include &lt;linux/exportfs.h&gt;</span>
<span class="cp">#include &lt;linux/statfs.h&gt;</span>
<span class="cp">#include &lt;linux/random.h&gt;</span>
<span class="cp">#include &lt;linux/mount.h&gt;</span>
<span class="cp">#include &lt;linux/quotaops.h&gt;</span>
<span class="cp">#include &lt;linux/seq_file.h&gt;</span>
<span class="cp">#include &lt;linux/log2.h&gt;</span>
<span class="cp">#include &lt;linux/cleancache.h&gt;</span>

<span class="cp">#include &lt;asm/uaccess.h&gt;</span>

<span class="cp">#define CREATE_TRACE_POINTS</span>

<span class="cp">#include &quot;ext3.h&quot;</span>
<span class="cp">#include &quot;xattr.h&quot;</span>
<span class="cp">#include &quot;acl.h&quot;</span>
<span class="cp">#include &quot;namei.h&quot;</span>

<span class="cp">#ifdef CONFIG_EXT3_DEFAULTS_TO_ORDERED</span>
  <span class="cp">#define EXT3_MOUNT_DEFAULT_DATA_MODE EXT3_MOUNT_ORDERED_DATA</span>
<span class="cp">#else</span>
  <span class="cp">#define EXT3_MOUNT_DEFAULT_DATA_MODE EXT3_MOUNT_WRITEBACK_DATA</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">ext3_load_journal</span><span class="p">(</span><span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ext3_super_block</span> <span class="o">*</span><span class="p">,</span>
			     <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">journal_devnum</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">ext3_create_journal</span><span class="p">(</span><span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ext3_super_block</span> <span class="o">*</span><span class="p">,</span>
			       <span class="kt">unsigned</span> <span class="kt">int</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">ext3_commit_super</span><span class="p">(</span><span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">sb</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">ext3_super_block</span> <span class="o">*</span><span class="n">es</span><span class="p">,</span>
			       <span class="kt">int</span> <span class="n">sync</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">ext3_mark_recovery_complete</span><span class="p">(</span><span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span> <span class="n">sb</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">ext3_super_block</span> <span class="o">*</span> <span class="n">es</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">ext3_clear_journal_err</span><span class="p">(</span><span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span> <span class="n">sb</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">ext3_super_block</span> <span class="o">*</span> <span class="n">es</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">ext3_sync_fs</span><span class="p">(</span><span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">sb</span><span class="p">,</span> <span class="kt">int</span> <span class="n">wait</span><span class="p">);</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">ext3_decode_error</span><span class="p">(</span><span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span> <span class="n">sb</span><span class="p">,</span> <span class="kt">int</span> <span class="n">errno</span><span class="p">,</span>
				     <span class="kt">char</span> <span class="n">nbuf</span><span class="p">[</span><span class="mi">16</span><span class="p">]);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">ext3_remount</span> <span class="p">(</span><span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span> <span class="n">sb</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span> <span class="n">flags</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span> <span class="n">data</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">ext3_statfs</span> <span class="p">(</span><span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span> <span class="n">dentry</span><span class="p">,</span> <span class="k">struct</span> <span class="n">kstatfs</span> <span class="o">*</span> <span class="n">buf</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">ext3_unfreeze</span><span class="p">(</span><span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">sb</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">ext3_freeze</span><span class="p">(</span><span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">sb</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * Wrappers for journal_start/end.</span>
<span class="cm"> *</span>
<span class="cm"> * The only special thing we need to do here is to make sure that all</span>
<span class="cm"> * journal_end calls result in the superblock being marked dirty, so</span>
<span class="cm"> * that sync() will call the filesystem&#39;s write_super callback if</span>
<span class="cm"> * appropriate.</span>
<span class="cm"> */</span>
<span class="n">handle_t</span> <span class="o">*</span><span class="nf">ext3_journal_start_sb</span><span class="p">(</span><span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">sb</span><span class="p">,</span> <span class="kt">int</span> <span class="n">nblocks</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">journal_t</span> <span class="o">*</span><span class="n">journal</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_flags</span> <span class="o">&amp;</span> <span class="n">MS_RDONLY</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">EROFS</span><span class="p">);</span>

	<span class="cm">/* Special case here: if the journal has aborted behind our</span>
<span class="cm">	 * backs (eg. EIO in the commit thread), then we still need to</span>
<span class="cm">	 * take the FS itself readonly cleanly. */</span>
	<span class="n">journal</span> <span class="o">=</span> <span class="n">EXT3_SB</span><span class="p">(</span><span class="n">sb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">s_journal</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">is_journal_aborted</span><span class="p">(</span><span class="n">journal</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ext3_abort</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
			   <span class="s">&quot;Detected aborted journal&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">EROFS</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">journal_start</span><span class="p">(</span><span class="n">journal</span><span class="p">,</span> <span class="n">nblocks</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * The only special thing we need to do here is to make sure that all</span>
<span class="cm"> * journal_stop calls result in the superblock being marked dirty, so</span>
<span class="cm"> * that sync() will call the filesystem&#39;s write_super callback if</span>
<span class="cm"> * appropriate.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">__ext3_journal_stop</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">where</span><span class="p">,</span> <span class="n">handle_t</span> <span class="o">*</span><span class="n">handle</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">sb</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">sb</span> <span class="o">=</span> <span class="n">handle</span><span class="o">-&gt;</span><span class="n">h_transaction</span><span class="o">-&gt;</span><span class="n">t_journal</span><span class="o">-&gt;</span><span class="n">j_private</span><span class="p">;</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">handle</span><span class="o">-&gt;</span><span class="n">h_err</span><span class="p">;</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">journal_stop</span><span class="p">(</span><span class="n">handle</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span><span class="p">)</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">rc</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="n">__ext3_std_error</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">where</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">ext3_journal_abort_handle</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">caller</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">err_fn</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">buffer_head</span> <span class="o">*</span><span class="n">bh</span><span class="p">,</span> <span class="n">handle_t</span> <span class="o">*</span><span class="n">handle</span><span class="p">,</span> <span class="kt">int</span> <span class="n">err</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="n">nbuf</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">errstr</span> <span class="o">=</span> <span class="n">ext3_decode_error</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">err</span><span class="p">,</span> <span class="n">nbuf</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bh</span><span class="p">)</span>
		<span class="n">BUFFER_TRACE</span><span class="p">(</span><span class="n">bh</span><span class="p">,</span> <span class="s">&quot;abort&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">handle</span><span class="o">-&gt;</span><span class="n">h_err</span><span class="p">)</span>
		<span class="n">handle</span><span class="o">-&gt;</span><span class="n">h_err</span> <span class="o">=</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">is_handle_aborted</span><span class="p">(</span><span class="n">handle</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;EXT3-fs: %s: aborting transaction: %s in %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">caller</span><span class="p">,</span> <span class="n">errstr</span><span class="p">,</span> <span class="n">err_fn</span><span class="p">);</span>

	<span class="n">journal_abort_handle</span><span class="p">(</span><span class="n">handle</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">ext3_msg</span><span class="p">(</span><span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">sb</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">prefix</span><span class="p">,</span>
		<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">fmt</span><span class="p">,</span> <span class="p">...)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">va_format</span> <span class="n">vaf</span><span class="p">;</span>
	<span class="kt">va_list</span> <span class="n">args</span><span class="p">;</span>

	<span class="n">va_start</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">fmt</span><span class="p">);</span>

	<span class="n">vaf</span><span class="p">.</span><span class="n">fmt</span> <span class="o">=</span> <span class="n">fmt</span><span class="p">;</span>
	<span class="n">vaf</span><span class="p">.</span><span class="n">va</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">args</span><span class="p">;</span>

	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%sEXT3-fs (%s): %pV</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">prefix</span><span class="p">,</span> <span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_id</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vaf</span><span class="p">);</span>

	<span class="n">va_end</span><span class="p">(</span><span class="n">args</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Deal with the reporting of failure conditions on a filesystem such as</span>
<span class="cm"> * inconsistencies detected or read IO failures.</span>
<span class="cm"> *</span>
<span class="cm"> * On ext2, we can store the error state of the filesystem in the</span>
<span class="cm"> * superblock.  That is not possible on ext3, because we may have other</span>
<span class="cm"> * write ordering constraints on the superblock which prevent us from</span>
<span class="cm"> * writing it out straight away; and given that the journal is about to</span>
<span class="cm"> * be aborted, we can&#39;t rely on the current, or future, transactions to</span>
<span class="cm"> * write out the superblock safely.</span>
<span class="cm"> *</span>
<span class="cm"> * We&#39;ll just use the journal_abort() error code to record an error in</span>
<span class="cm"> * the journal instead.  On recovery, the journal will complain about</span>
<span class="cm"> * that error until we&#39;ve noted it down and cleared it.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ext3_handle_error</span><span class="p">(</span><span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">sb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ext3_super_block</span> <span class="o">*</span><span class="n">es</span> <span class="o">=</span> <span class="n">EXT3_SB</span><span class="p">(</span><span class="n">sb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">s_es</span><span class="p">;</span>

	<span class="n">EXT3_SB</span><span class="p">(</span><span class="n">sb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">s_mount_state</span> <span class="o">|=</span> <span class="n">EXT3_ERROR_FS</span><span class="p">;</span>
	<span class="n">es</span><span class="o">-&gt;</span><span class="n">s_state</span> <span class="o">|=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">EXT3_ERROR_FS</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_flags</span> <span class="o">&amp;</span> <span class="n">MS_RDONLY</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_opt</span> <span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">ERRORS_CONT</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">journal_t</span> <span class="o">*</span><span class="n">journal</span> <span class="o">=</span> <span class="n">EXT3_SB</span><span class="p">(</span><span class="n">sb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">s_journal</span><span class="p">;</span>

		<span class="n">set_opt</span><span class="p">(</span><span class="n">EXT3_SB</span><span class="p">(</span><span class="n">sb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">s_mount_opt</span><span class="p">,</span> <span class="n">ABORT</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">journal</span><span class="p">)</span>
			<span class="n">journal_abort</span><span class="p">(</span><span class="n">journal</span><span class="p">,</span> <span class="o">-</span><span class="n">EIO</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_opt</span> <span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">ERRORS_RO</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ext3_msg</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">KERN_CRIT</span><span class="p">,</span>
			<span class="s">&quot;error: remounting filesystem read-only&quot;</span><span class="p">);</span>
		<span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_flags</span> <span class="o">|=</span> <span class="n">MS_RDONLY</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ext3_commit_super</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">es</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_opt</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">ERRORS_PANIC</span><span class="p">))</span>
		<span class="n">panic</span><span class="p">(</span><span class="s">&quot;EXT3-fs (%s): panic forced after error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_id</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">ext3_error</span><span class="p">(</span><span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">sb</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">function</span><span class="p">,</span>
		<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">fmt</span><span class="p">,</span> <span class="p">...)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">va_format</span> <span class="n">vaf</span><span class="p">;</span>
	<span class="kt">va_list</span> <span class="n">args</span><span class="p">;</span>

	<span class="n">va_start</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">fmt</span><span class="p">);</span>

	<span class="n">vaf</span><span class="p">.</span><span class="n">fmt</span> <span class="o">=</span> <span class="n">fmt</span><span class="p">;</span>
	<span class="n">vaf</span><span class="p">.</span><span class="n">va</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">args</span><span class="p">;</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_CRIT</span> <span class="s">&quot;EXT3-fs error (device %s): %s: %pV</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_id</span><span class="p">,</span> <span class="n">function</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vaf</span><span class="p">);</span>

	<span class="n">va_end</span><span class="p">(</span><span class="n">args</span><span class="p">);</span>

	<span class="n">ext3_handle_error</span><span class="p">(</span><span class="n">sb</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="nf">ext3_decode_error</span><span class="p">(</span><span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span> <span class="n">sb</span><span class="p">,</span> <span class="kt">int</span> <span class="n">errno</span><span class="p">,</span>
				     <span class="kt">char</span> <span class="n">nbuf</span><span class="p">[</span><span class="mi">16</span><span class="p">])</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">errstr</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">errno</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="o">-</span><span class="n">EIO</span>:
		<span class="n">errstr</span> <span class="o">=</span> <span class="s">&quot;IO failure&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="o">-</span><span class="n">ENOMEM</span>:
		<span class="n">errstr</span> <span class="o">=</span> <span class="s">&quot;Out of memory&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="o">-</span><span class="n">EROFS</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sb</span> <span class="o">||</span> <span class="n">EXT3_SB</span><span class="p">(</span><span class="n">sb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">s_journal</span><span class="o">-&gt;</span><span class="n">j_flags</span> <span class="o">&amp;</span> <span class="n">JFS_ABORT</span><span class="p">)</span>
			<span class="n">errstr</span> <span class="o">=</span> <span class="s">&quot;Journal has aborted&quot;</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">errstr</span> <span class="o">=</span> <span class="s">&quot;Readonly filesystem&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="cm">/* If the caller passed in an extra buffer for unknown</span>
<span class="cm">		 * errors, textualise them now.  Else we just return</span>
<span class="cm">		 * NULL. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">nbuf</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Check for truncated error codes... */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">snprintf</span><span class="p">(</span><span class="n">nbuf</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="s">&quot;error %d&quot;</span><span class="p">,</span> <span class="o">-</span><span class="n">errno</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">errstr</span> <span class="o">=</span> <span class="n">nbuf</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">errstr</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* __ext3_std_error decodes expected errors from journaling functions</span>
<span class="cm"> * automatically and invokes the appropriate error response.  */</span>

<span class="kt">void</span> <span class="nf">__ext3_std_error</span> <span class="p">(</span><span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span> <span class="n">sb</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span> <span class="n">function</span><span class="p">,</span>
		       <span class="kt">int</span> <span class="n">errno</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="n">nbuf</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">errstr</span><span class="p">;</span>

	<span class="cm">/* Special case: if the error is EROFS, and we&#39;re not already</span>
<span class="cm">	 * inside a transaction, then there&#39;s really no point in logging</span>
<span class="cm">	 * an error. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">errno</span> <span class="o">==</span> <span class="o">-</span><span class="n">EROFS</span> <span class="o">&amp;&amp;</span> <span class="n">journal_current_handle</span><span class="p">()</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_flags</span> <span class="o">&amp;</span> <span class="n">MS_RDONLY</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">errstr</span> <span class="o">=</span> <span class="n">ext3_decode_error</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">errno</span><span class="p">,</span> <span class="n">nbuf</span><span class="p">);</span>
	<span class="n">ext3_msg</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">KERN_CRIT</span><span class="p">,</span> <span class="s">&quot;error in %s: %s&quot;</span><span class="p">,</span> <span class="n">function</span><span class="p">,</span> <span class="n">errstr</span><span class="p">);</span>

	<span class="n">ext3_handle_error</span><span class="p">(</span><span class="n">sb</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * ext3_abort is a much stronger failure handler than ext3_error.  The</span>
<span class="cm"> * abort function may be used to deal with unrecoverable failures such</span>
<span class="cm"> * as journal IO errors or ENOMEM at a critical moment in log management.</span>
<span class="cm"> *</span>
<span class="cm"> * We unconditionally force the filesystem into an ABORT|READONLY state,</span>
<span class="cm"> * unless the error response on the fs has been set to panic in which</span>
<span class="cm"> * case we take the easy way out and panic immediately.</span>
<span class="cm"> */</span>

<span class="kt">void</span> <span class="nf">ext3_abort</span><span class="p">(</span><span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">sb</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">function</span><span class="p">,</span>
		 <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">fmt</span><span class="p">,</span> <span class="p">...)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">va_format</span> <span class="n">vaf</span><span class="p">;</span>
	<span class="kt">va_list</span> <span class="n">args</span><span class="p">;</span>

	<span class="n">va_start</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">fmt</span><span class="p">);</span>

	<span class="n">vaf</span><span class="p">.</span><span class="n">fmt</span> <span class="o">=</span> <span class="n">fmt</span><span class="p">;</span>
	<span class="n">vaf</span><span class="p">.</span><span class="n">va</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">args</span><span class="p">;</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_CRIT</span> <span class="s">&quot;EXT3-fs (%s): error: %s: %pV</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_id</span><span class="p">,</span> <span class="n">function</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vaf</span><span class="p">);</span>

	<span class="n">va_end</span><span class="p">(</span><span class="n">args</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_opt</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">ERRORS_PANIC</span><span class="p">))</span>
		<span class="n">panic</span><span class="p">(</span><span class="s">&quot;EXT3-fs: panic from previous error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_flags</span> <span class="o">&amp;</span> <span class="n">MS_RDONLY</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">ext3_msg</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">KERN_CRIT</span><span class="p">,</span>
		<span class="s">&quot;error: remounting filesystem read-only&quot;</span><span class="p">);</span>
	<span class="n">EXT3_SB</span><span class="p">(</span><span class="n">sb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">s_mount_state</span> <span class="o">|=</span> <span class="n">EXT3_ERROR_FS</span><span class="p">;</span>
	<span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_flags</span> <span class="o">|=</span> <span class="n">MS_RDONLY</span><span class="p">;</span>
	<span class="n">set_opt</span><span class="p">(</span><span class="n">EXT3_SB</span><span class="p">(</span><span class="n">sb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">s_mount_opt</span><span class="p">,</span> <span class="n">ABORT</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">EXT3_SB</span><span class="p">(</span><span class="n">sb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">s_journal</span><span class="p">)</span>
		<span class="n">journal_abort</span><span class="p">(</span><span class="n">EXT3_SB</span><span class="p">(</span><span class="n">sb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">s_journal</span><span class="p">,</span> <span class="o">-</span><span class="n">EIO</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">ext3_warning</span><span class="p">(</span><span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">sb</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">function</span><span class="p">,</span>
		  <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">fmt</span><span class="p">,</span> <span class="p">...)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">va_format</span> <span class="n">vaf</span><span class="p">;</span>
	<span class="kt">va_list</span> <span class="n">args</span><span class="p">;</span>

	<span class="n">va_start</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">fmt</span><span class="p">);</span>

	<span class="n">vaf</span><span class="p">.</span><span class="n">fmt</span> <span class="o">=</span> <span class="n">fmt</span><span class="p">;</span>
	<span class="n">vaf</span><span class="p">.</span><span class="n">va</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">args</span><span class="p">;</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;EXT3-fs (%s): warning: %s: %pV</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_id</span><span class="p">,</span> <span class="n">function</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vaf</span><span class="p">);</span>

	<span class="n">va_end</span><span class="p">(</span><span class="n">args</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">ext3_update_dynamic_rev</span><span class="p">(</span><span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">sb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ext3_super_block</span> <span class="o">*</span><span class="n">es</span> <span class="o">=</span> <span class="n">EXT3_SB</span><span class="p">(</span><span class="n">sb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">s_es</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">es</span><span class="o">-&gt;</span><span class="n">s_rev_level</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">EXT3_GOOD_OLD_REV</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">ext3_msg</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">KERN_WARNING</span><span class="p">,</span>
		<span class="s">&quot;warning: updating to rev %d because of &quot;</span>
		<span class="s">&quot;new feature flag, running e2fsck is recommended&quot;</span><span class="p">,</span>
		<span class="n">EXT3_DYNAMIC_REV</span><span class="p">);</span>

	<span class="n">es</span><span class="o">-&gt;</span><span class="n">s_first_ino</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">EXT3_GOOD_OLD_FIRST_INO</span><span class="p">);</span>
	<span class="n">es</span><span class="o">-&gt;</span><span class="n">s_inode_size</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">EXT3_GOOD_OLD_INODE_SIZE</span><span class="p">);</span>
	<span class="n">es</span><span class="o">-&gt;</span><span class="n">s_rev_level</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">EXT3_DYNAMIC_REV</span><span class="p">);</span>
	<span class="cm">/* leave es-&gt;s_feature_*compat flags alone */</span>
	<span class="cm">/* es-&gt;s_uuid will be set by e2fsck if empty */</span>

	<span class="cm">/*</span>
<span class="cm">	 * The rest of the superblock fields should be zero, and if not it</span>
<span class="cm">	 * means they are likely already in use, so leave them alone.  We</span>
<span class="cm">	 * can leave it up to e2fsck to clean up any inconsistencies there.</span>
<span class="cm">	 */</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Open the external journal device</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">block_device</span> <span class="o">*</span><span class="nf">ext3_blkdev_get</span><span class="p">(</span><span class="n">dev_t</span> <span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">sb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">block_device</span> <span class="o">*</span><span class="n">bdev</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">b</span><span class="p">[</span><span class="n">BDEVNAME_SIZE</span><span class="p">];</span>

	<span class="n">bdev</span> <span class="o">=</span> <span class="n">blkdev_get_by_dev</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">FMODE_READ</span><span class="o">|</span><span class="n">FMODE_WRITE</span><span class="o">|</span><span class="n">FMODE_EXCL</span><span class="p">,</span> <span class="n">sb</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">bdev</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">bdev</span><span class="p">;</span>

<span class="nl">fail:</span>
	<span class="n">ext3_msg</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="s">&quot;error: failed to open journal device %s: %ld&quot;</span><span class="p">,</span>
		<span class="n">__bdevname</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">b</span><span class="p">),</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">bdev</span><span class="p">));</span>

	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Release the journal device</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ext3_blkdev_put</span><span class="p">(</span><span class="k">struct</span> <span class="n">block_device</span> <span class="o">*</span><span class="n">bdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">blkdev_put</span><span class="p">(</span><span class="n">bdev</span><span class="p">,</span> <span class="n">FMODE_READ</span><span class="o">|</span><span class="n">FMODE_WRITE</span><span class="o">|</span><span class="n">FMODE_EXCL</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ext3_blkdev_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">ext3_sb_info</span> <span class="o">*</span><span class="n">sbi</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">block_device</span> <span class="o">*</span><span class="n">bdev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="n">bdev</span> <span class="o">=</span> <span class="n">sbi</span><span class="o">-&gt;</span><span class="n">journal_bdev</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bdev</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">ext3_blkdev_put</span><span class="p">(</span><span class="n">bdev</span><span class="p">);</span>
		<span class="n">sbi</span><span class="o">-&gt;</span><span class="n">journal_bdev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="nf">orphan_list_entry</span><span class="p">(</span><span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">l</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="o">&amp;</span><span class="n">list_entry</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ext3_inode_info</span><span class="p">,</span> <span class="n">i_orphan</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">vfs_inode</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dump_orphan_list</span><span class="p">(</span><span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">sb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ext3_sb_info</span> <span class="o">*</span><span class="n">sbi</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">l</span><span class="p">;</span>

	<span class="n">ext3_msg</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">KERN_ERR</span><span class="p">,</span> <span class="s">&quot;error: sb orphan head is %d&quot;</span><span class="p">,</span>
	       <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_es</span><span class="o">-&gt;</span><span class="n">s_last_orphan</span><span class="p">));</span>

	<span class="n">ext3_msg</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">KERN_ERR</span><span class="p">,</span> <span class="s">&quot;sb_info orphan list:&quot;</span><span class="p">);</span>
	<span class="n">list_for_each</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_orphan</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span> <span class="o">=</span> <span class="n">orphan_list_entry</span><span class="p">(</span><span class="n">l</span><span class="p">);</span>
		<span class="n">ext3_msg</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">KERN_ERR</span><span class="p">,</span> <span class="s">&quot;  &quot;</span>
		       <span class="s">&quot;inode %s:%lu at %p: mode %o, nlink %d, next %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_sb</span><span class="o">-&gt;</span><span class="n">s_id</span><span class="p">,</span> <span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_ino</span><span class="p">,</span> <span class="n">inode</span><span class="p">,</span>
		       <span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_mode</span><span class="p">,</span> <span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_nlink</span><span class="p">,</span>
		       <span class="n">NEXT_ORPHAN</span><span class="p">(</span><span class="n">inode</span><span class="p">));</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ext3_put_super</span> <span class="p">(</span><span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span> <span class="n">sb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ext3_sb_info</span> <span class="o">*</span><span class="n">sbi</span> <span class="o">=</span> <span class="n">EXT3_SB</span><span class="p">(</span><span class="n">sb</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ext3_super_block</span> <span class="o">*</span><span class="n">es</span> <span class="o">=</span> <span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_es</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">dquot_disable</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">DQUOT_USAGE_ENABLED</span> <span class="o">|</span> <span class="n">DQUOT_LIMITS_ENABLED</span><span class="p">);</span>
	<span class="n">ext3_xattr_put_super</span><span class="p">(</span><span class="n">sb</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">journal_destroy</span><span class="p">(</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_journal</span><span class="p">);</span>
	<span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_journal</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">ext3_abort</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="s">&quot;Couldn&#39;t clean up the journal&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_flags</span> <span class="o">&amp;</span> <span class="n">MS_RDONLY</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">EXT3_CLEAR_INCOMPAT_FEATURE</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">EXT3_FEATURE_INCOMPAT_RECOVER</span><span class="p">);</span>
		<span class="n">es</span><span class="o">-&gt;</span><span class="n">s_state</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_mount_state</span><span class="p">);</span>
		<span class="n">BUFFER_TRACE</span><span class="p">(</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_sbh</span><span class="p">,</span> <span class="s">&quot;marking dirty&quot;</span><span class="p">);</span>
		<span class="n">mark_buffer_dirty</span><span class="p">(</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_sbh</span><span class="p">);</span>
		<span class="n">ext3_commit_super</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">es</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_gdb_count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">brelse</span><span class="p">(</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_group_desc</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_group_desc</span><span class="p">);</span>
	<span class="n">percpu_counter_destroy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_freeblocks_counter</span><span class="p">);</span>
	<span class="n">percpu_counter_destroy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_freeinodes_counter</span><span class="p">);</span>
	<span class="n">percpu_counter_destroy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_dirs_counter</span><span class="p">);</span>
	<span class="n">brelse</span><span class="p">(</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_sbh</span><span class="p">);</span>
<span class="cp">#ifdef CONFIG_QUOTA</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MAXQUOTAS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_qf_names</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
<span class="cp">#endif</span>

	<span class="cm">/* Debugging code just in case the in-memory inode orphan list</span>
<span class="cm">	 * isn&#39;t empty.  The on-disk one can be non-empty if we&#39;ve</span>
<span class="cm">	 * detected an error and taken the fs readonly, but the</span>
<span class="cm">	 * in-memory list had better be clean by this point. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_orphan</span><span class="p">))</span>
		<span class="n">dump_orphan_list</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">sbi</span><span class="p">);</span>
	<span class="n">J_ASSERT</span><span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_orphan</span><span class="p">));</span>

	<span class="n">invalidate_bdev</span><span class="p">(</span><span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_bdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">journal_bdev</span> <span class="o">&amp;&amp;</span> <span class="n">sbi</span><span class="o">-&gt;</span><span class="n">journal_bdev</span> <span class="o">!=</span> <span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_bdev</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Invalidate the journal device&#39;s buffers.  We don&#39;t want them</span>
<span class="cm">		 * floating about in memory - the physical journal device may</span>
<span class="cm">		 * hotswapped, and it breaks the `ro-after&#39; testing code.</span>
<span class="cm">		 */</span>
		<span class="n">sync_blockdev</span><span class="p">(</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">journal_bdev</span><span class="p">);</span>
		<span class="n">invalidate_bdev</span><span class="p">(</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">journal_bdev</span><span class="p">);</span>
		<span class="n">ext3_blkdev_remove</span><span class="p">(</span><span class="n">sbi</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_fs_info</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_blockgroup_lock</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">sbi</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">kmem_cache</span> <span class="o">*</span><span class="n">ext3_inode_cachep</span><span class="p">;</span>

<span class="cm">/*</span>
<span class="cm"> * Called inside transaction, so use GFP_NOFS</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="nf">ext3_alloc_inode</span><span class="p">(</span><span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">sb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ext3_inode_info</span> <span class="o">*</span><span class="n">ei</span><span class="p">;</span>

	<span class="n">ei</span> <span class="o">=</span> <span class="n">kmem_cache_alloc</span><span class="p">(</span><span class="n">ext3_inode_cachep</span><span class="p">,</span> <span class="n">GFP_NOFS</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ei</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">ei</span><span class="o">-&gt;</span><span class="n">i_block_alloc_info</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">ei</span><span class="o">-&gt;</span><span class="n">vfs_inode</span><span class="p">.</span><span class="n">i_version</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ei</span><span class="o">-&gt;</span><span class="n">i_datasync_tid</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ei</span><span class="o">-&gt;</span><span class="n">i_sync_tid</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">&amp;</span><span class="n">ei</span><span class="o">-&gt;</span><span class="n">vfs_inode</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ext3_drop_inode</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">drop</span> <span class="o">=</span> <span class="n">generic_drop_inode</span><span class="p">(</span><span class="n">inode</span><span class="p">);</span>

	<span class="n">trace_ext3_drop_inode</span><span class="p">(</span><span class="n">inode</span><span class="p">,</span> <span class="n">drop</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">drop</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ext3_i_callback</span><span class="p">(</span><span class="k">struct</span> <span class="n">rcu_head</span> <span class="o">*</span><span class="n">head</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">head</span><span class="p">,</span> <span class="k">struct</span> <span class="n">inode</span><span class="p">,</span> <span class="n">i_rcu</span><span class="p">);</span>
	<span class="n">kmem_cache_free</span><span class="p">(</span><span class="n">ext3_inode_cachep</span><span class="p">,</span> <span class="n">EXT3_I</span><span class="p">(</span><span class="n">inode</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ext3_destroy_inode</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">EXT3_I</span><span class="p">(</span><span class="n">inode</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">i_orphan</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;EXT3 Inode %p: orphan list check failed!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">EXT3_I</span><span class="p">(</span><span class="n">inode</span><span class="p">));</span>
		<span class="n">print_hex_dump</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="p">,</span> <span class="n">DUMP_PREFIX_ADDRESS</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span>
				<span class="n">EXT3_I</span><span class="p">(</span><span class="n">inode</span><span class="p">),</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ext3_inode_info</span><span class="p">),</span>
				<span class="nb">false</span><span class="p">);</span>
		<span class="n">dump_stack</span><span class="p">();</span>
	<span class="p">}</span>
	<span class="n">call_rcu</span><span class="p">(</span><span class="o">&amp;</span><span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_rcu</span><span class="p">,</span> <span class="n">ext3_i_callback</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">init_once</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">foo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ext3_inode_info</span> <span class="o">*</span><span class="n">ei</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ext3_inode_info</span> <span class="o">*</span><span class="p">)</span> <span class="n">foo</span><span class="p">;</span>

	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ei</span><span class="o">-&gt;</span><span class="n">i_orphan</span><span class="p">);</span>
<span class="cp">#ifdef CONFIG_EXT3_FS_XATTR</span>
	<span class="n">init_rwsem</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ei</span><span class="o">-&gt;</span><span class="n">xattr_sem</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ei</span><span class="o">-&gt;</span><span class="n">truncate_mutex</span><span class="p">);</span>
	<span class="n">inode_init_once</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ei</span><span class="o">-&gt;</span><span class="n">vfs_inode</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">init_inodecache</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ext3_inode_cachep</span> <span class="o">=</span> <span class="n">kmem_cache_create</span><span class="p">(</span><span class="s">&quot;ext3_inode_cache&quot;</span><span class="p">,</span>
					     <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ext3_inode_info</span><span class="p">),</span>
					     <span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="n">SLAB_RECLAIM_ACCOUNT</span><span class="o">|</span>
						<span class="n">SLAB_MEM_SPREAD</span><span class="p">),</span>
					     <span class="n">init_once</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ext3_inode_cachep</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">destroy_inodecache</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">kmem_cache_destroy</span><span class="p">(</span><span class="n">ext3_inode_cachep</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">ext3_show_quota_options</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">seq</span><span class="p">,</span> <span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">sb</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#if defined(CONFIG_QUOTA)</span>
	<span class="k">struct</span> <span class="n">ext3_sb_info</span> <span class="o">*</span><span class="n">sbi</span> <span class="o">=</span> <span class="n">EXT3_SB</span><span class="p">(</span><span class="n">sb</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_jquota_fmt</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">char</span> <span class="o">*</span><span class="n">fmtname</span> <span class="o">=</span> <span class="s">&quot;&quot;</span><span class="p">;</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_jquota_fmt</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">QFMT_VFS_OLD</span>:
			<span class="n">fmtname</span> <span class="o">=</span> <span class="s">&quot;vfsold&quot;</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">QFMT_VFS_V0</span>:
			<span class="n">fmtname</span> <span class="o">=</span> <span class="s">&quot;vfsv0&quot;</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">QFMT_VFS_V1</span>:
			<span class="n">fmtname</span> <span class="o">=</span> <span class="s">&quot;vfsv1&quot;</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;,jqfmt=%s&quot;</span><span class="p">,</span> <span class="n">fmtname</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_qf_names</span><span class="p">[</span><span class="n">USRQUOTA</span><span class="p">])</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;,usrjquota=%s&quot;</span><span class="p">,</span> <span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_qf_names</span><span class="p">[</span><span class="n">USRQUOTA</span><span class="p">]);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_qf_names</span><span class="p">[</span><span class="n">GRPQUOTA</span><span class="p">])</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;,grpjquota=%s&quot;</span><span class="p">,</span> <span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_qf_names</span><span class="p">[</span><span class="n">GRPQUOTA</span><span class="p">]);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_opt</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">USRQUOTA</span><span class="p">))</span>
		<span class="n">seq_puts</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;,usrquota&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_opt</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">GRPQUOTA</span><span class="p">))</span>
		<span class="n">seq_puts</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;,grpquota&quot;</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="nf">data_mode_string</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">mode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">EXT3_MOUNT_JOURNAL_DATA</span>:
		<span class="k">return</span> <span class="s">&quot;journal&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">EXT3_MOUNT_ORDERED_DATA</span>:
		<span class="k">return</span> <span class="s">&quot;ordered&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">EXT3_MOUNT_WRITEBACK_DATA</span>:
		<span class="k">return</span> <span class="s">&quot;writeback&quot;</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="s">&quot;unknown&quot;</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Show an option if</span>
<span class="cm"> *  - it&#39;s set to a non-default value OR</span>
<span class="cm"> *  - if the per-sb default is different from the global default</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ext3_show_options</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">seq</span><span class="p">,</span> <span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="n">root</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">sb</span> <span class="o">=</span> <span class="n">root</span><span class="o">-&gt;</span><span class="n">d_sb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ext3_sb_info</span> <span class="o">*</span><span class="n">sbi</span> <span class="o">=</span> <span class="n">EXT3_SB</span><span class="p">(</span><span class="n">sb</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ext3_super_block</span> <span class="o">*</span><span class="n">es</span> <span class="o">=</span> <span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_es</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">def_mount_opts</span><span class="p">;</span>

	<span class="n">def_mount_opts</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">es</span><span class="o">-&gt;</span><span class="n">s_default_mount_opts</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_sb_block</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;,sb=%lu&quot;</span><span class="p">,</span> <span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_sb_block</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_opt</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">MINIX_DF</span><span class="p">))</span>
		<span class="n">seq_puts</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;,minixdf&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_opt</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">GRPID</span><span class="p">))</span>
		<span class="n">seq_puts</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;,grpid&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_opt</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">GRPID</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">def_mount_opts</span> <span class="o">&amp;</span> <span class="n">EXT3_DEFM_BSDGROUPS</span><span class="p">))</span>
		<span class="n">seq_puts</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;,nogrpid&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">uid_eq</span><span class="p">(</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_resuid</span><span class="p">,</span> <span class="n">make_kuid</span><span class="p">(</span><span class="o">&amp;</span><span class="n">init_user_ns</span><span class="p">,</span> <span class="n">EXT3_DEF_RESUID</span><span class="p">))</span> <span class="o">||</span>
	    <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">es</span><span class="o">-&gt;</span><span class="n">s_def_resuid</span><span class="p">)</span> <span class="o">!=</span> <span class="n">EXT3_DEF_RESUID</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;,resuid=%u&quot;</span><span class="p">,</span>
				<span class="n">from_kuid_munged</span><span class="p">(</span><span class="o">&amp;</span><span class="n">init_user_ns</span><span class="p">,</span> <span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_resuid</span><span class="p">));</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">gid_eq</span><span class="p">(</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_resgid</span><span class="p">,</span> <span class="n">make_kgid</span><span class="p">(</span><span class="o">&amp;</span><span class="n">init_user_ns</span><span class="p">,</span> <span class="n">EXT3_DEF_RESGID</span><span class="p">))</span> <span class="o">||</span>
	    <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">es</span><span class="o">-&gt;</span><span class="n">s_def_resgid</span><span class="p">)</span> <span class="o">!=</span> <span class="n">EXT3_DEF_RESGID</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;,resgid=%u&quot;</span><span class="p">,</span>
				<span class="n">from_kgid_munged</span><span class="p">(</span><span class="o">&amp;</span><span class="n">init_user_ns</span><span class="p">,</span> <span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_resgid</span><span class="p">));</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_opt</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">ERRORS_RO</span><span class="p">))</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">def_errors</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">es</span><span class="o">-&gt;</span><span class="n">s_errors</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">def_errors</span> <span class="o">==</span> <span class="n">EXT3_ERRORS_PANIC</span> <span class="o">||</span>
		    <span class="n">def_errors</span> <span class="o">==</span> <span class="n">EXT3_ERRORS_CONTINUE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">seq_puts</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;,errors=remount-ro&quot;</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_opt</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">ERRORS_CONT</span><span class="p">))</span>
		<span class="n">seq_puts</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;,errors=continue&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_opt</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">ERRORS_PANIC</span><span class="p">))</span>
		<span class="n">seq_puts</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;,errors=panic&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_opt</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">NO_UID32</span><span class="p">))</span>
		<span class="n">seq_puts</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;,nouid32&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_opt</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">DEBUG</span><span class="p">))</span>
		<span class="n">seq_puts</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;,debug&quot;</span><span class="p">);</span>
<span class="cp">#ifdef CONFIG_EXT3_FS_XATTR</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_opt</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">XATTR_USER</span><span class="p">))</span>
		<span class="n">seq_puts</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;,user_xattr&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_opt</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">XATTR_USER</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">def_mount_opts</span> <span class="o">&amp;</span> <span class="n">EXT3_DEFM_XATTR_USER</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">seq_puts</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;,nouser_xattr&quot;</span><span class="p">);</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef CONFIG_EXT3_FS_POSIX_ACL</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_opt</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">POSIX_ACL</span><span class="p">))</span>
		<span class="n">seq_puts</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;,acl&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_opt</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">POSIX_ACL</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">def_mount_opts</span> <span class="o">&amp;</span> <span class="n">EXT3_DEFM_ACL</span><span class="p">))</span>
		<span class="n">seq_puts</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;,noacl&quot;</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_opt</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">RESERVATION</span><span class="p">))</span>
		<span class="n">seq_puts</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;,noreservation&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_commit_interval</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;,commit=%u&quot;</span><span class="p">,</span>
			   <span class="p">(</span><span class="kt">unsigned</span><span class="p">)</span> <span class="p">(</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_commit_interval</span> <span class="o">/</span> <span class="n">HZ</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Always display barrier state so it&#39;s clear what the status is.</span>
<span class="cm">	 */</span>
	<span class="n">seq_puts</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;,barrier=&quot;</span><span class="p">);</span>
	<span class="n">seq_puts</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="n">test_opt</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">BARRIER</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;1&quot;</span> <span class="o">:</span> <span class="s">&quot;0&quot;</span><span class="p">);</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;,data=%s&quot;</span><span class="p">,</span> <span class="n">data_mode_string</span><span class="p">(</span><span class="n">test_opt</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">DATA_FLAGS</span><span class="p">)));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_opt</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">DATA_ERR_ABORT</span><span class="p">))</span>
		<span class="n">seq_puts</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;,data_err=abort&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_opt</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">NOLOAD</span><span class="p">))</span>
		<span class="n">seq_puts</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;,norecovery&quot;</span><span class="p">);</span>

	<span class="n">ext3_show_quota_options</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="n">sb</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="nf">ext3_nfs_get_inode</span><span class="p">(</span><span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">sb</span><span class="p">,</span>
		<span class="n">u64</span> <span class="n">ino</span><span class="p">,</span> <span class="n">u32</span> <span class="n">generation</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ino</span> <span class="o">&lt;</span> <span class="n">EXT3_FIRST_INO</span><span class="p">(</span><span class="n">sb</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">ino</span> <span class="o">!=</span> <span class="n">EXT3_ROOT_INO</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">ESTALE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ino</span> <span class="o">&gt;</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">EXT3_SB</span><span class="p">(</span><span class="n">sb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">s_es</span><span class="o">-&gt;</span><span class="n">s_inodes_count</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">ESTALE</span><span class="p">);</span>

	<span class="cm">/* iget isn&#39;t really right if the inode is currently unallocated!!</span>
<span class="cm">	 *</span>
<span class="cm">	 * ext3_read_inode will return a bad_inode if the inode had been</span>
<span class="cm">	 * deleted, so we should be safe.</span>
<span class="cm">	 *</span>
<span class="cm">	 * Currently we don&#39;t know the generation for parent directory, so</span>
<span class="cm">	 * a generation of 0 means &quot;accept any&quot;</span>
<span class="cm">	 */</span>
	<span class="n">inode</span> <span class="o">=</span> <span class="n">ext3_iget</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">ino</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">inode</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">ERR_CAST</span><span class="p">(</span><span class="n">inode</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">generation</span> <span class="o">&amp;&amp;</span> <span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_generation</span> <span class="o">!=</span> <span class="n">generation</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">iput</span><span class="p">(</span><span class="n">inode</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">ESTALE</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">inode</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="nf">ext3_fh_to_dentry</span><span class="p">(</span><span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">sb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fid</span> <span class="o">*</span><span class="n">fid</span><span class="p">,</span>
		<span class="kt">int</span> <span class="n">fh_len</span><span class="p">,</span> <span class="kt">int</span> <span class="n">fh_type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">generic_fh_to_dentry</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">fid</span><span class="p">,</span> <span class="n">fh_len</span><span class="p">,</span> <span class="n">fh_type</span><span class="p">,</span>
				    <span class="n">ext3_nfs_get_inode</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="nf">ext3_fh_to_parent</span><span class="p">(</span><span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">sb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fid</span> <span class="o">*</span><span class="n">fid</span><span class="p">,</span>
		<span class="kt">int</span> <span class="n">fh_len</span><span class="p">,</span> <span class="kt">int</span> <span class="n">fh_type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">generic_fh_to_parent</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">fid</span><span class="p">,</span> <span class="n">fh_len</span><span class="p">,</span> <span class="n">fh_type</span><span class="p">,</span>
				    <span class="n">ext3_nfs_get_inode</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Try to release metadata pages (indirect blocks, directories) which are</span>
<span class="cm"> * mapped via the block device.  Since these pages could have journal heads</span>
<span class="cm"> * which would prevent try_to_free_buffers() from freeing them, we must use</span>
<span class="cm"> * jbd layer&#39;s try_to_free_buffers() function to release them.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">bdev_try_to_free_page</span><span class="p">(</span><span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">sb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="n">page</span><span class="p">,</span>
				 <span class="n">gfp_t</span> <span class="n">wait</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">journal_t</span> <span class="o">*</span><span class="n">journal</span> <span class="o">=</span> <span class="n">EXT3_SB</span><span class="p">(</span><span class="n">sb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">s_journal</span><span class="p">;</span>

	<span class="n">WARN_ON</span><span class="p">(</span><span class="n">PageChecked</span><span class="p">(</span><span class="n">page</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">page_has_buffers</span><span class="p">(</span><span class="n">page</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">journal</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">journal_try_to_free_buffers</span><span class="p">(</span><span class="n">journal</span><span class="p">,</span> <span class="n">page</span><span class="p">,</span> 
						   <span class="n">wait</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">__GFP_WAIT</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">try_to_free_buffers</span><span class="p">(</span><span class="n">page</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_QUOTA</span>
<span class="cp">#define QTYPE2NAME(t) ((t)==USRQUOTA?&quot;user&quot;:&quot;group&quot;)</span>
<span class="cp">#define QTYPE2MOPT(on, t) ((t)==USRQUOTA?((on)##USRJQUOTA):((on)##GRPJQUOTA))</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">ext3_write_dquot</span><span class="p">(</span><span class="k">struct</span> <span class="n">dquot</span> <span class="o">*</span><span class="n">dquot</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">ext3_acquire_dquot</span><span class="p">(</span><span class="k">struct</span> <span class="n">dquot</span> <span class="o">*</span><span class="n">dquot</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">ext3_release_dquot</span><span class="p">(</span><span class="k">struct</span> <span class="n">dquot</span> <span class="o">*</span><span class="n">dquot</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">ext3_mark_dquot_dirty</span><span class="p">(</span><span class="k">struct</span> <span class="n">dquot</span> <span class="o">*</span><span class="n">dquot</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">ext3_write_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">sb</span><span class="p">,</span> <span class="kt">int</span> <span class="n">type</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">ext3_quota_on</span><span class="p">(</span><span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">sb</span><span class="p">,</span> <span class="kt">int</span> <span class="n">type</span><span class="p">,</span> <span class="kt">int</span> <span class="n">format_id</span><span class="p">,</span>
			 <span class="k">struct</span> <span class="n">path</span> <span class="o">*</span><span class="n">path</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">ext3_quota_on_mount</span><span class="p">(</span><span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">sb</span><span class="p">,</span> <span class="kt">int</span> <span class="n">type</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">ssize_t</span> <span class="n">ext3_quota_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">sb</span><span class="p">,</span> <span class="kt">int</span> <span class="n">type</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span>
			       <span class="kt">size_t</span> <span class="n">len</span><span class="p">,</span> <span class="n">loff_t</span> <span class="n">off</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">ssize_t</span> <span class="n">ext3_quota_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">sb</span><span class="p">,</span> <span class="kt">int</span> <span class="n">type</span><span class="p">,</span>
				<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">len</span><span class="p">,</span> <span class="n">loff_t</span> <span class="n">off</span><span class="p">);</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">dquot_operations</span> <span class="n">ext3_quota_operations</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">write_dquot</span>	<span class="o">=</span> <span class="n">ext3_write_dquot</span><span class="p">,</span>
	<span class="p">.</span><span class="n">acquire_dquot</span>	<span class="o">=</span> <span class="n">ext3_acquire_dquot</span><span class="p">,</span>
	<span class="p">.</span><span class="n">release_dquot</span>	<span class="o">=</span> <span class="n">ext3_release_dquot</span><span class="p">,</span>
	<span class="p">.</span><span class="n">mark_dirty</span>	<span class="o">=</span> <span class="n">ext3_mark_dquot_dirty</span><span class="p">,</span>
	<span class="p">.</span><span class="n">write_info</span>	<span class="o">=</span> <span class="n">ext3_write_info</span><span class="p">,</span>
	<span class="p">.</span><span class="n">alloc_dquot</span>	<span class="o">=</span> <span class="n">dquot_alloc</span><span class="p">,</span>
	<span class="p">.</span><span class="n">destroy_dquot</span>	<span class="o">=</span> <span class="n">dquot_destroy</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">quotactl_ops</span> <span class="n">ext3_qctl_operations</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">quota_on</span>	<span class="o">=</span> <span class="n">ext3_quota_on</span><span class="p">,</span>
	<span class="p">.</span><span class="n">quota_off</span>	<span class="o">=</span> <span class="n">dquot_quota_off</span><span class="p">,</span>
	<span class="p">.</span><span class="n">quota_sync</span>	<span class="o">=</span> <span class="n">dquot_quota_sync</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_info</span>	<span class="o">=</span> <span class="n">dquot_get_dqinfo</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_info</span>	<span class="o">=</span> <span class="n">dquot_set_dqinfo</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_dqblk</span>	<span class="o">=</span> <span class="n">dquot_get_dqblk</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_dqblk</span>	<span class="o">=</span> <span class="n">dquot_set_dqblk</span>
<span class="p">};</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">super_operations</span> <span class="n">ext3_sops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">alloc_inode</span>	<span class="o">=</span> <span class="n">ext3_alloc_inode</span><span class="p">,</span>
	<span class="p">.</span><span class="n">destroy_inode</span>	<span class="o">=</span> <span class="n">ext3_destroy_inode</span><span class="p">,</span>
	<span class="p">.</span><span class="n">write_inode</span>	<span class="o">=</span> <span class="n">ext3_write_inode</span><span class="p">,</span>
	<span class="p">.</span><span class="n">dirty_inode</span>	<span class="o">=</span> <span class="n">ext3_dirty_inode</span><span class="p">,</span>
	<span class="p">.</span><span class="n">drop_inode</span>	<span class="o">=</span> <span class="n">ext3_drop_inode</span><span class="p">,</span>
	<span class="p">.</span><span class="n">evict_inode</span>	<span class="o">=</span> <span class="n">ext3_evict_inode</span><span class="p">,</span>
	<span class="p">.</span><span class="n">put_super</span>	<span class="o">=</span> <span class="n">ext3_put_super</span><span class="p">,</span>
	<span class="p">.</span><span class="n">sync_fs</span>	<span class="o">=</span> <span class="n">ext3_sync_fs</span><span class="p">,</span>
	<span class="p">.</span><span class="n">freeze_fs</span>	<span class="o">=</span> <span class="n">ext3_freeze</span><span class="p">,</span>
	<span class="p">.</span><span class="n">unfreeze_fs</span>	<span class="o">=</span> <span class="n">ext3_unfreeze</span><span class="p">,</span>
	<span class="p">.</span><span class="n">statfs</span>		<span class="o">=</span> <span class="n">ext3_statfs</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remount_fs</span>	<span class="o">=</span> <span class="n">ext3_remount</span><span class="p">,</span>
	<span class="p">.</span><span class="n">show_options</span>	<span class="o">=</span> <span class="n">ext3_show_options</span><span class="p">,</span>
<span class="cp">#ifdef CONFIG_QUOTA</span>
	<span class="p">.</span><span class="n">quota_read</span>	<span class="o">=</span> <span class="n">ext3_quota_read</span><span class="p">,</span>
	<span class="p">.</span><span class="n">quota_write</span>	<span class="o">=</span> <span class="n">ext3_quota_write</span><span class="p">,</span>
<span class="cp">#endif</span>
	<span class="p">.</span><span class="n">bdev_try_to_free_page</span> <span class="o">=</span> <span class="n">bdev_try_to_free_page</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">export_operations</span> <span class="n">ext3_export_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">fh_to_dentry</span> <span class="o">=</span> <span class="n">ext3_fh_to_dentry</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fh_to_parent</span> <span class="o">=</span> <span class="n">ext3_fh_to_parent</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_parent</span> <span class="o">=</span> <span class="n">ext3_get_parent</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">enum</span> <span class="p">{</span>
	<span class="n">Opt_bsd_df</span><span class="p">,</span> <span class="n">Opt_minix_df</span><span class="p">,</span> <span class="n">Opt_grpid</span><span class="p">,</span> <span class="n">Opt_nogrpid</span><span class="p">,</span>
	<span class="n">Opt_resgid</span><span class="p">,</span> <span class="n">Opt_resuid</span><span class="p">,</span> <span class="n">Opt_sb</span><span class="p">,</span> <span class="n">Opt_err_cont</span><span class="p">,</span> <span class="n">Opt_err_panic</span><span class="p">,</span> <span class="n">Opt_err_ro</span><span class="p">,</span>
	<span class="n">Opt_nouid32</span><span class="p">,</span> <span class="n">Opt_nocheck</span><span class="p">,</span> <span class="n">Opt_debug</span><span class="p">,</span> <span class="n">Opt_oldalloc</span><span class="p">,</span> <span class="n">Opt_orlov</span><span class="p">,</span>
	<span class="n">Opt_user_xattr</span><span class="p">,</span> <span class="n">Opt_nouser_xattr</span><span class="p">,</span> <span class="n">Opt_acl</span><span class="p">,</span> <span class="n">Opt_noacl</span><span class="p">,</span>
	<span class="n">Opt_reservation</span><span class="p">,</span> <span class="n">Opt_noreservation</span><span class="p">,</span> <span class="n">Opt_noload</span><span class="p">,</span> <span class="n">Opt_nobh</span><span class="p">,</span> <span class="n">Opt_bh</span><span class="p">,</span>
	<span class="n">Opt_commit</span><span class="p">,</span> <span class="n">Opt_journal_update</span><span class="p">,</span> <span class="n">Opt_journal_inum</span><span class="p">,</span> <span class="n">Opt_journal_dev</span><span class="p">,</span>
	<span class="n">Opt_abort</span><span class="p">,</span> <span class="n">Opt_data_journal</span><span class="p">,</span> <span class="n">Opt_data_ordered</span><span class="p">,</span> <span class="n">Opt_data_writeback</span><span class="p">,</span>
	<span class="n">Opt_data_err_abort</span><span class="p">,</span> <span class="n">Opt_data_err_ignore</span><span class="p">,</span>
	<span class="n">Opt_usrjquota</span><span class="p">,</span> <span class="n">Opt_grpjquota</span><span class="p">,</span> <span class="n">Opt_offusrjquota</span><span class="p">,</span> <span class="n">Opt_offgrpjquota</span><span class="p">,</span>
	<span class="n">Opt_jqfmt_vfsold</span><span class="p">,</span> <span class="n">Opt_jqfmt_vfsv0</span><span class="p">,</span> <span class="n">Opt_jqfmt_vfsv1</span><span class="p">,</span> <span class="n">Opt_quota</span><span class="p">,</span>
	<span class="n">Opt_noquota</span><span class="p">,</span> <span class="n">Opt_ignore</span><span class="p">,</span> <span class="n">Opt_barrier</span><span class="p">,</span> <span class="n">Opt_nobarrier</span><span class="p">,</span> <span class="n">Opt_err</span><span class="p">,</span>
	<span class="n">Opt_resize</span><span class="p">,</span> <span class="n">Opt_usrquota</span><span class="p">,</span> <span class="n">Opt_grpquota</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="n">match_table_t</span> <span class="n">tokens</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span><span class="n">Opt_bsd_df</span><span class="p">,</span> <span class="s">&quot;bsddf&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">Opt_minix_df</span><span class="p">,</span> <span class="s">&quot;minixdf&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">Opt_grpid</span><span class="p">,</span> <span class="s">&quot;grpid&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">Opt_grpid</span><span class="p">,</span> <span class="s">&quot;bsdgroups&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">Opt_nogrpid</span><span class="p">,</span> <span class="s">&quot;nogrpid&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">Opt_nogrpid</span><span class="p">,</span> <span class="s">&quot;sysvgroups&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">Opt_resgid</span><span class="p">,</span> <span class="s">&quot;resgid=%u&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">Opt_resuid</span><span class="p">,</span> <span class="s">&quot;resuid=%u&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">Opt_sb</span><span class="p">,</span> <span class="s">&quot;sb=%u&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">Opt_err_cont</span><span class="p">,</span> <span class="s">&quot;errors=continue&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">Opt_err_panic</span><span class="p">,</span> <span class="s">&quot;errors=panic&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">Opt_err_ro</span><span class="p">,</span> <span class="s">&quot;errors=remount-ro&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">Opt_nouid32</span><span class="p">,</span> <span class="s">&quot;nouid32&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">Opt_nocheck</span><span class="p">,</span> <span class="s">&quot;nocheck&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">Opt_nocheck</span><span class="p">,</span> <span class="s">&quot;check=none&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">Opt_debug</span><span class="p">,</span> <span class="s">&quot;debug&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">Opt_oldalloc</span><span class="p">,</span> <span class="s">&quot;oldalloc&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">Opt_orlov</span><span class="p">,</span> <span class="s">&quot;orlov&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">Opt_user_xattr</span><span class="p">,</span> <span class="s">&quot;user_xattr&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">Opt_nouser_xattr</span><span class="p">,</span> <span class="s">&quot;nouser_xattr&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">Opt_acl</span><span class="p">,</span> <span class="s">&quot;acl&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">Opt_noacl</span><span class="p">,</span> <span class="s">&quot;noacl&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">Opt_reservation</span><span class="p">,</span> <span class="s">&quot;reservation&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">Opt_noreservation</span><span class="p">,</span> <span class="s">&quot;noreservation&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">Opt_noload</span><span class="p">,</span> <span class="s">&quot;noload&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">Opt_noload</span><span class="p">,</span> <span class="s">&quot;norecovery&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">Opt_nobh</span><span class="p">,</span> <span class="s">&quot;nobh&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">Opt_bh</span><span class="p">,</span> <span class="s">&quot;bh&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">Opt_commit</span><span class="p">,</span> <span class="s">&quot;commit=%u&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">Opt_journal_update</span><span class="p">,</span> <span class="s">&quot;journal=update&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">Opt_journal_inum</span><span class="p">,</span> <span class="s">&quot;journal=%u&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">Opt_journal_dev</span><span class="p">,</span> <span class="s">&quot;journal_dev=%u&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">Opt_abort</span><span class="p">,</span> <span class="s">&quot;abort&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">Opt_data_journal</span><span class="p">,</span> <span class="s">&quot;data=journal&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">Opt_data_ordered</span><span class="p">,</span> <span class="s">&quot;data=ordered&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">Opt_data_writeback</span><span class="p">,</span> <span class="s">&quot;data=writeback&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">Opt_data_err_abort</span><span class="p">,</span> <span class="s">&quot;data_err=abort&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">Opt_data_err_ignore</span><span class="p">,</span> <span class="s">&quot;data_err=ignore&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">Opt_offusrjquota</span><span class="p">,</span> <span class="s">&quot;usrjquota=&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">Opt_usrjquota</span><span class="p">,</span> <span class="s">&quot;usrjquota=%s&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">Opt_offgrpjquota</span><span class="p">,</span> <span class="s">&quot;grpjquota=&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">Opt_grpjquota</span><span class="p">,</span> <span class="s">&quot;grpjquota=%s&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">Opt_jqfmt_vfsold</span><span class="p">,</span> <span class="s">&quot;jqfmt=vfsold&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">Opt_jqfmt_vfsv0</span><span class="p">,</span> <span class="s">&quot;jqfmt=vfsv0&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">Opt_jqfmt_vfsv1</span><span class="p">,</span> <span class="s">&quot;jqfmt=vfsv1&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">Opt_grpquota</span><span class="p">,</span> <span class="s">&quot;grpquota&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">Opt_noquota</span><span class="p">,</span> <span class="s">&quot;noquota&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">Opt_quota</span><span class="p">,</span> <span class="s">&quot;quota&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">Opt_usrquota</span><span class="p">,</span> <span class="s">&quot;usrquota&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">Opt_barrier</span><span class="p">,</span> <span class="s">&quot;barrier=%u&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">Opt_barrier</span><span class="p">,</span> <span class="s">&quot;barrier&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">Opt_nobarrier</span><span class="p">,</span> <span class="s">&quot;nobarrier&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">Opt_resize</span><span class="p">,</span> <span class="s">&quot;resize&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">Opt_err</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="n">ext3_fsblk_t</span> <span class="nf">get_sb_block</span><span class="p">(</span><span class="kt">void</span> <span class="o">**</span><span class="n">data</span><span class="p">,</span> <span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">sb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ext3_fsblk_t</span>	<span class="n">sb_block</span><span class="p">;</span>
	<span class="kt">char</span>		<span class="o">*</span><span class="n">options</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="o">*</span><span class="n">data</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">options</span> <span class="o">||</span> <span class="n">strncmp</span><span class="p">(</span><span class="n">options</span><span class="p">,</span> <span class="s">&quot;sb=&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>	<span class="cm">/* Default location */</span>
	<span class="n">options</span> <span class="o">+=</span> <span class="mi">3</span><span class="p">;</span>
	<span class="cm">/*todo: use simple_strtoll with &gt;32bit ext3 */</span>
	<span class="n">sb_block</span> <span class="o">=</span> <span class="n">simple_strtoul</span><span class="p">(</span><span class="n">options</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">options</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">options</span> <span class="o">&amp;&amp;</span> <span class="o">*</span><span class="n">options</span> <span class="o">!=</span> <span class="sc">&#39;,&#39;</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ext3_msg</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="s">&quot;error: invalid sb specification: %s&quot;</span><span class="p">,</span>
		       <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="o">*</span><span class="n">data</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">options</span> <span class="o">==</span> <span class="sc">&#39;,&#39;</span><span class="p">)</span>
		<span class="n">options</span><span class="o">++</span><span class="p">;</span>
	<span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">options</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">sb_block</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_QUOTA</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">set_qf_name</span><span class="p">(</span><span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">sb</span><span class="p">,</span> <span class="kt">int</span> <span class="n">qtype</span><span class="p">,</span> <span class="n">substring_t</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ext3_sb_info</span> <span class="o">*</span><span class="n">sbi</span> <span class="o">=</span> <span class="n">EXT3_SB</span><span class="p">(</span><span class="n">sb</span><span class="p">);</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">qname</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sb_any_quota_loaded</span><span class="p">(</span><span class="n">sb</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		<span class="o">!</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_qf_names</span><span class="p">[</span><span class="n">qtype</span><span class="p">])</span> <span class="p">{</span>
		<span class="n">ext3_msg</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">KERN_ERR</span><span class="p">,</span>
			<span class="s">&quot;Cannot change journaled &quot;</span>
			<span class="s">&quot;quota options when quota turned on&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">qname</span> <span class="o">=</span> <span class="n">match_strdup</span><span class="p">(</span><span class="n">args</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">qname</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ext3_msg</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">KERN_ERR</span><span class="p">,</span>
			<span class="s">&quot;Not enough memory for storing quotafile name&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_qf_names</span><span class="p">[</span><span class="n">qtype</span><span class="p">]</span> <span class="o">&amp;&amp;</span>
		<span class="n">strcmp</span><span class="p">(</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_qf_names</span><span class="p">[</span><span class="n">qtype</span><span class="p">],</span> <span class="n">qname</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ext3_msg</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">KERN_ERR</span><span class="p">,</span>
			<span class="s">&quot;%s quota file already specified&quot;</span><span class="p">,</span> <span class="n">QTYPE2NAME</span><span class="p">(</span><span class="n">qtype</span><span class="p">));</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">qname</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_qf_names</span><span class="p">[</span><span class="n">qtype</span><span class="p">]</span> <span class="o">=</span> <span class="n">qname</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">strchr</span><span class="p">(</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_qf_names</span><span class="p">[</span><span class="n">qtype</span><span class="p">],</span> <span class="sc">&#39;/&#39;</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ext3_msg</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">KERN_ERR</span><span class="p">,</span>
			<span class="s">&quot;quotafile must be on filesystem root&quot;</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_qf_names</span><span class="p">[</span><span class="n">qtype</span><span class="p">]);</span>
		<span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_qf_names</span><span class="p">[</span><span class="n">qtype</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">set_opt</span><span class="p">(</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_mount_opt</span><span class="p">,</span> <span class="n">QUOTA</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">clear_qf_name</span><span class="p">(</span><span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">sb</span><span class="p">,</span> <span class="kt">int</span> <span class="n">qtype</span><span class="p">)</span> <span class="p">{</span>

	<span class="k">struct</span> <span class="n">ext3_sb_info</span> <span class="o">*</span><span class="n">sbi</span> <span class="o">=</span> <span class="n">EXT3_SB</span><span class="p">(</span><span class="n">sb</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sb_any_quota_loaded</span><span class="p">(</span><span class="n">sb</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		<span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_qf_names</span><span class="p">[</span><span class="n">qtype</span><span class="p">])</span> <span class="p">{</span>
		<span class="n">ext3_msg</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">KERN_ERR</span><span class="p">,</span> <span class="s">&quot;Cannot change journaled quota options&quot;</span>
			<span class="s">&quot; when quota turned on&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/*</span>
<span class="cm">	 * The space will be released later when all options are confirmed</span>
<span class="cm">	 * to be correct</span>
<span class="cm">	 */</span>
	<span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_qf_names</span><span class="p">[</span><span class="n">qtype</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">parse_options</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">options</span><span class="p">,</span> <span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">sb</span><span class="p">,</span>
			  <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">inum</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">journal_devnum</span><span class="p">,</span>
			  <span class="n">ext3_fsblk_t</span> <span class="o">*</span><span class="n">n_blocks_count</span><span class="p">,</span> <span class="kt">int</span> <span class="n">is_remount</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ext3_sb_info</span> <span class="o">*</span><span class="n">sbi</span> <span class="o">=</span> <span class="n">EXT3_SB</span><span class="p">(</span><span class="n">sb</span><span class="p">);</span>
	<span class="kt">char</span> <span class="o">*</span> <span class="n">p</span><span class="p">;</span>
	<span class="n">substring_t</span> <span class="n">args</span><span class="p">[</span><span class="n">MAX_OPT_ARGS</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">data_opt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">option</span><span class="p">;</span>
	<span class="n">kuid_t</span> <span class="n">uid</span><span class="p">;</span>
	<span class="n">kgid_t</span> <span class="n">gid</span><span class="p">;</span>
<span class="cp">#ifdef CONFIG_QUOTA</span>
	<span class="kt">int</span> <span class="n">qfmt</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">options</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">((</span><span class="n">p</span> <span class="o">=</span> <span class="n">strsep</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">options</span><span class="p">,</span> <span class="s">&quot;,&quot;</span><span class="p">))</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">token</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!*</span><span class="n">p</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="cm">/*</span>
<span class="cm">		 * Initialize args struct so we know whether arg was</span>
<span class="cm">		 * found; some options take optional arguments.</span>
<span class="cm">		 */</span>
		<span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">to</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">from</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">token</span> <span class="o">=</span> <span class="n">match_token</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">tokens</span><span class="p">,</span> <span class="n">args</span><span class="p">);</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">token</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">Opt_bsd_df</span>:
			<span class="n">clear_opt</span> <span class="p">(</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_mount_opt</span><span class="p">,</span> <span class="n">MINIX_DF</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">Opt_minix_df</span>:
			<span class="n">set_opt</span> <span class="p">(</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_mount_opt</span><span class="p">,</span> <span class="n">MINIX_DF</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">Opt_grpid</span>:
			<span class="n">set_opt</span> <span class="p">(</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_mount_opt</span><span class="p">,</span> <span class="n">GRPID</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">Opt_nogrpid</span>:
			<span class="n">clear_opt</span> <span class="p">(</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_mount_opt</span><span class="p">,</span> <span class="n">GRPID</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">Opt_resuid</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">match_int</span><span class="p">(</span><span class="o">&amp;</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">option</span><span class="p">))</span>
				<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">uid</span> <span class="o">=</span> <span class="n">make_kuid</span><span class="p">(</span><span class="n">current_user_ns</span><span class="p">(),</span> <span class="n">option</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">uid_valid</span><span class="p">(</span><span class="n">uid</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">ext3_msg</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">KERN_ERR</span><span class="p">,</span> <span class="s">&quot;Invalid uid value %d&quot;</span><span class="p">,</span> <span class="n">option</span><span class="p">);</span>
				<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

			<span class="p">}</span>
			<span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_resuid</span> <span class="o">=</span> <span class="n">uid</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">Opt_resgid</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">match_int</span><span class="p">(</span><span class="o">&amp;</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">option</span><span class="p">))</span>
				<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">gid</span> <span class="o">=</span> <span class="n">make_kgid</span><span class="p">(</span><span class="n">current_user_ns</span><span class="p">(),</span> <span class="n">option</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">gid_valid</span><span class="p">(</span><span class="n">gid</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">ext3_msg</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">KERN_ERR</span><span class="p">,</span> <span class="s">&quot;Invalid gid value %d&quot;</span><span class="p">,</span> <span class="n">option</span><span class="p">);</span>
				<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_resgid</span> <span class="o">=</span> <span class="n">gid</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">Opt_sb</span>:
			<span class="cm">/* handled by get_sb_block() instead of here */</span>
			<span class="cm">/* *sb_block = match_int(&amp;args[0]); */</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">Opt_err_panic</span>:
			<span class="n">clear_opt</span> <span class="p">(</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_mount_opt</span><span class="p">,</span> <span class="n">ERRORS_CONT</span><span class="p">);</span>
			<span class="n">clear_opt</span> <span class="p">(</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_mount_opt</span><span class="p">,</span> <span class="n">ERRORS_RO</span><span class="p">);</span>
			<span class="n">set_opt</span> <span class="p">(</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_mount_opt</span><span class="p">,</span> <span class="n">ERRORS_PANIC</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">Opt_err_ro</span>:
			<span class="n">clear_opt</span> <span class="p">(</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_mount_opt</span><span class="p">,</span> <span class="n">ERRORS_CONT</span><span class="p">);</span>
			<span class="n">clear_opt</span> <span class="p">(</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_mount_opt</span><span class="p">,</span> <span class="n">ERRORS_PANIC</span><span class="p">);</span>
			<span class="n">set_opt</span> <span class="p">(</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_mount_opt</span><span class="p">,</span> <span class="n">ERRORS_RO</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">Opt_err_cont</span>:
			<span class="n">clear_opt</span> <span class="p">(</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_mount_opt</span><span class="p">,</span> <span class="n">ERRORS_RO</span><span class="p">);</span>
			<span class="n">clear_opt</span> <span class="p">(</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_mount_opt</span><span class="p">,</span> <span class="n">ERRORS_PANIC</span><span class="p">);</span>
			<span class="n">set_opt</span> <span class="p">(</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_mount_opt</span><span class="p">,</span> <span class="n">ERRORS_CONT</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">Opt_nouid32</span>:
			<span class="n">set_opt</span> <span class="p">(</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_mount_opt</span><span class="p">,</span> <span class="n">NO_UID32</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">Opt_nocheck</span>:
			<span class="n">clear_opt</span> <span class="p">(</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_mount_opt</span><span class="p">,</span> <span class="n">CHECK</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">Opt_debug</span>:
			<span class="n">set_opt</span> <span class="p">(</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_mount_opt</span><span class="p">,</span> <span class="n">DEBUG</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">Opt_oldalloc</span>:
			<span class="n">ext3_msg</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">KERN_WARNING</span><span class="p">,</span>
				<span class="s">&quot;Ignoring deprecated oldalloc option&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">Opt_orlov</span>:
			<span class="n">ext3_msg</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">KERN_WARNING</span><span class="p">,</span>
				<span class="s">&quot;Ignoring deprecated orlov option&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
<span class="cp">#ifdef CONFIG_EXT3_FS_XATTR</span>
		<span class="k">case</span> <span class="n">Opt_user_xattr</span>:
			<span class="n">set_opt</span> <span class="p">(</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_mount_opt</span><span class="p">,</span> <span class="n">XATTR_USER</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">Opt_nouser_xattr</span>:
			<span class="n">clear_opt</span> <span class="p">(</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_mount_opt</span><span class="p">,</span> <span class="n">XATTR_USER</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
<span class="cp">#else</span>
		<span class="k">case</span> <span class="n">Opt_user_xattr</span>:
		<span class="k">case</span> <span class="n">Opt_nouser_xattr</span>:
			<span class="n">ext3_msg</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">KERN_INFO</span><span class="p">,</span>
				<span class="s">&quot;(no)user_xattr options not supported&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef CONFIG_EXT3_FS_POSIX_ACL</span>
		<span class="k">case</span> <span class="n">Opt_acl</span>:
			<span class="n">set_opt</span><span class="p">(</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_mount_opt</span><span class="p">,</span> <span class="n">POSIX_ACL</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">Opt_noacl</span>:
			<span class="n">clear_opt</span><span class="p">(</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_mount_opt</span><span class="p">,</span> <span class="n">POSIX_ACL</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
<span class="cp">#else</span>
		<span class="k">case</span> <span class="n">Opt_acl</span>:
		<span class="k">case</span> <span class="n">Opt_noacl</span>:
			<span class="n">ext3_msg</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">KERN_INFO</span><span class="p">,</span>
				<span class="s">&quot;(no)acl options not supported&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
<span class="cp">#endif</span>
		<span class="k">case</span> <span class="n">Opt_reservation</span>:
			<span class="n">set_opt</span><span class="p">(</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_mount_opt</span><span class="p">,</span> <span class="n">RESERVATION</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">Opt_noreservation</span>:
			<span class="n">clear_opt</span><span class="p">(</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_mount_opt</span><span class="p">,</span> <span class="n">RESERVATION</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">Opt_journal_update</span>:
			<span class="cm">/* @@@ FIXME */</span>
			<span class="cm">/* Eventually we will want to be able to create</span>
<span class="cm">			   a journal file here.  For now, only allow the</span>
<span class="cm">			   user to specify an existing inode to be the</span>
<span class="cm">			   journal file. */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">is_remount</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ext3_msg</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">KERN_ERR</span><span class="p">,</span> <span class="s">&quot;error: cannot specify &quot;</span>
					<span class="s">&quot;journal on remount&quot;</span><span class="p">);</span>
				<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">set_opt</span> <span class="p">(</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_mount_opt</span><span class="p">,</span> <span class="n">UPDATE_JOURNAL</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">Opt_journal_inum</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">is_remount</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ext3_msg</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">KERN_ERR</span><span class="p">,</span> <span class="s">&quot;error: cannot specify &quot;</span>
				       <span class="s">&quot;journal on remount&quot;</span><span class="p">);</span>
				<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">match_int</span><span class="p">(</span><span class="o">&amp;</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">option</span><span class="p">))</span>
				<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
			<span class="o">*</span><span class="n">inum</span> <span class="o">=</span> <span class="n">option</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">Opt_journal_dev</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">is_remount</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ext3_msg</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">KERN_ERR</span><span class="p">,</span> <span class="s">&quot;error: cannot specify &quot;</span>
				       <span class="s">&quot;journal on remount&quot;</span><span class="p">);</span>
				<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">match_int</span><span class="p">(</span><span class="o">&amp;</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">option</span><span class="p">))</span>
				<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
			<span class="o">*</span><span class="n">journal_devnum</span> <span class="o">=</span> <span class="n">option</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">Opt_noload</span>:
			<span class="n">set_opt</span> <span class="p">(</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_mount_opt</span><span class="p">,</span> <span class="n">NOLOAD</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">Opt_commit</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">match_int</span><span class="p">(</span><span class="o">&amp;</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">option</span><span class="p">))</span>
				<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">option</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">option</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">option</span> <span class="o">=</span> <span class="n">JBD_DEFAULT_MAX_COMMIT_AGE</span><span class="p">;</span>
			<span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_commit_interval</span> <span class="o">=</span> <span class="n">HZ</span> <span class="o">*</span> <span class="n">option</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">Opt_data_journal</span>:
			<span class="n">data_opt</span> <span class="o">=</span> <span class="n">EXT3_MOUNT_JOURNAL_DATA</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">datacheck</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">Opt_data_ordered</span>:
			<span class="n">data_opt</span> <span class="o">=</span> <span class="n">EXT3_MOUNT_ORDERED_DATA</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">datacheck</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">Opt_data_writeback</span>:
			<span class="n">data_opt</span> <span class="o">=</span> <span class="n">EXT3_MOUNT_WRITEBACK_DATA</span><span class="p">;</span>
		<span class="nl">datacheck:</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">is_remount</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">test_opt</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">DATA_FLAGS</span><span class="p">)</span> <span class="o">==</span> <span class="n">data_opt</span><span class="p">)</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="n">ext3_msg</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">KERN_ERR</span><span class="p">,</span>
					<span class="s">&quot;error: cannot change &quot;</span>
					<span class="s">&quot;data mode on remount. The filesystem &quot;</span>
					<span class="s">&quot;is mounted in data=%s mode and you &quot;</span>
					<span class="s">&quot;try to remount it in data=%s mode.&quot;</span><span class="p">,</span>
					<span class="n">data_mode_string</span><span class="p">(</span><span class="n">test_opt</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span>
							<span class="n">DATA_FLAGS</span><span class="p">)),</span>
					<span class="n">data_mode_string</span><span class="p">(</span><span class="n">data_opt</span><span class="p">));</span>
				<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">clear_opt</span><span class="p">(</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_mount_opt</span><span class="p">,</span> <span class="n">DATA_FLAGS</span><span class="p">);</span>
				<span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_mount_opt</span> <span class="o">|=</span> <span class="n">data_opt</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">Opt_data_err_abort</span>:
			<span class="n">set_opt</span><span class="p">(</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_mount_opt</span><span class="p">,</span> <span class="n">DATA_ERR_ABORT</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">Opt_data_err_ignore</span>:
			<span class="n">clear_opt</span><span class="p">(</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_mount_opt</span><span class="p">,</span> <span class="n">DATA_ERR_ABORT</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
<span class="cp">#ifdef CONFIG_QUOTA</span>
		<span class="k">case</span> <span class="n">Opt_usrjquota</span>:
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">set_qf_name</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">USRQUOTA</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
				<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">Opt_grpjquota</span>:
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">set_qf_name</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">GRPQUOTA</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
				<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">Opt_offusrjquota</span>:
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">clear_qf_name</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">USRQUOTA</span><span class="p">))</span>
				<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">Opt_offgrpjquota</span>:
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">clear_qf_name</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">GRPQUOTA</span><span class="p">))</span>
				<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">Opt_jqfmt_vfsold</span>:
			<span class="n">qfmt</span> <span class="o">=</span> <span class="n">QFMT_VFS_OLD</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">set_qf_format</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">Opt_jqfmt_vfsv0</span>:
			<span class="n">qfmt</span> <span class="o">=</span> <span class="n">QFMT_VFS_V0</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">set_qf_format</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">Opt_jqfmt_vfsv1</span>:
			<span class="n">qfmt</span> <span class="o">=</span> <span class="n">QFMT_VFS_V1</span><span class="p">;</span>
<span class="nl">set_qf_format:</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">sb_any_quota_loaded</span><span class="p">(</span><span class="n">sb</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			    <span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_jquota_fmt</span> <span class="o">!=</span> <span class="n">qfmt</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ext3_msg</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">KERN_ERR</span><span class="p">,</span> <span class="s">&quot;error: cannot change &quot;</span>
					<span class="s">&quot;journaled quota options when &quot;</span>
					<span class="s">&quot;quota turned on.&quot;</span><span class="p">);</span>
				<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_jquota_fmt</span> <span class="o">=</span> <span class="n">qfmt</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">Opt_quota</span>:
		<span class="k">case</span> <span class="n">Opt_usrquota</span>:
			<span class="n">set_opt</span><span class="p">(</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_mount_opt</span><span class="p">,</span> <span class="n">QUOTA</span><span class="p">);</span>
			<span class="n">set_opt</span><span class="p">(</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_mount_opt</span><span class="p">,</span> <span class="n">USRQUOTA</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">Opt_grpquota</span>:
			<span class="n">set_opt</span><span class="p">(</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_mount_opt</span><span class="p">,</span> <span class="n">QUOTA</span><span class="p">);</span>
			<span class="n">set_opt</span><span class="p">(</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_mount_opt</span><span class="p">,</span> <span class="n">GRPQUOTA</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">Opt_noquota</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">sb_any_quota_loaded</span><span class="p">(</span><span class="n">sb</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">ext3_msg</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">KERN_ERR</span><span class="p">,</span> <span class="s">&quot;error: cannot change &quot;</span>
					<span class="s">&quot;quota options when quota turned on.&quot;</span><span class="p">);</span>
				<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">clear_opt</span><span class="p">(</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_mount_opt</span><span class="p">,</span> <span class="n">QUOTA</span><span class="p">);</span>
			<span class="n">clear_opt</span><span class="p">(</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_mount_opt</span><span class="p">,</span> <span class="n">USRQUOTA</span><span class="p">);</span>
			<span class="n">clear_opt</span><span class="p">(</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_mount_opt</span><span class="p">,</span> <span class="n">GRPQUOTA</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
<span class="cp">#else</span>
		<span class="k">case</span> <span class="n">Opt_quota</span>:
		<span class="k">case</span> <span class="n">Opt_usrquota</span>:
		<span class="k">case</span> <span class="n">Opt_grpquota</span>:
			<span class="n">ext3_msg</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">KERN_ERR</span><span class="p">,</span>
				<span class="s">&quot;error: quota options not supported.&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">Opt_usrjquota</span>:
		<span class="k">case</span> <span class="n">Opt_grpjquota</span>:
		<span class="k">case</span> <span class="n">Opt_offusrjquota</span>:
		<span class="k">case</span> <span class="n">Opt_offgrpjquota</span>:
		<span class="k">case</span> <span class="n">Opt_jqfmt_vfsold</span>:
		<span class="k">case</span> <span class="n">Opt_jqfmt_vfsv0</span>:
		<span class="k">case</span> <span class="n">Opt_jqfmt_vfsv1</span>:
			<span class="n">ext3_msg</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">KERN_ERR</span><span class="p">,</span>
				<span class="s">&quot;error: journaled quota options not &quot;</span>
				<span class="s">&quot;supported.&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">Opt_noquota</span>:
			<span class="k">break</span><span class="p">;</span>
<span class="cp">#endif</span>
		<span class="k">case</span> <span class="n">Opt_abort</span>:
			<span class="n">set_opt</span><span class="p">(</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_mount_opt</span><span class="p">,</span> <span class="n">ABORT</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">Opt_nobarrier</span>:
			<span class="n">clear_opt</span><span class="p">(</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_mount_opt</span><span class="p">,</span> <span class="n">BARRIER</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">Opt_barrier</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">from</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">match_int</span><span class="p">(</span><span class="o">&amp;</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">option</span><span class="p">))</span>
					<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span>
				<span class="n">option</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>	<span class="cm">/* No argument, default to 1 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">option</span><span class="p">)</span>
				<span class="n">set_opt</span><span class="p">(</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_mount_opt</span><span class="p">,</span> <span class="n">BARRIER</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">clear_opt</span><span class="p">(</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_mount_opt</span><span class="p">,</span> <span class="n">BARRIER</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">Opt_ignore</span>:
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">Opt_resize</span>:
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_remount</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ext3_msg</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">KERN_ERR</span><span class="p">,</span>
					<span class="s">&quot;error: resize option only available &quot;</span>
					<span class="s">&quot;for remount&quot;</span><span class="p">);</span>
				<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">match_int</span><span class="p">(</span><span class="o">&amp;</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">option</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
			<span class="o">*</span><span class="n">n_blocks_count</span> <span class="o">=</span> <span class="n">option</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">Opt_nobh</span>:
			<span class="n">ext3_msg</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">KERN_WARNING</span><span class="p">,</span>
				<span class="s">&quot;warning: ignoring deprecated nobh option&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">Opt_bh</span>:
			<span class="n">ext3_msg</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">KERN_WARNING</span><span class="p">,</span>
				<span class="s">&quot;warning: ignoring deprecated bh option&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">ext3_msg</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">KERN_ERR</span><span class="p">,</span>
				<span class="s">&quot;error: unrecognized mount option </span><span class="se">\&quot;</span><span class="s">%s</span><span class="se">\&quot;</span><span class="s"> &quot;</span>
				<span class="s">&quot;or missing value&quot;</span><span class="p">,</span> <span class="n">p</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="cp">#ifdef CONFIG_QUOTA</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_qf_names</span><span class="p">[</span><span class="n">USRQUOTA</span><span class="p">]</span> <span class="o">||</span> <span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_qf_names</span><span class="p">[</span><span class="n">GRPQUOTA</span><span class="p">])</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">test_opt</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">USRQUOTA</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_qf_names</span><span class="p">[</span><span class="n">USRQUOTA</span><span class="p">])</span>
			<span class="n">clear_opt</span><span class="p">(</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_mount_opt</span><span class="p">,</span> <span class="n">USRQUOTA</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">test_opt</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">GRPQUOTA</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_qf_names</span><span class="p">[</span><span class="n">GRPQUOTA</span><span class="p">])</span>
			<span class="n">clear_opt</span><span class="p">(</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_mount_opt</span><span class="p">,</span> <span class="n">GRPQUOTA</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">test_opt</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">GRPQUOTA</span><span class="p">)</span> <span class="o">||</span> <span class="n">test_opt</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">USRQUOTA</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">ext3_msg</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">KERN_ERR</span><span class="p">,</span> <span class="s">&quot;error: old and new quota &quot;</span>
					<span class="s">&quot;format mixing.&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_jquota_fmt</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ext3_msg</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">KERN_ERR</span><span class="p">,</span> <span class="s">&quot;error: journaled quota format &quot;</span>
					<span class="s">&quot;not specified.&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_jquota_fmt</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ext3_msg</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">KERN_ERR</span><span class="p">,</span> <span class="s">&quot;error: journaled quota format &quot;</span>
					<span class="s">&quot;specified with no journaling &quot;</span>
					<span class="s">&quot;enabled.&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ext3_setup_super</span><span class="p">(</span><span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">sb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ext3_super_block</span> <span class="o">*</span><span class="n">es</span><span class="p">,</span>
			    <span class="kt">int</span> <span class="n">read_only</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ext3_sb_info</span> <span class="o">*</span><span class="n">sbi</span> <span class="o">=</span> <span class="n">EXT3_SB</span><span class="p">(</span><span class="n">sb</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">res</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">es</span><span class="o">-&gt;</span><span class="n">s_rev_level</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">EXT3_MAX_SUPP_REV</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ext3_msg</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">KERN_ERR</span><span class="p">,</span>
			<span class="s">&quot;error: revision level too high, &quot;</span>
			<span class="s">&quot;forcing read-only mode&quot;</span><span class="p">);</span>
		<span class="n">res</span> <span class="o">=</span> <span class="n">MS_RDONLY</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">read_only</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_mount_state</span> <span class="o">&amp;</span> <span class="n">EXT3_VALID_FS</span><span class="p">))</span>
		<span class="n">ext3_msg</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">KERN_WARNING</span><span class="p">,</span>
			<span class="s">&quot;warning: mounting unchecked fs, &quot;</span>
			<span class="s">&quot;running e2fsck is recommended&quot;</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_mount_state</span> <span class="o">&amp;</span> <span class="n">EXT3_ERROR_FS</span><span class="p">))</span>
		<span class="n">ext3_msg</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">KERN_WARNING</span><span class="p">,</span>
			<span class="s">&quot;warning: mounting fs with errors, &quot;</span>
			<span class="s">&quot;running e2fsck is recommended&quot;</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">__s16</span><span class="p">)</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">es</span><span class="o">-&gt;</span><span class="n">s_max_mnt_count</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
		 <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">es</span><span class="o">-&gt;</span><span class="n">s_mnt_count</span><span class="p">)</span> <span class="o">&gt;=</span>
			<span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">es</span><span class="o">-&gt;</span><span class="n">s_max_mnt_count</span><span class="p">))</span>
		<span class="n">ext3_msg</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">KERN_WARNING</span><span class="p">,</span>
			<span class="s">&quot;warning: maximal mount count reached, &quot;</span>
			<span class="s">&quot;running e2fsck is recommended&quot;</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">es</span><span class="o">-&gt;</span><span class="n">s_checkinterval</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		<span class="p">(</span><span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">es</span><span class="o">-&gt;</span><span class="n">s_lastcheck</span><span class="p">)</span> <span class="o">+</span>
			<span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">es</span><span class="o">-&gt;</span><span class="n">s_checkinterval</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">get_seconds</span><span class="p">()))</span>
		<span class="n">ext3_msg</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">KERN_WARNING</span><span class="p">,</span>
			<span class="s">&quot;warning: checktime reached, &quot;</span>
			<span class="s">&quot;running e2fsck is recommended&quot;</span><span class="p">);</span>
<span class="cp">#if 0</span><span class="c"></span>
<span class="c">		/* @@@ We _will_ want to clear the valid bit if we find</span>
<span class="c">                   inconsistencies, to force a fsck at reboot.  But for</span>
<span class="c">                   a plain journaled filesystem we can keep it set as</span>
<span class="c">                   valid forever! :) */</span>
<span class="c">	es-&gt;s_state &amp;= cpu_to_le16(~EXT3_VALID_FS);</span>
<span class="cp">#endif</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">es</span><span class="o">-&gt;</span><span class="n">s_max_mnt_count</span><span class="p">))</span>
		<span class="n">es</span><span class="o">-&gt;</span><span class="n">s_max_mnt_count</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">EXT3_DFL_MAX_MNT_COUNT</span><span class="p">);</span>
	<span class="n">le16_add_cpu</span><span class="p">(</span><span class="o">&amp;</span><span class="n">es</span><span class="o">-&gt;</span><span class="n">s_mnt_count</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">es</span><span class="o">-&gt;</span><span class="n">s_mtime</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">get_seconds</span><span class="p">());</span>
	<span class="n">ext3_update_dynamic_rev</span><span class="p">(</span><span class="n">sb</span><span class="p">);</span>
	<span class="n">EXT3_SET_INCOMPAT_FEATURE</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">EXT3_FEATURE_INCOMPAT_RECOVER</span><span class="p">);</span>

	<span class="n">ext3_commit_super</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">es</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_opt</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">DEBUG</span><span class="p">))</span>
		<span class="n">ext3_msg</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">KERN_INFO</span><span class="p">,</span> <span class="s">&quot;[bs=%lu, gc=%lu, &quot;</span>
				<span class="s">&quot;bpg=%lu, ipg=%lu, mo=%04lx]&quot;</span><span class="p">,</span>
			<span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_blocksize</span><span class="p">,</span>
			<span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_groups_count</span><span class="p">,</span>
			<span class="n">EXT3_BLOCKS_PER_GROUP</span><span class="p">(</span><span class="n">sb</span><span class="p">),</span>
			<span class="n">EXT3_INODES_PER_GROUP</span><span class="p">(</span><span class="n">sb</span><span class="p">),</span>
			<span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_mount_opt</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">EXT3_SB</span><span class="p">(</span><span class="n">sb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">s_journal</span><span class="o">-&gt;</span><span class="n">j_inode</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">char</span> <span class="n">b</span><span class="p">[</span><span class="n">BDEVNAME_SIZE</span><span class="p">];</span>
		<span class="n">ext3_msg</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">KERN_INFO</span><span class="p">,</span> <span class="s">&quot;using external journal on %s&quot;</span><span class="p">,</span>
			<span class="n">bdevname</span><span class="p">(</span><span class="n">EXT3_SB</span><span class="p">(</span><span class="n">sb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">s_journal</span><span class="o">-&gt;</span><span class="n">j_dev</span><span class="p">,</span> <span class="n">b</span><span class="p">));</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ext3_msg</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">KERN_INFO</span><span class="p">,</span> <span class="s">&quot;using internal journal&quot;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">cleancache_init_fs</span><span class="p">(</span><span class="n">sb</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Called at mount-time, super-block is locked */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ext3_check_descriptors</span><span class="p">(</span><span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">sb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ext3_sb_info</span> <span class="o">*</span><span class="n">sbi</span> <span class="o">=</span> <span class="n">EXT3_SB</span><span class="p">(</span><span class="n">sb</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">ext3_debug</span> <span class="p">(</span><span class="s">&quot;Checking group descriptors&quot;</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_groups_count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">ext3_group_desc</span> <span class="o">*</span><span class="n">gdp</span> <span class="o">=</span> <span class="n">ext3_get_group_desc</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="n">ext3_fsblk_t</span> <span class="n">first_block</span> <span class="o">=</span> <span class="n">ext3_group_first_block_no</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
		<span class="n">ext3_fsblk_t</span> <span class="n">last_block</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_groups_count</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
			<span class="n">last_block</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_es</span><span class="o">-&gt;</span><span class="n">s_blocks_count</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">last_block</span> <span class="o">=</span> <span class="n">first_block</span> <span class="o">+</span>
				<span class="p">(</span><span class="n">EXT3_BLOCKS_PER_GROUP</span><span class="p">(</span><span class="n">sb</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">gdp</span><span class="o">-&gt;</span><span class="n">bg_block_bitmap</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">first_block</span> <span class="o">||</span>
		    <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">gdp</span><span class="o">-&gt;</span><span class="n">bg_block_bitmap</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">last_block</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="n">ext3_error</span> <span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="s">&quot;ext3_check_descriptors&quot;</span><span class="p">,</span>
				    <span class="s">&quot;Block bitmap for group %d&quot;</span>
				    <span class="s">&quot; not in group (block %lu)!&quot;</span><span class="p">,</span>
				    <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span>
					<span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">gdp</span><span class="o">-&gt;</span><span class="n">bg_block_bitmap</span><span class="p">));</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">gdp</span><span class="o">-&gt;</span><span class="n">bg_inode_bitmap</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">first_block</span> <span class="o">||</span>
		    <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">gdp</span><span class="o">-&gt;</span><span class="n">bg_inode_bitmap</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">last_block</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="n">ext3_error</span> <span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="s">&quot;ext3_check_descriptors&quot;</span><span class="p">,</span>
				    <span class="s">&quot;Inode bitmap for group %d&quot;</span>
				    <span class="s">&quot; not in group (block %lu)!&quot;</span><span class="p">,</span>
				    <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span>
					<span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">gdp</span><span class="o">-&gt;</span><span class="n">bg_inode_bitmap</span><span class="p">));</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">gdp</span><span class="o">-&gt;</span><span class="n">bg_inode_table</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">first_block</span> <span class="o">||</span>
		    <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">gdp</span><span class="o">-&gt;</span><span class="n">bg_inode_table</span><span class="p">)</span> <span class="o">+</span> <span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_itb_per_group</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">&gt;</span>
		    <span class="n">last_block</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="n">ext3_error</span> <span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="s">&quot;ext3_check_descriptors&quot;</span><span class="p">,</span>
				    <span class="s">&quot;Inode table for group %d&quot;</span>
				    <span class="s">&quot; not in group (block %lu)!&quot;</span><span class="p">,</span>
				    <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span>
					<span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">gdp</span><span class="o">-&gt;</span><span class="n">bg_inode_table</span><span class="p">));</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_es</span><span class="o">-&gt;</span><span class="n">s_free_blocks_count</span><span class="o">=</span><span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">ext3_count_free_blocks</span><span class="p">(</span><span class="n">sb</span><span class="p">));</span>
	<span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_es</span><span class="o">-&gt;</span><span class="n">s_free_inodes_count</span><span class="o">=</span><span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">ext3_count_free_inodes</span><span class="p">(</span><span class="n">sb</span><span class="p">));</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/* ext3_orphan_cleanup() walks a singly-linked list of inodes (starting at</span>
<span class="cm"> * the superblock) which were deleted from all directories, but held open by</span>
<span class="cm"> * a process at the time of a crash.  We walk the list and try to delete these</span>
<span class="cm"> * inodes at recovery time (only with a read-write filesystem).</span>
<span class="cm"> *</span>
<span class="cm"> * In order to keep the orphan inode chain consistent during traversal (in</span>
<span class="cm"> * case of crash during recovery), we link each inode into the superblock</span>
<span class="cm"> * orphan list_head and handle it the same way as an inode deletion during</span>
<span class="cm"> * normal operation (which journals the operations for us).</span>
<span class="cm"> *</span>
<span class="cm"> * We only do an iget() and an iput() on each inode, which is very safe if we</span>
<span class="cm"> * accidentally point at an in-use or already deleted inode.  The worst that</span>
<span class="cm"> * can happen in this case is that we get a &quot;bit already cleared&quot; message from</span>
<span class="cm"> * ext3_free_inode().  The only reason we would point at a wrong inode is if</span>
<span class="cm"> * e2fsck was run on this filesystem, and it must have already done the orphan</span>
<span class="cm"> * inode cleanup for us, so we can safely abort without any further action.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ext3_orphan_cleanup</span> <span class="p">(</span><span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span> <span class="n">sb</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">ext3_super_block</span> <span class="o">*</span> <span class="n">es</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">s_flags</span> <span class="o">=</span> <span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">nr_orphans</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">nr_truncates</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="cp">#ifdef CONFIG_QUOTA</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">es</span><span class="o">-&gt;</span><span class="n">s_last_orphan</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">jbd_debug</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s">&quot;no orphan inodes to clean up</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bdev_read_only</span><span class="p">(</span><span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_bdev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ext3_msg</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">KERN_ERR</span><span class="p">,</span> <span class="s">&quot;error: write access &quot;</span>
			<span class="s">&quot;unavailable, skipping orphan cleanup.&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Check if feature set allows readwrite operations */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">EXT3_HAS_RO_COMPAT_FEATURE</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="o">~</span><span class="n">EXT3_FEATURE_RO_COMPAT_SUPP</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ext3_msg</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">KERN_INFO</span><span class="p">,</span> <span class="s">&quot;Skipping orphan cleanup due to &quot;</span>
			 <span class="s">&quot;unknown ROCOMPAT features&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">EXT3_SB</span><span class="p">(</span><span class="n">sb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">s_mount_state</span> <span class="o">&amp;</span> <span class="n">EXT3_ERROR_FS</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">es</span><span class="o">-&gt;</span><span class="n">s_last_orphan</span><span class="p">)</span>
			<span class="n">jbd_debug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;Errors on filesystem, &quot;</span>
				  <span class="s">&quot;clearing orphan list.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">es</span><span class="o">-&gt;</span><span class="n">s_last_orphan</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">jbd_debug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;Skipping orphan recovery on fs with errors.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">s_flags</span> <span class="o">&amp;</span> <span class="n">MS_RDONLY</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ext3_msg</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">KERN_INFO</span><span class="p">,</span> <span class="s">&quot;orphan cleanup on readonly fs&quot;</span><span class="p">);</span>
		<span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">MS_RDONLY</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#ifdef CONFIG_QUOTA</span>
	<span class="cm">/* Needed for iput() to work correctly and not trash data */</span>
	<span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_flags</span> <span class="o">|=</span> <span class="n">MS_ACTIVE</span><span class="p">;</span>
	<span class="cm">/* Turn on quotas so that they are updated correctly */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MAXQUOTAS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">EXT3_SB</span><span class="p">(</span><span class="n">sb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">s_qf_names</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="p">{</span>
			<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">ext3_quota_on_mount</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">ext3_msg</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">KERN_ERR</span><span class="p">,</span>
					<span class="s">&quot;error: cannot turn on journaled &quot;</span>
					<span class="s">&quot;quota: %d&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="cp">#endif</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">es</span><span class="o">-&gt;</span><span class="n">s_last_orphan</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">;</span>

		<span class="n">inode</span> <span class="o">=</span> <span class="n">ext3_orphan_get</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">es</span><span class="o">-&gt;</span><span class="n">s_last_orphan</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">inode</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">es</span><span class="o">-&gt;</span><span class="n">s_last_orphan</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">list_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">EXT3_I</span><span class="p">(</span><span class="n">inode</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">i_orphan</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">EXT3_SB</span><span class="p">(</span><span class="n">sb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">s_orphan</span><span class="p">);</span>
		<span class="n">dquot_initialize</span><span class="p">(</span><span class="n">inode</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_nlink</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span>
				<span class="s">&quot;%s: truncating inode %lu to %Ld bytes</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">__func__</span><span class="p">,</span> <span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_ino</span><span class="p">,</span> <span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_size</span><span class="p">);</span>
			<span class="n">jbd_debug</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;truncating inode %lu to %Ld bytes</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				  <span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_ino</span><span class="p">,</span> <span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_size</span><span class="p">);</span>
			<span class="n">ext3_truncate</span><span class="p">(</span><span class="n">inode</span><span class="p">);</span>
			<span class="n">nr_truncates</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span>
				<span class="s">&quot;%s: deleting unreferenced inode %lu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">__func__</span><span class="p">,</span> <span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_ino</span><span class="p">);</span>
			<span class="n">jbd_debug</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;deleting unreferenced inode %lu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				  <span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_ino</span><span class="p">);</span>
			<span class="n">nr_orphans</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">iput</span><span class="p">(</span><span class="n">inode</span><span class="p">);</span>  <span class="cm">/* The delete magic happens here! */</span>
	<span class="p">}</span>

<span class="cp">#define PLURAL(x) (x), ((x)==1) ? &quot;&quot; : &quot;s&quot;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nr_orphans</span><span class="p">)</span>
		<span class="n">ext3_msg</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">KERN_INFO</span><span class="p">,</span> <span class="s">&quot;%d orphan inode%s deleted&quot;</span><span class="p">,</span>
		       <span class="n">PLURAL</span><span class="p">(</span><span class="n">nr_orphans</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nr_truncates</span><span class="p">)</span>
		<span class="n">ext3_msg</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">KERN_INFO</span><span class="p">,</span> <span class="s">&quot;%d truncate%s cleaned up&quot;</span><span class="p">,</span>
		       <span class="n">PLURAL</span><span class="p">(</span><span class="n">nr_truncates</span><span class="p">));</span>
<span class="cp">#ifdef CONFIG_QUOTA</span>
	<span class="cm">/* Turn quotas off */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MAXQUOTAS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sb_dqopt</span><span class="p">(</span><span class="n">sb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">files</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
			<span class="n">dquot_quota_off</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
	<span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_flags</span> <span class="o">=</span> <span class="n">s_flags</span><span class="p">;</span> <span class="cm">/* Restore MS_RDONLY status */</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Maximal file size.  There is a direct, and {,double-,triple-}indirect</span>
<span class="cm"> * block limit, and also a limit of (2^32 - 1) 512-byte sectors in i_blocks.</span>
<span class="cm"> * We need to be 1 filesystem block less than the 2^32 sector limit.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">loff_t</span> <span class="nf">ext3_max_size</span><span class="p">(</span><span class="kt">int</span> <span class="n">bits</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">loff_t</span> <span class="n">res</span> <span class="o">=</span> <span class="n">EXT3_NDIR_BLOCKS</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">meta_blocks</span><span class="p">;</span>
	<span class="n">loff_t</span> <span class="n">upper_limit</span><span class="p">;</span>

	<span class="cm">/* This is calculated to be the largest file size for a</span>
<span class="cm">	 * dense, file such that the total number of</span>
<span class="cm">	 * sectors in the file, including data and all indirect blocks,</span>
<span class="cm">	 * does not exceed 2^32 -1</span>
<span class="cm">	 * __u32 i_blocks representing the total number of</span>
<span class="cm">	 * 512 bytes blocks of the file</span>
<span class="cm">	 */</span>
	<span class="n">upper_limit</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1LL</span> <span class="o">&lt;&lt;</span> <span class="mi">32</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* total blocks in file system block size */</span>
	<span class="n">upper_limit</span> <span class="o">&gt;&gt;=</span> <span class="p">(</span><span class="n">bits</span> <span class="o">-</span> <span class="mi">9</span><span class="p">);</span>


	<span class="cm">/* indirect blocks */</span>
	<span class="n">meta_blocks</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="cm">/* double indirect blocks */</span>
	<span class="n">meta_blocks</span> <span class="o">+=</span> <span class="mi">1</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1LL</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">bits</span><span class="o">-</span><span class="mi">2</span><span class="p">));</span>
	<span class="cm">/* tripple indirect blocks */</span>
	<span class="n">meta_blocks</span> <span class="o">+=</span> <span class="mi">1</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1LL</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">bits</span><span class="o">-</span><span class="mi">2</span><span class="p">))</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1LL</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="n">bits</span><span class="o">-</span><span class="mi">2</span><span class="p">)));</span>

	<span class="n">upper_limit</span> <span class="o">-=</span> <span class="n">meta_blocks</span><span class="p">;</span>
	<span class="n">upper_limit</span> <span class="o">&lt;&lt;=</span> <span class="n">bits</span><span class="p">;</span>

	<span class="n">res</span> <span class="o">+=</span> <span class="mi">1LL</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">bits</span><span class="o">-</span><span class="mi">2</span><span class="p">);</span>
	<span class="n">res</span> <span class="o">+=</span> <span class="mi">1LL</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="n">bits</span><span class="o">-</span><span class="mi">2</span><span class="p">));</span>
	<span class="n">res</span> <span class="o">+=</span> <span class="mi">1LL</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="mi">3</span><span class="o">*</span><span class="p">(</span><span class="n">bits</span><span class="o">-</span><span class="mi">2</span><span class="p">));</span>
	<span class="n">res</span> <span class="o">&lt;&lt;=</span> <span class="n">bits</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">res</span> <span class="o">&gt;</span> <span class="n">upper_limit</span><span class="p">)</span>
		<span class="n">res</span> <span class="o">=</span> <span class="n">upper_limit</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">res</span> <span class="o">&gt;</span> <span class="n">MAX_LFS_FILESIZE</span><span class="p">)</span>
		<span class="n">res</span> <span class="o">=</span> <span class="n">MAX_LFS_FILESIZE</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">ext3_fsblk_t</span> <span class="nf">descriptor_loc</span><span class="p">(</span><span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">sb</span><span class="p">,</span>
				    <span class="n">ext3_fsblk_t</span> <span class="n">logic_sb_block</span><span class="p">,</span>
				    <span class="kt">int</span> <span class="n">nr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ext3_sb_info</span> <span class="o">*</span><span class="n">sbi</span> <span class="o">=</span> <span class="n">EXT3_SB</span><span class="p">(</span><span class="n">sb</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">bg</span><span class="p">,</span> <span class="n">first_meta_bg</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">has_super</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">first_meta_bg</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_es</span><span class="o">-&gt;</span><span class="n">s_first_meta_bg</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">EXT3_HAS_INCOMPAT_FEATURE</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">EXT3_FEATURE_INCOMPAT_META_BG</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">nr</span> <span class="o">&lt;</span> <span class="n">first_meta_bg</span><span class="p">)</span>
		<span class="k">return</span> <span class="p">(</span><span class="n">logic_sb_block</span> <span class="o">+</span> <span class="n">nr</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">bg</span> <span class="o">=</span> <span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_desc_per_block</span> <span class="o">*</span> <span class="n">nr</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ext3_bg_has_super</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">bg</span><span class="p">))</span>
		<span class="n">has_super</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">has_super</span> <span class="o">+</span> <span class="n">ext3_group_first_block_no</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">bg</span><span class="p">));</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">ext3_fill_super</span> <span class="p">(</span><span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">sb</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">int</span> <span class="n">silent</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">buffer_head</span> <span class="o">*</span> <span class="n">bh</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ext3_super_block</span> <span class="o">*</span><span class="n">es</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ext3_sb_info</span> <span class="o">*</span><span class="n">sbi</span><span class="p">;</span>
	<span class="n">ext3_fsblk_t</span> <span class="n">block</span><span class="p">;</span>
	<span class="n">ext3_fsblk_t</span> <span class="n">sb_block</span> <span class="o">=</span> <span class="n">get_sb_block</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="p">,</span> <span class="n">sb</span><span class="p">);</span>
	<span class="n">ext3_fsblk_t</span> <span class="n">logic_sb_block</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">journal_inum</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">journal_devnum</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">def_mount_opts</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">root</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">blocksize</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">hblock</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">db_count</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">needs_recovery</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">__le32</span> <span class="n">features</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">sbi</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">sbi</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sbi</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_blockgroup_lock</span> <span class="o">=</span>
		<span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">blockgroup_lock</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_blockgroup_lock</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">sbi</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_fs_info</span> <span class="o">=</span> <span class="n">sbi</span><span class="p">;</span>
	<span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_mount_opt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_resuid</span> <span class="o">=</span> <span class="n">make_kuid</span><span class="p">(</span><span class="o">&amp;</span><span class="n">init_user_ns</span><span class="p">,</span> <span class="n">EXT3_DEF_RESUID</span><span class="p">);</span>
	<span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_resgid</span> <span class="o">=</span> <span class="n">make_kgid</span><span class="p">(</span><span class="o">&amp;</span><span class="n">init_user_ns</span><span class="p">,</span> <span class="n">EXT3_DEF_RESGID</span><span class="p">);</span>
	<span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_sb_block</span> <span class="o">=</span> <span class="n">sb_block</span><span class="p">;</span>

	<span class="n">blocksize</span> <span class="o">=</span> <span class="n">sb_min_blocksize</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">EXT3_MIN_BLOCK_SIZE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">blocksize</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ext3_msg</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">KERN_ERR</span><span class="p">,</span> <span class="s">&quot;error: unable to set blocksize&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_fail</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * The ext3 superblock will not be buffer aligned for other than 1kB</span>
<span class="cm">	 * block sizes.  We need to calculate the offset from buffer start.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">blocksize</span> <span class="o">!=</span> <span class="n">EXT3_MIN_BLOCK_SIZE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">logic_sb_block</span> <span class="o">=</span> <span class="p">(</span><span class="n">sb_block</span> <span class="o">*</span> <span class="n">EXT3_MIN_BLOCK_SIZE</span><span class="p">)</span> <span class="o">/</span> <span class="n">blocksize</span><span class="p">;</span>
		<span class="n">offset</span> <span class="o">=</span> <span class="p">(</span><span class="n">sb_block</span> <span class="o">*</span> <span class="n">EXT3_MIN_BLOCK_SIZE</span><span class="p">)</span> <span class="o">%</span> <span class="n">blocksize</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">logic_sb_block</span> <span class="o">=</span> <span class="n">sb_block</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">bh</span> <span class="o">=</span> <span class="n">sb_bread</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">logic_sb_block</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">ext3_msg</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">KERN_ERR</span><span class="p">,</span> <span class="s">&quot;error: unable to read superblock&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_fail</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/*</span>
<span class="cm">	 * Note: s_es must be initialized as soon as possible because</span>
<span class="cm">	 *       some ext3 macro-instructions depend on its value</span>
<span class="cm">	 */</span>
	<span class="n">es</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ext3_super_block</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">bh</span><span class="o">-&gt;</span><span class="n">b_data</span> <span class="o">+</span> <span class="n">offset</span><span class="p">);</span>
	<span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_es</span> <span class="o">=</span> <span class="n">es</span><span class="p">;</span>
	<span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_magic</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">es</span><span class="o">-&gt;</span><span class="n">s_magic</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_magic</span> <span class="o">!=</span> <span class="n">EXT3_SUPER_MAGIC</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">cantfind_ext3</span><span class="p">;</span>

	<span class="cm">/* Set defaults before we parse the mount options */</span>
	<span class="n">def_mount_opts</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">es</span><span class="o">-&gt;</span><span class="n">s_default_mount_opts</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">def_mount_opts</span> <span class="o">&amp;</span> <span class="n">EXT3_DEFM_DEBUG</span><span class="p">)</span>
		<span class="n">set_opt</span><span class="p">(</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_mount_opt</span><span class="p">,</span> <span class="n">DEBUG</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">def_mount_opts</span> <span class="o">&amp;</span> <span class="n">EXT3_DEFM_BSDGROUPS</span><span class="p">)</span>
		<span class="n">set_opt</span><span class="p">(</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_mount_opt</span><span class="p">,</span> <span class="n">GRPID</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">def_mount_opts</span> <span class="o">&amp;</span> <span class="n">EXT3_DEFM_UID16</span><span class="p">)</span>
		<span class="n">set_opt</span><span class="p">(</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_mount_opt</span><span class="p">,</span> <span class="n">NO_UID32</span><span class="p">);</span>
<span class="cp">#ifdef CONFIG_EXT3_FS_XATTR</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">def_mount_opts</span> <span class="o">&amp;</span> <span class="n">EXT3_DEFM_XATTR_USER</span><span class="p">)</span>
		<span class="n">set_opt</span><span class="p">(</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_mount_opt</span><span class="p">,</span> <span class="n">XATTR_USER</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef CONFIG_EXT3_FS_POSIX_ACL</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">def_mount_opts</span> <span class="o">&amp;</span> <span class="n">EXT3_DEFM_ACL</span><span class="p">)</span>
		<span class="n">set_opt</span><span class="p">(</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_mount_opt</span><span class="p">,</span> <span class="n">POSIX_ACL</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">def_mount_opts</span> <span class="o">&amp;</span> <span class="n">EXT3_DEFM_JMODE</span><span class="p">)</span> <span class="o">==</span> <span class="n">EXT3_DEFM_JMODE_DATA</span><span class="p">)</span>
		<span class="n">set_opt</span><span class="p">(</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_mount_opt</span><span class="p">,</span> <span class="n">JOURNAL_DATA</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">def_mount_opts</span> <span class="o">&amp;</span> <span class="n">EXT3_DEFM_JMODE</span><span class="p">)</span> <span class="o">==</span> <span class="n">EXT3_DEFM_JMODE_ORDERED</span><span class="p">)</span>
		<span class="n">set_opt</span><span class="p">(</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_mount_opt</span><span class="p">,</span> <span class="n">ORDERED_DATA</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">def_mount_opts</span> <span class="o">&amp;</span> <span class="n">EXT3_DEFM_JMODE</span><span class="p">)</span> <span class="o">==</span> <span class="n">EXT3_DEFM_JMODE_WBACK</span><span class="p">)</span>
		<span class="n">set_opt</span><span class="p">(</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_mount_opt</span><span class="p">,</span> <span class="n">WRITEBACK_DATA</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_es</span><span class="o">-&gt;</span><span class="n">s_errors</span><span class="p">)</span> <span class="o">==</span> <span class="n">EXT3_ERRORS_PANIC</span><span class="p">)</span>
		<span class="n">set_opt</span><span class="p">(</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_mount_opt</span><span class="p">,</span> <span class="n">ERRORS_PANIC</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_es</span><span class="o">-&gt;</span><span class="n">s_errors</span><span class="p">)</span> <span class="o">==</span> <span class="n">EXT3_ERRORS_CONTINUE</span><span class="p">)</span>
		<span class="n">set_opt</span><span class="p">(</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_mount_opt</span><span class="p">,</span> <span class="n">ERRORS_CONT</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">set_opt</span><span class="p">(</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_mount_opt</span><span class="p">,</span> <span class="n">ERRORS_RO</span><span class="p">);</span>

	<span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_resuid</span> <span class="o">=</span> <span class="n">make_kuid</span><span class="p">(</span><span class="o">&amp;</span><span class="n">init_user_ns</span><span class="p">,</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">es</span><span class="o">-&gt;</span><span class="n">s_def_resuid</span><span class="p">));</span>
	<span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_resgid</span> <span class="o">=</span> <span class="n">make_kgid</span><span class="p">(</span><span class="o">&amp;</span><span class="n">init_user_ns</span><span class="p">,</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">es</span><span class="o">-&gt;</span><span class="n">s_def_resgid</span><span class="p">));</span>

	<span class="cm">/* enable barriers by default */</span>
	<span class="n">set_opt</span><span class="p">(</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_mount_opt</span><span class="p">,</span> <span class="n">BARRIER</span><span class="p">);</span>
	<span class="n">set_opt</span><span class="p">(</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_mount_opt</span><span class="p">,</span> <span class="n">RESERVATION</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">parse_options</span> <span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">data</span><span class="p">,</span> <span class="n">sb</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">journal_inum</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">journal_devnum</span><span class="p">,</span>
			    <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">failed_mount</span><span class="p">;</span>

	<span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_flags</span> <span class="o">=</span> <span class="p">(</span><span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_flags</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">MS_POSIXACL</span><span class="p">)</span> <span class="o">|</span>
		<span class="p">(</span><span class="n">test_opt</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">POSIX_ACL</span><span class="p">)</span> <span class="o">?</span> <span class="n">MS_POSIXACL</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">es</span><span class="o">-&gt;</span><span class="n">s_rev_level</span><span class="p">)</span> <span class="o">==</span> <span class="n">EXT3_GOOD_OLD_REV</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">EXT3_HAS_COMPAT_FEATURE</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="o">~</span><span class="mi">0U</span><span class="p">)</span> <span class="o">||</span>
	     <span class="n">EXT3_HAS_RO_COMPAT_FEATURE</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="o">~</span><span class="mi">0U</span><span class="p">)</span> <span class="o">||</span>
	     <span class="n">EXT3_HAS_INCOMPAT_FEATURE</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="o">~</span><span class="mi">0U</span><span class="p">)))</span>
		<span class="n">ext3_msg</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">KERN_WARNING</span><span class="p">,</span>
			<span class="s">&quot;warning: feature flags set on rev 0 fs, &quot;</span>
			<span class="s">&quot;running e2fsck is recommended&quot;</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 * Check feature flags regardless of the revision level, since we</span>
<span class="cm">	 * previously didn&#39;t change the revision level when setting the flags,</span>
<span class="cm">	 * so there is a chance incompat flags are set on a rev 0 filesystem.</span>
<span class="cm">	 */</span>
	<span class="n">features</span> <span class="o">=</span> <span class="n">EXT3_HAS_INCOMPAT_FEATURE</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="o">~</span><span class="n">EXT3_FEATURE_INCOMPAT_SUPP</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">features</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ext3_msg</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">KERN_ERR</span><span class="p">,</span>
			<span class="s">&quot;error: couldn&#39;t mount because of unsupported &quot;</span>
			<span class="s">&quot;optional features (%x)&quot;</span><span class="p">,</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">features</span><span class="p">));</span>
		<span class="k">goto</span> <span class="n">failed_mount</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">features</span> <span class="o">=</span> <span class="n">EXT3_HAS_RO_COMPAT_FEATURE</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="o">~</span><span class="n">EXT3_FEATURE_RO_COMPAT_SUPP</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_flags</span> <span class="o">&amp;</span> <span class="n">MS_RDONLY</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">features</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ext3_msg</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">KERN_ERR</span><span class="p">,</span>
			<span class="s">&quot;error: couldn&#39;t mount RDWR because of unsupported &quot;</span>
			<span class="s">&quot;optional features (%x)&quot;</span><span class="p">,</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">features</span><span class="p">));</span>
		<span class="k">goto</span> <span class="n">failed_mount</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">blocksize</span> <span class="o">=</span> <span class="n">BLOCK_SIZE</span> <span class="o">&lt;&lt;</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">es</span><span class="o">-&gt;</span><span class="n">s_log_block_size</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">blocksize</span> <span class="o">&lt;</span> <span class="n">EXT3_MIN_BLOCK_SIZE</span> <span class="o">||</span>
	    <span class="n">blocksize</span> <span class="o">&gt;</span> <span class="n">EXT3_MAX_BLOCK_SIZE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ext3_msg</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">KERN_ERR</span><span class="p">,</span>
			<span class="s">&quot;error: couldn&#39;t mount because of unsupported &quot;</span>
			<span class="s">&quot;filesystem blocksize %d&quot;</span><span class="p">,</span> <span class="n">blocksize</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">failed_mount</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">hblock</span> <span class="o">=</span> <span class="n">bdev_logical_block_size</span><span class="p">(</span><span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_bdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_blocksize</span> <span class="o">!=</span> <span class="n">blocksize</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Make sure the blocksize for the filesystem is larger</span>
<span class="cm">		 * than the hardware sectorsize for the machine.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">blocksize</span> <span class="o">&lt;</span> <span class="n">hblock</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ext3_msg</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">KERN_ERR</span><span class="p">,</span>
				<span class="s">&quot;error: fsblocksize %d too small for &quot;</span>
				<span class="s">&quot;hardware sectorsize %d&quot;</span><span class="p">,</span> <span class="n">blocksize</span><span class="p">,</span> <span class="n">hblock</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">failed_mount</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">brelse</span> <span class="p">(</span><span class="n">bh</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sb_set_blocksize</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">blocksize</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">ext3_msg</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">KERN_ERR</span><span class="p">,</span>
				<span class="s">&quot;error: bad blocksize %d&quot;</span><span class="p">,</span> <span class="n">blocksize</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">out_fail</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">logic_sb_block</span> <span class="o">=</span> <span class="p">(</span><span class="n">sb_block</span> <span class="o">*</span> <span class="n">EXT3_MIN_BLOCK_SIZE</span><span class="p">)</span> <span class="o">/</span> <span class="n">blocksize</span><span class="p">;</span>
		<span class="n">offset</span> <span class="o">=</span> <span class="p">(</span><span class="n">sb_block</span> <span class="o">*</span> <span class="n">EXT3_MIN_BLOCK_SIZE</span><span class="p">)</span> <span class="o">%</span> <span class="n">blocksize</span><span class="p">;</span>
		<span class="n">bh</span> <span class="o">=</span> <span class="n">sb_bread</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">logic_sb_block</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bh</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ext3_msg</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">KERN_ERR</span><span class="p">,</span>
			       <span class="s">&quot;error: can&#39;t read superblock on 2nd try&quot;</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">failed_mount</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">es</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ext3_super_block</span> <span class="o">*</span><span class="p">)(</span><span class="n">bh</span><span class="o">-&gt;</span><span class="n">b_data</span> <span class="o">+</span> <span class="n">offset</span><span class="p">);</span>
		<span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_es</span> <span class="o">=</span> <span class="n">es</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">es</span><span class="o">-&gt;</span><span class="n">s_magic</span> <span class="o">!=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">EXT3_SUPER_MAGIC</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">ext3_msg</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">KERN_ERR</span><span class="p">,</span>
				<span class="s">&quot;error: magic mismatch&quot;</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">failed_mount</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_maxbytes</span> <span class="o">=</span> <span class="n">ext3_max_size</span><span class="p">(</span><span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_blocksize_bits</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">es</span><span class="o">-&gt;</span><span class="n">s_rev_level</span><span class="p">)</span> <span class="o">==</span> <span class="n">EXT3_GOOD_OLD_REV</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_inode_size</span> <span class="o">=</span> <span class="n">EXT3_GOOD_OLD_INODE_SIZE</span><span class="p">;</span>
		<span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_first_ino</span> <span class="o">=</span> <span class="n">EXT3_GOOD_OLD_FIRST_INO</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_inode_size</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">es</span><span class="o">-&gt;</span><span class="n">s_inode_size</span><span class="p">);</span>
		<span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_first_ino</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">es</span><span class="o">-&gt;</span><span class="n">s_first_ino</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_inode_size</span> <span class="o">&lt;</span> <span class="n">EXT3_GOOD_OLD_INODE_SIZE</span><span class="p">)</span> <span class="o">||</span>
		    <span class="p">(</span><span class="o">!</span><span class="n">is_power_of_2</span><span class="p">(</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_inode_size</span><span class="p">))</span> <span class="o">||</span>
		    <span class="p">(</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_inode_size</span> <span class="o">&gt;</span> <span class="n">blocksize</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">ext3_msg</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">KERN_ERR</span><span class="p">,</span>
				<span class="s">&quot;error: unsupported inode size: %d&quot;</span><span class="p">,</span>
				<span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_inode_size</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">failed_mount</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_frag_size</span> <span class="o">=</span> <span class="n">EXT3_MIN_FRAG_SIZE</span> <span class="o">&lt;&lt;</span>
				   <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">es</span><span class="o">-&gt;</span><span class="n">s_log_frag_size</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">blocksize</span> <span class="o">!=</span> <span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_frag_size</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ext3_msg</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">KERN_ERR</span><span class="p">,</span>
		       <span class="s">&quot;error: fragsize %lu != blocksize %u (unsupported)&quot;</span><span class="p">,</span>
		       <span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_frag_size</span><span class="p">,</span> <span class="n">blocksize</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">failed_mount</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_frags_per_block</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_blocks_per_group</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">es</span><span class="o">-&gt;</span><span class="n">s_blocks_per_group</span><span class="p">);</span>
	<span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_frags_per_group</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">es</span><span class="o">-&gt;</span><span class="n">s_frags_per_group</span><span class="p">);</span>
	<span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_inodes_per_group</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">es</span><span class="o">-&gt;</span><span class="n">s_inodes_per_group</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">EXT3_INODE_SIZE</span><span class="p">(</span><span class="n">sb</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">EXT3_INODES_PER_GROUP</span><span class="p">(</span><span class="n">sb</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">cantfind_ext3</span><span class="p">;</span>
	<span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_inodes_per_block</span> <span class="o">=</span> <span class="n">blocksize</span> <span class="o">/</span> <span class="n">EXT3_INODE_SIZE</span><span class="p">(</span><span class="n">sb</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_inodes_per_block</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">cantfind_ext3</span><span class="p">;</span>
	<span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_itb_per_group</span> <span class="o">=</span> <span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_inodes_per_group</span> <span class="o">/</span>
					<span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_inodes_per_block</span><span class="p">;</span>
	<span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_desc_per_block</span> <span class="o">=</span> <span class="n">blocksize</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ext3_group_desc</span><span class="p">);</span>
	<span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_sbh</span> <span class="o">=</span> <span class="n">bh</span><span class="p">;</span>
	<span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_mount_state</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">es</span><span class="o">-&gt;</span><span class="n">s_state</span><span class="p">);</span>
	<span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_addr_per_block_bits</span> <span class="o">=</span> <span class="n">ilog2</span><span class="p">(</span><span class="n">EXT3_ADDR_PER_BLOCK</span><span class="p">(</span><span class="n">sb</span><span class="p">));</span>
	<span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_desc_per_block_bits</span> <span class="o">=</span> <span class="n">ilog2</span><span class="p">(</span><span class="n">EXT3_DESC_PER_BLOCK</span><span class="p">(</span><span class="n">sb</span><span class="p">));</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_hash_seed</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">es</span><span class="o">-&gt;</span><span class="n">s_hash_seed</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_def_hash_version</span> <span class="o">=</span> <span class="n">es</span><span class="o">-&gt;</span><span class="n">s_def_hash_version</span><span class="p">;</span>
	<span class="n">i</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">es</span><span class="o">-&gt;</span><span class="n">s_flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&amp;</span> <span class="n">EXT2_FLAGS_UNSIGNED_HASH</span><span class="p">)</span>
		<span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_hash_unsigned</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">i</span> <span class="o">&amp;</span> <span class="n">EXT2_FLAGS_SIGNED_HASH</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#ifdef __CHAR_UNSIGNED__</span>
		<span class="n">es</span><span class="o">-&gt;</span><span class="n">s_flags</span> <span class="o">|=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">EXT2_FLAGS_UNSIGNED_HASH</span><span class="p">);</span>
		<span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_hash_unsigned</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
<span class="cp">#else</span>
		<span class="n">es</span><span class="o">-&gt;</span><span class="n">s_flags</span> <span class="o">|=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">EXT2_FLAGS_SIGNED_HASH</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_blocks_per_group</span> <span class="o">&gt;</span> <span class="n">blocksize</span> <span class="o">*</span> <span class="mi">8</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ext3_msg</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">KERN_ERR</span><span class="p">,</span>
			<span class="s">&quot;#blocks per group too big: %lu&quot;</span><span class="p">,</span>
			<span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_blocks_per_group</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">failed_mount</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_frags_per_group</span> <span class="o">&gt;</span> <span class="n">blocksize</span> <span class="o">*</span> <span class="mi">8</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ext3_msg</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">KERN_ERR</span><span class="p">,</span>
			<span class="s">&quot;error: #fragments per group too big: %lu&quot;</span><span class="p">,</span>
			<span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_frags_per_group</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">failed_mount</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_inodes_per_group</span> <span class="o">&gt;</span> <span class="n">blocksize</span> <span class="o">*</span> <span class="mi">8</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ext3_msg</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">KERN_ERR</span><span class="p">,</span>
			<span class="s">&quot;error: #inodes per group too big: %lu&quot;</span><span class="p">,</span>
			<span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_inodes_per_group</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">failed_mount</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">generic_check_addressable</span><span class="p">(</span><span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_blocksize_bits</span><span class="p">,</span>
					<span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">es</span><span class="o">-&gt;</span><span class="n">s_blocks_count</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ext3_msg</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">KERN_ERR</span><span class="p">,</span>
			<span class="s">&quot;error: filesystem is too large to mount safely&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">sector_t</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">)</span>
			<span class="n">ext3_msg</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">KERN_ERR</span><span class="p">,</span>
				<span class="s">&quot;error: CONFIG_LBDAF not enabled&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">err</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">failed_mount</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">EXT3_BLOCKS_PER_GROUP</span><span class="p">(</span><span class="n">sb</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">cantfind_ext3</span><span class="p">;</span>
	<span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_groups_count</span> <span class="o">=</span> <span class="p">((</span><span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">es</span><span class="o">-&gt;</span><span class="n">s_blocks_count</span><span class="p">)</span> <span class="o">-</span>
			       <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">es</span><span class="o">-&gt;</span><span class="n">s_first_data_block</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
				       <span class="o">/</span> <span class="n">EXT3_BLOCKS_PER_GROUP</span><span class="p">(</span><span class="n">sb</span><span class="p">))</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">db_count</span> <span class="o">=</span> <span class="n">DIV_ROUND_UP</span><span class="p">(</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_groups_count</span><span class="p">,</span> <span class="n">EXT3_DESC_PER_BLOCK</span><span class="p">(</span><span class="n">sb</span><span class="p">));</span>
	<span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_group_desc</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">db_count</span> <span class="o">*</span> <span class="k">sizeof</span> <span class="p">(</span><span class="k">struct</span> <span class="n">buffer_head</span> <span class="o">*</span><span class="p">),</span>
				    <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_group_desc</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ext3_msg</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">KERN_ERR</span><span class="p">,</span>
			<span class="s">&quot;error: not enough memory&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">failed_mount</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">bgl_lock_init</span><span class="p">(</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_blockgroup_lock</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">db_count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">block</span> <span class="o">=</span> <span class="n">descriptor_loc</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">logic_sb_block</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
		<span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_group_desc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">sb_bread</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">block</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_group_desc</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="p">{</span>
			<span class="n">ext3_msg</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">KERN_ERR</span><span class="p">,</span>
				<span class="s">&quot;error: can&#39;t read group descriptor %d&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
			<span class="n">db_count</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">failed_mount2</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ext3_check_descriptors</span> <span class="p">(</span><span class="n">sb</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ext3_msg</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">KERN_ERR</span><span class="p">,</span>
			<span class="s">&quot;error: group descriptors corrupted&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">failed_mount2</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_gdb_count</span> <span class="o">=</span> <span class="n">db_count</span><span class="p">;</span>
	<span class="n">get_random_bytes</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_next_generation</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">));</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_next_gen_lock</span><span class="p">);</span>

	<span class="cm">/* per fileystem reservation list head &amp; lock */</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_rsv_window_lock</span><span class="p">);</span>
	<span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_rsv_window_root</span> <span class="o">=</span> <span class="n">RB_ROOT</span><span class="p">;</span>
	<span class="cm">/* Add a single, static dummy reservation to the start of the</span>
<span class="cm">	 * reservation window list --- it gives us a placeholder for</span>
<span class="cm">	 * append-at-start-of-list which makes the allocation logic</span>
<span class="cm">	 * _much_ simpler. */</span>
	<span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_rsv_window_head</span><span class="p">.</span><span class="n">rsv_start</span> <span class="o">=</span> <span class="n">EXT3_RESERVE_WINDOW_NOT_ALLOCATED</span><span class="p">;</span>
	<span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_rsv_window_head</span><span class="p">.</span><span class="n">rsv_end</span> <span class="o">=</span> <span class="n">EXT3_RESERVE_WINDOW_NOT_ALLOCATED</span><span class="p">;</span>
	<span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_rsv_window_head</span><span class="p">.</span><span class="n">rsv_alloc_hit</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_rsv_window_head</span><span class="p">.</span><span class="n">rsv_goal_size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ext3_rsv_window_add</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_rsv_window_head</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * set up enough so that it can read an inode</span>
<span class="cm">	 */</span>
	<span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_op</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ext3_sops</span><span class="p">;</span>
	<span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_export_op</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ext3_export_ops</span><span class="p">;</span>
	<span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_xattr</span> <span class="o">=</span> <span class="n">ext3_xattr_handlers</span><span class="p">;</span>
<span class="cp">#ifdef CONFIG_QUOTA</span>
	<span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_qcop</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ext3_qctl_operations</span><span class="p">;</span>
	<span class="n">sb</span><span class="o">-&gt;</span><span class="n">dq_op</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ext3_quota_operations</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_uuid</span><span class="p">,</span> <span class="n">es</span><span class="o">-&gt;</span><span class="n">s_uuid</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">es</span><span class="o">-&gt;</span><span class="n">s_uuid</span><span class="p">));</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_orphan</span><span class="p">);</span> <span class="cm">/* unlinked but open files */</span>
	<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_orphan_lock</span><span class="p">);</span>
	<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_resize_lock</span><span class="p">);</span>

	<span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_root</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">needs_recovery</span> <span class="o">=</span> <span class="p">(</span><span class="n">es</span><span class="o">-&gt;</span><span class="n">s_last_orphan</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">||</span>
			  <span class="n">EXT3_HAS_INCOMPAT_FEATURE</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span>
				    <span class="n">EXT3_FEATURE_INCOMPAT_RECOVER</span><span class="p">));</span>

	<span class="cm">/*</span>
<span class="cm">	 * The first inode we look at is the journal inode.  Don&#39;t try</span>
<span class="cm">	 * root first: it may be modified in the journal!</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_opt</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">NOLOAD</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">EXT3_HAS_COMPAT_FEATURE</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">EXT3_FEATURE_COMPAT_HAS_JOURNAL</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ext3_load_journal</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">es</span><span class="p">,</span> <span class="n">journal_devnum</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">failed_mount2</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">journal_inum</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ext3_create_journal</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">es</span><span class="p">,</span> <span class="n">journal_inum</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">failed_mount2</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">silent</span><span class="p">)</span>
			<span class="n">ext3_msg</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">KERN_ERR</span><span class="p">,</span>
				<span class="s">&quot;error: no journal found. &quot;</span>
				<span class="s">&quot;mounting ext3 over ext2?&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">failed_mount2</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">percpu_counter_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_freeblocks_counter</span><span class="p">,</span>
			<span class="n">ext3_count_free_blocks</span><span class="p">(</span><span class="n">sb</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">percpu_counter_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_freeinodes_counter</span><span class="p">,</span>
				<span class="n">ext3_count_free_inodes</span><span class="p">(</span><span class="n">sb</span><span class="p">));</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">percpu_counter_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_dirs_counter</span><span class="p">,</span>
				<span class="n">ext3_count_dirs</span><span class="p">(</span><span class="n">sb</span><span class="p">));</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ext3_msg</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">KERN_ERR</span><span class="p">,</span> <span class="s">&quot;error: insufficient memory&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">err</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">failed_mount3</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* We have now updated the journal if required, so we can</span>
<span class="cm">	 * validate the data journaling mode. */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">test_opt</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">DATA_FLAGS</span><span class="p">))</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>:
		<span class="cm">/* No mode set, assume a default based on the journal</span>
<span class="cm">                   capabilities: ORDERED_DATA if the journal can</span>
<span class="cm">                   cope, else JOURNAL_DATA */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">journal_check_available_features</span>
		    <span class="p">(</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_journal</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">JFS_FEATURE_INCOMPAT_REVOKE</span><span class="p">))</span>
			<span class="n">set_opt</span><span class="p">(</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_mount_opt</span><span class="p">,</span> <span class="n">DEFAULT_DATA_MODE</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">set_opt</span><span class="p">(</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_mount_opt</span><span class="p">,</span> <span class="n">JOURNAL_DATA</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">EXT3_MOUNT_ORDERED_DATA</span>:
	<span class="k">case</span> <span class="n">EXT3_MOUNT_WRITEBACK_DATA</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">journal_check_available_features</span>
		    <span class="p">(</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_journal</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">JFS_FEATURE_INCOMPAT_REVOKE</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">ext3_msg</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">KERN_ERR</span><span class="p">,</span>
				<span class="s">&quot;error: journal does not support &quot;</span>
				<span class="s">&quot;requested data journaling mode&quot;</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">failed_mount3</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * The journal_load will have done any necessary log recovery,</span>
<span class="cm">	 * so we can safely mount the rest of the filesystem now.</span>
<span class="cm">	 */</span>

	<span class="n">root</span> <span class="o">=</span> <span class="n">ext3_iget</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">EXT3_ROOT_INO</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">root</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ext3_msg</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">KERN_ERR</span><span class="p">,</span> <span class="s">&quot;error: get root inode failed&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">root</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">failed_mount3</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">S_ISDIR</span><span class="p">(</span><span class="n">root</span><span class="o">-&gt;</span><span class="n">i_mode</span><span class="p">)</span> <span class="o">||</span> <span class="o">!</span><span class="n">root</span><span class="o">-&gt;</span><span class="n">i_blocks</span> <span class="o">||</span> <span class="o">!</span><span class="n">root</span><span class="o">-&gt;</span><span class="n">i_size</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">iput</span><span class="p">(</span><span class="n">root</span><span class="p">);</span>
		<span class="n">ext3_msg</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">KERN_ERR</span><span class="p">,</span> <span class="s">&quot;error: corrupt root inode, run e2fsck&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">failed_mount3</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_root</span> <span class="o">=</span> <span class="n">d_make_root</span><span class="p">(</span><span class="n">root</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_root</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ext3_msg</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">KERN_ERR</span><span class="p">,</span> <span class="s">&quot;error: get root dentry failed&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">failed_mount3</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ext3_setup_super</span> <span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">es</span><span class="p">,</span> <span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_flags</span> <span class="o">&amp;</span> <span class="n">MS_RDONLY</span><span class="p">);</span>

	<span class="n">EXT3_SB</span><span class="p">(</span><span class="n">sb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">s_mount_state</span> <span class="o">|=</span> <span class="n">EXT3_ORPHAN_FS</span><span class="p">;</span>
	<span class="n">ext3_orphan_cleanup</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">es</span><span class="p">);</span>
	<span class="n">EXT3_SB</span><span class="p">(</span><span class="n">sb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">s_mount_state</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">EXT3_ORPHAN_FS</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">needs_recovery</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ext3_mark_recovery_complete</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">es</span><span class="p">);</span>
		<span class="n">ext3_msg</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">KERN_INFO</span><span class="p">,</span> <span class="s">&quot;recovery complete&quot;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">ext3_msg</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">KERN_INFO</span><span class="p">,</span> <span class="s">&quot;mounted filesystem with %s data mode&quot;</span><span class="p">,</span>
		<span class="n">test_opt</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span><span class="n">DATA_FLAGS</span><span class="p">)</span> <span class="o">==</span> <span class="n">EXT3_MOUNT_JOURNAL_DATA</span> <span class="o">?</span> <span class="s">&quot;journal&quot;</span><span class="o">:</span>
		<span class="n">test_opt</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span><span class="n">DATA_FLAGS</span><span class="p">)</span> <span class="o">==</span> <span class="n">EXT3_MOUNT_ORDERED_DATA</span> <span class="o">?</span> <span class="s">&quot;ordered&quot;</span><span class="o">:</span>
		<span class="s">&quot;writeback&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">cantfind_ext3:</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">silent</span><span class="p">)</span>
		<span class="n">ext3_msg</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">KERN_INFO</span><span class="p">,</span>
			<span class="s">&quot;error: can&#39;t find ext3 filesystem on dev %s.&quot;</span><span class="p">,</span>
		       <span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_id</span><span class="p">);</span>
	<span class="k">goto</span> <span class="n">failed_mount</span><span class="p">;</span>

<span class="nl">failed_mount3:</span>
	<span class="n">percpu_counter_destroy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_freeblocks_counter</span><span class="p">);</span>
	<span class="n">percpu_counter_destroy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_freeinodes_counter</span><span class="p">);</span>
	<span class="n">percpu_counter_destroy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_dirs_counter</span><span class="p">);</span>
	<span class="n">journal_destroy</span><span class="p">(</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_journal</span><span class="p">);</span>
<span class="nl">failed_mount2:</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">db_count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">brelse</span><span class="p">(</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_group_desc</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_group_desc</span><span class="p">);</span>
<span class="nl">failed_mount:</span>
<span class="cp">#ifdef CONFIG_QUOTA</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MAXQUOTAS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_qf_names</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
<span class="cp">#endif</span>
	<span class="n">ext3_blkdev_remove</span><span class="p">(</span><span class="n">sbi</span><span class="p">);</span>
	<span class="n">brelse</span><span class="p">(</span><span class="n">bh</span><span class="p">);</span>
<span class="nl">out_fail:</span>
	<span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_fs_info</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_blockgroup_lock</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">sbi</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Setup any per-fs journal parameters now.  We&#39;ll do this both on</span>
<span class="cm"> * initial mount, once the journal has been initialised but before we&#39;ve</span>
<span class="cm"> * done any recovery; and again on any subsequent remount.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ext3_init_journal_params</span><span class="p">(</span><span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">sb</span><span class="p">,</span> <span class="n">journal_t</span> <span class="o">*</span><span class="n">journal</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ext3_sb_info</span> <span class="o">*</span><span class="n">sbi</span> <span class="o">=</span> <span class="n">EXT3_SB</span><span class="p">(</span><span class="n">sb</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_commit_interval</span><span class="p">)</span>
		<span class="n">journal</span><span class="o">-&gt;</span><span class="n">j_commit_interval</span> <span class="o">=</span> <span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_commit_interval</span><span class="p">;</span>
	<span class="cm">/* We could also set up an ext3-specific default for the commit</span>
<span class="cm">	 * interval here, but for now we&#39;ll just fall back to the jbd</span>
<span class="cm">	 * default. */</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">journal</span><span class="o">-&gt;</span><span class="n">j_state_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_opt</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">BARRIER</span><span class="p">))</span>
		<span class="n">journal</span><span class="o">-&gt;</span><span class="n">j_flags</span> <span class="o">|=</span> <span class="n">JFS_BARRIER</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">journal</span><span class="o">-&gt;</span><span class="n">j_flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">JFS_BARRIER</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_opt</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">DATA_ERR_ABORT</span><span class="p">))</span>
		<span class="n">journal</span><span class="o">-&gt;</span><span class="n">j_flags</span> <span class="o">|=</span> <span class="n">JFS_ABORT_ON_SYNCDATA_ERR</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">journal</span><span class="o">-&gt;</span><span class="n">j_flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">JFS_ABORT_ON_SYNCDATA_ERR</span><span class="p">;</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">journal</span><span class="o">-&gt;</span><span class="n">j_state_lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">journal_t</span> <span class="o">*</span><span class="nf">ext3_get_journal</span><span class="p">(</span><span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">sb</span><span class="p">,</span>
				   <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">journal_inum</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">journal_inode</span><span class="p">;</span>
	<span class="n">journal_t</span> <span class="o">*</span><span class="n">journal</span><span class="p">;</span>

	<span class="cm">/* First, test for the existence of a valid inode on disk.  Bad</span>
<span class="cm">	 * things happen if we iget() an unused inode, as the subsequent</span>
<span class="cm">	 * iput() will try to delete it. */</span>

	<span class="n">journal_inode</span> <span class="o">=</span> <span class="n">ext3_iget</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">journal_inum</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">journal_inode</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ext3_msg</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">KERN_ERR</span><span class="p">,</span> <span class="s">&quot;error: no journal found&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">journal_inode</span><span class="o">-&gt;</span><span class="n">i_nlink</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">make_bad_inode</span><span class="p">(</span><span class="n">journal_inode</span><span class="p">);</span>
		<span class="n">iput</span><span class="p">(</span><span class="n">journal_inode</span><span class="p">);</span>
		<span class="n">ext3_msg</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">KERN_ERR</span><span class="p">,</span> <span class="s">&quot;error: journal inode is deleted&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">jbd_debug</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;Journal inode found at %p: %Ld bytes</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		  <span class="n">journal_inode</span><span class="p">,</span> <span class="n">journal_inode</span><span class="o">-&gt;</span><span class="n">i_size</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">S_ISREG</span><span class="p">(</span><span class="n">journal_inode</span><span class="o">-&gt;</span><span class="n">i_mode</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ext3_msg</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">KERN_ERR</span><span class="p">,</span> <span class="s">&quot;error: invalid journal inode&quot;</span><span class="p">);</span>
		<span class="n">iput</span><span class="p">(</span><span class="n">journal_inode</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">journal</span> <span class="o">=</span> <span class="n">journal_init_inode</span><span class="p">(</span><span class="n">journal_inode</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">journal</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ext3_msg</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">KERN_ERR</span><span class="p">,</span> <span class="s">&quot;error: could not load journal inode&quot;</span><span class="p">);</span>
		<span class="n">iput</span><span class="p">(</span><span class="n">journal_inode</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">journal</span><span class="o">-&gt;</span><span class="n">j_private</span> <span class="o">=</span> <span class="n">sb</span><span class="p">;</span>
	<span class="n">ext3_init_journal_params</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">journal</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">journal</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">journal_t</span> <span class="o">*</span><span class="nf">ext3_get_dev_journal</span><span class="p">(</span><span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">sb</span><span class="p">,</span>
				       <span class="n">dev_t</span> <span class="n">j_dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">buffer_head</span> <span class="o">*</span> <span class="n">bh</span><span class="p">;</span>
	<span class="n">journal_t</span> <span class="o">*</span><span class="n">journal</span><span class="p">;</span>
	<span class="n">ext3_fsblk_t</span> <span class="n">start</span><span class="p">;</span>
	<span class="n">ext3_fsblk_t</span> <span class="n">len</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">hblock</span><span class="p">,</span> <span class="n">blocksize</span><span class="p">;</span>
	<span class="n">ext3_fsblk_t</span> <span class="n">sb_block</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">offset</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ext3_super_block</span> <span class="o">*</span> <span class="n">es</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">block_device</span> <span class="o">*</span><span class="n">bdev</span><span class="p">;</span>

	<span class="n">bdev</span> <span class="o">=</span> <span class="n">ext3_blkdev_get</span><span class="p">(</span><span class="n">j_dev</span><span class="p">,</span> <span class="n">sb</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bdev</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">blocksize</span> <span class="o">=</span> <span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_blocksize</span><span class="p">;</span>
	<span class="n">hblock</span> <span class="o">=</span> <span class="n">bdev_logical_block_size</span><span class="p">(</span><span class="n">bdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">blocksize</span> <span class="o">&lt;</span> <span class="n">hblock</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ext3_msg</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">KERN_ERR</span><span class="p">,</span>
			<span class="s">&quot;error: blocksize too small for journal device&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_bdev</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">sb_block</span> <span class="o">=</span> <span class="n">EXT3_MIN_BLOCK_SIZE</span> <span class="o">/</span> <span class="n">blocksize</span><span class="p">;</span>
	<span class="n">offset</span> <span class="o">=</span> <span class="n">EXT3_MIN_BLOCK_SIZE</span> <span class="o">%</span> <span class="n">blocksize</span><span class="p">;</span>
	<span class="n">set_blocksize</span><span class="p">(</span><span class="n">bdev</span><span class="p">,</span> <span class="n">blocksize</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">bh</span> <span class="o">=</span> <span class="n">__bread</span><span class="p">(</span><span class="n">bdev</span><span class="p">,</span> <span class="n">sb_block</span><span class="p">,</span> <span class="n">blocksize</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">ext3_msg</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">KERN_ERR</span><span class="p">,</span> <span class="s">&quot;error: couldn&#39;t read superblock of &quot;</span>
			<span class="s">&quot;external journal&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_bdev</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">es</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ext3_super_block</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">bh</span><span class="o">-&gt;</span><span class="n">b_data</span> <span class="o">+</span> <span class="n">offset</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">es</span><span class="o">-&gt;</span><span class="n">s_magic</span><span class="p">)</span> <span class="o">!=</span> <span class="n">EXT3_SUPER_MAGIC</span><span class="p">)</span> <span class="o">||</span>
	    <span class="o">!</span><span class="p">(</span><span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">es</span><span class="o">-&gt;</span><span class="n">s_feature_incompat</span><span class="p">)</span> <span class="o">&amp;</span>
	      <span class="n">EXT3_FEATURE_INCOMPAT_JOURNAL_DEV</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ext3_msg</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">KERN_ERR</span><span class="p">,</span> <span class="s">&quot;error: external journal has &quot;</span>
			<span class="s">&quot;bad superblock&quot;</span><span class="p">);</span>
		<span class="n">brelse</span><span class="p">(</span><span class="n">bh</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_bdev</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">memcmp</span><span class="p">(</span><span class="n">EXT3_SB</span><span class="p">(</span><span class="n">sb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">s_es</span><span class="o">-&gt;</span><span class="n">s_journal_uuid</span><span class="p">,</span> <span class="n">es</span><span class="o">-&gt;</span><span class="n">s_uuid</span><span class="p">,</span> <span class="mi">16</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ext3_msg</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">KERN_ERR</span><span class="p">,</span> <span class="s">&quot;error: journal UUID does not match&quot;</span><span class="p">);</span>
		<span class="n">brelse</span><span class="p">(</span><span class="n">bh</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_bdev</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">len</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">es</span><span class="o">-&gt;</span><span class="n">s_blocks_count</span><span class="p">);</span>
	<span class="n">start</span> <span class="o">=</span> <span class="n">sb_block</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">brelse</span><span class="p">(</span><span class="n">bh</span><span class="p">);</span>	<span class="cm">/* we&#39;re done with the superblock */</span>

	<span class="n">journal</span> <span class="o">=</span> <span class="n">journal_init_dev</span><span class="p">(</span><span class="n">bdev</span><span class="p">,</span> <span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_bdev</span><span class="p">,</span>
					<span class="n">start</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">blocksize</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">journal</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ext3_msg</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">KERN_ERR</span><span class="p">,</span>
			<span class="s">&quot;error: failed to create device journal&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_bdev</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">journal</span><span class="o">-&gt;</span><span class="n">j_private</span> <span class="o">=</span> <span class="n">sb</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bh_uptodate_or_lock</span><span class="p">(</span><span class="n">journal</span><span class="o">-&gt;</span><span class="n">j_sb_buffer</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bh_submit_read</span><span class="p">(</span><span class="n">journal</span><span class="o">-&gt;</span><span class="n">j_sb_buffer</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">ext3_msg</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">KERN_ERR</span><span class="p">,</span> <span class="s">&quot;I/O error on journal device&quot;</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">out_journal</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">journal</span><span class="o">-&gt;</span><span class="n">j_superblock</span><span class="o">-&gt;</span><span class="n">s_nr_users</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ext3_msg</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">KERN_ERR</span><span class="p">,</span>
			<span class="s">&quot;error: external journal has more than one &quot;</span>
			<span class="s">&quot;user (unsupported) - %d&quot;</span><span class="p">,</span>
			<span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">journal</span><span class="o">-&gt;</span><span class="n">j_superblock</span><span class="o">-&gt;</span><span class="n">s_nr_users</span><span class="p">));</span>
		<span class="k">goto</span> <span class="n">out_journal</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">EXT3_SB</span><span class="p">(</span><span class="n">sb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">journal_bdev</span> <span class="o">=</span> <span class="n">bdev</span><span class="p">;</span>
	<span class="n">ext3_init_journal_params</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">journal</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">journal</span><span class="p">;</span>
<span class="nl">out_journal:</span>
	<span class="n">journal_destroy</span><span class="p">(</span><span class="n">journal</span><span class="p">);</span>
<span class="nl">out_bdev:</span>
	<span class="n">ext3_blkdev_put</span><span class="p">(</span><span class="n">bdev</span><span class="p">);</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ext3_load_journal</span><span class="p">(</span><span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">sb</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">ext3_super_block</span> <span class="o">*</span><span class="n">es</span><span class="p">,</span>
			     <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">journal_devnum</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">journal_t</span> <span class="o">*</span><span class="n">journal</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">journal_inum</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">es</span><span class="o">-&gt;</span><span class="n">s_journal_inum</span><span class="p">);</span>
	<span class="n">dev_t</span> <span class="n">journal_dev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">really_read_only</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">journal_devnum</span> <span class="o">&amp;&amp;</span>
	    <span class="n">journal_devnum</span> <span class="o">!=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">es</span><span class="o">-&gt;</span><span class="n">s_journal_dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ext3_msg</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">KERN_INFO</span><span class="p">,</span> <span class="s">&quot;external journal device major/minor &quot;</span>
			<span class="s">&quot;numbers have changed&quot;</span><span class="p">);</span>
		<span class="n">journal_dev</span> <span class="o">=</span> <span class="n">new_decode_dev</span><span class="p">(</span><span class="n">journal_devnum</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">journal_dev</span> <span class="o">=</span> <span class="n">new_decode_dev</span><span class="p">(</span><span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">es</span><span class="o">-&gt;</span><span class="n">s_journal_dev</span><span class="p">));</span>

	<span class="n">really_read_only</span> <span class="o">=</span> <span class="n">bdev_read_only</span><span class="p">(</span><span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_bdev</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Are we loading a blank journal or performing recovery after a</span>
<span class="cm">	 * crash?  For recovery, we need to check in advance whether we</span>
<span class="cm">	 * can get read-write access to the device.</span>
<span class="cm">	 */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">EXT3_HAS_INCOMPAT_FEATURE</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">EXT3_FEATURE_INCOMPAT_RECOVER</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_flags</span> <span class="o">&amp;</span> <span class="n">MS_RDONLY</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ext3_msg</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">KERN_INFO</span><span class="p">,</span>
				<span class="s">&quot;recovery required on readonly filesystem&quot;</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">really_read_only</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ext3_msg</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">KERN_ERR</span><span class="p">,</span> <span class="s">&quot;error: write access &quot;</span>
					<span class="s">&quot;unavailable, cannot proceed&quot;</span><span class="p">);</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EROFS</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">ext3_msg</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">KERN_INFO</span><span class="p">,</span>
				<span class="s">&quot;write access will be enabled during recovery&quot;</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">journal_inum</span> <span class="o">&amp;&amp;</span> <span class="n">journal_dev</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ext3_msg</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">KERN_ERR</span><span class="p">,</span> <span class="s">&quot;error: filesystem has both journal &quot;</span>
		       <span class="s">&quot;and inode journals&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">journal_inum</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">journal</span> <span class="o">=</span> <span class="n">ext3_get_journal</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">journal_inum</span><span class="p">)))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">journal</span> <span class="o">=</span> <span class="n">ext3_get_dev_journal</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">journal_dev</span><span class="p">)))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">journal</span><span class="o">-&gt;</span><span class="n">j_flags</span> <span class="o">&amp;</span> <span class="n">JFS_BARRIER</span><span class="p">))</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;EXT3-fs: barriers not enabled</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">really_read_only</span> <span class="o">&amp;&amp;</span> <span class="n">test_opt</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">UPDATE_JOURNAL</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">journal_update_format</span><span class="p">(</span><span class="n">journal</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>  <span class="p">{</span>
			<span class="n">ext3_msg</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">KERN_ERR</span><span class="p">,</span> <span class="s">&quot;error updating journal&quot;</span><span class="p">);</span>
			<span class="n">journal_destroy</span><span class="p">(</span><span class="n">journal</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">EXT3_HAS_INCOMPAT_FEATURE</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">EXT3_FEATURE_INCOMPAT_RECOVER</span><span class="p">))</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">journal_wipe</span><span class="p">(</span><span class="n">journal</span><span class="p">,</span> <span class="o">!</span><span class="n">really_read_only</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span><span class="p">)</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">journal_load</span><span class="p">(</span><span class="n">journal</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ext3_msg</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">KERN_ERR</span><span class="p">,</span> <span class="s">&quot;error loading journal&quot;</span><span class="p">);</span>
		<span class="n">journal_destroy</span><span class="p">(</span><span class="n">journal</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">EXT3_SB</span><span class="p">(</span><span class="n">sb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">s_journal</span> <span class="o">=</span> <span class="n">journal</span><span class="p">;</span>
	<span class="n">ext3_clear_journal_err</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">es</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">really_read_only</span> <span class="o">&amp;&amp;</span> <span class="n">journal_devnum</span> <span class="o">&amp;&amp;</span>
	    <span class="n">journal_devnum</span> <span class="o">!=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">es</span><span class="o">-&gt;</span><span class="n">s_journal_dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">es</span><span class="o">-&gt;</span><span class="n">s_journal_dev</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">journal_devnum</span><span class="p">);</span>

		<span class="cm">/* Make sure we flush the recovery flag to disk. */</span>
		<span class="n">ext3_commit_super</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">es</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ext3_create_journal</span><span class="p">(</span><span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">sb</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">ext3_super_block</span> <span class="o">*</span><span class="n">es</span><span class="p">,</span>
			       <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">journal_inum</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">journal_t</span> <span class="o">*</span><span class="n">journal</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_flags</span> <span class="o">&amp;</span> <span class="n">MS_RDONLY</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ext3_msg</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">KERN_ERR</span><span class="p">,</span>
			<span class="s">&quot;error: readonly filesystem when trying to &quot;</span>
			<span class="s">&quot;create journal&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EROFS</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">journal</span> <span class="o">=</span> <span class="n">ext3_get_journal</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">journal_inum</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">journal</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">ext3_msg</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">KERN_INFO</span><span class="p">,</span> <span class="s">&quot;creating new journal on inode %u&quot;</span><span class="p">,</span>
	       <span class="n">journal_inum</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">journal_create</span><span class="p">(</span><span class="n">journal</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ext3_msg</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">KERN_ERR</span><span class="p">,</span> <span class="s">&quot;error creating journal&quot;</span><span class="p">);</span>
		<span class="n">journal_destroy</span><span class="p">(</span><span class="n">journal</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">EXT3_SB</span><span class="p">(</span><span class="n">sb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">s_journal</span> <span class="o">=</span> <span class="n">journal</span><span class="p">;</span>

	<span class="n">ext3_update_dynamic_rev</span><span class="p">(</span><span class="n">sb</span><span class="p">);</span>
	<span class="n">EXT3_SET_INCOMPAT_FEATURE</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">EXT3_FEATURE_INCOMPAT_RECOVER</span><span class="p">);</span>
	<span class="n">EXT3_SET_COMPAT_FEATURE</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">EXT3_FEATURE_COMPAT_HAS_JOURNAL</span><span class="p">);</span>

	<span class="n">es</span><span class="o">-&gt;</span><span class="n">s_journal_inum</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">journal_inum</span><span class="p">);</span>

	<span class="cm">/* Make sure we flush the recovery flag to disk. */</span>
	<span class="n">ext3_commit_super</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">es</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ext3_commit_super</span><span class="p">(</span><span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">sb</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">ext3_super_block</span> <span class="o">*</span><span class="n">es</span><span class="p">,</span>
			       <span class="kt">int</span> <span class="n">sync</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">buffer_head</span> <span class="o">*</span><span class="n">sbh</span> <span class="o">=</span> <span class="n">EXT3_SB</span><span class="p">(</span><span class="n">sb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">s_sbh</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">error</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sbh</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">error</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">buffer_write_io_error</span><span class="p">(</span><span class="n">sbh</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Oh, dear.  A previous attempt to write the</span>
<span class="cm">		 * superblock failed.  This could happen because the</span>
<span class="cm">		 * USB device was yanked out.  Or it could happen to</span>
<span class="cm">		 * be a transient write error and maybe the block will</span>
<span class="cm">		 * be remapped.  Nothing we can do but to retry the</span>
<span class="cm">		 * write and hope for the best.</span>
<span class="cm">		 */</span>
		<span class="n">ext3_msg</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">KERN_ERR</span><span class="p">,</span> <span class="s">&quot;previous I/O error to &quot;</span>
		       <span class="s">&quot;superblock detected&quot;</span><span class="p">);</span>
		<span class="n">clear_buffer_write_io_error</span><span class="p">(</span><span class="n">sbh</span><span class="p">);</span>
		<span class="n">set_buffer_uptodate</span><span class="p">(</span><span class="n">sbh</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="cm">/*</span>
<span class="cm">	 * If the file system is mounted read-only, don&#39;t update the</span>
<span class="cm">	 * superblock write time.  This avoids updating the superblock</span>
<span class="cm">	 * write time when we are mounting the root file system</span>
<span class="cm">	 * read/only but we need to replay the journal; at that point,</span>
<span class="cm">	 * for people who are east of GMT and who make their clock</span>
<span class="cm">	 * tick in localtime for Windows bug-for-bug compatibility,</span>
<span class="cm">	 * the clock is set in the future, and this will cause e2fsck</span>
<span class="cm">	 * to complain and force a full file system check.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_flags</span> <span class="o">&amp;</span> <span class="n">MS_RDONLY</span><span class="p">))</span>
		<span class="n">es</span><span class="o">-&gt;</span><span class="n">s_wtime</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">get_seconds</span><span class="p">());</span>
	<span class="n">es</span><span class="o">-&gt;</span><span class="n">s_free_blocks_count</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">ext3_count_free_blocks</span><span class="p">(</span><span class="n">sb</span><span class="p">));</span>
	<span class="n">es</span><span class="o">-&gt;</span><span class="n">s_free_inodes_count</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">ext3_count_free_inodes</span><span class="p">(</span><span class="n">sb</span><span class="p">));</span>
	<span class="n">BUFFER_TRACE</span><span class="p">(</span><span class="n">sbh</span><span class="p">,</span> <span class="s">&quot;marking dirty&quot;</span><span class="p">);</span>
	<span class="n">mark_buffer_dirty</span><span class="p">(</span><span class="n">sbh</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sync</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">error</span> <span class="o">=</span> <span class="n">sync_dirty_buffer</span><span class="p">(</span><span class="n">sbh</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">buffer_write_io_error</span><span class="p">(</span><span class="n">sbh</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">ext3_msg</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">KERN_ERR</span><span class="p">,</span> <span class="s">&quot;I/O error while writing &quot;</span>
			       <span class="s">&quot;superblock&quot;</span><span class="p">);</span>
			<span class="n">clear_buffer_write_io_error</span><span class="p">(</span><span class="n">sbh</span><span class="p">);</span>
			<span class="n">set_buffer_uptodate</span><span class="p">(</span><span class="n">sbh</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * Have we just finished recovery?  If so, and if we are mounting (or</span>
<span class="cm"> * remounting) the filesystem readonly, then we will end up with a</span>
<span class="cm"> * consistent fs on disk.  Record that fact.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ext3_mark_recovery_complete</span><span class="p">(</span><span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span> <span class="n">sb</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">ext3_super_block</span> <span class="o">*</span> <span class="n">es</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">journal_t</span> <span class="o">*</span><span class="n">journal</span> <span class="o">=</span> <span class="n">EXT3_SB</span><span class="p">(</span><span class="n">sb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">s_journal</span><span class="p">;</span>

	<span class="n">journal_lock_updates</span><span class="p">(</span><span class="n">journal</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">journal_flush</span><span class="p">(</span><span class="n">journal</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">EXT3_HAS_INCOMPAT_FEATURE</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">EXT3_FEATURE_INCOMPAT_RECOVER</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_flags</span> <span class="o">&amp;</span> <span class="n">MS_RDONLY</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">EXT3_CLEAR_INCOMPAT_FEATURE</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">EXT3_FEATURE_INCOMPAT_RECOVER</span><span class="p">);</span>
		<span class="n">ext3_commit_super</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">es</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>

<span class="nl">out:</span>
	<span class="n">journal_unlock_updates</span><span class="p">(</span><span class="n">journal</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * If we are mounting (or read-write remounting) a filesystem whose journal</span>
<span class="cm"> * has recorded an error from a previous lifetime, move that error to the</span>
<span class="cm"> * main filesystem now.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ext3_clear_journal_err</span><span class="p">(</span><span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">sb</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">ext3_super_block</span> <span class="o">*</span><span class="n">es</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">journal_t</span> <span class="o">*</span><span class="n">journal</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">j_errno</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">errstr</span><span class="p">;</span>

	<span class="n">journal</span> <span class="o">=</span> <span class="n">EXT3_SB</span><span class="p">(</span><span class="n">sb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">s_journal</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Now check for any error status which may have been recorded in the</span>
<span class="cm">	 * journal by a prior ext3_error() or ext3_abort()</span>
<span class="cm">	 */</span>

	<span class="n">j_errno</span> <span class="o">=</span> <span class="n">journal_errno</span><span class="p">(</span><span class="n">journal</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">j_errno</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">char</span> <span class="n">nbuf</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>

		<span class="n">errstr</span> <span class="o">=</span> <span class="n">ext3_decode_error</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">j_errno</span><span class="p">,</span> <span class="n">nbuf</span><span class="p">);</span>
		<span class="n">ext3_warning</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="s">&quot;Filesystem error recorded &quot;</span>
			     <span class="s">&quot;from previous mount: %s&quot;</span><span class="p">,</span> <span class="n">errstr</span><span class="p">);</span>
		<span class="n">ext3_warning</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="s">&quot;Marking fs in need of &quot;</span>
			     <span class="s">&quot;filesystem check.&quot;</span><span class="p">);</span>

		<span class="n">EXT3_SB</span><span class="p">(</span><span class="n">sb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">s_mount_state</span> <span class="o">|=</span> <span class="n">EXT3_ERROR_FS</span><span class="p">;</span>
		<span class="n">es</span><span class="o">-&gt;</span><span class="n">s_state</span> <span class="o">|=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">EXT3_ERROR_FS</span><span class="p">);</span>
		<span class="n">ext3_commit_super</span> <span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">es</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

		<span class="n">journal_clear_err</span><span class="p">(</span><span class="n">journal</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Force the running and committing transactions to commit,</span>
<span class="cm"> * and wait on the commit.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">ext3_force_commit</span><span class="p">(</span><span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">sb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">journal_t</span> <span class="o">*</span><span class="n">journal</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_flags</span> <span class="o">&amp;</span> <span class="n">MS_RDONLY</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">journal</span> <span class="o">=</span> <span class="n">EXT3_SB</span><span class="p">(</span><span class="n">sb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">s_journal</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">ext3_journal_force_commit</span><span class="p">(</span><span class="n">journal</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ext3_sync_fs</span><span class="p">(</span><span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">sb</span><span class="p">,</span> <span class="kt">int</span> <span class="n">wait</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">tid_t</span> <span class="n">target</span><span class="p">;</span>

	<span class="n">trace_ext3_sync_fs</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">wait</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">journal_start_commit</span><span class="p">(</span><span class="n">EXT3_SB</span><span class="p">(</span><span class="n">sb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">s_journal</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">target</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">wait</span><span class="p">)</span>
			<span class="n">log_wait_commit</span><span class="p">(</span><span class="n">EXT3_SB</span><span class="p">(</span><span class="n">sb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">s_journal</span><span class="p">,</span> <span class="n">target</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * LVM calls this function before a (read-only) snapshot is created.  This</span>
<span class="cm"> * gives us a chance to flush the journal completely and mark the fs clean.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ext3_freeze</span><span class="p">(</span><span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">sb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">error</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">journal_t</span> <span class="o">*</span><span class="n">journal</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_flags</span> <span class="o">&amp;</span> <span class="n">MS_RDONLY</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">journal</span> <span class="o">=</span> <span class="n">EXT3_SB</span><span class="p">(</span><span class="n">sb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">s_journal</span><span class="p">;</span>

		<span class="cm">/* Now we set up the journal barrier. */</span>
		<span class="n">journal_lock_updates</span><span class="p">(</span><span class="n">journal</span><span class="p">);</span>

		<span class="cm">/*</span>
<span class="cm">		 * We don&#39;t want to clear needs_recovery flag when we failed</span>
<span class="cm">		 * to flush the journal.</span>
<span class="cm">		 */</span>
		<span class="n">error</span> <span class="o">=</span> <span class="n">journal_flush</span><span class="p">(</span><span class="n">journal</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">error</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

		<span class="cm">/* Journal blocked and flushed, clear needs_recovery flag. */</span>
		<span class="n">EXT3_CLEAR_INCOMPAT_FEATURE</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">EXT3_FEATURE_INCOMPAT_RECOVER</span><span class="p">);</span>
		<span class="n">error</span> <span class="o">=</span> <span class="n">ext3_commit_super</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">EXT3_SB</span><span class="p">(</span><span class="n">sb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">s_es</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">out:</span>
	<span class="n">journal_unlock_updates</span><span class="p">(</span><span class="n">journal</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Called by LVM after the snapshot is done.  We need to reset the RECOVER</span>
<span class="cm"> * flag here, even though the filesystem is not technically dirty yet.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ext3_unfreeze</span><span class="p">(</span><span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">sb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_flags</span> <span class="o">&amp;</span> <span class="n">MS_RDONLY</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">lock_super</span><span class="p">(</span><span class="n">sb</span><span class="p">);</span>
		<span class="cm">/* Reser the needs_recovery flag before the fs is unlocked. */</span>
		<span class="n">EXT3_SET_INCOMPAT_FEATURE</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">EXT3_FEATURE_INCOMPAT_RECOVER</span><span class="p">);</span>
		<span class="n">ext3_commit_super</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">EXT3_SB</span><span class="p">(</span><span class="n">sb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">s_es</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">unlock_super</span><span class="p">(</span><span class="n">sb</span><span class="p">);</span>
		<span class="n">journal_unlock_updates</span><span class="p">(</span><span class="n">EXT3_SB</span><span class="p">(</span><span class="n">sb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">s_journal</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ext3_remount</span> <span class="p">(</span><span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span> <span class="n">sb</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span> <span class="n">flags</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ext3_super_block</span> <span class="o">*</span> <span class="n">es</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ext3_sb_info</span> <span class="o">*</span><span class="n">sbi</span> <span class="o">=</span> <span class="n">EXT3_SB</span><span class="p">(</span><span class="n">sb</span><span class="p">);</span>
	<span class="n">ext3_fsblk_t</span> <span class="n">n_blocks_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">old_sb_flags</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ext3_mount_options</span> <span class="n">old_opts</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">enable_quota</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
<span class="cp">#ifdef CONFIG_QUOTA</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="cm">/* Store the original options */</span>
	<span class="n">lock_super</span><span class="p">(</span><span class="n">sb</span><span class="p">);</span>
	<span class="n">old_sb_flags</span> <span class="o">=</span> <span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_flags</span><span class="p">;</span>
	<span class="n">old_opts</span><span class="p">.</span><span class="n">s_mount_opt</span> <span class="o">=</span> <span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_mount_opt</span><span class="p">;</span>
	<span class="n">old_opts</span><span class="p">.</span><span class="n">s_resuid</span> <span class="o">=</span> <span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_resuid</span><span class="p">;</span>
	<span class="n">old_opts</span><span class="p">.</span><span class="n">s_resgid</span> <span class="o">=</span> <span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_resgid</span><span class="p">;</span>
	<span class="n">old_opts</span><span class="p">.</span><span class="n">s_commit_interval</span> <span class="o">=</span> <span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_commit_interval</span><span class="p">;</span>
<span class="cp">#ifdef CONFIG_QUOTA</span>
	<span class="n">old_opts</span><span class="p">.</span><span class="n">s_jquota_fmt</span> <span class="o">=</span> <span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_jquota_fmt</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MAXQUOTAS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">old_opts</span><span class="p">.</span><span class="n">s_qf_names</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_qf_names</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
<span class="cp">#endif</span>

	<span class="cm">/*</span>
<span class="cm">	 * Allow the &quot;check&quot; option to be passed as a remount option.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">parse_options</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">sb</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">n_blocks_count</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">restore_opts</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_opt</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">ABORT</span><span class="p">))</span>
		<span class="n">ext3_abort</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="s">&quot;Abort forced by user&quot;</span><span class="p">);</span>

	<span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_flags</span> <span class="o">=</span> <span class="p">(</span><span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_flags</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">MS_POSIXACL</span><span class="p">)</span> <span class="o">|</span>
		<span class="p">(</span><span class="n">test_opt</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">POSIX_ACL</span><span class="p">)</span> <span class="o">?</span> <span class="n">MS_POSIXACL</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">es</span> <span class="o">=</span> <span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_es</span><span class="p">;</span>

	<span class="n">ext3_init_journal_params</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_journal</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="o">*</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MS_RDONLY</span><span class="p">)</span> <span class="o">!=</span> <span class="p">(</span><span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_flags</span> <span class="o">&amp;</span> <span class="n">MS_RDONLY</span><span class="p">)</span> <span class="o">||</span>
		<span class="n">n_blocks_count</span> <span class="o">&gt;</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">es</span><span class="o">-&gt;</span><span class="n">s_blocks_count</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">test_opt</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">ABORT</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EROFS</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">restore_opts</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MS_RDONLY</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">dquot_suspend</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">restore_opts</span><span class="p">;</span>

			<span class="cm">/*</span>
<span class="cm">			 * First of all, the unconditional stuff we have to do</span>
<span class="cm">			 * to disable replay of the journal when we next remount</span>
<span class="cm">			 */</span>
			<span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_flags</span> <span class="o">|=</span> <span class="n">MS_RDONLY</span><span class="p">;</span>

			<span class="cm">/*</span>
<span class="cm">			 * OK, test if we are remounting a valid rw partition</span>
<span class="cm">			 * readonly, and if so set the rdonly flag and then</span>
<span class="cm">			 * mark the partition as valid again.</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">es</span><span class="o">-&gt;</span><span class="n">s_state</span> <span class="o">&amp;</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">EXT3_VALID_FS</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
			    <span class="p">(</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_mount_state</span> <span class="o">&amp;</span> <span class="n">EXT3_VALID_FS</span><span class="p">))</span>
				<span class="n">es</span><span class="o">-&gt;</span><span class="n">s_state</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_mount_state</span><span class="p">);</span>

			<span class="n">ext3_mark_recovery_complete</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">es</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">__le32</span> <span class="n">ret</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">ret</span> <span class="o">=</span> <span class="n">EXT3_HAS_RO_COMPAT_FEATURE</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span>
					<span class="o">~</span><span class="n">EXT3_FEATURE_RO_COMPAT_SUPP</span><span class="p">)))</span> <span class="p">{</span>
				<span class="n">ext3_msg</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">KERN_WARNING</span><span class="p">,</span>
					<span class="s">&quot;warning: couldn&#39;t remount RDWR &quot;</span>
					<span class="s">&quot;because of unsupported optional &quot;</span>
					<span class="s">&quot;features (%x)&quot;</span><span class="p">,</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">ret</span><span class="p">));</span>
				<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EROFS</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">restore_opts</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="cm">/*</span>
<span class="cm">			 * If we have an unprocessed orphan list hanging</span>
<span class="cm">			 * around from a previously readonly bdev mount,</span>
<span class="cm">			 * require a full umount &amp; mount for now.</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">es</span><span class="o">-&gt;</span><span class="n">s_last_orphan</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ext3_msg</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">KERN_WARNING</span><span class="p">,</span> <span class="s">&quot;warning: couldn&#39;t &quot;</span>
				       <span class="s">&quot;remount RDWR because of unprocessed &quot;</span>
				       <span class="s">&quot;orphan inode list.  Please &quot;</span>
				       <span class="s">&quot;umount &amp; mount instead.&quot;</span><span class="p">);</span>
				<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">restore_opts</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="cm">/*</span>
<span class="cm">			 * Mounting a RDONLY partition read-write, so reread</span>
<span class="cm">			 * and store the current valid flag.  (It may have</span>
<span class="cm">			 * been changed by e2fsck since we originally mounted</span>
<span class="cm">			 * the partition.)</span>
<span class="cm">			 */</span>
			<span class="n">ext3_clear_journal_err</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">es</span><span class="p">);</span>
			<span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_mount_state</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">es</span><span class="o">-&gt;</span><span class="n">s_state</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">ext3_group_extend</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">es</span><span class="p">,</span> <span class="n">n_blocks_count</span><span class="p">)))</span>
				<span class="k">goto</span> <span class="n">restore_opts</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ext3_setup_super</span> <span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">es</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
				<span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">MS_RDONLY</span><span class="p">;</span>
			<span class="n">enable_quota</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="cp">#ifdef CONFIG_QUOTA</span>
	<span class="cm">/* Release old quota file names */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MAXQUOTAS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">old_opts</span><span class="p">.</span><span class="n">s_qf_names</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&amp;&amp;</span>
		    <span class="n">old_opts</span><span class="p">.</span><span class="n">s_qf_names</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_qf_names</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">old_opts</span><span class="p">.</span><span class="n">s_qf_names</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
<span class="cp">#endif</span>
	<span class="n">unlock_super</span><span class="p">(</span><span class="n">sb</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">enable_quota</span><span class="p">)</span>
		<span class="n">dquot_resume</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">restore_opts:</span>
	<span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_flags</span> <span class="o">=</span> <span class="n">old_sb_flags</span><span class="p">;</span>
	<span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_mount_opt</span> <span class="o">=</span> <span class="n">old_opts</span><span class="p">.</span><span class="n">s_mount_opt</span><span class="p">;</span>
	<span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_resuid</span> <span class="o">=</span> <span class="n">old_opts</span><span class="p">.</span><span class="n">s_resuid</span><span class="p">;</span>
	<span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_resgid</span> <span class="o">=</span> <span class="n">old_opts</span><span class="p">.</span><span class="n">s_resgid</span><span class="p">;</span>
	<span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_commit_interval</span> <span class="o">=</span> <span class="n">old_opts</span><span class="p">.</span><span class="n">s_commit_interval</span><span class="p">;</span>
<span class="cp">#ifdef CONFIG_QUOTA</span>
	<span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_jquota_fmt</span> <span class="o">=</span> <span class="n">old_opts</span><span class="p">.</span><span class="n">s_jquota_fmt</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MAXQUOTAS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_qf_names</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&amp;&amp;</span>
		    <span class="n">old_opts</span><span class="p">.</span><span class="n">s_qf_names</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_qf_names</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_qf_names</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_qf_names</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">old_opts</span><span class="p">.</span><span class="n">s_qf_names</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
	<span class="n">unlock_super</span><span class="p">(</span><span class="n">sb</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ext3_statfs</span> <span class="p">(</span><span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span> <span class="n">dentry</span><span class="p">,</span> <span class="k">struct</span> <span class="n">kstatfs</span> <span class="o">*</span> <span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">sb</span> <span class="o">=</span> <span class="n">dentry</span><span class="o">-&gt;</span><span class="n">d_sb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ext3_sb_info</span> <span class="o">*</span><span class="n">sbi</span> <span class="o">=</span> <span class="n">EXT3_SB</span><span class="p">(</span><span class="n">sb</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ext3_super_block</span> <span class="o">*</span><span class="n">es</span> <span class="o">=</span> <span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_es</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">fsid</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_opt</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">MINIX_DF</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_overhead_last</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_blocks_last</span> <span class="o">!=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">es</span><span class="o">-&gt;</span><span class="n">s_blocks_count</span><span class="p">))</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">ngroups</span> <span class="o">=</span> <span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_groups_count</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
		<span class="n">ext3_fsblk_t</span> <span class="n">overhead</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">smp_rmb</span><span class="p">();</span>

		<span class="cm">/*</span>
<span class="cm">		 * Compute the overhead (FS structures).  This is constant</span>
<span class="cm">		 * for a given filesystem unless the number of block groups</span>
<span class="cm">		 * changes so we cache the previous value until it does.</span>
<span class="cm">		 */</span>

		<span class="cm">/*</span>
<span class="cm">		 * All of the blocks before first_data_block are</span>
<span class="cm">		 * overhead</span>
<span class="cm">		 */</span>
		<span class="n">overhead</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">es</span><span class="o">-&gt;</span><span class="n">s_first_data_block</span><span class="p">);</span>

		<span class="cm">/*</span>
<span class="cm">		 * Add the overhead attributed to the superblock and</span>
<span class="cm">		 * block group descriptors.  If the sparse superblocks</span>
<span class="cm">		 * feature is turned on, then not all groups have this.</span>
<span class="cm">		 */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ngroups</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">overhead</span> <span class="o">+=</span> <span class="n">ext3_bg_has_super</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="o">+</span>
				<span class="n">ext3_bg_num_gdb</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
			<span class="n">cond_resched</span><span class="p">();</span>
		<span class="p">}</span>

		<span class="cm">/*</span>
<span class="cm">		 * Every block group has an inode bitmap, a block</span>
<span class="cm">		 * bitmap, and an inode table.</span>
<span class="cm">		 */</span>
		<span class="n">overhead</span> <span class="o">+=</span> <span class="n">ngroups</span> <span class="o">*</span> <span class="p">(</span><span class="mi">2</span> <span class="o">+</span> <span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_itb_per_group</span><span class="p">);</span>
		<span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_overhead_last</span> <span class="o">=</span> <span class="n">overhead</span><span class="p">;</span>
		<span class="n">smp_wmb</span><span class="p">();</span>
		<span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_blocks_last</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">es</span><span class="o">-&gt;</span><span class="n">s_blocks_count</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">buf</span><span class="o">-&gt;</span><span class="n">f_type</span> <span class="o">=</span> <span class="n">EXT3_SUPER_MAGIC</span><span class="p">;</span>
	<span class="n">buf</span><span class="o">-&gt;</span><span class="n">f_bsize</span> <span class="o">=</span> <span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_blocksize</span><span class="p">;</span>
	<span class="n">buf</span><span class="o">-&gt;</span><span class="n">f_blocks</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">es</span><span class="o">-&gt;</span><span class="n">s_blocks_count</span><span class="p">)</span> <span class="o">-</span> <span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_overhead_last</span><span class="p">;</span>
	<span class="n">buf</span><span class="o">-&gt;</span><span class="n">f_bfree</span> <span class="o">=</span> <span class="n">percpu_counter_sum_positive</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_freeblocks_counter</span><span class="p">);</span>
	<span class="n">buf</span><span class="o">-&gt;</span><span class="n">f_bavail</span> <span class="o">=</span> <span class="n">buf</span><span class="o">-&gt;</span><span class="n">f_bfree</span> <span class="o">-</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">es</span><span class="o">-&gt;</span><span class="n">s_r_blocks_count</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">f_bfree</span> <span class="o">&lt;</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">es</span><span class="o">-&gt;</span><span class="n">s_r_blocks_count</span><span class="p">))</span>
		<span class="n">buf</span><span class="o">-&gt;</span><span class="n">f_bavail</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">buf</span><span class="o">-&gt;</span><span class="n">f_files</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">es</span><span class="o">-&gt;</span><span class="n">s_inodes_count</span><span class="p">);</span>
	<span class="n">buf</span><span class="o">-&gt;</span><span class="n">f_ffree</span> <span class="o">=</span> <span class="n">percpu_counter_sum_positive</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_freeinodes_counter</span><span class="p">);</span>
	<span class="n">buf</span><span class="o">-&gt;</span><span class="n">f_namelen</span> <span class="o">=</span> <span class="n">EXT3_NAME_LEN</span><span class="p">;</span>
	<span class="n">fsid</span> <span class="o">=</span> <span class="n">le64_to_cpup</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">es</span><span class="o">-&gt;</span><span class="n">s_uuid</span><span class="p">)</span> <span class="o">^</span>
	       <span class="n">le64_to_cpup</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">es</span><span class="o">-&gt;</span><span class="n">s_uuid</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u64</span><span class="p">));</span>
	<span class="n">buf</span><span class="o">-&gt;</span><span class="n">f_fsid</span><span class="p">.</span><span class="n">val</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">fsid</span> <span class="o">&amp;</span> <span class="mh">0xFFFFFFFFUL</span><span class="p">;</span>
	<span class="n">buf</span><span class="o">-&gt;</span><span class="n">f_fsid</span><span class="p">.</span><span class="n">val</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">fsid</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFFFFFFFFUL</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Helper function for writing quotas on sync - we need to start transaction before quota file</span>
<span class="cm"> * is locked for write. Otherwise the are possible deadlocks:</span>
<span class="cm"> * Process 1                         Process 2</span>
<span class="cm"> * ext3_create()                     quota_sync()</span>
<span class="cm"> *   journal_start()                   write_dquot()</span>
<span class="cm"> *   dquot_initialize()                       down(dqio_mutex)</span>
<span class="cm"> *     down(dqio_mutex)                    journal_start()</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="cp">#ifdef CONFIG_QUOTA</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="nf">dquot_to_inode</span><span class="p">(</span><span class="k">struct</span> <span class="n">dquot</span> <span class="o">*</span><span class="n">dquot</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">sb_dqopt</span><span class="p">(</span><span class="n">dquot</span><span class="o">-&gt;</span><span class="n">dq_sb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">files</span><span class="p">[</span><span class="n">dquot</span><span class="o">-&gt;</span><span class="n">dq_type</span><span class="p">];</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ext3_write_dquot</span><span class="p">(</span><span class="k">struct</span> <span class="n">dquot</span> <span class="o">*</span><span class="n">dquot</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">,</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">handle_t</span> <span class="o">*</span><span class="n">handle</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">;</span>

	<span class="n">inode</span> <span class="o">=</span> <span class="n">dquot_to_inode</span><span class="p">(</span><span class="n">dquot</span><span class="p">);</span>
	<span class="n">handle</span> <span class="o">=</span> <span class="n">ext3_journal_start</span><span class="p">(</span><span class="n">inode</span><span class="p">,</span>
					<span class="n">EXT3_QUOTA_TRANS_BLOCKS</span><span class="p">(</span><span class="n">dquot</span><span class="o">-&gt;</span><span class="n">dq_sb</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">handle</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">handle</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">dquot_commit</span><span class="p">(</span><span class="n">dquot</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">ext3_journal_stop</span><span class="p">(</span><span class="n">handle</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ext3_acquire_dquot</span><span class="p">(</span><span class="k">struct</span> <span class="n">dquot</span> <span class="o">*</span><span class="n">dquot</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">,</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">handle_t</span> <span class="o">*</span><span class="n">handle</span><span class="p">;</span>

	<span class="n">handle</span> <span class="o">=</span> <span class="n">ext3_journal_start</span><span class="p">(</span><span class="n">dquot_to_inode</span><span class="p">(</span><span class="n">dquot</span><span class="p">),</span>
					<span class="n">EXT3_QUOTA_INIT_BLOCKS</span><span class="p">(</span><span class="n">dquot</span><span class="o">-&gt;</span><span class="n">dq_sb</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">handle</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">handle</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">dquot_acquire</span><span class="p">(</span><span class="n">dquot</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">ext3_journal_stop</span><span class="p">(</span><span class="n">handle</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ext3_release_dquot</span><span class="p">(</span><span class="k">struct</span> <span class="n">dquot</span> <span class="o">*</span><span class="n">dquot</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">,</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">handle_t</span> <span class="o">*</span><span class="n">handle</span><span class="p">;</span>

	<span class="n">handle</span> <span class="o">=</span> <span class="n">ext3_journal_start</span><span class="p">(</span><span class="n">dquot_to_inode</span><span class="p">(</span><span class="n">dquot</span><span class="p">),</span>
					<span class="n">EXT3_QUOTA_DEL_BLOCKS</span><span class="p">(</span><span class="n">dquot</span><span class="o">-&gt;</span><span class="n">dq_sb</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">handle</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* Release dquot anyway to avoid endless cycle in dqput() */</span>
		<span class="n">dquot_release</span><span class="p">(</span><span class="n">dquot</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">handle</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">dquot_release</span><span class="p">(</span><span class="n">dquot</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">ext3_journal_stop</span><span class="p">(</span><span class="n">handle</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ext3_mark_dquot_dirty</span><span class="p">(</span><span class="k">struct</span> <span class="n">dquot</span> <span class="o">*</span><span class="n">dquot</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Are we journaling quotas? */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">EXT3_SB</span><span class="p">(</span><span class="n">dquot</span><span class="o">-&gt;</span><span class="n">dq_sb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">s_qf_names</span><span class="p">[</span><span class="n">USRQUOTA</span><span class="p">]</span> <span class="o">||</span>
	    <span class="n">EXT3_SB</span><span class="p">(</span><span class="n">dquot</span><span class="o">-&gt;</span><span class="n">dq_sb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">s_qf_names</span><span class="p">[</span><span class="n">GRPQUOTA</span><span class="p">])</span> <span class="p">{</span>
		<span class="n">dquot_mark_dquot_dirty</span><span class="p">(</span><span class="n">dquot</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ext3_write_dquot</span><span class="p">(</span><span class="n">dquot</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">return</span> <span class="n">dquot_mark_dquot_dirty</span><span class="p">(</span><span class="n">dquot</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ext3_write_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">sb</span><span class="p">,</span> <span class="kt">int</span> <span class="n">type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">,</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">handle_t</span> <span class="o">*</span><span class="n">handle</span><span class="p">;</span>

	<span class="cm">/* Data block + inode block */</span>
	<span class="n">handle</span> <span class="o">=</span> <span class="n">ext3_journal_start</span><span class="p">(</span><span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_root</span><span class="o">-&gt;</span><span class="n">d_inode</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">handle</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">handle</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">dquot_commit_info</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">type</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">ext3_journal_stop</span><span class="p">(</span><span class="n">handle</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Turn on quotas during mount time - we need to find</span>
<span class="cm"> * the quota file and such...</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ext3_quota_on_mount</span><span class="p">(</span><span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">sb</span><span class="p">,</span> <span class="kt">int</span> <span class="n">type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">dquot_quota_on_mount</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">EXT3_SB</span><span class="p">(</span><span class="n">sb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">s_qf_names</span><span class="p">[</span><span class="n">type</span><span class="p">],</span>
					<span class="n">EXT3_SB</span><span class="p">(</span><span class="n">sb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">s_jquota_fmt</span><span class="p">,</span> <span class="n">type</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Standard function to be called on quota_on</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ext3_quota_on</span><span class="p">(</span><span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">sb</span><span class="p">,</span> <span class="kt">int</span> <span class="n">type</span><span class="p">,</span> <span class="kt">int</span> <span class="n">format_id</span><span class="p">,</span>
			 <span class="k">struct</span> <span class="n">path</span> <span class="o">*</span><span class="n">path</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_opt</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">QUOTA</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="cm">/* Quotafile not on the same filesystem? */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">path</span><span class="o">-&gt;</span><span class="n">dentry</span><span class="o">-&gt;</span><span class="n">d_sb</span> <span class="o">!=</span> <span class="n">sb</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EXDEV</span><span class="p">;</span>
	<span class="cm">/* Journaling quota? */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">EXT3_SB</span><span class="p">(</span><span class="n">sb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">s_qf_names</span><span class="p">[</span><span class="n">type</span><span class="p">])</span> <span class="p">{</span>
		<span class="cm">/* Quotafile not of fs root? */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">path</span><span class="o">-&gt;</span><span class="n">dentry</span><span class="o">-&gt;</span><span class="n">d_parent</span> <span class="o">!=</span> <span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_root</span><span class="p">)</span>
			<span class="n">ext3_msg</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">KERN_WARNING</span><span class="p">,</span>
				<span class="s">&quot;warning: Quota file not on filesystem root. &quot;</span>
				<span class="s">&quot;Journaled quota will not work.&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * When we journal data on quota file, we have to flush journal to see</span>
<span class="cm">	 * all updates to the file when we bypass pagecache...</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ext3_should_journal_data</span><span class="p">(</span><span class="n">path</span><span class="o">-&gt;</span><span class="n">dentry</span><span class="o">-&gt;</span><span class="n">d_inode</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * We don&#39;t need to lock updates but journal_flush() could</span>
<span class="cm">		 * otherwise be livelocked...</span>
<span class="cm">		 */</span>
		<span class="n">journal_lock_updates</span><span class="p">(</span><span class="n">EXT3_SB</span><span class="p">(</span><span class="n">sb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">s_journal</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">journal_flush</span><span class="p">(</span><span class="n">EXT3_SB</span><span class="p">(</span><span class="n">sb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">s_journal</span><span class="p">);</span>
		<span class="n">journal_unlock_updates</span><span class="p">(</span><span class="n">EXT3_SB</span><span class="p">(</span><span class="n">sb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">s_journal</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">dquot_quota_on</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">type</span><span class="p">,</span> <span class="n">format_id</span><span class="p">,</span> <span class="n">path</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Read data from quotafile - avoid pagecache and such because we cannot afford</span>
<span class="cm"> * acquiring the locks... As quota files are never truncated and quota code</span>
<span class="cm"> * itself serializes the operations (and no one else should touch the files)</span>
<span class="cm"> * we don&#39;t have to be afraid of races */</span>
<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">ext3_quota_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">sb</span><span class="p">,</span> <span class="kt">int</span> <span class="n">type</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span>
			       <span class="kt">size_t</span> <span class="n">len</span><span class="p">,</span> <span class="n">loff_t</span> <span class="n">off</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span> <span class="o">=</span> <span class="n">sb_dqopt</span><span class="p">(</span><span class="n">sb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">files</span><span class="p">[</span><span class="n">type</span><span class="p">];</span>
	<span class="n">sector_t</span> <span class="n">blk</span> <span class="o">=</span> <span class="n">off</span> <span class="o">&gt;&gt;</span> <span class="n">EXT3_BLOCK_SIZE_BITS</span><span class="p">(</span><span class="n">sb</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">offset</span> <span class="o">=</span> <span class="n">off</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_blocksize</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">tocopy</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">toread</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">buffer_head</span> <span class="o">*</span><span class="n">bh</span><span class="p">;</span>
	<span class="n">loff_t</span> <span class="n">i_size</span> <span class="o">=</span> <span class="n">i_size_read</span><span class="p">(</span><span class="n">inode</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">off</span> <span class="o">&gt;</span> <span class="n">i_size</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">off</span><span class="o">+</span><span class="n">len</span> <span class="o">&gt;</span> <span class="n">i_size</span><span class="p">)</span>
		<span class="n">len</span> <span class="o">=</span> <span class="n">i_size</span><span class="o">-</span><span class="n">off</span><span class="p">;</span>
	<span class="n">toread</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">toread</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tocopy</span> <span class="o">=</span> <span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_blocksize</span> <span class="o">-</span> <span class="n">offset</span> <span class="o">&lt;</span> <span class="n">toread</span> <span class="o">?</span>
				<span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_blocksize</span> <span class="o">-</span> <span class="n">offset</span> <span class="o">:</span> <span class="n">toread</span><span class="p">;</span>
		<span class="n">bh</span> <span class="o">=</span> <span class="n">ext3_bread</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">inode</span><span class="p">,</span> <span class="n">blk</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">err</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bh</span><span class="p">)</span>	<span class="cm">/* A hole? */</span>
			<span class="n">memset</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">tocopy</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">bh</span><span class="o">-&gt;</span><span class="n">b_data</span><span class="o">+</span><span class="n">offset</span><span class="p">,</span> <span class="n">tocopy</span><span class="p">);</span>
		<span class="n">brelse</span><span class="p">(</span><span class="n">bh</span><span class="p">);</span>
		<span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">toread</span> <span class="o">-=</span> <span class="n">tocopy</span><span class="p">;</span>
		<span class="n">data</span> <span class="o">+=</span> <span class="n">tocopy</span><span class="p">;</span>
		<span class="n">blk</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">len</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Write to quotafile (we know the transaction is already started and has</span>
<span class="cm"> * enough credits) */</span>
<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">ext3_quota_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">sb</span><span class="p">,</span> <span class="kt">int</span> <span class="n">type</span><span class="p">,</span>
				<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">len</span><span class="p">,</span> <span class="n">loff_t</span> <span class="n">off</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span> <span class="o">=</span> <span class="n">sb_dqopt</span><span class="p">(</span><span class="n">sb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">files</span><span class="p">[</span><span class="n">type</span><span class="p">];</span>
	<span class="n">sector_t</span> <span class="n">blk</span> <span class="o">=</span> <span class="n">off</span> <span class="o">&gt;&gt;</span> <span class="n">EXT3_BLOCK_SIZE_BITS</span><span class="p">(</span><span class="n">sb</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">offset</span> <span class="o">=</span> <span class="n">off</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_blocksize</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">journal_quota</span> <span class="o">=</span> <span class="n">EXT3_SB</span><span class="p">(</span><span class="n">sb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">s_qf_names</span><span class="p">[</span><span class="n">type</span><span class="p">]</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">buffer_head</span> <span class="o">*</span><span class="n">bh</span><span class="p">;</span>
	<span class="n">handle_t</span> <span class="o">*</span><span class="n">handle</span> <span class="o">=</span> <span class="n">journal_current_handle</span><span class="p">();</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">handle</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ext3_msg</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">KERN_WARNING</span><span class="p">,</span>
			<span class="s">&quot;warning: quota write (off=%llu, len=%llu)&quot;</span>
			<span class="s">&quot; cancelled because transaction is not started.&quot;</span><span class="p">,</span>
			<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">off</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">len</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Since we account only one data block in transaction credits,</span>
<span class="cm">	 * then it is impossible to cross a block boundary.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_blocksize</span> <span class="o">-</span> <span class="n">offset</span> <span class="o">&lt;</span> <span class="n">len</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ext3_msg</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">KERN_WARNING</span><span class="p">,</span> <span class="s">&quot;Quota write (off=%llu, len=%llu)&quot;</span>
			<span class="s">&quot; cancelled because not block aligned&quot;</span><span class="p">,</span>
			<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">off</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">len</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">bh</span> <span class="o">=</span> <span class="n">ext3_bread</span><span class="p">(</span><span class="n">handle</span><span class="p">,</span> <span class="n">inode</span><span class="p">,</span> <span class="n">blk</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">err</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bh</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">journal_quota</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">ext3_journal_get_write_access</span><span class="p">(</span><span class="n">handle</span><span class="p">,</span> <span class="n">bh</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">brelse</span><span class="p">(</span><span class="n">bh</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">lock_buffer</span><span class="p">(</span><span class="n">bh</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">bh</span><span class="o">-&gt;</span><span class="n">b_data</span><span class="o">+</span><span class="n">offset</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
	<span class="n">flush_dcache_page</span><span class="p">(</span><span class="n">bh</span><span class="o">-&gt;</span><span class="n">b_page</span><span class="p">);</span>
	<span class="n">unlock_buffer</span><span class="p">(</span><span class="n">bh</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">journal_quota</span><span class="p">)</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">ext3_journal_dirty_metadata</span><span class="p">(</span><span class="n">handle</span><span class="p">,</span> <span class="n">bh</span><span class="p">);</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* Always do at least ordered writes for quotas */</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">ext3_journal_dirty_data</span><span class="p">(</span><span class="n">handle</span><span class="p">,</span> <span class="n">bh</span><span class="p">);</span>
		<span class="n">mark_buffer_dirty</span><span class="p">(</span><span class="n">bh</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">brelse</span><span class="p">(</span><span class="n">bh</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_size</span> <span class="o">&lt;</span> <span class="n">off</span> <span class="o">+</span> <span class="n">len</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">i_size_write</span><span class="p">(</span><span class="n">inode</span><span class="p">,</span> <span class="n">off</span> <span class="o">+</span> <span class="n">len</span><span class="p">);</span>
		<span class="n">EXT3_I</span><span class="p">(</span><span class="n">inode</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">i_disksize</span> <span class="o">=</span> <span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_size</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_version</span><span class="o">++</span><span class="p">;</span>
	<span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_mtime</span> <span class="o">=</span> <span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_ctime</span> <span class="o">=</span> <span class="n">CURRENT_TIME</span><span class="p">;</span>
	<span class="n">ext3_mark_inode_dirty</span><span class="p">(</span><span class="n">handle</span><span class="p">,</span> <span class="n">inode</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">len</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#endif</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="nf">ext3_mount</span><span class="p">(</span><span class="k">struct</span> <span class="n">file_system_type</span> <span class="o">*</span><span class="n">fs_type</span><span class="p">,</span>
	<span class="kt">int</span> <span class="n">flags</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">dev_name</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">mount_bdev</span><span class="p">(</span><span class="n">fs_type</span><span class="p">,</span> <span class="n">flags</span><span class="p">,</span> <span class="n">dev_name</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">ext3_fill_super</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">file_system_type</span> <span class="n">ext3_fs_type</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span>		<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;ext3&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">mount</span>		<span class="o">=</span> <span class="n">ext3_mount</span><span class="p">,</span>
	<span class="p">.</span><span class="n">kill_sb</span>	<span class="o">=</span> <span class="n">kill_block_super</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fs_flags</span>	<span class="o">=</span> <span class="n">FS_REQUIRES_DEV</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">init_ext3_fs</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="n">init_ext3_xattr</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">init_inodecache</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out1</span><span class="p">;</span>
        <span class="n">err</span> <span class="o">=</span> <span class="n">register_filesystem</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ext3_fs_type</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">out:</span>
	<span class="n">destroy_inodecache</span><span class="p">();</span>
<span class="nl">out1:</span>
	<span class="n">exit_ext3_xattr</span><span class="p">();</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">exit_ext3_fs</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">unregister_filesystem</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ext3_fs_type</span><span class="p">);</span>
	<span class="n">destroy_inodecache</span><span class="p">();</span>
	<span class="n">exit_ext3_xattr</span><span class="p">();</span>
<span class="p">}</span>

<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Remy Card, Stephen Tweedie, Andrew Morton, Andreas Dilger, Theodore Ts&#39;o and others&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;Second Extended Filesystem with journaling extensions&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>
<span class="n">module_init</span><span class="p">(</span><span class="n">init_ext3_fs</span><span class="p">)</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">exit_ext3_fs</span><span class="p">)</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
