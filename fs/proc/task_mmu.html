<!DOCTYPE html>
<html><head><title>joekychen/linux » fs › proc › task_mmu.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>task_mmu.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cp">#include &lt;linux/mm.h&gt;</span>
<span class="cp">#include &lt;linux/hugetlb.h&gt;</span>
<span class="cp">#include &lt;linux/huge_mm.h&gt;</span>
<span class="cp">#include &lt;linux/mount.h&gt;</span>
<span class="cp">#include &lt;linux/seq_file.h&gt;</span>
<span class="cp">#include &lt;linux/highmem.h&gt;</span>
<span class="cp">#include &lt;linux/ptrace.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/pagemap.h&gt;</span>
<span class="cp">#include &lt;linux/mempolicy.h&gt;</span>
<span class="cp">#include &lt;linux/rmap.h&gt;</span>
<span class="cp">#include &lt;linux/swap.h&gt;</span>
<span class="cp">#include &lt;linux/swapops.h&gt;</span>

<span class="cp">#include &lt;asm/elf.h&gt;</span>
<span class="cp">#include &lt;asm/uaccess.h&gt;</span>
<span class="cp">#include &lt;asm/tlbflush.h&gt;</span>
<span class="cp">#include &quot;internal.h&quot;</span>

<span class="kt">void</span> <span class="nf">task_mem</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">m</span><span class="p">,</span> <span class="k">struct</span> <span class="n">mm_struct</span> <span class="o">*</span><span class="n">mm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">data</span><span class="p">,</span> <span class="n">text</span><span class="p">,</span> <span class="n">lib</span><span class="p">,</span> <span class="n">swap</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">hiwater_vm</span><span class="p">,</span> <span class="n">total_vm</span><span class="p">,</span> <span class="n">hiwater_rss</span><span class="p">,</span> <span class="n">total_rss</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Note: to minimize their overhead, mm maintains hiwater_vm and</span>
<span class="cm">	 * hiwater_rss only when about to *lower* total_vm or rss.  Any</span>
<span class="cm">	 * collector of these hiwater stats must therefore get total_vm</span>
<span class="cm">	 * and rss too, which will usually be the higher.  Barriers? not</span>
<span class="cm">	 * worth the effort, such snapshots can always be inconsistent.</span>
<span class="cm">	 */</span>
	<span class="n">hiwater_vm</span> <span class="o">=</span> <span class="n">total_vm</span> <span class="o">=</span> <span class="n">mm</span><span class="o">-&gt;</span><span class="n">total_vm</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hiwater_vm</span> <span class="o">&lt;</span> <span class="n">mm</span><span class="o">-&gt;</span><span class="n">hiwater_vm</span><span class="p">)</span>
		<span class="n">hiwater_vm</span> <span class="o">=</span> <span class="n">mm</span><span class="o">-&gt;</span><span class="n">hiwater_vm</span><span class="p">;</span>
	<span class="n">hiwater_rss</span> <span class="o">=</span> <span class="n">total_rss</span> <span class="o">=</span> <span class="n">get_mm_rss</span><span class="p">(</span><span class="n">mm</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hiwater_rss</span> <span class="o">&lt;</span> <span class="n">mm</span><span class="o">-&gt;</span><span class="n">hiwater_rss</span><span class="p">)</span>
		<span class="n">hiwater_rss</span> <span class="o">=</span> <span class="n">mm</span><span class="o">-&gt;</span><span class="n">hiwater_rss</span><span class="p">;</span>

	<span class="n">data</span> <span class="o">=</span> <span class="n">mm</span><span class="o">-&gt;</span><span class="n">total_vm</span> <span class="o">-</span> <span class="n">mm</span><span class="o">-&gt;</span><span class="n">shared_vm</span> <span class="o">-</span> <span class="n">mm</span><span class="o">-&gt;</span><span class="n">stack_vm</span><span class="p">;</span>
	<span class="n">text</span> <span class="o">=</span> <span class="p">(</span><span class="n">PAGE_ALIGN</span><span class="p">(</span><span class="n">mm</span><span class="o">-&gt;</span><span class="n">end_code</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="n">mm</span><span class="o">-&gt;</span><span class="n">start_code</span> <span class="o">&amp;</span> <span class="n">PAGE_MASK</span><span class="p">))</span> <span class="o">&gt;&gt;</span> <span class="mi">10</span><span class="p">;</span>
	<span class="n">lib</span> <span class="o">=</span> <span class="p">(</span><span class="n">mm</span><span class="o">-&gt;</span><span class="n">exec_vm</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">PAGE_SHIFT</span><span class="o">-</span><span class="mi">10</span><span class="p">))</span> <span class="o">-</span> <span class="n">text</span><span class="p">;</span>
	<span class="n">swap</span> <span class="o">=</span> <span class="n">get_mm_counter</span><span class="p">(</span><span class="n">mm</span><span class="p">,</span> <span class="n">MM_SWAPENTS</span><span class="p">);</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span>
		<span class="s">&quot;VmPeak:</span><span class="se">\t</span><span class="s">%8lu kB</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;VmSize:</span><span class="se">\t</span><span class="s">%8lu kB</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;VmLck:</span><span class="se">\t</span><span class="s">%8lu kB</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;VmPin:</span><span class="se">\t</span><span class="s">%8lu kB</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;VmHWM:</span><span class="se">\t</span><span class="s">%8lu kB</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;VmRSS:</span><span class="se">\t</span><span class="s">%8lu kB</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;VmData:</span><span class="se">\t</span><span class="s">%8lu kB</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;VmStk:</span><span class="se">\t</span><span class="s">%8lu kB</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;VmExe:</span><span class="se">\t</span><span class="s">%8lu kB</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;VmLib:</span><span class="se">\t</span><span class="s">%8lu kB</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;VmPTE:</span><span class="se">\t</span><span class="s">%8lu kB</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;VmSwap:</span><span class="se">\t</span><span class="s">%8lu kB</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">hiwater_vm</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">PAGE_SHIFT</span><span class="o">-</span><span class="mi">10</span><span class="p">),</span>
		<span class="p">(</span><span class="n">total_vm</span> <span class="o">-</span> <span class="n">mm</span><span class="o">-&gt;</span><span class="n">reserved_vm</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">PAGE_SHIFT</span><span class="o">-</span><span class="mi">10</span><span class="p">),</span>
		<span class="n">mm</span><span class="o">-&gt;</span><span class="n">locked_vm</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">PAGE_SHIFT</span><span class="o">-</span><span class="mi">10</span><span class="p">),</span>
		<span class="n">mm</span><span class="o">-&gt;</span><span class="n">pinned_vm</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">PAGE_SHIFT</span><span class="o">-</span><span class="mi">10</span><span class="p">),</span>
		<span class="n">hiwater_rss</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">PAGE_SHIFT</span><span class="o">-</span><span class="mi">10</span><span class="p">),</span>
		<span class="n">total_rss</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">PAGE_SHIFT</span><span class="o">-</span><span class="mi">10</span><span class="p">),</span>
		<span class="n">data</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">PAGE_SHIFT</span><span class="o">-</span><span class="mi">10</span><span class="p">),</span>
		<span class="n">mm</span><span class="o">-&gt;</span><span class="n">stack_vm</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">PAGE_SHIFT</span><span class="o">-</span><span class="mi">10</span><span class="p">),</span> <span class="n">text</span><span class="p">,</span> <span class="n">lib</span><span class="p">,</span>
		<span class="p">(</span><span class="n">PTRS_PER_PTE</span><span class="o">*</span><span class="k">sizeof</span><span class="p">(</span><span class="n">pte_t</span><span class="p">)</span><span class="o">*</span><span class="n">mm</span><span class="o">-&gt;</span><span class="n">nr_ptes</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">10</span><span class="p">,</span>
		<span class="n">swap</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">PAGE_SHIFT</span><span class="o">-</span><span class="mi">10</span><span class="p">));</span>
<span class="p">}</span>

<span class="kt">unsigned</span> <span class="kt">long</span> <span class="nf">task_vsize</span><span class="p">(</span><span class="k">struct</span> <span class="n">mm_struct</span> <span class="o">*</span><span class="n">mm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">PAGE_SIZE</span> <span class="o">*</span> <span class="n">mm</span><span class="o">-&gt;</span><span class="n">total_vm</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">unsigned</span> <span class="kt">long</span> <span class="nf">task_statm</span><span class="p">(</span><span class="k">struct</span> <span class="n">mm_struct</span> <span class="o">*</span><span class="n">mm</span><span class="p">,</span>
			 <span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">shared</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">text</span><span class="p">,</span>
			 <span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">resident</span><span class="p">)</span>
<span class="p">{</span>
	<span class="o">*</span><span class="n">shared</span> <span class="o">=</span> <span class="n">get_mm_counter</span><span class="p">(</span><span class="n">mm</span><span class="p">,</span> <span class="n">MM_FILEPAGES</span><span class="p">);</span>
	<span class="o">*</span><span class="n">text</span> <span class="o">=</span> <span class="p">(</span><span class="n">PAGE_ALIGN</span><span class="p">(</span><span class="n">mm</span><span class="o">-&gt;</span><span class="n">end_code</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="n">mm</span><span class="o">-&gt;</span><span class="n">start_code</span> <span class="o">&amp;</span> <span class="n">PAGE_MASK</span><span class="p">))</span>
								<span class="o">&gt;&gt;</span> <span class="n">PAGE_SHIFT</span><span class="p">;</span>
	<span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">mm</span><span class="o">-&gt;</span><span class="n">total_vm</span> <span class="o">-</span> <span class="n">mm</span><span class="o">-&gt;</span><span class="n">shared_vm</span><span class="p">;</span>
	<span class="o">*</span><span class="n">resident</span> <span class="o">=</span> <span class="o">*</span><span class="n">shared</span> <span class="o">+</span> <span class="n">get_mm_counter</span><span class="p">(</span><span class="n">mm</span><span class="p">,</span> <span class="n">MM_ANONPAGES</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">mm</span><span class="o">-&gt;</span><span class="n">total_vm</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">pad_len_spaces</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">m</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">len</span> <span class="o">=</span> <span class="mi">25</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">void</span><span class="o">*</span><span class="p">)</span> <span class="o">*</span> <span class="mi">6</span> <span class="o">-</span> <span class="n">len</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">len</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;%*c&quot;</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="sc">&#39; &#39;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">vma_stop</span><span class="p">(</span><span class="k">struct</span> <span class="n">proc_maps_private</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="k">struct</span> <span class="n">vm_area_struct</span> <span class="o">*</span><span class="n">vma</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vma</span> <span class="o">&amp;&amp;</span> <span class="n">vma</span> <span class="o">!=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">tail_vma</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">mm_struct</span> <span class="o">*</span><span class="n">mm</span> <span class="o">=</span> <span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_mm</span><span class="p">;</span>
		<span class="n">up_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mm</span><span class="o">-&gt;</span><span class="n">mmap_sem</span><span class="p">);</span>
		<span class="n">mmput</span><span class="p">(</span><span class="n">mm</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="o">*</span><span class="nf">m_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">m</span><span class="p">,</span> <span class="n">loff_t</span> <span class="o">*</span><span class="n">pos</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">proc_maps_private</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">last_addr</span> <span class="o">=</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">version</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mm_struct</span> <span class="o">*</span><span class="n">mm</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">vm_area_struct</span> <span class="o">*</span><span class="n">vma</span><span class="p">,</span> <span class="o">*</span><span class="n">tail_vma</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">loff_t</span> <span class="n">l</span> <span class="o">=</span> <span class="o">*</span><span class="n">pos</span><span class="p">;</span>

	<span class="cm">/* Clear the per syscall fields in priv */</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">task</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">tail_vma</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * We remember last_addr rather than next_addr to hit with</span>
<span class="cm">	 * mmap_cache most of the time. We have zero last_addr at</span>
<span class="cm">	 * the beginning and also after lseek. We will have -1 last_addr</span>
<span class="cm">	 * after the end of the vmas.</span>
<span class="cm">	 */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">last_addr</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1UL</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">task</span> <span class="o">=</span> <span class="n">get_pid_task</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">,</span> <span class="n">PIDTYPE_PID</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">task</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">ESRCH</span><span class="p">);</span>

	<span class="n">mm</span> <span class="o">=</span> <span class="n">mm_access</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">task</span><span class="p">,</span> <span class="n">PTRACE_MODE_READ</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mm</span> <span class="o">||</span> <span class="n">IS_ERR</span><span class="p">(</span><span class="n">mm</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">mm</span><span class="p">;</span>
	<span class="n">down_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mm</span><span class="o">-&gt;</span><span class="n">mmap_sem</span><span class="p">);</span>

	<span class="n">tail_vma</span> <span class="o">=</span> <span class="n">get_gate_vma</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">task</span><span class="o">-&gt;</span><span class="n">mm</span><span class="p">);</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">tail_vma</span> <span class="o">=</span> <span class="n">tail_vma</span><span class="p">;</span>

	<span class="cm">/* Start with last addr hint */</span>
	<span class="n">vma</span> <span class="o">=</span> <span class="n">find_vma</span><span class="p">(</span><span class="n">mm</span><span class="p">,</span> <span class="n">last_addr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">last_addr</span> <span class="o">&amp;&amp;</span> <span class="n">vma</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">vma</span> <span class="o">=</span> <span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_next</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Check the vma index is within the range and do</span>
<span class="cm">	 * sequential scan until m_index.</span>
<span class="cm">	 */</span>
	<span class="n">vma</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">l</span> <span class="o">&lt;</span> <span class="n">mm</span><span class="o">-&gt;</span><span class="n">map_count</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">vma</span> <span class="o">=</span> <span class="n">mm</span><span class="o">-&gt;</span><span class="n">mmap</span><span class="p">;</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">l</span><span class="o">--</span> <span class="o">&amp;&amp;</span> <span class="n">vma</span><span class="p">)</span>
			<span class="n">vma</span> <span class="o">=</span> <span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_next</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">l</span> <span class="o">!=</span> <span class="n">mm</span><span class="o">-&gt;</span><span class="n">map_count</span><span class="p">)</span>
		<span class="n">tail_vma</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span> <span class="cm">/* After gate vma */</span>

<span class="nl">out:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vma</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">vma</span><span class="p">;</span>

	<span class="cm">/* End of vmas has been reached */</span>
	<span class="n">m</span><span class="o">-&gt;</span><span class="n">version</span> <span class="o">=</span> <span class="p">(</span><span class="n">tail_vma</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span><span class="o">?</span> <span class="mi">0</span><span class="o">:</span> <span class="o">-</span><span class="mi">1UL</span><span class="p">;</span>
	<span class="n">up_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mm</span><span class="o">-&gt;</span><span class="n">mmap_sem</span><span class="p">);</span>
	<span class="n">mmput</span><span class="p">(</span><span class="n">mm</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">tail_vma</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="o">*</span><span class="nf">m_next</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">m</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">v</span><span class="p">,</span> <span class="n">loff_t</span> <span class="o">*</span><span class="n">pos</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">proc_maps_private</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">vm_area_struct</span> <span class="o">*</span><span class="n">vma</span> <span class="o">=</span> <span class="n">v</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">vm_area_struct</span> <span class="o">*</span><span class="n">tail_vma</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">tail_vma</span><span class="p">;</span>

	<span class="p">(</span><span class="o">*</span><span class="n">pos</span><span class="p">)</span><span class="o">++</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vma</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">vma</span> <span class="o">!=</span> <span class="n">tail_vma</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_next</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_next</span><span class="p">;</span>
	<span class="n">vma_stop</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">vma</span><span class="p">);</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">vma</span> <span class="o">!=</span> <span class="n">tail_vma</span><span class="p">)</span><span class="o">?</span> <span class="n">tail_vma</span><span class="o">:</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">m_stop</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">m</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">v</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">proc_maps_private</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">vm_area_struct</span> <span class="o">*</span><span class="n">vma</span> <span class="o">=</span> <span class="n">v</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">vma</span><span class="p">))</span>
		<span class="n">vma_stop</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">vma</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">task</span><span class="p">)</span>
		<span class="n">put_task_struct</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">task</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">do_maps_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span>
			<span class="k">const</span> <span class="k">struct</span> <span class="n">seq_operations</span> <span class="o">*</span><span class="n">ops</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">proc_maps_private</span> <span class="o">*</span><span class="n">priv</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">priv</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">priv</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">pid</span> <span class="o">=</span> <span class="n">proc_pid</span><span class="p">(</span><span class="n">inode</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">seq_open</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">ops</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">m</span> <span class="o">=</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
			<span class="n">m</span><span class="o">-&gt;</span><span class="n">private</span> <span class="o">=</span> <span class="n">priv</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">show_map_vma</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">m</span><span class="p">,</span> <span class="k">struct</span> <span class="n">vm_area_struct</span> <span class="o">*</span><span class="n">vma</span><span class="p">,</span> <span class="kt">int</span> <span class="n">is_pid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mm_struct</span> <span class="o">*</span><span class="n">mm</span> <span class="o">=</span> <span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_mm</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span> <span class="o">=</span> <span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_file</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">proc_maps_private</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">task_struct</span> <span class="o">*</span><span class="n">task</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">task</span><span class="p">;</span>
	<span class="n">vm_flags_t</span> <span class="n">flags</span> <span class="o">=</span> <span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_flags</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">ino</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">pgoff</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">;</span>
	<span class="n">dev_t</span> <span class="n">dev</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">len</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">file</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span> <span class="o">=</span> <span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_file</span><span class="o">-&gt;</span><span class="n">f_path</span><span class="p">.</span><span class="n">dentry</span><span class="o">-&gt;</span><span class="n">d_inode</span><span class="p">;</span>
		<span class="n">dev</span> <span class="o">=</span> <span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_sb</span><span class="o">-&gt;</span><span class="n">s_dev</span><span class="p">;</span>
		<span class="n">ino</span> <span class="o">=</span> <span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_ino</span><span class="p">;</span>
		<span class="n">pgoff</span> <span class="o">=</span> <span class="p">((</span><span class="n">loff_t</span><span class="p">)</span><span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_pgoff</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">PAGE_SHIFT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* We don&#39;t show the stack guard page in /proc/maps */</span>
	<span class="n">start</span> <span class="o">=</span> <span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_start</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">stack_guard_page_start</span><span class="p">(</span><span class="n">vma</span><span class="p">,</span> <span class="n">start</span><span class="p">))</span>
		<span class="n">start</span> <span class="o">+=</span> <span class="n">PAGE_SIZE</span><span class="p">;</span>
	<span class="n">end</span> <span class="o">=</span> <span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_end</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">stack_guard_page_end</span><span class="p">(</span><span class="n">vma</span><span class="p">,</span> <span class="n">end</span><span class="p">))</span>
		<span class="n">end</span> <span class="o">-=</span> <span class="n">PAGE_SIZE</span><span class="p">;</span>

	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;%08lx-%08lx %c%c%c%c %08llx %02x:%02x %lu %n&quot;</span><span class="p">,</span>
			<span class="n">start</span><span class="p">,</span>
			<span class="n">end</span><span class="p">,</span>
			<span class="n">flags</span> <span class="o">&amp;</span> <span class="n">VM_READ</span> <span class="o">?</span> <span class="sc">&#39;r&#39;</span> <span class="o">:</span> <span class="sc">&#39;-&#39;</span><span class="p">,</span>
			<span class="n">flags</span> <span class="o">&amp;</span> <span class="n">VM_WRITE</span> <span class="o">?</span> <span class="sc">&#39;w&#39;</span> <span class="o">:</span> <span class="sc">&#39;-&#39;</span><span class="p">,</span>
			<span class="n">flags</span> <span class="o">&amp;</span> <span class="n">VM_EXEC</span> <span class="o">?</span> <span class="sc">&#39;x&#39;</span> <span class="o">:</span> <span class="sc">&#39;-&#39;</span><span class="p">,</span>
			<span class="n">flags</span> <span class="o">&amp;</span> <span class="n">VM_MAYSHARE</span> <span class="o">?</span> <span class="sc">&#39;s&#39;</span> <span class="o">:</span> <span class="sc">&#39;p&#39;</span><span class="p">,</span>
			<span class="n">pgoff</span><span class="p">,</span>
			<span class="n">MAJOR</span><span class="p">(</span><span class="n">dev</span><span class="p">),</span> <span class="n">MINOR</span><span class="p">(</span><span class="n">dev</span><span class="p">),</span> <span class="n">ino</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">len</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Print the dentry name for named mappings, and a</span>
<span class="cm">	 * special [heap] marker for the heap:</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">file</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pad_len_spaces</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
		<span class="n">seq_path</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">file</span><span class="o">-&gt;</span><span class="n">f_path</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">name</span> <span class="o">=</span> <span class="n">arch_vma_name</span><span class="p">(</span><span class="n">vma</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">name</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pid_t</span> <span class="n">tid</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mm</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">name</span> <span class="o">=</span> <span class="s">&quot;[vdso]&quot;</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_start</span> <span class="o">&lt;=</span> <span class="n">mm</span><span class="o">-&gt;</span><span class="n">brk</span> <span class="o">&amp;&amp;</span>
		    <span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_end</span> <span class="o">&gt;=</span> <span class="n">mm</span><span class="o">-&gt;</span><span class="n">start_brk</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">name</span> <span class="o">=</span> <span class="s">&quot;[heap]&quot;</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">tid</span> <span class="o">=</span> <span class="n">vm_is_stack</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="n">vma</span><span class="p">,</span> <span class="n">is_pid</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">tid</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * Thread stack in /proc/PID/task/TID/maps or</span>
<span class="cm">			 * the main process stack.</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_pid</span> <span class="o">||</span> <span class="p">(</span><span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_start</span> <span class="o">&lt;=</span> <span class="n">mm</span><span class="o">-&gt;</span><span class="n">start_stack</span> <span class="o">&amp;&amp;</span>
			    <span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_end</span> <span class="o">&gt;=</span> <span class="n">mm</span><span class="o">-&gt;</span><span class="n">start_stack</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">name</span> <span class="o">=</span> <span class="s">&quot;[stack]&quot;</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="cm">/* Thread stack in /proc/PID/maps */</span>
				<span class="n">pad_len_spaces</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
				<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;[stack:%d]&quot;</span><span class="p">,</span> <span class="n">tid</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

<span class="nl">done:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">name</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pad_len_spaces</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
		<span class="n">seq_puts</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">seq_putc</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="sc">&#39;\n&#39;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">show_map</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">m</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">v</span><span class="p">,</span> <span class="kt">int</span> <span class="n">is_pid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">vm_area_struct</span> <span class="o">*</span><span class="n">vma</span> <span class="o">=</span> <span class="n">v</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">proc_maps_private</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">task_struct</span> <span class="o">*</span><span class="n">task</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">task</span><span class="p">;</span>

	<span class="n">show_map_vma</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">vma</span><span class="p">,</span> <span class="n">is_pid</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">&lt;</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">)</span>  <span class="cm">/* vma is copied successfully */</span>
		<span class="n">m</span><span class="o">-&gt;</span><span class="n">version</span> <span class="o">=</span> <span class="p">(</span><span class="n">vma</span> <span class="o">!=</span> <span class="n">get_gate_vma</span><span class="p">(</span><span class="n">task</span><span class="o">-&gt;</span><span class="n">mm</span><span class="p">))</span>
			<span class="o">?</span> <span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_start</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">show_pid_map</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">m</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">v</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">show_map</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">show_tid_map</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">m</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">v</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">show_map</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">seq_operations</span> <span class="n">proc_pid_maps_op</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">start</span>	<span class="o">=</span> <span class="n">m_start</span><span class="p">,</span>
	<span class="p">.</span><span class="n">next</span>	<span class="o">=</span> <span class="n">m_next</span><span class="p">,</span>
	<span class="p">.</span><span class="n">stop</span>	<span class="o">=</span> <span class="n">m_stop</span><span class="p">,</span>
	<span class="p">.</span><span class="n">show</span>	<span class="o">=</span> <span class="n">show_pid_map</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">seq_operations</span> <span class="n">proc_tid_maps_op</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">start</span>	<span class="o">=</span> <span class="n">m_start</span><span class="p">,</span>
	<span class="p">.</span><span class="n">next</span>	<span class="o">=</span> <span class="n">m_next</span><span class="p">,</span>
	<span class="p">.</span><span class="n">stop</span>	<span class="o">=</span> <span class="n">m_stop</span><span class="p">,</span>
	<span class="p">.</span><span class="n">show</span>	<span class="o">=</span> <span class="n">show_tid_map</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pid_maps_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">do_maps_open</span><span class="p">(</span><span class="n">inode</span><span class="p">,</span> <span class="n">file</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">proc_pid_maps_op</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tid_maps_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">do_maps_open</span><span class="p">(</span><span class="n">inode</span><span class="p">,</span> <span class="n">file</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">proc_tid_maps_op</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">const</span> <span class="k">struct</span> <span class="n">file_operations</span> <span class="n">proc_pid_maps_operations</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">open</span>		<span class="o">=</span> <span class="n">pid_maps_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read</span>		<span class="o">=</span> <span class="n">seq_read</span><span class="p">,</span>
	<span class="p">.</span><span class="n">llseek</span>		<span class="o">=</span> <span class="n">seq_lseek</span><span class="p">,</span>
	<span class="p">.</span><span class="n">release</span>	<span class="o">=</span> <span class="n">seq_release_private</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">const</span> <span class="k">struct</span> <span class="n">file_operations</span> <span class="n">proc_tid_maps_operations</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">open</span>		<span class="o">=</span> <span class="n">tid_maps_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read</span>		<span class="o">=</span> <span class="n">seq_read</span><span class="p">,</span>
	<span class="p">.</span><span class="n">llseek</span>		<span class="o">=</span> <span class="n">seq_lseek</span><span class="p">,</span>
	<span class="p">.</span><span class="n">release</span>	<span class="o">=</span> <span class="n">seq_release_private</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * Proportional Set Size(PSS): my share of RSS.</span>
<span class="cm"> *</span>
<span class="cm"> * PSS of a process is the count of pages it has in memory, where each</span>
<span class="cm"> * page is divided by the number of processes sharing it.  So if a</span>
<span class="cm"> * process has 1000 pages all to itself, and 1000 shared with one other</span>
<span class="cm"> * process, its PSS will be 1500.</span>
<span class="cm"> *</span>
<span class="cm"> * To keep (accumulated) division errors low, we adopt a 64bit</span>
<span class="cm"> * fixed-point pss counter to minimize division errors. So (pss &gt;&gt;</span>
<span class="cm"> * PSS_SHIFT) would be the real byte count.</span>
<span class="cm"> *</span>
<span class="cm"> * A shift of 12 before division means (assuming 4K page size):</span>
<span class="cm"> * 	- 1M 3-user-pages add up to 8KB errors;</span>
<span class="cm"> * 	- supports mapcount up to 2^24, or 16M;</span>
<span class="cm"> * 	- supports PSS up to 2^52 bytes, or 4PB.</span>
<span class="cm"> */</span>
<span class="cp">#define PSS_SHIFT 12</span>

<span class="cp">#ifdef CONFIG_PROC_PAGE_MONITOR</span>
<span class="k">struct</span> <span class="n">mem_size_stats</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">vm_area_struct</span> <span class="o">*</span><span class="n">vma</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">resident</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">shared_clean</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">shared_dirty</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">private_clean</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">private_dirty</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">referenced</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">anonymous</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">anonymous_thp</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">swap</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">nonlinear</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">pss</span><span class="p">;</span>
<span class="p">};</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">smaps_pte_entry</span><span class="p">(</span><span class="n">pte_t</span> <span class="n">ptent</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">addr</span><span class="p">,</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">ptent_size</span><span class="p">,</span> <span class="k">struct</span> <span class="n">mm_walk</span> <span class="o">*</span><span class="n">walk</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mem_size_stats</span> <span class="o">*</span><span class="n">mss</span> <span class="o">=</span> <span class="n">walk</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">vm_area_struct</span> <span class="o">*</span><span class="n">vma</span> <span class="o">=</span> <span class="n">mss</span><span class="o">-&gt;</span><span class="n">vma</span><span class="p">;</span>
	<span class="n">pgoff_t</span> <span class="n">pgoff</span> <span class="o">=</span> <span class="n">linear_page_index</span><span class="p">(</span><span class="n">vma</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="n">page</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">mapcount</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pte_present</span><span class="p">(</span><span class="n">ptent</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">page</span> <span class="o">=</span> <span class="n">vm_normal_page</span><span class="p">(</span><span class="n">vma</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">ptent</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">is_swap_pte</span><span class="p">(</span><span class="n">ptent</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">swp_entry_t</span> <span class="n">swpent</span> <span class="o">=</span> <span class="n">pte_to_swp_entry</span><span class="p">(</span><span class="n">ptent</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">non_swap_entry</span><span class="p">(</span><span class="n">swpent</span><span class="p">))</span>
			<span class="n">mss</span><span class="o">-&gt;</span><span class="n">swap</span> <span class="o">+=</span> <span class="n">ptent_size</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">is_migration_entry</span><span class="p">(</span><span class="n">swpent</span><span class="p">))</span>
			<span class="n">page</span> <span class="o">=</span> <span class="n">migration_entry_to_page</span><span class="p">(</span><span class="n">swpent</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">pte_file</span><span class="p">(</span><span class="n">ptent</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pte_to_pgoff</span><span class="p">(</span><span class="n">ptent</span><span class="p">)</span> <span class="o">!=</span> <span class="n">pgoff</span><span class="p">)</span>
			<span class="n">mss</span><span class="o">-&gt;</span><span class="n">nonlinear</span> <span class="o">+=</span> <span class="n">ptent_size</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">page</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">PageAnon</span><span class="p">(</span><span class="n">page</span><span class="p">))</span>
		<span class="n">mss</span><span class="o">-&gt;</span><span class="n">anonymous</span> <span class="o">+=</span> <span class="n">ptent_size</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">page</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">!=</span> <span class="n">pgoff</span><span class="p">)</span>
		<span class="n">mss</span><span class="o">-&gt;</span><span class="n">nonlinear</span> <span class="o">+=</span> <span class="n">ptent_size</span><span class="p">;</span>

	<span class="n">mss</span><span class="o">-&gt;</span><span class="n">resident</span> <span class="o">+=</span> <span class="n">ptent_size</span><span class="p">;</span>
	<span class="cm">/* Accumulate the size in pages that have been accessed. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pte_young</span><span class="p">(</span><span class="n">ptent</span><span class="p">)</span> <span class="o">||</span> <span class="n">PageReferenced</span><span class="p">(</span><span class="n">page</span><span class="p">))</span>
		<span class="n">mss</span><span class="o">-&gt;</span><span class="n">referenced</span> <span class="o">+=</span> <span class="n">ptent_size</span><span class="p">;</span>
	<span class="n">mapcount</span> <span class="o">=</span> <span class="n">page_mapcount</span><span class="p">(</span><span class="n">page</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mapcount</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pte_dirty</span><span class="p">(</span><span class="n">ptent</span><span class="p">)</span> <span class="o">||</span> <span class="n">PageDirty</span><span class="p">(</span><span class="n">page</span><span class="p">))</span>
			<span class="n">mss</span><span class="o">-&gt;</span><span class="n">shared_dirty</span> <span class="o">+=</span> <span class="n">ptent_size</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">mss</span><span class="o">-&gt;</span><span class="n">shared_clean</span> <span class="o">+=</span> <span class="n">ptent_size</span><span class="p">;</span>
		<span class="n">mss</span><span class="o">-&gt;</span><span class="n">pss</span> <span class="o">+=</span> <span class="p">(</span><span class="n">ptent_size</span> <span class="o">&lt;&lt;</span> <span class="n">PSS_SHIFT</span><span class="p">)</span> <span class="o">/</span> <span class="n">mapcount</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pte_dirty</span><span class="p">(</span><span class="n">ptent</span><span class="p">)</span> <span class="o">||</span> <span class="n">PageDirty</span><span class="p">(</span><span class="n">page</span><span class="p">))</span>
			<span class="n">mss</span><span class="o">-&gt;</span><span class="n">private_dirty</span> <span class="o">+=</span> <span class="n">ptent_size</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">mss</span><span class="o">-&gt;</span><span class="n">private_clean</span> <span class="o">+=</span> <span class="n">ptent_size</span><span class="p">;</span>
		<span class="n">mss</span><span class="o">-&gt;</span><span class="n">pss</span> <span class="o">+=</span> <span class="p">(</span><span class="n">ptent_size</span> <span class="o">&lt;&lt;</span> <span class="n">PSS_SHIFT</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">smaps_pte_range</span><span class="p">(</span><span class="n">pmd_t</span> <span class="o">*</span><span class="n">pmd</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">addr</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">end</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">mm_walk</span> <span class="o">*</span><span class="n">walk</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mem_size_stats</span> <span class="o">*</span><span class="n">mss</span> <span class="o">=</span> <span class="n">walk</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">vm_area_struct</span> <span class="o">*</span><span class="n">vma</span> <span class="o">=</span> <span class="n">mss</span><span class="o">-&gt;</span><span class="n">vma</span><span class="p">;</span>
	<span class="n">pte_t</span> <span class="o">*</span><span class="n">pte</span><span class="p">;</span>
	<span class="n">spinlock_t</span> <span class="o">*</span><span class="n">ptl</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pmd_trans_huge_lock</span><span class="p">(</span><span class="n">pmd</span><span class="p">,</span> <span class="n">vma</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">smaps_pte_entry</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">pte_t</span> <span class="o">*</span><span class="p">)</span><span class="n">pmd</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">HPAGE_PMD_SIZE</span><span class="p">,</span> <span class="n">walk</span><span class="p">);</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">walk</span><span class="o">-&gt;</span><span class="n">mm</span><span class="o">-&gt;</span><span class="n">page_table_lock</span><span class="p">);</span>
		<span class="n">mss</span><span class="o">-&gt;</span><span class="n">anonymous_thp</span> <span class="o">+=</span> <span class="n">HPAGE_PMD_SIZE</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pmd_trans_unstable</span><span class="p">(</span><span class="n">pmd</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * The mmap_sem held all the way back in m_start() is what</span>
<span class="cm">	 * keeps khugepaged out of here and from collapsing things</span>
<span class="cm">	 * in here.</span>
<span class="cm">	 */</span>
	<span class="n">pte</span> <span class="o">=</span> <span class="n">pte_offset_map_lock</span><span class="p">(</span><span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_mm</span><span class="p">,</span> <span class="n">pmd</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ptl</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(;</span> <span class="n">addr</span> <span class="o">!=</span> <span class="n">end</span><span class="p">;</span> <span class="n">pte</span><span class="o">++</span><span class="p">,</span> <span class="n">addr</span> <span class="o">+=</span> <span class="n">PAGE_SIZE</span><span class="p">)</span>
		<span class="n">smaps_pte_entry</span><span class="p">(</span><span class="o">*</span><span class="n">pte</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="n">walk</span><span class="p">);</span>
	<span class="n">pte_unmap_unlock</span><span class="p">(</span><span class="n">pte</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ptl</span><span class="p">);</span>
	<span class="n">cond_resched</span><span class="p">();</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">show_smap</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">m</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">v</span><span class="p">,</span> <span class="kt">int</span> <span class="n">is_pid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">proc_maps_private</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">task_struct</span> <span class="o">*</span><span class="n">task</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">task</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">vm_area_struct</span> <span class="o">*</span><span class="n">vma</span> <span class="o">=</span> <span class="n">v</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mem_size_stats</span> <span class="n">mss</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mm_walk</span> <span class="n">smaps_walk</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">pmd_entry</span> <span class="o">=</span> <span class="n">smaps_pte_range</span><span class="p">,</span>
		<span class="p">.</span><span class="n">mm</span> <span class="o">=</span> <span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_mm</span><span class="p">,</span>
		<span class="p">.</span><span class="n">private</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">mss</span><span class="p">,</span>
	<span class="p">};</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mss</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span> <span class="n">mss</span><span class="p">);</span>
	<span class="n">mss</span><span class="p">.</span><span class="n">vma</span> <span class="o">=</span> <span class="n">vma</span><span class="p">;</span>
	<span class="cm">/* mmap_sem is held in m_start */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_mm</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">is_vm_hugetlb_page</span><span class="p">(</span><span class="n">vma</span><span class="p">))</span>
		<span class="n">walk_page_range</span><span class="p">(</span><span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_start</span><span class="p">,</span> <span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_end</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">smaps_walk</span><span class="p">);</span>

	<span class="n">show_map_vma</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">vma</span><span class="p">,</span> <span class="n">is_pid</span><span class="p">);</span>

	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span>
		   <span class="s">&quot;Size:           %8lu kB</span><span class="se">\n</span><span class="s">&quot;</span>
		   <span class="s">&quot;Rss:            %8lu kB</span><span class="se">\n</span><span class="s">&quot;</span>
		   <span class="s">&quot;Pss:            %8lu kB</span><span class="se">\n</span><span class="s">&quot;</span>
		   <span class="s">&quot;Shared_Clean:   %8lu kB</span><span class="se">\n</span><span class="s">&quot;</span>
		   <span class="s">&quot;Shared_Dirty:   %8lu kB</span><span class="se">\n</span><span class="s">&quot;</span>
		   <span class="s">&quot;Private_Clean:  %8lu kB</span><span class="se">\n</span><span class="s">&quot;</span>
		   <span class="s">&quot;Private_Dirty:  %8lu kB</span><span class="se">\n</span><span class="s">&quot;</span>
		   <span class="s">&quot;Referenced:     %8lu kB</span><span class="se">\n</span><span class="s">&quot;</span>
		   <span class="s">&quot;Anonymous:      %8lu kB</span><span class="se">\n</span><span class="s">&quot;</span>
		   <span class="s">&quot;AnonHugePages:  %8lu kB</span><span class="se">\n</span><span class="s">&quot;</span>
		   <span class="s">&quot;Swap:           %8lu kB</span><span class="se">\n</span><span class="s">&quot;</span>
		   <span class="s">&quot;KernelPageSize: %8lu kB</span><span class="se">\n</span><span class="s">&quot;</span>
		   <span class="s">&quot;MMUPageSize:    %8lu kB</span><span class="se">\n</span><span class="s">&quot;</span>
		   <span class="s">&quot;Locked:         %8lu kB</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="p">(</span><span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_end</span> <span class="o">-</span> <span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_start</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">10</span><span class="p">,</span>
		   <span class="n">mss</span><span class="p">.</span><span class="n">resident</span> <span class="o">&gt;&gt;</span> <span class="mi">10</span><span class="p">,</span>
		   <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)(</span><span class="n">mss</span><span class="p">.</span><span class="n">pss</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="mi">10</span> <span class="o">+</span> <span class="n">PSS_SHIFT</span><span class="p">)),</span>
		   <span class="n">mss</span><span class="p">.</span><span class="n">shared_clean</span>  <span class="o">&gt;&gt;</span> <span class="mi">10</span><span class="p">,</span>
		   <span class="n">mss</span><span class="p">.</span><span class="n">shared_dirty</span>  <span class="o">&gt;&gt;</span> <span class="mi">10</span><span class="p">,</span>
		   <span class="n">mss</span><span class="p">.</span><span class="n">private_clean</span> <span class="o">&gt;&gt;</span> <span class="mi">10</span><span class="p">,</span>
		   <span class="n">mss</span><span class="p">.</span><span class="n">private_dirty</span> <span class="o">&gt;&gt;</span> <span class="mi">10</span><span class="p">,</span>
		   <span class="n">mss</span><span class="p">.</span><span class="n">referenced</span> <span class="o">&gt;&gt;</span> <span class="mi">10</span><span class="p">,</span>
		   <span class="n">mss</span><span class="p">.</span><span class="n">anonymous</span> <span class="o">&gt;&gt;</span> <span class="mi">10</span><span class="p">,</span>
		   <span class="n">mss</span><span class="p">.</span><span class="n">anonymous_thp</span> <span class="o">&gt;&gt;</span> <span class="mi">10</span><span class="p">,</span>
		   <span class="n">mss</span><span class="p">.</span><span class="n">swap</span> <span class="o">&gt;&gt;</span> <span class="mi">10</span><span class="p">,</span>
		   <span class="n">vma_kernel_pagesize</span><span class="p">(</span><span class="n">vma</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">10</span><span class="p">,</span>
		   <span class="n">vma_mmu_pagesize</span><span class="p">(</span><span class="n">vma</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">10</span><span class="p">,</span>
		   <span class="p">(</span><span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_flags</span> <span class="o">&amp;</span> <span class="n">VM_LOCKED</span><span class="p">)</span> <span class="o">?</span>
			<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)(</span><span class="n">mss</span><span class="p">.</span><span class="n">pss</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="mi">10</span> <span class="o">+</span> <span class="n">PSS_SHIFT</span><span class="p">))</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_flags</span> <span class="o">&amp;</span> <span class="n">VM_NONLINEAR</span><span class="p">)</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;Nonlinear:      %8lu kB</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">mss</span><span class="p">.</span><span class="n">nonlinear</span> <span class="o">&gt;&gt;</span> <span class="mi">10</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">&lt;</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">)</span>  <span class="cm">/* vma is copied successfully */</span>
		<span class="n">m</span><span class="o">-&gt;</span><span class="n">version</span> <span class="o">=</span> <span class="p">(</span><span class="n">vma</span> <span class="o">!=</span> <span class="n">get_gate_vma</span><span class="p">(</span><span class="n">task</span><span class="o">-&gt;</span><span class="n">mm</span><span class="p">))</span>
			<span class="o">?</span> <span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_start</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">show_pid_smap</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">m</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">v</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">show_smap</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">show_tid_smap</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">m</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">v</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">show_smap</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">seq_operations</span> <span class="n">proc_pid_smaps_op</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">start</span>	<span class="o">=</span> <span class="n">m_start</span><span class="p">,</span>
	<span class="p">.</span><span class="n">next</span>	<span class="o">=</span> <span class="n">m_next</span><span class="p">,</span>
	<span class="p">.</span><span class="n">stop</span>	<span class="o">=</span> <span class="n">m_stop</span><span class="p">,</span>
	<span class="p">.</span><span class="n">show</span>	<span class="o">=</span> <span class="n">show_pid_smap</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">seq_operations</span> <span class="n">proc_tid_smaps_op</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">start</span>	<span class="o">=</span> <span class="n">m_start</span><span class="p">,</span>
	<span class="p">.</span><span class="n">next</span>	<span class="o">=</span> <span class="n">m_next</span><span class="p">,</span>
	<span class="p">.</span><span class="n">stop</span>	<span class="o">=</span> <span class="n">m_stop</span><span class="p">,</span>
	<span class="p">.</span><span class="n">show</span>	<span class="o">=</span> <span class="n">show_tid_smap</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pid_smaps_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">do_maps_open</span><span class="p">(</span><span class="n">inode</span><span class="p">,</span> <span class="n">file</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">proc_pid_smaps_op</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tid_smaps_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">do_maps_open</span><span class="p">(</span><span class="n">inode</span><span class="p">,</span> <span class="n">file</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">proc_tid_smaps_op</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">const</span> <span class="k">struct</span> <span class="n">file_operations</span> <span class="n">proc_pid_smaps_operations</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">open</span>		<span class="o">=</span> <span class="n">pid_smaps_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read</span>		<span class="o">=</span> <span class="n">seq_read</span><span class="p">,</span>
	<span class="p">.</span><span class="n">llseek</span>		<span class="o">=</span> <span class="n">seq_lseek</span><span class="p">,</span>
	<span class="p">.</span><span class="n">release</span>	<span class="o">=</span> <span class="n">seq_release_private</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">const</span> <span class="k">struct</span> <span class="n">file_operations</span> <span class="n">proc_tid_smaps_operations</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">open</span>		<span class="o">=</span> <span class="n">tid_smaps_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read</span>		<span class="o">=</span> <span class="n">seq_read</span><span class="p">,</span>
	<span class="p">.</span><span class="n">llseek</span>		<span class="o">=</span> <span class="n">seq_lseek</span><span class="p">,</span>
	<span class="p">.</span><span class="n">release</span>	<span class="o">=</span> <span class="n">seq_release_private</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">clear_refs_pte_range</span><span class="p">(</span><span class="n">pmd_t</span> <span class="o">*</span><span class="n">pmd</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">addr</span><span class="p">,</span>
				<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">end</span><span class="p">,</span> <span class="k">struct</span> <span class="n">mm_walk</span> <span class="o">*</span><span class="n">walk</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">vm_area_struct</span> <span class="o">*</span><span class="n">vma</span> <span class="o">=</span> <span class="n">walk</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
	<span class="n">pte_t</span> <span class="o">*</span><span class="n">pte</span><span class="p">,</span> <span class="n">ptent</span><span class="p">;</span>
	<span class="n">spinlock_t</span> <span class="o">*</span><span class="n">ptl</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="n">page</span><span class="p">;</span>

	<span class="n">split_huge_page_pmd</span><span class="p">(</span><span class="n">walk</span><span class="o">-&gt;</span><span class="n">mm</span><span class="p">,</span> <span class="n">pmd</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pmd_trans_unstable</span><span class="p">(</span><span class="n">pmd</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">pte</span> <span class="o">=</span> <span class="n">pte_offset_map_lock</span><span class="p">(</span><span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_mm</span><span class="p">,</span> <span class="n">pmd</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ptl</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(;</span> <span class="n">addr</span> <span class="o">!=</span> <span class="n">end</span><span class="p">;</span> <span class="n">pte</span><span class="o">++</span><span class="p">,</span> <span class="n">addr</span> <span class="o">+=</span> <span class="n">PAGE_SIZE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ptent</span> <span class="o">=</span> <span class="o">*</span><span class="n">pte</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pte_present</span><span class="p">(</span><span class="n">ptent</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">page</span> <span class="o">=</span> <span class="n">vm_normal_page</span><span class="p">(</span><span class="n">vma</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">ptent</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">page</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="cm">/* Clear accessed and referenced bits. */</span>
		<span class="n">ptep_test_and_clear_young</span><span class="p">(</span><span class="n">vma</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">pte</span><span class="p">);</span>
		<span class="n">ClearPageReferenced</span><span class="p">(</span><span class="n">page</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">pte_unmap_unlock</span><span class="p">(</span><span class="n">pte</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ptl</span><span class="p">);</span>
	<span class="n">cond_resched</span><span class="p">();</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define CLEAR_REFS_ALL 1</span>
<span class="cp">#define CLEAR_REFS_ANON 2</span>
<span class="cp">#define CLEAR_REFS_MAPPED 3</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">clear_refs_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span>
				<span class="kt">size_t</span> <span class="n">count</span><span class="p">,</span> <span class="n">loff_t</span> <span class="o">*</span><span class="n">ppos</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">task_struct</span> <span class="o">*</span><span class="n">task</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">buffer</span><span class="p">[</span><span class="n">PROC_NUMBUF</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">mm_struct</span> <span class="o">*</span><span class="n">mm</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">vm_area_struct</span> <span class="o">*</span><span class="n">vma</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">type</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rv</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buffer</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">&gt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buffer</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">count</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buffer</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">count</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="n">rv</span> <span class="o">=</span> <span class="n">kstrtoint</span><span class="p">(</span><span class="n">strstrip</span><span class="p">(</span><span class="n">buffer</span><span class="p">),</span> <span class="mi">10</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">type</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rv</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rv</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">&lt;</span> <span class="n">CLEAR_REFS_ALL</span> <span class="o">||</span> <span class="n">type</span> <span class="o">&gt;</span> <span class="n">CLEAR_REFS_MAPPED</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">task</span> <span class="o">=</span> <span class="n">get_proc_task</span><span class="p">(</span><span class="n">file</span><span class="o">-&gt;</span><span class="n">f_path</span><span class="p">.</span><span class="n">dentry</span><span class="o">-&gt;</span><span class="n">d_inode</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">task</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ESRCH</span><span class="p">;</span>
	<span class="n">mm</span> <span class="o">=</span> <span class="n">get_task_mm</span><span class="p">(</span><span class="n">task</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mm</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">mm_walk</span> <span class="n">clear_refs_walk</span> <span class="o">=</span> <span class="p">{</span>
			<span class="p">.</span><span class="n">pmd_entry</span> <span class="o">=</span> <span class="n">clear_refs_pte_range</span><span class="p">,</span>
			<span class="p">.</span><span class="n">mm</span> <span class="o">=</span> <span class="n">mm</span><span class="p">,</span>
		<span class="p">};</span>
		<span class="n">down_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mm</span><span class="o">-&gt;</span><span class="n">mmap_sem</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">vma</span> <span class="o">=</span> <span class="n">mm</span><span class="o">-&gt;</span><span class="n">mmap</span><span class="p">;</span> <span class="n">vma</span><span class="p">;</span> <span class="n">vma</span> <span class="o">=</span> <span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_next</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">clear_refs_walk</span><span class="p">.</span><span class="n">private</span> <span class="o">=</span> <span class="n">vma</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">is_vm_hugetlb_page</span><span class="p">(</span><span class="n">vma</span><span class="p">))</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="cm">/*</span>
<span class="cm">			 * Writing 1 to /proc/pid/clear_refs affects all pages.</span>
<span class="cm">			 *</span>
<span class="cm">			 * Writing 2 to /proc/pid/clear_refs only affects</span>
<span class="cm">			 * Anonymous pages.</span>
<span class="cm">			 *</span>
<span class="cm">			 * Writing 3 to /proc/pid/clear_refs only affects file</span>
<span class="cm">			 * mapped pages.</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="n">CLEAR_REFS_ANON</span> <span class="o">&amp;&amp;</span> <span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_file</span><span class="p">)</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="n">CLEAR_REFS_MAPPED</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_file</span><span class="p">)</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="n">walk_page_range</span><span class="p">(</span><span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_start</span><span class="p">,</span> <span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_end</span><span class="p">,</span>
					<span class="o">&amp;</span><span class="n">clear_refs_walk</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">flush_tlb_mm</span><span class="p">(</span><span class="n">mm</span><span class="p">);</span>
		<span class="n">up_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mm</span><span class="o">-&gt;</span><span class="n">mmap_sem</span><span class="p">);</span>
		<span class="n">mmput</span><span class="p">(</span><span class="n">mm</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">put_task_struct</span><span class="p">(</span><span class="n">task</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">const</span> <span class="k">struct</span> <span class="n">file_operations</span> <span class="n">proc_clear_refs_operations</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">write</span>		<span class="o">=</span> <span class="n">clear_refs_write</span><span class="p">,</span>
	<span class="p">.</span><span class="n">llseek</span>		<span class="o">=</span> <span class="n">noop_llseek</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">typedef</span> <span class="k">struct</span> <span class="p">{</span>
	<span class="n">u64</span> <span class="n">pme</span><span class="p">;</span>
<span class="p">}</span> <span class="n">pagemap_entry_t</span><span class="p">;</span>

<span class="k">struct</span> <span class="n">pagemapread</span> <span class="p">{</span>
	<span class="kt">int</span> <span class="n">pos</span><span class="p">,</span> <span class="n">len</span><span class="p">;</span>
	<span class="n">pagemap_entry_t</span> <span class="o">*</span><span class="n">buffer</span><span class="p">;</span>
<span class="p">};</span>

<span class="cp">#define PAGEMAP_WALK_SIZE	(PMD_SIZE)</span>
<span class="cp">#define PAGEMAP_WALK_MASK	(PMD_MASK)</span>

<span class="cp">#define PM_ENTRY_BYTES      sizeof(u64)</span>
<span class="cp">#define PM_STATUS_BITS      3</span>
<span class="cp">#define PM_STATUS_OFFSET    (64 - PM_STATUS_BITS)</span>
<span class="cp">#define PM_STATUS_MASK      (((1LL &lt;&lt; PM_STATUS_BITS) - 1) &lt;&lt; PM_STATUS_OFFSET)</span>
<span class="cp">#define PM_STATUS(nr)       (((nr) &lt;&lt; PM_STATUS_OFFSET) &amp; PM_STATUS_MASK)</span>
<span class="cp">#define PM_PSHIFT_BITS      6</span>
<span class="cp">#define PM_PSHIFT_OFFSET    (PM_STATUS_OFFSET - PM_PSHIFT_BITS)</span>
<span class="cp">#define PM_PSHIFT_MASK      (((1LL &lt;&lt; PM_PSHIFT_BITS) - 1) &lt;&lt; PM_PSHIFT_OFFSET)</span>
<span class="cp">#define PM_PSHIFT(x)        (((u64) (x) &lt;&lt; PM_PSHIFT_OFFSET) &amp; PM_PSHIFT_MASK)</span>
<span class="cp">#define PM_PFRAME_MASK      ((1LL &lt;&lt; PM_PSHIFT_OFFSET) - 1)</span>
<span class="cp">#define PM_PFRAME(x)        ((x) &amp; PM_PFRAME_MASK)</span>

<span class="cp">#define PM_PRESENT          PM_STATUS(4LL)</span>
<span class="cp">#define PM_SWAP             PM_STATUS(2LL)</span>
<span class="cp">#define PM_FILE             PM_STATUS(1LL)</span>
<span class="cp">#define PM_NOT_PRESENT      PM_PSHIFT(PAGE_SHIFT)</span>
<span class="cp">#define PM_END_OF_BUFFER    1</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">pagemap_entry_t</span> <span class="nf">make_pme</span><span class="p">(</span><span class="n">u64</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">pagemap_entry_t</span><span class="p">)</span> <span class="p">{</span> <span class="p">.</span><span class="n">pme</span> <span class="o">=</span> <span class="n">val</span> <span class="p">};</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">add_to_pagemap</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">addr</span><span class="p">,</span> <span class="n">pagemap_entry_t</span> <span class="o">*</span><span class="n">pme</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">pagemapread</span> <span class="o">*</span><span class="n">pm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pm</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">[</span><span class="n">pm</span><span class="o">-&gt;</span><span class="n">pos</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="o">*</span><span class="n">pme</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pm</span><span class="o">-&gt;</span><span class="n">pos</span> <span class="o">&gt;=</span> <span class="n">pm</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">PM_END_OF_BUFFER</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pagemap_pte_hole</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">start</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">end</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">mm_walk</span> <span class="o">*</span><span class="n">walk</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pagemapread</span> <span class="o">*</span><span class="n">pm</span> <span class="o">=</span> <span class="n">walk</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">addr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pagemap_entry_t</span> <span class="n">pme</span> <span class="o">=</span> <span class="n">make_pme</span><span class="p">(</span><span class="n">PM_NOT_PRESENT</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">addr</span> <span class="o">=</span> <span class="n">start</span><span class="p">;</span> <span class="n">addr</span> <span class="o">&lt;</span> <span class="n">end</span><span class="p">;</span> <span class="n">addr</span> <span class="o">+=</span> <span class="n">PAGE_SIZE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">add_to_pagemap</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pme</span><span class="p">,</span> <span class="n">pm</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">pte_to_pagemap_entry</span><span class="p">(</span><span class="n">pagemap_entry_t</span> <span class="o">*</span><span class="n">pme</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">vm_area_struct</span> <span class="o">*</span><span class="n">vma</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">addr</span><span class="p">,</span> <span class="n">pte_t</span> <span class="n">pte</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u64</span> <span class="n">frame</span><span class="p">,</span> <span class="n">flags</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="n">page</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pte_present</span><span class="p">(</span><span class="n">pte</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">frame</span> <span class="o">=</span> <span class="n">pte_pfn</span><span class="p">(</span><span class="n">pte</span><span class="p">);</span>
		<span class="n">flags</span> <span class="o">=</span> <span class="n">PM_PRESENT</span><span class="p">;</span>
		<span class="n">page</span> <span class="o">=</span> <span class="n">vm_normal_page</span><span class="p">(</span><span class="n">vma</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">pte</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">is_swap_pte</span><span class="p">(</span><span class="n">pte</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">swp_entry_t</span> <span class="n">entry</span> <span class="o">=</span> <span class="n">pte_to_swp_entry</span><span class="p">(</span><span class="n">pte</span><span class="p">);</span>

		<span class="n">frame</span> <span class="o">=</span> <span class="n">swp_type</span><span class="p">(</span><span class="n">entry</span><span class="p">)</span> <span class="o">|</span>
			<span class="p">(</span><span class="n">swp_offset</span><span class="p">(</span><span class="n">entry</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">MAX_SWAPFILES_SHIFT</span><span class="p">);</span>
		<span class="n">flags</span> <span class="o">=</span> <span class="n">PM_SWAP</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">is_migration_entry</span><span class="p">(</span><span class="n">entry</span><span class="p">))</span>
			<span class="n">page</span> <span class="o">=</span> <span class="n">migration_entry_to_page</span><span class="p">(</span><span class="n">entry</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">pme</span> <span class="o">=</span> <span class="n">make_pme</span><span class="p">(</span><span class="n">PM_NOT_PRESENT</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">page</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">PageAnon</span><span class="p">(</span><span class="n">page</span><span class="p">))</span>
		<span class="n">flags</span> <span class="o">|=</span> <span class="n">PM_FILE</span><span class="p">;</span>

	<span class="o">*</span><span class="n">pme</span> <span class="o">=</span> <span class="n">make_pme</span><span class="p">(</span><span class="n">PM_PFRAME</span><span class="p">(</span><span class="n">frame</span><span class="p">)</span> <span class="o">|</span> <span class="n">PM_PSHIFT</span><span class="p">(</span><span class="n">PAGE_SHIFT</span><span class="p">)</span> <span class="o">|</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_TRANSPARENT_HUGEPAGE</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">thp_pmd_to_pagemap_entry</span><span class="p">(</span><span class="n">pagemap_entry_t</span> <span class="o">*</span><span class="n">pme</span><span class="p">,</span>
					<span class="n">pmd_t</span> <span class="n">pmd</span><span class="p">,</span> <span class="kt">int</span> <span class="n">offset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/*</span>
<span class="cm">	 * Currently pmd for thp is always present because thp can not be</span>
<span class="cm">	 * swapped-out, migrated, or HWPOISONed (split in such cases instead.)</span>
<span class="cm">	 * This if-check is just to prepare for future implementation.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pmd_present</span><span class="p">(</span><span class="n">pmd</span><span class="p">))</span>
		<span class="o">*</span><span class="n">pme</span> <span class="o">=</span> <span class="n">make_pme</span><span class="p">(</span><span class="n">PM_PFRAME</span><span class="p">(</span><span class="n">pmd_pfn</span><span class="p">(</span><span class="n">pmd</span><span class="p">)</span> <span class="o">+</span> <span class="n">offset</span><span class="p">)</span>
				<span class="o">|</span> <span class="n">PM_PSHIFT</span><span class="p">(</span><span class="n">PAGE_SHIFT</span><span class="p">)</span> <span class="o">|</span> <span class="n">PM_PRESENT</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="o">*</span><span class="n">pme</span> <span class="o">=</span> <span class="n">make_pme</span><span class="p">(</span><span class="n">PM_NOT_PRESENT</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#else</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">thp_pmd_to_pagemap_entry</span><span class="p">(</span><span class="n">pagemap_entry_t</span> <span class="o">*</span><span class="n">pme</span><span class="p">,</span>
						<span class="n">pmd_t</span> <span class="n">pmd</span><span class="p">,</span> <span class="kt">int</span> <span class="n">offset</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pagemap_pte_range</span><span class="p">(</span><span class="n">pmd_t</span> <span class="o">*</span><span class="n">pmd</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">addr</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">end</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">mm_walk</span> <span class="o">*</span><span class="n">walk</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">vm_area_struct</span> <span class="o">*</span><span class="n">vma</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pagemapread</span> <span class="o">*</span><span class="n">pm</span> <span class="o">=</span> <span class="n">walk</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
	<span class="n">pte_t</span> <span class="o">*</span><span class="n">pte</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pagemap_entry_t</span> <span class="n">pme</span> <span class="o">=</span> <span class="n">make_pme</span><span class="p">(</span><span class="n">PM_NOT_PRESENT</span><span class="p">);</span>

	<span class="cm">/* find the first VMA at or above &#39;addr&#39; */</span>
	<span class="n">vma</span> <span class="o">=</span> <span class="n">find_vma</span><span class="p">(</span><span class="n">walk</span><span class="o">-&gt;</span><span class="n">mm</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vma</span> <span class="o">&amp;&amp;</span> <span class="n">pmd_trans_huge_lock</span><span class="p">(</span><span class="n">pmd</span><span class="p">,</span> <span class="n">vma</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(;</span> <span class="n">addr</span> <span class="o">!=</span> <span class="n">end</span><span class="p">;</span> <span class="n">addr</span> <span class="o">+=</span> <span class="n">PAGE_SIZE</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">offset</span><span class="p">;</span>

			<span class="n">offset</span> <span class="o">=</span> <span class="p">(</span><span class="n">addr</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">PAGEMAP_WALK_MASK</span><span class="p">)</span> <span class="o">&gt;&gt;</span>
					<span class="n">PAGE_SHIFT</span><span class="p">;</span>
			<span class="n">thp_pmd_to_pagemap_entry</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pme</span><span class="p">,</span> <span class="o">*</span><span class="n">pmd</span><span class="p">,</span> <span class="n">offset</span><span class="p">);</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">add_to_pagemap</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pme</span><span class="p">,</span> <span class="n">pm</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">walk</span><span class="o">-&gt;</span><span class="n">mm</span><span class="o">-&gt;</span><span class="n">page_table_lock</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pmd_trans_unstable</span><span class="p">(</span><span class="n">pmd</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(;</span> <span class="n">addr</span> <span class="o">!=</span> <span class="n">end</span><span class="p">;</span> <span class="n">addr</span> <span class="o">+=</span> <span class="n">PAGE_SIZE</span><span class="p">)</span> <span class="p">{</span>

		<span class="cm">/* check to see if we&#39;ve left &#39;vma&#39; behind</span>
<span class="cm">		 * and need a new, higher one */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">vma</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">addr</span> <span class="o">&gt;=</span> <span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_end</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">vma</span> <span class="o">=</span> <span class="n">find_vma</span><span class="p">(</span><span class="n">walk</span><span class="o">-&gt;</span><span class="n">mm</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>
			<span class="n">pme</span> <span class="o">=</span> <span class="n">make_pme</span><span class="p">(</span><span class="n">PM_NOT_PRESENT</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="cm">/* check that &#39;vma&#39; actually covers this address,</span>
<span class="cm">		 * and that it isn&#39;t a huge page vma */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">vma</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_start</span> <span class="o">&lt;=</span> <span class="n">addr</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="o">!</span><span class="n">is_vm_hugetlb_page</span><span class="p">(</span><span class="n">vma</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">pte</span> <span class="o">=</span> <span class="n">pte_offset_map</span><span class="p">(</span><span class="n">pmd</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>
			<span class="n">pte_to_pagemap_entry</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pme</span><span class="p">,</span> <span class="n">vma</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="o">*</span><span class="n">pte</span><span class="p">);</span>
			<span class="cm">/* unmap before userspace copy */</span>
			<span class="n">pte_unmap</span><span class="p">(</span><span class="n">pte</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">add_to_pagemap</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pme</span><span class="p">,</span> <span class="n">pm</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">cond_resched</span><span class="p">();</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_HUGETLB_PAGE</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">huge_pte_to_pagemap_entry</span><span class="p">(</span><span class="n">pagemap_entry_t</span> <span class="o">*</span><span class="n">pme</span><span class="p">,</span>
					<span class="n">pte_t</span> <span class="n">pte</span><span class="p">,</span> <span class="kt">int</span> <span class="n">offset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pte_present</span><span class="p">(</span><span class="n">pte</span><span class="p">))</span>
		<span class="o">*</span><span class="n">pme</span> <span class="o">=</span> <span class="n">make_pme</span><span class="p">(</span><span class="n">PM_PFRAME</span><span class="p">(</span><span class="n">pte_pfn</span><span class="p">(</span><span class="n">pte</span><span class="p">)</span> <span class="o">+</span> <span class="n">offset</span><span class="p">)</span>
				<span class="o">|</span> <span class="n">PM_PSHIFT</span><span class="p">(</span><span class="n">PAGE_SHIFT</span><span class="p">)</span> <span class="o">|</span> <span class="n">PM_PRESENT</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="o">*</span><span class="n">pme</span> <span class="o">=</span> <span class="n">make_pme</span><span class="p">(</span><span class="n">PM_NOT_PRESENT</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* This function walks within one hugetlb entry in the single call */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">pagemap_hugetlb_range</span><span class="p">(</span><span class="n">pte_t</span> <span class="o">*</span><span class="n">pte</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">hmask</span><span class="p">,</span>
				 <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">addr</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">end</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">mm_walk</span> <span class="o">*</span><span class="n">walk</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pagemapread</span> <span class="o">*</span><span class="n">pm</span> <span class="o">=</span> <span class="n">walk</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pagemap_entry_t</span> <span class="n">pme</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(;</span> <span class="n">addr</span> <span class="o">!=</span> <span class="n">end</span><span class="p">;</span> <span class="n">addr</span> <span class="o">+=</span> <span class="n">PAGE_SIZE</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">offset</span> <span class="o">=</span> <span class="p">(</span><span class="n">addr</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">hmask</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">PAGE_SHIFT</span><span class="p">;</span>
		<span class="n">huge_pte_to_pagemap_entry</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pme</span><span class="p">,</span> <span class="o">*</span><span class="n">pte</span><span class="p">,</span> <span class="n">offset</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">add_to_pagemap</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pme</span><span class="p">,</span> <span class="n">pm</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">cond_resched</span><span class="p">();</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* HUGETLB_PAGE */</span><span class="cp"></span>

<span class="cm">/*</span>
<span class="cm"> * /proc/pid/pagemap - an array mapping virtual pages to pfns</span>
<span class="cm"> *</span>
<span class="cm"> * For each page in the address space, this file contains one 64-bit entry</span>
<span class="cm"> * consisting of the following:</span>
<span class="cm"> *</span>
<span class="cm"> * Bits 0-54  page frame number (PFN) if present</span>
<span class="cm"> * Bits 0-4   swap type if swapped</span>
<span class="cm"> * Bits 5-54  swap offset if swapped</span>
<span class="cm"> * Bits 55-60 page shift (page size = 1&lt;&lt;page shift)</span>
<span class="cm"> * Bit  61    page is file-page or shared-anon</span>
<span class="cm"> * Bit  62    page swapped</span>
<span class="cm"> * Bit  63    page present</span>
<span class="cm"> *</span>
<span class="cm"> * If the page is not present but in swap, then the PFN contains an</span>
<span class="cm"> * encoding of the swap file number and the page&#39;s offset into the</span>
<span class="cm"> * swap. Unmapped pages return a null PFN. This allows determining</span>
<span class="cm"> * precisely which pages are mapped (or in swap) and comparing mapped</span>
<span class="cm"> * pages between processes.</span>
<span class="cm"> *</span>
<span class="cm"> * Efficient users of this interface will use /proc/pid/maps to</span>
<span class="cm"> * determine which areas of memory are actually mapped and llseek to</span>
<span class="cm"> * skip over unmapped regions.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">pagemap_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span>
			    <span class="kt">size_t</span> <span class="n">count</span><span class="p">,</span> <span class="n">loff_t</span> <span class="o">*</span><span class="n">ppos</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">task_struct</span> <span class="o">*</span><span class="n">task</span> <span class="o">=</span> <span class="n">get_proc_task</span><span class="p">(</span><span class="n">file</span><span class="o">-&gt;</span><span class="n">f_path</span><span class="p">.</span><span class="n">dentry</span><span class="o">-&gt;</span><span class="n">d_inode</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">mm_struct</span> <span class="o">*</span><span class="n">mm</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pagemapread</span> <span class="n">pm</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ESRCH</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mm_walk</span> <span class="n">pagemap_walk</span> <span class="o">=</span> <span class="p">{};</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">src</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">svpfn</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">start_vaddr</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">end_vaddr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">copied</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">task</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="cm">/* file position must be aligned */</span>
	<span class="k">if</span> <span class="p">((</span><span class="o">*</span><span class="n">ppos</span> <span class="o">%</span> <span class="n">PM_ENTRY_BYTES</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">count</span> <span class="o">%</span> <span class="n">PM_ENTRY_BYTES</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out_task</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">count</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_task</span><span class="p">;</span>

	<span class="n">pm</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="n">PM_ENTRY_BYTES</span> <span class="o">*</span> <span class="p">(</span><span class="n">PAGEMAP_WALK_SIZE</span> <span class="o">&gt;&gt;</span> <span class="n">PAGE_SHIFT</span><span class="p">);</span>
	<span class="n">pm</span><span class="p">.</span><span class="n">buffer</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">pm</span><span class="p">.</span><span class="n">len</span><span class="p">,</span> <span class="n">GFP_TEMPORARY</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pm</span><span class="p">.</span><span class="n">buffer</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_task</span><span class="p">;</span>

	<span class="n">mm</span> <span class="o">=</span> <span class="n">mm_access</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="n">PTRACE_MODE_READ</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">mm</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mm</span> <span class="o">||</span> <span class="n">IS_ERR</span><span class="p">(</span><span class="n">mm</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out_free</span><span class="p">;</span>

	<span class="n">pagemap_walk</span><span class="p">.</span><span class="n">pmd_entry</span> <span class="o">=</span> <span class="n">pagemap_pte_range</span><span class="p">;</span>
	<span class="n">pagemap_walk</span><span class="p">.</span><span class="n">pte_hole</span> <span class="o">=</span> <span class="n">pagemap_pte_hole</span><span class="p">;</span>
<span class="cp">#ifdef CONFIG_HUGETLB_PAGE</span>
	<span class="n">pagemap_walk</span><span class="p">.</span><span class="n">hugetlb_entry</span> <span class="o">=</span> <span class="n">pagemap_hugetlb_range</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="n">pagemap_walk</span><span class="p">.</span><span class="n">mm</span> <span class="o">=</span> <span class="n">mm</span><span class="p">;</span>
	<span class="n">pagemap_walk</span><span class="p">.</span><span class="n">private</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pm</span><span class="p">;</span>

	<span class="n">src</span> <span class="o">=</span> <span class="o">*</span><span class="n">ppos</span><span class="p">;</span>
	<span class="n">svpfn</span> <span class="o">=</span> <span class="n">src</span> <span class="o">/</span> <span class="n">PM_ENTRY_BYTES</span><span class="p">;</span>
	<span class="n">start_vaddr</span> <span class="o">=</span> <span class="n">svpfn</span> <span class="o">&lt;&lt;</span> <span class="n">PAGE_SHIFT</span><span class="p">;</span>
	<span class="n">end_vaddr</span> <span class="o">=</span> <span class="n">TASK_SIZE_OF</span><span class="p">(</span><span class="n">task</span><span class="p">);</span>

	<span class="cm">/* watch out for wraparound */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">svpfn</span> <span class="o">&gt;</span> <span class="n">TASK_SIZE_OF</span><span class="p">(</span><span class="n">task</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">PAGE_SHIFT</span><span class="p">)</span>
		<span class="n">start_vaddr</span> <span class="o">=</span> <span class="n">end_vaddr</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * The odds are that this will stop walking way</span>
<span class="cm">	 * before end_vaddr, because the length of the</span>
<span class="cm">	 * user buffer is tracked in &quot;pm&quot;, and the walk</span>
<span class="cm">	 * will stop when we hit the end of the buffer.</span>
<span class="cm">	 */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">count</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">start_vaddr</span> <span class="o">&lt;</span> <span class="n">end_vaddr</span><span class="p">))</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">len</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">end</span><span class="p">;</span>

		<span class="n">pm</span><span class="p">.</span><span class="n">pos</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">end</span> <span class="o">=</span> <span class="p">(</span><span class="n">start_vaddr</span> <span class="o">+</span> <span class="n">PAGEMAP_WALK_SIZE</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">PAGEMAP_WALK_MASK</span><span class="p">;</span>
		<span class="cm">/* overflow ? */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">end</span> <span class="o">&lt;</span> <span class="n">start_vaddr</span> <span class="o">||</span> <span class="n">end</span> <span class="o">&gt;</span> <span class="n">end_vaddr</span><span class="p">)</span>
			<span class="n">end</span> <span class="o">=</span> <span class="n">end_vaddr</span><span class="p">;</span>
		<span class="n">down_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mm</span><span class="o">-&gt;</span><span class="n">mmap_sem</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">walk_page_range</span><span class="p">(</span><span class="n">start_vaddr</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pagemap_walk</span><span class="p">);</span>
		<span class="n">up_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mm</span><span class="o">-&gt;</span><span class="n">mmap_sem</span><span class="p">);</span>
		<span class="n">start_vaddr</span> <span class="o">=</span> <span class="n">end</span><span class="p">;</span>

		<span class="n">len</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">count</span><span class="p">,</span> <span class="n">PM_ENTRY_BYTES</span> <span class="o">*</span> <span class="n">pm</span><span class="p">.</span><span class="n">pos</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">pm</span><span class="p">.</span><span class="n">buffer</span><span class="p">,</span> <span class="n">len</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out_mm</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">copied</span> <span class="o">+=</span> <span class="n">len</span><span class="p">;</span>
		<span class="n">buf</span> <span class="o">+=</span> <span class="n">len</span><span class="p">;</span>
		<span class="n">count</span> <span class="o">-=</span> <span class="n">len</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="o">*</span><span class="n">ppos</span> <span class="o">+=</span> <span class="n">copied</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span> <span class="o">||</span> <span class="n">ret</span> <span class="o">==</span> <span class="n">PM_END_OF_BUFFER</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">copied</span><span class="p">;</span>

<span class="nl">out_mm:</span>
	<span class="n">mmput</span><span class="p">(</span><span class="n">mm</span><span class="p">);</span>
<span class="nl">out_free:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">pm</span><span class="p">.</span><span class="n">buffer</span><span class="p">);</span>
<span class="nl">out_task:</span>
	<span class="n">put_task_struct</span><span class="p">(</span><span class="n">task</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">const</span> <span class="k">struct</span> <span class="n">file_operations</span> <span class="n">proc_pagemap_operations</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">llseek</span>		<span class="o">=</span> <span class="n">mem_lseek</span><span class="p">,</span> <span class="cm">/* borrow this */</span>
	<span class="p">.</span><span class="n">read</span>		<span class="o">=</span> <span class="n">pagemap_read</span><span class="p">,</span>
<span class="p">};</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_PROC_PAGE_MONITOR */</span><span class="cp"></span>

<span class="cp">#ifdef CONFIG_NUMA</span>

<span class="k">struct</span> <span class="n">numa_maps</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">vm_area_struct</span> <span class="o">*</span><span class="n">vma</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">pages</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">anon</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">active</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">writeback</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">mapcount_max</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">dirty</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">swapcache</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">node</span><span class="p">[</span><span class="n">MAX_NUMNODES</span><span class="p">];</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">numa_maps_private</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">proc_maps_private</span> <span class="n">proc_maps</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">numa_maps</span> <span class="n">md</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">gather_stats</span><span class="p">(</span><span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="n">page</span><span class="p">,</span> <span class="k">struct</span> <span class="n">numa_maps</span> <span class="o">*</span><span class="n">md</span><span class="p">,</span> <span class="kt">int</span> <span class="n">pte_dirty</span><span class="p">,</span>
			<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">nr_pages</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">count</span> <span class="o">=</span> <span class="n">page_mapcount</span><span class="p">(</span><span class="n">page</span><span class="p">);</span>

	<span class="n">md</span><span class="o">-&gt;</span><span class="n">pages</span> <span class="o">+=</span> <span class="n">nr_pages</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pte_dirty</span> <span class="o">||</span> <span class="n">PageDirty</span><span class="p">(</span><span class="n">page</span><span class="p">))</span>
		<span class="n">md</span><span class="o">-&gt;</span><span class="n">dirty</span> <span class="o">+=</span> <span class="n">nr_pages</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">PageSwapCache</span><span class="p">(</span><span class="n">page</span><span class="p">))</span>
		<span class="n">md</span><span class="o">-&gt;</span><span class="n">swapcache</span> <span class="o">+=</span> <span class="n">nr_pages</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">PageActive</span><span class="p">(</span><span class="n">page</span><span class="p">)</span> <span class="o">||</span> <span class="n">PageUnevictable</span><span class="p">(</span><span class="n">page</span><span class="p">))</span>
		<span class="n">md</span><span class="o">-&gt;</span><span class="n">active</span> <span class="o">+=</span> <span class="n">nr_pages</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">PageWriteback</span><span class="p">(</span><span class="n">page</span><span class="p">))</span>
		<span class="n">md</span><span class="o">-&gt;</span><span class="n">writeback</span> <span class="o">+=</span> <span class="n">nr_pages</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">PageAnon</span><span class="p">(</span><span class="n">page</span><span class="p">))</span>
		<span class="n">md</span><span class="o">-&gt;</span><span class="n">anon</span> <span class="o">+=</span> <span class="n">nr_pages</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">&gt;</span> <span class="n">md</span><span class="o">-&gt;</span><span class="n">mapcount_max</span><span class="p">)</span>
		<span class="n">md</span><span class="o">-&gt;</span><span class="n">mapcount_max</span> <span class="o">=</span> <span class="n">count</span><span class="p">;</span>

	<span class="n">md</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">[</span><span class="n">page_to_nid</span><span class="p">(</span><span class="n">page</span><span class="p">)]</span> <span class="o">+=</span> <span class="n">nr_pages</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="nf">can_gather_numa_stats</span><span class="p">(</span><span class="n">pte_t</span> <span class="n">pte</span><span class="p">,</span> <span class="k">struct</span> <span class="n">vm_area_struct</span> <span class="o">*</span><span class="n">vma</span><span class="p">,</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="n">page</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">nid</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pte_present</span><span class="p">(</span><span class="n">pte</span><span class="p">))</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">page</span> <span class="o">=</span> <span class="n">vm_normal_page</span><span class="p">(</span><span class="n">vma</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">pte</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">page</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">PageReserved</span><span class="p">(</span><span class="n">page</span><span class="p">))</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">nid</span> <span class="o">=</span> <span class="n">page_to_nid</span><span class="p">(</span><span class="n">page</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">node_isset</span><span class="p">(</span><span class="n">nid</span><span class="p">,</span> <span class="n">node_states</span><span class="p">[</span><span class="n">N_HIGH_MEMORY</span><span class="p">]))</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">page</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">gather_pte_stats</span><span class="p">(</span><span class="n">pmd_t</span> <span class="o">*</span><span class="n">pmd</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">addr</span><span class="p">,</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">end</span><span class="p">,</span> <span class="k">struct</span> <span class="n">mm_walk</span> <span class="o">*</span><span class="n">walk</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">numa_maps</span> <span class="o">*</span><span class="n">md</span><span class="p">;</span>
	<span class="n">spinlock_t</span> <span class="o">*</span><span class="n">ptl</span><span class="p">;</span>
	<span class="n">pte_t</span> <span class="o">*</span><span class="n">orig_pte</span><span class="p">;</span>
	<span class="n">pte_t</span> <span class="o">*</span><span class="n">pte</span><span class="p">;</span>

	<span class="n">md</span> <span class="o">=</span> <span class="n">walk</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pmd_trans_huge_lock</span><span class="p">(</span><span class="n">pmd</span><span class="p">,</span> <span class="n">md</span><span class="o">-&gt;</span><span class="n">vma</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pte_t</span> <span class="n">huge_pte</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">pte_t</span> <span class="o">*</span><span class="p">)</span><span class="n">pmd</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="n">page</span><span class="p">;</span>

		<span class="n">page</span> <span class="o">=</span> <span class="n">can_gather_numa_stats</span><span class="p">(</span><span class="n">huge_pte</span><span class="p">,</span> <span class="n">md</span><span class="o">-&gt;</span><span class="n">vma</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">page</span><span class="p">)</span>
			<span class="n">gather_stats</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="n">md</span><span class="p">,</span> <span class="n">pte_dirty</span><span class="p">(</span><span class="n">huge_pte</span><span class="p">),</span>
				     <span class="n">HPAGE_PMD_SIZE</span><span class="o">/</span><span class="n">PAGE_SIZE</span><span class="p">);</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">walk</span><span class="o">-&gt;</span><span class="n">mm</span><span class="o">-&gt;</span><span class="n">page_table_lock</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pmd_trans_unstable</span><span class="p">(</span><span class="n">pmd</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">orig_pte</span> <span class="o">=</span> <span class="n">pte</span> <span class="o">=</span> <span class="n">pte_offset_map_lock</span><span class="p">(</span><span class="n">walk</span><span class="o">-&gt;</span><span class="n">mm</span><span class="p">,</span> <span class="n">pmd</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ptl</span><span class="p">);</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="n">page</span> <span class="o">=</span> <span class="n">can_gather_numa_stats</span><span class="p">(</span><span class="o">*</span><span class="n">pte</span><span class="p">,</span> <span class="n">md</span><span class="o">-&gt;</span><span class="n">vma</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">page</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">gather_stats</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="n">md</span><span class="p">,</span> <span class="n">pte_dirty</span><span class="p">(</span><span class="o">*</span><span class="n">pte</span><span class="p">),</span> <span class="mi">1</span><span class="p">);</span>

	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">pte</span><span class="o">++</span><span class="p">,</span> <span class="n">addr</span> <span class="o">+=</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="n">addr</span> <span class="o">!=</span> <span class="n">end</span><span class="p">);</span>
	<span class="n">pte_unmap_unlock</span><span class="p">(</span><span class="n">orig_pte</span><span class="p">,</span> <span class="n">ptl</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#ifdef CONFIG_HUGETLB_PAGE</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">gather_hugetbl_stats</span><span class="p">(</span><span class="n">pte_t</span> <span class="o">*</span><span class="n">pte</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">hmask</span><span class="p">,</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">addr</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">end</span><span class="p">,</span> <span class="k">struct</span> <span class="n">mm_walk</span> <span class="o">*</span><span class="n">walk</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">numa_maps</span> <span class="o">*</span><span class="n">md</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="n">page</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pte_none</span><span class="p">(</span><span class="o">*</span><span class="n">pte</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">page</span> <span class="o">=</span> <span class="n">pte_page</span><span class="p">(</span><span class="o">*</span><span class="n">pte</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">page</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">md</span> <span class="o">=</span> <span class="n">walk</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
	<span class="n">gather_stats</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="n">md</span><span class="p">,</span> <span class="n">pte_dirty</span><span class="p">(</span><span class="o">*</span><span class="n">pte</span><span class="p">),</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#else</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">gather_hugetbl_stats</span><span class="p">(</span><span class="n">pte_t</span> <span class="o">*</span><span class="n">pte</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">hmask</span><span class="p">,</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">addr</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">end</span><span class="p">,</span> <span class="k">struct</span> <span class="n">mm_walk</span> <span class="o">*</span><span class="n">walk</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="cm">/*</span>
<span class="cm"> * Display pages allocated per node and memory policy via /proc.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">show_numa_map</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">m</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">v</span><span class="p">,</span> <span class="kt">int</span> <span class="n">is_pid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">numa_maps_private</span> <span class="o">*</span><span class="n">numa_priv</span> <span class="o">=</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">proc_maps_private</span> <span class="o">*</span><span class="n">proc_priv</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">numa_priv</span><span class="o">-&gt;</span><span class="n">proc_maps</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">vm_area_struct</span> <span class="o">*</span><span class="n">vma</span> <span class="o">=</span> <span class="n">v</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">numa_maps</span> <span class="o">*</span><span class="n">md</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">numa_priv</span><span class="o">-&gt;</span><span class="n">md</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span> <span class="o">=</span> <span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_file</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mm_struct</span> <span class="o">*</span><span class="n">mm</span> <span class="o">=</span> <span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_mm</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mm_walk</span> <span class="n">walk</span> <span class="o">=</span> <span class="p">{};</span>
	<span class="k">struct</span> <span class="n">mempolicy</span> <span class="o">*</span><span class="n">pol</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">n</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">50</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mm</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Ensure we start with an empty set of numa_maps statistics. */</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">md</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">md</span><span class="p">));</span>

	<span class="n">md</span><span class="o">-&gt;</span><span class="n">vma</span> <span class="o">=</span> <span class="n">vma</span><span class="p">;</span>

	<span class="n">walk</span><span class="p">.</span><span class="n">hugetlb_entry</span> <span class="o">=</span> <span class="n">gather_hugetbl_stats</span><span class="p">;</span>
	<span class="n">walk</span><span class="p">.</span><span class="n">pmd_entry</span> <span class="o">=</span> <span class="n">gather_pte_stats</span><span class="p">;</span>
	<span class="n">walk</span><span class="p">.</span><span class="n">private</span> <span class="o">=</span> <span class="n">md</span><span class="p">;</span>
	<span class="n">walk</span><span class="p">.</span><span class="n">mm</span> <span class="o">=</span> <span class="n">mm</span><span class="p">;</span>

	<span class="n">pol</span> <span class="o">=</span> <span class="n">get_vma_policy</span><span class="p">(</span><span class="n">proc_priv</span><span class="o">-&gt;</span><span class="n">task</span><span class="p">,</span> <span class="n">vma</span><span class="p">,</span> <span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_start</span><span class="p">);</span>
	<span class="n">mpol_to_str</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buffer</span><span class="p">),</span> <span class="n">pol</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">mpol_cond_put</span><span class="p">(</span><span class="n">pol</span><span class="p">);</span>

	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;%08lx %s&quot;</span><span class="p">,</span> <span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_start</span><span class="p">,</span> <span class="n">buffer</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">file</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot; file=&quot;</span><span class="p">);</span>
		<span class="n">seq_path</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">file</span><span class="o">-&gt;</span><span class="n">f_path</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n\t</span><span class="s">= &quot;</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_start</span> <span class="o">&lt;=</span> <span class="n">mm</span><span class="o">-&gt;</span><span class="n">brk</span> <span class="o">&amp;&amp;</span> <span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_end</span> <span class="o">&gt;=</span> <span class="n">mm</span><span class="o">-&gt;</span><span class="n">start_brk</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot; heap&quot;</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">pid_t</span> <span class="n">tid</span> <span class="o">=</span> <span class="n">vm_is_stack</span><span class="p">(</span><span class="n">proc_priv</span><span class="o">-&gt;</span><span class="n">task</span><span class="p">,</span> <span class="n">vma</span><span class="p">,</span> <span class="n">is_pid</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tid</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * Thread stack in /proc/PID/task/TID/maps or</span>
<span class="cm">			 * the main process stack.</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_pid</span> <span class="o">||</span> <span class="p">(</span><span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_start</span> <span class="o">&lt;=</span> <span class="n">mm</span><span class="o">-&gt;</span><span class="n">start_stack</span> <span class="o">&amp;&amp;</span>
			    <span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_end</span> <span class="o">&gt;=</span> <span class="n">mm</span><span class="o">-&gt;</span><span class="n">start_stack</span><span class="p">))</span>
				<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot; stack&quot;</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot; stack:%d&quot;</span><span class="p">,</span> <span class="n">tid</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">is_vm_hugetlb_page</span><span class="p">(</span><span class="n">vma</span><span class="p">))</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot; huge&quot;</span><span class="p">);</span>

	<span class="n">walk_page_range</span><span class="p">(</span><span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_start</span><span class="p">,</span> <span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_end</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">walk</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">md</span><span class="o">-&gt;</span><span class="n">pages</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">md</span><span class="o">-&gt;</span><span class="n">anon</span><span class="p">)</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot; anon=%lu&quot;</span><span class="p">,</span> <span class="n">md</span><span class="o">-&gt;</span><span class="n">anon</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">md</span><span class="o">-&gt;</span><span class="n">dirty</span><span class="p">)</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot; dirty=%lu&quot;</span><span class="p">,</span> <span class="n">md</span><span class="o">-&gt;</span><span class="n">dirty</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">md</span><span class="o">-&gt;</span><span class="n">pages</span> <span class="o">!=</span> <span class="n">md</span><span class="o">-&gt;</span><span class="n">anon</span> <span class="o">&amp;&amp;</span> <span class="n">md</span><span class="o">-&gt;</span><span class="n">pages</span> <span class="o">!=</span> <span class="n">md</span><span class="o">-&gt;</span><span class="n">dirty</span><span class="p">)</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot; mapped=%lu&quot;</span><span class="p">,</span> <span class="n">md</span><span class="o">-&gt;</span><span class="n">pages</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">md</span><span class="o">-&gt;</span><span class="n">mapcount_max</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot; mapmax=%lu&quot;</span><span class="p">,</span> <span class="n">md</span><span class="o">-&gt;</span><span class="n">mapcount_max</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">md</span><span class="o">-&gt;</span><span class="n">swapcache</span><span class="p">)</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot; swapcache=%lu&quot;</span><span class="p">,</span> <span class="n">md</span><span class="o">-&gt;</span><span class="n">swapcache</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">md</span><span class="o">-&gt;</span><span class="n">active</span> <span class="o">&lt;</span> <span class="n">md</span><span class="o">-&gt;</span><span class="n">pages</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">is_vm_hugetlb_page</span><span class="p">(</span><span class="n">vma</span><span class="p">))</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot; active=%lu&quot;</span><span class="p">,</span> <span class="n">md</span><span class="o">-&gt;</span><span class="n">active</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">md</span><span class="o">-&gt;</span><span class="n">writeback</span><span class="p">)</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot; writeback=%lu&quot;</span><span class="p">,</span> <span class="n">md</span><span class="o">-&gt;</span><span class="n">writeback</span><span class="p">);</span>

	<span class="n">for_each_node_state</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">N_HIGH_MEMORY</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">md</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">[</span><span class="n">n</span><span class="p">])</span>
			<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot; N%d=%lu&quot;</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">md</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">[</span><span class="n">n</span><span class="p">]);</span>
<span class="nl">out:</span>
	<span class="n">seq_putc</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="sc">&#39;\n&#39;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">&lt;</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">)</span>
		<span class="n">m</span><span class="o">-&gt;</span><span class="n">version</span> <span class="o">=</span> <span class="p">(</span><span class="n">vma</span> <span class="o">!=</span> <span class="n">proc_priv</span><span class="o">-&gt;</span><span class="n">tail_vma</span><span class="p">)</span> <span class="o">?</span> <span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_start</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">show_pid_numa_map</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">m</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">v</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">show_numa_map</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">show_tid_numa_map</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">m</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">v</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">show_numa_map</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">seq_operations</span> <span class="n">proc_pid_numa_maps_op</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">start</span>  <span class="o">=</span> <span class="n">m_start</span><span class="p">,</span>
	<span class="p">.</span><span class="n">next</span>   <span class="o">=</span> <span class="n">m_next</span><span class="p">,</span>
	<span class="p">.</span><span class="n">stop</span>   <span class="o">=</span> <span class="n">m_stop</span><span class="p">,</span>
	<span class="p">.</span><span class="n">show</span>   <span class="o">=</span> <span class="n">show_pid_numa_map</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">seq_operations</span> <span class="n">proc_tid_numa_maps_op</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">start</span>  <span class="o">=</span> <span class="n">m_start</span><span class="p">,</span>
	<span class="p">.</span><span class="n">next</span>   <span class="o">=</span> <span class="n">m_next</span><span class="p">,</span>
	<span class="p">.</span><span class="n">stop</span>   <span class="o">=</span> <span class="n">m_stop</span><span class="p">,</span>
	<span class="p">.</span><span class="n">show</span>   <span class="o">=</span> <span class="n">show_tid_numa_map</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">numa_maps_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span>
			  <span class="k">const</span> <span class="k">struct</span> <span class="n">seq_operations</span> <span class="o">*</span><span class="n">ops</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">numa_maps_private</span> <span class="o">*</span><span class="n">priv</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">priv</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">priv</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">proc_maps</span><span class="p">.</span><span class="n">pid</span> <span class="o">=</span> <span class="n">proc_pid</span><span class="p">(</span><span class="n">inode</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">seq_open</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">ops</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">m</span> <span class="o">=</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
			<span class="n">m</span><span class="o">-&gt;</span><span class="n">private</span> <span class="o">=</span> <span class="n">priv</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pid_numa_maps_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">numa_maps_open</span><span class="p">(</span><span class="n">inode</span><span class="p">,</span> <span class="n">file</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">proc_pid_numa_maps_op</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tid_numa_maps_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">numa_maps_open</span><span class="p">(</span><span class="n">inode</span><span class="p">,</span> <span class="n">file</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">proc_tid_numa_maps_op</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">const</span> <span class="k">struct</span> <span class="n">file_operations</span> <span class="n">proc_pid_numa_maps_operations</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">open</span>		<span class="o">=</span> <span class="n">pid_numa_maps_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read</span>		<span class="o">=</span> <span class="n">seq_read</span><span class="p">,</span>
	<span class="p">.</span><span class="n">llseek</span>		<span class="o">=</span> <span class="n">seq_lseek</span><span class="p">,</span>
	<span class="p">.</span><span class="n">release</span>	<span class="o">=</span> <span class="n">seq_release_private</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">const</span> <span class="k">struct</span> <span class="n">file_operations</span> <span class="n">proc_tid_numa_maps_operations</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">open</span>		<span class="o">=</span> <span class="n">tid_numa_maps_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read</span>		<span class="o">=</span> <span class="n">seq_read</span><span class="p">,</span>
	<span class="p">.</span><span class="n">llseek</span>		<span class="o">=</span> <span class="n">seq_lseek</span><span class="p">,</span>
	<span class="p">.</span><span class="n">release</span>	<span class="o">=</span> <span class="n">seq_release_private</span><span class="p">,</span>
<span class="p">};</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_NUMA */</span><span class="cp"></span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
