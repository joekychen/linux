<!DOCTYPE html>
<html><head><title>joekychen/linux » fs › jffs2 › xattr.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>xattr.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * JFFS2 -- Journalling Flash File System, Version 2.</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright © 2006  NEC Corporation</span>
<span class="cm"> *</span>
<span class="cm"> * Created by KaiGai Kohei &lt;kaigai@ak.jp.nec.com&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * For licensing information, see the file &#39;LICENCE&#39; in this directory.</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="cp">#define pr_fmt(fmt) KBUILD_MODNAME &quot;: &quot; fmt</span>

<span class="cp">#define JFFS2_XATTR_IS_CORRUPTED	1</span>

<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/fs.h&gt;</span>
<span class="cp">#include &lt;linux/time.h&gt;</span>
<span class="cp">#include &lt;linux/pagemap.h&gt;</span>
<span class="cp">#include &lt;linux/highmem.h&gt;</span>
<span class="cp">#include &lt;linux/crc32.h&gt;</span>
<span class="cp">#include &lt;linux/jffs2.h&gt;</span>
<span class="cp">#include &lt;linux/xattr.h&gt;</span>
<span class="cp">#include &lt;linux/mtd/mtd.h&gt;</span>
<span class="cp">#include &quot;nodelist.h&quot;</span>
<span class="cm">/* -------- xdatum related functions ----------------</span>
<span class="cm"> * xattr_datum_hashkey(xprefix, xname, xvalue, xsize)</span>
<span class="cm"> *   is used to calcurate xdatum hashkey. The reminder of hashkey into XATTRINDEX_HASHSIZE is</span>
<span class="cm"> *   the index of the xattr name/value pair cache (c-&gt;xattrindex).</span>
<span class="cm"> * is_xattr_datum_unchecked(c, xd)</span>
<span class="cm"> *   returns 1, if xdatum contains any unchecked raw nodes. if all raw nodes are not</span>
<span class="cm"> *   unchecked, it returns 0.</span>
<span class="cm"> * unload_xattr_datum(c, xd)</span>
<span class="cm"> *   is used to release xattr name/value pair and detach from c-&gt;xattrindex.</span>
<span class="cm"> * reclaim_xattr_datum(c)</span>
<span class="cm"> *   is used to reclaim xattr name/value pairs on the xattr name/value pair cache when</span>
<span class="cm"> *   memory usage by cache is over c-&gt;xdatum_mem_threshold. Currently, this threshold</span>
<span class="cm"> *   is hard coded as 32KiB.</span>
<span class="cm"> * do_verify_xattr_datum(c, xd)</span>
<span class="cm"> *   is used to load the xdatum informations without name/value pair from the medium.</span>
<span class="cm"> *   It&#39;s necessary once, because those informations are not collected during mounting</span>
<span class="cm"> *   process when EBS is enabled.</span>
<span class="cm"> *   0 will be returned, if success. An negative return value means recoverable error, and</span>
<span class="cm"> *   positive return value means unrecoverable error. Thus, caller must remove this xdatum</span>
<span class="cm"> *   and xref when it returned positive value.</span>
<span class="cm"> * do_load_xattr_datum(c, xd)</span>
<span class="cm"> *   is used to load name/value pair from the medium.</span>
<span class="cm"> *   The meanings of return value is same as do_verify_xattr_datum().</span>
<span class="cm"> * load_xattr_datum(c, xd)</span>
<span class="cm"> *   is used to be as a wrapper of do_verify_xattr_datum() and do_load_xattr_datum().</span>
<span class="cm"> *   If xd need to call do_verify_xattr_datum() at first, it&#39;s called before calling</span>
<span class="cm"> *   do_load_xattr_datum(). The meanings of return value is same as do_verify_xattr_datum().</span>
<span class="cm"> * save_xattr_datum(c, xd)</span>
<span class="cm"> *   is used to write xdatum to medium. xd-&gt;version will be incremented.</span>
<span class="cm"> * create_xattr_datum(c, xprefix, xname, xvalue, xsize)</span>
<span class="cm"> *   is used to create new xdatum and write to medium.</span>
<span class="cm"> * unrefer_xattr_datum(c, xd)</span>
<span class="cm"> *   is used to delete a xdatum. When nobody refers this xdatum, JFFS2_XFLAGS_DEAD</span>
<span class="cm"> *   is set on xd-&gt;flags and chained xattr_dead_list or release it immediately.</span>
<span class="cm"> *   In the first case, the garbage collector release it later.</span>
<span class="cm"> * -------------------------------------------------- */</span>
<span class="k">static</span> <span class="kt">uint32_t</span> <span class="nf">xattr_datum_hashkey</span><span class="p">(</span><span class="kt">int</span> <span class="n">xprefix</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">xname</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">xvalue</span><span class="p">,</span> <span class="kt">int</span> <span class="n">xsize</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">name_len</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">xname</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">crc32</span><span class="p">(</span><span class="n">xprefix</span><span class="p">,</span> <span class="n">xname</span><span class="p">,</span> <span class="n">name_len</span><span class="p">)</span> <span class="o">^</span> <span class="n">crc32</span><span class="p">(</span><span class="n">xprefix</span><span class="p">,</span> <span class="n">xvalue</span><span class="p">,</span> <span class="n">xsize</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">is_xattr_datum_unchecked</span><span class="p">(</span><span class="k">struct</span> <span class="n">jffs2_sb_info</span> <span class="o">*</span><span class="n">c</span><span class="p">,</span> <span class="k">struct</span> <span class="n">jffs2_xattr_datum</span> <span class="o">*</span><span class="n">xd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">jffs2_raw_node_ref</span> <span class="o">*</span><span class="n">raw</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">erase_completion_lock</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">raw</span><span class="o">=</span><span class="n">xd</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">;</span> <span class="n">raw</span> <span class="o">!=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">xd</span><span class="p">;</span> <span class="n">raw</span><span class="o">=</span><span class="n">raw</span><span class="o">-&gt;</span><span class="n">next_in_ino</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ref_flags</span><span class="p">(</span><span class="n">raw</span><span class="p">)</span> <span class="o">==</span> <span class="n">REF_UNCHECKED</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">erase_completion_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">unload_xattr_datum</span><span class="p">(</span><span class="k">struct</span> <span class="n">jffs2_sb_info</span> <span class="o">*</span><span class="n">c</span><span class="p">,</span> <span class="k">struct</span> <span class="n">jffs2_xattr_datum</span> <span class="o">*</span><span class="n">xd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* must be called under down_write(xattr_sem) */</span>
	<span class="n">D1</span><span class="p">(</span><span class="n">dbg_xattr</span><span class="p">(</span><span class="s">&quot;%s: xid=%u, version=%u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">xd</span><span class="o">-&gt;</span><span class="n">xid</span><span class="p">,</span> <span class="n">xd</span><span class="o">-&gt;</span><span class="n">version</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">xd</span><span class="o">-&gt;</span><span class="n">xname</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">xdatum_mem_usage</span> <span class="o">-=</span> <span class="p">(</span><span class="n">xd</span><span class="o">-&gt;</span><span class="n">name_len</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">xd</span><span class="o">-&gt;</span><span class="n">value_len</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">xd</span><span class="o">-&gt;</span><span class="n">xname</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">list_del_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">xd</span><span class="o">-&gt;</span><span class="n">xindex</span><span class="p">);</span>
	<span class="n">xd</span><span class="o">-&gt;</span><span class="n">hashkey</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">xd</span><span class="o">-&gt;</span><span class="n">xname</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">xd</span><span class="o">-&gt;</span><span class="n">xvalue</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">reclaim_xattr_datum</span><span class="p">(</span><span class="k">struct</span> <span class="n">jffs2_sb_info</span> <span class="o">*</span><span class="n">c</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* must be called under down_write(xattr_sem) */</span>
	<span class="k">struct</span> <span class="n">jffs2_xattr_datum</span> <span class="o">*</span><span class="n">xd</span><span class="p">,</span> <span class="o">*</span><span class="n">_xd</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">target</span><span class="p">,</span> <span class="n">before</span><span class="p">;</span>
	<span class="k">static</span> <span class="kt">int</span> <span class="n">index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">count</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">xdatum_mem_threshold</span> <span class="o">&gt;</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">xdatum_mem_usage</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">before</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">xdatum_mem_usage</span><span class="p">;</span>
	<span class="n">target</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">xdatum_mem_usage</span> <span class="o">*</span> <span class="mi">4</span> <span class="o">/</span> <span class="mi">5</span><span class="p">;</span> <span class="cm">/* 20% reduction */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">count</span> <span class="o">&lt;</span> <span class="n">XATTRINDEX_HASHSIZE</span><span class="p">;</span> <span class="n">count</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">xd</span><span class="p">,</span> <span class="n">_xd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">xattrindex</span><span class="p">[</span><span class="n">index</span><span class="p">],</span> <span class="n">xindex</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">xd</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">JFFS2_XFLAGS_HOT</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">xd</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">JFFS2_XFLAGS_HOT</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">xd</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">JFFS2_XFLAGS_BIND</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">unload_xattr_datum</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">xd</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">xdatum_mem_usage</span> <span class="o">&lt;=</span> <span class="n">target</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">index</span> <span class="o">=</span> <span class="p">(</span><span class="n">index</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">XATTRINDEX_HASHSIZE</span><span class="p">;</span>
	<span class="p">}</span>
 <span class="nl">out:</span>
	<span class="n">JFFS2_NOTICE</span><span class="p">(</span><span class="s">&quot;xdatum_mem_usage from %u byte to %u byte (%u byte reclaimed)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		     <span class="n">before</span><span class="p">,</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">xdatum_mem_usage</span><span class="p">,</span> <span class="n">before</span> <span class="o">-</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">xdatum_mem_usage</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">do_verify_xattr_datum</span><span class="p">(</span><span class="k">struct</span> <span class="n">jffs2_sb_info</span> <span class="o">*</span><span class="n">c</span><span class="p">,</span> <span class="k">struct</span> <span class="n">jffs2_xattr_datum</span> <span class="o">*</span><span class="n">xd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* must be called under down_write(xattr_sem) */</span>
	<span class="k">struct</span> <span class="n">jffs2_eraseblock</span> <span class="o">*</span><span class="n">jeb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">jffs2_raw_node_ref</span> <span class="o">*</span><span class="n">raw</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">jffs2_raw_xattr</span> <span class="n">rx</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">readlen</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">crc</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">totlen</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">erase_completion_lock</span><span class="p">);</span>
	<span class="n">offset</span> <span class="o">=</span> <span class="n">ref_offset</span><span class="p">(</span><span class="n">xd</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ref_flags</span><span class="p">(</span><span class="n">xd</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">)</span> <span class="o">==</span> <span class="n">REF_PRISTINE</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">complete</span><span class="p">;</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">erase_completion_lock</span><span class="p">);</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">jffs2_flash_read</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">rx</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">readlen</span><span class="p">,</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">rx</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">||</span> <span class="n">readlen</span> <span class="o">!=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">rx</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">JFFS2_WARNING</span><span class="p">(</span><span class="s">&quot;jffs2_flash_read()=%d, req=%zu, read=%zu at %#08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			      <span class="n">rc</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">rx</span><span class="p">),</span> <span class="n">readlen</span><span class="p">,</span> <span class="n">offset</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">rc</span> <span class="o">?</span> <span class="n">rc</span> <span class="o">:</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">crc</span> <span class="o">=</span> <span class="n">crc32</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rx</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">rx</span><span class="p">)</span> <span class="o">-</span> <span class="mi">4</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">crc</span> <span class="o">!=</span> <span class="n">je32_to_cpu</span><span class="p">(</span><span class="n">rx</span><span class="p">.</span><span class="n">node_crc</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">JFFS2_ERROR</span><span class="p">(</span><span class="s">&quot;node CRC failed at %#08x, read=%#08x, calc=%#08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">offset</span><span class="p">,</span> <span class="n">je32_to_cpu</span><span class="p">(</span><span class="n">rx</span><span class="p">.</span><span class="n">hdr_crc</span><span class="p">),</span> <span class="n">crc</span><span class="p">);</span>
		<span class="n">xd</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">JFFS2_XFLAGS_INVALID</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">JFFS2_XATTR_IS_CORRUPTED</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">totlen</span> <span class="o">=</span> <span class="n">PAD</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">rx</span><span class="p">)</span> <span class="o">+</span> <span class="n">rx</span><span class="p">.</span><span class="n">name_len</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">je16_to_cpu</span><span class="p">(</span><span class="n">rx</span><span class="p">.</span><span class="n">value_len</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">je16_to_cpu</span><span class="p">(</span><span class="n">rx</span><span class="p">.</span><span class="n">magic</span><span class="p">)</span> <span class="o">!=</span> <span class="n">JFFS2_MAGIC_BITMASK</span>
	    <span class="o">||</span> <span class="n">je16_to_cpu</span><span class="p">(</span><span class="n">rx</span><span class="p">.</span><span class="n">nodetype</span><span class="p">)</span> <span class="o">!=</span> <span class="n">JFFS2_NODETYPE_XATTR</span>
	    <span class="o">||</span> <span class="n">je32_to_cpu</span><span class="p">(</span><span class="n">rx</span><span class="p">.</span><span class="n">totlen</span><span class="p">)</span> <span class="o">!=</span> <span class="n">totlen</span>
	    <span class="o">||</span> <span class="n">je32_to_cpu</span><span class="p">(</span><span class="n">rx</span><span class="p">.</span><span class="n">xid</span><span class="p">)</span> <span class="o">!=</span> <span class="n">xd</span><span class="o">-&gt;</span><span class="n">xid</span>
	    <span class="o">||</span> <span class="n">je32_to_cpu</span><span class="p">(</span><span class="n">rx</span><span class="p">.</span><span class="n">version</span><span class="p">)</span> <span class="o">!=</span> <span class="n">xd</span><span class="o">-&gt;</span><span class="n">version</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">JFFS2_ERROR</span><span class="p">(</span><span class="s">&quot;inconsistent xdatum at %#08x, magic=%#04x/%#04x, &quot;</span>
			    <span class="s">&quot;nodetype=%#04x/%#04x, totlen=%u/%u, xid=%u/%u, version=%u/%u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">offset</span><span class="p">,</span> <span class="n">je16_to_cpu</span><span class="p">(</span><span class="n">rx</span><span class="p">.</span><span class="n">magic</span><span class="p">),</span> <span class="n">JFFS2_MAGIC_BITMASK</span><span class="p">,</span>
			    <span class="n">je16_to_cpu</span><span class="p">(</span><span class="n">rx</span><span class="p">.</span><span class="n">nodetype</span><span class="p">),</span> <span class="n">JFFS2_NODETYPE_XATTR</span><span class="p">,</span>
			    <span class="n">je32_to_cpu</span><span class="p">(</span><span class="n">rx</span><span class="p">.</span><span class="n">totlen</span><span class="p">),</span> <span class="n">totlen</span><span class="p">,</span>
			    <span class="n">je32_to_cpu</span><span class="p">(</span><span class="n">rx</span><span class="p">.</span><span class="n">xid</span><span class="p">),</span> <span class="n">xd</span><span class="o">-&gt;</span><span class="n">xid</span><span class="p">,</span>
			    <span class="n">je32_to_cpu</span><span class="p">(</span><span class="n">rx</span><span class="p">.</span><span class="n">version</span><span class="p">),</span> <span class="n">xd</span><span class="o">-&gt;</span><span class="n">version</span><span class="p">);</span>
		<span class="n">xd</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">JFFS2_XFLAGS_INVALID</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">JFFS2_XATTR_IS_CORRUPTED</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">xd</span><span class="o">-&gt;</span><span class="n">xprefix</span> <span class="o">=</span> <span class="n">rx</span><span class="p">.</span><span class="n">xprefix</span><span class="p">;</span>
	<span class="n">xd</span><span class="o">-&gt;</span><span class="n">name_len</span> <span class="o">=</span> <span class="n">rx</span><span class="p">.</span><span class="n">name_len</span><span class="p">;</span>
	<span class="n">xd</span><span class="o">-&gt;</span><span class="n">value_len</span> <span class="o">=</span> <span class="n">je16_to_cpu</span><span class="p">(</span><span class="n">rx</span><span class="p">.</span><span class="n">value_len</span><span class="p">);</span>
	<span class="n">xd</span><span class="o">-&gt;</span><span class="n">data_crc</span> <span class="o">=</span> <span class="n">je32_to_cpu</span><span class="p">(</span><span class="n">rx</span><span class="p">.</span><span class="n">data_crc</span><span class="p">);</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">erase_completion_lock</span><span class="p">);</span>
 <span class="nl">complete:</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">raw</span><span class="o">=</span><span class="n">xd</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">;</span> <span class="n">raw</span> <span class="o">!=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">xd</span><span class="p">;</span> <span class="n">raw</span><span class="o">=</span><span class="n">raw</span><span class="o">-&gt;</span><span class="n">next_in_ino</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">jeb</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">blocks</span><span class="p">[</span><span class="n">ref_offset</span><span class="p">(</span><span class="n">raw</span><span class="p">)</span> <span class="o">/</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">sector_size</span><span class="p">];</span>
		<span class="n">totlen</span> <span class="o">=</span> <span class="n">PAD</span><span class="p">(</span><span class="n">ref_totlen</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">jeb</span><span class="p">,</span> <span class="n">raw</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ref_flags</span><span class="p">(</span><span class="n">raw</span><span class="p">)</span> <span class="o">==</span> <span class="n">REF_UNCHECKED</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">c</span><span class="o">-&gt;</span><span class="n">unchecked_size</span> <span class="o">-=</span> <span class="n">totlen</span><span class="p">;</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">used_size</span> <span class="o">+=</span> <span class="n">totlen</span><span class="p">;</span>
			<span class="n">jeb</span><span class="o">-&gt;</span><span class="n">unchecked_size</span> <span class="o">-=</span> <span class="n">totlen</span><span class="p">;</span> <span class="n">jeb</span><span class="o">-&gt;</span><span class="n">used_size</span> <span class="o">+=</span> <span class="n">totlen</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">raw</span><span class="o">-&gt;</span><span class="n">flash_offset</span> <span class="o">=</span> <span class="n">ref_offset</span><span class="p">(</span><span class="n">raw</span><span class="p">)</span> <span class="o">|</span> <span class="p">((</span><span class="n">xd</span><span class="o">-&gt;</span><span class="n">node</span><span class="o">==</span><span class="n">raw</span><span class="p">)</span> <span class="o">?</span> <span class="n">REF_PRISTINE</span> <span class="o">:</span> <span class="n">REF_NORMAL</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">erase_completion_lock</span><span class="p">);</span>

	<span class="cm">/* unchecked xdatum is chained with c-&gt;xattr_unchecked */</span>
	<span class="n">list_del_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">xd</span><span class="o">-&gt;</span><span class="n">xindex</span><span class="p">);</span>

	<span class="n">dbg_xattr</span><span class="p">(</span><span class="s">&quot;success on verfying xdatum (xid=%u, version=%u)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		  <span class="n">xd</span><span class="o">-&gt;</span><span class="n">xid</span><span class="p">,</span> <span class="n">xd</span><span class="o">-&gt;</span><span class="n">version</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">do_load_xattr_datum</span><span class="p">(</span><span class="k">struct</span> <span class="n">jffs2_sb_info</span> <span class="o">*</span><span class="n">c</span><span class="p">,</span> <span class="k">struct</span> <span class="n">jffs2_xattr_datum</span> <span class="o">*</span><span class="n">xd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* must be called under down_write(xattr_sem) */</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">data</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">readlen</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">crc</span><span class="p">,</span> <span class="n">length</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">ret</span><span class="p">,</span> <span class="n">retry</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">ref_flags</span><span class="p">(</span><span class="n">xd</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">)</span> <span class="o">!=</span> <span class="n">REF_PRISTINE</span><span class="p">);</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">xd</span><span class="o">-&gt;</span><span class="n">xindex</span><span class="p">));</span>
 <span class="nl">retry:</span>
	<span class="n">length</span> <span class="o">=</span> <span class="n">xd</span><span class="o">-&gt;</span><span class="n">name_len</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">xd</span><span class="o">-&gt;</span><span class="n">value_len</span><span class="p">;</span>
	<span class="n">data</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">length</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">data</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">jffs2_flash_read</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">ref_offset</span><span class="p">(</span><span class="n">xd</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">)</span><span class="o">+</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">jffs2_raw_xattr</span><span class="p">),</span>
			       <span class="n">length</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">readlen</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">||</span> <span class="n">length</span><span class="o">!=</span><span class="n">readlen</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">JFFS2_WARNING</span><span class="p">(</span><span class="s">&quot;jffs2_flash_read() returned %d, request=%d, readlen=%zu, at %#08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			      <span class="n">ret</span><span class="p">,</span> <span class="n">length</span><span class="p">,</span> <span class="n">readlen</span><span class="p">,</span> <span class="n">ref_offset</span><span class="p">(</span><span class="n">xd</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">));</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span> <span class="o">?</span> <span class="n">ret</span> <span class="o">:</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">data</span><span class="p">[</span><span class="n">xd</span><span class="o">-&gt;</span><span class="n">name_len</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
	<span class="n">crc</span> <span class="o">=</span> <span class="n">crc32</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">length</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">crc</span> <span class="o">!=</span> <span class="n">xd</span><span class="o">-&gt;</span><span class="n">data_crc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">JFFS2_WARNING</span><span class="p">(</span><span class="s">&quot;node CRC failed (JFFS2_NODETYPE_XATTR)&quot;</span>
			      <span class="s">&quot; at %#08x, read: 0x%08x calculated: 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			      <span class="n">ref_offset</span><span class="p">(</span><span class="n">xd</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">),</span> <span class="n">xd</span><span class="o">-&gt;</span><span class="n">data_crc</span><span class="p">,</span> <span class="n">crc</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>
		<span class="n">xd</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">JFFS2_XFLAGS_INVALID</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">JFFS2_XATTR_IS_CORRUPTED</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">xd</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">JFFS2_XFLAGS_HOT</span><span class="p">;</span>
	<span class="n">xd</span><span class="o">-&gt;</span><span class="n">xname</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="n">xd</span><span class="o">-&gt;</span><span class="n">xvalue</span> <span class="o">=</span> <span class="n">data</span> <span class="o">+</span> <span class="n">xd</span><span class="o">-&gt;</span><span class="n">name_len</span><span class="o">+</span><span class="mi">1</span><span class="p">;</span>

	<span class="n">c</span><span class="o">-&gt;</span><span class="n">xdatum_mem_usage</span> <span class="o">+=</span> <span class="n">length</span><span class="p">;</span>

	<span class="n">xd</span><span class="o">-&gt;</span><span class="n">hashkey</span> <span class="o">=</span> <span class="n">xattr_datum_hashkey</span><span class="p">(</span><span class="n">xd</span><span class="o">-&gt;</span><span class="n">xprefix</span><span class="p">,</span> <span class="n">xd</span><span class="o">-&gt;</span><span class="n">xname</span><span class="p">,</span> <span class="n">xd</span><span class="o">-&gt;</span><span class="n">xvalue</span><span class="p">,</span> <span class="n">xd</span><span class="o">-&gt;</span><span class="n">value_len</span><span class="p">);</span>
	<span class="n">i</span> <span class="o">=</span> <span class="n">xd</span><span class="o">-&gt;</span><span class="n">hashkey</span> <span class="o">%</span> <span class="n">XATTRINDEX_HASHSIZE</span><span class="p">;</span>
	<span class="n">list_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">xd</span><span class="o">-&gt;</span><span class="n">xindex</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">xattrindex</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">retry</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">retry</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">reclaim_xattr_datum</span><span class="p">(</span><span class="n">c</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">xd</span><span class="o">-&gt;</span><span class="n">xname</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">retry</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dbg_xattr</span><span class="p">(</span><span class="s">&quot;success on loading xdatum (xid=%u, xprefix=%u, xname=&#39;%s&#39;)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		  <span class="n">xd</span><span class="o">-&gt;</span><span class="n">xid</span><span class="p">,</span> <span class="n">xd</span><span class="o">-&gt;</span><span class="n">xprefix</span><span class="p">,</span> <span class="n">xd</span><span class="o">-&gt;</span><span class="n">xname</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">load_xattr_datum</span><span class="p">(</span><span class="k">struct</span> <span class="n">jffs2_sb_info</span> <span class="o">*</span><span class="n">c</span><span class="p">,</span> <span class="k">struct</span> <span class="n">jffs2_xattr_datum</span> <span class="o">*</span><span class="n">xd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* must be called under down_write(xattr_sem);</span>
<span class="cm">	 * rc &lt; 0 : recoverable error, try again</span>
<span class="cm">	 * rc = 0 : success</span>
<span class="cm">	 * rc &gt; 0 : Unrecoverable error, this node should be deleted.</span>
<span class="cm">	 */</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">xd</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">JFFS2_XFLAGS_DEAD</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">xd</span><span class="o">-&gt;</span><span class="n">xname</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">xd</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">JFFS2_XFLAGS_INVALID</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">JFFS2_XATTR_IS_CORRUPTED</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">is_xattr_datum_unchecked</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">xd</span><span class="p">)))</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">do_verify_xattr_datum</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">xd</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rc</span><span class="p">)</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">do_load_xattr_datum</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">xd</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">save_xattr_datum</span><span class="p">(</span><span class="k">struct</span> <span class="n">jffs2_sb_info</span> <span class="o">*</span><span class="n">c</span><span class="p">,</span> <span class="k">struct</span> <span class="n">jffs2_xattr_datum</span> <span class="o">*</span><span class="n">xd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* must be called under down_write(xattr_sem) */</span>
	<span class="k">struct</span> <span class="n">jffs2_raw_xattr</span> <span class="n">rx</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">kvec</span> <span class="n">vecs</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="kt">size_t</span> <span class="n">length</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">,</span> <span class="n">totlen</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">phys_ofs</span> <span class="o">=</span> <span class="n">write_ofs</span><span class="p">(</span><span class="n">c</span><span class="p">);</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">xd</span><span class="o">-&gt;</span><span class="n">xname</span><span class="p">);</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">xd</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">JFFS2_XFLAGS_DEAD</span><span class="o">|</span><span class="n">JFFS2_XFLAGS_INVALID</span><span class="p">));</span>

	<span class="n">vecs</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">iov_base</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">rx</span><span class="p">;</span>
	<span class="n">vecs</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">iov_len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">rx</span><span class="p">);</span>
	<span class="n">vecs</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">iov_base</span> <span class="o">=</span> <span class="n">xd</span><span class="o">-&gt;</span><span class="n">xname</span><span class="p">;</span>
	<span class="n">vecs</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">iov_len</span> <span class="o">=</span> <span class="n">xd</span><span class="o">-&gt;</span><span class="n">name_len</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">xd</span><span class="o">-&gt;</span><span class="n">value_len</span><span class="p">;</span>
	<span class="n">totlen</span> <span class="o">=</span> <span class="n">vecs</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">iov_len</span> <span class="o">+</span> <span class="n">vecs</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">iov_len</span><span class="p">;</span>

	<span class="cm">/* Setup raw-xattr */</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rx</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">rx</span><span class="p">));</span>
	<span class="n">rx</span><span class="p">.</span><span class="n">magic</span> <span class="o">=</span> <span class="n">cpu_to_je16</span><span class="p">(</span><span class="n">JFFS2_MAGIC_BITMASK</span><span class="p">);</span>
	<span class="n">rx</span><span class="p">.</span><span class="n">nodetype</span> <span class="o">=</span> <span class="n">cpu_to_je16</span><span class="p">(</span><span class="n">JFFS2_NODETYPE_XATTR</span><span class="p">);</span>
	<span class="n">rx</span><span class="p">.</span><span class="n">totlen</span> <span class="o">=</span> <span class="n">cpu_to_je32</span><span class="p">(</span><span class="n">PAD</span><span class="p">(</span><span class="n">totlen</span><span class="p">));</span>
	<span class="n">rx</span><span class="p">.</span><span class="n">hdr_crc</span> <span class="o">=</span> <span class="n">cpu_to_je32</span><span class="p">(</span><span class="n">crc32</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rx</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">jffs2_unknown_node</span><span class="p">)</span> <span class="o">-</span> <span class="mi">4</span><span class="p">));</span>

	<span class="n">rx</span><span class="p">.</span><span class="n">xid</span> <span class="o">=</span> <span class="n">cpu_to_je32</span><span class="p">(</span><span class="n">xd</span><span class="o">-&gt;</span><span class="n">xid</span><span class="p">);</span>
	<span class="n">rx</span><span class="p">.</span><span class="n">version</span> <span class="o">=</span> <span class="n">cpu_to_je32</span><span class="p">(</span><span class="o">++</span><span class="n">xd</span><span class="o">-&gt;</span><span class="n">version</span><span class="p">);</span>
	<span class="n">rx</span><span class="p">.</span><span class="n">xprefix</span> <span class="o">=</span> <span class="n">xd</span><span class="o">-&gt;</span><span class="n">xprefix</span><span class="p">;</span>
	<span class="n">rx</span><span class="p">.</span><span class="n">name_len</span> <span class="o">=</span> <span class="n">xd</span><span class="o">-&gt;</span><span class="n">name_len</span><span class="p">;</span>
	<span class="n">rx</span><span class="p">.</span><span class="n">value_len</span> <span class="o">=</span> <span class="n">cpu_to_je16</span><span class="p">(</span><span class="n">xd</span><span class="o">-&gt;</span><span class="n">value_len</span><span class="p">);</span>
	<span class="n">rx</span><span class="p">.</span><span class="n">data_crc</span> <span class="o">=</span> <span class="n">cpu_to_je32</span><span class="p">(</span><span class="n">crc32</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">vecs</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">iov_base</span><span class="p">,</span> <span class="n">vecs</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">iov_len</span><span class="p">));</span>
	<span class="n">rx</span><span class="p">.</span><span class="n">node_crc</span> <span class="o">=</span> <span class="n">cpu_to_je32</span><span class="p">(</span><span class="n">crc32</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rx</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">jffs2_raw_xattr</span><span class="p">)</span> <span class="o">-</span> <span class="mi">4</span><span class="p">));</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">jffs2_flash_writev</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">vecs</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">phys_ofs</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">length</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">||</span> <span class="n">totlen</span> <span class="o">!=</span> <span class="n">length</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">JFFS2_WARNING</span><span class="p">(</span><span class="s">&quot;jffs2_flash_writev()=%d, req=%u, wrote=%zu, at %#08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			      <span class="n">rc</span><span class="p">,</span> <span class="n">totlen</span><span class="p">,</span> <span class="n">length</span><span class="p">,</span> <span class="n">phys_ofs</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">rc</span> <span class="o">?</span> <span class="n">rc</span> <span class="o">:</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">length</span><span class="p">)</span>
			<span class="n">jffs2_add_physical_node_ref</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">phys_ofs</span> <span class="o">|</span> <span class="n">REF_OBSOLETE</span><span class="p">,</span> <span class="n">PAD</span><span class="p">(</span><span class="n">totlen</span><span class="p">),</span> <span class="nb">NULL</span><span class="p">);</span>

		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* success */</span>
	<span class="n">jffs2_add_physical_node_ref</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">phys_ofs</span> <span class="o">|</span> <span class="n">REF_PRISTINE</span><span class="p">,</span> <span class="n">PAD</span><span class="p">(</span><span class="n">totlen</span><span class="p">),</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">xd</span><span class="p">);</span>

	<span class="n">dbg_xattr</span><span class="p">(</span><span class="s">&quot;success on saving xdatum (xid=%u, version=%u, xprefix=%u, xname=&#39;%s&#39;)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		  <span class="n">xd</span><span class="o">-&gt;</span><span class="n">xid</span><span class="p">,</span> <span class="n">xd</span><span class="o">-&gt;</span><span class="n">version</span><span class="p">,</span> <span class="n">xd</span><span class="o">-&gt;</span><span class="n">xprefix</span><span class="p">,</span> <span class="n">xd</span><span class="o">-&gt;</span><span class="n">xname</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">jffs2_xattr_datum</span> <span class="o">*</span><span class="nf">create_xattr_datum</span><span class="p">(</span><span class="k">struct</span> <span class="n">jffs2_sb_info</span> <span class="o">*</span><span class="n">c</span><span class="p">,</span>
						    <span class="kt">int</span> <span class="n">xprefix</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">xname</span><span class="p">,</span>
						    <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">xvalue</span><span class="p">,</span> <span class="kt">int</span> <span class="n">xsize</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* must be called under down_write(xattr_sem) */</span>
	<span class="k">struct</span> <span class="n">jffs2_xattr_datum</span> <span class="o">*</span><span class="n">xd</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">hashkey</span><span class="p">,</span> <span class="n">name_len</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">rc</span><span class="p">;</span>

	<span class="cm">/* Search xattr_datum has same xname/xvalue by index */</span>
	<span class="n">hashkey</span> <span class="o">=</span> <span class="n">xattr_datum_hashkey</span><span class="p">(</span><span class="n">xprefix</span><span class="p">,</span> <span class="n">xname</span><span class="p">,</span> <span class="n">xvalue</span><span class="p">,</span> <span class="n">xsize</span><span class="p">);</span>
	<span class="n">i</span> <span class="o">=</span> <span class="n">hashkey</span> <span class="o">%</span> <span class="n">XATTRINDEX_HASHSIZE</span><span class="p">;</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">xd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">xattrindex</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">xindex</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">xd</span><span class="o">-&gt;</span><span class="n">hashkey</span><span class="o">==</span><span class="n">hashkey</span>
		    <span class="o">&amp;&amp;</span> <span class="n">xd</span><span class="o">-&gt;</span><span class="n">xprefix</span><span class="o">==</span><span class="n">xprefix</span>
		    <span class="o">&amp;&amp;</span> <span class="n">xd</span><span class="o">-&gt;</span><span class="n">value_len</span><span class="o">==</span><span class="n">xsize</span>
		    <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">xd</span><span class="o">-&gt;</span><span class="n">xname</span><span class="p">,</span> <span class="n">xname</span><span class="p">)</span>
		    <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">memcmp</span><span class="p">(</span><span class="n">xd</span><span class="o">-&gt;</span><span class="n">xvalue</span><span class="p">,</span> <span class="n">xvalue</span><span class="p">,</span> <span class="n">xsize</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">xd</span><span class="o">-&gt;</span><span class="n">refcnt</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">xd</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* Not found, Create NEW XATTR-Cache */</span>
	<span class="n">name_len</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">xname</span><span class="p">);</span>

	<span class="n">xd</span> <span class="o">=</span> <span class="n">jffs2_alloc_xattr_datum</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">xd</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">ENOMEM</span><span class="p">);</span>

	<span class="n">data</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">name_len</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">xsize</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">data</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">jffs2_free_xattr_datum</span><span class="p">(</span><span class="n">xd</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">ENOMEM</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">strcpy</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">xname</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">data</span> <span class="o">+</span> <span class="n">name_len</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">xvalue</span><span class="p">,</span> <span class="n">xsize</span><span class="p">);</span>

	<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">xd</span><span class="o">-&gt;</span><span class="n">refcnt</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">xd</span><span class="o">-&gt;</span><span class="n">xid</span> <span class="o">=</span> <span class="o">++</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">highest_xid</span><span class="p">;</span>
	<span class="n">xd</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">JFFS2_XFLAGS_HOT</span><span class="p">;</span>
	<span class="n">xd</span><span class="o">-&gt;</span><span class="n">xprefix</span> <span class="o">=</span> <span class="n">xprefix</span><span class="p">;</span>

	<span class="n">xd</span><span class="o">-&gt;</span><span class="n">hashkey</span> <span class="o">=</span> <span class="n">hashkey</span><span class="p">;</span>
	<span class="n">xd</span><span class="o">-&gt;</span><span class="n">xname</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="n">xd</span><span class="o">-&gt;</span><span class="n">xvalue</span> <span class="o">=</span> <span class="n">data</span> <span class="o">+</span> <span class="n">name_len</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">xd</span><span class="o">-&gt;</span><span class="n">name_len</span> <span class="o">=</span> <span class="n">name_len</span><span class="p">;</span>
	<span class="n">xd</span><span class="o">-&gt;</span><span class="n">value_len</span> <span class="o">=</span> <span class="n">xsize</span><span class="p">;</span>
	<span class="n">xd</span><span class="o">-&gt;</span><span class="n">data_crc</span> <span class="o">=</span> <span class="n">crc32</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">xd</span><span class="o">-&gt;</span><span class="n">name_len</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">xd</span><span class="o">-&gt;</span><span class="n">value_len</span><span class="p">);</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">save_xattr_datum</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">xd</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">xd</span><span class="o">-&gt;</span><span class="n">xname</span><span class="p">);</span>
		<span class="n">jffs2_free_xattr_datum</span><span class="p">(</span><span class="n">xd</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="n">rc</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Insert Hash Index */</span>
	<span class="n">i</span> <span class="o">=</span> <span class="n">hashkey</span> <span class="o">%</span> <span class="n">XATTRINDEX_HASHSIZE</span><span class="p">;</span>
	<span class="n">list_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">xd</span><span class="o">-&gt;</span><span class="n">xindex</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">xattrindex</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

	<span class="n">c</span><span class="o">-&gt;</span><span class="n">xdatum_mem_usage</span> <span class="o">+=</span> <span class="p">(</span><span class="n">xd</span><span class="o">-&gt;</span><span class="n">name_len</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">xd</span><span class="o">-&gt;</span><span class="n">value_len</span><span class="p">);</span>
	<span class="n">reclaim_xattr_datum</span><span class="p">(</span><span class="n">c</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">xd</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">unrefer_xattr_datum</span><span class="p">(</span><span class="k">struct</span> <span class="n">jffs2_sb_info</span> <span class="o">*</span><span class="n">c</span><span class="p">,</span> <span class="k">struct</span> <span class="n">jffs2_xattr_datum</span> <span class="o">*</span><span class="n">xd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* must be called under down_write(xattr_sem) */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">atomic_dec_and_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">xd</span><span class="o">-&gt;</span><span class="n">refcnt</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">erase_completion_lock</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">unload_xattr_datum</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">xd</span><span class="p">);</span>
		<span class="n">xd</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">JFFS2_XFLAGS_DEAD</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">xd</span><span class="o">-&gt;</span><span class="n">node</span> <span class="o">==</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">xd</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">xd</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">JFFS2_XFLAGS_INVALID</span><span class="p">));</span>
			<span class="n">jffs2_free_xattr_datum</span><span class="p">(</span><span class="n">xd</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">list_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">xd</span><span class="o">-&gt;</span><span class="n">xindex</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">xattr_dead_list</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">erase_completion_lock</span><span class="p">);</span>

		<span class="n">dbg_xattr</span><span class="p">(</span><span class="s">&quot;xdatum(xid=%u, version=%u) was removed.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">xd</span><span class="o">-&gt;</span><span class="n">xid</span><span class="p">,</span> <span class="n">xd</span><span class="o">-&gt;</span><span class="n">version</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* -------- xref related functions ------------------</span>
<span class="cm"> * verify_xattr_ref(c, ref)</span>
<span class="cm"> *   is used to load xref information from medium. Because summary data does not</span>
<span class="cm"> *   contain xid/ino, it&#39;s necessary to verify once while mounting process.</span>
<span class="cm"> * save_xattr_ref(c, ref)</span>
<span class="cm"> *   is used to write xref to medium. If delete marker is marked, it write</span>
<span class="cm"> *   a delete marker of xref into medium.</span>
<span class="cm"> * create_xattr_ref(c, ic, xd)</span>
<span class="cm"> *   is used to create a new xref and write to medium.</span>
<span class="cm"> * delete_xattr_ref(c, ref)</span>
<span class="cm"> *   is used to delete jffs2_xattr_ref. It marks xref XREF_DELETE_MARKER,</span>
<span class="cm"> *   and allows GC to reclaim those physical nodes.</span>
<span class="cm"> * jffs2_xattr_delete_inode(c, ic)</span>
<span class="cm"> *   is called to remove xrefs related to obsolete inode when inode is unlinked.</span>
<span class="cm"> * jffs2_xattr_free_inode(c, ic)</span>
<span class="cm"> *   is called to release xattr related objects when unmounting. </span>
<span class="cm"> * check_xattr_ref_inode(c, ic)</span>
<span class="cm"> *   is used to confirm inode does not have duplicate xattr name/value pair.</span>
<span class="cm"> * jffs2_xattr_do_crccheck_inode(c, ic)</span>
<span class="cm"> *   is used to force xattr data integrity check during the initial gc scan.</span>
<span class="cm"> * -------------------------------------------------- */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">verify_xattr_ref</span><span class="p">(</span><span class="k">struct</span> <span class="n">jffs2_sb_info</span> <span class="o">*</span><span class="n">c</span><span class="p">,</span> <span class="k">struct</span> <span class="n">jffs2_xattr_ref</span> <span class="o">*</span><span class="n">ref</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">jffs2_eraseblock</span> <span class="o">*</span><span class="n">jeb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">jffs2_raw_node_ref</span> <span class="o">*</span><span class="n">raw</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">jffs2_raw_xref</span> <span class="n">rr</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">readlen</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">crc</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">totlen</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">erase_completion_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ref_flags</span><span class="p">(</span><span class="n">ref</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">)</span> <span class="o">!=</span> <span class="n">REF_UNCHECKED</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">complete</span><span class="p">;</span>
	<span class="n">offset</span> <span class="o">=</span> <span class="n">ref_offset</span><span class="p">(</span><span class="n">ref</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">);</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">erase_completion_lock</span><span class="p">);</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">jffs2_flash_read</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">rr</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">readlen</span><span class="p">,</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">rr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">||</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">rr</span><span class="p">)</span> <span class="o">!=</span> <span class="n">readlen</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">JFFS2_WARNING</span><span class="p">(</span><span class="s">&quot;jffs2_flash_read()=%d, req=%zu, read=%zu, at %#08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			      <span class="n">rc</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">rr</span><span class="p">),</span> <span class="n">readlen</span><span class="p">,</span> <span class="n">offset</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">rc</span> <span class="o">?</span> <span class="n">rc</span> <span class="o">:</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* obsolete node */</span>
	<span class="n">crc</span> <span class="o">=</span> <span class="n">crc32</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rr</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">rr</span><span class="p">)</span> <span class="o">-</span> <span class="mi">4</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">crc</span> <span class="o">!=</span> <span class="n">je32_to_cpu</span><span class="p">(</span><span class="n">rr</span><span class="p">.</span><span class="n">node_crc</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">JFFS2_ERROR</span><span class="p">(</span><span class="s">&quot;node CRC failed at %#08x, read=%#08x, calc=%#08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">offset</span><span class="p">,</span> <span class="n">je32_to_cpu</span><span class="p">(</span><span class="n">rr</span><span class="p">.</span><span class="n">node_crc</span><span class="p">),</span> <span class="n">crc</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">JFFS2_XATTR_IS_CORRUPTED</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">je16_to_cpu</span><span class="p">(</span><span class="n">rr</span><span class="p">.</span><span class="n">magic</span><span class="p">)</span> <span class="o">!=</span> <span class="n">JFFS2_MAGIC_BITMASK</span>
	    <span class="o">||</span> <span class="n">je16_to_cpu</span><span class="p">(</span><span class="n">rr</span><span class="p">.</span><span class="n">nodetype</span><span class="p">)</span> <span class="o">!=</span> <span class="n">JFFS2_NODETYPE_XREF</span>
	    <span class="o">||</span> <span class="n">je32_to_cpu</span><span class="p">(</span><span class="n">rr</span><span class="p">.</span><span class="n">totlen</span><span class="p">)</span> <span class="o">!=</span> <span class="n">PAD</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">rr</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">JFFS2_ERROR</span><span class="p">(</span><span class="s">&quot;inconsistent xref at %#08x, magic=%#04x/%#04x, &quot;</span>
			    <span class="s">&quot;nodetype=%#04x/%#04x, totlen=%u/%zu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">offset</span><span class="p">,</span> <span class="n">je16_to_cpu</span><span class="p">(</span><span class="n">rr</span><span class="p">.</span><span class="n">magic</span><span class="p">),</span> <span class="n">JFFS2_MAGIC_BITMASK</span><span class="p">,</span>
			    <span class="n">je16_to_cpu</span><span class="p">(</span><span class="n">rr</span><span class="p">.</span><span class="n">nodetype</span><span class="p">),</span> <span class="n">JFFS2_NODETYPE_XREF</span><span class="p">,</span>
			    <span class="n">je32_to_cpu</span><span class="p">(</span><span class="n">rr</span><span class="p">.</span><span class="n">totlen</span><span class="p">),</span> <span class="n">PAD</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">rr</span><span class="p">)));</span>
		<span class="k">return</span> <span class="n">JFFS2_XATTR_IS_CORRUPTED</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ref</span><span class="o">-&gt;</span><span class="n">ino</span> <span class="o">=</span> <span class="n">je32_to_cpu</span><span class="p">(</span><span class="n">rr</span><span class="p">.</span><span class="n">ino</span><span class="p">);</span>
	<span class="n">ref</span><span class="o">-&gt;</span><span class="n">xid</span> <span class="o">=</span> <span class="n">je32_to_cpu</span><span class="p">(</span><span class="n">rr</span><span class="p">.</span><span class="n">xid</span><span class="p">);</span>
	<span class="n">ref</span><span class="o">-&gt;</span><span class="n">xseqno</span> <span class="o">=</span> <span class="n">je32_to_cpu</span><span class="p">(</span><span class="n">rr</span><span class="p">.</span><span class="n">xseqno</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ref</span><span class="o">-&gt;</span><span class="n">xseqno</span> <span class="o">&gt;</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">highest_xseqno</span><span class="p">)</span>
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">highest_xseqno</span> <span class="o">=</span> <span class="p">(</span><span class="n">ref</span><span class="o">-&gt;</span><span class="n">xseqno</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">XREF_DELETE_MARKER</span><span class="p">);</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">erase_completion_lock</span><span class="p">);</span>
 <span class="nl">complete:</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">raw</span><span class="o">=</span><span class="n">ref</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">;</span> <span class="n">raw</span> <span class="o">!=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">ref</span><span class="p">;</span> <span class="n">raw</span><span class="o">=</span><span class="n">raw</span><span class="o">-&gt;</span><span class="n">next_in_ino</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">jeb</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">blocks</span><span class="p">[</span><span class="n">ref_offset</span><span class="p">(</span><span class="n">raw</span><span class="p">)</span> <span class="o">/</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">sector_size</span><span class="p">];</span>
		<span class="n">totlen</span> <span class="o">=</span> <span class="n">PAD</span><span class="p">(</span><span class="n">ref_totlen</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">jeb</span><span class="p">,</span> <span class="n">raw</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ref_flags</span><span class="p">(</span><span class="n">raw</span><span class="p">)</span> <span class="o">==</span> <span class="n">REF_UNCHECKED</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">c</span><span class="o">-&gt;</span><span class="n">unchecked_size</span> <span class="o">-=</span> <span class="n">totlen</span><span class="p">;</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">used_size</span> <span class="o">+=</span> <span class="n">totlen</span><span class="p">;</span>
			<span class="n">jeb</span><span class="o">-&gt;</span><span class="n">unchecked_size</span> <span class="o">-=</span> <span class="n">totlen</span><span class="p">;</span> <span class="n">jeb</span><span class="o">-&gt;</span><span class="n">used_size</span> <span class="o">+=</span> <span class="n">totlen</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">raw</span><span class="o">-&gt;</span><span class="n">flash_offset</span> <span class="o">=</span> <span class="n">ref_offset</span><span class="p">(</span><span class="n">raw</span><span class="p">)</span> <span class="o">|</span> <span class="p">((</span><span class="n">ref</span><span class="o">-&gt;</span><span class="n">node</span><span class="o">==</span><span class="n">raw</span><span class="p">)</span> <span class="o">?</span> <span class="n">REF_PRISTINE</span> <span class="o">:</span> <span class="n">REF_NORMAL</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">erase_completion_lock</span><span class="p">);</span>

	<span class="n">dbg_xattr</span><span class="p">(</span><span class="s">&quot;success on verifying xref (ino=%u, xid=%u) at %#08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		  <span class="n">ref</span><span class="o">-&gt;</span><span class="n">ino</span><span class="p">,</span> <span class="n">ref</span><span class="o">-&gt;</span><span class="n">xid</span><span class="p">,</span> <span class="n">ref_offset</span><span class="p">(</span><span class="n">ref</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">));</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">save_xattr_ref</span><span class="p">(</span><span class="k">struct</span> <span class="n">jffs2_sb_info</span> <span class="o">*</span><span class="n">c</span><span class="p">,</span> <span class="k">struct</span> <span class="n">jffs2_xattr_ref</span> <span class="o">*</span><span class="n">ref</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* must be called under down_write(xattr_sem) */</span>
	<span class="k">struct</span> <span class="n">jffs2_raw_xref</span> <span class="n">rr</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">length</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">xseqno</span><span class="p">,</span> <span class="n">phys_ofs</span> <span class="o">=</span> <span class="n">write_ofs</span><span class="p">(</span><span class="n">c</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">rr</span><span class="p">.</span><span class="n">magic</span> <span class="o">=</span> <span class="n">cpu_to_je16</span><span class="p">(</span><span class="n">JFFS2_MAGIC_BITMASK</span><span class="p">);</span>
	<span class="n">rr</span><span class="p">.</span><span class="n">nodetype</span> <span class="o">=</span> <span class="n">cpu_to_je16</span><span class="p">(</span><span class="n">JFFS2_NODETYPE_XREF</span><span class="p">);</span>
	<span class="n">rr</span><span class="p">.</span><span class="n">totlen</span> <span class="o">=</span> <span class="n">cpu_to_je32</span><span class="p">(</span><span class="n">PAD</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">rr</span><span class="p">)));</span>
	<span class="n">rr</span><span class="p">.</span><span class="n">hdr_crc</span> <span class="o">=</span> <span class="n">cpu_to_je32</span><span class="p">(</span><span class="n">crc32</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rr</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">jffs2_unknown_node</span><span class="p">)</span> <span class="o">-</span> <span class="mi">4</span><span class="p">));</span>

	<span class="n">xseqno</span> <span class="o">=</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">highest_xseqno</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">is_xattr_ref_dead</span><span class="p">(</span><span class="n">ref</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">xseqno</span> <span class="o">|=</span> <span class="n">XREF_DELETE_MARKER</span><span class="p">;</span>
		<span class="n">rr</span><span class="p">.</span><span class="n">ino</span> <span class="o">=</span> <span class="n">cpu_to_je32</span><span class="p">(</span><span class="n">ref</span><span class="o">-&gt;</span><span class="n">ino</span><span class="p">);</span>
		<span class="n">rr</span><span class="p">.</span><span class="n">xid</span> <span class="o">=</span> <span class="n">cpu_to_je32</span><span class="p">(</span><span class="n">ref</span><span class="o">-&gt;</span><span class="n">xid</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">rr</span><span class="p">.</span><span class="n">ino</span> <span class="o">=</span> <span class="n">cpu_to_je32</span><span class="p">(</span><span class="n">ref</span><span class="o">-&gt;</span><span class="n">ic</span><span class="o">-&gt;</span><span class="n">ino</span><span class="p">);</span>
		<span class="n">rr</span><span class="p">.</span><span class="n">xid</span> <span class="o">=</span> <span class="n">cpu_to_je32</span><span class="p">(</span><span class="n">ref</span><span class="o">-&gt;</span><span class="n">xd</span><span class="o">-&gt;</span><span class="n">xid</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">rr</span><span class="p">.</span><span class="n">xseqno</span> <span class="o">=</span> <span class="n">cpu_to_je32</span><span class="p">(</span><span class="n">xseqno</span><span class="p">);</span>
	<span class="n">rr</span><span class="p">.</span><span class="n">node_crc</span> <span class="o">=</span> <span class="n">cpu_to_je32</span><span class="p">(</span><span class="n">crc32</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rr</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">rr</span><span class="p">)</span> <span class="o">-</span> <span class="mi">4</span><span class="p">));</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">jffs2_flash_write</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">phys_ofs</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">rr</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">length</span><span class="p">,</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">rr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">||</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">rr</span><span class="p">)</span> <span class="o">!=</span> <span class="n">length</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">JFFS2_WARNING</span><span class="p">(</span><span class="s">&quot;jffs2_flash_write() returned %d, request=%zu, retlen=%zu, at %#08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			      <span class="n">ret</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">rr</span><span class="p">),</span> <span class="n">length</span><span class="p">,</span> <span class="n">phys_ofs</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">ret</span> <span class="o">?</span> <span class="n">ret</span> <span class="o">:</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">length</span><span class="p">)</span>
			<span class="n">jffs2_add_physical_node_ref</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">phys_ofs</span> <span class="o">|</span> <span class="n">REF_OBSOLETE</span><span class="p">,</span> <span class="n">PAD</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">rr</span><span class="p">)),</span> <span class="nb">NULL</span><span class="p">);</span>

		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* success */</span>
	<span class="n">ref</span><span class="o">-&gt;</span><span class="n">xseqno</span> <span class="o">=</span> <span class="n">xseqno</span><span class="p">;</span>
	<span class="n">jffs2_add_physical_node_ref</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">phys_ofs</span> <span class="o">|</span> <span class="n">REF_PRISTINE</span><span class="p">,</span> <span class="n">PAD</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">rr</span><span class="p">)),</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">ref</span><span class="p">);</span>

	<span class="n">dbg_xattr</span><span class="p">(</span><span class="s">&quot;success on saving xref (ino=%u, xid=%u)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ref</span><span class="o">-&gt;</span><span class="n">ic</span><span class="o">-&gt;</span><span class="n">ino</span><span class="p">,</span> <span class="n">ref</span><span class="o">-&gt;</span><span class="n">xd</span><span class="o">-&gt;</span><span class="n">xid</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">jffs2_xattr_ref</span> <span class="o">*</span><span class="nf">create_xattr_ref</span><span class="p">(</span><span class="k">struct</span> <span class="n">jffs2_sb_info</span> <span class="o">*</span><span class="n">c</span><span class="p">,</span> <span class="k">struct</span> <span class="n">jffs2_inode_cache</span> <span class="o">*</span><span class="n">ic</span><span class="p">,</span>
						<span class="k">struct</span> <span class="n">jffs2_xattr_datum</span> <span class="o">*</span><span class="n">xd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* must be called under down_write(xattr_sem) */</span>
	<span class="k">struct</span> <span class="n">jffs2_xattr_ref</span> <span class="o">*</span><span class="n">ref</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ref</span> <span class="o">=</span> <span class="n">jffs2_alloc_xattr_ref</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ref</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">ENOMEM</span><span class="p">);</span>
	<span class="n">ref</span><span class="o">-&gt;</span><span class="n">ic</span> <span class="o">=</span> <span class="n">ic</span><span class="p">;</span>
	<span class="n">ref</span><span class="o">-&gt;</span><span class="n">xd</span> <span class="o">=</span> <span class="n">xd</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">save_xattr_ref</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">ref</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">jffs2_free_xattr_ref</span><span class="p">(</span><span class="n">ref</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="n">ret</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Chain to inode */</span>
	<span class="n">ref</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">ic</span><span class="o">-&gt;</span><span class="n">xref</span><span class="p">;</span>
	<span class="n">ic</span><span class="o">-&gt;</span><span class="n">xref</span> <span class="o">=</span> <span class="n">ref</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">ref</span><span class="p">;</span> <span class="cm">/* success */</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">delete_xattr_ref</span><span class="p">(</span><span class="k">struct</span> <span class="n">jffs2_sb_info</span> <span class="o">*</span><span class="n">c</span><span class="p">,</span> <span class="k">struct</span> <span class="n">jffs2_xattr_ref</span> <span class="o">*</span><span class="n">ref</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* must be called under down_write(xattr_sem) */</span>
	<span class="k">struct</span> <span class="n">jffs2_xattr_datum</span> <span class="o">*</span><span class="n">xd</span><span class="p">;</span>

	<span class="n">xd</span> <span class="o">=</span> <span class="n">ref</span><span class="o">-&gt;</span><span class="n">xd</span><span class="p">;</span>
	<span class="n">ref</span><span class="o">-&gt;</span><span class="n">xseqno</span> <span class="o">|=</span> <span class="n">XREF_DELETE_MARKER</span><span class="p">;</span>
	<span class="n">ref</span><span class="o">-&gt;</span><span class="n">ino</span> <span class="o">=</span> <span class="n">ref</span><span class="o">-&gt;</span><span class="n">ic</span><span class="o">-&gt;</span><span class="n">ino</span><span class="p">;</span>
	<span class="n">ref</span><span class="o">-&gt;</span><span class="n">xid</span> <span class="o">=</span> <span class="n">ref</span><span class="o">-&gt;</span><span class="n">xd</span><span class="o">-&gt;</span><span class="n">xid</span><span class="p">;</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">erase_completion_lock</span><span class="p">);</span>
	<span class="n">ref</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">xref_dead_list</span><span class="p">;</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">xref_dead_list</span> <span class="o">=</span> <span class="n">ref</span><span class="p">;</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">erase_completion_lock</span><span class="p">);</span>

	<span class="n">dbg_xattr</span><span class="p">(</span><span class="s">&quot;xref(ino=%u, xid=%u, xseqno=%u) was removed.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		  <span class="n">ref</span><span class="o">-&gt;</span><span class="n">ino</span><span class="p">,</span> <span class="n">ref</span><span class="o">-&gt;</span><span class="n">xid</span><span class="p">,</span> <span class="n">ref</span><span class="o">-&gt;</span><span class="n">xseqno</span><span class="p">);</span>

	<span class="n">unrefer_xattr_datum</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">xd</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">jffs2_xattr_delete_inode</span><span class="p">(</span><span class="k">struct</span> <span class="n">jffs2_sb_info</span> <span class="o">*</span><span class="n">c</span><span class="p">,</span> <span class="k">struct</span> <span class="n">jffs2_inode_cache</span> <span class="o">*</span><span class="n">ic</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* It&#39;s called from jffs2_evict_inode() on inode removing.</span>
<span class="cm">	   When an inode with XATTR is removed, those XATTRs must be removed. */</span>
	<span class="k">struct</span> <span class="n">jffs2_xattr_ref</span> <span class="o">*</span><span class="n">ref</span><span class="p">,</span> <span class="o">*</span><span class="n">_ref</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ic</span> <span class="o">||</span> <span class="n">ic</span><span class="o">-&gt;</span><span class="n">pino_nlink</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">down_write</span><span class="p">(</span><span class="o">&amp;</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">xattr_sem</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">ref</span> <span class="o">=</span> <span class="n">ic</span><span class="o">-&gt;</span><span class="n">xref</span><span class="p">;</span> <span class="n">ref</span><span class="p">;</span> <span class="n">ref</span> <span class="o">=</span> <span class="n">_ref</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">_ref</span> <span class="o">=</span> <span class="n">ref</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
		<span class="n">delete_xattr_ref</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">ref</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">ic</span><span class="o">-&gt;</span><span class="n">xref</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">up_write</span><span class="p">(</span><span class="o">&amp;</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">xattr_sem</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">jffs2_xattr_free_inode</span><span class="p">(</span><span class="k">struct</span> <span class="n">jffs2_sb_info</span> <span class="o">*</span><span class="n">c</span><span class="p">,</span> <span class="k">struct</span> <span class="n">jffs2_inode_cache</span> <span class="o">*</span><span class="n">ic</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* It&#39;s called from jffs2_free_ino_caches() until unmounting FS. */</span>
	<span class="k">struct</span> <span class="n">jffs2_xattr_datum</span> <span class="o">*</span><span class="n">xd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">jffs2_xattr_ref</span> <span class="o">*</span><span class="n">ref</span><span class="p">,</span> <span class="o">*</span><span class="n">_ref</span><span class="p">;</span>

	<span class="n">down_write</span><span class="p">(</span><span class="o">&amp;</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">xattr_sem</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">ref</span> <span class="o">=</span> <span class="n">ic</span><span class="o">-&gt;</span><span class="n">xref</span><span class="p">;</span> <span class="n">ref</span><span class="p">;</span> <span class="n">ref</span> <span class="o">=</span> <span class="n">_ref</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">_ref</span> <span class="o">=</span> <span class="n">ref</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
		<span class="n">xd</span> <span class="o">=</span> <span class="n">ref</span><span class="o">-&gt;</span><span class="n">xd</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">atomic_dec_and_test</span><span class="p">(</span><span class="o">&amp;</span><span class="n">xd</span><span class="o">-&gt;</span><span class="n">refcnt</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">unload_xattr_datum</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">xd</span><span class="p">);</span>
			<span class="n">jffs2_free_xattr_datum</span><span class="p">(</span><span class="n">xd</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">jffs2_free_xattr_ref</span><span class="p">(</span><span class="n">ref</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">ic</span><span class="o">-&gt;</span><span class="n">xref</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">up_write</span><span class="p">(</span><span class="o">&amp;</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">xattr_sem</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">check_xattr_ref_inode</span><span class="p">(</span><span class="k">struct</span> <span class="n">jffs2_sb_info</span> <span class="o">*</span><span class="n">c</span><span class="p">,</span> <span class="k">struct</span> <span class="n">jffs2_inode_cache</span> <span class="o">*</span><span class="n">ic</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* success of check_xattr_ref_inode() means that inode (ic) dose not have</span>
<span class="cm">	 * duplicate name/value pairs. If duplicate name/value pair would be found,</span>
<span class="cm">	 * one will be removed.</span>
<span class="cm">	 */</span>
	<span class="k">struct</span> <span class="n">jffs2_xattr_ref</span> <span class="o">*</span><span class="n">ref</span><span class="p">,</span> <span class="o">*</span><span class="n">cmp</span><span class="p">,</span> <span class="o">**</span><span class="n">pref</span><span class="p">,</span> <span class="o">**</span><span class="n">pcmp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="n">ic</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">INO_FLAGS_XATTR_CHECKED</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">down_write</span><span class="p">(</span><span class="o">&amp;</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">xattr_sem</span><span class="p">);</span>
 <span class="nl">retry:</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">ref</span><span class="o">=</span><span class="n">ic</span><span class="o">-&gt;</span><span class="n">xref</span><span class="p">,</span> <span class="n">pref</span><span class="o">=&amp;</span><span class="n">ic</span><span class="o">-&gt;</span><span class="n">xref</span><span class="p">;</span> <span class="n">ref</span><span class="p">;</span> <span class="n">pref</span><span class="o">=&amp;</span><span class="n">ref</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">,</span> <span class="n">ref</span><span class="o">=</span><span class="n">ref</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ref</span><span class="o">-&gt;</span><span class="n">xd</span><span class="o">-&gt;</span><span class="n">xname</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="n">load_xattr_datum</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">ref</span><span class="o">-&gt;</span><span class="n">xd</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">rc</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
				<span class="o">*</span><span class="n">pref</span> <span class="o">=</span> <span class="n">ref</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
				<span class="n">delete_xattr_ref</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">ref</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">retry</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">rc</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">))</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">cmp</span><span class="o">=</span><span class="n">ref</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">,</span> <span class="n">pcmp</span><span class="o">=&amp;</span><span class="n">ref</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span> <span class="n">cmp</span><span class="p">;</span> <span class="n">pcmp</span><span class="o">=&amp;</span><span class="n">cmp</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">,</span> <span class="n">cmp</span><span class="o">=</span><span class="n">cmp</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cmp</span><span class="o">-&gt;</span><span class="n">xd</span><span class="o">-&gt;</span><span class="n">xname</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ref</span><span class="o">-&gt;</span><span class="n">xd</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">JFFS2_XFLAGS_BIND</span><span class="p">;</span>
				<span class="n">rc</span> <span class="o">=</span> <span class="n">load_xattr_datum</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">cmp</span><span class="o">-&gt;</span><span class="n">xd</span><span class="p">);</span>
				<span class="n">ref</span><span class="o">-&gt;</span><span class="n">xd</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">JFFS2_XFLAGS_BIND</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">rc</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
					<span class="o">*</span><span class="n">pcmp</span> <span class="o">=</span> <span class="n">cmp</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
					<span class="n">delete_xattr_ref</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">cmp</span><span class="p">);</span>
					<span class="k">goto</span> <span class="n">retry</span><span class="p">;</span>
				<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">rc</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">))</span>
					<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ref</span><span class="o">-&gt;</span><span class="n">xd</span><span class="o">-&gt;</span><span class="n">xprefix</span> <span class="o">==</span> <span class="n">cmp</span><span class="o">-&gt;</span><span class="n">xd</span><span class="o">-&gt;</span><span class="n">xprefix</span>
			    <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">ref</span><span class="o">-&gt;</span><span class="n">xd</span><span class="o">-&gt;</span><span class="n">xname</span><span class="p">,</span> <span class="n">cmp</span><span class="o">-&gt;</span><span class="n">xd</span><span class="o">-&gt;</span><span class="n">xname</span><span class="p">))</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">ref</span><span class="o">-&gt;</span><span class="n">xseqno</span> <span class="o">&gt;</span> <span class="n">cmp</span><span class="o">-&gt;</span><span class="n">xseqno</span><span class="p">)</span> <span class="p">{</span>
					<span class="o">*</span><span class="n">pcmp</span> <span class="o">=</span> <span class="n">cmp</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
					<span class="n">delete_xattr_ref</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">cmp</span><span class="p">);</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="o">*</span><span class="n">pref</span> <span class="o">=</span> <span class="n">ref</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
					<span class="n">delete_xattr_ref</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">ref</span><span class="p">);</span>
				<span class="p">}</span>
				<span class="k">goto</span> <span class="n">retry</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">ic</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">INO_FLAGS_XATTR_CHECKED</span><span class="p">;</span>
 <span class="nl">out:</span>
	<span class="n">up_write</span><span class="p">(</span><span class="o">&amp;</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">xattr_sem</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">jffs2_xattr_do_crccheck_inode</span><span class="p">(</span><span class="k">struct</span> <span class="n">jffs2_sb_info</span> <span class="o">*</span><span class="n">c</span><span class="p">,</span> <span class="k">struct</span> <span class="n">jffs2_inode_cache</span> <span class="o">*</span><span class="n">ic</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">check_xattr_ref_inode</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">ic</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* -------- xattr subsystem functions ---------------</span>
<span class="cm"> * jffs2_init_xattr_subsystem(c)</span>
<span class="cm"> *   is used to initialize semaphore and list_head, and some variables.</span>
<span class="cm"> * jffs2_find_xattr_datum(c, xid)</span>
<span class="cm"> *   is used to lookup xdatum while scanning process.</span>
<span class="cm"> * jffs2_clear_xattr_subsystem(c)</span>
<span class="cm"> *   is used to release any xattr related objects.</span>
<span class="cm"> * jffs2_build_xattr_subsystem(c)</span>
<span class="cm"> *   is used to associate xdatum and xref while super block building process.</span>
<span class="cm"> * jffs2_setup_xattr_datum(c, xid, version)</span>
<span class="cm"> *   is used to insert xdatum while scanning process.</span>
<span class="cm"> * -------------------------------------------------- */</span>
<span class="kt">void</span> <span class="nf">jffs2_init_xattr_subsystem</span><span class="p">(</span><span class="k">struct</span> <span class="n">jffs2_sb_info</span> <span class="o">*</span><span class="n">c</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">XATTRINDEX_HASHSIZE</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">xattrindex</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">xattr_unchecked</span><span class="p">);</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">xattr_dead_list</span><span class="p">);</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">xref_dead_list</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">xref_temp</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">init_rwsem</span><span class="p">(</span><span class="o">&amp;</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">xattr_sem</span><span class="p">);</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">highest_xid</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">highest_xseqno</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">xdatum_mem_usage</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">xdatum_mem_threshold</span> <span class="o">=</span> <span class="mi">32</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">;</span>	<span class="cm">/* Default 32KB */</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">jffs2_xattr_datum</span> <span class="o">*</span><span class="nf">jffs2_find_xattr_datum</span><span class="p">(</span><span class="k">struct</span> <span class="n">jffs2_sb_info</span> <span class="o">*</span><span class="n">c</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">xid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">jffs2_xattr_datum</span> <span class="o">*</span><span class="n">xd</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">xid</span> <span class="o">%</span> <span class="n">XATTRINDEX_HASHSIZE</span><span class="p">;</span>

	<span class="cm">/* It&#39;s only used in scanning/building process. */</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">JFFS2_SB_FLAG_SCANNING</span><span class="o">|</span><span class="n">JFFS2_SB_FLAG_BUILDING</span><span class="p">)));</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">xd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">xattrindex</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">xindex</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">xd</span><span class="o">-&gt;</span><span class="n">xid</span><span class="o">==</span><span class="n">xid</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">xd</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">jffs2_clear_xattr_subsystem</span><span class="p">(</span><span class="k">struct</span> <span class="n">jffs2_sb_info</span> <span class="o">*</span><span class="n">c</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">jffs2_xattr_datum</span> <span class="o">*</span><span class="n">xd</span><span class="p">,</span> <span class="o">*</span><span class="n">_xd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">jffs2_xattr_ref</span> <span class="o">*</span><span class="n">ref</span><span class="p">,</span> <span class="o">*</span><span class="n">_ref</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">ref</span><span class="o">=</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">xref_temp</span><span class="p">;</span> <span class="n">ref</span><span class="p">;</span> <span class="n">ref</span> <span class="o">=</span> <span class="n">_ref</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">_ref</span> <span class="o">=</span> <span class="n">ref</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
		<span class="n">jffs2_free_xattr_ref</span><span class="p">(</span><span class="n">ref</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">ref</span><span class="o">=</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">xref_dead_list</span><span class="p">;</span> <span class="n">ref</span><span class="p">;</span> <span class="n">ref</span> <span class="o">=</span> <span class="n">_ref</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">_ref</span> <span class="o">=</span> <span class="n">ref</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
		<span class="n">jffs2_free_xattr_ref</span><span class="p">(</span><span class="n">ref</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">XATTRINDEX_HASHSIZE</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">xd</span><span class="p">,</span> <span class="n">_xd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">xattrindex</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">xindex</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">xd</span><span class="o">-&gt;</span><span class="n">xindex</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">xd</span><span class="o">-&gt;</span><span class="n">xname</span><span class="p">)</span>
				<span class="n">kfree</span><span class="p">(</span><span class="n">xd</span><span class="o">-&gt;</span><span class="n">xname</span><span class="p">);</span>
			<span class="n">jffs2_free_xattr_datum</span><span class="p">(</span><span class="n">xd</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">xd</span><span class="p">,</span> <span class="n">_xd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">xattr_dead_list</span><span class="p">,</span> <span class="n">xindex</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">xd</span><span class="o">-&gt;</span><span class="n">xindex</span><span class="p">);</span>
		<span class="n">jffs2_free_xattr_datum</span><span class="p">(</span><span class="n">xd</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">xd</span><span class="p">,</span> <span class="n">_xd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">xattr_unchecked</span><span class="p">,</span> <span class="n">xindex</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">xd</span><span class="o">-&gt;</span><span class="n">xindex</span><span class="p">);</span>
		<span class="n">jffs2_free_xattr_datum</span><span class="p">(</span><span class="n">xd</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cp">#define XREF_TMPHASH_SIZE	(128)</span>
<span class="kt">void</span> <span class="nf">jffs2_build_xattr_subsystem</span><span class="p">(</span><span class="k">struct</span> <span class="n">jffs2_sb_info</span> <span class="o">*</span><span class="n">c</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">jffs2_xattr_ref</span> <span class="o">*</span><span class="n">ref</span><span class="p">,</span> <span class="o">*</span><span class="n">_ref</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">jffs2_xattr_ref</span> <span class="o">*</span><span class="n">xref_tmphash</span><span class="p">[</span><span class="n">XREF_TMPHASH_SIZE</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">jffs2_xattr_datum</span> <span class="o">*</span><span class="n">xd</span><span class="p">,</span> <span class="o">*</span><span class="n">_xd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">jffs2_inode_cache</span> <span class="o">*</span><span class="n">ic</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">jffs2_raw_node_ref</span> <span class="o">*</span><span class="n">raw</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">xdatum_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">xdatum_unchecked_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">xref_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">xdatum_orphan_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">xref_orphan_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">xref_dead_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">JFFS2_SB_FLAG_BUILDING</span><span class="p">));</span>

	<span class="cm">/* Phase.1 : Merge same xref */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">XREF_TMPHASH_SIZE</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">xref_tmphash</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">ref</span><span class="o">=</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">xref_temp</span><span class="p">;</span> <span class="n">ref</span><span class="p">;</span> <span class="n">ref</span><span class="o">=</span><span class="n">_ref</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">jffs2_xattr_ref</span> <span class="o">*</span><span class="n">tmp</span><span class="p">;</span>

		<span class="n">_ref</span> <span class="o">=</span> <span class="n">ref</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ref_flags</span><span class="p">(</span><span class="n">ref</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">)</span> <span class="o">!=</span> <span class="n">REF_PRISTINE</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">verify_xattr_ref</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">ref</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">BUG_ON</span><span class="p">(</span><span class="n">ref</span><span class="o">-&gt;</span><span class="n">node</span><span class="o">-&gt;</span><span class="n">next_in_ino</span> <span class="o">!=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">ref</span><span class="p">);</span>
				<span class="n">ref</span><span class="o">-&gt;</span><span class="n">node</span><span class="o">-&gt;</span><span class="n">next_in_ino</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
				<span class="n">jffs2_mark_node_obsolete</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">ref</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">);</span>
				<span class="n">jffs2_free_xattr_ref</span><span class="p">(</span><span class="n">ref</span><span class="p">);</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="n">i</span> <span class="o">=</span> <span class="p">(</span><span class="n">ref</span><span class="o">-&gt;</span><span class="n">ino</span> <span class="o">^</span> <span class="n">ref</span><span class="o">-&gt;</span><span class="n">xid</span><span class="p">)</span> <span class="o">%</span> <span class="n">XREF_TMPHASH_SIZE</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">tmp</span><span class="o">=</span><span class="n">xref_tmphash</span><span class="p">[</span><span class="n">i</span><span class="p">];</span> <span class="n">tmp</span><span class="p">;</span> <span class="n">tmp</span><span class="o">=</span><span class="n">tmp</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">tmp</span><span class="o">-&gt;</span><span class="n">ino</span> <span class="o">==</span> <span class="n">ref</span><span class="o">-&gt;</span><span class="n">ino</span> <span class="o">&amp;&amp;</span> <span class="n">tmp</span><span class="o">-&gt;</span><span class="n">xid</span> <span class="o">==</span> <span class="n">ref</span><span class="o">-&gt;</span><span class="n">xid</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tmp</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">raw</span> <span class="o">=</span> <span class="n">ref</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ref</span><span class="o">-&gt;</span><span class="n">xseqno</span> <span class="o">&gt;</span> <span class="n">tmp</span><span class="o">-&gt;</span><span class="n">xseqno</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">tmp</span><span class="o">-&gt;</span><span class="n">xseqno</span> <span class="o">=</span> <span class="n">ref</span><span class="o">-&gt;</span><span class="n">xseqno</span><span class="p">;</span>
				<span class="n">raw</span><span class="o">-&gt;</span><span class="n">next_in_ino</span> <span class="o">=</span> <span class="n">tmp</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">;</span>
				<span class="n">tmp</span><span class="o">-&gt;</span><span class="n">node</span> <span class="o">=</span> <span class="n">raw</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">raw</span><span class="o">-&gt;</span><span class="n">next_in_ino</span> <span class="o">=</span> <span class="n">tmp</span><span class="o">-&gt;</span><span class="n">node</span><span class="o">-&gt;</span><span class="n">next_in_ino</span><span class="p">;</span>
				<span class="n">tmp</span><span class="o">-&gt;</span><span class="n">node</span><span class="o">-&gt;</span><span class="n">next_in_ino</span> <span class="o">=</span> <span class="n">raw</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">jffs2_free_xattr_ref</span><span class="p">(</span><span class="n">ref</span><span class="p">);</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">ref</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">xref_tmphash</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
			<span class="n">xref_tmphash</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">ref</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">xref_temp</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="cm">/* Phase.2 : Bind xref with inode_cache and xattr_datum */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">XREF_TMPHASH_SIZE</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">ref</span><span class="o">=</span><span class="n">xref_tmphash</span><span class="p">[</span><span class="n">i</span><span class="p">];</span> <span class="n">ref</span><span class="p">;</span> <span class="n">ref</span><span class="o">=</span><span class="n">_ref</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">xref_count</span><span class="o">++</span><span class="p">;</span>
			<span class="n">_ref</span> <span class="o">=</span> <span class="n">ref</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">is_xattr_ref_dead</span><span class="p">(</span><span class="n">ref</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">ref</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">xref_dead_list</span><span class="p">;</span>
				<span class="n">c</span><span class="o">-&gt;</span><span class="n">xref_dead_list</span> <span class="o">=</span> <span class="n">ref</span><span class="p">;</span>
				<span class="n">xref_dead_count</span><span class="o">++</span><span class="p">;</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="cm">/* At this point, ref-&gt;xid and ref-&gt;ino contain XID and inode number.</span>
<span class="cm">			   ref-&gt;xd and ref-&gt;ic are not valid yet. */</span>
			<span class="n">xd</span> <span class="o">=</span> <span class="n">jffs2_find_xattr_datum</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">ref</span><span class="o">-&gt;</span><span class="n">xid</span><span class="p">);</span>
			<span class="n">ic</span> <span class="o">=</span> <span class="n">jffs2_get_ino_cache</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">ref</span><span class="o">-&gt;</span><span class="n">ino</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">xd</span> <span class="o">||</span> <span class="o">!</span><span class="n">ic</span> <span class="o">||</span> <span class="o">!</span><span class="n">ic</span><span class="o">-&gt;</span><span class="n">pino_nlink</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">dbg_xattr</span><span class="p">(</span><span class="s">&quot;xref(ino=%u, xid=%u, xseqno=%u) is orphan.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					  <span class="n">ref</span><span class="o">-&gt;</span><span class="n">ino</span><span class="p">,</span> <span class="n">ref</span><span class="o">-&gt;</span><span class="n">xid</span><span class="p">,</span> <span class="n">ref</span><span class="o">-&gt;</span><span class="n">xseqno</span><span class="p">);</span>
				<span class="n">ref</span><span class="o">-&gt;</span><span class="n">xseqno</span> <span class="o">|=</span> <span class="n">XREF_DELETE_MARKER</span><span class="p">;</span>
				<span class="n">ref</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">xref_dead_list</span><span class="p">;</span>
				<span class="n">c</span><span class="o">-&gt;</span><span class="n">xref_dead_list</span> <span class="o">=</span> <span class="n">ref</span><span class="p">;</span>
				<span class="n">xref_orphan_count</span><span class="o">++</span><span class="p">;</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">ref</span><span class="o">-&gt;</span><span class="n">xd</span> <span class="o">=</span> <span class="n">xd</span><span class="p">;</span>
			<span class="n">ref</span><span class="o">-&gt;</span><span class="n">ic</span> <span class="o">=</span> <span class="n">ic</span><span class="p">;</span>
			<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">xd</span><span class="o">-&gt;</span><span class="n">refcnt</span><span class="p">);</span>
			<span class="n">ref</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">ic</span><span class="o">-&gt;</span><span class="n">xref</span><span class="p">;</span>
			<span class="n">ic</span><span class="o">-&gt;</span><span class="n">xref</span> <span class="o">=</span> <span class="n">ref</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* Phase.3 : Link unchecked xdatum to xattr_unchecked list */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">XATTRINDEX_HASHSIZE</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">xd</span><span class="p">,</span> <span class="n">_xd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">xattrindex</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">xindex</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">xdatum_count</span><span class="o">++</span><span class="p">;</span>
			<span class="n">list_del_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">xd</span><span class="o">-&gt;</span><span class="n">xindex</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">xd</span><span class="o">-&gt;</span><span class="n">refcnt</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">dbg_xattr</span><span class="p">(</span><span class="s">&quot;xdatum(xid=%u, version=%u) is orphan.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					  <span class="n">xd</span><span class="o">-&gt;</span><span class="n">xid</span><span class="p">,</span> <span class="n">xd</span><span class="o">-&gt;</span><span class="n">version</span><span class="p">);</span>
				<span class="n">xd</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">JFFS2_XFLAGS_DEAD</span><span class="p">;</span>
				<span class="n">list_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">xd</span><span class="o">-&gt;</span><span class="n">xindex</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">xattr_unchecked</span><span class="p">);</span>
				<span class="n">xdatum_orphan_count</span><span class="o">++</span><span class="p">;</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">is_xattr_datum_unchecked</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">xd</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">dbg_xattr</span><span class="p">(</span><span class="s">&quot;unchecked xdatum(xid=%u, version=%u)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					  <span class="n">xd</span><span class="o">-&gt;</span><span class="n">xid</span><span class="p">,</span> <span class="n">xd</span><span class="o">-&gt;</span><span class="n">version</span><span class="p">);</span>
				<span class="n">list_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">xd</span><span class="o">-&gt;</span><span class="n">xindex</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">xattr_unchecked</span><span class="p">);</span>
				<span class="n">xdatum_unchecked_count</span><span class="o">++</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="cm">/* build complete */</span>
	<span class="n">JFFS2_NOTICE</span><span class="p">(</span><span class="s">&quot;complete building xattr subsystem, %u of xdatum&quot;</span>
		     <span class="s">&quot; (%u unchecked, %u orphan) and &quot;</span>
		     <span class="s">&quot;%u of xref (%u dead, %u orphan) found.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		     <span class="n">xdatum_count</span><span class="p">,</span> <span class="n">xdatum_unchecked_count</span><span class="p">,</span> <span class="n">xdatum_orphan_count</span><span class="p">,</span>
		     <span class="n">xref_count</span><span class="p">,</span> <span class="n">xref_dead_count</span><span class="p">,</span> <span class="n">xref_orphan_count</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">jffs2_xattr_datum</span> <span class="o">*</span><span class="nf">jffs2_setup_xattr_datum</span><span class="p">(</span><span class="k">struct</span> <span class="n">jffs2_sb_info</span> <span class="o">*</span><span class="n">c</span><span class="p">,</span>
						  <span class="kt">uint32_t</span> <span class="n">xid</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">version</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">jffs2_xattr_datum</span> <span class="o">*</span><span class="n">xd</span><span class="p">;</span>

	<span class="n">xd</span> <span class="o">=</span> <span class="n">jffs2_find_xattr_datum</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">xid</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">xd</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">xd</span> <span class="o">=</span> <span class="n">jffs2_alloc_xattr_datum</span><span class="p">();</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">xd</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">ENOMEM</span><span class="p">);</span>
		<span class="n">xd</span><span class="o">-&gt;</span><span class="n">xid</span> <span class="o">=</span> <span class="n">xid</span><span class="p">;</span>
		<span class="n">xd</span><span class="o">-&gt;</span><span class="n">version</span> <span class="o">=</span> <span class="n">version</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">xd</span><span class="o">-&gt;</span><span class="n">xid</span> <span class="o">&gt;</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">highest_xid</span><span class="p">)</span>
			<span class="n">c</span><span class="o">-&gt;</span><span class="n">highest_xid</span> <span class="o">=</span> <span class="n">xd</span><span class="o">-&gt;</span><span class="n">xid</span><span class="p">;</span>
		<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">xd</span><span class="o">-&gt;</span><span class="n">xindex</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">xattrindex</span><span class="p">[</span><span class="n">xid</span> <span class="o">%</span> <span class="n">XATTRINDEX_HASHSIZE</span><span class="p">]);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">xd</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* -------- xattr subsystem functions ---------------</span>
<span class="cm"> * xprefix_to_handler(xprefix)</span>
<span class="cm"> *   is used to translate xprefix into xattr_handler.</span>
<span class="cm"> * jffs2_listxattr(dentry, buffer, size)</span>
<span class="cm"> *   is an implementation of listxattr handler on jffs2.</span>
<span class="cm"> * do_jffs2_getxattr(inode, xprefix, xname, buffer, size)</span>
<span class="cm"> *   is an implementation of getxattr handler on jffs2.</span>
<span class="cm"> * do_jffs2_setxattr(inode, xprefix, xname, buffer, size, flags)</span>
<span class="cm"> *   is an implementation of setxattr handler on jffs2.</span>
<span class="cm"> * -------------------------------------------------- */</span>
<span class="k">const</span> <span class="k">struct</span> <span class="n">xattr_handler</span> <span class="o">*</span><span class="n">jffs2_xattr_handlers</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="o">&amp;</span><span class="n">jffs2_user_xattr_handler</span><span class="p">,</span>
<span class="cp">#ifdef CONFIG_JFFS2_FS_SECURITY</span>
	<span class="o">&amp;</span><span class="n">jffs2_security_xattr_handler</span><span class="p">,</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef CONFIG_JFFS2_FS_POSIX_ACL</span>
	<span class="o">&amp;</span><span class="n">jffs2_acl_access_xattr_handler</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">jffs2_acl_default_xattr_handler</span><span class="p">,</span>
<span class="cp">#endif</span>
	<span class="o">&amp;</span><span class="n">jffs2_trusted_xattr_handler</span><span class="p">,</span>
	<span class="nb">NULL</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">xattr_handler</span> <span class="o">*</span><span class="nf">xprefix_to_handler</span><span class="p">(</span><span class="kt">int</span> <span class="n">xprefix</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">xattr_handler</span> <span class="o">*</span><span class="n">ret</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">xprefix</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">JFFS2_XPREFIX_USER</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">jffs2_user_xattr_handler</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
<span class="cp">#ifdef CONFIG_JFFS2_FS_SECURITY</span>
	<span class="k">case</span> <span class="n">JFFS2_XPREFIX_SECURITY</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">jffs2_security_xattr_handler</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef CONFIG_JFFS2_FS_POSIX_ACL</span>
	<span class="k">case</span> <span class="n">JFFS2_XPREFIX_ACL_ACCESS</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">jffs2_acl_access_xattr_handler</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">JFFS2_XPREFIX_ACL_DEFAULT</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">jffs2_acl_default_xattr_handler</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="k">case</span> <span class="n">JFFS2_XPREFIX_TRUSTED</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">jffs2_trusted_xattr_handler</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">ssize_t</span> <span class="nf">jffs2_listxattr</span><span class="p">(</span><span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="n">dentry</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buffer</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span> <span class="o">=</span> <span class="n">dentry</span><span class="o">-&gt;</span><span class="n">d_inode</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">jffs2_inode_info</span> <span class="o">*</span><span class="n">f</span> <span class="o">=</span> <span class="n">JFFS2_INODE_INFO</span><span class="p">(</span><span class="n">inode</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">jffs2_sb_info</span> <span class="o">*</span><span class="n">c</span> <span class="o">=</span> <span class="n">JFFS2_SB_INFO</span><span class="p">(</span><span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_sb</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">jffs2_inode_cache</span> <span class="o">*</span><span class="n">ic</span> <span class="o">=</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">inocache</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">jffs2_xattr_ref</span> <span class="o">*</span><span class="n">ref</span><span class="p">,</span> <span class="o">**</span><span class="n">pref</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">jffs2_xattr_datum</span> <span class="o">*</span><span class="n">xd</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">xattr_handler</span> <span class="o">*</span><span class="n">xhandle</span><span class="p">;</span>
	<span class="kt">ssize_t</span> <span class="n">len</span><span class="p">,</span> <span class="n">rc</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">retry</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">check_xattr_ref_inode</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">ic</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">rc</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">down_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">xattr_sem</span><span class="p">);</span>
 <span class="nl">retry:</span>
	<span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">ref</span><span class="o">=</span><span class="n">ic</span><span class="o">-&gt;</span><span class="n">xref</span><span class="p">,</span> <span class="n">pref</span><span class="o">=&amp;</span><span class="n">ic</span><span class="o">-&gt;</span><span class="n">xref</span><span class="p">;</span> <span class="n">ref</span><span class="p">;</span> <span class="n">pref</span><span class="o">=&amp;</span><span class="n">ref</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">,</span> <span class="n">ref</span><span class="o">=</span><span class="n">ref</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">BUG_ON</span><span class="p">(</span><span class="n">ref</span><span class="o">-&gt;</span><span class="n">ic</span> <span class="o">!=</span> <span class="n">ic</span><span class="p">);</span>
		<span class="n">xd</span> <span class="o">=</span> <span class="n">ref</span><span class="o">-&gt;</span><span class="n">xd</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">xd</span><span class="o">-&gt;</span><span class="n">xname</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* xdatum is unchached */</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">retry</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">retry</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="n">up_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">xattr_sem</span><span class="p">);</span>
				<span class="n">down_write</span><span class="p">(</span><span class="o">&amp;</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">xattr_sem</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">retry</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">rc</span> <span class="o">=</span> <span class="n">load_xattr_datum</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">xd</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">rc</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
					<span class="o">*</span><span class="n">pref</span> <span class="o">=</span> <span class="n">ref</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
					<span class="n">delete_xattr_ref</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">ref</span><span class="p">);</span>
					<span class="k">goto</span> <span class="n">retry</span><span class="p">;</span>
				<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">rc</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">))</span>
					<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">xhandle</span> <span class="o">=</span> <span class="n">xprefix_to_handler</span><span class="p">(</span><span class="n">xd</span><span class="o">-&gt;</span><span class="n">xprefix</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">xhandle</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">buffer</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="n">xhandle</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">(</span><span class="n">dentry</span><span class="p">,</span> <span class="n">buffer</span><span class="o">+</span><span class="n">len</span><span class="p">,</span> <span class="n">size</span><span class="o">-</span><span class="n">len</span><span class="p">,</span>
					   <span class="n">xd</span><span class="o">-&gt;</span><span class="n">xname</span><span class="p">,</span> <span class="n">xd</span><span class="o">-&gt;</span><span class="n">name_len</span><span class="p">,</span> <span class="n">xd</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="n">xhandle</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">(</span><span class="n">dentry</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">xd</span><span class="o">-&gt;</span><span class="n">xname</span><span class="p">,</span>
					   <span class="n">xd</span><span class="o">-&gt;</span><span class="n">name_len</span><span class="p">,</span> <span class="n">xd</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="n">len</span> <span class="o">+=</span> <span class="n">rc</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>
 <span class="nl">out:</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">retry</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">up_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">xattr_sem</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">up_write</span><span class="p">(</span><span class="o">&amp;</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">xattr_sem</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">do_jffs2_getxattr</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="kt">int</span> <span class="n">xprefix</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">xname</span><span class="p">,</span>
		      <span class="kt">char</span> <span class="o">*</span><span class="n">buffer</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">jffs2_inode_info</span> <span class="o">*</span><span class="n">f</span> <span class="o">=</span> <span class="n">JFFS2_INODE_INFO</span><span class="p">(</span><span class="n">inode</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">jffs2_sb_info</span> <span class="o">*</span><span class="n">c</span> <span class="o">=</span> <span class="n">JFFS2_SB_INFO</span><span class="p">(</span><span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_sb</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">jffs2_inode_cache</span> <span class="o">*</span><span class="n">ic</span> <span class="o">=</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">inocache</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">jffs2_xattr_datum</span> <span class="o">*</span><span class="n">xd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">jffs2_xattr_ref</span> <span class="o">*</span><span class="n">ref</span><span class="p">,</span> <span class="o">**</span><span class="n">pref</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">,</span> <span class="n">retry</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">check_xattr_ref_inode</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">ic</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">rc</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">down_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">xattr_sem</span><span class="p">);</span>
 <span class="nl">retry:</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">ref</span><span class="o">=</span><span class="n">ic</span><span class="o">-&gt;</span><span class="n">xref</span><span class="p">,</span> <span class="n">pref</span><span class="o">=&amp;</span><span class="n">ic</span><span class="o">-&gt;</span><span class="n">xref</span><span class="p">;</span> <span class="n">ref</span><span class="p">;</span> <span class="n">pref</span><span class="o">=&amp;</span><span class="n">ref</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">,</span> <span class="n">ref</span><span class="o">=</span><span class="n">ref</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">BUG_ON</span><span class="p">(</span><span class="n">ref</span><span class="o">-&gt;</span><span class="n">ic</span><span class="o">!=</span><span class="n">ic</span><span class="p">);</span>

		<span class="n">xd</span> <span class="o">=</span> <span class="n">ref</span><span class="o">-&gt;</span><span class="n">xd</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">xd</span><span class="o">-&gt;</span><span class="n">xprefix</span> <span class="o">!=</span> <span class="n">xprefix</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">xd</span><span class="o">-&gt;</span><span class="n">xname</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* xdatum is unchached */</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">retry</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">retry</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="n">up_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">xattr_sem</span><span class="p">);</span>
				<span class="n">down_write</span><span class="p">(</span><span class="o">&amp;</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">xattr_sem</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">retry</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">rc</span> <span class="o">=</span> <span class="n">load_xattr_datum</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">xd</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">rc</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
					<span class="o">*</span><span class="n">pref</span> <span class="o">=</span> <span class="n">ref</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
					<span class="n">delete_xattr_ref</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">ref</span><span class="p">);</span>
					<span class="k">goto</span> <span class="n">retry</span><span class="p">;</span>
				<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">rc</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
					<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">xname</span><span class="p">,</span> <span class="n">xd</span><span class="o">-&gt;</span><span class="n">xname</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="n">xd</span><span class="o">-&gt;</span><span class="n">value_len</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">buffer</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">&lt;</span> <span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ERANGE</span><span class="p">;</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="n">memcpy</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="n">xd</span><span class="o">-&gt;</span><span class="n">xvalue</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODATA</span><span class="p">;</span>
 <span class="nl">out:</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">retry</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">up_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">xattr_sem</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">up_write</span><span class="p">(</span><span class="o">&amp;</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">xattr_sem</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">do_jffs2_setxattr</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="kt">int</span> <span class="n">xprefix</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">xname</span><span class="p">,</span>
		      <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buffer</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">size</span><span class="p">,</span> <span class="kt">int</span> <span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">jffs2_inode_info</span> <span class="o">*</span><span class="n">f</span> <span class="o">=</span> <span class="n">JFFS2_INODE_INFO</span><span class="p">(</span><span class="n">inode</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">jffs2_sb_info</span> <span class="o">*</span><span class="n">c</span> <span class="o">=</span> <span class="n">JFFS2_SB_INFO</span><span class="p">(</span><span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_sb</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">jffs2_inode_cache</span> <span class="o">*</span><span class="n">ic</span> <span class="o">=</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">inocache</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">jffs2_xattr_datum</span> <span class="o">*</span><span class="n">xd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">jffs2_xattr_ref</span> <span class="o">*</span><span class="n">ref</span><span class="p">,</span> <span class="o">*</span><span class="n">newref</span><span class="p">,</span> <span class="o">**</span><span class="n">pref</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">length</span><span class="p">,</span> <span class="n">request</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">check_xattr_ref_inode</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">ic</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">rc</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">request</span> <span class="o">=</span> <span class="n">PAD</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">jffs2_raw_xattr</span><span class="p">)</span> <span class="o">+</span> <span class="n">strlen</span><span class="p">(</span><span class="n">xname</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">size</span><span class="p">);</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">jffs2_reserve_space</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">length</span><span class="p">,</span>
				 <span class="n">ALLOC_NORMAL</span><span class="p">,</span> <span class="n">JFFS2_SUMMARY_XATTR_SIZE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">JFFS2_WARNING</span><span class="p">(</span><span class="s">&quot;jffs2_reserve_space()=%d, request=%u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="p">,</span> <span class="n">request</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Find existing xattr */</span>
	<span class="n">down_write</span><span class="p">(</span><span class="o">&amp;</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">xattr_sem</span><span class="p">);</span>
 <span class="nl">retry:</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">ref</span><span class="o">=</span><span class="n">ic</span><span class="o">-&gt;</span><span class="n">xref</span><span class="p">,</span> <span class="n">pref</span><span class="o">=&amp;</span><span class="n">ic</span><span class="o">-&gt;</span><span class="n">xref</span><span class="p">;</span> <span class="n">ref</span><span class="p">;</span> <span class="n">pref</span><span class="o">=&amp;</span><span class="n">ref</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">,</span> <span class="n">ref</span><span class="o">=</span><span class="n">ref</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">xd</span> <span class="o">=</span> <span class="n">ref</span><span class="o">-&gt;</span><span class="n">xd</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">xd</span><span class="o">-&gt;</span><span class="n">xprefix</span> <span class="o">!=</span> <span class="n">xprefix</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">xd</span><span class="o">-&gt;</span><span class="n">xname</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="n">load_xattr_datum</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">xd</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">rc</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
				<span class="o">*</span><span class="n">pref</span> <span class="o">=</span> <span class="n">ref</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
				<span class="n">delete_xattr_ref</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">ref</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">retry</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">rc</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">))</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">xd</span><span class="o">-&gt;</span><span class="n">xname</span><span class="p">,</span> <span class="n">xname</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">XATTR_CREATE</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EEXIST</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">buffer</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ref</span><span class="o">-&gt;</span><span class="n">ino</span> <span class="o">=</span> <span class="n">ic</span><span class="o">-&gt;</span><span class="n">ino</span><span class="p">;</span>
				<span class="n">ref</span><span class="o">-&gt;</span><span class="n">xid</span> <span class="o">=</span> <span class="n">xd</span><span class="o">-&gt;</span><span class="n">xid</span><span class="p">;</span>
				<span class="n">ref</span><span class="o">-&gt;</span><span class="n">xseqno</span> <span class="o">|=</span> <span class="n">XREF_DELETE_MARKER</span><span class="p">;</span>
				<span class="n">rc</span> <span class="o">=</span> <span class="n">save_xattr_ref</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">ref</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
					<span class="o">*</span><span class="n">pref</span> <span class="o">=</span> <span class="n">ref</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
					<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">erase_completion_lock</span><span class="p">);</span>
					<span class="n">ref</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">xref_dead_list</span><span class="p">;</span>
					<span class="n">c</span><span class="o">-&gt;</span><span class="n">xref_dead_list</span> <span class="o">=</span> <span class="n">ref</span><span class="p">;</span>
					<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">erase_completion_lock</span><span class="p">);</span>
					<span class="n">unrefer_xattr_datum</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">xd</span><span class="p">);</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="n">ref</span><span class="o">-&gt;</span><span class="n">ic</span> <span class="o">=</span> <span class="n">ic</span><span class="p">;</span>
					<span class="n">ref</span><span class="o">-&gt;</span><span class="n">xd</span> <span class="o">=</span> <span class="n">xd</span><span class="p">;</span>
					<span class="n">ref</span><span class="o">-&gt;</span><span class="n">xseqno</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">XREF_DELETE_MARKER</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">goto</span> <span class="n">found</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="cm">/* not found */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">XATTR_REPLACE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODATA</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">buffer</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODATA</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
 <span class="nl">found:</span>
	<span class="n">xd</span> <span class="o">=</span> <span class="n">create_xattr_datum</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">xprefix</span><span class="p">,</span> <span class="n">xname</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">xd</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">xd</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">up_write</span><span class="p">(</span><span class="o">&amp;</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">xattr_sem</span><span class="p">);</span>
	<span class="n">jffs2_complete_reservation</span><span class="p">(</span><span class="n">c</span><span class="p">);</span>

	<span class="cm">/* create xattr_ref */</span>
	<span class="n">request</span> <span class="o">=</span> <span class="n">PAD</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">jffs2_raw_xref</span><span class="p">));</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">jffs2_reserve_space</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">length</span><span class="p">,</span>
				 <span class="n">ALLOC_NORMAL</span><span class="p">,</span> <span class="n">JFFS2_SUMMARY_XREF_SIZE</span><span class="p">);</span>
	<span class="n">down_write</span><span class="p">(</span><span class="o">&amp;</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">xattr_sem</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">JFFS2_WARNING</span><span class="p">(</span><span class="s">&quot;jffs2_reserve_space()=%d, request=%u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="p">,</span> <span class="n">request</span><span class="p">);</span>
		<span class="n">unrefer_xattr_datum</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">xd</span><span class="p">);</span>
		<span class="n">up_write</span><span class="p">(</span><span class="o">&amp;</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">xattr_sem</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ref</span><span class="p">)</span>
		<span class="o">*</span><span class="n">pref</span> <span class="o">=</span> <span class="n">ref</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
	<span class="n">newref</span> <span class="o">=</span> <span class="n">create_xattr_ref</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">ic</span><span class="p">,</span> <span class="n">xd</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">newref</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ref</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ref</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">ic</span><span class="o">-&gt;</span><span class="n">xref</span><span class="p">;</span>
			<span class="n">ic</span><span class="o">-&gt;</span><span class="n">xref</span> <span class="o">=</span> <span class="n">ref</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">newref</span><span class="p">);</span>
		<span class="n">unrefer_xattr_datum</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">xd</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ref</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">delete_xattr_ref</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">ref</span><span class="p">);</span>
	<span class="p">}</span>
 <span class="nl">out:</span>
	<span class="n">up_write</span><span class="p">(</span><span class="o">&amp;</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">xattr_sem</span><span class="p">);</span>
	<span class="n">jffs2_complete_reservation</span><span class="p">(</span><span class="n">c</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* -------- garbage collector functions -------------</span>
<span class="cm"> * jffs2_garbage_collect_xattr_datum(c, xd, raw)</span>
<span class="cm"> *   is used to move xdatum into new node.</span>
<span class="cm"> * jffs2_garbage_collect_xattr_ref(c, ref, raw)</span>
<span class="cm"> *   is used to move xref into new node.</span>
<span class="cm"> * jffs2_verify_xattr(c)</span>
<span class="cm"> *   is used to call do_verify_xattr_datum() before garbage collecting.</span>
<span class="cm"> * jffs2_release_xattr_datum(c, xd)</span>
<span class="cm"> *   is used to release an in-memory object of xdatum.</span>
<span class="cm"> * jffs2_release_xattr_ref(c, ref)</span>
<span class="cm"> *   is used to release an in-memory object of xref.</span>
<span class="cm"> * -------------------------------------------------- */</span>
<span class="kt">int</span> <span class="nf">jffs2_garbage_collect_xattr_datum</span><span class="p">(</span><span class="k">struct</span> <span class="n">jffs2_sb_info</span> <span class="o">*</span><span class="n">c</span><span class="p">,</span> <span class="k">struct</span> <span class="n">jffs2_xattr_datum</span> <span class="o">*</span><span class="n">xd</span><span class="p">,</span>
				      <span class="k">struct</span> <span class="n">jffs2_raw_node_ref</span> <span class="o">*</span><span class="n">raw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">uint32_t</span> <span class="n">totlen</span><span class="p">,</span> <span class="n">length</span><span class="p">,</span> <span class="n">old_ofs</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">down_write</span><span class="p">(</span><span class="o">&amp;</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">xattr_sem</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">xd</span><span class="o">-&gt;</span><span class="n">node</span> <span class="o">!=</span> <span class="n">raw</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">xd</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">JFFS2_XFLAGS_DEAD</span><span class="o">|</span><span class="n">JFFS2_XFLAGS_INVALID</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">load_xattr_datum</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">xd</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">rc</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="p">(</span><span class="n">rc</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="n">rc</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">old_ofs</span> <span class="o">=</span> <span class="n">ref_offset</span><span class="p">(</span><span class="n">xd</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">);</span>
	<span class="n">totlen</span> <span class="o">=</span> <span class="n">PAD</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">jffs2_raw_xattr</span><span class="p">)</span>
			<span class="o">+</span> <span class="n">xd</span><span class="o">-&gt;</span><span class="n">name_len</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">xd</span><span class="o">-&gt;</span><span class="n">value_len</span><span class="p">);</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">jffs2_reserve_space_gc</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">totlen</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">length</span><span class="p">,</span> <span class="n">JFFS2_SUMMARY_XATTR_SIZE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">JFFS2_WARNING</span><span class="p">(</span><span class="s">&quot;jffs2_reserve_space_gc()=%d, request=%u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="p">,</span> <span class="n">totlen</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">save_xattr_datum</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">xd</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rc</span><span class="p">)</span>
		<span class="n">dbg_xattr</span><span class="p">(</span><span class="s">&quot;xdatum (xid=%u, version=%u) GC&#39;ed from %#08x to %08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">xd</span><span class="o">-&gt;</span><span class="n">xid</span><span class="p">,</span> <span class="n">xd</span><span class="o">-&gt;</span><span class="n">version</span><span class="p">,</span> <span class="n">old_ofs</span><span class="p">,</span> <span class="n">ref_offset</span><span class="p">(</span><span class="n">xd</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">));</span>
 <span class="nl">out:</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rc</span><span class="p">)</span>
		<span class="n">jffs2_mark_node_obsolete</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">raw</span><span class="p">);</span>
	<span class="n">up_write</span><span class="p">(</span><span class="o">&amp;</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">xattr_sem</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">jffs2_garbage_collect_xattr_ref</span><span class="p">(</span><span class="k">struct</span> <span class="n">jffs2_sb_info</span> <span class="o">*</span><span class="n">c</span><span class="p">,</span> <span class="k">struct</span> <span class="n">jffs2_xattr_ref</span> <span class="o">*</span><span class="n">ref</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">jffs2_raw_node_ref</span> <span class="o">*</span><span class="n">raw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">uint32_t</span> <span class="n">totlen</span><span class="p">,</span> <span class="n">length</span><span class="p">,</span> <span class="n">old_ofs</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">down_write</span><span class="p">(</span><span class="o">&amp;</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">xattr_sem</span><span class="p">);</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">ref</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ref</span><span class="o">-&gt;</span><span class="n">node</span> <span class="o">!=</span> <span class="n">raw</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">is_xattr_ref_dead</span><span class="p">(</span><span class="n">ref</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">raw</span><span class="o">-&gt;</span><span class="n">next_in_ino</span> <span class="o">==</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">ref</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">old_ofs</span> <span class="o">=</span> <span class="n">ref_offset</span><span class="p">(</span><span class="n">ref</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">);</span>
	<span class="n">totlen</span> <span class="o">=</span> <span class="n">ref_totlen</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">gcblock</span><span class="p">,</span> <span class="n">ref</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">);</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">jffs2_reserve_space_gc</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">totlen</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">length</span><span class="p">,</span> <span class="n">JFFS2_SUMMARY_XREF_SIZE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">JFFS2_WARNING</span><span class="p">(</span><span class="s">&quot;%s: jffs2_reserve_space_gc() = %d, request = %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			      <span class="n">__func__</span><span class="p">,</span> <span class="n">rc</span><span class="p">,</span> <span class="n">totlen</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">rc</span> <span class="o">?</span> <span class="n">rc</span> <span class="o">:</span> <span class="o">-</span><span class="n">EBADFD</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">save_xattr_ref</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">ref</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rc</span><span class="p">)</span>
		<span class="n">dbg_xattr</span><span class="p">(</span><span class="s">&quot;xref (ino=%u, xid=%u) GC&#39;ed from %#08x to %08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">ref</span><span class="o">-&gt;</span><span class="n">ic</span><span class="o">-&gt;</span><span class="n">ino</span><span class="p">,</span> <span class="n">ref</span><span class="o">-&gt;</span><span class="n">xd</span><span class="o">-&gt;</span><span class="n">xid</span><span class="p">,</span> <span class="n">old_ofs</span><span class="p">,</span> <span class="n">ref_offset</span><span class="p">(</span><span class="n">ref</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">));</span>
 <span class="nl">out:</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rc</span><span class="p">)</span>
		<span class="n">jffs2_mark_node_obsolete</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">raw</span><span class="p">);</span>
	<span class="n">up_write</span><span class="p">(</span><span class="o">&amp;</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">xattr_sem</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">jffs2_verify_xattr</span><span class="p">(</span><span class="k">struct</span> <span class="n">jffs2_sb_info</span> <span class="o">*</span><span class="n">c</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">jffs2_xattr_datum</span> <span class="o">*</span><span class="n">xd</span><span class="p">,</span> <span class="o">*</span><span class="n">_xd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">jffs2_eraseblock</span> <span class="o">*</span><span class="n">jeb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">jffs2_raw_node_ref</span> <span class="o">*</span><span class="n">raw</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">totlen</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">down_write</span><span class="p">(</span><span class="o">&amp;</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">xattr_sem</span><span class="p">);</span>
	<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">xd</span><span class="p">,</span> <span class="n">_xd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">xattr_unchecked</span><span class="p">,</span> <span class="n">xindex</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">do_verify_xattr_datum</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">xd</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">list_del_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">xd</span><span class="o">-&gt;</span><span class="n">xindex</span><span class="p">);</span>
		<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">erase_completion_lock</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">raw</span><span class="o">=</span><span class="n">xd</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">;</span> <span class="n">raw</span> <span class="o">!=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">xd</span><span class="p">;</span> <span class="n">raw</span><span class="o">=</span><span class="n">raw</span><span class="o">-&gt;</span><span class="n">next_in_ino</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ref_flags</span><span class="p">(</span><span class="n">raw</span><span class="p">)</span> <span class="o">!=</span> <span class="n">REF_UNCHECKED</span><span class="p">)</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="n">jeb</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">blocks</span><span class="p">[</span><span class="n">ref_offset</span><span class="p">(</span><span class="n">raw</span><span class="p">)</span> <span class="o">/</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">sector_size</span><span class="p">];</span>
			<span class="n">totlen</span> <span class="o">=</span> <span class="n">PAD</span><span class="p">(</span><span class="n">ref_totlen</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">jeb</span><span class="p">,</span> <span class="n">raw</span><span class="p">));</span>
			<span class="n">c</span><span class="o">-&gt;</span><span class="n">unchecked_size</span> <span class="o">-=</span> <span class="n">totlen</span><span class="p">;</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">used_size</span> <span class="o">+=</span> <span class="n">totlen</span><span class="p">;</span>
			<span class="n">jeb</span><span class="o">-&gt;</span><span class="n">unchecked_size</span> <span class="o">-=</span> <span class="n">totlen</span><span class="p">;</span> <span class="n">jeb</span><span class="o">-&gt;</span><span class="n">used_size</span> <span class="o">+=</span> <span class="n">totlen</span><span class="p">;</span>
			<span class="n">raw</span><span class="o">-&gt;</span><span class="n">flash_offset</span> <span class="o">=</span> <span class="n">ref_offset</span><span class="p">(</span><span class="n">raw</span><span class="p">)</span>
				<span class="o">|</span> <span class="p">((</span><span class="n">xd</span><span class="o">-&gt;</span><span class="n">node</span> <span class="o">==</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">raw</span><span class="p">)</span> <span class="o">?</span> <span class="n">REF_PRISTINE</span> <span class="o">:</span> <span class="n">REF_NORMAL</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">xd</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">JFFS2_XFLAGS_DEAD</span><span class="p">)</span>
			<span class="n">list_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">xd</span><span class="o">-&gt;</span><span class="n">xindex</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">xattr_dead_list</span><span class="p">);</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">erase_completion_lock</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">up_write</span><span class="p">(</span><span class="o">&amp;</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">xattr_sem</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">xattr_unchecked</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">jffs2_release_xattr_datum</span><span class="p">(</span><span class="k">struct</span> <span class="n">jffs2_sb_info</span> <span class="o">*</span><span class="n">c</span><span class="p">,</span> <span class="k">struct</span> <span class="n">jffs2_xattr_datum</span> <span class="o">*</span><span class="n">xd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* must be called under spin_lock(&amp;c-&gt;erase_completion_lock) */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">xd</span><span class="o">-&gt;</span><span class="n">refcnt</span><span class="p">)</span> <span class="o">||</span> <span class="n">xd</span><span class="o">-&gt;</span><span class="n">node</span> <span class="o">!=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">xd</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">xd</span><span class="o">-&gt;</span><span class="n">xindex</span><span class="p">);</span>
	<span class="n">jffs2_free_xattr_datum</span><span class="p">(</span><span class="n">xd</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">jffs2_release_xattr_ref</span><span class="p">(</span><span class="k">struct</span> <span class="n">jffs2_sb_info</span> <span class="o">*</span><span class="n">c</span><span class="p">,</span> <span class="k">struct</span> <span class="n">jffs2_xattr_ref</span> <span class="o">*</span><span class="n">ref</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* must be called under spin_lock(&amp;c-&gt;erase_completion_lock) */</span>
	<span class="k">struct</span> <span class="n">jffs2_xattr_ref</span> <span class="o">*</span><span class="n">tmp</span><span class="p">,</span> <span class="o">**</span><span class="n">ptmp</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ref</span><span class="o">-&gt;</span><span class="n">node</span> <span class="o">!=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">ref</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">tmp</span><span class="o">=</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">xref_dead_list</span><span class="p">,</span> <span class="n">ptmp</span><span class="o">=&amp;</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">xref_dead_list</span><span class="p">;</span> <span class="n">tmp</span><span class="p">;</span> <span class="n">ptmp</span><span class="o">=&amp;</span><span class="n">tmp</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">,</span> <span class="n">tmp</span><span class="o">=</span><span class="n">tmp</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ref</span> <span class="o">==</span> <span class="n">tmp</span><span class="p">)</span> <span class="p">{</span>
			<span class="o">*</span><span class="n">ptmp</span> <span class="o">=</span> <span class="n">tmp</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">jffs2_free_xattr_ref</span><span class="p">(</span><span class="n">ref</span><span class="p">);</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
