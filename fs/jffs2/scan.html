<!DOCTYPE html>
<html><head><title>joekychen/linux » fs › jffs2 › scan.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>scan.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * JFFS2 -- Journalling Flash File System, Version 2.</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright © 2001-2007 Red Hat, Inc.</span>
<span class="cm"> *</span>
<span class="cm"> * Created by David Woodhouse &lt;dwmw2@infradead.org&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * For licensing information, see the file &#39;LICENCE&#39; in this directory.</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="cp">#define pr_fmt(fmt) KBUILD_MODNAME &quot;: &quot; fmt</span>

<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/sched.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/mtd/mtd.h&gt;</span>
<span class="cp">#include &lt;linux/pagemap.h&gt;</span>
<span class="cp">#include &lt;linux/crc32.h&gt;</span>
<span class="cp">#include &lt;linux/compiler.h&gt;</span>
<span class="cp">#include &quot;nodelist.h&quot;</span>
<span class="cp">#include &quot;summary.h&quot;</span>
<span class="cp">#include &quot;debug.h&quot;</span>

<span class="cp">#define DEFAULT_EMPTY_SCAN_SIZE 256</span>

<span class="cp">#define noisy_printk(noise, fmt, ...)					\</span>
<span class="cp">do {									\</span>
<span class="cp">	if (*(noise)) {							\</span>
<span class="cp">		pr_notice(fmt, ##__VA_ARGS__);				\</span>
<span class="cp">		(*(noise))--;						\</span>
<span class="cp">		if (!(*(noise)))					\</span>
<span class="cp">			pr_notice(&quot;Further such events for this erase block will not be printed\n&quot;); \</span>
<span class="cp">	}								\</span>
<span class="cp">} while (0)</span>

<span class="k">static</span> <span class="kt">uint32_t</span> <span class="n">pseudo_random</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">jffs2_scan_eraseblock</span> <span class="p">(</span><span class="k">struct</span> <span class="n">jffs2_sb_info</span> <span class="o">*</span><span class="n">c</span><span class="p">,</span> <span class="k">struct</span> <span class="n">jffs2_eraseblock</span> <span class="o">*</span><span class="n">jeb</span><span class="p">,</span>
				  <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">buf_size</span><span class="p">,</span> <span class="k">struct</span> <span class="n">jffs2_summary</span> <span class="o">*</span><span class="n">s</span><span class="p">);</span>

<span class="cm">/* These helper functions _must_ increase ofs and also do the dirty/used space accounting.</span>
<span class="cm"> * Returning an error will abort the mount - bad checksums etc. should just mark the space</span>
<span class="cm"> * as dirty.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">jffs2_scan_inode_node</span><span class="p">(</span><span class="k">struct</span> <span class="n">jffs2_sb_info</span> <span class="o">*</span><span class="n">c</span><span class="p">,</span> <span class="k">struct</span> <span class="n">jffs2_eraseblock</span> <span class="o">*</span><span class="n">jeb</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">jffs2_raw_inode</span> <span class="o">*</span><span class="n">ri</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">ofs</span><span class="p">,</span> <span class="k">struct</span> <span class="n">jffs2_summary</span> <span class="o">*</span><span class="n">s</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">jffs2_scan_dirent_node</span><span class="p">(</span><span class="k">struct</span> <span class="n">jffs2_sb_info</span> <span class="o">*</span><span class="n">c</span><span class="p">,</span> <span class="k">struct</span> <span class="n">jffs2_eraseblock</span> <span class="o">*</span><span class="n">jeb</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">jffs2_raw_dirent</span> <span class="o">*</span><span class="n">rd</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">ofs</span><span class="p">,</span> <span class="k">struct</span> <span class="n">jffs2_summary</span> <span class="o">*</span><span class="n">s</span><span class="p">);</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">min_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">jffs2_sb_info</span> <span class="o">*</span><span class="n">c</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">uint32_t</span> <span class="n">min</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">jffs2_raw_inode</span><span class="p">);</span>
<span class="cp">#ifdef CONFIG_JFFS2_FS_WRITEBUFFER</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">jffs2_can_mark_obsolete</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">min</span> <span class="o">&lt;</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">wbuf_pagesize</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">wbuf_pagesize</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="k">return</span> <span class="n">min</span><span class="p">;</span>

<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">uint32_t</span> <span class="nf">EMPTY_SCAN_SIZE</span><span class="p">(</span><span class="kt">uint32_t</span> <span class="n">sector_size</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sector_size</span> <span class="o">&lt;</span> <span class="n">DEFAULT_EMPTY_SCAN_SIZE</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">sector_size</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="n">DEFAULT_EMPTY_SCAN_SIZE</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">file_dirty</span><span class="p">(</span><span class="k">struct</span> <span class="n">jffs2_sb_info</span> <span class="o">*</span><span class="n">c</span><span class="p">,</span> <span class="k">struct</span> <span class="n">jffs2_eraseblock</span> <span class="o">*</span><span class="n">jeb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">ret</span> <span class="o">=</span> <span class="n">jffs2_prealloc_raw_node_refs</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">jeb</span><span class="p">,</span> <span class="mi">1</span><span class="p">)))</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">ret</span> <span class="o">=</span> <span class="n">jffs2_scan_dirty_space</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">jeb</span><span class="p">,</span> <span class="n">jeb</span><span class="o">-&gt;</span><span class="n">free_size</span><span class="p">)))</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="cm">/* Turned wasted size into dirty, since we apparently </span>
<span class="cm">	   think it&#39;s recoverable now. */</span>
	<span class="n">jeb</span><span class="o">-&gt;</span><span class="n">dirty_size</span> <span class="o">+=</span> <span class="n">jeb</span><span class="o">-&gt;</span><span class="n">wasted_size</span><span class="p">;</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">dirty_size</span> <span class="o">+=</span> <span class="n">jeb</span><span class="o">-&gt;</span><span class="n">wasted_size</span><span class="p">;</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">wasted_size</span> <span class="o">-=</span> <span class="n">jeb</span><span class="o">-&gt;</span><span class="n">wasted_size</span><span class="p">;</span>
	<span class="n">jeb</span><span class="o">-&gt;</span><span class="n">wasted_size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">VERYDIRTY</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">jeb</span><span class="o">-&gt;</span><span class="n">dirty_size</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">list_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">jeb</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">very_dirty_list</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">list_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">jeb</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">dirty_list</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">jffs2_scan_medium</span><span class="p">(</span><span class="k">struct</span> <span class="n">jffs2_sb_info</span> <span class="o">*</span><span class="n">c</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">ret</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">empty_blocks</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">bad_blocks</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">flashbuf</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">buf_size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">jffs2_summary</span> <span class="o">*</span><span class="n">s</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span> <span class="cm">/* summary info collected by the scan process */</span>
<span class="cp">#ifndef __ECOS</span>
	<span class="kt">size_t</span> <span class="n">pointlen</span><span class="p">,</span> <span class="n">try_size</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">mtd_point</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">mtd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">mtd</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pointlen</span><span class="p">,</span>
			<span class="p">(</span><span class="kt">void</span> <span class="o">**</span><span class="p">)</span><span class="o">&amp;</span><span class="n">flashbuf</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span> <span class="o">&amp;&amp;</span> <span class="n">pointlen</span> <span class="o">&lt;</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">mtd</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Don&#39;t muck about if it won&#39;t let us point to the whole flash */</span>
		<span class="n">jffs2_dbg</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;MTD point returned len too short: 0x%zx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">pointlen</span><span class="p">);</span>
		<span class="n">mtd_unpoint</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">mtd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">pointlen</span><span class="p">);</span>
		<span class="n">flashbuf</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&amp;&amp;</span> <span class="n">ret</span> <span class="o">!=</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">)</span>
		<span class="n">jffs2_dbg</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;MTD point failed %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">flashbuf</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* For NAND it&#39;s quicker to read a whole eraseblock at a time,</span>
<span class="cm">		   apparently */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">jffs2_cleanmarker_oob</span><span class="p">(</span><span class="n">c</span><span class="p">))</span>
			<span class="n">try_size</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">sector_size</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">try_size</span> <span class="o">=</span> <span class="n">PAGE_SIZE</span><span class="p">;</span>

		<span class="n">jffs2_dbg</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;Trying to allocate readbuf of %zu &quot;</span>
			  <span class="s">&quot;bytes</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">try_size</span><span class="p">);</span>

		<span class="n">flashbuf</span> <span class="o">=</span> <span class="n">mtd_kmalloc_up_to</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">mtd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">try_size</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">flashbuf</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

		<span class="n">jffs2_dbg</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;Allocated readbuf of %zu bytes</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">try_size</span><span class="p">);</span>

		<span class="n">buf_size</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint32_t</span><span class="p">)</span><span class="n">try_size</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">jffs2_sum_active</span><span class="p">())</span> <span class="p">{</span>
		<span class="n">s</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">jffs2_summary</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">s</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">JFFS2_WARNING</span><span class="p">(</span><span class="s">&quot;Can&#39;t allocate memory for summary</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">nr_blocks</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">jffs2_eraseblock</span> <span class="o">*</span><span class="n">jeb</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">blocks</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

		<span class="n">cond_resched</span><span class="p">();</span>

		<span class="cm">/* reset summary info for next eraseblock scan */</span>
		<span class="n">jffs2_sum_reset_collected</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">jffs2_scan_eraseblock</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">jeb</span><span class="p">,</span> <span class="n">buf_size</span><span class="o">?</span><span class="n">flashbuf</span><span class="o">:</span><span class="p">(</span><span class="n">flashbuf</span><span class="o">+</span><span class="n">jeb</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">),</span>
						<span class="n">buf_size</span><span class="p">,</span> <span class="n">s</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

		<span class="n">jffs2_dbg_acct_paranoia_check_nolock</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">jeb</span><span class="p">);</span>

		<span class="cm">/* Now decide which list to put it on */</span>
		<span class="k">switch</span><span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">BLK_STATE_ALLFF</span>:
			<span class="cm">/*</span>
<span class="cm">			 * Empty block.   Since we can&#39;t be sure it</span>
<span class="cm">			 * was entirely erased, we just queue it for erase</span>
<span class="cm">			 * again.  It will be marked as such when the erase</span>
<span class="cm">			 * is complete.  Meanwhile we still count it as empty</span>
<span class="cm">			 * for later checks.</span>
<span class="cm">			 */</span>
			<span class="n">empty_blocks</span><span class="o">++</span><span class="p">;</span>
			<span class="n">list_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">jeb</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">erase_pending_list</span><span class="p">);</span>
			<span class="n">c</span><span class="o">-&gt;</span><span class="n">nr_erasing_blocks</span><span class="o">++</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">BLK_STATE_CLEANMARKER</span>:
			<span class="cm">/* Only a CLEANMARKER node is valid */</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">jeb</span><span class="o">-&gt;</span><span class="n">dirty_size</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* It&#39;s actually free */</span>
				<span class="n">list_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">jeb</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">free_list</span><span class="p">);</span>
				<span class="n">c</span><span class="o">-&gt;</span><span class="n">nr_free_blocks</span><span class="o">++</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="cm">/* Dirt */</span>
				<span class="n">jffs2_dbg</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;Adding all-dirty block at 0x%08x to erase_pending_list</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					  <span class="n">jeb</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">);</span>
				<span class="n">list_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">jeb</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">erase_pending_list</span><span class="p">);</span>
				<span class="n">c</span><span class="o">-&gt;</span><span class="n">nr_erasing_blocks</span><span class="o">++</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">BLK_STATE_CLEAN</span>:
			<span class="cm">/* Full (or almost full) of clean data. Clean list */</span>
			<span class="n">list_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">jeb</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">clean_list</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">BLK_STATE_PARTDIRTY</span>:
			<span class="cm">/* Some data, but not full. Dirty list. */</span>
			<span class="cm">/* We want to remember the block with most free space</span>
<span class="cm">			and stick it in the &#39;nextblock&#39; position to start writing to it. */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">jeb</span><span class="o">-&gt;</span><span class="n">free_size</span> <span class="o">&gt;</span> <span class="n">min_free</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
					<span class="p">(</span><span class="o">!</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">nextblock</span> <span class="o">||</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">nextblock</span><span class="o">-&gt;</span><span class="n">free_size</span> <span class="o">&lt;</span> <span class="n">jeb</span><span class="o">-&gt;</span><span class="n">free_size</span><span class="p">))</span> <span class="p">{</span>
				<span class="cm">/* Better candidate for the next writes to go to */</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">nextblock</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">ret</span> <span class="o">=</span> <span class="n">file_dirty</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">nextblock</span><span class="p">);</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
						<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
					<span class="cm">/* deleting summary information of the old nextblock */</span>
					<span class="n">jffs2_sum_reset_collected</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">summary</span><span class="p">);</span>
				<span class="p">}</span>
				<span class="cm">/* update collected summary information for the current nextblock */</span>
				<span class="n">jffs2_sum_move_collected</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">s</span><span class="p">);</span>
				<span class="n">jffs2_dbg</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;%s(): new nextblock = 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					  <span class="n">__func__</span><span class="p">,</span> <span class="n">jeb</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">);</span>
				<span class="n">c</span><span class="o">-&gt;</span><span class="n">nextblock</span> <span class="o">=</span> <span class="n">jeb</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">ret</span> <span class="o">=</span> <span class="n">file_dirty</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">jeb</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
					<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">BLK_STATE_ALLDIRTY</span>:
			<span class="cm">/* Nothing valid - not even a clean marker. Needs erasing. */</span>
			<span class="cm">/* For now we just put it on the erasing list. We&#39;ll start the erases later */</span>
			<span class="n">jffs2_dbg</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;Erase block at 0x%08x is not formatted. It will be erased</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				  <span class="n">jeb</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">);</span>
			<span class="n">list_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">jeb</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">erase_pending_list</span><span class="p">);</span>
			<span class="n">c</span><span class="o">-&gt;</span><span class="n">nr_erasing_blocks</span><span class="o">++</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">BLK_STATE_BADBLOCK</span>:
			<span class="n">jffs2_dbg</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;Block at 0x%08x is bad</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">jeb</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">);</span>
			<span class="n">list_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">jeb</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">bad_list</span><span class="p">);</span>
			<span class="n">c</span><span class="o">-&gt;</span><span class="n">bad_size</span> <span class="o">+=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">sector_size</span><span class="p">;</span>
			<span class="n">c</span><span class="o">-&gt;</span><span class="n">free_size</span> <span class="o">-=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">sector_size</span><span class="p">;</span>
			<span class="n">bad_blocks</span><span class="o">++</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">pr_warn</span><span class="p">(</span><span class="s">&quot;%s(): unknown block state</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
			<span class="n">BUG</span><span class="p">();</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* Nextblock dirty is always seen as wasted, because we cannot recycle it now */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">nextblock</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">nextblock</span><span class="o">-&gt;</span><span class="n">dirty_size</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">nextblock</span><span class="o">-&gt;</span><span class="n">wasted_size</span> <span class="o">+=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">nextblock</span><span class="o">-&gt;</span><span class="n">dirty_size</span><span class="p">;</span>
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">wasted_size</span> <span class="o">+=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">nextblock</span><span class="o">-&gt;</span><span class="n">dirty_size</span><span class="p">;</span>
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">dirty_size</span> <span class="o">-=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">nextblock</span><span class="o">-&gt;</span><span class="n">dirty_size</span><span class="p">;</span>
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">nextblock</span><span class="o">-&gt;</span><span class="n">dirty_size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#ifdef CONFIG_JFFS2_FS_WRITEBUFFER</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">jffs2_can_mark_obsolete</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">wbuf_pagesize</span> <span class="o">&amp;&amp;</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">nextblock</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">nextblock</span><span class="o">-&gt;</span><span class="n">free_size</span> <span class="o">%</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">wbuf_pagesize</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* If we&#39;re going to start writing into a block which already</span>
<span class="cm">		   contains data, and the end of the data isn&#39;t page-aligned,</span>
<span class="cm">		   skip a little and align it. */</span>

		<span class="kt">uint32_t</span> <span class="n">skip</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">nextblock</span><span class="o">-&gt;</span><span class="n">free_size</span> <span class="o">%</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">wbuf_pagesize</span><span class="p">;</span>

		<span class="n">jffs2_dbg</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;%s(): Skipping %d bytes in nextblock to ensure page alignment</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">__func__</span><span class="p">,</span> <span class="n">skip</span><span class="p">);</span>
		<span class="n">jffs2_prealloc_raw_node_refs</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">nextblock</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">jffs2_scan_dirty_space</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">nextblock</span><span class="p">,</span> <span class="n">skip</span><span class="p">);</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">nr_erasing_blocks</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">used_size</span> <span class="o">&amp;&amp;</span> <span class="p">((</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">nr_free_blocks</span><span class="o">+</span><span class="n">empty_blocks</span><span class="o">+</span><span class="n">bad_blocks</span><span class="p">)</span><span class="o">!=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">nr_blocks</span> <span class="o">||</span> <span class="n">bad_blocks</span> <span class="o">==</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">nr_blocks</span><span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_notice</span><span class="p">(</span><span class="s">&quot;Cowardly refusing to erase blocks on filesystem with no valid JFFS2 nodes</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">pr_notice</span><span class="p">(</span><span class="s">&quot;empty_blocks %d, bad_blocks %d, c-&gt;nr_blocks %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				  <span class="n">empty_blocks</span><span class="p">,</span> <span class="n">bad_blocks</span><span class="p">,</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">nr_blocks</span><span class="p">);</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">erase_completion_lock</span><span class="p">);</span>
		<span class="n">jffs2_garbage_collect_trigger</span><span class="p">(</span><span class="n">c</span><span class="p">);</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">erase_completion_lock</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
 <span class="nl">out:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">buf_size</span><span class="p">)</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">flashbuf</span><span class="p">);</span>
<span class="cp">#ifndef __ECOS</span>
	<span class="k">else</span>
		<span class="n">mtd_unpoint</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">mtd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">mtd</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">jffs2_fill_scan_buf</span><span class="p">(</span><span class="k">struct</span> <span class="n">jffs2_sb_info</span> <span class="o">*</span><span class="n">c</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span>
			       <span class="kt">uint32_t</span> <span class="n">ofs</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">retlen</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">jffs2_flash_read</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">ofs</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">retlen</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">jffs2_dbg</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;mtd-&gt;read(0x%x bytes from 0x%x) returned %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">len</span><span class="p">,</span> <span class="n">ofs</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retlen</span> <span class="o">&lt;</span> <span class="n">len</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">jffs2_dbg</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;Read at 0x%x gave only 0x%zx bytes</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">ofs</span><span class="p">,</span> <span class="n">retlen</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">jffs2_scan_classify_jeb</span><span class="p">(</span><span class="k">struct</span> <span class="n">jffs2_sb_info</span> <span class="o">*</span><span class="n">c</span><span class="p">,</span> <span class="k">struct</span> <span class="n">jffs2_eraseblock</span> <span class="o">*</span><span class="n">jeb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">jeb</span><span class="o">-&gt;</span><span class="n">used_size</span> <span class="o">+</span> <span class="n">jeb</span><span class="o">-&gt;</span><span class="n">unchecked_size</span><span class="p">)</span> <span class="o">==</span> <span class="n">PAD</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">cleanmarker_size</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">jeb</span><span class="o">-&gt;</span><span class="n">dirty_size</span>
	    <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="o">!</span><span class="n">jeb</span><span class="o">-&gt;</span><span class="n">first_node</span> <span class="o">||</span> <span class="o">!</span><span class="n">ref_next</span><span class="p">(</span><span class="n">jeb</span><span class="o">-&gt;</span><span class="n">first_node</span><span class="p">))</span> <span class="p">)</span>
		<span class="k">return</span> <span class="n">BLK_STATE_CLEANMARKER</span><span class="p">;</span>

	<span class="cm">/* move blocks with max 4 byte dirty space to cleanlist */</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ISDIRTY</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">sector_size</span> <span class="o">-</span> <span class="p">(</span><span class="n">jeb</span><span class="o">-&gt;</span><span class="n">used_size</span> <span class="o">+</span> <span class="n">jeb</span><span class="o">-&gt;</span><span class="n">unchecked_size</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">dirty_size</span> <span class="o">-=</span> <span class="n">jeb</span><span class="o">-&gt;</span><span class="n">dirty_size</span><span class="p">;</span>
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">wasted_size</span> <span class="o">+=</span> <span class="n">jeb</span><span class="o">-&gt;</span><span class="n">dirty_size</span><span class="p">;</span>
		<span class="n">jeb</span><span class="o">-&gt;</span><span class="n">wasted_size</span> <span class="o">+=</span> <span class="n">jeb</span><span class="o">-&gt;</span><span class="n">dirty_size</span><span class="p">;</span>
		<span class="n">jeb</span><span class="o">-&gt;</span><span class="n">dirty_size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">BLK_STATE_CLEAN</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">jeb</span><span class="o">-&gt;</span><span class="n">used_size</span> <span class="o">||</span> <span class="n">jeb</span><span class="o">-&gt;</span><span class="n">unchecked_size</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">BLK_STATE_PARTDIRTY</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="n">BLK_STATE_ALLDIRTY</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_JFFS2_FS_XATTR</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">jffs2_scan_xattr_node</span><span class="p">(</span><span class="k">struct</span> <span class="n">jffs2_sb_info</span> <span class="o">*</span><span class="n">c</span><span class="p">,</span> <span class="k">struct</span> <span class="n">jffs2_eraseblock</span> <span class="o">*</span><span class="n">jeb</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">jffs2_raw_xattr</span> <span class="o">*</span><span class="n">rx</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">ofs</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">jffs2_summary</span> <span class="o">*</span><span class="n">s</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">jffs2_xattr_datum</span> <span class="o">*</span><span class="n">xd</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">xid</span><span class="p">,</span> <span class="n">version</span><span class="p">,</span> <span class="n">totlen</span><span class="p">,</span> <span class="n">crc</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">crc</span> <span class="o">=</span> <span class="n">crc32</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">rx</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">jffs2_raw_xattr</span><span class="p">)</span> <span class="o">-</span> <span class="mi">4</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">crc</span> <span class="o">!=</span> <span class="n">je32_to_cpu</span><span class="p">(</span><span class="n">rx</span><span class="o">-&gt;</span><span class="n">node_crc</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">JFFS2_WARNING</span><span class="p">(</span><span class="s">&quot;node CRC failed at %#08x, read=%#08x, calc=%#08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			      <span class="n">ofs</span><span class="p">,</span> <span class="n">je32_to_cpu</span><span class="p">(</span><span class="n">rx</span><span class="o">-&gt;</span><span class="n">node_crc</span><span class="p">),</span> <span class="n">crc</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">jffs2_scan_dirty_space</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">jeb</span><span class="p">,</span> <span class="n">je32_to_cpu</span><span class="p">(</span><span class="n">rx</span><span class="o">-&gt;</span><span class="n">totlen</span><span class="p">))))</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">xid</span> <span class="o">=</span> <span class="n">je32_to_cpu</span><span class="p">(</span><span class="n">rx</span><span class="o">-&gt;</span><span class="n">xid</span><span class="p">);</span>
	<span class="n">version</span> <span class="o">=</span> <span class="n">je32_to_cpu</span><span class="p">(</span><span class="n">rx</span><span class="o">-&gt;</span><span class="n">version</span><span class="p">);</span>

	<span class="n">totlen</span> <span class="o">=</span> <span class="n">PAD</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">jffs2_raw_xattr</span><span class="p">)</span>
			<span class="o">+</span> <span class="n">rx</span><span class="o">-&gt;</span><span class="n">name_len</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">je16_to_cpu</span><span class="p">(</span><span class="n">rx</span><span class="o">-&gt;</span><span class="n">value_len</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">totlen</span> <span class="o">!=</span> <span class="n">je32_to_cpu</span><span class="p">(</span><span class="n">rx</span><span class="o">-&gt;</span><span class="n">totlen</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">JFFS2_WARNING</span><span class="p">(</span><span class="s">&quot;node length mismatch at %#08x, read=%u, calc=%u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			      <span class="n">ofs</span><span class="p">,</span> <span class="n">je32_to_cpu</span><span class="p">(</span><span class="n">rx</span><span class="o">-&gt;</span><span class="n">totlen</span><span class="p">),</span> <span class="n">totlen</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">jffs2_scan_dirty_space</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">jeb</span><span class="p">,</span> <span class="n">je32_to_cpu</span><span class="p">(</span><span class="n">rx</span><span class="o">-&gt;</span><span class="n">totlen</span><span class="p">))))</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">xd</span> <span class="o">=</span> <span class="n">jffs2_setup_xattr_datum</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">xid</span><span class="p">,</span> <span class="n">version</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">xd</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">xd</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">xd</span><span class="o">-&gt;</span><span class="n">version</span> <span class="o">&gt;</span> <span class="n">version</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">jffs2_raw_node_ref</span> <span class="o">*</span><span class="n">raw</span>
			<span class="o">=</span> <span class="n">jffs2_link_node_ref</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">jeb</span><span class="p">,</span> <span class="n">ofs</span> <span class="o">|</span> <span class="n">REF_PRISTINE</span><span class="p">,</span> <span class="n">totlen</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="n">raw</span><span class="o">-&gt;</span><span class="n">next_in_ino</span> <span class="o">=</span> <span class="n">xd</span><span class="o">-&gt;</span><span class="n">node</span><span class="o">-&gt;</span><span class="n">next_in_ino</span><span class="p">;</span>
		<span class="n">xd</span><span class="o">-&gt;</span><span class="n">node</span><span class="o">-&gt;</span><span class="n">next_in_ino</span> <span class="o">=</span> <span class="n">raw</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">xd</span><span class="o">-&gt;</span><span class="n">version</span> <span class="o">=</span> <span class="n">version</span><span class="p">;</span>
		<span class="n">xd</span><span class="o">-&gt;</span><span class="n">xprefix</span> <span class="o">=</span> <span class="n">rx</span><span class="o">-&gt;</span><span class="n">xprefix</span><span class="p">;</span>
		<span class="n">xd</span><span class="o">-&gt;</span><span class="n">name_len</span> <span class="o">=</span> <span class="n">rx</span><span class="o">-&gt;</span><span class="n">name_len</span><span class="p">;</span>
		<span class="n">xd</span><span class="o">-&gt;</span><span class="n">value_len</span> <span class="o">=</span> <span class="n">je16_to_cpu</span><span class="p">(</span><span class="n">rx</span><span class="o">-&gt;</span><span class="n">value_len</span><span class="p">);</span>
		<span class="n">xd</span><span class="o">-&gt;</span><span class="n">data_crc</span> <span class="o">=</span> <span class="n">je32_to_cpu</span><span class="p">(</span><span class="n">rx</span><span class="o">-&gt;</span><span class="n">data_crc</span><span class="p">);</span>

		<span class="n">jffs2_link_node_ref</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">jeb</span><span class="p">,</span> <span class="n">ofs</span> <span class="o">|</span> <span class="n">REF_PRISTINE</span><span class="p">,</span> <span class="n">totlen</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">xd</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">jffs2_sum_active</span><span class="p">())</span>
		<span class="n">jffs2_sum_add_xattr_mem</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">rx</span><span class="p">,</span> <span class="n">ofs</span> <span class="o">-</span> <span class="n">jeb</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">);</span>
	<span class="n">dbg_xattr</span><span class="p">(</span><span class="s">&quot;scanning xdatum at %#08x (xid=%u, version=%u)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		  <span class="n">ofs</span><span class="p">,</span> <span class="n">xd</span><span class="o">-&gt;</span><span class="n">xid</span><span class="p">,</span> <span class="n">xd</span><span class="o">-&gt;</span><span class="n">version</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">jffs2_scan_xref_node</span><span class="p">(</span><span class="k">struct</span> <span class="n">jffs2_sb_info</span> <span class="o">*</span><span class="n">c</span><span class="p">,</span> <span class="k">struct</span> <span class="n">jffs2_eraseblock</span> <span class="o">*</span><span class="n">jeb</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">jffs2_raw_xref</span> <span class="o">*</span><span class="n">rr</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">ofs</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">jffs2_summary</span> <span class="o">*</span><span class="n">s</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">jffs2_xattr_ref</span> <span class="o">*</span><span class="n">ref</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">crc</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">crc</span> <span class="o">=</span> <span class="n">crc32</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">rr</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">rr</span><span class="p">)</span> <span class="o">-</span> <span class="mi">4</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">crc</span> <span class="o">!=</span> <span class="n">je32_to_cpu</span><span class="p">(</span><span class="n">rr</span><span class="o">-&gt;</span><span class="n">node_crc</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">JFFS2_WARNING</span><span class="p">(</span><span class="s">&quot;node CRC failed at %#08x, read=%#08x, calc=%#08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			      <span class="n">ofs</span><span class="p">,</span> <span class="n">je32_to_cpu</span><span class="p">(</span><span class="n">rr</span><span class="o">-&gt;</span><span class="n">node_crc</span><span class="p">),</span> <span class="n">crc</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">jffs2_scan_dirty_space</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">jeb</span><span class="p">,</span> <span class="n">PAD</span><span class="p">(</span><span class="n">je32_to_cpu</span><span class="p">(</span><span class="n">rr</span><span class="o">-&gt;</span><span class="n">totlen</span><span class="p">)))))</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">PAD</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">jffs2_raw_xref</span><span class="p">))</span> <span class="o">!=</span> <span class="n">je32_to_cpu</span><span class="p">(</span><span class="n">rr</span><span class="o">-&gt;</span><span class="n">totlen</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">JFFS2_WARNING</span><span class="p">(</span><span class="s">&quot;node length mismatch at %#08x, read=%u, calc=%zd</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			      <span class="n">ofs</span><span class="p">,</span> <span class="n">je32_to_cpu</span><span class="p">(</span><span class="n">rr</span><span class="o">-&gt;</span><span class="n">totlen</span><span class="p">),</span>
			      <span class="n">PAD</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">jffs2_raw_xref</span><span class="p">)));</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">jffs2_scan_dirty_space</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">jeb</span><span class="p">,</span> <span class="n">je32_to_cpu</span><span class="p">(</span><span class="n">rr</span><span class="o">-&gt;</span><span class="n">totlen</span><span class="p">))))</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ref</span> <span class="o">=</span> <span class="n">jffs2_alloc_xattr_ref</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ref</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="cm">/* BEFORE jffs2_build_xattr_subsystem() called, </span>
<span class="cm">	 * and AFTER xattr_ref is marked as a dead xref,</span>
<span class="cm">	 * ref-&gt;xid is used to store 32bit xid, xd is not used</span>
<span class="cm">	 * ref-&gt;ino is used to store 32bit inode-number, ic is not used</span>
<span class="cm">	 * Thoes variables are declared as union, thus using those</span>
<span class="cm">	 * are exclusive. In a similar way, ref-&gt;next is temporarily</span>
<span class="cm">	 * used to chain all xattr_ref object. It&#39;s re-chained to</span>
<span class="cm">	 * jffs2_inode_cache in jffs2_build_xattr_subsystem() correctly.</span>
<span class="cm">	 */</span>
	<span class="n">ref</span><span class="o">-&gt;</span><span class="n">ino</span> <span class="o">=</span> <span class="n">je32_to_cpu</span><span class="p">(</span><span class="n">rr</span><span class="o">-&gt;</span><span class="n">ino</span><span class="p">);</span>
	<span class="n">ref</span><span class="o">-&gt;</span><span class="n">xid</span> <span class="o">=</span> <span class="n">je32_to_cpu</span><span class="p">(</span><span class="n">rr</span><span class="o">-&gt;</span><span class="n">xid</span><span class="p">);</span>
	<span class="n">ref</span><span class="o">-&gt;</span><span class="n">xseqno</span> <span class="o">=</span> <span class="n">je32_to_cpu</span><span class="p">(</span><span class="n">rr</span><span class="o">-&gt;</span><span class="n">xseqno</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ref</span><span class="o">-&gt;</span><span class="n">xseqno</span> <span class="o">&gt;</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">highest_xseqno</span><span class="p">)</span>
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">highest_xseqno</span> <span class="o">=</span> <span class="p">(</span><span class="n">ref</span><span class="o">-&gt;</span><span class="n">xseqno</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">XREF_DELETE_MARKER</span><span class="p">);</span>
	<span class="n">ref</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">xref_temp</span><span class="p">;</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">xref_temp</span> <span class="o">=</span> <span class="n">ref</span><span class="p">;</span>

	<span class="n">jffs2_link_node_ref</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">jeb</span><span class="p">,</span> <span class="n">ofs</span> <span class="o">|</span> <span class="n">REF_PRISTINE</span><span class="p">,</span> <span class="n">PAD</span><span class="p">(</span><span class="n">je32_to_cpu</span><span class="p">(</span><span class="n">rr</span><span class="o">-&gt;</span><span class="n">totlen</span><span class="p">)),</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">ref</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">jffs2_sum_active</span><span class="p">())</span>
		<span class="n">jffs2_sum_add_xref_mem</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">rr</span><span class="p">,</span> <span class="n">ofs</span> <span class="o">-</span> <span class="n">jeb</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">);</span>
	<span class="n">dbg_xattr</span><span class="p">(</span><span class="s">&quot;scan xref at %#08x (xid=%u, ino=%u)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		  <span class="n">ofs</span><span class="p">,</span> <span class="n">ref</span><span class="o">-&gt;</span><span class="n">xid</span><span class="p">,</span> <span class="n">ref</span><span class="o">-&gt;</span><span class="n">ino</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="cm">/* Called with &#39;buf_size == 0&#39; if buf is in fact a pointer _directly_ into</span>
<span class="cm">   the flash, XIP-style */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">jffs2_scan_eraseblock</span> <span class="p">(</span><span class="k">struct</span> <span class="n">jffs2_sb_info</span> <span class="o">*</span><span class="n">c</span><span class="p">,</span> <span class="k">struct</span> <span class="n">jffs2_eraseblock</span> <span class="o">*</span><span class="n">jeb</span><span class="p">,</span>
				  <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">buf_size</span><span class="p">,</span> <span class="k">struct</span> <span class="n">jffs2_summary</span> <span class="o">*</span><span class="n">s</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">jffs2_unknown_node</span> <span class="o">*</span><span class="n">node</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">jffs2_unknown_node</span> <span class="n">crcnode</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">ofs</span><span class="p">,</span> <span class="n">prevofs</span><span class="p">,</span> <span class="n">max_ofs</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">hdr_crc</span><span class="p">,</span> <span class="n">buf_ofs</span><span class="p">,</span> <span class="n">buf_len</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">noise</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>


<span class="cp">#ifdef CONFIG_JFFS2_FS_WRITEBUFFER</span>
	<span class="kt">int</span> <span class="n">cleanmarkerfound</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="n">ofs</span> <span class="o">=</span> <span class="n">jeb</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">;</span>
	<span class="n">prevofs</span> <span class="o">=</span> <span class="n">jeb</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">jffs2_dbg</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;%s(): Scanning block at 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">ofs</span><span class="p">);</span>

<span class="cp">#ifdef CONFIG_JFFS2_FS_WRITEBUFFER</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">jffs2_cleanmarker_oob</span><span class="p">(</span><span class="n">c</span><span class="p">))</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">mtd_block_isbad</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">mtd</span><span class="p">,</span> <span class="n">jeb</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">))</span>
			<span class="k">return</span> <span class="n">BLK_STATE_BADBLOCK</span><span class="p">;</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">jffs2_check_nand_cleanmarker</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">jeb</span><span class="p">);</span>
		<span class="n">jffs2_dbg</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;jffs_check_nand_cleanmarker returned %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>

		<span class="cm">/* Even if it&#39;s not found, we still scan to see</span>
<span class="cm">		   if the block is empty. We use this information</span>
<span class="cm">		   to decide whether to erase it or not. */</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">0</span>:		<span class="n">cleanmarkerfound</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">1</span>: 	<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span> 	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="cp">#endif</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">jffs2_sum_active</span><span class="p">())</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">jffs2_sum_marker</span> <span class="o">*</span><span class="n">sm</span><span class="p">;</span>
		<span class="kt">void</span> <span class="o">*</span><span class="n">sumptr</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="kt">uint32_t</span> <span class="n">sumlen</span><span class="p">;</span>
	      
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">buf_size</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* XIP case. Just look, point at the summary if it&#39;s there */</span>
			<span class="n">sm</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">buf</span> <span class="o">+</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">sector_size</span> <span class="o">-</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">sm</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">je32_to_cpu</span><span class="p">(</span><span class="n">sm</span><span class="o">-&gt;</span><span class="n">magic</span><span class="p">)</span> <span class="o">==</span> <span class="n">JFFS2_SUM_MAGIC</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">sumptr</span> <span class="o">=</span> <span class="n">buf</span> <span class="o">+</span> <span class="n">je32_to_cpu</span><span class="p">(</span><span class="n">sm</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">);</span>
				<span class="n">sumlen</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">sector_size</span> <span class="o">-</span> <span class="n">je32_to_cpu</span><span class="p">(</span><span class="n">sm</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* If NAND flash, read a whole page of it. Else just the end */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">wbuf_pagesize</span><span class="p">)</span>
				<span class="n">buf_len</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">wbuf_pagesize</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">buf_len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">sm</span><span class="p">);</span>

			<span class="cm">/* Read as much as we want into the _end_ of the preallocated buffer */</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">jffs2_fill_scan_buf</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">buf</span> <span class="o">+</span> <span class="n">buf_size</span> <span class="o">-</span> <span class="n">buf_len</span><span class="p">,</span> 
						  <span class="n">jeb</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">+</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">sector_size</span> <span class="o">-</span> <span class="n">buf_len</span><span class="p">,</span>
						  <span class="n">buf_len</span><span class="p">);</span>				
			<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

			<span class="n">sm</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">buf</span> <span class="o">+</span> <span class="n">buf_size</span> <span class="o">-</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">sm</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">je32_to_cpu</span><span class="p">(</span><span class="n">sm</span><span class="o">-&gt;</span><span class="n">magic</span><span class="p">)</span> <span class="o">==</span> <span class="n">JFFS2_SUM_MAGIC</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">sumlen</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">sector_size</span> <span class="o">-</span> <span class="n">je32_to_cpu</span><span class="p">(</span><span class="n">sm</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">);</span>
				<span class="n">sumptr</span> <span class="o">=</span> <span class="n">buf</span> <span class="o">+</span> <span class="n">buf_size</span> <span class="o">-</span> <span class="n">sumlen</span><span class="p">;</span>

				<span class="cm">/* Now, make sure the summary itself is available */</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">sumlen</span> <span class="o">&gt;</span> <span class="n">buf_size</span><span class="p">)</span> <span class="p">{</span>
					<span class="cm">/* Need to kmalloc for this. */</span>
					<span class="n">sumptr</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">sumlen</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
					<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sumptr</span><span class="p">)</span>
						<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
					<span class="n">memcpy</span><span class="p">(</span><span class="n">sumptr</span> <span class="o">+</span> <span class="n">sumlen</span> <span class="o">-</span> <span class="n">buf_len</span><span class="p">,</span> <span class="n">buf</span> <span class="o">+</span> <span class="n">buf_size</span> <span class="o">-</span> <span class="n">buf_len</span><span class="p">,</span> <span class="n">buf_len</span><span class="p">);</span>
				<span class="p">}</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">buf_len</span> <span class="o">&lt;</span> <span class="n">sumlen</span><span class="p">)</span> <span class="p">{</span>
					<span class="cm">/* Need to read more so that the entire summary node is present */</span>
					<span class="n">err</span> <span class="o">=</span> <span class="n">jffs2_fill_scan_buf</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">sumptr</span><span class="p">,</span> 
								  <span class="n">jeb</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">+</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">sector_size</span> <span class="o">-</span> <span class="n">sumlen</span><span class="p">,</span>
								  <span class="n">sumlen</span> <span class="o">-</span> <span class="n">buf_len</span><span class="p">);</span>				
					<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
						<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>

		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">sumptr</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">jffs2_sum_scan_sumnode</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">jeb</span><span class="p">,</span> <span class="n">sumptr</span><span class="p">,</span> <span class="n">sumlen</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pseudo_random</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">buf_size</span> <span class="o">&amp;&amp;</span> <span class="n">sumlen</span> <span class="o">&gt;</span> <span class="n">buf_size</span><span class="p">)</span>
				<span class="n">kfree</span><span class="p">(</span><span class="n">sumptr</span><span class="p">);</span>
			<span class="cm">/* If it returns with a real error, bail. </span>
<span class="cm">			   If it returns positive, that&#39;s a block classification</span>
<span class="cm">			   (i.e. BLK_STATE_xxx) so return that too.</span>
<span class="cm">			   If it returns zero, fall through to full scan. */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">buf_ofs</span> <span class="o">=</span> <span class="n">jeb</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">buf_size</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* This is the XIP case -- we&#39;re reading _directly_ from the flash chip */</span>
		<span class="n">buf_len</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">sector_size</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">buf_len</span> <span class="o">=</span> <span class="n">EMPTY_SCAN_SIZE</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">sector_size</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">jffs2_fill_scan_buf</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">buf_ofs</span><span class="p">,</span> <span class="n">buf_len</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* We temporarily use &#39;ofs&#39; as a pointer into the buffer/jeb */</span>
	<span class="n">ofs</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">max_ofs</span> <span class="o">=</span> <span class="n">EMPTY_SCAN_SIZE</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">sector_size</span><span class="p">);</span>
	<span class="cm">/* Scan only EMPTY_SCAN_SIZE of 0xFF before declaring it&#39;s empty */</span>
	<span class="k">while</span><span class="p">(</span><span class="n">ofs</span> <span class="o">&lt;</span> <span class="n">max_ofs</span> <span class="o">&amp;&amp;</span> <span class="o">*</span><span class="p">(</span><span class="kt">uint32_t</span> <span class="o">*</span><span class="p">)(</span><span class="o">&amp;</span><span class="n">buf</span><span class="p">[</span><span class="n">ofs</span><span class="p">])</span> <span class="o">==</span> <span class="mh">0xFFFFFFFF</span><span class="p">)</span>
		<span class="n">ofs</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ofs</span> <span class="o">==</span> <span class="n">max_ofs</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#ifdef CONFIG_JFFS2_FS_WRITEBUFFER</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">jffs2_cleanmarker_oob</span><span class="p">(</span><span class="n">c</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* scan oob, take care of cleanmarker */</span>
			<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">jffs2_check_oob_empty</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">jeb</span><span class="p">,</span> <span class="n">cleanmarkerfound</span><span class="p">);</span>
			<span class="n">jffs2_dbg</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;jffs2_check_oob_empty returned %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				  <span class="n">ret</span><span class="p">);</span>
			<span class="k">switch</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="mi">0</span>:		<span class="k">return</span> <span class="n">cleanmarkerfound</span> <span class="o">?</span> <span class="n">BLK_STATE_CLEANMARKER</span> <span class="o">:</span> <span class="n">BLK_STATE_ALLFF</span><span class="p">;</span>
			<span class="k">case</span> <span class="mi">1</span>: 	<span class="k">return</span> <span class="n">BLK_STATE_ALLDIRTY</span><span class="p">;</span>
			<span class="nl">default:</span> 	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
<span class="cp">#endif</span>
		<span class="n">jffs2_dbg</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;Block at 0x%08x is empty (erased)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">jeb</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">cleanmarker_size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">BLK_STATE_CLEANMARKER</span><span class="p">;</span>	<span class="cm">/* don&#39;t bother with re-erase */</span>
		<span class="k">else</span>
			<span class="k">return</span> <span class="n">BLK_STATE_ALLFF</span><span class="p">;</span>	<span class="cm">/* OK to erase if all blocks are like this */</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ofs</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">jffs2_dbg</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;Free space at %08x ends at %08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">jeb</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">,</span>
			  <span class="n">jeb</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">+</span> <span class="n">ofs</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">jffs2_prealloc_raw_node_refs</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">jeb</span><span class="p">,</span> <span class="mi">1</span><span class="p">)))</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">jffs2_scan_dirty_space</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">jeb</span><span class="p">,</span> <span class="n">ofs</span><span class="p">)))</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Now ofs is a complete physical flash offset as it always was... */</span>
	<span class="n">ofs</span> <span class="o">+=</span> <span class="n">jeb</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">;</span>

	<span class="n">noise</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>

	<span class="n">dbg_summary</span><span class="p">(</span><span class="s">&quot;no summary found in jeb 0x%08x. Apply original scan.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">jeb</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">);</span>

<span class="nl">scan_more:</span>
	<span class="k">while</span><span class="p">(</span><span class="n">ofs</span> <span class="o">&lt;</span> <span class="n">jeb</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">+</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">sector_size</span><span class="p">)</span> <span class="p">{</span>

		<span class="n">jffs2_dbg_acct_paranoia_check_nolock</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">jeb</span><span class="p">);</span>

		<span class="cm">/* Make sure there are node refs available for use */</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">jffs2_prealloc_raw_node_refs</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">jeb</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

		<span class="n">cond_resched</span><span class="p">();</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ofs</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_warn</span><span class="p">(</span><span class="s">&quot;Eep. ofs 0x%08x not word-aligned!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ofs</span><span class="p">);</span>
			<span class="n">ofs</span> <span class="o">=</span> <span class="n">PAD</span><span class="p">(</span><span class="n">ofs</span><span class="p">);</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ofs</span> <span class="o">==</span> <span class="n">prevofs</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_warn</span><span class="p">(</span><span class="s">&quot;ofs 0x%08x has already been seen. Skipping</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">ofs</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">jffs2_scan_dirty_space</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">jeb</span><span class="p">,</span> <span class="mi">4</span><span class="p">)))</span>
				<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
			<span class="n">ofs</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">prevofs</span> <span class="o">=</span> <span class="n">ofs</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">jeb</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">+</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">sector_size</span> <span class="o">&lt;</span> <span class="n">ofs</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">node</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">jffs2_dbg</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;Fewer than %zd bytes left to end of block. (%x+%x&lt;%x+%zx) Not reading</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				  <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">jffs2_unknown_node</span><span class="p">),</span>
				  <span class="n">jeb</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">,</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">sector_size</span><span class="p">,</span> <span class="n">ofs</span><span class="p">,</span>
				  <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">node</span><span class="p">));</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">jffs2_scan_dirty_space</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">jeb</span><span class="p">,</span> <span class="p">(</span><span class="n">jeb</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">+</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">sector_size</span><span class="p">)</span><span class="o">-</span><span class="n">ofs</span><span class="p">)))</span>
				<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">buf_ofs</span> <span class="o">+</span> <span class="n">buf_len</span> <span class="o">&lt;</span> <span class="n">ofs</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">node</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">buf_len</span> <span class="o">=</span> <span class="n">min_t</span><span class="p">(</span><span class="kt">uint32_t</span><span class="p">,</span> <span class="n">buf_size</span><span class="p">,</span> <span class="n">jeb</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">+</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">sector_size</span> <span class="o">-</span> <span class="n">ofs</span><span class="p">);</span>
			<span class="n">jffs2_dbg</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;Fewer than %zd bytes (node header) left to end of buf. Reading 0x%x at 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				  <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">jffs2_unknown_node</span><span class="p">),</span>
				  <span class="n">buf_len</span><span class="p">,</span> <span class="n">ofs</span><span class="p">);</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">jffs2_fill_scan_buf</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">ofs</span><span class="p">,</span> <span class="n">buf_len</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
			<span class="n">buf_ofs</span> <span class="o">=</span> <span class="n">ofs</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">node</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">jffs2_unknown_node</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">buf</span><span class="p">[</span><span class="n">ofs</span><span class="o">-</span><span class="n">buf_ofs</span><span class="p">];</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="kt">uint32_t</span> <span class="o">*</span><span class="p">)(</span><span class="o">&amp;</span><span class="n">buf</span><span class="p">[</span><span class="n">ofs</span><span class="o">-</span><span class="n">buf_ofs</span><span class="p">])</span> <span class="o">==</span> <span class="mh">0xffffffff</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">uint32_t</span> <span class="n">inbuf_ofs</span><span class="p">;</span>
			<span class="kt">uint32_t</span> <span class="n">empty_start</span><span class="p">,</span> <span class="n">scan_end</span><span class="p">;</span>

			<span class="n">empty_start</span> <span class="o">=</span> <span class="n">ofs</span><span class="p">;</span>
			<span class="n">ofs</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>
			<span class="n">scan_end</span> <span class="o">=</span> <span class="n">min_t</span><span class="p">(</span><span class="kt">uint32_t</span><span class="p">,</span> <span class="n">EMPTY_SCAN_SIZE</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">sector_size</span><span class="p">)</span><span class="o">/</span><span class="mi">8</span><span class="p">,</span> <span class="n">buf_len</span><span class="p">);</span>

			<span class="n">jffs2_dbg</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;Found empty flash at 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ofs</span><span class="p">);</span>
		<span class="nl">more_empty:</span>
			<span class="n">inbuf_ofs</span> <span class="o">=</span> <span class="n">ofs</span> <span class="o">-</span> <span class="n">buf_ofs</span><span class="p">;</span>
			<span class="k">while</span> <span class="p">(</span><span class="n">inbuf_ofs</span> <span class="o">&lt;</span> <span class="n">scan_end</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="kt">uint32_t</span> <span class="o">*</span><span class="p">)(</span><span class="o">&amp;</span><span class="n">buf</span><span class="p">[</span><span class="n">inbuf_ofs</span><span class="p">])</span> <span class="o">!=</span> <span class="mh">0xffffffff</span><span class="p">))</span> <span class="p">{</span>
					<span class="n">pr_warn</span><span class="p">(</span><span class="s">&quot;Empty flash at 0x%08x ends at 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						<span class="n">empty_start</span><span class="p">,</span> <span class="n">ofs</span><span class="p">);</span>
					<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">jffs2_scan_dirty_space</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">jeb</span><span class="p">,</span> <span class="n">ofs</span><span class="o">-</span><span class="n">empty_start</span><span class="p">)))</span>
						<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
					<span class="k">goto</span> <span class="n">scan_more</span><span class="p">;</span>
				<span class="p">}</span>

				<span class="n">inbuf_ofs</span><span class="o">+=</span><span class="mi">4</span><span class="p">;</span>
				<span class="n">ofs</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="cm">/* Ran off end. */</span>
			<span class="n">jffs2_dbg</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;Empty flash to end of buffer at 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				  <span class="n">ofs</span><span class="p">);</span>

			<span class="cm">/* If we&#39;re only checking the beginning of a block with a cleanmarker,</span>
<span class="cm">			   bail now */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">buf_ofs</span> <span class="o">==</span> <span class="n">jeb</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">&amp;&amp;</span> <span class="n">jeb</span><span class="o">-&gt;</span><span class="n">used_size</span> <span class="o">==</span> <span class="n">PAD</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">cleanmarker_size</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			    <span class="n">c</span><span class="o">-&gt;</span><span class="n">cleanmarker_size</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">jeb</span><span class="o">-&gt;</span><span class="n">dirty_size</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">ref_next</span><span class="p">(</span><span class="n">jeb</span><span class="o">-&gt;</span><span class="n">first_node</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">jffs2_dbg</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;%d bytes at start of block seems clean... assuming all clean</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					  <span class="n">EMPTY_SCAN_SIZE</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">sector_size</span><span class="p">));</span>
				<span class="k">return</span> <span class="n">BLK_STATE_CLEANMARKER</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">buf_size</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">scan_end</span> <span class="o">!=</span> <span class="n">buf_len</span><span class="p">))</span> <span class="p">{</span><span class="cm">/* XIP/point case */</span>
				<span class="n">scan_end</span> <span class="o">=</span> <span class="n">buf_len</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">more_empty</span><span class="p">;</span>
			<span class="p">}</span>
			
			<span class="cm">/* See how much more there is to read in this eraseblock... */</span>
			<span class="n">buf_len</span> <span class="o">=</span> <span class="n">min_t</span><span class="p">(</span><span class="kt">uint32_t</span><span class="p">,</span> <span class="n">buf_size</span><span class="p">,</span> <span class="n">jeb</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">+</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">sector_size</span> <span class="o">-</span> <span class="n">ofs</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">buf_len</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* No more to read. Break out of main loop without marking</span>
<span class="cm">				   this range of empty space as dirty (because it&#39;s not) */</span>
				<span class="n">jffs2_dbg</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;Empty flash at %08x runs to end of block. Treating as free_space</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					  <span class="n">empty_start</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="cm">/* point never reaches here */</span>
			<span class="n">scan_end</span> <span class="o">=</span> <span class="n">buf_len</span><span class="p">;</span>
			<span class="n">jffs2_dbg</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;Reading another 0x%x at 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				  <span class="n">buf_len</span><span class="p">,</span> <span class="n">ofs</span><span class="p">);</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">jffs2_fill_scan_buf</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">ofs</span><span class="p">,</span> <span class="n">buf_len</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
			<span class="n">buf_ofs</span> <span class="o">=</span> <span class="n">ofs</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">more_empty</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ofs</span> <span class="o">==</span> <span class="n">jeb</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">&amp;&amp;</span> <span class="n">je16_to_cpu</span><span class="p">(</span><span class="n">node</span><span class="o">-&gt;</span><span class="n">magic</span><span class="p">)</span> <span class="o">==</span> <span class="n">KSAMTIB_CIGAM_2SFFJ</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_warn</span><span class="p">(</span><span class="s">&quot;Magic bitmask is backwards at offset 0x%08x. Wrong endian filesystem?</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">ofs</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">jffs2_scan_dirty_space</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">jeb</span><span class="p">,</span> <span class="mi">4</span><span class="p">)))</span>
				<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
			<span class="n">ofs</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">je16_to_cpu</span><span class="p">(</span><span class="n">node</span><span class="o">-&gt;</span><span class="n">magic</span><span class="p">)</span> <span class="o">==</span> <span class="n">JFFS2_DIRTY_BITMASK</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">jffs2_dbg</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;Dirty bitmask at 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ofs</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">jffs2_scan_dirty_space</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">jeb</span><span class="p">,</span> <span class="mi">4</span><span class="p">)))</span>
				<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
			<span class="n">ofs</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">je16_to_cpu</span><span class="p">(</span><span class="n">node</span><span class="o">-&gt;</span><span class="n">magic</span><span class="p">)</span> <span class="o">==</span> <span class="n">JFFS2_OLD_MAGIC_BITMASK</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_warn</span><span class="p">(</span><span class="s">&quot;Old JFFS2 bitmask found at 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ofs</span><span class="p">);</span>
			<span class="n">pr_warn</span><span class="p">(</span><span class="s">&quot;You cannot use older JFFS2 filesystems with newer kernels</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">jffs2_scan_dirty_space</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">jeb</span><span class="p">,</span> <span class="mi">4</span><span class="p">)))</span>
				<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
			<span class="n">ofs</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">je16_to_cpu</span><span class="p">(</span><span class="n">node</span><span class="o">-&gt;</span><span class="n">magic</span><span class="p">)</span> <span class="o">!=</span> <span class="n">JFFS2_MAGIC_BITMASK</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* OK. We&#39;re out of possibilities. Whinge and move on */</span>
			<span class="n">noisy_printk</span><span class="p">(</span><span class="o">&amp;</span><span class="n">noise</span><span class="p">,</span> <span class="s">&quot;%s(): Magic bitmask 0x%04x not found at 0x%08x: 0x%04x instead</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				     <span class="n">__func__</span><span class="p">,</span>
				     <span class="n">JFFS2_MAGIC_BITMASK</span><span class="p">,</span> <span class="n">ofs</span><span class="p">,</span>
				     <span class="n">je16_to_cpu</span><span class="p">(</span><span class="n">node</span><span class="o">-&gt;</span><span class="n">magic</span><span class="p">));</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">jffs2_scan_dirty_space</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">jeb</span><span class="p">,</span> <span class="mi">4</span><span class="p">)))</span>
				<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
			<span class="n">ofs</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* We seem to have a node of sorts. Check the CRC */</span>
		<span class="n">crcnode</span><span class="p">.</span><span class="n">magic</span> <span class="o">=</span> <span class="n">node</span><span class="o">-&gt;</span><span class="n">magic</span><span class="p">;</span>
		<span class="n">crcnode</span><span class="p">.</span><span class="n">nodetype</span> <span class="o">=</span> <span class="n">cpu_to_je16</span><span class="p">(</span> <span class="n">je16_to_cpu</span><span class="p">(</span><span class="n">node</span><span class="o">-&gt;</span><span class="n">nodetype</span><span class="p">)</span> <span class="o">|</span> <span class="n">JFFS2_NODE_ACCURATE</span><span class="p">);</span>
		<span class="n">crcnode</span><span class="p">.</span><span class="n">totlen</span> <span class="o">=</span> <span class="n">node</span><span class="o">-&gt;</span><span class="n">totlen</span><span class="p">;</span>
		<span class="n">hdr_crc</span> <span class="o">=</span> <span class="n">crc32</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">crcnode</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">crcnode</span><span class="p">)</span><span class="o">-</span><span class="mi">4</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">hdr_crc</span> <span class="o">!=</span> <span class="n">je32_to_cpu</span><span class="p">(</span><span class="n">node</span><span class="o">-&gt;</span><span class="n">hdr_crc</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">noisy_printk</span><span class="p">(</span><span class="o">&amp;</span><span class="n">noise</span><span class="p">,</span> <span class="s">&quot;%s(): Node at 0x%08x {0x%04x, 0x%04x, 0x%08x) has invalid CRC 0x%08x (calculated 0x%08x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				     <span class="n">__func__</span><span class="p">,</span>
				     <span class="n">ofs</span><span class="p">,</span> <span class="n">je16_to_cpu</span><span class="p">(</span><span class="n">node</span><span class="o">-&gt;</span><span class="n">magic</span><span class="p">),</span>
				     <span class="n">je16_to_cpu</span><span class="p">(</span><span class="n">node</span><span class="o">-&gt;</span><span class="n">nodetype</span><span class="p">),</span>
				     <span class="n">je32_to_cpu</span><span class="p">(</span><span class="n">node</span><span class="o">-&gt;</span><span class="n">totlen</span><span class="p">),</span>
				     <span class="n">je32_to_cpu</span><span class="p">(</span><span class="n">node</span><span class="o">-&gt;</span><span class="n">hdr_crc</span><span class="p">),</span>
				     <span class="n">hdr_crc</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">jffs2_scan_dirty_space</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">jeb</span><span class="p">,</span> <span class="mi">4</span><span class="p">)))</span>
				<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
			<span class="n">ofs</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ofs</span> <span class="o">+</span> <span class="n">je32_to_cpu</span><span class="p">(</span><span class="n">node</span><span class="o">-&gt;</span><span class="n">totlen</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">jeb</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">+</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">sector_size</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Eep. Node goes over the end of the erase block. */</span>
			<span class="n">pr_warn</span><span class="p">(</span><span class="s">&quot;Node at 0x%08x with length 0x%08x would run over the end of the erase block</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">ofs</span><span class="p">,</span> <span class="n">je32_to_cpu</span><span class="p">(</span><span class="n">node</span><span class="o">-&gt;</span><span class="n">totlen</span><span class="p">));</span>
			<span class="n">pr_warn</span><span class="p">(</span><span class="s">&quot;Perhaps the file system was created with the wrong erase size?</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">jffs2_scan_dirty_space</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">jeb</span><span class="p">,</span> <span class="mi">4</span><span class="p">)))</span>
				<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
			<span class="n">ofs</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">je16_to_cpu</span><span class="p">(</span><span class="n">node</span><span class="o">-&gt;</span><span class="n">nodetype</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">JFFS2_NODE_ACCURATE</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* Wheee. This is an obsoleted node */</span>
			<span class="n">jffs2_dbg</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;Node at 0x%08x is obsolete. Skipping</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				  <span class="n">ofs</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">jffs2_scan_dirty_space</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">jeb</span><span class="p">,</span> <span class="n">PAD</span><span class="p">(</span><span class="n">je32_to_cpu</span><span class="p">(</span><span class="n">node</span><span class="o">-&gt;</span><span class="n">totlen</span><span class="p">)))))</span>
				<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
			<span class="n">ofs</span> <span class="o">+=</span> <span class="n">PAD</span><span class="p">(</span><span class="n">je32_to_cpu</span><span class="p">(</span><span class="n">node</span><span class="o">-&gt;</span><span class="n">totlen</span><span class="p">));</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">switch</span><span class="p">(</span><span class="n">je16_to_cpu</span><span class="p">(</span><span class="n">node</span><span class="o">-&gt;</span><span class="n">nodetype</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">JFFS2_NODETYPE_INODE</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">buf_ofs</span> <span class="o">+</span> <span class="n">buf_len</span> <span class="o">&lt;</span> <span class="n">ofs</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">jffs2_raw_inode</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">buf_len</span> <span class="o">=</span> <span class="n">min_t</span><span class="p">(</span><span class="kt">uint32_t</span><span class="p">,</span> <span class="n">buf_size</span><span class="p">,</span> <span class="n">jeb</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">+</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">sector_size</span> <span class="o">-</span> <span class="n">ofs</span><span class="p">);</span>
				<span class="n">jffs2_dbg</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;Fewer than %zd bytes (inode node) left to end of buf. Reading 0x%x at 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					  <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">jffs2_raw_inode</span><span class="p">),</span>
					  <span class="n">buf_len</span><span class="p">,</span> <span class="n">ofs</span><span class="p">);</span>
				<span class="n">err</span> <span class="o">=</span> <span class="n">jffs2_fill_scan_buf</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">ofs</span><span class="p">,</span> <span class="n">buf_len</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
					<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
				<span class="n">buf_ofs</span> <span class="o">=</span> <span class="n">ofs</span><span class="p">;</span>
				<span class="n">node</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">buf</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">jffs2_scan_inode_node</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">jeb</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">node</span><span class="p">,</span> <span class="n">ofs</span><span class="p">,</span> <span class="n">s</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="k">return</span> <span class="n">err</span><span class="p">;</span>
			<span class="n">ofs</span> <span class="o">+=</span> <span class="n">PAD</span><span class="p">(</span><span class="n">je32_to_cpu</span><span class="p">(</span><span class="n">node</span><span class="o">-&gt;</span><span class="n">totlen</span><span class="p">));</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">JFFS2_NODETYPE_DIRENT</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">buf_ofs</span> <span class="o">+</span> <span class="n">buf_len</span> <span class="o">&lt;</span> <span class="n">ofs</span> <span class="o">+</span> <span class="n">je32_to_cpu</span><span class="p">(</span><span class="n">node</span><span class="o">-&gt;</span><span class="n">totlen</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">buf_len</span> <span class="o">=</span> <span class="n">min_t</span><span class="p">(</span><span class="kt">uint32_t</span><span class="p">,</span> <span class="n">buf_size</span><span class="p">,</span> <span class="n">jeb</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">+</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">sector_size</span> <span class="o">-</span> <span class="n">ofs</span><span class="p">);</span>
				<span class="n">jffs2_dbg</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;Fewer than %d bytes (dirent node) left to end of buf. Reading 0x%x at 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					  <span class="n">je32_to_cpu</span><span class="p">(</span><span class="n">node</span><span class="o">-&gt;</span><span class="n">totlen</span><span class="p">),</span> <span class="n">buf_len</span><span class="p">,</span>
					  <span class="n">ofs</span><span class="p">);</span>
				<span class="n">err</span> <span class="o">=</span> <span class="n">jffs2_fill_scan_buf</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">ofs</span><span class="p">,</span> <span class="n">buf_len</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
					<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
				<span class="n">buf_ofs</span> <span class="o">=</span> <span class="n">ofs</span><span class="p">;</span>
				<span class="n">node</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">buf</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">jffs2_scan_dirent_node</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">jeb</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">node</span><span class="p">,</span> <span class="n">ofs</span><span class="p">,</span> <span class="n">s</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="k">return</span> <span class="n">err</span><span class="p">;</span>
			<span class="n">ofs</span> <span class="o">+=</span> <span class="n">PAD</span><span class="p">(</span><span class="n">je32_to_cpu</span><span class="p">(</span><span class="n">node</span><span class="o">-&gt;</span><span class="n">totlen</span><span class="p">));</span>
			<span class="k">break</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_JFFS2_FS_XATTR</span>
		<span class="k">case</span> <span class="n">JFFS2_NODETYPE_XATTR</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">buf_ofs</span> <span class="o">+</span> <span class="n">buf_len</span> <span class="o">&lt;</span> <span class="n">ofs</span> <span class="o">+</span> <span class="n">je32_to_cpu</span><span class="p">(</span><span class="n">node</span><span class="o">-&gt;</span><span class="n">totlen</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">buf_len</span> <span class="o">=</span> <span class="n">min_t</span><span class="p">(</span><span class="kt">uint32_t</span><span class="p">,</span> <span class="n">buf_size</span><span class="p">,</span> <span class="n">jeb</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">+</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">sector_size</span> <span class="o">-</span> <span class="n">ofs</span><span class="p">);</span>
				<span class="n">jffs2_dbg</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;Fewer than %d bytes (xattr node) left to end of buf. Reading 0x%x at 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					  <span class="n">je32_to_cpu</span><span class="p">(</span><span class="n">node</span><span class="o">-&gt;</span><span class="n">totlen</span><span class="p">),</span> <span class="n">buf_len</span><span class="p">,</span>
					  <span class="n">ofs</span><span class="p">);</span>
				<span class="n">err</span> <span class="o">=</span> <span class="n">jffs2_fill_scan_buf</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">ofs</span><span class="p">,</span> <span class="n">buf_len</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
					<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
				<span class="n">buf_ofs</span> <span class="o">=</span> <span class="n">ofs</span><span class="p">;</span>
				<span class="n">node</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">buf</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">jffs2_scan_xattr_node</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">jeb</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">node</span><span class="p">,</span> <span class="n">ofs</span><span class="p">,</span> <span class="n">s</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
			<span class="n">ofs</span> <span class="o">+=</span> <span class="n">PAD</span><span class="p">(</span><span class="n">je32_to_cpu</span><span class="p">(</span><span class="n">node</span><span class="o">-&gt;</span><span class="n">totlen</span><span class="p">));</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">JFFS2_NODETYPE_XREF</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">buf_ofs</span> <span class="o">+</span> <span class="n">buf_len</span> <span class="o">&lt;</span> <span class="n">ofs</span> <span class="o">+</span> <span class="n">je32_to_cpu</span><span class="p">(</span><span class="n">node</span><span class="o">-&gt;</span><span class="n">totlen</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">buf_len</span> <span class="o">=</span> <span class="n">min_t</span><span class="p">(</span><span class="kt">uint32_t</span><span class="p">,</span> <span class="n">buf_size</span><span class="p">,</span> <span class="n">jeb</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">+</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">sector_size</span> <span class="o">-</span> <span class="n">ofs</span><span class="p">);</span>
				<span class="n">jffs2_dbg</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;Fewer than %d bytes (xref node) left to end of buf. Reading 0x%x at 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					  <span class="n">je32_to_cpu</span><span class="p">(</span><span class="n">node</span><span class="o">-&gt;</span><span class="n">totlen</span><span class="p">),</span> <span class="n">buf_len</span><span class="p">,</span>
					  <span class="n">ofs</span><span class="p">);</span>
				<span class="n">err</span> <span class="o">=</span> <span class="n">jffs2_fill_scan_buf</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">ofs</span><span class="p">,</span> <span class="n">buf_len</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
					<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
				<span class="n">buf_ofs</span> <span class="o">=</span> <span class="n">ofs</span><span class="p">;</span>
				<span class="n">node</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">buf</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">jffs2_scan_xref_node</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">jeb</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">node</span><span class="p">,</span> <span class="n">ofs</span><span class="p">,</span> <span class="n">s</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
			<span class="n">ofs</span> <span class="o">+=</span> <span class="n">PAD</span><span class="p">(</span><span class="n">je32_to_cpu</span><span class="p">(</span><span class="n">node</span><span class="o">-&gt;</span><span class="n">totlen</span><span class="p">));</span>
			<span class="k">break</span><span class="p">;</span>
<span class="cp">#endif	</span><span class="cm">/* CONFIG_JFFS2_FS_XATTR */</span><span class="cp"></span>

		<span class="k">case</span> <span class="n">JFFS2_NODETYPE_CLEANMARKER</span>:
			<span class="n">jffs2_dbg</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;CLEANMARKER node found at 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ofs</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">je32_to_cpu</span><span class="p">(</span><span class="n">node</span><span class="o">-&gt;</span><span class="n">totlen</span><span class="p">)</span> <span class="o">!=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">cleanmarker_size</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">pr_notice</span><span class="p">(</span><span class="s">&quot;CLEANMARKER node found at 0x%08x has totlen 0x%x != normal 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					  <span class="n">ofs</span><span class="p">,</span> <span class="n">je32_to_cpu</span><span class="p">(</span><span class="n">node</span><span class="o">-&gt;</span><span class="n">totlen</span><span class="p">),</span>
					  <span class="n">c</span><span class="o">-&gt;</span><span class="n">cleanmarker_size</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">jffs2_scan_dirty_space</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">jeb</span><span class="p">,</span> <span class="n">PAD</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">jffs2_unknown_node</span><span class="p">)))))</span>
					<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
				<span class="n">ofs</span> <span class="o">+=</span> <span class="n">PAD</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">jffs2_unknown_node</span><span class="p">));</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">jeb</span><span class="o">-&gt;</span><span class="n">first_node</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">pr_notice</span><span class="p">(</span><span class="s">&quot;CLEANMARKER node found at 0x%08x, not first node in block (0x%08x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					  <span class="n">ofs</span><span class="p">,</span> <span class="n">jeb</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">jffs2_scan_dirty_space</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">jeb</span><span class="p">,</span> <span class="n">PAD</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">jffs2_unknown_node</span><span class="p">)))))</span>
					<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
				<span class="n">ofs</span> <span class="o">+=</span> <span class="n">PAD</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">jffs2_unknown_node</span><span class="p">));</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">jffs2_link_node_ref</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">jeb</span><span class="p">,</span> <span class="n">ofs</span> <span class="o">|</span> <span class="n">REF_NORMAL</span><span class="p">,</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">cleanmarker_size</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

				<span class="n">ofs</span> <span class="o">+=</span> <span class="n">PAD</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">cleanmarker_size</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">JFFS2_NODETYPE_PADDING</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">jffs2_sum_active</span><span class="p">())</span>
				<span class="n">jffs2_sum_add_padding_mem</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">je32_to_cpu</span><span class="p">(</span><span class="n">node</span><span class="o">-&gt;</span><span class="n">totlen</span><span class="p">));</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">jffs2_scan_dirty_space</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">jeb</span><span class="p">,</span> <span class="n">PAD</span><span class="p">(</span><span class="n">je32_to_cpu</span><span class="p">(</span><span class="n">node</span><span class="o">-&gt;</span><span class="n">totlen</span><span class="p">)))))</span>
				<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
			<span class="n">ofs</span> <span class="o">+=</span> <span class="n">PAD</span><span class="p">(</span><span class="n">je32_to_cpu</span><span class="p">(</span><span class="n">node</span><span class="o">-&gt;</span><span class="n">totlen</span><span class="p">));</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="nl">default:</span>
			<span class="k">switch</span> <span class="p">(</span><span class="n">je16_to_cpu</span><span class="p">(</span><span class="n">node</span><span class="o">-&gt;</span><span class="n">nodetype</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">JFFS2_COMPAT_MASK</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="n">JFFS2_FEATURE_ROCOMPAT</span>:
				<span class="n">pr_notice</span><span class="p">(</span><span class="s">&quot;Read-only compatible feature node (0x%04x) found at offset 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					  <span class="n">je16_to_cpu</span><span class="p">(</span><span class="n">node</span><span class="o">-&gt;</span><span class="n">nodetype</span><span class="p">),</span> <span class="n">ofs</span><span class="p">);</span>
				<span class="n">c</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">JFFS2_SB_FLAG_RO</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">jffs2_is_readonly</span><span class="p">(</span><span class="n">c</span><span class="p">)))</span>
					<span class="k">return</span> <span class="o">-</span><span class="n">EROFS</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">jffs2_scan_dirty_space</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">jeb</span><span class="p">,</span> <span class="n">PAD</span><span class="p">(</span><span class="n">je32_to_cpu</span><span class="p">(</span><span class="n">node</span><span class="o">-&gt;</span><span class="n">totlen</span><span class="p">)))))</span>
					<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
				<span class="n">ofs</span> <span class="o">+=</span> <span class="n">PAD</span><span class="p">(</span><span class="n">je32_to_cpu</span><span class="p">(</span><span class="n">node</span><span class="o">-&gt;</span><span class="n">totlen</span><span class="p">));</span>
				<span class="k">break</span><span class="p">;</span>

			<span class="k">case</span> <span class="n">JFFS2_FEATURE_INCOMPAT</span>:
				<span class="n">pr_notice</span><span class="p">(</span><span class="s">&quot;Incompatible feature node (0x%04x) found at offset 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					  <span class="n">je16_to_cpu</span><span class="p">(</span><span class="n">node</span><span class="o">-&gt;</span><span class="n">nodetype</span><span class="p">),</span> <span class="n">ofs</span><span class="p">);</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

			<span class="k">case</span> <span class="n">JFFS2_FEATURE_RWCOMPAT_DELETE</span>:
				<span class="n">jffs2_dbg</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;Unknown but compatible feature node (0x%04x) found at offset 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					  <span class="n">je16_to_cpu</span><span class="p">(</span><span class="n">node</span><span class="o">-&gt;</span><span class="n">nodetype</span><span class="p">),</span> <span class="n">ofs</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">jffs2_scan_dirty_space</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">jeb</span><span class="p">,</span> <span class="n">PAD</span><span class="p">(</span><span class="n">je32_to_cpu</span><span class="p">(</span><span class="n">node</span><span class="o">-&gt;</span><span class="n">totlen</span><span class="p">)))))</span>
					<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
				<span class="n">ofs</span> <span class="o">+=</span> <span class="n">PAD</span><span class="p">(</span><span class="n">je32_to_cpu</span><span class="p">(</span><span class="n">node</span><span class="o">-&gt;</span><span class="n">totlen</span><span class="p">));</span>
				<span class="k">break</span><span class="p">;</span>

			<span class="k">case</span> <span class="n">JFFS2_FEATURE_RWCOMPAT_COPY</span>: <span class="p">{</span>
				<span class="n">jffs2_dbg</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;Unknown but compatible feature node (0x%04x) found at offset 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					  <span class="n">je16_to_cpu</span><span class="p">(</span><span class="n">node</span><span class="o">-&gt;</span><span class="n">nodetype</span><span class="p">),</span> <span class="n">ofs</span><span class="p">);</span>

				<span class="n">jffs2_link_node_ref</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">jeb</span><span class="p">,</span> <span class="n">ofs</span> <span class="o">|</span> <span class="n">REF_PRISTINE</span><span class="p">,</span> <span class="n">PAD</span><span class="p">(</span><span class="n">je32_to_cpu</span><span class="p">(</span><span class="n">node</span><span class="o">-&gt;</span><span class="n">totlen</span><span class="p">)),</span> <span class="nb">NULL</span><span class="p">);</span>

				<span class="cm">/* We can&#39;t summarise nodes we don&#39;t grok */</span>
				<span class="n">jffs2_sum_disable_collecting</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
				<span class="n">ofs</span> <span class="o">+=</span> <span class="n">PAD</span><span class="p">(</span><span class="n">je32_to_cpu</span><span class="p">(</span><span class="n">node</span><span class="o">-&gt;</span><span class="n">totlen</span><span class="p">));</span>
				<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">jffs2_sum_active</span><span class="p">())</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">PAD</span><span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">sum_size</span> <span class="o">+</span> <span class="n">JFFS2_SUMMARY_FRAME_SIZE</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">jeb</span><span class="o">-&gt;</span><span class="n">free_size</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dbg_summary</span><span class="p">(</span><span class="s">&quot;There is not enough space for &quot;</span>
				<span class="s">&quot;summary information, disabling for this jeb!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">jffs2_sum_disable_collecting</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">jffs2_dbg</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;Block at 0x%08x: free 0x%08x, dirty 0x%08x, unchecked 0x%08x, used 0x%08x, wasted 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		  <span class="n">jeb</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">,</span> <span class="n">jeb</span><span class="o">-&gt;</span><span class="n">free_size</span><span class="p">,</span> <span class="n">jeb</span><span class="o">-&gt;</span><span class="n">dirty_size</span><span class="p">,</span>
		  <span class="n">jeb</span><span class="o">-&gt;</span><span class="n">unchecked_size</span><span class="p">,</span> <span class="n">jeb</span><span class="o">-&gt;</span><span class="n">used_size</span><span class="p">,</span> <span class="n">jeb</span><span class="o">-&gt;</span><span class="n">wasted_size</span><span class="p">);</span>
	
	<span class="cm">/* mark_node_obsolete can add to wasted !! */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">jeb</span><span class="o">-&gt;</span><span class="n">wasted_size</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">jeb</span><span class="o">-&gt;</span><span class="n">dirty_size</span> <span class="o">+=</span> <span class="n">jeb</span><span class="o">-&gt;</span><span class="n">wasted_size</span><span class="p">;</span>
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">dirty_size</span> <span class="o">+=</span> <span class="n">jeb</span><span class="o">-&gt;</span><span class="n">wasted_size</span><span class="p">;</span>
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">wasted_size</span> <span class="o">-=</span> <span class="n">jeb</span><span class="o">-&gt;</span><span class="n">wasted_size</span><span class="p">;</span>
		<span class="n">jeb</span><span class="o">-&gt;</span><span class="n">wasted_size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">jffs2_scan_classify_jeb</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">jeb</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">jffs2_inode_cache</span> <span class="o">*</span><span class="nf">jffs2_scan_make_ino_cache</span><span class="p">(</span><span class="k">struct</span> <span class="n">jffs2_sb_info</span> <span class="o">*</span><span class="n">c</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">ino</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">jffs2_inode_cache</span> <span class="o">*</span><span class="n">ic</span><span class="p">;</span>

	<span class="n">ic</span> <span class="o">=</span> <span class="n">jffs2_get_ino_cache</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">ino</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ic</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ic</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ino</span> <span class="o">&gt;</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">highest_ino</span><span class="p">)</span>
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">highest_ino</span> <span class="o">=</span> <span class="n">ino</span><span class="p">;</span>

	<span class="n">ic</span> <span class="o">=</span> <span class="n">jffs2_alloc_inode_cache</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ic</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_notice</span><span class="p">(</span><span class="s">&quot;%s(): allocation of inode cache failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">ic</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">ic</span><span class="p">));</span>

	<span class="n">ic</span><span class="o">-&gt;</span><span class="n">ino</span> <span class="o">=</span> <span class="n">ino</span><span class="p">;</span>
	<span class="n">ic</span><span class="o">-&gt;</span><span class="n">nodes</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">ic</span><span class="p">;</span>
	<span class="n">jffs2_add_ino_cache</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">ic</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ino</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">ic</span><span class="o">-&gt;</span><span class="n">pino_nlink</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">ic</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">jffs2_scan_inode_node</span><span class="p">(</span><span class="k">struct</span> <span class="n">jffs2_sb_info</span> <span class="o">*</span><span class="n">c</span><span class="p">,</span> <span class="k">struct</span> <span class="n">jffs2_eraseblock</span> <span class="o">*</span><span class="n">jeb</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">jffs2_raw_inode</span> <span class="o">*</span><span class="n">ri</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">ofs</span><span class="p">,</span> <span class="k">struct</span> <span class="n">jffs2_summary</span> <span class="o">*</span><span class="n">s</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">jffs2_inode_cache</span> <span class="o">*</span><span class="n">ic</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">crc</span><span class="p">,</span> <span class="n">ino</span> <span class="o">=</span> <span class="n">je32_to_cpu</span><span class="p">(</span><span class="n">ri</span><span class="o">-&gt;</span><span class="n">ino</span><span class="p">);</span>

	<span class="n">jffs2_dbg</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;%s(): Node at 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">ofs</span><span class="p">);</span>

	<span class="cm">/* We do very little here now. Just check the ino# to which we should attribute</span>
<span class="cm">	   this node; we can do all the CRC checking etc. later. There&#39;s a tradeoff here --</span>
<span class="cm">	   we used to scan the flash once only, reading everything we want from it into</span>
<span class="cm">	   memory, then building all our in-core data structures and freeing the extra</span>
<span class="cm">	   information. Now we allow the first part of the mount to complete a lot quicker,</span>
<span class="cm">	   but we have to go _back_ to the flash in order to finish the CRC checking, etc.</span>
<span class="cm">	   Which means that the _full_ amount of time to get to proper write mode with GC</span>
<span class="cm">	   operational may actually be _longer_ than before. Sucks to be me. */</span>

	<span class="cm">/* Check the node CRC in any case. */</span>
	<span class="n">crc</span> <span class="o">=</span> <span class="n">crc32</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">ri</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">ri</span><span class="p">)</span><span class="o">-</span><span class="mi">8</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">crc</span> <span class="o">!=</span> <span class="n">je32_to_cpu</span><span class="p">(</span><span class="n">ri</span><span class="o">-&gt;</span><span class="n">node_crc</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pr_notice</span><span class="p">(</span><span class="s">&quot;%s(): CRC failed on node at 0x%08x: Read 0x%08x, calculated 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">__func__</span><span class="p">,</span> <span class="n">ofs</span><span class="p">,</span> <span class="n">je32_to_cpu</span><span class="p">(</span><span class="n">ri</span><span class="o">-&gt;</span><span class="n">node_crc</span><span class="p">),</span> <span class="n">crc</span><span class="p">);</span>
		<span class="cm">/*</span>
<span class="cm">		 * We believe totlen because the CRC on the node</span>
<span class="cm">		 * _header_ was OK, just the node itself failed.</span>
<span class="cm">		 */</span>
		<span class="k">return</span> <span class="n">jffs2_scan_dirty_space</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">jeb</span><span class="p">,</span>
					      <span class="n">PAD</span><span class="p">(</span><span class="n">je32_to_cpu</span><span class="p">(</span><span class="n">ri</span><span class="o">-&gt;</span><span class="n">totlen</span><span class="p">)));</span>
	<span class="p">}</span>

	<span class="n">ic</span> <span class="o">=</span> <span class="n">jffs2_get_ino_cache</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">ino</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ic</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ic</span> <span class="o">=</span> <span class="n">jffs2_scan_make_ino_cache</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">ino</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ic</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Wheee. It worked */</span>
	<span class="n">jffs2_link_node_ref</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">jeb</span><span class="p">,</span> <span class="n">ofs</span> <span class="o">|</span> <span class="n">REF_UNCHECKED</span><span class="p">,</span> <span class="n">PAD</span><span class="p">(</span><span class="n">je32_to_cpu</span><span class="p">(</span><span class="n">ri</span><span class="o">-&gt;</span><span class="n">totlen</span><span class="p">)),</span> <span class="n">ic</span><span class="p">);</span>

	<span class="n">jffs2_dbg</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;Node is ino #%u, version %d. Range 0x%x-0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		  <span class="n">je32_to_cpu</span><span class="p">(</span><span class="n">ri</span><span class="o">-&gt;</span><span class="n">ino</span><span class="p">),</span> <span class="n">je32_to_cpu</span><span class="p">(</span><span class="n">ri</span><span class="o">-&gt;</span><span class="n">version</span><span class="p">),</span>
		  <span class="n">je32_to_cpu</span><span class="p">(</span><span class="n">ri</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">),</span>
		  <span class="n">je32_to_cpu</span><span class="p">(</span><span class="n">ri</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">)</span><span class="o">+</span><span class="n">je32_to_cpu</span><span class="p">(</span><span class="n">ri</span><span class="o">-&gt;</span><span class="n">dsize</span><span class="p">));</span>

	<span class="n">pseudo_random</span> <span class="o">+=</span> <span class="n">je32_to_cpu</span><span class="p">(</span><span class="n">ri</span><span class="o">-&gt;</span><span class="n">version</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">jffs2_sum_active</span><span class="p">())</span> <span class="p">{</span>
		<span class="n">jffs2_sum_add_inode_mem</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">ri</span><span class="p">,</span> <span class="n">ofs</span> <span class="o">-</span> <span class="n">jeb</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">jffs2_scan_dirent_node</span><span class="p">(</span><span class="k">struct</span> <span class="n">jffs2_sb_info</span> <span class="o">*</span><span class="n">c</span><span class="p">,</span> <span class="k">struct</span> <span class="n">jffs2_eraseblock</span> <span class="o">*</span><span class="n">jeb</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">jffs2_raw_dirent</span> <span class="o">*</span><span class="n">rd</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">ofs</span><span class="p">,</span> <span class="k">struct</span> <span class="n">jffs2_summary</span> <span class="o">*</span><span class="n">s</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">jffs2_full_dirent</span> <span class="o">*</span><span class="n">fd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">jffs2_inode_cache</span> <span class="o">*</span><span class="n">ic</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">checkedlen</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">crc</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">jffs2_dbg</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;%s(): Node at 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">ofs</span><span class="p">);</span>

	<span class="cm">/* We don&#39;t get here unless the node is still valid, so we don&#39;t have to</span>
<span class="cm">	   mask in the ACCURATE bit any more. */</span>
	<span class="n">crc</span> <span class="o">=</span> <span class="n">crc32</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">rd</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">rd</span><span class="p">)</span><span class="o">-</span><span class="mi">8</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">crc</span> <span class="o">!=</span> <span class="n">je32_to_cpu</span><span class="p">(</span><span class="n">rd</span><span class="o">-&gt;</span><span class="n">node_crc</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pr_notice</span><span class="p">(</span><span class="s">&quot;%s(): Node CRC failed on node at 0x%08x: Read 0x%08x, calculated 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">__func__</span><span class="p">,</span> <span class="n">ofs</span><span class="p">,</span> <span class="n">je32_to_cpu</span><span class="p">(</span><span class="n">rd</span><span class="o">-&gt;</span><span class="n">node_crc</span><span class="p">),</span> <span class="n">crc</span><span class="p">);</span>
		<span class="cm">/* We believe totlen because the CRC on the node _header_ was OK, just the node itself failed. */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">jffs2_scan_dirty_space</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">jeb</span><span class="p">,</span> <span class="n">PAD</span><span class="p">(</span><span class="n">je32_to_cpu</span><span class="p">(</span><span class="n">rd</span><span class="o">-&gt;</span><span class="n">totlen</span><span class="p">)))))</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pseudo_random</span> <span class="o">+=</span> <span class="n">je32_to_cpu</span><span class="p">(</span><span class="n">rd</span><span class="o">-&gt;</span><span class="n">version</span><span class="p">);</span>

	<span class="cm">/* Should never happen. Did. (OLPC trac #4184)*/</span>
	<span class="n">checkedlen</span> <span class="o">=</span> <span class="n">strnlen</span><span class="p">(</span><span class="n">rd</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">rd</span><span class="o">-&gt;</span><span class="n">nsize</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">checkedlen</span> <span class="o">&lt;</span> <span class="n">rd</span><span class="o">-&gt;</span><span class="n">nsize</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Dirent at %08x has zeroes in name. Truncating to %d chars</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">ofs</span><span class="p">,</span> <span class="n">checkedlen</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">fd</span> <span class="o">=</span> <span class="n">jffs2_alloc_full_dirent</span><span class="p">(</span><span class="n">checkedlen</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fd</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fd</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">rd</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">checkedlen</span><span class="p">);</span>
	<span class="n">fd</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">[</span><span class="n">checkedlen</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">crc</span> <span class="o">=</span> <span class="n">crc32</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">fd</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">rd</span><span class="o">-&gt;</span><span class="n">nsize</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">crc</span> <span class="o">!=</span> <span class="n">je32_to_cpu</span><span class="p">(</span><span class="n">rd</span><span class="o">-&gt;</span><span class="n">name_crc</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pr_notice</span><span class="p">(</span><span class="s">&quot;%s(): Name CRC failed on node at 0x%08x: Read 0x%08x, calculated 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">__func__</span><span class="p">,</span> <span class="n">ofs</span><span class="p">,</span> <span class="n">je32_to_cpu</span><span class="p">(</span><span class="n">rd</span><span class="o">-&gt;</span><span class="n">name_crc</span><span class="p">),</span> <span class="n">crc</span><span class="p">);</span>
		<span class="n">jffs2_dbg</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;Name for which CRC failed is (now) &#39;%s&#39;, ino #%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">fd</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">je32_to_cpu</span><span class="p">(</span><span class="n">rd</span><span class="o">-&gt;</span><span class="n">ino</span><span class="p">));</span>
		<span class="n">jffs2_free_full_dirent</span><span class="p">(</span><span class="n">fd</span><span class="p">);</span>
		<span class="cm">/* FIXME: Why do we believe totlen? */</span>
		<span class="cm">/* We believe totlen because the CRC on the node _header_ was OK, just the name failed. */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">jffs2_scan_dirty_space</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">jeb</span><span class="p">,</span> <span class="n">PAD</span><span class="p">(</span><span class="n">je32_to_cpu</span><span class="p">(</span><span class="n">rd</span><span class="o">-&gt;</span><span class="n">totlen</span><span class="p">)))))</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ic</span> <span class="o">=</span> <span class="n">jffs2_scan_make_ino_cache</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">je32_to_cpu</span><span class="p">(</span><span class="n">rd</span><span class="o">-&gt;</span><span class="n">pino</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ic</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">jffs2_free_full_dirent</span><span class="p">(</span><span class="n">fd</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">fd</span><span class="o">-&gt;</span><span class="n">raw</span> <span class="o">=</span> <span class="n">jffs2_link_node_ref</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">jeb</span><span class="p">,</span> <span class="n">ofs</span> <span class="o">|</span> <span class="n">dirent_node_state</span><span class="p">(</span><span class="n">rd</span><span class="p">),</span>
				      <span class="n">PAD</span><span class="p">(</span><span class="n">je32_to_cpu</span><span class="p">(</span><span class="n">rd</span><span class="o">-&gt;</span><span class="n">totlen</span><span class="p">)),</span> <span class="n">ic</span><span class="p">);</span>

	<span class="n">fd</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">fd</span><span class="o">-&gt;</span><span class="n">version</span> <span class="o">=</span> <span class="n">je32_to_cpu</span><span class="p">(</span><span class="n">rd</span><span class="o">-&gt;</span><span class="n">version</span><span class="p">);</span>
	<span class="n">fd</span><span class="o">-&gt;</span><span class="n">ino</span> <span class="o">=</span> <span class="n">je32_to_cpu</span><span class="p">(</span><span class="n">rd</span><span class="o">-&gt;</span><span class="n">ino</span><span class="p">);</span>
	<span class="n">fd</span><span class="o">-&gt;</span><span class="n">nhash</span> <span class="o">=</span> <span class="n">full_name_hash</span><span class="p">(</span><span class="n">fd</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">checkedlen</span><span class="p">);</span>
	<span class="n">fd</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">rd</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">;</span>
	<span class="n">jffs2_add_fd_to_list</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">fd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ic</span><span class="o">-&gt;</span><span class="n">scan_dents</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">jffs2_sum_active</span><span class="p">())</span> <span class="p">{</span>
		<span class="n">jffs2_sum_add_dirent_mem</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">rd</span><span class="p">,</span> <span class="n">ofs</span> <span class="o">-</span> <span class="n">jeb</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">count_list</span><span class="p">(</span><span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">l</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">uint32_t</span> <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">tmp</span><span class="p">;</span>

	<span class="n">list_for_each</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="n">l</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">count</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Note: This breaks if list_empty(head). I don&#39;t care. You</span>
<span class="cm">   might, if you copy this code and use it elsewhere :) */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">rotate_list</span><span class="p">(</span><span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">head</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">n</span> <span class="o">=</span> <span class="n">head</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>

	<span class="n">list_del</span><span class="p">(</span><span class="n">head</span><span class="p">);</span>
	<span class="k">while</span><span class="p">(</span><span class="n">count</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">n</span> <span class="o">=</span> <span class="n">n</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">list_add</span><span class="p">(</span><span class="n">head</span><span class="p">,</span> <span class="n">n</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">jffs2_rotate_lists</span><span class="p">(</span><span class="k">struct</span> <span class="n">jffs2_sb_info</span> <span class="o">*</span><span class="n">c</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">uint32_t</span> <span class="n">x</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">rotateby</span><span class="p">;</span>

	<span class="n">x</span> <span class="o">=</span> <span class="n">count_list</span><span class="p">(</span><span class="o">&amp;</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">clean_list</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rotateby</span> <span class="o">=</span> <span class="n">pseudo_random</span> <span class="o">%</span> <span class="n">x</span><span class="p">;</span>
		<span class="n">rotate_list</span><span class="p">((</span><span class="o">&amp;</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">clean_list</span><span class="p">),</span> <span class="n">rotateby</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">x</span> <span class="o">=</span> <span class="n">count_list</span><span class="p">(</span><span class="o">&amp;</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">very_dirty_list</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rotateby</span> <span class="o">=</span> <span class="n">pseudo_random</span> <span class="o">%</span> <span class="n">x</span><span class="p">;</span>
		<span class="n">rotate_list</span><span class="p">((</span><span class="o">&amp;</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">very_dirty_list</span><span class="p">),</span> <span class="n">rotateby</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">x</span> <span class="o">=</span> <span class="n">count_list</span><span class="p">(</span><span class="o">&amp;</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">dirty_list</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rotateby</span> <span class="o">=</span> <span class="n">pseudo_random</span> <span class="o">%</span> <span class="n">x</span><span class="p">;</span>
		<span class="n">rotate_list</span><span class="p">((</span><span class="o">&amp;</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">dirty_list</span><span class="p">),</span> <span class="n">rotateby</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">x</span> <span class="o">=</span> <span class="n">count_list</span><span class="p">(</span><span class="o">&amp;</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">erasable_list</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rotateby</span> <span class="o">=</span> <span class="n">pseudo_random</span> <span class="o">%</span> <span class="n">x</span><span class="p">;</span>
		<span class="n">rotate_list</span><span class="p">((</span><span class="o">&amp;</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">erasable_list</span><span class="p">),</span> <span class="n">rotateby</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">nr_erasing_blocks</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rotateby</span> <span class="o">=</span> <span class="n">pseudo_random</span> <span class="o">%</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">nr_erasing_blocks</span><span class="p">;</span>
		<span class="n">rotate_list</span><span class="p">((</span><span class="o">&amp;</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">erase_pending_list</span><span class="p">),</span> <span class="n">rotateby</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">nr_free_blocks</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rotateby</span> <span class="o">=</span> <span class="n">pseudo_random</span> <span class="o">%</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">nr_free_blocks</span><span class="p">;</span>
		<span class="n">rotate_list</span><span class="p">((</span><span class="o">&amp;</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">free_list</span><span class="p">),</span> <span class="n">rotateby</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
