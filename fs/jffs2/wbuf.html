<!DOCTYPE html>
<html><head><title>joekychen/linux » fs › jffs2 › wbuf.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>wbuf.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * JFFS2 -- Journalling Flash File System, Version 2.</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright © 2001-2007 Red Hat, Inc.</span>
<span class="cm"> * Copyright © 2004 Thomas Gleixner &lt;tglx@linutronix.de&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * Created by David Woodhouse &lt;dwmw2@infradead.org&gt;</span>
<span class="cm"> * Modified debugged and enhanced by Thomas Gleixner &lt;tglx@linutronix.de&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * For licensing information, see the file &#39;LICENCE&#39; in this directory.</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="cp">#define pr_fmt(fmt) KBUILD_MODNAME &quot;: &quot; fmt</span>

<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/mtd/mtd.h&gt;</span>
<span class="cp">#include &lt;linux/crc32.h&gt;</span>
<span class="cp">#include &lt;linux/mtd/nand.h&gt;</span>
<span class="cp">#include &lt;linux/jiffies.h&gt;</span>
<span class="cp">#include &lt;linux/sched.h&gt;</span>
<span class="cp">#include &lt;linux/writeback.h&gt;</span>

<span class="cp">#include &quot;nodelist.h&quot;</span>

<span class="cm">/* For testing write failures */</span>
<span class="cp">#undef BREAKME</span>
<span class="cp">#undef BREAKMEHEADER</span>

<span class="cp">#ifdef BREAKME</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">brokenbuf</span><span class="p">;</span>
<span class="cp">#endif</span>

<span class="cp">#define PAGE_DIV(x) ( ((unsigned long)(x) / (unsigned long)(c-&gt;wbuf_pagesize)) * (unsigned long)(c-&gt;wbuf_pagesize) )</span>
<span class="cp">#define PAGE_MOD(x) ( (unsigned long)(x) % (unsigned long)(c-&gt;wbuf_pagesize) )</span>

<span class="cm">/* max. erase failures before we mark a block bad */</span>
<span class="cp">#define MAX_ERASE_FAILURES 	2</span>

<span class="k">struct</span> <span class="n">jffs2_inodirty</span> <span class="p">{</span>
	<span class="kt">uint32_t</span> <span class="n">ino</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">jffs2_inodirty</span> <span class="o">*</span><span class="n">next</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">jffs2_inodirty</span> <span class="n">inodirty_nomem</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">jffs2_wbuf_pending_for_ino</span><span class="p">(</span><span class="k">struct</span> <span class="n">jffs2_sb_info</span> <span class="o">*</span><span class="n">c</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">ino</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">jffs2_inodirty</span> <span class="o">*</span><span class="n">this</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">wbuf_inodes</span><span class="p">;</span>

	<span class="cm">/* If a malloc failed, consider _everything_ dirty */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">this</span> <span class="o">==</span> <span class="o">&amp;</span><span class="n">inodirty_nomem</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* If ino == 0, _any_ non-GC writes mean &#39;yes&#39; */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">this</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">ino</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* Look to see if the inode in question is pending in the wbuf */</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">this</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">ino</span> <span class="o">==</span> <span class="n">ino</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">this</span> <span class="o">=</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">jffs2_clear_wbuf_ino_list</span><span class="p">(</span><span class="k">struct</span> <span class="n">jffs2_sb_info</span> <span class="o">*</span><span class="n">c</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">jffs2_inodirty</span> <span class="o">*</span><span class="n">this</span><span class="p">;</span>

	<span class="n">this</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">wbuf_inodes</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">this</span> <span class="o">!=</span> <span class="o">&amp;</span><span class="n">inodirty_nomem</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">this</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">jffs2_inodirty</span> <span class="o">*</span><span class="n">next</span> <span class="o">=</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">this</span><span class="p">);</span>
			<span class="n">this</span> <span class="o">=</span> <span class="n">next</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">wbuf_inodes</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">jffs2_wbuf_dirties_inode</span><span class="p">(</span><span class="k">struct</span> <span class="n">jffs2_sb_info</span> <span class="o">*</span><span class="n">c</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">ino</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">jffs2_inodirty</span> <span class="o">*</span><span class="n">new</span><span class="p">;</span>

	<span class="cm">/* Schedule delayed write-buffer write-out */</span>
	<span class="n">jffs2_dirty_trigger</span><span class="p">(</span><span class="n">c</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">jffs2_wbuf_pending_for_ino</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">ino</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">new</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">new</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">new</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">jffs2_dbg</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;No memory to allocate inodirty. Fallback to all considered dirty</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">jffs2_clear_wbuf_ino_list</span><span class="p">(</span><span class="n">c</span><span class="p">);</span>
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">wbuf_inodes</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">inodirty_nomem</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">new</span><span class="o">-&gt;</span><span class="n">ino</span> <span class="o">=</span> <span class="n">ino</span><span class="p">;</span>
	<span class="n">new</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">wbuf_inodes</span><span class="p">;</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">wbuf_inodes</span> <span class="o">=</span> <span class="n">new</span><span class="p">;</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">jffs2_refile_wbuf_blocks</span><span class="p">(</span><span class="k">struct</span> <span class="n">jffs2_sb_info</span> <span class="o">*</span><span class="n">c</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">this</span><span class="p">,</span> <span class="o">*</span><span class="n">next</span><span class="p">;</span>
	<span class="k">static</span> <span class="kt">int</span> <span class="n">n</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">erasable_pending_wbuf_list</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">list_for_each_safe</span><span class="p">(</span><span class="n">this</span><span class="p">,</span> <span class="n">next</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">erasable_pending_wbuf_list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">jffs2_eraseblock</span> <span class="o">*</span><span class="n">jeb</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">this</span><span class="p">,</span> <span class="k">struct</span> <span class="n">jffs2_eraseblock</span><span class="p">,</span> <span class="n">list</span><span class="p">);</span>

		<span class="n">jffs2_dbg</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;Removing eraseblock at 0x%08x from erasable_pending_wbuf_list...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">jeb</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">);</span>
		<span class="n">list_del</span><span class="p">(</span><span class="n">this</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">jiffies</span> <span class="o">+</span> <span class="p">(</span><span class="n">n</span><span class="o">++</span><span class="p">))</span> <span class="o">&amp;</span> <span class="mi">127</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Most of the time, we just erase it immediately. Otherwise we</span>
<span class="cm">			   spend ages scanning it on mount, etc. */</span>
			<span class="n">jffs2_dbg</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;...and adding to erase_pending_list</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">jeb</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">erase_pending_list</span><span class="p">);</span>
			<span class="n">c</span><span class="o">-&gt;</span><span class="n">nr_erasing_blocks</span><span class="o">++</span><span class="p">;</span>
			<span class="n">jffs2_garbage_collect_trigger</span><span class="p">(</span><span class="n">c</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* Sometimes, however, we leave it elsewhere so it doesn&#39;t get</span>
<span class="cm">			   immediately reused, and we spread the load a bit. */</span>
			<span class="n">jffs2_dbg</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;...and adding to erasable_list</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">jeb</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">erasable_list</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cp">#define REFILE_NOTEMPTY 0</span>
<span class="cp">#define REFILE_ANYWAY   1</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">jffs2_block_refile</span><span class="p">(</span><span class="k">struct</span> <span class="n">jffs2_sb_info</span> <span class="o">*</span><span class="n">c</span><span class="p">,</span> <span class="k">struct</span> <span class="n">jffs2_eraseblock</span> <span class="o">*</span><span class="n">jeb</span><span class="p">,</span> <span class="kt">int</span> <span class="n">allow_empty</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">jffs2_dbg</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;About to refile bad block at %08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">jeb</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">);</span>

	<span class="cm">/* File the existing block on the bad_used_list.... */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">nextblock</span> <span class="o">==</span> <span class="n">jeb</span><span class="p">)</span>
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">nextblock</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">else</span> <span class="cm">/* Not sure this should ever happen... need more coffee */</span>
		<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">jeb</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">jeb</span><span class="o">-&gt;</span><span class="n">first_node</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">jffs2_dbg</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;Refiling block at %08x to bad_used_list</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">jeb</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">);</span>
		<span class="n">list_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">jeb</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">bad_used_list</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">BUG_ON</span><span class="p">(</span><span class="n">allow_empty</span> <span class="o">==</span> <span class="n">REFILE_NOTEMPTY</span><span class="p">);</span>
		<span class="cm">/* It has to have had some nodes or we couldn&#39;t be here */</span>
		<span class="n">jffs2_dbg</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;Refiling block at %08x to erase_pending_list</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">jeb</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">);</span>
		<span class="n">list_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">jeb</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">erase_pending_list</span><span class="p">);</span>
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">nr_erasing_blocks</span><span class="o">++</span><span class="p">;</span>
		<span class="n">jffs2_garbage_collect_trigger</span><span class="p">(</span><span class="n">c</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">jffs2_prealloc_raw_node_refs</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">jeb</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
		<span class="kt">uint32_t</span> <span class="n">oldfree</span> <span class="o">=</span> <span class="n">jeb</span><span class="o">-&gt;</span><span class="n">free_size</span><span class="p">;</span>

		<span class="n">jffs2_link_node_ref</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">jeb</span><span class="p">,</span> 
				    <span class="p">(</span><span class="n">jeb</span><span class="o">-&gt;</span><span class="n">offset</span><span class="o">+</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">sector_size</span><span class="o">-</span><span class="n">oldfree</span><span class="p">)</span> <span class="o">|</span> <span class="n">REF_OBSOLETE</span><span class="p">,</span>
				    <span class="n">oldfree</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="cm">/* convert to wasted */</span>
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">wasted_size</span> <span class="o">+=</span> <span class="n">oldfree</span><span class="p">;</span>
		<span class="n">jeb</span><span class="o">-&gt;</span><span class="n">wasted_size</span> <span class="o">+=</span> <span class="n">oldfree</span><span class="p">;</span>
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">dirty_size</span> <span class="o">-=</span> <span class="n">oldfree</span><span class="p">;</span>
		<span class="n">jeb</span><span class="o">-&gt;</span><span class="n">dirty_size</span> <span class="o">-=</span> <span class="n">oldfree</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">jffs2_dbg_dump_block_lists_nolock</span><span class="p">(</span><span class="n">c</span><span class="p">);</span>
	<span class="n">jffs2_dbg_acct_sanity_check_nolock</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="n">jeb</span><span class="p">);</span>
	<span class="n">jffs2_dbg_acct_paranoia_check_nolock</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">jeb</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">jffs2_raw_node_ref</span> <span class="o">**</span><span class="nf">jffs2_incore_replace_raw</span><span class="p">(</span><span class="k">struct</span> <span class="n">jffs2_sb_info</span> <span class="o">*</span><span class="n">c</span><span class="p">,</span>
							    <span class="k">struct</span> <span class="n">jffs2_inode_info</span> <span class="o">*</span><span class="n">f</span><span class="p">,</span>
							    <span class="k">struct</span> <span class="n">jffs2_raw_node_ref</span> <span class="o">*</span><span class="n">raw</span><span class="p">,</span>
							    <span class="k">union</span> <span class="n">jffs2_node_union</span> <span class="o">*</span><span class="n">node</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">jffs2_node_frag</span> <span class="o">*</span><span class="n">frag</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">jffs2_full_dirent</span> <span class="o">*</span><span class="n">fd</span><span class="p">;</span>

	<span class="n">dbg_noderef</span><span class="p">(</span><span class="s">&quot;incore_replace_raw: node at %p is {%04x,%04x}</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">node</span><span class="p">,</span> <span class="n">je16_to_cpu</span><span class="p">(</span><span class="n">node</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">magic</span><span class="p">),</span> <span class="n">je16_to_cpu</span><span class="p">(</span><span class="n">node</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">nodetype</span><span class="p">));</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">je16_to_cpu</span><span class="p">(</span><span class="n">node</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">magic</span><span class="p">)</span> <span class="o">!=</span> <span class="mh">0x1985</span> <span class="o">&amp;&amp;</span>
	       <span class="n">je16_to_cpu</span><span class="p">(</span><span class="n">node</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">magic</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">je16_to_cpu</span><span class="p">(</span><span class="n">node</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">nodetype</span><span class="p">))</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">JFFS2_NODETYPE_INODE</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">metadata</span> <span class="o">&amp;&amp;</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">metadata</span><span class="o">-&gt;</span><span class="n">raw</span> <span class="o">==</span> <span class="n">raw</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dbg_noderef</span><span class="p">(</span><span class="s">&quot;Will replace -&gt;raw in f-&gt;metadata at %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">metadata</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">&amp;</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">metadata</span><span class="o">-&gt;</span><span class="n">raw</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">frag</span> <span class="o">=</span> <span class="n">jffs2_lookup_node_frag</span><span class="p">(</span><span class="o">&amp;</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">fragtree</span><span class="p">,</span> <span class="n">je32_to_cpu</span><span class="p">(</span><span class="n">node</span><span class="o">-&gt;</span><span class="n">i</span><span class="p">.</span><span class="n">offset</span><span class="p">));</span>
		<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">frag</span><span class="p">);</span>
		<span class="cm">/* Find a frag which refers to the full_dnode we want to modify */</span>
		<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">frag</span><span class="o">-&gt;</span><span class="n">node</span> <span class="o">||</span> <span class="n">frag</span><span class="o">-&gt;</span><span class="n">node</span><span class="o">-&gt;</span><span class="n">raw</span> <span class="o">!=</span> <span class="n">raw</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">frag</span> <span class="o">=</span> <span class="n">frag_next</span><span class="p">(</span><span class="n">frag</span><span class="p">);</span>
			<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">frag</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">dbg_noderef</span><span class="p">(</span><span class="s">&quot;Will replace -&gt;raw in full_dnode at %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">frag</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">&amp;</span><span class="n">frag</span><span class="o">-&gt;</span><span class="n">node</span><span class="o">-&gt;</span><span class="n">raw</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">JFFS2_NODETYPE_DIRENT</span>:
		<span class="k">for</span> <span class="p">(</span><span class="n">fd</span> <span class="o">=</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">dents</span><span class="p">;</span> <span class="n">fd</span><span class="p">;</span> <span class="n">fd</span> <span class="o">=</span> <span class="n">fd</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">fd</span><span class="o">-&gt;</span><span class="n">raw</span> <span class="o">==</span> <span class="n">raw</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">dbg_noderef</span><span class="p">(</span><span class="s">&quot;Will replace -&gt;raw in full_dirent at %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">fd</span><span class="p">);</span>
				<span class="k">return</span> <span class="o">&amp;</span><span class="n">fd</span><span class="o">-&gt;</span><span class="n">raw</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">BUG</span><span class="p">();</span>

	<span class="nl">default:</span>
		<span class="n">dbg_noderef</span><span class="p">(</span><span class="s">&quot;Don&#39;t care about replacing raw for nodetype %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">je16_to_cpu</span><span class="p">(</span><span class="n">node</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">nodetype</span><span class="p">));</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_JFFS2_FS_WBUF_VERIFY</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">jffs2_verify_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">jffs2_sb_info</span> <span class="o">*</span><span class="n">c</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span>
			      <span class="kt">uint32_t</span> <span class="n">ofs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">retlen</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">eccstr</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">mtd_read</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">mtd</span><span class="p">,</span> <span class="n">ofs</span><span class="p">,</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">wbuf_pagesize</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">retlen</span><span class="p">,</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">wbuf_verify</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&amp;&amp;</span> <span class="n">ret</span> <span class="o">!=</span> <span class="o">-</span><span class="n">EUCLEAN</span> <span class="o">&amp;&amp;</span> <span class="n">ret</span> <span class="o">!=</span> <span class="o">-</span><span class="n">EBADMSG</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_warn</span><span class="p">(</span><span class="s">&quot;%s(): Read back of page at %08x failed: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">wbuf_ofs</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">retlen</span> <span class="o">!=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">wbuf_pagesize</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_warn</span><span class="p">(</span><span class="s">&quot;%s(): Read back of page at %08x gave short read: %zd not %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span> <span class="n">ofs</span><span class="p">,</span> <span class="n">retlen</span><span class="p">,</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">wbuf_pagesize</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">memcmp</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">wbuf_verify</span><span class="p">,</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">wbuf_pagesize</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="o">-</span><span class="n">EUCLEAN</span><span class="p">)</span>
		<span class="n">eccstr</span> <span class="o">=</span> <span class="s">&quot;corrected&quot;</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="o">-</span><span class="n">EBADMSG</span><span class="p">)</span>
		<span class="n">eccstr</span> <span class="o">=</span> <span class="s">&quot;correction failed&quot;</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">eccstr</span> <span class="o">=</span> <span class="s">&quot;OK or unused&quot;</span><span class="p">;</span>

	<span class="n">pr_warn</span><span class="p">(</span><span class="s">&quot;Write verify error (ECC %s) at %08x. Wrote:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">eccstr</span><span class="p">,</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">wbuf_ofs</span><span class="p">);</span>
	<span class="n">print_hex_dump</span><span class="p">(</span><span class="n">KERN_WARNING</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="p">,</span> <span class="n">DUMP_PREFIX_OFFSET</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
		       <span class="n">c</span><span class="o">-&gt;</span><span class="n">wbuf</span><span class="p">,</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">wbuf_pagesize</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">pr_warn</span><span class="p">(</span><span class="s">&quot;Read back:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">print_hex_dump</span><span class="p">(</span><span class="n">KERN_WARNING</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="p">,</span> <span class="n">DUMP_PREFIX_OFFSET</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
		       <span class="n">c</span><span class="o">-&gt;</span><span class="n">wbuf_verify</span><span class="p">,</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">wbuf_pagesize</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#else</span>
<span class="cp">#define jffs2_verify_write(c,b,o) (0)</span>
<span class="cp">#endif</span>

<span class="cm">/* Recover from failure to write wbuf. Recover the nodes up to the</span>
<span class="cm"> * wbuf, not the one which we were starting to try to write. */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">jffs2_wbuf_recover</span><span class="p">(</span><span class="k">struct</span> <span class="n">jffs2_sb_info</span> <span class="o">*</span><span class="n">c</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">jffs2_eraseblock</span> <span class="o">*</span><span class="n">jeb</span><span class="p">,</span> <span class="o">*</span><span class="n">new_jeb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">jffs2_raw_node_ref</span> <span class="o">*</span><span class="n">raw</span><span class="p">,</span> <span class="o">*</span><span class="n">next</span><span class="p">,</span> <span class="o">*</span><span class="n">first_raw</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">retlen</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">nr_refile</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">ofs</span><span class="p">,</span> <span class="n">len</span><span class="p">;</span>

	<span class="n">jeb</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">blocks</span><span class="p">[</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">wbuf_ofs</span> <span class="o">/</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">sector_size</span><span class="p">];</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">erase_completion_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">wbuf_ofs</span> <span class="o">%</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">mtd</span><span class="o">-&gt;</span><span class="n">erasesize</span><span class="p">)</span>
		<span class="n">jffs2_block_refile</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">jeb</span><span class="p">,</span> <span class="n">REFILE_NOTEMPTY</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">jffs2_block_refile</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">jeb</span><span class="p">,</span> <span class="n">REFILE_ANYWAY</span><span class="p">);</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">erase_completion_lock</span><span class="p">);</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">ref_obsolete</span><span class="p">(</span><span class="n">jeb</span><span class="o">-&gt;</span><span class="n">last_node</span><span class="p">));</span>

	<span class="cm">/* Find the first node to be recovered, by skipping over every</span>
<span class="cm">	   node which ends before the wbuf starts, or which is obsolete. */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">next</span> <span class="o">=</span> <span class="n">raw</span> <span class="o">=</span> <span class="n">jeb</span><span class="o">-&gt;</span><span class="n">first_node</span><span class="p">;</span> <span class="n">next</span><span class="p">;</span> <span class="n">raw</span> <span class="o">=</span> <span class="n">next</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">next</span> <span class="o">=</span> <span class="n">ref_next</span><span class="p">(</span><span class="n">raw</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ref_obsolete</span><span class="p">(</span><span class="n">raw</span><span class="p">)</span> <span class="o">||</span> 
		    <span class="p">(</span><span class="n">next</span> <span class="o">&amp;&amp;</span> <span class="n">ref_offset</span><span class="p">(</span><span class="n">next</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">wbuf_ofs</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">dbg_noderef</span><span class="p">(</span><span class="s">&quot;Skipping node at 0x%08x(%d)-0x%08x which is either before 0x%08x or obsolete</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				    <span class="n">ref_offset</span><span class="p">(</span><span class="n">raw</span><span class="p">),</span> <span class="n">ref_flags</span><span class="p">(</span><span class="n">raw</span><span class="p">),</span>
				    <span class="p">(</span><span class="n">ref_offset</span><span class="p">(</span><span class="n">raw</span><span class="p">)</span> <span class="o">+</span> <span class="n">ref_totlen</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">jeb</span><span class="p">,</span> <span class="n">raw</span><span class="p">)),</span>
				    <span class="n">c</span><span class="o">-&gt;</span><span class="n">wbuf_ofs</span><span class="p">);</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">dbg_noderef</span><span class="p">(</span><span class="s">&quot;First node to be recovered is at 0x%08x(%d)-0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">ref_offset</span><span class="p">(</span><span class="n">raw</span><span class="p">),</span> <span class="n">ref_flags</span><span class="p">(</span><span class="n">raw</span><span class="p">),</span>
			    <span class="p">(</span><span class="n">ref_offset</span><span class="p">(</span><span class="n">raw</span><span class="p">)</span> <span class="o">+</span> <span class="n">ref_totlen</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">jeb</span><span class="p">,</span> <span class="n">raw</span><span class="p">)));</span>

		<span class="n">first_raw</span> <span class="o">=</span> <span class="n">raw</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">first_raw</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* All nodes were obsolete. Nothing to recover. */</span>
		<span class="n">jffs2_dbg</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;No non-obsolete nodes to be recovered. Just filing block bad</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">wbuf_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">start</span> <span class="o">=</span> <span class="n">ref_offset</span><span class="p">(</span><span class="n">first_raw</span><span class="p">);</span>
	<span class="n">end</span> <span class="o">=</span> <span class="n">ref_offset</span><span class="p">(</span><span class="n">jeb</span><span class="o">-&gt;</span><span class="n">last_node</span><span class="p">);</span>
	<span class="n">nr_refile</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* Count the number of refs which need to be copied */</span>
	<span class="k">while</span> <span class="p">((</span><span class="n">raw</span> <span class="o">=</span> <span class="n">ref_next</span><span class="p">(</span><span class="n">raw</span><span class="p">))</span> <span class="o">!=</span> <span class="n">jeb</span><span class="o">-&gt;</span><span class="n">last_node</span><span class="p">)</span>
		<span class="n">nr_refile</span><span class="o">++</span><span class="p">;</span>

	<span class="n">dbg_noderef</span><span class="p">(</span><span class="s">&quot;wbuf recover %08x-%08x (%d bytes in %d nodes)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">end</span> <span class="o">-</span> <span class="n">start</span><span class="p">,</span> <span class="n">nr_refile</span><span class="p">);</span>

	<span class="n">buf</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">start</span> <span class="o">&lt;</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">wbuf_ofs</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* First affected node was already partially written.</span>
<span class="cm">		 * Attempt to reread the old data into our buffer. */</span>

		<span class="n">buf</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">end</span> <span class="o">-</span> <span class="n">start</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">buf</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_crit</span><span class="p">(</span><span class="s">&quot;Malloc failure in wbuf recovery. Data loss ensues.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

			<span class="k">goto</span> <span class="n">read_failed</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* Do the read... */</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">mtd_read</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">mtd</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">wbuf_ofs</span> <span class="o">-</span> <span class="n">start</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">retlen</span><span class="p">,</span>
			       <span class="n">buf</span><span class="p">);</span>

		<span class="cm">/* ECC recovered ? */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">ret</span> <span class="o">==</span> <span class="o">-</span><span class="n">EUCLEAN</span> <span class="o">||</span> <span class="n">ret</span> <span class="o">==</span> <span class="o">-</span><span class="n">EBADMSG</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">retlen</span> <span class="o">==</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">wbuf_ofs</span> <span class="o">-</span> <span class="n">start</span><span class="p">))</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">||</span> <span class="n">retlen</span> <span class="o">!=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">wbuf_ofs</span> <span class="o">-</span> <span class="n">start</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_crit</span><span class="p">(</span><span class="s">&quot;Old data are already lost in wbuf recovery. Data loss ensues.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

			<span class="n">kfree</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
			<span class="n">buf</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="nl">read_failed:</span>
			<span class="n">first_raw</span> <span class="o">=</span> <span class="n">ref_next</span><span class="p">(</span><span class="n">first_raw</span><span class="p">);</span>
			<span class="n">nr_refile</span><span class="o">--</span><span class="p">;</span>
			<span class="k">while</span> <span class="p">(</span><span class="n">first_raw</span> <span class="o">&amp;&amp;</span> <span class="n">ref_obsolete</span><span class="p">(</span><span class="n">first_raw</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">first_raw</span> <span class="o">=</span> <span class="n">ref_next</span><span class="p">(</span><span class="n">first_raw</span><span class="p">);</span>
				<span class="n">nr_refile</span><span class="o">--</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="cm">/* If this was the only node to be recovered, give up */</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">first_raw</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">c</span><span class="o">-&gt;</span><span class="n">wbuf_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="k">return</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="cm">/* It wasn&#39;t. Go on and try to recover nodes complete in the wbuf */</span>
			<span class="n">start</span> <span class="o">=</span> <span class="n">ref_offset</span><span class="p">(</span><span class="n">first_raw</span><span class="p">);</span>
			<span class="n">dbg_noderef</span><span class="p">(</span><span class="s">&quot;wbuf now recover %08x-%08x (%d bytes in %d nodes)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				    <span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">end</span> <span class="o">-</span> <span class="n">start</span><span class="p">,</span> <span class="n">nr_refile</span><span class="p">);</span>

		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* Read succeeded. Copy the remaining data from the wbuf */</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">buf</span> <span class="o">+</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">wbuf_ofs</span> <span class="o">-</span> <span class="n">start</span><span class="p">),</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">wbuf</span><span class="p">,</span> <span class="n">end</span> <span class="o">-</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">wbuf_ofs</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="cm">/* OK... we&#39;re to rewrite (end-start) bytes of data from first_raw onwards.</span>
<span class="cm">	   Either &#39;buf&#39; contains the data, or we find it in the wbuf */</span>

	<span class="cm">/* ... and get an allocation of space from a shiny new block instead */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">jffs2_reserve_space_gc</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">end</span><span class="o">-</span><span class="n">start</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">len</span><span class="p">,</span> <span class="n">JFFS2_SUMMARY_NOSUM_SIZE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_warn</span><span class="p">(</span><span class="s">&quot;Failed to allocate space for wbuf recovery. Data loss ensues.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* The summary is not recovered, so it must be disabled for this erase block */</span>
	<span class="n">jffs2_sum_disable_collecting</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">summary</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">jffs2_prealloc_raw_node_refs</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">nextblock</span><span class="p">,</span> <span class="n">nr_refile</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_warn</span><span class="p">(</span><span class="s">&quot;Failed to allocate node refs for wbuf recovery. Data loss ensues.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ofs</span> <span class="o">=</span> <span class="n">write_ofs</span><span class="p">(</span><span class="n">c</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">end</span><span class="o">-</span><span class="n">start</span> <span class="o">&gt;=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">wbuf_pagesize</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Need to do another write immediately, but it&#39;s possible</span>
<span class="cm">		   that this is just because the wbuf itself is completely</span>
<span class="cm">		   full, and there&#39;s nothing earlier read back from the</span>
<span class="cm">		   flash. Hence &#39;buf&#39; isn&#39;t necessarily what we&#39;re writing</span>
<span class="cm">		   from. */</span>
		<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">rewrite_buf</span> <span class="o">=</span> <span class="n">buf</span><span class="o">?:</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">wbuf</span><span class="p">;</span>
		<span class="kt">uint32_t</span> <span class="n">towrite</span> <span class="o">=</span> <span class="p">(</span><span class="n">end</span><span class="o">-</span><span class="n">start</span><span class="p">)</span> <span class="o">-</span> <span class="p">((</span><span class="n">end</span><span class="o">-</span><span class="n">start</span><span class="p">)</span><span class="o">%</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">wbuf_pagesize</span><span class="p">);</span>

		<span class="n">jffs2_dbg</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;Write 0x%x bytes at 0x%08x in wbuf recover</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">towrite</span><span class="p">,</span> <span class="n">ofs</span><span class="p">);</span>

<span class="cp">#ifdef BREAKMEHEADER</span>
		<span class="k">static</span> <span class="kt">int</span> <span class="n">breakme</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">breakme</span><span class="o">++</span> <span class="o">==</span> <span class="mi">20</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_notice</span><span class="p">(</span><span class="s">&quot;Faking write error at 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ofs</span><span class="p">);</span>
			<span class="n">breakme</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">mtd_write</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">mtd</span><span class="p">,</span> <span class="n">ofs</span><span class="p">,</span> <span class="n">towrite</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">retlen</span><span class="p">,</span> <span class="n">brokenbuf</span><span class="p">);</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
<span class="cp">#endif</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">mtd_write</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">mtd</span><span class="p">,</span> <span class="n">ofs</span><span class="p">,</span> <span class="n">towrite</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">retlen</span><span class="p">,</span>
					<span class="n">rewrite_buf</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">||</span> <span class="n">retlen</span> <span class="o">!=</span> <span class="n">towrite</span> <span class="o">||</span> <span class="n">jffs2_verify_write</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">rewrite_buf</span><span class="p">,</span> <span class="n">ofs</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* Argh. We tried. Really we did. */</span>
			<span class="n">pr_crit</span><span class="p">(</span><span class="s">&quot;Recovery of wbuf failed due to a second write error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">retlen</span><span class="p">)</span>
				<span class="n">jffs2_add_physical_node_ref</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">ofs</span> <span class="o">|</span> <span class="n">REF_OBSOLETE</span><span class="p">,</span> <span class="n">ref_totlen</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">jeb</span><span class="p">,</span> <span class="n">first_raw</span><span class="p">),</span> <span class="nb">NULL</span><span class="p">);</span>

			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">pr_notice</span><span class="p">(</span><span class="s">&quot;Recovery of wbuf succeeded to %08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ofs</span><span class="p">);</span>

		<span class="n">c</span><span class="o">-&gt;</span><span class="n">wbuf_len</span> <span class="o">=</span> <span class="p">(</span><span class="n">end</span> <span class="o">-</span> <span class="n">start</span><span class="p">)</span> <span class="o">-</span> <span class="n">towrite</span><span class="p">;</span>
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">wbuf_ofs</span> <span class="o">=</span> <span class="n">ofs</span> <span class="o">+</span> <span class="n">towrite</span><span class="p">;</span>
		<span class="n">memmove</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">wbuf</span><span class="p">,</span> <span class="n">rewrite_buf</span> <span class="o">+</span> <span class="n">towrite</span><span class="p">,</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">wbuf_len</span><span class="p">);</span>
		<span class="cm">/* Don&#39;t muck about with c-&gt;wbuf_inodes. False positives are harmless. */</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* OK, now we&#39;re left with the dregs in whichever buffer we&#39;re using */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">buf</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">wbuf</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">end</span><span class="o">-</span><span class="n">start</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">memmove</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">wbuf</span><span class="p">,</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">wbuf</span> <span class="o">+</span> <span class="p">(</span><span class="n">start</span> <span class="o">-</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">wbuf_ofs</span><span class="p">),</span> <span class="n">end</span> <span class="o">-</span> <span class="n">start</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">wbuf_ofs</span> <span class="o">=</span> <span class="n">ofs</span><span class="p">;</span>
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">wbuf_len</span> <span class="o">=</span> <span class="n">end</span> <span class="o">-</span> <span class="n">start</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Now sort out the jffs2_raw_node_refs, moving them from the old to the next block */</span>
	<span class="n">new_jeb</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">blocks</span><span class="p">[</span><span class="n">ofs</span> <span class="o">/</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">sector_size</span><span class="p">];</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">erase_completion_lock</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">raw</span> <span class="o">=</span> <span class="n">first_raw</span><span class="p">;</span> <span class="n">raw</span> <span class="o">!=</span> <span class="n">jeb</span><span class="o">-&gt;</span><span class="n">last_node</span><span class="p">;</span> <span class="n">raw</span> <span class="o">=</span> <span class="n">ref_next</span><span class="p">(</span><span class="n">raw</span><span class="p">))</span> <span class="p">{</span>
		<span class="kt">uint32_t</span> <span class="n">rawlen</span> <span class="o">=</span> <span class="n">ref_totlen</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">jeb</span><span class="p">,</span> <span class="n">raw</span><span class="p">);</span>
		<span class="k">struct</span> <span class="n">jffs2_inode_cache</span> <span class="o">*</span><span class="n">ic</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">jffs2_raw_node_ref</span> <span class="o">*</span><span class="n">new_ref</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">jffs2_raw_node_ref</span> <span class="o">**</span><span class="n">adjust_ref</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">jffs2_inode_info</span> <span class="o">*</span><span class="n">f</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

		<span class="n">jffs2_dbg</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;Refiling block of %08x at %08x(%d) to %08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">rawlen</span><span class="p">,</span> <span class="n">ref_offset</span><span class="p">(</span><span class="n">raw</span><span class="p">),</span> <span class="n">ref_flags</span><span class="p">(</span><span class="n">raw</span><span class="p">),</span> <span class="n">ofs</span><span class="p">);</span>

		<span class="n">ic</span> <span class="o">=</span> <span class="n">jffs2_raw_ref_to_ic</span><span class="p">(</span><span class="n">raw</span><span class="p">);</span>

		<span class="cm">/* Ick. This XATTR mess should be fixed shortly... */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ic</span> <span class="o">&amp;&amp;</span> <span class="n">ic</span><span class="o">-&gt;</span><span class="n">class</span> <span class="o">==</span> <span class="n">RAWNODE_CLASS_XATTR_DATUM</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">jffs2_xattr_datum</span> <span class="o">*</span><span class="n">xd</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">ic</span><span class="p">;</span>
			<span class="n">BUG_ON</span><span class="p">(</span><span class="n">xd</span><span class="o">-&gt;</span><span class="n">node</span> <span class="o">!=</span> <span class="n">raw</span><span class="p">);</span>
			<span class="n">adjust_ref</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">xd</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">;</span>
			<span class="n">raw</span><span class="o">-&gt;</span><span class="n">next_in_ino</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="n">ic</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ic</span> <span class="o">&amp;&amp;</span> <span class="n">ic</span><span class="o">-&gt;</span><span class="n">class</span> <span class="o">==</span> <span class="n">RAWNODE_CLASS_XATTR_REF</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">jffs2_xattr_datum</span> <span class="o">*</span><span class="n">xr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">ic</span><span class="p">;</span>
			<span class="n">BUG_ON</span><span class="p">(</span><span class="n">xr</span><span class="o">-&gt;</span><span class="n">node</span> <span class="o">!=</span> <span class="n">raw</span><span class="p">);</span>
			<span class="n">adjust_ref</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">xr</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">;</span>
			<span class="n">raw</span><span class="o">-&gt;</span><span class="n">next_in_ino</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="n">ic</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ic</span> <span class="o">&amp;&amp;</span> <span class="n">ic</span><span class="o">-&gt;</span><span class="n">class</span> <span class="o">==</span> <span class="n">RAWNODE_CLASS_INODE_CACHE</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">jffs2_raw_node_ref</span> <span class="o">**</span><span class="n">p</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ic</span><span class="o">-&gt;</span><span class="n">nodes</span><span class="p">;</span>

			<span class="cm">/* Remove the old node from the per-inode list */</span>
			<span class="k">while</span> <span class="p">(</span><span class="o">*</span><span class="n">p</span> <span class="o">&amp;&amp;</span> <span class="o">*</span><span class="n">p</span> <span class="o">!=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">ic</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">p</span> <span class="o">==</span> <span class="n">raw</span><span class="p">)</span> <span class="p">{</span>
					<span class="p">(</span><span class="o">*</span><span class="n">p</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="n">raw</span><span class="o">-&gt;</span><span class="n">next_in_ino</span><span class="p">);</span>
					<span class="n">raw</span><span class="o">-&gt;</span><span class="n">next_in_ino</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="n">p</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">((</span><span class="o">*</span><span class="n">p</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">next_in_ino</span><span class="p">);</span>
			<span class="p">}</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">ic</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">INO_STATE_PRESENT</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">ref_obsolete</span><span class="p">(</span><span class="n">raw</span><span class="p">))</span> <span class="p">{</span>
				<span class="cm">/* If it&#39;s an in-core inode, then we have to adjust any</span>
<span class="cm">				   full_dirent or full_dnode structure to point to the</span>
<span class="cm">				   new version instead of the old */</span>
				<span class="n">f</span> <span class="o">=</span> <span class="n">jffs2_gc_fetch_inode</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">ic</span><span class="o">-&gt;</span><span class="n">ino</span><span class="p">,</span> <span class="o">!</span><span class="n">ic</span><span class="o">-&gt;</span><span class="n">pino_nlink</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">f</span><span class="p">))</span> <span class="p">{</span>
					<span class="cm">/* Should never happen; it _must_ be present */</span>
					<span class="n">JFFS2_ERROR</span><span class="p">(</span><span class="s">&quot;Failed to iget() ino #%u, err %ld</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						    <span class="n">ic</span><span class="o">-&gt;</span><span class="n">ino</span><span class="p">,</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">f</span><span class="p">));</span>
					<span class="n">BUG</span><span class="p">();</span>
				<span class="p">}</span>
				<span class="cm">/* We don&#39;t lock f-&gt;sem. There&#39;s a number of ways we could</span>
<span class="cm">				   end up in here with it already being locked, and nobody&#39;s</span>
<span class="cm">				   going to modify it on us anyway because we hold the</span>
<span class="cm">				   alloc_sem. We&#39;re only changing one -&gt;raw pointer too,</span>
<span class="cm">				   which we can get away with without upsetting readers. */</span>
				<span class="n">adjust_ref</span> <span class="o">=</span> <span class="n">jffs2_incore_replace_raw</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">raw</span><span class="p">,</span>
								      <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)(</span><span class="n">buf</span><span class="o">?:</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">wbuf</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">ref_offset</span><span class="p">(</span><span class="n">raw</span><span class="p">)</span> <span class="o">-</span> <span class="n">start</span><span class="p">));</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">ic</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">!=</span> <span class="n">INO_STATE_PRESENT</span> <span class="o">&amp;&amp;</span>
					    <span class="n">ic</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">!=</span> <span class="n">INO_STATE_CHECKEDABSENT</span> <span class="o">&amp;&amp;</span>
					    <span class="n">ic</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">!=</span> <span class="n">INO_STATE_GC</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">JFFS2_ERROR</span><span class="p">(</span><span class="s">&quot;Inode #%u is in strange state %d!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ic</span><span class="o">-&gt;</span><span class="n">ino</span><span class="p">,</span> <span class="n">ic</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">);</span>
				<span class="n">BUG</span><span class="p">();</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="n">new_ref</span> <span class="o">=</span> <span class="n">jffs2_link_node_ref</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">new_jeb</span><span class="p">,</span> <span class="n">ofs</span> <span class="o">|</span> <span class="n">ref_flags</span><span class="p">(</span><span class="n">raw</span><span class="p">),</span> <span class="n">rawlen</span><span class="p">,</span> <span class="n">ic</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">adjust_ref</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">BUG_ON</span><span class="p">(</span><span class="o">*</span><span class="n">adjust_ref</span> <span class="o">!=</span> <span class="n">raw</span><span class="p">);</span>
			<span class="o">*</span><span class="n">adjust_ref</span> <span class="o">=</span> <span class="n">new_ref</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">f</span><span class="p">)</span>
			<span class="n">jffs2_gc_release_inode</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">f</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ref_obsolete</span><span class="p">(</span><span class="n">raw</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">jeb</span><span class="o">-&gt;</span><span class="n">dirty_size</span> <span class="o">+=</span> <span class="n">rawlen</span><span class="p">;</span>
			<span class="n">jeb</span><span class="o">-&gt;</span><span class="n">used_size</span>  <span class="o">-=</span> <span class="n">rawlen</span><span class="p">;</span>
			<span class="n">c</span><span class="o">-&gt;</span><span class="n">dirty_size</span> <span class="o">+=</span> <span class="n">rawlen</span><span class="p">;</span>
			<span class="n">c</span><span class="o">-&gt;</span><span class="n">used_size</span> <span class="o">-=</span> <span class="n">rawlen</span><span class="p">;</span>
			<span class="n">raw</span><span class="o">-&gt;</span><span class="n">flash_offset</span> <span class="o">=</span> <span class="n">ref_offset</span><span class="p">(</span><span class="n">raw</span><span class="p">)</span> <span class="o">|</span> <span class="n">REF_OBSOLETE</span><span class="p">;</span>
			<span class="n">BUG_ON</span><span class="p">(</span><span class="n">raw</span><span class="o">-&gt;</span><span class="n">next_in_ino</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">ofs</span> <span class="o">+=</span> <span class="n">rawlen</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>

	<span class="cm">/* Fix up the original jeb now it&#39;s on the bad_list */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">first_raw</span> <span class="o">==</span> <span class="n">jeb</span><span class="o">-&gt;</span><span class="n">first_node</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">jffs2_dbg</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;Failing block at %08x is now empty. Moving to erase_pending_list</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">jeb</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">);</span>
		<span class="n">list_move</span><span class="p">(</span><span class="o">&amp;</span><span class="n">jeb</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">erase_pending_list</span><span class="p">);</span>
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">nr_erasing_blocks</span><span class="o">++</span><span class="p">;</span>
		<span class="n">jffs2_garbage_collect_trigger</span><span class="p">(</span><span class="n">c</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">jffs2_dbg_acct_sanity_check_nolock</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">jeb</span><span class="p">);</span>
	<span class="n">jffs2_dbg_acct_paranoia_check_nolock</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">jeb</span><span class="p">);</span>

	<span class="n">jffs2_dbg_acct_sanity_check_nolock</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">new_jeb</span><span class="p">);</span>
	<span class="n">jffs2_dbg_acct_paranoia_check_nolock</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">new_jeb</span><span class="p">);</span>

	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">erase_completion_lock</span><span class="p">);</span>

	<span class="n">jffs2_dbg</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;wbuf recovery completed OK. wbuf_ofs 0x%08x, len 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		  <span class="n">c</span><span class="o">-&gt;</span><span class="n">wbuf_ofs</span><span class="p">,</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">wbuf_len</span><span class="p">);</span>

<span class="p">}</span>

<span class="cm">/* Meaning of pad argument:</span>
<span class="cm">   0: Do not pad. Probably pointless - we only ever use this when we can&#39;t pad anyway.</span>
<span class="cm">   1: Pad, do not adjust nextblock free_size</span>
<span class="cm">   2: Pad, adjust nextblock free_size</span>
<span class="cm">*/</span>
<span class="cp">#define NOPAD		0</span>
<span class="cp">#define PAD_NOACCOUNT	1</span>
<span class="cp">#define PAD_ACCOUNTING	2</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">__jffs2_flush_wbuf</span><span class="p">(</span><span class="k">struct</span> <span class="n">jffs2_sb_info</span> <span class="o">*</span><span class="n">c</span><span class="p">,</span> <span class="kt">int</span> <span class="n">pad</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">jffs2_eraseblock</span> <span class="o">*</span><span class="n">wbuf_jeb</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">retlen</span><span class="p">;</span>

	<span class="cm">/* Nothing to do if not write-buffering the flash. In particular, we shouldn&#39;t</span>
<span class="cm">	   del_timer() the timer we never initialised. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">jffs2_is_writebuffered</span><span class="p">(</span><span class="n">c</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mutex_is_locked</span><span class="p">(</span><span class="o">&amp;</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">alloc_sem</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pr_crit</span><span class="p">(</span><span class="s">&quot;jffs2_flush_wbuf() called with alloc_sem not locked!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">BUG</span><span class="p">();</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">wbuf_len</span><span class="p">)</span>	<span class="cm">/* already checked c-&gt;wbuf above */</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">wbuf_jeb</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">blocks</span><span class="p">[</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">wbuf_ofs</span> <span class="o">/</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">sector_size</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">jffs2_prealloc_raw_node_refs</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">wbuf_jeb</span><span class="p">,</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">nextblock</span><span class="o">-&gt;</span><span class="n">allocated_refs</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="cm">/* claim remaining space on the page</span>
<span class="cm">	   this happens, if we have a change to a new block,</span>
<span class="cm">	   or if fsync forces us to flush the writebuffer.</span>
<span class="cm">	   if we have a switch to next page, we will not have</span>
<span class="cm">	   enough remaining space for this.</span>
<span class="cm">	*/</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pad</span> <span class="p">)</span> <span class="p">{</span>
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">wbuf_len</span> <span class="o">=</span> <span class="n">PAD</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">wbuf_len</span><span class="p">);</span>

		<span class="cm">/* Pad with JFFS2_DIRTY_BITMASK initially.  this helps out ECC&#39;d NOR</span>
<span class="cm">		   with 8 byte page size */</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">wbuf</span> <span class="o">+</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">wbuf_len</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">wbuf_pagesize</span> <span class="o">-</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">wbuf_len</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">wbuf_len</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">jffs2_unknown_node</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">wbuf_pagesize</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">jffs2_unknown_node</span> <span class="o">*</span><span class="n">padnode</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">wbuf</span> <span class="o">+</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">wbuf_len</span><span class="p">);</span>
			<span class="n">padnode</span><span class="o">-&gt;</span><span class="n">magic</span> <span class="o">=</span> <span class="n">cpu_to_je16</span><span class="p">(</span><span class="n">JFFS2_MAGIC_BITMASK</span><span class="p">);</span>
			<span class="n">padnode</span><span class="o">-&gt;</span><span class="n">nodetype</span> <span class="o">=</span> <span class="n">cpu_to_je16</span><span class="p">(</span><span class="n">JFFS2_NODETYPE_PADDING</span><span class="p">);</span>
			<span class="n">padnode</span><span class="o">-&gt;</span><span class="n">totlen</span> <span class="o">=</span> <span class="n">cpu_to_je32</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">wbuf_pagesize</span> <span class="o">-</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">wbuf_len</span><span class="p">);</span>
			<span class="n">padnode</span><span class="o">-&gt;</span><span class="n">hdr_crc</span> <span class="o">=</span> <span class="n">cpu_to_je32</span><span class="p">(</span><span class="n">crc32</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">padnode</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">padnode</span><span class="p">)</span><span class="o">-</span><span class="mi">4</span><span class="p">));</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="cm">/* else jffs2_flash_writev has actually filled in the rest of the</span>
<span class="cm">	   buffer for us, and will deal with the node refs etc. later. */</span>

<span class="cp">#ifdef BREAKME</span>
	<span class="k">static</span> <span class="kt">int</span> <span class="n">breakme</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">breakme</span><span class="o">++</span> <span class="o">==</span> <span class="mi">20</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_notice</span><span class="p">(</span><span class="s">&quot;Faking write error at 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">wbuf_ofs</span><span class="p">);</span>
		<span class="n">breakme</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">mtd_write</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">mtd</span><span class="p">,</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">wbuf_ofs</span><span class="p">,</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">wbuf_pagesize</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">retlen</span><span class="p">,</span>
			  <span class="n">brokenbuf</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
<span class="cp">#endif</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">mtd_write</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">mtd</span><span class="p">,</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">wbuf_ofs</span><span class="p">,</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">wbuf_pagesize</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="n">retlen</span><span class="p">,</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">wbuf</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_warn</span><span class="p">(</span><span class="s">&quot;jffs2_flush_wbuf(): Write failed with %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">wfail</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">retlen</span> <span class="o">!=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">wbuf_pagesize</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_warn</span><span class="p">(</span><span class="s">&quot;jffs2_flush_wbuf(): Write was short: %zd instead of %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">retlen</span><span class="p">,</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">wbuf_pagesize</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">wfail</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">ret</span> <span class="o">=</span> <span class="n">jffs2_verify_write</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">wbuf</span><span class="p">,</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">wbuf_ofs</span><span class="p">)))</span> <span class="p">{</span>
	<span class="nl">wfail:</span>
		<span class="n">jffs2_wbuf_recover</span><span class="p">(</span><span class="n">c</span><span class="p">);</span>

		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Adjust free size of the block if we padded. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pad</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">uint32_t</span> <span class="n">waste</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">wbuf_pagesize</span> <span class="o">-</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">wbuf_len</span><span class="p">;</span>

		<span class="n">jffs2_dbg</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;jffs2_flush_wbuf() adjusting free_size of %sblock at %08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="p">(</span><span class="n">wbuf_jeb</span> <span class="o">==</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">nextblock</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;next&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
			  <span class="n">wbuf_jeb</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">);</span>

		<span class="cm">/* wbuf_pagesize - wbuf_len is the amount of space that&#39;s to be</span>
<span class="cm">		   padded. If there is less free space in the block than that,</span>
<span class="cm">		   something screwed up */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">wbuf_jeb</span><span class="o">-&gt;</span><span class="n">free_size</span> <span class="o">&lt;</span> <span class="n">waste</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_crit</span><span class="p">(</span><span class="s">&quot;jffs2_flush_wbuf(): Accounting error. wbuf at 0x%08x has 0x%03x bytes, 0x%03x left.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">c</span><span class="o">-&gt;</span><span class="n">wbuf_ofs</span><span class="p">,</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">wbuf_len</span><span class="p">,</span> <span class="n">waste</span><span class="p">);</span>
			<span class="n">pr_crit</span><span class="p">(</span><span class="s">&quot;jffs2_flush_wbuf(): But free_size for block at 0x%08x is only 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">wbuf_jeb</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">,</span> <span class="n">wbuf_jeb</span><span class="o">-&gt;</span><span class="n">free_size</span><span class="p">);</span>
			<span class="n">BUG</span><span class="p">();</span>
		<span class="p">}</span>

		<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">erase_completion_lock</span><span class="p">);</span>

		<span class="n">jffs2_link_node_ref</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">wbuf_jeb</span><span class="p">,</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">wbuf_ofs</span> <span class="o">+</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">wbuf_len</span><span class="p">)</span> <span class="o">|</span> <span class="n">REF_OBSOLETE</span><span class="p">,</span> <span class="n">waste</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="cm">/* FIXME: that made it count as dirty. Convert to wasted */</span>
		<span class="n">wbuf_jeb</span><span class="o">-&gt;</span><span class="n">dirty_size</span> <span class="o">-=</span> <span class="n">waste</span><span class="p">;</span>
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">dirty_size</span> <span class="o">-=</span> <span class="n">waste</span><span class="p">;</span>
		<span class="n">wbuf_jeb</span><span class="o">-&gt;</span><span class="n">wasted_size</span> <span class="o">+=</span> <span class="n">waste</span><span class="p">;</span>
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">wasted_size</span> <span class="o">+=</span> <span class="n">waste</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">erase_completion_lock</span><span class="p">);</span>

	<span class="cm">/* Stick any now-obsoleted blocks on the erase_pending_list */</span>
	<span class="n">jffs2_refile_wbuf_blocks</span><span class="p">(</span><span class="n">c</span><span class="p">);</span>
	<span class="n">jffs2_clear_wbuf_ino_list</span><span class="p">(</span><span class="n">c</span><span class="p">);</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">erase_completion_lock</span><span class="p">);</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">wbuf</span><span class="p">,</span><span class="mh">0xff</span><span class="p">,</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">wbuf_pagesize</span><span class="p">);</span>
	<span class="cm">/* adjust write buffer offset, else we get a non contiguous write bug */</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">wbuf_ofs</span> <span class="o">+=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">wbuf_pagesize</span><span class="p">;</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">wbuf_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Trigger garbage collection to flush the write-buffer.</span>
<span class="cm">   If ino arg is zero, do it if _any_ real (i.e. not GC) writes are</span>
<span class="cm">   outstanding. If ino arg non-zero, do it only if a write for the</span>
<span class="cm">   given inode is outstanding. */</span>
<span class="kt">int</span> <span class="nf">jffs2_flush_wbuf_gc</span><span class="p">(</span><span class="k">struct</span> <span class="n">jffs2_sb_info</span> <span class="o">*</span><span class="n">c</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">ino</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">uint32_t</span> <span class="n">old_wbuf_ofs</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">old_wbuf_len</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">jffs2_dbg</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;jffs2_flush_wbuf_gc() called for ino #%u...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ino</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">wbuf</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">alloc_sem</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">jffs2_wbuf_pending_for_ino</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">ino</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">jffs2_dbg</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;Ino #%d not pending in wbuf. Returning</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ino</span><span class="p">);</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">alloc_sem</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">old_wbuf_ofs</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">wbuf_ofs</span><span class="p">;</span>
	<span class="n">old_wbuf_len</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">wbuf_len</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">unchecked_size</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* GC won&#39;t make any progress for a while */</span>
		<span class="n">jffs2_dbg</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;%s(): padding. Not finished checking</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">__func__</span><span class="p">);</span>
		<span class="n">down_write</span><span class="p">(</span><span class="o">&amp;</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">wbuf_sem</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">__jffs2_flush_wbuf</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">PAD_ACCOUNTING</span><span class="p">);</span>
		<span class="cm">/* retry flushing wbuf in case jffs2_wbuf_recover</span>
<span class="cm">		   left some data in the wbuf */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">__jffs2_flush_wbuf</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">PAD_ACCOUNTING</span><span class="p">);</span>
		<span class="n">up_write</span><span class="p">(</span><span class="o">&amp;</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">wbuf_sem</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">while</span> <span class="p">(</span><span class="n">old_wbuf_len</span> <span class="o">&amp;&amp;</span>
		      <span class="n">old_wbuf_ofs</span> <span class="o">==</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">wbuf_ofs</span><span class="p">)</span> <span class="p">{</span>

		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">alloc_sem</span><span class="p">);</span>

		<span class="n">jffs2_dbg</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;%s(): calls gc pass</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">jffs2_garbage_collect_pass</span><span class="p">(</span><span class="n">c</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* GC failed. Flush it with padding instead */</span>
			<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">alloc_sem</span><span class="p">);</span>
			<span class="n">down_write</span><span class="p">(</span><span class="o">&amp;</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">wbuf_sem</span><span class="p">);</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">__jffs2_flush_wbuf</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">PAD_ACCOUNTING</span><span class="p">);</span>
			<span class="cm">/* retry flushing wbuf in case jffs2_wbuf_recover</span>
<span class="cm">			   left some data in the wbuf */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
				<span class="n">ret</span> <span class="o">=</span> <span class="n">__jffs2_flush_wbuf</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">PAD_ACCOUNTING</span><span class="p">);</span>
			<span class="n">up_write</span><span class="p">(</span><span class="o">&amp;</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">wbuf_sem</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">alloc_sem</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">jffs2_dbg</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;%s(): ends...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">alloc_sem</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Pad write-buffer to end and write it, wasting space. */</span>
<span class="kt">int</span> <span class="nf">jffs2_flush_wbuf_pad</span><span class="p">(</span><span class="k">struct</span> <span class="n">jffs2_sb_info</span> <span class="o">*</span><span class="n">c</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">wbuf</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">down_write</span><span class="p">(</span><span class="o">&amp;</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">wbuf_sem</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">__jffs2_flush_wbuf</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">PAD_NOACCOUNT</span><span class="p">);</span>
	<span class="cm">/* retry - maybe wbuf recover left some data in wbuf. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">__jffs2_flush_wbuf</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">PAD_NOACCOUNT</span><span class="p">);</span>
	<span class="n">up_write</span><span class="p">(</span><span class="o">&amp;</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">wbuf_sem</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">size_t</span> <span class="nf">jffs2_fill_wbuf</span><span class="p">(</span><span class="k">struct</span> <span class="n">jffs2_sb_info</span> <span class="o">*</span><span class="n">c</span><span class="p">,</span> <span class="k">const</span> <span class="kt">uint8_t</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span>
			      <span class="kt">size_t</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">wbuf_len</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">wbuf_pagesize</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">wbuf_pagesize</span> <span class="o">-</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">wbuf_len</span><span class="p">))</span>
		<span class="n">len</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">wbuf_pagesize</span> <span class="o">-</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">wbuf_len</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">wbuf</span> <span class="o">+</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">wbuf_len</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">wbuf_len</span> <span class="o">+=</span> <span class="p">(</span><span class="kt">uint32_t</span><span class="p">)</span> <span class="n">len</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">len</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">jffs2_flash_writev</span><span class="p">(</span><span class="k">struct</span> <span class="n">jffs2_sb_info</span> <span class="o">*</span><span class="n">c</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">kvec</span> <span class="o">*</span><span class="n">invecs</span><span class="p">,</span>
		       <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">count</span><span class="p">,</span> <span class="n">loff_t</span> <span class="n">to</span><span class="p">,</span> <span class="kt">size_t</span> <span class="o">*</span><span class="n">retlen</span><span class="p">,</span>
		       <span class="kt">uint32_t</span> <span class="n">ino</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">jffs2_eraseblock</span> <span class="o">*</span><span class="n">jeb</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">wbuf_retlen</span><span class="p">,</span> <span class="n">donelen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">outvec_to</span> <span class="o">=</span> <span class="n">to</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">,</span> <span class="n">invec</span><span class="p">;</span>

	<span class="cm">/* If not writebuffered flash, don&#39;t bother */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">jffs2_is_writebuffered</span><span class="p">(</span><span class="n">c</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">jffs2_flash_direct_writev</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">invecs</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">to</span><span class="p">,</span> <span class="n">retlen</span><span class="p">);</span>

	<span class="n">down_write</span><span class="p">(</span><span class="o">&amp;</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">wbuf_sem</span><span class="p">);</span>

	<span class="cm">/* If wbuf_ofs is not initialized, set it to target address */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">wbuf_ofs</span> <span class="o">==</span> <span class="mh">0xFFFFFFFF</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">wbuf_ofs</span> <span class="o">=</span> <span class="n">PAGE_DIV</span><span class="p">(</span><span class="n">to</span><span class="p">);</span>
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">wbuf_len</span> <span class="o">=</span> <span class="n">PAGE_MOD</span><span class="p">(</span><span class="n">to</span><span class="p">);</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">wbuf</span><span class="p">,</span><span class="mh">0xff</span><span class="p">,</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">wbuf_pagesize</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Sanity checks on target address.  It&#39;s permitted to write</span>
<span class="cm">	 * at PAD(c-&gt;wbuf_len+c-&gt;wbuf_ofs), and it&#39;s permitted to</span>
<span class="cm">	 * write at the beginning of a new erase block. Anything else,</span>
<span class="cm">	 * and you die.  New block starts at xxx000c (0-b = block</span>
<span class="cm">	 * header)</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">SECTOR_ADDR</span><span class="p">(</span><span class="n">to</span><span class="p">)</span> <span class="o">!=</span> <span class="n">SECTOR_ADDR</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">wbuf_ofs</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* It&#39;s a write to a new block */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">wbuf_len</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">jffs2_dbg</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;%s(): to 0x%lx causes flush of wbuf at 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				  <span class="n">__func__</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">to</span><span class="p">,</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">wbuf_ofs</span><span class="p">);</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">__jffs2_flush_wbuf</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">PAD_NOACCOUNT</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">outerr</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* set pointer to new block */</span>
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">wbuf_ofs</span> <span class="o">=</span> <span class="n">PAGE_DIV</span><span class="p">(</span><span class="n">to</span><span class="p">);</span>
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">wbuf_len</span> <span class="o">=</span> <span class="n">PAGE_MOD</span><span class="p">(</span><span class="n">to</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">to</span> <span class="o">!=</span> <span class="n">PAD</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">wbuf_ofs</span> <span class="o">+</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">wbuf_len</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* We&#39;re not writing immediately after the writebuffer. Bad. */</span>
		<span class="n">pr_crit</span><span class="p">(</span><span class="s">&quot;%s(): Non-contiguous write to %08lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">to</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">wbuf_len</span><span class="p">)</span>
			<span class="n">pr_crit</span><span class="p">(</span><span class="s">&quot;wbuf was previously %08x-%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">c</span><span class="o">-&gt;</span><span class="n">wbuf_ofs</span><span class="p">,</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">wbuf_ofs</span> <span class="o">+</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">wbuf_len</span><span class="p">);</span>
		<span class="n">BUG</span><span class="p">();</span>
	<span class="p">}</span>

	<span class="cm">/* adjust alignment offset */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">wbuf_len</span> <span class="o">!=</span> <span class="n">PAGE_MOD</span><span class="p">(</span><span class="n">to</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">wbuf_len</span> <span class="o">=</span> <span class="n">PAGE_MOD</span><span class="p">(</span><span class="n">to</span><span class="p">);</span>
		<span class="cm">/* take care of alignment to next page */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">wbuf_len</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">c</span><span class="o">-&gt;</span><span class="n">wbuf_len</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">wbuf_pagesize</span><span class="p">;</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">__jffs2_flush_wbuf</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">NOPAD</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">outerr</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">invec</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">invec</span> <span class="o">&lt;</span> <span class="n">count</span><span class="p">;</span> <span class="n">invec</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">vlen</span> <span class="o">=</span> <span class="n">invecs</span><span class="p">[</span><span class="n">invec</span><span class="p">].</span><span class="n">iov_len</span><span class="p">;</span>
		<span class="kt">uint8_t</span> <span class="o">*</span><span class="n">v</span> <span class="o">=</span> <span class="n">invecs</span><span class="p">[</span><span class="n">invec</span><span class="p">].</span><span class="n">iov_base</span><span class="p">;</span>

		<span class="n">wbuf_retlen</span> <span class="o">=</span> <span class="n">jffs2_fill_wbuf</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">vlen</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">wbuf_len</span> <span class="o">==</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">wbuf_pagesize</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">__jffs2_flush_wbuf</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">NOPAD</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">outerr</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">vlen</span> <span class="o">-=</span> <span class="n">wbuf_retlen</span><span class="p">;</span>
		<span class="n">outvec_to</span> <span class="o">+=</span> <span class="n">wbuf_retlen</span><span class="p">;</span>
		<span class="n">donelen</span> <span class="o">+=</span> <span class="n">wbuf_retlen</span><span class="p">;</span>
		<span class="n">v</span> <span class="o">+=</span> <span class="n">wbuf_retlen</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">vlen</span> <span class="o">&gt;=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">wbuf_pagesize</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">mtd_write</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">mtd</span><span class="p">,</span> <span class="n">outvec_to</span><span class="p">,</span> <span class="n">PAGE_DIV</span><span class="p">(</span><span class="n">vlen</span><span class="p">),</span>
					<span class="o">&amp;</span><span class="n">wbuf_retlen</span><span class="p">,</span> <span class="n">v</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">wbuf_retlen</span> <span class="o">!=</span> <span class="n">PAGE_DIV</span><span class="p">(</span><span class="n">vlen</span><span class="p">))</span>
				<span class="k">goto</span> <span class="n">outfile</span><span class="p">;</span>

			<span class="n">vlen</span> <span class="o">-=</span> <span class="n">wbuf_retlen</span><span class="p">;</span>
			<span class="n">outvec_to</span> <span class="o">+=</span> <span class="n">wbuf_retlen</span><span class="p">;</span>
			<span class="n">c</span><span class="o">-&gt;</span><span class="n">wbuf_ofs</span> <span class="o">=</span> <span class="n">outvec_to</span><span class="p">;</span>
			<span class="n">donelen</span> <span class="o">+=</span> <span class="n">wbuf_retlen</span><span class="p">;</span>
			<span class="n">v</span> <span class="o">+=</span> <span class="n">wbuf_retlen</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">wbuf_retlen</span> <span class="o">=</span> <span class="n">jffs2_fill_wbuf</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">vlen</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">wbuf_len</span> <span class="o">==</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">wbuf_pagesize</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">__jffs2_flush_wbuf</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">NOPAD</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">outerr</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">outvec_to</span> <span class="o">+=</span> <span class="n">wbuf_retlen</span><span class="p">;</span>
		<span class="n">donelen</span> <span class="o">+=</span> <span class="n">wbuf_retlen</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * If there&#39;s a remainder in the wbuf and it&#39;s a non-GC write,</span>
<span class="cm">	 * remember that the wbuf affects this ino</span>
<span class="cm">	 */</span>
	<span class="o">*</span><span class="n">retlen</span> <span class="o">=</span> <span class="n">donelen</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">jffs2_sum_active</span><span class="p">())</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">res</span> <span class="o">=</span> <span class="n">jffs2_sum_add_kvec</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">invecs</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="p">(</span><span class="kt">uint32_t</span><span class="p">)</span> <span class="n">to</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">wbuf_len</span> <span class="o">&amp;&amp;</span> <span class="n">ino</span><span class="p">)</span>
		<span class="n">jffs2_wbuf_dirties_inode</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">ino</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">up_write</span><span class="p">(</span><span class="o">&amp;</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">wbuf_sem</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

<span class="nl">outfile:</span>
	<span class="cm">/*</span>
<span class="cm">	 * At this point we have no problem, c-&gt;wbuf is empty. However</span>
<span class="cm">	 * refile nextblock to avoid writing again to same address.</span>
<span class="cm">	 */</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">erase_completion_lock</span><span class="p">);</span>

	<span class="n">jeb</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">blocks</span><span class="p">[</span><span class="n">outvec_to</span> <span class="o">/</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">sector_size</span><span class="p">];</span>
	<span class="n">jffs2_block_refile</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">jeb</span><span class="p">,</span> <span class="n">REFILE_ANYWAY</span><span class="p">);</span>

	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">erase_completion_lock</span><span class="p">);</span>

<span class="nl">outerr:</span>
	<span class="o">*</span><span class="n">retlen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">up_write</span><span class="p">(</span><span class="o">&amp;</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">wbuf_sem</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *	This is the entry for flash write.</span>
<span class="cm"> *	Check, if we work on NAND FLASH, if so build an kvec and write it via vritev</span>
<span class="cm">*/</span>
<span class="kt">int</span> <span class="nf">jffs2_flash_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">jffs2_sb_info</span> <span class="o">*</span><span class="n">c</span><span class="p">,</span> <span class="n">loff_t</span> <span class="n">ofs</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">len</span><span class="p">,</span>
		      <span class="kt">size_t</span> <span class="o">*</span><span class="n">retlen</span><span class="p">,</span> <span class="k">const</span> <span class="n">u_char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">kvec</span> <span class="n">vecs</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">jffs2_is_writebuffered</span><span class="p">(</span><span class="n">c</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">jffs2_flash_direct_write</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">ofs</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">retlen</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>

	<span class="n">vecs</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">iov_base</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">buf</span><span class="p">;</span>
	<span class="n">vecs</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">iov_len</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">jffs2_flash_writev</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">vecs</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ofs</span><span class="p">,</span> <span class="n">retlen</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">	Handle readback from writebuffer and ECC failure return</span>
<span class="cm">*/</span>
<span class="kt">int</span> <span class="nf">jffs2_flash_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">jffs2_sb_info</span> <span class="o">*</span><span class="n">c</span><span class="p">,</span> <span class="n">loff_t</span> <span class="n">ofs</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">len</span><span class="p">,</span> <span class="kt">size_t</span> <span class="o">*</span><span class="n">retlen</span><span class="p">,</span> <span class="n">u_char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">loff_t</span>	<span class="n">orbf</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">owbf</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">lwbf</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span>	<span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">jffs2_is_writebuffered</span><span class="p">(</span><span class="n">c</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">mtd_read</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">mtd</span><span class="p">,</span> <span class="n">ofs</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">retlen</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>

	<span class="cm">/* Read flash */</span>
	<span class="n">down_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">wbuf_sem</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">mtd_read</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">mtd</span><span class="p">,</span> <span class="n">ofs</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">retlen</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="o">-</span><span class="n">EBADMSG</span> <span class="o">||</span> <span class="n">ret</span> <span class="o">==</span> <span class="o">-</span><span class="n">EUCLEAN</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="o">*</span><span class="n">retlen</span> <span class="o">==</span> <span class="n">len</span><span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="o">-</span><span class="n">EBADMSG</span><span class="p">)</span>
			<span class="n">pr_warn</span><span class="p">(</span><span class="s">&quot;mtd-&gt;read(0x%zx bytes from 0x%llx) returned ECC error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">len</span><span class="p">,</span> <span class="n">ofs</span><span class="p">);</span>
		<span class="cm">/*</span>
<span class="cm">		 * We have the raw data without ECC correction in the buffer,</span>
<span class="cm">		 * maybe we are lucky and all data or parts are correct. We</span>
<span class="cm">		 * check the node.  If data are corrupted node check will sort</span>
<span class="cm">		 * it out.  We keep this block, it will fail on write or erase</span>
<span class="cm">		 * and the we mark it bad. Or should we do that now? But we</span>
<span class="cm">		 * should give him a chance.  Maybe we had a system crash or</span>
<span class="cm">		 * power loss before the ecc write or a erase was completed.</span>
<span class="cm">		 * So we return success. :)</span>
<span class="cm">		 */</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* if no writebuffer available or write buffer empty, return */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">wbuf_pagesize</span> <span class="o">||</span> <span class="o">!</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">wbuf_len</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>

	<span class="cm">/* if we read in a different block, return */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">SECTOR_ADDR</span><span class="p">(</span><span class="n">ofs</span><span class="p">)</span> <span class="o">!=</span> <span class="n">SECTOR_ADDR</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">wbuf_ofs</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ofs</span> <span class="o">&gt;=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">wbuf_ofs</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">owbf</span> <span class="o">=</span> <span class="p">(</span><span class="n">ofs</span> <span class="o">-</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">wbuf_ofs</span><span class="p">);</span>	<span class="cm">/* offset in write buffer */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">owbf</span> <span class="o">&gt;</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">wbuf_len</span><span class="p">)</span>		<span class="cm">/* is read beyond write buffer ? */</span>
			<span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>
		<span class="n">lwbf</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">wbuf_len</span> <span class="o">-</span> <span class="n">owbf</span><span class="p">;</span>	<span class="cm">/* number of bytes to copy */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">lwbf</span> <span class="o">&gt;</span> <span class="n">len</span><span class="p">)</span>
			<span class="n">lwbf</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">orbf</span> <span class="o">=</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">wbuf_ofs</span> <span class="o">-</span> <span class="n">ofs</span><span class="p">);</span>	<span class="cm">/* offset in read buffer */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">orbf</span> <span class="o">&gt;</span> <span class="n">len</span><span class="p">)</span>			<span class="cm">/* is write beyond write buffer ? */</span>
			<span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>
		<span class="n">lwbf</span> <span class="o">=</span> <span class="n">len</span> <span class="o">-</span> <span class="n">orbf</span><span class="p">;</span>		<span class="cm">/* number of bytes to copy */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">lwbf</span> <span class="o">&gt;</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">wbuf_len</span><span class="p">)</span>
			<span class="n">lwbf</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">wbuf_len</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lwbf</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">buf</span><span class="o">+</span><span class="n">orbf</span><span class="p">,</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">wbuf</span><span class="o">+</span><span class="n">owbf</span><span class="p">,</span><span class="n">lwbf</span><span class="p">);</span>

<span class="nl">exit:</span>
	<span class="n">up_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">wbuf_sem</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define NR_OOB_SCAN_PAGES 4</span>

<span class="cm">/* For historical reasons we use only 8 bytes for OOB clean marker */</span>
<span class="cp">#define OOB_CM_SIZE 8</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">jffs2_unknown_node</span> <span class="n">oob_cleanmarker</span> <span class="o">=</span>
<span class="p">{</span>
	<span class="p">.</span><span class="n">magic</span> <span class="o">=</span> <span class="n">constant_cpu_to_je16</span><span class="p">(</span><span class="n">JFFS2_MAGIC_BITMASK</span><span class="p">),</span>
	<span class="p">.</span><span class="n">nodetype</span> <span class="o">=</span> <span class="n">constant_cpu_to_je16</span><span class="p">(</span><span class="n">JFFS2_NODETYPE_CLEANMARKER</span><span class="p">),</span>
	<span class="p">.</span><span class="n">totlen</span> <span class="o">=</span> <span class="n">constant_cpu_to_je32</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * Check, if the out of band area is empty. This function knows about the clean</span>
<span class="cm"> * marker and if it is present in OOB, treats the OOB as empty anyway.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">jffs2_check_oob_empty</span><span class="p">(</span><span class="k">struct</span> <span class="n">jffs2_sb_info</span> <span class="o">*</span><span class="n">c</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">jffs2_eraseblock</span> <span class="o">*</span><span class="n">jeb</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">ret</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">cmlen</span> <span class="o">=</span> <span class="n">min_t</span><span class="p">(</span><span class="kt">int</span><span class="p">,</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">oobavail</span><span class="p">,</span> <span class="n">OOB_CM_SIZE</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">mtd_oob_ops</span> <span class="n">ops</span><span class="p">;</span>

	<span class="n">ops</span><span class="p">.</span><span class="n">mode</span> <span class="o">=</span> <span class="n">MTD_OPS_AUTO_OOB</span><span class="p">;</span>
	<span class="n">ops</span><span class="p">.</span><span class="n">ooblen</span> <span class="o">=</span> <span class="n">NR_OOB_SCAN_PAGES</span> <span class="o">*</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">oobavail</span><span class="p">;</span>
	<span class="n">ops</span><span class="p">.</span><span class="n">oobbuf</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">oobbuf</span><span class="p">;</span>
	<span class="n">ops</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="n">ops</span><span class="p">.</span><span class="n">ooboffs</span> <span class="o">=</span> <span class="n">ops</span><span class="p">.</span><span class="n">retlen</span> <span class="o">=</span> <span class="n">ops</span><span class="p">.</span><span class="n">oobretlen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ops</span><span class="p">.</span><span class="n">datbuf</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">mtd_read_oob</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">mtd</span><span class="p">,</span> <span class="n">jeb</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ops</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">||</span> <span class="n">ops</span><span class="p">.</span><span class="n">oobretlen</span> <span class="o">!=</span> <span class="n">ops</span><span class="p">.</span><span class="n">ooblen</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;cannot read OOB for EB at %08x, requested %zd bytes, read %zd bytes, error %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">jeb</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">,</span> <span class="n">ops</span><span class="p">.</span><span class="n">ooblen</span><span class="p">,</span> <span class="n">ops</span><span class="p">.</span><span class="n">oobretlen</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span><span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ops</span><span class="p">.</span><span class="n">ooblen</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mode</span> <span class="o">&amp;&amp;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">cmlen</span><span class="p">)</span>
			<span class="cm">/* Yeah, we know about the cleanmarker */</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ops</span><span class="p">.</span><span class="n">oobbuf</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="mh">0xFF</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">jffs2_dbg</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;Found %02x at %x in OOB for &quot;</span>
				  <span class="s">&quot;%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ops</span><span class="p">.</span><span class="n">oobbuf</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">i</span><span class="p">,</span> <span class="n">jeb</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Check for a valid cleanmarker.</span>
<span class="cm"> * Returns: 0 if a valid cleanmarker was found</span>
<span class="cm"> *	    1 if no cleanmarker was found</span>
<span class="cm"> *	    negative error code if an error occurred</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">jffs2_check_nand_cleanmarker</span><span class="p">(</span><span class="k">struct</span> <span class="n">jffs2_sb_info</span> <span class="o">*</span><span class="n">c</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">jffs2_eraseblock</span> <span class="o">*</span><span class="n">jeb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mtd_oob_ops</span> <span class="n">ops</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">,</span> <span class="n">cmlen</span> <span class="o">=</span> <span class="n">min_t</span><span class="p">(</span><span class="kt">int</span><span class="p">,</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">oobavail</span><span class="p">,</span> <span class="n">OOB_CM_SIZE</span><span class="p">);</span>

	<span class="n">ops</span><span class="p">.</span><span class="n">mode</span> <span class="o">=</span> <span class="n">MTD_OPS_AUTO_OOB</span><span class="p">;</span>
	<span class="n">ops</span><span class="p">.</span><span class="n">ooblen</span> <span class="o">=</span> <span class="n">cmlen</span><span class="p">;</span>
	<span class="n">ops</span><span class="p">.</span><span class="n">oobbuf</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">oobbuf</span><span class="p">;</span>
	<span class="n">ops</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="n">ops</span><span class="p">.</span><span class="n">ooboffs</span> <span class="o">=</span> <span class="n">ops</span><span class="p">.</span><span class="n">retlen</span> <span class="o">=</span> <span class="n">ops</span><span class="p">.</span><span class="n">oobretlen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ops</span><span class="p">.</span><span class="n">datbuf</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">mtd_read_oob</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">mtd</span><span class="p">,</span> <span class="n">jeb</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ops</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">||</span> <span class="n">ops</span><span class="p">.</span><span class="n">oobretlen</span> <span class="o">!=</span> <span class="n">ops</span><span class="p">.</span><span class="n">ooblen</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;cannot read OOB for EB at %08x, requested %zd bytes, read %zd bytes, error %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">jeb</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">,</span> <span class="n">ops</span><span class="p">.</span><span class="n">ooblen</span><span class="p">,</span> <span class="n">ops</span><span class="p">.</span><span class="n">oobretlen</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="o">!!</span><span class="n">memcmp</span><span class="p">(</span><span class="o">&amp;</span><span class="n">oob_cleanmarker</span><span class="p">,</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">oobbuf</span><span class="p">,</span> <span class="n">cmlen</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">jffs2_write_nand_cleanmarker</span><span class="p">(</span><span class="k">struct</span> <span class="n">jffs2_sb_info</span> <span class="o">*</span><span class="n">c</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">jffs2_eraseblock</span> <span class="o">*</span><span class="n">jeb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mtd_oob_ops</span> <span class="n">ops</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">cmlen</span> <span class="o">=</span> <span class="n">min_t</span><span class="p">(</span><span class="kt">int</span><span class="p">,</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">oobavail</span><span class="p">,</span> <span class="n">OOB_CM_SIZE</span><span class="p">);</span>

	<span class="n">ops</span><span class="p">.</span><span class="n">mode</span> <span class="o">=</span> <span class="n">MTD_OPS_AUTO_OOB</span><span class="p">;</span>
	<span class="n">ops</span><span class="p">.</span><span class="n">ooblen</span> <span class="o">=</span> <span class="n">cmlen</span><span class="p">;</span>
	<span class="n">ops</span><span class="p">.</span><span class="n">oobbuf</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint8_t</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">oob_cleanmarker</span><span class="p">;</span>
	<span class="n">ops</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="n">ops</span><span class="p">.</span><span class="n">ooboffs</span> <span class="o">=</span> <span class="n">ops</span><span class="p">.</span><span class="n">retlen</span> <span class="o">=</span> <span class="n">ops</span><span class="p">.</span><span class="n">oobretlen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ops</span><span class="p">.</span><span class="n">datbuf</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">mtd_write_oob</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">mtd</span><span class="p">,</span> <span class="n">jeb</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ops</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">||</span> <span class="n">ops</span><span class="p">.</span><span class="n">oobretlen</span> <span class="o">!=</span> <span class="n">ops</span><span class="p">.</span><span class="n">ooblen</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;cannot write OOB for EB at %08x, requested %zd bytes, read %zd bytes, error %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">jeb</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">,</span> <span class="n">ops</span><span class="p">.</span><span class="n">ooblen</span><span class="p">,</span> <span class="n">ops</span><span class="p">.</span><span class="n">oobretlen</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * On NAND we try to mark this block bad. If the block was erased more</span>
<span class="cm"> * than MAX_ERASE_FAILURES we mark it finally bad.</span>
<span class="cm"> * Don&#39;t care about failures. This block remains on the erase-pending</span>
<span class="cm"> * or badblock list as long as nobody manipulates the flash with</span>
<span class="cm"> * a bootloader or something like that.</span>
<span class="cm"> */</span>

<span class="kt">int</span> <span class="nf">jffs2_write_nand_badblock</span><span class="p">(</span><span class="k">struct</span> <span class="n">jffs2_sb_info</span> <span class="o">*</span><span class="n">c</span><span class="p">,</span> <span class="k">struct</span> <span class="n">jffs2_eraseblock</span> <span class="o">*</span><span class="n">jeb</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">bad_offset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> 	<span class="n">ret</span><span class="p">;</span>

	<span class="cm">/* if the count is &lt; max, we try to write the counter to the 2nd page oob area */</span>
	<span class="k">if</span><span class="p">(</span> <span class="o">++</span><span class="n">jeb</span><span class="o">-&gt;</span><span class="n">bad_count</span> <span class="o">&lt;</span> <span class="n">MAX_ERASE_FAILURES</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">pr_warn</span><span class="p">(</span><span class="s">&quot;marking eraseblock at %08x as bad</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">bad_offset</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">mtd_block_markbad</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">mtd</span><span class="p">,</span> <span class="n">bad_offset</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">jffs2_dbg</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;%s(): Write failed for block at %08x: error %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">__func__</span><span class="p">,</span> <span class="n">jeb</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">jffs2_sb_info</span> <span class="o">*</span><span class="nf">work_to_sb</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">delayed_work</span> <span class="o">*</span><span class="n">dwork</span><span class="p">;</span>

	<span class="n">dwork</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="k">struct</span> <span class="n">delayed_work</span><span class="p">,</span> <span class="n">work</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">container_of</span><span class="p">(</span><span class="n">dwork</span><span class="p">,</span> <span class="k">struct</span> <span class="n">jffs2_sb_info</span><span class="p">,</span> <span class="n">wbuf_dwork</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">delayed_wbuf_sync</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">jffs2_sb_info</span> <span class="o">*</span><span class="n">c</span> <span class="o">=</span> <span class="n">work_to_sb</span><span class="p">(</span><span class="n">work</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">sb</span> <span class="o">=</span> <span class="n">OFNI_BS_2SFFJ</span><span class="p">(</span><span class="n">c</span><span class="p">);</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">wbuf_dwork_lock</span><span class="p">);</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">wbuf_queued</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">wbuf_dwork_lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_flags</span> <span class="o">&amp;</span> <span class="n">MS_RDONLY</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">jffs2_dbg</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;%s()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="n">jffs2_flush_wbuf_gc</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">jffs2_dirty_trigger</span><span class="p">(</span><span class="k">struct</span> <span class="n">jffs2_sb_info</span> <span class="o">*</span><span class="n">c</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">sb</span> <span class="o">=</span> <span class="n">OFNI_BS_2SFFJ</span><span class="p">(</span><span class="n">c</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">delay</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_flags</span> <span class="o">&amp;</span> <span class="n">MS_RDONLY</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">wbuf_dwork_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">wbuf_queued</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">jffs2_dbg</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;%s()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="n">delay</span> <span class="o">=</span> <span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="n">dirty_writeback_interval</span> <span class="o">*</span> <span class="mi">10</span><span class="p">);</span>
		<span class="n">queue_delayed_work</span><span class="p">(</span><span class="n">system_long_wq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">wbuf_dwork</span><span class="p">,</span> <span class="n">delay</span><span class="p">);</span>
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">wbuf_queued</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">wbuf_dwork_lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">jffs2_nand_flash_setup</span><span class="p">(</span><span class="k">struct</span> <span class="n">jffs2_sb_info</span> <span class="o">*</span><span class="n">c</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nand_ecclayout</span> <span class="o">*</span><span class="n">oinfo</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">mtd</span><span class="o">-&gt;</span><span class="n">ecclayout</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">mtd</span><span class="o">-&gt;</span><span class="n">oobsize</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Cleanmarker is out-of-band, so inline size zero */</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">cleanmarker_size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">oinfo</span> <span class="o">||</span> <span class="n">oinfo</span><span class="o">-&gt;</span><span class="n">oobavail</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;inconsistent device description</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">jffs2_dbg</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;using OOB on NAND</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">c</span><span class="o">-&gt;</span><span class="n">oobavail</span> <span class="o">=</span> <span class="n">oinfo</span><span class="o">-&gt;</span><span class="n">oobavail</span><span class="p">;</span>

	<span class="cm">/* Initialise write buffer */</span>
	<span class="n">init_rwsem</span><span class="p">(</span><span class="o">&amp;</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">wbuf_sem</span><span class="p">);</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">wbuf_dwork_lock</span><span class="p">);</span>
	<span class="n">INIT_DELAYED_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">wbuf_dwork</span><span class="p">,</span> <span class="n">delayed_wbuf_sync</span><span class="p">);</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">wbuf_pagesize</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">mtd</span><span class="o">-&gt;</span><span class="n">writesize</span><span class="p">;</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">wbuf_ofs</span> <span class="o">=</span> <span class="mh">0xFFFFFFFF</span><span class="p">;</span>

	<span class="n">c</span><span class="o">-&gt;</span><span class="n">wbuf</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">wbuf_pagesize</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">wbuf</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">c</span><span class="o">-&gt;</span><span class="n">oobbuf</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">NR_OOB_SCAN_PAGES</span> <span class="o">*</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">oobavail</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">oobbuf</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">wbuf</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

<span class="cp">#ifdef CONFIG_JFFS2_FS_WBUF_VERIFY</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">wbuf_verify</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">wbuf_pagesize</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">wbuf_verify</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">oobbuf</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">wbuf</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">jffs2_nand_flash_cleanup</span><span class="p">(</span><span class="k">struct</span> <span class="n">jffs2_sb_info</span> <span class="o">*</span><span class="n">c</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifdef CONFIG_JFFS2_FS_WBUF_VERIFY</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">wbuf_verify</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">wbuf</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">oobbuf</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">jffs2_dataflash_setup</span><span class="p">(</span><span class="k">struct</span> <span class="n">jffs2_sb_info</span> <span class="o">*</span><span class="n">c</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">cleanmarker_size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>		<span class="cm">/* No cleanmarkers needed */</span>

	<span class="cm">/* Initialize write buffer */</span>
	<span class="n">init_rwsem</span><span class="p">(</span><span class="o">&amp;</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">wbuf_sem</span><span class="p">);</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">wbuf_dwork_lock</span><span class="p">);</span>
	<span class="n">INIT_DELAYED_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">wbuf_dwork</span><span class="p">,</span> <span class="n">delayed_wbuf_sync</span><span class="p">);</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">wbuf_pagesize</span> <span class="o">=</span>  <span class="n">c</span><span class="o">-&gt;</span><span class="n">mtd</span><span class="o">-&gt;</span><span class="n">erasesize</span><span class="p">;</span>

	<span class="cm">/* Find a suitable c-&gt;sector_size</span>
<span class="cm">	 * - Not too much sectors</span>
<span class="cm">	 * - Sectors have to be at least 4 K + some bytes</span>
<span class="cm">	 * - All known dataflashes have erase sizes of 528 or 1056</span>
<span class="cm">	 * - we take at least 8 eraseblocks and want to have at least 8K size</span>
<span class="cm">	 * - The concatenation should be a power of 2</span>
<span class="cm">	*/</span>

	<span class="n">c</span><span class="o">-&gt;</span><span class="n">sector_size</span> <span class="o">=</span> <span class="mi">8</span> <span class="o">*</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">mtd</span><span class="o">-&gt;</span><span class="n">erasesize</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">sector_size</span> <span class="o">&lt;</span> <span class="mi">8192</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">sector_size</span> <span class="o">*=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* It may be necessary to adjust the flash size */</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">flash_size</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">mtd</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">flash_size</span> <span class="o">%</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">sector_size</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">flash_size</span> <span class="o">=</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">flash_size</span> <span class="o">/</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">sector_size</span><span class="p">)</span> <span class="o">*</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">sector_size</span><span class="p">;</span>
		<span class="n">pr_warn</span><span class="p">(</span><span class="s">&quot;flash size adjusted to %dKiB</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">flash_size</span><span class="p">);</span>
	<span class="p">};</span>

	<span class="n">c</span><span class="o">-&gt;</span><span class="n">wbuf_ofs</span> <span class="o">=</span> <span class="mh">0xFFFFFFFF</span><span class="p">;</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">wbuf</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">wbuf_pagesize</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">wbuf</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_JFFS2_FS_WBUF_VERIFY</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">wbuf_verify</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">wbuf_pagesize</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">wbuf_verify</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">oobbuf</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">wbuf</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#endif</span>

	<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;write-buffering enabled buffer (%d) erasesize (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">wbuf_pagesize</span><span class="p">,</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">sector_size</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">jffs2_dataflash_cleanup</span><span class="p">(</span><span class="k">struct</span> <span class="n">jffs2_sb_info</span> <span class="o">*</span><span class="n">c</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#ifdef CONFIG_JFFS2_FS_WBUF_VERIFY</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">wbuf_verify</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">wbuf</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">jffs2_nor_wbuf_flash_setup</span><span class="p">(</span><span class="k">struct</span> <span class="n">jffs2_sb_info</span> <span class="o">*</span><span class="n">c</span><span class="p">)</span> <span class="p">{</span>
	<span class="cm">/* Cleanmarker currently occupies whole programming regions,</span>
<span class="cm">	 * either one or 2 for 8Byte STMicro flashes. */</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">cleanmarker_size</span> <span class="o">=</span> <span class="n">max</span><span class="p">(</span><span class="mi">16u</span><span class="p">,</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">mtd</span><span class="o">-&gt;</span><span class="n">writesize</span><span class="p">);</span>

	<span class="cm">/* Initialize write buffer */</span>
	<span class="n">init_rwsem</span><span class="p">(</span><span class="o">&amp;</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">wbuf_sem</span><span class="p">);</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">wbuf_dwork_lock</span><span class="p">);</span>
	<span class="n">INIT_DELAYED_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">wbuf_dwork</span><span class="p">,</span> <span class="n">delayed_wbuf_sync</span><span class="p">);</span>

	<span class="n">c</span><span class="o">-&gt;</span><span class="n">wbuf_pagesize</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">mtd</span><span class="o">-&gt;</span><span class="n">writesize</span><span class="p">;</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">wbuf_ofs</span> <span class="o">=</span> <span class="mh">0xFFFFFFFF</span><span class="p">;</span>

	<span class="n">c</span><span class="o">-&gt;</span><span class="n">wbuf</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">wbuf_pagesize</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">wbuf</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_JFFS2_FS_WBUF_VERIFY</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">wbuf_verify</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">wbuf_pagesize</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">wbuf_verify</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">wbuf</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">jffs2_nor_wbuf_flash_cleanup</span><span class="p">(</span><span class="k">struct</span> <span class="n">jffs2_sb_info</span> <span class="o">*</span><span class="n">c</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#ifdef CONFIG_JFFS2_FS_WBUF_VERIFY</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">wbuf_verify</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">wbuf</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">jffs2_ubivol_setup</span><span class="p">(</span><span class="k">struct</span> <span class="n">jffs2_sb_info</span> <span class="o">*</span><span class="n">c</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">cleanmarker_size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">mtd</span><span class="o">-&gt;</span><span class="n">writesize</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
		<span class="cm">/* We do not need write-buffer */</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">init_rwsem</span><span class="p">(</span><span class="o">&amp;</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">wbuf_sem</span><span class="p">);</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">wbuf_dwork_lock</span><span class="p">);</span>
	<span class="n">INIT_DELAYED_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">wbuf_dwork</span><span class="p">,</span> <span class="n">delayed_wbuf_sync</span><span class="p">);</span>

	<span class="n">c</span><span class="o">-&gt;</span><span class="n">wbuf_pagesize</span> <span class="o">=</span>  <span class="n">c</span><span class="o">-&gt;</span><span class="n">mtd</span><span class="o">-&gt;</span><span class="n">writesize</span><span class="p">;</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">wbuf_ofs</span> <span class="o">=</span> <span class="mh">0xFFFFFFFF</span><span class="p">;</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">wbuf</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">wbuf_pagesize</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">wbuf</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;write-buffering enabled buffer (%d) erasesize (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">wbuf_pagesize</span><span class="p">,</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">sector_size</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">jffs2_ubivol_cleanup</span><span class="p">(</span><span class="k">struct</span> <span class="n">jffs2_sb_info</span> <span class="o">*</span><span class="n">c</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">wbuf</span><span class="p">);</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
