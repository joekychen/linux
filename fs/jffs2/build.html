<!DOCTYPE html>
<html><head><title>joekychen/linux » fs › jffs2 › build.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>build.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * JFFS2 -- Journalling Flash File System, Version 2.</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright © 2001-2007 Red Hat, Inc.</span>
<span class="cm"> * Copyright © 2004-2010 David Woodhouse &lt;dwmw2@infradead.org&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * Created by David Woodhouse &lt;dwmw2@infradead.org&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * For licensing information, see the file &#39;LICENCE&#39; in this directory.</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="cp">#define pr_fmt(fmt) KBUILD_MODNAME &quot;: &quot; fmt</span>

<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/sched.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/vmalloc.h&gt;</span>
<span class="cp">#include &lt;linux/mtd/mtd.h&gt;</span>
<span class="cp">#include &quot;nodelist.h&quot;</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">jffs2_build_remove_unlinked_inode</span><span class="p">(</span><span class="k">struct</span> <span class="n">jffs2_sb_info</span> <span class="o">*</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">jffs2_inode_cache</span> <span class="o">*</span><span class="p">,</span> <span class="k">struct</span> <span class="n">jffs2_full_dirent</span> <span class="o">**</span><span class="p">);</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="k">struct</span> <span class="n">jffs2_inode_cache</span> <span class="o">*</span>
<span class="nf">first_inode_chain</span><span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="n">i</span><span class="p">,</span> <span class="k">struct</span> <span class="n">jffs2_sb_info</span> <span class="o">*</span><span class="n">c</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">for</span> <span class="p">(;</span> <span class="o">*</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">inocache_hashsize</span><span class="p">;</span> <span class="p">(</span><span class="o">*</span><span class="n">i</span><span class="p">)</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">inocache_list</span><span class="p">[</span><span class="o">*</span><span class="n">i</span><span class="p">])</span>
			<span class="k">return</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">inocache_list</span><span class="p">[</span><span class="o">*</span><span class="n">i</span><span class="p">];</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="k">struct</span> <span class="n">jffs2_inode_cache</span> <span class="o">*</span>
<span class="nf">next_inode</span><span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="n">i</span><span class="p">,</span> <span class="k">struct</span> <span class="n">jffs2_inode_cache</span> <span class="o">*</span><span class="n">ic</span><span class="p">,</span> <span class="k">struct</span> <span class="n">jffs2_sb_info</span> <span class="o">*</span><span class="n">c</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* More in this chain? */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ic</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ic</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
	<span class="p">(</span><span class="o">*</span><span class="n">i</span><span class="p">)</span><span class="o">++</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">first_inode_chain</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">c</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#define for_each_inode(i, c, ic)			\</span>
<span class="cp">	for (i = 0, ic = first_inode_chain(&amp;i, (c));	\</span>
<span class="cp">	     ic;					\</span>
<span class="cp">	     ic = next_inode(&amp;i, ic, (c)))</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">jffs2_build_inode_pass1</span><span class="p">(</span><span class="k">struct</span> <span class="n">jffs2_sb_info</span> <span class="o">*</span><span class="n">c</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">jffs2_inode_cache</span> <span class="o">*</span><span class="n">ic</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">jffs2_full_dirent</span> <span class="o">*</span><span class="n">fd</span><span class="p">;</span>

	<span class="n">dbg_fsbuild</span><span class="p">(</span><span class="s">&quot;building directory inode #%u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ic</span><span class="o">-&gt;</span><span class="n">ino</span><span class="p">);</span>

	<span class="cm">/* For each child, increase nlink */</span>
	<span class="k">for</span><span class="p">(</span><span class="n">fd</span> <span class="o">=</span> <span class="n">ic</span><span class="o">-&gt;</span><span class="n">scan_dents</span><span class="p">;</span> <span class="n">fd</span><span class="p">;</span> <span class="n">fd</span> <span class="o">=</span> <span class="n">fd</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">jffs2_inode_cache</span> <span class="o">*</span><span class="n">child_ic</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fd</span><span class="o">-&gt;</span><span class="n">ino</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="cm">/* we can get high latency here with huge directories */</span>

		<span class="n">child_ic</span> <span class="o">=</span> <span class="n">jffs2_get_ino_cache</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">fd</span><span class="o">-&gt;</span><span class="n">ino</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">child_ic</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dbg_fsbuild</span><span class="p">(</span><span class="s">&quot;child </span><span class="se">\&quot;</span><span class="s">%s</span><span class="se">\&quot;</span><span class="s"> (ino #%u) of dir ino #%u doesn&#39;t exist!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				  <span class="n">fd</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">fd</span><span class="o">-&gt;</span><span class="n">ino</span><span class="p">,</span> <span class="n">ic</span><span class="o">-&gt;</span><span class="n">ino</span><span class="p">);</span>
			<span class="n">jffs2_mark_node_obsolete</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">fd</span><span class="o">-&gt;</span><span class="n">raw</span><span class="p">);</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">fd</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">DT_DIR</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">child_ic</span><span class="o">-&gt;</span><span class="n">pino_nlink</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">JFFS2_ERROR</span><span class="p">(</span><span class="s">&quot;child dir </span><span class="se">\&quot;</span><span class="s">%s</span><span class="se">\&quot;</span><span class="s"> (ino #%u) of dir ino #%u appears to be a hard link</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					    <span class="n">fd</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">fd</span><span class="o">-&gt;</span><span class="n">ino</span><span class="p">,</span> <span class="n">ic</span><span class="o">-&gt;</span><span class="n">ino</span><span class="p">);</span>
				<span class="cm">/* TODO: What do we do about it? */</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">child_ic</span><span class="o">-&gt;</span><span class="n">pino_nlink</span> <span class="o">=</span> <span class="n">ic</span><span class="o">-&gt;</span><span class="n">ino</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">child_ic</span><span class="o">-&gt;</span><span class="n">pino_nlink</span><span class="o">++</span><span class="p">;</span>

		<span class="n">dbg_fsbuild</span><span class="p">(</span><span class="s">&quot;increased nlink for child </span><span class="se">\&quot;</span><span class="s">%s</span><span class="se">\&quot;</span><span class="s"> (ino #%u)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">fd</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">fd</span><span class="o">-&gt;</span><span class="n">ino</span><span class="p">);</span>
		<span class="cm">/* Can&#39;t free scan_dents so far. We might need them in pass 2 */</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* Scan plan:</span>
<span class="cm"> - Scan physical nodes. Build map of inodes/dirents. Allocate inocaches as we go</span>
<span class="cm"> - Scan directory tree from top down, setting nlink in inocaches</span>
<span class="cm"> - Scan inocaches for inodes with nlink==0</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">jffs2_build_filesystem</span><span class="p">(</span><span class="k">struct</span> <span class="n">jffs2_sb_info</span> <span class="o">*</span><span class="n">c</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">jffs2_inode_cache</span> <span class="o">*</span><span class="n">ic</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">jffs2_full_dirent</span> <span class="o">*</span><span class="n">fd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">jffs2_full_dirent</span> <span class="o">*</span><span class="n">dead_fds</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">dbg_fsbuild</span><span class="p">(</span><span class="s">&quot;build FS data structures</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/* First, scan the medium and build all the inode caches with</span>
<span class="cm">	   lists of physical nodes */</span>

	<span class="n">c</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">JFFS2_SB_FLAG_SCANNING</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">jffs2_scan_medium</span><span class="p">(</span><span class="n">c</span><span class="p">);</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">JFFS2_SB_FLAG_SCANNING</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>

	<span class="n">dbg_fsbuild</span><span class="p">(</span><span class="s">&quot;scanned flash completely</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">jffs2_dbg_dump_block_lists_nolock</span><span class="p">(</span><span class="n">c</span><span class="p">);</span>

	<span class="n">dbg_fsbuild</span><span class="p">(</span><span class="s">&quot;pass 1 starting</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">JFFS2_SB_FLAG_BUILDING</span><span class="p">;</span>
	<span class="cm">/* Now scan the directory tree, increasing nlink according to every dirent found. */</span>
	<span class="n">for_each_inode</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ic</span><span class="o">-&gt;</span><span class="n">scan_dents</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">jffs2_build_inode_pass1</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">ic</span><span class="p">);</span>
			<span class="n">cond_resched</span><span class="p">();</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">dbg_fsbuild</span><span class="p">(</span><span class="s">&quot;pass 1 complete</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/* Next, scan for inodes with nlink == 0 and remove them. If</span>
<span class="cm">	   they were directories, then decrement the nlink of their</span>
<span class="cm">	   children too, and repeat the scan. As that&#39;s going to be</span>
<span class="cm">	   a fairly uncommon occurrence, it&#39;s not so evil to do it this</span>
<span class="cm">	   way. Recursion bad. */</span>
	<span class="n">dbg_fsbuild</span><span class="p">(</span><span class="s">&quot;pass 2 starting</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">for_each_inode</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ic</span><span class="o">-&gt;</span><span class="n">pino_nlink</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">jffs2_build_remove_unlinked_inode</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">ic</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dead_fds</span><span class="p">);</span>
		<span class="n">cond_resched</span><span class="p">();</span>
	<span class="p">}</span>

	<span class="n">dbg_fsbuild</span><span class="p">(</span><span class="s">&quot;pass 2a starting</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">dead_fds</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fd</span> <span class="o">=</span> <span class="n">dead_fds</span><span class="p">;</span>
		<span class="n">dead_fds</span> <span class="o">=</span> <span class="n">fd</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>

		<span class="n">ic</span> <span class="o">=</span> <span class="n">jffs2_get_ino_cache</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">fd</span><span class="o">-&gt;</span><span class="n">ino</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ic</span><span class="p">)</span>
			<span class="n">jffs2_build_remove_unlinked_inode</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">ic</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dead_fds</span><span class="p">);</span>
		<span class="n">jffs2_free_full_dirent</span><span class="p">(</span><span class="n">fd</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">dbg_fsbuild</span><span class="p">(</span><span class="s">&quot;pass 2a complete</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">dbg_fsbuild</span><span class="p">(</span><span class="s">&quot;freeing temporary data structures</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/* Finally, we can scan again and free the dirent structs */</span>
	<span class="n">for_each_inode</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">while</span><span class="p">(</span><span class="n">ic</span><span class="o">-&gt;</span><span class="n">scan_dents</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">fd</span> <span class="o">=</span> <span class="n">ic</span><span class="o">-&gt;</span><span class="n">scan_dents</span><span class="p">;</span>
			<span class="n">ic</span><span class="o">-&gt;</span><span class="n">scan_dents</span> <span class="o">=</span> <span class="n">fd</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
			<span class="n">jffs2_free_full_dirent</span><span class="p">(</span><span class="n">fd</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">ic</span><span class="o">-&gt;</span><span class="n">scan_dents</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">cond_resched</span><span class="p">();</span>
	<span class="p">}</span>
	<span class="n">jffs2_build_xattr_subsystem</span><span class="p">(</span><span class="n">c</span><span class="p">);</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">JFFS2_SB_FLAG_BUILDING</span><span class="p">;</span>

	<span class="n">dbg_fsbuild</span><span class="p">(</span><span class="s">&quot;FS build complete</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/* Rotate the lists by some number to ensure wear levelling */</span>
	<span class="n">jffs2_rotate_lists</span><span class="p">(</span><span class="n">c</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">exit:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">for_each_inode</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">while</span><span class="p">(</span><span class="n">ic</span><span class="o">-&gt;</span><span class="n">scan_dents</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">fd</span> <span class="o">=</span> <span class="n">ic</span><span class="o">-&gt;</span><span class="n">scan_dents</span><span class="p">;</span>
				<span class="n">ic</span><span class="o">-&gt;</span><span class="n">scan_dents</span> <span class="o">=</span> <span class="n">fd</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
				<span class="n">jffs2_free_full_dirent</span><span class="p">(</span><span class="n">fd</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">jffs2_clear_xattr_subsystem</span><span class="p">(</span><span class="n">c</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">jffs2_build_remove_unlinked_inode</span><span class="p">(</span><span class="k">struct</span> <span class="n">jffs2_sb_info</span> <span class="o">*</span><span class="n">c</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">jffs2_inode_cache</span> <span class="o">*</span><span class="n">ic</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">jffs2_full_dirent</span> <span class="o">**</span><span class="n">dead_fds</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">jffs2_raw_node_ref</span> <span class="o">*</span><span class="n">raw</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">jffs2_full_dirent</span> <span class="o">*</span><span class="n">fd</span><span class="p">;</span>

	<span class="n">dbg_fsbuild</span><span class="p">(</span><span class="s">&quot;removing ino #%u with nlink == zero.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ic</span><span class="o">-&gt;</span><span class="n">ino</span><span class="p">);</span>

	<span class="n">raw</span> <span class="o">=</span> <span class="n">ic</span><span class="o">-&gt;</span><span class="n">nodes</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">raw</span> <span class="o">!=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">ic</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">jffs2_raw_node_ref</span> <span class="o">*</span><span class="n">next</span> <span class="o">=</span> <span class="n">raw</span><span class="o">-&gt;</span><span class="n">next_in_ino</span><span class="p">;</span>
		<span class="n">dbg_fsbuild</span><span class="p">(</span><span class="s">&quot;obsoleting node at 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ref_offset</span><span class="p">(</span><span class="n">raw</span><span class="p">));</span>
		<span class="n">jffs2_mark_node_obsolete</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">raw</span><span class="p">);</span>
		<span class="n">raw</span> <span class="o">=</span> <span class="n">next</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ic</span><span class="o">-&gt;</span><span class="n">scan_dents</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">whinged</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">dbg_fsbuild</span><span class="p">(</span><span class="s">&quot;inode #%u was a directory which may have children...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ic</span><span class="o">-&gt;</span><span class="n">ino</span><span class="p">);</span>

		<span class="k">while</span><span class="p">(</span><span class="n">ic</span><span class="o">-&gt;</span><span class="n">scan_dents</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">jffs2_inode_cache</span> <span class="o">*</span><span class="n">child_ic</span><span class="p">;</span>

			<span class="n">fd</span> <span class="o">=</span> <span class="n">ic</span><span class="o">-&gt;</span><span class="n">scan_dents</span><span class="p">;</span>
			<span class="n">ic</span><span class="o">-&gt;</span><span class="n">scan_dents</span> <span class="o">=</span> <span class="n">fd</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fd</span><span class="o">-&gt;</span><span class="n">ino</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* It&#39;s a deletion dirent. Ignore it */</span>
				<span class="n">dbg_fsbuild</span><span class="p">(</span><span class="s">&quot;child </span><span class="se">\&quot;</span><span class="s">%s</span><span class="se">\&quot;</span><span class="s"> is a deletion dirent, skipping...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">fd</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
				<span class="n">jffs2_free_full_dirent</span><span class="p">(</span><span class="n">fd</span><span class="p">);</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">whinged</span><span class="p">)</span>
				<span class="n">whinged</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

			<span class="n">dbg_fsbuild</span><span class="p">(</span><span class="s">&quot;removing child </span><span class="se">\&quot;</span><span class="s">%s</span><span class="se">\&quot;</span><span class="s">, ino #%u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">fd</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">fd</span><span class="o">-&gt;</span><span class="n">ino</span><span class="p">);</span>

			<span class="n">child_ic</span> <span class="o">=</span> <span class="n">jffs2_get_ino_cache</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">fd</span><span class="o">-&gt;</span><span class="n">ino</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">child_ic</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">dbg_fsbuild</span><span class="p">(</span><span class="s">&quot;cannot remove child </span><span class="se">\&quot;</span><span class="s">%s</span><span class="se">\&quot;</span><span class="s">, ino #%u, because it doesn&#39;t exist</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						<span class="n">fd</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">fd</span><span class="o">-&gt;</span><span class="n">ino</span><span class="p">);</span>
				<span class="n">jffs2_free_full_dirent</span><span class="p">(</span><span class="n">fd</span><span class="p">);</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="cm">/* Reduce nlink of the child. If it&#39;s now zero, stick it on the</span>
<span class="cm">			   dead_fds list to be cleaned up later. Else just free the fd */</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">fd</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">DT_DIR</span><span class="p">)</span>
				<span class="n">child_ic</span><span class="o">-&gt;</span><span class="n">pino_nlink</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">child_ic</span><span class="o">-&gt;</span><span class="n">pino_nlink</span><span class="o">--</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">child_ic</span><span class="o">-&gt;</span><span class="n">pino_nlink</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">dbg_fsbuild</span><span class="p">(</span><span class="s">&quot;inode #%u (</span><span class="se">\&quot;</span><span class="s">%s</span><span class="se">\&quot;</span><span class="s">) now has no links; adding to dead_fds list.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					  <span class="n">fd</span><span class="o">-&gt;</span><span class="n">ino</span><span class="p">,</span> <span class="n">fd</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
				<span class="n">fd</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="o">*</span><span class="n">dead_fds</span><span class="p">;</span>
				<span class="o">*</span><span class="n">dead_fds</span> <span class="o">=</span> <span class="n">fd</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">dbg_fsbuild</span><span class="p">(</span><span class="s">&quot;inode #%u (</span><span class="se">\&quot;</span><span class="s">%s</span><span class="se">\&quot;</span><span class="s">) has now got nlink %d. Ignoring.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					  <span class="n">fd</span><span class="o">-&gt;</span><span class="n">ino</span><span class="p">,</span> <span class="n">fd</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">child_ic</span><span class="o">-&gt;</span><span class="n">pino_nlink</span><span class="p">);</span>
				<span class="n">jffs2_free_full_dirent</span><span class="p">(</span><span class="n">fd</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	   We don&#39;t delete the inocache from the hash list and free it yet.</span>
<span class="cm">	   The erase code will do that, when all the nodes are completely gone.</span>
<span class="cm">	*/</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">jffs2_calc_trigger_levels</span><span class="p">(</span><span class="k">struct</span> <span class="n">jffs2_sb_info</span> <span class="o">*</span><span class="n">c</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">uint32_t</span> <span class="n">size</span><span class="p">;</span>

	<span class="cm">/* Deletion should almost _always_ be allowed. We&#39;re fairly</span>
<span class="cm">	   buggered once we stop allowing people to delete stuff</span>
<span class="cm">	   because there&#39;s not enough free space... */</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">resv_blocks_deletion</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>

	<span class="cm">/* Be conservative about how much space we need before we allow writes.</span>
<span class="cm">	   On top of that which is required for deletia, require an extra 2%</span>
<span class="cm">	   of the medium to be available, for overhead caused by nodes being</span>
<span class="cm">	   split across blocks, etc. */</span>

	<span class="n">size</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">flash_size</span> <span class="o">/</span> <span class="mi">50</span><span class="p">;</span> <span class="cm">/* 2% of flash size */</span>
	<span class="n">size</span> <span class="o">+=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">nr_blocks</span> <span class="o">*</span> <span class="mi">100</span><span class="p">;</span> <span class="cm">/* And 100 bytes per eraseblock */</span>
	<span class="n">size</span> <span class="o">+=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">sector_size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span> <span class="cm">/* ... and round up */</span>

	<span class="n">c</span><span class="o">-&gt;</span><span class="n">resv_blocks_write</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">resv_blocks_deletion</span> <span class="o">+</span> <span class="p">(</span><span class="n">size</span> <span class="o">/</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">sector_size</span><span class="p">);</span>

	<span class="cm">/* When do we let the GC thread run in the background */</span>

	<span class="n">c</span><span class="o">-&gt;</span><span class="n">resv_blocks_gctrigger</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">resv_blocks_write</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* When do we allow garbage collection to merge nodes to make</span>
<span class="cm">	   long-term progress at the expense of short-term space exhaustion? */</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">resv_blocks_gcmerge</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">resv_blocks_deletion</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* When do we allow garbage collection to eat from bad blocks rather</span>
<span class="cm">	   than actually making progress? */</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">resv_blocks_gcbad</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span><span class="c1">//c-&gt;resv_blocks_deletion + 2;</span>

	<span class="cm">/* What number of &#39;very dirty&#39; eraseblocks do we allow before we</span>
<span class="cm">	   trigger the GC thread even if we don&#39;t _need_ the space. When we</span>
<span class="cm">	   can&#39;t mark nodes obsolete on the medium, the old dirty nodes cause</span>
<span class="cm">	   performance problems because we have to inspect and discard them. */</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">vdirty_blocks_gctrigger</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">resv_blocks_gctrigger</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">jffs2_can_mark_obsolete</span><span class="p">(</span><span class="n">c</span><span class="p">))</span>
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">vdirty_blocks_gctrigger</span> <span class="o">*=</span> <span class="mi">10</span><span class="p">;</span>

	<span class="cm">/* If there&#39;s less than this amount of dirty space, don&#39;t bother</span>
<span class="cm">	   trying to GC to make more space. It&#39;ll be a fruitless task */</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">nospc_dirty_size</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">sector_size</span> <span class="o">+</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">flash_size</span> <span class="o">/</span> <span class="mi">100</span><span class="p">);</span>

	<span class="n">dbg_fsbuild</span><span class="p">(</span><span class="s">&quot;trigger levels (size %d KiB, block size %d KiB, %d blocks)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">c</span><span class="o">-&gt;</span><span class="n">flash_size</span> <span class="o">/</span> <span class="mi">1024</span><span class="p">,</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">sector_size</span> <span class="o">/</span> <span class="mi">1024</span><span class="p">,</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">nr_blocks</span><span class="p">);</span>
	<span class="n">dbg_fsbuild</span><span class="p">(</span><span class="s">&quot;Blocks required to allow deletion:    %d (%d KiB)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		  <span class="n">c</span><span class="o">-&gt;</span><span class="n">resv_blocks_deletion</span><span class="p">,</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">resv_blocks_deletion</span><span class="o">*</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">sector_size</span><span class="o">/</span><span class="mi">1024</span><span class="p">);</span>
	<span class="n">dbg_fsbuild</span><span class="p">(</span><span class="s">&quot;Blocks required to allow writes:      %d (%d KiB)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		  <span class="n">c</span><span class="o">-&gt;</span><span class="n">resv_blocks_write</span><span class="p">,</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">resv_blocks_write</span><span class="o">*</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">sector_size</span><span class="o">/</span><span class="mi">1024</span><span class="p">);</span>
	<span class="n">dbg_fsbuild</span><span class="p">(</span><span class="s">&quot;Blocks required to quiesce GC thread: %d (%d KiB)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		  <span class="n">c</span><span class="o">-&gt;</span><span class="n">resv_blocks_gctrigger</span><span class="p">,</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">resv_blocks_gctrigger</span><span class="o">*</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">sector_size</span><span class="o">/</span><span class="mi">1024</span><span class="p">);</span>
	<span class="n">dbg_fsbuild</span><span class="p">(</span><span class="s">&quot;Blocks required to allow GC merges:   %d (%d KiB)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		  <span class="n">c</span><span class="o">-&gt;</span><span class="n">resv_blocks_gcmerge</span><span class="p">,</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">resv_blocks_gcmerge</span><span class="o">*</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">sector_size</span><span class="o">/</span><span class="mi">1024</span><span class="p">);</span>
	<span class="n">dbg_fsbuild</span><span class="p">(</span><span class="s">&quot;Blocks required to GC bad blocks:     %d (%d KiB)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		  <span class="n">c</span><span class="o">-&gt;</span><span class="n">resv_blocks_gcbad</span><span class="p">,</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">resv_blocks_gcbad</span><span class="o">*</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">sector_size</span><span class="o">/</span><span class="mi">1024</span><span class="p">);</span>
	<span class="n">dbg_fsbuild</span><span class="p">(</span><span class="s">&quot;Amount of dirty space required to GC: %d bytes</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		  <span class="n">c</span><span class="o">-&gt;</span><span class="n">nospc_dirty_size</span><span class="p">);</span>
	<span class="n">dbg_fsbuild</span><span class="p">(</span><span class="s">&quot;Very dirty blocks before GC triggered: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		  <span class="n">c</span><span class="o">-&gt;</span><span class="n">vdirty_blocks_gctrigger</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">jffs2_do_mount_fs</span><span class="p">(</span><span class="k">struct</span> <span class="n">jffs2_sb_info</span> <span class="o">*</span><span class="n">c</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">size</span><span class="p">;</span>

	<span class="n">c</span><span class="o">-&gt;</span><span class="n">free_size</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">flash_size</span><span class="p">;</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">nr_blocks</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">flash_size</span> <span class="o">/</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">sector_size</span><span class="p">;</span>
	<span class="n">size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">jffs2_eraseblock</span><span class="p">)</span> <span class="o">*</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">nr_blocks</span><span class="p">;</span>
<span class="cp">#ifndef __ECOS</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">jffs2_blocks_use_vmalloc</span><span class="p">(</span><span class="n">c</span><span class="p">))</span>
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">blocks</span> <span class="o">=</span> <span class="n">vzalloc</span><span class="p">(</span><span class="n">size</span><span class="p">);</span>
	<span class="k">else</span>
<span class="cp">#endif</span>
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">blocks</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">blocks</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">nr_blocks</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">blocks</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">list</span><span class="p">);</span>
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">blocks</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">offset</span> <span class="o">=</span> <span class="n">i</span> <span class="o">*</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">sector_size</span><span class="p">;</span>
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">blocks</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">free_size</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">sector_size</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">clean_list</span><span class="p">);</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">very_dirty_list</span><span class="p">);</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">dirty_list</span><span class="p">);</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">erasable_list</span><span class="p">);</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">erasing_list</span><span class="p">);</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">erase_checking_list</span><span class="p">);</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">erase_pending_list</span><span class="p">);</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">erasable_pending_wbuf_list</span><span class="p">);</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">erase_complete_list</span><span class="p">);</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">free_list</span><span class="p">);</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">bad_list</span><span class="p">);</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">bad_used_list</span><span class="p">);</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">highest_ino</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">summary</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">jffs2_sum_init</span><span class="p">(</span><span class="n">c</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_free</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">jffs2_build_filesystem</span><span class="p">(</span><span class="n">c</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dbg_fsbuild</span><span class="p">(</span><span class="s">&quot;build_fs failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">jffs2_free_ino_caches</span><span class="p">(</span><span class="n">c</span><span class="p">);</span>
		<span class="n">jffs2_free_raw_node_refs</span><span class="p">(</span><span class="n">c</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out_free</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">jffs2_calc_trigger_levels</span><span class="p">(</span><span class="n">c</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

 <span class="nl">out_free:</span>
<span class="cp">#ifndef __ECOS</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">jffs2_blocks_use_vmalloc</span><span class="p">(</span><span class="n">c</span><span class="p">))</span>
		<span class="n">vfree</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">blocks</span><span class="p">);</span>
	<span class="k">else</span>
<span class="cp">#endif</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">blocks</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
