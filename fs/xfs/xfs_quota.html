<!DOCTYPE html>
<html><head><title>joekychen/linux » fs › xfs › xfs_quota.h

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>xfs_quota.h</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Copyright (c) 2000-2005 Silicon Graphics, Inc.</span>
<span class="cm"> * All Rights Reserved.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or</span>
<span class="cm"> * modify it under the terms of the GNU General Public License as</span>
<span class="cm"> * published by the Free Software Foundation.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is distributed in the hope that it would be useful,</span>
<span class="cm"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm"> * GNU General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> * You should have received a copy of the GNU General Public License</span>
<span class="cm"> * along with this program; if not, write the Free Software Foundation,</span>
<span class="cm"> * Inc.,  51 Franklin St, Fifth Floor, Boston, MA  02110-1301  USA</span>
<span class="cm"> */</span>
<span class="cp">#ifndef __XFS_QUOTA_H__</span>
<span class="cp">#define __XFS_QUOTA_H__</span>

<span class="k">struct</span> <span class="n">xfs_trans</span><span class="p">;</span>

<span class="cm">/*</span>
<span class="cm"> * The ondisk form of a dquot structure.</span>
<span class="cm"> */</span>
<span class="cp">#define XFS_DQUOT_MAGIC		0x4451		</span><span class="cm">/* &#39;DQ&#39; */</span><span class="cp"></span>
<span class="cp">#define XFS_DQUOT_VERSION	(u_int8_t)0x01	</span><span class="cm">/* latest version number */</span><span class="cp"></span>

<span class="cm">/*</span>
<span class="cm"> * uid_t and gid_t are hard-coded to 32 bits in the inode.</span>
<span class="cm"> * Hence, an &#39;id&#39; in a dquot is 32 bits..</span>
<span class="cm"> */</span>
<span class="k">typedef</span> <span class="n">__uint32_t</span>	<span class="n">xfs_dqid_t</span><span class="p">;</span>

<span class="cm">/*</span>
<span class="cm"> * Even though users may not have quota limits occupying all 64-bits,</span>
<span class="cm"> * they may need 64-bit accounting. Hence, 64-bit quota-counters,</span>
<span class="cm"> * and quota-limits. This is a waste in the common case, but hey ...</span>
<span class="cm"> */</span>
<span class="k">typedef</span> <span class="n">__uint64_t</span>	<span class="n">xfs_qcnt_t</span><span class="p">;</span>
<span class="k">typedef</span> <span class="n">__uint16_t</span>	<span class="n">xfs_qwarncnt_t</span><span class="p">;</span>

<span class="cm">/*</span>
<span class="cm"> * This is the main portion of the on-disk representation of quota</span>
<span class="cm"> * information for a user. This is the q_core of the xfs_dquot_t that</span>
<span class="cm"> * is kept in kernel memory. We pad this with some more expansion room</span>
<span class="cm"> * to construct the on disk structure.</span>
<span class="cm"> */</span>
<span class="k">typedef</span> <span class="k">struct</span>	<span class="n">xfs_disk_dquot</span> <span class="p">{</span>
	<span class="n">__be16</span>		<span class="n">d_magic</span><span class="p">;</span>	<span class="cm">/* dquot magic = XFS_DQUOT_MAGIC */</span>
	<span class="n">__u8</span>		<span class="n">d_version</span><span class="p">;</span>	<span class="cm">/* dquot version */</span>
	<span class="n">__u8</span>		<span class="n">d_flags</span><span class="p">;</span>	<span class="cm">/* XFS_DQ_USER/PROJ/GROUP */</span>
	<span class="n">__be32</span>		<span class="n">d_id</span><span class="p">;</span>		<span class="cm">/* user,project,group id */</span>
	<span class="n">__be64</span>		<span class="n">d_blk_hardlimit</span><span class="p">;</span><span class="cm">/* absolute limit on disk blks */</span>
	<span class="n">__be64</span>		<span class="n">d_blk_softlimit</span><span class="p">;</span><span class="cm">/* preferred limit on disk blks */</span>
	<span class="n">__be64</span>		<span class="n">d_ino_hardlimit</span><span class="p">;</span><span class="cm">/* maximum # allocated inodes */</span>
	<span class="n">__be64</span>		<span class="n">d_ino_softlimit</span><span class="p">;</span><span class="cm">/* preferred inode limit */</span>
	<span class="n">__be64</span>		<span class="n">d_bcount</span><span class="p">;</span>	<span class="cm">/* disk blocks owned by the user */</span>
	<span class="n">__be64</span>		<span class="n">d_icount</span><span class="p">;</span>	<span class="cm">/* inodes owned by the user */</span>
	<span class="n">__be32</span>		<span class="n">d_itimer</span><span class="p">;</span>	<span class="cm">/* zero if within inode limits if not,</span>
<span class="cm">					   this is when we refuse service */</span>
	<span class="n">__be32</span>		<span class="n">d_btimer</span><span class="p">;</span>	<span class="cm">/* similar to above; for disk blocks */</span>
	<span class="n">__be16</span>		<span class="n">d_iwarns</span><span class="p">;</span>	<span class="cm">/* warnings issued wrt num inodes */</span>
	<span class="n">__be16</span>		<span class="n">d_bwarns</span><span class="p">;</span>	<span class="cm">/* warnings issued wrt disk blocks */</span>
	<span class="n">__be32</span>		<span class="n">d_pad0</span><span class="p">;</span>		<span class="cm">/* 64 bit align */</span>
	<span class="n">__be64</span>		<span class="n">d_rtb_hardlimit</span><span class="p">;</span><span class="cm">/* absolute limit on realtime blks */</span>
	<span class="n">__be64</span>		<span class="n">d_rtb_softlimit</span><span class="p">;</span><span class="cm">/* preferred limit on RT disk blks */</span>
	<span class="n">__be64</span>		<span class="n">d_rtbcount</span><span class="p">;</span>	<span class="cm">/* realtime blocks owned */</span>
	<span class="n">__be32</span>		<span class="n">d_rtbtimer</span><span class="p">;</span>	<span class="cm">/* similar to above; for RT disk blocks */</span>
	<span class="n">__be16</span>		<span class="n">d_rtbwarns</span><span class="p">;</span>	<span class="cm">/* warnings issued wrt RT disk blocks */</span>
	<span class="n">__be16</span>		<span class="n">d_pad</span><span class="p">;</span>
<span class="p">}</span> <span class="n">xfs_disk_dquot_t</span><span class="p">;</span>

<span class="cm">/*</span>
<span class="cm"> * This is what goes on disk. This is separated from the xfs_disk_dquot because</span>
<span class="cm"> * carrying the unnecessary padding would be a waste of memory.</span>
<span class="cm"> */</span>
<span class="k">typedef</span> <span class="k">struct</span> <span class="n">xfs_dqblk</span> <span class="p">{</span>
	<span class="n">xfs_disk_dquot_t</span>  <span class="n">dd_diskdq</span><span class="p">;</span>	<span class="cm">/* portion that lives incore as well */</span>
	<span class="kt">char</span>		  <span class="n">dd_fill</span><span class="p">[</span><span class="mi">32</span><span class="p">];</span>	<span class="cm">/* filling for posterity */</span>
<span class="p">}</span> <span class="n">xfs_dqblk_t</span><span class="p">;</span>

<span class="cm">/*</span>
<span class="cm"> * flags for q_flags field in the dquot.</span>
<span class="cm"> */</span>
<span class="cp">#define XFS_DQ_USER		0x0001		</span><span class="cm">/* a user quota */</span><span class="cp"></span>
<span class="cp">#define XFS_DQ_PROJ		0x0002		</span><span class="cm">/* project quota */</span><span class="cp"></span>
<span class="cp">#define XFS_DQ_GROUP		0x0004		</span><span class="cm">/* a group quota */</span><span class="cp"></span>
<span class="cp">#define XFS_DQ_DIRTY		0x0008		</span><span class="cm">/* dquot is dirty */</span><span class="cp"></span>
<span class="cp">#define XFS_DQ_FREEING		0x0010		</span><span class="cm">/* dquot is beeing torn down */</span><span class="cp"></span>

<span class="cp">#define XFS_DQ_ALLTYPES		(XFS_DQ_USER|XFS_DQ_PROJ|XFS_DQ_GROUP)</span>

<span class="cp">#define XFS_DQ_FLAGS \</span>
<span class="cp">	{ XFS_DQ_USER,		&quot;USER&quot; }, \</span>
<span class="cp">	{ XFS_DQ_PROJ,		&quot;PROJ&quot; }, \</span>
<span class="cp">	{ XFS_DQ_GROUP,		&quot;GROUP&quot; }, \</span>
<span class="cp">	{ XFS_DQ_DIRTY,		&quot;DIRTY&quot; }, \</span>
<span class="cp">	{ XFS_DQ_FREEING,	&quot;FREEING&quot; }</span>

<span class="cm">/*</span>
<span class="cm"> * In the worst case, when both user and group quotas are on,</span>
<span class="cm"> * we can have a max of three dquots changing in a single transaction.</span>
<span class="cm"> */</span>
<span class="cp">#define XFS_DQUOT_LOGRES(mp)	(sizeof(xfs_disk_dquot_t) * 3)</span>


<span class="cm">/*</span>
<span class="cm"> * These are the structures used to lay out dquots and quotaoff</span>
<span class="cm"> * records on the log. Quite similar to those of inodes.</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> * log format struct for dquots.</span>
<span class="cm"> * The first two fields must be the type and size fitting into</span>
<span class="cm"> * 32 bits : log_recovery code assumes that.</span>
<span class="cm"> */</span>
<span class="k">typedef</span> <span class="k">struct</span> <span class="n">xfs_dq_logformat</span> <span class="p">{</span>
	<span class="n">__uint16_t</span>		<span class="n">qlf_type</span><span class="p">;</span>      <span class="cm">/* dquot log item type */</span>
	<span class="n">__uint16_t</span>		<span class="n">qlf_size</span><span class="p">;</span>      <span class="cm">/* size of this item */</span>
	<span class="n">xfs_dqid_t</span>		<span class="n">qlf_id</span><span class="p">;</span>	       <span class="cm">/* usr/grp/proj id : 32 bits */</span>
	<span class="n">__int64_t</span>		<span class="n">qlf_blkno</span><span class="p">;</span>     <span class="cm">/* blkno of dquot buffer */</span>
	<span class="n">__int32_t</span>		<span class="n">qlf_len</span><span class="p">;</span>       <span class="cm">/* len of dquot buffer */</span>
	<span class="n">__uint32_t</span>		<span class="n">qlf_boffset</span><span class="p">;</span>   <span class="cm">/* off of dquot in buffer */</span>
<span class="p">}</span> <span class="n">xfs_dq_logformat_t</span><span class="p">;</span>

<span class="cm">/*</span>
<span class="cm"> * log format struct for QUOTAOFF records.</span>
<span class="cm"> * The first two fields must be the type and size fitting into</span>
<span class="cm"> * 32 bits : log_recovery code assumes that.</span>
<span class="cm"> * We write two LI_QUOTAOFF logitems per quotaoff, the last one keeps a pointer</span>
<span class="cm"> * to the first and ensures that the first logitem is taken out of the AIL</span>
<span class="cm"> * only when the last one is securely committed.</span>
<span class="cm"> */</span>
<span class="k">typedef</span> <span class="k">struct</span> <span class="n">xfs_qoff_logformat</span> <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">short</span>		<span class="n">qf_type</span><span class="p">;</span>	<span class="cm">/* quotaoff log item type */</span>
	<span class="kt">unsigned</span> <span class="kt">short</span>		<span class="n">qf_size</span><span class="p">;</span>	<span class="cm">/* size of this item */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>		<span class="n">qf_flags</span><span class="p">;</span>	<span class="cm">/* USR and/or GRP */</span>
	<span class="kt">char</span>			<span class="n">qf_pad</span><span class="p">[</span><span class="mi">12</span><span class="p">];</span>	<span class="cm">/* padding for future */</span>
<span class="p">}</span> <span class="n">xfs_qoff_logformat_t</span><span class="p">;</span>


<span class="cm">/*</span>
<span class="cm"> * Disk quotas status in m_qflags, and also sb_qflags. 16 bits.</span>
<span class="cm"> */</span>
<span class="cp">#define XFS_UQUOTA_ACCT	0x0001  </span><span class="cm">/* user quota accounting ON */</span><span class="cp"></span>
<span class="cp">#define XFS_UQUOTA_ENFD	0x0002  </span><span class="cm">/* user quota limits enforced */</span><span class="cp"></span>
<span class="cp">#define XFS_UQUOTA_CHKD	0x0004  </span><span class="cm">/* quotacheck run on usr quotas */</span><span class="cp"></span>
<span class="cp">#define XFS_PQUOTA_ACCT	0x0008  </span><span class="cm">/* project quota accounting ON */</span><span class="cp"></span>
<span class="cp">#define XFS_OQUOTA_ENFD	0x0010  </span><span class="cm">/* other (grp/prj) quota limits enforced */</span><span class="cp"></span>
<span class="cp">#define XFS_OQUOTA_CHKD	0x0020  </span><span class="cm">/* quotacheck run on other (grp/prj) quotas */</span><span class="cp"></span>
<span class="cp">#define XFS_GQUOTA_ACCT	0x0040  </span><span class="cm">/* group quota accounting ON */</span><span class="cp"></span>

<span class="cm">/*</span>
<span class="cm"> * Quota Accounting/Enforcement flags</span>
<span class="cm"> */</span>
<span class="cp">#define XFS_ALL_QUOTA_ACCT	\</span>
<span class="cp">		(XFS_UQUOTA_ACCT | XFS_GQUOTA_ACCT | XFS_PQUOTA_ACCT)</span>
<span class="cp">#define XFS_ALL_QUOTA_ENFD	(XFS_UQUOTA_ENFD | XFS_OQUOTA_ENFD)</span>
<span class="cp">#define XFS_ALL_QUOTA_CHKD	(XFS_UQUOTA_CHKD | XFS_OQUOTA_CHKD)</span>

<span class="cp">#define XFS_IS_QUOTA_RUNNING(mp)	((mp)-&gt;m_qflags &amp; XFS_ALL_QUOTA_ACCT)</span>
<span class="cp">#define XFS_IS_UQUOTA_RUNNING(mp)	((mp)-&gt;m_qflags &amp; XFS_UQUOTA_ACCT)</span>
<span class="cp">#define XFS_IS_PQUOTA_RUNNING(mp)	((mp)-&gt;m_qflags &amp; XFS_PQUOTA_ACCT)</span>
<span class="cp">#define XFS_IS_GQUOTA_RUNNING(mp)	((mp)-&gt;m_qflags &amp; XFS_GQUOTA_ACCT)</span>
<span class="cp">#define XFS_IS_UQUOTA_ENFORCED(mp)	((mp)-&gt;m_qflags &amp; XFS_UQUOTA_ENFD)</span>
<span class="cp">#define XFS_IS_OQUOTA_ENFORCED(mp)	((mp)-&gt;m_qflags &amp; XFS_OQUOTA_ENFD)</span>

<span class="cm">/*</span>
<span class="cm"> * Incore only flags for quotaoff - these bits get cleared when quota(s)</span>
<span class="cm"> * are in the process of getting turned off. These flags are in m_qflags but</span>
<span class="cm"> * never in sb_qflags.</span>
<span class="cm"> */</span>
<span class="cp">#define XFS_UQUOTA_ACTIVE	0x0100  </span><span class="cm">/* uquotas are being turned off */</span><span class="cp"></span>
<span class="cp">#define XFS_PQUOTA_ACTIVE	0x0200  </span><span class="cm">/* pquotas are being turned off */</span><span class="cp"></span>
<span class="cp">#define XFS_GQUOTA_ACTIVE	0x0400  </span><span class="cm">/* gquotas are being turned off */</span><span class="cp"></span>
<span class="cp">#define XFS_ALL_QUOTA_ACTIVE	\</span>
<span class="cp">	(XFS_UQUOTA_ACTIVE | XFS_PQUOTA_ACTIVE | XFS_GQUOTA_ACTIVE)</span>

<span class="cm">/*</span>
<span class="cm"> * Checking XFS_IS_*QUOTA_ON() while holding any inode lock guarantees</span>
<span class="cm"> * quota will be not be switched off as long as that inode lock is held.</span>
<span class="cm"> */</span>
<span class="cp">#define XFS_IS_QUOTA_ON(mp)	((mp)-&gt;m_qflags &amp; (XFS_UQUOTA_ACTIVE | \</span>
<span class="cp">						   XFS_GQUOTA_ACTIVE | \</span>
<span class="cp">						   XFS_PQUOTA_ACTIVE))</span>
<span class="cp">#define XFS_IS_OQUOTA_ON(mp)	((mp)-&gt;m_qflags &amp; (XFS_GQUOTA_ACTIVE | \</span>
<span class="cp">						   XFS_PQUOTA_ACTIVE))</span>
<span class="cp">#define XFS_IS_UQUOTA_ON(mp)	((mp)-&gt;m_qflags &amp; XFS_UQUOTA_ACTIVE)</span>
<span class="cp">#define XFS_IS_GQUOTA_ON(mp)	((mp)-&gt;m_qflags &amp; XFS_GQUOTA_ACTIVE)</span>
<span class="cp">#define XFS_IS_PQUOTA_ON(mp)	((mp)-&gt;m_qflags &amp; XFS_PQUOTA_ACTIVE)</span>

<span class="cm">/*</span>
<span class="cm"> * Flags to tell various functions what to do. Not all of these are meaningful</span>
<span class="cm"> * to a single function. None of these XFS_QMOPT_* flags are meant to have</span>
<span class="cm"> * persistent values (ie. their values can and will change between versions)</span>
<span class="cm"> */</span>
<span class="cp">#define XFS_QMOPT_DQALLOC	0x0000002 </span><span class="cm">/* alloc dquot ondisk if needed */</span><span class="cp"></span>
<span class="cp">#define XFS_QMOPT_UQUOTA	0x0000004 </span><span class="cm">/* user dquot requested */</span><span class="cp"></span>
<span class="cp">#define XFS_QMOPT_PQUOTA	0x0000008 </span><span class="cm">/* project dquot requested */</span><span class="cp"></span>
<span class="cp">#define XFS_QMOPT_FORCE_RES	0x0000010 </span><span class="cm">/* ignore quota limits */</span><span class="cp"></span>
<span class="cp">#define XFS_QMOPT_SBVERSION	0x0000040 </span><span class="cm">/* change superblock version num */</span><span class="cp"></span>
<span class="cp">#define XFS_QMOPT_DOWARN        0x0000400 </span><span class="cm">/* increase warning cnt if needed */</span><span class="cp"></span>
<span class="cp">#define XFS_QMOPT_DQREPAIR	0x0001000 </span><span class="cm">/* repair dquot if damaged */</span><span class="cp"></span>
<span class="cp">#define XFS_QMOPT_GQUOTA	0x0002000 </span><span class="cm">/* group dquot requested */</span><span class="cp"></span>
<span class="cp">#define XFS_QMOPT_ENOSPC	0x0004000 </span><span class="cm">/* enospc instead of edquot (prj) */</span><span class="cp"></span>

<span class="cm">/*</span>
<span class="cm"> * flags to xfs_trans_mod_dquot to indicate which field needs to be</span>
<span class="cm"> * modified.</span>
<span class="cm"> */</span>
<span class="cp">#define XFS_QMOPT_RES_REGBLKS	0x0010000</span>
<span class="cp">#define XFS_QMOPT_RES_RTBLKS	0x0020000</span>
<span class="cp">#define XFS_QMOPT_BCOUNT	0x0040000</span>
<span class="cp">#define XFS_QMOPT_ICOUNT	0x0080000</span>
<span class="cp">#define XFS_QMOPT_RTBCOUNT	0x0100000</span>
<span class="cp">#define XFS_QMOPT_DELBCOUNT	0x0200000</span>
<span class="cp">#define XFS_QMOPT_DELRTBCOUNT	0x0400000</span>
<span class="cp">#define XFS_QMOPT_RES_INOS	0x0800000</span>

<span class="cm">/*</span>
<span class="cm"> * flags for dqalloc.</span>
<span class="cm"> */</span>
<span class="cp">#define XFS_QMOPT_INHERIT	0x1000000</span>

<span class="cm">/*</span>
<span class="cm"> * flags to xfs_trans_mod_dquot.</span>
<span class="cm"> */</span>
<span class="cp">#define XFS_TRANS_DQ_RES_BLKS	XFS_QMOPT_RES_REGBLKS</span>
<span class="cp">#define XFS_TRANS_DQ_RES_RTBLKS	XFS_QMOPT_RES_RTBLKS</span>
<span class="cp">#define XFS_TRANS_DQ_RES_INOS	XFS_QMOPT_RES_INOS</span>
<span class="cp">#define XFS_TRANS_DQ_BCOUNT	XFS_QMOPT_BCOUNT</span>
<span class="cp">#define XFS_TRANS_DQ_DELBCOUNT	XFS_QMOPT_DELBCOUNT</span>
<span class="cp">#define XFS_TRANS_DQ_ICOUNT	XFS_QMOPT_ICOUNT</span>
<span class="cp">#define XFS_TRANS_DQ_RTBCOUNT	XFS_QMOPT_RTBCOUNT</span>
<span class="cp">#define XFS_TRANS_DQ_DELRTBCOUNT XFS_QMOPT_DELRTBCOUNT</span>


<span class="cp">#define XFS_QMOPT_QUOTALL	\</span>
<span class="cp">		(XFS_QMOPT_UQUOTA | XFS_QMOPT_PQUOTA | XFS_QMOPT_GQUOTA)</span>
<span class="cp">#define XFS_QMOPT_RESBLK_MASK	(XFS_QMOPT_RES_REGBLKS | XFS_QMOPT_RES_RTBLKS)</span>

<span class="cp">#ifdef __KERNEL__</span>
<span class="cm">/*</span>
<span class="cm"> * This check is done typically without holding the inode lock;</span>
<span class="cm"> * that may seem racy, but it is harmless in the context that it is used.</span>
<span class="cm"> * The inode cannot go inactive as long a reference is kept, and</span>
<span class="cm"> * therefore if dquot(s) were attached, they&#39;ll stay consistent.</span>
<span class="cm"> * If, for example, the ownership of the inode changes while</span>
<span class="cm"> * we didn&#39;t have the inode locked, the appropriate dquot(s) will be</span>
<span class="cm"> * attached atomically.</span>
<span class="cm"> */</span>
<span class="cp">#define XFS_NOT_DQATTACHED(mp, ip) ((XFS_IS_UQUOTA_ON(mp) &amp;&amp;\</span>
<span class="cp">				     (ip)-&gt;i_udquot == NULL) || \</span>
<span class="cp">				    (XFS_IS_OQUOTA_ON(mp) &amp;&amp; \</span>
<span class="cp">				     (ip)-&gt;i_gdquot == NULL))</span>

<span class="cp">#define XFS_QM_NEED_QUOTACHECK(mp) \</span>
<span class="cp">	((XFS_IS_UQUOTA_ON(mp) &amp;&amp; \</span>
<span class="cp">		(mp-&gt;m_sb.sb_qflags &amp; XFS_UQUOTA_CHKD) == 0) || \</span>
<span class="cp">	 (XFS_IS_GQUOTA_ON(mp) &amp;&amp; \</span>
<span class="cp">		((mp-&gt;m_sb.sb_qflags &amp; XFS_OQUOTA_CHKD) == 0 || \</span>
<span class="cp">		 (mp-&gt;m_sb.sb_qflags &amp; XFS_PQUOTA_ACCT))) || \</span>
<span class="cp">	 (XFS_IS_PQUOTA_ON(mp) &amp;&amp; \</span>
<span class="cp">		((mp-&gt;m_sb.sb_qflags &amp; XFS_OQUOTA_CHKD) == 0 || \</span>
<span class="cp">		 (mp-&gt;m_sb.sb_qflags &amp; XFS_GQUOTA_ACCT))))</span>

<span class="cp">#define XFS_MOUNT_QUOTA_SET1	(XFS_UQUOTA_ACCT|XFS_UQUOTA_ENFD|\</span>
<span class="cp">				 XFS_UQUOTA_CHKD|XFS_PQUOTA_ACCT|\</span>
<span class="cp">				 XFS_OQUOTA_ENFD|XFS_OQUOTA_CHKD)</span>

<span class="cp">#define XFS_MOUNT_QUOTA_SET2	(XFS_UQUOTA_ACCT|XFS_UQUOTA_ENFD|\</span>
<span class="cp">				 XFS_UQUOTA_CHKD|XFS_GQUOTA_ACCT|\</span>
<span class="cp">				 XFS_OQUOTA_ENFD|XFS_OQUOTA_CHKD)</span>

<span class="cp">#define XFS_MOUNT_QUOTA_ALL	(XFS_UQUOTA_ACCT|XFS_UQUOTA_ENFD|\</span>
<span class="cp">				 XFS_UQUOTA_CHKD|XFS_PQUOTA_ACCT|\</span>
<span class="cp">				 XFS_OQUOTA_ENFD|XFS_OQUOTA_CHKD|\</span>
<span class="cp">				 XFS_GQUOTA_ACCT)</span>


<span class="cm">/*</span>
<span class="cm"> * The structure kept inside the xfs_trans_t keep track of dquot changes</span>
<span class="cm"> * within a transaction and apply them later.</span>
<span class="cm"> */</span>
<span class="k">typedef</span> <span class="k">struct</span> <span class="n">xfs_dqtrx</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">xfs_dquot</span> <span class="o">*</span><span class="n">qt_dquot</span><span class="p">;</span>	  <span class="cm">/* the dquot this refers to */</span>
	<span class="n">ulong</span>		<span class="n">qt_blk_res</span><span class="p">;</span>	  <span class="cm">/* blks reserved on a dquot */</span>
	<span class="n">ulong</span>		<span class="n">qt_blk_res_used</span><span class="p">;</span>  <span class="cm">/* blks used from the reservation */</span>
	<span class="n">ulong</span>		<span class="n">qt_ino_res</span><span class="p">;</span>	  <span class="cm">/* inode reserved on a dquot */</span>
	<span class="n">ulong</span>		<span class="n">qt_ino_res_used</span><span class="p">;</span>  <span class="cm">/* inodes used from the reservation */</span>
	<span class="kt">long</span>		<span class="n">qt_bcount_delta</span><span class="p">;</span>  <span class="cm">/* dquot blk count changes */</span>
	<span class="kt">long</span>		<span class="n">qt_delbcnt_delta</span><span class="p">;</span> <span class="cm">/* delayed dquot blk count changes */</span>
	<span class="kt">long</span>		<span class="n">qt_icount_delta</span><span class="p">;</span>  <span class="cm">/* dquot inode count changes */</span>
	<span class="n">ulong</span>		<span class="n">qt_rtblk_res</span><span class="p">;</span>	  <span class="cm">/* # blks reserved on a dquot */</span>
	<span class="n">ulong</span>		<span class="n">qt_rtblk_res_used</span><span class="p">;</span><span class="cm">/* # blks used from reservation */</span>
	<span class="kt">long</span>		<span class="n">qt_rtbcount_delta</span><span class="p">;</span><span class="cm">/* dquot realtime blk changes */</span>
	<span class="kt">long</span>		<span class="n">qt_delrtb_delta</span><span class="p">;</span>  <span class="cm">/* delayed RT blk count changes */</span>
<span class="p">}</span> <span class="n">xfs_dqtrx_t</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_XFS_QUOTA</span>
<span class="k">extern</span> <span class="kt">void</span> <span class="n">xfs_trans_dup_dqinfo</span><span class="p">(</span><span class="k">struct</span> <span class="n">xfs_trans</span> <span class="o">*</span><span class="p">,</span> <span class="k">struct</span> <span class="n">xfs_trans</span> <span class="o">*</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">void</span> <span class="n">xfs_trans_free_dqinfo</span><span class="p">(</span><span class="k">struct</span> <span class="n">xfs_trans</span> <span class="o">*</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">void</span> <span class="n">xfs_trans_mod_dquot_byino</span><span class="p">(</span><span class="k">struct</span> <span class="n">xfs_trans</span> <span class="o">*</span><span class="p">,</span> <span class="k">struct</span> <span class="n">xfs_inode</span> <span class="o">*</span><span class="p">,</span>
		<span class="n">uint</span><span class="p">,</span> <span class="kt">long</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">void</span> <span class="n">xfs_trans_apply_dquot_deltas</span><span class="p">(</span><span class="k">struct</span> <span class="n">xfs_trans</span> <span class="o">*</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">void</span> <span class="n">xfs_trans_unreserve_and_mod_dquots</span><span class="p">(</span><span class="k">struct</span> <span class="n">xfs_trans</span> <span class="o">*</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">int</span> <span class="n">xfs_trans_reserve_quota_nblks</span><span class="p">(</span><span class="k">struct</span> <span class="n">xfs_trans</span> <span class="o">*</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">xfs_inode</span> <span class="o">*</span><span class="p">,</span> <span class="kt">long</span><span class="p">,</span> <span class="kt">long</span><span class="p">,</span> <span class="n">uint</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">int</span> <span class="n">xfs_trans_reserve_quota_bydquots</span><span class="p">(</span><span class="k">struct</span> <span class="n">xfs_trans</span> <span class="o">*</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">xfs_mount</span> <span class="o">*</span><span class="p">,</span> <span class="k">struct</span> <span class="n">xfs_dquot</span> <span class="o">*</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">xfs_dquot</span> <span class="o">*</span><span class="p">,</span> <span class="kt">long</span><span class="p">,</span> <span class="kt">long</span><span class="p">,</span> <span class="n">uint</span><span class="p">);</span>

<span class="k">extern</span> <span class="kt">int</span> <span class="n">xfs_qm_vop_dqalloc</span><span class="p">(</span><span class="k">struct</span> <span class="n">xfs_inode</span> <span class="o">*</span><span class="p">,</span> <span class="n">uid_t</span><span class="p">,</span> <span class="n">gid_t</span><span class="p">,</span> <span class="n">prid_t</span><span class="p">,</span> <span class="n">uint</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">xfs_dquot</span> <span class="o">**</span><span class="p">,</span> <span class="k">struct</span> <span class="n">xfs_dquot</span> <span class="o">**</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">void</span> <span class="n">xfs_qm_vop_create_dqattach</span><span class="p">(</span><span class="k">struct</span> <span class="n">xfs_trans</span> <span class="o">*</span><span class="p">,</span> <span class="k">struct</span> <span class="n">xfs_inode</span> <span class="o">*</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">xfs_dquot</span> <span class="o">*</span><span class="p">,</span> <span class="k">struct</span> <span class="n">xfs_dquot</span> <span class="o">*</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">int</span> <span class="n">xfs_qm_vop_rename_dqattach</span><span class="p">(</span><span class="k">struct</span> <span class="n">xfs_inode</span> <span class="o">**</span><span class="p">);</span>
<span class="k">extern</span> <span class="k">struct</span> <span class="n">xfs_dquot</span> <span class="o">*</span><span class="n">xfs_qm_vop_chown</span><span class="p">(</span><span class="k">struct</span> <span class="n">xfs_trans</span> <span class="o">*</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">xfs_inode</span> <span class="o">*</span><span class="p">,</span> <span class="k">struct</span> <span class="n">xfs_dquot</span> <span class="o">**</span><span class="p">,</span> <span class="k">struct</span> <span class="n">xfs_dquot</span> <span class="o">*</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">int</span> <span class="n">xfs_qm_vop_chown_reserve</span><span class="p">(</span><span class="k">struct</span> <span class="n">xfs_trans</span> <span class="o">*</span><span class="p">,</span> <span class="k">struct</span> <span class="n">xfs_inode</span> <span class="o">*</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">xfs_dquot</span> <span class="o">*</span><span class="p">,</span> <span class="k">struct</span> <span class="n">xfs_dquot</span> <span class="o">*</span><span class="p">,</span> <span class="n">uint</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">int</span> <span class="n">xfs_qm_dqattach</span><span class="p">(</span><span class="k">struct</span> <span class="n">xfs_inode</span> <span class="o">*</span><span class="p">,</span> <span class="n">uint</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">int</span> <span class="n">xfs_qm_dqattach_locked</span><span class="p">(</span><span class="k">struct</span> <span class="n">xfs_inode</span> <span class="o">*</span><span class="p">,</span> <span class="n">uint</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">void</span> <span class="n">xfs_qm_dqdetach</span><span class="p">(</span><span class="k">struct</span> <span class="n">xfs_inode</span> <span class="o">*</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">void</span> <span class="n">xfs_qm_dqrele</span><span class="p">(</span><span class="k">struct</span> <span class="n">xfs_dquot</span> <span class="o">*</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">void</span> <span class="n">xfs_qm_statvfs</span><span class="p">(</span><span class="k">struct</span> <span class="n">xfs_inode</span> <span class="o">*</span><span class="p">,</span> <span class="k">struct</span> <span class="n">kstatfs</span> <span class="o">*</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">int</span> <span class="n">xfs_qm_newmount</span><span class="p">(</span><span class="k">struct</span> <span class="n">xfs_mount</span> <span class="o">*</span><span class="p">,</span> <span class="n">uint</span> <span class="o">*</span><span class="p">,</span> <span class="n">uint</span> <span class="o">*</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">void</span> <span class="n">xfs_qm_mount_quotas</span><span class="p">(</span><span class="k">struct</span> <span class="n">xfs_mount</span> <span class="o">*</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">void</span> <span class="n">xfs_qm_unmount</span><span class="p">(</span><span class="k">struct</span> <span class="n">xfs_mount</span> <span class="o">*</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">void</span> <span class="n">xfs_qm_unmount_quotas</span><span class="p">(</span><span class="k">struct</span> <span class="n">xfs_mount</span> <span class="o">*</span><span class="p">);</span>

<span class="cp">#else</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span>
<span class="nf">xfs_qm_vop_dqalloc</span><span class="p">(</span><span class="k">struct</span> <span class="n">xfs_inode</span> <span class="o">*</span><span class="n">ip</span><span class="p">,</span> <span class="n">uid_t</span> <span class="n">uid</span><span class="p">,</span> <span class="n">gid_t</span> <span class="n">gid</span><span class="p">,</span> <span class="n">prid_t</span> <span class="n">prid</span><span class="p">,</span>
		<span class="n">uint</span> <span class="n">flags</span><span class="p">,</span> <span class="k">struct</span> <span class="n">xfs_dquot</span> <span class="o">**</span><span class="n">udqp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">xfs_dquot</span> <span class="o">**</span><span class="n">gdqp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="o">*</span><span class="n">udqp</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="o">*</span><span class="n">gdqp</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#define xfs_trans_dup_dqinfo(tp, tp2)</span>
<span class="cp">#define xfs_trans_free_dqinfo(tp)</span>
<span class="cp">#define xfs_trans_mod_dquot_byino(tp, ip, fields, delta)</span>
<span class="cp">#define xfs_trans_apply_dquot_deltas(tp)</span>
<span class="cp">#define xfs_trans_unreserve_and_mod_dquots(tp)</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">xfs_trans_reserve_quota_nblks</span><span class="p">(</span><span class="k">struct</span> <span class="n">xfs_trans</span> <span class="o">*</span><span class="n">tp</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">xfs_inode</span> <span class="o">*</span><span class="n">ip</span><span class="p">,</span> <span class="kt">long</span> <span class="n">nblks</span><span class="p">,</span> <span class="kt">long</span> <span class="n">ninos</span><span class="p">,</span> <span class="n">uint</span> <span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">xfs_trans_reserve_quota_bydquots</span><span class="p">(</span><span class="k">struct</span> <span class="n">xfs_trans</span> <span class="o">*</span><span class="n">tp</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">xfs_mount</span> <span class="o">*</span><span class="n">mp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">xfs_dquot</span> <span class="o">*</span><span class="n">udqp</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">xfs_dquot</span> <span class="o">*</span><span class="n">gdqp</span><span class="p">,</span> <span class="kt">long</span> <span class="n">nblks</span><span class="p">,</span> <span class="kt">long</span> <span class="n">nions</span><span class="p">,</span> <span class="n">uint</span> <span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#define xfs_qm_vop_create_dqattach(tp, ip, u, g)</span>
<span class="cp">#define xfs_qm_vop_rename_dqattach(it)					(0)</span>
<span class="cp">#define xfs_qm_vop_chown(tp, ip, old, new)				(NULL)</span>
<span class="cp">#define xfs_qm_vop_chown_reserve(tp, ip, u, g, fl)			(0)</span>
<span class="cp">#define xfs_qm_dqattach(ip, fl)						(0)</span>
<span class="cp">#define xfs_qm_dqattach_locked(ip, fl)					(0)</span>
<span class="cp">#define xfs_qm_dqdetach(ip)</span>
<span class="cp">#define xfs_qm_dqrele(d)</span>
<span class="cp">#define xfs_qm_statvfs(ip, s)</span>
<span class="cp">#define xfs_qm_newmount(mp, a, b)					(0)</span>
<span class="cp">#define xfs_qm_mount_quotas(mp)</span>
<span class="cp">#define xfs_qm_unmount(mp)</span>
<span class="cp">#define xfs_qm_unmount_quotas(mp)</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_XFS_QUOTA */</span><span class="cp"></span>

<span class="cp">#define xfs_trans_unreserve_quota_nblks(tp, ip, nblks, ninos, flags) \</span>
<span class="cp">	xfs_trans_reserve_quota_nblks(tp, ip, -(nblks), -(ninos), flags)</span>
<span class="cp">#define xfs_trans_reserve_quota(tp, mp, ud, gd, nb, ni, f) \</span>
<span class="cp">	xfs_trans_reserve_quota_bydquots(tp, mp, ud, gd, nb, ni, \</span>
<span class="cp">				f | XFS_QMOPT_RES_REGBLKS)</span>

<span class="k">extern</span> <span class="kt">int</span> <span class="n">xfs_qm_dqcheck</span><span class="p">(</span><span class="k">struct</span> <span class="n">xfs_mount</span> <span class="o">*</span><span class="p">,</span> <span class="n">xfs_disk_dquot_t</span> <span class="o">*</span><span class="p">,</span>
				<span class="n">xfs_dqid_t</span><span class="p">,</span> <span class="n">uint</span><span class="p">,</span> <span class="n">uint</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">int</span> <span class="n">xfs_mount_reset_sbqflags</span><span class="p">(</span><span class="k">struct</span> <span class="n">xfs_mount</span> <span class="o">*</span><span class="p">);</span>

<span class="cp">#endif	</span><span class="cm">/* __KERNEL__ */</span><span class="cp"></span>
<span class="cp">#endif	</span><span class="cm">/* __XFS_QUOTA_H__ */</span><span class="cp"></span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
