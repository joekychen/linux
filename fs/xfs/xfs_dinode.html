<!DOCTYPE html>
<html><head><title>joekychen/linux » fs › xfs › xfs_dinode.h

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>xfs_dinode.h</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Copyright (c) 2000,2002,2005 Silicon Graphics, Inc.</span>
<span class="cm"> * All Rights Reserved.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or</span>
<span class="cm"> * modify it under the terms of the GNU General Public License as</span>
<span class="cm"> * published by the Free Software Foundation.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is distributed in the hope that it would be useful,</span>
<span class="cm"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm"> * GNU General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> * You should have received a copy of the GNU General Public License</span>
<span class="cm"> * along with this program; if not, write the Free Software Foundation,</span>
<span class="cm"> * Inc.,  51 Franklin St, Fifth Floor, Boston, MA  02110-1301  USA</span>
<span class="cm"> */</span>
<span class="cp">#ifndef __XFS_DINODE_H__</span>
<span class="cp">#define	__XFS_DINODE_H__</span>

<span class="cp">#define	XFS_DINODE_MAGIC		0x494e	</span><span class="cm">/* &#39;IN&#39; */</span><span class="cp"></span>
<span class="cp">#define XFS_DINODE_GOOD_VERSION(v)	(((v) == 1 || (v) == 2))</span>

<span class="k">typedef</span> <span class="k">struct</span> <span class="n">xfs_timestamp</span> <span class="p">{</span>
	<span class="n">__be32</span>		<span class="n">t_sec</span><span class="p">;</span>		<span class="cm">/* timestamp seconds */</span>
	<span class="n">__be32</span>		<span class="n">t_nsec</span><span class="p">;</span>		<span class="cm">/* timestamp nanoseconds */</span>
<span class="p">}</span> <span class="n">xfs_timestamp_t</span><span class="p">;</span>

<span class="cm">/*</span>
<span class="cm"> * On-disk inode structure.</span>
<span class="cm"> *</span>
<span class="cm"> * This is just the header or &quot;dinode core&quot;, the inode is expanded to fill a</span>
<span class="cm"> * variable size the leftover area split into a data and an attribute fork.</span>
<span class="cm"> * The format of the data and attribute fork depends on the format of the</span>
<span class="cm"> * inode as indicated by di_format and di_aformat.  To access the data and</span>
<span class="cm"> * attribute use the XFS_DFORK_PTR, XFS_DFORK_DPTR, and XFS_DFORK_PTR macros</span>
<span class="cm"> * below.</span>
<span class="cm"> *</span>
<span class="cm"> * There is a very similar struct icdinode in xfs_inode which matches the</span>
<span class="cm"> * layout of the first 96 bytes of this structure, but is kept in native</span>
<span class="cm"> * format instead of big endian.</span>
<span class="cm"> */</span>
<span class="k">typedef</span> <span class="k">struct</span> <span class="n">xfs_dinode</span> <span class="p">{</span>
	<span class="n">__be16</span>		<span class="n">di_magic</span><span class="p">;</span>	<span class="cm">/* inode magic # = XFS_DINODE_MAGIC */</span>
	<span class="n">__be16</span>		<span class="n">di_mode</span><span class="p">;</span>	<span class="cm">/* mode and type of file */</span>
	<span class="n">__u8</span>		<span class="n">di_version</span><span class="p">;</span>	<span class="cm">/* inode version */</span>
	<span class="n">__u8</span>		<span class="n">di_format</span><span class="p">;</span>	<span class="cm">/* format of di_c data */</span>
	<span class="n">__be16</span>		<span class="n">di_onlink</span><span class="p">;</span>	<span class="cm">/* old number of links to file */</span>
	<span class="n">__be32</span>		<span class="n">di_uid</span><span class="p">;</span>		<span class="cm">/* owner&#39;s user id */</span>
	<span class="n">__be32</span>		<span class="n">di_gid</span><span class="p">;</span>		<span class="cm">/* owner&#39;s group id */</span>
	<span class="n">__be32</span>		<span class="n">di_nlink</span><span class="p">;</span>	<span class="cm">/* number of links to file */</span>
	<span class="n">__be16</span>		<span class="n">di_projid_lo</span><span class="p">;</span>	<span class="cm">/* lower part of owner&#39;s project id */</span>
	<span class="n">__be16</span>		<span class="n">di_projid_hi</span><span class="p">;</span>	<span class="cm">/* higher part owner&#39;s project id */</span>
	<span class="n">__u8</span>		<span class="n">di_pad</span><span class="p">[</span><span class="mi">6</span><span class="p">];</span>	<span class="cm">/* unused, zeroed space */</span>
	<span class="n">__be16</span>		<span class="n">di_flushiter</span><span class="p">;</span>	<span class="cm">/* incremented on flush */</span>
	<span class="n">xfs_timestamp_t</span>	<span class="n">di_atime</span><span class="p">;</span>	<span class="cm">/* time last accessed */</span>
	<span class="n">xfs_timestamp_t</span>	<span class="n">di_mtime</span><span class="p">;</span>	<span class="cm">/* time last modified */</span>
	<span class="n">xfs_timestamp_t</span>	<span class="n">di_ctime</span><span class="p">;</span>	<span class="cm">/* time created/inode modified */</span>
	<span class="n">__be64</span>		<span class="n">di_size</span><span class="p">;</span>	<span class="cm">/* number of bytes in file */</span>
	<span class="n">__be64</span>		<span class="n">di_nblocks</span><span class="p">;</span>	<span class="cm">/* # of direct &amp; btree blocks used */</span>
	<span class="n">__be32</span>		<span class="n">di_extsize</span><span class="p">;</span>	<span class="cm">/* basic/minimum extent size for file */</span>
	<span class="n">__be32</span>		<span class="n">di_nextents</span><span class="p">;</span>	<span class="cm">/* number of extents in data fork */</span>
	<span class="n">__be16</span>		<span class="n">di_anextents</span><span class="p">;</span>	<span class="cm">/* number of extents in attribute fork*/</span>
	<span class="n">__u8</span>		<span class="n">di_forkoff</span><span class="p">;</span>	<span class="cm">/* attr fork offs, &lt;&lt;3 for 64b align */</span>
	<span class="n">__s8</span>		<span class="n">di_aformat</span><span class="p">;</span>	<span class="cm">/* format of attr fork&#39;s data */</span>
	<span class="n">__be32</span>		<span class="n">di_dmevmask</span><span class="p">;</span>	<span class="cm">/* DMIG event mask */</span>
	<span class="n">__be16</span>		<span class="n">di_dmstate</span><span class="p">;</span>	<span class="cm">/* DMIG state info */</span>
	<span class="n">__be16</span>		<span class="n">di_flags</span><span class="p">;</span>	<span class="cm">/* random flags, XFS_DIFLAG_... */</span>
	<span class="n">__be32</span>		<span class="n">di_gen</span><span class="p">;</span>		<span class="cm">/* generation number */</span>

	<span class="cm">/* di_next_unlinked is the only non-core field in the old dinode */</span>
	<span class="n">__be32</span>		<span class="n">di_next_unlinked</span><span class="p">;</span><span class="cm">/* agi unlinked list ptr */</span>
<span class="p">}</span> <span class="n">__attribute__</span><span class="p">((</span><span class="n">packed</span><span class="p">))</span> <span class="n">xfs_dinode_t</span><span class="p">;</span>

<span class="cp">#define DI_MAX_FLUSH 0xffff</span>

<span class="cm">/*</span>
<span class="cm"> * The 32 bit link count in the inode theoretically maxes out at UINT_MAX.</span>
<span class="cm"> * Since the pathconf interface is signed, we use 2^31 - 1 instead.</span>
<span class="cm"> * The old inode format had a 16 bit link count, so its maximum is USHRT_MAX.</span>
<span class="cm"> */</span>
<span class="cp">#define	XFS_MAXLINK		((1U &lt;&lt; 31) - 1U)</span>
<span class="cp">#define	XFS_MAXLINK_1		65535U</span>

<span class="cm">/*</span>
<span class="cm"> * Values for di_format</span>
<span class="cm"> */</span>
<span class="k">typedef</span> <span class="k">enum</span> <span class="n">xfs_dinode_fmt</span> <span class="p">{</span>
	<span class="n">XFS_DINODE_FMT_DEV</span><span class="p">,</span>		<span class="cm">/* xfs_dev_t */</span>
	<span class="n">XFS_DINODE_FMT_LOCAL</span><span class="p">,</span>		<span class="cm">/* bulk data */</span>
	<span class="n">XFS_DINODE_FMT_EXTENTS</span><span class="p">,</span>		<span class="cm">/* struct xfs_bmbt_rec */</span>
	<span class="n">XFS_DINODE_FMT_BTREE</span><span class="p">,</span>		<span class="cm">/* struct xfs_bmdr_block */</span>
	<span class="n">XFS_DINODE_FMT_UUID</span>		<span class="cm">/* uuid_t */</span>
<span class="p">}</span> <span class="n">xfs_dinode_fmt_t</span><span class="p">;</span>

<span class="cm">/*</span>
<span class="cm"> * Inode minimum and maximum sizes.</span>
<span class="cm"> */</span>
<span class="cp">#define	XFS_DINODE_MIN_LOG	8</span>
<span class="cp">#define	XFS_DINODE_MAX_LOG	11</span>
<span class="cp">#define	XFS_DINODE_MIN_SIZE	(1 &lt;&lt; XFS_DINODE_MIN_LOG)</span>
<span class="cp">#define	XFS_DINODE_MAX_SIZE	(1 &lt;&lt; XFS_DINODE_MAX_LOG)</span>

<span class="cm">/*</span>
<span class="cm"> * Inode size for given fs.</span>
<span class="cm"> */</span>
<span class="cp">#define XFS_LITINO(mp) \</span>
<span class="cp">	((int)(((mp)-&gt;m_sb.sb_inodesize) - sizeof(struct xfs_dinode)))</span>

<span class="cp">#define	XFS_BROOT_SIZE_ADJ	\</span>
<span class="cp">	(XFS_BTREE_LBLOCK_LEN - sizeof(xfs_bmdr_block_t))</span>

<span class="cm">/*</span>
<span class="cm"> * Inode data &amp; attribute fork sizes, per inode.</span>
<span class="cm"> */</span>
<span class="cp">#define XFS_DFORK_Q(dip)		((dip)-&gt;di_forkoff != 0)</span>
<span class="cp">#define XFS_DFORK_BOFF(dip)		((int)((dip)-&gt;di_forkoff &lt;&lt; 3))</span>

<span class="cp">#define XFS_DFORK_DSIZE(dip,mp) \</span>
<span class="cp">	(XFS_DFORK_Q(dip) ? \</span>
<span class="cp">		XFS_DFORK_BOFF(dip) : \</span>
<span class="cp">		XFS_LITINO(mp))</span>
<span class="cp">#define XFS_DFORK_ASIZE(dip,mp) \</span>
<span class="cp">	(XFS_DFORK_Q(dip) ? \</span>
<span class="cp">		XFS_LITINO(mp) - XFS_DFORK_BOFF(dip) : \</span>
<span class="cp">		0)</span>
<span class="cp">#define XFS_DFORK_SIZE(dip,mp,w) \</span>
<span class="cp">	((w) == XFS_DATA_FORK ? \</span>
<span class="cp">		XFS_DFORK_DSIZE(dip, mp) : \</span>
<span class="cp">		XFS_DFORK_ASIZE(dip, mp))</span>

<span class="cm">/*</span>
<span class="cm"> * Return pointers to the data or attribute forks.</span>
<span class="cm"> */</span>
<span class="cp">#define XFS_DFORK_DPTR(dip) \</span>
<span class="cp">	((char *)(dip) + sizeof(struct xfs_dinode))</span>
<span class="cp">#define XFS_DFORK_APTR(dip)	\</span>
<span class="cp">	(XFS_DFORK_DPTR(dip) + XFS_DFORK_BOFF(dip))</span>
<span class="cp">#define XFS_DFORK_PTR(dip,w)	\</span>
<span class="cp">	((w) == XFS_DATA_FORK ? XFS_DFORK_DPTR(dip) : XFS_DFORK_APTR(dip))</span>

<span class="cp">#define XFS_DFORK_FORMAT(dip,w) \</span>
<span class="cp">	((w) == XFS_DATA_FORK ? \</span>
<span class="cp">		(dip)-&gt;di_format : \</span>
<span class="cp">		(dip)-&gt;di_aformat)</span>
<span class="cp">#define XFS_DFORK_NEXTENTS(dip,w) \</span>
<span class="cp">	((w) == XFS_DATA_FORK ? \</span>
<span class="cp">		be32_to_cpu((dip)-&gt;di_nextents) : \</span>
<span class="cp">		be16_to_cpu((dip)-&gt;di_anextents))</span>

<span class="cp">#define	XFS_BUF_TO_DINODE(bp)	((xfs_dinode_t *)((bp)-&gt;b_addr))</span>

<span class="cm">/*</span>
<span class="cm"> * For block and character special files the 32bit dev_t is stored at the</span>
<span class="cm"> * beginning of the data fork.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="n">xfs_dev_t</span> <span class="nf">xfs_dinode_get_rdev</span><span class="p">(</span><span class="k">struct</span> <span class="n">xfs_dinode</span> <span class="o">*</span><span class="n">dip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">__be32</span> <span class="o">*</span><span class="p">)</span><span class="n">XFS_DFORK_DPTR</span><span class="p">(</span><span class="n">dip</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">xfs_dinode_put_rdev</span><span class="p">(</span><span class="k">struct</span> <span class="n">xfs_dinode</span> <span class="o">*</span><span class="n">dip</span><span class="p">,</span> <span class="n">xfs_dev_t</span> <span class="n">rdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="o">*</span><span class="p">(</span><span class="n">__be32</span> <span class="o">*</span><span class="p">)</span><span class="n">XFS_DFORK_DPTR</span><span class="p">(</span><span class="n">dip</span><span class="p">)</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">rdev</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Values for di_flags</span>
<span class="cm"> * There should be a one-to-one correspondence between these flags and the</span>
<span class="cm"> * XFS_XFLAG_s.</span>
<span class="cm"> */</span>
<span class="cp">#define XFS_DIFLAG_REALTIME_BIT  0	</span><span class="cm">/* file&#39;s blocks come from rt area */</span><span class="cp"></span>
<span class="cp">#define XFS_DIFLAG_PREALLOC_BIT  1	</span><span class="cm">/* file space has been preallocated */</span><span class="cp"></span>
<span class="cp">#define XFS_DIFLAG_NEWRTBM_BIT   2	</span><span class="cm">/* for rtbitmap inode, new format */</span><span class="cp"></span>
<span class="cp">#define XFS_DIFLAG_IMMUTABLE_BIT 3	</span><span class="cm">/* inode is immutable */</span><span class="cp"></span>
<span class="cp">#define XFS_DIFLAG_APPEND_BIT    4	</span><span class="cm">/* inode is append-only */</span><span class="cp"></span>
<span class="cp">#define XFS_DIFLAG_SYNC_BIT      5	</span><span class="cm">/* inode is written synchronously */</span><span class="cp"></span>
<span class="cp">#define XFS_DIFLAG_NOATIME_BIT   6	</span><span class="cm">/* do not update atime */</span><span class="cp"></span>
<span class="cp">#define XFS_DIFLAG_NODUMP_BIT    7	</span><span class="cm">/* do not dump */</span><span class="cp"></span>
<span class="cp">#define XFS_DIFLAG_RTINHERIT_BIT 8	</span><span class="cm">/* create with realtime bit set */</span><span class="cp"></span>
<span class="cp">#define XFS_DIFLAG_PROJINHERIT_BIT   9	</span><span class="cm">/* create with parents projid */</span><span class="cp"></span>
<span class="cp">#define XFS_DIFLAG_NOSYMLINKS_BIT   10	</span><span class="cm">/* disallow symlink creation */</span><span class="cp"></span>
<span class="cp">#define XFS_DIFLAG_EXTSIZE_BIT      11	</span><span class="cm">/* inode extent size allocator hint */</span><span class="cp"></span>
<span class="cp">#define XFS_DIFLAG_EXTSZINHERIT_BIT 12	</span><span class="cm">/* inherit inode extent size */</span><span class="cp"></span>
<span class="cp">#define XFS_DIFLAG_NODEFRAG_BIT     13	</span><span class="cm">/* do not reorganize/defragment */</span><span class="cp"></span>
<span class="cp">#define XFS_DIFLAG_FILESTREAM_BIT   14  </span><span class="cm">/* use filestream allocator */</span><span class="cp"></span>
<span class="cp">#define XFS_DIFLAG_REALTIME      (1 &lt;&lt; XFS_DIFLAG_REALTIME_BIT)</span>
<span class="cp">#define XFS_DIFLAG_PREALLOC      (1 &lt;&lt; XFS_DIFLAG_PREALLOC_BIT)</span>
<span class="cp">#define XFS_DIFLAG_NEWRTBM       (1 &lt;&lt; XFS_DIFLAG_NEWRTBM_BIT)</span>
<span class="cp">#define XFS_DIFLAG_IMMUTABLE     (1 &lt;&lt; XFS_DIFLAG_IMMUTABLE_BIT)</span>
<span class="cp">#define XFS_DIFLAG_APPEND        (1 &lt;&lt; XFS_DIFLAG_APPEND_BIT)</span>
<span class="cp">#define XFS_DIFLAG_SYNC          (1 &lt;&lt; XFS_DIFLAG_SYNC_BIT)</span>
<span class="cp">#define XFS_DIFLAG_NOATIME       (1 &lt;&lt; XFS_DIFLAG_NOATIME_BIT)</span>
<span class="cp">#define XFS_DIFLAG_NODUMP        (1 &lt;&lt; XFS_DIFLAG_NODUMP_BIT)</span>
<span class="cp">#define XFS_DIFLAG_RTINHERIT     (1 &lt;&lt; XFS_DIFLAG_RTINHERIT_BIT)</span>
<span class="cp">#define XFS_DIFLAG_PROJINHERIT   (1 &lt;&lt; XFS_DIFLAG_PROJINHERIT_BIT)</span>
<span class="cp">#define XFS_DIFLAG_NOSYMLINKS    (1 &lt;&lt; XFS_DIFLAG_NOSYMLINKS_BIT)</span>
<span class="cp">#define XFS_DIFLAG_EXTSIZE       (1 &lt;&lt; XFS_DIFLAG_EXTSIZE_BIT)</span>
<span class="cp">#define XFS_DIFLAG_EXTSZINHERIT  (1 &lt;&lt; XFS_DIFLAG_EXTSZINHERIT_BIT)</span>
<span class="cp">#define XFS_DIFLAG_NODEFRAG      (1 &lt;&lt; XFS_DIFLAG_NODEFRAG_BIT)</span>
<span class="cp">#define XFS_DIFLAG_FILESTREAM    (1 &lt;&lt; XFS_DIFLAG_FILESTREAM_BIT)</span>

<span class="cp">#ifdef CONFIG_XFS_RT</span>
<span class="cp">#define XFS_IS_REALTIME_INODE(ip) ((ip)-&gt;i_d.di_flags &amp; XFS_DIFLAG_REALTIME)</span>
<span class="cp">#else</span>
<span class="cp">#define XFS_IS_REALTIME_INODE(ip) (0)</span>
<span class="cp">#endif</span>

<span class="cp">#define XFS_DIFLAG_ANY \</span>
<span class="cp">	(XFS_DIFLAG_REALTIME | XFS_DIFLAG_PREALLOC | XFS_DIFLAG_NEWRTBM | \</span>
<span class="cp">	 XFS_DIFLAG_IMMUTABLE | XFS_DIFLAG_APPEND | XFS_DIFLAG_SYNC | \</span>
<span class="cp">	 XFS_DIFLAG_NOATIME | XFS_DIFLAG_NODUMP | XFS_DIFLAG_RTINHERIT | \</span>
<span class="cp">	 XFS_DIFLAG_PROJINHERIT | XFS_DIFLAG_NOSYMLINKS | XFS_DIFLAG_EXTSIZE | \</span>
<span class="cp">	 XFS_DIFLAG_EXTSZINHERIT | XFS_DIFLAG_NODEFRAG | XFS_DIFLAG_FILESTREAM)</span>

<span class="cp">#endif	</span><span class="cm">/* __XFS_DINODE_H__ */</span><span class="cp"></span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
