<!DOCTYPE html>
<html><head><title>joekychen/linux » fs › xfs › xfs_qm_syscalls.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>xfs_qm_syscalls.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Copyright (c) 2000-2005 Silicon Graphics, Inc.</span>
<span class="cm"> * All Rights Reserved.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or</span>
<span class="cm"> * modify it under the terms of the GNU General Public License as</span>
<span class="cm"> * published by the Free Software Foundation.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is distributed in the hope that it would be useful,</span>
<span class="cm"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm"> * GNU General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> * You should have received a copy of the GNU General Public License</span>
<span class="cm"> * along with this program; if not, write the Free Software Foundation,</span>
<span class="cm"> * Inc.,  51 Franklin St, Fifth Floor, Boston, MA  02110-1301  USA</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/capability.h&gt;</span>

<span class="cp">#include &quot;xfs.h&quot;</span>
<span class="cp">#include &quot;xfs_fs.h&quot;</span>
<span class="cp">#include &quot;xfs_bit.h&quot;</span>
<span class="cp">#include &quot;xfs_log.h&quot;</span>
<span class="cp">#include &quot;xfs_trans.h&quot;</span>
<span class="cp">#include &quot;xfs_sb.h&quot;</span>
<span class="cp">#include &quot;xfs_ag.h&quot;</span>
<span class="cp">#include &quot;xfs_alloc.h&quot;</span>
<span class="cp">#include &quot;xfs_quota.h&quot;</span>
<span class="cp">#include &quot;xfs_mount.h&quot;</span>
<span class="cp">#include &quot;xfs_bmap_btree.h&quot;</span>
<span class="cp">#include &quot;xfs_inode.h&quot;</span>
<span class="cp">#include &quot;xfs_inode_item.h&quot;</span>
<span class="cp">#include &quot;xfs_itable.h&quot;</span>
<span class="cp">#include &quot;xfs_bmap.h&quot;</span>
<span class="cp">#include &quot;xfs_rtalloc.h&quot;</span>
<span class="cp">#include &quot;xfs_error.h&quot;</span>
<span class="cp">#include &quot;xfs_attr.h&quot;</span>
<span class="cp">#include &quot;xfs_buf_item.h&quot;</span>
<span class="cp">#include &quot;xfs_utils.h&quot;</span>
<span class="cp">#include &quot;xfs_qm.h&quot;</span>
<span class="cp">#include &quot;xfs_trace.h&quot;</span>

<span class="n">STATIC</span> <span class="kt">int</span>	<span class="n">xfs_qm_log_quotaoff</span><span class="p">(</span><span class="n">xfs_mount_t</span> <span class="o">*</span><span class="p">,</span> <span class="n">xfs_qoff_logitem_t</span> <span class="o">**</span><span class="p">,</span> <span class="n">uint</span><span class="p">);</span>
<span class="n">STATIC</span> <span class="kt">int</span>	<span class="n">xfs_qm_log_quotaoff_end</span><span class="p">(</span><span class="n">xfs_mount_t</span> <span class="o">*</span><span class="p">,</span> <span class="n">xfs_qoff_logitem_t</span> <span class="o">*</span><span class="p">,</span>
					<span class="n">uint</span><span class="p">);</span>
<span class="n">STATIC</span> <span class="n">uint</span>	<span class="n">xfs_qm_export_flags</span><span class="p">(</span><span class="n">uint</span><span class="p">);</span>
<span class="n">STATIC</span> <span class="n">uint</span>	<span class="n">xfs_qm_export_qtype_flags</span><span class="p">(</span><span class="n">uint</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * Turn off quota accounting and/or enforcement for all udquots and/or</span>
<span class="cm"> * gdquots. Called only at unmount time.</span>
<span class="cm"> *</span>
<span class="cm"> * This assumes that there are no dquots of this file system cached</span>
<span class="cm"> * incore, and modifies the ondisk dquot directly. Therefore, for example,</span>
<span class="cm"> * it is an error to call this twice, without purging the cache.</span>
<span class="cm"> */</span>
<span class="kt">int</span>
<span class="nf">xfs_qm_scall_quotaoff</span><span class="p">(</span>
	<span class="n">xfs_mount_t</span>		<span class="o">*</span><span class="n">mp</span><span class="p">,</span>
	<span class="n">uint</span>			<span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">xfs_quotainfo</span>	<span class="o">*</span><span class="n">q</span> <span class="o">=</span> <span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_quotainfo</span><span class="p">;</span>
	<span class="n">uint</span>			<span class="n">dqtype</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">error</span><span class="p">;</span>
	<span class="n">uint</span>			<span class="n">inactivate_flags</span><span class="p">;</span>
	<span class="n">xfs_qoff_logitem_t</span>	<span class="o">*</span><span class="n">qoffstart</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * No file system can have quotas enabled on disk but not in core.</span>
<span class="cm">	 * Note that quota utilities (like quotaoff) _expect_</span>
<span class="cm">	 * errno == EEXIST here.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_qflags</span> <span class="o">&amp;</span> <span class="n">flags</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">XFS_ERROR</span><span class="p">(</span><span class="n">EEXIST</span><span class="p">);</span>
	<span class="n">error</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">flags</span> <span class="o">&amp;=</span> <span class="p">(</span><span class="n">XFS_ALL_QUOTA_ACCT</span> <span class="o">|</span> <span class="n">XFS_ALL_QUOTA_ENFD</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * We don&#39;t want to deal with two quotaoffs messing up each other,</span>
<span class="cm">	 * so we&#39;re going to serialize it. quotaoff isn&#39;t exactly a performance</span>
<span class="cm">	 * critical thing.</span>
<span class="cm">	 * If quotaoff, then we must be dealing with the root filesystem.</span>
<span class="cm">	 */</span>
	<span class="n">ASSERT</span><span class="p">(</span><span class="n">q</span><span class="p">);</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">qi_quotaofflock</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * If we&#39;re just turning off quota enforcement, change mp and go.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">XFS_ALL_QUOTA_ACCT</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_qflags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>

		<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_sb_lock</span><span class="p">);</span>
		<span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_sb</span><span class="p">.</span><span class="n">sb_qflags</span> <span class="o">=</span> <span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_qflags</span><span class="p">;</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_sb_lock</span><span class="p">);</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">qi_quotaofflock</span><span class="p">);</span>

		<span class="cm">/* XXX what to do if error ? Revert back to old vals incore ? */</span>
		<span class="n">error</span> <span class="o">=</span> <span class="n">xfs_qm_write_sb_changes</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="n">XFS_SB_QFLAGS</span><span class="p">);</span>
		<span class="k">return</span> <span class="p">(</span><span class="n">error</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">dqtype</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">inactivate_flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * If accounting is off, we must turn enforcement off, clear the</span>
<span class="cm">	 * quota &#39;CHKD&#39; certificate to make it known that we have to</span>
<span class="cm">	 * do a quotacheck the next time this quota is turned on.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">XFS_UQUOTA_ACCT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dqtype</span> <span class="o">|=</span> <span class="n">XFS_QMOPT_UQUOTA</span><span class="p">;</span>
		<span class="n">flags</span> <span class="o">|=</span> <span class="p">(</span><span class="n">XFS_UQUOTA_CHKD</span> <span class="o">|</span> <span class="n">XFS_UQUOTA_ENFD</span><span class="p">);</span>
		<span class="n">inactivate_flags</span> <span class="o">|=</span> <span class="n">XFS_UQUOTA_ACTIVE</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">XFS_GQUOTA_ACCT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dqtype</span> <span class="o">|=</span> <span class="n">XFS_QMOPT_GQUOTA</span><span class="p">;</span>
		<span class="n">flags</span> <span class="o">|=</span> <span class="p">(</span><span class="n">XFS_OQUOTA_CHKD</span> <span class="o">|</span> <span class="n">XFS_OQUOTA_ENFD</span><span class="p">);</span>
		<span class="n">inactivate_flags</span> <span class="o">|=</span> <span class="n">XFS_GQUOTA_ACTIVE</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">XFS_PQUOTA_ACCT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dqtype</span> <span class="o">|=</span> <span class="n">XFS_QMOPT_PQUOTA</span><span class="p">;</span>
		<span class="n">flags</span> <span class="o">|=</span> <span class="p">(</span><span class="n">XFS_OQUOTA_CHKD</span> <span class="o">|</span> <span class="n">XFS_OQUOTA_ENFD</span><span class="p">);</span>
		<span class="n">inactivate_flags</span> <span class="o">|=</span> <span class="n">XFS_PQUOTA_ACTIVE</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Nothing to do?  Don&#39;t complain. This happens when we&#39;re just</span>
<span class="cm">	 * turning off quota enforcement.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_qflags</span> <span class="o">&amp;</span> <span class="n">flags</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_unlock</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Write the LI_QUOTAOFF log record, and do SB changes atomically,</span>
<span class="cm">	 * and synchronously. If we fail to write, we should abort the</span>
<span class="cm">	 * operation as it cannot be recovered safely if we crash.</span>
<span class="cm">	 */</span>
	<span class="n">error</span> <span class="o">=</span> <span class="n">xfs_qm_log_quotaoff</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">qoffstart</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_unlock</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Next we clear the XFS_MOUNT_*DQ_ACTIVE bit(s) in the mount struct</span>
<span class="cm">	 * to take care of the race between dqget and quotaoff. We don&#39;t take</span>
<span class="cm">	 * any special locks to reset these bits. All processes need to check</span>
<span class="cm">	 * these bits *after* taking inode lock(s) to see if the particular</span>
<span class="cm">	 * quota type is in the process of being turned off. If *ACTIVE, it is</span>
<span class="cm">	 * guaranteed that all dquot structures and all quotainode ptrs will all</span>
<span class="cm">	 * stay valid as long as that inode is kept locked.</span>
<span class="cm">	 *</span>
<span class="cm">	 * There is no turning back after this.</span>
<span class="cm">	 */</span>
	<span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_qflags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">inactivate_flags</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Give back all the dquot reference(s) held by inodes.</span>
<span class="cm">	 * Here we go thru every single incore inode in this file system, and</span>
<span class="cm">	 * do a dqrele on the i_udquot/i_gdquot that it may have.</span>
<span class="cm">	 * Essentially, as long as somebody has an inode locked, this guarantees</span>
<span class="cm">	 * that quotas will not be turned off. This is handy because in a</span>
<span class="cm">	 * transaction once we lock the inode(s) and check for quotaon, we can</span>
<span class="cm">	 * depend on the quota inodes (and other things) being valid as long as</span>
<span class="cm">	 * we keep the lock(s).</span>
<span class="cm">	 */</span>
	<span class="n">xfs_qm_dqrele_all_inodes</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Next we make the changes in the quota flag in the mount struct.</span>
<span class="cm">	 * This isn&#39;t protected by a particular lock directly, because we</span>
<span class="cm">	 * don&#39;t want to take a mrlock every time we depend on quotas being on.</span>
<span class="cm">	 */</span>
	<span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_qflags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">flags</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Go through all the dquots of this file system and purge them,</span>
<span class="cm">	 * according to what was turned off.</span>
<span class="cm">	 */</span>
	<span class="n">xfs_qm_dqpurge_all</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="n">dqtype</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Transactions that had started before ACTIVE state bit was cleared</span>
<span class="cm">	 * could have logged many dquots, so they&#39;d have higher LSNs than</span>
<span class="cm">	 * the first QUOTAOFF log record does. If we happen to crash when</span>
<span class="cm">	 * the tail of the log has gone past the QUOTAOFF record, but</span>
<span class="cm">	 * before the last dquot modification, those dquots __will__</span>
<span class="cm">	 * recover, and that&#39;s not good.</span>
<span class="cm">	 *</span>
<span class="cm">	 * So, we have QUOTAOFF start and end logitems; the start</span>
<span class="cm">	 * logitem won&#39;t get overwritten until the end logitem appears...</span>
<span class="cm">	 */</span>
	<span class="n">error</span> <span class="o">=</span> <span class="n">xfs_qm_log_quotaoff_end</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="n">qoffstart</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* We&#39;re screwed now. Shutdown is the only option. */</span>
		<span class="n">xfs_force_shutdown</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="n">SHUTDOWN_CORRUPT_INCORE</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_unlock</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * If quotas is completely disabled, close shop.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(((</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">XFS_MOUNT_QUOTA_ALL</span><span class="p">)</span> <span class="o">==</span> <span class="n">XFS_MOUNT_QUOTA_SET1</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">((</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">XFS_MOUNT_QUOTA_ALL</span><span class="p">)</span> <span class="o">==</span> <span class="n">XFS_MOUNT_QUOTA_SET2</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">qi_quotaofflock</span><span class="p">);</span>
		<span class="n">xfs_qm_destroy_quotainfo</span><span class="p">(</span><span class="n">mp</span><span class="p">);</span>
		<span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Release our quotainode references if we don&#39;t need them anymore.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">dqtype</span> <span class="o">&amp;</span> <span class="n">XFS_QMOPT_UQUOTA</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">qi_uquotaip</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">IRELE</span><span class="p">(</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">qi_uquotaip</span><span class="p">);</span>
		<span class="n">q</span><span class="o">-&gt;</span><span class="n">qi_uquotaip</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">dqtype</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">XFS_QMOPT_GQUOTA</span><span class="o">|</span><span class="n">XFS_QMOPT_PQUOTA</span><span class="p">))</span> <span class="o">&amp;&amp;</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">qi_gquotaip</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">IRELE</span><span class="p">(</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">qi_gquotaip</span><span class="p">);</span>
		<span class="n">q</span><span class="o">-&gt;</span><span class="n">qi_gquotaip</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">out_unlock:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">qi_quotaofflock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">STATIC</span> <span class="kt">int</span>
<span class="nf">xfs_qm_scall_trunc_qfile</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">xfs_mount</span>	<span class="o">*</span><span class="n">mp</span><span class="p">,</span>
	<span class="n">xfs_ino_t</span>		<span class="n">ino</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">xfs_inode</span>	<span class="o">*</span><span class="n">ip</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">xfs_trans</span>	<span class="o">*</span><span class="n">tp</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">error</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ino</span> <span class="o">==</span> <span class="n">NULLFSINO</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">error</span> <span class="o">=</span> <span class="n">xfs_iget</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">ino</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ip</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">error</span><span class="p">;</span>

	<span class="n">xfs_ilock</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">XFS_IOLOCK_EXCL</span><span class="p">);</span>

	<span class="n">tp</span> <span class="o">=</span> <span class="n">xfs_trans_alloc</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="n">XFS_TRANS_TRUNCATE_FILE</span><span class="p">);</span>
	<span class="n">error</span> <span class="o">=</span> <span class="n">xfs_trans_reserve</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">XFS_ITRUNCATE_LOG_RES</span><span class="p">(</span><span class="n">mp</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span>
				  <span class="n">XFS_TRANS_PERM_LOG_RES</span><span class="p">,</span>
				  <span class="n">XFS_ITRUNCATE_LOG_COUNT</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">xfs_trans_cancel</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">xfs_iunlock</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">XFS_IOLOCK_EXCL</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_put</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">xfs_ilock</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">XFS_ILOCK_EXCL</span><span class="p">);</span>
	<span class="n">xfs_trans_ijoin</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">ip</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_d</span><span class="p">.</span><span class="n">di_size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">xfs_trans_log_inode</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">ip</span><span class="p">,</span> <span class="n">XFS_ILOG_CORE</span><span class="p">);</span>

	<span class="n">error</span> <span class="o">=</span> <span class="n">xfs_itruncate_extents</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tp</span><span class="p">,</span> <span class="n">ip</span><span class="p">,</span> <span class="n">XFS_DATA_FORK</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">xfs_trans_cancel</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">XFS_TRANS_RELEASE_LOG_RES</span> <span class="o">|</span>
				     <span class="n">XFS_TRANS_ABORT</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_unlock</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ASSERT</span><span class="p">(</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_d</span><span class="p">.</span><span class="n">di_nextents</span> <span class="o">==</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">xfs_trans_ichgtime</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">ip</span><span class="p">,</span> <span class="n">XFS_ICHGTIME_MOD</span> <span class="o">|</span> <span class="n">XFS_ICHGTIME_CHG</span><span class="p">);</span>
	<span class="n">error</span> <span class="o">=</span> <span class="n">xfs_trans_commit</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">XFS_TRANS_RELEASE_LOG_RES</span><span class="p">);</span>

<span class="nl">out_unlock:</span>
	<span class="n">xfs_iunlock</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">XFS_ILOCK_EXCL</span> <span class="o">|</span> <span class="n">XFS_IOLOCK_EXCL</span><span class="p">);</span>
<span class="nl">out_put:</span>
	<span class="n">IRELE</span><span class="p">(</span><span class="n">ip</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="nf">xfs_qm_scall_trunc_qfiles</span><span class="p">(</span>
	<span class="n">xfs_mount_t</span>	<span class="o">*</span><span class="n">mp</span><span class="p">,</span>
	<span class="n">uint</span>		<span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span>		<span class="n">error</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">error2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">xfs_sb_version_hasquota</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_sb</span><span class="p">)</span> <span class="o">||</span> <span class="n">flags</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">xfs_debug</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="s">&quot;%s: flags=%x m_qflags=%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span> <span class="n">flags</span><span class="p">,</span> <span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_qflags</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">XFS_ERROR</span><span class="p">(</span><span class="n">EINVAL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">XFS_DQ_USER</span><span class="p">)</span>
		<span class="n">error</span> <span class="o">=</span> <span class="n">xfs_qm_scall_trunc_qfile</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_sb</span><span class="p">.</span><span class="n">sb_uquotino</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">XFS_DQ_GROUP</span><span class="o">|</span><span class="n">XFS_DQ_PROJ</span><span class="p">))</span>
		<span class="n">error2</span> <span class="o">=</span> <span class="n">xfs_qm_scall_trunc_qfile</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_sb</span><span class="p">.</span><span class="n">sb_gquotino</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">error</span> <span class="o">?</span> <span class="n">error</span> <span class="o">:</span> <span class="n">error2</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Switch on (a given) quota enforcement for a filesystem.  This takes</span>
<span class="cm"> * effect immediately.</span>
<span class="cm"> * (Switching on quota accounting must be done at mount time.)</span>
<span class="cm"> */</span>
<span class="kt">int</span>
<span class="nf">xfs_qm_scall_quotaon</span><span class="p">(</span>
	<span class="n">xfs_mount_t</span>	<span class="o">*</span><span class="n">mp</span><span class="p">,</span>
	<span class="n">uint</span>		<span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span>		<span class="n">error</span><span class="p">;</span>
	<span class="n">uint</span>		<span class="n">qf</span><span class="p">;</span>
	<span class="n">__int64_t</span>	<span class="n">sbflags</span><span class="p">;</span>

	<span class="n">flags</span> <span class="o">&amp;=</span> <span class="p">(</span><span class="n">XFS_ALL_QUOTA_ACCT</span> <span class="o">|</span> <span class="n">XFS_ALL_QUOTA_ENFD</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 * Switching on quota accounting must be done at mount time.</span>
<span class="cm">	 */</span>
	<span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">XFS_ALL_QUOTA_ACCT</span><span class="p">);</span>

	<span class="n">sbflags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">xfs_debug</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="s">&quot;%s: zero flags, m_qflags=%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span> <span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_qflags</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">XFS_ERROR</span><span class="p">(</span><span class="n">EINVAL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* No fs can turn on quotas with a delayed effect */</span>
	<span class="n">ASSERT</span><span class="p">((</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">XFS_ALL_QUOTA_ACCT</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Can&#39;t enforce without accounting. We check the superblock</span>
<span class="cm">	 * qflags here instead of m_qflags because rootfs can have</span>
<span class="cm">	 * quota acct on ondisk without m_qflags&#39; knowing.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(((</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">XFS_UQUOTA_ACCT</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_sb</span><span class="p">.</span><span class="n">sb_qflags</span> <span class="o">&amp;</span> <span class="n">XFS_UQUOTA_ACCT</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">XFS_UQUOTA_ENFD</span><span class="p">))</span>
	    <span class="o">||</span>
	    <span class="p">((</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">XFS_PQUOTA_ACCT</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_sb</span><span class="p">.</span><span class="n">sb_qflags</span> <span class="o">&amp;</span> <span class="n">XFS_PQUOTA_ACCT</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">XFS_GQUOTA_ACCT</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_sb</span><span class="p">.</span><span class="n">sb_qflags</span> <span class="o">&amp;</span> <span class="n">XFS_GQUOTA_ACCT</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">XFS_OQUOTA_ENFD</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">xfs_debug</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span>
			<span class="s">&quot;%s: Can&#39;t enforce without acct, flags=%x sbflags=%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span> <span class="n">flags</span><span class="p">,</span> <span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_sb</span><span class="p">.</span><span class="n">sb_qflags</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">XFS_ERROR</span><span class="p">(</span><span class="n">EINVAL</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="cm">/*</span>
<span class="cm">	 * If everything&#39;s up to-date incore, then don&#39;t waste time.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_qflags</span> <span class="o">&amp;</span> <span class="n">flags</span><span class="p">)</span> <span class="o">==</span> <span class="n">flags</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">XFS_ERROR</span><span class="p">(</span><span class="n">EEXIST</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Change sb_qflags on disk but not incore mp-&gt;qflags</span>
<span class="cm">	 * if this is the root filesystem.</span>
<span class="cm">	 */</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_sb_lock</span><span class="p">);</span>
	<span class="n">qf</span> <span class="o">=</span> <span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_sb</span><span class="p">.</span><span class="n">sb_qflags</span><span class="p">;</span>
	<span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_sb</span><span class="p">.</span><span class="n">sb_qflags</span> <span class="o">=</span> <span class="n">qf</span> <span class="o">|</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_sb_lock</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * There&#39;s nothing to change if it&#39;s the same.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">qf</span> <span class="o">&amp;</span> <span class="n">flags</span><span class="p">)</span> <span class="o">==</span> <span class="n">flags</span> <span class="o">&amp;&amp;</span> <span class="n">sbflags</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">XFS_ERROR</span><span class="p">(</span><span class="n">EEXIST</span><span class="p">);</span>
	<span class="n">sbflags</span> <span class="o">|=</span> <span class="n">XFS_SB_QFLAGS</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">error</span> <span class="o">=</span> <span class="n">xfs_qm_write_sb_changes</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="n">sbflags</span><span class="p">)))</span>
		<span class="k">return</span> <span class="p">(</span><span class="n">error</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 * If we aren&#39;t trying to switch on quota enforcement, we are done.</span>
<span class="cm">	 */</span>
	<span class="k">if</span>  <span class="p">(((</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_sb</span><span class="p">.</span><span class="n">sb_qflags</span> <span class="o">&amp;</span> <span class="n">XFS_UQUOTA_ACCT</span><span class="p">)</span> <span class="o">!=</span>
	     <span class="p">(</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_qflags</span> <span class="o">&amp;</span> <span class="n">XFS_UQUOTA_ACCT</span><span class="p">))</span> <span class="o">||</span>
	     <span class="p">((</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_sb</span><span class="p">.</span><span class="n">sb_qflags</span> <span class="o">&amp;</span> <span class="n">XFS_PQUOTA_ACCT</span><span class="p">)</span> <span class="o">!=</span>
	     <span class="p">(</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_qflags</span> <span class="o">&amp;</span> <span class="n">XFS_PQUOTA_ACCT</span><span class="p">))</span> <span class="o">||</span>
	     <span class="p">((</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_sb</span><span class="p">.</span><span class="n">sb_qflags</span> <span class="o">&amp;</span> <span class="n">XFS_GQUOTA_ACCT</span><span class="p">)</span> <span class="o">!=</span>
	     <span class="p">(</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_qflags</span> <span class="o">&amp;</span> <span class="n">XFS_GQUOTA_ACCT</span><span class="p">))</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">XFS_ALL_QUOTA_ENFD</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="n">XFS_IS_QUOTA_RUNNING</span><span class="p">(</span><span class="n">mp</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">XFS_ERROR</span><span class="p">(</span><span class="n">ESRCH</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Switch on quota enforcement in core.</span>
<span class="cm">	 */</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_quotainfo</span><span class="o">-&gt;</span><span class="n">qi_quotaofflock</span><span class="p">);</span>
	<span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_qflags</span> <span class="o">|=</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">XFS_ALL_QUOTA_ENFD</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_quotainfo</span><span class="o">-&gt;</span><span class="n">qi_quotaofflock</span><span class="p">);</span>

	<span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * Return quota status information, such as uquota-off, enforcements, etc.</span>
<span class="cm"> */</span>
<span class="kt">int</span>
<span class="nf">xfs_qm_scall_getqstat</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">xfs_mount</span>	<span class="o">*</span><span class="n">mp</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">fs_quota_stat</span>	<span class="o">*</span><span class="n">out</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">xfs_quotainfo</span>	<span class="o">*</span><span class="n">q</span> <span class="o">=</span> <span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_quotainfo</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">xfs_inode</span>	<span class="o">*</span><span class="n">uip</span><span class="p">,</span> <span class="o">*</span><span class="n">gip</span><span class="p">;</span>
	<span class="n">boolean_t</span>		<span class="n">tempuqip</span><span class="p">,</span> <span class="n">tempgqip</span><span class="p">;</span>

	<span class="n">uip</span> <span class="o">=</span> <span class="n">gip</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">tempuqip</span> <span class="o">=</span> <span class="n">tempgqip</span> <span class="o">=</span> <span class="n">B_FALSE</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">fs_quota_stat_t</span><span class="p">));</span>

	<span class="n">out</span><span class="o">-&gt;</span><span class="n">qs_version</span> <span class="o">=</span> <span class="n">FS_QSTAT_VERSION</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">xfs_sb_version_hasquota</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_sb</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">out</span><span class="o">-&gt;</span><span class="n">qs_uquota</span><span class="p">.</span><span class="n">qfs_ino</span> <span class="o">=</span> <span class="n">NULLFSINO</span><span class="p">;</span>
		<span class="n">out</span><span class="o">-&gt;</span><span class="n">qs_gquota</span><span class="p">.</span><span class="n">qfs_ino</span> <span class="o">=</span> <span class="n">NULLFSINO</span><span class="p">;</span>
		<span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">out</span><span class="o">-&gt;</span><span class="n">qs_flags</span> <span class="o">=</span> <span class="p">(</span><span class="n">__uint16_t</span><span class="p">)</span> <span class="n">xfs_qm_export_flags</span><span class="p">(</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_qflags</span> <span class="o">&amp;</span>
							<span class="p">(</span><span class="n">XFS_ALL_QUOTA_ACCT</span><span class="o">|</span>
							 <span class="n">XFS_ALL_QUOTA_ENFD</span><span class="p">));</span>
	<span class="n">out</span><span class="o">-&gt;</span><span class="n">qs_pad</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">out</span><span class="o">-&gt;</span><span class="n">qs_uquota</span><span class="p">.</span><span class="n">qfs_ino</span> <span class="o">=</span> <span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_sb</span><span class="p">.</span><span class="n">sb_uquotino</span><span class="p">;</span>
	<span class="n">out</span><span class="o">-&gt;</span><span class="n">qs_gquota</span><span class="p">.</span><span class="n">qfs_ino</span> <span class="o">=</span> <span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_sb</span><span class="p">.</span><span class="n">sb_gquotino</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">q</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">uip</span> <span class="o">=</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">qi_uquotaip</span><span class="p">;</span>
		<span class="n">gip</span> <span class="o">=</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">qi_gquotaip</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">uip</span> <span class="o">&amp;&amp;</span> <span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_sb</span><span class="p">.</span><span class="n">sb_uquotino</span> <span class="o">!=</span> <span class="n">NULLFSINO</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">xfs_iget</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_sb</span><span class="p">.</span><span class="n">sb_uquotino</span><span class="p">,</span>
					<span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">uip</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">tempuqip</span> <span class="o">=</span> <span class="n">B_TRUE</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">gip</span> <span class="o">&amp;&amp;</span> <span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_sb</span><span class="p">.</span><span class="n">sb_gquotino</span> <span class="o">!=</span> <span class="n">NULLFSINO</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">xfs_iget</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_sb</span><span class="p">.</span><span class="n">sb_gquotino</span><span class="p">,</span>
					<span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">gip</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">tempgqip</span> <span class="o">=</span> <span class="n">B_TRUE</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">uip</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">out</span><span class="o">-&gt;</span><span class="n">qs_uquota</span><span class="p">.</span><span class="n">qfs_nblks</span> <span class="o">=</span> <span class="n">uip</span><span class="o">-&gt;</span><span class="n">i_d</span><span class="p">.</span><span class="n">di_nblocks</span><span class="p">;</span>
		<span class="n">out</span><span class="o">-&gt;</span><span class="n">qs_uquota</span><span class="p">.</span><span class="n">qfs_nextents</span> <span class="o">=</span> <span class="n">uip</span><span class="o">-&gt;</span><span class="n">i_d</span><span class="p">.</span><span class="n">di_nextents</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tempuqip</span><span class="p">)</span>
			<span class="n">IRELE</span><span class="p">(</span><span class="n">uip</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">gip</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">out</span><span class="o">-&gt;</span><span class="n">qs_gquota</span><span class="p">.</span><span class="n">qfs_nblks</span> <span class="o">=</span> <span class="n">gip</span><span class="o">-&gt;</span><span class="n">i_d</span><span class="p">.</span><span class="n">di_nblocks</span><span class="p">;</span>
		<span class="n">out</span><span class="o">-&gt;</span><span class="n">qs_gquota</span><span class="p">.</span><span class="n">qfs_nextents</span> <span class="o">=</span> <span class="n">gip</span><span class="o">-&gt;</span><span class="n">i_d</span><span class="p">.</span><span class="n">di_nextents</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tempgqip</span><span class="p">)</span>
			<span class="n">IRELE</span><span class="p">(</span><span class="n">gip</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">q</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">out</span><span class="o">-&gt;</span><span class="n">qs_incoredqs</span> <span class="o">=</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">qi_dquots</span><span class="p">;</span>
		<span class="n">out</span><span class="o">-&gt;</span><span class="n">qs_btimelimit</span> <span class="o">=</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">qi_btimelimit</span><span class="p">;</span>
		<span class="n">out</span><span class="o">-&gt;</span><span class="n">qs_itimelimit</span> <span class="o">=</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">qi_itimelimit</span><span class="p">;</span>
		<span class="n">out</span><span class="o">-&gt;</span><span class="n">qs_rtbtimelimit</span> <span class="o">=</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">qi_rtbtimelimit</span><span class="p">;</span>
		<span class="n">out</span><span class="o">-&gt;</span><span class="n">qs_bwarnlimit</span> <span class="o">=</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">qi_bwarnlimit</span><span class="p">;</span>
		<span class="n">out</span><span class="o">-&gt;</span><span class="n">qs_iwarnlimit</span> <span class="o">=</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">qi_iwarnlimit</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define XFS_DQ_MASK \</span>
<span class="cp">	(FS_DQ_LIMIT_MASK | FS_DQ_TIMER_MASK | FS_DQ_WARNS_MASK)</span>

<span class="cm">/*</span>
<span class="cm"> * Adjust quota limits, and start/stop timers accordingly.</span>
<span class="cm"> */</span>
<span class="kt">int</span>
<span class="nf">xfs_qm_scall_setqlim</span><span class="p">(</span>
	<span class="n">xfs_mount_t</span>		<span class="o">*</span><span class="n">mp</span><span class="p">,</span>
	<span class="n">xfs_dqid_t</span>		<span class="n">id</span><span class="p">,</span>
	<span class="n">uint</span>			<span class="n">type</span><span class="p">,</span>
	<span class="n">fs_disk_quota_t</span>		<span class="o">*</span><span class="n">newlim</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">xfs_quotainfo</span>	<span class="o">*</span><span class="n">q</span> <span class="o">=</span> <span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_quotainfo</span><span class="p">;</span>
	<span class="n">xfs_disk_dquot_t</span>	<span class="o">*</span><span class="n">ddq</span><span class="p">;</span>
	<span class="n">xfs_dquot_t</span>		<span class="o">*</span><span class="n">dqp</span><span class="p">;</span>
	<span class="n">xfs_trans_t</span>		<span class="o">*</span><span class="n">tp</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">error</span><span class="p">;</span>
	<span class="n">xfs_qcnt_t</span>		<span class="n">hard</span><span class="p">,</span> <span class="n">soft</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">newlim</span><span class="o">-&gt;</span><span class="n">d_fieldmask</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">XFS_DQ_MASK</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">newlim</span><span class="o">-&gt;</span><span class="n">d_fieldmask</span> <span class="o">&amp;</span> <span class="n">XFS_DQ_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">tp</span> <span class="o">=</span> <span class="n">xfs_trans_alloc</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="n">XFS_TRANS_QM_SETQLIM</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">error</span> <span class="o">=</span> <span class="n">xfs_trans_reserve</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">xfs_disk_dquot_t</span><span class="p">)</span> <span class="o">+</span> <span class="mi">128</span><span class="p">,</span>
				      <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">XFS_DEFAULT_LOG_COUNT</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">xfs_trans_cancel</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">return</span> <span class="p">(</span><span class="n">error</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * We don&#39;t want to race with a quotaoff so take the quotaoff lock.</span>
<span class="cm">	 * (We don&#39;t hold an inode lock, so there&#39;s nothing else to stop</span>
<span class="cm">	 * a quotaoff from happening). (XXXThis doesn&#39;t currently happen</span>
<span class="cm">	 * because we take the vfslock before calling xfs_qm_sysent).</span>
<span class="cm">	 */</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">qi_quotaofflock</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Get the dquot (locked), and join it to the transaction.</span>
<span class="cm">	 * Allocate the dquot if this doesn&#39;t exist.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">error</span> <span class="o">=</span> <span class="n">xfs_qm_dqget</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">id</span><span class="p">,</span> <span class="n">type</span><span class="p">,</span> <span class="n">XFS_QMOPT_DQALLOC</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dqp</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">xfs_trans_cancel</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">XFS_TRANS_ABORT</span><span class="p">);</span>
		<span class="n">ASSERT</span><span class="p">(</span><span class="n">error</span> <span class="o">!=</span> <span class="n">ENOENT</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_unlock</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">xfs_trans_dqjoin</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">dqp</span><span class="p">);</span>
	<span class="n">ddq</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dqp</span><span class="o">-&gt;</span><span class="n">q_core</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Make sure that hardlimits are &gt;= soft limits before changing.</span>
<span class="cm">	 */</span>
	<span class="n">hard</span> <span class="o">=</span> <span class="p">(</span><span class="n">newlim</span><span class="o">-&gt;</span><span class="n">d_fieldmask</span> <span class="o">&amp;</span> <span class="n">FS_DQ_BHARD</span><span class="p">)</span> <span class="o">?</span>
		<span class="p">(</span><span class="n">xfs_qcnt_t</span><span class="p">)</span> <span class="n">XFS_BB_TO_FSB</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="n">newlim</span><span class="o">-&gt;</span><span class="n">d_blk_hardlimit</span><span class="p">)</span> <span class="o">:</span>
			<span class="n">be64_to_cpu</span><span class="p">(</span><span class="n">ddq</span><span class="o">-&gt;</span><span class="n">d_blk_hardlimit</span><span class="p">);</span>
	<span class="n">soft</span> <span class="o">=</span> <span class="p">(</span><span class="n">newlim</span><span class="o">-&gt;</span><span class="n">d_fieldmask</span> <span class="o">&amp;</span> <span class="n">FS_DQ_BSOFT</span><span class="p">)</span> <span class="o">?</span>
		<span class="p">(</span><span class="n">xfs_qcnt_t</span><span class="p">)</span> <span class="n">XFS_BB_TO_FSB</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="n">newlim</span><span class="o">-&gt;</span><span class="n">d_blk_softlimit</span><span class="p">)</span> <span class="o">:</span>
			<span class="n">be64_to_cpu</span><span class="p">(</span><span class="n">ddq</span><span class="o">-&gt;</span><span class="n">d_blk_softlimit</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hard</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">hard</span> <span class="o">&gt;=</span> <span class="n">soft</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ddq</span><span class="o">-&gt;</span><span class="n">d_blk_hardlimit</span> <span class="o">=</span> <span class="n">cpu_to_be64</span><span class="p">(</span><span class="n">hard</span><span class="p">);</span>
		<span class="n">ddq</span><span class="o">-&gt;</span><span class="n">d_blk_softlimit</span> <span class="o">=</span> <span class="n">cpu_to_be64</span><span class="p">(</span><span class="n">soft</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">id</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">q</span><span class="o">-&gt;</span><span class="n">qi_bhardlimit</span> <span class="o">=</span> <span class="n">hard</span><span class="p">;</span>
			<span class="n">q</span><span class="o">-&gt;</span><span class="n">qi_bsoftlimit</span> <span class="o">=</span> <span class="n">soft</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">xfs_debug</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="s">&quot;blkhard %Ld &lt; blksoft %Ld</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">hard</span><span class="p">,</span> <span class="n">soft</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">hard</span> <span class="o">=</span> <span class="p">(</span><span class="n">newlim</span><span class="o">-&gt;</span><span class="n">d_fieldmask</span> <span class="o">&amp;</span> <span class="n">FS_DQ_RTBHARD</span><span class="p">)</span> <span class="o">?</span>
		<span class="p">(</span><span class="n">xfs_qcnt_t</span><span class="p">)</span> <span class="n">XFS_BB_TO_FSB</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="n">newlim</span><span class="o">-&gt;</span><span class="n">d_rtb_hardlimit</span><span class="p">)</span> <span class="o">:</span>
			<span class="n">be64_to_cpu</span><span class="p">(</span><span class="n">ddq</span><span class="o">-&gt;</span><span class="n">d_rtb_hardlimit</span><span class="p">);</span>
	<span class="n">soft</span> <span class="o">=</span> <span class="p">(</span><span class="n">newlim</span><span class="o">-&gt;</span><span class="n">d_fieldmask</span> <span class="o">&amp;</span> <span class="n">FS_DQ_RTBSOFT</span><span class="p">)</span> <span class="o">?</span>
		<span class="p">(</span><span class="n">xfs_qcnt_t</span><span class="p">)</span> <span class="n">XFS_BB_TO_FSB</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="n">newlim</span><span class="o">-&gt;</span><span class="n">d_rtb_softlimit</span><span class="p">)</span> <span class="o">:</span>
			<span class="n">be64_to_cpu</span><span class="p">(</span><span class="n">ddq</span><span class="o">-&gt;</span><span class="n">d_rtb_softlimit</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hard</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">hard</span> <span class="o">&gt;=</span> <span class="n">soft</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ddq</span><span class="o">-&gt;</span><span class="n">d_rtb_hardlimit</span> <span class="o">=</span> <span class="n">cpu_to_be64</span><span class="p">(</span><span class="n">hard</span><span class="p">);</span>
		<span class="n">ddq</span><span class="o">-&gt;</span><span class="n">d_rtb_softlimit</span> <span class="o">=</span> <span class="n">cpu_to_be64</span><span class="p">(</span><span class="n">soft</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">id</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">q</span><span class="o">-&gt;</span><span class="n">qi_rtbhardlimit</span> <span class="o">=</span> <span class="n">hard</span><span class="p">;</span>
			<span class="n">q</span><span class="o">-&gt;</span><span class="n">qi_rtbsoftlimit</span> <span class="o">=</span> <span class="n">soft</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">xfs_debug</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="s">&quot;rtbhard %Ld &lt; rtbsoft %Ld</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">hard</span><span class="p">,</span> <span class="n">soft</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">hard</span> <span class="o">=</span> <span class="p">(</span><span class="n">newlim</span><span class="o">-&gt;</span><span class="n">d_fieldmask</span> <span class="o">&amp;</span> <span class="n">FS_DQ_IHARD</span><span class="p">)</span> <span class="o">?</span>
		<span class="p">(</span><span class="n">xfs_qcnt_t</span><span class="p">)</span> <span class="n">newlim</span><span class="o">-&gt;</span><span class="n">d_ino_hardlimit</span> <span class="o">:</span>
			<span class="n">be64_to_cpu</span><span class="p">(</span><span class="n">ddq</span><span class="o">-&gt;</span><span class="n">d_ino_hardlimit</span><span class="p">);</span>
	<span class="n">soft</span> <span class="o">=</span> <span class="p">(</span><span class="n">newlim</span><span class="o">-&gt;</span><span class="n">d_fieldmask</span> <span class="o">&amp;</span> <span class="n">FS_DQ_ISOFT</span><span class="p">)</span> <span class="o">?</span>
		<span class="p">(</span><span class="n">xfs_qcnt_t</span><span class="p">)</span> <span class="n">newlim</span><span class="o">-&gt;</span><span class="n">d_ino_softlimit</span> <span class="o">:</span>
			<span class="n">be64_to_cpu</span><span class="p">(</span><span class="n">ddq</span><span class="o">-&gt;</span><span class="n">d_ino_softlimit</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hard</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">hard</span> <span class="o">&gt;=</span> <span class="n">soft</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ddq</span><span class="o">-&gt;</span><span class="n">d_ino_hardlimit</span> <span class="o">=</span> <span class="n">cpu_to_be64</span><span class="p">(</span><span class="n">hard</span><span class="p">);</span>
		<span class="n">ddq</span><span class="o">-&gt;</span><span class="n">d_ino_softlimit</span> <span class="o">=</span> <span class="n">cpu_to_be64</span><span class="p">(</span><span class="n">soft</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">id</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">q</span><span class="o">-&gt;</span><span class="n">qi_ihardlimit</span> <span class="o">=</span> <span class="n">hard</span><span class="p">;</span>
			<span class="n">q</span><span class="o">-&gt;</span><span class="n">qi_isoftlimit</span> <span class="o">=</span> <span class="n">soft</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">xfs_debug</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="s">&quot;ihard %Ld &lt; isoft %Ld</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">hard</span><span class="p">,</span> <span class="n">soft</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Update warnings counter(s) if requested</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">newlim</span><span class="o">-&gt;</span><span class="n">d_fieldmask</span> <span class="o">&amp;</span> <span class="n">FS_DQ_BWARNS</span><span class="p">)</span>
		<span class="n">ddq</span><span class="o">-&gt;</span><span class="n">d_bwarns</span> <span class="o">=</span> <span class="n">cpu_to_be16</span><span class="p">(</span><span class="n">newlim</span><span class="o">-&gt;</span><span class="n">d_bwarns</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">newlim</span><span class="o">-&gt;</span><span class="n">d_fieldmask</span> <span class="o">&amp;</span> <span class="n">FS_DQ_IWARNS</span><span class="p">)</span>
		<span class="n">ddq</span><span class="o">-&gt;</span><span class="n">d_iwarns</span> <span class="o">=</span> <span class="n">cpu_to_be16</span><span class="p">(</span><span class="n">newlim</span><span class="o">-&gt;</span><span class="n">d_iwarns</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">newlim</span><span class="o">-&gt;</span><span class="n">d_fieldmask</span> <span class="o">&amp;</span> <span class="n">FS_DQ_RTBWARNS</span><span class="p">)</span>
		<span class="n">ddq</span><span class="o">-&gt;</span><span class="n">d_rtbwarns</span> <span class="o">=</span> <span class="n">cpu_to_be16</span><span class="p">(</span><span class="n">newlim</span><span class="o">-&gt;</span><span class="n">d_rtbwarns</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">id</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Timelimits for the super user set the relative time</span>
<span class="cm">		 * the other users can be over quota for this file system.</span>
<span class="cm">		 * If it is zero a default is used.  Ditto for the default</span>
<span class="cm">		 * soft and hard limit values (already done, above), and</span>
<span class="cm">		 * for warnings.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">newlim</span><span class="o">-&gt;</span><span class="n">d_fieldmask</span> <span class="o">&amp;</span> <span class="n">FS_DQ_BTIMER</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">q</span><span class="o">-&gt;</span><span class="n">qi_btimelimit</span> <span class="o">=</span> <span class="n">newlim</span><span class="o">-&gt;</span><span class="n">d_btimer</span><span class="p">;</span>
			<span class="n">ddq</span><span class="o">-&gt;</span><span class="n">d_btimer</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">newlim</span><span class="o">-&gt;</span><span class="n">d_btimer</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">newlim</span><span class="o">-&gt;</span><span class="n">d_fieldmask</span> <span class="o">&amp;</span> <span class="n">FS_DQ_ITIMER</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">q</span><span class="o">-&gt;</span><span class="n">qi_itimelimit</span> <span class="o">=</span> <span class="n">newlim</span><span class="o">-&gt;</span><span class="n">d_itimer</span><span class="p">;</span>
			<span class="n">ddq</span><span class="o">-&gt;</span><span class="n">d_itimer</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">newlim</span><span class="o">-&gt;</span><span class="n">d_itimer</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">newlim</span><span class="o">-&gt;</span><span class="n">d_fieldmask</span> <span class="o">&amp;</span> <span class="n">FS_DQ_RTBTIMER</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">q</span><span class="o">-&gt;</span><span class="n">qi_rtbtimelimit</span> <span class="o">=</span> <span class="n">newlim</span><span class="o">-&gt;</span><span class="n">d_rtbtimer</span><span class="p">;</span>
			<span class="n">ddq</span><span class="o">-&gt;</span><span class="n">d_rtbtimer</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">newlim</span><span class="o">-&gt;</span><span class="n">d_rtbtimer</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">newlim</span><span class="o">-&gt;</span><span class="n">d_fieldmask</span> <span class="o">&amp;</span> <span class="n">FS_DQ_BWARNS</span><span class="p">)</span>
			<span class="n">q</span><span class="o">-&gt;</span><span class="n">qi_bwarnlimit</span> <span class="o">=</span> <span class="n">newlim</span><span class="o">-&gt;</span><span class="n">d_bwarns</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">newlim</span><span class="o">-&gt;</span><span class="n">d_fieldmask</span> <span class="o">&amp;</span> <span class="n">FS_DQ_IWARNS</span><span class="p">)</span>
			<span class="n">q</span><span class="o">-&gt;</span><span class="n">qi_iwarnlimit</span> <span class="o">=</span> <span class="n">newlim</span><span class="o">-&gt;</span><span class="n">d_iwarns</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">newlim</span><span class="o">-&gt;</span><span class="n">d_fieldmask</span> <span class="o">&amp;</span> <span class="n">FS_DQ_RTBWARNS</span><span class="p">)</span>
			<span class="n">q</span><span class="o">-&gt;</span><span class="n">qi_rtbwarnlimit</span> <span class="o">=</span> <span class="n">newlim</span><span class="o">-&gt;</span><span class="n">d_rtbwarns</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * If the user is now over quota, start the timelimit.</span>
<span class="cm">		 * The user will not be &#39;warned&#39;.</span>
<span class="cm">		 * Note that we keep the timers ticking, whether enforcement</span>
<span class="cm">		 * is on or off. We don&#39;t really want to bother with iterating</span>
<span class="cm">		 * over all ondisk dquots and turning the timers on/off.</span>
<span class="cm">		 */</span>
		<span class="n">xfs_qm_adjust_dqtimers</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="n">ddq</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">dqp</span><span class="o">-&gt;</span><span class="n">dq_flags</span> <span class="o">|=</span> <span class="n">XFS_DQ_DIRTY</span><span class="p">;</span>
	<span class="n">xfs_trans_log_dquot</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">dqp</span><span class="p">);</span>

	<span class="n">error</span> <span class="o">=</span> <span class="n">xfs_trans_commit</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">xfs_qm_dqrele</span><span class="p">(</span><span class="n">dqp</span><span class="p">);</span>

 <span class="nl">out_unlock:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">qi_quotaofflock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">STATIC</span> <span class="kt">int</span>
<span class="nf">xfs_qm_log_quotaoff_end</span><span class="p">(</span>
	<span class="n">xfs_mount_t</span>		<span class="o">*</span><span class="n">mp</span><span class="p">,</span>
	<span class="n">xfs_qoff_logitem_t</span>	<span class="o">*</span><span class="n">startqoff</span><span class="p">,</span>
	<span class="n">uint</span>			<span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">xfs_trans_t</span>		<span class="o">*</span><span class="n">tp</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">error</span><span class="p">;</span>
	<span class="n">xfs_qoff_logitem_t</span>	<span class="o">*</span><span class="n">qoffi</span><span class="p">;</span>

	<span class="n">tp</span> <span class="o">=</span> <span class="n">xfs_trans_alloc</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="n">XFS_TRANS_QM_QUOTAOFF_END</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">error</span> <span class="o">=</span> <span class="n">xfs_trans_reserve</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">xfs_qoff_logitem_t</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span><span class="p">,</span>
				      <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">XFS_DEFAULT_LOG_COUNT</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">xfs_trans_cancel</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">return</span> <span class="p">(</span><span class="n">error</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">qoffi</span> <span class="o">=</span> <span class="n">xfs_trans_get_qoff_item</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">startqoff</span><span class="p">,</span>
					<span class="n">flags</span> <span class="o">&amp;</span> <span class="n">XFS_ALL_QUOTA_ACCT</span><span class="p">);</span>
	<span class="n">xfs_trans_log_quotaoff_item</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">qoffi</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * We have to make sure that the transaction is secure on disk before we</span>
<span class="cm">	 * return and actually stop quota accounting. So, make it synchronous.</span>
<span class="cm">	 * We don&#39;t care about quotoff&#39;s performance.</span>
<span class="cm">	 */</span>
	<span class="n">xfs_trans_set_sync</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>
	<span class="n">error</span> <span class="o">=</span> <span class="n">xfs_trans_commit</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">error</span><span class="p">);</span>
<span class="p">}</span>


<span class="n">STATIC</span> <span class="kt">int</span>
<span class="nf">xfs_qm_log_quotaoff</span><span class="p">(</span>
	<span class="n">xfs_mount_t</span>	       <span class="o">*</span><span class="n">mp</span><span class="p">,</span>
	<span class="n">xfs_qoff_logitem_t</span>     <span class="o">**</span><span class="n">qoffstartp</span><span class="p">,</span>
	<span class="n">uint</span>		       <span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">xfs_trans_t</span>	       <span class="o">*</span><span class="n">tp</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">error</span><span class="p">;</span>
	<span class="n">xfs_qoff_logitem_t</span>     <span class="o">*</span><span class="n">qoffi</span><span class="o">=</span><span class="nb">NULL</span><span class="p">;</span>
	<span class="n">uint</span>			<span class="n">oldsbqflag</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>

	<span class="n">tp</span> <span class="o">=</span> <span class="n">xfs_trans_alloc</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="n">XFS_TRANS_QM_QUOTAOFF</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">error</span> <span class="o">=</span> <span class="n">xfs_trans_reserve</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
				      <span class="k">sizeof</span><span class="p">(</span><span class="n">xfs_qoff_logitem_t</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">+</span>
				      <span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_sb</span><span class="p">.</span><span class="n">sb_sectsize</span> <span class="o">+</span> <span class="mi">128</span><span class="p">,</span>
				      <span class="mi">0</span><span class="p">,</span>
				      <span class="mi">0</span><span class="p">,</span>
				      <span class="n">XFS_DEFAULT_LOG_COUNT</span><span class="p">)))</span> <span class="p">{</span>
		<span class="k">goto</span> <span class="n">error0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">qoffi</span> <span class="o">=</span> <span class="n">xfs_trans_get_qoff_item</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">flags</span> <span class="o">&amp;</span> <span class="n">XFS_ALL_QUOTA_ACCT</span><span class="p">);</span>
	<span class="n">xfs_trans_log_quotaoff_item</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">qoffi</span><span class="p">);</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_sb_lock</span><span class="p">);</span>
	<span class="n">oldsbqflag</span> <span class="o">=</span> <span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_sb</span><span class="p">.</span><span class="n">sb_qflags</span><span class="p">;</span>
	<span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_sb</span><span class="p">.</span><span class="n">sb_qflags</span> <span class="o">=</span> <span class="p">(</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_qflags</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">flags</span><span class="p">))</span> <span class="o">&amp;</span> <span class="n">XFS_MOUNT_QUOTA_ALL</span><span class="p">;</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_sb_lock</span><span class="p">);</span>

	<span class="n">xfs_mod_sb</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">XFS_SB_QFLAGS</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * We have to make sure that the transaction is secure on disk before we</span>
<span class="cm">	 * return and actually stop quota accounting. So, make it synchronous.</span>
<span class="cm">	 * We don&#39;t care about quotoff&#39;s performance.</span>
<span class="cm">	 */</span>
	<span class="n">xfs_trans_set_sync</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>
	<span class="n">error</span> <span class="o">=</span> <span class="n">xfs_trans_commit</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

<span class="nl">error0:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">xfs_trans_cancel</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="cm">/*</span>
<span class="cm">		 * No one else is modifying sb_qflags, so this is OK.</span>
<span class="cm">		 * We still hold the quotaofflock.</span>
<span class="cm">		 */</span>
		<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_sb_lock</span><span class="p">);</span>
		<span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_sb</span><span class="p">.</span><span class="n">sb_qflags</span> <span class="o">=</span> <span class="n">oldsbqflag</span><span class="p">;</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_sb_lock</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="o">*</span><span class="n">qoffstartp</span> <span class="o">=</span> <span class="n">qoffi</span><span class="p">;</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">error</span><span class="p">);</span>
<span class="p">}</span>


<span class="kt">int</span>
<span class="nf">xfs_qm_scall_getquota</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">xfs_mount</span>	<span class="o">*</span><span class="n">mp</span><span class="p">,</span>
	<span class="n">xfs_dqid_t</span>		<span class="n">id</span><span class="p">,</span>
	<span class="n">uint</span>			<span class="n">type</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">fs_disk_quota</span>	<span class="o">*</span><span class="n">dst</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">xfs_dquot</span>	<span class="o">*</span><span class="n">dqp</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">error</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Try to get the dquot. We don&#39;t want it allocated on disk, so</span>
<span class="cm">	 * we aren&#39;t passing the XFS_QMOPT_DOALLOC flag. If it doesn&#39;t</span>
<span class="cm">	 * exist, we&#39;ll get ENOENT back.</span>
<span class="cm">	 */</span>
	<span class="n">error</span> <span class="o">=</span> <span class="n">xfs_qm_dqget</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">id</span><span class="p">,</span> <span class="n">type</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dqp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">error</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * If everything&#39;s NULL, this dquot doesn&#39;t quite exist as far as</span>
<span class="cm">	 * our utility programs are concerned.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">XFS_IS_DQUOT_UNINITIALIZED</span><span class="p">(</span><span class="n">dqp</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">error</span> <span class="o">=</span> <span class="n">XFS_ERROR</span><span class="p">(</span><span class="n">ENOENT</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_put</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">dst</span><span class="p">));</span>
	<span class="n">dst</span><span class="o">-&gt;</span><span class="n">d_version</span> <span class="o">=</span> <span class="n">FS_DQUOT_VERSION</span><span class="p">;</span>
	<span class="n">dst</span><span class="o">-&gt;</span><span class="n">d_flags</span> <span class="o">=</span> <span class="n">xfs_qm_export_qtype_flags</span><span class="p">(</span><span class="n">dqp</span><span class="o">-&gt;</span><span class="n">q_core</span><span class="p">.</span><span class="n">d_flags</span><span class="p">);</span>
	<span class="n">dst</span><span class="o">-&gt;</span><span class="n">d_id</span> <span class="o">=</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">dqp</span><span class="o">-&gt;</span><span class="n">q_core</span><span class="p">.</span><span class="n">d_id</span><span class="p">);</span>
	<span class="n">dst</span><span class="o">-&gt;</span><span class="n">d_blk_hardlimit</span> <span class="o">=</span>
		<span class="n">XFS_FSB_TO_BB</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="n">be64_to_cpu</span><span class="p">(</span><span class="n">dqp</span><span class="o">-&gt;</span><span class="n">q_core</span><span class="p">.</span><span class="n">d_blk_hardlimit</span><span class="p">));</span>
	<span class="n">dst</span><span class="o">-&gt;</span><span class="n">d_blk_softlimit</span> <span class="o">=</span>
		<span class="n">XFS_FSB_TO_BB</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="n">be64_to_cpu</span><span class="p">(</span><span class="n">dqp</span><span class="o">-&gt;</span><span class="n">q_core</span><span class="p">.</span><span class="n">d_blk_softlimit</span><span class="p">));</span>
	<span class="n">dst</span><span class="o">-&gt;</span><span class="n">d_ino_hardlimit</span> <span class="o">=</span> <span class="n">be64_to_cpu</span><span class="p">(</span><span class="n">dqp</span><span class="o">-&gt;</span><span class="n">q_core</span><span class="p">.</span><span class="n">d_ino_hardlimit</span><span class="p">);</span>
	<span class="n">dst</span><span class="o">-&gt;</span><span class="n">d_ino_softlimit</span> <span class="o">=</span> <span class="n">be64_to_cpu</span><span class="p">(</span><span class="n">dqp</span><span class="o">-&gt;</span><span class="n">q_core</span><span class="p">.</span><span class="n">d_ino_softlimit</span><span class="p">);</span>
	<span class="n">dst</span><span class="o">-&gt;</span><span class="n">d_bcount</span> <span class="o">=</span> <span class="n">XFS_FSB_TO_BB</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="n">dqp</span><span class="o">-&gt;</span><span class="n">q_res_bcount</span><span class="p">);</span>
	<span class="n">dst</span><span class="o">-&gt;</span><span class="n">d_icount</span> <span class="o">=</span> <span class="n">dqp</span><span class="o">-&gt;</span><span class="n">q_res_icount</span><span class="p">;</span>
	<span class="n">dst</span><span class="o">-&gt;</span><span class="n">d_btimer</span> <span class="o">=</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">dqp</span><span class="o">-&gt;</span><span class="n">q_core</span><span class="p">.</span><span class="n">d_btimer</span><span class="p">);</span>
	<span class="n">dst</span><span class="o">-&gt;</span><span class="n">d_itimer</span> <span class="o">=</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">dqp</span><span class="o">-&gt;</span><span class="n">q_core</span><span class="p">.</span><span class="n">d_itimer</span><span class="p">);</span>
	<span class="n">dst</span><span class="o">-&gt;</span><span class="n">d_iwarns</span> <span class="o">=</span> <span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">dqp</span><span class="o">-&gt;</span><span class="n">q_core</span><span class="p">.</span><span class="n">d_iwarns</span><span class="p">);</span>
	<span class="n">dst</span><span class="o">-&gt;</span><span class="n">d_bwarns</span> <span class="o">=</span> <span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">dqp</span><span class="o">-&gt;</span><span class="n">q_core</span><span class="p">.</span><span class="n">d_bwarns</span><span class="p">);</span>
	<span class="n">dst</span><span class="o">-&gt;</span><span class="n">d_rtb_hardlimit</span> <span class="o">=</span>
		<span class="n">XFS_FSB_TO_BB</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="n">be64_to_cpu</span><span class="p">(</span><span class="n">dqp</span><span class="o">-&gt;</span><span class="n">q_core</span><span class="p">.</span><span class="n">d_rtb_hardlimit</span><span class="p">));</span>
	<span class="n">dst</span><span class="o">-&gt;</span><span class="n">d_rtb_softlimit</span> <span class="o">=</span>
		<span class="n">XFS_FSB_TO_BB</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="n">be64_to_cpu</span><span class="p">(</span><span class="n">dqp</span><span class="o">-&gt;</span><span class="n">q_core</span><span class="p">.</span><span class="n">d_rtb_softlimit</span><span class="p">));</span>
	<span class="n">dst</span><span class="o">-&gt;</span><span class="n">d_rtbcount</span> <span class="o">=</span> <span class="n">XFS_FSB_TO_BB</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="n">dqp</span><span class="o">-&gt;</span><span class="n">q_res_rtbcount</span><span class="p">);</span>
	<span class="n">dst</span><span class="o">-&gt;</span><span class="n">d_rtbtimer</span> <span class="o">=</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">dqp</span><span class="o">-&gt;</span><span class="n">q_core</span><span class="p">.</span><span class="n">d_rtbtimer</span><span class="p">);</span>
	<span class="n">dst</span><span class="o">-&gt;</span><span class="n">d_rtbwarns</span> <span class="o">=</span> <span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">dqp</span><span class="o">-&gt;</span><span class="n">q_core</span><span class="p">.</span><span class="n">d_rtbwarns</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Internally, we don&#39;t reset all the timers when quota enforcement</span>
<span class="cm">	 * gets turned off. No need to confuse the user level code,</span>
<span class="cm">	 * so return zeroes in that case.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">((</span><span class="o">!</span><span class="n">XFS_IS_UQUOTA_ENFORCED</span><span class="p">(</span><span class="n">mp</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">dqp</span><span class="o">-&gt;</span><span class="n">q_core</span><span class="p">.</span><span class="n">d_flags</span> <span class="o">==</span> <span class="n">XFS_DQ_USER</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="o">!</span><span class="n">XFS_IS_OQUOTA_ENFORCED</span><span class="p">(</span><span class="n">mp</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			<span class="p">(</span><span class="n">dqp</span><span class="o">-&gt;</span><span class="n">q_core</span><span class="p">.</span><span class="n">d_flags</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">XFS_DQ_PROJ</span> <span class="o">|</span> <span class="n">XFS_DQ_GROUP</span><span class="p">))))</span> <span class="p">{</span>
		<span class="n">dst</span><span class="o">-&gt;</span><span class="n">d_btimer</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">dst</span><span class="o">-&gt;</span><span class="n">d_itimer</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">dst</span><span class="o">-&gt;</span><span class="n">d_rtbtimer</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

<span class="cp">#ifdef DEBUG</span>
	<span class="k">if</span> <span class="p">(((</span><span class="n">XFS_IS_UQUOTA_ENFORCED</span><span class="p">(</span><span class="n">mp</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">dst</span><span class="o">-&gt;</span><span class="n">d_flags</span> <span class="o">==</span> <span class="n">FS_USER_QUOTA</span><span class="p">)</span> <span class="o">||</span>
	     <span class="p">(</span><span class="n">XFS_IS_OQUOTA_ENFORCED</span><span class="p">(</span><span class="n">mp</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			<span class="p">(</span><span class="n">dst</span><span class="o">-&gt;</span><span class="n">d_flags</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">FS_PROJ_QUOTA</span> <span class="o">|</span> <span class="n">FS_GROUP_QUOTA</span><span class="p">))))</span> <span class="o">&amp;&amp;</span>
	    <span class="n">dst</span><span class="o">-&gt;</span><span class="n">d_id</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(((</span><span class="kt">int</span><span class="p">)</span> <span class="n">dst</span><span class="o">-&gt;</span><span class="n">d_bcount</span> <span class="o">&gt;</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="n">dst</span><span class="o">-&gt;</span><span class="n">d_blk_softlimit</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">dst</span><span class="o">-&gt;</span><span class="n">d_blk_softlimit</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">ASSERT</span><span class="p">(</span><span class="n">dst</span><span class="o">-&gt;</span><span class="n">d_btimer</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(((</span><span class="kt">int</span><span class="p">)</span> <span class="n">dst</span><span class="o">-&gt;</span><span class="n">d_icount</span> <span class="o">&gt;</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="n">dst</span><span class="o">-&gt;</span><span class="n">d_ino_softlimit</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">dst</span><span class="o">-&gt;</span><span class="n">d_ino_softlimit</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">ASSERT</span><span class="p">(</span><span class="n">dst</span><span class="o">-&gt;</span><span class="n">d_itimer</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
<span class="nl">out_put:</span>
	<span class="n">xfs_qm_dqput</span><span class="p">(</span><span class="n">dqp</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">STATIC</span> <span class="n">uint</span>
<span class="nf">xfs_qm_export_qtype_flags</span><span class="p">(</span>
	<span class="n">uint</span> <span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/*</span>
<span class="cm">	 * Can&#39;t be more than one, or none.</span>
<span class="cm">	 */</span>
	<span class="n">ASSERT</span><span class="p">((</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">FS_PROJ_QUOTA</span> <span class="o">|</span> <span class="n">FS_USER_QUOTA</span><span class="p">))</span> <span class="o">!=</span>
		<span class="p">(</span><span class="n">FS_PROJ_QUOTA</span> <span class="o">|</span> <span class="n">FS_USER_QUOTA</span><span class="p">));</span>
	<span class="n">ASSERT</span><span class="p">((</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">FS_PROJ_QUOTA</span> <span class="o">|</span> <span class="n">FS_GROUP_QUOTA</span><span class="p">))</span> <span class="o">!=</span>
		<span class="p">(</span><span class="n">FS_PROJ_QUOTA</span> <span class="o">|</span> <span class="n">FS_GROUP_QUOTA</span><span class="p">));</span>
	<span class="n">ASSERT</span><span class="p">((</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">FS_USER_QUOTA</span> <span class="o">|</span> <span class="n">FS_GROUP_QUOTA</span><span class="p">))</span> <span class="o">!=</span>
		<span class="p">(</span><span class="n">FS_USER_QUOTA</span> <span class="o">|</span> <span class="n">FS_GROUP_QUOTA</span><span class="p">));</span>
	<span class="n">ASSERT</span><span class="p">((</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">FS_PROJ_QUOTA</span><span class="o">|</span><span class="n">FS_USER_QUOTA</span><span class="o">|</span><span class="n">FS_GROUP_QUOTA</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">XFS_DQ_USER</span><span class="p">)</span> <span class="o">?</span>
		<span class="n">FS_USER_QUOTA</span> <span class="o">:</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">XFS_DQ_PROJ</span><span class="p">)</span> <span class="o">?</span>
			<span class="n">FS_PROJ_QUOTA</span> <span class="o">:</span> <span class="n">FS_GROUP_QUOTA</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">STATIC</span> <span class="n">uint</span>
<span class="nf">xfs_qm_export_flags</span><span class="p">(</span>
	<span class="n">uint</span> <span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">uint</span> <span class="n">uflags</span><span class="p">;</span>

	<span class="n">uflags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">XFS_UQUOTA_ACCT</span><span class="p">)</span>
		<span class="n">uflags</span> <span class="o">|=</span> <span class="n">FS_QUOTA_UDQ_ACCT</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">XFS_PQUOTA_ACCT</span><span class="p">)</span>
		<span class="n">uflags</span> <span class="o">|=</span> <span class="n">FS_QUOTA_PDQ_ACCT</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">XFS_GQUOTA_ACCT</span><span class="p">)</span>
		<span class="n">uflags</span> <span class="o">|=</span> <span class="n">FS_QUOTA_GDQ_ACCT</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">XFS_UQUOTA_ENFD</span><span class="p">)</span>
		<span class="n">uflags</span> <span class="o">|=</span> <span class="n">FS_QUOTA_UDQ_ENFD</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">XFS_OQUOTA_ENFD</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">uflags</span> <span class="o">|=</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">XFS_GQUOTA_ACCT</span><span class="p">)</span> <span class="o">?</span>
			<span class="n">FS_QUOTA_GDQ_ENFD</span> <span class="o">:</span> <span class="n">FS_QUOTA_PDQ_ENFD</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">uflags</span><span class="p">);</span>
<span class="p">}</span>


<span class="n">STATIC</span> <span class="kt">int</span>
<span class="nf">xfs_dqrele_inode</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">xfs_inode</span>	<span class="o">*</span><span class="n">ip</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">xfs_perag</span>	<span class="o">*</span><span class="n">pag</span><span class="p">,</span>
	<span class="kt">int</span>			<span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* skip quota inodes */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ip</span> <span class="o">==</span> <span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_mount</span><span class="o">-&gt;</span><span class="n">m_quotainfo</span><span class="o">-&gt;</span><span class="n">qi_uquotaip</span> <span class="o">||</span>
	    <span class="n">ip</span> <span class="o">==</span> <span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_mount</span><span class="o">-&gt;</span><span class="n">m_quotainfo</span><span class="o">-&gt;</span><span class="n">qi_gquotaip</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ASSERT</span><span class="p">(</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_udquot</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="n">ASSERT</span><span class="p">(</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_gdquot</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">xfs_ilock</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">XFS_ILOCK_EXCL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">XFS_UQUOTA_ACCT</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_udquot</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">xfs_qm_dqrele</span><span class="p">(</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_udquot</span><span class="p">);</span>
		<span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_udquot</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">XFS_PQUOTA_ACCT</span><span class="o">|</span><span class="n">XFS_GQUOTA_ACCT</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_gdquot</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">xfs_qm_dqrele</span><span class="p">(</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_gdquot</span><span class="p">);</span>
		<span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_gdquot</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">xfs_iunlock</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">XFS_ILOCK_EXCL</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * Go thru all the inodes in the file system, releasing their dquots.</span>
<span class="cm"> *</span>
<span class="cm"> * Note that the mount structure gets modified to indicate that quotas are off</span>
<span class="cm"> * AFTER this, in the case of quotaoff.</span>
<span class="cm"> */</span>
<span class="kt">void</span>
<span class="nf">xfs_qm_dqrele_all_inodes</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">xfs_mount</span> <span class="o">*</span><span class="n">mp</span><span class="p">,</span>
	<span class="n">uint</span>		 <span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ASSERT</span><span class="p">(</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_quotainfo</span><span class="p">);</span>
	<span class="n">xfs_inode_ag_iterator</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="n">xfs_dqrele_inode</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
