<!DOCTYPE html>
<html><head><title>joekychen/linux » fs › xfs › xfs_super.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>xfs_super.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Copyright (c) 2000-2006 Silicon Graphics, Inc.</span>
<span class="cm"> * All Rights Reserved.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or</span>
<span class="cm"> * modify it under the terms of the GNU General Public License as</span>
<span class="cm"> * published by the Free Software Foundation.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is distributed in the hope that it would be useful,</span>
<span class="cm"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm"> * GNU General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> * You should have received a copy of the GNU General Public License</span>
<span class="cm"> * along with this program; if not, write the Free Software Foundation,</span>
<span class="cm"> * Inc.,  51 Franklin St, Fifth Floor, Boston, MA  02110-1301  USA</span>
<span class="cm"> */</span>

<span class="cp">#include &quot;xfs.h&quot;</span>
<span class="cp">#include &quot;xfs_log.h&quot;</span>
<span class="cp">#include &quot;xfs_inum.h&quot;</span>
<span class="cp">#include &quot;xfs_trans.h&quot;</span>
<span class="cp">#include &quot;xfs_sb.h&quot;</span>
<span class="cp">#include &quot;xfs_ag.h&quot;</span>
<span class="cp">#include &quot;xfs_dir2.h&quot;</span>
<span class="cp">#include &quot;xfs_alloc.h&quot;</span>
<span class="cp">#include &quot;xfs_quota.h&quot;</span>
<span class="cp">#include &quot;xfs_mount.h&quot;</span>
<span class="cp">#include &quot;xfs_bmap_btree.h&quot;</span>
<span class="cp">#include &quot;xfs_alloc_btree.h&quot;</span>
<span class="cp">#include &quot;xfs_ialloc_btree.h&quot;</span>
<span class="cp">#include &quot;xfs_dinode.h&quot;</span>
<span class="cp">#include &quot;xfs_inode.h&quot;</span>
<span class="cp">#include &quot;xfs_btree.h&quot;</span>
<span class="cp">#include &quot;xfs_ialloc.h&quot;</span>
<span class="cp">#include &quot;xfs_bmap.h&quot;</span>
<span class="cp">#include &quot;xfs_rtalloc.h&quot;</span>
<span class="cp">#include &quot;xfs_error.h&quot;</span>
<span class="cp">#include &quot;xfs_itable.h&quot;</span>
<span class="cp">#include &quot;xfs_fsops.h&quot;</span>
<span class="cp">#include &quot;xfs_attr.h&quot;</span>
<span class="cp">#include &quot;xfs_buf_item.h&quot;</span>
<span class="cp">#include &quot;xfs_utils.h&quot;</span>
<span class="cp">#include &quot;xfs_vnodeops.h&quot;</span>
<span class="cp">#include &quot;xfs_log_priv.h&quot;</span>
<span class="cp">#include &quot;xfs_trans_priv.h&quot;</span>
<span class="cp">#include &quot;xfs_filestream.h&quot;</span>
<span class="cp">#include &quot;xfs_da_btree.h&quot;</span>
<span class="cp">#include &quot;xfs_extfree_item.h&quot;</span>
<span class="cp">#include &quot;xfs_mru_cache.h&quot;</span>
<span class="cp">#include &quot;xfs_inode_item.h&quot;</span>
<span class="cp">#include &quot;xfs_sync.h&quot;</span>
<span class="cp">#include &quot;xfs_trace.h&quot;</span>

<span class="cp">#include &lt;linux/namei.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/mount.h&gt;</span>
<span class="cp">#include &lt;linux/mempool.h&gt;</span>
<span class="cp">#include &lt;linux/writeback.h&gt;</span>
<span class="cp">#include &lt;linux/kthread.h&gt;</span>
<span class="cp">#include &lt;linux/freezer.h&gt;</span>
<span class="cp">#include &lt;linux/parser.h&gt;</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">super_operations</span> <span class="n">xfs_super_operations</span><span class="p">;</span>
<span class="k">static</span> <span class="n">kmem_zone_t</span> <span class="o">*</span><span class="n">xfs_ioend_zone</span><span class="p">;</span>
<span class="n">mempool_t</span> <span class="o">*</span><span class="n">xfs_ioend_pool</span><span class="p">;</span>

<span class="cp">#define MNTOPT_LOGBUFS	&quot;logbufs&quot;	</span><span class="cm">/* number of XFS log buffers */</span><span class="cp"></span>
<span class="cp">#define MNTOPT_LOGBSIZE	&quot;logbsize&quot;	</span><span class="cm">/* size of XFS log buffers */</span><span class="cp"></span>
<span class="cp">#define MNTOPT_LOGDEV	&quot;logdev&quot;	</span><span class="cm">/* log device */</span><span class="cp"></span>
<span class="cp">#define MNTOPT_RTDEV	&quot;rtdev&quot;		</span><span class="cm">/* realtime I/O device */</span><span class="cp"></span>
<span class="cp">#define MNTOPT_BIOSIZE	&quot;biosize&quot;	</span><span class="cm">/* log2 of preferred buffered io size */</span><span class="cp"></span>
<span class="cp">#define MNTOPT_WSYNC	&quot;wsync&quot;		</span><span class="cm">/* safe-mode nfs compatible mount */</span><span class="cp"></span>
<span class="cp">#define MNTOPT_NOALIGN	&quot;noalign&quot;	</span><span class="cm">/* turn off stripe alignment */</span><span class="cp"></span>
<span class="cp">#define MNTOPT_SWALLOC	&quot;swalloc&quot;	</span><span class="cm">/* turn on stripe width allocation */</span><span class="cp"></span>
<span class="cp">#define MNTOPT_SUNIT	&quot;sunit&quot;		</span><span class="cm">/* data volume stripe unit */</span><span class="cp"></span>
<span class="cp">#define MNTOPT_SWIDTH	&quot;swidth&quot;	</span><span class="cm">/* data volume stripe width */</span><span class="cp"></span>
<span class="cp">#define MNTOPT_NOUUID	&quot;nouuid&quot;	</span><span class="cm">/* ignore filesystem UUID */</span><span class="cp"></span>
<span class="cp">#define MNTOPT_MTPT	&quot;mtpt&quot;		</span><span class="cm">/* filesystem mount point */</span><span class="cp"></span>
<span class="cp">#define MNTOPT_GRPID	&quot;grpid&quot;		</span><span class="cm">/* group-ID from parent directory */</span><span class="cp"></span>
<span class="cp">#define MNTOPT_NOGRPID	&quot;nogrpid&quot;	</span><span class="cm">/* group-ID from current process */</span><span class="cp"></span>
<span class="cp">#define MNTOPT_BSDGROUPS    &quot;bsdgroups&quot;    </span><span class="cm">/* group-ID from parent directory */</span><span class="cp"></span>
<span class="cp">#define MNTOPT_SYSVGROUPS   &quot;sysvgroups&quot;   </span><span class="cm">/* group-ID from current process */</span><span class="cp"></span>
<span class="cp">#define MNTOPT_ALLOCSIZE    &quot;allocsize&quot;    </span><span class="cm">/* preferred allocation size */</span><span class="cp"></span>
<span class="cp">#define MNTOPT_NORECOVERY   &quot;norecovery&quot;   </span><span class="cm">/* don&#39;t run XFS recovery */</span><span class="cp"></span>
<span class="cp">#define MNTOPT_BARRIER	&quot;barrier&quot;	</span><span class="cm">/* use writer barriers for log write and</span>
<span class="cm">					 * unwritten extent conversion */</span><span class="cp"></span>
<span class="cp">#define MNTOPT_NOBARRIER &quot;nobarrier&quot;	</span><span class="cm">/* .. disable */</span><span class="cp"></span>
<span class="cp">#define MNTOPT_64BITINODE   &quot;inode64&quot;	</span><span class="cm">/* inodes can be allocated anywhere */</span><span class="cp"></span>
<span class="cp">#define MNTOPT_IKEEP	&quot;ikeep&quot;		</span><span class="cm">/* do not free empty inode clusters */</span><span class="cp"></span>
<span class="cp">#define MNTOPT_NOIKEEP	&quot;noikeep&quot;	</span><span class="cm">/* free empty inode clusters */</span><span class="cp"></span>
<span class="cp">#define MNTOPT_LARGEIO	   &quot;largeio&quot;	</span><span class="cm">/* report large I/O sizes in stat() */</span><span class="cp"></span>
<span class="cp">#define MNTOPT_NOLARGEIO   &quot;nolargeio&quot;	</span><span class="cm">/* do not report large I/O sizes</span>
<span class="cm">					 * in stat(). */</span><span class="cp"></span>
<span class="cp">#define MNTOPT_ATTR2	&quot;attr2&quot;		</span><span class="cm">/* do use attr2 attribute format */</span><span class="cp"></span>
<span class="cp">#define MNTOPT_NOATTR2	&quot;noattr2&quot;	</span><span class="cm">/* do not use attr2 attribute format */</span><span class="cp"></span>
<span class="cp">#define MNTOPT_FILESTREAM  &quot;filestreams&quot; </span><span class="cm">/* use filestreams allocator */</span><span class="cp"></span>
<span class="cp">#define MNTOPT_QUOTA	&quot;quota&quot;		</span><span class="cm">/* disk quotas (user) */</span><span class="cp"></span>
<span class="cp">#define MNTOPT_NOQUOTA	&quot;noquota&quot;	</span><span class="cm">/* no quotas */</span><span class="cp"></span>
<span class="cp">#define MNTOPT_USRQUOTA	&quot;usrquota&quot;	</span><span class="cm">/* user quota enabled */</span><span class="cp"></span>
<span class="cp">#define MNTOPT_GRPQUOTA	&quot;grpquota&quot;	</span><span class="cm">/* group quota enabled */</span><span class="cp"></span>
<span class="cp">#define MNTOPT_PRJQUOTA	&quot;prjquota&quot;	</span><span class="cm">/* project quota enabled */</span><span class="cp"></span>
<span class="cp">#define MNTOPT_UQUOTA	&quot;uquota&quot;	</span><span class="cm">/* user quota (IRIX variant) */</span><span class="cp"></span>
<span class="cp">#define MNTOPT_GQUOTA	&quot;gquota&quot;	</span><span class="cm">/* group quota (IRIX variant) */</span><span class="cp"></span>
<span class="cp">#define MNTOPT_PQUOTA	&quot;pquota&quot;	</span><span class="cm">/* project quota (IRIX variant) */</span><span class="cp"></span>
<span class="cp">#define MNTOPT_UQUOTANOENF &quot;uqnoenforce&quot;</span><span class="cm">/* user quota limit enforcement */</span><span class="cp"></span>
<span class="cp">#define MNTOPT_GQUOTANOENF &quot;gqnoenforce&quot;</span><span class="cm">/* group quota limit enforcement */</span><span class="cp"></span>
<span class="cp">#define MNTOPT_PQUOTANOENF &quot;pqnoenforce&quot;</span><span class="cm">/* project quota limit enforcement */</span><span class="cp"></span>
<span class="cp">#define MNTOPT_QUOTANOENF  &quot;qnoenforce&quot;	</span><span class="cm">/* same as uqnoenforce */</span><span class="cp"></span>
<span class="cp">#define MNTOPT_DELAYLOG    &quot;delaylog&quot;	</span><span class="cm">/* Delayed logging enabled */</span><span class="cp"></span>
<span class="cp">#define MNTOPT_NODELAYLOG  &quot;nodelaylog&quot;	</span><span class="cm">/* Delayed logging disabled */</span><span class="cp"></span>
<span class="cp">#define MNTOPT_DISCARD	   &quot;discard&quot;	</span><span class="cm">/* Discard unused blocks */</span><span class="cp"></span>
<span class="cp">#define MNTOPT_NODISCARD   &quot;nodiscard&quot;	</span><span class="cm">/* Do not discard unused blocks */</span><span class="cp"></span>

<span class="cm">/*</span>
<span class="cm"> * Table driven mount option parser.</span>
<span class="cm"> *</span>
<span class="cm"> * Currently only used for remount, but it will be used for mount</span>
<span class="cm"> * in the future, too.</span>
<span class="cm"> */</span>
<span class="k">enum</span> <span class="p">{</span>
	<span class="n">Opt_barrier</span><span class="p">,</span> <span class="n">Opt_nobarrier</span><span class="p">,</span> <span class="n">Opt_err</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="n">match_table_t</span> <span class="n">tokens</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span><span class="n">Opt_barrier</span><span class="p">,</span> <span class="s">&quot;barrier&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">Opt_nobarrier</span><span class="p">,</span> <span class="s">&quot;nobarrier&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">Opt_err</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">}</span>
<span class="p">};</span>


<span class="n">STATIC</span> <span class="kt">unsigned</span> <span class="kt">long</span>
<span class="nf">suffix_strtoul</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">endp</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">base</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span>	<span class="n">last</span><span class="p">,</span> <span class="n">shift_left_factor</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">char</span>	<span class="o">*</span><span class="n">value</span> <span class="o">=</span> <span class="n">s</span><span class="p">;</span>

	<span class="n">last</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">value</span><span class="p">[</span><span class="n">last</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;K&#39;</span> <span class="o">||</span> <span class="n">value</span><span class="p">[</span><span class="n">last</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;k&#39;</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">shift_left_factor</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
		<span class="n">value</span><span class="p">[</span><span class="n">last</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">value</span><span class="p">[</span><span class="n">last</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;M&#39;</span> <span class="o">||</span> <span class="n">value</span><span class="p">[</span><span class="n">last</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;m&#39;</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">shift_left_factor</span> <span class="o">=</span> <span class="mi">20</span><span class="p">;</span>
		<span class="n">value</span><span class="p">[</span><span class="n">last</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">value</span><span class="p">[</span><span class="n">last</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;G&#39;</span> <span class="o">||</span> <span class="n">value</span><span class="p">[</span><span class="n">last</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;g&#39;</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">shift_left_factor</span> <span class="o">=</span> <span class="mi">30</span><span class="p">;</span>
		<span class="n">value</span><span class="p">[</span><span class="n">last</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">simple_strtoul</span><span class="p">((</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">s</span><span class="p">,</span> <span class="n">endp</span><span class="p">,</span> <span class="n">base</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">shift_left_factor</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * This function fills in xfs_mount_t fields based on mount args.</span>
<span class="cm"> * Note: the superblock has _not_ yet been read in.</span>
<span class="cm"> *</span>
<span class="cm"> * Note that this function leaks the various device name allocations on</span>
<span class="cm"> * failure.  The caller takes care of them.</span>
<span class="cm"> */</span>
<span class="n">STATIC</span> <span class="kt">int</span>
<span class="nf">xfs_parseargs</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">xfs_mount</span>	<span class="o">*</span><span class="n">mp</span><span class="p">,</span>
	<span class="kt">char</span>			<span class="o">*</span><span class="n">options</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">super_block</span>	<span class="o">*</span><span class="n">sb</span> <span class="o">=</span> <span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_super</span><span class="p">;</span>
	<span class="kt">char</span>			<span class="o">*</span><span class="n">this_char</span><span class="p">,</span> <span class="o">*</span><span class="n">value</span><span class="p">,</span> <span class="o">*</span><span class="n">eov</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">dsunit</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">dswidth</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">iosize</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">__uint8_t</span>		<span class="n">iosizelog</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * set up the mount name first so all the errors will refer to the</span>
<span class="cm">	 * correct device.</span>
<span class="cm">	 */</span>
	<span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_fsname</span> <span class="o">=</span> <span class="n">kstrndup</span><span class="p">(</span><span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_id</span><span class="p">,</span> <span class="n">MAXNAMELEN</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_fsname</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_fsname_len</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_fsname</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Copy binary VFS mount flags we are interested in.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_flags</span> <span class="o">&amp;</span> <span class="n">MS_RDONLY</span><span class="p">)</span>
		<span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_flags</span> <span class="o">|=</span> <span class="n">XFS_MOUNT_RDONLY</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_flags</span> <span class="o">&amp;</span> <span class="n">MS_DIRSYNC</span><span class="p">)</span>
		<span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_flags</span> <span class="o">|=</span> <span class="n">XFS_MOUNT_DIRSYNC</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_flags</span> <span class="o">&amp;</span> <span class="n">MS_SYNCHRONOUS</span><span class="p">)</span>
		<span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_flags</span> <span class="o">|=</span> <span class="n">XFS_MOUNT_WSYNC</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Set some default flags that could be cleared by the mount option</span>
<span class="cm">	 * parsing.</span>
<span class="cm">	 */</span>
	<span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_flags</span> <span class="o">|=</span> <span class="n">XFS_MOUNT_BARRIER</span><span class="p">;</span>
	<span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_flags</span> <span class="o">|=</span> <span class="n">XFS_MOUNT_COMPAT_IOSIZE</span><span class="p">;</span>
	<span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_flags</span> <span class="o">|=</span> <span class="n">XFS_MOUNT_SMALL_INUMS</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * These can be overridden by the mount option parsing.</span>
<span class="cm">	 */</span>
	<span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_logbufs</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_logbsize</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">options</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">((</span><span class="n">this_char</span> <span class="o">=</span> <span class="n">strsep</span><span class="p">(</span><span class="o">&amp;</span><span class="n">options</span><span class="p">,</span> <span class="s">&quot;,&quot;</span><span class="p">))</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!*</span><span class="n">this_char</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">value</span> <span class="o">=</span> <span class="n">strchr</span><span class="p">(</span><span class="n">this_char</span><span class="p">,</span> <span class="sc">&#39;=&#39;</span><span class="p">))</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="o">*</span><span class="n">value</span><span class="o">++</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">this_char</span><span class="p">,</span> <span class="n">MNTOPT_LOGBUFS</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">value</span> <span class="o">||</span> <span class="o">!*</span><span class="n">value</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">xfs_warn</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="s">&quot;%s option requires an argument&quot;</span><span class="p">,</span>
					<span class="n">this_char</span><span class="p">);</span>
				<span class="k">return</span> <span class="n">EINVAL</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_logbufs</span> <span class="o">=</span> <span class="n">simple_strtoul</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">eov</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">this_char</span><span class="p">,</span> <span class="n">MNTOPT_LOGBSIZE</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">value</span> <span class="o">||</span> <span class="o">!*</span><span class="n">value</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">xfs_warn</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="s">&quot;%s option requires an argument&quot;</span><span class="p">,</span>
					<span class="n">this_char</span><span class="p">);</span>
				<span class="k">return</span> <span class="n">EINVAL</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_logbsize</span> <span class="o">=</span> <span class="n">suffix_strtoul</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">eov</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">this_char</span><span class="p">,</span> <span class="n">MNTOPT_LOGDEV</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">value</span> <span class="o">||</span> <span class="o">!*</span><span class="n">value</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">xfs_warn</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="s">&quot;%s option requires an argument&quot;</span><span class="p">,</span>
					<span class="n">this_char</span><span class="p">);</span>
				<span class="k">return</span> <span class="n">EINVAL</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_logname</span> <span class="o">=</span> <span class="n">kstrndup</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">MAXNAMELEN</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_logname</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">ENOMEM</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">this_char</span><span class="p">,</span> <span class="n">MNTOPT_MTPT</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">xfs_warn</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="s">&quot;%s option not allowed on this system&quot;</span><span class="p">,</span>
				<span class="n">this_char</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">this_char</span><span class="p">,</span> <span class="n">MNTOPT_RTDEV</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">value</span> <span class="o">||</span> <span class="o">!*</span><span class="n">value</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">xfs_warn</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="s">&quot;%s option requires an argument&quot;</span><span class="p">,</span>
					<span class="n">this_char</span><span class="p">);</span>
				<span class="k">return</span> <span class="n">EINVAL</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_rtname</span> <span class="o">=</span> <span class="n">kstrndup</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">MAXNAMELEN</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_rtname</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">ENOMEM</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">this_char</span><span class="p">,</span> <span class="n">MNTOPT_BIOSIZE</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">value</span> <span class="o">||</span> <span class="o">!*</span><span class="n">value</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">xfs_warn</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="s">&quot;%s option requires an argument&quot;</span><span class="p">,</span>
					<span class="n">this_char</span><span class="p">);</span>
				<span class="k">return</span> <span class="n">EINVAL</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">iosize</span> <span class="o">=</span> <span class="n">simple_strtoul</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">eov</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>
			<span class="n">iosizelog</span> <span class="o">=</span> <span class="n">ffs</span><span class="p">(</span><span class="n">iosize</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">this_char</span><span class="p">,</span> <span class="n">MNTOPT_ALLOCSIZE</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">value</span> <span class="o">||</span> <span class="o">!*</span><span class="n">value</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">xfs_warn</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="s">&quot;%s option requires an argument&quot;</span><span class="p">,</span>
					<span class="n">this_char</span><span class="p">);</span>
				<span class="k">return</span> <span class="n">EINVAL</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">iosize</span> <span class="o">=</span> <span class="n">suffix_strtoul</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">eov</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>
			<span class="n">iosizelog</span> <span class="o">=</span> <span class="n">ffs</span><span class="p">(</span><span class="n">iosize</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">this_char</span><span class="p">,</span> <span class="n">MNTOPT_GRPID</span><span class="p">)</span> <span class="o">||</span>
			   <span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">this_char</span><span class="p">,</span> <span class="n">MNTOPT_BSDGROUPS</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_flags</span> <span class="o">|=</span> <span class="n">XFS_MOUNT_GRPID</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">this_char</span><span class="p">,</span> <span class="n">MNTOPT_NOGRPID</span><span class="p">)</span> <span class="o">||</span>
			   <span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">this_char</span><span class="p">,</span> <span class="n">MNTOPT_SYSVGROUPS</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">XFS_MOUNT_GRPID</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">this_char</span><span class="p">,</span> <span class="n">MNTOPT_WSYNC</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_flags</span> <span class="o">|=</span> <span class="n">XFS_MOUNT_WSYNC</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">this_char</span><span class="p">,</span> <span class="n">MNTOPT_NORECOVERY</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_flags</span> <span class="o">|=</span> <span class="n">XFS_MOUNT_NORECOVERY</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">this_char</span><span class="p">,</span> <span class="n">MNTOPT_NOALIGN</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_flags</span> <span class="o">|=</span> <span class="n">XFS_MOUNT_NOALIGN</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">this_char</span><span class="p">,</span> <span class="n">MNTOPT_SWALLOC</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_flags</span> <span class="o">|=</span> <span class="n">XFS_MOUNT_SWALLOC</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">this_char</span><span class="p">,</span> <span class="n">MNTOPT_SUNIT</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">value</span> <span class="o">||</span> <span class="o">!*</span><span class="n">value</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">xfs_warn</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="s">&quot;%s option requires an argument&quot;</span><span class="p">,</span>
					<span class="n">this_char</span><span class="p">);</span>
				<span class="k">return</span> <span class="n">EINVAL</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">dsunit</span> <span class="o">=</span> <span class="n">simple_strtoul</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">eov</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">this_char</span><span class="p">,</span> <span class="n">MNTOPT_SWIDTH</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">value</span> <span class="o">||</span> <span class="o">!*</span><span class="n">value</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">xfs_warn</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="s">&quot;%s option requires an argument&quot;</span><span class="p">,</span>
					<span class="n">this_char</span><span class="p">);</span>
				<span class="k">return</span> <span class="n">EINVAL</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">dswidth</span> <span class="o">=</span> <span class="n">simple_strtoul</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">eov</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">this_char</span><span class="p">,</span> <span class="n">MNTOPT_64BITINODE</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">XFS_MOUNT_SMALL_INUMS</span><span class="p">;</span>
<span class="cp">#if !XFS_BIG_INUMS</span>
			<span class="n">xfs_warn</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="s">&quot;%s option not allowed on this system&quot;</span><span class="p">,</span>
				<span class="n">this_char</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">EINVAL</span><span class="p">;</span>
<span class="cp">#endif</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">this_char</span><span class="p">,</span> <span class="n">MNTOPT_NOUUID</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_flags</span> <span class="o">|=</span> <span class="n">XFS_MOUNT_NOUUID</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">this_char</span><span class="p">,</span> <span class="n">MNTOPT_BARRIER</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_flags</span> <span class="o">|=</span> <span class="n">XFS_MOUNT_BARRIER</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">this_char</span><span class="p">,</span> <span class="n">MNTOPT_NOBARRIER</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">XFS_MOUNT_BARRIER</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">this_char</span><span class="p">,</span> <span class="n">MNTOPT_IKEEP</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_flags</span> <span class="o">|=</span> <span class="n">XFS_MOUNT_IKEEP</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">this_char</span><span class="p">,</span> <span class="n">MNTOPT_NOIKEEP</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">XFS_MOUNT_IKEEP</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">this_char</span><span class="p">,</span> <span class="n">MNTOPT_LARGEIO</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">XFS_MOUNT_COMPAT_IOSIZE</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">this_char</span><span class="p">,</span> <span class="n">MNTOPT_NOLARGEIO</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_flags</span> <span class="o">|=</span> <span class="n">XFS_MOUNT_COMPAT_IOSIZE</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">this_char</span><span class="p">,</span> <span class="n">MNTOPT_ATTR2</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_flags</span> <span class="o">|=</span> <span class="n">XFS_MOUNT_ATTR2</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">this_char</span><span class="p">,</span> <span class="n">MNTOPT_NOATTR2</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">XFS_MOUNT_ATTR2</span><span class="p">;</span>
			<span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_flags</span> <span class="o">|=</span> <span class="n">XFS_MOUNT_NOATTR2</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">this_char</span><span class="p">,</span> <span class="n">MNTOPT_FILESTREAM</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_flags</span> <span class="o">|=</span> <span class="n">XFS_MOUNT_FILESTREAMS</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">this_char</span><span class="p">,</span> <span class="n">MNTOPT_NOQUOTA</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_qflags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">XFS_ALL_QUOTA_ACCT</span><span class="p">;</span>
			<span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_qflags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">XFS_ALL_QUOTA_ENFD</span><span class="p">;</span>
			<span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_qflags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">XFS_ALL_QUOTA_ACTIVE</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">this_char</span><span class="p">,</span> <span class="n">MNTOPT_QUOTA</span><span class="p">)</span> <span class="o">||</span>
			   <span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">this_char</span><span class="p">,</span> <span class="n">MNTOPT_UQUOTA</span><span class="p">)</span> <span class="o">||</span>
			   <span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">this_char</span><span class="p">,</span> <span class="n">MNTOPT_USRQUOTA</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_qflags</span> <span class="o">|=</span> <span class="p">(</span><span class="n">XFS_UQUOTA_ACCT</span> <span class="o">|</span> <span class="n">XFS_UQUOTA_ACTIVE</span> <span class="o">|</span>
					 <span class="n">XFS_UQUOTA_ENFD</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">this_char</span><span class="p">,</span> <span class="n">MNTOPT_QUOTANOENF</span><span class="p">)</span> <span class="o">||</span>
			   <span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">this_char</span><span class="p">,</span> <span class="n">MNTOPT_UQUOTANOENF</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_qflags</span> <span class="o">|=</span> <span class="p">(</span><span class="n">XFS_UQUOTA_ACCT</span> <span class="o">|</span> <span class="n">XFS_UQUOTA_ACTIVE</span><span class="p">);</span>
			<span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_qflags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">XFS_UQUOTA_ENFD</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">this_char</span><span class="p">,</span> <span class="n">MNTOPT_PQUOTA</span><span class="p">)</span> <span class="o">||</span>
			   <span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">this_char</span><span class="p">,</span> <span class="n">MNTOPT_PRJQUOTA</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_qflags</span> <span class="o">|=</span> <span class="p">(</span><span class="n">XFS_PQUOTA_ACCT</span> <span class="o">|</span> <span class="n">XFS_PQUOTA_ACTIVE</span> <span class="o">|</span>
					 <span class="n">XFS_OQUOTA_ENFD</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">this_char</span><span class="p">,</span> <span class="n">MNTOPT_PQUOTANOENF</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_qflags</span> <span class="o">|=</span> <span class="p">(</span><span class="n">XFS_PQUOTA_ACCT</span> <span class="o">|</span> <span class="n">XFS_PQUOTA_ACTIVE</span><span class="p">);</span>
			<span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_qflags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">XFS_OQUOTA_ENFD</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">this_char</span><span class="p">,</span> <span class="n">MNTOPT_GQUOTA</span><span class="p">)</span> <span class="o">||</span>
			   <span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">this_char</span><span class="p">,</span> <span class="n">MNTOPT_GRPQUOTA</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_qflags</span> <span class="o">|=</span> <span class="p">(</span><span class="n">XFS_GQUOTA_ACCT</span> <span class="o">|</span> <span class="n">XFS_GQUOTA_ACTIVE</span> <span class="o">|</span>
					 <span class="n">XFS_OQUOTA_ENFD</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">this_char</span><span class="p">,</span> <span class="n">MNTOPT_GQUOTANOENF</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_qflags</span> <span class="o">|=</span> <span class="p">(</span><span class="n">XFS_GQUOTA_ACCT</span> <span class="o">|</span> <span class="n">XFS_GQUOTA_ACTIVE</span><span class="p">);</span>
			<span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_qflags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">XFS_OQUOTA_ENFD</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">this_char</span><span class="p">,</span> <span class="n">MNTOPT_DELAYLOG</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">xfs_warn</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span>
	<span class="s">&quot;delaylog is the default now, option is deprecated.&quot;</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">this_char</span><span class="p">,</span> <span class="n">MNTOPT_NODELAYLOG</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">xfs_warn</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span>
	<span class="s">&quot;nodelaylog support has been removed, option is deprecated.&quot;</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">this_char</span><span class="p">,</span> <span class="n">MNTOPT_DISCARD</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_flags</span> <span class="o">|=</span> <span class="n">XFS_MOUNT_DISCARD</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">this_char</span><span class="p">,</span> <span class="n">MNTOPT_NODISCARD</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">XFS_MOUNT_DISCARD</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">this_char</span><span class="p">,</span> <span class="s">&quot;ihashsize&quot;</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">xfs_warn</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span>
	<span class="s">&quot;ihashsize no longer used, option is deprecated.&quot;</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">this_char</span><span class="p">,</span> <span class="s">&quot;osyncisdsync&quot;</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">xfs_warn</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span>
	<span class="s">&quot;osyncisdsync has no effect, option is deprecated.&quot;</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">this_char</span><span class="p">,</span> <span class="s">&quot;osyncisosync&quot;</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">xfs_warn</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span>
	<span class="s">&quot;osyncisosync has no effect, option is deprecated.&quot;</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">this_char</span><span class="p">,</span> <span class="s">&quot;irixsgid&quot;</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">xfs_warn</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span>
	<span class="s">&quot;irixsgid is now a sysctl(2) variable, option is deprecated.&quot;</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">xfs_warn</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="s">&quot;unknown mount option [%s].&quot;</span><span class="p">,</span> <span class="n">this_char</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * no recovery flag requires a read-only mount</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_flags</span> <span class="o">&amp;</span> <span class="n">XFS_MOUNT_NORECOVERY</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="p">(</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_flags</span> <span class="o">&amp;</span> <span class="n">XFS_MOUNT_RDONLY</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">xfs_warn</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="s">&quot;no-recovery mounts must be read-only.&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_flags</span> <span class="o">&amp;</span> <span class="n">XFS_MOUNT_NOALIGN</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">dsunit</span> <span class="o">||</span> <span class="n">dswidth</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">xfs_warn</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span>
	<span class="s">&quot;sunit and swidth options incompatible with the noalign option&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

<span class="cp">#ifndef CONFIG_XFS_QUOTA</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">XFS_IS_QUOTA_RUNNING</span><span class="p">(</span><span class="n">mp</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">xfs_warn</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="s">&quot;quota support not available in this kernel.&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#endif</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_qflags</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">XFS_GQUOTA_ACCT</span> <span class="o">|</span> <span class="n">XFS_GQUOTA_ACTIVE</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_qflags</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">XFS_PQUOTA_ACCT</span> <span class="o">|</span> <span class="n">XFS_PQUOTA_ACTIVE</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">xfs_warn</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="s">&quot;cannot mount with both project and group quota&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">dsunit</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">dswidth</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="o">!</span><span class="n">dsunit</span> <span class="o">&amp;&amp;</span> <span class="n">dswidth</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">xfs_warn</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="s">&quot;sunit and swidth must be specified together&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dsunit</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">dswidth</span> <span class="o">%</span> <span class="n">dsunit</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">xfs_warn</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span>
	<span class="s">&quot;stripe width (%d) must be a multiple of the stripe unit (%d)&quot;</span><span class="p">,</span>
			<span class="n">dswidth</span><span class="p">,</span> <span class="n">dsunit</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">done:</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_flags</span> <span class="o">&amp;</span> <span class="n">XFS_MOUNT_NOALIGN</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * At this point the superblock has not been read</span>
<span class="cm">		 * in, therefore we do not know the block size.</span>
<span class="cm">		 * Before the mount call ends we will convert</span>
<span class="cm">		 * these to FSBs.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dsunit</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_dalign</span> <span class="o">=</span> <span class="n">dsunit</span><span class="p">;</span>
			<span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_flags</span> <span class="o">|=</span> <span class="n">XFS_MOUNT_RETERR</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">dswidth</span><span class="p">)</span>
			<span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_swidth</span> <span class="o">=</span> <span class="n">dswidth</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_logbufs</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span> <span class="o">&amp;&amp;</span>
	    <span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_logbufs</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_logbufs</span> <span class="o">&lt;</span> <span class="n">XLOG_MIN_ICLOGS</span> <span class="o">||</span>
	     <span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_logbufs</span> <span class="o">&gt;</span> <span class="n">XLOG_MAX_ICLOGS</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">xfs_warn</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="s">&quot;invalid logbufs value: %d [not %d-%d]&quot;</span><span class="p">,</span>
			<span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_logbufs</span><span class="p">,</span> <span class="n">XLOG_MIN_ICLOGS</span><span class="p">,</span> <span class="n">XLOG_MAX_ICLOGS</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">XFS_ERROR</span><span class="p">(</span><span class="n">EINVAL</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_logbsize</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span> <span class="o">&amp;&amp;</span>
	    <span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_logbsize</span> <span class="o">!=</span>  <span class="mi">0</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_logbsize</span> <span class="o">&lt;</span> <span class="n">XLOG_MIN_RECORD_BSIZE</span> <span class="o">||</span>
	     <span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_logbsize</span> <span class="o">&gt;</span> <span class="n">XLOG_MAX_RECORD_BSIZE</span> <span class="o">||</span>
	     <span class="o">!</span><span class="n">is_power_of_2</span><span class="p">(</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_logbsize</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">xfs_warn</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span>
			<span class="s">&quot;invalid logbufsize: %d [not 16k,32k,64k,128k or 256k]&quot;</span><span class="p">,</span>
			<span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_logbsize</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">XFS_ERROR</span><span class="p">(</span><span class="n">EINVAL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">iosizelog</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">iosizelog</span> <span class="o">&gt;</span> <span class="n">XFS_MAX_IO_LOG</span> <span class="o">||</span>
		    <span class="n">iosizelog</span> <span class="o">&lt;</span> <span class="n">XFS_MIN_IO_LOG</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">xfs_warn</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="s">&quot;invalid log iosize: %d [not %d-%d]&quot;</span><span class="p">,</span>
				<span class="n">iosizelog</span><span class="p">,</span> <span class="n">XFS_MIN_IO_LOG</span><span class="p">,</span>
				<span class="n">XFS_MAX_IO_LOG</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">XFS_ERROR</span><span class="p">(</span><span class="n">EINVAL</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_flags</span> <span class="o">|=</span> <span class="n">XFS_MOUNT_DFLT_IOSIZE</span><span class="p">;</span>
		<span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_readio_log</span> <span class="o">=</span> <span class="n">iosizelog</span><span class="p">;</span>
		<span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_writeio_log</span> <span class="o">=</span> <span class="n">iosizelog</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">proc_xfs_info</span> <span class="p">{</span>
	<span class="kt">int</span>	<span class="n">flag</span><span class="p">;</span>
	<span class="kt">char</span>	<span class="o">*</span><span class="n">str</span><span class="p">;</span>
<span class="p">};</span>

<span class="n">STATIC</span> <span class="kt">int</span>
<span class="nf">xfs_showargs</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">xfs_mount</span>	<span class="o">*</span><span class="n">mp</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">seq_file</span>		<span class="o">*</span><span class="n">m</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="k">struct</span> <span class="n">proc_xfs_info</span> <span class="n">xfs_info_set</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="cm">/* the few simple ones we can get from the mount struct */</span>
		<span class="p">{</span> <span class="n">XFS_MOUNT_IKEEP</span><span class="p">,</span>		<span class="s">&quot;,&quot;</span> <span class="n">MNTOPT_IKEEP</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">XFS_MOUNT_WSYNC</span><span class="p">,</span>		<span class="s">&quot;,&quot;</span> <span class="n">MNTOPT_WSYNC</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">XFS_MOUNT_NOALIGN</span><span class="p">,</span>		<span class="s">&quot;,&quot;</span> <span class="n">MNTOPT_NOALIGN</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">XFS_MOUNT_SWALLOC</span><span class="p">,</span>		<span class="s">&quot;,&quot;</span> <span class="n">MNTOPT_SWALLOC</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">XFS_MOUNT_NOUUID</span><span class="p">,</span>		<span class="s">&quot;,&quot;</span> <span class="n">MNTOPT_NOUUID</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">XFS_MOUNT_NORECOVERY</span><span class="p">,</span>		<span class="s">&quot;,&quot;</span> <span class="n">MNTOPT_NORECOVERY</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">XFS_MOUNT_ATTR2</span><span class="p">,</span>		<span class="s">&quot;,&quot;</span> <span class="n">MNTOPT_ATTR2</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">XFS_MOUNT_FILESTREAMS</span><span class="p">,</span>	<span class="s">&quot;,&quot;</span> <span class="n">MNTOPT_FILESTREAM</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">XFS_MOUNT_GRPID</span><span class="p">,</span>		<span class="s">&quot;,&quot;</span> <span class="n">MNTOPT_GRPID</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">XFS_MOUNT_DISCARD</span><span class="p">,</span>		<span class="s">&quot;,&quot;</span> <span class="n">MNTOPT_DISCARD</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span> <span class="p">}</span>
	<span class="p">};</span>
	<span class="k">static</span> <span class="k">struct</span> <span class="n">proc_xfs_info</span> <span class="n">xfs_info_unset</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="cm">/* the few simple ones we can get from the mount struct */</span>
		<span class="p">{</span> <span class="n">XFS_MOUNT_COMPAT_IOSIZE</span><span class="p">,</span>	<span class="s">&quot;,&quot;</span> <span class="n">MNTOPT_LARGEIO</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">XFS_MOUNT_BARRIER</span><span class="p">,</span>		<span class="s">&quot;,&quot;</span> <span class="n">MNTOPT_NOBARRIER</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">XFS_MOUNT_SMALL_INUMS</span><span class="p">,</span>	<span class="s">&quot;,&quot;</span> <span class="n">MNTOPT_64BITINODE</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span> <span class="p">}</span>
	<span class="p">};</span>
	<span class="k">struct</span> <span class="n">proc_xfs_info</span>	<span class="o">*</span><span class="n">xfs_infop</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">xfs_infop</span> <span class="o">=</span> <span class="n">xfs_info_set</span><span class="p">;</span> <span class="n">xfs_infop</span><span class="o">-&gt;</span><span class="n">flag</span><span class="p">;</span> <span class="n">xfs_infop</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_flags</span> <span class="o">&amp;</span> <span class="n">xfs_infop</span><span class="o">-&gt;</span><span class="n">flag</span><span class="p">)</span>
			<span class="n">seq_puts</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">xfs_infop</span><span class="o">-&gt;</span><span class="n">str</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">xfs_infop</span> <span class="o">=</span> <span class="n">xfs_info_unset</span><span class="p">;</span> <span class="n">xfs_infop</span><span class="o">-&gt;</span><span class="n">flag</span><span class="p">;</span> <span class="n">xfs_infop</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_flags</span> <span class="o">&amp;</span> <span class="n">xfs_infop</span><span class="o">-&gt;</span><span class="n">flag</span><span class="p">))</span>
			<span class="n">seq_puts</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">xfs_infop</span><span class="o">-&gt;</span><span class="n">str</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_flags</span> <span class="o">&amp;</span> <span class="n">XFS_MOUNT_DFLT_IOSIZE</span><span class="p">)</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;,&quot;</span> <span class="n">MNTOPT_ALLOCSIZE</span> <span class="s">&quot;=%dk&quot;</span><span class="p">,</span>
				<span class="p">(</span><span class="kt">int</span><span class="p">)(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_writeio_log</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">10</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_logbufs</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;,&quot;</span> <span class="n">MNTOPT_LOGBUFS</span> <span class="s">&quot;=%d&quot;</span><span class="p">,</span> <span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_logbufs</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_logbsize</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;,&quot;</span> <span class="n">MNTOPT_LOGBSIZE</span> <span class="s">&quot;=%dk&quot;</span><span class="p">,</span> <span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_logbsize</span> <span class="o">&gt;&gt;</span> <span class="mi">10</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_logname</span><span class="p">)</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;,&quot;</span> <span class="n">MNTOPT_LOGDEV</span> <span class="s">&quot;=%s&quot;</span><span class="p">,</span> <span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_logname</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_rtname</span><span class="p">)</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;,&quot;</span> <span class="n">MNTOPT_RTDEV</span> <span class="s">&quot;=%s&quot;</span><span class="p">,</span> <span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_rtname</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_dalign</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;,&quot;</span> <span class="n">MNTOPT_SUNIT</span> <span class="s">&quot;=%d&quot;</span><span class="p">,</span>
				<span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">XFS_FSB_TO_BB</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_dalign</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_swidth</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;,&quot;</span> <span class="n">MNTOPT_SWIDTH</span> <span class="s">&quot;=%d&quot;</span><span class="p">,</span>
				<span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">XFS_FSB_TO_BB</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_swidth</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_qflags</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">XFS_UQUOTA_ACCT</span><span class="o">|</span><span class="n">XFS_UQUOTA_ENFD</span><span class="p">))</span>
		<span class="n">seq_puts</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;,&quot;</span> <span class="n">MNTOPT_USRQUOTA</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_qflags</span> <span class="o">&amp;</span> <span class="n">XFS_UQUOTA_ACCT</span><span class="p">)</span>
		<span class="n">seq_puts</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;,&quot;</span> <span class="n">MNTOPT_UQUOTANOENF</span><span class="p">);</span>

	<span class="cm">/* Either project or group quotas can be active, not both */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_qflags</span> <span class="o">&amp;</span> <span class="n">XFS_PQUOTA_ACCT</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_qflags</span> <span class="o">&amp;</span> <span class="n">XFS_OQUOTA_ENFD</span><span class="p">)</span>
			<span class="n">seq_puts</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;,&quot;</span> <span class="n">MNTOPT_PRJQUOTA</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">seq_puts</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;,&quot;</span> <span class="n">MNTOPT_PQUOTANOENF</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_qflags</span> <span class="o">&amp;</span> <span class="n">XFS_GQUOTA_ACCT</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_qflags</span> <span class="o">&amp;</span> <span class="n">XFS_OQUOTA_ENFD</span><span class="p">)</span>
			<span class="n">seq_puts</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;,&quot;</span> <span class="n">MNTOPT_GRPQUOTA</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">seq_puts</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;,&quot;</span> <span class="n">MNTOPT_GQUOTANOENF</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_qflags</span> <span class="o">&amp;</span> <span class="n">XFS_ALL_QUOTA_ACCT</span><span class="p">))</span>
		<span class="n">seq_puts</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;,&quot;</span> <span class="n">MNTOPT_NOQUOTA</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">__uint64_t</span>
<span class="nf">xfs_max_file_offset</span><span class="p">(</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>		<span class="n">blockshift</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>		<span class="n">pagefactor</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>		<span class="n">bitshift</span> <span class="o">=</span> <span class="n">BITS_PER_LONG</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* Figure out maximum filesize, on Linux this can depend on</span>
<span class="cm">	 * the filesystem blocksize (on 32 bit platforms).</span>
<span class="cm">	 * __block_write_begin does this in an [unsigned] long...</span>
<span class="cm">	 *      page-&gt;index &lt;&lt; (PAGE_CACHE_SHIFT - bbits)</span>
<span class="cm">	 * So, for page sized blocks (4K on 32 bit platforms),</span>
<span class="cm">	 * this wraps at around 8Tb (hence MAX_LFS_FILESIZE which is</span>
<span class="cm">	 *      (((u64)PAGE_CACHE_SIZE &lt;&lt; (BITS_PER_LONG-1))-1)</span>
<span class="cm">	 * but for smaller blocksizes it is less (bbits = log2 bsize).</span>
<span class="cm">	 * Note1: get_block_t takes a long (implicit cast from above)</span>
<span class="cm">	 * Note2: The Large Block Device (LBD and HAVE_SECTOR_T) patch</span>
<span class="cm">	 * can optionally convert the [unsigned] long from above into</span>
<span class="cm">	 * an [unsigned] long long.</span>
<span class="cm">	 */</span>

<span class="cp">#if BITS_PER_LONG == 32</span>
<span class="cp"># if defined(CONFIG_LBDAF)</span>
	<span class="n">ASSERT</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">sector_t</span><span class="p">)</span> <span class="o">==</span> <span class="mi">8</span><span class="p">);</span>
	<span class="n">pagefactor</span> <span class="o">=</span> <span class="n">PAGE_CACHE_SIZE</span><span class="p">;</span>
	<span class="n">bitshift</span> <span class="o">=</span> <span class="n">BITS_PER_LONG</span><span class="p">;</span>
<span class="cp"># else</span>
	<span class="n">pagefactor</span> <span class="o">=</span> <span class="n">PAGE_CACHE_SIZE</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="n">PAGE_CACHE_SHIFT</span> <span class="o">-</span> <span class="n">blockshift</span><span class="p">);</span>
<span class="cp"># endif</span>
<span class="cp">#endif</span>

	<span class="k">return</span> <span class="p">(((</span><span class="n">__uint64_t</span><span class="p">)</span><span class="n">pagefactor</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">bitshift</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">STATIC</span> <span class="kt">int</span>
<span class="nf">xfs_blkdev_get</span><span class="p">(</span>
	<span class="n">xfs_mount_t</span>		<span class="o">*</span><span class="n">mp</span><span class="p">,</span>
	<span class="k">const</span> <span class="kt">char</span>		<span class="o">*</span><span class="n">name</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">block_device</span>	<span class="o">**</span><span class="n">bdevp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span>			<span class="n">error</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="o">*</span><span class="n">bdevp</span> <span class="o">=</span> <span class="n">blkdev_get_by_path</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">FMODE_READ</span><span class="o">|</span><span class="n">FMODE_WRITE</span><span class="o">|</span><span class="n">FMODE_EXCL</span><span class="p">,</span>
				    <span class="n">mp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="o">*</span><span class="n">bdevp</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">error</span> <span class="o">=</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="o">*</span><span class="n">bdevp</span><span class="p">);</span>
		<span class="n">xfs_warn</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="s">&quot;Invalid device [%s], error=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">error</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="o">-</span><span class="n">error</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">STATIC</span> <span class="kt">void</span>
<span class="nf">xfs_blkdev_put</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">block_device</span>	<span class="o">*</span><span class="n">bdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bdev</span><span class="p">)</span>
		<span class="n">blkdev_put</span><span class="p">(</span><span class="n">bdev</span><span class="p">,</span> <span class="n">FMODE_READ</span><span class="o">|</span><span class="n">FMODE_WRITE</span><span class="o">|</span><span class="n">FMODE_EXCL</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">xfs_blkdev_issue_flush</span><span class="p">(</span>
	<span class="n">xfs_buftarg_t</span>		<span class="o">*</span><span class="n">buftarg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">blkdev_issue_flush</span><span class="p">(</span><span class="n">buftarg</span><span class="o">-&gt;</span><span class="n">bt_bdev</span><span class="p">,</span> <span class="n">GFP_NOFS</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">STATIC</span> <span class="kt">void</span>
<span class="nf">xfs_close_devices</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">xfs_mount</span>	<span class="o">*</span><span class="n">mp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_logdev_targp</span> <span class="o">&amp;&amp;</span> <span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_logdev_targp</span> <span class="o">!=</span> <span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_ddev_targp</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">block_device</span> <span class="o">*</span><span class="n">logdev</span> <span class="o">=</span> <span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_logdev_targp</span><span class="o">-&gt;</span><span class="n">bt_bdev</span><span class="p">;</span>
		<span class="n">xfs_free_buftarg</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_logdev_targp</span><span class="p">);</span>
		<span class="n">xfs_blkdev_put</span><span class="p">(</span><span class="n">logdev</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_rtdev_targp</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">block_device</span> <span class="o">*</span><span class="n">rtdev</span> <span class="o">=</span> <span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_rtdev_targp</span><span class="o">-&gt;</span><span class="n">bt_bdev</span><span class="p">;</span>
		<span class="n">xfs_free_buftarg</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_rtdev_targp</span><span class="p">);</span>
		<span class="n">xfs_blkdev_put</span><span class="p">(</span><span class="n">rtdev</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">xfs_free_buftarg</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_ddev_targp</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * The file system configurations are:</span>
<span class="cm"> *	(1) device (partition) with data and internal log</span>
<span class="cm"> *	(2) logical volume with data and log subvolumes.</span>
<span class="cm"> *	(3) logical volume with data, log, and realtime subvolumes.</span>
<span class="cm"> *</span>
<span class="cm"> * We only have to handle opening the log and realtime volumes here if</span>
<span class="cm"> * they are present.  The data subvolume has already been opened by</span>
<span class="cm"> * get_sb_bdev() and is stored in sb-&gt;s_bdev.</span>
<span class="cm"> */</span>
<span class="n">STATIC</span> <span class="kt">int</span>
<span class="nf">xfs_open_devices</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">xfs_mount</span>	<span class="o">*</span><span class="n">mp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">block_device</span>	<span class="o">*</span><span class="n">ddev</span> <span class="o">=</span> <span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_super</span><span class="o">-&gt;</span><span class="n">s_bdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">block_device</span>	<span class="o">*</span><span class="n">logdev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">*</span><span class="n">rtdev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">error</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Open real time and log devices - order is important.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_logname</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">error</span> <span class="o">=</span> <span class="n">xfs_blkdev_get</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_logname</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">logdev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_rtname</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">error</span> <span class="o">=</span> <span class="n">xfs_blkdev_get</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_rtname</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rtdev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out_close_logdev</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">rtdev</span> <span class="o">==</span> <span class="n">ddev</span> <span class="o">||</span> <span class="n">rtdev</span> <span class="o">==</span> <span class="n">logdev</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">xfs_warn</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span>
	<span class="s">&quot;Cannot mount filesystem with identical rtdev and ddev/logdev.&quot;</span><span class="p">);</span>
			<span class="n">error</span> <span class="o">=</span> <span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out_close_rtdev</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Setup xfs_mount buffer target pointers</span>
<span class="cm">	 */</span>
	<span class="n">error</span> <span class="o">=</span> <span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_ddev_targp</span> <span class="o">=</span> <span class="n">xfs_alloc_buftarg</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="n">ddev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_fsname</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_ddev_targp</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_close_rtdev</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rtdev</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_rtdev_targp</span> <span class="o">=</span> <span class="n">xfs_alloc_buftarg</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="n">rtdev</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
							<span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_fsname</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_rtdev_targp</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out_free_ddev_targ</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">logdev</span> <span class="o">&amp;&amp;</span> <span class="n">logdev</span> <span class="o">!=</span> <span class="n">ddev</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_logdev_targp</span> <span class="o">=</span> <span class="n">xfs_alloc_buftarg</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="n">logdev</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
							<span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_fsname</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_logdev_targp</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out_free_rtdev_targ</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_logdev_targp</span> <span class="o">=</span> <span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_ddev_targp</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

 <span class="nl">out_free_rtdev_targ:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_rtdev_targp</span><span class="p">)</span>
		<span class="n">xfs_free_buftarg</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_rtdev_targp</span><span class="p">);</span>
 <span class="nl">out_free_ddev_targ:</span>
	<span class="n">xfs_free_buftarg</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_ddev_targp</span><span class="p">);</span>
 <span class="nl">out_close_rtdev:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rtdev</span><span class="p">)</span>
		<span class="n">xfs_blkdev_put</span><span class="p">(</span><span class="n">rtdev</span><span class="p">);</span>
 <span class="nl">out_close_logdev:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">logdev</span> <span class="o">&amp;&amp;</span> <span class="n">logdev</span> <span class="o">!=</span> <span class="n">ddev</span><span class="p">)</span>
		<span class="n">xfs_blkdev_put</span><span class="p">(</span><span class="n">logdev</span><span class="p">);</span>
 <span class="nl">out:</span>
	<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Setup xfs_mount buffer target pointers based on superblock</span>
<span class="cm"> */</span>
<span class="n">STATIC</span> <span class="kt">int</span>
<span class="nf">xfs_setup_devices</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">xfs_mount</span>	<span class="o">*</span><span class="n">mp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span>			<span class="n">error</span><span class="p">;</span>

	<span class="n">error</span> <span class="o">=</span> <span class="n">xfs_setsize_buftarg</span><span class="p">(</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_ddev_targp</span><span class="p">,</span> <span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_sb</span><span class="p">.</span><span class="n">sb_blocksize</span><span class="p">,</span>
				    <span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_sb</span><span class="p">.</span><span class="n">sb_sectsize</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">error</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_logdev_targp</span> <span class="o">&amp;&amp;</span> <span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_logdev_targp</span> <span class="o">!=</span> <span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_ddev_targp</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">int</span>	<span class="n">log_sector_size</span> <span class="o">=</span> <span class="n">BBSIZE</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">xfs_sb_version_hassector</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_sb</span><span class="p">))</span>
			<span class="n">log_sector_size</span> <span class="o">=</span> <span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_sb</span><span class="p">.</span><span class="n">sb_logsectsize</span><span class="p">;</span>
		<span class="n">error</span> <span class="o">=</span> <span class="n">xfs_setsize_buftarg</span><span class="p">(</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_logdev_targp</span><span class="p">,</span>
					    <span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_sb</span><span class="p">.</span><span class="n">sb_blocksize</span><span class="p">,</span>
					    <span class="n">log_sector_size</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_rtdev_targp</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">error</span> <span class="o">=</span> <span class="n">xfs_setsize_buftarg</span><span class="p">(</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_rtdev_targp</span><span class="p">,</span>
					    <span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_sb</span><span class="p">.</span><span class="n">sb_blocksize</span><span class="p">,</span>
					    <span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_sb</span><span class="p">.</span><span class="n">sb_sectsize</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">STATIC</span> <span class="kt">int</span>
<span class="nf">xfs_init_mount_workqueues</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">xfs_mount</span>	<span class="o">*</span><span class="n">mp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_data_workqueue</span> <span class="o">=</span> <span class="n">alloc_workqueue</span><span class="p">(</span><span class="s">&quot;xfs-data/%s&quot;</span><span class="p">,</span>
			<span class="n">WQ_MEM_RECLAIM</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_fsname</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_data_workqueue</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_unwritten_workqueue</span> <span class="o">=</span> <span class="n">alloc_workqueue</span><span class="p">(</span><span class="s">&quot;xfs-conv/%s&quot;</span><span class="p">,</span>
			<span class="n">WQ_MEM_RECLAIM</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_fsname</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_unwritten_workqueue</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_destroy_data_iodone_queue</span><span class="p">;</span>

	<span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_cil_workqueue</span> <span class="o">=</span> <span class="n">alloc_workqueue</span><span class="p">(</span><span class="s">&quot;xfs-cil/%s&quot;</span><span class="p">,</span>
			<span class="n">WQ_MEM_RECLAIM</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_fsname</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_cil_workqueue</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_destroy_unwritten</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">out_destroy_unwritten:</span>
	<span class="n">destroy_workqueue</span><span class="p">(</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_unwritten_workqueue</span><span class="p">);</span>
<span class="nl">out_destroy_data_iodone_queue:</span>
	<span class="n">destroy_workqueue</span><span class="p">(</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_data_workqueue</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">STATIC</span> <span class="kt">void</span>
<span class="nf">xfs_destroy_mount_workqueues</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">xfs_mount</span>	<span class="o">*</span><span class="n">mp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">destroy_workqueue</span><span class="p">(</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_cil_workqueue</span><span class="p">);</span>
	<span class="n">destroy_workqueue</span><span class="p">(</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_data_workqueue</span><span class="p">);</span>
	<span class="n">destroy_workqueue</span><span class="p">(</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_unwritten_workqueue</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Catch misguided souls that try to use this interface on XFS */</span>
<span class="n">STATIC</span> <span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span>
<span class="nf">xfs_fs_alloc_inode</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">super_block</span>	<span class="o">*</span><span class="n">sb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">BUG</span><span class="p">();</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Now that the generic code is guaranteed not to be accessing</span>
<span class="cm"> * the linux inode, we can reclaim the inode.</span>
<span class="cm"> */</span>
<span class="n">STATIC</span> <span class="kt">void</span>
<span class="nf">xfs_fs_destroy_inode</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">inode</span>		<span class="o">*</span><span class="n">inode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">xfs_inode</span>	<span class="o">*</span><span class="n">ip</span> <span class="o">=</span> <span class="n">XFS_I</span><span class="p">(</span><span class="n">inode</span><span class="p">);</span>

	<span class="n">trace_xfs_destroy_inode</span><span class="p">(</span><span class="n">ip</span><span class="p">);</span>

	<span class="n">XFS_STATS_INC</span><span class="p">(</span><span class="n">vn_reclaim</span><span class="p">);</span>

	<span class="cm">/* bad inode, get out here ASAP */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">is_bad_inode</span><span class="p">(</span><span class="n">inode</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out_reclaim</span><span class="p">;</span>

	<span class="n">ASSERT</span><span class="p">(</span><span class="n">XFS_FORCED_SHUTDOWN</span><span class="p">(</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_mount</span><span class="p">)</span> <span class="o">||</span> <span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_delayed_blks</span> <span class="o">==</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * We should never get here with one of the reclaim flags already set.</span>
<span class="cm">	 */</span>
	<span class="n">ASSERT_ALWAYS</span><span class="p">(</span><span class="o">!</span><span class="n">xfs_iflags_test</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">XFS_IRECLAIMABLE</span><span class="p">));</span>
	<span class="n">ASSERT_ALWAYS</span><span class="p">(</span><span class="o">!</span><span class="n">xfs_iflags_test</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">XFS_IRECLAIM</span><span class="p">));</span>

	<span class="cm">/*</span>
<span class="cm">	 * We always use background reclaim here because even if the</span>
<span class="cm">	 * inode is clean, it still may be under IO and hence we have</span>
<span class="cm">	 * to take the flush lock. The background reclaim path handles</span>
<span class="cm">	 * this more efficiently than we can here, so simply let background</span>
<span class="cm">	 * reclaim tear down all inodes.</span>
<span class="cm">	 */</span>
<span class="nl">out_reclaim:</span>
	<span class="n">xfs_inode_set_reclaim_tag</span><span class="p">(</span><span class="n">ip</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Slab object creation initialisation for the XFS inode.</span>
<span class="cm"> * This covers only the idempotent fields in the XFS inode;</span>
<span class="cm"> * all other fields need to be initialised on allocation</span>
<span class="cm"> * from the slab. This avoids the need to repeatedly initialise</span>
<span class="cm"> * fields in the xfs inode that left in the initialise state</span>
<span class="cm"> * when freeing the inode.</span>
<span class="cm"> */</span>
<span class="n">STATIC</span> <span class="kt">void</span>
<span class="nf">xfs_fs_inode_init_once</span><span class="p">(</span>
	<span class="kt">void</span>			<span class="o">*</span><span class="n">inode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">xfs_inode</span>	<span class="o">*</span><span class="n">ip</span> <span class="o">=</span> <span class="n">inode</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">xfs_inode</span><span class="p">));</span>

	<span class="cm">/* vfs inode */</span>
	<span class="n">inode_init_once</span><span class="p">(</span><span class="n">VFS_I</span><span class="p">(</span><span class="n">ip</span><span class="p">));</span>

	<span class="cm">/* xfs inode */</span>
	<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_pincount</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_flags_lock</span><span class="p">);</span>

	<span class="n">mrlock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_lock</span><span class="p">,</span> <span class="n">MRLOCK_ALLOW_EQUAL_PRI</span><span class="o">|</span><span class="n">MRLOCK_BARRIER</span><span class="p">,</span>
		     <span class="s">&quot;xfsino&quot;</span><span class="p">,</span> <span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_ino</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * This is called by the VFS when dirtying inode metadata.  This can happen</span>
<span class="cm"> * for a few reasons, but we only care about timestamp updates, given that</span>
<span class="cm"> * we handled the rest ourselves.  In theory no other calls should happen,</span>
<span class="cm"> * but for example generic_write_end() keeps dirtying the inode after</span>
<span class="cm"> * updating i_size.  Thus we check that the flags are exactly I_DIRTY_SYNC,</span>
<span class="cm"> * and skip this call otherwise.</span>
<span class="cm"> *</span>
<span class="cm"> * We&#39;ll hopefull get a different method just for updating timestamps soon,</span>
<span class="cm"> * at which point this hack can go away, and maybe we&#39;ll also get real</span>
<span class="cm"> * error handling here.</span>
<span class="cm"> */</span>
<span class="n">STATIC</span> <span class="kt">void</span>
<span class="nf">xfs_fs_dirty_inode</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">inode</span>		<span class="o">*</span><span class="n">inode</span><span class="p">,</span>
	<span class="kt">int</span>			<span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">xfs_inode</span>	<span class="o">*</span><span class="n">ip</span> <span class="o">=</span> <span class="n">XFS_I</span><span class="p">(</span><span class="n">inode</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">xfs_mount</span>	<span class="o">*</span><span class="n">mp</span> <span class="o">=</span> <span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_mount</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">xfs_trans</span>	<span class="o">*</span><span class="n">tp</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">error</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">!=</span> <span class="n">I_DIRTY_SYNC</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">trace_xfs_dirty_inode</span><span class="p">(</span><span class="n">ip</span><span class="p">);</span>

	<span class="n">tp</span> <span class="o">=</span> <span class="n">xfs_trans_alloc</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="n">XFS_TRANS_FSYNC_TS</span><span class="p">);</span>
	<span class="n">error</span> <span class="o">=</span> <span class="n">xfs_trans_reserve</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">XFS_FSYNC_TS_LOG_RES</span><span class="p">(</span><span class="n">mp</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">xfs_trans_cancel</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">trouble</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">xfs_ilock</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">XFS_ILOCK_EXCL</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 * Grab all the latest timestamps from the Linux inode.</span>
<span class="cm">	 */</span>
	<span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_d</span><span class="p">.</span><span class="n">di_atime</span><span class="p">.</span><span class="n">t_sec</span> <span class="o">=</span> <span class="p">(</span><span class="n">__int32_t</span><span class="p">)</span><span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_atime</span><span class="p">.</span><span class="n">tv_sec</span><span class="p">;</span>
	<span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_d</span><span class="p">.</span><span class="n">di_atime</span><span class="p">.</span><span class="n">t_nsec</span> <span class="o">=</span> <span class="p">(</span><span class="n">__int32_t</span><span class="p">)</span><span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_atime</span><span class="p">.</span><span class="n">tv_nsec</span><span class="p">;</span>
	<span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_d</span><span class="p">.</span><span class="n">di_ctime</span><span class="p">.</span><span class="n">t_sec</span> <span class="o">=</span> <span class="p">(</span><span class="n">__int32_t</span><span class="p">)</span><span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_ctime</span><span class="p">.</span><span class="n">tv_sec</span><span class="p">;</span>
	<span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_d</span><span class="p">.</span><span class="n">di_ctime</span><span class="p">.</span><span class="n">t_nsec</span> <span class="o">=</span> <span class="p">(</span><span class="n">__int32_t</span><span class="p">)</span><span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_ctime</span><span class="p">.</span><span class="n">tv_nsec</span><span class="p">;</span>
	<span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_d</span><span class="p">.</span><span class="n">di_mtime</span><span class="p">.</span><span class="n">t_sec</span> <span class="o">=</span> <span class="p">(</span><span class="n">__int32_t</span><span class="p">)</span><span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_mtime</span><span class="p">.</span><span class="n">tv_sec</span><span class="p">;</span>
	<span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_d</span><span class="p">.</span><span class="n">di_mtime</span><span class="p">.</span><span class="n">t_nsec</span> <span class="o">=</span> <span class="p">(</span><span class="n">__int32_t</span><span class="p">)</span><span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_mtime</span><span class="p">.</span><span class="n">tv_nsec</span><span class="p">;</span>

	<span class="n">xfs_trans_ijoin</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">ip</span><span class="p">,</span> <span class="n">XFS_ILOCK_EXCL</span><span class="p">);</span>
	<span class="n">xfs_trans_log_inode</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">ip</span><span class="p">,</span> <span class="n">XFS_ILOG_TIMESTAMP</span><span class="p">);</span>
	<span class="n">error</span> <span class="o">=</span> <span class="n">xfs_trans_commit</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">trouble</span><span class="p">;</span>
	<span class="k">return</span><span class="p">;</span>

<span class="nl">trouble:</span>
	<span class="n">xfs_warn</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="s">&quot;failed to update timestamps for inode 0x%llx&quot;</span><span class="p">,</span> <span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_ino</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">STATIC</span> <span class="kt">void</span>
<span class="nf">xfs_fs_evict_inode</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">inode</span>		<span class="o">*</span><span class="n">inode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">xfs_inode_t</span>		<span class="o">*</span><span class="n">ip</span> <span class="o">=</span> <span class="n">XFS_I</span><span class="p">(</span><span class="n">inode</span><span class="p">);</span>

	<span class="n">trace_xfs_evict_inode</span><span class="p">(</span><span class="n">ip</span><span class="p">);</span>

	<span class="n">truncate_inode_pages</span><span class="p">(</span><span class="o">&amp;</span><span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_data</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">clear_inode</span><span class="p">(</span><span class="n">inode</span><span class="p">);</span>
	<span class="n">XFS_STATS_INC</span><span class="p">(</span><span class="n">vn_rele</span><span class="p">);</span>
	<span class="n">XFS_STATS_INC</span><span class="p">(</span><span class="n">vn_remove</span><span class="p">);</span>
	<span class="n">XFS_STATS_DEC</span><span class="p">(</span><span class="n">vn_active</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * The iolock is used by the file system to coordinate reads,</span>
<span class="cm">	 * writes, and block truncates.  Up to this point the lock</span>
<span class="cm">	 * protected concurrent accesses by users of the inode.  But</span>
<span class="cm">	 * from here forward we&#39;re doing some final processing of the</span>
<span class="cm">	 * inode because we&#39;re done with it, and although we reuse the</span>
<span class="cm">	 * iolock for protection it is really a distinct lock class</span>
<span class="cm">	 * (in the lockdep sense) from before.  To keep lockdep happy</span>
<span class="cm">	 * (and basically indicate what we are doing), we explicitly</span>
<span class="cm">	 * re-init the iolock here.</span>
<span class="cm">	 */</span>
	<span class="n">ASSERT</span><span class="p">(</span><span class="o">!</span><span class="n">rwsem_is_locked</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_iolock</span><span class="p">.</span><span class="n">mr_lock</span><span class="p">));</span>
	<span class="n">mrlock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_iolock</span><span class="p">,</span> <span class="n">MRLOCK_BARRIER</span><span class="p">,</span> <span class="s">&quot;xfsio&quot;</span><span class="p">,</span> <span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_ino</span><span class="p">);</span>
	<span class="n">lockdep_set_class_and_name</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_iolock</span><span class="p">.</span><span class="n">mr_lock</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">xfs_iolock_reclaimable</span><span class="p">,</span> <span class="s">&quot;xfs_iolock_reclaimable&quot;</span><span class="p">);</span>

	<span class="n">xfs_inactive</span><span class="p">(</span><span class="n">ip</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * We do an unlocked check for XFS_IDONTCACHE here because we are already</span>
<span class="cm"> * serialised against cache hits here via the inode-&gt;i_lock and igrab() in</span>
<span class="cm"> * xfs_iget_cache_hit(). Hence a lookup that might clear this flag will not be</span>
<span class="cm"> * racing with us, and it avoids needing to grab a spinlock here for every inode</span>
<span class="cm"> * we drop the final reference on.</span>
<span class="cm"> */</span>
<span class="n">STATIC</span> <span class="kt">int</span>
<span class="nf">xfs_fs_drop_inode</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">inode</span>		<span class="o">*</span><span class="n">inode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">xfs_inode</span>	<span class="o">*</span><span class="n">ip</span> <span class="o">=</span> <span class="n">XFS_I</span><span class="p">(</span><span class="n">inode</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">generic_drop_inode</span><span class="p">(</span><span class="n">inode</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_flags</span> <span class="o">&amp;</span> <span class="n">XFS_IDONTCACHE</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">STATIC</span> <span class="kt">void</span>
<span class="nf">xfs_free_fsname</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">xfs_mount</span>	<span class="o">*</span><span class="n">mp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_fsname</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_rtname</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_logname</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">STATIC</span> <span class="kt">void</span>
<span class="nf">xfs_fs_put_super</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">super_block</span>	<span class="o">*</span><span class="n">sb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">xfs_mount</span>	<span class="o">*</span><span class="n">mp</span> <span class="o">=</span> <span class="n">XFS_M</span><span class="p">(</span><span class="n">sb</span><span class="p">);</span>

	<span class="n">xfs_filestream_unmount</span><span class="p">(</span><span class="n">mp</span><span class="p">);</span>
	<span class="n">xfs_unmountfs</span><span class="p">(</span><span class="n">mp</span><span class="p">);</span>
	<span class="n">xfs_syncd_stop</span><span class="p">(</span><span class="n">mp</span><span class="p">);</span>
	<span class="n">xfs_freesb</span><span class="p">(</span><span class="n">mp</span><span class="p">);</span>
	<span class="n">xfs_icsb_destroy_counters</span><span class="p">(</span><span class="n">mp</span><span class="p">);</span>
	<span class="n">xfs_destroy_mount_workqueues</span><span class="p">(</span><span class="n">mp</span><span class="p">);</span>
	<span class="n">xfs_close_devices</span><span class="p">(</span><span class="n">mp</span><span class="p">);</span>
	<span class="n">xfs_free_fsname</span><span class="p">(</span><span class="n">mp</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">mp</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">STATIC</span> <span class="kt">int</span>
<span class="nf">xfs_fs_sync_fs</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">super_block</span>	<span class="o">*</span><span class="n">sb</span><span class="p">,</span>
	<span class="kt">int</span>			<span class="n">wait</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">xfs_mount</span>	<span class="o">*</span><span class="n">mp</span> <span class="o">=</span> <span class="n">XFS_M</span><span class="p">(</span><span class="n">sb</span><span class="p">);</span>
	<span class="kt">int</span>			<span class="n">error</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Doing anything during the async pass would be counterproductive.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">wait</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">error</span> <span class="o">=</span> <span class="n">xfs_quiesce_data</span><span class="p">(</span><span class="n">mp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">error</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">laptop_mode</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * The disk must be active because we&#39;re syncing.</span>
<span class="cm">		 * We schedule xfssyncd now (now that the disk is</span>
<span class="cm">		 * active) instead of later (when it might not be).</span>
<span class="cm">		 */</span>
		<span class="n">flush_delayed_work_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_sync_work</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">STATIC</span> <span class="kt">int</span>
<span class="nf">xfs_fs_statfs</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">dentry</span>		<span class="o">*</span><span class="n">dentry</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">kstatfs</span>		<span class="o">*</span><span class="n">statp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">xfs_mount</span>	<span class="o">*</span><span class="n">mp</span> <span class="o">=</span> <span class="n">XFS_M</span><span class="p">(</span><span class="n">dentry</span><span class="o">-&gt;</span><span class="n">d_sb</span><span class="p">);</span>
	<span class="n">xfs_sb_t</span>		<span class="o">*</span><span class="n">sbp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_sb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">xfs_inode</span>	<span class="o">*</span><span class="n">ip</span> <span class="o">=</span> <span class="n">XFS_I</span><span class="p">(</span><span class="n">dentry</span><span class="o">-&gt;</span><span class="n">d_inode</span><span class="p">);</span>
	<span class="n">__uint64_t</span>		<span class="n">fakeinos</span><span class="p">,</span> <span class="n">id</span><span class="p">;</span>
	<span class="n">xfs_extlen_t</span>		<span class="n">lsize</span><span class="p">;</span>
	<span class="n">__int64_t</span>		<span class="n">ffree</span><span class="p">;</span>

	<span class="n">statp</span><span class="o">-&gt;</span><span class="n">f_type</span> <span class="o">=</span> <span class="n">XFS_SB_MAGIC</span><span class="p">;</span>
	<span class="n">statp</span><span class="o">-&gt;</span><span class="n">f_namelen</span> <span class="o">=</span> <span class="n">MAXNAMELEN</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">id</span> <span class="o">=</span> <span class="n">huge_encode_dev</span><span class="p">(</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_ddev_targp</span><span class="o">-&gt;</span><span class="n">bt_dev</span><span class="p">);</span>
	<span class="n">statp</span><span class="o">-&gt;</span><span class="n">f_fsid</span><span class="p">.</span><span class="n">val</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">id</span><span class="p">;</span>
	<span class="n">statp</span><span class="o">-&gt;</span><span class="n">f_fsid</span><span class="p">.</span><span class="n">val</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)(</span><span class="n">id</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">);</span>

	<span class="n">xfs_icsb_sync_counters</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="n">XFS_ICSB_LAZY_COUNT</span><span class="p">);</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_sb_lock</span><span class="p">);</span>
	<span class="n">statp</span><span class="o">-&gt;</span><span class="n">f_bsize</span> <span class="o">=</span> <span class="n">sbp</span><span class="o">-&gt;</span><span class="n">sb_blocksize</span><span class="p">;</span>
	<span class="n">lsize</span> <span class="o">=</span> <span class="n">sbp</span><span class="o">-&gt;</span><span class="n">sb_logstart</span> <span class="o">?</span> <span class="n">sbp</span><span class="o">-&gt;</span><span class="n">sb_logblocks</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">statp</span><span class="o">-&gt;</span><span class="n">f_blocks</span> <span class="o">=</span> <span class="n">sbp</span><span class="o">-&gt;</span><span class="n">sb_dblocks</span> <span class="o">-</span> <span class="n">lsize</span><span class="p">;</span>
	<span class="n">statp</span><span class="o">-&gt;</span><span class="n">f_bfree</span> <span class="o">=</span> <span class="n">statp</span><span class="o">-&gt;</span><span class="n">f_bavail</span> <span class="o">=</span>
				<span class="n">sbp</span><span class="o">-&gt;</span><span class="n">sb_fdblocks</span> <span class="o">-</span> <span class="n">XFS_ALLOC_SET_ASIDE</span><span class="p">(</span><span class="n">mp</span><span class="p">);</span>
	<span class="n">fakeinos</span> <span class="o">=</span> <span class="n">statp</span><span class="o">-&gt;</span><span class="n">f_bfree</span> <span class="o">&lt;&lt;</span> <span class="n">sbp</span><span class="o">-&gt;</span><span class="n">sb_inopblog</span><span class="p">;</span>
	<span class="n">statp</span><span class="o">-&gt;</span><span class="n">f_files</span> <span class="o">=</span>
	    <span class="n">MIN</span><span class="p">(</span><span class="n">sbp</span><span class="o">-&gt;</span><span class="n">sb_icount</span> <span class="o">+</span> <span class="n">fakeinos</span><span class="p">,</span> <span class="p">(</span><span class="n">__uint64_t</span><span class="p">)</span><span class="n">XFS_MAXINUMBER</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_maxicount</span><span class="p">)</span>
		<span class="n">statp</span><span class="o">-&gt;</span><span class="n">f_files</span> <span class="o">=</span> <span class="n">min_t</span><span class="p">(</span><span class="n">typeof</span><span class="p">(</span><span class="n">statp</span><span class="o">-&gt;</span><span class="n">f_files</span><span class="p">),</span>
					<span class="n">statp</span><span class="o">-&gt;</span><span class="n">f_files</span><span class="p">,</span>
					<span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_maxicount</span><span class="p">);</span>

	<span class="cm">/* make sure statp-&gt;f_ffree does not underflow */</span>
	<span class="n">ffree</span> <span class="o">=</span> <span class="n">statp</span><span class="o">-&gt;</span><span class="n">f_files</span> <span class="o">-</span> <span class="p">(</span><span class="n">sbp</span><span class="o">-&gt;</span><span class="n">sb_icount</span> <span class="o">-</span> <span class="n">sbp</span><span class="o">-&gt;</span><span class="n">sb_ifree</span><span class="p">);</span>
	<span class="n">statp</span><span class="o">-&gt;</span><span class="n">f_ffree</span> <span class="o">=</span> <span class="n">max_t</span><span class="p">(</span><span class="n">__int64_t</span><span class="p">,</span> <span class="n">ffree</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_sb_lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_d</span><span class="p">.</span><span class="n">di_flags</span> <span class="o">&amp;</span> <span class="n">XFS_DIFLAG_PROJINHERIT</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">((</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_qflags</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">XFS_PQUOTA_ACCT</span><span class="o">|</span><span class="n">XFS_OQUOTA_ENFD</span><span class="p">)))</span> <span class="o">==</span>
			      <span class="p">(</span><span class="n">XFS_PQUOTA_ACCT</span><span class="o">|</span><span class="n">XFS_OQUOTA_ENFD</span><span class="p">))</span>
		<span class="n">xfs_qm_statvfs</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">statp</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">STATIC</span> <span class="kt">void</span>
<span class="nf">xfs_save_resvblks</span><span class="p">(</span><span class="k">struct</span> <span class="n">xfs_mount</span> <span class="o">*</span><span class="n">mp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">__uint64_t</span> <span class="n">resblks</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_resblks_save</span> <span class="o">=</span> <span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_resblks</span><span class="p">;</span>
	<span class="n">xfs_reserve_blocks</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">resblks</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">STATIC</span> <span class="kt">void</span>
<span class="nf">xfs_restore_resvblks</span><span class="p">(</span><span class="k">struct</span> <span class="n">xfs_mount</span> <span class="o">*</span><span class="n">mp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">__uint64_t</span> <span class="n">resblks</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_resblks_save</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">resblks</span> <span class="o">=</span> <span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_resblks_save</span><span class="p">;</span>
		<span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_resblks_save</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">resblks</span> <span class="o">=</span> <span class="n">xfs_default_resblks</span><span class="p">(</span><span class="n">mp</span><span class="p">);</span>

	<span class="n">xfs_reserve_blocks</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">resblks</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">STATIC</span> <span class="kt">int</span>
<span class="nf">xfs_fs_remount</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">super_block</span>	<span class="o">*</span><span class="n">sb</span><span class="p">,</span>
	<span class="kt">int</span>			<span class="o">*</span><span class="n">flags</span><span class="p">,</span>
	<span class="kt">char</span>			<span class="o">*</span><span class="n">options</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">xfs_mount</span>	<span class="o">*</span><span class="n">mp</span> <span class="o">=</span> <span class="n">XFS_M</span><span class="p">(</span><span class="n">sb</span><span class="p">);</span>
	<span class="n">substring_t</span>		<span class="n">args</span><span class="p">[</span><span class="n">MAX_OPT_ARGS</span><span class="p">];</span>
	<span class="kt">char</span>			<span class="o">*</span><span class="n">p</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">error</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">((</span><span class="n">p</span> <span class="o">=</span> <span class="n">strsep</span><span class="p">(</span><span class="o">&amp;</span><span class="n">options</span><span class="p">,</span> <span class="s">&quot;,&quot;</span><span class="p">))</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">token</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!*</span><span class="n">p</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">token</span> <span class="o">=</span> <span class="n">match_token</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">tokens</span><span class="p">,</span> <span class="n">args</span><span class="p">);</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">token</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">Opt_barrier</span>:
			<span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_flags</span> <span class="o">|=</span> <span class="n">XFS_MOUNT_BARRIER</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">Opt_nobarrier</span>:
			<span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">XFS_MOUNT_BARRIER</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="cm">/*</span>
<span class="cm">			 * Logically we would return an error here to prevent</span>
<span class="cm">			 * users from believing they might have changed</span>
<span class="cm">			 * mount options using remount which can&#39;t be changed.</span>
<span class="cm">			 *</span>
<span class="cm">			 * But unfortunately mount(8) adds all options from</span>
<span class="cm">			 * mtab and fstab to the mount arguments in some cases</span>
<span class="cm">			 * so we can&#39;t blindly reject options, but have to</span>
<span class="cm">			 * check for each specified option if it actually</span>
<span class="cm">			 * differs from the currently set option and only</span>
<span class="cm">			 * reject it if that&#39;s the case.</span>
<span class="cm">			 *</span>
<span class="cm">			 * Until that is implemented we return success for</span>
<span class="cm">			 * every remount request, and silently ignore all</span>
<span class="cm">			 * options that we can&#39;t actually change.</span>
<span class="cm">			 */</span>
<span class="cp">#if 0</span><span class="c"></span>
<span class="c">			xfs_info(mp,</span>
<span class="c">		&quot;mount option \&quot;%s\&quot; not supported for remount\n&quot;, p);</span>
<span class="c">			return -EINVAL;</span>
<span class="cp">#else</span>
			<span class="k">break</span><span class="p">;</span>
<span class="cp">#endif</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* ro -&gt; rw */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_flags</span> <span class="o">&amp;</span> <span class="n">XFS_MOUNT_RDONLY</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="o">*</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MS_RDONLY</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">XFS_MOUNT_RDONLY</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * If this is the first remount to writeable state we</span>
<span class="cm">		 * might have some superblock changes to update.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_update_flags</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">error</span> <span class="o">=</span> <span class="n">xfs_mount_log_sb</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_update_flags</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">xfs_warn</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="s">&quot;failed to write sb changes&quot;</span><span class="p">);</span>
				<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_update_flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/*</span>
<span class="cm">		 * Fill out the reserve pool if it is empty. Use the stashed</span>
<span class="cm">		 * value if it is non-zero, otherwise go with the default.</span>
<span class="cm">		 */</span>
		<span class="n">xfs_restore_resvblks</span><span class="p">(</span><span class="n">mp</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* rw -&gt; ro */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_flags</span> <span class="o">&amp;</span> <span class="n">XFS_MOUNT_RDONLY</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="o">*</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MS_RDONLY</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * After we have synced the data but before we sync the</span>
<span class="cm">		 * metadata, we need to free up the reserve block pool so that</span>
<span class="cm">		 * the used block count in the superblock on disk is correct at</span>
<span class="cm">		 * the end of the remount. Stash the current reserve pool size</span>
<span class="cm">		 * so that if we get remounted rw, we can return it to the same</span>
<span class="cm">		 * size.</span>
<span class="cm">		 */</span>

		<span class="n">xfs_quiesce_data</span><span class="p">(</span><span class="n">mp</span><span class="p">);</span>
		<span class="n">xfs_save_resvblks</span><span class="p">(</span><span class="n">mp</span><span class="p">);</span>
		<span class="n">xfs_quiesce_attr</span><span class="p">(</span><span class="n">mp</span><span class="p">);</span>
		<span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_flags</span> <span class="o">|=</span> <span class="n">XFS_MOUNT_RDONLY</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Second stage of a freeze. The data is already frozen so we only</span>
<span class="cm"> * need to take care of the metadata. Once that&#39;s done write a dummy</span>
<span class="cm"> * record to dirty the log in case of a crash while frozen.</span>
<span class="cm"> */</span>
<span class="n">STATIC</span> <span class="kt">int</span>
<span class="nf">xfs_fs_freeze</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">super_block</span>	<span class="o">*</span><span class="n">sb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">xfs_mount</span>	<span class="o">*</span><span class="n">mp</span> <span class="o">=</span> <span class="n">XFS_M</span><span class="p">(</span><span class="n">sb</span><span class="p">);</span>

	<span class="n">xfs_save_resvblks</span><span class="p">(</span><span class="n">mp</span><span class="p">);</span>
	<span class="n">xfs_quiesce_attr</span><span class="p">(</span><span class="n">mp</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">xfs_fs_log_dummy</span><span class="p">(</span><span class="n">mp</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">STATIC</span> <span class="kt">int</span>
<span class="nf">xfs_fs_unfreeze</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">super_block</span>	<span class="o">*</span><span class="n">sb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">xfs_mount</span>	<span class="o">*</span><span class="n">mp</span> <span class="o">=</span> <span class="n">XFS_M</span><span class="p">(</span><span class="n">sb</span><span class="p">);</span>

	<span class="n">xfs_restore_resvblks</span><span class="p">(</span><span class="n">mp</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">STATIC</span> <span class="kt">int</span>
<span class="nf">xfs_fs_show_options</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">seq_file</span>		<span class="o">*</span><span class="n">m</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">dentry</span>		<span class="o">*</span><span class="n">root</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">xfs_showargs</span><span class="p">(</span><span class="n">XFS_M</span><span class="p">(</span><span class="n">root</span><span class="o">-&gt;</span><span class="n">d_sb</span><span class="p">),</span> <span class="n">m</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * This function fills in xfs_mount_t fields based on mount args.</span>
<span class="cm"> * Note: the superblock _has_ now been read in.</span>
<span class="cm"> */</span>
<span class="n">STATIC</span> <span class="kt">int</span>
<span class="nf">xfs_finish_flags</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">xfs_mount</span>	<span class="o">*</span><span class="n">mp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span>			<span class="n">ronly</span> <span class="o">=</span> <span class="p">(</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_flags</span> <span class="o">&amp;</span> <span class="n">XFS_MOUNT_RDONLY</span><span class="p">);</span>

	<span class="cm">/* Fail a mount where the logbuf is smaller than the log stripe */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">xfs_sb_version_haslogv2</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_sb</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_logbsize</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
		    <span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_sb</span><span class="p">.</span><span class="n">sb_logsunit</span> <span class="o">&gt;</span> <span class="n">XLOG_BIG_RECORD_BSIZE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_logbsize</span> <span class="o">=</span> <span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_sb</span><span class="p">.</span><span class="n">sb_logsunit</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_logbsize</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
			   <span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_logbsize</span> <span class="o">&lt;</span> <span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_sb</span><span class="p">.</span><span class="n">sb_logsunit</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">xfs_warn</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span>
		<span class="s">&quot;logbuf size must be greater than or equal to log stripe size&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">XFS_ERROR</span><span class="p">(</span><span class="n">EINVAL</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* Fail a mount if the logbuf is larger than 32K */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_logbsize</span> <span class="o">&gt;</span> <span class="n">XLOG_BIG_RECORD_BSIZE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">xfs_warn</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span>
		<span class="s">&quot;logbuf size for version 1 logs must be 16K or 32K&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">XFS_ERROR</span><span class="p">(</span><span class="n">EINVAL</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * mkfs&#39;ed attr2 will turn on attr2 mount unless explicitly</span>
<span class="cm">	 * told by noattr2 to turn it off</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">xfs_sb_version_hasattr2</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_sb</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="p">(</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_flags</span> <span class="o">&amp;</span> <span class="n">XFS_MOUNT_NOATTR2</span><span class="p">))</span>
		<span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_flags</span> <span class="o">|=</span> <span class="n">XFS_MOUNT_ATTR2</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * prohibit r/w mounts of read-only filesystems</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_sb</span><span class="p">.</span><span class="n">sb_flags</span> <span class="o">&amp;</span> <span class="n">XFS_SBF_READONLY</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">ronly</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">xfs_warn</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span>
			<span class="s">&quot;cannot mount a read-only filesystem as read-write&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">XFS_ERROR</span><span class="p">(</span><span class="n">EROFS</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">STATIC</span> <span class="kt">int</span>
<span class="nf">xfs_fs_fill_super</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">super_block</span>	<span class="o">*</span><span class="n">sb</span><span class="p">,</span>
	<span class="kt">void</span>			<span class="o">*</span><span class="n">data</span><span class="p">,</span>
	<span class="kt">int</span>			<span class="n">silent</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">inode</span>		<span class="o">*</span><span class="n">root</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">xfs_mount</span>	<span class="o">*</span><span class="n">mp</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">error</span> <span class="o">=</span> <span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">mp</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">xfs_mount</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mp</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_sb_lock</span><span class="p">);</span>
	<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_growlock</span><span class="p">);</span>
	<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_active_trans</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_super</span> <span class="o">=</span> <span class="n">sb</span><span class="p">;</span>
	<span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_fs_info</span> <span class="o">=</span> <span class="n">mp</span><span class="p">;</span>

	<span class="n">error</span> <span class="o">=</span> <span class="n">xfs_parseargs</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">data</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_free_fsname</span><span class="p">;</span>

	<span class="n">sb_min_blocksize</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">BBSIZE</span><span class="p">);</span>
	<span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_xattr</span> <span class="o">=</span> <span class="n">xfs_xattr_handlers</span><span class="p">;</span>
	<span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_export_op</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">xfs_export_operations</span><span class="p">;</span>
<span class="cp">#ifdef CONFIG_XFS_QUOTA</span>
	<span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_qcop</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">xfs_quotactl_operations</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_op</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">xfs_super_operations</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">silent</span><span class="p">)</span>
		<span class="n">flags</span> <span class="o">|=</span> <span class="n">XFS_MFSI_QUIET</span><span class="p">;</span>

	<span class="n">error</span> <span class="o">=</span> <span class="n">xfs_open_devices</span><span class="p">(</span><span class="n">mp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_free_fsname</span><span class="p">;</span>

	<span class="n">error</span> <span class="o">=</span> <span class="n">xfs_init_mount_workqueues</span><span class="p">(</span><span class="n">mp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_close_devices</span><span class="p">;</span>

	<span class="n">error</span> <span class="o">=</span> <span class="n">xfs_icsb_init_counters</span><span class="p">(</span><span class="n">mp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_destroy_workqueues</span><span class="p">;</span>

	<span class="n">error</span> <span class="o">=</span> <span class="n">xfs_readsb</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_destroy_counters</span><span class="p">;</span>

	<span class="n">error</span> <span class="o">=</span> <span class="n">xfs_finish_flags</span><span class="p">(</span><span class="n">mp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_free_sb</span><span class="p">;</span>

	<span class="n">error</span> <span class="o">=</span> <span class="n">xfs_setup_devices</span><span class="p">(</span><span class="n">mp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_free_sb</span><span class="p">;</span>

	<span class="n">error</span> <span class="o">=</span> <span class="n">xfs_filestream_mount</span><span class="p">(</span><span class="n">mp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_free_sb</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * we must configure the block size in the superblock before we run the</span>
<span class="cm">	 * full mount process as the mount process can lookup and cache inodes.</span>
<span class="cm">	 * For the same reason we must also initialise the syncd and register</span>
<span class="cm">	 * the inode cache shrinker so that inodes can be reclaimed during</span>
<span class="cm">	 * operations like a quotacheck that iterate all inodes in the</span>
<span class="cm">	 * filesystem.</span>
<span class="cm">	 */</span>
	<span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_magic</span> <span class="o">=</span> <span class="n">XFS_SB_MAGIC</span><span class="p">;</span>
	<span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_blocksize</span> <span class="o">=</span> <span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_sb</span><span class="p">.</span><span class="n">sb_blocksize</span><span class="p">;</span>
	<span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_blocksize_bits</span> <span class="o">=</span> <span class="n">ffs</span><span class="p">(</span><span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_blocksize</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_maxbytes</span> <span class="o">=</span> <span class="n">xfs_max_file_offset</span><span class="p">(</span><span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_blocksize_bits</span><span class="p">);</span>
	<span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_max_links</span> <span class="o">=</span> <span class="n">XFS_MAXLINK</span><span class="p">;</span>
	<span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_time_gran</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">set_posix_acl_flag</span><span class="p">(</span><span class="n">sb</span><span class="p">);</span>

	<span class="n">error</span> <span class="o">=</span> <span class="n">xfs_syncd_init</span><span class="p">(</span><span class="n">mp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_filestream_unmount</span><span class="p">;</span>

	<span class="n">error</span> <span class="o">=</span> <span class="n">xfs_mountfs</span><span class="p">(</span><span class="n">mp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_syncd_stop</span><span class="p">;</span>

	<span class="n">root</span> <span class="o">=</span> <span class="n">igrab</span><span class="p">(</span><span class="n">VFS_I</span><span class="p">(</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_rootip</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">root</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">error</span> <span class="o">=</span> <span class="n">ENOENT</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out_unmount</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">is_bad_inode</span><span class="p">(</span><span class="n">root</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">error</span> <span class="o">=</span> <span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out_unmount</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_root</span> <span class="o">=</span> <span class="n">d_make_root</span><span class="p">(</span><span class="n">root</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_root</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">error</span> <span class="o">=</span> <span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out_unmount</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
 <span class="nl">out_syncd_stop:</span>
	<span class="n">xfs_syncd_stop</span><span class="p">(</span><span class="n">mp</span><span class="p">);</span>
 <span class="nl">out_filestream_unmount:</span>
	<span class="n">xfs_filestream_unmount</span><span class="p">(</span><span class="n">mp</span><span class="p">);</span>
 <span class="nl">out_free_sb:</span>
	<span class="n">xfs_freesb</span><span class="p">(</span><span class="n">mp</span><span class="p">);</span>
 <span class="nl">out_destroy_counters:</span>
	<span class="n">xfs_icsb_destroy_counters</span><span class="p">(</span><span class="n">mp</span><span class="p">);</span>
<span class="nl">out_destroy_workqueues:</span>
	<span class="n">xfs_destroy_mount_workqueues</span><span class="p">(</span><span class="n">mp</span><span class="p">);</span>
 <span class="nl">out_close_devices:</span>
	<span class="n">xfs_close_devices</span><span class="p">(</span><span class="n">mp</span><span class="p">);</span>
 <span class="nl">out_free_fsname:</span>
	<span class="n">xfs_free_fsname</span><span class="p">(</span><span class="n">mp</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">mp</span><span class="p">);</span>
 <span class="nl">out:</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">error</span><span class="p">;</span>

 <span class="nl">out_unmount:</span>
	<span class="n">xfs_filestream_unmount</span><span class="p">(</span><span class="n">mp</span><span class="p">);</span>
	<span class="n">xfs_unmountfs</span><span class="p">(</span><span class="n">mp</span><span class="p">);</span>
	<span class="n">xfs_syncd_stop</span><span class="p">(</span><span class="n">mp</span><span class="p">);</span>
	<span class="k">goto</span> <span class="n">out_free_sb</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">STATIC</span> <span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span>
<span class="nf">xfs_fs_mount</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">file_system_type</span>	<span class="o">*</span><span class="n">fs_type</span><span class="p">,</span>
	<span class="kt">int</span>			<span class="n">flags</span><span class="p">,</span>
	<span class="k">const</span> <span class="kt">char</span>		<span class="o">*</span><span class="n">dev_name</span><span class="p">,</span>
	<span class="kt">void</span>			<span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">mount_bdev</span><span class="p">(</span><span class="n">fs_type</span><span class="p">,</span> <span class="n">flags</span><span class="p">,</span> <span class="n">dev_name</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">xfs_fs_fill_super</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">xfs_fs_nr_cached_objects</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">super_block</span>	<span class="o">*</span><span class="n">sb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">xfs_reclaim_inodes_count</span><span class="p">(</span><span class="n">XFS_M</span><span class="p">(</span><span class="n">sb</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">xfs_fs_free_cached_objects</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">super_block</span>	<span class="o">*</span><span class="n">sb</span><span class="p">,</span>
	<span class="kt">int</span>			<span class="n">nr_to_scan</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">xfs_reclaim_inodes_nr</span><span class="p">(</span><span class="n">XFS_M</span><span class="p">(</span><span class="n">sb</span><span class="p">),</span> <span class="n">nr_to_scan</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">super_operations</span> <span class="n">xfs_super_operations</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">alloc_inode</span>		<span class="o">=</span> <span class="n">xfs_fs_alloc_inode</span><span class="p">,</span>
	<span class="p">.</span><span class="n">destroy_inode</span>		<span class="o">=</span> <span class="n">xfs_fs_destroy_inode</span><span class="p">,</span>
	<span class="p">.</span><span class="n">dirty_inode</span>		<span class="o">=</span> <span class="n">xfs_fs_dirty_inode</span><span class="p">,</span>
	<span class="p">.</span><span class="n">evict_inode</span>		<span class="o">=</span> <span class="n">xfs_fs_evict_inode</span><span class="p">,</span>
	<span class="p">.</span><span class="n">drop_inode</span>		<span class="o">=</span> <span class="n">xfs_fs_drop_inode</span><span class="p">,</span>
	<span class="p">.</span><span class="n">put_super</span>		<span class="o">=</span> <span class="n">xfs_fs_put_super</span><span class="p">,</span>
	<span class="p">.</span><span class="n">sync_fs</span>		<span class="o">=</span> <span class="n">xfs_fs_sync_fs</span><span class="p">,</span>
	<span class="p">.</span><span class="n">freeze_fs</span>		<span class="o">=</span> <span class="n">xfs_fs_freeze</span><span class="p">,</span>
	<span class="p">.</span><span class="n">unfreeze_fs</span>		<span class="o">=</span> <span class="n">xfs_fs_unfreeze</span><span class="p">,</span>
	<span class="p">.</span><span class="n">statfs</span>			<span class="o">=</span> <span class="n">xfs_fs_statfs</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remount_fs</span>		<span class="o">=</span> <span class="n">xfs_fs_remount</span><span class="p">,</span>
	<span class="p">.</span><span class="n">show_options</span>		<span class="o">=</span> <span class="n">xfs_fs_show_options</span><span class="p">,</span>
	<span class="p">.</span><span class="n">nr_cached_objects</span>	<span class="o">=</span> <span class="n">xfs_fs_nr_cached_objects</span><span class="p">,</span>
	<span class="p">.</span><span class="n">free_cached_objects</span>	<span class="o">=</span> <span class="n">xfs_fs_free_cached_objects</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">file_system_type</span> <span class="n">xfs_fs_type</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span>			<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">name</span>			<span class="o">=</span> <span class="s">&quot;xfs&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">mount</span>			<span class="o">=</span> <span class="n">xfs_fs_mount</span><span class="p">,</span>
	<span class="p">.</span><span class="n">kill_sb</span>		<span class="o">=</span> <span class="n">kill_block_super</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fs_flags</span>		<span class="o">=</span> <span class="n">FS_REQUIRES_DEV</span><span class="p">,</span>
<span class="p">};</span>

<span class="n">STATIC</span> <span class="kt">int</span> <span class="n">__init</span>
<span class="nf">xfs_init_zones</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>

	<span class="n">xfs_ioend_zone</span> <span class="o">=</span> <span class="n">kmem_zone_init</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">xfs_ioend_t</span><span class="p">),</span> <span class="s">&quot;xfs_ioend&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">xfs_ioend_zone</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">xfs_ioend_pool</span> <span class="o">=</span> <span class="n">mempool_create_slab_pool</span><span class="p">(</span><span class="mi">4</span> <span class="o">*</span> <span class="n">MAX_BUF_PER_PAGE</span><span class="p">,</span>
						  <span class="n">xfs_ioend_zone</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">xfs_ioend_pool</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_destroy_ioend_zone</span><span class="p">;</span>

	<span class="n">xfs_log_ticket_zone</span> <span class="o">=</span> <span class="n">kmem_zone_init</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">xlog_ticket_t</span><span class="p">),</span>
						<span class="s">&quot;xfs_log_ticket&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">xfs_log_ticket_zone</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_destroy_ioend_pool</span><span class="p">;</span>

	<span class="n">xfs_bmap_free_item_zone</span> <span class="o">=</span> <span class="n">kmem_zone_init</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">xfs_bmap_free_item_t</span><span class="p">),</span>
						<span class="s">&quot;xfs_bmap_free_item&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">xfs_bmap_free_item_zone</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_destroy_log_ticket_zone</span><span class="p">;</span>

	<span class="n">xfs_btree_cur_zone</span> <span class="o">=</span> <span class="n">kmem_zone_init</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">xfs_btree_cur_t</span><span class="p">),</span>
						<span class="s">&quot;xfs_btree_cur&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">xfs_btree_cur_zone</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_destroy_bmap_free_item_zone</span><span class="p">;</span>

	<span class="n">xfs_da_state_zone</span> <span class="o">=</span> <span class="n">kmem_zone_init</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">xfs_da_state_t</span><span class="p">),</span>
						<span class="s">&quot;xfs_da_state&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">xfs_da_state_zone</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_destroy_btree_cur_zone</span><span class="p">;</span>

	<span class="n">xfs_dabuf_zone</span> <span class="o">=</span> <span class="n">kmem_zone_init</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">xfs_dabuf_t</span><span class="p">),</span> <span class="s">&quot;xfs_dabuf&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">xfs_dabuf_zone</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_destroy_da_state_zone</span><span class="p">;</span>

	<span class="n">xfs_ifork_zone</span> <span class="o">=</span> <span class="n">kmem_zone_init</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">xfs_ifork_t</span><span class="p">),</span> <span class="s">&quot;xfs_ifork&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">xfs_ifork_zone</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_destroy_dabuf_zone</span><span class="p">;</span>

	<span class="n">xfs_trans_zone</span> <span class="o">=</span> <span class="n">kmem_zone_init</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">xfs_trans_t</span><span class="p">),</span> <span class="s">&quot;xfs_trans&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">xfs_trans_zone</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_destroy_ifork_zone</span><span class="p">;</span>

	<span class="n">xfs_log_item_desc_zone</span> <span class="o">=</span>
		<span class="n">kmem_zone_init</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">xfs_log_item_desc</span><span class="p">),</span>
			       <span class="s">&quot;xfs_log_item_desc&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">xfs_log_item_desc_zone</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_destroy_trans_zone</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * The size of the zone allocated buf log item is the maximum</span>
<span class="cm">	 * size possible under XFS.  This wastes a little bit of memory,</span>
<span class="cm">	 * but it is much faster.</span>
<span class="cm">	 */</span>
	<span class="n">xfs_buf_item_zone</span> <span class="o">=</span> <span class="n">kmem_zone_init</span><span class="p">((</span><span class="k">sizeof</span><span class="p">(</span><span class="n">xfs_buf_log_item_t</span><span class="p">)</span> <span class="o">+</span>
				<span class="p">(((</span><span class="n">XFS_MAX_BLOCKSIZE</span> <span class="o">/</span> <span class="n">XFS_BLF_CHUNK</span><span class="p">)</span> <span class="o">/</span>
				  <span class="n">NBWORD</span><span class="p">)</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">))),</span> <span class="s">&quot;xfs_buf_item&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">xfs_buf_item_zone</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_destroy_log_item_desc_zone</span><span class="p">;</span>

	<span class="n">xfs_efd_zone</span> <span class="o">=</span> <span class="n">kmem_zone_init</span><span class="p">((</span><span class="k">sizeof</span><span class="p">(</span><span class="n">xfs_efd_log_item_t</span><span class="p">)</span> <span class="o">+</span>
			<span class="p">((</span><span class="n">XFS_EFD_MAX_FAST_EXTENTS</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span>
				 <span class="k">sizeof</span><span class="p">(</span><span class="n">xfs_extent_t</span><span class="p">))),</span> <span class="s">&quot;xfs_efd_item&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">xfs_efd_zone</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_destroy_buf_item_zone</span><span class="p">;</span>

	<span class="n">xfs_efi_zone</span> <span class="o">=</span> <span class="n">kmem_zone_init</span><span class="p">((</span><span class="k">sizeof</span><span class="p">(</span><span class="n">xfs_efi_log_item_t</span><span class="p">)</span> <span class="o">+</span>
			<span class="p">((</span><span class="n">XFS_EFI_MAX_FAST_EXTENTS</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span>
				<span class="k">sizeof</span><span class="p">(</span><span class="n">xfs_extent_t</span><span class="p">))),</span> <span class="s">&quot;xfs_efi_item&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">xfs_efi_zone</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_destroy_efd_zone</span><span class="p">;</span>

	<span class="n">xfs_inode_zone</span> <span class="o">=</span>
		<span class="n">kmem_zone_init_flags</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">xfs_inode_t</span><span class="p">),</span> <span class="s">&quot;xfs_inode&quot;</span><span class="p">,</span>
			<span class="n">KM_ZONE_HWALIGN</span> <span class="o">|</span> <span class="n">KM_ZONE_RECLAIM</span> <span class="o">|</span> <span class="n">KM_ZONE_SPREAD</span><span class="p">,</span>
			<span class="n">xfs_fs_inode_init_once</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">xfs_inode_zone</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_destroy_efi_zone</span><span class="p">;</span>

	<span class="n">xfs_ili_zone</span> <span class="o">=</span>
		<span class="n">kmem_zone_init_flags</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">xfs_inode_log_item_t</span><span class="p">),</span> <span class="s">&quot;xfs_ili&quot;</span><span class="p">,</span>
					<span class="n">KM_ZONE_SPREAD</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">xfs_ili_zone</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_destroy_inode_zone</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

 <span class="nl">out_destroy_inode_zone:</span>
	<span class="n">kmem_zone_destroy</span><span class="p">(</span><span class="n">xfs_inode_zone</span><span class="p">);</span>
 <span class="nl">out_destroy_efi_zone:</span>
	<span class="n">kmem_zone_destroy</span><span class="p">(</span><span class="n">xfs_efi_zone</span><span class="p">);</span>
 <span class="nl">out_destroy_efd_zone:</span>
	<span class="n">kmem_zone_destroy</span><span class="p">(</span><span class="n">xfs_efd_zone</span><span class="p">);</span>
 <span class="nl">out_destroy_buf_item_zone:</span>
	<span class="n">kmem_zone_destroy</span><span class="p">(</span><span class="n">xfs_buf_item_zone</span><span class="p">);</span>
 <span class="nl">out_destroy_log_item_desc_zone:</span>
	<span class="n">kmem_zone_destroy</span><span class="p">(</span><span class="n">xfs_log_item_desc_zone</span><span class="p">);</span>
 <span class="nl">out_destroy_trans_zone:</span>
	<span class="n">kmem_zone_destroy</span><span class="p">(</span><span class="n">xfs_trans_zone</span><span class="p">);</span>
 <span class="nl">out_destroy_ifork_zone:</span>
	<span class="n">kmem_zone_destroy</span><span class="p">(</span><span class="n">xfs_ifork_zone</span><span class="p">);</span>
 <span class="nl">out_destroy_dabuf_zone:</span>
	<span class="n">kmem_zone_destroy</span><span class="p">(</span><span class="n">xfs_dabuf_zone</span><span class="p">);</span>
 <span class="nl">out_destroy_da_state_zone:</span>
	<span class="n">kmem_zone_destroy</span><span class="p">(</span><span class="n">xfs_da_state_zone</span><span class="p">);</span>
 <span class="nl">out_destroy_btree_cur_zone:</span>
	<span class="n">kmem_zone_destroy</span><span class="p">(</span><span class="n">xfs_btree_cur_zone</span><span class="p">);</span>
 <span class="nl">out_destroy_bmap_free_item_zone:</span>
	<span class="n">kmem_zone_destroy</span><span class="p">(</span><span class="n">xfs_bmap_free_item_zone</span><span class="p">);</span>
 <span class="nl">out_destroy_log_ticket_zone:</span>
	<span class="n">kmem_zone_destroy</span><span class="p">(</span><span class="n">xfs_log_ticket_zone</span><span class="p">);</span>
 <span class="nl">out_destroy_ioend_pool:</span>
	<span class="n">mempool_destroy</span><span class="p">(</span><span class="n">xfs_ioend_pool</span><span class="p">);</span>
 <span class="nl">out_destroy_ioend_zone:</span>
	<span class="n">kmem_zone_destroy</span><span class="p">(</span><span class="n">xfs_ioend_zone</span><span class="p">);</span>
 <span class="nl">out:</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">STATIC</span> <span class="kt">void</span>
<span class="nf">xfs_destroy_zones</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">kmem_zone_destroy</span><span class="p">(</span><span class="n">xfs_ili_zone</span><span class="p">);</span>
	<span class="n">kmem_zone_destroy</span><span class="p">(</span><span class="n">xfs_inode_zone</span><span class="p">);</span>
	<span class="n">kmem_zone_destroy</span><span class="p">(</span><span class="n">xfs_efi_zone</span><span class="p">);</span>
	<span class="n">kmem_zone_destroy</span><span class="p">(</span><span class="n">xfs_efd_zone</span><span class="p">);</span>
	<span class="n">kmem_zone_destroy</span><span class="p">(</span><span class="n">xfs_buf_item_zone</span><span class="p">);</span>
	<span class="n">kmem_zone_destroy</span><span class="p">(</span><span class="n">xfs_log_item_desc_zone</span><span class="p">);</span>
	<span class="n">kmem_zone_destroy</span><span class="p">(</span><span class="n">xfs_trans_zone</span><span class="p">);</span>
	<span class="n">kmem_zone_destroy</span><span class="p">(</span><span class="n">xfs_ifork_zone</span><span class="p">);</span>
	<span class="n">kmem_zone_destroy</span><span class="p">(</span><span class="n">xfs_dabuf_zone</span><span class="p">);</span>
	<span class="n">kmem_zone_destroy</span><span class="p">(</span><span class="n">xfs_da_state_zone</span><span class="p">);</span>
	<span class="n">kmem_zone_destroy</span><span class="p">(</span><span class="n">xfs_btree_cur_zone</span><span class="p">);</span>
	<span class="n">kmem_zone_destroy</span><span class="p">(</span><span class="n">xfs_bmap_free_item_zone</span><span class="p">);</span>
	<span class="n">kmem_zone_destroy</span><span class="p">(</span><span class="n">xfs_log_ticket_zone</span><span class="p">);</span>
	<span class="n">mempool_destroy</span><span class="p">(</span><span class="n">xfs_ioend_pool</span><span class="p">);</span>
	<span class="n">kmem_zone_destroy</span><span class="p">(</span><span class="n">xfs_ioend_zone</span><span class="p">);</span>

<span class="p">}</span>

<span class="n">STATIC</span> <span class="kt">int</span> <span class="n">__init</span>
<span class="nf">xfs_init_workqueues</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/*</span>
<span class="cm">	 * We never want to the same work item to run twice, reclaiming inodes</span>
<span class="cm">	 * or idling the log is not going to get any faster by multiple CPUs</span>
<span class="cm">	 * competing for ressources.  Use the default large max_active value</span>
<span class="cm">	 * so that even lots of filesystems can perform these task in parallel.</span>
<span class="cm">	 */</span>
	<span class="n">xfs_syncd_wq</span> <span class="o">=</span> <span class="n">alloc_workqueue</span><span class="p">(</span><span class="s">&quot;xfssyncd&quot;</span><span class="p">,</span> <span class="n">WQ_NON_REENTRANT</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">xfs_syncd_wq</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * The allocation workqueue can be used in memory reclaim situations</span>
<span class="cm">	 * (writepage path), and parallelism is only limited by the number of</span>
<span class="cm">	 * AGs in all the filesystems mounted. Hence use the default large</span>
<span class="cm">	 * max_active value for this workqueue.</span>
<span class="cm">	 */</span>
	<span class="n">xfs_alloc_wq</span> <span class="o">=</span> <span class="n">alloc_workqueue</span><span class="p">(</span><span class="s">&quot;xfsalloc&quot;</span><span class="p">,</span> <span class="n">WQ_MEM_RECLAIM</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">xfs_alloc_wq</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_destroy_syncd</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">out_destroy_syncd:</span>
	<span class="n">destroy_workqueue</span><span class="p">(</span><span class="n">xfs_syncd_wq</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">STATIC</span> <span class="kt">void</span>
<span class="nf">xfs_destroy_workqueues</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">destroy_workqueue</span><span class="p">(</span><span class="n">xfs_alloc_wq</span><span class="p">);</span>
	<span class="n">destroy_workqueue</span><span class="p">(</span><span class="n">xfs_syncd_wq</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">STATIC</span> <span class="kt">int</span> <span class="n">__init</span>
<span class="nf">init_xfs_fs</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span>			<span class="n">error</span><span class="p">;</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="n">XFS_VERSION_STRING</span> <span class="s">&quot; with &quot;</span>
			 <span class="n">XFS_BUILD_OPTIONS</span> <span class="s">&quot; enabled</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">xfs_dir_startup</span><span class="p">();</span>

	<span class="n">error</span> <span class="o">=</span> <span class="n">xfs_init_zones</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">error</span> <span class="o">=</span> <span class="n">xfs_init_workqueues</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_destroy_zones</span><span class="p">;</span>

	<span class="n">error</span> <span class="o">=</span> <span class="n">xfs_mru_cache_init</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_destroy_wq</span><span class="p">;</span>

	<span class="n">error</span> <span class="o">=</span> <span class="n">xfs_filestream_init</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_mru_cache_uninit</span><span class="p">;</span>

	<span class="n">error</span> <span class="o">=</span> <span class="n">xfs_buf_init</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_filestream_uninit</span><span class="p">;</span>

	<span class="n">error</span> <span class="o">=</span> <span class="n">xfs_init_procfs</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_buf_terminate</span><span class="p">;</span>

	<span class="n">error</span> <span class="o">=</span> <span class="n">xfs_sysctl_register</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_cleanup_procfs</span><span class="p">;</span>

	<span class="n">error</span> <span class="o">=</span> <span class="n">xfs_qm_init</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_sysctl_unregister</span><span class="p">;</span>

	<span class="n">error</span> <span class="o">=</span> <span class="n">register_filesystem</span><span class="p">(</span><span class="o">&amp;</span><span class="n">xfs_fs_type</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_qm_exit</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

 <span class="nl">out_qm_exit:</span>
	<span class="n">xfs_qm_exit</span><span class="p">();</span>
 <span class="nl">out_sysctl_unregister:</span>
	<span class="n">xfs_sysctl_unregister</span><span class="p">();</span>
 <span class="nl">out_cleanup_procfs:</span>
	<span class="n">xfs_cleanup_procfs</span><span class="p">();</span>
 <span class="nl">out_buf_terminate:</span>
	<span class="n">xfs_buf_terminate</span><span class="p">();</span>
 <span class="nl">out_filestream_uninit:</span>
	<span class="n">xfs_filestream_uninit</span><span class="p">();</span>
 <span class="nl">out_mru_cache_uninit:</span>
	<span class="n">xfs_mru_cache_uninit</span><span class="p">();</span>
 <span class="nl">out_destroy_wq:</span>
	<span class="n">xfs_destroy_workqueues</span><span class="p">();</span>
 <span class="nl">out_destroy_zones:</span>
	<span class="n">xfs_destroy_zones</span><span class="p">();</span>
 <span class="nl">out:</span>
	<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">STATIC</span> <span class="kt">void</span> <span class="n">__exit</span>
<span class="nf">exit_xfs_fs</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">xfs_qm_exit</span><span class="p">();</span>
	<span class="n">unregister_filesystem</span><span class="p">(</span><span class="o">&amp;</span><span class="n">xfs_fs_type</span><span class="p">);</span>
	<span class="n">xfs_sysctl_unregister</span><span class="p">();</span>
	<span class="n">xfs_cleanup_procfs</span><span class="p">();</span>
	<span class="n">xfs_buf_terminate</span><span class="p">();</span>
	<span class="n">xfs_filestream_uninit</span><span class="p">();</span>
	<span class="n">xfs_mru_cache_uninit</span><span class="p">();</span>
	<span class="n">xfs_destroy_workqueues</span><span class="p">();</span>
	<span class="n">xfs_destroy_zones</span><span class="p">();</span>
<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">init_xfs_fs</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">exit_xfs_fs</span><span class="p">);</span>

<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Silicon Graphics, Inc.&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="n">XFS_VERSION_STRING</span> <span class="s">&quot; with &quot;</span> <span class="n">XFS_BUILD_OPTIONS</span> <span class="s">&quot; enabled&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
