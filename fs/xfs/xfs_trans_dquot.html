<!DOCTYPE html>
<html><head><title>joekychen/linux » fs › xfs › xfs_trans_dquot.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>xfs_trans_dquot.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Copyright (c) 2000-2002 Silicon Graphics, Inc.</span>
<span class="cm"> * All Rights Reserved.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or</span>
<span class="cm"> * modify it under the terms of the GNU General Public License as</span>
<span class="cm"> * published by the Free Software Foundation.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is distributed in the hope that it would be useful,</span>
<span class="cm"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm"> * GNU General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> * You should have received a copy of the GNU General Public License</span>
<span class="cm"> * along with this program; if not, write the Free Software Foundation,</span>
<span class="cm"> * Inc.,  51 Franklin St, Fifth Floor, Boston, MA  02110-1301  USA</span>
<span class="cm"> */</span>
<span class="cp">#include &quot;xfs.h&quot;</span>
<span class="cp">#include &quot;xfs_fs.h&quot;</span>
<span class="cp">#include &quot;xfs_log.h&quot;</span>
<span class="cp">#include &quot;xfs_trans.h&quot;</span>
<span class="cp">#include &quot;xfs_sb.h&quot;</span>
<span class="cp">#include &quot;xfs_ag.h&quot;</span>
<span class="cp">#include &quot;xfs_alloc.h&quot;</span>
<span class="cp">#include &quot;xfs_quota.h&quot;</span>
<span class="cp">#include &quot;xfs_mount.h&quot;</span>
<span class="cp">#include &quot;xfs_bmap_btree.h&quot;</span>
<span class="cp">#include &quot;xfs_inode.h&quot;</span>
<span class="cp">#include &quot;xfs_itable.h&quot;</span>
<span class="cp">#include &quot;xfs_bmap.h&quot;</span>
<span class="cp">#include &quot;xfs_rtalloc.h&quot;</span>
<span class="cp">#include &quot;xfs_error.h&quot;</span>
<span class="cp">#include &quot;xfs_attr.h&quot;</span>
<span class="cp">#include &quot;xfs_buf_item.h&quot;</span>
<span class="cp">#include &quot;xfs_trans_priv.h&quot;</span>
<span class="cp">#include &quot;xfs_qm.h&quot;</span>

<span class="n">STATIC</span> <span class="kt">void</span>	<span class="n">xfs_trans_alloc_dqinfo</span><span class="p">(</span><span class="n">xfs_trans_t</span> <span class="o">*</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * Add the locked dquot to the transaction.</span>
<span class="cm"> * The dquot must be locked, and it cannot be associated with any</span>
<span class="cm"> * transaction.</span>
<span class="cm"> */</span>
<span class="kt">void</span>
<span class="nf">xfs_trans_dqjoin</span><span class="p">(</span>
	<span class="n">xfs_trans_t</span>	<span class="o">*</span><span class="n">tp</span><span class="p">,</span>
	<span class="n">xfs_dquot_t</span>	<span class="o">*</span><span class="n">dqp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ASSERT</span><span class="p">(</span><span class="n">dqp</span><span class="o">-&gt;</span><span class="n">q_transp</span> <span class="o">!=</span> <span class="n">tp</span><span class="p">);</span>
	<span class="n">ASSERT</span><span class="p">(</span><span class="n">XFS_DQ_IS_LOCKED</span><span class="p">(</span><span class="n">dqp</span><span class="p">));</span>
	<span class="n">ASSERT</span><span class="p">(</span><span class="n">dqp</span><span class="o">-&gt;</span><span class="n">q_logitem</span><span class="p">.</span><span class="n">qli_dquot</span> <span class="o">==</span> <span class="n">dqp</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Get a log_item_desc to point at the new item.</span>
<span class="cm">	 */</span>
	<span class="n">xfs_trans_add_item</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dqp</span><span class="o">-&gt;</span><span class="n">q_logitem</span><span class="p">.</span><span class="n">qli_item</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Initialize d_transp so we can later determine if this dquot is</span>
<span class="cm">	 * associated with this transaction.</span>
<span class="cm">	 */</span>
	<span class="n">dqp</span><span class="o">-&gt;</span><span class="n">q_transp</span> <span class="o">=</span> <span class="n">tp</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * This is called to mark the dquot as needing</span>
<span class="cm"> * to be logged when the transaction is committed.  The dquot must</span>
<span class="cm"> * already be associated with the given transaction.</span>
<span class="cm"> * Note that it marks the entire transaction as dirty. In the ordinary</span>
<span class="cm"> * case, this gets called via xfs_trans_commit, after the transaction</span>
<span class="cm"> * is already dirty. However, there&#39;s nothing stop this from getting</span>
<span class="cm"> * called directly, as done by xfs_qm_scall_setqlim. Hence, the TRANS_DIRTY</span>
<span class="cm"> * flag.</span>
<span class="cm"> */</span>
<span class="kt">void</span>
<span class="nf">xfs_trans_log_dquot</span><span class="p">(</span>
	<span class="n">xfs_trans_t</span>	<span class="o">*</span><span class="n">tp</span><span class="p">,</span>
	<span class="n">xfs_dquot_t</span>	<span class="o">*</span><span class="n">dqp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ASSERT</span><span class="p">(</span><span class="n">dqp</span><span class="o">-&gt;</span><span class="n">q_transp</span> <span class="o">==</span> <span class="n">tp</span><span class="p">);</span>
	<span class="n">ASSERT</span><span class="p">(</span><span class="n">XFS_DQ_IS_LOCKED</span><span class="p">(</span><span class="n">dqp</span><span class="p">));</span>

	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">t_flags</span> <span class="o">|=</span> <span class="n">XFS_TRANS_DIRTY</span><span class="p">;</span>
	<span class="n">dqp</span><span class="o">-&gt;</span><span class="n">q_logitem</span><span class="p">.</span><span class="n">qli_item</span><span class="p">.</span><span class="n">li_desc</span><span class="o">-&gt;</span><span class="n">lid_flags</span> <span class="o">|=</span> <span class="n">XFS_LID_DIRTY</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Carry forward whatever is left of the quota blk reservation to</span>
<span class="cm"> * the spanky new transaction</span>
<span class="cm"> */</span>
<span class="kt">void</span>
<span class="nf">xfs_trans_dup_dqinfo</span><span class="p">(</span>
	<span class="n">xfs_trans_t</span>	<span class="o">*</span><span class="n">otp</span><span class="p">,</span>
	<span class="n">xfs_trans_t</span>	<span class="o">*</span><span class="n">ntp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">xfs_dqtrx_t</span>	<span class="o">*</span><span class="n">oq</span><span class="p">,</span> <span class="o">*</span><span class="n">nq</span><span class="p">;</span>
	<span class="kt">int</span>		<span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">;</span>
	<span class="n">xfs_dqtrx_t</span>	<span class="o">*</span><span class="n">oqa</span><span class="p">,</span> <span class="o">*</span><span class="n">nqa</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">otp</span><span class="o">-&gt;</span><span class="n">t_dqinfo</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">xfs_trans_alloc_dqinfo</span><span class="p">(</span><span class="n">ntp</span><span class="p">);</span>
	<span class="n">oqa</span> <span class="o">=</span> <span class="n">otp</span><span class="o">-&gt;</span><span class="n">t_dqinfo</span><span class="o">-&gt;</span><span class="n">dqa_usrdquots</span><span class="p">;</span>
	<span class="n">nqa</span> <span class="o">=</span> <span class="n">ntp</span><span class="o">-&gt;</span><span class="n">t_dqinfo</span><span class="o">-&gt;</span><span class="n">dqa_usrdquots</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Because the quota blk reservation is carried forward,</span>
<span class="cm">	 * it is also necessary to carry forward the DQ_DIRTY flag.</span>
<span class="cm">	 */</span>
	<span class="k">if</span><span class="p">(</span><span class="n">otp</span><span class="o">-&gt;</span><span class="n">t_flags</span> <span class="o">&amp;</span> <span class="n">XFS_TRANS_DQ_DIRTY</span><span class="p">)</span>
		<span class="n">ntp</span><span class="o">-&gt;</span><span class="n">t_flags</span> <span class="o">|=</span> <span class="n">XFS_TRANS_DQ_DIRTY</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">XFS_QM_TRANS_MAXDQS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">oqa</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">qt_dquot</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="n">oq</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">oqa</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
			<span class="n">nq</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">nqa</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

			<span class="n">nq</span><span class="o">-&gt;</span><span class="n">qt_dquot</span> <span class="o">=</span> <span class="n">oq</span><span class="o">-&gt;</span><span class="n">qt_dquot</span><span class="p">;</span>
			<span class="n">nq</span><span class="o">-&gt;</span><span class="n">qt_bcount_delta</span> <span class="o">=</span> <span class="n">nq</span><span class="o">-&gt;</span><span class="n">qt_icount_delta</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">nq</span><span class="o">-&gt;</span><span class="n">qt_rtbcount_delta</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

			<span class="cm">/*</span>
<span class="cm">			 * Transfer whatever is left of the reservations.</span>
<span class="cm">			 */</span>
			<span class="n">nq</span><span class="o">-&gt;</span><span class="n">qt_blk_res</span> <span class="o">=</span> <span class="n">oq</span><span class="o">-&gt;</span><span class="n">qt_blk_res</span> <span class="o">-</span> <span class="n">oq</span><span class="o">-&gt;</span><span class="n">qt_blk_res_used</span><span class="p">;</span>
			<span class="n">oq</span><span class="o">-&gt;</span><span class="n">qt_blk_res</span> <span class="o">=</span> <span class="n">oq</span><span class="o">-&gt;</span><span class="n">qt_blk_res_used</span><span class="p">;</span>

			<span class="n">nq</span><span class="o">-&gt;</span><span class="n">qt_rtblk_res</span> <span class="o">=</span> <span class="n">oq</span><span class="o">-&gt;</span><span class="n">qt_rtblk_res</span> <span class="o">-</span>
				<span class="n">oq</span><span class="o">-&gt;</span><span class="n">qt_rtblk_res_used</span><span class="p">;</span>
			<span class="n">oq</span><span class="o">-&gt;</span><span class="n">qt_rtblk_res</span> <span class="o">=</span> <span class="n">oq</span><span class="o">-&gt;</span><span class="n">qt_rtblk_res_used</span><span class="p">;</span>

			<span class="n">nq</span><span class="o">-&gt;</span><span class="n">qt_ino_res</span> <span class="o">=</span> <span class="n">oq</span><span class="o">-&gt;</span><span class="n">qt_ino_res</span> <span class="o">-</span> <span class="n">oq</span><span class="o">-&gt;</span><span class="n">qt_ino_res_used</span><span class="p">;</span>
			<span class="n">oq</span><span class="o">-&gt;</span><span class="n">qt_ino_res</span> <span class="o">=</span> <span class="n">oq</span><span class="o">-&gt;</span><span class="n">qt_ino_res_used</span><span class="p">;</span>

		<span class="p">}</span>
		<span class="n">oqa</span> <span class="o">=</span> <span class="n">otp</span><span class="o">-&gt;</span><span class="n">t_dqinfo</span><span class="o">-&gt;</span><span class="n">dqa_grpdquots</span><span class="p">;</span>
		<span class="n">nqa</span> <span class="o">=</span> <span class="n">ntp</span><span class="o">-&gt;</span><span class="n">t_dqinfo</span><span class="o">-&gt;</span><span class="n">dqa_grpdquots</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Wrap around mod_dquot to account for both user and group quotas.</span>
<span class="cm"> */</span>
<span class="kt">void</span>
<span class="nf">xfs_trans_mod_dquot_byino</span><span class="p">(</span>
	<span class="n">xfs_trans_t</span>	<span class="o">*</span><span class="n">tp</span><span class="p">,</span>
	<span class="n">xfs_inode_t</span>	<span class="o">*</span><span class="n">ip</span><span class="p">,</span>
	<span class="n">uint</span>		<span class="n">field</span><span class="p">,</span>
	<span class="kt">long</span>		<span class="n">delta</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">xfs_mount_t</span>	<span class="o">*</span><span class="n">mp</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">t_mountp</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">XFS_IS_QUOTA_RUNNING</span><span class="p">(</span><span class="n">mp</span><span class="p">)</span> <span class="o">||</span>
	    <span class="o">!</span><span class="n">XFS_IS_QUOTA_ON</span><span class="p">(</span><span class="n">mp</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_ino</span> <span class="o">==</span> <span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_sb</span><span class="p">.</span><span class="n">sb_uquotino</span> <span class="o">||</span>
	    <span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_ino</span> <span class="o">==</span> <span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_sb</span><span class="p">.</span><span class="n">sb_gquotino</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">t_dqinfo</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">xfs_trans_alloc_dqinfo</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">XFS_IS_UQUOTA_ON</span><span class="p">(</span><span class="n">mp</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_udquot</span><span class="p">)</span>
		<span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">xfs_trans_mod_dquot</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_udquot</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="n">delta</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">XFS_IS_OQUOTA_ON</span><span class="p">(</span><span class="n">mp</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_gdquot</span><span class="p">)</span>
		<span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">xfs_trans_mod_dquot</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_gdquot</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="n">delta</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">STATIC</span> <span class="n">xfs_dqtrx_t</span> <span class="o">*</span>
<span class="nf">xfs_trans_get_dqtrx</span><span class="p">(</span>
	<span class="n">xfs_trans_t</span>	<span class="o">*</span><span class="n">tp</span><span class="p">,</span>
	<span class="n">xfs_dquot_t</span>	<span class="o">*</span><span class="n">dqp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span>		<span class="n">i</span><span class="p">;</span>
	<span class="n">xfs_dqtrx_t</span>	<span class="o">*</span><span class="n">qa</span><span class="p">;</span>

	<span class="n">qa</span> <span class="o">=</span> <span class="n">XFS_QM_ISUDQ</span><span class="p">(</span><span class="n">dqp</span><span class="p">)</span> <span class="o">?</span>
		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">t_dqinfo</span><span class="o">-&gt;</span><span class="n">dqa_usrdquots</span> <span class="o">:</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">t_dqinfo</span><span class="o">-&gt;</span><span class="n">dqa_grpdquots</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">XFS_QM_TRANS_MAXDQS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">qa</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">qt_dquot</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span>
		    <span class="n">qa</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">qt_dquot</span> <span class="o">==</span> <span class="n">dqp</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">&amp;</span><span class="n">qa</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Make the changes in the transaction structure.</span>
<span class="cm"> * The moral equivalent to xfs_trans_mod_sb().</span>
<span class="cm"> * We don&#39;t touch any fields in the dquot, so we don&#39;t care</span>
<span class="cm"> * if it&#39;s locked or not (most of the time it won&#39;t be).</span>
<span class="cm"> */</span>
<span class="kt">void</span>
<span class="nf">xfs_trans_mod_dquot</span><span class="p">(</span>
	<span class="n">xfs_trans_t</span>	<span class="o">*</span><span class="n">tp</span><span class="p">,</span>
	<span class="n">xfs_dquot_t</span>	<span class="o">*</span><span class="n">dqp</span><span class="p">,</span>
	<span class="n">uint</span>		<span class="n">field</span><span class="p">,</span>
	<span class="kt">long</span>		<span class="n">delta</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">xfs_dqtrx_t</span>	<span class="o">*</span><span class="n">qtrx</span><span class="p">;</span>

	<span class="n">ASSERT</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>
	<span class="n">ASSERT</span><span class="p">(</span><span class="n">XFS_IS_QUOTA_RUNNING</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">t_mountp</span><span class="p">));</span>
	<span class="n">qtrx</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">t_dqinfo</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">xfs_trans_alloc_dqinfo</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 * Find either the first free slot or the slot that belongs</span>
<span class="cm">	 * to this dquot.</span>
<span class="cm">	 */</span>
	<span class="n">qtrx</span> <span class="o">=</span> <span class="n">xfs_trans_get_dqtrx</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">dqp</span><span class="p">);</span>
	<span class="n">ASSERT</span><span class="p">(</span><span class="n">qtrx</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">qtrx</span><span class="o">-&gt;</span><span class="n">qt_dquot</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">qtrx</span><span class="o">-&gt;</span><span class="n">qt_dquot</span> <span class="o">=</span> <span class="n">dqp</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">field</span><span class="p">)</span> <span class="p">{</span>

		<span class="cm">/*</span>
<span class="cm">		 * regular disk blk reservation</span>
<span class="cm">		 */</span>
	      <span class="k">case</span> <span class="n">XFS_TRANS_DQ_RES_BLKS</span>:
		<span class="n">qtrx</span><span class="o">-&gt;</span><span class="n">qt_blk_res</span> <span class="o">+=</span> <span class="p">(</span><span class="n">ulong</span><span class="p">)</span><span class="n">delta</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * inode reservation</span>
<span class="cm">		 */</span>
	      <span class="k">case</span> <span class="n">XFS_TRANS_DQ_RES_INOS</span>:
		<span class="n">qtrx</span><span class="o">-&gt;</span><span class="n">qt_ino_res</span> <span class="o">+=</span> <span class="p">(</span><span class="n">ulong</span><span class="p">)</span><span class="n">delta</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * disk blocks used.</span>
<span class="cm">		 */</span>
	      <span class="k">case</span> <span class="n">XFS_TRANS_DQ_BCOUNT</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">qtrx</span><span class="o">-&gt;</span><span class="n">qt_blk_res</span> <span class="o">&amp;&amp;</span> <span class="n">delta</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">qtrx</span><span class="o">-&gt;</span><span class="n">qt_blk_res_used</span> <span class="o">+=</span> <span class="p">(</span><span class="n">ulong</span><span class="p">)</span><span class="n">delta</span><span class="p">;</span>
			<span class="n">ASSERT</span><span class="p">(</span><span class="n">qtrx</span><span class="o">-&gt;</span><span class="n">qt_blk_res</span> <span class="o">&gt;=</span> <span class="n">qtrx</span><span class="o">-&gt;</span><span class="n">qt_blk_res_used</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">qtrx</span><span class="o">-&gt;</span><span class="n">qt_bcount_delta</span> <span class="o">+=</span> <span class="n">delta</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	      <span class="k">case</span> <span class="n">XFS_TRANS_DQ_DELBCOUNT</span>:
		<span class="n">qtrx</span><span class="o">-&gt;</span><span class="n">qt_delbcnt_delta</span> <span class="o">+=</span> <span class="n">delta</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * Inode Count</span>
<span class="cm">		 */</span>
	      <span class="k">case</span> <span class="n">XFS_TRANS_DQ_ICOUNT</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">qtrx</span><span class="o">-&gt;</span><span class="n">qt_ino_res</span> <span class="o">&amp;&amp;</span> <span class="n">delta</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">qtrx</span><span class="o">-&gt;</span><span class="n">qt_ino_res_used</span> <span class="o">+=</span> <span class="p">(</span><span class="n">ulong</span><span class="p">)</span><span class="n">delta</span><span class="p">;</span>
			<span class="n">ASSERT</span><span class="p">(</span><span class="n">qtrx</span><span class="o">-&gt;</span><span class="n">qt_ino_res</span> <span class="o">&gt;=</span> <span class="n">qtrx</span><span class="o">-&gt;</span><span class="n">qt_ino_res_used</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">qtrx</span><span class="o">-&gt;</span><span class="n">qt_icount_delta</span> <span class="o">+=</span> <span class="n">delta</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * rtblk reservation</span>
<span class="cm">		 */</span>
	      <span class="k">case</span> <span class="n">XFS_TRANS_DQ_RES_RTBLKS</span>:
		<span class="n">qtrx</span><span class="o">-&gt;</span><span class="n">qt_rtblk_res</span> <span class="o">+=</span> <span class="p">(</span><span class="n">ulong</span><span class="p">)</span><span class="n">delta</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * rtblk count</span>
<span class="cm">		 */</span>
	      <span class="k">case</span> <span class="n">XFS_TRANS_DQ_RTBCOUNT</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">qtrx</span><span class="o">-&gt;</span><span class="n">qt_rtblk_res</span> <span class="o">&amp;&amp;</span> <span class="n">delta</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">qtrx</span><span class="o">-&gt;</span><span class="n">qt_rtblk_res_used</span> <span class="o">+=</span> <span class="p">(</span><span class="n">ulong</span><span class="p">)</span><span class="n">delta</span><span class="p">;</span>
			<span class="n">ASSERT</span><span class="p">(</span><span class="n">qtrx</span><span class="o">-&gt;</span><span class="n">qt_rtblk_res</span> <span class="o">&gt;=</span> <span class="n">qtrx</span><span class="o">-&gt;</span><span class="n">qt_rtblk_res_used</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">qtrx</span><span class="o">-&gt;</span><span class="n">qt_rtbcount_delta</span> <span class="o">+=</span> <span class="n">delta</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	      <span class="k">case</span> <span class="n">XFS_TRANS_DQ_DELRTBCOUNT</span>:
		<span class="n">qtrx</span><span class="o">-&gt;</span><span class="n">qt_delrtb_delta</span> <span class="o">+=</span> <span class="n">delta</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	      <span class="nl">default:</span>
		<span class="n">ASSERT</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">t_flags</span> <span class="o">|=</span> <span class="n">XFS_TRANS_DQ_DIRTY</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * Given an array of dqtrx structures, lock all the dquots associated</span>
<span class="cm"> * and join them to the transaction, provided they have been modified.</span>
<span class="cm"> * We know that the highest number of dquots (of one type - usr OR grp),</span>
<span class="cm"> * involved in a transaction is 2 and that both usr and grp combined - 3.</span>
<span class="cm"> * So, we don&#39;t attempt to make this very generic.</span>
<span class="cm"> */</span>
<span class="n">STATIC</span> <span class="kt">void</span>
<span class="nf">xfs_trans_dqlockedjoin</span><span class="p">(</span>
	<span class="n">xfs_trans_t</span>	<span class="o">*</span><span class="n">tp</span><span class="p">,</span>
	<span class="n">xfs_dqtrx_t</span>	<span class="o">*</span><span class="n">q</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ASSERT</span><span class="p">(</span><span class="n">q</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">qt_dquot</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">q</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">qt_dquot</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">xfs_dqlock</span><span class="p">(</span><span class="n">q</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">qt_dquot</span><span class="p">);</span>
		<span class="n">xfs_trans_dqjoin</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">q</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">qt_dquot</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ASSERT</span><span class="p">(</span><span class="n">XFS_QM_TRANS_MAXDQS</span> <span class="o">==</span> <span class="mi">2</span><span class="p">);</span>
		<span class="n">xfs_dqlock2</span><span class="p">(</span><span class="n">q</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">qt_dquot</span><span class="p">,</span> <span class="n">q</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">qt_dquot</span><span class="p">);</span>
		<span class="n">xfs_trans_dqjoin</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">q</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">qt_dquot</span><span class="p">);</span>
		<span class="n">xfs_trans_dqjoin</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">q</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">qt_dquot</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * Called by xfs_trans_commit() and similar in spirit to</span>
<span class="cm"> * xfs_trans_apply_sb_deltas().</span>
<span class="cm"> * Go thru all the dquots belonging to this transaction and modify the</span>
<span class="cm"> * INCORE dquot to reflect the actual usages.</span>
<span class="cm"> * Unreserve just the reservations done by this transaction.</span>
<span class="cm"> * dquot is still left locked at exit.</span>
<span class="cm"> */</span>
<span class="kt">void</span>
<span class="nf">xfs_trans_apply_dquot_deltas</span><span class="p">(</span>
	<span class="n">xfs_trans_t</span>		<span class="o">*</span><span class="n">tp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span>			<span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">;</span>
	<span class="n">xfs_dquot_t</span>		<span class="o">*</span><span class="n">dqp</span><span class="p">;</span>
	<span class="n">xfs_dqtrx_t</span>		<span class="o">*</span><span class="n">qtrx</span><span class="p">,</span> <span class="o">*</span><span class="n">qa</span><span class="p">;</span>
	<span class="n">xfs_disk_dquot_t</span>	<span class="o">*</span><span class="n">d</span><span class="p">;</span>
	<span class="kt">long</span>			<span class="n">totalbdelta</span><span class="p">;</span>
	<span class="kt">long</span>			<span class="n">totalrtbdelta</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">t_flags</span> <span class="o">&amp;</span> <span class="n">XFS_TRANS_DQ_DIRTY</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">ASSERT</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">t_dqinfo</span><span class="p">);</span>
	<span class="n">qa</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">t_dqinfo</span><span class="o">-&gt;</span><span class="n">dqa_usrdquots</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">qa</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">qt_dquot</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">qa</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">t_dqinfo</span><span class="o">-&gt;</span><span class="n">dqa_grpdquots</span><span class="p">;</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/*</span>
<span class="cm">		 * Lock all of the dquots and join them to the transaction.</span>
<span class="cm">		 */</span>
		<span class="n">xfs_trans_dqlockedjoin</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">qa</span><span class="p">);</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">XFS_QM_TRANS_MAXDQS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">qtrx</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">qa</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
			<span class="cm">/*</span>
<span class="cm">			 * The array of dquots is filled</span>
<span class="cm">			 * sequentially, not sparsely.</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">dqp</span> <span class="o">=</span> <span class="n">qtrx</span><span class="o">-&gt;</span><span class="n">qt_dquot</span><span class="p">)</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>

			<span class="n">ASSERT</span><span class="p">(</span><span class="n">XFS_DQ_IS_LOCKED</span><span class="p">(</span><span class="n">dqp</span><span class="p">));</span>
			<span class="n">ASSERT</span><span class="p">(</span><span class="n">dqp</span><span class="o">-&gt;</span><span class="n">q_transp</span> <span class="o">==</span> <span class="n">tp</span><span class="p">);</span>

			<span class="cm">/*</span>
<span class="cm">			 * adjust the actual number of blocks used</span>
<span class="cm">			 */</span>
			<span class="n">d</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dqp</span><span class="o">-&gt;</span><span class="n">q_core</span><span class="p">;</span>

			<span class="cm">/*</span>
<span class="cm">			 * The issue here is - sometimes we don&#39;t make a blkquota</span>
<span class="cm">			 * reservation intentionally to be fair to users</span>
<span class="cm">			 * (when the amount is small). On the other hand,</span>
<span class="cm">			 * delayed allocs do make reservations, but that&#39;s</span>
<span class="cm">			 * outside of a transaction, so we have no</span>
<span class="cm">			 * idea how much was really reserved.</span>
<span class="cm">			 * So, here we&#39;ve accumulated delayed allocation blks and</span>
<span class="cm">			 * non-delay blks. The assumption is that the</span>
<span class="cm">			 * delayed ones are always reserved (outside of a</span>
<span class="cm">			 * transaction), and the others may or may not have</span>
<span class="cm">			 * quota reservations.</span>
<span class="cm">			 */</span>
			<span class="n">totalbdelta</span> <span class="o">=</span> <span class="n">qtrx</span><span class="o">-&gt;</span><span class="n">qt_bcount_delta</span> <span class="o">+</span>
				<span class="n">qtrx</span><span class="o">-&gt;</span><span class="n">qt_delbcnt_delta</span><span class="p">;</span>
			<span class="n">totalrtbdelta</span> <span class="o">=</span> <span class="n">qtrx</span><span class="o">-&gt;</span><span class="n">qt_rtbcount_delta</span> <span class="o">+</span>
				<span class="n">qtrx</span><span class="o">-&gt;</span><span class="n">qt_delrtb_delta</span><span class="p">;</span>
<span class="cp">#ifdef DEBUG</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">totalbdelta</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">ASSERT</span><span class="p">(</span><span class="n">be64_to_cpu</span><span class="p">(</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">d_bcount</span><span class="p">)</span> <span class="o">&gt;=</span>
				       <span class="o">-</span><span class="n">totalbdelta</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">totalrtbdelta</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">ASSERT</span><span class="p">(</span><span class="n">be64_to_cpu</span><span class="p">(</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">d_rtbcount</span><span class="p">)</span> <span class="o">&gt;=</span>
				       <span class="o">-</span><span class="n">totalrtbdelta</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">qtrx</span><span class="o">-&gt;</span><span class="n">qt_icount_delta</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">ASSERT</span><span class="p">(</span><span class="n">be64_to_cpu</span><span class="p">(</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">d_icount</span><span class="p">)</span> <span class="o">&gt;=</span>
				       <span class="o">-</span><span class="n">qtrx</span><span class="o">-&gt;</span><span class="n">qt_icount_delta</span><span class="p">);</span>
<span class="cp">#endif</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">totalbdelta</span><span class="p">)</span>
				<span class="n">be64_add_cpu</span><span class="p">(</span><span class="o">&amp;</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">d_bcount</span><span class="p">,</span> <span class="p">(</span><span class="n">xfs_qcnt_t</span><span class="p">)</span><span class="n">totalbdelta</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">qtrx</span><span class="o">-&gt;</span><span class="n">qt_icount_delta</span><span class="p">)</span>
				<span class="n">be64_add_cpu</span><span class="p">(</span><span class="o">&amp;</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">d_icount</span><span class="p">,</span> <span class="p">(</span><span class="n">xfs_qcnt_t</span><span class="p">)</span><span class="n">qtrx</span><span class="o">-&gt;</span><span class="n">qt_icount_delta</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">totalrtbdelta</span><span class="p">)</span>
				<span class="n">be64_add_cpu</span><span class="p">(</span><span class="o">&amp;</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">d_rtbcount</span><span class="p">,</span> <span class="p">(</span><span class="n">xfs_qcnt_t</span><span class="p">)</span><span class="n">totalrtbdelta</span><span class="p">);</span>

			<span class="cm">/*</span>
<span class="cm">			 * Get any default limits in use.</span>
<span class="cm">			 * Start/reset the timer(s) if needed.</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">d_id</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">xfs_qm_adjust_dqlimits</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">t_mountp</span><span class="p">,</span> <span class="n">d</span><span class="p">);</span>
				<span class="n">xfs_qm_adjust_dqtimers</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">t_mountp</span><span class="p">,</span> <span class="n">d</span><span class="p">);</span>
			<span class="p">}</span>

			<span class="n">dqp</span><span class="o">-&gt;</span><span class="n">dq_flags</span> <span class="o">|=</span> <span class="n">XFS_DQ_DIRTY</span><span class="p">;</span>
			<span class="cm">/*</span>
<span class="cm">			 * add this to the list of items to get logged</span>
<span class="cm">			 */</span>
			<span class="n">xfs_trans_log_dquot</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">dqp</span><span class="p">);</span>
			<span class="cm">/*</span>
<span class="cm">			 * Take off what&#39;s left of the original reservation.</span>
<span class="cm">			 * In case of delayed allocations, there&#39;s no</span>
<span class="cm">			 * reservation that a transaction structure knows of.</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">qtrx</span><span class="o">-&gt;</span><span class="n">qt_blk_res</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">qtrx</span><span class="o">-&gt;</span><span class="n">qt_blk_res</span> <span class="o">!=</span> <span class="n">qtrx</span><span class="o">-&gt;</span><span class="n">qt_blk_res_used</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">qtrx</span><span class="o">-&gt;</span><span class="n">qt_blk_res</span> <span class="o">&gt;</span>
					    <span class="n">qtrx</span><span class="o">-&gt;</span><span class="n">qt_blk_res_used</span><span class="p">)</span>
						<span class="n">dqp</span><span class="o">-&gt;</span><span class="n">q_res_bcount</span> <span class="o">-=</span> <span class="p">(</span><span class="n">xfs_qcnt_t</span><span class="p">)</span>
							<span class="p">(</span><span class="n">qtrx</span><span class="o">-&gt;</span><span class="n">qt_blk_res</span> <span class="o">-</span>
							 <span class="n">qtrx</span><span class="o">-&gt;</span><span class="n">qt_blk_res_used</span><span class="p">);</span>
					<span class="k">else</span>
						<span class="n">dqp</span><span class="o">-&gt;</span><span class="n">q_res_bcount</span> <span class="o">-=</span> <span class="p">(</span><span class="n">xfs_qcnt_t</span><span class="p">)</span>
							<span class="p">(</span><span class="n">qtrx</span><span class="o">-&gt;</span><span class="n">qt_blk_res_used</span> <span class="o">-</span>
							 <span class="n">qtrx</span><span class="o">-&gt;</span><span class="n">qt_blk_res</span><span class="p">);</span>
				<span class="p">}</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="cm">/*</span>
<span class="cm">				 * These blks were never reserved, either inside</span>
<span class="cm">				 * a transaction or outside one (in a delayed</span>
<span class="cm">				 * allocation). Also, this isn&#39;t always a</span>
<span class="cm">				 * negative number since we sometimes</span>
<span class="cm">				 * deliberately skip quota reservations.</span>
<span class="cm">				 */</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">qtrx</span><span class="o">-&gt;</span><span class="n">qt_bcount_delta</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">dqp</span><span class="o">-&gt;</span><span class="n">q_res_bcount</span> <span class="o">+=</span>
					      <span class="p">(</span><span class="n">xfs_qcnt_t</span><span class="p">)</span><span class="n">qtrx</span><span class="o">-&gt;</span><span class="n">qt_bcount_delta</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="cm">/*</span>
<span class="cm">			 * Adjust the RT reservation.</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">qtrx</span><span class="o">-&gt;</span><span class="n">qt_rtblk_res</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">qtrx</span><span class="o">-&gt;</span><span class="n">qt_rtblk_res</span> <span class="o">!=</span> <span class="n">qtrx</span><span class="o">-&gt;</span><span class="n">qt_rtblk_res_used</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">qtrx</span><span class="o">-&gt;</span><span class="n">qt_rtblk_res</span> <span class="o">&gt;</span>
					    <span class="n">qtrx</span><span class="o">-&gt;</span><span class="n">qt_rtblk_res_used</span><span class="p">)</span>
					       <span class="n">dqp</span><span class="o">-&gt;</span><span class="n">q_res_rtbcount</span> <span class="o">-=</span> <span class="p">(</span><span class="n">xfs_qcnt_t</span><span class="p">)</span>
						       <span class="p">(</span><span class="n">qtrx</span><span class="o">-&gt;</span><span class="n">qt_rtblk_res</span> <span class="o">-</span>
							<span class="n">qtrx</span><span class="o">-&gt;</span><span class="n">qt_rtblk_res_used</span><span class="p">);</span>
					<span class="k">else</span>
					       <span class="n">dqp</span><span class="o">-&gt;</span><span class="n">q_res_rtbcount</span> <span class="o">-=</span> <span class="p">(</span><span class="n">xfs_qcnt_t</span><span class="p">)</span>
						       <span class="p">(</span><span class="n">qtrx</span><span class="o">-&gt;</span><span class="n">qt_rtblk_res_used</span> <span class="o">-</span>
							<span class="n">qtrx</span><span class="o">-&gt;</span><span class="n">qt_rtblk_res</span><span class="p">);</span>
				<span class="p">}</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">qtrx</span><span class="o">-&gt;</span><span class="n">qt_rtbcount_delta</span><span class="p">)</span>
					<span class="n">dqp</span><span class="o">-&gt;</span><span class="n">q_res_rtbcount</span> <span class="o">+=</span>
					    <span class="p">(</span><span class="n">xfs_qcnt_t</span><span class="p">)</span><span class="n">qtrx</span><span class="o">-&gt;</span><span class="n">qt_rtbcount_delta</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="cm">/*</span>
<span class="cm">			 * Adjust the inode reservation.</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">qtrx</span><span class="o">-&gt;</span><span class="n">qt_ino_res</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ASSERT</span><span class="p">(</span><span class="n">qtrx</span><span class="o">-&gt;</span><span class="n">qt_ino_res</span> <span class="o">&gt;=</span>
				       <span class="n">qtrx</span><span class="o">-&gt;</span><span class="n">qt_ino_res_used</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">qtrx</span><span class="o">-&gt;</span><span class="n">qt_ino_res</span> <span class="o">&gt;</span> <span class="n">qtrx</span><span class="o">-&gt;</span><span class="n">qt_ino_res_used</span><span class="p">)</span>
					<span class="n">dqp</span><span class="o">-&gt;</span><span class="n">q_res_icount</span> <span class="o">-=</span> <span class="p">(</span><span class="n">xfs_qcnt_t</span><span class="p">)</span>
						<span class="p">(</span><span class="n">qtrx</span><span class="o">-&gt;</span><span class="n">qt_ino_res</span> <span class="o">-</span>
						 <span class="n">qtrx</span><span class="o">-&gt;</span><span class="n">qt_ino_res_used</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">qtrx</span><span class="o">-&gt;</span><span class="n">qt_icount_delta</span><span class="p">)</span>
					<span class="n">dqp</span><span class="o">-&gt;</span><span class="n">q_res_icount</span> <span class="o">+=</span>
					    <span class="p">(</span><span class="n">xfs_qcnt_t</span><span class="p">)</span><span class="n">qtrx</span><span class="o">-&gt;</span><span class="n">qt_icount_delta</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">ASSERT</span><span class="p">(</span><span class="n">dqp</span><span class="o">-&gt;</span><span class="n">q_res_bcount</span> <span class="o">&gt;=</span>
				<span class="n">be64_to_cpu</span><span class="p">(</span><span class="n">dqp</span><span class="o">-&gt;</span><span class="n">q_core</span><span class="p">.</span><span class="n">d_bcount</span><span class="p">));</span>
			<span class="n">ASSERT</span><span class="p">(</span><span class="n">dqp</span><span class="o">-&gt;</span><span class="n">q_res_icount</span> <span class="o">&gt;=</span>
				<span class="n">be64_to_cpu</span><span class="p">(</span><span class="n">dqp</span><span class="o">-&gt;</span><span class="n">q_core</span><span class="p">.</span><span class="n">d_icount</span><span class="p">));</span>
			<span class="n">ASSERT</span><span class="p">(</span><span class="n">dqp</span><span class="o">-&gt;</span><span class="n">q_res_rtbcount</span> <span class="o">&gt;=</span>
				<span class="n">be64_to_cpu</span><span class="p">(</span><span class="n">dqp</span><span class="o">-&gt;</span><span class="n">q_core</span><span class="p">.</span><span class="n">d_rtbcount</span><span class="p">));</span>
		<span class="p">}</span>
		<span class="cm">/*</span>
<span class="cm">		 * Do the group quotas next</span>
<span class="cm">		 */</span>
		<span class="n">qa</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">t_dqinfo</span><span class="o">-&gt;</span><span class="n">dqa_grpdquots</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Release the reservations, and adjust the dquots accordingly.</span>
<span class="cm"> * This is called only when the transaction is being aborted. If by</span>
<span class="cm"> * any chance we have done dquot modifications incore (ie. deltas) already,</span>
<span class="cm"> * we simply throw those away, since that&#39;s the expected behavior</span>
<span class="cm"> * when a transaction is curtailed without a commit.</span>
<span class="cm"> */</span>
<span class="kt">void</span>
<span class="nf">xfs_trans_unreserve_and_mod_dquots</span><span class="p">(</span>
	<span class="n">xfs_trans_t</span>		<span class="o">*</span><span class="n">tp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span>			<span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">;</span>
	<span class="n">xfs_dquot_t</span>		<span class="o">*</span><span class="n">dqp</span><span class="p">;</span>
	<span class="n">xfs_dqtrx_t</span>		<span class="o">*</span><span class="n">qtrx</span><span class="p">,</span> <span class="o">*</span><span class="n">qa</span><span class="p">;</span>
	<span class="n">boolean_t</span>		<span class="n">locked</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">t_dqinfo</span> <span class="o">||</span> <span class="o">!</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">t_flags</span> <span class="o">&amp;</span> <span class="n">XFS_TRANS_DQ_DIRTY</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">qa</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">t_dqinfo</span><span class="o">-&gt;</span><span class="n">dqa_usrdquots</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">XFS_QM_TRANS_MAXDQS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">qtrx</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">qa</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
			<span class="cm">/*</span>
<span class="cm">			 * We assume that the array of dquots is filled</span>
<span class="cm">			 * sequentially, not sparsely.</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">dqp</span> <span class="o">=</span> <span class="n">qtrx</span><span class="o">-&gt;</span><span class="n">qt_dquot</span><span class="p">)</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="cm">/*</span>
<span class="cm">			 * Unreserve the original reservation. We don&#39;t care</span>
<span class="cm">			 * about the number of blocks used field, or deltas.</span>
<span class="cm">			 * Also we don&#39;t bother to zero the fields.</span>
<span class="cm">			 */</span>
			<span class="n">locked</span> <span class="o">=</span> <span class="n">B_FALSE</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">qtrx</span><span class="o">-&gt;</span><span class="n">qt_blk_res</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">xfs_dqlock</span><span class="p">(</span><span class="n">dqp</span><span class="p">);</span>
				<span class="n">locked</span> <span class="o">=</span> <span class="n">B_TRUE</span><span class="p">;</span>
				<span class="n">dqp</span><span class="o">-&gt;</span><span class="n">q_res_bcount</span> <span class="o">-=</span>
					<span class="p">(</span><span class="n">xfs_qcnt_t</span><span class="p">)</span><span class="n">qtrx</span><span class="o">-&gt;</span><span class="n">qt_blk_res</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">qtrx</span><span class="o">-&gt;</span><span class="n">qt_ino_res</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">locked</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">xfs_dqlock</span><span class="p">(</span><span class="n">dqp</span><span class="p">);</span>
					<span class="n">locked</span> <span class="o">=</span> <span class="n">B_TRUE</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="n">dqp</span><span class="o">-&gt;</span><span class="n">q_res_icount</span> <span class="o">-=</span>
					<span class="p">(</span><span class="n">xfs_qcnt_t</span><span class="p">)</span><span class="n">qtrx</span><span class="o">-&gt;</span><span class="n">qt_ino_res</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">qtrx</span><span class="o">-&gt;</span><span class="n">qt_rtblk_res</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">locked</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">xfs_dqlock</span><span class="p">(</span><span class="n">dqp</span><span class="p">);</span>
					<span class="n">locked</span> <span class="o">=</span> <span class="n">B_TRUE</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="n">dqp</span><span class="o">-&gt;</span><span class="n">q_res_rtbcount</span> <span class="o">-=</span>
					<span class="p">(</span><span class="n">xfs_qcnt_t</span><span class="p">)</span><span class="n">qtrx</span><span class="o">-&gt;</span><span class="n">qt_rtblk_res</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">locked</span><span class="p">)</span>
				<span class="n">xfs_dqunlock</span><span class="p">(</span><span class="n">dqp</span><span class="p">);</span>

		<span class="p">}</span>
		<span class="n">qa</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">t_dqinfo</span><span class="o">-&gt;</span><span class="n">dqa_grpdquots</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="n">STATIC</span> <span class="kt">void</span>
<span class="nf">xfs_quota_warn</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">xfs_mount</span>	<span class="o">*</span><span class="n">mp</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">xfs_dquot</span>	<span class="o">*</span><span class="n">dqp</span><span class="p">,</span>
	<span class="kt">int</span>			<span class="n">type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* no warnings for project quotas - we just return ENOSPC later */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dqp</span><span class="o">-&gt;</span><span class="n">dq_flags</span> <span class="o">&amp;</span> <span class="n">XFS_DQ_PROJ</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">quota_send_warning</span><span class="p">((</span><span class="n">dqp</span><span class="o">-&gt;</span><span class="n">dq_flags</span> <span class="o">&amp;</span> <span class="n">XFS_DQ_USER</span><span class="p">)</span> <span class="o">?</span> <span class="n">USRQUOTA</span> <span class="o">:</span> <span class="n">GRPQUOTA</span><span class="p">,</span>
			   <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">dqp</span><span class="o">-&gt;</span><span class="n">q_core</span><span class="p">.</span><span class="n">d_id</span><span class="p">),</span> <span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_super</span><span class="o">-&gt;</span><span class="n">s_dev</span><span class="p">,</span>
			   <span class="n">type</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * This reserves disk blocks and inodes against a dquot.</span>
<span class="cm"> * Flags indicate if the dquot is to be locked here and also</span>
<span class="cm"> * if the blk reservation is for RT or regular blocks.</span>
<span class="cm"> * Sending in XFS_QMOPT_FORCE_RES flag skips the quota check.</span>
<span class="cm"> */</span>
<span class="n">STATIC</span> <span class="kt">int</span>
<span class="nf">xfs_trans_dqresv</span><span class="p">(</span>
	<span class="n">xfs_trans_t</span>	<span class="o">*</span><span class="n">tp</span><span class="p">,</span>
	<span class="n">xfs_mount_t</span>	<span class="o">*</span><span class="n">mp</span><span class="p">,</span>
	<span class="n">xfs_dquot_t</span>	<span class="o">*</span><span class="n">dqp</span><span class="p">,</span>
	<span class="kt">long</span>		<span class="n">nblks</span><span class="p">,</span>
	<span class="kt">long</span>		<span class="n">ninos</span><span class="p">,</span>
	<span class="n">uint</span>		<span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">xfs_qcnt_t</span>	<span class="n">hardlimit</span><span class="p">;</span>
	<span class="n">xfs_qcnt_t</span>	<span class="n">softlimit</span><span class="p">;</span>
	<span class="kt">time_t</span>		<span class="n">timer</span><span class="p">;</span>
	<span class="n">xfs_qwarncnt_t</span>	<span class="n">warns</span><span class="p">;</span>
	<span class="n">xfs_qwarncnt_t</span>	<span class="n">warnlimit</span><span class="p">;</span>
	<span class="n">xfs_qcnt_t</span>	<span class="n">total_count</span><span class="p">;</span>
	<span class="n">xfs_qcnt_t</span>	<span class="o">*</span><span class="n">resbcountp</span><span class="p">;</span>
	<span class="n">xfs_quotainfo_t</span>	<span class="o">*</span><span class="n">q</span> <span class="o">=</span> <span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_quotainfo</span><span class="p">;</span>


	<span class="n">xfs_dqlock</span><span class="p">(</span><span class="n">dqp</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">XFS_TRANS_DQ_RES_BLKS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">hardlimit</span> <span class="o">=</span> <span class="n">be64_to_cpu</span><span class="p">(</span><span class="n">dqp</span><span class="o">-&gt;</span><span class="n">q_core</span><span class="p">.</span><span class="n">d_blk_hardlimit</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hardlimit</span><span class="p">)</span>
			<span class="n">hardlimit</span> <span class="o">=</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">qi_bhardlimit</span><span class="p">;</span>
		<span class="n">softlimit</span> <span class="o">=</span> <span class="n">be64_to_cpu</span><span class="p">(</span><span class="n">dqp</span><span class="o">-&gt;</span><span class="n">q_core</span><span class="p">.</span><span class="n">d_blk_softlimit</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">softlimit</span><span class="p">)</span>
			<span class="n">softlimit</span> <span class="o">=</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">qi_bsoftlimit</span><span class="p">;</span>
		<span class="n">timer</span> <span class="o">=</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">dqp</span><span class="o">-&gt;</span><span class="n">q_core</span><span class="p">.</span><span class="n">d_btimer</span><span class="p">);</span>
		<span class="n">warns</span> <span class="o">=</span> <span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">dqp</span><span class="o">-&gt;</span><span class="n">q_core</span><span class="p">.</span><span class="n">d_bwarns</span><span class="p">);</span>
		<span class="n">warnlimit</span> <span class="o">=</span> <span class="n">dqp</span><span class="o">-&gt;</span><span class="n">q_mount</span><span class="o">-&gt;</span><span class="n">m_quotainfo</span><span class="o">-&gt;</span><span class="n">qi_bwarnlimit</span><span class="p">;</span>
		<span class="n">resbcountp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dqp</span><span class="o">-&gt;</span><span class="n">q_res_bcount</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ASSERT</span><span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">XFS_TRANS_DQ_RES_RTBLKS</span><span class="p">);</span>
		<span class="n">hardlimit</span> <span class="o">=</span> <span class="n">be64_to_cpu</span><span class="p">(</span><span class="n">dqp</span><span class="o">-&gt;</span><span class="n">q_core</span><span class="p">.</span><span class="n">d_rtb_hardlimit</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hardlimit</span><span class="p">)</span>
			<span class="n">hardlimit</span> <span class="o">=</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">qi_rtbhardlimit</span><span class="p">;</span>
		<span class="n">softlimit</span> <span class="o">=</span> <span class="n">be64_to_cpu</span><span class="p">(</span><span class="n">dqp</span><span class="o">-&gt;</span><span class="n">q_core</span><span class="p">.</span><span class="n">d_rtb_softlimit</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">softlimit</span><span class="p">)</span>
			<span class="n">softlimit</span> <span class="o">=</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">qi_rtbsoftlimit</span><span class="p">;</span>
		<span class="n">timer</span> <span class="o">=</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">dqp</span><span class="o">-&gt;</span><span class="n">q_core</span><span class="p">.</span><span class="n">d_rtbtimer</span><span class="p">);</span>
		<span class="n">warns</span> <span class="o">=</span> <span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">dqp</span><span class="o">-&gt;</span><span class="n">q_core</span><span class="p">.</span><span class="n">d_rtbwarns</span><span class="p">);</span>
		<span class="n">warnlimit</span> <span class="o">=</span> <span class="n">dqp</span><span class="o">-&gt;</span><span class="n">q_mount</span><span class="o">-&gt;</span><span class="n">m_quotainfo</span><span class="o">-&gt;</span><span class="n">qi_rtbwarnlimit</span><span class="p">;</span>
		<span class="n">resbcountp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dqp</span><span class="o">-&gt;</span><span class="n">q_res_rtbcount</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">XFS_QMOPT_FORCE_RES</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
	    <span class="n">dqp</span><span class="o">-&gt;</span><span class="n">q_core</span><span class="p">.</span><span class="n">d_id</span> <span class="o">&amp;&amp;</span>
	    <span class="p">((</span><span class="n">XFS_IS_UQUOTA_ENFORCED</span><span class="p">(</span><span class="n">dqp</span><span class="o">-&gt;</span><span class="n">q_mount</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">XFS_QM_ISUDQ</span><span class="p">(</span><span class="n">dqp</span><span class="p">))</span> <span class="o">||</span>
	     <span class="p">(</span><span class="n">XFS_IS_OQUOTA_ENFORCED</span><span class="p">(</span><span class="n">dqp</span><span class="o">-&gt;</span><span class="n">q_mount</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	      <span class="p">(</span><span class="n">XFS_QM_ISPDQ</span><span class="p">(</span><span class="n">dqp</span><span class="p">)</span> <span class="o">||</span> <span class="n">XFS_QM_ISGDQ</span><span class="p">(</span><span class="n">dqp</span><span class="p">)))))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">nblks</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * dquot is locked already. See if we&#39;d go over the</span>
<span class="cm">			 * hardlimit or exceed the timelimit if we allocate</span>
<span class="cm">			 * nblks.</span>
<span class="cm">			 */</span>
			<span class="n">total_count</span> <span class="o">=</span> <span class="o">*</span><span class="n">resbcountp</span> <span class="o">+</span> <span class="n">nblks</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">hardlimit</span> <span class="o">&amp;&amp;</span> <span class="n">total_count</span> <span class="o">&gt;</span> <span class="n">hardlimit</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">xfs_quota_warn</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="n">dqp</span><span class="p">,</span> <span class="n">QUOTA_NL_BHARDWARN</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">error_return</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">softlimit</span> <span class="o">&amp;&amp;</span> <span class="n">total_count</span> <span class="o">&gt;</span> <span class="n">softlimit</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">((</span><span class="n">timer</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">get_seconds</span><span class="p">()</span> <span class="o">&gt;</span> <span class="n">timer</span><span class="p">)</span> <span class="o">||</span>
				    <span class="p">(</span><span class="n">warns</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">warns</span> <span class="o">&gt;=</span> <span class="n">warnlimit</span><span class="p">))</span> <span class="p">{</span>
					<span class="n">xfs_quota_warn</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="n">dqp</span><span class="p">,</span>
						       <span class="n">QUOTA_NL_BSOFTLONGWARN</span><span class="p">);</span>
					<span class="k">goto</span> <span class="n">error_return</span><span class="p">;</span>
				<span class="p">}</span>

				<span class="n">xfs_quota_warn</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="n">dqp</span><span class="p">,</span> <span class="n">QUOTA_NL_BSOFTWARN</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ninos</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">total_count</span> <span class="o">=</span> <span class="n">be64_to_cpu</span><span class="p">(</span><span class="n">dqp</span><span class="o">-&gt;</span><span class="n">q_core</span><span class="p">.</span><span class="n">d_icount</span><span class="p">)</span> <span class="o">+</span> <span class="n">ninos</span><span class="p">;</span>
			<span class="n">timer</span> <span class="o">=</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">dqp</span><span class="o">-&gt;</span><span class="n">q_core</span><span class="p">.</span><span class="n">d_itimer</span><span class="p">);</span>
			<span class="n">warns</span> <span class="o">=</span> <span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">dqp</span><span class="o">-&gt;</span><span class="n">q_core</span><span class="p">.</span><span class="n">d_iwarns</span><span class="p">);</span>
			<span class="n">warnlimit</span> <span class="o">=</span> <span class="n">dqp</span><span class="o">-&gt;</span><span class="n">q_mount</span><span class="o">-&gt;</span><span class="n">m_quotainfo</span><span class="o">-&gt;</span><span class="n">qi_iwarnlimit</span><span class="p">;</span>
			<span class="n">hardlimit</span> <span class="o">=</span> <span class="n">be64_to_cpu</span><span class="p">(</span><span class="n">dqp</span><span class="o">-&gt;</span><span class="n">q_core</span><span class="p">.</span><span class="n">d_ino_hardlimit</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hardlimit</span><span class="p">)</span>
				<span class="n">hardlimit</span> <span class="o">=</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">qi_ihardlimit</span><span class="p">;</span>
			<span class="n">softlimit</span> <span class="o">=</span> <span class="n">be64_to_cpu</span><span class="p">(</span><span class="n">dqp</span><span class="o">-&gt;</span><span class="n">q_core</span><span class="p">.</span><span class="n">d_ino_softlimit</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">softlimit</span><span class="p">)</span>
				<span class="n">softlimit</span> <span class="o">=</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">qi_isoftlimit</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">hardlimit</span> <span class="o">&amp;&amp;</span> <span class="n">total_count</span> <span class="o">&gt;</span> <span class="n">hardlimit</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">xfs_quota_warn</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="n">dqp</span><span class="p">,</span> <span class="n">QUOTA_NL_IHARDWARN</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">error_return</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">softlimit</span> <span class="o">&amp;&amp;</span> <span class="n">total_count</span> <span class="o">&gt;</span> <span class="n">softlimit</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span>  <span class="p">((</span><span class="n">timer</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">get_seconds</span><span class="p">()</span> <span class="o">&gt;</span> <span class="n">timer</span><span class="p">)</span> <span class="o">||</span>
				     <span class="p">(</span><span class="n">warns</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">warns</span> <span class="o">&gt;=</span> <span class="n">warnlimit</span><span class="p">))</span> <span class="p">{</span>
					<span class="n">xfs_quota_warn</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="n">dqp</span><span class="p">,</span>
						       <span class="n">QUOTA_NL_ISOFTLONGWARN</span><span class="p">);</span>
					<span class="k">goto</span> <span class="n">error_return</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="n">xfs_quota_warn</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="n">dqp</span><span class="p">,</span> <span class="n">QUOTA_NL_ISOFTWARN</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Change the reservation, but not the actual usage.</span>
<span class="cm">	 * Note that q_res_bcount = q_core.d_bcount + resv</span>
<span class="cm">	 */</span>
	<span class="p">(</span><span class="o">*</span><span class="n">resbcountp</span><span class="p">)</span> <span class="o">+=</span> <span class="p">(</span><span class="n">xfs_qcnt_t</span><span class="p">)</span><span class="n">nblks</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ninos</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">dqp</span><span class="o">-&gt;</span><span class="n">q_res_icount</span> <span class="o">+=</span> <span class="p">(</span><span class="n">xfs_qcnt_t</span><span class="p">)</span><span class="n">ninos</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * note the reservation amt in the trans struct too,</span>
<span class="cm">	 * so that the transaction knows how much was reserved by</span>
<span class="cm">	 * it against this particular dquot.</span>
<span class="cm">	 * We don&#39;t do this when we are reserving for a delayed allocation,</span>
<span class="cm">	 * because we don&#39;t have the luxury of a transaction envelope then.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tp</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ASSERT</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">t_dqinfo</span><span class="p">);</span>
		<span class="n">ASSERT</span><span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">XFS_QMOPT_RESBLK_MASK</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">nblks</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">xfs_trans_mod_dquot</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">dqp</span><span class="p">,</span>
					    <span class="n">flags</span> <span class="o">&amp;</span> <span class="n">XFS_QMOPT_RESBLK_MASK</span><span class="p">,</span>
					    <span class="n">nblks</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ninos</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">xfs_trans_mod_dquot</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">dqp</span><span class="p">,</span>
					    <span class="n">XFS_TRANS_DQ_RES_INOS</span><span class="p">,</span>
					    <span class="n">ninos</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">ASSERT</span><span class="p">(</span><span class="n">dqp</span><span class="o">-&gt;</span><span class="n">q_res_bcount</span> <span class="o">&gt;=</span> <span class="n">be64_to_cpu</span><span class="p">(</span><span class="n">dqp</span><span class="o">-&gt;</span><span class="n">q_core</span><span class="p">.</span><span class="n">d_bcount</span><span class="p">));</span>
	<span class="n">ASSERT</span><span class="p">(</span><span class="n">dqp</span><span class="o">-&gt;</span><span class="n">q_res_rtbcount</span> <span class="o">&gt;=</span> <span class="n">be64_to_cpu</span><span class="p">(</span><span class="n">dqp</span><span class="o">-&gt;</span><span class="n">q_core</span><span class="p">.</span><span class="n">d_rtbcount</span><span class="p">));</span>
	<span class="n">ASSERT</span><span class="p">(</span><span class="n">dqp</span><span class="o">-&gt;</span><span class="n">q_res_icount</span> <span class="o">&gt;=</span> <span class="n">be64_to_cpu</span><span class="p">(</span><span class="n">dqp</span><span class="o">-&gt;</span><span class="n">q_core</span><span class="p">.</span><span class="n">d_icount</span><span class="p">));</span>

	<span class="n">xfs_dqunlock</span><span class="p">(</span><span class="n">dqp</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">error_return:</span>
	<span class="n">xfs_dqunlock</span><span class="p">(</span><span class="n">dqp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">XFS_QMOPT_ENOSPC</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ENOSPC</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">EDQUOT</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * Given dquot(s), make disk block and/or inode reservations against them.</span>
<span class="cm"> * The fact that this does the reservation against both the usr and</span>
<span class="cm"> * grp/prj quotas is important, because this follows a both-or-nothing</span>
<span class="cm"> * approach.</span>
<span class="cm"> *</span>
<span class="cm"> * flags = XFS_QMOPT_FORCE_RES evades limit enforcement. Used by chown.</span>
<span class="cm"> *	   XFS_QMOPT_ENOSPC returns ENOSPC not EDQUOT.  Used by pquota.</span>
<span class="cm"> *	   XFS_TRANS_DQ_RES_BLKS reserves regular disk blocks</span>
<span class="cm"> *	   XFS_TRANS_DQ_RES_RTBLKS reserves realtime disk blocks</span>
<span class="cm"> * dquots are unlocked on return, if they were not locked by caller.</span>
<span class="cm"> */</span>
<span class="kt">int</span>
<span class="nf">xfs_trans_reserve_quota_bydquots</span><span class="p">(</span>
	<span class="n">xfs_trans_t</span>	<span class="o">*</span><span class="n">tp</span><span class="p">,</span>
	<span class="n">xfs_mount_t</span>	<span class="o">*</span><span class="n">mp</span><span class="p">,</span>
	<span class="n">xfs_dquot_t</span>	<span class="o">*</span><span class="n">udqp</span><span class="p">,</span>
	<span class="n">xfs_dquot_t</span>	<span class="o">*</span><span class="n">gdqp</span><span class="p">,</span>
	<span class="kt">long</span>		<span class="n">nblks</span><span class="p">,</span>
	<span class="kt">long</span>		<span class="n">ninos</span><span class="p">,</span>
	<span class="n">uint</span>		<span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span>		<span class="n">resvd</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">error</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">XFS_IS_QUOTA_RUNNING</span><span class="p">(</span><span class="n">mp</span><span class="p">)</span> <span class="o">||</span> <span class="o">!</span><span class="n">XFS_IS_QUOTA_ON</span><span class="p">(</span><span class="n">mp</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tp</span> <span class="o">&amp;&amp;</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">t_dqinfo</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">xfs_trans_alloc_dqinfo</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>

	<span class="n">ASSERT</span><span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">XFS_QMOPT_RESBLK_MASK</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">udqp</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">error</span> <span class="o">=</span> <span class="n">xfs_trans_dqresv</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">mp</span><span class="p">,</span> <span class="n">udqp</span><span class="p">,</span> <span class="n">nblks</span><span class="p">,</span> <span class="n">ninos</span><span class="p">,</span>
					<span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">XFS_QMOPT_ENOSPC</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
		<span class="n">resvd</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">gdqp</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">error</span> <span class="o">=</span> <span class="n">xfs_trans_dqresv</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">mp</span><span class="p">,</span> <span class="n">gdqp</span><span class="p">,</span> <span class="n">nblks</span><span class="p">,</span> <span class="n">ninos</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * can&#39;t do it, so backout previous reservation</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">resvd</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">flags</span> <span class="o">|=</span> <span class="n">XFS_QMOPT_FORCE_RES</span><span class="p">;</span>
				<span class="n">xfs_trans_dqresv</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">mp</span><span class="p">,</span> <span class="n">udqp</span><span class="p">,</span>
						 <span class="o">-</span><span class="n">nblks</span><span class="p">,</span> <span class="o">-</span><span class="n">ninos</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Didn&#39;t change anything critical, so, no need to log</span>
<span class="cm">	 */</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * Lock the dquot and change the reservation if we can.</span>
<span class="cm"> * This doesn&#39;t change the actual usage, just the reservation.</span>
<span class="cm"> * The inode sent in is locked.</span>
<span class="cm"> */</span>
<span class="kt">int</span>
<span class="nf">xfs_trans_reserve_quota_nblks</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">xfs_trans</span>	<span class="o">*</span><span class="n">tp</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">xfs_inode</span>	<span class="o">*</span><span class="n">ip</span><span class="p">,</span>
	<span class="kt">long</span>			<span class="n">nblks</span><span class="p">,</span>
	<span class="kt">long</span>			<span class="n">ninos</span><span class="p">,</span>
	<span class="n">uint</span>			<span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">xfs_mount</span>	<span class="o">*</span><span class="n">mp</span> <span class="o">=</span> <span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_mount</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">XFS_IS_QUOTA_RUNNING</span><span class="p">(</span><span class="n">mp</span><span class="p">)</span> <span class="o">||</span> <span class="o">!</span><span class="n">XFS_IS_QUOTA_ON</span><span class="p">(</span><span class="n">mp</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">XFS_IS_PQUOTA_ON</span><span class="p">(</span><span class="n">mp</span><span class="p">))</span>
		<span class="n">flags</span> <span class="o">|=</span> <span class="n">XFS_QMOPT_ENOSPC</span><span class="p">;</span>

	<span class="n">ASSERT</span><span class="p">(</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_ino</span> <span class="o">!=</span> <span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_sb</span><span class="p">.</span><span class="n">sb_uquotino</span><span class="p">);</span>
	<span class="n">ASSERT</span><span class="p">(</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_ino</span> <span class="o">!=</span> <span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_sb</span><span class="p">.</span><span class="n">sb_gquotino</span><span class="p">);</span>

	<span class="n">ASSERT</span><span class="p">(</span><span class="n">xfs_isilocked</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">XFS_ILOCK_EXCL</span><span class="p">));</span>
	<span class="n">ASSERT</span><span class="p">((</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">XFS_QMOPT_FORCE_RES</span> <span class="o">|</span> <span class="n">XFS_QMOPT_ENOSPC</span><span class="p">))</span> <span class="o">==</span>
				<span class="n">XFS_TRANS_DQ_RES_RTBLKS</span> <span class="o">||</span>
	       <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">XFS_QMOPT_FORCE_RES</span> <span class="o">|</span> <span class="n">XFS_QMOPT_ENOSPC</span><span class="p">))</span> <span class="o">==</span>
				<span class="n">XFS_TRANS_DQ_RES_BLKS</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Reserve nblks against these dquots, with trans as the mediator.</span>
<span class="cm">	 */</span>
	<span class="k">return</span> <span class="n">xfs_trans_reserve_quota_bydquots</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">mp</span><span class="p">,</span>
						<span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_udquot</span><span class="p">,</span> <span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_gdquot</span><span class="p">,</span>
						<span class="n">nblks</span><span class="p">,</span> <span class="n">ninos</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * This routine is called to allocate a quotaoff log item.</span>
<span class="cm"> */</span>
<span class="n">xfs_qoff_logitem_t</span> <span class="o">*</span>
<span class="nf">xfs_trans_get_qoff_item</span><span class="p">(</span>
	<span class="n">xfs_trans_t</span>		<span class="o">*</span><span class="n">tp</span><span class="p">,</span>
	<span class="n">xfs_qoff_logitem_t</span>	<span class="o">*</span><span class="n">startqoff</span><span class="p">,</span>
	<span class="n">uint</span>			<span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">xfs_qoff_logitem_t</span>	<span class="o">*</span><span class="n">q</span><span class="p">;</span>

	<span class="n">ASSERT</span><span class="p">(</span><span class="n">tp</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="n">q</span> <span class="o">=</span> <span class="n">xfs_qm_qoff_logitem_init</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">t_mountp</span><span class="p">,</span> <span class="n">startqoff</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">ASSERT</span><span class="p">(</span><span class="n">q</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Get a log_item_desc to point at the new item.</span>
<span class="cm">	 */</span>
	<span class="n">xfs_trans_add_item</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">qql_item</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">q</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * This is called to mark the quotaoff logitem as needing</span>
<span class="cm"> * to be logged when the transaction is committed.  The logitem must</span>
<span class="cm"> * already be associated with the given transaction.</span>
<span class="cm"> */</span>
<span class="kt">void</span>
<span class="nf">xfs_trans_log_quotaoff_item</span><span class="p">(</span>
	<span class="n">xfs_trans_t</span>		<span class="o">*</span><span class="n">tp</span><span class="p">,</span>
	<span class="n">xfs_qoff_logitem_t</span>	<span class="o">*</span><span class="n">qlp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">t_flags</span> <span class="o">|=</span> <span class="n">XFS_TRANS_DIRTY</span><span class="p">;</span>
	<span class="n">qlp</span><span class="o">-&gt;</span><span class="n">qql_item</span><span class="p">.</span><span class="n">li_desc</span><span class="o">-&gt;</span><span class="n">lid_flags</span> <span class="o">|=</span> <span class="n">XFS_LID_DIRTY</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">STATIC</span> <span class="kt">void</span>
<span class="nf">xfs_trans_alloc_dqinfo</span><span class="p">(</span>
	<span class="n">xfs_trans_t</span>	<span class="o">*</span><span class="n">tp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">t_dqinfo</span> <span class="o">=</span> <span class="n">kmem_zone_zalloc</span><span class="p">(</span><span class="n">xfs_qm_dqtrxzone</span><span class="p">,</span> <span class="n">KM_SLEEP</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">xfs_trans_free_dqinfo</span><span class="p">(</span>
	<span class="n">xfs_trans_t</span>	<span class="o">*</span><span class="n">tp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">t_dqinfo</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">kmem_zone_free</span><span class="p">(</span><span class="n">xfs_qm_dqtrxzone</span><span class="p">,</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">t_dqinfo</span><span class="p">);</span>
	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">t_dqinfo</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
