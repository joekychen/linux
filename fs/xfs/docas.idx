f | xfs_stats.h | s | 7.3K | 219 | Christoph Hellwig | hch@infradead.org | 1331741346 |  | xfs: use common code for quota statistics  Switch the quota code over to use the generic XFS statistics infrastructure. While the legacy /proc/fs/xfs/xqm and /proc/fs/xfs/xqmstats interfaces are preserved for now the statistics that still have a meaning with the current code are now also available from /proc/fs/xfs/stats.  Signed-off-by: Christoph Hellwig <hch@lst.de> Reviewed-by: Dave Chinner <dchinner@redhat.com> Signed-off-by: Ben Myers <bpm@sgi.com>
f | xfs_filestream.h | s | 2.2K | 63 | Christoph Hellwig | hch@infradead.org | 1280168211 |  | xfs: clean up filestreams helpers  Move xfs_filestream_peek_ag, xxfs_filestream_get_ag and xfs_filestream_put_ag from xfs_filestream.h to xfs_filestream.c where it's only callers are, and remove the inline marker while we're at it to let the compiler decide on the inlining.  Also don't return a value from xfs_filestream_put_ag because we don't need it.  Signed-off-by: Christoph Hellwig <hch@lst.de> Reviewed-by: Dave Chinner <dchinner@redhat.com> Signed-off-by: Dave Chinner <david@fromorbit.com>
f | xfs_buf_item.h | s | 4.1K | 116 | Christoph Hellwig | hch@infradead.org | 1292537122 |  | xfs: use struct list_head for the buf cancel table  Signed-off-by: Christoph Hellwig <hch@lst.de> Signed-off-by: Alex Elder <aelder@sgi.com>
f | uuid.h | s | 1.0K | 26 | Christoph Hellwig | hch@infradead.org | 1313184095 |  | xfs: remove subdirectories  Use the move from Linux 2.6 to Linux 3.x as an excuse to kill the annoying subdirectories in the XFS source code.  Besides the large amount of file rename the only changes are to the Makefile, a few files including headers with the subdirectory prefix, and the binary sysctl compat code that includes a header under fs/xfs/ from kernel/.  Signed-off-by: Christoph Hellwig <hch@lst.de> Signed-off-by: Alex Elder <aelder@sgi.com>
f | xfs_ioctl.c | s | 34K | 1310 | Dave Chinner | dchinner@redhat.com | 1337030460 |  | xfs: clean up xfs_bit.h includes  With the removal of xfs_rw.h and other changes over time, xfs_bit.h is being included in many files that don't actually need it. Clean up the includes as necessary.  Also move the only-used-once xfs_ialloc_find_free() static inline function out of a header file that is widely included to reduce the number of needless dependencies on xfs_bit.h.  Signed-off-by: Dave Chinner <dchinner@redhat.com> Reviewed-by: Mark Tinguely <tinguely@sgi.com> Signed-off-by: Ben Myers <bpm@sgi.com>
f | Makefile | g | 2.6K |  | Dave Chinner | dchinner@redhat.com | 1337030459 |  | xfs: move xfs_do_force_shutdown() and kill xfs_rw.c  xfs_do_force_shutdown now is the only thing in xfs_rw.c. There is no need to keep it in it's own file anymore, so move it to xfs_fsops.c next to xfs_fs_goingdown() and kill xfs_rw.c.  Signed-off-by: Dave Chinner <dchinner@redhat.com> Reviewed-by: Mark Tinguely <tinguely@sgi.com> Signed-off-by: Ben Myers <bpm@sgi.com>
f | xfs_rename.c | s | 9.2K | 316 | Dave Chinner | dchinner@redhat.com | 1337030454 |  | xfs: move xfsagino_t to xfs_types.h  Untangle the header file includes a bit by moving the definition of xfs_agino_t to xfs_types.h. This removes the dependency that xfs_ag.h has on xfs_inum.h, meaning we don't need to include xfs_inum.h everywhere we include xfs_ag.h.  Signed-off-by: Dave Chinner <dchinner@redhat.com> Reviewed-by: Mark Tinguely <tinguely@sgi.com> Signed-off-by: Ben Myers <bpm@sgi.com>
f | xfs_fs_subr.c | s | 2.3K | 88 | Christoph Hellwig | hch@infradead.org | 1326834533 |  | xfs: remove the i_size field in struct xfs_inode  There is no fundamental need to keep an in-memory inode size copy in the XFS inode.  We already have the on-disk value in the dinode, and the separate in-memory copy that we need for regular files only in the XFS inode.  Remove the xfs_inode i_size field and change the XFS_ISIZE macro to use the VFS inode i_size field for regular files.  Switch code that was directly accessing the i_size field in the xfs_inode to XFS_ISIZE, or in cases where we are limited to regular files direct access of the VFS inode i_size field.  This also allows dropping some fairly complicated code in the write path which dealt with keeping the xfs_inode i_size uptodate with the VFS i_size that is getting updated inside ->write_end.  Note that we do not bother resetting the VFS i_size when truncating a file that gets freed to zero as there is no point in doing so because the VFS inode is no longer in use at this point.  Just relax the assert in xfs_ifree to only check the on-disk size instead.  Reviewed-by: Dave Chinner <dchinner@redhat.com> Signed-off-by: Christoph Hellwig <hch@lst.de> Signed-off-by: Ben Myers <bpm@sgi.com>
f | xfs_vnodeops.c | s | 57K | 2111 | Dave Chinner | dchinner@redhat.com | 1337615143 |  | xfs: fix delalloc quota accounting on failure  xfstest 270 was causing quota reservations way beyond what was sane (ten to hundreds of TB) for a 4GB filesystem. There's a sign problem in the error handling path of xfs_bmapi_reserve_delalloc() because xfs_trans_unreserve_quota_nblks() simple negates the value passed - which doesn't work for an unsigned variable. This causes reservations of close to 2^32 block instead of removing a reservation of a handful of blocks.  Fix the same problem in the other xfs_trans_unreserve_quota_nblks() callers where unsigned integer variables are used, too.  Signed-off-by: Dave Chinner <dchinner@redhat.com> Reviewed-by: Eric Sandeen <sandeen@redhat.com> Signed-off-by: Ben Myers <bpm@sgi.com>
f | xfs_aops.h | s | 2.3K | 59 | Christoph Hellwig | hch@infradead.org | 1331674249 |  | xfs: log file size updates at I/O completion time  Do not use unlogged metadata updates and the VFS dirty bit for updating the file size after writeback.  In addition to causing various problems with updates getting delayed for far too long this also drags in the unscalable VFS dirty tracking, and is one of the few remaining unlogged metadata updates.  Reviewed-by: Dave Chinner <dchinner@redhat.com> Signed-off-by: Christoph Hellwig <hch@lst.de> Reviewed-by: Mark Tinguely <tinguely@sgi.com> Signed-off-by: Ben Myers <bpm@sgi.com>
f | xfs_bmap.h | s | 8.0K | 195 | Dave Chinner | dchinner@redhat.com | 1337030457 |  | xfs: move xfs_fsb_to_db to xfs_bmap.h  This is the only remaining useful function in xfs_rw.h, so move it to a header file responsible for block mapping functions that the callers already include. Soon we can get rid of xfs_rw.h.  Signed-off-by: Dave Chinner <dchinner@redhat.com> Reviewed-by: Mark Tinguely <tinguely@sgi.com> Signed-off-by: Ben Myers <bpm@sgi.com>
f | xfs_discard.h | s | 262B | 7 | Christoph Hellwig | hch@infradead.org | 1313184095 |  | xfs: remove subdirectories  Use the move from Linux 2.6 to Linux 3.x as an excuse to kill the annoying subdirectories in the XFS source code.  Besides the large amount of file rename the only changes are to the Makefile, a few files including headers with the subdirectory prefix, and the binary sysctl compat code that includes a header under fs/xfs/ from kernel/.  Signed-off-by: Christoph Hellwig <hch@lst.de> Signed-off-by: Alex Elder <aelder@sgi.com>
f | xfs_mount.h | s | 15K | 365 | Mark Tinguely | tinguely@sgi.com | 1340306471 |  | xfs: rename log structure to xlog  Rename the XFS log structure to xlog to help crash distinquish it from the other logs in Linux.  Signed-off-by: Mark Tinguely <tinguely@sgi.com> Reviewed-by: Christoph Hellwig <hch@lst.de> Signed-off-by: Ben Myers <bpm@sgi.com>
f | xfs_ialloc.h | s | 5.0K | 141 | Dave Chinner | dchinner@redhat.com | 1337030460 |  | xfs: clean up xfs_bit.h includes  With the removal of xfs_rw.h and other changes over time, xfs_bit.h is being included in many files that don't actually need it. Clean up the includes as necessary.  Also move the only-used-once xfs_ialloc_find_free() static inline function out of a header file that is widely included to reduce the number of needless dependencies on xfs_bit.h.  Signed-off-by: Dave Chinner <dchinner@redhat.com> Reviewed-by: Mark Tinguely <tinguely@sgi.com> Signed-off-by: Ben Myers <bpm@sgi.com>
f | xfs_vnodeops.h | s | 2.7K | 55 | Dave Chinner | dchinner@redhat.com | 1331836816 |  | xfs: remove remaining scraps of struct xfs_iomap  Signed-off-by: Dave Chinner <dchinner@redhat.com> Reviewed-by: Christoph Hellwig <hch@lst.de> Reviewed-by: Mark Tinguely <tinguely@sgi.com> Signed-off-by: Ben Myers <bpm@sgi.com>
f | xfs_mru_cache.h | s | 2.3K | 48 | Dave Chinner | david@fromorbit.com | 1263591262 |  | xfs: Kill filestreams cache flush  The filestreams cache flush is not needed in the sync code as it does not affect data writeback, and it is now not used by the growfs code, either, so kill it.  Signed-off-by: Dave Chinner <david@fromorbit.com> Reviewed-by: Christoph Hellwig <hch@lst.de> Signed-off-by: Alex Elder <aelder@sgi.com>
f | xfs_log_cil.c | s | 25K | 771 | Mark Tinguely | tinguely@sgi.com | 1340306471 |  | xfs: rename log structure to xlog  Rename the XFS log structure to xlog to help crash distinquish it from the other logs in Linux.  Signed-off-by: Mark Tinguely <tinguely@sgi.com> Reviewed-by: Christoph Hellwig <hch@lst.de> Signed-off-by: Ben Myers <bpm@sgi.com>
f | xfs_log_recover.c | s | 104K | 3497 | Mark Tinguely | tinguely@sgi.com | 1340306471 |  | xfs: rename log structure to xlog  Rename the XFS log structure to xlog to help crash distinquish it from the other logs in Linux.  Signed-off-by: Mark Tinguely <tinguely@sgi.com> Reviewed-by: Christoph Hellwig <hch@lst.de> Signed-off-by: Ben Myers <bpm@sgi.com>
f | kmem.h | s | 3.0K | 96 | Al Viro | viro@zeniv.linux.org.uk | 1338348512 |  | xfs: switch to proper __bitwise type for KM_... flags  Signed-off-by: Al Viro <viro@zeniv.linux.org.uk>
f | xfs_rtalloc.h | s | 5.2K | 144 | Chandra Seetharaman | sekharan@us.ibm.com | 1311624193 |  | xfs: Remove the macro XFS_BUF_PTR  Remove the definition and usages of the macro XFS_BUF_PTR.  Signed-off-by: Chandra Seetharaman <sekharan@us.ibm.com> Reviewed-by: Christoph Hellwig <hch@lst.de> Signed-off-by: Alex Elder <aelder@sgi.com>
f | xfs_dquot.h | s | 5.0K | 146 | Christoph Hellwig | hch@infradead.org | 1337030431 |  | xfs: on-stack delayed write buffer lists  Queue delwri buffers on a local on-stack list instead of a per-buftarg one, and write back the buffers per-process instead of by waking up xfsbufd.  This is now easily doable given that we have very few places left that write delwri buffers:   - log recovery: 	Only done at mount time, and already forcing out the buffers 	synchronously using xfs_flush_buftarg   - quotacheck: 	Same story.   - dquot reclaim: 	Writes out dirty dquots on the LRU under memory pressure.  We might 	want to look into doing more of this via xfsaild, but it's already 	more optimal than the synchronous inode reclaim that writes each 	buffer synchronously.   - xfsaild: 	This is the main beneficiary of the change.  By keeping a local list 	of buffers to write we reduce latency of writing out buffers, and 	more importably we can remove all the delwri list promotions which 	were hitting the buffer cache hard under sustained metadata loads.  The implementation is very straight forward - xfs_buf_delwri_queue now gets a new list_head pointer that it adds the delwri buffers to, and all callers need to eventually submit the list using xfs_buf_delwi_submit or xfs_buf_delwi_submit_nowait.  Buffers that already are on a delwri list are skipped in xfs_buf_delwri_queue, assuming they already are on another delwri list.  The biggest change to pass down the buffer list was done to the AIL pushing. Now that we operate on buffers the trylock, push and pushbuf log item methods are merged into a single push routine, which tries to lock the item, and if possible add the buffer that needs writeback to the buffer list. This leads to much simpler code than the previous split but requires the individual IOP_PUSH instances to unlock and reacquire the AIL around calls to blocking routines.  Given that xfsailds now also handle writing out buffers, the conditions for log forcing and the sleep times needed some small changes.  The most important one is that we consider an AIL busy as long we still have buffers to push, and the other one is that we do increment the pushed LSN for buffers that are under flushing at this moment, but still count them towards the stuck items for restart purposes.  Without this we could hammer on stuck items without ever forcing the log and not make progress under heavy random delete workloads on fast flash storage devices.  [ Dave Chinner: 	- rebase on previous patches. 	- improved comments for XBF_DELWRI_Q handling 	- fix XBF_ASYNC handling in queue submission (test 106 failure) 	- rename delwri submit function buffer list parameters for clarity 	- xfs_efd_item_push() should return XFS_ITEM_PINNED ]  Signed-off-by: Christoph Hellwig <hch@lst.de> Reviewed-by: Dave Chinner <dchinner@redhat.com> Reviewed-by: Mark Tinguely <tinguely@sgi.com> Signed-off-by: Ben Myers <bpm@sgi.com>
f | xfs_message.c | s | 2.5K | 95 | Dave Chinner | dchinner@redhat.com | 1337030454 |  | xfs: move xfsagino_t to xfs_types.h  Untangle the header file includes a bit by moving the definition of xfs_agino_t to xfs_types.h. This removes the dependency that xfs_ag.h has on xfs_inum.h, meaning we don't need to include xfs_inum.h everywhere we include xfs_ag.h.  Signed-off-by: Dave Chinner <dchinner@redhat.com> Reviewed-by: Mark Tinguely <tinguely@sgi.com> Signed-off-by: Ben Myers <bpm@sgi.com>
f | xfs_itable.h | s | 3.2K | 95 | Dave Chinner | dchinner@redhat.com | 1277343317 |  | xfs: remove block number from inode lookup code  The block number comes from bulkstat based inode lookups to shortcut the mapping calculations. We ar enot able to trust anything from bulkstat, so drop the block number as well so that the correct lookups and mappings are always done.  Signed-off-by: Dave Chinner <dchinner@redhat.com> Reviewed-by: Christoph Hellwig <hch@lst.de>
f | xfs_globals.c | s | 1.5K | 42 | Christoph Hellwig | hch@infradead.org | 1313184095 |  | xfs: remove subdirectories  Use the move from Linux 2.6 to Linux 3.x as an excuse to kill the annoying subdirectories in the XFS source code.  Besides the large amount of file rename the only changes are to the Makefile, a few files including headers with the subdirectory prefix, and the binary sysctl compat code that includes a header under fs/xfs/ from kernel/.  Signed-off-by: Christoph Hellwig <hch@lst.de> Signed-off-by: Alex Elder <aelder@sgi.com>
f | xfs_da_btree.c | s | 65K | 2281 | Dave Chinner | dchinner@redhat.com | 1337030454 |  | xfs: move xfsagino_t to xfs_types.h  Untangle the header file includes a bit by moving the definition of xfs_agino_t to xfs_types.h. This removes the dependency that xfs_ag.h has on xfs_inum.h, meaning we don't need to include xfs_inum.h everywhere we include xfs_ag.h.  Signed-off-by: Dave Chinner <dchinner@redhat.com> Reviewed-by: Mark Tinguely <tinguely@sgi.com> Signed-off-by: Ben Myers <bpm@sgi.com>
f | xfs_trans_ail.c | s | 20K | 697 | Dave Chinner | dchinner@redhat.com | 1337030454 |  | xfs: move xfsagino_t to xfs_types.h  Untangle the header file includes a bit by moving the definition of xfs_agino_t to xfs_types.h. This removes the dependency that xfs_ag.h has on xfs_inum.h, meaning we don't need to include xfs_inum.h everywhere we include xfs_ag.h.  Signed-off-by: Dave Chinner <dchinner@redhat.com> Reviewed-by: Mark Tinguely <tinguely@sgi.com> Signed-off-by: Ben Myers <bpm@sgi.com>
f | xfs_ioctl32.c | s | 17K | 596 | Dave Chinner | dchinner@redhat.com | 1337030460 |  | xfs: clean up xfs_bit.h includes  With the removal of xfs_rw.h and other changes over time, xfs_bit.h is being included in many files that don't actually need it. Clean up the includes as necessary.  Also move the only-used-once xfs_ialloc_find_free() static inline function out of a header file that is widely included to reduce the number of needless dependencies on xfs_bit.h.  Signed-off-by: Dave Chinner <dchinner@redhat.com> Reviewed-by: Mark Tinguely <tinguely@sgi.com> Signed-off-by: Ben Myers <bpm@sgi.com>
f | xfs_bit.c | s | 2.8K | 110 | David Chinner | david@fromorbit.com | 1218606072 |  | [XFS] Use the generic bitops rather than implementing them ourselves.  This keeps xfs_lowbit64 as it was since there aren't good generic helpers there ... Patch inspired by Andi Kleen.  SGI-PV: 981498  SGI-Modid: xfs-linux-melb:xfs-kern:31472a  Signed-off-by: David Chinner <david@fromorbit.com> Signed-off-by: Eric Sandeen <sandeen@sandeen.net> Signed-off-by: Donald Douwsma <donaldd@sgi.com> Signed-off-by: Lachlan McIlroy <lachlan@sgi.com>
f | xfs_fs.h | s | 19K | 456 | Eric Sandeen | sandeen@redhat.com | 1310142771 |  | xfs: consolidate & clarify mount sanity checks  Pavol pointed out that there is one silent error case in the mount path, and that others are rather uninformative.  I've taken Pavol's suggested patch and extended it a bit to also:  * fix a message which says "turned off" but actually errors out * consolidate the vaguely differentiated "SB sanity check [12]"   messages, and hexdump the superblock for analysis  Original-patch-by: Pavol Gono <Pavol.Gono@siemens.com> Signed-off-by: Eric Sandeen <sandeen@redhat.com> Signed-off-by: Alex Elder <aelder@sgi.com>
f | xfs_sysctl.h | s | 3.3K | 93 | Christoph Hellwig | hch@infradead.org | 1313184095 |  | xfs: remove subdirectories  Use the move from Linux 2.6 to Linux 3.x as an excuse to kill the annoying subdirectories in the XFS source code.  Besides the large amount of file rename the only changes are to the Makefile, a few files including headers with the subdirectory prefix, and the binary sysctl compat code that includes a header under fs/xfs/ from kernel/.  Signed-off-by: Christoph Hellwig <hch@lst.de> Signed-off-by: Alex Elder <aelder@sgi.com>
f | xfs_ioctl32.h | s | 9.0K | 208 | Christoph Hellwig | hch@infradead.org | 1313184095 |  | xfs: remove subdirectories  Use the move from Linux 2.6 to Linux 3.x as an excuse to kill the annoying subdirectories in the XFS source code.  Besides the large amount of file rename the only changes are to the Makefile, a few files including headers with the subdirectory prefix, and the binary sysctl compat code that includes a header under fs/xfs/ from kernel/.  Signed-off-by: Christoph Hellwig <hch@lst.de> Signed-off-by: Alex Elder <aelder@sgi.com>
f | xfs_iops.h | s | 1.0K | 25 | Christoph Hellwig | hch@infradead.org | 1313184095 |  | xfs: remove subdirectories  Use the move from Linux 2.6 to Linux 3.x as an excuse to kill the annoying subdirectories in the XFS source code.  Besides the large amount of file rename the only changes are to the Makefile, a few files including headers with the subdirectory prefix, and the binary sysctl compat code that includes a header under fs/xfs/ from kernel/.  Signed-off-by: Christoph Hellwig <hch@lst.de> Signed-off-by: Alex Elder <aelder@sgi.com>
f | xfs_mount.c | s | 65K | 2278 | Dave Chinner | dchinner@redhat.com | 1337030462 |  | xfs: flush outstanding buffers on log mount failure  When we fail to mount the log in xfs_mountfs(), we tear down all the infrastructure we have already allocated. However, the process of mounting the log may have progressed to the point of reading, caching and modifying buffers in memory. Hence before we can free all the infrastructure, we have to flush and remove all the buffers from memory.  Problem first reported by Eric Sandeen, later a different incarnation was reported by Ben Myers.  Signed-off-by: Dave Chinner <dchinner@redhat.com> Reviewed-by: Mark Tinguely <tinguely@sgi.com> Reviewed-by: Christoph Hellwig <hch@lst.de> Signed-off-by: Ben Myers <bpm@sgi.com>
f | xfs_inode.h | s | 19K | 540 | Dave Chinner | dchinner@redhat.com | 1337030458 |  | xfs: move xfs_get_extsz_hint() and kill xfs_rw.h  The only thing left in xfs_rw.h is a function prototype for an inode function.  Move that to xfs_inode.h, and kill xfs_rw.h.  Also move the function implementing the prototype from xfs_rw.c to xfs_inode.c so we only have one function left in xfs_rw.c  Signed-off-by: Dave Chinner <dchinner@redhat.com> Reviewed-by: Mark Tinguely <tinguely@sgi.com> Reviewed-by: Christoph Hellwig <hch@lst.de> Signed-off-by: Ben Myers <bpm@sgi.com>
f | xfs_extfree_item.c | s | 13K | 438 | Dave Chinner | dchinner@redhat.com | 1337030454 |  | xfs: move xfsagino_t to xfs_types.h  Untangle the header file includes a bit by moving the definition of xfs_agino_t to xfs_types.h. This removes the dependency that xfs_ag.h has on xfs_inum.h, meaning we don't need to include xfs_inum.h everywhere we include xfs_ag.h.  Signed-off-by: Dave Chinner <dchinner@redhat.com> Reviewed-by: Mark Tinguely <tinguely@sgi.com> Signed-off-by: Ben Myers <bpm@sgi.com>
f | xfs_bmap_btree.c | s | 20K | 736 | Dave Chinner | dchinner@redhat.com | 1337030454 |  | xfs: move xfsagino_t to xfs_types.h  Untangle the header file includes a bit by moving the definition of xfs_agino_t to xfs_types.h. This removes the dependency that xfs_ag.h has on xfs_inum.h, meaning we don't need to include xfs_inum.h everywhere we include xfs_ag.h.  Signed-off-by: Dave Chinner <dchinner@redhat.com> Reviewed-by: Mark Tinguely <tinguely@sgi.com> Signed-off-by: Ben Myers <bpm@sgi.com>
f | xfs_qm.h | s | 4.7K | 110 | Christoph Hellwig | hch@infradead.org | 1331744792 |  | xfs: remove the global xfs_Gqm structure  If we initialize the slab caches for the quota code when XFS is loaded there is no need for a global and reference counted quota manager structure.  Drop all this overhead and also fix the error handling during quota initialization.  Reviewed-by: Dave Chinner <dchinner@redhat.com> Signed-off-by: Christoph Hellwig <hch@lst.de> Signed-off-by: Ben Myers <bpm@sgi.com>
f | xfs_dir2_data.c | s | 24K | 802 | Dave Chinner | dchinner@redhat.com | 1337030454 |  | xfs: move xfsagino_t to xfs_types.h  Untangle the header file includes a bit by moving the definition of xfs_agino_t to xfs_types.h. This removes the dependency that xfs_ag.h has on xfs_inum.h, meaning we don't need to include xfs_inum.h everywhere we include xfs_ag.h.  Signed-off-by: Dave Chinner <dchinner@redhat.com> Reviewed-by: Mark Tinguely <tinguely@sgi.com> Signed-off-by: Ben Myers <bpm@sgi.com>
f | xfs_mru_cache.c | s | 17K | 499 | Tejun Heo | tj@kernel.org | 1296556963 |  | xfs: convert to alloc_workqueue()  Convert from create[_singlethread]_workqueue() to alloc_workqueue().  * xfsdatad_workqueue and xfsconvertd_workqueue are identity converted.   Using higher concurrency limit might be useful but given the   complexity of workqueue usage in xfs, proceeding cautiously seems   better.  * xfs_mru_reap_wq is converted to non-ordered workqueue with max   concurrency of 1 as the work items don't require any specific   ordering and already have proper synchronization.  It seems it was   singlethreaded to save worker threads, which is no longer a concern.  Signed-off-by: Tejun Heo <tj@kernel.org> Cc: Alex Elder <aelder@sgi.com> Cc: xfs-masters@oss.sgi.com Cc: Christoph Hellwig <hch@infradead.org>
f | xfs_xattr.c | s | 5.6K | 209 | Christoph Hellwig | hch@infradead.org | 1313184095 |  | xfs: remove subdirectories  Use the move from Linux 2.6 to Linux 3.x as an excuse to kill the annoying subdirectories in the XFS source code.  Besides the large amount of file rename the only changes are to the Makefile, a few files including headers with the subdirectory prefix, and the binary sysctl compat code that includes a header under fs/xfs/ from kernel/.  Signed-off-by: Christoph Hellwig <hch@lst.de> Signed-off-by: Alex Elder <aelder@sgi.com>
f | xfs_inode.c | s | 106K | 3437 | Dave Chinner | dchinner@redhat.com | 1337030463 |  | xfs: make XBF_MAPPED the default behaviour  Rather than specifying XBF_MAPPED for almost all buffers, introduce XBF_UNMAPPED for the couple of users that use unmapped buffers.  Signed-off-by: Dave Chinner <dchinner@redhat.com> Reviewed-by: Mark Tinguely <tinguely@sgi.com> Reviewed-by: Christoph Hellwig <hch@lst.de> Signed-off-by: Ben Myers <bpm@sgi.com>
f | xfs_trace.c | s | 1.6K | 53 | Dave Chinner | dchinner@redhat.com | 1337030460 |  | xfs: clean up xfs_bit.h includes  With the removal of xfs_rw.h and other changes over time, xfs_bit.h is being included in many files that don't actually need it. Clean up the includes as necessary.  Also move the only-used-once xfs_ialloc_find_free() static inline function out of a header file that is widely included to reduce the number of needless dependencies on xfs_bit.h.  Signed-off-by: Dave Chinner <dchinner@redhat.com> Reviewed-by: Mark Tinguely <tinguely@sgi.com> Signed-off-by: Ben Myers <bpm@sgi.com>
f | xfs_quotaops.c | s | 3.0K | 122 | Dave Chinner | dchinner@redhat.com | 1337030454 |  | xfs: move xfsagino_t to xfs_types.h  Untangle the header file includes a bit by moving the definition of xfs_agino_t to xfs_types.h. This removes the dependency that xfs_ag.h has on xfs_inum.h, meaning we don't need to include xfs_inum.h everywhere we include xfs_ag.h.  Signed-off-by: Dave Chinner <dchinner@redhat.com> Reviewed-by: Mark Tinguely <tinguely@sgi.com> Signed-off-by: Ben Myers <bpm@sgi.com>
f | xfs_alloc_btree.h | s | 3.5K | 96 | Christoph Hellwig | hch@infradead.org | 1225347274 |  | [XFS] Always use struct xfs_btree_block instead of short / longform structures.  Always use the generic xfs_btree_block type instead of the short / long structures. Add XFS_BTREE_SBLOCK_LEN / XFS_BTREE_LBLOCK_LEN defines for the length of a short / long form block. The rationale for this is that we will grow more btree block header variants to support CRCs and other RAS information, and always accessing them through the same datatype with unions for the short / long form pointers makes implementing this much easier.  SGI-PV: 988146  SGI-Modid: xfs-linux-melb:xfs-kern:32300a  Signed-off-by: Christoph Hellwig <hch@infradead.org> Signed-off-by: Donald Douwsma <donaldd@sgi.com> Signed-off-by: David Chinner <david@fromorbit.com> Signed-off-by: Lachlan McIlroy <lachlan@sgi.com>
f | xfs_dquot_item.c | s | 11K | 408 | Dave Chinner | dchinner@redhat.com | 1337030460 |  | xfs: clean up xfs_bit.h includes  With the removal of xfs_rw.h and other changes over time, xfs_bit.h is being included in many files that don't actually need it. Clean up the includes as necessary.  Also move the only-used-once xfs_ialloc_find_free() static inline function out of a header file that is widely included to reduce the number of needless dependencies on xfs_bit.h.  Signed-off-by: Dave Chinner <dchinner@redhat.com> Reviewed-by: Mark Tinguely <tinguely@sgi.com> Signed-off-by: Ben Myers <bpm@sgi.com>
f | xfs_dir2_format.h | s | 16K | 533 | Christoph Hellwig | hch@lst.de | 1310557428 |  | xfs: cleanup struct xfs_dir2_free  Change the bests array to be a proper variable sized entry.  This is done easily as no one relies on the size of the structure.  Also change XFS_DIR2_MAX_FREE_BESTS to an inline function while we're at it.  Signed-off-by: Christoph Hellwig <hch@lst.de> Reviewed-by: Alex Elder <aelder@sgi.com> Reviewed-by: Dave Chinner <dchinner@redhat.com>
f | xfs_bmap_btree.h | s | 7.1K | 202 | Eric Sandeen | sandeen@sandeen.net | 1263591098 |  | xfs: make several more functions static  Just minor housekeeping, a lot more functions can be trivially made static; others could if we reordered things a bit...  Signed-off-by: Eric Sandeen <sandeen@sandeen.net> Signed-off-by: Alex Elder <aelder@sgi.com>
f | uuid.c | s | 1.6K | 57 | Christoph Hellwig | hch@infradead.org | 1313184095 |  | xfs: remove subdirectories  Use the move from Linux 2.6 to Linux 3.x as an excuse to kill the annoying subdirectories in the XFS source code.  Besides the large amount of file rename the only changes are to the Makefile, a few files including headers with the subdirectory prefix, and the binary sysctl compat code that includes a header under fs/xfs/ from kernel/.  Signed-off-by: Christoph Hellwig <hch@lst.de> Signed-off-by: Alex Elder <aelder@sgi.com>
f | xfs_iomap.c | s | 19K | 671 | Dave Chinner | dchinner@redhat.com | 1337615143 |  | xfs: fix delalloc quota accounting on failure  xfstest 270 was causing quota reservations way beyond what was sane (ten to hundreds of TB) for a 4GB filesystem. There's a sign problem in the error handling path of xfs_bmapi_reserve_delalloc() because xfs_trans_unreserve_quota_nblks() simple negates the value passed - which doesn't work for an unsigned variable. This causes reservations of close to 2^32 block instead of removing a reservation of a handful of blocks.  Fix the same problem in the other xfs_trans_unreserve_quota_nblks() callers where unsigned integer variables are used, too.  Signed-off-by: Dave Chinner <dchinner@redhat.com> Reviewed-by: Eric Sandeen <sandeen@redhat.com> Signed-off-by: Ben Myers <bpm@sgi.com>
f | xfs_dquot.c | s | 25K | 905 | Dave Chinner | dchinner@redhat.com | 1337030454 |  | xfs: move xfsagino_t to xfs_types.h  Untangle the header file includes a bit by moving the definition of xfs_agino_t to xfs_types.h. This removes the dependency that xfs_ag.h has on xfs_inum.h, meaning we don't need to include xfs_inum.h everywhere we include xfs_ag.h.  Signed-off-by: Dave Chinner <dchinner@redhat.com> Reviewed-by: Mark Tinguely <tinguely@sgi.com> Signed-off-by: Ben Myers <bpm@sgi.com>
f | xfs_inode_item.h | s | 6.1K | 152 | Dave Chinner | dchinner@redhat.com | 1337030433 |  | xfs: pass shutdown method into xfs_trans_ail_delete_bulk  xfs_trans_ail_delete_bulk() can be called from different contexts so if the item is not in the AIL we need different shutdown for each context.  Pass in the shutdown method needed so the correct action can be taken.  Signed-off-by: Dave Chinner <dchinner@redhat.com> Reviewed-by: Christoph Hellwig <hch@lst.de> Reviewed-by: Mark Tinguely <tinguely@sgi.com> Signed-off-by: Ben Myers <bpm@sgi.com>
f | xfs_dir2_node.c | s | 57K | 1925 | Dave Chinner | dchinner@redhat.com | 1337030454 |  | xfs: move xfsagino_t to xfs_types.h  Untangle the header file includes a bit by moving the definition of xfs_agino_t to xfs_types.h. This removes the dependency that xfs_ag.h has on xfs_inum.h, meaning we don't need to include xfs_inum.h everywhere we include xfs_ag.h.  Signed-off-by: Dave Chinner <dchinner@redhat.com> Reviewed-by: Mark Tinguely <tinguely@sgi.com> Signed-off-by: Ben Myers <bpm@sgi.com>
f | xfs_fsops.c | s | 20K | 699 | Dave Chinner | dchinner@redhat.com | 1337030463 |  | xfs: make XBF_MAPPED the default behaviour  Rather than specifying XBF_MAPPED for almost all buffers, introduce XBF_UNMAPPED for the couple of users that use unmapped buffers.  Signed-off-by: Dave Chinner <dchinner@redhat.com> Reviewed-by: Mark Tinguely <tinguely@sgi.com> Reviewed-by: Christoph Hellwig <hch@lst.de> Signed-off-by: Ben Myers <bpm@sgi.com>
f | xfs_trans_priv.h | s | 4.5K | 138 | Dave Chinner | dchinner@redhat.com | 1337030433 |  | xfs: pass shutdown method into xfs_trans_ail_delete_bulk  xfs_trans_ail_delete_bulk() can be called from different contexts so if the item is not in the AIL we need different shutdown for each context.  Pass in the shutdown method needed so the correct action can be taken.  Signed-off-by: Dave Chinner <dchinner@redhat.com> Reviewed-by: Christoph Hellwig <hch@lst.de> Reviewed-by: Mark Tinguely <tinguely@sgi.com> Signed-off-by: Ben Myers <bpm@sgi.com>
f | xfs_buf_item.c | s | 27K | 905 | Dave Chinner | dchinner@redhat.com | 1337030454 |  | xfs: move xfsagino_t to xfs_types.h  Untangle the header file includes a bit by moving the definition of xfs_agino_t to xfs_types.h. This removes the dependency that xfs_ag.h has on xfs_inum.h, meaning we don't need to include xfs_inum.h everywhere we include xfs_ag.h.  Signed-off-by: Dave Chinner <dchinner@redhat.com> Reviewed-by: Mark Tinguely <tinguely@sgi.com> Signed-off-by: Ben Myers <bpm@sgi.com>
f | xfs_utils.h | s | 1.1K | 25 | Al Viro | viro@zeniv.linux.org.uk | 1325649300 |  | xfs: propagate umode_t  Signed-off-by: Al Viro <viro@zeniv.linux.org.uk>
f | xfs_buf.h | s | 9.1K | 224 | Dave Chinner | dchinner@redhat.com | 1337030463 |  | xfs: make XBF_MAPPED the default behaviour  Rather than specifying XBF_MAPPED for almost all buffers, introduce XBF_UNMAPPED for the couple of users that use unmapped buffers.  Signed-off-by: Dave Chinner <dchinner@redhat.com> Reviewed-by: Mark Tinguely <tinguely@sgi.com> Reviewed-by: Christoph Hellwig <hch@lst.de> Signed-off-by: Ben Myers <bpm@sgi.com>
f | xfs_log.h | s | 5.4K | 160 | Christoph Hellwig | hch@infradead.org | 1337030426 |  | xfs: allow assigning the tail lsn with the AIL lock held  Provide a variant of xlog_assign_tail_lsn that has the AIL lock already held.  By doing so we do an additional atomic_read + atomic_set under the lock, which comes down to two instructions.  Switch xfs_trans_ail_update_bulk and xfs_trans_ail_delete_bulk to the new version to reduce the number of lock roundtrips, and prepare for a new addition that would require a third lock roundtrip in xfs_trans_ail_delete_bulk.  This addition is also the reason for slightly rearranging the conditionals and relying on xfs_log_space_wake for checking that the filesystem has been shut down internally.  Signed-off-by: Christoph Hellwig <hch@lst.de> Reviewed-by: Dave Chinner <dchinner@redhat.com> Reviewed-by: Mark Tinguely <tinguely@sgi.com> Signed-off-by: Ben Myers <bpm@sgi.com>
f | xfs_sync.h | s | 1.8K | 41 | Christoph Hellwig | hch@infradead.org | 1331676075 |  | xfs: log timestamp updates  Timestamps on regular files are the last metadata that XFS does not update transactionally.  Now that we use the delaylog mode exclusively and made the log scode scale extremly well there is no need to bypass that code for timestamp updates.  Logging all updates allows to drop a lot of code, and will allow for further performance improvements later on.  Note that this patch drops optimized handling of fdatasync - it will be added back in a separate commit.  Reviewed-by: Dave Chinner <dchinner@redhat.com> Signed-off-by: Christoph Hellwig <hch@lst.de> Reviewed-by: Mark Tinguely <tinguely@sgi.com> Signed-off-by: Ben Myers <bpm@sgi.com>
f | kmem.c | s | 2.8K | 119 | Al Viro | viro@zeniv.linux.org.uk | 1338348512 |  | xfs: switch to proper __bitwise type for KM_... flags  Signed-off-by: Al Viro <viro@zeniv.linux.org.uk>
f | xfs_extent_busy.c | s | 15K | 558 | Ben Myers | bpm@sgi.com | 1337030464 |  | xfs: make xfs_extent_busy_trim not static  Commit e459df5, 'xfs: move busy extent handling to it's own file' moved some code from xfs_alloc.c into xfs_extent_busy.c for convenience in userspace code merges.  One of the functions moved is xfs_extent_busy_trim (formerly xfs_alloc_busy_trim) which is defined STATIC.  Unfortunately this function is still used in xfs_alloc.c, and this results in an undefined symbol in xfs.ko.  Make xfs_extent_busy_trim not static and add its prototype to xfs_extent_busy.h.  Signed-off-by: Ben Myers <bpm@sgi.com> Reviewed-by: Mark Tinguely <tinguely@sgi.com>
f | xfs_utils.c | s | 8.1K | 290 | Dave Chinner | dchinner@redhat.com | 1337030460 |  | xfs: clean up xfs_bit.h includes  With the removal of xfs_rw.h and other changes over time, xfs_bit.h is being included in many files that don't actually need it. Clean up the includes as necessary.  Also move the only-used-once xfs_ialloc_find_free() static inline function out of a header file that is widely included to reduce the number of needless dependencies on xfs_bit.h.  Signed-off-by: Dave Chinner <dchinner@redhat.com> Reviewed-by: Mark Tinguely <tinguely@sgi.com> Signed-off-by: Ben Myers <bpm@sgi.com>
f | xfs_attr_sf.h | s | 2.8K | 65 | Dave Chinner | david@fromorbit.com | 1263944868 |  | xfs: convert attr to use unsigned names  To be consistent with the directory code, the attr code should use unsigned names. Convert the names from the vfs at the highest level to unsigned, and Ã¦nsure they are consistenly used as unsigned down to disk.  Signed-off-by: Dave Chinner <david@fromorbit.com> Reviewed-by: Christoph Hellwig <hch@lst.de>
f | xfs_dir2.h | s | 2.1K | 55 | Christoph Hellwig | hch@lst.de | 1310557428 |  | xfs: reshuffle dir2 headers  Replace the current mess of dir2 headers with just three that have a clear purpose:   - xfs_dir2_format.h for all format definitions, including the inline helpers    to access our variable size structures  - xfs_dir2_priv.h for all prototypes that are internal to the dir2 code    and not needed by anything outside of the directory code.  For this    purpose xfs_da_btree.c, and phase6.c in xfs_repair are considered part    of the directory code.  - xfs_dir2.h for the public interface to the directory code  In addition to the reshuffle I have also update the comments to not only match the new file structure, but also to describe the directory format better.  Signed-off-by: Christoph Hellwig <hch@lst.de> Reviewed-by: Alex Elder <aelder@sgi.com> Reviewed-by: Dave Chinner <dchinner@redhat.com>
f | xfs_discard.c | s | 6.4K | 210 | Dave Chinner | dchinner@redhat.com | 1337030456 |  | xfs: clean up busy extent naming  Now that the busy extent tracking has been moved out of the allocation files, clean up the namespace it uses to "xfs_extent_busy" rather than a mix of "xfs_busy" and "xfs_alloc_busy".  Signed-off-by: Dave Chinner<dchinner@redhat.com> Reviewed-by: Christoph Hellwig <hch@lst.de> Reviewed-by: Mark Tinguely <tinguely@sgi.com> Signed-off-by: Ben Myers <bpm@sgi.com>
f | xfs_sb.h | s | 18K | 488 | Amit Sahrawat | amit.sahrawat83@gmail.com | 1328224084 |  | xfs: kill the unused XFS_BB_FSB_OFFSET macro  Removing the macro, as this is no more needed in the code. Tried to find the reference when it was last used - but the usage for this seemed to have been dropped long time ago.  Signed-off-by: Amit Sahrawat <amit.sahrawat83@gmail.com> Reviewed-by: Christoph Hellwig <hch@lst.de> Signed-off-by: Ben Myers <bpm@sgi.com>
f | xfs_dir2.c | s | 15K | 603 | Dave Chinner | dchinner@redhat.com | 1337030460 |  | xfs: clean up xfs_bit.h includes  With the removal of xfs_rw.h and other changes over time, xfs_bit.h is being included in many files that don't actually need it. Clean up the includes as necessary.  Also move the only-used-once xfs_ialloc_find_free() static inline function out of a header file that is widely included to reduce the number of needless dependencies on xfs_bit.h.  Signed-off-by: Dave Chinner <dchinner@redhat.com> Reviewed-by: Mark Tinguely <tinguely@sgi.com> Signed-off-by: Ben Myers <bpm@sgi.com>
f | xfs_message.h | s | 1.1K | 31 | Joe Perches | joe@perches.com | 1320107454 |  | treewide: use __printf not __attribute__((format(printf,...)))  Standardize the style for compiler based printf format verification. Standardized the location of __printf too.  Done via script and a little typing.  $ grep -rPl --include=*.[ch] -w "__attribute__" * || \   grep -vP "^(tools||scripts||include/linux/compiler-gcc.h)" || \   xargs perl -n -i -e 'local $/; while (<>) { s/\b__attribute__\s*\(\s*\(\s*format\s*\(\s*printf\s*,\s*(.+)\s*,\s*(.+)\s*\)\s*\)\s*\)/__printf($1, $2)/g ; print; }'  [akpm@linux-foundation.org: revert arch bits] Signed-off-by: Joe Perches <joe@perches.com> Cc: "Kirill A. Shutemov" <kirill@shutemov.name> Signed-off-by: Andrew Morton <akpm@linux-foundation.org> Signed-off-by: Linus Torvalds <torvalds@linux-foundation.org>
f | xfs_dir2_sf.c | s | 37K | 1254 | Dave Chinner | dchinner@redhat.com | 1337030454 |  | xfs: move xfsagino_t to xfs_types.h  Untangle the header file includes a bit by moving the definition of xfs_agino_t to xfs_types.h. This removes the dependency that xfs_ag.h has on xfs_inum.h, meaning we don't need to include xfs_inum.h everywhere we include xfs_ag.h.  Signed-off-by: Dave Chinner <dchinner@redhat.com> Reviewed-by: Mark Tinguely <tinguely@sgi.com> Signed-off-by: Ben Myers <bpm@sgi.com>
f | xfs_btree.h | s | 13K | 399 | Chandra Seetharaman | sekharan@us.ibm.com | 1311624193 |  | xfs: Remove the macro XFS_BUF_PTR  Remove the definition and usages of the macro XFS_BUF_PTR.  Signed-off-by: Chandra Seetharaman <sekharan@us.ibm.com> Reviewed-by: Christoph Hellwig <hch@lst.de> Signed-off-by: Alex Elder <aelder@sgi.com>
f | xfs_log_recover.h | s | 2.0K | 56 | Dave Chinner | dchinner@redhat.com | 1274715219 |  | xfs: Clean up XFS_BLI_* flag namespace  Clean up the buffer log format (XFS_BLI_*) flags because they have a polluted namespace. They XFS_BLI_ prefix is used for both in-memory and on-disk flag feilds, but have overlapping values for different flags. Rename the buffer log format flags to use the XFS_BLF_* prefix to avoid confusing them with the in-memory XFS_BLI_* prefixed flags.  Signed-off-by: Dave Chinner <dchinner@redhat.com> Reviewed-by: Christoph Hellwig <hch@lst.de> Signed-off-by: Alex Elder <aelder@sgi.com>
f | xfs_trans_space.h | s | 3.4K | 83 | Christoph Hellwig | hch@lst.de | 1234165034 |  | xfs: remove superflous inobt macros  xfs_ialloc_btree.h has a a cuple of macros that only obsfucate the code but don't provide any abstraction benefits.  This patches removes those and cleans up the reamaining defintions up a little.  Signed-off-by: Christoph Hellwig <hch@lst.de> Reviewed-by: Dave Chinner <david@fromorbit.com>
f | xfs_trans.c | s | 44K | 1430 | Al Viro | viro@zeniv.linux.org.uk | 1338348512 |  | xfs: switch to proper __bitwise type for KM_... flags  Signed-off-by: Al Viro <viro@zeniv.linux.org.uk>
f | xfs_btree.c | s | 93K | 3210 | Dave Chinner | dchinner@redhat.com | 1337030454 |  | xfs: move xfsagino_t to xfs_types.h  Untangle the header file includes a bit by moving the definition of xfs_agino_t to xfs_types.h. This removes the dependency that xfs_ag.h has on xfs_inum.h, meaning we don't need to include xfs_inum.h everywhere we include xfs_ag.h.  Signed-off-by: Dave Chinner <dchinner@redhat.com> Reviewed-by: Mark Tinguely <tinguely@sgi.com> Signed-off-by: Ben Myers <bpm@sgi.com>
f | xfs_linux.h | s | 7.5K | 269 | Christoph Hellwig | hch@infradead.org | 1318348969 |  | xfs: revert to using a kthread for AIL pushing  Currently we have a few issues with the way the workqueue code is used to implement AIL pushing:   - it accidentally uses the same workqueue as the syncer action, and thus    can be prevented from running if there are enough sync actions active    in the system.  - it doesn't use the HIGHPRI flag to queue at the head of the queue of    work items  At this point I'm not confident enough in getting all the workqueue flags and tweaks right to provide a perfectly reliable execution context for AIL pushing, which is the most important piece in XFS to make forward progress when the log fills.  Revert back to use a kthread per filesystem which fixes all the above issues at the cost of having a task struct and stack around for each mounted filesystem.  In addition this also gives us much better ways to diagnose any issues involving hung AIL pushing and removes a small amount of code.  Signed-off-by: Christoph Hellwig <hch@lst.de> Reported-by: Stefan Priebe <s.priebe@profihost.ag> Tested-by: Stefan Priebe <s.priebe@profihost.ag> Reviewed-by: Dave Chinner <dchinner@redhat.com> Signed-off-by: Alex Elder <aelder@sgi.com>
f | xfs_attr_leaf.h | s | 10K | 237 | Eric Sandeen | sandeen@sandeen.net | 1231476404 |  | [XFS] Remove macro-to-function indirections in attr code  Signed-off-by: Eric Sandeen <sandeen@sandeen.net> Reviewed-by: Christoph Hellwig <hch@infradead.org> Signed-off-by: Lachlan McIlroy <lachlan@sgi.com>
f | xfs_alloc_btree.c | s | 9.4K | 334 | Dave Chinner | dchinner@redhat.com | 1337030460 |  | xfs: clean up xfs_bit.h includes  With the removal of xfs_rw.h and other changes over time, xfs_bit.h is being included in many files that don't actually need it. Clean up the includes as necessary.  Also move the only-used-once xfs_ialloc_find_free() static inline function out of a header file that is widely included to reduce the number of needless dependencies on xfs_bit.h.  Signed-off-by: Dave Chinner <dchinner@redhat.com> Reviewed-by: Mark Tinguely <tinguely@sgi.com> Signed-off-by: Ben Myers <bpm@sgi.com>
f | xfs_rtalloc.c | s | 60K | 2236 | Dave Chinner | dchinner@redhat.com | 1337030458 |  | xfs: move xfs_get_extsz_hint() and kill xfs_rw.h  The only thing left in xfs_rw.h is a function prototype for an inode function.  Move that to xfs_inode.h, and kill xfs_rw.h.  Also move the function implementing the prototype from xfs_rw.c to xfs_inode.c so we only have one function left in xfs_rw.c  Signed-off-by: Dave Chinner <dchinner@redhat.com> Reviewed-by: Mark Tinguely <tinguely@sgi.com> Reviewed-by: Christoph Hellwig <hch@lst.de> Signed-off-by: Ben Myers <bpm@sgi.com>
f | xfs_quota_priv.h | s | 1.5K | 38 | Christoph Hellwig | hch@infradead.org | 1331741346 |  | xfs: use per-filesystem radix trees for dquot lookup  Replace the global hash tables for looking up in-memory dquot structures with per-filesystem radix trees to allow scaling to a large number of in-memory dquot structures.  Reviewed-by: Dave Chinner <dchinner@redhat.com> Signed-off-by: Christoph Hellwig <hch@lst.de> Signed-off-by: Ben Myers <bpm@sgi.com>
f | xfs_dir2_priv.h | s | 6.3K | 128 | Christoph Hellwig | hch@lst.de | 1310557428 |  | xfs: reshuffle dir2 headers  Replace the current mess of dir2 headers with just three that have a clear purpose:   - xfs_dir2_format.h for all format definitions, including the inline helpers    to access our variable size structures  - xfs_dir2_priv.h for all prototypes that are internal to the dir2 code    and not needed by anything outside of the directory code.  For this    purpose xfs_da_btree.c, and phase6.c in xfs_repair are considered part    of the directory code.  - xfs_dir2.h for the public interface to the directory code  In addition to the reshuffle I have also update the comments to not only match the new file structure, but also to describe the directory format better.  Signed-off-by: Christoph Hellwig <hch@lst.de> Reviewed-by: Alex Elder <aelder@sgi.com> Reviewed-by: Dave Chinner <dchinner@redhat.com>
f | xfs_attr_leaf.c | s | 84K | 2740 | Dave Chinner | dchinner@redhat.com | 1337030454 |  | xfs: move xfsagino_t to xfs_types.h  Untangle the header file includes a bit by moving the definition of xfs_agino_t to xfs_types.h. This removes the dependency that xfs_ag.h has on xfs_inum.h, meaning we don't need to include xfs_inum.h everywhere we include xfs_ag.h.  Signed-off-by: Dave Chinner <dchinner@redhat.com> Reviewed-by: Mark Tinguely <tinguely@sgi.com> Signed-off-by: Ben Myers <bpm@sgi.com>
f | xfs_dir2_block.c | s | 34K | 1177 | Dave Chinner | dchinner@redhat.com | 1337030454 |  | xfs: move xfsagino_t to xfs_types.h  Untangle the header file includes a bit by moving the definition of xfs_agino_t to xfs_types.h. This removes the dependency that xfs_ag.h has on xfs_inum.h, meaning we don't need to include xfs_inum.h everywhere we include xfs_ag.h.  Signed-off-by: Dave Chinner <dchinner@redhat.com> Reviewed-by: Mark Tinguely <tinguely@sgi.com> Signed-off-by: Ben Myers <bpm@sgi.com>
f | xfs_inum.h | s | 2.3K | 59 | Dave Chinner | dchinner@redhat.com | 1337030454 |  | xfs: move xfsagino_t to xfs_types.h  Untangle the header file includes a bit by moving the definition of xfs_agino_t to xfs_types.h. This removes the dependency that xfs_ag.h has on xfs_inum.h, meaning we don't need to include xfs_inum.h everywhere we include xfs_ag.h.  Signed-off-by: Dave Chinner <dchinner@redhat.com> Reviewed-by: Mark Tinguely <tinguely@sgi.com> Signed-off-by: Ben Myers <bpm@sgi.com>
f | xfs_iomap.h | s | 1.2K | 29 | Christoph Hellwig | hch@infradead.org | 1292537151 |  | xfs: kill xfs_iomap  Opencode the xfs_iomap code in it's two callers.  The overlap of passed flags already was minimal and will be further reduced in the next patch.  As a side effect the BMAPI_* flags for xfs_bmapi and the IO_* flags for I/O end processing are merged into a single set of flags, which should be a bit more descriptive of the operation we perform.  Also improve the tracing by giving each caller it's own type set of tracepoints.  Signed-off-by: Christoph Hellwig <hch@lst.de> Reviewed-by: Dave Chinner <dchinner@redhat.com> Signed-off-by: Alex Elder <aelder@sgi.com>
f | xfs_trans_dquot.c | s | 21K | 790 | Dave Chinner | dchinner@redhat.com | 1337030460 |  | xfs: clean up xfs_bit.h includes  With the removal of xfs_rw.h and other changes over time, xfs_bit.h is being included in many files that don't actually need it. Clean up the includes as necessary.  Also move the only-used-once xfs_ialloc_find_free() static inline function out of a header file that is widely included to reduce the number of needless dependencies on xfs_bit.h.  Signed-off-by: Dave Chinner <dchinner@redhat.com> Reviewed-by: Mark Tinguely <tinguely@sgi.com> Signed-off-by: Ben Myers <bpm@sgi.com>
f | xfs_itable.c | s | 19K | 692 | Dave Chinner | dchinner@redhat.com | 1337030460 |  | xfs: clean up xfs_bit.h includes  With the removal of xfs_rw.h and other changes over time, xfs_bit.h is being included in many files that don't actually need it. Clean up the includes as necessary.  Also move the only-used-once xfs_ialloc_find_free() static inline function out of a header file that is widely included to reduce the number of needless dependencies on xfs_bit.h.  Signed-off-by: Dave Chinner <dchinner@redhat.com> Reviewed-by: Mark Tinguely <tinguely@sgi.com> Signed-off-by: Ben Myers <bpm@sgi.com>
f | xfs_export.h | s | 2.0K | 68 | Christoph Hellwig | hch@infradead.org | 1313184095 |  | xfs: remove subdirectories  Use the move from Linux 2.6 to Linux 3.x as an excuse to kill the annoying subdirectories in the XFS source code.  Besides the large amount of file rename the only changes are to the Makefile, a few files including headers with the subdirectory prefix, and the binary sysctl compat code that includes a header under fs/xfs/ from kernel/.  Signed-off-by: Christoph Hellwig <hch@lst.de> Signed-off-by: Alex Elder <aelder@sgi.com>
f | mrlock.h | s | 2.0K | 78 | Christoph Hellwig | hch@infradead.org | 1313184095 |  | xfs: remove subdirectories  Use the move from Linux 2.6 to Linux 3.x as an excuse to kill the annoying subdirectories in the XFS source code.  Besides the large amount of file rename the only changes are to the Makefile, a few files including headers with the subdirectory prefix, and the binary sysctl compat code that includes a header under fs/xfs/ from kernel/.  Signed-off-by: Christoph Hellwig <hch@lst.de> Signed-off-by: Alex Elder <aelder@sgi.com>
f | xfs_file.c | s | 28K | 988 | Josef Bacik | josef@redhat.com | 1338566845 |  | fs: introduce inode operation ->update_time  Btrfs has to make sure we have space to allocate new blocks in order to modify the inode, so updating time can fail.  We've gotten around this by having our own file_update_time but this is kind of a pain, and Christoph has indicated he would like to make xfs do something different with atime updates.  So introduce ->update_time, where we will deal with i_version an a/m/c time updates and indicate which changes need to be made.  The normal version just does what it has always done, updates the time and marks the inode dirty, and then filesystems can choose to do something different.  I've gone through all of the users of file_update_time and made them check for errors with the exception of the fault code since it's complicated and I wasn't quite sure what to do there, also Jan is going to be pushing the file time updates into page_mkwrite for those who have it so that should satisfy btrfs and make it not a big deal to check the file_update_time() return code in the generic fault path. Thanks,  Signed-off-by: Josef Bacik <josef@redhat.com>
f | xfs_bmap.c | s | 178K | 5709 | Dave Chinner | dchinner@redhat.com | 1337615143 |  | xfs: fix delalloc quota accounting on failure  xfstest 270 was causing quota reservations way beyond what was sane (ten to hundreds of TB) for a 4GB filesystem. There's a sign problem in the error handling path of xfs_bmapi_reserve_delalloc() because xfs_trans_unreserve_quota_nblks() simple negates the value passed - which doesn't work for an unsigned variable. This causes reservations of close to 2^32 block instead of removing a reservation of a handful of blocks.  Fix the same problem in the other xfs_trans_unreserve_quota_nblks() callers where unsigned integer variables are used, too.  Signed-off-by: Dave Chinner <dchinner@redhat.com> Reviewed-by: Eric Sandeen <sandeen@redhat.com> Signed-off-by: Ben Myers <bpm@sgi.com>
f | xfs_stats.c | s | 5.0K | 177 | Christoph Hellwig | hch@infradead.org | 1331741346 |  | xfs: use common code for quota statistics  Switch the quota code over to use the generic XFS statistics infrastructure. While the legacy /proc/fs/xfs/xqm and /proc/fs/xfs/xqmstats interfaces are preserved for now the statistics that still have a meaning with the current code are now also available from /proc/fs/xfs/stats.  Signed-off-by: Christoph Hellwig <hch@lst.de> Reviewed-by: Dave Chinner <dchinner@redhat.com> Signed-off-by: Ben Myers <bpm@sgi.com>
f | xfs_acl.h | s | 2.1K | 57 | Markus Trippelsdorf | markus@trippelsdorf.de | 1311960374 |  | xfs: Fix build breakage in xfs_iops.c when CONFIG_FS_POSIX_ACL is not set  commit 4e34e719e45, that takes the ACL checks to common code, accidentely broke the build when CONFIG_FS_POSIX_ACL is not set:    CC      fs/xfs/linux-2.6/xfs_iops.o fs/xfs/linux-2.6/xfs_iops.c:1025:14: error: âxfs_get_aclâ undeclared here (not in a function)  Fix this by declaring xfs_get_acl a static inline function.  Signed-off-by: Markus Trippelsdorf <markus@trippelsdorf.de> Signed-off-by: Alex Elder <aelder@sgi.com>
f | xfs_dfrag.c | s | 12K | 396 | Dave Chinner | dchinner@redhat.com | 1337030460 |  | xfs: clean up xfs_bit.h includes  With the removal of xfs_rw.h and other changes over time, xfs_bit.h is being included in many files that don't actually need it. Clean up the includes as necessary.  Also move the only-used-once xfs_ialloc_find_free() static inline function out of a header file that is widely included to reduce the number of needless dependencies on xfs_bit.h.  Signed-off-by: Dave Chinner <dchinner@redhat.com> Reviewed-by: Mark Tinguely <tinguely@sgi.com> Signed-off-by: Ben Myers <bpm@sgi.com>
f | xfs_qm_bhv.c | s | 4.4K | 142 | Dave Chinner | dchinner@redhat.com | 1337030460 |  | xfs: clean up xfs_bit.h includes  With the removal of xfs_rw.h and other changes over time, xfs_bit.h is being included in many files that don't actually need it. Clean up the includes as necessary.  Also move the only-used-once xfs_ialloc_find_free() static inline function out of a header file that is widely included to reduce the number of needless dependencies on xfs_bit.h.  Signed-off-by: Dave Chinner <dchinner@redhat.com> Reviewed-by: Mark Tinguely <tinguely@sgi.com> Signed-off-by: Ben Myers <bpm@sgi.com>
f | xfs_da_btree.h | s | 10K | 242 | Christoph Hellwig | hch@lst.de | 1310557430 |  | xfs: remove the dead XFS_DABUF_DEBUG code  Signed-off-by: Christoph Hellwig <hch@lst.de> Reviewed-by: Alex Elder <aelder@sgi.com> Reviewed-by: Dave Chinner <dchinner@redhat.com>
f | xfs_error.c | s | 4.0K | 159 | Dave Chinner | dchinner@redhat.com | 1337030454 |  | xfs: move xfsagino_t to xfs_types.h  Untangle the header file includes a bit by moving the definition of xfs_agino_t to xfs_types.h. This removes the dependency that xfs_ag.h has on xfs_inum.h, meaning we don't need to include xfs_inum.h everywhere we include xfs_ag.h.  Signed-off-by: Dave Chinner <dchinner@redhat.com> Reviewed-by: Mark Tinguely <tinguely@sgi.com> Signed-off-by: Ben Myers <bpm@sgi.com>
f | xfs_aops.c | s | 39K | 1416 | Alain Renaud | arenaud@sgi.com | 1340222248 |  | xfs: xfs_vm_writepage clear iomap_valid when !buffer_uptodate (REV2)  On filesytems with a block size smaller than PAGE_SIZE we currently have a problem with unwritten extents.  If a we have multi-block page for which an unwritten extent has been allocated, and only some of the buffers have been written to, and they are not contiguous, we can expose stale data from disk in the blocks between the writes after extent conversion.  Example of a page with unwritten and real data. buffer  content 0       empty  b_state = 0 1       DATA   b_state = 0x1023 Uptodate,Dirty,Mapped,Unwritten 2       DATA   b_state = 0x1023 Uptodate,Dirty,Mapped,Unwritten 3       empty  b_state = 0 4       empty  b_state = 0 5       DATA   b_state = 0x1023 Uptodate,Dirty,Mapped,Unwritten 6       DATA   b_state = 0x1023 Uptodate,Dirty,Mapped,Unwritten 7       empty  b_state = 0  Buffers 1, 2, 5, and 6 have been written to, leaving 0, 3, 4, and 7 empty.  Currently buffers 1, 2, 5, and 6 are added to a single ioend, and when IO has completed, extent conversion creates a real extent from block 1 through block 6, leaving 0 and 7 unwritten.  However buffers 3 and 4 were not written to disk, so stale data is exposed from those blocks on a subsequent read.  Fix this by setting iomap_valid = 0 when we find a buffer that is not Uptodate.  This ensures that buffers 5 and 6 are not added to the same ioend as buffers 1 and 2.  Later these blocks will be converted into two separate real extents, leaving the blocks in between unwritten.  Signed-off-by: Alain Renaud <arenaud@sgi.com> Reviewed-by: Dave Chinner <dchinner@redhat.com> Signed-off-by: Ben Myers <bpm@sgi.com>
f | xfs_buf.c | s | 37K | 1475 | Jan Kara | jack@suse.cz | 1340306436 |  | xfs: Fix overallocation in xfs_buf_allocate_memory()  Commit de1cbee which removed b_file_offset in favor of b_bn introduced a bug causing xfs_buf_allocate_memory() to overestimate the number of necessary pages. The problem is that xfs_buf_alloc() sets b_bn to -1 and thus effectively every buffer is straddling a page boundary which causes xfs_buf_allocate_memory() to allocate two pages and use vmalloc() for access which is unnecessary.  Dave says xfs_buf_alloc() doesn't need to set b_bn to -1 anymore since the buffer is inserted into the cache only after being fully initialized now. So just make xfs_buf_alloc() fill in proper block number from the beginning.  CC: David Chinner <dchinner@redhat.com> Signed-off-by: Jan Kara <jack@suse.cz> Reviewed-by: Christoph Hellwig <hch@lst.de> Reviewed-by: Dave Chinner <dchinner@redhat.com> Signed-off-by: Ben Myers <bpm@sgi.com>
f | xfs_extent_busy.h | s | 2.3K | 60 | Ben Myers | bpm@sgi.com | 1337030464 |  | xfs: make xfs_extent_busy_trim not static  Commit e459df5, 'xfs: move busy extent handling to it's own file' moved some code from xfs_alloc.c into xfs_extent_busy.c for convenience in userspace code merges.  One of the functions moved is xfs_extent_busy_trim (formerly xfs_alloc_busy_trim) which is defined STATIC.  Unfortunately this function is still used in xfs_alloc.c, and this results in an undefined symbol in xfs.ko.  Make xfs_extent_busy_trim not static and add its prototype to xfs_extent_busy.h.  Signed-off-by: Ben Myers <bpm@sgi.com> Reviewed-by: Mark Tinguely <tinguely@sgi.com>
f | xfs_trace.h | s | 56K | 1751 | Mark Tinguely | tinguely@sgi.com | 1340306471 |  | xfs: rename log structure to xlog  Rename the XFS log structure to xlog to help crash distinquish it from the other logs in Linux.  Signed-off-by: Mark Tinguely <tinguely@sgi.com> Reviewed-by: Christoph Hellwig <hch@lst.de> Signed-off-by: Ben Myers <bpm@sgi.com>
f | xfs_filestream.c | s | 22K | 719 | Dave Chinner | dchinner@redhat.com | 1318385706 |  | xfs: rename allocation range fields in struct xfs_bmalloca  Signed-off-by: Dave Chinner <dchinner@redhat.com> Signed-off-by: Christoph Hellwig <hch@lst.de> Signed-off-by: Alex Elder <aelder@sgi.com>
f | xfs_types.h | s | 5.3K | 136 | Dave Chinner | dchinner@redhat.com | 1337030454 |  | xfs: move xfsagino_t to xfs_types.h  Untangle the header file includes a bit by moving the definition of xfs_agino_t to xfs_types.h. This removes the dependency that xfs_ag.h has on xfs_inum.h, meaning we don't need to include xfs_inum.h everywhere we include xfs_ag.h.  Signed-off-by: Dave Chinner <dchinner@redhat.com> Reviewed-by: Mark Tinguely <tinguely@sgi.com> Signed-off-by: Ben Myers <bpm@sgi.com>
f | xfs_dfrag.h | s | 1.4K | 46 | Dave Chinner | david@fromorbit.com | 1263591083 |  | xfs: clean up inconsistent variable naming in xfs_swap_extent  The swap extent ioctl passes in a target inode and a temporary inode which are clearly named in the ioctl structure. The code then assigns temp to target and vice versa, making it extremely difficult to work out which inode is which later in the code.  Make this consistent throughout the code.  Also make xfs_swap_extent static as there are no external users of the function.  Signed-off-by: Dave Chinner <david@fromorbit.com> Signed-off-by: Alex Elder <aelder@sgi.com>
f | xfs_dquot_item.h | s | 1.7K | 42 | Christoph Hellwig | hch@infradead.org | 1313184095 |  | xfs: remove subdirectories  Use the move from Linux 2.6 to Linux 3.x as an excuse to kill the annoying subdirectories in the XFS source code.  Besides the large amount of file rename the only changes are to the Makefile, a few files including headers with the subdirectory prefix, and the binary sysctl compat code that includes a header under fs/xfs/ from kernel/.  Signed-off-by: Christoph Hellwig <hch@lst.de> Signed-off-by: Alex Elder <aelder@sgi.com>
f | xfs_alloc.c | s | 68K | 2330 | Dave Chinner | dchinner@redhat.com | 1340306420 |  | xfs: fix allocbt cursor leak in xfs_alloc_ag_vextent_near  When we fail to find an matching extent near the requested extent specification during a left-right distance search in xfs_alloc_ag_vextent_near, we fail to free the original cursor that we used to look up the XFS_BTNUM_CNT tree and hence leak it.  Reported-by: Chris J Arges <chris.j.arges@canonical.com> Signed-off-by: Dave Chinner <dchinner@redhat.com> Reviewed-by: Christoph Hellwig <hch@lst.de> Signed-off-by: Ben Myers <bpm@sgi.com>
f | xfs_trans_inode.c | s | 4.5K | 153 | Dave Chinner | dchinner@redhat.com | 1337030460 |  | xfs: clean up xfs_bit.h includes  With the removal of xfs_rw.h and other changes over time, xfs_bit.h is being included in many files that don't actually need it. Clean up the includes as necessary.  Also move the only-used-once xfs_ialloc_find_free() static inline function out of a header file that is widely included to reduce the number of needless dependencies on xfs_bit.h.  Signed-off-by: Dave Chinner <dchinner@redhat.com> Reviewed-by: Mark Tinguely <tinguely@sgi.com> Signed-off-by: Ben Myers <bpm@sgi.com>
f | xfs_error.h | s | 5.4K | 146 | Dave Chinner | dchinner@redhat.com | 1299452975 |  | xfs: kill support/debug.[ch]  The remaining functionality in debug.[ch] is effectively just assert handling, conditional debug definitions and hex dumping. The hex dumping and assert function can be moved into the new printk module, while the rest can be moved into top-level header files. This allows fs/xfs/support/debug.[ch] to be completely removed from the codebase.  Signed-off-by: Dave Chinner <dchinner@redhat.com> Reviewed-by: Alex Elder <aelder@sgi.com> Reviewed-by: Christoph Hellwig <hch@lst.de>
f | xfs_fsops.h | s | 1.3K | 28 | Dave Chinner | dchinner@redhat.com | 1294799297 |  | xfs: ensure log covering transactions are synchronous  To ensure the log is covered and the filesystem idles correctly, we need to ensure that dummy transactions hit the disk and do not stay pinned in memory.  If the superblock is pinned in memory, it can't be flushed so the log covering cannot make progress. The result is dependent on timing - more oftent han not we continue to issues a log covering transaction every 36s rather than idling after ~90s.  Fix this by making the log covering transaction synchronous. To avoid additional log force from xfssyncd, make the log covering transaction take the place of the existing log force in the xfssyncd background sync process.  Signed-off-by: Dave Chinner <dchinner@redhat.com> Reviewed-by: Christoph Hellwig <hch@lst.de> Signed-off-by: Alex Elder <aelder@sgi.com>
f | xfs_sync.c | s | 25K | 853 | Ben Myers | bpm@sgi.com | 1340306448 |  | xfs: shutdown xfs_sync_worker before the log  Revert commit 1307bbd, which uses the s_umount semaphore to provide exclusion between xfs_sync_worker and unmount, in favor of shutting down the sync worker before freeing the log in xfs_log_unmount.  This is a cleaner way of resolving the race between xfs_sync_worker and unmount than using s_umount.  Signed-off-by: Ben Myers <bpm@sgi.com> Reviewed-by: Mark Tinguely <tinguely@sgi.com> Reviewed-by: Dave Chinner <dchinner@redhat.com>
f | xfs_super.c | s | 45K | 1523 | Linus Torvalds | torvalds@linux-foundation.org | 1338224085 |  | 
f | xfs_quota.h | s | 14K | 345 | Chandra Seetharaman | sekharan@us.ibm.com | 1328290340 |  | Define new macro XFS_ALL_QUOTA_ACTIVE and simply some usage  Define new macro XFS_ALL_QUOTA_ACTIVE and simply some usage of quota macros.  Signed-off-by: Chandra Seetharaman <sekharan@us.ibm.com> Reviewed-by: Christoph Hellwig <hch@lst.de> Signed-off-by: Ben Myers <bpm@sgi.com>
f | Kconfig | g | 3.2K |  | Jan Kara | jack@suse.cz | 1286273797 |  | quota: Make QUOTACTL config be selected by its users  Remove "depends on" line from QUOTACTL config option and rather select the option explicitely from config options which need it. It makes more sense this way and also fixes Kconfig warning due to GFS2 selecting QUOTACTL but QUOTACTL not depending on it.  Signed-off-by: Jan Kara <jack@suse.cz>
f | xfs_log_priv.h | s | 24K | 615 | Mark Tinguely | tinguely@sgi.com | 1340306471 |  | xfs: rename log structure to xlog  Rename the XFS log structure to xlog to help crash distinquish it from the other logs in Linux.  Signed-off-by: Mark Tinguely <tinguely@sgi.com> Reviewed-by: Christoph Hellwig <hch@lst.de> Signed-off-by: Ben Myers <bpm@sgi.com>
f | xfs_qm.c | s | 45K | 1696 | Dave Chinner | dchinner@redhat.com | 1337030454 |  | xfs: move xfsagino_t to xfs_types.h  Untangle the header file includes a bit by moving the definition of xfs_agino_t to xfs_types.h. This removes the dependency that xfs_ag.h has on xfs_inum.h, meaning we don't need to include xfs_inum.h everywhere we include xfs_ag.h.  Signed-off-by: Dave Chinner <dchinner@redhat.com> Reviewed-by: Mark Tinguely <tinguely@sgi.com> Signed-off-by: Ben Myers <bpm@sgi.com>
f | xfs_ialloc_btree.c | s | 6.3K | 237 | Dave Chinner | dchinner@redhat.com | 1337030454 |  | xfs: move xfsagino_t to xfs_types.h  Untangle the header file includes a bit by moving the definition of xfs_agino_t to xfs_types.h. This removes the dependency that xfs_ag.h has on xfs_inum.h, meaning we don't need to include xfs_inum.h everywhere we include xfs_ag.h.  Signed-off-by: Dave Chinner <dchinner@redhat.com> Reviewed-by: Mark Tinguely <tinguely@sgi.com> Signed-off-by: Ben Myers <bpm@sgi.com>
f | xfs_attr.h | s | 5.5K | 125 | Dave Chinner | david@fromorbit.com | 1263944868 |  | xfs: convert attr to use unsigned names  To be consistent with the directory code, the attr code should use unsigned names. Convert the names from the vfs at the highest level to unsigned, and Ã¦nsure they are consistenly used as unsigned down to disk.  Signed-off-by: Dave Chinner <david@fromorbit.com> Reviewed-by: Christoph Hellwig <hch@lst.de>
f | xfs.h | s | 906B | 26 | Alex Elder | aelder@sgi.com | 1313175475 |  | xfs: don't expect xfs headers to be in subdirectories  Fix up some #include directives in preparation for moving a few header files out of xfs source subdirectories.  Note that "xfs_linux.h" also got its quoting convention for included files switched.  Signed-off-by: Alex Elder <aelder@sgi.com> Reviewed-by: Christoph Hellwig <hch@lst.de>
f | xfs_extfree_item.h | s | 5.1K | 139 | Dave Chinner | dchinner@redhat.com | 1292806789 |  | xfs: Pull EFI/EFD handling out from under the AIL lock  EFI/EFD interactions are protected from races by the AIL lock. They are the only type of log items that require the the AIL lock to serialise internal state, so they need to be separated from the AIL lock before we can do bulk insert operations on the AIL.  To acheive this, convert the counter of the number of extents in the EFI to an atomic so it can be safely manipulated by EFD processing without locks. Also, convert the EFI state flag manipulations to use atomic bit operations so no locks are needed to record state changes. Finally, use the state bits to determine when it is safe to free the EFI and clean up the code to do this neatly.  Signed-off-by: Dave Chinner <dchinner@redhat.com> Reviewed-by: Christoph Hellwig <hch@lst.de>
f | xfs_bit.h | s | 2.1K | 73 | Eric Sandeen | sandeen@sandeen.net | 1231476834 |  | [XFS] Remove macro-to-function indirections in the mask code  Signed-off-by: Eric Sandeen <sandeen@sandeen.net> Reviewed-by: Christoph Hellwig <hch@infradead.org> Signed-off-by: Lachlan McIlroy <lachlan@sgi.com>
f | time.h | s | 1.0K | 31 | Christoph Hellwig | hch@infradead.org | 1313184095 |  | xfs: remove subdirectories  Use the move from Linux 2.6 to Linux 3.x as an excuse to kill the annoying subdirectories in the XFS source code.  Besides the large amount of file rename the only changes are to the Makefile, a few files including headers with the subdirectory prefix, and the binary sysctl compat code that includes a header under fs/xfs/ from kernel/.  Signed-off-by: Christoph Hellwig <hch@lst.de> Signed-off-by: Alex Elder <aelder@sgi.com>
f | xfs_trans.h | s | 18K | 458 | Al Viro | viro@zeniv.linux.org.uk | 1338348512 |  | xfs: switch to proper __bitwise type for KM_... flags  Signed-off-by: Al Viro <viro@zeniv.linux.org.uk>
f | xfs_inode_item.c | s | 23K | 802 | Brian Foster | bfoster@redhat.com | 1340306406 |  | xfs: check for stale inode before acquiring iflock on push  An inode in the AIL can be flush locked and marked stale if a cluster free transaction occurs at the right time. The inode item is then marked as flushing, which causes xfsaild to spin and leaves the filesystem stalled. This is reproduced by running xfstests 273 in a loop for an extended period of time.  Check for stale inodes before the flush lock. This marks the inode as pinned, leads to a log flush and allows the filesystem to proceed.  Signed-off-by: Brian Foster <bfoster@redhat.com> Reviewed-by: Dave Chinner <dchinner@redhat.com> Reviewed-by: Christoph Hellwig <hch@lst.de> Reviewed-by: Mark Tinguely <tinguely@sgi.com> Signed-off-by: Ben Myers <bpm@sgi.com>
f | xfs_iget.c | s | 19K | 638 | Peter Watkins | treestem@gmail.com | 1337615144 |  | xfs: fix memory reclaim deadlock on agi buffer  Note xfs_iget can be called while holding a locked agi buffer. If it goes into memory reclaim then inode teardown may try to lock the same buffer. Prevent the deadlock by calling radix_tree_preload with GFP_NOFS.  Signed-off-by: Peter Watkins <treestem@gmail.com> Reviewed-by: Dave Chinner <dchinner@redhat.com> Signed-off-by: Ben Myers <bpm@sgi.com>
f | xfs_ag.h | s | 9.5K | 241 | Dave Chinner | dchinner@redhat.com | 1337030455 |  | xfs: move busy extent handling to it's own file  To make it easier to handle userspace code merges, move all the busy extent handling out of the allocation code and into it's own file. The userspace code does not need the busy extent code, so this simplifies the merging of the kernel code into the userspace xfsprogs library.  Because the busy extent code has been almost completely rewritten over the past couple of years, also update the copyright on this new file to include the authors that made all those changes.  Signed-off-by: Dave Chinner <dchinner@redhat.com> Reviewed-by: Christoph Hellwig <hch@lst.de> Reviewed-by: Mark Tinguely <tinguely@sgi.com> Signed-off-by: Ben Myers <bpm@sgi.com>
f | xfs_ialloc.c | s | 42K | 1441 | Dave Chinner | dchinner@redhat.com | 1337030460 |  | xfs: clean up xfs_bit.h includes  With the removal of xfs_rw.h and other changes over time, xfs_bit.h is being included in many files that don't actually need it. Clean up the includes as necessary.  Also move the only-used-once xfs_ialloc_find_free() static inline function out of a header file that is widely included to reduce the number of needless dependencies on xfs_bit.h.  Signed-off-by: Dave Chinner <dchinner@redhat.com> Reviewed-by: Mark Tinguely <tinguely@sgi.com> Signed-off-by: Ben Myers <bpm@sgi.com>
f | xfs_vnode.h | s | 1.9K | 54 | Dave Chinner | dchinner@redhat.com | 1331836816 |  | xfs: remove remaining scraps of struct xfs_iomap  Signed-off-by: Dave Chinner <dchinner@redhat.com> Reviewed-by: Christoph Hellwig <hch@lst.de> Reviewed-by: Mark Tinguely <tinguely@sgi.com> Signed-off-by: Ben Myers <bpm@sgi.com>
f | xfs_ialloc_btree.h | s | 3.2K | 95 | Christoph Hellwig | hch@lst.de | 1234165034 |  | xfs: remove superflous inobt macros  xfs_ialloc_btree.h has a a cuple of macros that only obsfucate the code but don't provide any abstraction benefits.  This patches removes those and cleans up the reamaining defintions up a little.  Signed-off-by: Christoph Hellwig <hch@lst.de> Reviewed-by: Dave Chinner <david@fromorbit.com>
f | xfs_sysctl.c | s | 6.1K | 238 | Christoph Hellwig | hch@infradead.org | 1313184095 |  | xfs: remove subdirectories  Use the move from Linux 2.6 to Linux 3.x as an excuse to kill the annoying subdirectories in the XFS source code.  Besides the large amount of file rename the only changes are to the Makefile, a few files including headers with the subdirectory prefix, and the binary sysctl compat code that includes a header under fs/xfs/ from kernel/.  Signed-off-by: Christoph Hellwig <hch@lst.de> Signed-off-by: Alex Elder <aelder@sgi.com>
f | xfs_iops.c | s | 28K | 1019 | Dave Chinner | dchinner@redhat.com | 1337030460 |  | xfs: clean up xfs_bit.h includes  With the removal of xfs_rw.h and other changes over time, xfs_bit.h is being included in many files that don't actually need it. Clean up the includes as necessary.  Also move the only-used-once xfs_ialloc_find_free() static inline function out of a header file that is widely included to reduce the number of needless dependencies on xfs_bit.h.  Signed-off-by: Dave Chinner <dchinner@redhat.com> Reviewed-by: Mark Tinguely <tinguely@sgi.com> Signed-off-by: Ben Myers <bpm@sgi.com>
f | xfs_qm_syscalls.c | s | 24K | 791 | Dave Chinner | dchinner@redhat.com | 1337030454 |  | xfs: move xfsagino_t to xfs_types.h  Untangle the header file includes a bit by moving the definition of xfs_agino_t to xfs_types.h. This removes the dependency that xfs_ag.h has on xfs_inum.h, meaning we don't need to include xfs_inum.h everywhere we include xfs_ag.h.  Signed-off-by: Dave Chinner <dchinner@redhat.com> Reviewed-by: Mark Tinguely <tinguely@sgi.com> Signed-off-by: Ben Myers <bpm@sgi.com>
f | xfs_attr.c | s | 55K | 1982 | Dave Chinner | dchinner@redhat.com | 1337030458 |  | xfs: move xfs_get_extsz_hint() and kill xfs_rw.h  The only thing left in xfs_rw.h is a function prototype for an inode function.  Move that to xfs_inode.h, and kill xfs_rw.h.  Also move the function implementing the prototype from xfs_rw.c to xfs_inode.c so we only have one function left in xfs_rw.c  Signed-off-by: Dave Chinner <dchinner@redhat.com> Reviewed-by: Mark Tinguely <tinguely@sgi.com> Reviewed-by: Christoph Hellwig <hch@lst.de> Signed-off-by: Ben Myers <bpm@sgi.com>
f | xfs_trans_extfree.c | s | 3.5K | 118 | Dave Chinner | dchinner@redhat.com | 1337030454 |  | xfs: move xfsagino_t to xfs_types.h  Untangle the header file includes a bit by moving the definition of xfs_agino_t to xfs_types.h. This removes the dependency that xfs_ag.h has on xfs_inum.h, meaning we don't need to include xfs_inum.h everywhere we include xfs_ag.h.  Signed-off-by: Dave Chinner <dchinner@redhat.com> Reviewed-by: Mark Tinguely <tinguely@sgi.com> Signed-off-by: Ben Myers <bpm@sgi.com>
f | xfs_log.c | s | 99K | 3228 | Mark Tinguely | tinguely@sgi.com | 1340306471 |  | xfs: rename log structure to xlog  Rename the XFS log structure to xlog to help crash distinquish it from the other logs in Linux.  Signed-off-by: Mark Tinguely <tinguely@sgi.com> Reviewed-by: Christoph Hellwig <hch@lst.de> Signed-off-by: Ben Myers <bpm@sgi.com>
f | xfs_export.c | s | 6.3K | 218 | Al Viro | viro@zeniv.linux.org.uk | 1338348513 |  | ->encode_fh() API change  pass inode + parent's inode or NULL instead of dentry + bool saying whether we want the parent or not.  NOTE: that needs ceph fix folded in.  Signed-off-by: Al Viro <viro@zeniv.linux.org.uk>
f | xfs_alloc.h | s | 8.4K | 213 | Dave Chinner | dchinner@redhat.com | 1337030455 |  | xfs: move busy extent handling to it's own file  To make it easier to handle userspace code merges, move all the busy extent handling out of the allocation code and into it's own file. The userspace code does not need the busy extent code, so this simplifies the merging of the kernel code into the userspace xfsprogs library.  Because the busy extent code has been almost completely rewritten over the past couple of years, also update the copyright on this new file to include the authors that made all those changes.  Signed-off-by: Dave Chinner <dchinner@redhat.com> Reviewed-by: Christoph Hellwig <hch@lst.de> Reviewed-by: Mark Tinguely <tinguely@sgi.com> Signed-off-by: Ben Myers <bpm@sgi.com>
f | xfs_acl.c | s | 8.7K | 353 | Xi Wang | xi.wang@gmail.com | 1324070262 |  | xfs: fix acl count validation in xfs_acl_from_disk()  Commit fa8b18ed didn't prevent the integer overflow and possible memory corruption.  "count" can go negative and bypass the check.  Signed-off-by: Xi Wang <xi.wang@gmail.com> Reviewed-by: Christoph Hellwig <hch@lst.de> Signed-off-by: Ben Myers <bpm@sgi.com>
f | xfs_trans_buf.c | s | 20K | 693 | Dave Chinner | dchinner@redhat.com | 1337030463 |  | xfs: make XBF_MAPPED the default behaviour  Rather than specifying XBF_MAPPED for almost all buffers, introduce XBF_UNMAPPED for the couple of users that use unmapped buffers.  Signed-off-by: Dave Chinner <dchinner@redhat.com> Reviewed-by: Mark Tinguely <tinguely@sgi.com> Reviewed-by: Christoph Hellwig <hch@lst.de> Signed-off-by: Ben Myers <bpm@sgi.com>
f | xfs_super.h | s | 2.2K | 71 | Christoph Hellwig | hch@infradead.org | 1331744792 |  | xfs: remove the global xfs_Gqm structure  If we initialize the slab caches for the quota code when XFS is loaded there is no need for a global and reference counted quota manager structure.  Drop all this overhead and also fix the error handling during quota initialization.  Reviewed-by: Dave Chinner <dchinner@redhat.com> Signed-off-by: Christoph Hellwig <hch@lst.de> Signed-off-by: Ben Myers <bpm@sgi.com>
f | xfs_dinode.h | s | 8.2K | 195 | Chandra Seetharaman | sekharan@us.ibm.com | 1311624193 |  | xfs: Remove the macro XFS_BUF_PTR  Remove the definition and usages of the macro XFS_BUF_PTR.  Signed-off-by: Chandra Seetharaman <sekharan@us.ibm.com> Reviewed-by: Christoph Hellwig <hch@lst.de> Signed-off-by: Alex Elder <aelder@sgi.com>
f | xfs_ioctl.h | s | 1.8K | 74 | Christoph Hellwig | hch@infradead.org | 1313184095 |  | xfs: remove subdirectories  Use the move from Linux 2.6 to Linux 3.x as an excuse to kill the annoying subdirectories in the XFS source code.  Besides the large amount of file rename the only changes are to the Makefile, a few files including headers with the subdirectory prefix, and the binary sysctl compat code that includes a header under fs/xfs/ from kernel/.  Signed-off-by: Christoph Hellwig <hch@lst.de> Signed-off-by: Alex Elder <aelder@sgi.com>
f | xfs_dir2_leaf.c | s | 52K | 1830 | Dave Chinner | dchinner@redhat.com | 1337030454 |  | xfs: move xfsagino_t to xfs_types.h  Untangle the header file includes a bit by moving the definition of xfs_agino_t to xfs_types.h. This removes the dependency that xfs_ag.h has on xfs_inum.h, meaning we don't need to include xfs_inum.h everywhere we include xfs_ag.h.  Signed-off-by: Dave Chinner <dchinner@redhat.com> Reviewed-by: Mark Tinguely <tinguely@sgi.com> Signed-off-by: Ben Myers <bpm@sgi.com>
