<!DOCTYPE html>
<html><head><title>joekychen/linux » fs › xfs › xfs_dir2_format.h

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>xfs_dir2_format.h</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Copyright (c) 2000-2001,2005 Silicon Graphics, Inc.</span>
<span class="cm"> * All Rights Reserved.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or</span>
<span class="cm"> * modify it under the terms of the GNU General Public License as</span>
<span class="cm"> * published by the Free Software Foundation.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is distributed in the hope that it would be useful,</span>
<span class="cm"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm"> * GNU General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> * You should have received a copy of the GNU General Public License</span>
<span class="cm"> * along with this program; if not, write the Free Software Foundation,</span>
<span class="cm"> * Inc.,  51 Franklin St, Fifth Floor, Boston, MA  02110-1301  USA</span>
<span class="cm"> */</span>
<span class="cp">#ifndef __XFS_DIR2_FORMAT_H__</span>
<span class="cp">#define __XFS_DIR2_FORMAT_H__</span>

<span class="cm">/*</span>
<span class="cm"> * Directory version 2.</span>
<span class="cm"> *</span>
<span class="cm"> * There are 4 possible formats:</span>
<span class="cm"> *  - shortform - embedded into the inode</span>
<span class="cm"> *  - single block - data with embedded leaf at the end</span>
<span class="cm"> *  - multiple data blocks, single leaf+freeindex block</span>
<span class="cm"> *  - data blocks, node and leaf blocks (btree), freeindex blocks</span>
<span class="cm"> *</span>
<span class="cm"> * Note: many node blocks structures and constants are shared with the attr</span>
<span class="cm"> * code and defined in xfs_da_btree.h.</span>
<span class="cm"> */</span>

<span class="cp">#define	XFS_DIR2_BLOCK_MAGIC	0x58443242	</span><span class="cm">/* XD2B: single block dirs */</span><span class="cp"></span>
<span class="cp">#define	XFS_DIR2_DATA_MAGIC	0x58443244	</span><span class="cm">/* XD2D: multiblock dirs */</span><span class="cp"></span>
<span class="cp">#define	XFS_DIR2_FREE_MAGIC	0x58443246	</span><span class="cm">/* XD2F: free index blocks */</span><span class="cp"></span>

<span class="cm">/*</span>
<span class="cm"> * Byte offset in data block and shortform entry.</span>
<span class="cm"> */</span>
<span class="k">typedef</span>	<span class="n">__uint16_t</span>	<span class="n">xfs_dir2_data_off_t</span><span class="p">;</span>
<span class="cp">#define	NULLDATAOFF	0xffffU</span>
<span class="k">typedef</span> <span class="n">uint</span>		<span class="n">xfs_dir2_data_aoff_t</span><span class="p">;</span>	<span class="cm">/* argument form */</span>

<span class="cm">/*</span>
<span class="cm"> * Normalized offset (in a data block) of the entry, really xfs_dir2_data_off_t.</span>
<span class="cm"> * Only need 16 bits, this is the byte offset into the single block form.</span>
<span class="cm"> */</span>
<span class="k">typedef</span> <span class="k">struct</span> <span class="p">{</span> <span class="n">__uint8_t</span> <span class="n">i</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span> <span class="p">}</span> <span class="n">__arch_pack</span> <span class="n">xfs_dir2_sf_off_t</span><span class="p">;</span>

<span class="cm">/*</span>
<span class="cm"> * Offset in data space of a data entry.</span>
<span class="cm"> */</span>
<span class="k">typedef</span>	<span class="n">__uint32_t</span>	<span class="n">xfs_dir2_dataptr_t</span><span class="p">;</span>
<span class="cp">#define	XFS_DIR2_MAX_DATAPTR	((xfs_dir2_dataptr_t)0xffffffff)</span>
<span class="cp">#define	XFS_DIR2_NULL_DATAPTR	((xfs_dir2_dataptr_t)0)</span>

<span class="cm">/*</span>
<span class="cm"> * Byte offset in a directory.</span>
<span class="cm"> */</span>
<span class="k">typedef</span>	<span class="n">xfs_off_t</span>	<span class="n">xfs_dir2_off_t</span><span class="p">;</span>

<span class="cm">/*</span>
<span class="cm"> * Directory block number (logical dirblk in file)</span>
<span class="cm"> */</span>
<span class="k">typedef</span>	<span class="n">__uint32_t</span>	<span class="n">xfs_dir2_db_t</span><span class="p">;</span>

<span class="cm">/*</span>
<span class="cm"> * Inode number stored as 8 8-bit values.</span>
<span class="cm"> */</span>
<span class="k">typedef</span>	<span class="k">struct</span> <span class="p">{</span> <span class="n">__uint8_t</span> <span class="n">i</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span> <span class="p">}</span> <span class="n">xfs_dir2_ino8_t</span><span class="p">;</span>

<span class="cm">/*</span>
<span class="cm"> * Inode number stored as 4 8-bit values.</span>
<span class="cm"> * Works a lot of the time, when all the inode numbers in a directory</span>
<span class="cm"> * fit in 32 bits.</span>
<span class="cm"> */</span>
<span class="k">typedef</span> <span class="k">struct</span> <span class="p">{</span> <span class="n">__uint8_t</span> <span class="n">i</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span> <span class="p">}</span> <span class="n">xfs_dir2_ino4_t</span><span class="p">;</span>

<span class="k">typedef</span> <span class="k">union</span> <span class="p">{</span>
	<span class="n">xfs_dir2_ino8_t</span>	<span class="n">i8</span><span class="p">;</span>
	<span class="n">xfs_dir2_ino4_t</span>	<span class="n">i4</span><span class="p">;</span>
<span class="p">}</span> <span class="n">xfs_dir2_inou_t</span><span class="p">;</span>
<span class="cp">#define	XFS_DIR2_MAX_SHORT_INUM	((xfs_ino_t)0xffffffffULL)</span>

<span class="cm">/*</span>
<span class="cm"> * Directory layout when stored internal to an inode.</span>
<span class="cm"> *</span>
<span class="cm"> * Small directories are packed as tightly as possible so as to fit into the</span>
<span class="cm"> * literal area of the inode.  These &quot;shortform&quot; directories consist of a</span>
<span class="cm"> * single xfs_dir2_sf_hdr header followed by zero or more xfs_dir2_sf_entry</span>
<span class="cm"> * structures.  Due the different inode number storage size and the variable</span>
<span class="cm"> * length name field in the xfs_dir2_sf_entry all these structure are</span>
<span class="cm"> * variable length, and the accessors in this file should be used to iterate</span>
<span class="cm"> * over them.</span>
<span class="cm"> */</span>
<span class="k">typedef</span> <span class="k">struct</span> <span class="n">xfs_dir2_sf_hdr</span> <span class="p">{</span>
	<span class="n">__uint8_t</span>		<span class="n">count</span><span class="p">;</span>		<span class="cm">/* count of entries */</span>
	<span class="n">__uint8_t</span>		<span class="n">i8count</span><span class="p">;</span>	<span class="cm">/* count of 8-byte inode #s */</span>
	<span class="n">xfs_dir2_inou_t</span>		<span class="n">parent</span><span class="p">;</span>		<span class="cm">/* parent dir inode number */</span>
<span class="p">}</span> <span class="n">__arch_pack</span> <span class="n">xfs_dir2_sf_hdr_t</span><span class="p">;</span>

<span class="k">typedef</span> <span class="k">struct</span> <span class="n">xfs_dir2_sf_entry</span> <span class="p">{</span>
	<span class="n">__u8</span>			<span class="n">namelen</span><span class="p">;</span>	<span class="cm">/* actual name length */</span>
	<span class="n">xfs_dir2_sf_off_t</span>	<span class="n">offset</span><span class="p">;</span>		<span class="cm">/* saved offset */</span>
	<span class="n">__u8</span>			<span class="n">name</span><span class="p">[];</span>		<span class="cm">/* name, variable size */</span>
	<span class="cm">/*</span>
<span class="cm">	 * A xfs_dir2_ino8_t or xfs_dir2_ino4_t follows here, at a</span>
<span class="cm">	 * variable offset after the name.</span>
<span class="cm">	 */</span>
<span class="p">}</span> <span class="n">__arch_pack</span> <span class="n">xfs_dir2_sf_entry_t</span><span class="p">;</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">xfs_dir2_sf_hdr_size</span><span class="p">(</span><span class="kt">int</span> <span class="n">i8count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">xfs_dir2_sf_hdr</span><span class="p">)</span> <span class="o">-</span>
		<span class="p">(</span><span class="n">i8count</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">*</span>
		<span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">xfs_dir2_ino8_t</span><span class="p">)</span> <span class="o">-</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">xfs_dir2_ino4_t</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">xfs_dir2_data_aoff_t</span>
<span class="nf">xfs_dir2_sf_get_offset</span><span class="p">(</span><span class="n">xfs_dir2_sf_entry_t</span> <span class="o">*</span><span class="n">sfep</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">get_unaligned_be16</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sfep</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">.</span><span class="n">i</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span>
<span class="nf">xfs_dir2_sf_put_offset</span><span class="p">(</span><span class="n">xfs_dir2_sf_entry_t</span> <span class="o">*</span><span class="n">sfep</span><span class="p">,</span> <span class="n">xfs_dir2_data_aoff_t</span> <span class="n">off</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">put_unaligned_be16</span><span class="p">(</span><span class="n">off</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sfep</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">.</span><span class="n">i</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span>
<span class="nf">xfs_dir2_sf_entsize</span><span class="p">(</span><span class="k">struct</span> <span class="n">xfs_dir2_sf_hdr</span> <span class="o">*</span><span class="n">hdr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">xfs_dir2_sf_entry</span><span class="p">)</span> <span class="o">+</span>	<span class="cm">/* namelen + offset */</span>
		<span class="n">len</span> <span class="o">+</span>					<span class="cm">/* name */</span>
		<span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">i8count</span> <span class="o">?</span>				<span class="cm">/* ino */</span>
		 <span class="k">sizeof</span><span class="p">(</span><span class="n">xfs_dir2_ino8_t</span><span class="p">)</span> <span class="o">:</span>
		 <span class="k">sizeof</span><span class="p">(</span><span class="n">xfs_dir2_ino4_t</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="k">struct</span> <span class="n">xfs_dir2_sf_entry</span> <span class="o">*</span>
<span class="nf">xfs_dir2_sf_firstentry</span><span class="p">(</span><span class="k">struct</span> <span class="n">xfs_dir2_sf_hdr</span> <span class="o">*</span><span class="n">hdr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="k">struct</span> <span class="n">xfs_dir2_sf_entry</span> <span class="o">*</span><span class="p">)</span>
		<span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">hdr</span> <span class="o">+</span> <span class="n">xfs_dir2_sf_hdr_size</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">i8count</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="k">struct</span> <span class="n">xfs_dir2_sf_entry</span> <span class="o">*</span>
<span class="nf">xfs_dir2_sf_nextentry</span><span class="p">(</span><span class="k">struct</span> <span class="n">xfs_dir2_sf_hdr</span> <span class="o">*</span><span class="n">hdr</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">xfs_dir2_sf_entry</span> <span class="o">*</span><span class="n">sfep</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="k">struct</span> <span class="n">xfs_dir2_sf_entry</span> <span class="o">*</span><span class="p">)</span>
		<span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">sfep</span> <span class="o">+</span> <span class="n">xfs_dir2_sf_entsize</span><span class="p">(</span><span class="n">hdr</span><span class="p">,</span> <span class="n">sfep</span><span class="o">-&gt;</span><span class="n">namelen</span><span class="p">));</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * Data block structures.</span>
<span class="cm"> *</span>
<span class="cm"> * A pure data block looks like the following drawing on disk:</span>
<span class="cm"> *</span>
<span class="cm"> *    +-------------------------------------------------+</span>
<span class="cm"> *    | xfs_dir2_data_hdr_t                             |</span>
<span class="cm"> *    +-------------------------------------------------+</span>
<span class="cm"> *    | xfs_dir2_data_entry_t OR xfs_dir2_data_unused_t |</span>
<span class="cm"> *    | xfs_dir2_data_entry_t OR xfs_dir2_data_unused_t |</span>
<span class="cm"> *    | xfs_dir2_data_entry_t OR xfs_dir2_data_unused_t |</span>
<span class="cm"> *    | ...                                             |</span>
<span class="cm"> *    +-------------------------------------------------+</span>
<span class="cm"> *    | unused space                                    |</span>
<span class="cm"> *    +-------------------------------------------------+</span>
<span class="cm"> *</span>
<span class="cm"> * As all the entries are variable size structures the accessors below should</span>
<span class="cm"> * be used to iterate over them.</span>
<span class="cm"> *</span>
<span class="cm"> * In addition to the pure data blocks for the data and node formats,</span>
<span class="cm"> * most structures are also used for the combined data/freespace &quot;block&quot;</span>
<span class="cm"> * format below.</span>
<span class="cm"> */</span>

<span class="cp">#define	XFS_DIR2_DATA_ALIGN_LOG	3		</span><span class="cm">/* i.e., 8 bytes */</span><span class="cp"></span>
<span class="cp">#define	XFS_DIR2_DATA_ALIGN	(1 &lt;&lt; XFS_DIR2_DATA_ALIGN_LOG)</span>
<span class="cp">#define	XFS_DIR2_DATA_FREE_TAG	0xffff</span>
<span class="cp">#define	XFS_DIR2_DATA_FD_COUNT	3</span>

<span class="cm">/*</span>
<span class="cm"> * Directory address space divided into sections,</span>
<span class="cm"> * spaces separated by 32GB.</span>
<span class="cm"> */</span>
<span class="cp">#define	XFS_DIR2_SPACE_SIZE	(1ULL &lt;&lt; (32 + XFS_DIR2_DATA_ALIGN_LOG))</span>
<span class="cp">#define	XFS_DIR2_DATA_SPACE	0</span>
<span class="cp">#define	XFS_DIR2_DATA_OFFSET	(XFS_DIR2_DATA_SPACE * XFS_DIR2_SPACE_SIZE)</span>
<span class="cp">#define	XFS_DIR2_DATA_FIRSTDB(mp)	\</span>
<span class="cp">	xfs_dir2_byte_to_db(mp, XFS_DIR2_DATA_OFFSET)</span>

<span class="cm">/*</span>
<span class="cm"> * Offsets of . and .. in data space (always block 0)</span>
<span class="cm"> */</span>
<span class="cp">#define	XFS_DIR2_DATA_DOT_OFFSET	\</span>
<span class="cp">	((xfs_dir2_data_aoff_t)sizeof(struct xfs_dir2_data_hdr))</span>
<span class="cp">#define	XFS_DIR2_DATA_DOTDOT_OFFSET	\</span>
<span class="cp">	(XFS_DIR2_DATA_DOT_OFFSET + xfs_dir2_data_entsize(1))</span>
<span class="cp">#define	XFS_DIR2_DATA_FIRST_OFFSET		\</span>
<span class="cp">	(XFS_DIR2_DATA_DOTDOT_OFFSET + xfs_dir2_data_entsize(2))</span>

<span class="cm">/*</span>
<span class="cm"> * Describe a free area in the data block.</span>
<span class="cm"> *</span>
<span class="cm"> * The freespace will be formatted as a xfs_dir2_data_unused_t.</span>
<span class="cm"> */</span>
<span class="k">typedef</span> <span class="k">struct</span> <span class="n">xfs_dir2_data_free</span> <span class="p">{</span>
	<span class="n">__be16</span>			<span class="n">offset</span><span class="p">;</span>		<span class="cm">/* start of freespace */</span>
	<span class="n">__be16</span>			<span class="n">length</span><span class="p">;</span>		<span class="cm">/* length of freespace */</span>
<span class="p">}</span> <span class="n">xfs_dir2_data_free_t</span><span class="p">;</span>

<span class="cm">/*</span>
<span class="cm"> * Header for the data blocks.</span>
<span class="cm"> *</span>
<span class="cm"> * The code knows that XFS_DIR2_DATA_FD_COUNT is 3.</span>
<span class="cm"> */</span>
<span class="k">typedef</span> <span class="k">struct</span> <span class="n">xfs_dir2_data_hdr</span> <span class="p">{</span>
	<span class="n">__be32</span>			<span class="n">magic</span><span class="p">;</span>		<span class="cm">/* XFS_DIR2_DATA_MAGIC or */</span>
						<span class="cm">/* XFS_DIR2_BLOCK_MAGIC */</span>
	<span class="n">xfs_dir2_data_free_t</span>	<span class="n">bestfree</span><span class="p">[</span><span class="n">XFS_DIR2_DATA_FD_COUNT</span><span class="p">];</span>
<span class="p">}</span> <span class="n">xfs_dir2_data_hdr_t</span><span class="p">;</span>

<span class="cm">/*</span>
<span class="cm"> * Active entry in a data block.</span>
<span class="cm"> *</span>
<span class="cm"> * Aligned to 8 bytes.  After the variable length name field there is a</span>
<span class="cm"> * 2 byte tag field, which can be accessed using xfs_dir2_data_entry_tag_p.</span>
<span class="cm"> */</span>
<span class="k">typedef</span> <span class="k">struct</span> <span class="n">xfs_dir2_data_entry</span> <span class="p">{</span>
	<span class="n">__be64</span>			<span class="n">inumber</span><span class="p">;</span>	<span class="cm">/* inode number */</span>
	<span class="n">__u8</span>			<span class="n">namelen</span><span class="p">;</span>	<span class="cm">/* name length */</span>
	<span class="n">__u8</span>			<span class="n">name</span><span class="p">[];</span>		<span class="cm">/* name bytes, no null */</span>
     <span class="cm">/*	__be16                  tag; */</span>		<span class="cm">/* starting offset of us */</span>
<span class="p">}</span> <span class="n">xfs_dir2_data_entry_t</span><span class="p">;</span>

<span class="cm">/*</span>
<span class="cm"> * Unused entry in a data block.</span>
<span class="cm"> *</span>
<span class="cm"> * Aligned to 8 bytes.  Tag appears as the last 2 bytes and must be accessed</span>
<span class="cm"> * using xfs_dir2_data_unused_tag_p.</span>
<span class="cm"> */</span>
<span class="k">typedef</span> <span class="k">struct</span> <span class="n">xfs_dir2_data_unused</span> <span class="p">{</span>
	<span class="n">__be16</span>			<span class="n">freetag</span><span class="p">;</span>	<span class="cm">/* XFS_DIR2_DATA_FREE_TAG */</span>
	<span class="n">__be16</span>			<span class="n">length</span><span class="p">;</span>		<span class="cm">/* total free length */</span>
						<span class="cm">/* variable offset */</span>
	<span class="n">__be16</span>			<span class="n">tag</span><span class="p">;</span>		<span class="cm">/* starting offset of us */</span>
<span class="p">}</span> <span class="n">xfs_dir2_data_unused_t</span><span class="p">;</span>

<span class="cm">/*</span>
<span class="cm"> * Size of a data entry.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">xfs_dir2_data_entsize</span><span class="p">(</span><span class="kt">int</span> <span class="n">n</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">roundup</span><span class="p">(</span><span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">xfs_dir2_data_entry</span><span class="p">,</span> <span class="n">name</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span> <span class="n">n</span> <span class="o">+</span>
		 <span class="p">(</span><span class="n">uint</span><span class="p">)</span><span class="k">sizeof</span><span class="p">(</span><span class="n">xfs_dir2_data_off_t</span><span class="p">),</span> <span class="n">XFS_DIR2_DATA_ALIGN</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Pointer to an entry&#39;s tag word.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="n">__be16</span> <span class="o">*</span>
<span class="nf">xfs_dir2_data_entry_tag_p</span><span class="p">(</span><span class="k">struct</span> <span class="n">xfs_dir2_data_entry</span> <span class="o">*</span><span class="n">dep</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">__be16</span> <span class="o">*</span><span class="p">)((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">dep</span> <span class="o">+</span>
		<span class="n">xfs_dir2_data_entsize</span><span class="p">(</span><span class="n">dep</span><span class="o">-&gt;</span><span class="n">namelen</span><span class="p">)</span> <span class="o">-</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">__be16</span><span class="p">));</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Pointer to a freespace&#39;s tag word.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="n">__be16</span> <span class="o">*</span>
<span class="nf">xfs_dir2_data_unused_tag_p</span><span class="p">(</span><span class="k">struct</span> <span class="n">xfs_dir2_data_unused</span> <span class="o">*</span><span class="n">dup</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">__be16</span> <span class="o">*</span><span class="p">)((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">dup</span> <span class="o">+</span>
			<span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">dup</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">)</span> <span class="o">-</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">__be16</span><span class="p">));</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Leaf block structures.</span>
<span class="cm"> *</span>
<span class="cm"> * A pure leaf block looks like the following drawing on disk:</span>
<span class="cm"> *</span>
<span class="cm"> *    +---------------------------+</span>
<span class="cm"> *    | xfs_dir2_leaf_hdr_t       |</span>
<span class="cm"> *    +---------------------------+</span>
<span class="cm"> *    | xfs_dir2_leaf_entry_t     |</span>
<span class="cm"> *    | xfs_dir2_leaf_entry_t     |</span>
<span class="cm"> *    | xfs_dir2_leaf_entry_t     |</span>
<span class="cm"> *    | xfs_dir2_leaf_entry_t     |</span>
<span class="cm"> *    | ...                       |</span>
<span class="cm"> *    +---------------------------+</span>
<span class="cm"> *    | xfs_dir2_data_off_t       |</span>
<span class="cm"> *    | xfs_dir2_data_off_t       |</span>
<span class="cm"> *    | xfs_dir2_data_off_t       |</span>
<span class="cm"> *    | ...                       |</span>
<span class="cm"> *    +---------------------------+</span>
<span class="cm"> *    | xfs_dir2_leaf_tail_t      |</span>
<span class="cm"> *    +---------------------------+</span>
<span class="cm"> *</span>
<span class="cm"> * The xfs_dir2_data_off_t members (bests) and tail are at the end of the block</span>
<span class="cm"> * for single-leaf (magic = XFS_DIR2_LEAF1_MAGIC) blocks only, but not present</span>
<span class="cm"> * for directories with separate leaf nodes and free space blocks</span>
<span class="cm"> * (magic = XFS_DIR2_LEAFN_MAGIC).</span>
<span class="cm"> *</span>
<span class="cm"> * As all the entries are variable size structures the accessors below should</span>
<span class="cm"> * be used to iterate over them.</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> * Offset of the leaf/node space.  First block in this space</span>
<span class="cm"> * is the btree root.</span>
<span class="cm"> */</span>
<span class="cp">#define	XFS_DIR2_LEAF_SPACE	1</span>
<span class="cp">#define	XFS_DIR2_LEAF_OFFSET	(XFS_DIR2_LEAF_SPACE * XFS_DIR2_SPACE_SIZE)</span>
<span class="cp">#define	XFS_DIR2_LEAF_FIRSTDB(mp)	\</span>
<span class="cp">	xfs_dir2_byte_to_db(mp, XFS_DIR2_LEAF_OFFSET)</span>

<span class="cm">/*</span>
<span class="cm"> * Leaf block header.</span>
<span class="cm"> */</span>
<span class="k">typedef</span> <span class="k">struct</span> <span class="n">xfs_dir2_leaf_hdr</span> <span class="p">{</span>
	<span class="n">xfs_da_blkinfo_t</span>	<span class="n">info</span><span class="p">;</span>		<span class="cm">/* header for da routines */</span>
	<span class="n">__be16</span>			<span class="n">count</span><span class="p">;</span>		<span class="cm">/* count of entries */</span>
	<span class="n">__be16</span>			<span class="n">stale</span><span class="p">;</span>		<span class="cm">/* count of stale entries */</span>
<span class="p">}</span> <span class="n">xfs_dir2_leaf_hdr_t</span><span class="p">;</span>

<span class="cm">/*</span>
<span class="cm"> * Leaf block entry.</span>
<span class="cm"> */</span>
<span class="k">typedef</span> <span class="k">struct</span> <span class="n">xfs_dir2_leaf_entry</span> <span class="p">{</span>
	<span class="n">__be32</span>			<span class="n">hashval</span><span class="p">;</span>	<span class="cm">/* hash value of name */</span>
	<span class="n">__be32</span>			<span class="n">address</span><span class="p">;</span>	<span class="cm">/* address of data entry */</span>
<span class="p">}</span> <span class="n">xfs_dir2_leaf_entry_t</span><span class="p">;</span>

<span class="cm">/*</span>
<span class="cm"> * Leaf block tail.</span>
<span class="cm"> */</span>
<span class="k">typedef</span> <span class="k">struct</span> <span class="n">xfs_dir2_leaf_tail</span> <span class="p">{</span>
	<span class="n">__be32</span>			<span class="n">bestcount</span><span class="p">;</span>
<span class="p">}</span> <span class="n">xfs_dir2_leaf_tail_t</span><span class="p">;</span>

<span class="cm">/*</span>
<span class="cm"> * Leaf block.</span>
<span class="cm"> */</span>
<span class="k">typedef</span> <span class="k">struct</span> <span class="n">xfs_dir2_leaf</span> <span class="p">{</span>
	<span class="n">xfs_dir2_leaf_hdr_t</span>	<span class="n">hdr</span><span class="p">;</span>		<span class="cm">/* leaf header */</span>
	<span class="n">xfs_dir2_leaf_entry_t</span>	<span class="n">ents</span><span class="p">[];</span>		<span class="cm">/* entries */</span>
<span class="p">}</span> <span class="n">xfs_dir2_leaf_t</span><span class="p">;</span>

<span class="cm">/*</span>
<span class="cm"> * DB blocks here are logical directory block numbers, not filesystem blocks.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">xfs_dir2_max_leaf_ents</span><span class="p">(</span><span class="k">struct</span> <span class="n">xfs_mount</span> <span class="o">*</span><span class="n">mp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_dirblksize</span> <span class="o">-</span> <span class="p">(</span><span class="n">uint</span><span class="p">)</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">xfs_dir2_leaf_hdr</span><span class="p">))</span> <span class="o">/</span>
		<span class="p">(</span><span class="n">uint</span><span class="p">)</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">xfs_dir2_leaf_entry</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Get address of the bestcount field in the single-leaf block.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="k">struct</span> <span class="n">xfs_dir2_leaf_tail</span> <span class="o">*</span>
<span class="nf">xfs_dir2_leaf_tail_p</span><span class="p">(</span><span class="k">struct</span> <span class="n">xfs_mount</span> <span class="o">*</span><span class="n">mp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">xfs_dir2_leaf</span> <span class="o">*</span><span class="n">lp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="k">struct</span> <span class="n">xfs_dir2_leaf_tail</span> <span class="o">*</span><span class="p">)</span>
		<span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">lp</span> <span class="o">+</span> <span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_dirblksize</span> <span class="o">-</span>
		  <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">xfs_dir2_leaf_tail</span><span class="p">));</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Get address of the bests array in the single-leaf block.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="n">__be16</span> <span class="o">*</span>
<span class="nf">xfs_dir2_leaf_bests_p</span><span class="p">(</span><span class="k">struct</span> <span class="n">xfs_dir2_leaf_tail</span> <span class="o">*</span><span class="n">ltp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">__be16</span> <span class="o">*</span><span class="p">)</span><span class="n">ltp</span> <span class="o">-</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">ltp</span><span class="o">-&gt;</span><span class="n">bestcount</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Convert dataptr to byte in file space</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="n">xfs_dir2_off_t</span>
<span class="nf">xfs_dir2_dataptr_to_byte</span><span class="p">(</span><span class="k">struct</span> <span class="n">xfs_mount</span> <span class="o">*</span><span class="n">mp</span><span class="p">,</span> <span class="n">xfs_dir2_dataptr_t</span> <span class="n">dp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">xfs_dir2_off_t</span><span class="p">)</span><span class="n">dp</span> <span class="o">&lt;&lt;</span> <span class="n">XFS_DIR2_DATA_ALIGN_LOG</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Convert byte in file space to dataptr.  It had better be aligned.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="n">xfs_dir2_dataptr_t</span>
<span class="nf">xfs_dir2_byte_to_dataptr</span><span class="p">(</span><span class="k">struct</span> <span class="n">xfs_mount</span> <span class="o">*</span><span class="n">mp</span><span class="p">,</span> <span class="n">xfs_dir2_off_t</span> <span class="n">by</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">xfs_dir2_dataptr_t</span><span class="p">)(</span><span class="n">by</span> <span class="o">&gt;&gt;</span> <span class="n">XFS_DIR2_DATA_ALIGN_LOG</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Convert byte in space to (DB) block</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="n">xfs_dir2_db_t</span>
<span class="nf">xfs_dir2_byte_to_db</span><span class="p">(</span><span class="k">struct</span> <span class="n">xfs_mount</span> <span class="o">*</span><span class="n">mp</span><span class="p">,</span> <span class="n">xfs_dir2_off_t</span> <span class="n">by</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">xfs_dir2_db_t</span><span class="p">)</span>
		<span class="p">(</span><span class="n">by</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_sb</span><span class="p">.</span><span class="n">sb_blocklog</span> <span class="o">+</span> <span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_sb</span><span class="p">.</span><span class="n">sb_dirblklog</span><span class="p">));</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Convert dataptr to a block number</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="n">xfs_dir2_db_t</span>
<span class="nf">xfs_dir2_dataptr_to_db</span><span class="p">(</span><span class="k">struct</span> <span class="n">xfs_mount</span> <span class="o">*</span><span class="n">mp</span><span class="p">,</span> <span class="n">xfs_dir2_dataptr_t</span> <span class="n">dp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">xfs_dir2_byte_to_db</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="n">xfs_dir2_dataptr_to_byte</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="n">dp</span><span class="p">));</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Convert byte in space to offset in a block</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="n">xfs_dir2_data_aoff_t</span>
<span class="nf">xfs_dir2_byte_to_off</span><span class="p">(</span><span class="k">struct</span> <span class="n">xfs_mount</span> <span class="o">*</span><span class="n">mp</span><span class="p">,</span> <span class="n">xfs_dir2_off_t</span> <span class="n">by</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">xfs_dir2_data_aoff_t</span><span class="p">)(</span><span class="n">by</span> <span class="o">&amp;</span>
		<span class="p">((</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_sb</span><span class="p">.</span><span class="n">sb_blocklog</span> <span class="o">+</span> <span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_sb</span><span class="p">.</span><span class="n">sb_dirblklog</span><span class="p">))</span> <span class="o">-</span> <span class="mi">1</span><span class="p">));</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Convert dataptr to a byte offset in a block</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="n">xfs_dir2_data_aoff_t</span>
<span class="nf">xfs_dir2_dataptr_to_off</span><span class="p">(</span><span class="k">struct</span> <span class="n">xfs_mount</span> <span class="o">*</span><span class="n">mp</span><span class="p">,</span> <span class="n">xfs_dir2_dataptr_t</span> <span class="n">dp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">xfs_dir2_byte_to_off</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="n">xfs_dir2_dataptr_to_byte</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="n">dp</span><span class="p">));</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Convert block and offset to byte in space</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="n">xfs_dir2_off_t</span>
<span class="nf">xfs_dir2_db_off_to_byte</span><span class="p">(</span><span class="k">struct</span> <span class="n">xfs_mount</span> <span class="o">*</span><span class="n">mp</span><span class="p">,</span> <span class="n">xfs_dir2_db_t</span> <span class="n">db</span><span class="p">,</span>
			<span class="n">xfs_dir2_data_aoff_t</span> <span class="n">o</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">((</span><span class="n">xfs_dir2_off_t</span><span class="p">)</span><span class="n">db</span> <span class="o">&lt;&lt;</span>
		<span class="p">(</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_sb</span><span class="p">.</span><span class="n">sb_blocklog</span> <span class="o">+</span> <span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_sb</span><span class="p">.</span><span class="n">sb_dirblklog</span><span class="p">))</span> <span class="o">+</span> <span class="n">o</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Convert block (DB) to block (dablk)</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="n">xfs_dablk_t</span>
<span class="nf">xfs_dir2_db_to_da</span><span class="p">(</span><span class="k">struct</span> <span class="n">xfs_mount</span> <span class="o">*</span><span class="n">mp</span><span class="p">,</span> <span class="n">xfs_dir2_db_t</span> <span class="n">db</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">xfs_dablk_t</span><span class="p">)(</span><span class="n">db</span> <span class="o">&lt;&lt;</span> <span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_sb</span><span class="p">.</span><span class="n">sb_dirblklog</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Convert byte in space to (DA) block</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="n">xfs_dablk_t</span>
<span class="nf">xfs_dir2_byte_to_da</span><span class="p">(</span><span class="k">struct</span> <span class="n">xfs_mount</span> <span class="o">*</span><span class="n">mp</span><span class="p">,</span> <span class="n">xfs_dir2_off_t</span> <span class="n">by</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">xfs_dir2_db_to_da</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="n">xfs_dir2_byte_to_db</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="n">by</span><span class="p">));</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Convert block and offset to dataptr</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="n">xfs_dir2_dataptr_t</span>
<span class="nf">xfs_dir2_db_off_to_dataptr</span><span class="p">(</span><span class="k">struct</span> <span class="n">xfs_mount</span> <span class="o">*</span><span class="n">mp</span><span class="p">,</span> <span class="n">xfs_dir2_db_t</span> <span class="n">db</span><span class="p">,</span>
			   <span class="n">xfs_dir2_data_aoff_t</span> <span class="n">o</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">xfs_dir2_byte_to_dataptr</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="n">xfs_dir2_db_off_to_byte</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="n">db</span><span class="p">,</span> <span class="n">o</span><span class="p">));</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Convert block (dablk) to block (DB)</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="n">xfs_dir2_db_t</span>
<span class="nf">xfs_dir2_da_to_db</span><span class="p">(</span><span class="k">struct</span> <span class="n">xfs_mount</span> <span class="o">*</span><span class="n">mp</span><span class="p">,</span> <span class="n">xfs_dablk_t</span> <span class="n">da</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">xfs_dir2_db_t</span><span class="p">)(</span><span class="n">da</span> <span class="o">&gt;&gt;</span> <span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_sb</span><span class="p">.</span><span class="n">sb_dirblklog</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Convert block (dablk) to byte offset in space</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="n">xfs_dir2_off_t</span>
<span class="nf">xfs_dir2_da_to_byte</span><span class="p">(</span><span class="k">struct</span> <span class="n">xfs_mount</span> <span class="o">*</span><span class="n">mp</span><span class="p">,</span> <span class="n">xfs_dablk_t</span> <span class="n">da</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">xfs_dir2_db_off_to_byte</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="n">xfs_dir2_da_to_db</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="n">da</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Free space block defintions for the node format.</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> * Offset of the freespace index.</span>
<span class="cm"> */</span>
<span class="cp">#define	XFS_DIR2_FREE_SPACE	2</span>
<span class="cp">#define	XFS_DIR2_FREE_OFFSET	(XFS_DIR2_FREE_SPACE * XFS_DIR2_SPACE_SIZE)</span>
<span class="cp">#define	XFS_DIR2_FREE_FIRSTDB(mp)	\</span>
<span class="cp">	xfs_dir2_byte_to_db(mp, XFS_DIR2_FREE_OFFSET)</span>

<span class="k">typedef</span>	<span class="k">struct</span> <span class="n">xfs_dir2_free_hdr</span> <span class="p">{</span>
	<span class="n">__be32</span>			<span class="n">magic</span><span class="p">;</span>		<span class="cm">/* XFS_DIR2_FREE_MAGIC */</span>
	<span class="n">__be32</span>			<span class="n">firstdb</span><span class="p">;</span>	<span class="cm">/* db of first entry */</span>
	<span class="n">__be32</span>			<span class="n">nvalid</span><span class="p">;</span>		<span class="cm">/* count of valid entries */</span>
	<span class="n">__be32</span>			<span class="n">nused</span><span class="p">;</span>		<span class="cm">/* count of used entries */</span>
<span class="p">}</span> <span class="n">xfs_dir2_free_hdr_t</span><span class="p">;</span>

<span class="k">typedef</span> <span class="k">struct</span> <span class="n">xfs_dir2_free</span> <span class="p">{</span>
	<span class="n">xfs_dir2_free_hdr_t</span>	<span class="n">hdr</span><span class="p">;</span>		<span class="cm">/* block header */</span>
	<span class="n">__be16</span>			<span class="n">bests</span><span class="p">[];</span>	<span class="cm">/* best free counts */</span>
						<span class="cm">/* unused entries are -1 */</span>
<span class="p">}</span> <span class="n">xfs_dir2_free_t</span><span class="p">;</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">xfs_dir2_free_max_bests</span><span class="p">(</span><span class="k">struct</span> <span class="n">xfs_mount</span> <span class="o">*</span><span class="n">mp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_dirblksize</span> <span class="o">-</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">xfs_dir2_free_hdr</span><span class="p">))</span> <span class="o">/</span>
		<span class="k">sizeof</span><span class="p">(</span><span class="n">xfs_dir2_data_off_t</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Convert data space db to the corresponding free db.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="n">xfs_dir2_db_t</span>
<span class="nf">xfs_dir2_db_to_fdb</span><span class="p">(</span><span class="k">struct</span> <span class="n">xfs_mount</span> <span class="o">*</span><span class="n">mp</span><span class="p">,</span> <span class="n">xfs_dir2_db_t</span> <span class="n">db</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">XFS_DIR2_FREE_FIRSTDB</span><span class="p">(</span><span class="n">mp</span><span class="p">)</span> <span class="o">+</span> <span class="n">db</span> <span class="o">/</span> <span class="n">xfs_dir2_free_max_bests</span><span class="p">(</span><span class="n">mp</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Convert data space db to the corresponding index in a free db.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span>
<span class="nf">xfs_dir2_db_to_fdindex</span><span class="p">(</span><span class="k">struct</span> <span class="n">xfs_mount</span> <span class="o">*</span><span class="n">mp</span><span class="p">,</span> <span class="n">xfs_dir2_db_t</span> <span class="n">db</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">db</span> <span class="o">%</span> <span class="n">xfs_dir2_free_max_bests</span><span class="p">(</span><span class="n">mp</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Single block format.</span>
<span class="cm"> *</span>
<span class="cm"> * The single block format looks like the following drawing on disk:</span>
<span class="cm"> *</span>
<span class="cm"> *    +-------------------------------------------------+</span>
<span class="cm"> *    | xfs_dir2_data_hdr_t                             |</span>
<span class="cm"> *    +-------------------------------------------------+</span>
<span class="cm"> *    | xfs_dir2_data_entry_t OR xfs_dir2_data_unused_t |</span>
<span class="cm"> *    | xfs_dir2_data_entry_t OR xfs_dir2_data_unused_t |</span>
<span class="cm"> *    | xfs_dir2_data_entry_t OR xfs_dir2_data_unused_t :</span>
<span class="cm"> *    | ...                                             |</span>
<span class="cm"> *    +-------------------------------------------------+</span>
<span class="cm"> *    | unused space                                    |</span>
<span class="cm"> *    +-------------------------------------------------+</span>
<span class="cm"> *    | ...                                             |</span>
<span class="cm"> *    | xfs_dir2_leaf_entry_t                           |</span>
<span class="cm"> *    | xfs_dir2_leaf_entry_t                           |</span>
<span class="cm"> *    +-------------------------------------------------+</span>
<span class="cm"> *    | xfs_dir2_block_tail_t                           |</span>
<span class="cm"> *    +-------------------------------------------------+</span>
<span class="cm"> *</span>
<span class="cm"> * As all the entries are variable size structures the accessors below should</span>
<span class="cm"> * be used to iterate over them.</span>
<span class="cm"> */</span>

<span class="k">typedef</span> <span class="k">struct</span> <span class="n">xfs_dir2_block_tail</span> <span class="p">{</span>
	<span class="n">__be32</span>		<span class="n">count</span><span class="p">;</span>			<span class="cm">/* count of leaf entries */</span>
	<span class="n">__be32</span>		<span class="n">stale</span><span class="p">;</span>			<span class="cm">/* count of stale lf entries */</span>
<span class="p">}</span> <span class="n">xfs_dir2_block_tail_t</span><span class="p">;</span>

<span class="cm">/*</span>
<span class="cm"> * Pointer to the leaf header embedded in a data block (1-block format)</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="k">struct</span> <span class="n">xfs_dir2_block_tail</span> <span class="o">*</span>
<span class="nf">xfs_dir2_block_tail_p</span><span class="p">(</span><span class="k">struct</span> <span class="n">xfs_mount</span> <span class="o">*</span><span class="n">mp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">xfs_dir2_data_hdr</span> <span class="o">*</span><span class="n">hdr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">((</span><span class="k">struct</span> <span class="n">xfs_dir2_block_tail</span> <span class="o">*</span><span class="p">)</span>
		<span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">hdr</span> <span class="o">+</span> <span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_dirblksize</span><span class="p">))</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Pointer to the leaf entries embedded in a data block (1-block format)</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="k">struct</span> <span class="n">xfs_dir2_leaf_entry</span> <span class="o">*</span>
<span class="nf">xfs_dir2_block_leaf_p</span><span class="p">(</span><span class="k">struct</span> <span class="n">xfs_dir2_block_tail</span> <span class="o">*</span><span class="n">btp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">((</span><span class="k">struct</span> <span class="n">xfs_dir2_leaf_entry</span> <span class="o">*</span><span class="p">)</span><span class="n">btp</span><span class="p">)</span> <span class="o">-</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">btp</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#endif </span><span class="cm">/* __XFS_DIR2_FORMAT_H__ */</span><span class="cp"></span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
