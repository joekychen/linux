<!DOCTYPE html>
<html><head><title>joekychen/linux » fs › xfs › xfs_dir2_data.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>xfs_dir2_data.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Copyright (c) 2000-2002,2005 Silicon Graphics, Inc.</span>
<span class="cm"> * All Rights Reserved.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or</span>
<span class="cm"> * modify it under the terms of the GNU General Public License as</span>
<span class="cm"> * published by the Free Software Foundation.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is distributed in the hope that it would be useful,</span>
<span class="cm"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm"> * GNU General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> * You should have received a copy of the GNU General Public License</span>
<span class="cm"> * along with this program; if not, write the Free Software Foundation,</span>
<span class="cm"> * Inc.,  51 Franklin St, Fifth Floor, Boston, MA  02110-1301  USA</span>
<span class="cm"> */</span>
<span class="cp">#include &quot;xfs.h&quot;</span>
<span class="cp">#include &quot;xfs_fs.h&quot;</span>
<span class="cp">#include &quot;xfs_types.h&quot;</span>
<span class="cp">#include &quot;xfs_log.h&quot;</span>
<span class="cp">#include &quot;xfs_trans.h&quot;</span>
<span class="cp">#include &quot;xfs_sb.h&quot;</span>
<span class="cp">#include &quot;xfs_ag.h&quot;</span>
<span class="cp">#include &quot;xfs_mount.h&quot;</span>
<span class="cp">#include &quot;xfs_da_btree.h&quot;</span>
<span class="cp">#include &quot;xfs_bmap_btree.h&quot;</span>
<span class="cp">#include &quot;xfs_dinode.h&quot;</span>
<span class="cp">#include &quot;xfs_inode.h&quot;</span>
<span class="cp">#include &quot;xfs_dir2_format.h&quot;</span>
<span class="cp">#include &quot;xfs_dir2_priv.h&quot;</span>
<span class="cp">#include &quot;xfs_error.h&quot;</span>

<span class="n">STATIC</span> <span class="n">xfs_dir2_data_free_t</span> <span class="o">*</span>
<span class="n">xfs_dir2_data_freefind</span><span class="p">(</span><span class="n">xfs_dir2_data_hdr_t</span> <span class="o">*</span><span class="n">hdr</span><span class="p">,</span> <span class="n">xfs_dir2_data_unused_t</span> <span class="o">*</span><span class="n">dup</span><span class="p">);</span>

<span class="cp">#ifdef DEBUG</span>
<span class="cm">/*</span>
<span class="cm"> * Check the consistency of the data block.</span>
<span class="cm"> * The input can also be a block-format directory.</span>
<span class="cm"> * Pop an assert if we find anything bad.</span>
<span class="cm"> */</span>
<span class="kt">void</span>
<span class="nf">xfs_dir2_data_check</span><span class="p">(</span>
	<span class="n">xfs_inode_t</span>		<span class="o">*</span><span class="n">dp</span><span class="p">,</span>		<span class="cm">/* incore inode pointer */</span>
	<span class="n">xfs_dabuf_t</span>		<span class="o">*</span><span class="n">bp</span><span class="p">)</span>		<span class="cm">/* data block&#39;s buffer */</span>
<span class="p">{</span>
	<span class="n">xfs_dir2_dataptr_t</span>	<span class="n">addr</span><span class="p">;</span>		<span class="cm">/* addr for leaf lookup */</span>
	<span class="n">xfs_dir2_data_free_t</span>	<span class="o">*</span><span class="n">bf</span><span class="p">;</span>		<span class="cm">/* bestfree table */</span>
	<span class="n">xfs_dir2_block_tail_t</span>	<span class="o">*</span><span class="n">btp</span><span class="o">=</span><span class="nb">NULL</span><span class="p">;</span>	<span class="cm">/* block tail */</span>
	<span class="kt">int</span>			<span class="n">count</span><span class="p">;</span>		<span class="cm">/* count of entries found */</span>
	<span class="n">xfs_dir2_data_hdr_t</span>	<span class="o">*</span><span class="n">hdr</span><span class="p">;</span>		<span class="cm">/* data block header */</span>
	<span class="n">xfs_dir2_data_entry_t</span>	<span class="o">*</span><span class="n">dep</span><span class="p">;</span>		<span class="cm">/* data entry */</span>
	<span class="n">xfs_dir2_data_free_t</span>	<span class="o">*</span><span class="n">dfp</span><span class="p">;</span>		<span class="cm">/* bestfree entry */</span>
	<span class="n">xfs_dir2_data_unused_t</span>	<span class="o">*</span><span class="n">dup</span><span class="p">;</span>		<span class="cm">/* unused entry */</span>
	<span class="kt">char</span>			<span class="o">*</span><span class="n">endp</span><span class="p">;</span>		<span class="cm">/* end of useful data */</span>
	<span class="kt">int</span>			<span class="n">freeseen</span><span class="p">;</span>	<span class="cm">/* mask of bestfrees seen */</span>
	<span class="n">xfs_dahash_t</span>		<span class="n">hash</span><span class="p">;</span>		<span class="cm">/* hash of current name */</span>
	<span class="kt">int</span>			<span class="n">i</span><span class="p">;</span>		<span class="cm">/* leaf index */</span>
	<span class="kt">int</span>			<span class="n">lastfree</span><span class="p">;</span>	<span class="cm">/* last entry was unused */</span>
	<span class="n">xfs_dir2_leaf_entry_t</span>	<span class="o">*</span><span class="n">lep</span><span class="o">=</span><span class="nb">NULL</span><span class="p">;</span>	<span class="cm">/* block leaf entries */</span>
	<span class="n">xfs_mount_t</span>		<span class="o">*</span><span class="n">mp</span><span class="p">;</span>		<span class="cm">/* filesystem mount point */</span>
	<span class="kt">char</span>			<span class="o">*</span><span class="n">p</span><span class="p">;</span>		<span class="cm">/* current data position */</span>
	<span class="kt">int</span>			<span class="n">stale</span><span class="p">;</span>		<span class="cm">/* count of stale leaves */</span>
	<span class="k">struct</span> <span class="n">xfs_name</span>		<span class="n">name</span><span class="p">;</span>

	<span class="n">mp</span> <span class="o">=</span> <span class="n">dp</span><span class="o">-&gt;</span><span class="n">i_mount</span><span class="p">;</span>
	<span class="n">hdr</span> <span class="o">=</span> <span class="n">bp</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="n">bf</span> <span class="o">=</span> <span class="n">hdr</span><span class="o">-&gt;</span><span class="n">bestfree</span><span class="p">;</span>
	<span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)(</span><span class="n">hdr</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">magic</span> <span class="o">==</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">XFS_DIR2_BLOCK_MAGIC</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">btp</span> <span class="o">=</span> <span class="n">xfs_dir2_block_tail_p</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="n">hdr</span><span class="p">);</span>
		<span class="n">lep</span> <span class="o">=</span> <span class="n">xfs_dir2_block_leaf_p</span><span class="p">(</span><span class="n">btp</span><span class="p">);</span>
		<span class="n">endp</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">lep</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ASSERT</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">magic</span> <span class="o">==</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">XFS_DIR2_DATA_MAGIC</span><span class="p">));</span>
		<span class="n">endp</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">hdr</span> <span class="o">+</span> <span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_dirblksize</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">count</span> <span class="o">=</span> <span class="n">lastfree</span> <span class="o">=</span> <span class="n">freeseen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * Account for zero bestfree entries.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bf</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">length</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ASSERT</span><span class="p">(</span><span class="o">!</span><span class="n">bf</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">offset</span><span class="p">);</span>
		<span class="n">freeseen</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bf</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">length</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ASSERT</span><span class="p">(</span><span class="o">!</span><span class="n">bf</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">offset</span><span class="p">);</span>
		<span class="n">freeseen</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bf</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">length</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ASSERT</span><span class="p">(</span><span class="o">!</span><span class="n">bf</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">offset</span><span class="p">);</span>
		<span class="n">freeseen</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ASSERT</span><span class="p">(</span><span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">bf</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">length</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">bf</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">length</span><span class="p">));</span>
	<span class="n">ASSERT</span><span class="p">(</span><span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">bf</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">length</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">bf</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">length</span><span class="p">));</span>
	<span class="cm">/*</span>
<span class="cm">	 * Loop over the data/unused entries.</span>
<span class="cm">	 */</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">p</span> <span class="o">&lt;</span> <span class="n">endp</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dup</span> <span class="o">=</span> <span class="p">(</span><span class="n">xfs_dir2_data_unused_t</span> <span class="o">*</span><span class="p">)</span><span class="n">p</span><span class="p">;</span>
		<span class="cm">/*</span>
<span class="cm">		 * If it&#39;s unused, look for the space in the bestfree table.</span>
<span class="cm">		 * If we find it, account for that, else make sure it</span>
<span class="cm">		 * doesn&#39;t need to be there.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">dup</span><span class="o">-&gt;</span><span class="n">freetag</span><span class="p">)</span> <span class="o">==</span> <span class="n">XFS_DIR2_DATA_FREE_TAG</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ASSERT</span><span class="p">(</span><span class="n">lastfree</span> <span class="o">==</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">ASSERT</span><span class="p">(</span><span class="n">be16_to_cpu</span><span class="p">(</span><span class="o">*</span><span class="n">xfs_dir2_data_unused_tag_p</span><span class="p">(</span><span class="n">dup</span><span class="p">))</span> <span class="o">==</span>
			       <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">dup</span> <span class="o">-</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">hdr</span><span class="p">);</span>
			<span class="n">dfp</span> <span class="o">=</span> <span class="n">xfs_dir2_data_freefind</span><span class="p">(</span><span class="n">hdr</span><span class="p">,</span> <span class="n">dup</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">dfp</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">i</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)(</span><span class="n">dfp</span> <span class="o">-</span> <span class="n">bf</span><span class="p">);</span>
				<span class="n">ASSERT</span><span class="p">((</span><span class="n">freeseen</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">);</span>
				<span class="n">freeseen</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">ASSERT</span><span class="p">(</span><span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">dup</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">)</span> <span class="o">&lt;=</span>
				       <span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">bf</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">length</span><span class="p">));</span>
			<span class="p">}</span>
			<span class="n">p</span> <span class="o">+=</span> <span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">dup</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">);</span>
			<span class="n">lastfree</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/*</span>
<span class="cm">		 * It&#39;s a real entry.  Validate the fields.</span>
<span class="cm">		 * If this is a block directory then make sure it&#39;s</span>
<span class="cm">		 * in the leaf section of the block.</span>
<span class="cm">		 * The linear search is crude but this is DEBUG code.</span>
<span class="cm">		 */</span>
		<span class="n">dep</span> <span class="o">=</span> <span class="p">(</span><span class="n">xfs_dir2_data_entry_t</span> <span class="o">*</span><span class="p">)</span><span class="n">p</span><span class="p">;</span>
		<span class="n">ASSERT</span><span class="p">(</span><span class="n">dep</span><span class="o">-&gt;</span><span class="n">namelen</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">ASSERT</span><span class="p">(</span><span class="n">xfs_dir_ino_validate</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="n">be64_to_cpu</span><span class="p">(</span><span class="n">dep</span><span class="o">-&gt;</span><span class="n">inumber</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">ASSERT</span><span class="p">(</span><span class="n">be16_to_cpu</span><span class="p">(</span><span class="o">*</span><span class="n">xfs_dir2_data_entry_tag_p</span><span class="p">(</span><span class="n">dep</span><span class="p">))</span> <span class="o">==</span>
		       <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">dep</span> <span class="o">-</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">hdr</span><span class="p">);</span>
		<span class="n">count</span><span class="o">++</span><span class="p">;</span>
		<span class="n">lastfree</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">magic</span> <span class="o">==</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">XFS_DIR2_BLOCK_MAGIC</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">addr</span> <span class="o">=</span> <span class="n">xfs_dir2_db_off_to_dataptr</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_dirdatablk</span><span class="p">,</span>
				<span class="p">(</span><span class="n">xfs_dir2_data_aoff_t</span><span class="p">)</span>
				<span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">dep</span> <span class="o">-</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">hdr</span><span class="p">));</span>
			<span class="n">name</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">dep</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">;</span>
			<span class="n">name</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="n">dep</span><span class="o">-&gt;</span><span class="n">namelen</span><span class="p">;</span>
			<span class="n">hash</span> <span class="o">=</span> <span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_dirnameops</span><span class="o">-&gt;</span><span class="n">hashname</span><span class="p">(</span><span class="o">&amp;</span><span class="n">name</span><span class="p">);</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">btp</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">lep</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">address</span><span class="p">)</span> <span class="o">==</span> <span class="n">addr</span> <span class="o">&amp;&amp;</span>
				    <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">lep</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">hashval</span><span class="p">)</span> <span class="o">==</span> <span class="n">hash</span><span class="p">)</span>
					<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">ASSERT</span><span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">btp</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">));</span>
		<span class="p">}</span>
		<span class="n">p</span> <span class="o">+=</span> <span class="n">xfs_dir2_data_entsize</span><span class="p">(</span><span class="n">dep</span><span class="o">-&gt;</span><span class="n">namelen</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="cm">/*</span>
<span class="cm">	 * Need to have seen all the entries and all the bestfree slots.</span>
<span class="cm">	 */</span>
	<span class="n">ASSERT</span><span class="p">(</span><span class="n">freeseen</span> <span class="o">==</span> <span class="mi">7</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">magic</span> <span class="o">==</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">XFS_DIR2_BLOCK_MAGIC</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">stale</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">btp</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">lep</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">address</span> <span class="o">==</span>
			    <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">XFS_DIR2_NULL_DATAPTR</span><span class="p">))</span>
				<span class="n">stale</span><span class="o">++</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">ASSERT</span><span class="p">(</span><span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">lep</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">hashval</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">lep</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">].</span><span class="n">hashval</span><span class="p">));</span>
		<span class="p">}</span>
		<span class="n">ASSERT</span><span class="p">(</span><span class="n">count</span> <span class="o">==</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">btp</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">)</span> <span class="o">-</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">btp</span><span class="o">-&gt;</span><span class="n">stale</span><span class="p">));</span>
		<span class="n">ASSERT</span><span class="p">(</span><span class="n">stale</span> <span class="o">==</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">btp</span><span class="o">-&gt;</span><span class="n">stale</span><span class="p">));</span>
	<span class="p">}</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="cm">/*</span>
<span class="cm"> * Given a data block and an unused entry from that block,</span>
<span class="cm"> * return the bestfree entry if any that corresponds to it.</span>
<span class="cm"> */</span>
<span class="n">STATIC</span> <span class="n">xfs_dir2_data_free_t</span> <span class="o">*</span>
<span class="nf">xfs_dir2_data_freefind</span><span class="p">(</span>
	<span class="n">xfs_dir2_data_hdr_t</span>	<span class="o">*</span><span class="n">hdr</span><span class="p">,</span>		<span class="cm">/* data block */</span>
	<span class="n">xfs_dir2_data_unused_t</span>	<span class="o">*</span><span class="n">dup</span><span class="p">)</span>		<span class="cm">/* data unused entry */</span>
<span class="p">{</span>
	<span class="n">xfs_dir2_data_free_t</span>	<span class="o">*</span><span class="n">dfp</span><span class="p">;</span>		<span class="cm">/* bestfree entry */</span>
	<span class="n">xfs_dir2_data_aoff_t</span>	<span class="n">off</span><span class="p">;</span>		<span class="cm">/* offset value needed */</span>
<span class="cp">#if defined(DEBUG) &amp;&amp; defined(__KERNEL__)</span>
	<span class="kt">int</span>			<span class="n">matched</span><span class="p">;</span>	<span class="cm">/* matched the value */</span>
	<span class="kt">int</span>			<span class="n">seenzero</span><span class="p">;</span>	<span class="cm">/* saw a 0 bestfree entry */</span>
<span class="cp">#endif</span>

	<span class="n">off</span> <span class="o">=</span> <span class="p">(</span><span class="n">xfs_dir2_data_aoff_t</span><span class="p">)((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">dup</span> <span class="o">-</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">hdr</span><span class="p">);</span>
<span class="cp">#if defined(DEBUG) &amp;&amp; defined(__KERNEL__)</span>
	<span class="cm">/*</span>
<span class="cm">	 * Validate some consistency in the bestfree table.</span>
<span class="cm">	 * Check order, non-overlapping entries, and if we find the</span>
<span class="cm">	 * one we&#39;re looking for it has to be exact.</span>
<span class="cm">	 */</span>
	<span class="n">ASSERT</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">magic</span> <span class="o">==</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">XFS_DIR2_DATA_MAGIC</span><span class="p">)</span> <span class="o">||</span>
	       <span class="n">hdr</span><span class="o">-&gt;</span><span class="n">magic</span> <span class="o">==</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">XFS_DIR2_BLOCK_MAGIC</span><span class="p">));</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">dfp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">bestfree</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">seenzero</span> <span class="o">=</span> <span class="n">matched</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	     <span class="n">dfp</span> <span class="o">&lt;</span> <span class="o">&amp;</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">bestfree</span><span class="p">[</span><span class="n">XFS_DIR2_DATA_FD_COUNT</span><span class="p">];</span>
	     <span class="n">dfp</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dfp</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ASSERT</span><span class="p">(</span><span class="o">!</span><span class="n">dfp</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">);</span>
			<span class="n">seenzero</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">ASSERT</span><span class="p">(</span><span class="n">seenzero</span> <span class="o">==</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">dfp</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">)</span> <span class="o">==</span> <span class="n">off</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">matched</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">ASSERT</span><span class="p">(</span><span class="n">dfp</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">==</span> <span class="n">dup</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">off</span> <span class="o">&lt;</span> <span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">dfp</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">))</span>
			<span class="n">ASSERT</span><span class="p">(</span><span class="n">off</span> <span class="o">+</span> <span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">dup</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">dfp</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">));</span>
		<span class="k">else</span>
			<span class="n">ASSERT</span><span class="p">(</span><span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">dfp</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">)</span> <span class="o">+</span> <span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">dfp</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">off</span><span class="p">);</span>
		<span class="n">ASSERT</span><span class="p">(</span><span class="n">matched</span> <span class="o">||</span> <span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">dfp</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">dup</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dfp</span> <span class="o">&gt;</span> <span class="o">&amp;</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">bestfree</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
			<span class="n">ASSERT</span><span class="p">(</span><span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">dfp</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">].</span><span class="n">length</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">dfp</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">length</span><span class="p">));</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
	<span class="cm">/*</span>
<span class="cm">	 * If this is smaller than the smallest bestfree entry,</span>
<span class="cm">	 * it can&#39;t be there since they&#39;re sorted.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">dup</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">)</span> <span class="o">&lt;</span>
	    <span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">bestfree</span><span class="p">[</span><span class="n">XFS_DIR2_DATA_FD_COUNT</span> <span class="o">-</span> <span class="mi">1</span><span class="p">].</span><span class="n">length</span><span class="p">))</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * Look at the three bestfree entries for our guy.</span>
<span class="cm">	 */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">dfp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">bestfree</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	     <span class="n">dfp</span> <span class="o">&lt;</span> <span class="o">&amp;</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">bestfree</span><span class="p">[</span><span class="n">XFS_DIR2_DATA_FD_COUNT</span><span class="p">];</span>
	     <span class="n">dfp</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dfp</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">)</span>
			<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">dfp</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">)</span> <span class="o">==</span> <span class="n">off</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">dfp</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/*</span>
<span class="cm">	 * Didn&#39;t find it.  This only happens if there are duplicate lengths.</span>
<span class="cm">	 */</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Insert an unused-space entry into the bestfree table.</span>
<span class="cm"> */</span>
<span class="n">xfs_dir2_data_free_t</span> <span class="o">*</span>				<span class="cm">/* entry inserted */</span>
<span class="n">xfs_dir2_data_freeinsert</span><span class="p">(</span>
	<span class="n">xfs_dir2_data_hdr_t</span>	<span class="o">*</span><span class="n">hdr</span><span class="p">,</span>		<span class="cm">/* data block pointer */</span>
	<span class="n">xfs_dir2_data_unused_t</span>	<span class="o">*</span><span class="n">dup</span><span class="p">,</span>		<span class="cm">/* unused space */</span>
	<span class="kt">int</span>			<span class="o">*</span><span class="n">loghead</span><span class="p">)</span>	<span class="cm">/* log the data header (out) */</span>
<span class="p">{</span>
	<span class="n">xfs_dir2_data_free_t</span>	<span class="o">*</span><span class="n">dfp</span><span class="p">;</span>		<span class="cm">/* bestfree table pointer */</span>
	<span class="n">xfs_dir2_data_free_t</span>	<span class="n">new</span><span class="p">;</span>		<span class="cm">/* new bestfree entry */</span>

<span class="cp">#ifdef __KERNEL__</span>
	<span class="n">ASSERT</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">magic</span> <span class="o">==</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">XFS_DIR2_DATA_MAGIC</span><span class="p">)</span> <span class="o">||</span>
	       <span class="n">hdr</span><span class="o">-&gt;</span><span class="n">magic</span> <span class="o">==</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">XFS_DIR2_BLOCK_MAGIC</span><span class="p">));</span>
<span class="cp">#endif</span>
	<span class="n">dfp</span> <span class="o">=</span> <span class="n">hdr</span><span class="o">-&gt;</span><span class="n">bestfree</span><span class="p">;</span>
	<span class="n">new</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="n">dup</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">;</span>
	<span class="n">new</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="n">cpu_to_be16</span><span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">dup</span> <span class="o">-</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">hdr</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Insert at position 0, 1, or 2; or not at all.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">new</span><span class="p">.</span><span class="n">length</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">dfp</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">length</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dfp</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">dfp</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
		<span class="n">dfp</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">dfp</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
		<span class="n">dfp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">new</span><span class="p">;</span>
		<span class="o">*</span><span class="n">loghead</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">return</span> <span class="o">&amp;</span><span class="n">dfp</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">new</span><span class="p">.</span><span class="n">length</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">dfp</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">length</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dfp</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">dfp</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
		<span class="n">dfp</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">new</span><span class="p">;</span>
		<span class="o">*</span><span class="n">loghead</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">return</span> <span class="o">&amp;</span><span class="n">dfp</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">new</span><span class="p">.</span><span class="n">length</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">dfp</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">length</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dfp</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">new</span><span class="p">;</span>
		<span class="o">*</span><span class="n">loghead</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">return</span> <span class="o">&amp;</span><span class="n">dfp</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Remove a bestfree entry from the table.</span>
<span class="cm"> */</span>
<span class="n">STATIC</span> <span class="kt">void</span>
<span class="n">xfs_dir2_data_freeremove</span><span class="p">(</span>
	<span class="n">xfs_dir2_data_hdr_t</span>	<span class="o">*</span><span class="n">hdr</span><span class="p">,</span>		<span class="cm">/* data block header */</span>
	<span class="n">xfs_dir2_data_free_t</span>	<span class="o">*</span><span class="n">dfp</span><span class="p">,</span>		<span class="cm">/* bestfree entry pointer */</span>
	<span class="kt">int</span>			<span class="o">*</span><span class="n">loghead</span><span class="p">)</span>	<span class="cm">/* out: log data header */</span>
<span class="p">{</span>
<span class="cp">#ifdef __KERNEL__</span>
	<span class="n">ASSERT</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">magic</span> <span class="o">==</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">XFS_DIR2_DATA_MAGIC</span><span class="p">)</span> <span class="o">||</span>
	       <span class="n">hdr</span><span class="o">-&gt;</span><span class="n">magic</span> <span class="o">==</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">XFS_DIR2_BLOCK_MAGIC</span><span class="p">));</span>
<span class="cp">#endif</span>
	<span class="cm">/*</span>
<span class="cm">	 * It&#39;s the first entry, slide the next 2 up.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dfp</span> <span class="o">==</span> <span class="o">&amp;</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">bestfree</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">{</span>
		<span class="n">hdr</span><span class="o">-&gt;</span><span class="n">bestfree</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">hdr</span><span class="o">-&gt;</span><span class="n">bestfree</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
		<span class="n">hdr</span><span class="o">-&gt;</span><span class="n">bestfree</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">hdr</span><span class="o">-&gt;</span><span class="n">bestfree</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="p">}</span>
	<span class="cm">/*</span>
<span class="cm">	 * It&#39;s the second entry, slide the 3rd entry up.</span>
<span class="cm">	 */</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">dfp</span> <span class="o">==</span> <span class="o">&amp;</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">bestfree</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
		<span class="n">hdr</span><span class="o">-&gt;</span><span class="n">bestfree</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">hdr</span><span class="o">-&gt;</span><span class="n">bestfree</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="cm">/*</span>
<span class="cm">	 * Must be the last entry.</span>
<span class="cm">	 */</span>
	<span class="k">else</span>
		<span class="n">ASSERT</span><span class="p">(</span><span class="n">dfp</span> <span class="o">==</span> <span class="o">&amp;</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">bestfree</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
	<span class="cm">/*</span>
<span class="cm">	 * Clear the 3rd entry, must be zero now.</span>
<span class="cm">	 */</span>
	<span class="n">hdr</span><span class="o">-&gt;</span><span class="n">bestfree</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">hdr</span><span class="o">-&gt;</span><span class="n">bestfree</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="o">*</span><span class="n">loghead</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Given a data block, reconstruct its bestfree map.</span>
<span class="cm"> */</span>
<span class="kt">void</span>
<span class="n">xfs_dir2_data_freescan</span><span class="p">(</span>
	<span class="n">xfs_mount_t</span>		<span class="o">*</span><span class="n">mp</span><span class="p">,</span>		<span class="cm">/* filesystem mount point */</span>
	<span class="n">xfs_dir2_data_hdr_t</span>	<span class="o">*</span><span class="n">hdr</span><span class="p">,</span>		<span class="cm">/* data block header */</span>
	<span class="kt">int</span>			<span class="o">*</span><span class="n">loghead</span><span class="p">)</span>	<span class="cm">/* out: log data header */</span>
<span class="p">{</span>
	<span class="n">xfs_dir2_block_tail_t</span>	<span class="o">*</span><span class="n">btp</span><span class="p">;</span>		<span class="cm">/* block tail */</span>
	<span class="n">xfs_dir2_data_entry_t</span>	<span class="o">*</span><span class="n">dep</span><span class="p">;</span>		<span class="cm">/* active data entry */</span>
	<span class="n">xfs_dir2_data_unused_t</span>	<span class="o">*</span><span class="n">dup</span><span class="p">;</span>		<span class="cm">/* unused data entry */</span>
	<span class="kt">char</span>			<span class="o">*</span><span class="n">endp</span><span class="p">;</span>		<span class="cm">/* end of block&#39;s data */</span>
	<span class="kt">char</span>			<span class="o">*</span><span class="n">p</span><span class="p">;</span>		<span class="cm">/* current entry pointer */</span>

<span class="cp">#ifdef __KERNEL__</span>
	<span class="n">ASSERT</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">magic</span> <span class="o">==</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">XFS_DIR2_DATA_MAGIC</span><span class="p">)</span> <span class="o">||</span>
	       <span class="n">hdr</span><span class="o">-&gt;</span><span class="n">magic</span> <span class="o">==</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">XFS_DIR2_BLOCK_MAGIC</span><span class="p">));</span>
<span class="cp">#endif</span>
	<span class="cm">/*</span>
<span class="cm">	 * Start by clearing the table.</span>
<span class="cm">	 */</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">bestfree</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">bestfree</span><span class="p">));</span>
	<span class="o">*</span><span class="n">loghead</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * Set up pointers.</span>
<span class="cm">	 */</span>
	<span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)(</span><span class="n">hdr</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">magic</span> <span class="o">==</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">XFS_DIR2_BLOCK_MAGIC</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">btp</span> <span class="o">=</span> <span class="n">xfs_dir2_block_tail_p</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="n">hdr</span><span class="p">);</span>
		<span class="n">endp</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">xfs_dir2_block_leaf_p</span><span class="p">(</span><span class="n">btp</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">endp</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">hdr</span> <span class="o">+</span> <span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_dirblksize</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * Loop over the block&#39;s entries.</span>
<span class="cm">	 */</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">p</span> <span class="o">&lt;</span> <span class="n">endp</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dup</span> <span class="o">=</span> <span class="p">(</span><span class="n">xfs_dir2_data_unused_t</span> <span class="o">*</span><span class="p">)</span><span class="n">p</span><span class="p">;</span>
		<span class="cm">/*</span>
<span class="cm">		 * If it&#39;s a free entry, insert it.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">dup</span><span class="o">-&gt;</span><span class="n">freetag</span><span class="p">)</span> <span class="o">==</span> <span class="n">XFS_DIR2_DATA_FREE_TAG</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ASSERT</span><span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">dup</span> <span class="o">-</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">hdr</span> <span class="o">==</span>
			       <span class="n">be16_to_cpu</span><span class="p">(</span><span class="o">*</span><span class="n">xfs_dir2_data_unused_tag_p</span><span class="p">(</span><span class="n">dup</span><span class="p">)));</span>
			<span class="n">xfs_dir2_data_freeinsert</span><span class="p">(</span><span class="n">hdr</span><span class="p">,</span> <span class="n">dup</span><span class="p">,</span> <span class="n">loghead</span><span class="p">);</span>
			<span class="n">p</span> <span class="o">+=</span> <span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">dup</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="cm">/*</span>
<span class="cm">		 * For active entries, check their tags and skip them.</span>
<span class="cm">		 */</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="n">dep</span> <span class="o">=</span> <span class="p">(</span><span class="n">xfs_dir2_data_entry_t</span> <span class="o">*</span><span class="p">)</span><span class="n">p</span><span class="p">;</span>
			<span class="n">ASSERT</span><span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">dep</span> <span class="o">-</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">hdr</span> <span class="o">==</span>
			       <span class="n">be16_to_cpu</span><span class="p">(</span><span class="o">*</span><span class="n">xfs_dir2_data_entry_tag_p</span><span class="p">(</span><span class="n">dep</span><span class="p">)));</span>
			<span class="n">p</span> <span class="o">+=</span> <span class="n">xfs_dir2_data_entsize</span><span class="p">(</span><span class="n">dep</span><span class="o">-&gt;</span><span class="n">namelen</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Initialize a data block at the given block number in the directory.</span>
<span class="cm"> * Give back the buffer for the created block.</span>
<span class="cm"> */</span>
<span class="kt">int</span>						<span class="cm">/* error */</span>
<span class="n">xfs_dir2_data_init</span><span class="p">(</span>
	<span class="n">xfs_da_args_t</span>		<span class="o">*</span><span class="n">args</span><span class="p">,</span>		<span class="cm">/* directory operation args */</span>
	<span class="n">xfs_dir2_db_t</span>		<span class="n">blkno</span><span class="p">,</span>		<span class="cm">/* logical dir block number */</span>
	<span class="n">xfs_dabuf_t</span>		<span class="o">**</span><span class="n">bpp</span><span class="p">)</span>		<span class="cm">/* output block buffer */</span>
<span class="p">{</span>
	<span class="n">xfs_dabuf_t</span>		<span class="o">*</span><span class="n">bp</span><span class="p">;</span>		<span class="cm">/* block buffer */</span>
	<span class="n">xfs_dir2_data_hdr_t</span>	<span class="o">*</span><span class="n">hdr</span><span class="p">;</span>		<span class="cm">/* data block header */</span>
	<span class="n">xfs_inode_t</span>		<span class="o">*</span><span class="n">dp</span><span class="p">;</span>		<span class="cm">/* incore directory inode */</span>
	<span class="n">xfs_dir2_data_unused_t</span>	<span class="o">*</span><span class="n">dup</span><span class="p">;</span>		<span class="cm">/* unused entry pointer */</span>
	<span class="kt">int</span>			<span class="n">error</span><span class="p">;</span>		<span class="cm">/* error return value */</span>
	<span class="kt">int</span>			<span class="n">i</span><span class="p">;</span>		<span class="cm">/* bestfree index */</span>
	<span class="n">xfs_mount_t</span>		<span class="o">*</span><span class="n">mp</span><span class="p">;</span>		<span class="cm">/* filesystem mount point */</span>
	<span class="n">xfs_trans_t</span>		<span class="o">*</span><span class="n">tp</span><span class="p">;</span>		<span class="cm">/* transaction pointer */</span>
	<span class="kt">int</span>                     <span class="n">t</span><span class="p">;</span>              <span class="cm">/* temp */</span>

	<span class="n">dp</span> <span class="o">=</span> <span class="n">args</span><span class="o">-&gt;</span><span class="n">dp</span><span class="p">;</span>
	<span class="n">mp</span> <span class="o">=</span> <span class="n">dp</span><span class="o">-&gt;</span><span class="n">i_mount</span><span class="p">;</span>
	<span class="n">tp</span> <span class="o">=</span> <span class="n">args</span><span class="o">-&gt;</span><span class="n">trans</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * Get the buffer set up for the block.</span>
<span class="cm">	 */</span>
	<span class="n">error</span> <span class="o">=</span> <span class="n">xfs_da_get_buf</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">dp</span><span class="p">,</span> <span class="n">xfs_dir2_db_to_da</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="n">blkno</span><span class="p">),</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bp</span><span class="p">,</span>
		<span class="n">XFS_DATA_FORK</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ASSERT</span><span class="p">(</span><span class="n">bp</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Initialize the header.</span>
<span class="cm">	 */</span>
	<span class="n">hdr</span> <span class="o">=</span> <span class="n">bp</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="n">hdr</span><span class="o">-&gt;</span><span class="n">magic</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">XFS_DIR2_DATA_MAGIC</span><span class="p">);</span>
	<span class="n">hdr</span><span class="o">-&gt;</span><span class="n">bestfree</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">offset</span> <span class="o">=</span> <span class="n">cpu_to_be16</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">hdr</span><span class="p">));</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">XFS_DIR2_DATA_FD_COUNT</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">hdr</span><span class="o">-&gt;</span><span class="n">bestfree</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">hdr</span><span class="o">-&gt;</span><span class="n">bestfree</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Set up an unused entry for the block&#39;s body.</span>
<span class="cm">	 */</span>
	<span class="n">dup</span> <span class="o">=</span> <span class="p">(</span><span class="n">xfs_dir2_data_unused_t</span> <span class="o">*</span><span class="p">)(</span><span class="n">hdr</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">dup</span><span class="o">-&gt;</span><span class="n">freetag</span> <span class="o">=</span> <span class="n">cpu_to_be16</span><span class="p">(</span><span class="n">XFS_DIR2_DATA_FREE_TAG</span><span class="p">);</span>

	<span class="n">t</span> <span class="o">=</span> <span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_dirblksize</span> <span class="o">-</span> <span class="p">(</span><span class="n">uint</span><span class="p">)</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">hdr</span><span class="p">);</span>
	<span class="n">hdr</span><span class="o">-&gt;</span><span class="n">bestfree</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">length</span> <span class="o">=</span> <span class="n">cpu_to_be16</span><span class="p">(</span><span class="n">t</span><span class="p">);</span>
	<span class="n">dup</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">=</span> <span class="n">cpu_to_be16</span><span class="p">(</span><span class="n">t</span><span class="p">);</span>
	<span class="o">*</span><span class="n">xfs_dir2_data_unused_tag_p</span><span class="p">(</span><span class="n">dup</span><span class="p">)</span> <span class="o">=</span> <span class="n">cpu_to_be16</span><span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">dup</span> <span class="o">-</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">hdr</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 * Log it and return it.</span>
<span class="cm">	 */</span>
	<span class="n">xfs_dir2_data_log_header</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">bp</span><span class="p">);</span>
	<span class="n">xfs_dir2_data_log_unused</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">bp</span><span class="p">,</span> <span class="n">dup</span><span class="p">);</span>
	<span class="o">*</span><span class="n">bpp</span> <span class="o">=</span> <span class="n">bp</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Log an active data entry from the block.</span>
<span class="cm"> */</span>
<span class="kt">void</span>
<span class="n">xfs_dir2_data_log_entry</span><span class="p">(</span>
	<span class="n">xfs_trans_t</span>		<span class="o">*</span><span class="n">tp</span><span class="p">,</span>		<span class="cm">/* transaction pointer */</span>
	<span class="n">xfs_dabuf_t</span>		<span class="o">*</span><span class="n">bp</span><span class="p">,</span>		<span class="cm">/* block buffer */</span>
	<span class="n">xfs_dir2_data_entry_t</span>	<span class="o">*</span><span class="n">dep</span><span class="p">)</span>		<span class="cm">/* data entry pointer */</span>
<span class="p">{</span>
	<span class="n">xfs_dir2_data_hdr_t</span>	<span class="o">*</span><span class="n">hdr</span> <span class="o">=</span> <span class="n">bp</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>

	<span class="n">ASSERT</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">magic</span> <span class="o">==</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">XFS_DIR2_DATA_MAGIC</span><span class="p">)</span> <span class="o">||</span>
	       <span class="n">hdr</span><span class="o">-&gt;</span><span class="n">magic</span> <span class="o">==</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">XFS_DIR2_BLOCK_MAGIC</span><span class="p">));</span>

	<span class="n">xfs_da_log_buf</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">bp</span><span class="p">,</span> <span class="p">(</span><span class="n">uint</span><span class="p">)((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">dep</span> <span class="o">-</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">hdr</span><span class="p">),</span>
		<span class="p">(</span><span class="n">uint</span><span class="p">)((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)(</span><span class="n">xfs_dir2_data_entry_tag_p</span><span class="p">(</span><span class="n">dep</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">-</span>
		       <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">hdr</span> <span class="o">-</span> <span class="mi">1</span><span class="p">));</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Log a data block header.</span>
<span class="cm"> */</span>
<span class="kt">void</span>
<span class="n">xfs_dir2_data_log_header</span><span class="p">(</span>
	<span class="n">xfs_trans_t</span>		<span class="o">*</span><span class="n">tp</span><span class="p">,</span>		<span class="cm">/* transaction pointer */</span>
	<span class="n">xfs_dabuf_t</span>		<span class="o">*</span><span class="n">bp</span><span class="p">)</span>		<span class="cm">/* block buffer */</span>
<span class="p">{</span>
	<span class="n">xfs_dir2_data_hdr_t</span>	<span class="o">*</span><span class="n">hdr</span> <span class="o">=</span> <span class="n">bp</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>

	<span class="n">ASSERT</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">magic</span> <span class="o">==</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">XFS_DIR2_DATA_MAGIC</span><span class="p">)</span> <span class="o">||</span>
	       <span class="n">hdr</span><span class="o">-&gt;</span><span class="n">magic</span> <span class="o">==</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">XFS_DIR2_BLOCK_MAGIC</span><span class="p">));</span>

	<span class="n">xfs_da_log_buf</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">bp</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">hdr</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Log a data unused entry.</span>
<span class="cm"> */</span>
<span class="kt">void</span>
<span class="n">xfs_dir2_data_log_unused</span><span class="p">(</span>
	<span class="n">xfs_trans_t</span>		<span class="o">*</span><span class="n">tp</span><span class="p">,</span>		<span class="cm">/* transaction pointer */</span>
	<span class="n">xfs_dabuf_t</span>		<span class="o">*</span><span class="n">bp</span><span class="p">,</span>		<span class="cm">/* block buffer */</span>
	<span class="n">xfs_dir2_data_unused_t</span>	<span class="o">*</span><span class="n">dup</span><span class="p">)</span>		<span class="cm">/* data unused pointer */</span>
<span class="p">{</span>
	<span class="n">xfs_dir2_data_hdr_t</span>	<span class="o">*</span><span class="n">hdr</span> <span class="o">=</span> <span class="n">bp</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>

	<span class="n">ASSERT</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">magic</span> <span class="o">==</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">XFS_DIR2_DATA_MAGIC</span><span class="p">)</span> <span class="o">||</span>
	       <span class="n">hdr</span><span class="o">-&gt;</span><span class="n">magic</span> <span class="o">==</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">XFS_DIR2_BLOCK_MAGIC</span><span class="p">));</span>

	<span class="cm">/*</span>
<span class="cm">	 * Log the first part of the unused entry.</span>
<span class="cm">	 */</span>
	<span class="n">xfs_da_log_buf</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">bp</span><span class="p">,</span> <span class="p">(</span><span class="n">uint</span><span class="p">)((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">dup</span> <span class="o">-</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">hdr</span><span class="p">),</span>
		<span class="p">(</span><span class="n">uint</span><span class="p">)((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">dup</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">dup</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">)</span> <span class="o">-</span>
		       <span class="mi">1</span> <span class="o">-</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">hdr</span><span class="p">));</span>
	<span class="cm">/*</span>
<span class="cm">	 * Log the end (tag) of the unused entry.</span>
<span class="cm">	 */</span>
	<span class="n">xfs_da_log_buf</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">bp</span><span class="p">,</span>
		<span class="p">(</span><span class="n">uint</span><span class="p">)((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">xfs_dir2_data_unused_tag_p</span><span class="p">(</span><span class="n">dup</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">hdr</span><span class="p">),</span>
		<span class="p">(</span><span class="n">uint</span><span class="p">)((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">xfs_dir2_data_unused_tag_p</span><span class="p">(</span><span class="n">dup</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">hdr</span> <span class="o">+</span>
		       <span class="k">sizeof</span><span class="p">(</span><span class="n">xfs_dir2_data_off_t</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">));</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Make a byte range in the data block unused.</span>
<span class="cm"> * Its current contents are unimportant.</span>
<span class="cm"> */</span>
<span class="kt">void</span>
<span class="n">xfs_dir2_data_make_free</span><span class="p">(</span>
	<span class="n">xfs_trans_t</span>		<span class="o">*</span><span class="n">tp</span><span class="p">,</span>		<span class="cm">/* transaction pointer */</span>
	<span class="n">xfs_dabuf_t</span>		<span class="o">*</span><span class="n">bp</span><span class="p">,</span>		<span class="cm">/* block buffer */</span>
	<span class="n">xfs_dir2_data_aoff_t</span>	<span class="n">offset</span><span class="p">,</span>		<span class="cm">/* starting byte offset */</span>
	<span class="n">xfs_dir2_data_aoff_t</span>	<span class="n">len</span><span class="p">,</span>		<span class="cm">/* length in bytes */</span>
	<span class="kt">int</span>			<span class="o">*</span><span class="n">needlogp</span><span class="p">,</span>	<span class="cm">/* out: log header */</span>
	<span class="kt">int</span>			<span class="o">*</span><span class="n">needscanp</span><span class="p">)</span>	<span class="cm">/* out: regen bestfree */</span>
<span class="p">{</span>
	<span class="n">xfs_dir2_data_hdr_t</span>	<span class="o">*</span><span class="n">hdr</span><span class="p">;</span>		<span class="cm">/* data block pointer */</span>
	<span class="n">xfs_dir2_data_free_t</span>	<span class="o">*</span><span class="n">dfp</span><span class="p">;</span>		<span class="cm">/* bestfree pointer */</span>
	<span class="kt">char</span>			<span class="o">*</span><span class="n">endptr</span><span class="p">;</span>	<span class="cm">/* end of data area */</span>
	<span class="n">xfs_mount_t</span>		<span class="o">*</span><span class="n">mp</span><span class="p">;</span>		<span class="cm">/* filesystem mount point */</span>
	<span class="kt">int</span>			<span class="n">needscan</span><span class="p">;</span>	<span class="cm">/* need to regen bestfree */</span>
	<span class="n">xfs_dir2_data_unused_t</span>	<span class="o">*</span><span class="n">newdup</span><span class="p">;</span>	<span class="cm">/* new unused entry */</span>
	<span class="n">xfs_dir2_data_unused_t</span>	<span class="o">*</span><span class="n">postdup</span><span class="p">;</span>	<span class="cm">/* unused entry after us */</span>
	<span class="n">xfs_dir2_data_unused_t</span>	<span class="o">*</span><span class="n">prevdup</span><span class="p">;</span>	<span class="cm">/* unused entry before us */</span>

	<span class="n">mp</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">t_mountp</span><span class="p">;</span>
	<span class="n">hdr</span> <span class="o">=</span> <span class="n">bp</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Figure out where the end of the data area is.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">magic</span> <span class="o">==</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">XFS_DIR2_DATA_MAGIC</span><span class="p">))</span>
		<span class="n">endptr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">hdr</span> <span class="o">+</span> <span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_dirblksize</span><span class="p">;</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">xfs_dir2_block_tail_t</span>	<span class="o">*</span><span class="n">btp</span><span class="p">;</span>	<span class="cm">/* block tail */</span>

		<span class="n">ASSERT</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">magic</span> <span class="o">==</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">XFS_DIR2_BLOCK_MAGIC</span><span class="p">));</span>
		<span class="n">btp</span> <span class="o">=</span> <span class="n">xfs_dir2_block_tail_p</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="n">hdr</span><span class="p">);</span>
		<span class="n">endptr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">xfs_dir2_block_leaf_p</span><span class="p">(</span><span class="n">btp</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="cm">/*</span>
<span class="cm">	 * If this isn&#39;t the start of the block, then back up to</span>
<span class="cm">	 * the previous entry and see if it&#39;s free.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">offset</span> <span class="o">&gt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">hdr</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">__be16</span>			<span class="o">*</span><span class="n">tagp</span><span class="p">;</span>	<span class="cm">/* tag just before us */</span>

		<span class="n">tagp</span> <span class="o">=</span> <span class="p">(</span><span class="n">__be16</span> <span class="o">*</span><span class="p">)((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">hdr</span> <span class="o">+</span> <span class="n">offset</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">prevdup</span> <span class="o">=</span> <span class="p">(</span><span class="n">xfs_dir2_data_unused_t</span> <span class="o">*</span><span class="p">)((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">hdr</span> <span class="o">+</span> <span class="n">be16_to_cpu</span><span class="p">(</span><span class="o">*</span><span class="n">tagp</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">prevdup</span><span class="o">-&gt;</span><span class="n">freetag</span><span class="p">)</span> <span class="o">!=</span> <span class="n">XFS_DIR2_DATA_FREE_TAG</span><span class="p">)</span>
			<span class="n">prevdup</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">prevdup</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * If this isn&#39;t the end of the block, see if the entry after</span>
<span class="cm">	 * us is free.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">hdr</span> <span class="o">+</span> <span class="n">offset</span> <span class="o">+</span> <span class="n">len</span> <span class="o">&lt;</span> <span class="n">endptr</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">postdup</span> <span class="o">=</span>
			<span class="p">(</span><span class="n">xfs_dir2_data_unused_t</span> <span class="o">*</span><span class="p">)((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">hdr</span> <span class="o">+</span> <span class="n">offset</span> <span class="o">+</span> <span class="n">len</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">postdup</span><span class="o">-&gt;</span><span class="n">freetag</span><span class="p">)</span> <span class="o">!=</span> <span class="n">XFS_DIR2_DATA_FREE_TAG</span><span class="p">)</span>
			<span class="n">postdup</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">postdup</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">ASSERT</span><span class="p">(</span><span class="o">*</span><span class="n">needscanp</span> <span class="o">==</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">needscan</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * Previous and following entries are both free,</span>
<span class="cm">	 * merge everything into a single free entry.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">prevdup</span> <span class="o">&amp;&amp;</span> <span class="n">postdup</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">xfs_dir2_data_free_t</span>	<span class="o">*</span><span class="n">dfp2</span><span class="p">;</span>	<span class="cm">/* another bestfree pointer */</span>

		<span class="cm">/*</span>
<span class="cm">		 * See if prevdup and/or postdup are in bestfree table.</span>
<span class="cm">		 */</span>
		<span class="n">dfp</span> <span class="o">=</span> <span class="n">xfs_dir2_data_freefind</span><span class="p">(</span><span class="n">hdr</span><span class="p">,</span> <span class="n">prevdup</span><span class="p">);</span>
		<span class="n">dfp2</span> <span class="o">=</span> <span class="n">xfs_dir2_data_freefind</span><span class="p">(</span><span class="n">hdr</span><span class="p">,</span> <span class="n">postdup</span><span class="p">);</span>
		<span class="cm">/*</span>
<span class="cm">		 * We need a rescan unless there are exactly 2 free entries</span>
<span class="cm">		 * namely our two.  Then we know what&#39;s happening, otherwise</span>
<span class="cm">		 * since the third bestfree is there, there might be more</span>
<span class="cm">		 * entries.</span>
<span class="cm">		 */</span>
		<span class="n">needscan</span> <span class="o">=</span> <span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">bestfree</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">length</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">);</span>
		<span class="cm">/*</span>
<span class="cm">		 * Fix up the new big freespace.</span>
<span class="cm">		 */</span>
		<span class="n">be16_add_cpu</span><span class="p">(</span><span class="o">&amp;</span><span class="n">prevdup</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">,</span> <span class="n">len</span> <span class="o">+</span> <span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">postdup</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">));</span>
		<span class="o">*</span><span class="n">xfs_dir2_data_unused_tag_p</span><span class="p">(</span><span class="n">prevdup</span><span class="p">)</span> <span class="o">=</span>
			<span class="n">cpu_to_be16</span><span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">prevdup</span> <span class="o">-</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">hdr</span><span class="p">);</span>
		<span class="n">xfs_dir2_data_log_unused</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">bp</span><span class="p">,</span> <span class="n">prevdup</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">needscan</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * Has to be the case that entries 0 and 1 are</span>
<span class="cm">			 * dfp and dfp2 (don&#39;t know which is which), and</span>
<span class="cm">			 * entry 2 is empty.</span>
<span class="cm">			 * Remove entry 1 first then entry 0.</span>
<span class="cm">			 */</span>
			<span class="n">ASSERT</span><span class="p">(</span><span class="n">dfp</span> <span class="o">&amp;&amp;</span> <span class="n">dfp2</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">dfp</span> <span class="o">==</span> <span class="o">&amp;</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">bestfree</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="p">{</span>
				<span class="n">dfp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">bestfree</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
				<span class="n">ASSERT</span><span class="p">(</span><span class="n">dfp2</span> <span class="o">==</span> <span class="n">dfp</span><span class="p">);</span>
				<span class="n">dfp2</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">bestfree</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
			<span class="p">}</span>
			<span class="n">xfs_dir2_data_freeremove</span><span class="p">(</span><span class="n">hdr</span><span class="p">,</span> <span class="n">dfp2</span><span class="p">,</span> <span class="n">needlogp</span><span class="p">);</span>
			<span class="n">xfs_dir2_data_freeremove</span><span class="p">(</span><span class="n">hdr</span><span class="p">,</span> <span class="n">dfp</span><span class="p">,</span> <span class="n">needlogp</span><span class="p">);</span>
			<span class="cm">/*</span>
<span class="cm">			 * Now insert the new entry.</span>
<span class="cm">			 */</span>
			<span class="n">dfp</span> <span class="o">=</span> <span class="n">xfs_dir2_data_freeinsert</span><span class="p">(</span><span class="n">hdr</span><span class="p">,</span> <span class="n">prevdup</span><span class="p">,</span> <span class="n">needlogp</span><span class="p">);</span>
			<span class="n">ASSERT</span><span class="p">(</span><span class="n">dfp</span> <span class="o">==</span> <span class="o">&amp;</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">bestfree</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
			<span class="n">ASSERT</span><span class="p">(</span><span class="n">dfp</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">==</span> <span class="n">prevdup</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">);</span>
			<span class="n">ASSERT</span><span class="p">(</span><span class="o">!</span><span class="n">dfp</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">length</span><span class="p">);</span>
			<span class="n">ASSERT</span><span class="p">(</span><span class="o">!</span><span class="n">dfp</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">length</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="cm">/*</span>
<span class="cm">	 * The entry before us is free, merge with it.</span>
<span class="cm">	 */</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">prevdup</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dfp</span> <span class="o">=</span> <span class="n">xfs_dir2_data_freefind</span><span class="p">(</span><span class="n">hdr</span><span class="p">,</span> <span class="n">prevdup</span><span class="p">);</span>
		<span class="n">be16_add_cpu</span><span class="p">(</span><span class="o">&amp;</span><span class="n">prevdup</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
		<span class="o">*</span><span class="n">xfs_dir2_data_unused_tag_p</span><span class="p">(</span><span class="n">prevdup</span><span class="p">)</span> <span class="o">=</span>
			<span class="n">cpu_to_be16</span><span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">prevdup</span> <span class="o">-</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">hdr</span><span class="p">);</span>
		<span class="n">xfs_dir2_data_log_unused</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">bp</span><span class="p">,</span> <span class="n">prevdup</span><span class="p">);</span>
		<span class="cm">/*</span>
<span class="cm">		 * If the previous entry was in the table, the new entry</span>
<span class="cm">		 * is longer, so it will be in the table too.  Remove</span>
<span class="cm">		 * the old one and add the new one.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dfp</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">xfs_dir2_data_freeremove</span><span class="p">(</span><span class="n">hdr</span><span class="p">,</span> <span class="n">dfp</span><span class="p">,</span> <span class="n">needlogp</span><span class="p">);</span>
			<span class="n">xfs_dir2_data_freeinsert</span><span class="p">(</span><span class="n">hdr</span><span class="p">,</span> <span class="n">prevdup</span><span class="p">,</span> <span class="n">needlogp</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="cm">/*</span>
<span class="cm">		 * Otherwise we need a scan if the new entry is big enough.</span>
<span class="cm">		 */</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="n">needscan</span> <span class="o">=</span> <span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">prevdup</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">)</span> <span class="o">&gt;</span>
				   <span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">bestfree</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">length</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="cm">/*</span>
<span class="cm">	 * The following entry is free, merge with it.</span>
<span class="cm">	 */</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">postdup</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dfp</span> <span class="o">=</span> <span class="n">xfs_dir2_data_freefind</span><span class="p">(</span><span class="n">hdr</span><span class="p">,</span> <span class="n">postdup</span><span class="p">);</span>
		<span class="n">newdup</span> <span class="o">=</span> <span class="p">(</span><span class="n">xfs_dir2_data_unused_t</span> <span class="o">*</span><span class="p">)((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">hdr</span> <span class="o">+</span> <span class="n">offset</span><span class="p">);</span>
		<span class="n">newdup</span><span class="o">-&gt;</span><span class="n">freetag</span> <span class="o">=</span> <span class="n">cpu_to_be16</span><span class="p">(</span><span class="n">XFS_DIR2_DATA_FREE_TAG</span><span class="p">);</span>
		<span class="n">newdup</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">=</span> <span class="n">cpu_to_be16</span><span class="p">(</span><span class="n">len</span> <span class="o">+</span> <span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">postdup</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">));</span>
		<span class="o">*</span><span class="n">xfs_dir2_data_unused_tag_p</span><span class="p">(</span><span class="n">newdup</span><span class="p">)</span> <span class="o">=</span>
			<span class="n">cpu_to_be16</span><span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">newdup</span> <span class="o">-</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">hdr</span><span class="p">);</span>
		<span class="n">xfs_dir2_data_log_unused</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">bp</span><span class="p">,</span> <span class="n">newdup</span><span class="p">);</span>
		<span class="cm">/*</span>
<span class="cm">		 * If the following entry was in the table, the new entry</span>
<span class="cm">		 * is longer, so it will be in the table too.  Remove</span>
<span class="cm">		 * the old one and add the new one.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dfp</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">xfs_dir2_data_freeremove</span><span class="p">(</span><span class="n">hdr</span><span class="p">,</span> <span class="n">dfp</span><span class="p">,</span> <span class="n">needlogp</span><span class="p">);</span>
			<span class="n">xfs_dir2_data_freeinsert</span><span class="p">(</span><span class="n">hdr</span><span class="p">,</span> <span class="n">newdup</span><span class="p">,</span> <span class="n">needlogp</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="cm">/*</span>
<span class="cm">		 * Otherwise we need a scan if the new entry is big enough.</span>
<span class="cm">		 */</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="n">needscan</span> <span class="o">=</span> <span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">newdup</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">)</span> <span class="o">&gt;</span>
				   <span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">bestfree</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">length</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="cm">/*</span>
<span class="cm">	 * Neither neighbor is free.  Make a new entry.</span>
<span class="cm">	 */</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">newdup</span> <span class="o">=</span> <span class="p">(</span><span class="n">xfs_dir2_data_unused_t</span> <span class="o">*</span><span class="p">)((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">hdr</span> <span class="o">+</span> <span class="n">offset</span><span class="p">);</span>
		<span class="n">newdup</span><span class="o">-&gt;</span><span class="n">freetag</span> <span class="o">=</span> <span class="n">cpu_to_be16</span><span class="p">(</span><span class="n">XFS_DIR2_DATA_FREE_TAG</span><span class="p">);</span>
		<span class="n">newdup</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">=</span> <span class="n">cpu_to_be16</span><span class="p">(</span><span class="n">len</span><span class="p">);</span>
		<span class="o">*</span><span class="n">xfs_dir2_data_unused_tag_p</span><span class="p">(</span><span class="n">newdup</span><span class="p">)</span> <span class="o">=</span>
			<span class="n">cpu_to_be16</span><span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">newdup</span> <span class="o">-</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">hdr</span><span class="p">);</span>
		<span class="n">xfs_dir2_data_log_unused</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">bp</span><span class="p">,</span> <span class="n">newdup</span><span class="p">);</span>
		<span class="n">xfs_dir2_data_freeinsert</span><span class="p">(</span><span class="n">hdr</span><span class="p">,</span> <span class="n">newdup</span><span class="p">,</span> <span class="n">needlogp</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="o">*</span><span class="n">needscanp</span> <span class="o">=</span> <span class="n">needscan</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Take a byte range out of an existing unused space and make it un-free.</span>
<span class="cm"> */</span>
<span class="kt">void</span>
<span class="n">xfs_dir2_data_use_free</span><span class="p">(</span>
	<span class="n">xfs_trans_t</span>		<span class="o">*</span><span class="n">tp</span><span class="p">,</span>		<span class="cm">/* transaction pointer */</span>
	<span class="n">xfs_dabuf_t</span>		<span class="o">*</span><span class="n">bp</span><span class="p">,</span>		<span class="cm">/* data block buffer */</span>
	<span class="n">xfs_dir2_data_unused_t</span>	<span class="o">*</span><span class="n">dup</span><span class="p">,</span>		<span class="cm">/* unused entry */</span>
	<span class="n">xfs_dir2_data_aoff_t</span>	<span class="n">offset</span><span class="p">,</span>		<span class="cm">/* starting offset to use */</span>
	<span class="n">xfs_dir2_data_aoff_t</span>	<span class="n">len</span><span class="p">,</span>		<span class="cm">/* length to use */</span>
	<span class="kt">int</span>			<span class="o">*</span><span class="n">needlogp</span><span class="p">,</span>	<span class="cm">/* out: need to log header */</span>
	<span class="kt">int</span>			<span class="o">*</span><span class="n">needscanp</span><span class="p">)</span>	<span class="cm">/* out: need regen bestfree */</span>
<span class="p">{</span>
	<span class="n">xfs_dir2_data_hdr_t</span>	<span class="o">*</span><span class="n">hdr</span><span class="p">;</span>		<span class="cm">/* data block header */</span>
	<span class="n">xfs_dir2_data_free_t</span>	<span class="o">*</span><span class="n">dfp</span><span class="p">;</span>		<span class="cm">/* bestfree pointer */</span>
	<span class="kt">int</span>			<span class="n">matchback</span><span class="p">;</span>	<span class="cm">/* matches end of freespace */</span>
	<span class="kt">int</span>			<span class="n">matchfront</span><span class="p">;</span>	<span class="cm">/* matches start of freespace */</span>
	<span class="kt">int</span>			<span class="n">needscan</span><span class="p">;</span>	<span class="cm">/* need to regen bestfree */</span>
	<span class="n">xfs_dir2_data_unused_t</span>	<span class="o">*</span><span class="n">newdup</span><span class="p">;</span>	<span class="cm">/* new unused entry */</span>
	<span class="n">xfs_dir2_data_unused_t</span>	<span class="o">*</span><span class="n">newdup2</span><span class="p">;</span>	<span class="cm">/* another new unused entry */</span>
	<span class="kt">int</span>			<span class="n">oldlen</span><span class="p">;</span>		<span class="cm">/* old unused entry&#39;s length */</span>

	<span class="n">hdr</span> <span class="o">=</span> <span class="n">bp</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="n">ASSERT</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">magic</span> <span class="o">==</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">XFS_DIR2_DATA_MAGIC</span><span class="p">)</span> <span class="o">||</span>
	       <span class="n">hdr</span><span class="o">-&gt;</span><span class="n">magic</span> <span class="o">==</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">XFS_DIR2_BLOCK_MAGIC</span><span class="p">));</span>
	<span class="n">ASSERT</span><span class="p">(</span><span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">dup</span><span class="o">-&gt;</span><span class="n">freetag</span><span class="p">)</span> <span class="o">==</span> <span class="n">XFS_DIR2_DATA_FREE_TAG</span><span class="p">);</span>
	<span class="n">ASSERT</span><span class="p">(</span><span class="n">offset</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">dup</span> <span class="o">-</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">hdr</span><span class="p">);</span>
	<span class="n">ASSERT</span><span class="p">(</span><span class="n">offset</span> <span class="o">+</span> <span class="n">len</span> <span class="o">&lt;=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">dup</span> <span class="o">+</span> <span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">dup</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">hdr</span><span class="p">);</span>
	<span class="n">ASSERT</span><span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">dup</span> <span class="o">-</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">hdr</span> <span class="o">==</span> <span class="n">be16_to_cpu</span><span class="p">(</span><span class="o">*</span><span class="n">xfs_dir2_data_unused_tag_p</span><span class="p">(</span><span class="n">dup</span><span class="p">)));</span>
	<span class="cm">/*</span>
<span class="cm">	 * Look up the entry in the bestfree table.</span>
<span class="cm">	 */</span>
	<span class="n">dfp</span> <span class="o">=</span> <span class="n">xfs_dir2_data_freefind</span><span class="p">(</span><span class="n">hdr</span><span class="p">,</span> <span class="n">dup</span><span class="p">);</span>
	<span class="n">oldlen</span> <span class="o">=</span> <span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">dup</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">);</span>
	<span class="n">ASSERT</span><span class="p">(</span><span class="n">dfp</span> <span class="o">||</span> <span class="n">oldlen</span> <span class="o">&lt;=</span> <span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">bestfree</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">length</span><span class="p">));</span>
	<span class="cm">/*</span>
<span class="cm">	 * Check for alignment with front and back of the entry.</span>
<span class="cm">	 */</span>
	<span class="n">matchfront</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">dup</span> <span class="o">-</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">hdr</span> <span class="o">==</span> <span class="n">offset</span><span class="p">;</span>
	<span class="n">matchback</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">dup</span> <span class="o">+</span> <span class="n">oldlen</span> <span class="o">-</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">hdr</span> <span class="o">==</span> <span class="n">offset</span> <span class="o">+</span> <span class="n">len</span><span class="p">;</span>
	<span class="n">ASSERT</span><span class="p">(</span><span class="o">*</span><span class="n">needscanp</span> <span class="o">==</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">needscan</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * If we matched it exactly we just need to get rid of it from</span>
<span class="cm">	 * the bestfree table.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">matchfront</span> <span class="o">&amp;&amp;</span> <span class="n">matchback</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dfp</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">needscan</span> <span class="o">=</span> <span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">bestfree</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">offset</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">needscan</span><span class="p">)</span>
				<span class="n">xfs_dir2_data_freeremove</span><span class="p">(</span><span class="n">hdr</span><span class="p">,</span> <span class="n">dfp</span><span class="p">,</span> <span class="n">needlogp</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="cm">/*</span>
<span class="cm">	 * We match the first part of the entry.</span>
<span class="cm">	 * Make a new entry with the remaining freespace.</span>
<span class="cm">	 */</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">matchfront</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">newdup</span> <span class="o">=</span> <span class="p">(</span><span class="n">xfs_dir2_data_unused_t</span> <span class="o">*</span><span class="p">)((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">hdr</span> <span class="o">+</span> <span class="n">offset</span> <span class="o">+</span> <span class="n">len</span><span class="p">);</span>
		<span class="n">newdup</span><span class="o">-&gt;</span><span class="n">freetag</span> <span class="o">=</span> <span class="n">cpu_to_be16</span><span class="p">(</span><span class="n">XFS_DIR2_DATA_FREE_TAG</span><span class="p">);</span>
		<span class="n">newdup</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">=</span> <span class="n">cpu_to_be16</span><span class="p">(</span><span class="n">oldlen</span> <span class="o">-</span> <span class="n">len</span><span class="p">);</span>
		<span class="o">*</span><span class="n">xfs_dir2_data_unused_tag_p</span><span class="p">(</span><span class="n">newdup</span><span class="p">)</span> <span class="o">=</span>
			<span class="n">cpu_to_be16</span><span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">newdup</span> <span class="o">-</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">hdr</span><span class="p">);</span>
		<span class="n">xfs_dir2_data_log_unused</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">bp</span><span class="p">,</span> <span class="n">newdup</span><span class="p">);</span>
		<span class="cm">/*</span>
<span class="cm">		 * If it was in the table, remove it and add the new one.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dfp</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">xfs_dir2_data_freeremove</span><span class="p">(</span><span class="n">hdr</span><span class="p">,</span> <span class="n">dfp</span><span class="p">,</span> <span class="n">needlogp</span><span class="p">);</span>
			<span class="n">dfp</span> <span class="o">=</span> <span class="n">xfs_dir2_data_freeinsert</span><span class="p">(</span><span class="n">hdr</span><span class="p">,</span> <span class="n">newdup</span><span class="p">,</span> <span class="n">needlogp</span><span class="p">);</span>
			<span class="n">ASSERT</span><span class="p">(</span><span class="n">dfp</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">);</span>
			<span class="n">ASSERT</span><span class="p">(</span><span class="n">dfp</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">==</span> <span class="n">newdup</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">);</span>
			<span class="n">ASSERT</span><span class="p">(</span><span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">dfp</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">)</span> <span class="o">==</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">newdup</span> <span class="o">-</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">hdr</span><span class="p">);</span>
			<span class="cm">/*</span>
<span class="cm">			 * If we got inserted at the last slot,</span>
<span class="cm">			 * that means we don&#39;t know if there was a better</span>
<span class="cm">			 * choice for the last slot, or not.  Rescan.</span>
<span class="cm">			 */</span>
			<span class="n">needscan</span> <span class="o">=</span> <span class="n">dfp</span> <span class="o">==</span> <span class="o">&amp;</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">bestfree</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="cm">/*</span>
<span class="cm">	 * We match the last part of the entry.</span>
<span class="cm">	 * Trim the allocated space off the tail of the entry.</span>
<span class="cm">	 */</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">matchback</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">newdup</span> <span class="o">=</span> <span class="n">dup</span><span class="p">;</span>
		<span class="n">newdup</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">=</span> <span class="n">cpu_to_be16</span><span class="p">(((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">hdr</span> <span class="o">+</span> <span class="n">offset</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">newdup</span><span class="p">);</span>
		<span class="o">*</span><span class="n">xfs_dir2_data_unused_tag_p</span><span class="p">(</span><span class="n">newdup</span><span class="p">)</span> <span class="o">=</span>
			<span class="n">cpu_to_be16</span><span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">newdup</span> <span class="o">-</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">hdr</span><span class="p">);</span>
		<span class="n">xfs_dir2_data_log_unused</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">bp</span><span class="p">,</span> <span class="n">newdup</span><span class="p">);</span>
		<span class="cm">/*</span>
<span class="cm">		 * If it was in the table, remove it and add the new one.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dfp</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">xfs_dir2_data_freeremove</span><span class="p">(</span><span class="n">hdr</span><span class="p">,</span> <span class="n">dfp</span><span class="p">,</span> <span class="n">needlogp</span><span class="p">);</span>
			<span class="n">dfp</span> <span class="o">=</span> <span class="n">xfs_dir2_data_freeinsert</span><span class="p">(</span><span class="n">hdr</span><span class="p">,</span> <span class="n">newdup</span><span class="p">,</span> <span class="n">needlogp</span><span class="p">);</span>
			<span class="n">ASSERT</span><span class="p">(</span><span class="n">dfp</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">);</span>
			<span class="n">ASSERT</span><span class="p">(</span><span class="n">dfp</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">==</span> <span class="n">newdup</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">);</span>
			<span class="n">ASSERT</span><span class="p">(</span><span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">dfp</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">)</span> <span class="o">==</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">newdup</span> <span class="o">-</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">hdr</span><span class="p">);</span>
			<span class="cm">/*</span>
<span class="cm">			 * If we got inserted at the last slot,</span>
<span class="cm">			 * that means we don&#39;t know if there was a better</span>
<span class="cm">			 * choice for the last slot, or not.  Rescan.</span>
<span class="cm">			 */</span>
			<span class="n">needscan</span> <span class="o">=</span> <span class="n">dfp</span> <span class="o">==</span> <span class="o">&amp;</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">bestfree</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="cm">/*</span>
<span class="cm">	 * Poking out the middle of an entry.</span>
<span class="cm">	 * Make two new entries.</span>
<span class="cm">	 */</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">newdup</span> <span class="o">=</span> <span class="n">dup</span><span class="p">;</span>
		<span class="n">newdup</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">=</span> <span class="n">cpu_to_be16</span><span class="p">(((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">hdr</span> <span class="o">+</span> <span class="n">offset</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">newdup</span><span class="p">);</span>
		<span class="o">*</span><span class="n">xfs_dir2_data_unused_tag_p</span><span class="p">(</span><span class="n">newdup</span><span class="p">)</span> <span class="o">=</span>
			<span class="n">cpu_to_be16</span><span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">newdup</span> <span class="o">-</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">hdr</span><span class="p">);</span>
		<span class="n">xfs_dir2_data_log_unused</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">bp</span><span class="p">,</span> <span class="n">newdup</span><span class="p">);</span>
		<span class="n">newdup2</span> <span class="o">=</span> <span class="p">(</span><span class="n">xfs_dir2_data_unused_t</span> <span class="o">*</span><span class="p">)((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">hdr</span> <span class="o">+</span> <span class="n">offset</span> <span class="o">+</span> <span class="n">len</span><span class="p">);</span>
		<span class="n">newdup2</span><span class="o">-&gt;</span><span class="n">freetag</span> <span class="o">=</span> <span class="n">cpu_to_be16</span><span class="p">(</span><span class="n">XFS_DIR2_DATA_FREE_TAG</span><span class="p">);</span>
		<span class="n">newdup2</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">=</span> <span class="n">cpu_to_be16</span><span class="p">(</span><span class="n">oldlen</span> <span class="o">-</span> <span class="n">len</span> <span class="o">-</span> <span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">newdup</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">));</span>
		<span class="o">*</span><span class="n">xfs_dir2_data_unused_tag_p</span><span class="p">(</span><span class="n">newdup2</span><span class="p">)</span> <span class="o">=</span>
			<span class="n">cpu_to_be16</span><span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">newdup2</span> <span class="o">-</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">hdr</span><span class="p">);</span>
		<span class="n">xfs_dir2_data_log_unused</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">bp</span><span class="p">,</span> <span class="n">newdup2</span><span class="p">);</span>
		<span class="cm">/*</span>
<span class="cm">		 * If the old entry was in the table, we need to scan</span>
<span class="cm">		 * if the 3rd entry was valid, since these entries</span>
<span class="cm">		 * are smaller than the old one.</span>
<span class="cm">		 * If we don&#39;t need to scan that means there were 1 or 2</span>
<span class="cm">		 * entries in the table, and removing the old and adding</span>
<span class="cm">		 * the 2 new will work.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dfp</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">needscan</span> <span class="o">=</span> <span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">bestfree</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">length</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">needscan</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">xfs_dir2_data_freeremove</span><span class="p">(</span><span class="n">hdr</span><span class="p">,</span> <span class="n">dfp</span><span class="p">,</span> <span class="n">needlogp</span><span class="p">);</span>
				<span class="n">xfs_dir2_data_freeinsert</span><span class="p">(</span><span class="n">hdr</span><span class="p">,</span> <span class="n">newdup</span><span class="p">,</span> <span class="n">needlogp</span><span class="p">);</span>
				<span class="n">xfs_dir2_data_freeinsert</span><span class="p">(</span><span class="n">hdr</span><span class="p">,</span> <span class="n">newdup2</span><span class="p">,</span>
							 <span class="n">needlogp</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="o">*</span><span class="n">needscanp</span> <span class="o">=</span> <span class="n">needscan</span><span class="p">;</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
