<!DOCTYPE html>
<html><head><title>joekychen/linux » fs › xfs › xfs_bmap.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>xfs_bmap.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Copyright (c) 2000-2006 Silicon Graphics, Inc.</span>
<span class="cm"> * All Rights Reserved.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or</span>
<span class="cm"> * modify it under the terms of the GNU General Public License as</span>
<span class="cm"> * published by the Free Software Foundation.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is distributed in the hope that it would be useful,</span>
<span class="cm"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm"> * GNU General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> * You should have received a copy of the GNU General Public License</span>
<span class="cm"> * along with this program; if not, write the Free Software Foundation,</span>
<span class="cm"> * Inc.,  51 Franklin St, Fifth Floor, Boston, MA  02110-1301  USA</span>
<span class="cm"> */</span>
<span class="cp">#include &quot;xfs.h&quot;</span>
<span class="cp">#include &quot;xfs_fs.h&quot;</span>
<span class="cp">#include &quot;xfs_types.h&quot;</span>
<span class="cp">#include &quot;xfs_bit.h&quot;</span>
<span class="cp">#include &quot;xfs_log.h&quot;</span>
<span class="cp">#include &quot;xfs_inum.h&quot;</span>
<span class="cp">#include &quot;xfs_trans.h&quot;</span>
<span class="cp">#include &quot;xfs_sb.h&quot;</span>
<span class="cp">#include &quot;xfs_ag.h&quot;</span>
<span class="cp">#include &quot;xfs_dir2.h&quot;</span>
<span class="cp">#include &quot;xfs_da_btree.h&quot;</span>
<span class="cp">#include &quot;xfs_bmap_btree.h&quot;</span>
<span class="cp">#include &quot;xfs_alloc_btree.h&quot;</span>
<span class="cp">#include &quot;xfs_ialloc_btree.h&quot;</span>
<span class="cp">#include &quot;xfs_dinode.h&quot;</span>
<span class="cp">#include &quot;xfs_inode.h&quot;</span>
<span class="cp">#include &quot;xfs_btree.h&quot;</span>
<span class="cp">#include &quot;xfs_mount.h&quot;</span>
<span class="cp">#include &quot;xfs_itable.h&quot;</span>
<span class="cp">#include &quot;xfs_inode_item.h&quot;</span>
<span class="cp">#include &quot;xfs_extfree_item.h&quot;</span>
<span class="cp">#include &quot;xfs_alloc.h&quot;</span>
<span class="cp">#include &quot;xfs_bmap.h&quot;</span>
<span class="cp">#include &quot;xfs_rtalloc.h&quot;</span>
<span class="cp">#include &quot;xfs_error.h&quot;</span>
<span class="cp">#include &quot;xfs_attr_leaf.h&quot;</span>
<span class="cp">#include &quot;xfs_quota.h&quot;</span>
<span class="cp">#include &quot;xfs_trans_space.h&quot;</span>
<span class="cp">#include &quot;xfs_buf_item.h&quot;</span>
<span class="cp">#include &quot;xfs_filestream.h&quot;</span>
<span class="cp">#include &quot;xfs_vnodeops.h&quot;</span>
<span class="cp">#include &quot;xfs_trace.h&quot;</span>


<span class="n">kmem_zone_t</span>		<span class="o">*</span><span class="n">xfs_bmap_free_item_zone</span><span class="p">;</span>

<span class="cm">/*</span>
<span class="cm"> * Prototypes for internal bmap routines.</span>
<span class="cm"> */</span>

<span class="cp">#ifdef DEBUG</span>
<span class="n">STATIC</span> <span class="kt">void</span>
<span class="n">xfs_bmap_check_leaf_extents</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">xfs_btree_cur</span>	<span class="o">*</span><span class="n">cur</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">xfs_inode</span>	<span class="o">*</span><span class="n">ip</span><span class="p">,</span>
	<span class="kt">int</span>			<span class="n">whichfork</span><span class="p">);</span>
<span class="cp">#else</span>
<span class="cp">#define xfs_bmap_check_leaf_extents(cur, ip, whichfork)		do { } while (0)</span>
<span class="cp">#endif</span>


<span class="cm">/*</span>
<span class="cm"> * Called from xfs_bmap_add_attrfork to handle extents format files.</span>
<span class="cm"> */</span>
<span class="n">STATIC</span> <span class="kt">int</span>					<span class="cm">/* error */</span>
<span class="n">xfs_bmap_add_attrfork_extents</span><span class="p">(</span>
	<span class="n">xfs_trans_t</span>		<span class="o">*</span><span class="n">tp</span><span class="p">,</span>		<span class="cm">/* transaction pointer */</span>
	<span class="n">xfs_inode_t</span>		<span class="o">*</span><span class="n">ip</span><span class="p">,</span>		<span class="cm">/* incore inode pointer */</span>
	<span class="n">xfs_fsblock_t</span>		<span class="o">*</span><span class="n">firstblock</span><span class="p">,</span>	<span class="cm">/* first block allocated */</span>
	<span class="n">xfs_bmap_free_t</span>		<span class="o">*</span><span class="n">flist</span><span class="p">,</span>		<span class="cm">/* blocks to free at commit */</span>
	<span class="kt">int</span>			<span class="o">*</span><span class="n">flags</span><span class="p">);</span>	<span class="cm">/* inode logging flags */</span>

<span class="cm">/*</span>
<span class="cm"> * Called from xfs_bmap_add_attrfork to handle local format files.</span>
<span class="cm"> */</span>
<span class="n">STATIC</span> <span class="kt">int</span>					<span class="cm">/* error */</span>
<span class="n">xfs_bmap_add_attrfork_local</span><span class="p">(</span>
	<span class="n">xfs_trans_t</span>		<span class="o">*</span><span class="n">tp</span><span class="p">,</span>		<span class="cm">/* transaction pointer */</span>
	<span class="n">xfs_inode_t</span>		<span class="o">*</span><span class="n">ip</span><span class="p">,</span>		<span class="cm">/* incore inode pointer */</span>
	<span class="n">xfs_fsblock_t</span>		<span class="o">*</span><span class="n">firstblock</span><span class="p">,</span>	<span class="cm">/* first block allocated */</span>
	<span class="n">xfs_bmap_free_t</span>		<span class="o">*</span><span class="n">flist</span><span class="p">,</span>		<span class="cm">/* blocks to free at commit */</span>
	<span class="kt">int</span>			<span class="o">*</span><span class="n">flags</span><span class="p">);</span>	<span class="cm">/* inode logging flags */</span>

<span class="cm">/*</span>
<span class="cm"> * xfs_bmap_alloc is called by xfs_bmapi to allocate an extent for a file.</span>
<span class="cm"> * It figures out where to ask the underlying allocator to put the new extent.</span>
<span class="cm"> */</span>
<span class="n">STATIC</span> <span class="kt">int</span>				<span class="cm">/* error */</span>
<span class="n">xfs_bmap_alloc</span><span class="p">(</span>
	<span class="n">xfs_bmalloca_t</span>		<span class="o">*</span><span class="n">ap</span><span class="p">);</span>	<span class="cm">/* bmap alloc argument struct */</span>

<span class="cm">/*</span>
<span class="cm"> * Transform a btree format file with only one leaf node, where the</span>
<span class="cm"> * extents list will fit in the inode, into an extents format file.</span>
<span class="cm"> * Since the file extents are already in-core, all we have to do is</span>
<span class="cm"> * give up the space for the btree root and pitch the leaf block.</span>
<span class="cm"> */</span>
<span class="n">STATIC</span> <span class="kt">int</span>				<span class="cm">/* error */</span>
<span class="n">xfs_bmap_btree_to_extents</span><span class="p">(</span>
	<span class="n">xfs_trans_t</span>		<span class="o">*</span><span class="n">tp</span><span class="p">,</span>	<span class="cm">/* transaction pointer */</span>
	<span class="n">xfs_inode_t</span>		<span class="o">*</span><span class="n">ip</span><span class="p">,</span>	<span class="cm">/* incore inode pointer */</span>
	<span class="n">xfs_btree_cur_t</span>		<span class="o">*</span><span class="n">cur</span><span class="p">,</span>	<span class="cm">/* btree cursor */</span>
	<span class="kt">int</span>			<span class="o">*</span><span class="n">logflagsp</span><span class="p">,</span> <span class="cm">/* inode logging flags */</span>
	<span class="kt">int</span>			<span class="n">whichfork</span><span class="p">);</span> <span class="cm">/* data or attr fork */</span>

<span class="cm">/*</span>
<span class="cm"> * Remove the entry &quot;free&quot; from the free item list.  Prev points to the</span>
<span class="cm"> * previous entry, unless &quot;free&quot; is the head of the list.</span>
<span class="cm"> */</span>
<span class="n">STATIC</span> <span class="kt">void</span>
<span class="n">xfs_bmap_del_free</span><span class="p">(</span>
	<span class="n">xfs_bmap_free_t</span>		<span class="o">*</span><span class="n">flist</span><span class="p">,</span>	<span class="cm">/* free item list header */</span>
	<span class="n">xfs_bmap_free_item_t</span>	<span class="o">*</span><span class="n">prev</span><span class="p">,</span>	<span class="cm">/* previous item on list, if any */</span>
	<span class="n">xfs_bmap_free_item_t</span>	<span class="o">*</span><span class="n">free</span><span class="p">);</span>	<span class="cm">/* list item to be freed */</span>

<span class="cm">/*</span>
<span class="cm"> * Convert an extents-format file into a btree-format file.</span>
<span class="cm"> * The new file will have a root block (in the inode) and a single child block.</span>
<span class="cm"> */</span>
<span class="n">STATIC</span> <span class="kt">int</span>					<span class="cm">/* error */</span>
<span class="n">xfs_bmap_extents_to_btree</span><span class="p">(</span>
	<span class="n">xfs_trans_t</span>		<span class="o">*</span><span class="n">tp</span><span class="p">,</span>		<span class="cm">/* transaction pointer */</span>
	<span class="n">xfs_inode_t</span>		<span class="o">*</span><span class="n">ip</span><span class="p">,</span>		<span class="cm">/* incore inode pointer */</span>
	<span class="n">xfs_fsblock_t</span>		<span class="o">*</span><span class="n">firstblock</span><span class="p">,</span>	<span class="cm">/* first-block-allocated */</span>
	<span class="n">xfs_bmap_free_t</span>		<span class="o">*</span><span class="n">flist</span><span class="p">,</span>		<span class="cm">/* blocks freed in xaction */</span>
	<span class="n">xfs_btree_cur_t</span>		<span class="o">**</span><span class="n">curp</span><span class="p">,</span>		<span class="cm">/* cursor returned to caller */</span>
	<span class="kt">int</span>			<span class="n">wasdel</span><span class="p">,</span>		<span class="cm">/* converting a delayed alloc */</span>
	<span class="kt">int</span>			<span class="o">*</span><span class="n">logflagsp</span><span class="p">,</span>	<span class="cm">/* inode logging flags */</span>
	<span class="kt">int</span>			<span class="n">whichfork</span><span class="p">);</span>	<span class="cm">/* data or attr fork */</span>

<span class="cm">/*</span>
<span class="cm"> * Convert a local file to an extents file.</span>
<span class="cm"> * This code is sort of bogus, since the file data needs to get</span>
<span class="cm"> * logged so it won&#39;t be lost.  The bmap-level manipulations are ok, though.</span>
<span class="cm"> */</span>
<span class="n">STATIC</span> <span class="kt">int</span>				<span class="cm">/* error */</span>
<span class="n">xfs_bmap_local_to_extents</span><span class="p">(</span>
	<span class="n">xfs_trans_t</span>	<span class="o">*</span><span class="n">tp</span><span class="p">,</span>		<span class="cm">/* transaction pointer */</span>
	<span class="n">xfs_inode_t</span>	<span class="o">*</span><span class="n">ip</span><span class="p">,</span>		<span class="cm">/* incore inode pointer */</span>
	<span class="n">xfs_fsblock_t</span>	<span class="o">*</span><span class="n">firstblock</span><span class="p">,</span>	<span class="cm">/* first block allocated in xaction */</span>
	<span class="n">xfs_extlen_t</span>	<span class="n">total</span><span class="p">,</span>		<span class="cm">/* total blocks needed by transaction */</span>
	<span class="kt">int</span>		<span class="o">*</span><span class="n">logflagsp</span><span class="p">,</span>	<span class="cm">/* inode logging flags */</span>
	<span class="kt">int</span>		<span class="n">whichfork</span><span class="p">);</span>	<span class="cm">/* data or attr fork */</span>

<span class="cm">/*</span>
<span class="cm"> * Search the extents list for the inode, for the extent containing bno.</span>
<span class="cm"> * If bno lies in a hole, point to the next entry.  If bno lies past eof,</span>
<span class="cm"> * *eofp will be set, and *prevp will contain the last entry (null if none).</span>
<span class="cm"> * Else, *lastxp will be set to the index of the found</span>
<span class="cm"> * entry; *gotp will contain the entry.</span>
<span class="cm"> */</span>
<span class="n">STATIC</span> <span class="n">xfs_bmbt_rec_host_t</span> <span class="o">*</span>		<span class="cm">/* pointer to found extent entry */</span>
<span class="n">xfs_bmap_search_extents</span><span class="p">(</span>
	<span class="n">xfs_inode_t</span>	<span class="o">*</span><span class="n">ip</span><span class="p">,</span>		<span class="cm">/* incore inode pointer */</span>
	<span class="n">xfs_fileoff_t</span>	<span class="n">bno</span><span class="p">,</span>		<span class="cm">/* block number searched for */</span>
	<span class="kt">int</span>		<span class="n">whichfork</span><span class="p">,</span>	<span class="cm">/* data or attr fork */</span>
	<span class="kt">int</span>		<span class="o">*</span><span class="n">eofp</span><span class="p">,</span>		<span class="cm">/* out: end of file found */</span>
	<span class="n">xfs_extnum_t</span>	<span class="o">*</span><span class="n">lastxp</span><span class="p">,</span>	<span class="cm">/* out: last extent index */</span>
	<span class="n">xfs_bmbt_irec_t</span>	<span class="o">*</span><span class="n">gotp</span><span class="p">,</span>		<span class="cm">/* out: extent entry found */</span>
	<span class="n">xfs_bmbt_irec_t</span>	<span class="o">*</span><span class="n">prevp</span><span class="p">);</span>	<span class="cm">/* out: previous extent entry found */</span>

<span class="cm">/*</span>
<span class="cm"> * Compute the worst-case number of indirect blocks that will be used</span>
<span class="cm"> * for ip&#39;s delayed extent of length &quot;len&quot;.</span>
<span class="cm"> */</span>
<span class="n">STATIC</span> <span class="n">xfs_filblks_t</span>
<span class="n">xfs_bmap_worst_indlen</span><span class="p">(</span>
	<span class="n">xfs_inode_t</span>		<span class="o">*</span><span class="n">ip</span><span class="p">,</span>	<span class="cm">/* incore inode pointer */</span>
	<span class="n">xfs_filblks_t</span>		<span class="n">len</span><span class="p">);</span>	<span class="cm">/* delayed extent length */</span>

<span class="cp">#ifdef DEBUG</span>
<span class="cm">/*</span>
<span class="cm"> * Perform various validation checks on the values being returned</span>
<span class="cm"> * from xfs_bmapi().</span>
<span class="cm"> */</span>
<span class="n">STATIC</span> <span class="kt">void</span>
<span class="n">xfs_bmap_validate_ret</span><span class="p">(</span>
	<span class="n">xfs_fileoff_t</span>		<span class="n">bno</span><span class="p">,</span>
	<span class="n">xfs_filblks_t</span>		<span class="n">len</span><span class="p">,</span>
	<span class="kt">int</span>			<span class="n">flags</span><span class="p">,</span>
	<span class="n">xfs_bmbt_irec_t</span>		<span class="o">*</span><span class="n">mval</span><span class="p">,</span>
	<span class="kt">int</span>			<span class="n">nmap</span><span class="p">,</span>
	<span class="kt">int</span>			<span class="n">ret_nmap</span><span class="p">);</span>
<span class="cp">#else</span>
<span class="cp">#define	xfs_bmap_validate_ret(bno,len,flags,mval,onmap,nmap)</span>
<span class="cp">#endif </span><span class="cm">/* DEBUG */</span><span class="cp"></span>

<span class="n">STATIC</span> <span class="kt">int</span>
<span class="n">xfs_bmap_count_tree</span><span class="p">(</span>
	<span class="n">xfs_mount_t</span>     <span class="o">*</span><span class="n">mp</span><span class="p">,</span>
	<span class="n">xfs_trans_t</span>     <span class="o">*</span><span class="n">tp</span><span class="p">,</span>
	<span class="n">xfs_ifork_t</span>	<span class="o">*</span><span class="n">ifp</span><span class="p">,</span>
	<span class="n">xfs_fsblock_t</span>   <span class="n">blockno</span><span class="p">,</span>
	<span class="kt">int</span>             <span class="n">levelin</span><span class="p">,</span>
	<span class="kt">int</span>		<span class="o">*</span><span class="n">count</span><span class="p">);</span>

<span class="n">STATIC</span> <span class="kt">void</span>
<span class="n">xfs_bmap_count_leaves</span><span class="p">(</span>
	<span class="n">xfs_ifork_t</span>		<span class="o">*</span><span class="n">ifp</span><span class="p">,</span>
	<span class="n">xfs_extnum_t</span>		<span class="n">idx</span><span class="p">,</span>
	<span class="kt">int</span>			<span class="n">numrecs</span><span class="p">,</span>
	<span class="kt">int</span>			<span class="o">*</span><span class="n">count</span><span class="p">);</span>

<span class="n">STATIC</span> <span class="kt">void</span>
<span class="n">xfs_bmap_disk_count_leaves</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">xfs_mount</span>	<span class="o">*</span><span class="n">mp</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">xfs_btree_block</span>	<span class="o">*</span><span class="n">block</span><span class="p">,</span>
	<span class="kt">int</span>			<span class="n">numrecs</span><span class="p">,</span>
	<span class="kt">int</span>			<span class="o">*</span><span class="n">count</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * Bmap internal routines.</span>
<span class="cm"> */</span>

<span class="n">STATIC</span> <span class="kt">int</span>				<span class="cm">/* error */</span>
<span class="n">xfs_bmbt_lookup_eq</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">xfs_btree_cur</span>	<span class="o">*</span><span class="n">cur</span><span class="p">,</span>
	<span class="n">xfs_fileoff_t</span>		<span class="n">off</span><span class="p">,</span>
	<span class="n">xfs_fsblock_t</span>		<span class="n">bno</span><span class="p">,</span>
	<span class="n">xfs_filblks_t</span>		<span class="n">len</span><span class="p">,</span>
	<span class="kt">int</span>			<span class="o">*</span><span class="n">stat</span><span class="p">)</span>	<span class="cm">/* success/failure */</span>
<span class="p">{</span>
	<span class="n">cur</span><span class="o">-&gt;</span><span class="n">bc_rec</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">br_startoff</span> <span class="o">=</span> <span class="n">off</span><span class="p">;</span>
	<span class="n">cur</span><span class="o">-&gt;</span><span class="n">bc_rec</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">br_startblock</span> <span class="o">=</span> <span class="n">bno</span><span class="p">;</span>
	<span class="n">cur</span><span class="o">-&gt;</span><span class="n">bc_rec</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">br_blockcount</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">xfs_btree_lookup</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">XFS_LOOKUP_EQ</span><span class="p">,</span> <span class="n">stat</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">STATIC</span> <span class="kt">int</span>				<span class="cm">/* error */</span>
<span class="n">xfs_bmbt_lookup_ge</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">xfs_btree_cur</span>	<span class="o">*</span><span class="n">cur</span><span class="p">,</span>
	<span class="n">xfs_fileoff_t</span>		<span class="n">off</span><span class="p">,</span>
	<span class="n">xfs_fsblock_t</span>		<span class="n">bno</span><span class="p">,</span>
	<span class="n">xfs_filblks_t</span>		<span class="n">len</span><span class="p">,</span>
	<span class="kt">int</span>			<span class="o">*</span><span class="n">stat</span><span class="p">)</span>	<span class="cm">/* success/failure */</span>
<span class="p">{</span>
	<span class="n">cur</span><span class="o">-&gt;</span><span class="n">bc_rec</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">br_startoff</span> <span class="o">=</span> <span class="n">off</span><span class="p">;</span>
	<span class="n">cur</span><span class="o">-&gt;</span><span class="n">bc_rec</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">br_startblock</span> <span class="o">=</span> <span class="n">bno</span><span class="p">;</span>
	<span class="n">cur</span><span class="o">-&gt;</span><span class="n">bc_rec</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">br_blockcount</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">xfs_btree_lookup</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">XFS_LOOKUP_GE</span><span class="p">,</span> <span class="n">stat</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Check if the inode needs to be converted to btree format.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="n">bool</span> <span class="n">xfs_bmap_needs_btree</span><span class="p">(</span><span class="k">struct</span> <span class="n">xfs_inode</span> <span class="o">*</span><span class="n">ip</span><span class="p">,</span> <span class="kt">int</span> <span class="n">whichfork</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">XFS_IFORK_FORMAT</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">whichfork</span><span class="p">)</span> <span class="o">==</span> <span class="n">XFS_DINODE_FMT_EXTENTS</span> <span class="o">&amp;&amp;</span>
		<span class="n">XFS_IFORK_NEXTENTS</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">whichfork</span><span class="p">)</span> <span class="o">&gt;</span>
			<span class="n">XFS_IFORK_MAXEXT</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">whichfork</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Check if the inode should be converted to extent format.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="n">bool</span> <span class="n">xfs_bmap_wants_extents</span><span class="p">(</span><span class="k">struct</span> <span class="n">xfs_inode</span> <span class="o">*</span><span class="n">ip</span><span class="p">,</span> <span class="kt">int</span> <span class="n">whichfork</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">XFS_IFORK_FORMAT</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">whichfork</span><span class="p">)</span> <span class="o">==</span> <span class="n">XFS_DINODE_FMT_BTREE</span> <span class="o">&amp;&amp;</span>
		<span class="n">XFS_IFORK_NEXTENTS</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">whichfork</span><span class="p">)</span> <span class="o">&lt;=</span>
			<span class="n">XFS_IFORK_MAXEXT</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">whichfork</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Update the record referred to by cur to the value given</span>
<span class="cm"> * by [off, bno, len, state].</span>
<span class="cm"> * This either works (return 0) or gets an EFSCORRUPTED error.</span>
<span class="cm"> */</span>
<span class="n">STATIC</span> <span class="kt">int</span>
<span class="n">xfs_bmbt_update</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">xfs_btree_cur</span>	<span class="o">*</span><span class="n">cur</span><span class="p">,</span>
	<span class="n">xfs_fileoff_t</span>		<span class="n">off</span><span class="p">,</span>
	<span class="n">xfs_fsblock_t</span>		<span class="n">bno</span><span class="p">,</span>
	<span class="n">xfs_filblks_t</span>		<span class="n">len</span><span class="p">,</span>
	<span class="n">xfs_exntst_t</span>		<span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">union</span> <span class="n">xfs_btree_rec</span>	<span class="n">rec</span><span class="p">;</span>

	<span class="n">xfs_bmbt_disk_set_allf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rec</span><span class="p">.</span><span class="n">bmbt</span><span class="p">,</span> <span class="n">off</span><span class="p">,</span> <span class="n">bno</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">state</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">xfs_btree_update</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rec</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Called from xfs_bmap_add_attrfork to handle btree format files.</span>
<span class="cm"> */</span>
<span class="n">STATIC</span> <span class="kt">int</span>					<span class="cm">/* error */</span>
<span class="n">xfs_bmap_add_attrfork_btree</span><span class="p">(</span>
	<span class="n">xfs_trans_t</span>		<span class="o">*</span><span class="n">tp</span><span class="p">,</span>		<span class="cm">/* transaction pointer */</span>
	<span class="n">xfs_inode_t</span>		<span class="o">*</span><span class="n">ip</span><span class="p">,</span>		<span class="cm">/* incore inode pointer */</span>
	<span class="n">xfs_fsblock_t</span>		<span class="o">*</span><span class="n">firstblock</span><span class="p">,</span>	<span class="cm">/* first block allocated */</span>
	<span class="n">xfs_bmap_free_t</span>		<span class="o">*</span><span class="n">flist</span><span class="p">,</span>		<span class="cm">/* blocks to free at commit */</span>
	<span class="kt">int</span>			<span class="o">*</span><span class="n">flags</span><span class="p">)</span>		<span class="cm">/* inode logging flags */</span>
<span class="p">{</span>
	<span class="n">xfs_btree_cur_t</span>		<span class="o">*</span><span class="n">cur</span><span class="p">;</span>		<span class="cm">/* btree cursor */</span>
	<span class="kt">int</span>			<span class="n">error</span><span class="p">;</span>		<span class="cm">/* error return value */</span>
	<span class="n">xfs_mount_t</span>		<span class="o">*</span><span class="n">mp</span><span class="p">;</span>		<span class="cm">/* file system mount struct */</span>
	<span class="kt">int</span>			<span class="n">stat</span><span class="p">;</span>		<span class="cm">/* newroot status */</span>

	<span class="n">mp</span> <span class="o">=</span> <span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_mount</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_df</span><span class="p">.</span><span class="n">if_broot_bytes</span> <span class="o">&lt;=</span> <span class="n">XFS_IFORK_DSIZE</span><span class="p">(</span><span class="n">ip</span><span class="p">))</span>
		<span class="o">*</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">XFS_ILOG_DBROOT</span><span class="p">;</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">cur</span> <span class="o">=</span> <span class="n">xfs_bmbt_init_cursor</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="n">tp</span><span class="p">,</span> <span class="n">ip</span><span class="p">,</span> <span class="n">XFS_DATA_FORK</span><span class="p">);</span>
		<span class="n">cur</span><span class="o">-&gt;</span><span class="n">bc_private</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">flist</span> <span class="o">=</span> <span class="n">flist</span><span class="p">;</span>
		<span class="n">cur</span><span class="o">-&gt;</span><span class="n">bc_private</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">firstblock</span> <span class="o">=</span> <span class="o">*</span><span class="n">firstblock</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">error</span> <span class="o">=</span> <span class="n">xfs_bmbt_lookup_ge</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">stat</span><span class="p">)))</span>
			<span class="k">goto</span> <span class="n">error0</span><span class="p">;</span>
		<span class="cm">/* must be at least one entry */</span>
		<span class="n">XFS_WANT_CORRUPTED_GOTO</span><span class="p">(</span><span class="n">stat</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="n">error0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">error</span> <span class="o">=</span> <span class="n">xfs_btree_new_iroot</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">flags</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">stat</span><span class="p">)))</span>
			<span class="k">goto</span> <span class="n">error0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">stat</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">xfs_btree_del_cursor</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">XFS_BTREE_NOERROR</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">XFS_ERROR</span><span class="p">(</span><span class="n">ENOSPC</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="o">*</span><span class="n">firstblock</span> <span class="o">=</span> <span class="n">cur</span><span class="o">-&gt;</span><span class="n">bc_private</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">firstblock</span><span class="p">;</span>
		<span class="n">cur</span><span class="o">-&gt;</span><span class="n">bc_private</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">allocated</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">xfs_btree_del_cursor</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">XFS_BTREE_NOERROR</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">error0:</span>
	<span class="n">xfs_btree_del_cursor</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">XFS_BTREE_ERROR</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Called from xfs_bmap_add_attrfork to handle extents format files.</span>
<span class="cm"> */</span>
<span class="n">STATIC</span> <span class="kt">int</span>					<span class="cm">/* error */</span>
<span class="n">xfs_bmap_add_attrfork_extents</span><span class="p">(</span>
	<span class="n">xfs_trans_t</span>		<span class="o">*</span><span class="n">tp</span><span class="p">,</span>		<span class="cm">/* transaction pointer */</span>
	<span class="n">xfs_inode_t</span>		<span class="o">*</span><span class="n">ip</span><span class="p">,</span>		<span class="cm">/* incore inode pointer */</span>
	<span class="n">xfs_fsblock_t</span>		<span class="o">*</span><span class="n">firstblock</span><span class="p">,</span>	<span class="cm">/* first block allocated */</span>
	<span class="n">xfs_bmap_free_t</span>		<span class="o">*</span><span class="n">flist</span><span class="p">,</span>		<span class="cm">/* blocks to free at commit */</span>
	<span class="kt">int</span>			<span class="o">*</span><span class="n">flags</span><span class="p">)</span>		<span class="cm">/* inode logging flags */</span>
<span class="p">{</span>
	<span class="n">xfs_btree_cur_t</span>		<span class="o">*</span><span class="n">cur</span><span class="p">;</span>		<span class="cm">/* bmap btree cursor */</span>
	<span class="kt">int</span>			<span class="n">error</span><span class="p">;</span>		<span class="cm">/* error return value */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_d</span><span class="p">.</span><span class="n">di_nextents</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">xfs_bmbt_rec_t</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">XFS_IFORK_DSIZE</span><span class="p">(</span><span class="n">ip</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">cur</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">error</span> <span class="o">=</span> <span class="n">xfs_bmap_extents_to_btree</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">ip</span><span class="p">,</span> <span class="n">firstblock</span><span class="p">,</span> <span class="n">flist</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cur</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
		<span class="n">flags</span><span class="p">,</span> <span class="n">XFS_DATA_FORK</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cur</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cur</span><span class="o">-&gt;</span><span class="n">bc_private</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">allocated</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">xfs_btree_del_cursor</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span>
			<span class="n">error</span> <span class="o">?</span> <span class="n">XFS_BTREE_ERROR</span> <span class="o">:</span> <span class="n">XFS_BTREE_NOERROR</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Called from xfs_bmap_add_attrfork to handle local format files.</span>
<span class="cm"> */</span>
<span class="n">STATIC</span> <span class="kt">int</span>					<span class="cm">/* error */</span>
<span class="n">xfs_bmap_add_attrfork_local</span><span class="p">(</span>
	<span class="n">xfs_trans_t</span>		<span class="o">*</span><span class="n">tp</span><span class="p">,</span>		<span class="cm">/* transaction pointer */</span>
	<span class="n">xfs_inode_t</span>		<span class="o">*</span><span class="n">ip</span><span class="p">,</span>		<span class="cm">/* incore inode pointer */</span>
	<span class="n">xfs_fsblock_t</span>		<span class="o">*</span><span class="n">firstblock</span><span class="p">,</span>	<span class="cm">/* first block allocated */</span>
	<span class="n">xfs_bmap_free_t</span>		<span class="o">*</span><span class="n">flist</span><span class="p">,</span>		<span class="cm">/* blocks to free at commit */</span>
	<span class="kt">int</span>			<span class="o">*</span><span class="n">flags</span><span class="p">)</span>		<span class="cm">/* inode logging flags */</span>
<span class="p">{</span>
	<span class="n">xfs_da_args_t</span>		<span class="n">dargs</span><span class="p">;</span>		<span class="cm">/* args for dir/attr code */</span>
	<span class="kt">int</span>			<span class="n">error</span><span class="p">;</span>		<span class="cm">/* error return value */</span>
	<span class="n">xfs_mount_t</span>		<span class="o">*</span><span class="n">mp</span><span class="p">;</span>		<span class="cm">/* mount structure pointer */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_df</span><span class="p">.</span><span class="n">if_bytes</span> <span class="o">&lt;=</span> <span class="n">XFS_IFORK_DSIZE</span><span class="p">(</span><span class="n">ip</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">S_ISDIR</span><span class="p">(</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_d</span><span class="p">.</span><span class="n">di_mode</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">mp</span> <span class="o">=</span> <span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_mount</span><span class="p">;</span>
		<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dargs</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">dargs</span><span class="p">));</span>
		<span class="n">dargs</span><span class="p">.</span><span class="n">dp</span> <span class="o">=</span> <span class="n">ip</span><span class="p">;</span>
		<span class="n">dargs</span><span class="p">.</span><span class="n">firstblock</span> <span class="o">=</span> <span class="n">firstblock</span><span class="p">;</span>
		<span class="n">dargs</span><span class="p">.</span><span class="n">flist</span> <span class="o">=</span> <span class="n">flist</span><span class="p">;</span>
		<span class="n">dargs</span><span class="p">.</span><span class="n">total</span> <span class="o">=</span> <span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_dirblkfsbs</span><span class="p">;</span>
		<span class="n">dargs</span><span class="p">.</span><span class="n">whichfork</span> <span class="o">=</span> <span class="n">XFS_DATA_FORK</span><span class="p">;</span>
		<span class="n">dargs</span><span class="p">.</span><span class="n">trans</span> <span class="o">=</span> <span class="n">tp</span><span class="p">;</span>
		<span class="n">error</span> <span class="o">=</span> <span class="n">xfs_dir2_sf_to_block</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dargs</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">error</span> <span class="o">=</span> <span class="n">xfs_bmap_local_to_extents</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">ip</span><span class="p">,</span> <span class="n">firstblock</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">flags</span><span class="p">,</span>
			<span class="n">XFS_DATA_FORK</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Convert a delayed allocation to a real allocation.</span>
<span class="cm"> */</span>
<span class="n">STATIC</span> <span class="kt">int</span>				<span class="cm">/* error */</span>
<span class="n">xfs_bmap_add_extent_delay_real</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">xfs_bmalloca</span>	<span class="o">*</span><span class="n">bma</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">xfs_bmbt_irec</span>	<span class="o">*</span><span class="n">new</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">bma</span><span class="o">-&gt;</span><span class="n">got</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">diff</span><span class="p">;</span>	<span class="cm">/* temp value */</span>
	<span class="n">xfs_bmbt_rec_host_t</span>	<span class="o">*</span><span class="n">ep</span><span class="p">;</span>	<span class="cm">/* extent entry for idx */</span>
	<span class="kt">int</span>			<span class="n">error</span><span class="p">;</span>	<span class="cm">/* error return value */</span>
	<span class="kt">int</span>			<span class="n">i</span><span class="p">;</span>	<span class="cm">/* temp state */</span>
	<span class="n">xfs_ifork_t</span>		<span class="o">*</span><span class="n">ifp</span><span class="p">;</span>	<span class="cm">/* inode fork pointer */</span>
	<span class="n">xfs_fileoff_t</span>		<span class="n">new_endoff</span><span class="p">;</span>	<span class="cm">/* end offset of new entry */</span>
	<span class="n">xfs_bmbt_irec_t</span>		<span class="n">r</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>	<span class="cm">/* neighbor extent entries */</span>
					<span class="cm">/* left is 0, right is 1, prev is 2 */</span>
	<span class="kt">int</span>			<span class="n">rval</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>	<span class="cm">/* return value (logging flags) */</span>
	<span class="kt">int</span>			<span class="n">state</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span><span class="cm">/* state bits, accessed thru macros */</span>
	<span class="n">xfs_filblks_t</span>		<span class="n">da_new</span><span class="p">;</span> <span class="cm">/* new count del alloc blocks used */</span>
	<span class="n">xfs_filblks_t</span>		<span class="n">da_old</span><span class="p">;</span> <span class="cm">/* old count del alloc blocks used */</span>
	<span class="n">xfs_filblks_t</span>		<span class="n">temp</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>	<span class="cm">/* value for da_new calculations */</span>
	<span class="n">xfs_filblks_t</span>		<span class="n">temp2</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="cm">/* value for da_new calculations */</span>
	<span class="kt">int</span>			<span class="n">tmp_rval</span><span class="p">;</span>	<span class="cm">/* partial logging flags */</span>

	<span class="n">ifp</span> <span class="o">=</span> <span class="n">XFS_IFORK_PTR</span><span class="p">(</span><span class="n">bma</span><span class="o">-&gt;</span><span class="n">ip</span><span class="p">,</span> <span class="n">XFS_DATA_FORK</span><span class="p">);</span>

	<span class="n">ASSERT</span><span class="p">(</span><span class="n">bma</span><span class="o">-&gt;</span><span class="n">idx</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">ASSERT</span><span class="p">(</span><span class="n">bma</span><span class="o">-&gt;</span><span class="n">idx</span> <span class="o">&lt;=</span> <span class="n">ifp</span><span class="o">-&gt;</span><span class="n">if_bytes</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">xfs_bmbt_rec</span><span class="p">));</span>
	<span class="n">ASSERT</span><span class="p">(</span><span class="o">!</span><span class="n">isnullstartblock</span><span class="p">(</span><span class="n">new</span><span class="o">-&gt;</span><span class="n">br_startblock</span><span class="p">));</span>
	<span class="n">ASSERT</span><span class="p">(</span><span class="o">!</span><span class="n">bma</span><span class="o">-&gt;</span><span class="n">cur</span> <span class="o">||</span>
	       <span class="p">(</span><span class="n">bma</span><span class="o">-&gt;</span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">bc_private</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">XFS_BTCUR_BPRV_WASDEL</span><span class="p">));</span>

	<span class="n">XFS_STATS_INC</span><span class="p">(</span><span class="n">xs_add_exlist</span><span class="p">);</span>

<span class="cp">#define	LEFT		r[0]</span>
<span class="cp">#define	RIGHT		r[1]</span>
<span class="cp">#define	PREV		r[2]</span>

	<span class="cm">/*</span>
<span class="cm">	 * Set up a bunch of variables to make the tests simpler.</span>
<span class="cm">	 */</span>
	<span class="n">ep</span> <span class="o">=</span> <span class="n">xfs_iext_get_ext</span><span class="p">(</span><span class="n">ifp</span><span class="p">,</span> <span class="n">bma</span><span class="o">-&gt;</span><span class="n">idx</span><span class="p">);</span>
	<span class="n">xfs_bmbt_get_all</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">PREV</span><span class="p">);</span>
	<span class="n">new_endoff</span> <span class="o">=</span> <span class="n">new</span><span class="o">-&gt;</span><span class="n">br_startoff</span> <span class="o">+</span> <span class="n">new</span><span class="o">-&gt;</span><span class="n">br_blockcount</span><span class="p">;</span>
	<span class="n">ASSERT</span><span class="p">(</span><span class="n">PREV</span><span class="p">.</span><span class="n">br_startoff</span> <span class="o">&lt;=</span> <span class="n">new</span><span class="o">-&gt;</span><span class="n">br_startoff</span><span class="p">);</span>
	<span class="n">ASSERT</span><span class="p">(</span><span class="n">PREV</span><span class="p">.</span><span class="n">br_startoff</span> <span class="o">+</span> <span class="n">PREV</span><span class="p">.</span><span class="n">br_blockcount</span> <span class="o">&gt;=</span> <span class="n">new_endoff</span><span class="p">);</span>

	<span class="n">da_old</span> <span class="o">=</span> <span class="n">startblockval</span><span class="p">(</span><span class="n">PREV</span><span class="p">.</span><span class="n">br_startblock</span><span class="p">);</span>
	<span class="n">da_new</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Set flags determining what part of the previous delayed allocation</span>
<span class="cm">	 * extent is being replaced by a real allocation.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">PREV</span><span class="p">.</span><span class="n">br_startoff</span> <span class="o">==</span> <span class="n">new</span><span class="o">-&gt;</span><span class="n">br_startoff</span><span class="p">)</span>
		<span class="n">state</span> <span class="o">|=</span> <span class="n">BMAP_LEFT_FILLING</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">PREV</span><span class="p">.</span><span class="n">br_startoff</span> <span class="o">+</span> <span class="n">PREV</span><span class="p">.</span><span class="n">br_blockcount</span> <span class="o">==</span> <span class="n">new_endoff</span><span class="p">)</span>
		<span class="n">state</span> <span class="o">|=</span> <span class="n">BMAP_RIGHT_FILLING</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Check and set flags if this segment has a left neighbor.</span>
<span class="cm">	 * Don&#39;t set contiguous if the combined extent would be too large.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bma</span><span class="o">-&gt;</span><span class="n">idx</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">state</span> <span class="o">|=</span> <span class="n">BMAP_LEFT_VALID</span><span class="p">;</span>
		<span class="n">xfs_bmbt_get_all</span><span class="p">(</span><span class="n">xfs_iext_get_ext</span><span class="p">(</span><span class="n">ifp</span><span class="p">,</span> <span class="n">bma</span><span class="o">-&gt;</span><span class="n">idx</span> <span class="o">-</span> <span class="mi">1</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">LEFT</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">isnullstartblock</span><span class="p">(</span><span class="n">LEFT</span><span class="p">.</span><span class="n">br_startblock</span><span class="p">))</span>
			<span class="n">state</span> <span class="o">|=</span> <span class="n">BMAP_LEFT_DELAY</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">state</span> <span class="o">&amp;</span> <span class="n">BMAP_LEFT_VALID</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">state</span> <span class="o">&amp;</span> <span class="n">BMAP_LEFT_DELAY</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">LEFT</span><span class="p">.</span><span class="n">br_startoff</span> <span class="o">+</span> <span class="n">LEFT</span><span class="p">.</span><span class="n">br_blockcount</span> <span class="o">==</span> <span class="n">new</span><span class="o">-&gt;</span><span class="n">br_startoff</span> <span class="o">&amp;&amp;</span>
	    <span class="n">LEFT</span><span class="p">.</span><span class="n">br_startblock</span> <span class="o">+</span> <span class="n">LEFT</span><span class="p">.</span><span class="n">br_blockcount</span> <span class="o">==</span> <span class="n">new</span><span class="o">-&gt;</span><span class="n">br_startblock</span> <span class="o">&amp;&amp;</span>
	    <span class="n">LEFT</span><span class="p">.</span><span class="n">br_state</span> <span class="o">==</span> <span class="n">new</span><span class="o">-&gt;</span><span class="n">br_state</span> <span class="o">&amp;&amp;</span>
	    <span class="n">LEFT</span><span class="p">.</span><span class="n">br_blockcount</span> <span class="o">+</span> <span class="n">new</span><span class="o">-&gt;</span><span class="n">br_blockcount</span> <span class="o">&lt;=</span> <span class="n">MAXEXTLEN</span><span class="p">)</span>
		<span class="n">state</span> <span class="o">|=</span> <span class="n">BMAP_LEFT_CONTIG</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Check and set flags if this segment has a right neighbor.</span>
<span class="cm">	 * Don&#39;t set contiguous if the combined extent would be too large.</span>
<span class="cm">	 * Also check for all-three-contiguous being too large.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bma</span><span class="o">-&gt;</span><span class="n">idx</span> <span class="o">&lt;</span> <span class="n">bma</span><span class="o">-&gt;</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_df</span><span class="p">.</span><span class="n">if_bytes</span> <span class="o">/</span> <span class="p">(</span><span class="n">uint</span><span class="p">)</span><span class="k">sizeof</span><span class="p">(</span><span class="n">xfs_bmbt_rec_t</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">state</span> <span class="o">|=</span> <span class="n">BMAP_RIGHT_VALID</span><span class="p">;</span>
		<span class="n">xfs_bmbt_get_all</span><span class="p">(</span><span class="n">xfs_iext_get_ext</span><span class="p">(</span><span class="n">ifp</span><span class="p">,</span> <span class="n">bma</span><span class="o">-&gt;</span><span class="n">idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">RIGHT</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">isnullstartblock</span><span class="p">(</span><span class="n">RIGHT</span><span class="p">.</span><span class="n">br_startblock</span><span class="p">))</span>
			<span class="n">state</span> <span class="o">|=</span> <span class="n">BMAP_RIGHT_DELAY</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">state</span> <span class="o">&amp;</span> <span class="n">BMAP_RIGHT_VALID</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">state</span> <span class="o">&amp;</span> <span class="n">BMAP_RIGHT_DELAY</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">new_endoff</span> <span class="o">==</span> <span class="n">RIGHT</span><span class="p">.</span><span class="n">br_startoff</span> <span class="o">&amp;&amp;</span>
	    <span class="n">new</span><span class="o">-&gt;</span><span class="n">br_startblock</span> <span class="o">+</span> <span class="n">new</span><span class="o">-&gt;</span><span class="n">br_blockcount</span> <span class="o">==</span> <span class="n">RIGHT</span><span class="p">.</span><span class="n">br_startblock</span> <span class="o">&amp;&amp;</span>
	    <span class="n">new</span><span class="o">-&gt;</span><span class="n">br_state</span> <span class="o">==</span> <span class="n">RIGHT</span><span class="p">.</span><span class="n">br_state</span> <span class="o">&amp;&amp;</span>
	    <span class="n">new</span><span class="o">-&gt;</span><span class="n">br_blockcount</span> <span class="o">+</span> <span class="n">RIGHT</span><span class="p">.</span><span class="n">br_blockcount</span> <span class="o">&lt;=</span> <span class="n">MAXEXTLEN</span> <span class="o">&amp;&amp;</span>
	    <span class="p">((</span><span class="n">state</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">BMAP_LEFT_CONTIG</span> <span class="o">|</span> <span class="n">BMAP_LEFT_FILLING</span> <span class="o">|</span>
		       <span class="n">BMAP_RIGHT_FILLING</span><span class="p">))</span> <span class="o">!=</span>
		      <span class="p">(</span><span class="n">BMAP_LEFT_CONTIG</span> <span class="o">|</span> <span class="n">BMAP_LEFT_FILLING</span> <span class="o">|</span>
		       <span class="n">BMAP_RIGHT_FILLING</span><span class="p">)</span> <span class="o">||</span>
	     <span class="n">LEFT</span><span class="p">.</span><span class="n">br_blockcount</span> <span class="o">+</span> <span class="n">new</span><span class="o">-&gt;</span><span class="n">br_blockcount</span> <span class="o">+</span> <span class="n">RIGHT</span><span class="p">.</span><span class="n">br_blockcount</span>
			<span class="o">&lt;=</span> <span class="n">MAXEXTLEN</span><span class="p">))</span>
		<span class="n">state</span> <span class="o">|=</span> <span class="n">BMAP_RIGHT_CONTIG</span><span class="p">;</span>

	<span class="n">error</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * Switch out based on the FILLING and CONTIG state bits.</span>
<span class="cm">	 */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">state</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">BMAP_LEFT_FILLING</span> <span class="o">|</span> <span class="n">BMAP_LEFT_CONTIG</span> <span class="o">|</span>
			 <span class="n">BMAP_RIGHT_FILLING</span> <span class="o">|</span> <span class="n">BMAP_RIGHT_CONTIG</span><span class="p">))</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">BMAP_LEFT_FILLING</span> <span class="o">|</span> <span class="n">BMAP_LEFT_CONTIG</span> <span class="o">|</span>
	     <span class="n">BMAP_RIGHT_FILLING</span> <span class="o">|</span> <span class="n">BMAP_RIGHT_CONTIG</span><span class="o">:</span>
		<span class="cm">/*</span>
<span class="cm">		 * Filling in all of a previously delayed allocation extent.</span>
<span class="cm">		 * The left and right neighbors are both contiguous with new.</span>
<span class="cm">		 */</span>
		<span class="n">bma</span><span class="o">-&gt;</span><span class="n">idx</span><span class="o">--</span><span class="p">;</span>
		<span class="n">trace_xfs_bmap_pre_update</span><span class="p">(</span><span class="n">bma</span><span class="o">-&gt;</span><span class="n">ip</span><span class="p">,</span> <span class="n">bma</span><span class="o">-&gt;</span><span class="n">idx</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">_THIS_IP_</span><span class="p">);</span>
		<span class="n">xfs_bmbt_set_blockcount</span><span class="p">(</span><span class="n">xfs_iext_get_ext</span><span class="p">(</span><span class="n">ifp</span><span class="p">,</span> <span class="n">bma</span><span class="o">-&gt;</span><span class="n">idx</span><span class="p">),</span>
			<span class="n">LEFT</span><span class="p">.</span><span class="n">br_blockcount</span> <span class="o">+</span> <span class="n">PREV</span><span class="p">.</span><span class="n">br_blockcount</span> <span class="o">+</span>
			<span class="n">RIGHT</span><span class="p">.</span><span class="n">br_blockcount</span><span class="p">);</span>
		<span class="n">trace_xfs_bmap_post_update</span><span class="p">(</span><span class="n">bma</span><span class="o">-&gt;</span><span class="n">ip</span><span class="p">,</span> <span class="n">bma</span><span class="o">-&gt;</span><span class="n">idx</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">_THIS_IP_</span><span class="p">);</span>

		<span class="n">xfs_iext_remove</span><span class="p">(</span><span class="n">bma</span><span class="o">-&gt;</span><span class="n">ip</span><span class="p">,</span> <span class="n">bma</span><span class="o">-&gt;</span><span class="n">idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">state</span><span class="p">);</span>
		<span class="n">bma</span><span class="o">-&gt;</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_d</span><span class="p">.</span><span class="n">di_nextents</span><span class="o">--</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bma</span><span class="o">-&gt;</span><span class="n">cur</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="n">rval</span> <span class="o">=</span> <span class="n">XFS_ILOG_CORE</span> <span class="o">|</span> <span class="n">XFS_ILOG_DEXT</span><span class="p">;</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="n">rval</span> <span class="o">=</span> <span class="n">XFS_ILOG_CORE</span><span class="p">;</span>
			<span class="n">error</span> <span class="o">=</span> <span class="n">xfs_bmbt_lookup_eq</span><span class="p">(</span><span class="n">bma</span><span class="o">-&gt;</span><span class="n">cur</span><span class="p">,</span> <span class="n">RIGHT</span><span class="p">.</span><span class="n">br_startoff</span><span class="p">,</span>
					<span class="n">RIGHT</span><span class="p">.</span><span class="n">br_startblock</span><span class="p">,</span>
					<span class="n">RIGHT</span><span class="p">.</span><span class="n">br_blockcount</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">i</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
			<span class="n">XFS_WANT_CORRUPTED_GOTO</span><span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="n">done</span><span class="p">);</span>
			<span class="n">error</span> <span class="o">=</span> <span class="n">xfs_btree_delete</span><span class="p">(</span><span class="n">bma</span><span class="o">-&gt;</span><span class="n">cur</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">i</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
			<span class="n">XFS_WANT_CORRUPTED_GOTO</span><span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="n">done</span><span class="p">);</span>
			<span class="n">error</span> <span class="o">=</span> <span class="n">xfs_btree_decrement</span><span class="p">(</span><span class="n">bma</span><span class="o">-&gt;</span><span class="n">cur</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">i</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
			<span class="n">XFS_WANT_CORRUPTED_GOTO</span><span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="n">done</span><span class="p">);</span>
			<span class="n">error</span> <span class="o">=</span> <span class="n">xfs_bmbt_update</span><span class="p">(</span><span class="n">bma</span><span class="o">-&gt;</span><span class="n">cur</span><span class="p">,</span> <span class="n">LEFT</span><span class="p">.</span><span class="n">br_startoff</span><span class="p">,</span>
					<span class="n">LEFT</span><span class="p">.</span><span class="n">br_startblock</span><span class="p">,</span>
					<span class="n">LEFT</span><span class="p">.</span><span class="n">br_blockcount</span> <span class="o">+</span>
					<span class="n">PREV</span><span class="p">.</span><span class="n">br_blockcount</span> <span class="o">+</span>
					<span class="n">RIGHT</span><span class="p">.</span><span class="n">br_blockcount</span><span class="p">,</span> <span class="n">LEFT</span><span class="p">.</span><span class="n">br_state</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">BMAP_LEFT_FILLING</span> <span class="o">|</span> <span class="n">BMAP_RIGHT_FILLING</span> <span class="o">|</span> <span class="n">BMAP_LEFT_CONTIG</span>:
		<span class="cm">/*</span>
<span class="cm">		 * Filling in all of a previously delayed allocation extent.</span>
<span class="cm">		 * The left neighbor is contiguous, the right is not.</span>
<span class="cm">		 */</span>
		<span class="n">bma</span><span class="o">-&gt;</span><span class="n">idx</span><span class="o">--</span><span class="p">;</span>

		<span class="n">trace_xfs_bmap_pre_update</span><span class="p">(</span><span class="n">bma</span><span class="o">-&gt;</span><span class="n">ip</span><span class="p">,</span> <span class="n">bma</span><span class="o">-&gt;</span><span class="n">idx</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">_THIS_IP_</span><span class="p">);</span>
		<span class="n">xfs_bmbt_set_blockcount</span><span class="p">(</span><span class="n">xfs_iext_get_ext</span><span class="p">(</span><span class="n">ifp</span><span class="p">,</span> <span class="n">bma</span><span class="o">-&gt;</span><span class="n">idx</span><span class="p">),</span>
			<span class="n">LEFT</span><span class="p">.</span><span class="n">br_blockcount</span> <span class="o">+</span> <span class="n">PREV</span><span class="p">.</span><span class="n">br_blockcount</span><span class="p">);</span>
		<span class="n">trace_xfs_bmap_post_update</span><span class="p">(</span><span class="n">bma</span><span class="o">-&gt;</span><span class="n">ip</span><span class="p">,</span> <span class="n">bma</span><span class="o">-&gt;</span><span class="n">idx</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">_THIS_IP_</span><span class="p">);</span>

		<span class="n">xfs_iext_remove</span><span class="p">(</span><span class="n">bma</span><span class="o">-&gt;</span><span class="n">ip</span><span class="p">,</span> <span class="n">bma</span><span class="o">-&gt;</span><span class="n">idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">state</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bma</span><span class="o">-&gt;</span><span class="n">cur</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="n">rval</span> <span class="o">=</span> <span class="n">XFS_ILOG_DEXT</span><span class="p">;</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="n">rval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">error</span> <span class="o">=</span> <span class="n">xfs_bmbt_lookup_eq</span><span class="p">(</span><span class="n">bma</span><span class="o">-&gt;</span><span class="n">cur</span><span class="p">,</span> <span class="n">LEFT</span><span class="p">.</span><span class="n">br_startoff</span><span class="p">,</span>
					<span class="n">LEFT</span><span class="p">.</span><span class="n">br_startblock</span><span class="p">,</span> <span class="n">LEFT</span><span class="p">.</span><span class="n">br_blockcount</span><span class="p">,</span>
					<span class="o">&amp;</span><span class="n">i</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
			<span class="n">XFS_WANT_CORRUPTED_GOTO</span><span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="n">done</span><span class="p">);</span>
			<span class="n">error</span> <span class="o">=</span> <span class="n">xfs_bmbt_update</span><span class="p">(</span><span class="n">bma</span><span class="o">-&gt;</span><span class="n">cur</span><span class="p">,</span> <span class="n">LEFT</span><span class="p">.</span><span class="n">br_startoff</span><span class="p">,</span>
					<span class="n">LEFT</span><span class="p">.</span><span class="n">br_startblock</span><span class="p">,</span>
					<span class="n">LEFT</span><span class="p">.</span><span class="n">br_blockcount</span> <span class="o">+</span>
					<span class="n">PREV</span><span class="p">.</span><span class="n">br_blockcount</span><span class="p">,</span> <span class="n">LEFT</span><span class="p">.</span><span class="n">br_state</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">BMAP_LEFT_FILLING</span> <span class="o">|</span> <span class="n">BMAP_RIGHT_FILLING</span> <span class="o">|</span> <span class="n">BMAP_RIGHT_CONTIG</span>:
		<span class="cm">/*</span>
<span class="cm">		 * Filling in all of a previously delayed allocation extent.</span>
<span class="cm">		 * The right neighbor is contiguous, the left is not.</span>
<span class="cm">		 */</span>
		<span class="n">trace_xfs_bmap_pre_update</span><span class="p">(</span><span class="n">bma</span><span class="o">-&gt;</span><span class="n">ip</span><span class="p">,</span> <span class="n">bma</span><span class="o">-&gt;</span><span class="n">idx</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">_THIS_IP_</span><span class="p">);</span>
		<span class="n">xfs_bmbt_set_startblock</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="n">new</span><span class="o">-&gt;</span><span class="n">br_startblock</span><span class="p">);</span>
		<span class="n">xfs_bmbt_set_blockcount</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span>
			<span class="n">PREV</span><span class="p">.</span><span class="n">br_blockcount</span> <span class="o">+</span> <span class="n">RIGHT</span><span class="p">.</span><span class="n">br_blockcount</span><span class="p">);</span>
		<span class="n">trace_xfs_bmap_post_update</span><span class="p">(</span><span class="n">bma</span><span class="o">-&gt;</span><span class="n">ip</span><span class="p">,</span> <span class="n">bma</span><span class="o">-&gt;</span><span class="n">idx</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">_THIS_IP_</span><span class="p">);</span>

		<span class="n">xfs_iext_remove</span><span class="p">(</span><span class="n">bma</span><span class="o">-&gt;</span><span class="n">ip</span><span class="p">,</span> <span class="n">bma</span><span class="o">-&gt;</span><span class="n">idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">state</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bma</span><span class="o">-&gt;</span><span class="n">cur</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="n">rval</span> <span class="o">=</span> <span class="n">XFS_ILOG_DEXT</span><span class="p">;</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="n">rval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">error</span> <span class="o">=</span> <span class="n">xfs_bmbt_lookup_eq</span><span class="p">(</span><span class="n">bma</span><span class="o">-&gt;</span><span class="n">cur</span><span class="p">,</span> <span class="n">RIGHT</span><span class="p">.</span><span class="n">br_startoff</span><span class="p">,</span>
					<span class="n">RIGHT</span><span class="p">.</span><span class="n">br_startblock</span><span class="p">,</span>
					<span class="n">RIGHT</span><span class="p">.</span><span class="n">br_blockcount</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">i</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
			<span class="n">XFS_WANT_CORRUPTED_GOTO</span><span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="n">done</span><span class="p">);</span>
			<span class="n">error</span> <span class="o">=</span> <span class="n">xfs_bmbt_update</span><span class="p">(</span><span class="n">bma</span><span class="o">-&gt;</span><span class="n">cur</span><span class="p">,</span> <span class="n">PREV</span><span class="p">.</span><span class="n">br_startoff</span><span class="p">,</span>
					<span class="n">new</span><span class="o">-&gt;</span><span class="n">br_startblock</span><span class="p">,</span>
					<span class="n">PREV</span><span class="p">.</span><span class="n">br_blockcount</span> <span class="o">+</span>
					<span class="n">RIGHT</span><span class="p">.</span><span class="n">br_blockcount</span><span class="p">,</span> <span class="n">PREV</span><span class="p">.</span><span class="n">br_state</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">BMAP_LEFT_FILLING</span> <span class="o">|</span> <span class="n">BMAP_RIGHT_FILLING</span>:
		<span class="cm">/*</span>
<span class="cm">		 * Filling in all of a previously delayed allocation extent.</span>
<span class="cm">		 * Neither the left nor right neighbors are contiguous with</span>
<span class="cm">		 * the new one.</span>
<span class="cm">		 */</span>
		<span class="n">trace_xfs_bmap_pre_update</span><span class="p">(</span><span class="n">bma</span><span class="o">-&gt;</span><span class="n">ip</span><span class="p">,</span> <span class="n">bma</span><span class="o">-&gt;</span><span class="n">idx</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">_THIS_IP_</span><span class="p">);</span>
		<span class="n">xfs_bmbt_set_startblock</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="n">new</span><span class="o">-&gt;</span><span class="n">br_startblock</span><span class="p">);</span>
		<span class="n">trace_xfs_bmap_post_update</span><span class="p">(</span><span class="n">bma</span><span class="o">-&gt;</span><span class="n">ip</span><span class="p">,</span> <span class="n">bma</span><span class="o">-&gt;</span><span class="n">idx</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">_THIS_IP_</span><span class="p">);</span>

		<span class="n">bma</span><span class="o">-&gt;</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_d</span><span class="p">.</span><span class="n">di_nextents</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bma</span><span class="o">-&gt;</span><span class="n">cur</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="n">rval</span> <span class="o">=</span> <span class="n">XFS_ILOG_CORE</span> <span class="o">|</span> <span class="n">XFS_ILOG_DEXT</span><span class="p">;</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="n">rval</span> <span class="o">=</span> <span class="n">XFS_ILOG_CORE</span><span class="p">;</span>
			<span class="n">error</span> <span class="o">=</span> <span class="n">xfs_bmbt_lookup_eq</span><span class="p">(</span><span class="n">bma</span><span class="o">-&gt;</span><span class="n">cur</span><span class="p">,</span> <span class="n">new</span><span class="o">-&gt;</span><span class="n">br_startoff</span><span class="p">,</span>
					<span class="n">new</span><span class="o">-&gt;</span><span class="n">br_startblock</span><span class="p">,</span> <span class="n">new</span><span class="o">-&gt;</span><span class="n">br_blockcount</span><span class="p">,</span>
					<span class="o">&amp;</span><span class="n">i</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
			<span class="n">XFS_WANT_CORRUPTED_GOTO</span><span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="n">done</span><span class="p">);</span>
			<span class="n">bma</span><span class="o">-&gt;</span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">bc_rec</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">br_state</span> <span class="o">=</span> <span class="n">XFS_EXT_NORM</span><span class="p">;</span>
			<span class="n">error</span> <span class="o">=</span> <span class="n">xfs_btree_insert</span><span class="p">(</span><span class="n">bma</span><span class="o">-&gt;</span><span class="n">cur</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">i</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
			<span class="n">XFS_WANT_CORRUPTED_GOTO</span><span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="n">done</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">BMAP_LEFT_FILLING</span> <span class="o">|</span> <span class="n">BMAP_LEFT_CONTIG</span>:
		<span class="cm">/*</span>
<span class="cm">		 * Filling in the first part of a previous delayed allocation.</span>
<span class="cm">		 * The left neighbor is contiguous.</span>
<span class="cm">		 */</span>
		<span class="n">trace_xfs_bmap_pre_update</span><span class="p">(</span><span class="n">bma</span><span class="o">-&gt;</span><span class="n">ip</span><span class="p">,</span> <span class="n">bma</span><span class="o">-&gt;</span><span class="n">idx</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">_THIS_IP_</span><span class="p">);</span>
		<span class="n">xfs_bmbt_set_blockcount</span><span class="p">(</span><span class="n">xfs_iext_get_ext</span><span class="p">(</span><span class="n">ifp</span><span class="p">,</span> <span class="n">bma</span><span class="o">-&gt;</span><span class="n">idx</span> <span class="o">-</span> <span class="mi">1</span><span class="p">),</span>
			<span class="n">LEFT</span><span class="p">.</span><span class="n">br_blockcount</span> <span class="o">+</span> <span class="n">new</span><span class="o">-&gt;</span><span class="n">br_blockcount</span><span class="p">);</span>
		<span class="n">xfs_bmbt_set_startoff</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span>
			<span class="n">PREV</span><span class="p">.</span><span class="n">br_startoff</span> <span class="o">+</span> <span class="n">new</span><span class="o">-&gt;</span><span class="n">br_blockcount</span><span class="p">);</span>
		<span class="n">trace_xfs_bmap_post_update</span><span class="p">(</span><span class="n">bma</span><span class="o">-&gt;</span><span class="n">ip</span><span class="p">,</span> <span class="n">bma</span><span class="o">-&gt;</span><span class="n">idx</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">_THIS_IP_</span><span class="p">);</span>

		<span class="n">temp</span> <span class="o">=</span> <span class="n">PREV</span><span class="p">.</span><span class="n">br_blockcount</span> <span class="o">-</span> <span class="n">new</span><span class="o">-&gt;</span><span class="n">br_blockcount</span><span class="p">;</span>
		<span class="n">trace_xfs_bmap_pre_update</span><span class="p">(</span><span class="n">bma</span><span class="o">-&gt;</span><span class="n">ip</span><span class="p">,</span> <span class="n">bma</span><span class="o">-&gt;</span><span class="n">idx</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">_THIS_IP_</span><span class="p">);</span>
		<span class="n">xfs_bmbt_set_blockcount</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="n">temp</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bma</span><span class="o">-&gt;</span><span class="n">cur</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="n">rval</span> <span class="o">=</span> <span class="n">XFS_ILOG_DEXT</span><span class="p">;</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="n">rval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">error</span> <span class="o">=</span> <span class="n">xfs_bmbt_lookup_eq</span><span class="p">(</span><span class="n">bma</span><span class="o">-&gt;</span><span class="n">cur</span><span class="p">,</span> <span class="n">LEFT</span><span class="p">.</span><span class="n">br_startoff</span><span class="p">,</span>
					<span class="n">LEFT</span><span class="p">.</span><span class="n">br_startblock</span><span class="p">,</span> <span class="n">LEFT</span><span class="p">.</span><span class="n">br_blockcount</span><span class="p">,</span>
					<span class="o">&amp;</span><span class="n">i</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
			<span class="n">XFS_WANT_CORRUPTED_GOTO</span><span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="n">done</span><span class="p">);</span>
			<span class="n">error</span> <span class="o">=</span> <span class="n">xfs_bmbt_update</span><span class="p">(</span><span class="n">bma</span><span class="o">-&gt;</span><span class="n">cur</span><span class="p">,</span> <span class="n">LEFT</span><span class="p">.</span><span class="n">br_startoff</span><span class="p">,</span>
					<span class="n">LEFT</span><span class="p">.</span><span class="n">br_startblock</span><span class="p">,</span>
					<span class="n">LEFT</span><span class="p">.</span><span class="n">br_blockcount</span> <span class="o">+</span>
					<span class="n">new</span><span class="o">-&gt;</span><span class="n">br_blockcount</span><span class="p">,</span>
					<span class="n">LEFT</span><span class="p">.</span><span class="n">br_state</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">da_new</span> <span class="o">=</span> <span class="n">XFS_FILBLKS_MIN</span><span class="p">(</span><span class="n">xfs_bmap_worst_indlen</span><span class="p">(</span><span class="n">bma</span><span class="o">-&gt;</span><span class="n">ip</span><span class="p">,</span> <span class="n">temp</span><span class="p">),</span>
			<span class="n">startblockval</span><span class="p">(</span><span class="n">PREV</span><span class="p">.</span><span class="n">br_startblock</span><span class="p">));</span>
		<span class="n">xfs_bmbt_set_startblock</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="n">nullstartblock</span><span class="p">(</span><span class="n">da_new</span><span class="p">));</span>
		<span class="n">trace_xfs_bmap_post_update</span><span class="p">(</span><span class="n">bma</span><span class="o">-&gt;</span><span class="n">ip</span><span class="p">,</span> <span class="n">bma</span><span class="o">-&gt;</span><span class="n">idx</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">_THIS_IP_</span><span class="p">);</span>

		<span class="n">bma</span><span class="o">-&gt;</span><span class="n">idx</span><span class="o">--</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">BMAP_LEFT_FILLING</span>:
		<span class="cm">/*</span>
<span class="cm">		 * Filling in the first part of a previous delayed allocation.</span>
<span class="cm">		 * The left neighbor is not contiguous.</span>
<span class="cm">		 */</span>
		<span class="n">trace_xfs_bmap_pre_update</span><span class="p">(</span><span class="n">bma</span><span class="o">-&gt;</span><span class="n">ip</span><span class="p">,</span> <span class="n">bma</span><span class="o">-&gt;</span><span class="n">idx</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">_THIS_IP_</span><span class="p">);</span>
		<span class="n">xfs_bmbt_set_startoff</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="n">new_endoff</span><span class="p">);</span>
		<span class="n">temp</span> <span class="o">=</span> <span class="n">PREV</span><span class="p">.</span><span class="n">br_blockcount</span> <span class="o">-</span> <span class="n">new</span><span class="o">-&gt;</span><span class="n">br_blockcount</span><span class="p">;</span>
		<span class="n">xfs_bmbt_set_blockcount</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="n">temp</span><span class="p">);</span>
		<span class="n">xfs_iext_insert</span><span class="p">(</span><span class="n">bma</span><span class="o">-&gt;</span><span class="n">ip</span><span class="p">,</span> <span class="n">bma</span><span class="o">-&gt;</span><span class="n">idx</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">new</span><span class="p">,</span> <span class="n">state</span><span class="p">);</span>
		<span class="n">bma</span><span class="o">-&gt;</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_d</span><span class="p">.</span><span class="n">di_nextents</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bma</span><span class="o">-&gt;</span><span class="n">cur</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="n">rval</span> <span class="o">=</span> <span class="n">XFS_ILOG_CORE</span> <span class="o">|</span> <span class="n">XFS_ILOG_DEXT</span><span class="p">;</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="n">rval</span> <span class="o">=</span> <span class="n">XFS_ILOG_CORE</span><span class="p">;</span>
			<span class="n">error</span> <span class="o">=</span> <span class="n">xfs_bmbt_lookup_eq</span><span class="p">(</span><span class="n">bma</span><span class="o">-&gt;</span><span class="n">cur</span><span class="p">,</span> <span class="n">new</span><span class="o">-&gt;</span><span class="n">br_startoff</span><span class="p">,</span>
					<span class="n">new</span><span class="o">-&gt;</span><span class="n">br_startblock</span><span class="p">,</span> <span class="n">new</span><span class="o">-&gt;</span><span class="n">br_blockcount</span><span class="p">,</span>
					<span class="o">&amp;</span><span class="n">i</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
			<span class="n">XFS_WANT_CORRUPTED_GOTO</span><span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="n">done</span><span class="p">);</span>
			<span class="n">bma</span><span class="o">-&gt;</span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">bc_rec</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">br_state</span> <span class="o">=</span> <span class="n">XFS_EXT_NORM</span><span class="p">;</span>
			<span class="n">error</span> <span class="o">=</span> <span class="n">xfs_btree_insert</span><span class="p">(</span><span class="n">bma</span><span class="o">-&gt;</span><span class="n">cur</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">i</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
			<span class="n">XFS_WANT_CORRUPTED_GOTO</span><span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="n">done</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">xfs_bmap_needs_btree</span><span class="p">(</span><span class="n">bma</span><span class="o">-&gt;</span><span class="n">ip</span><span class="p">,</span> <span class="n">XFS_DATA_FORK</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">error</span> <span class="o">=</span> <span class="n">xfs_bmap_extents_to_btree</span><span class="p">(</span><span class="n">bma</span><span class="o">-&gt;</span><span class="n">tp</span><span class="p">,</span> <span class="n">bma</span><span class="o">-&gt;</span><span class="n">ip</span><span class="p">,</span>
					<span class="n">bma</span><span class="o">-&gt;</span><span class="n">firstblock</span><span class="p">,</span> <span class="n">bma</span><span class="o">-&gt;</span><span class="n">flist</span><span class="p">,</span>
					<span class="o">&amp;</span><span class="n">bma</span><span class="o">-&gt;</span><span class="n">cur</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tmp_rval</span><span class="p">,</span> <span class="n">XFS_DATA_FORK</span><span class="p">);</span>
			<span class="n">rval</span> <span class="o">|=</span> <span class="n">tmp_rval</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">da_new</span> <span class="o">=</span> <span class="n">XFS_FILBLKS_MIN</span><span class="p">(</span><span class="n">xfs_bmap_worst_indlen</span><span class="p">(</span><span class="n">bma</span><span class="o">-&gt;</span><span class="n">ip</span><span class="p">,</span> <span class="n">temp</span><span class="p">),</span>
			<span class="n">startblockval</span><span class="p">(</span><span class="n">PREV</span><span class="p">.</span><span class="n">br_startblock</span><span class="p">)</span> <span class="o">-</span>
			<span class="p">(</span><span class="n">bma</span><span class="o">-&gt;</span><span class="n">cur</span> <span class="o">?</span> <span class="n">bma</span><span class="o">-&gt;</span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">bc_private</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">allocated</span> <span class="o">:</span> <span class="mi">0</span><span class="p">));</span>
		<span class="n">ep</span> <span class="o">=</span> <span class="n">xfs_iext_get_ext</span><span class="p">(</span><span class="n">ifp</span><span class="p">,</span> <span class="n">bma</span><span class="o">-&gt;</span><span class="n">idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">xfs_bmbt_set_startblock</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="n">nullstartblock</span><span class="p">(</span><span class="n">da_new</span><span class="p">));</span>
		<span class="n">trace_xfs_bmap_post_update</span><span class="p">(</span><span class="n">bma</span><span class="o">-&gt;</span><span class="n">ip</span><span class="p">,</span> <span class="n">bma</span><span class="o">-&gt;</span><span class="n">idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">_THIS_IP_</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">BMAP_RIGHT_FILLING</span> <span class="o">|</span> <span class="n">BMAP_RIGHT_CONTIG</span>:
		<span class="cm">/*</span>
<span class="cm">		 * Filling in the last part of a previous delayed allocation.</span>
<span class="cm">		 * The right neighbor is contiguous with the new allocation.</span>
<span class="cm">		 */</span>
		<span class="n">temp</span> <span class="o">=</span> <span class="n">PREV</span><span class="p">.</span><span class="n">br_blockcount</span> <span class="o">-</span> <span class="n">new</span><span class="o">-&gt;</span><span class="n">br_blockcount</span><span class="p">;</span>
		<span class="n">trace_xfs_bmap_pre_update</span><span class="p">(</span><span class="n">bma</span><span class="o">-&gt;</span><span class="n">ip</span><span class="p">,</span> <span class="n">bma</span><span class="o">-&gt;</span><span class="n">idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">_THIS_IP_</span><span class="p">);</span>
		<span class="n">xfs_bmbt_set_blockcount</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="n">temp</span><span class="p">);</span>
		<span class="n">xfs_bmbt_set_allf</span><span class="p">(</span><span class="n">xfs_iext_get_ext</span><span class="p">(</span><span class="n">ifp</span><span class="p">,</span> <span class="n">bma</span><span class="o">-&gt;</span><span class="n">idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span>
			<span class="n">new</span><span class="o">-&gt;</span><span class="n">br_startoff</span><span class="p">,</span> <span class="n">new</span><span class="o">-&gt;</span><span class="n">br_startblock</span><span class="p">,</span>
			<span class="n">new</span><span class="o">-&gt;</span><span class="n">br_blockcount</span> <span class="o">+</span> <span class="n">RIGHT</span><span class="p">.</span><span class="n">br_blockcount</span><span class="p">,</span>
			<span class="n">RIGHT</span><span class="p">.</span><span class="n">br_state</span><span class="p">);</span>
		<span class="n">trace_xfs_bmap_post_update</span><span class="p">(</span><span class="n">bma</span><span class="o">-&gt;</span><span class="n">ip</span><span class="p">,</span> <span class="n">bma</span><span class="o">-&gt;</span><span class="n">idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">_THIS_IP_</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bma</span><span class="o">-&gt;</span><span class="n">cur</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="n">rval</span> <span class="o">=</span> <span class="n">XFS_ILOG_DEXT</span><span class="p">;</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="n">rval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">error</span> <span class="o">=</span> <span class="n">xfs_bmbt_lookup_eq</span><span class="p">(</span><span class="n">bma</span><span class="o">-&gt;</span><span class="n">cur</span><span class="p">,</span> <span class="n">RIGHT</span><span class="p">.</span><span class="n">br_startoff</span><span class="p">,</span>
					<span class="n">RIGHT</span><span class="p">.</span><span class="n">br_startblock</span><span class="p">,</span>
					<span class="n">RIGHT</span><span class="p">.</span><span class="n">br_blockcount</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">i</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
			<span class="n">XFS_WANT_CORRUPTED_GOTO</span><span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="n">done</span><span class="p">);</span>
			<span class="n">error</span> <span class="o">=</span> <span class="n">xfs_bmbt_update</span><span class="p">(</span><span class="n">bma</span><span class="o">-&gt;</span><span class="n">cur</span><span class="p">,</span> <span class="n">new</span><span class="o">-&gt;</span><span class="n">br_startoff</span><span class="p">,</span>
					<span class="n">new</span><span class="o">-&gt;</span><span class="n">br_startblock</span><span class="p">,</span>
					<span class="n">new</span><span class="o">-&gt;</span><span class="n">br_blockcount</span> <span class="o">+</span>
					<span class="n">RIGHT</span><span class="p">.</span><span class="n">br_blockcount</span><span class="p">,</span>
					<span class="n">RIGHT</span><span class="p">.</span><span class="n">br_state</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">da_new</span> <span class="o">=</span> <span class="n">XFS_FILBLKS_MIN</span><span class="p">(</span><span class="n">xfs_bmap_worst_indlen</span><span class="p">(</span><span class="n">bma</span><span class="o">-&gt;</span><span class="n">ip</span><span class="p">,</span> <span class="n">temp</span><span class="p">),</span>
			<span class="n">startblockval</span><span class="p">(</span><span class="n">PREV</span><span class="p">.</span><span class="n">br_startblock</span><span class="p">));</span>
		<span class="n">trace_xfs_bmap_pre_update</span><span class="p">(</span><span class="n">bma</span><span class="o">-&gt;</span><span class="n">ip</span><span class="p">,</span> <span class="n">bma</span><span class="o">-&gt;</span><span class="n">idx</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">_THIS_IP_</span><span class="p">);</span>
		<span class="n">xfs_bmbt_set_startblock</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="n">nullstartblock</span><span class="p">(</span><span class="n">da_new</span><span class="p">));</span>
		<span class="n">trace_xfs_bmap_post_update</span><span class="p">(</span><span class="n">bma</span><span class="o">-&gt;</span><span class="n">ip</span><span class="p">,</span> <span class="n">bma</span><span class="o">-&gt;</span><span class="n">idx</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">_THIS_IP_</span><span class="p">);</span>

		<span class="n">bma</span><span class="o">-&gt;</span><span class="n">idx</span><span class="o">++</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">BMAP_RIGHT_FILLING</span>:
		<span class="cm">/*</span>
<span class="cm">		 * Filling in the last part of a previous delayed allocation.</span>
<span class="cm">		 * The right neighbor is not contiguous.</span>
<span class="cm">		 */</span>
		<span class="n">temp</span> <span class="o">=</span> <span class="n">PREV</span><span class="p">.</span><span class="n">br_blockcount</span> <span class="o">-</span> <span class="n">new</span><span class="o">-&gt;</span><span class="n">br_blockcount</span><span class="p">;</span>
		<span class="n">trace_xfs_bmap_pre_update</span><span class="p">(</span><span class="n">bma</span><span class="o">-&gt;</span><span class="n">ip</span><span class="p">,</span> <span class="n">bma</span><span class="o">-&gt;</span><span class="n">idx</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">_THIS_IP_</span><span class="p">);</span>
		<span class="n">xfs_bmbt_set_blockcount</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="n">temp</span><span class="p">);</span>
		<span class="n">xfs_iext_insert</span><span class="p">(</span><span class="n">bma</span><span class="o">-&gt;</span><span class="n">ip</span><span class="p">,</span> <span class="n">bma</span><span class="o">-&gt;</span><span class="n">idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">new</span><span class="p">,</span> <span class="n">state</span><span class="p">);</span>
		<span class="n">bma</span><span class="o">-&gt;</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_d</span><span class="p">.</span><span class="n">di_nextents</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bma</span><span class="o">-&gt;</span><span class="n">cur</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="n">rval</span> <span class="o">=</span> <span class="n">XFS_ILOG_CORE</span> <span class="o">|</span> <span class="n">XFS_ILOG_DEXT</span><span class="p">;</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="n">rval</span> <span class="o">=</span> <span class="n">XFS_ILOG_CORE</span><span class="p">;</span>
			<span class="n">error</span> <span class="o">=</span> <span class="n">xfs_bmbt_lookup_eq</span><span class="p">(</span><span class="n">bma</span><span class="o">-&gt;</span><span class="n">cur</span><span class="p">,</span> <span class="n">new</span><span class="o">-&gt;</span><span class="n">br_startoff</span><span class="p">,</span>
					<span class="n">new</span><span class="o">-&gt;</span><span class="n">br_startblock</span><span class="p">,</span> <span class="n">new</span><span class="o">-&gt;</span><span class="n">br_blockcount</span><span class="p">,</span>
					<span class="o">&amp;</span><span class="n">i</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
			<span class="n">XFS_WANT_CORRUPTED_GOTO</span><span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="n">done</span><span class="p">);</span>
			<span class="n">bma</span><span class="o">-&gt;</span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">bc_rec</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">br_state</span> <span class="o">=</span> <span class="n">XFS_EXT_NORM</span><span class="p">;</span>
			<span class="n">error</span> <span class="o">=</span> <span class="n">xfs_btree_insert</span><span class="p">(</span><span class="n">bma</span><span class="o">-&gt;</span><span class="n">cur</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">i</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
			<span class="n">XFS_WANT_CORRUPTED_GOTO</span><span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="n">done</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">xfs_bmap_needs_btree</span><span class="p">(</span><span class="n">bma</span><span class="o">-&gt;</span><span class="n">ip</span><span class="p">,</span> <span class="n">XFS_DATA_FORK</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">error</span> <span class="o">=</span> <span class="n">xfs_bmap_extents_to_btree</span><span class="p">(</span><span class="n">bma</span><span class="o">-&gt;</span><span class="n">tp</span><span class="p">,</span> <span class="n">bma</span><span class="o">-&gt;</span><span class="n">ip</span><span class="p">,</span>
				<span class="n">bma</span><span class="o">-&gt;</span><span class="n">firstblock</span><span class="p">,</span> <span class="n">bma</span><span class="o">-&gt;</span><span class="n">flist</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bma</span><span class="o">-&gt;</span><span class="n">cur</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="n">tmp_rval</span><span class="p">,</span> <span class="n">XFS_DATA_FORK</span><span class="p">);</span>
			<span class="n">rval</span> <span class="o">|=</span> <span class="n">tmp_rval</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">da_new</span> <span class="o">=</span> <span class="n">XFS_FILBLKS_MIN</span><span class="p">(</span><span class="n">xfs_bmap_worst_indlen</span><span class="p">(</span><span class="n">bma</span><span class="o">-&gt;</span><span class="n">ip</span><span class="p">,</span> <span class="n">temp</span><span class="p">),</span>
			<span class="n">startblockval</span><span class="p">(</span><span class="n">PREV</span><span class="p">.</span><span class="n">br_startblock</span><span class="p">)</span> <span class="o">-</span>
			<span class="p">(</span><span class="n">bma</span><span class="o">-&gt;</span><span class="n">cur</span> <span class="o">?</span> <span class="n">bma</span><span class="o">-&gt;</span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">bc_private</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">allocated</span> <span class="o">:</span> <span class="mi">0</span><span class="p">));</span>
		<span class="n">ep</span> <span class="o">=</span> <span class="n">xfs_iext_get_ext</span><span class="p">(</span><span class="n">ifp</span><span class="p">,</span> <span class="n">bma</span><span class="o">-&gt;</span><span class="n">idx</span><span class="p">);</span>
		<span class="n">xfs_bmbt_set_startblock</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="n">nullstartblock</span><span class="p">(</span><span class="n">da_new</span><span class="p">));</span>
		<span class="n">trace_xfs_bmap_post_update</span><span class="p">(</span><span class="n">bma</span><span class="o">-&gt;</span><span class="n">ip</span><span class="p">,</span> <span class="n">bma</span><span class="o">-&gt;</span><span class="n">idx</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">_THIS_IP_</span><span class="p">);</span>

		<span class="n">bma</span><span class="o">-&gt;</span><span class="n">idx</span><span class="o">++</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="mi">0</span>:
		<span class="cm">/*</span>
<span class="cm">		 * Filling in the middle part of a previous delayed allocation.</span>
<span class="cm">		 * Contiguity is impossible here.</span>
<span class="cm">		 * This case is avoided almost all the time.</span>
<span class="cm">		 *</span>
<span class="cm">		 * We start with a delayed allocation:</span>
<span class="cm">		 *</span>
<span class="cm">		 * +ddddddddddddddddddddddddddddddddddddddddddddddddddddddd+</span>
<span class="cm">		 *  PREV @ idx</span>
<span class="cm">		 *</span>
<span class="cm">	         * and we are allocating:</span>
<span class="cm">		 *                     +rrrrrrrrrrrrrrrrr+</span>
<span class="cm">		 *			      new</span>
<span class="cm">		 *</span>
<span class="cm">		 * and we set it up for insertion as:</span>
<span class="cm">		 * +ddddddddddddddddddd+rrrrrrrrrrrrrrrrr+ddddddddddddddddd+</span>
<span class="cm">		 *                            new</span>
<span class="cm">		 *  PREV @ idx          LEFT              RIGHT</span>
<span class="cm">		 *                      inserted at idx + 1</span>
<span class="cm">		 */</span>
		<span class="n">temp</span> <span class="o">=</span> <span class="n">new</span><span class="o">-&gt;</span><span class="n">br_startoff</span> <span class="o">-</span> <span class="n">PREV</span><span class="p">.</span><span class="n">br_startoff</span><span class="p">;</span>
		<span class="n">temp2</span> <span class="o">=</span> <span class="n">PREV</span><span class="p">.</span><span class="n">br_startoff</span> <span class="o">+</span> <span class="n">PREV</span><span class="p">.</span><span class="n">br_blockcount</span> <span class="o">-</span> <span class="n">new_endoff</span><span class="p">;</span>
		<span class="n">trace_xfs_bmap_pre_update</span><span class="p">(</span><span class="n">bma</span><span class="o">-&gt;</span><span class="n">ip</span><span class="p">,</span> <span class="n">bma</span><span class="o">-&gt;</span><span class="n">idx</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">_THIS_IP_</span><span class="p">);</span>
		<span class="n">xfs_bmbt_set_blockcount</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="n">temp</span><span class="p">);</span>	<span class="cm">/* truncate PREV */</span>
		<span class="n">LEFT</span> <span class="o">=</span> <span class="o">*</span><span class="n">new</span><span class="p">;</span>
		<span class="n">RIGHT</span><span class="p">.</span><span class="n">br_state</span> <span class="o">=</span> <span class="n">PREV</span><span class="p">.</span><span class="n">br_state</span><span class="p">;</span>
		<span class="n">RIGHT</span><span class="p">.</span><span class="n">br_startblock</span> <span class="o">=</span> <span class="n">nullstartblock</span><span class="p">(</span>
				<span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">xfs_bmap_worst_indlen</span><span class="p">(</span><span class="n">bma</span><span class="o">-&gt;</span><span class="n">ip</span><span class="p">,</span> <span class="n">temp2</span><span class="p">));</span>
		<span class="n">RIGHT</span><span class="p">.</span><span class="n">br_startoff</span> <span class="o">=</span> <span class="n">new_endoff</span><span class="p">;</span>
		<span class="n">RIGHT</span><span class="p">.</span><span class="n">br_blockcount</span> <span class="o">=</span> <span class="n">temp2</span><span class="p">;</span>
		<span class="cm">/* insert LEFT (r[0]) and RIGHT (r[1]) at the same time */</span>
		<span class="n">xfs_iext_insert</span><span class="p">(</span><span class="n">bma</span><span class="o">-&gt;</span><span class="n">ip</span><span class="p">,</span> <span class="n">bma</span><span class="o">-&gt;</span><span class="n">idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">LEFT</span><span class="p">,</span> <span class="n">state</span><span class="p">);</span>
		<span class="n">bma</span><span class="o">-&gt;</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_d</span><span class="p">.</span><span class="n">di_nextents</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bma</span><span class="o">-&gt;</span><span class="n">cur</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="n">rval</span> <span class="o">=</span> <span class="n">XFS_ILOG_CORE</span> <span class="o">|</span> <span class="n">XFS_ILOG_DEXT</span><span class="p">;</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="n">rval</span> <span class="o">=</span> <span class="n">XFS_ILOG_CORE</span><span class="p">;</span>
			<span class="n">error</span> <span class="o">=</span> <span class="n">xfs_bmbt_lookup_eq</span><span class="p">(</span><span class="n">bma</span><span class="o">-&gt;</span><span class="n">cur</span><span class="p">,</span> <span class="n">new</span><span class="o">-&gt;</span><span class="n">br_startoff</span><span class="p">,</span>
					<span class="n">new</span><span class="o">-&gt;</span><span class="n">br_startblock</span><span class="p">,</span> <span class="n">new</span><span class="o">-&gt;</span><span class="n">br_blockcount</span><span class="p">,</span>
					<span class="o">&amp;</span><span class="n">i</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
			<span class="n">XFS_WANT_CORRUPTED_GOTO</span><span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="n">done</span><span class="p">);</span>
			<span class="n">bma</span><span class="o">-&gt;</span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">bc_rec</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">br_state</span> <span class="o">=</span> <span class="n">XFS_EXT_NORM</span><span class="p">;</span>
			<span class="n">error</span> <span class="o">=</span> <span class="n">xfs_btree_insert</span><span class="p">(</span><span class="n">bma</span><span class="o">-&gt;</span><span class="n">cur</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">i</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
			<span class="n">XFS_WANT_CORRUPTED_GOTO</span><span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="n">done</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">xfs_bmap_needs_btree</span><span class="p">(</span><span class="n">bma</span><span class="o">-&gt;</span><span class="n">ip</span><span class="p">,</span> <span class="n">XFS_DATA_FORK</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">error</span> <span class="o">=</span> <span class="n">xfs_bmap_extents_to_btree</span><span class="p">(</span><span class="n">bma</span><span class="o">-&gt;</span><span class="n">tp</span><span class="p">,</span> <span class="n">bma</span><span class="o">-&gt;</span><span class="n">ip</span><span class="p">,</span>
					<span class="n">bma</span><span class="o">-&gt;</span><span class="n">firstblock</span><span class="p">,</span> <span class="n">bma</span><span class="o">-&gt;</span><span class="n">flist</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bma</span><span class="o">-&gt;</span><span class="n">cur</span><span class="p">,</span>
					<span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tmp_rval</span><span class="p">,</span> <span class="n">XFS_DATA_FORK</span><span class="p">);</span>
			<span class="n">rval</span> <span class="o">|=</span> <span class="n">tmp_rval</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">temp</span> <span class="o">=</span> <span class="n">xfs_bmap_worst_indlen</span><span class="p">(</span><span class="n">bma</span><span class="o">-&gt;</span><span class="n">ip</span><span class="p">,</span> <span class="n">temp</span><span class="p">);</span>
		<span class="n">temp2</span> <span class="o">=</span> <span class="n">xfs_bmap_worst_indlen</span><span class="p">(</span><span class="n">bma</span><span class="o">-&gt;</span><span class="n">ip</span><span class="p">,</span> <span class="n">temp2</span><span class="p">);</span>
		<span class="n">diff</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)(</span><span class="n">temp</span> <span class="o">+</span> <span class="n">temp2</span> <span class="o">-</span> <span class="n">startblockval</span><span class="p">(</span><span class="n">PREV</span><span class="p">.</span><span class="n">br_startblock</span><span class="p">)</span> <span class="o">-</span>
			<span class="p">(</span><span class="n">bma</span><span class="o">-&gt;</span><span class="n">cur</span> <span class="o">?</span> <span class="n">bma</span><span class="o">-&gt;</span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">bc_private</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">allocated</span> <span class="o">:</span> <span class="mi">0</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">diff</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">error</span> <span class="o">=</span> <span class="n">xfs_icsb_modify_counters</span><span class="p">(</span><span class="n">bma</span><span class="o">-&gt;</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_mount</span><span class="p">,</span>
					<span class="n">XFS_SBS_FDBLOCKS</span><span class="p">,</span>
					<span class="o">-</span><span class="p">((</span><span class="kt">int64_t</span><span class="p">)</span><span class="n">diff</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">ASSERT</span><span class="p">(</span><span class="o">!</span><span class="n">error</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">ep</span> <span class="o">=</span> <span class="n">xfs_iext_get_ext</span><span class="p">(</span><span class="n">ifp</span><span class="p">,</span> <span class="n">bma</span><span class="o">-&gt;</span><span class="n">idx</span><span class="p">);</span>
		<span class="n">xfs_bmbt_set_startblock</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="n">nullstartblock</span><span class="p">((</span><span class="kt">int</span><span class="p">)</span><span class="n">temp</span><span class="p">));</span>
		<span class="n">trace_xfs_bmap_post_update</span><span class="p">(</span><span class="n">bma</span><span class="o">-&gt;</span><span class="n">ip</span><span class="p">,</span> <span class="n">bma</span><span class="o">-&gt;</span><span class="n">idx</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">_THIS_IP_</span><span class="p">);</span>
		<span class="n">trace_xfs_bmap_pre_update</span><span class="p">(</span><span class="n">bma</span><span class="o">-&gt;</span><span class="n">ip</span><span class="p">,</span> <span class="n">bma</span><span class="o">-&gt;</span><span class="n">idx</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">_THIS_IP_</span><span class="p">);</span>
		<span class="n">xfs_bmbt_set_startblock</span><span class="p">(</span><span class="n">xfs_iext_get_ext</span><span class="p">(</span><span class="n">ifp</span><span class="p">,</span> <span class="n">bma</span><span class="o">-&gt;</span><span class="n">idx</span> <span class="o">+</span> <span class="mi">2</span><span class="p">),</span>
			<span class="n">nullstartblock</span><span class="p">((</span><span class="kt">int</span><span class="p">)</span><span class="n">temp2</span><span class="p">));</span>
		<span class="n">trace_xfs_bmap_post_update</span><span class="p">(</span><span class="n">bma</span><span class="o">-&gt;</span><span class="n">ip</span><span class="p">,</span> <span class="n">bma</span><span class="o">-&gt;</span><span class="n">idx</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">_THIS_IP_</span><span class="p">);</span>

		<span class="n">bma</span><span class="o">-&gt;</span><span class="n">idx</span><span class="o">++</span><span class="p">;</span>
		<span class="n">da_new</span> <span class="o">=</span> <span class="n">temp</span> <span class="o">+</span> <span class="n">temp2</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">BMAP_LEFT_FILLING</span> <span class="o">|</span> <span class="n">BMAP_LEFT_CONTIG</span> <span class="o">|</span> <span class="n">BMAP_RIGHT_CONTIG</span>:
	<span class="k">case</span> <span class="n">BMAP_RIGHT_FILLING</span> <span class="o">|</span> <span class="n">BMAP_LEFT_CONTIG</span> <span class="o">|</span> <span class="n">BMAP_RIGHT_CONTIG</span>:
	<span class="k">case</span> <span class="n">BMAP_LEFT_FILLING</span> <span class="o">|</span> <span class="n">BMAP_RIGHT_CONTIG</span>:
	<span class="k">case</span> <span class="n">BMAP_RIGHT_FILLING</span> <span class="o">|</span> <span class="n">BMAP_LEFT_CONTIG</span>:
	<span class="k">case</span> <span class="n">BMAP_LEFT_CONTIG</span> <span class="o">|</span> <span class="n">BMAP_RIGHT_CONTIG</span>:
	<span class="k">case</span> <span class="n">BMAP_LEFT_CONTIG</span>:
	<span class="k">case</span> <span class="n">BMAP_RIGHT_CONTIG</span>:
		<span class="cm">/*</span>
<span class="cm">		 * These cases are all impossible.</span>
<span class="cm">		 */</span>
		<span class="n">ASSERT</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* convert to a btree if necessary */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">xfs_bmap_needs_btree</span><span class="p">(</span><span class="n">bma</span><span class="o">-&gt;</span><span class="n">ip</span><span class="p">,</span> <span class="n">XFS_DATA_FORK</span><span class="p">))</span> <span class="p">{</span>
		<span class="kt">int</span>	<span class="n">tmp_logflags</span><span class="p">;</span>	<span class="cm">/* partial log flag return val */</span>

		<span class="n">ASSERT</span><span class="p">(</span><span class="n">bma</span><span class="o">-&gt;</span><span class="n">cur</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="n">error</span> <span class="o">=</span> <span class="n">xfs_bmap_extents_to_btree</span><span class="p">(</span><span class="n">bma</span><span class="o">-&gt;</span><span class="n">tp</span><span class="p">,</span> <span class="n">bma</span><span class="o">-&gt;</span><span class="n">ip</span><span class="p">,</span>
				<span class="n">bma</span><span class="o">-&gt;</span><span class="n">firstblock</span><span class="p">,</span> <span class="n">bma</span><span class="o">-&gt;</span><span class="n">flist</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bma</span><span class="o">-&gt;</span><span class="n">cur</span><span class="p">,</span>
				<span class="n">da_old</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tmp_logflags</span><span class="p">,</span> <span class="n">XFS_DATA_FORK</span><span class="p">);</span>
		<span class="n">bma</span><span class="o">-&gt;</span><span class="n">logflags</span> <span class="o">|=</span> <span class="n">tmp_logflags</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* adjust for changes in reserved delayed indirect blocks */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">da_old</span> <span class="o">||</span> <span class="n">da_new</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">temp</span> <span class="o">=</span> <span class="n">da_new</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bma</span><span class="o">-&gt;</span><span class="n">cur</span><span class="p">)</span>
			<span class="n">temp</span> <span class="o">+=</span> <span class="n">bma</span><span class="o">-&gt;</span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">bc_private</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">allocated</span><span class="p">;</span>
		<span class="n">ASSERT</span><span class="p">(</span><span class="n">temp</span> <span class="o">&lt;=</span> <span class="n">da_old</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">temp</span> <span class="o">&lt;</span> <span class="n">da_old</span><span class="p">)</span>
			<span class="n">xfs_icsb_modify_counters</span><span class="p">(</span><span class="n">bma</span><span class="o">-&gt;</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_mount</span><span class="p">,</span>
					<span class="n">XFS_SBS_FDBLOCKS</span><span class="p">,</span>
					<span class="p">(</span><span class="kt">int64_t</span><span class="p">)(</span><span class="n">da_old</span> <span class="o">-</span> <span class="n">temp</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* clear out the allocated field, done with it now in any case. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bma</span><span class="o">-&gt;</span><span class="n">cur</span><span class="p">)</span>
		<span class="n">bma</span><span class="o">-&gt;</span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">bc_private</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">allocated</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">xfs_bmap_check_leaf_extents</span><span class="p">(</span><span class="n">bma</span><span class="o">-&gt;</span><span class="n">cur</span><span class="p">,</span> <span class="n">bma</span><span class="o">-&gt;</span><span class="n">ip</span><span class="p">,</span> <span class="n">XFS_DATA_FORK</span><span class="p">);</span>
<span class="nl">done:</span>
	<span class="n">bma</span><span class="o">-&gt;</span><span class="n">logflags</span> <span class="o">|=</span> <span class="n">rval</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
<span class="cp">#undef	LEFT</span>
<span class="cp">#undef	RIGHT</span>
<span class="cp">#undef	PREV</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Convert an unwritten allocation to a real allocation or vice versa.</span>
<span class="cm"> */</span>
<span class="n">STATIC</span> <span class="kt">int</span>				<span class="cm">/* error */</span>
<span class="n">xfs_bmap_add_extent_unwritten_real</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">xfs_trans</span>	<span class="o">*</span><span class="n">tp</span><span class="p">,</span>
	<span class="n">xfs_inode_t</span>		<span class="o">*</span><span class="n">ip</span><span class="p">,</span>	<span class="cm">/* incore inode pointer */</span>
	<span class="n">xfs_extnum_t</span>		<span class="o">*</span><span class="n">idx</span><span class="p">,</span>	<span class="cm">/* extent number to update/insert */</span>
	<span class="n">xfs_btree_cur_t</span>		<span class="o">**</span><span class="n">curp</span><span class="p">,</span>	<span class="cm">/* if *curp is null, not a btree */</span>
	<span class="n">xfs_bmbt_irec_t</span>		<span class="o">*</span><span class="n">new</span><span class="p">,</span>	<span class="cm">/* new data to add to file extents */</span>
	<span class="n">xfs_fsblock_t</span>		<span class="o">*</span><span class="n">first</span><span class="p">,</span>	<span class="cm">/* pointer to firstblock variable */</span>
	<span class="n">xfs_bmap_free_t</span>		<span class="o">*</span><span class="n">flist</span><span class="p">,</span>	<span class="cm">/* list of extents to be freed */</span>
	<span class="kt">int</span>			<span class="o">*</span><span class="n">logflagsp</span><span class="p">)</span> <span class="cm">/* inode logging flags */</span>
<span class="p">{</span>
	<span class="n">xfs_btree_cur_t</span>		<span class="o">*</span><span class="n">cur</span><span class="p">;</span>	<span class="cm">/* btree cursor */</span>
	<span class="n">xfs_bmbt_rec_host_t</span>	<span class="o">*</span><span class="n">ep</span><span class="p">;</span>	<span class="cm">/* extent entry for idx */</span>
	<span class="kt">int</span>			<span class="n">error</span><span class="p">;</span>	<span class="cm">/* error return value */</span>
	<span class="kt">int</span>			<span class="n">i</span><span class="p">;</span>	<span class="cm">/* temp state */</span>
	<span class="n">xfs_ifork_t</span>		<span class="o">*</span><span class="n">ifp</span><span class="p">;</span>	<span class="cm">/* inode fork pointer */</span>
	<span class="n">xfs_fileoff_t</span>		<span class="n">new_endoff</span><span class="p">;</span>	<span class="cm">/* end offset of new entry */</span>
	<span class="n">xfs_exntst_t</span>		<span class="n">newext</span><span class="p">;</span>	<span class="cm">/* new extent state */</span>
	<span class="n">xfs_exntst_t</span>		<span class="n">oldext</span><span class="p">;</span>	<span class="cm">/* old extent state */</span>
	<span class="n">xfs_bmbt_irec_t</span>		<span class="n">r</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>	<span class="cm">/* neighbor extent entries */</span>
					<span class="cm">/* left is 0, right is 1, prev is 2 */</span>
	<span class="kt">int</span>			<span class="n">rval</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>	<span class="cm">/* return value (logging flags) */</span>
	<span class="kt">int</span>			<span class="n">state</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span><span class="cm">/* state bits, accessed thru macros */</span>

	<span class="o">*</span><span class="n">logflagsp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">cur</span> <span class="o">=</span> <span class="o">*</span><span class="n">curp</span><span class="p">;</span>
	<span class="n">ifp</span> <span class="o">=</span> <span class="n">XFS_IFORK_PTR</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">XFS_DATA_FORK</span><span class="p">);</span>

	<span class="n">ASSERT</span><span class="p">(</span><span class="o">*</span><span class="n">idx</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">ASSERT</span><span class="p">(</span><span class="o">*</span><span class="n">idx</span> <span class="o">&lt;=</span> <span class="n">ifp</span><span class="o">-&gt;</span><span class="n">if_bytes</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">xfs_bmbt_rec</span><span class="p">));</span>
	<span class="n">ASSERT</span><span class="p">(</span><span class="o">!</span><span class="n">isnullstartblock</span><span class="p">(</span><span class="n">new</span><span class="o">-&gt;</span><span class="n">br_startblock</span><span class="p">));</span>

	<span class="n">XFS_STATS_INC</span><span class="p">(</span><span class="n">xs_add_exlist</span><span class="p">);</span>

<span class="cp">#define	LEFT		r[0]</span>
<span class="cp">#define	RIGHT		r[1]</span>
<span class="cp">#define	PREV		r[2]</span>

	<span class="cm">/*</span>
<span class="cm">	 * Set up a bunch of variables to make the tests simpler.</span>
<span class="cm">	 */</span>
	<span class="n">error</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ep</span> <span class="o">=</span> <span class="n">xfs_iext_get_ext</span><span class="p">(</span><span class="n">ifp</span><span class="p">,</span> <span class="o">*</span><span class="n">idx</span><span class="p">);</span>
	<span class="n">xfs_bmbt_get_all</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">PREV</span><span class="p">);</span>
	<span class="n">newext</span> <span class="o">=</span> <span class="n">new</span><span class="o">-&gt;</span><span class="n">br_state</span><span class="p">;</span>
	<span class="n">oldext</span> <span class="o">=</span> <span class="p">(</span><span class="n">newext</span> <span class="o">==</span> <span class="n">XFS_EXT_UNWRITTEN</span><span class="p">)</span> <span class="o">?</span>
		<span class="n">XFS_EXT_NORM</span> <span class="o">:</span> <span class="n">XFS_EXT_UNWRITTEN</span><span class="p">;</span>
	<span class="n">ASSERT</span><span class="p">(</span><span class="n">PREV</span><span class="p">.</span><span class="n">br_state</span> <span class="o">==</span> <span class="n">oldext</span><span class="p">);</span>
	<span class="n">new_endoff</span> <span class="o">=</span> <span class="n">new</span><span class="o">-&gt;</span><span class="n">br_startoff</span> <span class="o">+</span> <span class="n">new</span><span class="o">-&gt;</span><span class="n">br_blockcount</span><span class="p">;</span>
	<span class="n">ASSERT</span><span class="p">(</span><span class="n">PREV</span><span class="p">.</span><span class="n">br_startoff</span> <span class="o">&lt;=</span> <span class="n">new</span><span class="o">-&gt;</span><span class="n">br_startoff</span><span class="p">);</span>
	<span class="n">ASSERT</span><span class="p">(</span><span class="n">PREV</span><span class="p">.</span><span class="n">br_startoff</span> <span class="o">+</span> <span class="n">PREV</span><span class="p">.</span><span class="n">br_blockcount</span> <span class="o">&gt;=</span> <span class="n">new_endoff</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Set flags determining what part of the previous oldext allocation</span>
<span class="cm">	 * extent is being replaced by a newext allocation.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">PREV</span><span class="p">.</span><span class="n">br_startoff</span> <span class="o">==</span> <span class="n">new</span><span class="o">-&gt;</span><span class="n">br_startoff</span><span class="p">)</span>
		<span class="n">state</span> <span class="o">|=</span> <span class="n">BMAP_LEFT_FILLING</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">PREV</span><span class="p">.</span><span class="n">br_startoff</span> <span class="o">+</span> <span class="n">PREV</span><span class="p">.</span><span class="n">br_blockcount</span> <span class="o">==</span> <span class="n">new_endoff</span><span class="p">)</span>
		<span class="n">state</span> <span class="o">|=</span> <span class="n">BMAP_RIGHT_FILLING</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Check and set flags if this segment has a left neighbor.</span>
<span class="cm">	 * Don&#39;t set contiguous if the combined extent would be too large.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">idx</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">state</span> <span class="o">|=</span> <span class="n">BMAP_LEFT_VALID</span><span class="p">;</span>
		<span class="n">xfs_bmbt_get_all</span><span class="p">(</span><span class="n">xfs_iext_get_ext</span><span class="p">(</span><span class="n">ifp</span><span class="p">,</span> <span class="o">*</span><span class="n">idx</span> <span class="o">-</span> <span class="mi">1</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">LEFT</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">isnullstartblock</span><span class="p">(</span><span class="n">LEFT</span><span class="p">.</span><span class="n">br_startblock</span><span class="p">))</span>
			<span class="n">state</span> <span class="o">|=</span> <span class="n">BMAP_LEFT_DELAY</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">state</span> <span class="o">&amp;</span> <span class="n">BMAP_LEFT_VALID</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">state</span> <span class="o">&amp;</span> <span class="n">BMAP_LEFT_DELAY</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">LEFT</span><span class="p">.</span><span class="n">br_startoff</span> <span class="o">+</span> <span class="n">LEFT</span><span class="p">.</span><span class="n">br_blockcount</span> <span class="o">==</span> <span class="n">new</span><span class="o">-&gt;</span><span class="n">br_startoff</span> <span class="o">&amp;&amp;</span>
	    <span class="n">LEFT</span><span class="p">.</span><span class="n">br_startblock</span> <span class="o">+</span> <span class="n">LEFT</span><span class="p">.</span><span class="n">br_blockcount</span> <span class="o">==</span> <span class="n">new</span><span class="o">-&gt;</span><span class="n">br_startblock</span> <span class="o">&amp;&amp;</span>
	    <span class="n">LEFT</span><span class="p">.</span><span class="n">br_state</span> <span class="o">==</span> <span class="n">newext</span> <span class="o">&amp;&amp;</span>
	    <span class="n">LEFT</span><span class="p">.</span><span class="n">br_blockcount</span> <span class="o">+</span> <span class="n">new</span><span class="o">-&gt;</span><span class="n">br_blockcount</span> <span class="o">&lt;=</span> <span class="n">MAXEXTLEN</span><span class="p">)</span>
		<span class="n">state</span> <span class="o">|=</span> <span class="n">BMAP_LEFT_CONTIG</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Check and set flags if this segment has a right neighbor.</span>
<span class="cm">	 * Don&#39;t set contiguous if the combined extent would be too large.</span>
<span class="cm">	 * Also check for all-three-contiguous being too large.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">idx</span> <span class="o">&lt;</span> <span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_df</span><span class="p">.</span><span class="n">if_bytes</span> <span class="o">/</span> <span class="p">(</span><span class="n">uint</span><span class="p">)</span><span class="k">sizeof</span><span class="p">(</span><span class="n">xfs_bmbt_rec_t</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">state</span> <span class="o">|=</span> <span class="n">BMAP_RIGHT_VALID</span><span class="p">;</span>
		<span class="n">xfs_bmbt_get_all</span><span class="p">(</span><span class="n">xfs_iext_get_ext</span><span class="p">(</span><span class="n">ifp</span><span class="p">,</span> <span class="o">*</span><span class="n">idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">RIGHT</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">isnullstartblock</span><span class="p">(</span><span class="n">RIGHT</span><span class="p">.</span><span class="n">br_startblock</span><span class="p">))</span>
			<span class="n">state</span> <span class="o">|=</span> <span class="n">BMAP_RIGHT_DELAY</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">state</span> <span class="o">&amp;</span> <span class="n">BMAP_RIGHT_VALID</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">state</span> <span class="o">&amp;</span> <span class="n">BMAP_RIGHT_DELAY</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">new_endoff</span> <span class="o">==</span> <span class="n">RIGHT</span><span class="p">.</span><span class="n">br_startoff</span> <span class="o">&amp;&amp;</span>
	    <span class="n">new</span><span class="o">-&gt;</span><span class="n">br_startblock</span> <span class="o">+</span> <span class="n">new</span><span class="o">-&gt;</span><span class="n">br_blockcount</span> <span class="o">==</span> <span class="n">RIGHT</span><span class="p">.</span><span class="n">br_startblock</span> <span class="o">&amp;&amp;</span>
	    <span class="n">newext</span> <span class="o">==</span> <span class="n">RIGHT</span><span class="p">.</span><span class="n">br_state</span> <span class="o">&amp;&amp;</span>
	    <span class="n">new</span><span class="o">-&gt;</span><span class="n">br_blockcount</span> <span class="o">+</span> <span class="n">RIGHT</span><span class="p">.</span><span class="n">br_blockcount</span> <span class="o">&lt;=</span> <span class="n">MAXEXTLEN</span> <span class="o">&amp;&amp;</span>
	    <span class="p">((</span><span class="n">state</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">BMAP_LEFT_CONTIG</span> <span class="o">|</span> <span class="n">BMAP_LEFT_FILLING</span> <span class="o">|</span>
		       <span class="n">BMAP_RIGHT_FILLING</span><span class="p">))</span> <span class="o">!=</span>
		      <span class="p">(</span><span class="n">BMAP_LEFT_CONTIG</span> <span class="o">|</span> <span class="n">BMAP_LEFT_FILLING</span> <span class="o">|</span>
		       <span class="n">BMAP_RIGHT_FILLING</span><span class="p">)</span> <span class="o">||</span>
	     <span class="n">LEFT</span><span class="p">.</span><span class="n">br_blockcount</span> <span class="o">+</span> <span class="n">new</span><span class="o">-&gt;</span><span class="n">br_blockcount</span> <span class="o">+</span> <span class="n">RIGHT</span><span class="p">.</span><span class="n">br_blockcount</span>
			<span class="o">&lt;=</span> <span class="n">MAXEXTLEN</span><span class="p">))</span>
		<span class="n">state</span> <span class="o">|=</span> <span class="n">BMAP_RIGHT_CONTIG</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Switch out based on the FILLING and CONTIG state bits.</span>
<span class="cm">	 */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">state</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">BMAP_LEFT_FILLING</span> <span class="o">|</span> <span class="n">BMAP_LEFT_CONTIG</span> <span class="o">|</span>
			 <span class="n">BMAP_RIGHT_FILLING</span> <span class="o">|</span> <span class="n">BMAP_RIGHT_CONTIG</span><span class="p">))</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">BMAP_LEFT_FILLING</span> <span class="o">|</span> <span class="n">BMAP_LEFT_CONTIG</span> <span class="o">|</span>
	     <span class="n">BMAP_RIGHT_FILLING</span> <span class="o">|</span> <span class="n">BMAP_RIGHT_CONTIG</span><span class="o">:</span>
		<span class="cm">/*</span>
<span class="cm">		 * Setting all of a previous oldext extent to newext.</span>
<span class="cm">		 * The left and right neighbors are both contiguous with new.</span>
<span class="cm">		 */</span>
		<span class="o">--*</span><span class="n">idx</span><span class="p">;</span>

		<span class="n">trace_xfs_bmap_pre_update</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="o">*</span><span class="n">idx</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">_THIS_IP_</span><span class="p">);</span>
		<span class="n">xfs_bmbt_set_blockcount</span><span class="p">(</span><span class="n">xfs_iext_get_ext</span><span class="p">(</span><span class="n">ifp</span><span class="p">,</span> <span class="o">*</span><span class="n">idx</span><span class="p">),</span>
			<span class="n">LEFT</span><span class="p">.</span><span class="n">br_blockcount</span> <span class="o">+</span> <span class="n">PREV</span><span class="p">.</span><span class="n">br_blockcount</span> <span class="o">+</span>
			<span class="n">RIGHT</span><span class="p">.</span><span class="n">br_blockcount</span><span class="p">);</span>
		<span class="n">trace_xfs_bmap_post_update</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="o">*</span><span class="n">idx</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">_THIS_IP_</span><span class="p">);</span>

		<span class="n">xfs_iext_remove</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="o">*</span><span class="n">idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">state</span><span class="p">);</span>
		<span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_d</span><span class="p">.</span><span class="n">di_nextents</span> <span class="o">-=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cur</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="n">rval</span> <span class="o">=</span> <span class="n">XFS_ILOG_CORE</span> <span class="o">|</span> <span class="n">XFS_ILOG_DEXT</span><span class="p">;</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="n">rval</span> <span class="o">=</span> <span class="n">XFS_ILOG_CORE</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">error</span> <span class="o">=</span> <span class="n">xfs_bmbt_lookup_eq</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">RIGHT</span><span class="p">.</span><span class="n">br_startoff</span><span class="p">,</span>
					<span class="n">RIGHT</span><span class="p">.</span><span class="n">br_startblock</span><span class="p">,</span>
					<span class="n">RIGHT</span><span class="p">.</span><span class="n">br_blockcount</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">i</span><span class="p">)))</span>
				<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
			<span class="n">XFS_WANT_CORRUPTED_GOTO</span><span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="n">done</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">error</span> <span class="o">=</span> <span class="n">xfs_btree_delete</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">i</span><span class="p">)))</span>
				<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
			<span class="n">XFS_WANT_CORRUPTED_GOTO</span><span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="n">done</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">error</span> <span class="o">=</span> <span class="n">xfs_btree_decrement</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">i</span><span class="p">)))</span>
				<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
			<span class="n">XFS_WANT_CORRUPTED_GOTO</span><span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="n">done</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">error</span> <span class="o">=</span> <span class="n">xfs_btree_delete</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">i</span><span class="p">)))</span>
				<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
			<span class="n">XFS_WANT_CORRUPTED_GOTO</span><span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="n">done</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">error</span> <span class="o">=</span> <span class="n">xfs_btree_decrement</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">i</span><span class="p">)))</span>
				<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
			<span class="n">XFS_WANT_CORRUPTED_GOTO</span><span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="n">done</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">error</span> <span class="o">=</span> <span class="n">xfs_bmbt_update</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">LEFT</span><span class="p">.</span><span class="n">br_startoff</span><span class="p">,</span>
				<span class="n">LEFT</span><span class="p">.</span><span class="n">br_startblock</span><span class="p">,</span>
				<span class="n">LEFT</span><span class="p">.</span><span class="n">br_blockcount</span> <span class="o">+</span> <span class="n">PREV</span><span class="p">.</span><span class="n">br_blockcount</span> <span class="o">+</span>
				<span class="n">RIGHT</span><span class="p">.</span><span class="n">br_blockcount</span><span class="p">,</span> <span class="n">LEFT</span><span class="p">.</span><span class="n">br_state</span><span class="p">)))</span>
				<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">BMAP_LEFT_FILLING</span> <span class="o">|</span> <span class="n">BMAP_RIGHT_FILLING</span> <span class="o">|</span> <span class="n">BMAP_LEFT_CONTIG</span>:
		<span class="cm">/*</span>
<span class="cm">		 * Setting all of a previous oldext extent to newext.</span>
<span class="cm">		 * The left neighbor is contiguous, the right is not.</span>
<span class="cm">		 */</span>
		<span class="o">--*</span><span class="n">idx</span><span class="p">;</span>

		<span class="n">trace_xfs_bmap_pre_update</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="o">*</span><span class="n">idx</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">_THIS_IP_</span><span class="p">);</span>
		<span class="n">xfs_bmbt_set_blockcount</span><span class="p">(</span><span class="n">xfs_iext_get_ext</span><span class="p">(</span><span class="n">ifp</span><span class="p">,</span> <span class="o">*</span><span class="n">idx</span><span class="p">),</span>
			<span class="n">LEFT</span><span class="p">.</span><span class="n">br_blockcount</span> <span class="o">+</span> <span class="n">PREV</span><span class="p">.</span><span class="n">br_blockcount</span><span class="p">);</span>
		<span class="n">trace_xfs_bmap_post_update</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="o">*</span><span class="n">idx</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">_THIS_IP_</span><span class="p">);</span>

		<span class="n">xfs_iext_remove</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="o">*</span><span class="n">idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">state</span><span class="p">);</span>
		<span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_d</span><span class="p">.</span><span class="n">di_nextents</span><span class="o">--</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cur</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="n">rval</span> <span class="o">=</span> <span class="n">XFS_ILOG_CORE</span> <span class="o">|</span> <span class="n">XFS_ILOG_DEXT</span><span class="p">;</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="n">rval</span> <span class="o">=</span> <span class="n">XFS_ILOG_CORE</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">error</span> <span class="o">=</span> <span class="n">xfs_bmbt_lookup_eq</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">PREV</span><span class="p">.</span><span class="n">br_startoff</span><span class="p">,</span>
					<span class="n">PREV</span><span class="p">.</span><span class="n">br_startblock</span><span class="p">,</span> <span class="n">PREV</span><span class="p">.</span><span class="n">br_blockcount</span><span class="p">,</span>
					<span class="o">&amp;</span><span class="n">i</span><span class="p">)))</span>
				<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
			<span class="n">XFS_WANT_CORRUPTED_GOTO</span><span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="n">done</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">error</span> <span class="o">=</span> <span class="n">xfs_btree_delete</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">i</span><span class="p">)))</span>
				<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
			<span class="n">XFS_WANT_CORRUPTED_GOTO</span><span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="n">done</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">error</span> <span class="o">=</span> <span class="n">xfs_btree_decrement</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">i</span><span class="p">)))</span>
				<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
			<span class="n">XFS_WANT_CORRUPTED_GOTO</span><span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="n">done</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">error</span> <span class="o">=</span> <span class="n">xfs_bmbt_update</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">LEFT</span><span class="p">.</span><span class="n">br_startoff</span><span class="p">,</span>
				<span class="n">LEFT</span><span class="p">.</span><span class="n">br_startblock</span><span class="p">,</span>
				<span class="n">LEFT</span><span class="p">.</span><span class="n">br_blockcount</span> <span class="o">+</span> <span class="n">PREV</span><span class="p">.</span><span class="n">br_blockcount</span><span class="p">,</span>
				<span class="n">LEFT</span><span class="p">.</span><span class="n">br_state</span><span class="p">)))</span>
				<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">BMAP_LEFT_FILLING</span> <span class="o">|</span> <span class="n">BMAP_RIGHT_FILLING</span> <span class="o">|</span> <span class="n">BMAP_RIGHT_CONTIG</span>:
		<span class="cm">/*</span>
<span class="cm">		 * Setting all of a previous oldext extent to newext.</span>
<span class="cm">		 * The right neighbor is contiguous, the left is not.</span>
<span class="cm">		 */</span>
		<span class="n">trace_xfs_bmap_pre_update</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="o">*</span><span class="n">idx</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">_THIS_IP_</span><span class="p">);</span>
		<span class="n">xfs_bmbt_set_blockcount</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span>
			<span class="n">PREV</span><span class="p">.</span><span class="n">br_blockcount</span> <span class="o">+</span> <span class="n">RIGHT</span><span class="p">.</span><span class="n">br_blockcount</span><span class="p">);</span>
		<span class="n">xfs_bmbt_set_state</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="n">newext</span><span class="p">);</span>
		<span class="n">trace_xfs_bmap_post_update</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="o">*</span><span class="n">idx</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">_THIS_IP_</span><span class="p">);</span>
		<span class="n">xfs_iext_remove</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="o">*</span><span class="n">idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">state</span><span class="p">);</span>
		<span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_d</span><span class="p">.</span><span class="n">di_nextents</span><span class="o">--</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cur</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="n">rval</span> <span class="o">=</span> <span class="n">XFS_ILOG_CORE</span> <span class="o">|</span> <span class="n">XFS_ILOG_DEXT</span><span class="p">;</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="n">rval</span> <span class="o">=</span> <span class="n">XFS_ILOG_CORE</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">error</span> <span class="o">=</span> <span class="n">xfs_bmbt_lookup_eq</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">RIGHT</span><span class="p">.</span><span class="n">br_startoff</span><span class="p">,</span>
					<span class="n">RIGHT</span><span class="p">.</span><span class="n">br_startblock</span><span class="p">,</span>
					<span class="n">RIGHT</span><span class="p">.</span><span class="n">br_blockcount</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">i</span><span class="p">)))</span>
				<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
			<span class="n">XFS_WANT_CORRUPTED_GOTO</span><span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="n">done</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">error</span> <span class="o">=</span> <span class="n">xfs_btree_delete</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">i</span><span class="p">)))</span>
				<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
			<span class="n">XFS_WANT_CORRUPTED_GOTO</span><span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="n">done</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">error</span> <span class="o">=</span> <span class="n">xfs_btree_decrement</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">i</span><span class="p">)))</span>
				<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
			<span class="n">XFS_WANT_CORRUPTED_GOTO</span><span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="n">done</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">error</span> <span class="o">=</span> <span class="n">xfs_bmbt_update</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">new</span><span class="o">-&gt;</span><span class="n">br_startoff</span><span class="p">,</span>
				<span class="n">new</span><span class="o">-&gt;</span><span class="n">br_startblock</span><span class="p">,</span>
				<span class="n">new</span><span class="o">-&gt;</span><span class="n">br_blockcount</span> <span class="o">+</span> <span class="n">RIGHT</span><span class="p">.</span><span class="n">br_blockcount</span><span class="p">,</span>
				<span class="n">newext</span><span class="p">)))</span>
				<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">BMAP_LEFT_FILLING</span> <span class="o">|</span> <span class="n">BMAP_RIGHT_FILLING</span>:
		<span class="cm">/*</span>
<span class="cm">		 * Setting all of a previous oldext extent to newext.</span>
<span class="cm">		 * Neither the left nor right neighbors are contiguous with</span>
<span class="cm">		 * the new one.</span>
<span class="cm">		 */</span>
		<span class="n">trace_xfs_bmap_pre_update</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="o">*</span><span class="n">idx</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">_THIS_IP_</span><span class="p">);</span>
		<span class="n">xfs_bmbt_set_state</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="n">newext</span><span class="p">);</span>
		<span class="n">trace_xfs_bmap_post_update</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="o">*</span><span class="n">idx</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">_THIS_IP_</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">cur</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="n">rval</span> <span class="o">=</span> <span class="n">XFS_ILOG_DEXT</span><span class="p">;</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="n">rval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">error</span> <span class="o">=</span> <span class="n">xfs_bmbt_lookup_eq</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">new</span><span class="o">-&gt;</span><span class="n">br_startoff</span><span class="p">,</span>
					<span class="n">new</span><span class="o">-&gt;</span><span class="n">br_startblock</span><span class="p">,</span> <span class="n">new</span><span class="o">-&gt;</span><span class="n">br_blockcount</span><span class="p">,</span>
					<span class="o">&amp;</span><span class="n">i</span><span class="p">)))</span>
				<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
			<span class="n">XFS_WANT_CORRUPTED_GOTO</span><span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="n">done</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">error</span> <span class="o">=</span> <span class="n">xfs_bmbt_update</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">new</span><span class="o">-&gt;</span><span class="n">br_startoff</span><span class="p">,</span>
				<span class="n">new</span><span class="o">-&gt;</span><span class="n">br_startblock</span><span class="p">,</span> <span class="n">new</span><span class="o">-&gt;</span><span class="n">br_blockcount</span><span class="p">,</span>
				<span class="n">newext</span><span class="p">)))</span>
				<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">BMAP_LEFT_FILLING</span> <span class="o">|</span> <span class="n">BMAP_LEFT_CONTIG</span>:
		<span class="cm">/*</span>
<span class="cm">		 * Setting the first part of a previous oldext extent to newext.</span>
<span class="cm">		 * The left neighbor is contiguous.</span>
<span class="cm">		 */</span>
		<span class="n">trace_xfs_bmap_pre_update</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="o">*</span><span class="n">idx</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">_THIS_IP_</span><span class="p">);</span>
		<span class="n">xfs_bmbt_set_blockcount</span><span class="p">(</span><span class="n">xfs_iext_get_ext</span><span class="p">(</span><span class="n">ifp</span><span class="p">,</span> <span class="o">*</span><span class="n">idx</span> <span class="o">-</span> <span class="mi">1</span><span class="p">),</span>
			<span class="n">LEFT</span><span class="p">.</span><span class="n">br_blockcount</span> <span class="o">+</span> <span class="n">new</span><span class="o">-&gt;</span><span class="n">br_blockcount</span><span class="p">);</span>
		<span class="n">xfs_bmbt_set_startoff</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span>
			<span class="n">PREV</span><span class="p">.</span><span class="n">br_startoff</span> <span class="o">+</span> <span class="n">new</span><span class="o">-&gt;</span><span class="n">br_blockcount</span><span class="p">);</span>
		<span class="n">trace_xfs_bmap_post_update</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="o">*</span><span class="n">idx</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">_THIS_IP_</span><span class="p">);</span>

		<span class="n">trace_xfs_bmap_pre_update</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="o">*</span><span class="n">idx</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">_THIS_IP_</span><span class="p">);</span>
		<span class="n">xfs_bmbt_set_startblock</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span>
			<span class="n">new</span><span class="o">-&gt;</span><span class="n">br_startblock</span> <span class="o">+</span> <span class="n">new</span><span class="o">-&gt;</span><span class="n">br_blockcount</span><span class="p">);</span>
		<span class="n">xfs_bmbt_set_blockcount</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span>
			<span class="n">PREV</span><span class="p">.</span><span class="n">br_blockcount</span> <span class="o">-</span> <span class="n">new</span><span class="o">-&gt;</span><span class="n">br_blockcount</span><span class="p">);</span>
		<span class="n">trace_xfs_bmap_post_update</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="o">*</span><span class="n">idx</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">_THIS_IP_</span><span class="p">);</span>

		<span class="o">--*</span><span class="n">idx</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">cur</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="n">rval</span> <span class="o">=</span> <span class="n">XFS_ILOG_DEXT</span><span class="p">;</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="n">rval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">error</span> <span class="o">=</span> <span class="n">xfs_bmbt_lookup_eq</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">PREV</span><span class="p">.</span><span class="n">br_startoff</span><span class="p">,</span>
					<span class="n">PREV</span><span class="p">.</span><span class="n">br_startblock</span><span class="p">,</span> <span class="n">PREV</span><span class="p">.</span><span class="n">br_blockcount</span><span class="p">,</span>
					<span class="o">&amp;</span><span class="n">i</span><span class="p">)))</span>
				<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
			<span class="n">XFS_WANT_CORRUPTED_GOTO</span><span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="n">done</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">error</span> <span class="o">=</span> <span class="n">xfs_bmbt_update</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span>
				<span class="n">PREV</span><span class="p">.</span><span class="n">br_startoff</span> <span class="o">+</span> <span class="n">new</span><span class="o">-&gt;</span><span class="n">br_blockcount</span><span class="p">,</span>
				<span class="n">PREV</span><span class="p">.</span><span class="n">br_startblock</span> <span class="o">+</span> <span class="n">new</span><span class="o">-&gt;</span><span class="n">br_blockcount</span><span class="p">,</span>
				<span class="n">PREV</span><span class="p">.</span><span class="n">br_blockcount</span> <span class="o">-</span> <span class="n">new</span><span class="o">-&gt;</span><span class="n">br_blockcount</span><span class="p">,</span>
				<span class="n">oldext</span><span class="p">)))</span>
				<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">error</span> <span class="o">=</span> <span class="n">xfs_btree_decrement</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">i</span><span class="p">)))</span>
				<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
			<span class="n">error</span> <span class="o">=</span> <span class="n">xfs_bmbt_update</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">LEFT</span><span class="p">.</span><span class="n">br_startoff</span><span class="p">,</span>
				<span class="n">LEFT</span><span class="p">.</span><span class="n">br_startblock</span><span class="p">,</span>
				<span class="n">LEFT</span><span class="p">.</span><span class="n">br_blockcount</span> <span class="o">+</span> <span class="n">new</span><span class="o">-&gt;</span><span class="n">br_blockcount</span><span class="p">,</span>
				<span class="n">LEFT</span><span class="p">.</span><span class="n">br_state</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">BMAP_LEFT_FILLING</span>:
		<span class="cm">/*</span>
<span class="cm">		 * Setting the first part of a previous oldext extent to newext.</span>
<span class="cm">		 * The left neighbor is not contiguous.</span>
<span class="cm">		 */</span>
		<span class="n">trace_xfs_bmap_pre_update</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="o">*</span><span class="n">idx</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">_THIS_IP_</span><span class="p">);</span>
		<span class="n">ASSERT</span><span class="p">(</span><span class="n">ep</span> <span class="o">&amp;&amp;</span> <span class="n">xfs_bmbt_get_state</span><span class="p">(</span><span class="n">ep</span><span class="p">)</span> <span class="o">==</span> <span class="n">oldext</span><span class="p">);</span>
		<span class="n">xfs_bmbt_set_startoff</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="n">new_endoff</span><span class="p">);</span>
		<span class="n">xfs_bmbt_set_blockcount</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span>
			<span class="n">PREV</span><span class="p">.</span><span class="n">br_blockcount</span> <span class="o">-</span> <span class="n">new</span><span class="o">-&gt;</span><span class="n">br_blockcount</span><span class="p">);</span>
		<span class="n">xfs_bmbt_set_startblock</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span>
			<span class="n">new</span><span class="o">-&gt;</span><span class="n">br_startblock</span> <span class="o">+</span> <span class="n">new</span><span class="o">-&gt;</span><span class="n">br_blockcount</span><span class="p">);</span>
		<span class="n">trace_xfs_bmap_post_update</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="o">*</span><span class="n">idx</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">_THIS_IP_</span><span class="p">);</span>

		<span class="n">xfs_iext_insert</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="o">*</span><span class="n">idx</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">new</span><span class="p">,</span> <span class="n">state</span><span class="p">);</span>
		<span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_d</span><span class="p">.</span><span class="n">di_nextents</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cur</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="n">rval</span> <span class="o">=</span> <span class="n">XFS_ILOG_CORE</span> <span class="o">|</span> <span class="n">XFS_ILOG_DEXT</span><span class="p">;</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="n">rval</span> <span class="o">=</span> <span class="n">XFS_ILOG_CORE</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">error</span> <span class="o">=</span> <span class="n">xfs_bmbt_lookup_eq</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">PREV</span><span class="p">.</span><span class="n">br_startoff</span><span class="p">,</span>
					<span class="n">PREV</span><span class="p">.</span><span class="n">br_startblock</span><span class="p">,</span> <span class="n">PREV</span><span class="p">.</span><span class="n">br_blockcount</span><span class="p">,</span>
					<span class="o">&amp;</span><span class="n">i</span><span class="p">)))</span>
				<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
			<span class="n">XFS_WANT_CORRUPTED_GOTO</span><span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="n">done</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">error</span> <span class="o">=</span> <span class="n">xfs_bmbt_update</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span>
				<span class="n">PREV</span><span class="p">.</span><span class="n">br_startoff</span> <span class="o">+</span> <span class="n">new</span><span class="o">-&gt;</span><span class="n">br_blockcount</span><span class="p">,</span>
				<span class="n">PREV</span><span class="p">.</span><span class="n">br_startblock</span> <span class="o">+</span> <span class="n">new</span><span class="o">-&gt;</span><span class="n">br_blockcount</span><span class="p">,</span>
				<span class="n">PREV</span><span class="p">.</span><span class="n">br_blockcount</span> <span class="o">-</span> <span class="n">new</span><span class="o">-&gt;</span><span class="n">br_blockcount</span><span class="p">,</span>
				<span class="n">oldext</span><span class="p">)))</span>
				<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
			<span class="n">cur</span><span class="o">-&gt;</span><span class="n">bc_rec</span><span class="p">.</span><span class="n">b</span> <span class="o">=</span> <span class="o">*</span><span class="n">new</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">error</span> <span class="o">=</span> <span class="n">xfs_btree_insert</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">i</span><span class="p">)))</span>
				<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
			<span class="n">XFS_WANT_CORRUPTED_GOTO</span><span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="n">done</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">BMAP_RIGHT_FILLING</span> <span class="o">|</span> <span class="n">BMAP_RIGHT_CONTIG</span>:
		<span class="cm">/*</span>
<span class="cm">		 * Setting the last part of a previous oldext extent to newext.</span>
<span class="cm">		 * The right neighbor is contiguous with the new allocation.</span>
<span class="cm">		 */</span>
		<span class="n">trace_xfs_bmap_pre_update</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="o">*</span><span class="n">idx</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">_THIS_IP_</span><span class="p">);</span>
		<span class="n">xfs_bmbt_set_blockcount</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span>
			<span class="n">PREV</span><span class="p">.</span><span class="n">br_blockcount</span> <span class="o">-</span> <span class="n">new</span><span class="o">-&gt;</span><span class="n">br_blockcount</span><span class="p">);</span>
		<span class="n">trace_xfs_bmap_post_update</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="o">*</span><span class="n">idx</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">_THIS_IP_</span><span class="p">);</span>

		<span class="o">++*</span><span class="n">idx</span><span class="p">;</span>

		<span class="n">trace_xfs_bmap_pre_update</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="o">*</span><span class="n">idx</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">_THIS_IP_</span><span class="p">);</span>
		<span class="n">xfs_bmbt_set_allf</span><span class="p">(</span><span class="n">xfs_iext_get_ext</span><span class="p">(</span><span class="n">ifp</span><span class="p">,</span> <span class="o">*</span><span class="n">idx</span><span class="p">),</span>
			<span class="n">new</span><span class="o">-&gt;</span><span class="n">br_startoff</span><span class="p">,</span> <span class="n">new</span><span class="o">-&gt;</span><span class="n">br_startblock</span><span class="p">,</span>
			<span class="n">new</span><span class="o">-&gt;</span><span class="n">br_blockcount</span> <span class="o">+</span> <span class="n">RIGHT</span><span class="p">.</span><span class="n">br_blockcount</span><span class="p">,</span> <span class="n">newext</span><span class="p">);</span>
		<span class="n">trace_xfs_bmap_post_update</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="o">*</span><span class="n">idx</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">_THIS_IP_</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">cur</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="n">rval</span> <span class="o">=</span> <span class="n">XFS_ILOG_DEXT</span><span class="p">;</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="n">rval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">error</span> <span class="o">=</span> <span class="n">xfs_bmbt_lookup_eq</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">PREV</span><span class="p">.</span><span class="n">br_startoff</span><span class="p">,</span>
					<span class="n">PREV</span><span class="p">.</span><span class="n">br_startblock</span><span class="p">,</span>
					<span class="n">PREV</span><span class="p">.</span><span class="n">br_blockcount</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">i</span><span class="p">)))</span>
				<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
			<span class="n">XFS_WANT_CORRUPTED_GOTO</span><span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="n">done</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">error</span> <span class="o">=</span> <span class="n">xfs_bmbt_update</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">PREV</span><span class="p">.</span><span class="n">br_startoff</span><span class="p">,</span>
				<span class="n">PREV</span><span class="p">.</span><span class="n">br_startblock</span><span class="p">,</span>
				<span class="n">PREV</span><span class="p">.</span><span class="n">br_blockcount</span> <span class="o">-</span> <span class="n">new</span><span class="o">-&gt;</span><span class="n">br_blockcount</span><span class="p">,</span>
				<span class="n">oldext</span><span class="p">)))</span>
				<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">error</span> <span class="o">=</span> <span class="n">xfs_btree_increment</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">i</span><span class="p">)))</span>
				<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">error</span> <span class="o">=</span> <span class="n">xfs_bmbt_update</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">new</span><span class="o">-&gt;</span><span class="n">br_startoff</span><span class="p">,</span>
				<span class="n">new</span><span class="o">-&gt;</span><span class="n">br_startblock</span><span class="p">,</span>
				<span class="n">new</span><span class="o">-&gt;</span><span class="n">br_blockcount</span> <span class="o">+</span> <span class="n">RIGHT</span><span class="p">.</span><span class="n">br_blockcount</span><span class="p">,</span>
				<span class="n">newext</span><span class="p">)))</span>
				<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">BMAP_RIGHT_FILLING</span>:
		<span class="cm">/*</span>
<span class="cm">		 * Setting the last part of a previous oldext extent to newext.</span>
<span class="cm">		 * The right neighbor is not contiguous.</span>
<span class="cm">		 */</span>
		<span class="n">trace_xfs_bmap_pre_update</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="o">*</span><span class="n">idx</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">_THIS_IP_</span><span class="p">);</span>
		<span class="n">xfs_bmbt_set_blockcount</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span>
			<span class="n">PREV</span><span class="p">.</span><span class="n">br_blockcount</span> <span class="o">-</span> <span class="n">new</span><span class="o">-&gt;</span><span class="n">br_blockcount</span><span class="p">);</span>
		<span class="n">trace_xfs_bmap_post_update</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="o">*</span><span class="n">idx</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">_THIS_IP_</span><span class="p">);</span>

		<span class="o">++*</span><span class="n">idx</span><span class="p">;</span>
		<span class="n">xfs_iext_insert</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="o">*</span><span class="n">idx</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">new</span><span class="p">,</span> <span class="n">state</span><span class="p">);</span>

		<span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_d</span><span class="p">.</span><span class="n">di_nextents</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cur</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="n">rval</span> <span class="o">=</span> <span class="n">XFS_ILOG_CORE</span> <span class="o">|</span> <span class="n">XFS_ILOG_DEXT</span><span class="p">;</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="n">rval</span> <span class="o">=</span> <span class="n">XFS_ILOG_CORE</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">error</span> <span class="o">=</span> <span class="n">xfs_bmbt_lookup_eq</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">PREV</span><span class="p">.</span><span class="n">br_startoff</span><span class="p">,</span>
					<span class="n">PREV</span><span class="p">.</span><span class="n">br_startblock</span><span class="p">,</span> <span class="n">PREV</span><span class="p">.</span><span class="n">br_blockcount</span><span class="p">,</span>
					<span class="o">&amp;</span><span class="n">i</span><span class="p">)))</span>
				<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
			<span class="n">XFS_WANT_CORRUPTED_GOTO</span><span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="n">done</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">error</span> <span class="o">=</span> <span class="n">xfs_bmbt_update</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">PREV</span><span class="p">.</span><span class="n">br_startoff</span><span class="p">,</span>
				<span class="n">PREV</span><span class="p">.</span><span class="n">br_startblock</span><span class="p">,</span>
				<span class="n">PREV</span><span class="p">.</span><span class="n">br_blockcount</span> <span class="o">-</span> <span class="n">new</span><span class="o">-&gt;</span><span class="n">br_blockcount</span><span class="p">,</span>
				<span class="n">oldext</span><span class="p">)))</span>
				<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">error</span> <span class="o">=</span> <span class="n">xfs_bmbt_lookup_eq</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">new</span><span class="o">-&gt;</span><span class="n">br_startoff</span><span class="p">,</span>
					<span class="n">new</span><span class="o">-&gt;</span><span class="n">br_startblock</span><span class="p">,</span> <span class="n">new</span><span class="o">-&gt;</span><span class="n">br_blockcount</span><span class="p">,</span>
					<span class="o">&amp;</span><span class="n">i</span><span class="p">)))</span>
				<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
			<span class="n">XFS_WANT_CORRUPTED_GOTO</span><span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="n">done</span><span class="p">);</span>
			<span class="n">cur</span><span class="o">-&gt;</span><span class="n">bc_rec</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">br_state</span> <span class="o">=</span> <span class="n">XFS_EXT_NORM</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">error</span> <span class="o">=</span> <span class="n">xfs_btree_insert</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">i</span><span class="p">)))</span>
				<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
			<span class="n">XFS_WANT_CORRUPTED_GOTO</span><span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="n">done</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="mi">0</span>:
		<span class="cm">/*</span>
<span class="cm">		 * Setting the middle part of a previous oldext extent to</span>
<span class="cm">		 * newext.  Contiguity is impossible here.</span>
<span class="cm">		 * One extent becomes three extents.</span>
<span class="cm">		 */</span>
		<span class="n">trace_xfs_bmap_pre_update</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="o">*</span><span class="n">idx</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">_THIS_IP_</span><span class="p">);</span>
		<span class="n">xfs_bmbt_set_blockcount</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span>
			<span class="n">new</span><span class="o">-&gt;</span><span class="n">br_startoff</span> <span class="o">-</span> <span class="n">PREV</span><span class="p">.</span><span class="n">br_startoff</span><span class="p">);</span>
		<span class="n">trace_xfs_bmap_post_update</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="o">*</span><span class="n">idx</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">_THIS_IP_</span><span class="p">);</span>

		<span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="o">*</span><span class="n">new</span><span class="p">;</span>
		<span class="n">r</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">br_startoff</span> <span class="o">=</span> <span class="n">new_endoff</span><span class="p">;</span>
		<span class="n">r</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">br_blockcount</span> <span class="o">=</span>
			<span class="n">PREV</span><span class="p">.</span><span class="n">br_startoff</span> <span class="o">+</span> <span class="n">PREV</span><span class="p">.</span><span class="n">br_blockcount</span> <span class="o">-</span> <span class="n">new_endoff</span><span class="p">;</span>
		<span class="n">r</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">br_startblock</span> <span class="o">=</span> <span class="n">new</span><span class="o">-&gt;</span><span class="n">br_startblock</span> <span class="o">+</span> <span class="n">new</span><span class="o">-&gt;</span><span class="n">br_blockcount</span><span class="p">;</span>
		<span class="n">r</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">br_state</span> <span class="o">=</span> <span class="n">oldext</span><span class="p">;</span>

		<span class="o">++*</span><span class="n">idx</span><span class="p">;</span>
		<span class="n">xfs_iext_insert</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="o">*</span><span class="n">idx</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">state</span><span class="p">);</span>

		<span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_d</span><span class="p">.</span><span class="n">di_nextents</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cur</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="n">rval</span> <span class="o">=</span> <span class="n">XFS_ILOG_CORE</span> <span class="o">|</span> <span class="n">XFS_ILOG_DEXT</span><span class="p">;</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="n">rval</span> <span class="o">=</span> <span class="n">XFS_ILOG_CORE</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">error</span> <span class="o">=</span> <span class="n">xfs_bmbt_lookup_eq</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">PREV</span><span class="p">.</span><span class="n">br_startoff</span><span class="p">,</span>
					<span class="n">PREV</span><span class="p">.</span><span class="n">br_startblock</span><span class="p">,</span> <span class="n">PREV</span><span class="p">.</span><span class="n">br_blockcount</span><span class="p">,</span>
					<span class="o">&amp;</span><span class="n">i</span><span class="p">)))</span>
				<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
			<span class="n">XFS_WANT_CORRUPTED_GOTO</span><span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="n">done</span><span class="p">);</span>
			<span class="cm">/* new right extent - oldext */</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">error</span> <span class="o">=</span> <span class="n">xfs_bmbt_update</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">r</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">br_startoff</span><span class="p">,</span>
				<span class="n">r</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">br_startblock</span><span class="p">,</span> <span class="n">r</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">br_blockcount</span><span class="p">,</span>
				<span class="n">r</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">br_state</span><span class="p">)))</span>
				<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
			<span class="cm">/* new left extent - oldext */</span>
			<span class="n">cur</span><span class="o">-&gt;</span><span class="n">bc_rec</span><span class="p">.</span><span class="n">b</span> <span class="o">=</span> <span class="n">PREV</span><span class="p">;</span>
			<span class="n">cur</span><span class="o">-&gt;</span><span class="n">bc_rec</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">br_blockcount</span> <span class="o">=</span>
				<span class="n">new</span><span class="o">-&gt;</span><span class="n">br_startoff</span> <span class="o">-</span> <span class="n">PREV</span><span class="p">.</span><span class="n">br_startoff</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">error</span> <span class="o">=</span> <span class="n">xfs_btree_insert</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">i</span><span class="p">)))</span>
				<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
			<span class="n">XFS_WANT_CORRUPTED_GOTO</span><span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="n">done</span><span class="p">);</span>
			<span class="cm">/*</span>
<span class="cm">			 * Reset the cursor to the position of the new extent</span>
<span class="cm">			 * we are about to insert as we can&#39;t trust it after</span>
<span class="cm">			 * the previous insert.</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">error</span> <span class="o">=</span> <span class="n">xfs_bmbt_lookup_eq</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">new</span><span class="o">-&gt;</span><span class="n">br_startoff</span><span class="p">,</span>
					<span class="n">new</span><span class="o">-&gt;</span><span class="n">br_startblock</span><span class="p">,</span> <span class="n">new</span><span class="o">-&gt;</span><span class="n">br_blockcount</span><span class="p">,</span>
					<span class="o">&amp;</span><span class="n">i</span><span class="p">)))</span>
				<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
			<span class="n">XFS_WANT_CORRUPTED_GOTO</span><span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="n">done</span><span class="p">);</span>
			<span class="cm">/* new middle extent - newext */</span>
			<span class="n">cur</span><span class="o">-&gt;</span><span class="n">bc_rec</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">br_state</span> <span class="o">=</span> <span class="n">new</span><span class="o">-&gt;</span><span class="n">br_state</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">error</span> <span class="o">=</span> <span class="n">xfs_btree_insert</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">i</span><span class="p">)))</span>
				<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
			<span class="n">XFS_WANT_CORRUPTED_GOTO</span><span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="n">done</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">BMAP_LEFT_FILLING</span> <span class="o">|</span> <span class="n">BMAP_LEFT_CONTIG</span> <span class="o">|</span> <span class="n">BMAP_RIGHT_CONTIG</span>:
	<span class="k">case</span> <span class="n">BMAP_RIGHT_FILLING</span> <span class="o">|</span> <span class="n">BMAP_LEFT_CONTIG</span> <span class="o">|</span> <span class="n">BMAP_RIGHT_CONTIG</span>:
	<span class="k">case</span> <span class="n">BMAP_LEFT_FILLING</span> <span class="o">|</span> <span class="n">BMAP_RIGHT_CONTIG</span>:
	<span class="k">case</span> <span class="n">BMAP_RIGHT_FILLING</span> <span class="o">|</span> <span class="n">BMAP_LEFT_CONTIG</span>:
	<span class="k">case</span> <span class="n">BMAP_LEFT_CONTIG</span> <span class="o">|</span> <span class="n">BMAP_RIGHT_CONTIG</span>:
	<span class="k">case</span> <span class="n">BMAP_LEFT_CONTIG</span>:
	<span class="k">case</span> <span class="n">BMAP_RIGHT_CONTIG</span>:
		<span class="cm">/*</span>
<span class="cm">		 * These cases are all impossible.</span>
<span class="cm">		 */</span>
		<span class="n">ASSERT</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* convert to a btree if necessary */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">xfs_bmap_needs_btree</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">XFS_DATA_FORK</span><span class="p">))</span> <span class="p">{</span>
		<span class="kt">int</span>	<span class="n">tmp_logflags</span><span class="p">;</span>	<span class="cm">/* partial log flag return val */</span>

		<span class="n">ASSERT</span><span class="p">(</span><span class="n">cur</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="n">error</span> <span class="o">=</span> <span class="n">xfs_bmap_extents_to_btree</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">ip</span><span class="p">,</span> <span class="n">first</span><span class="p">,</span> <span class="n">flist</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cur</span><span class="p">,</span>
				<span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tmp_logflags</span><span class="p">,</span> <span class="n">XFS_DATA_FORK</span><span class="p">);</span>
		<span class="o">*</span><span class="n">logflagsp</span> <span class="o">|=</span> <span class="n">tmp_logflags</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* clear out the allocated field, done with it now in any case. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cur</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cur</span><span class="o">-&gt;</span><span class="n">bc_private</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">allocated</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="o">*</span><span class="n">curp</span> <span class="o">=</span> <span class="n">cur</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">xfs_bmap_check_leaf_extents</span><span class="p">(</span><span class="o">*</span><span class="n">curp</span><span class="p">,</span> <span class="n">ip</span><span class="p">,</span> <span class="n">XFS_DATA_FORK</span><span class="p">);</span>
<span class="nl">done:</span>
	<span class="o">*</span><span class="n">logflagsp</span> <span class="o">|=</span> <span class="n">rval</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
<span class="cp">#undef	LEFT</span>
<span class="cp">#undef	RIGHT</span>
<span class="cp">#undef	PREV</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Convert a hole to a delayed allocation.</span>
<span class="cm"> */</span>
<span class="n">STATIC</span> <span class="kt">void</span>
<span class="n">xfs_bmap_add_extent_hole_delay</span><span class="p">(</span>
	<span class="n">xfs_inode_t</span>		<span class="o">*</span><span class="n">ip</span><span class="p">,</span>	<span class="cm">/* incore inode pointer */</span>
	<span class="n">xfs_extnum_t</span>		<span class="o">*</span><span class="n">idx</span><span class="p">,</span>	<span class="cm">/* extent number to update/insert */</span>
	<span class="n">xfs_bmbt_irec_t</span>		<span class="o">*</span><span class="n">new</span><span class="p">)</span>	<span class="cm">/* new data to add to file extents */</span>
<span class="p">{</span>
	<span class="n">xfs_ifork_t</span>		<span class="o">*</span><span class="n">ifp</span><span class="p">;</span>	<span class="cm">/* inode fork pointer */</span>
	<span class="n">xfs_bmbt_irec_t</span>		<span class="n">left</span><span class="p">;</span>	<span class="cm">/* left neighbor extent entry */</span>
	<span class="n">xfs_filblks_t</span>		<span class="n">newlen</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>	<span class="cm">/* new indirect size */</span>
	<span class="n">xfs_filblks_t</span>		<span class="n">oldlen</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>	<span class="cm">/* old indirect size */</span>
	<span class="n">xfs_bmbt_irec_t</span>		<span class="n">right</span><span class="p">;</span>	<span class="cm">/* right neighbor extent entry */</span>
	<span class="kt">int</span>			<span class="n">state</span><span class="p">;</span>  <span class="cm">/* state bits, accessed thru macros */</span>
	<span class="n">xfs_filblks_t</span>		<span class="n">temp</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>	<span class="cm">/* temp for indirect calculations */</span>

	<span class="n">ifp</span> <span class="o">=</span> <span class="n">XFS_IFORK_PTR</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">XFS_DATA_FORK</span><span class="p">);</span>
	<span class="n">state</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ASSERT</span><span class="p">(</span><span class="n">isnullstartblock</span><span class="p">(</span><span class="n">new</span><span class="o">-&gt;</span><span class="n">br_startblock</span><span class="p">));</span>

	<span class="cm">/*</span>
<span class="cm">	 * Check and set flags if this segment has a left neighbor</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">idx</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">state</span> <span class="o">|=</span> <span class="n">BMAP_LEFT_VALID</span><span class="p">;</span>
		<span class="n">xfs_bmbt_get_all</span><span class="p">(</span><span class="n">xfs_iext_get_ext</span><span class="p">(</span><span class="n">ifp</span><span class="p">,</span> <span class="o">*</span><span class="n">idx</span> <span class="o">-</span> <span class="mi">1</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">left</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">isnullstartblock</span><span class="p">(</span><span class="n">left</span><span class="p">.</span><span class="n">br_startblock</span><span class="p">))</span>
			<span class="n">state</span> <span class="o">|=</span> <span class="n">BMAP_LEFT_DELAY</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Check and set flags if the current (right) segment exists.</span>
<span class="cm">	 * If it doesn&#39;t exist, we&#39;re converting the hole at end-of-file.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">idx</span> <span class="o">&lt;</span> <span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_df</span><span class="p">.</span><span class="n">if_bytes</span> <span class="o">/</span> <span class="p">(</span><span class="n">uint</span><span class="p">)</span><span class="k">sizeof</span><span class="p">(</span><span class="n">xfs_bmbt_rec_t</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">state</span> <span class="o">|=</span> <span class="n">BMAP_RIGHT_VALID</span><span class="p">;</span>
		<span class="n">xfs_bmbt_get_all</span><span class="p">(</span><span class="n">xfs_iext_get_ext</span><span class="p">(</span><span class="n">ifp</span><span class="p">,</span> <span class="o">*</span><span class="n">idx</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">right</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">isnullstartblock</span><span class="p">(</span><span class="n">right</span><span class="p">.</span><span class="n">br_startblock</span><span class="p">))</span>
			<span class="n">state</span> <span class="o">|=</span> <span class="n">BMAP_RIGHT_DELAY</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Set contiguity flags on the left and right neighbors.</span>
<span class="cm">	 * Don&#39;t let extents get too large, even if the pieces are contiguous.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">state</span> <span class="o">&amp;</span> <span class="n">BMAP_LEFT_VALID</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">state</span> <span class="o">&amp;</span> <span class="n">BMAP_LEFT_DELAY</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">left</span><span class="p">.</span><span class="n">br_startoff</span> <span class="o">+</span> <span class="n">left</span><span class="p">.</span><span class="n">br_blockcount</span> <span class="o">==</span> <span class="n">new</span><span class="o">-&gt;</span><span class="n">br_startoff</span> <span class="o">&amp;&amp;</span>
	    <span class="n">left</span><span class="p">.</span><span class="n">br_blockcount</span> <span class="o">+</span> <span class="n">new</span><span class="o">-&gt;</span><span class="n">br_blockcount</span> <span class="o">&lt;=</span> <span class="n">MAXEXTLEN</span><span class="p">)</span>
		<span class="n">state</span> <span class="o">|=</span> <span class="n">BMAP_LEFT_CONTIG</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">state</span> <span class="o">&amp;</span> <span class="n">BMAP_RIGHT_VALID</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">state</span> <span class="o">&amp;</span> <span class="n">BMAP_RIGHT_DELAY</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">new</span><span class="o">-&gt;</span><span class="n">br_startoff</span> <span class="o">+</span> <span class="n">new</span><span class="o">-&gt;</span><span class="n">br_blockcount</span> <span class="o">==</span> <span class="n">right</span><span class="p">.</span><span class="n">br_startoff</span> <span class="o">&amp;&amp;</span>
	    <span class="n">new</span><span class="o">-&gt;</span><span class="n">br_blockcount</span> <span class="o">+</span> <span class="n">right</span><span class="p">.</span><span class="n">br_blockcount</span> <span class="o">&lt;=</span> <span class="n">MAXEXTLEN</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">state</span> <span class="o">&amp;</span> <span class="n">BMAP_LEFT_CONTIG</span><span class="p">)</span> <span class="o">||</span>
	     <span class="p">(</span><span class="n">left</span><span class="p">.</span><span class="n">br_blockcount</span> <span class="o">+</span> <span class="n">new</span><span class="o">-&gt;</span><span class="n">br_blockcount</span> <span class="o">+</span>
	      <span class="n">right</span><span class="p">.</span><span class="n">br_blockcount</span> <span class="o">&lt;=</span> <span class="n">MAXEXTLEN</span><span class="p">)))</span>
		<span class="n">state</span> <span class="o">|=</span> <span class="n">BMAP_RIGHT_CONTIG</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Switch out based on the contiguity flags.</span>
<span class="cm">	 */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">state</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">BMAP_LEFT_CONTIG</span> <span class="o">|</span> <span class="n">BMAP_RIGHT_CONTIG</span><span class="p">))</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">BMAP_LEFT_CONTIG</span> <span class="o">|</span> <span class="n">BMAP_RIGHT_CONTIG</span>:
		<span class="cm">/*</span>
<span class="cm">		 * New allocation is contiguous with delayed allocations</span>
<span class="cm">		 * on the left and on the right.</span>
<span class="cm">		 * Merge all three into a single extent record.</span>
<span class="cm">		 */</span>
		<span class="o">--*</span><span class="n">idx</span><span class="p">;</span>
		<span class="n">temp</span> <span class="o">=</span> <span class="n">left</span><span class="p">.</span><span class="n">br_blockcount</span> <span class="o">+</span> <span class="n">new</span><span class="o">-&gt;</span><span class="n">br_blockcount</span> <span class="o">+</span>
			<span class="n">right</span><span class="p">.</span><span class="n">br_blockcount</span><span class="p">;</span>

		<span class="n">trace_xfs_bmap_pre_update</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="o">*</span><span class="n">idx</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">_THIS_IP_</span><span class="p">);</span>
		<span class="n">xfs_bmbt_set_blockcount</span><span class="p">(</span><span class="n">xfs_iext_get_ext</span><span class="p">(</span><span class="n">ifp</span><span class="p">,</span> <span class="o">*</span><span class="n">idx</span><span class="p">),</span> <span class="n">temp</span><span class="p">);</span>
		<span class="n">oldlen</span> <span class="o">=</span> <span class="n">startblockval</span><span class="p">(</span><span class="n">left</span><span class="p">.</span><span class="n">br_startblock</span><span class="p">)</span> <span class="o">+</span>
			<span class="n">startblockval</span><span class="p">(</span><span class="n">new</span><span class="o">-&gt;</span><span class="n">br_startblock</span><span class="p">)</span> <span class="o">+</span>
			<span class="n">startblockval</span><span class="p">(</span><span class="n">right</span><span class="p">.</span><span class="n">br_startblock</span><span class="p">);</span>
		<span class="n">newlen</span> <span class="o">=</span> <span class="n">xfs_bmap_worst_indlen</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">temp</span><span class="p">);</span>
		<span class="n">xfs_bmbt_set_startblock</span><span class="p">(</span><span class="n">xfs_iext_get_ext</span><span class="p">(</span><span class="n">ifp</span><span class="p">,</span> <span class="o">*</span><span class="n">idx</span><span class="p">),</span>
			<span class="n">nullstartblock</span><span class="p">((</span><span class="kt">int</span><span class="p">)</span><span class="n">newlen</span><span class="p">));</span>
		<span class="n">trace_xfs_bmap_post_update</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="o">*</span><span class="n">idx</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">_THIS_IP_</span><span class="p">);</span>

		<span class="n">xfs_iext_remove</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="o">*</span><span class="n">idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">state</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">BMAP_LEFT_CONTIG</span>:
		<span class="cm">/*</span>
<span class="cm">		 * New allocation is contiguous with a delayed allocation</span>
<span class="cm">		 * on the left.</span>
<span class="cm">		 * Merge the new allocation with the left neighbor.</span>
<span class="cm">		 */</span>
		<span class="o">--*</span><span class="n">idx</span><span class="p">;</span>
		<span class="n">temp</span> <span class="o">=</span> <span class="n">left</span><span class="p">.</span><span class="n">br_blockcount</span> <span class="o">+</span> <span class="n">new</span><span class="o">-&gt;</span><span class="n">br_blockcount</span><span class="p">;</span>

		<span class="n">trace_xfs_bmap_pre_update</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="o">*</span><span class="n">idx</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">_THIS_IP_</span><span class="p">);</span>
		<span class="n">xfs_bmbt_set_blockcount</span><span class="p">(</span><span class="n">xfs_iext_get_ext</span><span class="p">(</span><span class="n">ifp</span><span class="p">,</span> <span class="o">*</span><span class="n">idx</span><span class="p">),</span> <span class="n">temp</span><span class="p">);</span>
		<span class="n">oldlen</span> <span class="o">=</span> <span class="n">startblockval</span><span class="p">(</span><span class="n">left</span><span class="p">.</span><span class="n">br_startblock</span><span class="p">)</span> <span class="o">+</span>
			<span class="n">startblockval</span><span class="p">(</span><span class="n">new</span><span class="o">-&gt;</span><span class="n">br_startblock</span><span class="p">);</span>
		<span class="n">newlen</span> <span class="o">=</span> <span class="n">xfs_bmap_worst_indlen</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">temp</span><span class="p">);</span>
		<span class="n">xfs_bmbt_set_startblock</span><span class="p">(</span><span class="n">xfs_iext_get_ext</span><span class="p">(</span><span class="n">ifp</span><span class="p">,</span> <span class="o">*</span><span class="n">idx</span><span class="p">),</span>
			<span class="n">nullstartblock</span><span class="p">((</span><span class="kt">int</span><span class="p">)</span><span class="n">newlen</span><span class="p">));</span>
		<span class="n">trace_xfs_bmap_post_update</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="o">*</span><span class="n">idx</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">_THIS_IP_</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">BMAP_RIGHT_CONTIG</span>:
		<span class="cm">/*</span>
<span class="cm">		 * New allocation is contiguous with a delayed allocation</span>
<span class="cm">		 * on the right.</span>
<span class="cm">		 * Merge the new allocation with the right neighbor.</span>
<span class="cm">		 */</span>
		<span class="n">trace_xfs_bmap_pre_update</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="o">*</span><span class="n">idx</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">_THIS_IP_</span><span class="p">);</span>
		<span class="n">temp</span> <span class="o">=</span> <span class="n">new</span><span class="o">-&gt;</span><span class="n">br_blockcount</span> <span class="o">+</span> <span class="n">right</span><span class="p">.</span><span class="n">br_blockcount</span><span class="p">;</span>
		<span class="n">oldlen</span> <span class="o">=</span> <span class="n">startblockval</span><span class="p">(</span><span class="n">new</span><span class="o">-&gt;</span><span class="n">br_startblock</span><span class="p">)</span> <span class="o">+</span>
			<span class="n">startblockval</span><span class="p">(</span><span class="n">right</span><span class="p">.</span><span class="n">br_startblock</span><span class="p">);</span>
		<span class="n">newlen</span> <span class="o">=</span> <span class="n">xfs_bmap_worst_indlen</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">temp</span><span class="p">);</span>
		<span class="n">xfs_bmbt_set_allf</span><span class="p">(</span><span class="n">xfs_iext_get_ext</span><span class="p">(</span><span class="n">ifp</span><span class="p">,</span> <span class="o">*</span><span class="n">idx</span><span class="p">),</span>
			<span class="n">new</span><span class="o">-&gt;</span><span class="n">br_startoff</span><span class="p">,</span>
			<span class="n">nullstartblock</span><span class="p">((</span><span class="kt">int</span><span class="p">)</span><span class="n">newlen</span><span class="p">),</span> <span class="n">temp</span><span class="p">,</span> <span class="n">right</span><span class="p">.</span><span class="n">br_state</span><span class="p">);</span>
		<span class="n">trace_xfs_bmap_post_update</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="o">*</span><span class="n">idx</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">_THIS_IP_</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="mi">0</span>:
		<span class="cm">/*</span>
<span class="cm">		 * New allocation is not contiguous with another</span>
<span class="cm">		 * delayed allocation.</span>
<span class="cm">		 * Insert a new entry.</span>
<span class="cm">		 */</span>
		<span class="n">oldlen</span> <span class="o">=</span> <span class="n">newlen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">xfs_iext_insert</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="o">*</span><span class="n">idx</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">new</span><span class="p">,</span> <span class="n">state</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">oldlen</span> <span class="o">!=</span> <span class="n">newlen</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ASSERT</span><span class="p">(</span><span class="n">oldlen</span> <span class="o">&gt;</span> <span class="n">newlen</span><span class="p">);</span>
		<span class="n">xfs_icsb_modify_counters</span><span class="p">(</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_mount</span><span class="p">,</span> <span class="n">XFS_SBS_FDBLOCKS</span><span class="p">,</span>
			<span class="p">(</span><span class="kt">int64_t</span><span class="p">)(</span><span class="n">oldlen</span> <span class="o">-</span> <span class="n">newlen</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
		<span class="cm">/*</span>
<span class="cm">		 * Nothing to do for disk quota accounting here.</span>
<span class="cm">		 */</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Convert a hole to a real allocation.</span>
<span class="cm"> */</span>
<span class="n">STATIC</span> <span class="kt">int</span>				<span class="cm">/* error */</span>
<span class="n">xfs_bmap_add_extent_hole_real</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">xfs_bmalloca</span>	<span class="o">*</span><span class="n">bma</span><span class="p">,</span>
	<span class="kt">int</span>			<span class="n">whichfork</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">xfs_bmbt_irec</span>	<span class="o">*</span><span class="n">new</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">bma</span><span class="o">-&gt;</span><span class="n">got</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">error</span><span class="p">;</span>	<span class="cm">/* error return value */</span>
	<span class="kt">int</span>			<span class="n">i</span><span class="p">;</span>	<span class="cm">/* temp state */</span>
	<span class="n">xfs_ifork_t</span>		<span class="o">*</span><span class="n">ifp</span><span class="p">;</span>	<span class="cm">/* inode fork pointer */</span>
	<span class="n">xfs_bmbt_irec_t</span>		<span class="n">left</span><span class="p">;</span>	<span class="cm">/* left neighbor extent entry */</span>
	<span class="n">xfs_bmbt_irec_t</span>		<span class="n">right</span><span class="p">;</span>	<span class="cm">/* right neighbor extent entry */</span>
	<span class="kt">int</span>			<span class="n">rval</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>	<span class="cm">/* return value (logging flags) */</span>
	<span class="kt">int</span>			<span class="n">state</span><span class="p">;</span>	<span class="cm">/* state bits, accessed thru macros */</span>

	<span class="n">ifp</span> <span class="o">=</span> <span class="n">XFS_IFORK_PTR</span><span class="p">(</span><span class="n">bma</span><span class="o">-&gt;</span><span class="n">ip</span><span class="p">,</span> <span class="n">whichfork</span><span class="p">);</span>

	<span class="n">ASSERT</span><span class="p">(</span><span class="n">bma</span><span class="o">-&gt;</span><span class="n">idx</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">ASSERT</span><span class="p">(</span><span class="n">bma</span><span class="o">-&gt;</span><span class="n">idx</span> <span class="o">&lt;=</span> <span class="n">ifp</span><span class="o">-&gt;</span><span class="n">if_bytes</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">xfs_bmbt_rec</span><span class="p">));</span>
	<span class="n">ASSERT</span><span class="p">(</span><span class="o">!</span><span class="n">isnullstartblock</span><span class="p">(</span><span class="n">new</span><span class="o">-&gt;</span><span class="n">br_startblock</span><span class="p">));</span>
	<span class="n">ASSERT</span><span class="p">(</span><span class="o">!</span><span class="n">bma</span><span class="o">-&gt;</span><span class="n">cur</span> <span class="o">||</span>
	       <span class="o">!</span><span class="p">(</span><span class="n">bma</span><span class="o">-&gt;</span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">bc_private</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">XFS_BTCUR_BPRV_WASDEL</span><span class="p">));</span>

	<span class="n">XFS_STATS_INC</span><span class="p">(</span><span class="n">xs_add_exlist</span><span class="p">);</span>

	<span class="n">state</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">whichfork</span> <span class="o">==</span> <span class="n">XFS_ATTR_FORK</span><span class="p">)</span>
		<span class="n">state</span> <span class="o">|=</span> <span class="n">BMAP_ATTRFORK</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Check and set flags if this segment has a left neighbor.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bma</span><span class="o">-&gt;</span><span class="n">idx</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">state</span> <span class="o">|=</span> <span class="n">BMAP_LEFT_VALID</span><span class="p">;</span>
		<span class="n">xfs_bmbt_get_all</span><span class="p">(</span><span class="n">xfs_iext_get_ext</span><span class="p">(</span><span class="n">ifp</span><span class="p">,</span> <span class="n">bma</span><span class="o">-&gt;</span><span class="n">idx</span> <span class="o">-</span> <span class="mi">1</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">left</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">isnullstartblock</span><span class="p">(</span><span class="n">left</span><span class="p">.</span><span class="n">br_startblock</span><span class="p">))</span>
			<span class="n">state</span> <span class="o">|=</span> <span class="n">BMAP_LEFT_DELAY</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Check and set flags if this segment has a current value.</span>
<span class="cm">	 * Not true if we&#39;re inserting into the &quot;hole&quot; at eof.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bma</span><span class="o">-&gt;</span><span class="n">idx</span> <span class="o">&lt;</span> <span class="n">ifp</span><span class="o">-&gt;</span><span class="n">if_bytes</span> <span class="o">/</span> <span class="p">(</span><span class="n">uint</span><span class="p">)</span><span class="k">sizeof</span><span class="p">(</span><span class="n">xfs_bmbt_rec_t</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">state</span> <span class="o">|=</span> <span class="n">BMAP_RIGHT_VALID</span><span class="p">;</span>
		<span class="n">xfs_bmbt_get_all</span><span class="p">(</span><span class="n">xfs_iext_get_ext</span><span class="p">(</span><span class="n">ifp</span><span class="p">,</span> <span class="n">bma</span><span class="o">-&gt;</span><span class="n">idx</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">right</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">isnullstartblock</span><span class="p">(</span><span class="n">right</span><span class="p">.</span><span class="n">br_startblock</span><span class="p">))</span>
			<span class="n">state</span> <span class="o">|=</span> <span class="n">BMAP_RIGHT_DELAY</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * We&#39;re inserting a real allocation between &quot;left&quot; and &quot;right&quot;.</span>
<span class="cm">	 * Set the contiguity flags.  Don&#39;t let extents get too large.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">state</span> <span class="o">&amp;</span> <span class="n">BMAP_LEFT_VALID</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">state</span> <span class="o">&amp;</span> <span class="n">BMAP_LEFT_DELAY</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">left</span><span class="p">.</span><span class="n">br_startoff</span> <span class="o">+</span> <span class="n">left</span><span class="p">.</span><span class="n">br_blockcount</span> <span class="o">==</span> <span class="n">new</span><span class="o">-&gt;</span><span class="n">br_startoff</span> <span class="o">&amp;&amp;</span>
	    <span class="n">left</span><span class="p">.</span><span class="n">br_startblock</span> <span class="o">+</span> <span class="n">left</span><span class="p">.</span><span class="n">br_blockcount</span> <span class="o">==</span> <span class="n">new</span><span class="o">-&gt;</span><span class="n">br_startblock</span> <span class="o">&amp;&amp;</span>
	    <span class="n">left</span><span class="p">.</span><span class="n">br_state</span> <span class="o">==</span> <span class="n">new</span><span class="o">-&gt;</span><span class="n">br_state</span> <span class="o">&amp;&amp;</span>
	    <span class="n">left</span><span class="p">.</span><span class="n">br_blockcount</span> <span class="o">+</span> <span class="n">new</span><span class="o">-&gt;</span><span class="n">br_blockcount</span> <span class="o">&lt;=</span> <span class="n">MAXEXTLEN</span><span class="p">)</span>
		<span class="n">state</span> <span class="o">|=</span> <span class="n">BMAP_LEFT_CONTIG</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">state</span> <span class="o">&amp;</span> <span class="n">BMAP_RIGHT_VALID</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">state</span> <span class="o">&amp;</span> <span class="n">BMAP_RIGHT_DELAY</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">new</span><span class="o">-&gt;</span><span class="n">br_startoff</span> <span class="o">+</span> <span class="n">new</span><span class="o">-&gt;</span><span class="n">br_blockcount</span> <span class="o">==</span> <span class="n">right</span><span class="p">.</span><span class="n">br_startoff</span> <span class="o">&amp;&amp;</span>
	    <span class="n">new</span><span class="o">-&gt;</span><span class="n">br_startblock</span> <span class="o">+</span> <span class="n">new</span><span class="o">-&gt;</span><span class="n">br_blockcount</span> <span class="o">==</span> <span class="n">right</span><span class="p">.</span><span class="n">br_startblock</span> <span class="o">&amp;&amp;</span>
	    <span class="n">new</span><span class="o">-&gt;</span><span class="n">br_state</span> <span class="o">==</span> <span class="n">right</span><span class="p">.</span><span class="n">br_state</span> <span class="o">&amp;&amp;</span>
	    <span class="n">new</span><span class="o">-&gt;</span><span class="n">br_blockcount</span> <span class="o">+</span> <span class="n">right</span><span class="p">.</span><span class="n">br_blockcount</span> <span class="o">&lt;=</span> <span class="n">MAXEXTLEN</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">state</span> <span class="o">&amp;</span> <span class="n">BMAP_LEFT_CONTIG</span><span class="p">)</span> <span class="o">||</span>
	     <span class="n">left</span><span class="p">.</span><span class="n">br_blockcount</span> <span class="o">+</span> <span class="n">new</span><span class="o">-&gt;</span><span class="n">br_blockcount</span> <span class="o">+</span>
	     <span class="n">right</span><span class="p">.</span><span class="n">br_blockcount</span> <span class="o">&lt;=</span> <span class="n">MAXEXTLEN</span><span class="p">))</span>
		<span class="n">state</span> <span class="o">|=</span> <span class="n">BMAP_RIGHT_CONTIG</span><span class="p">;</span>

	<span class="n">error</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * Select which case we&#39;re in here, and implement it.</span>
<span class="cm">	 */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">state</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">BMAP_LEFT_CONTIG</span> <span class="o">|</span> <span class="n">BMAP_RIGHT_CONTIG</span><span class="p">))</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">BMAP_LEFT_CONTIG</span> <span class="o">|</span> <span class="n">BMAP_RIGHT_CONTIG</span>:
		<span class="cm">/*</span>
<span class="cm">		 * New allocation is contiguous with real allocations on the</span>
<span class="cm">		 * left and on the right.</span>
<span class="cm">		 * Merge all three into a single extent record.</span>
<span class="cm">		 */</span>
		<span class="o">--</span><span class="n">bma</span><span class="o">-&gt;</span><span class="n">idx</span><span class="p">;</span>
		<span class="n">trace_xfs_bmap_pre_update</span><span class="p">(</span><span class="n">bma</span><span class="o">-&gt;</span><span class="n">ip</span><span class="p">,</span> <span class="n">bma</span><span class="o">-&gt;</span><span class="n">idx</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">_THIS_IP_</span><span class="p">);</span>
		<span class="n">xfs_bmbt_set_blockcount</span><span class="p">(</span><span class="n">xfs_iext_get_ext</span><span class="p">(</span><span class="n">ifp</span><span class="p">,</span> <span class="n">bma</span><span class="o">-&gt;</span><span class="n">idx</span><span class="p">),</span>
			<span class="n">left</span><span class="p">.</span><span class="n">br_blockcount</span> <span class="o">+</span> <span class="n">new</span><span class="o">-&gt;</span><span class="n">br_blockcount</span> <span class="o">+</span>
			<span class="n">right</span><span class="p">.</span><span class="n">br_blockcount</span><span class="p">);</span>
		<span class="n">trace_xfs_bmap_post_update</span><span class="p">(</span><span class="n">bma</span><span class="o">-&gt;</span><span class="n">ip</span><span class="p">,</span> <span class="n">bma</span><span class="o">-&gt;</span><span class="n">idx</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">_THIS_IP_</span><span class="p">);</span>

		<span class="n">xfs_iext_remove</span><span class="p">(</span><span class="n">bma</span><span class="o">-&gt;</span><span class="n">ip</span><span class="p">,</span> <span class="n">bma</span><span class="o">-&gt;</span><span class="n">idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">state</span><span class="p">);</span>

		<span class="n">XFS_IFORK_NEXT_SET</span><span class="p">(</span><span class="n">bma</span><span class="o">-&gt;</span><span class="n">ip</span><span class="p">,</span> <span class="n">whichfork</span><span class="p">,</span>
			<span class="n">XFS_IFORK_NEXTENTS</span><span class="p">(</span><span class="n">bma</span><span class="o">-&gt;</span><span class="n">ip</span><span class="p">,</span> <span class="n">whichfork</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bma</span><span class="o">-&gt;</span><span class="n">cur</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rval</span> <span class="o">=</span> <span class="n">XFS_ILOG_CORE</span> <span class="o">|</span> <span class="n">xfs_ilog_fext</span><span class="p">(</span><span class="n">whichfork</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">rval</span> <span class="o">=</span> <span class="n">XFS_ILOG_CORE</span><span class="p">;</span>
			<span class="n">error</span> <span class="o">=</span> <span class="n">xfs_bmbt_lookup_eq</span><span class="p">(</span><span class="n">bma</span><span class="o">-&gt;</span><span class="n">cur</span><span class="p">,</span> <span class="n">right</span><span class="p">.</span><span class="n">br_startoff</span><span class="p">,</span>
					<span class="n">right</span><span class="p">.</span><span class="n">br_startblock</span><span class="p">,</span> <span class="n">right</span><span class="p">.</span><span class="n">br_blockcount</span><span class="p">,</span>
					<span class="o">&amp;</span><span class="n">i</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
			<span class="n">XFS_WANT_CORRUPTED_GOTO</span><span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="n">done</span><span class="p">);</span>
			<span class="n">error</span> <span class="o">=</span> <span class="n">xfs_btree_delete</span><span class="p">(</span><span class="n">bma</span><span class="o">-&gt;</span><span class="n">cur</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">i</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
			<span class="n">XFS_WANT_CORRUPTED_GOTO</span><span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="n">done</span><span class="p">);</span>
			<span class="n">error</span> <span class="o">=</span> <span class="n">xfs_btree_decrement</span><span class="p">(</span><span class="n">bma</span><span class="o">-&gt;</span><span class="n">cur</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">i</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
			<span class="n">XFS_WANT_CORRUPTED_GOTO</span><span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="n">done</span><span class="p">);</span>
			<span class="n">error</span> <span class="o">=</span> <span class="n">xfs_bmbt_update</span><span class="p">(</span><span class="n">bma</span><span class="o">-&gt;</span><span class="n">cur</span><span class="p">,</span> <span class="n">left</span><span class="p">.</span><span class="n">br_startoff</span><span class="p">,</span>
					<span class="n">left</span><span class="p">.</span><span class="n">br_startblock</span><span class="p">,</span>
					<span class="n">left</span><span class="p">.</span><span class="n">br_blockcount</span> <span class="o">+</span>
						<span class="n">new</span><span class="o">-&gt;</span><span class="n">br_blockcount</span> <span class="o">+</span>
						<span class="n">right</span><span class="p">.</span><span class="n">br_blockcount</span><span class="p">,</span>
					<span class="n">left</span><span class="p">.</span><span class="n">br_state</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">BMAP_LEFT_CONTIG</span>:
		<span class="cm">/*</span>
<span class="cm">		 * New allocation is contiguous with a real allocation</span>
<span class="cm">		 * on the left.</span>
<span class="cm">		 * Merge the new allocation with the left neighbor.</span>
<span class="cm">		 */</span>
		<span class="o">--</span><span class="n">bma</span><span class="o">-&gt;</span><span class="n">idx</span><span class="p">;</span>
		<span class="n">trace_xfs_bmap_pre_update</span><span class="p">(</span><span class="n">bma</span><span class="o">-&gt;</span><span class="n">ip</span><span class="p">,</span> <span class="n">bma</span><span class="o">-&gt;</span><span class="n">idx</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">_THIS_IP_</span><span class="p">);</span>
		<span class="n">xfs_bmbt_set_blockcount</span><span class="p">(</span><span class="n">xfs_iext_get_ext</span><span class="p">(</span><span class="n">ifp</span><span class="p">,</span> <span class="n">bma</span><span class="o">-&gt;</span><span class="n">idx</span><span class="p">),</span>
			<span class="n">left</span><span class="p">.</span><span class="n">br_blockcount</span> <span class="o">+</span> <span class="n">new</span><span class="o">-&gt;</span><span class="n">br_blockcount</span><span class="p">);</span>
		<span class="n">trace_xfs_bmap_post_update</span><span class="p">(</span><span class="n">bma</span><span class="o">-&gt;</span><span class="n">ip</span><span class="p">,</span> <span class="n">bma</span><span class="o">-&gt;</span><span class="n">idx</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">_THIS_IP_</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">bma</span><span class="o">-&gt;</span><span class="n">cur</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rval</span> <span class="o">=</span> <span class="n">xfs_ilog_fext</span><span class="p">(</span><span class="n">whichfork</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">rval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">error</span> <span class="o">=</span> <span class="n">xfs_bmbt_lookup_eq</span><span class="p">(</span><span class="n">bma</span><span class="o">-&gt;</span><span class="n">cur</span><span class="p">,</span> <span class="n">left</span><span class="p">.</span><span class="n">br_startoff</span><span class="p">,</span>
					<span class="n">left</span><span class="p">.</span><span class="n">br_startblock</span><span class="p">,</span> <span class="n">left</span><span class="p">.</span><span class="n">br_blockcount</span><span class="p">,</span>
					<span class="o">&amp;</span><span class="n">i</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
			<span class="n">XFS_WANT_CORRUPTED_GOTO</span><span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="n">done</span><span class="p">);</span>
			<span class="n">error</span> <span class="o">=</span> <span class="n">xfs_bmbt_update</span><span class="p">(</span><span class="n">bma</span><span class="o">-&gt;</span><span class="n">cur</span><span class="p">,</span> <span class="n">left</span><span class="p">.</span><span class="n">br_startoff</span><span class="p">,</span>
					<span class="n">left</span><span class="p">.</span><span class="n">br_startblock</span><span class="p">,</span>
					<span class="n">left</span><span class="p">.</span><span class="n">br_blockcount</span> <span class="o">+</span>
						<span class="n">new</span><span class="o">-&gt;</span><span class="n">br_blockcount</span><span class="p">,</span>
					<span class="n">left</span><span class="p">.</span><span class="n">br_state</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">BMAP_RIGHT_CONTIG</span>:
		<span class="cm">/*</span>
<span class="cm">		 * New allocation is contiguous with a real allocation</span>
<span class="cm">		 * on the right.</span>
<span class="cm">		 * Merge the new allocation with the right neighbor.</span>
<span class="cm">		 */</span>
		<span class="n">trace_xfs_bmap_pre_update</span><span class="p">(</span><span class="n">bma</span><span class="o">-&gt;</span><span class="n">ip</span><span class="p">,</span> <span class="n">bma</span><span class="o">-&gt;</span><span class="n">idx</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">_THIS_IP_</span><span class="p">);</span>
		<span class="n">xfs_bmbt_set_allf</span><span class="p">(</span><span class="n">xfs_iext_get_ext</span><span class="p">(</span><span class="n">ifp</span><span class="p">,</span> <span class="n">bma</span><span class="o">-&gt;</span><span class="n">idx</span><span class="p">),</span>
			<span class="n">new</span><span class="o">-&gt;</span><span class="n">br_startoff</span><span class="p">,</span> <span class="n">new</span><span class="o">-&gt;</span><span class="n">br_startblock</span><span class="p">,</span>
			<span class="n">new</span><span class="o">-&gt;</span><span class="n">br_blockcount</span> <span class="o">+</span> <span class="n">right</span><span class="p">.</span><span class="n">br_blockcount</span><span class="p">,</span>
			<span class="n">right</span><span class="p">.</span><span class="n">br_state</span><span class="p">);</span>
		<span class="n">trace_xfs_bmap_post_update</span><span class="p">(</span><span class="n">bma</span><span class="o">-&gt;</span><span class="n">ip</span><span class="p">,</span> <span class="n">bma</span><span class="o">-&gt;</span><span class="n">idx</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">_THIS_IP_</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">bma</span><span class="o">-&gt;</span><span class="n">cur</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rval</span> <span class="o">=</span> <span class="n">xfs_ilog_fext</span><span class="p">(</span><span class="n">whichfork</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">rval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">error</span> <span class="o">=</span> <span class="n">xfs_bmbt_lookup_eq</span><span class="p">(</span><span class="n">bma</span><span class="o">-&gt;</span><span class="n">cur</span><span class="p">,</span>
					<span class="n">right</span><span class="p">.</span><span class="n">br_startoff</span><span class="p">,</span>
					<span class="n">right</span><span class="p">.</span><span class="n">br_startblock</span><span class="p">,</span>
					<span class="n">right</span><span class="p">.</span><span class="n">br_blockcount</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">i</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
			<span class="n">XFS_WANT_CORRUPTED_GOTO</span><span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="n">done</span><span class="p">);</span>
			<span class="n">error</span> <span class="o">=</span> <span class="n">xfs_bmbt_update</span><span class="p">(</span><span class="n">bma</span><span class="o">-&gt;</span><span class="n">cur</span><span class="p">,</span> <span class="n">new</span><span class="o">-&gt;</span><span class="n">br_startoff</span><span class="p">,</span>
					<span class="n">new</span><span class="o">-&gt;</span><span class="n">br_startblock</span><span class="p">,</span>
					<span class="n">new</span><span class="o">-&gt;</span><span class="n">br_blockcount</span> <span class="o">+</span>
						<span class="n">right</span><span class="p">.</span><span class="n">br_blockcount</span><span class="p">,</span>
					<span class="n">right</span><span class="p">.</span><span class="n">br_state</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="mi">0</span>:
		<span class="cm">/*</span>
<span class="cm">		 * New allocation is not contiguous with another</span>
<span class="cm">		 * real allocation.</span>
<span class="cm">		 * Insert a new entry.</span>
<span class="cm">		 */</span>
		<span class="n">xfs_iext_insert</span><span class="p">(</span><span class="n">bma</span><span class="o">-&gt;</span><span class="n">ip</span><span class="p">,</span> <span class="n">bma</span><span class="o">-&gt;</span><span class="n">idx</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">new</span><span class="p">,</span> <span class="n">state</span><span class="p">);</span>
		<span class="n">XFS_IFORK_NEXT_SET</span><span class="p">(</span><span class="n">bma</span><span class="o">-&gt;</span><span class="n">ip</span><span class="p">,</span> <span class="n">whichfork</span><span class="p">,</span>
			<span class="n">XFS_IFORK_NEXTENTS</span><span class="p">(</span><span class="n">bma</span><span class="o">-&gt;</span><span class="n">ip</span><span class="p">,</span> <span class="n">whichfork</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bma</span><span class="o">-&gt;</span><span class="n">cur</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rval</span> <span class="o">=</span> <span class="n">XFS_ILOG_CORE</span> <span class="o">|</span> <span class="n">xfs_ilog_fext</span><span class="p">(</span><span class="n">whichfork</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">rval</span> <span class="o">=</span> <span class="n">XFS_ILOG_CORE</span><span class="p">;</span>
			<span class="n">error</span> <span class="o">=</span> <span class="n">xfs_bmbt_lookup_eq</span><span class="p">(</span><span class="n">bma</span><span class="o">-&gt;</span><span class="n">cur</span><span class="p">,</span>
					<span class="n">new</span><span class="o">-&gt;</span><span class="n">br_startoff</span><span class="p">,</span>
					<span class="n">new</span><span class="o">-&gt;</span><span class="n">br_startblock</span><span class="p">,</span>
					<span class="n">new</span><span class="o">-&gt;</span><span class="n">br_blockcount</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">i</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
			<span class="n">XFS_WANT_CORRUPTED_GOTO</span><span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="n">done</span><span class="p">);</span>
			<span class="n">bma</span><span class="o">-&gt;</span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">bc_rec</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">br_state</span> <span class="o">=</span> <span class="n">new</span><span class="o">-&gt;</span><span class="n">br_state</span><span class="p">;</span>
			<span class="n">error</span> <span class="o">=</span> <span class="n">xfs_btree_insert</span><span class="p">(</span><span class="n">bma</span><span class="o">-&gt;</span><span class="n">cur</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">i</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
			<span class="n">XFS_WANT_CORRUPTED_GOTO</span><span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="n">done</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* convert to a btree if necessary */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">xfs_bmap_needs_btree</span><span class="p">(</span><span class="n">bma</span><span class="o">-&gt;</span><span class="n">ip</span><span class="p">,</span> <span class="n">whichfork</span><span class="p">))</span> <span class="p">{</span>
		<span class="kt">int</span>	<span class="n">tmp_logflags</span><span class="p">;</span>	<span class="cm">/* partial log flag return val */</span>

		<span class="n">ASSERT</span><span class="p">(</span><span class="n">bma</span><span class="o">-&gt;</span><span class="n">cur</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="n">error</span> <span class="o">=</span> <span class="n">xfs_bmap_extents_to_btree</span><span class="p">(</span><span class="n">bma</span><span class="o">-&gt;</span><span class="n">tp</span><span class="p">,</span> <span class="n">bma</span><span class="o">-&gt;</span><span class="n">ip</span><span class="p">,</span>
				<span class="n">bma</span><span class="o">-&gt;</span><span class="n">firstblock</span><span class="p">,</span> <span class="n">bma</span><span class="o">-&gt;</span><span class="n">flist</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bma</span><span class="o">-&gt;</span><span class="n">cur</span><span class="p">,</span>
				<span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tmp_logflags</span><span class="p">,</span> <span class="n">whichfork</span><span class="p">);</span>
		<span class="n">bma</span><span class="o">-&gt;</span><span class="n">logflags</span> <span class="o">|=</span> <span class="n">tmp_logflags</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* clear out the allocated field, done with it now in any case. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bma</span><span class="o">-&gt;</span><span class="n">cur</span><span class="p">)</span>
		<span class="n">bma</span><span class="o">-&gt;</span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">bc_private</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">allocated</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">xfs_bmap_check_leaf_extents</span><span class="p">(</span><span class="n">bma</span><span class="o">-&gt;</span><span class="n">cur</span><span class="p">,</span> <span class="n">bma</span><span class="o">-&gt;</span><span class="n">ip</span><span class="p">,</span> <span class="n">whichfork</span><span class="p">);</span>
<span class="nl">done:</span>
	<span class="n">bma</span><span class="o">-&gt;</span><span class="n">logflags</span> <span class="o">|=</span> <span class="n">rval</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Adjust the size of the new extent based on di_extsize and rt extsize.</span>
<span class="cm"> */</span>
<span class="n">STATIC</span> <span class="kt">int</span>
<span class="n">xfs_bmap_extsize_align</span><span class="p">(</span>
	<span class="n">xfs_mount_t</span>	<span class="o">*</span><span class="n">mp</span><span class="p">,</span>
	<span class="n">xfs_bmbt_irec_t</span>	<span class="o">*</span><span class="n">gotp</span><span class="p">,</span>		<span class="cm">/* next extent pointer */</span>
	<span class="n">xfs_bmbt_irec_t</span>	<span class="o">*</span><span class="n">prevp</span><span class="p">,</span>		<span class="cm">/* previous extent pointer */</span>
	<span class="n">xfs_extlen_t</span>	<span class="n">extsz</span><span class="p">,</span>		<span class="cm">/* align to this extent size */</span>
	<span class="kt">int</span>		<span class="n">rt</span><span class="p">,</span>		<span class="cm">/* is this a realtime inode? */</span>
	<span class="kt">int</span>		<span class="n">eof</span><span class="p">,</span>		<span class="cm">/* is extent at end-of-file? */</span>
	<span class="kt">int</span>		<span class="n">delay</span><span class="p">,</span>		<span class="cm">/* creating delalloc extent? */</span>
	<span class="kt">int</span>		<span class="n">convert</span><span class="p">,</span>	<span class="cm">/* overwriting unwritten extent? */</span>
	<span class="n">xfs_fileoff_t</span>	<span class="o">*</span><span class="n">offp</span><span class="p">,</span>		<span class="cm">/* in/out: aligned offset */</span>
	<span class="n">xfs_extlen_t</span>	<span class="o">*</span><span class="n">lenp</span><span class="p">)</span>		<span class="cm">/* in/out: aligned length */</span>
<span class="p">{</span>
	<span class="n">xfs_fileoff_t</span>	<span class="n">orig_off</span><span class="p">;</span>	<span class="cm">/* original offset */</span>
	<span class="n">xfs_extlen_t</span>	<span class="n">orig_alen</span><span class="p">;</span>	<span class="cm">/* original length */</span>
	<span class="n">xfs_fileoff_t</span>	<span class="n">orig_end</span><span class="p">;</span>	<span class="cm">/* original off+len */</span>
	<span class="n">xfs_fileoff_t</span>	<span class="n">nexto</span><span class="p">;</span>		<span class="cm">/* next file offset */</span>
	<span class="n">xfs_fileoff_t</span>	<span class="n">prevo</span><span class="p">;</span>		<span class="cm">/* previous file offset */</span>
	<span class="n">xfs_fileoff_t</span>	<span class="n">align_off</span><span class="p">;</span>	<span class="cm">/* temp for offset */</span>
	<span class="n">xfs_extlen_t</span>	<span class="n">align_alen</span><span class="p">;</span>	<span class="cm">/* temp for length */</span>
	<span class="n">xfs_extlen_t</span>	<span class="n">temp</span><span class="p">;</span>		<span class="cm">/* temp for calculations */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">convert</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">orig_off</span> <span class="o">=</span> <span class="n">align_off</span> <span class="o">=</span> <span class="o">*</span><span class="n">offp</span><span class="p">;</span>
	<span class="n">orig_alen</span> <span class="o">=</span> <span class="n">align_alen</span> <span class="o">=</span> <span class="o">*</span><span class="n">lenp</span><span class="p">;</span>
	<span class="n">orig_end</span> <span class="o">=</span> <span class="n">orig_off</span> <span class="o">+</span> <span class="n">orig_alen</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * If this request overlaps an existing extent, then don&#39;t</span>
<span class="cm">	 * attempt to perform any additional alignment.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">delay</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">eof</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">orig_off</span> <span class="o">&gt;=</span> <span class="n">gotp</span><span class="o">-&gt;</span><span class="n">br_startoff</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">orig_end</span> <span class="o">&lt;=</span> <span class="n">gotp</span><span class="o">-&gt;</span><span class="n">br_startoff</span> <span class="o">+</span> <span class="n">gotp</span><span class="o">-&gt;</span><span class="n">br_blockcount</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * If the file offset is unaligned vs. the extent size</span>
<span class="cm">	 * we need to align it.  This will be possible unless</span>
<span class="cm">	 * the file was previously written with a kernel that didn&#39;t</span>
<span class="cm">	 * perform this alignment, or if a truncate shot us in the</span>
<span class="cm">	 * foot.</span>
<span class="cm">	 */</span>
	<span class="n">temp</span> <span class="o">=</span> <span class="n">do_mod</span><span class="p">(</span><span class="n">orig_off</span><span class="p">,</span> <span class="n">extsz</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">temp</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">align_alen</span> <span class="o">+=</span> <span class="n">temp</span><span class="p">;</span>
		<span class="n">align_off</span> <span class="o">-=</span> <span class="n">temp</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/*</span>
<span class="cm">	 * Same adjustment for the end of the requested area.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">temp</span> <span class="o">=</span> <span class="p">(</span><span class="n">align_alen</span> <span class="o">%</span> <span class="n">extsz</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">align_alen</span> <span class="o">+=</span> <span class="n">extsz</span> <span class="o">-</span> <span class="n">temp</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/*</span>
<span class="cm">	 * If the previous block overlaps with this proposed allocation</span>
<span class="cm">	 * then move the start forward without adjusting the length.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">prevp</span><span class="o">-&gt;</span><span class="n">br_startoff</span> <span class="o">!=</span> <span class="n">NULLFILEOFF</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">prevp</span><span class="o">-&gt;</span><span class="n">br_startblock</span> <span class="o">==</span> <span class="n">HOLESTARTBLOCK</span><span class="p">)</span>
			<span class="n">prevo</span> <span class="o">=</span> <span class="n">prevp</span><span class="o">-&gt;</span><span class="n">br_startoff</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">prevo</span> <span class="o">=</span> <span class="n">prevp</span><span class="o">-&gt;</span><span class="n">br_startoff</span> <span class="o">+</span> <span class="n">prevp</span><span class="o">-&gt;</span><span class="n">br_blockcount</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">prevo</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">align_off</span> <span class="o">!=</span> <span class="n">orig_off</span> <span class="o">&amp;&amp;</span> <span class="n">align_off</span> <span class="o">&lt;</span> <span class="n">prevo</span><span class="p">)</span>
		<span class="n">align_off</span> <span class="o">=</span> <span class="n">prevo</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * If the next block overlaps with this proposed allocation</span>
<span class="cm">	 * then move the start back without adjusting the length,</span>
<span class="cm">	 * but not before offset 0.</span>
<span class="cm">	 * This may of course make the start overlap previous block,</span>
<span class="cm">	 * and if we hit the offset 0 limit then the next block</span>
<span class="cm">	 * can still overlap too.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">eof</span> <span class="o">&amp;&amp;</span> <span class="n">gotp</span><span class="o">-&gt;</span><span class="n">br_startoff</span> <span class="o">!=</span> <span class="n">NULLFILEOFF</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">delay</span> <span class="o">&amp;&amp;</span> <span class="n">gotp</span><span class="o">-&gt;</span><span class="n">br_startblock</span> <span class="o">==</span> <span class="n">HOLESTARTBLOCK</span><span class="p">)</span> <span class="o">||</span>
		    <span class="p">(</span><span class="o">!</span><span class="n">delay</span> <span class="o">&amp;&amp;</span> <span class="n">gotp</span><span class="o">-&gt;</span><span class="n">br_startblock</span> <span class="o">==</span> <span class="n">DELAYSTARTBLOCK</span><span class="p">))</span>
			<span class="n">nexto</span> <span class="o">=</span> <span class="n">gotp</span><span class="o">-&gt;</span><span class="n">br_startoff</span> <span class="o">+</span> <span class="n">gotp</span><span class="o">-&gt;</span><span class="n">br_blockcount</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">nexto</span> <span class="o">=</span> <span class="n">gotp</span><span class="o">-&gt;</span><span class="n">br_startoff</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">nexto</span> <span class="o">=</span> <span class="n">NULLFILEOFF</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">eof</span> <span class="o">&amp;&amp;</span>
	    <span class="n">align_off</span> <span class="o">+</span> <span class="n">align_alen</span> <span class="o">!=</span> <span class="n">orig_end</span> <span class="o">&amp;&amp;</span>
	    <span class="n">align_off</span> <span class="o">+</span> <span class="n">align_alen</span> <span class="o">&gt;</span> <span class="n">nexto</span><span class="p">)</span>
		<span class="n">align_off</span> <span class="o">=</span> <span class="n">nexto</span> <span class="o">&gt;</span> <span class="n">align_alen</span> <span class="o">?</span> <span class="n">nexto</span> <span class="o">-</span> <span class="n">align_alen</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * If we&#39;re now overlapping the next or previous extent that</span>
<span class="cm">	 * means we can&#39;t fit an extsz piece in this hole.  Just move</span>
<span class="cm">	 * the start forward to the first valid spot and set</span>
<span class="cm">	 * the length so we hit the end.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">align_off</span> <span class="o">!=</span> <span class="n">orig_off</span> <span class="o">&amp;&amp;</span> <span class="n">align_off</span> <span class="o">&lt;</span> <span class="n">prevo</span><span class="p">)</span>
		<span class="n">align_off</span> <span class="o">=</span> <span class="n">prevo</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">align_off</span> <span class="o">+</span> <span class="n">align_alen</span> <span class="o">!=</span> <span class="n">orig_end</span> <span class="o">&amp;&amp;</span>
	    <span class="n">align_off</span> <span class="o">+</span> <span class="n">align_alen</span> <span class="o">&gt;</span> <span class="n">nexto</span> <span class="o">&amp;&amp;</span>
	    <span class="n">nexto</span> <span class="o">!=</span> <span class="n">NULLFILEOFF</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ASSERT</span><span class="p">(</span><span class="n">nexto</span> <span class="o">&gt;</span> <span class="n">prevo</span><span class="p">);</span>
		<span class="n">align_alen</span> <span class="o">=</span> <span class="n">nexto</span> <span class="o">-</span> <span class="n">align_off</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * If realtime, and the result isn&#39;t a multiple of the realtime</span>
<span class="cm">	 * extent size we need to remove blocks until it is.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rt</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">temp</span> <span class="o">=</span> <span class="p">(</span><span class="n">align_alen</span> <span class="o">%</span> <span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_sb</span><span class="p">.</span><span class="n">sb_rextsize</span><span class="p">)))</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * We&#39;re not covering the original request, or</span>
<span class="cm">		 * we won&#39;t be able to once we fix the length.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">orig_off</span> <span class="o">&lt;</span> <span class="n">align_off</span> <span class="o">||</span>
		    <span class="n">orig_end</span> <span class="o">&gt;</span> <span class="n">align_off</span> <span class="o">+</span> <span class="n">align_alen</span> <span class="o">||</span>
		    <span class="n">align_alen</span> <span class="o">-</span> <span class="n">temp</span> <span class="o">&lt;</span> <span class="n">orig_alen</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">XFS_ERROR</span><span class="p">(</span><span class="n">EINVAL</span><span class="p">);</span>
		<span class="cm">/*</span>
<span class="cm">		 * Try to fix it by moving the start up.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">align_off</span> <span class="o">+</span> <span class="n">temp</span> <span class="o">&lt;=</span> <span class="n">orig_off</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">align_alen</span> <span class="o">-=</span> <span class="n">temp</span><span class="p">;</span>
			<span class="n">align_off</span> <span class="o">+=</span> <span class="n">temp</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/*</span>
<span class="cm">		 * Try to fix it by moving the end in.</span>
<span class="cm">		 */</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">align_off</span> <span class="o">+</span> <span class="n">align_alen</span> <span class="o">-</span> <span class="n">temp</span> <span class="o">&gt;=</span> <span class="n">orig_end</span><span class="p">)</span>
			<span class="n">align_alen</span> <span class="o">-=</span> <span class="n">temp</span><span class="p">;</span>
		<span class="cm">/*</span>
<span class="cm">		 * Set the start to the minimum then trim the length.</span>
<span class="cm">		 */</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="n">align_alen</span> <span class="o">-=</span> <span class="n">orig_off</span> <span class="o">-</span> <span class="n">align_off</span><span class="p">;</span>
			<span class="n">align_off</span> <span class="o">=</span> <span class="n">orig_off</span><span class="p">;</span>
			<span class="n">align_alen</span> <span class="o">-=</span> <span class="n">align_alen</span> <span class="o">%</span> <span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_sb</span><span class="p">.</span><span class="n">sb_rextsize</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/*</span>
<span class="cm">		 * Result doesn&#39;t cover the request, fail it.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">orig_off</span> <span class="o">&lt;</span> <span class="n">align_off</span> <span class="o">||</span> <span class="n">orig_end</span> <span class="o">&gt;</span> <span class="n">align_off</span> <span class="o">+</span> <span class="n">align_alen</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">XFS_ERROR</span><span class="p">(</span><span class="n">EINVAL</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ASSERT</span><span class="p">(</span><span class="n">orig_off</span> <span class="o">&gt;=</span> <span class="n">align_off</span><span class="p">);</span>
		<span class="n">ASSERT</span><span class="p">(</span><span class="n">orig_end</span> <span class="o">&lt;=</span> <span class="n">align_off</span> <span class="o">+</span> <span class="n">align_alen</span><span class="p">);</span>
	<span class="p">}</span>

<span class="cp">#ifdef DEBUG</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">eof</span> <span class="o">&amp;&amp;</span> <span class="n">gotp</span><span class="o">-&gt;</span><span class="n">br_startoff</span> <span class="o">!=</span> <span class="n">NULLFILEOFF</span><span class="p">)</span>
		<span class="n">ASSERT</span><span class="p">(</span><span class="n">align_off</span> <span class="o">+</span> <span class="n">align_alen</span> <span class="o">&lt;=</span> <span class="n">gotp</span><span class="o">-&gt;</span><span class="n">br_startoff</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">prevp</span><span class="o">-&gt;</span><span class="n">br_startoff</span> <span class="o">!=</span> <span class="n">NULLFILEOFF</span><span class="p">)</span>
		<span class="n">ASSERT</span><span class="p">(</span><span class="n">align_off</span> <span class="o">&gt;=</span> <span class="n">prevp</span><span class="o">-&gt;</span><span class="n">br_startoff</span> <span class="o">+</span> <span class="n">prevp</span><span class="o">-&gt;</span><span class="n">br_blockcount</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="o">*</span><span class="n">lenp</span> <span class="o">=</span> <span class="n">align_alen</span><span class="p">;</span>
	<span class="o">*</span><span class="n">offp</span> <span class="o">=</span> <span class="n">align_off</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define XFS_ALLOC_GAP_UNITS	4</span>

<span class="n">STATIC</span> <span class="kt">void</span>
<span class="n">xfs_bmap_adjacent</span><span class="p">(</span>
	<span class="n">xfs_bmalloca_t</span>	<span class="o">*</span><span class="n">ap</span><span class="p">)</span>		<span class="cm">/* bmap alloc argument struct */</span>
<span class="p">{</span>
	<span class="n">xfs_fsblock_t</span>	<span class="n">adjust</span><span class="p">;</span>		<span class="cm">/* adjustment to block numbers */</span>
	<span class="n">xfs_agnumber_t</span>	<span class="n">fb_agno</span><span class="p">;</span>	<span class="cm">/* ag number of ap-&gt;firstblock */</span>
	<span class="n">xfs_mount_t</span>	<span class="o">*</span><span class="n">mp</span><span class="p">;</span>		<span class="cm">/* mount point structure */</span>
	<span class="kt">int</span>		<span class="n">nullfb</span><span class="p">;</span>		<span class="cm">/* true if ap-&gt;firstblock isn&#39;t set */</span>
	<span class="kt">int</span>		<span class="n">rt</span><span class="p">;</span>		<span class="cm">/* true if inode is realtime */</span>

<span class="cp">#define	ISVALID(x,y)	\</span>
<span class="cp">	(rt ? \</span>
<span class="cp">		(x) &lt; mp-&gt;m_sb.sb_rblocks : \</span>
<span class="cp">		XFS_FSB_TO_AGNO(mp, x) == XFS_FSB_TO_AGNO(mp, y) &amp;&amp; \</span>
<span class="cp">		XFS_FSB_TO_AGNO(mp, x) &lt; mp-&gt;m_sb.sb_agcount &amp;&amp; \</span>
<span class="cp">		XFS_FSB_TO_AGBNO(mp, x) &lt; mp-&gt;m_sb.sb_agblocks)</span>

	<span class="n">mp</span> <span class="o">=</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_mount</span><span class="p">;</span>
	<span class="n">nullfb</span> <span class="o">=</span> <span class="o">*</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">firstblock</span> <span class="o">==</span> <span class="n">NULLFSBLOCK</span><span class="p">;</span>
	<span class="n">rt</span> <span class="o">=</span> <span class="n">XFS_IS_REALTIME_INODE</span><span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">ip</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">userdata</span><span class="p">;</span>
	<span class="n">fb_agno</span> <span class="o">=</span> <span class="n">nullfb</span> <span class="o">?</span> <span class="n">NULLAGNUMBER</span> <span class="o">:</span> <span class="n">XFS_FSB_TO_AGNO</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="o">*</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">firstblock</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 * If allocating at eof, and there&#39;s a previous real block,</span>
<span class="cm">	 * try to use its last block as our starting point.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">eof</span> <span class="o">&amp;&amp;</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">prev</span><span class="p">.</span><span class="n">br_startoff</span> <span class="o">!=</span> <span class="n">NULLFILEOFF</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="n">isnullstartblock</span><span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">prev</span><span class="p">.</span><span class="n">br_startblock</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">ISVALID</span><span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">prev</span><span class="p">.</span><span class="n">br_startblock</span> <span class="o">+</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">prev</span><span class="p">.</span><span class="n">br_blockcount</span><span class="p">,</span>
		    <span class="n">ap</span><span class="o">-&gt;</span><span class="n">prev</span><span class="p">.</span><span class="n">br_startblock</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ap</span><span class="o">-&gt;</span><span class="n">blkno</span> <span class="o">=</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">prev</span><span class="p">.</span><span class="n">br_startblock</span> <span class="o">+</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">prev</span><span class="p">.</span><span class="n">br_blockcount</span><span class="p">;</span>
		<span class="cm">/*</span>
<span class="cm">		 * Adjust for the gap between prevp and us.</span>
<span class="cm">		 */</span>
		<span class="n">adjust</span> <span class="o">=</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">-</span>
			<span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">prev</span><span class="p">.</span><span class="n">br_startoff</span> <span class="o">+</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">prev</span><span class="p">.</span><span class="n">br_blockcount</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">adjust</span> <span class="o">&amp;&amp;</span>
		    <span class="n">ISVALID</span><span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">blkno</span> <span class="o">+</span> <span class="n">adjust</span><span class="p">,</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">prev</span><span class="p">.</span><span class="n">br_startblock</span><span class="p">))</span>
			<span class="n">ap</span><span class="o">-&gt;</span><span class="n">blkno</span> <span class="o">+=</span> <span class="n">adjust</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/*</span>
<span class="cm">	 * If not at eof, then compare the two neighbor blocks.</span>
<span class="cm">	 * Figure out whether either one gives us a good starting point,</span>
<span class="cm">	 * and pick the better one.</span>
<span class="cm">	 */</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">eof</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">xfs_fsblock_t</span>	<span class="n">gotbno</span><span class="p">;</span>		<span class="cm">/* right side block number */</span>
		<span class="n">xfs_fsblock_t</span>	<span class="n">gotdiff</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>	<span class="cm">/* right side difference */</span>
		<span class="n">xfs_fsblock_t</span>	<span class="n">prevbno</span><span class="p">;</span>	<span class="cm">/* left side block number */</span>
		<span class="n">xfs_fsblock_t</span>	<span class="n">prevdiff</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>	<span class="cm">/* left side difference */</span>

		<span class="cm">/*</span>
<span class="cm">		 * If there&#39;s a previous (left) block, select a requested</span>
<span class="cm">		 * start block based on it.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">prev</span><span class="p">.</span><span class="n">br_startoff</span> <span class="o">!=</span> <span class="n">NULLFILEOFF</span> <span class="o">&amp;&amp;</span>
		    <span class="o">!</span><span class="n">isnullstartblock</span><span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">prev</span><span class="p">.</span><span class="n">br_startblock</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">prevbno</span> <span class="o">=</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">prev</span><span class="p">.</span><span class="n">br_startblock</span> <span class="o">+</span>
			       <span class="n">ap</span><span class="o">-&gt;</span><span class="n">prev</span><span class="p">.</span><span class="n">br_blockcount</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="n">ISVALID</span><span class="p">(</span><span class="n">prevbno</span><span class="p">,</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">prev</span><span class="p">.</span><span class="n">br_startblock</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * Calculate gap to end of previous block.</span>
<span class="cm">			 */</span>
			<span class="n">adjust</span> <span class="o">=</span> <span class="n">prevdiff</span> <span class="o">=</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">-</span>
				<span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">prev</span><span class="p">.</span><span class="n">br_startoff</span> <span class="o">+</span>
				 <span class="n">ap</span><span class="o">-&gt;</span><span class="n">prev</span><span class="p">.</span><span class="n">br_blockcount</span><span class="p">);</span>
			<span class="cm">/*</span>
<span class="cm">			 * Figure the startblock based on the previous block&#39;s</span>
<span class="cm">			 * end and the gap size.</span>
<span class="cm">			 * Heuristic!</span>
<span class="cm">			 * If the gap is large relative to the piece we&#39;re</span>
<span class="cm">			 * allocating, or using it gives us an invalid block</span>
<span class="cm">			 * number, then just use the end of the previous block.</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">prevdiff</span> <span class="o">&lt;=</span> <span class="n">XFS_ALLOC_GAP_UNITS</span> <span class="o">*</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">&amp;&amp;</span>
			    <span class="n">ISVALID</span><span class="p">(</span><span class="n">prevbno</span> <span class="o">+</span> <span class="n">prevdiff</span><span class="p">,</span>
				    <span class="n">ap</span><span class="o">-&gt;</span><span class="n">prev</span><span class="p">.</span><span class="n">br_startblock</span><span class="p">))</span>
				<span class="n">prevbno</span> <span class="o">+=</span> <span class="n">adjust</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">prevdiff</span> <span class="o">+=</span> <span class="n">adjust</span><span class="p">;</span>
			<span class="cm">/*</span>
<span class="cm">			 * If the firstblock forbids it, can&#39;t use it,</span>
<span class="cm">			 * must use default.</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rt</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">nullfb</span> <span class="o">&amp;&amp;</span>
			    <span class="n">XFS_FSB_TO_AGNO</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="n">prevbno</span><span class="p">)</span> <span class="o">!=</span> <span class="n">fb_agno</span><span class="p">)</span>
				<span class="n">prevbno</span> <span class="o">=</span> <span class="n">NULLFSBLOCK</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/*</span>
<span class="cm">		 * No previous block or can&#39;t follow it, just default.</span>
<span class="cm">		 */</span>
		<span class="k">else</span>
			<span class="n">prevbno</span> <span class="o">=</span> <span class="n">NULLFSBLOCK</span><span class="p">;</span>
		<span class="cm">/*</span>
<span class="cm">		 * If there&#39;s a following (right) block, select a requested</span>
<span class="cm">		 * start block based on it.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">isnullstartblock</span><span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">got</span><span class="p">.</span><span class="n">br_startblock</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * Calculate gap to start of next block.</span>
<span class="cm">			 */</span>
			<span class="n">adjust</span> <span class="o">=</span> <span class="n">gotdiff</span> <span class="o">=</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">got</span><span class="p">.</span><span class="n">br_startoff</span> <span class="o">-</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">;</span>
			<span class="cm">/*</span>
<span class="cm">			 * Figure the startblock based on the next block&#39;s</span>
<span class="cm">			 * start and the gap size.</span>
<span class="cm">			 */</span>
			<span class="n">gotbno</span> <span class="o">=</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">got</span><span class="p">.</span><span class="n">br_startblock</span><span class="p">;</span>
			<span class="cm">/*</span>
<span class="cm">			 * Heuristic!</span>
<span class="cm">			 * If the gap is large relative to the piece we&#39;re</span>
<span class="cm">			 * allocating, or using it gives us an invalid block</span>
<span class="cm">			 * number, then just use the start of the next block</span>
<span class="cm">			 * offset by our length.</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">gotdiff</span> <span class="o">&lt;=</span> <span class="n">XFS_ALLOC_GAP_UNITS</span> <span class="o">*</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">&amp;&amp;</span>
			    <span class="n">ISVALID</span><span class="p">(</span><span class="n">gotbno</span> <span class="o">-</span> <span class="n">gotdiff</span><span class="p">,</span> <span class="n">gotbno</span><span class="p">))</span>
				<span class="n">gotbno</span> <span class="o">-=</span> <span class="n">adjust</span><span class="p">;</span>
			<span class="k">else</span> <span class="nf">if</span> <span class="p">(</span><span class="n">ISVALID</span><span class="p">(</span><span class="n">gotbno</span> <span class="o">-</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">,</span> <span class="n">gotbno</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">gotbno</span> <span class="o">-=</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">;</span>
				<span class="n">gotdiff</span> <span class="o">+=</span> <span class="n">adjust</span> <span class="o">-</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span>
				<span class="n">gotdiff</span> <span class="o">+=</span> <span class="n">adjust</span><span class="p">;</span>
			<span class="cm">/*</span>
<span class="cm">			 * If the firstblock forbids it, can&#39;t use it,</span>
<span class="cm">			 * must use default.</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rt</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">nullfb</span> <span class="o">&amp;&amp;</span>
			    <span class="n">XFS_FSB_TO_AGNO</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="n">gotbno</span><span class="p">)</span> <span class="o">!=</span> <span class="n">fb_agno</span><span class="p">)</span>
				<span class="n">gotbno</span> <span class="o">=</span> <span class="n">NULLFSBLOCK</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/*</span>
<span class="cm">		 * No next block, just default.</span>
<span class="cm">		 */</span>
		<span class="k">else</span>
			<span class="n">gotbno</span> <span class="o">=</span> <span class="n">NULLFSBLOCK</span><span class="p">;</span>
		<span class="cm">/*</span>
<span class="cm">		 * If both valid, pick the better one, else the only good</span>
<span class="cm">		 * one, else ap-&gt;blkno is already set (to 0 or the inode block).</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">prevbno</span> <span class="o">!=</span> <span class="n">NULLFSBLOCK</span> <span class="o">&amp;&amp;</span> <span class="n">gotbno</span> <span class="o">!=</span> <span class="n">NULLFSBLOCK</span><span class="p">)</span>
			<span class="n">ap</span><span class="o">-&gt;</span><span class="n">blkno</span> <span class="o">=</span> <span class="n">prevdiff</span> <span class="o">&lt;=</span> <span class="n">gotdiff</span> <span class="o">?</span> <span class="n">prevbno</span> <span class="o">:</span> <span class="n">gotbno</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">prevbno</span> <span class="o">!=</span> <span class="n">NULLFSBLOCK</span><span class="p">)</span>
			<span class="n">ap</span><span class="o">-&gt;</span><span class="n">blkno</span> <span class="o">=</span> <span class="n">prevbno</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">gotbno</span> <span class="o">!=</span> <span class="n">NULLFSBLOCK</span><span class="p">)</span>
			<span class="n">ap</span><span class="o">-&gt;</span><span class="n">blkno</span> <span class="o">=</span> <span class="n">gotbno</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#undef ISVALID</span>
<span class="p">}</span>

<span class="n">STATIC</span> <span class="kt">int</span>
<span class="n">xfs_bmap_rtalloc</span><span class="p">(</span>
	<span class="n">xfs_bmalloca_t</span>	<span class="o">*</span><span class="n">ap</span><span class="p">)</span>		<span class="cm">/* bmap alloc argument struct */</span>
<span class="p">{</span>
	<span class="n">xfs_alloctype_t</span>	<span class="n">atype</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* type for allocation routines */</span>
	<span class="kt">int</span>		<span class="n">error</span><span class="p">;</span>		<span class="cm">/* error return value */</span>
	<span class="n">xfs_mount_t</span>	<span class="o">*</span><span class="n">mp</span><span class="p">;</span>		<span class="cm">/* mount point structure */</span>
	<span class="n">xfs_extlen_t</span>	<span class="n">prod</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* product factor for allocators */</span>
	<span class="n">xfs_extlen_t</span>	<span class="n">ralen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* realtime allocation length */</span>
	<span class="n">xfs_extlen_t</span>	<span class="n">align</span><span class="p">;</span>		<span class="cm">/* minimum allocation alignment */</span>
	<span class="n">xfs_rtblock_t</span>	<span class="n">rtb</span><span class="p">;</span>

	<span class="n">mp</span> <span class="o">=</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_mount</span><span class="p">;</span>
	<span class="n">align</span> <span class="o">=</span> <span class="n">xfs_get_extsz_hint</span><span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">ip</span><span class="p">);</span>
	<span class="n">prod</span> <span class="o">=</span> <span class="n">align</span> <span class="o">/</span> <span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_sb</span><span class="p">.</span><span class="n">sb_rextsize</span><span class="p">;</span>
	<span class="n">error</span> <span class="o">=</span> <span class="n">xfs_bmap_extsize_align</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">got</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">prev</span><span class="p">,</span>
					<span class="n">align</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">eof</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
					<span class="n">ap</span><span class="o">-&gt;</span><span class="n">conv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">ASSERT</span><span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">);</span>
	<span class="n">ASSERT</span><span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">%</span> <span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_sb</span><span class="p">.</span><span class="n">sb_rextsize</span> <span class="o">==</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * If the offset &amp; length are not perfectly aligned</span>
<span class="cm">	 * then kill prod, it will just get us in trouble.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">do_mod</span><span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">,</span> <span class="n">align</span><span class="p">)</span> <span class="o">||</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">%</span> <span class="n">align</span><span class="p">)</span>
		<span class="n">prod</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * Set ralen to be the actual requested length in rtextents.</span>
<span class="cm">	 */</span>
	<span class="n">ralen</span> <span class="o">=</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">/</span> <span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_sb</span><span class="p">.</span><span class="n">sb_rextsize</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * If the old value was close enough to MAXEXTLEN that</span>
<span class="cm">	 * we rounded up to it, cut it back so it&#39;s valid again.</span>
<span class="cm">	 * Note that if it&#39;s a really large request (bigger than</span>
<span class="cm">	 * MAXEXTLEN), we don&#39;t hear about that number, and can&#39;t</span>
<span class="cm">	 * adjust the starting point to match it.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ralen</span> <span class="o">*</span> <span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_sb</span><span class="p">.</span><span class="n">sb_rextsize</span> <span class="o">&gt;=</span> <span class="n">MAXEXTLEN</span><span class="p">)</span>
		<span class="n">ralen</span> <span class="o">=</span> <span class="n">MAXEXTLEN</span> <span class="o">/</span> <span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_sb</span><span class="p">.</span><span class="n">sb_rextsize</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Lock out other modifications to the RT bitmap inode.</span>
<span class="cm">	 */</span>
	<span class="n">xfs_ilock</span><span class="p">(</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_rbmip</span><span class="p">,</span> <span class="n">XFS_ILOCK_EXCL</span><span class="p">);</span>
	<span class="n">xfs_trans_ijoin</span><span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">tp</span><span class="p">,</span> <span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_rbmip</span><span class="p">,</span> <span class="n">XFS_ILOCK_EXCL</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * If it&#39;s an allocation to an empty file at offset 0,</span>
<span class="cm">	 * pick an extent that will space things out in the rt area.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">eof</span> <span class="o">&amp;&amp;</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">xfs_rtblock_t</span> <span class="n">uninitialized_var</span><span class="p">(</span><span class="n">rtx</span><span class="p">);</span> <span class="cm">/* realtime extent no */</span>

		<span class="n">error</span> <span class="o">=</span> <span class="n">xfs_rtpick_extent</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">tp</span><span class="p">,</span> <span class="n">ralen</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rtx</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
		<span class="n">ap</span><span class="o">-&gt;</span><span class="n">blkno</span> <span class="o">=</span> <span class="n">rtx</span> <span class="o">*</span> <span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_sb</span><span class="p">.</span><span class="n">sb_rextsize</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ap</span><span class="o">-&gt;</span><span class="n">blkno</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">xfs_bmap_adjacent</span><span class="p">(</span><span class="n">ap</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Realtime allocation, done through xfs_rtallocate_extent.</span>
<span class="cm">	 */</span>
	<span class="n">atype</span> <span class="o">=</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">blkno</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">?</span>  <span class="n">XFS_ALLOCTYPE_ANY_AG</span> <span class="o">:</span> <span class="n">XFS_ALLOCTYPE_NEAR_BNO</span><span class="p">;</span>
	<span class="n">do_div</span><span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">blkno</span><span class="p">,</span> <span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_sb</span><span class="p">.</span><span class="n">sb_rextsize</span><span class="p">);</span>
	<span class="n">rtb</span> <span class="o">=</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">blkno</span><span class="p">;</span>
	<span class="n">ap</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">=</span> <span class="n">ralen</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">error</span> <span class="o">=</span> <span class="n">xfs_rtallocate_extent</span><span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">tp</span><span class="p">,</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">blkno</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="n">ralen</span><span class="p">,</span> <span class="n">atype</span><span class="p">,</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">wasdel</span><span class="p">,</span> <span class="n">prod</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rtb</span><span class="p">)))</span>
		<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rtb</span> <span class="o">==</span> <span class="n">NULLFSBLOCK</span> <span class="o">&amp;&amp;</span> <span class="n">prod</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">error</span> <span class="o">=</span> <span class="n">xfs_rtallocate_extent</span><span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">tp</span><span class="p">,</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">blkno</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
					   <span class="n">ap</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ralen</span><span class="p">,</span> <span class="n">atype</span><span class="p">,</span>
					   <span class="n">ap</span><span class="o">-&gt;</span><span class="n">wasdel</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rtb</span><span class="p">)))</span>
		<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">ap</span><span class="o">-&gt;</span><span class="n">blkno</span> <span class="o">=</span> <span class="n">rtb</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">blkno</span> <span class="o">!=</span> <span class="n">NULLFSBLOCK</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ap</span><span class="o">-&gt;</span><span class="n">blkno</span> <span class="o">*=</span> <span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_sb</span><span class="p">.</span><span class="n">sb_rextsize</span><span class="p">;</span>
		<span class="n">ralen</span> <span class="o">*=</span> <span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_sb</span><span class="p">.</span><span class="n">sb_rextsize</span><span class="p">;</span>
		<span class="n">ap</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">=</span> <span class="n">ralen</span><span class="p">;</span>
		<span class="n">ap</span><span class="o">-&gt;</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_d</span><span class="p">.</span><span class="n">di_nblocks</span> <span class="o">+=</span> <span class="n">ralen</span><span class="p">;</span>
		<span class="n">xfs_trans_log_inode</span><span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">tp</span><span class="p">,</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">ip</span><span class="p">,</span> <span class="n">XFS_ILOG_CORE</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">wasdel</span><span class="p">)</span>
			<span class="n">ap</span><span class="o">-&gt;</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_delayed_blks</span> <span class="o">-=</span> <span class="n">ralen</span><span class="p">;</span>
		<span class="cm">/*</span>
<span class="cm">		 * Adjust the disk quota also. This was reserved</span>
<span class="cm">		 * earlier.</span>
<span class="cm">		 */</span>
		<span class="n">xfs_trans_mod_dquot_byino</span><span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">tp</span><span class="p">,</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">ip</span><span class="p">,</span>
			<span class="n">ap</span><span class="o">-&gt;</span><span class="n">wasdel</span> <span class="o">?</span> <span class="n">XFS_TRANS_DQ_DELRTBCOUNT</span> <span class="o">:</span>
					<span class="n">XFS_TRANS_DQ_RTBCOUNT</span><span class="p">,</span> <span class="p">(</span><span class="kt">long</span><span class="p">)</span> <span class="n">ralen</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ap</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">STATIC</span> <span class="kt">int</span>
<span class="n">xfs_bmap_btalloc_nullfb</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">xfs_bmalloca</span>	<span class="o">*</span><span class="n">ap</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">xfs_alloc_arg</span>	<span class="o">*</span><span class="n">args</span><span class="p">,</span>
	<span class="n">xfs_extlen_t</span>		<span class="o">*</span><span class="n">blen</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">xfs_mount</span>	<span class="o">*</span><span class="n">mp</span> <span class="o">=</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_mount</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">xfs_perag</span>	<span class="o">*</span><span class="n">pag</span><span class="p">;</span>
	<span class="n">xfs_agnumber_t</span>		<span class="n">ag</span><span class="p">,</span> <span class="n">startag</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">notinit</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">error</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">userdata</span> <span class="o">&amp;&amp;</span> <span class="n">xfs_inode_is_filestream</span><span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">ip</span><span class="p">))</span>
		<span class="n">args</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">XFS_ALLOCTYPE_NEAR_BNO</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">args</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">XFS_ALLOCTYPE_START_BNO</span><span class="p">;</span>
	<span class="n">args</span><span class="o">-&gt;</span><span class="n">total</span> <span class="o">=</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">total</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Search for an allocation group with a single extent large enough</span>
<span class="cm">	 * for the request.  If one isn&#39;t found, then adjust the minimum</span>
<span class="cm">	 * allocation size to the largest space found.</span>
<span class="cm">	 */</span>
	<span class="n">startag</span> <span class="o">=</span> <span class="n">ag</span> <span class="o">=</span> <span class="n">XFS_FSB_TO_AGNO</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="n">args</span><span class="o">-&gt;</span><span class="n">fsbno</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">startag</span> <span class="o">==</span> <span class="n">NULLAGNUMBER</span><span class="p">)</span>
		<span class="n">startag</span> <span class="o">=</span> <span class="n">ag</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">pag</span> <span class="o">=</span> <span class="n">xfs_perag_get</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="n">ag</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">*</span><span class="n">blen</span> <span class="o">&lt;</span> <span class="n">args</span><span class="o">-&gt;</span><span class="n">maxlen</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pag</span><span class="o">-&gt;</span><span class="n">pagf_init</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">error</span> <span class="o">=</span> <span class="n">xfs_alloc_pagf_init</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="n">args</span><span class="o">-&gt;</span><span class="n">tp</span><span class="p">,</span> <span class="n">ag</span><span class="p">,</span>
						    <span class="n">XFS_ALLOC_FLAG_TRYLOCK</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">xfs_perag_put</span><span class="p">(</span><span class="n">pag</span><span class="p">);</span>
				<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="cm">/*</span>
<span class="cm">		 * See xfs_alloc_fix_freelist...</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pag</span><span class="o">-&gt;</span><span class="n">pagf_init</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">xfs_extlen_t</span>	<span class="n">longest</span><span class="p">;</span>
			<span class="n">longest</span> <span class="o">=</span> <span class="n">xfs_alloc_longest_free_extent</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="n">pag</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">blen</span> <span class="o">&lt;</span> <span class="n">longest</span><span class="p">)</span>
				<span class="o">*</span><span class="n">blen</span> <span class="o">=</span> <span class="n">longest</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">notinit</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">xfs_inode_is_filestream</span><span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">ip</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">blen</span> <span class="o">&gt;=</span> <span class="n">args</span><span class="o">-&gt;</span><span class="n">maxlen</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">userdata</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/*</span>
<span class="cm">				 * If startag is an invalid AG, we&#39;ve</span>
<span class="cm">				 * come here once before and</span>
<span class="cm">				 * xfs_filestream_new_ag picked the</span>
<span class="cm">				 * best currently available.</span>
<span class="cm">				 *</span>
<span class="cm">				 * Don&#39;t continue looping, since we</span>
<span class="cm">				 * could loop forever.</span>
<span class="cm">				 */</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">startag</span> <span class="o">==</span> <span class="n">NULLAGNUMBER</span><span class="p">)</span>
					<span class="k">break</span><span class="p">;</span>

				<span class="n">error</span> <span class="o">=</span> <span class="n">xfs_filestream_new_ag</span><span class="p">(</span><span class="n">ap</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ag</span><span class="p">);</span>
				<span class="n">xfs_perag_put</span><span class="p">(</span><span class="n">pag</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
					<span class="k">return</span> <span class="n">error</span><span class="p">;</span>

				<span class="cm">/* loop again to set &#39;blen&#39;*/</span>
				<span class="n">startag</span> <span class="o">=</span> <span class="n">NULLAGNUMBER</span><span class="p">;</span>
				<span class="n">pag</span> <span class="o">=</span> <span class="n">xfs_perag_get</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="n">ag</span><span class="p">);</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="n">ag</span> <span class="o">==</span> <span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_sb</span><span class="p">.</span><span class="n">sb_agcount</span><span class="p">)</span>
			<span class="n">ag</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ag</span> <span class="o">==</span> <span class="n">startag</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">xfs_perag_put</span><span class="p">(</span><span class="n">pag</span><span class="p">);</span>
		<span class="n">pag</span> <span class="o">=</span> <span class="n">xfs_perag_get</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="n">ag</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">xfs_perag_put</span><span class="p">(</span><span class="n">pag</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Since the above loop did a BUF_TRYLOCK, it is</span>
<span class="cm">	 * possible that there is space for this request.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">notinit</span> <span class="o">||</span> <span class="o">*</span><span class="n">blen</span> <span class="o">&lt;</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">minlen</span><span class="p">)</span>
		<span class="n">args</span><span class="o">-&gt;</span><span class="n">minlen</span> <span class="o">=</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">minlen</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * If the best seen length is less than the request</span>
<span class="cm">	 * length, use the best as the minimum.</span>
<span class="cm">	 */</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">blen</span> <span class="o">&lt;</span> <span class="n">args</span><span class="o">-&gt;</span><span class="n">maxlen</span><span class="p">)</span>
		<span class="n">args</span><span class="o">-&gt;</span><span class="n">minlen</span> <span class="o">=</span> <span class="o">*</span><span class="n">blen</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * Otherwise we&#39;ve seen an extent as big as maxlen,</span>
<span class="cm">	 * use that as the minimum.</span>
<span class="cm">	 */</span>
	<span class="k">else</span>
		<span class="n">args</span><span class="o">-&gt;</span><span class="n">minlen</span> <span class="o">=</span> <span class="n">args</span><span class="o">-&gt;</span><span class="n">maxlen</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * set the failure fallback case to look in the selected</span>
<span class="cm">	 * AG as the stream may have moved.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">xfs_inode_is_filestream</span><span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">ip</span><span class="p">))</span>
		<span class="n">ap</span><span class="o">-&gt;</span><span class="n">blkno</span> <span class="o">=</span> <span class="n">args</span><span class="o">-&gt;</span><span class="n">fsbno</span> <span class="o">=</span> <span class="n">XFS_AGB_TO_FSB</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="n">ag</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">STATIC</span> <span class="kt">int</span>
<span class="n">xfs_bmap_btalloc</span><span class="p">(</span>
	<span class="n">xfs_bmalloca_t</span>	<span class="o">*</span><span class="n">ap</span><span class="p">)</span>		<span class="cm">/* bmap alloc argument struct */</span>
<span class="p">{</span>
	<span class="n">xfs_mount_t</span>	<span class="o">*</span><span class="n">mp</span><span class="p">;</span>		<span class="cm">/* mount point structure */</span>
	<span class="n">xfs_alloctype_t</span>	<span class="n">atype</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* type for allocation routines */</span>
	<span class="n">xfs_extlen_t</span>	<span class="n">align</span><span class="p">;</span>		<span class="cm">/* minimum allocation alignment */</span>
	<span class="n">xfs_agnumber_t</span>	<span class="n">fb_agno</span><span class="p">;</span>	<span class="cm">/* ag number of ap-&gt;firstblock */</span>
	<span class="n">xfs_agnumber_t</span>	<span class="n">ag</span><span class="p">;</span>
	<span class="n">xfs_alloc_arg_t</span>	<span class="n">args</span><span class="p">;</span>
	<span class="n">xfs_extlen_t</span>	<span class="n">blen</span><span class="p">;</span>
	<span class="n">xfs_extlen_t</span>	<span class="n">nextminlen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span>		<span class="n">nullfb</span><span class="p">;</span>		<span class="cm">/* true if ap-&gt;firstblock isn&#39;t set */</span>
	<span class="kt">int</span>		<span class="n">isaligned</span><span class="p">;</span>
	<span class="kt">int</span>		<span class="n">tryagain</span><span class="p">;</span>
	<span class="kt">int</span>		<span class="n">error</span><span class="p">;</span>

	<span class="n">ASSERT</span><span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">);</span>

	<span class="n">mp</span> <span class="o">=</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_mount</span><span class="p">;</span>
	<span class="n">align</span> <span class="o">=</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">userdata</span> <span class="o">?</span> <span class="n">xfs_get_extsz_hint</span><span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">ip</span><span class="p">)</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">align</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">error</span> <span class="o">=</span> <span class="n">xfs_bmap_extsize_align</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">got</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">prev</span><span class="p">,</span>
						<span class="n">align</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">eof</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">conv</span><span class="p">,</span>
						<span class="o">&amp;</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">);</span>
		<span class="n">ASSERT</span><span class="p">(</span><span class="o">!</span><span class="n">error</span><span class="p">);</span>
		<span class="n">ASSERT</span><span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">nullfb</span> <span class="o">=</span> <span class="o">*</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">firstblock</span> <span class="o">==</span> <span class="n">NULLFSBLOCK</span><span class="p">;</span>
	<span class="n">fb_agno</span> <span class="o">=</span> <span class="n">nullfb</span> <span class="o">?</span> <span class="n">NULLAGNUMBER</span> <span class="o">:</span> <span class="n">XFS_FSB_TO_AGNO</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="o">*</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">firstblock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nullfb</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">userdata</span> <span class="o">&amp;&amp;</span> <span class="n">xfs_inode_is_filestream</span><span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">ip</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">ag</span> <span class="o">=</span> <span class="n">xfs_filestream_lookup_ag</span><span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">ip</span><span class="p">);</span>
			<span class="n">ag</span> <span class="o">=</span> <span class="p">(</span><span class="n">ag</span> <span class="o">!=</span> <span class="n">NULLAGNUMBER</span><span class="p">)</span> <span class="o">?</span> <span class="n">ag</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">ap</span><span class="o">-&gt;</span><span class="n">blkno</span> <span class="o">=</span> <span class="n">XFS_AGB_TO_FSB</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="n">ag</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">ap</span><span class="o">-&gt;</span><span class="n">blkno</span> <span class="o">=</span> <span class="n">XFS_INO_TO_FSB</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_ino</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">ap</span><span class="o">-&gt;</span><span class="n">blkno</span> <span class="o">=</span> <span class="o">*</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">firstblock</span><span class="p">;</span>

	<span class="n">xfs_bmap_adjacent</span><span class="p">(</span><span class="n">ap</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * If allowed, use ap-&gt;blkno; otherwise must use firstblock since</span>
<span class="cm">	 * it&#39;s in the right allocation group.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nullfb</span> <span class="o">||</span> <span class="n">XFS_FSB_TO_AGNO</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">blkno</span><span class="p">)</span> <span class="o">==</span> <span class="n">fb_agno</span><span class="p">)</span>
		<span class="p">;</span>
	<span class="k">else</span>
		<span class="n">ap</span><span class="o">-&gt;</span><span class="n">blkno</span> <span class="o">=</span> <span class="o">*</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">firstblock</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * Normal allocation, done through xfs_alloc_vextent.</span>
<span class="cm">	 */</span>
	<span class="n">tryagain</span> <span class="o">=</span> <span class="n">isaligned</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">args</span><span class="p">.</span><span class="n">tp</span> <span class="o">=</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">tp</span><span class="p">;</span>
	<span class="n">args</span><span class="p">.</span><span class="n">mp</span> <span class="o">=</span> <span class="n">mp</span><span class="p">;</span>
	<span class="n">args</span><span class="p">.</span><span class="n">fsbno</span> <span class="o">=</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">blkno</span><span class="p">;</span>

	<span class="cm">/* Trim the allocation back to the maximum an AG can fit. */</span>
	<span class="n">args</span><span class="p">.</span><span class="n">maxlen</span> <span class="o">=</span> <span class="n">MIN</span><span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">,</span> <span class="n">XFS_ALLOC_AG_MAX_USABLE</span><span class="p">(</span><span class="n">mp</span><span class="p">));</span>
	<span class="n">args</span><span class="p">.</span><span class="n">firstblock</span> <span class="o">=</span> <span class="o">*</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">firstblock</span><span class="p">;</span>
	<span class="n">blen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nullfb</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">error</span> <span class="o">=</span> <span class="n">xfs_bmap_btalloc_nullfb</span><span class="p">(</span><span class="n">ap</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">args</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">blen</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">flist</span><span class="o">-&gt;</span><span class="n">xbf_low</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">xfs_inode_is_filestream</span><span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">ip</span><span class="p">))</span>
			<span class="n">args</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">XFS_ALLOCTYPE_FIRST_AG</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">args</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">XFS_ALLOCTYPE_START_BNO</span><span class="p">;</span>
		<span class="n">args</span><span class="p">.</span><span class="n">total</span> <span class="o">=</span> <span class="n">args</span><span class="p">.</span><span class="n">minlen</span> <span class="o">=</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">minlen</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">args</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">XFS_ALLOCTYPE_NEAR_BNO</span><span class="p">;</span>
		<span class="n">args</span><span class="p">.</span><span class="n">total</span> <span class="o">=</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">total</span><span class="p">;</span>
		<span class="n">args</span><span class="p">.</span><span class="n">minlen</span> <span class="o">=</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">minlen</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* apply extent size hints if obtained earlier */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">align</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">args</span><span class="p">.</span><span class="n">prod</span> <span class="o">=</span> <span class="n">align</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">args</span><span class="p">.</span><span class="n">mod</span> <span class="o">=</span> <span class="p">(</span><span class="n">xfs_extlen_t</span><span class="p">)</span><span class="n">do_mod</span><span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">,</span> <span class="n">args</span><span class="p">.</span><span class="n">prod</span><span class="p">)))</span>
			<span class="n">args</span><span class="p">.</span><span class="n">mod</span> <span class="o">=</span> <span class="p">(</span><span class="n">xfs_extlen_t</span><span class="p">)(</span><span class="n">args</span><span class="p">.</span><span class="n">prod</span> <span class="o">-</span> <span class="n">args</span><span class="p">.</span><span class="n">mod</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_sb</span><span class="p">.</span><span class="n">sb_blocksize</span> <span class="o">&gt;=</span> <span class="n">PAGE_CACHE_SIZE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">args</span><span class="p">.</span><span class="n">prod</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">args</span><span class="p">.</span><span class="n">mod</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">args</span><span class="p">.</span><span class="n">prod</span> <span class="o">=</span> <span class="n">PAGE_CACHE_SIZE</span> <span class="o">&gt;&gt;</span> <span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_sb</span><span class="p">.</span><span class="n">sb_blocklog</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">args</span><span class="p">.</span><span class="n">mod</span> <span class="o">=</span> <span class="p">(</span><span class="n">xfs_extlen_t</span><span class="p">)(</span><span class="n">do_mod</span><span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">,</span> <span class="n">args</span><span class="p">.</span><span class="n">prod</span><span class="p">))))</span>
			<span class="n">args</span><span class="p">.</span><span class="n">mod</span> <span class="o">=</span> <span class="p">(</span><span class="n">xfs_extlen_t</span><span class="p">)(</span><span class="n">args</span><span class="p">.</span><span class="n">prod</span> <span class="o">-</span> <span class="n">args</span><span class="p">.</span><span class="n">mod</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="cm">/*</span>
<span class="cm">	 * If we are not low on available data blocks, and the</span>
<span class="cm">	 * underlying logical volume manager is a stripe, and</span>
<span class="cm">	 * the file offset is zero then try to allocate data</span>
<span class="cm">	 * blocks on stripe unit boundary.</span>
<span class="cm">	 * NOTE: ap-&gt;aeof is only set if the allocation length</span>
<span class="cm">	 * is &gt;= the stripe unit and the allocation offset is</span>
<span class="cm">	 * at the end of file.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">flist</span><span class="o">-&gt;</span><span class="n">xbf_low</span> <span class="o">&amp;&amp;</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">aeof</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">args</span><span class="p">.</span><span class="n">alignment</span> <span class="o">=</span> <span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_dalign</span><span class="p">;</span>
			<span class="n">atype</span> <span class="o">=</span> <span class="n">args</span><span class="p">.</span><span class="n">type</span><span class="p">;</span>
			<span class="n">isaligned</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="cm">/*</span>
<span class="cm">			 * Adjust for alignment</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">blen</span> <span class="o">&gt;</span> <span class="n">args</span><span class="p">.</span><span class="n">alignment</span> <span class="o">&amp;&amp;</span> <span class="n">blen</span> <span class="o">&lt;=</span> <span class="n">args</span><span class="p">.</span><span class="n">maxlen</span><span class="p">)</span>
				<span class="n">args</span><span class="p">.</span><span class="n">minlen</span> <span class="o">=</span> <span class="n">blen</span> <span class="o">-</span> <span class="n">args</span><span class="p">.</span><span class="n">alignment</span><span class="p">;</span>
			<span class="n">args</span><span class="p">.</span><span class="n">minalignslop</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * First try an exact bno allocation.</span>
<span class="cm">			 * If it fails then do a near or start bno</span>
<span class="cm">			 * allocation with alignment turned on.</span>
<span class="cm">			 */</span>
			<span class="n">atype</span> <span class="o">=</span> <span class="n">args</span><span class="p">.</span><span class="n">type</span><span class="p">;</span>
			<span class="n">tryagain</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">args</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">XFS_ALLOCTYPE_THIS_BNO</span><span class="p">;</span>
			<span class="n">args</span><span class="p">.</span><span class="n">alignment</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="cm">/*</span>
<span class="cm">			 * Compute the minlen+alignment for the</span>
<span class="cm">			 * next case.  Set slop so that the value</span>
<span class="cm">			 * of minlen+alignment+slop doesn&#39;t go up</span>
<span class="cm">			 * between the calls.</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">blen</span> <span class="o">&gt;</span> <span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_dalign</span> <span class="o">&amp;&amp;</span> <span class="n">blen</span> <span class="o">&lt;=</span> <span class="n">args</span><span class="p">.</span><span class="n">maxlen</span><span class="p">)</span>
				<span class="n">nextminlen</span> <span class="o">=</span> <span class="n">blen</span> <span class="o">-</span> <span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_dalign</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">nextminlen</span> <span class="o">=</span> <span class="n">args</span><span class="p">.</span><span class="n">minlen</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">nextminlen</span> <span class="o">+</span> <span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_dalign</span> <span class="o">&gt;</span> <span class="n">args</span><span class="p">.</span><span class="n">minlen</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
				<span class="n">args</span><span class="p">.</span><span class="n">minalignslop</span> <span class="o">=</span>
					<span class="n">nextminlen</span> <span class="o">+</span> <span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_dalign</span> <span class="o">-</span>
					<span class="n">args</span><span class="p">.</span><span class="n">minlen</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">args</span><span class="p">.</span><span class="n">minalignslop</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">args</span><span class="p">.</span><span class="n">alignment</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">args</span><span class="p">.</span><span class="n">minalignslop</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">args</span><span class="p">.</span><span class="n">minleft</span> <span class="o">=</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">minleft</span><span class="p">;</span>
	<span class="n">args</span><span class="p">.</span><span class="n">wasdel</span> <span class="o">=</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">wasdel</span><span class="p">;</span>
	<span class="n">args</span><span class="p">.</span><span class="n">isfl</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">args</span><span class="p">.</span><span class="n">userdata</span> <span class="o">=</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">userdata</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">error</span> <span class="o">=</span> <span class="n">xfs_alloc_vextent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">args</span><span class="p">)))</span>
		<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tryagain</span> <span class="o">&amp;&amp;</span> <span class="n">args</span><span class="p">.</span><span class="n">fsbno</span> <span class="o">==</span> <span class="n">NULLFSBLOCK</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Exact allocation failed. Now try with alignment</span>
<span class="cm">		 * turned on.</span>
<span class="cm">		 */</span>
		<span class="n">args</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">atype</span><span class="p">;</span>
		<span class="n">args</span><span class="p">.</span><span class="n">fsbno</span> <span class="o">=</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">blkno</span><span class="p">;</span>
		<span class="n">args</span><span class="p">.</span><span class="n">alignment</span> <span class="o">=</span> <span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_dalign</span><span class="p">;</span>
		<span class="n">args</span><span class="p">.</span><span class="n">minlen</span> <span class="o">=</span> <span class="n">nextminlen</span><span class="p">;</span>
		<span class="n">args</span><span class="p">.</span><span class="n">minalignslop</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">isaligned</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">error</span> <span class="o">=</span> <span class="n">xfs_alloc_vextent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">args</span><span class="p">)))</span>
			<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">isaligned</span> <span class="o">&amp;&amp;</span> <span class="n">args</span><span class="p">.</span><span class="n">fsbno</span> <span class="o">==</span> <span class="n">NULLFSBLOCK</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * allocation failed, so turn off alignment and</span>
<span class="cm">		 * try again.</span>
<span class="cm">		 */</span>
		<span class="n">args</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">atype</span><span class="p">;</span>
		<span class="n">args</span><span class="p">.</span><span class="n">fsbno</span> <span class="o">=</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">blkno</span><span class="p">;</span>
		<span class="n">args</span><span class="p">.</span><span class="n">alignment</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">error</span> <span class="o">=</span> <span class="n">xfs_alloc_vextent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">args</span><span class="p">)))</span>
			<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">args</span><span class="p">.</span><span class="n">fsbno</span> <span class="o">==</span> <span class="n">NULLFSBLOCK</span> <span class="o">&amp;&amp;</span> <span class="n">nullfb</span> <span class="o">&amp;&amp;</span>
	    <span class="n">args</span><span class="p">.</span><span class="n">minlen</span> <span class="o">&gt;</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">minlen</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">args</span><span class="p">.</span><span class="n">minlen</span> <span class="o">=</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">minlen</span><span class="p">;</span>
		<span class="n">args</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">XFS_ALLOCTYPE_START_BNO</span><span class="p">;</span>
		<span class="n">args</span><span class="p">.</span><span class="n">fsbno</span> <span class="o">=</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">blkno</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">error</span> <span class="o">=</span> <span class="n">xfs_alloc_vextent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">args</span><span class="p">)))</span>
			<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">args</span><span class="p">.</span><span class="n">fsbno</span> <span class="o">==</span> <span class="n">NULLFSBLOCK</span> <span class="o">&amp;&amp;</span> <span class="n">nullfb</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">args</span><span class="p">.</span><span class="n">fsbno</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">args</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">XFS_ALLOCTYPE_FIRST_AG</span><span class="p">;</span>
		<span class="n">args</span><span class="p">.</span><span class="n">total</span> <span class="o">=</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">minlen</span><span class="p">;</span>
		<span class="n">args</span><span class="p">.</span><span class="n">minleft</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">error</span> <span class="o">=</span> <span class="n">xfs_alloc_vextent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">args</span><span class="p">)))</span>
			<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
		<span class="n">ap</span><span class="o">-&gt;</span><span class="n">flist</span><span class="o">-&gt;</span><span class="n">xbf_low</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">args</span><span class="p">.</span><span class="n">fsbno</span> <span class="o">!=</span> <span class="n">NULLFSBLOCK</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * check the allocation happened at the same or higher AG than</span>
<span class="cm">		 * the first block that was allocated.</span>
<span class="cm">		 */</span>
		<span class="n">ASSERT</span><span class="p">(</span><span class="o">*</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">firstblock</span> <span class="o">==</span> <span class="n">NULLFSBLOCK</span> <span class="o">||</span>
		       <span class="n">XFS_FSB_TO_AGNO</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="o">*</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">firstblock</span><span class="p">)</span> <span class="o">==</span>
		       <span class="n">XFS_FSB_TO_AGNO</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="n">args</span><span class="p">.</span><span class="n">fsbno</span><span class="p">)</span> <span class="o">||</span>
		       <span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">flist</span><span class="o">-&gt;</span><span class="n">xbf_low</span> <span class="o">&amp;&amp;</span>
			<span class="n">XFS_FSB_TO_AGNO</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="o">*</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">firstblock</span><span class="p">)</span> <span class="o">&lt;</span>
			<span class="n">XFS_FSB_TO_AGNO</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="n">args</span><span class="p">.</span><span class="n">fsbno</span><span class="p">)));</span>

		<span class="n">ap</span><span class="o">-&gt;</span><span class="n">blkno</span> <span class="o">=</span> <span class="n">args</span><span class="p">.</span><span class="n">fsbno</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">firstblock</span> <span class="o">==</span> <span class="n">NULLFSBLOCK</span><span class="p">)</span>
			<span class="o">*</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">firstblock</span> <span class="o">=</span> <span class="n">args</span><span class="p">.</span><span class="n">fsbno</span><span class="p">;</span>
		<span class="n">ASSERT</span><span class="p">(</span><span class="n">nullfb</span> <span class="o">||</span> <span class="n">fb_agno</span> <span class="o">==</span> <span class="n">args</span><span class="p">.</span><span class="n">agno</span> <span class="o">||</span>
		       <span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">flist</span><span class="o">-&gt;</span><span class="n">xbf_low</span> <span class="o">&amp;&amp;</span> <span class="n">fb_agno</span> <span class="o">&lt;</span> <span class="n">args</span><span class="p">.</span><span class="n">agno</span><span class="p">));</span>
		<span class="n">ap</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">=</span> <span class="n">args</span><span class="p">.</span><span class="n">len</span><span class="p">;</span>
		<span class="n">ap</span><span class="o">-&gt;</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_d</span><span class="p">.</span><span class="n">di_nblocks</span> <span class="o">+=</span> <span class="n">args</span><span class="p">.</span><span class="n">len</span><span class="p">;</span>
		<span class="n">xfs_trans_log_inode</span><span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">tp</span><span class="p">,</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">ip</span><span class="p">,</span> <span class="n">XFS_ILOG_CORE</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">wasdel</span><span class="p">)</span>
			<span class="n">ap</span><span class="o">-&gt;</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_delayed_blks</span> <span class="o">-=</span> <span class="n">args</span><span class="p">.</span><span class="n">len</span><span class="p">;</span>
		<span class="cm">/*</span>
<span class="cm">		 * Adjust the disk quota also. This was reserved</span>
<span class="cm">		 * earlier.</span>
<span class="cm">		 */</span>
		<span class="n">xfs_trans_mod_dquot_byino</span><span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">tp</span><span class="p">,</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">ip</span><span class="p">,</span>
			<span class="n">ap</span><span class="o">-&gt;</span><span class="n">wasdel</span> <span class="o">?</span> <span class="n">XFS_TRANS_DQ_DELBCOUNT</span> <span class="o">:</span>
					<span class="n">XFS_TRANS_DQ_BCOUNT</span><span class="p">,</span>
			<span class="p">(</span><span class="kt">long</span><span class="p">)</span> <span class="n">args</span><span class="p">.</span><span class="n">len</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ap</span><span class="o">-&gt;</span><span class="n">blkno</span> <span class="o">=</span> <span class="n">NULLFSBLOCK</span><span class="p">;</span>
		<span class="n">ap</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * xfs_bmap_alloc is called by xfs_bmapi to allocate an extent for a file.</span>
<span class="cm"> * It figures out where to ask the underlying allocator to put the new extent.</span>
<span class="cm"> */</span>
<span class="n">STATIC</span> <span class="kt">int</span>
<span class="n">xfs_bmap_alloc</span><span class="p">(</span>
	<span class="n">xfs_bmalloca_t</span>	<span class="o">*</span><span class="n">ap</span><span class="p">)</span>		<span class="cm">/* bmap alloc argument struct */</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">XFS_IS_REALTIME_INODE</span><span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">ip</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">userdata</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">xfs_bmap_rtalloc</span><span class="p">(</span><span class="n">ap</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">xfs_bmap_btalloc</span><span class="p">(</span><span class="n">ap</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Transform a btree format file with only one leaf node, where the</span>
<span class="cm"> * extents list will fit in the inode, into an extents format file.</span>
<span class="cm"> * Since the file extents are already in-core, all we have to do is</span>
<span class="cm"> * give up the space for the btree root and pitch the leaf block.</span>
<span class="cm"> */</span>
<span class="n">STATIC</span> <span class="kt">int</span>				<span class="cm">/* error */</span>
<span class="n">xfs_bmap_btree_to_extents</span><span class="p">(</span>
	<span class="n">xfs_trans_t</span>		<span class="o">*</span><span class="n">tp</span><span class="p">,</span>	<span class="cm">/* transaction pointer */</span>
	<span class="n">xfs_inode_t</span>		<span class="o">*</span><span class="n">ip</span><span class="p">,</span>	<span class="cm">/* incore inode pointer */</span>
	<span class="n">xfs_btree_cur_t</span>		<span class="o">*</span><span class="n">cur</span><span class="p">,</span>	<span class="cm">/* btree cursor */</span>
	<span class="kt">int</span>			<span class="o">*</span><span class="n">logflagsp</span><span class="p">,</span> <span class="cm">/* inode logging flags */</span>
	<span class="kt">int</span>			<span class="n">whichfork</span><span class="p">)</span>  <span class="cm">/* data or attr fork */</span>
<span class="p">{</span>
	<span class="cm">/* REFERENCED */</span>
	<span class="k">struct</span> <span class="n">xfs_btree_block</span>	<span class="o">*</span><span class="n">cblock</span><span class="p">;</span><span class="cm">/* child btree block */</span>
	<span class="n">xfs_fsblock_t</span>		<span class="n">cbno</span><span class="p">;</span>	<span class="cm">/* child block number */</span>
	<span class="n">xfs_buf_t</span>		<span class="o">*</span><span class="n">cbp</span><span class="p">;</span>	<span class="cm">/* child block&#39;s buffer */</span>
	<span class="kt">int</span>			<span class="n">error</span><span class="p">;</span>	<span class="cm">/* error return value */</span>
	<span class="n">xfs_ifork_t</span>		<span class="o">*</span><span class="n">ifp</span><span class="p">;</span>	<span class="cm">/* inode fork data */</span>
	<span class="n">xfs_mount_t</span>		<span class="o">*</span><span class="n">mp</span><span class="p">;</span>	<span class="cm">/* mount point structure */</span>
	<span class="n">__be64</span>			<span class="o">*</span><span class="n">pp</span><span class="p">;</span>	<span class="cm">/* ptr to block address */</span>
	<span class="k">struct</span> <span class="n">xfs_btree_block</span>	<span class="o">*</span><span class="n">rblock</span><span class="p">;</span><span class="cm">/* root btree block */</span>

	<span class="n">mp</span> <span class="o">=</span> <span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_mount</span><span class="p">;</span>
	<span class="n">ifp</span> <span class="o">=</span> <span class="n">XFS_IFORK_PTR</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">whichfork</span><span class="p">);</span>
	<span class="n">ASSERT</span><span class="p">(</span><span class="n">ifp</span><span class="o">-&gt;</span><span class="n">if_flags</span> <span class="o">&amp;</span> <span class="n">XFS_IFEXTENTS</span><span class="p">);</span>
	<span class="n">ASSERT</span><span class="p">(</span><span class="n">XFS_IFORK_FORMAT</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">whichfork</span><span class="p">)</span> <span class="o">==</span> <span class="n">XFS_DINODE_FMT_BTREE</span><span class="p">);</span>
	<span class="n">rblock</span> <span class="o">=</span> <span class="n">ifp</span><span class="o">-&gt;</span><span class="n">if_broot</span><span class="p">;</span>
	<span class="n">ASSERT</span><span class="p">(</span><span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">rblock</span><span class="o">-&gt;</span><span class="n">bb_level</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">ASSERT</span><span class="p">(</span><span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">rblock</span><span class="o">-&gt;</span><span class="n">bb_numrecs</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">ASSERT</span><span class="p">(</span><span class="n">xfs_bmbt_maxrecs</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="n">ifp</span><span class="o">-&gt;</span><span class="n">if_broot_bytes</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">pp</span> <span class="o">=</span> <span class="n">XFS_BMAP_BROOT_PTR_ADDR</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="n">rblock</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ifp</span><span class="o">-&gt;</span><span class="n">if_broot_bytes</span><span class="p">);</span>
	<span class="n">cbno</span> <span class="o">=</span> <span class="n">be64_to_cpu</span><span class="p">(</span><span class="o">*</span><span class="n">pp</span><span class="p">);</span>
	<span class="o">*</span><span class="n">logflagsp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="cp">#ifdef DEBUG</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">error</span> <span class="o">=</span> <span class="n">xfs_btree_check_lptr</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">cbno</span><span class="p">,</span> <span class="mi">1</span><span class="p">)))</span>
		<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">error</span> <span class="o">=</span> <span class="n">xfs_btree_read_bufl</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="n">tp</span><span class="p">,</span> <span class="n">cbno</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cbp</span><span class="p">,</span>
			<span class="n">XFS_BMAP_BTREE_REF</span><span class="p">)))</span>
		<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">cblock</span> <span class="o">=</span> <span class="n">XFS_BUF_TO_BLOCK</span><span class="p">(</span><span class="n">cbp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">error</span> <span class="o">=</span> <span class="n">xfs_btree_check_block</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">cblock</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">cbp</span><span class="p">)))</span>
		<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">xfs_bmap_add_free</span><span class="p">(</span><span class="n">cbno</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">cur</span><span class="o">-&gt;</span><span class="n">bc_private</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">flist</span><span class="p">,</span> <span class="n">mp</span><span class="p">);</span>
	<span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_d</span><span class="p">.</span><span class="n">di_nblocks</span><span class="o">--</span><span class="p">;</span>
	<span class="n">xfs_trans_mod_dquot_byino</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">ip</span><span class="p">,</span> <span class="n">XFS_TRANS_DQ_BCOUNT</span><span class="p">,</span> <span class="o">-</span><span class="mi">1L</span><span class="p">);</span>
	<span class="n">xfs_trans_binval</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">cbp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">bc_bufs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">cbp</span><span class="p">)</span>
		<span class="n">cur</span><span class="o">-&gt;</span><span class="n">bc_bufs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">xfs_iroot_realloc</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">whichfork</span><span class="p">);</span>
	<span class="n">ASSERT</span><span class="p">(</span><span class="n">ifp</span><span class="o">-&gt;</span><span class="n">if_broot</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">ASSERT</span><span class="p">((</span><span class="n">ifp</span><span class="o">-&gt;</span><span class="n">if_flags</span> <span class="o">&amp;</span> <span class="n">XFS_IFBROOT</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">XFS_IFORK_FMT_SET</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">whichfork</span><span class="p">,</span> <span class="n">XFS_DINODE_FMT_EXTENTS</span><span class="p">);</span>
	<span class="o">*</span><span class="n">logflagsp</span> <span class="o">=</span> <span class="n">XFS_ILOG_CORE</span> <span class="o">|</span> <span class="n">xfs_ilog_fext</span><span class="p">(</span><span class="n">whichfork</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Called by xfs_bmapi to update file extent records and the btree</span>
<span class="cm"> * after removing space (or undoing a delayed allocation).</span>
<span class="cm"> */</span>
<span class="n">STATIC</span> <span class="kt">int</span>				<span class="cm">/* error */</span>
<span class="n">xfs_bmap_del_extent</span><span class="p">(</span>
	<span class="n">xfs_inode_t</span>		<span class="o">*</span><span class="n">ip</span><span class="p">,</span>	<span class="cm">/* incore inode pointer */</span>
	<span class="n">xfs_trans_t</span>		<span class="o">*</span><span class="n">tp</span><span class="p">,</span>	<span class="cm">/* current transaction pointer */</span>
	<span class="n">xfs_extnum_t</span>		<span class="o">*</span><span class="n">idx</span><span class="p">,</span>	<span class="cm">/* extent number to update/delete */</span>
	<span class="n">xfs_bmap_free_t</span>		<span class="o">*</span><span class="n">flist</span><span class="p">,</span>	<span class="cm">/* list of extents to be freed */</span>
	<span class="n">xfs_btree_cur_t</span>		<span class="o">*</span><span class="n">cur</span><span class="p">,</span>	<span class="cm">/* if null, not a btree */</span>
	<span class="n">xfs_bmbt_irec_t</span>		<span class="o">*</span><span class="n">del</span><span class="p">,</span>	<span class="cm">/* data to remove from extents */</span>
	<span class="kt">int</span>			<span class="o">*</span><span class="n">logflagsp</span><span class="p">,</span> <span class="cm">/* inode logging flags */</span>
	<span class="kt">int</span>			<span class="n">whichfork</span><span class="p">)</span> <span class="cm">/* data or attr fork */</span>
<span class="p">{</span>
	<span class="n">xfs_filblks_t</span>		<span class="n">da_new</span><span class="p">;</span>	<span class="cm">/* new delay-alloc indirect blocks */</span>
	<span class="n">xfs_filblks_t</span>		<span class="n">da_old</span><span class="p">;</span>	<span class="cm">/* old delay-alloc indirect blocks */</span>
	<span class="n">xfs_fsblock_t</span>		<span class="n">del_endblock</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>	<span class="cm">/* first block past del */</span>
	<span class="n">xfs_fileoff_t</span>		<span class="n">del_endoff</span><span class="p">;</span>	<span class="cm">/* first offset past del */</span>
	<span class="kt">int</span>			<span class="n">delay</span><span class="p">;</span>	<span class="cm">/* current block is delayed allocated */</span>
	<span class="kt">int</span>			<span class="n">do_fx</span><span class="p">;</span>	<span class="cm">/* free extent at end of routine */</span>
	<span class="n">xfs_bmbt_rec_host_t</span>	<span class="o">*</span><span class="n">ep</span><span class="p">;</span>	<span class="cm">/* current extent entry pointer */</span>
	<span class="kt">int</span>			<span class="n">error</span><span class="p">;</span>	<span class="cm">/* error return value */</span>
	<span class="kt">int</span>			<span class="n">flags</span><span class="p">;</span>	<span class="cm">/* inode logging flags */</span>
	<span class="n">xfs_bmbt_irec_t</span>		<span class="n">got</span><span class="p">;</span>	<span class="cm">/* current extent entry */</span>
	<span class="n">xfs_fileoff_t</span>		<span class="n">got_endoff</span><span class="p">;</span>	<span class="cm">/* first offset past got */</span>
	<span class="kt">int</span>			<span class="n">i</span><span class="p">;</span>	<span class="cm">/* temp state */</span>
	<span class="n">xfs_ifork_t</span>		<span class="o">*</span><span class="n">ifp</span><span class="p">;</span>	<span class="cm">/* inode fork pointer */</span>
	<span class="n">xfs_mount_t</span>		<span class="o">*</span><span class="n">mp</span><span class="p">;</span>	<span class="cm">/* mount structure */</span>
	<span class="n">xfs_filblks_t</span>		<span class="n">nblks</span><span class="p">;</span>	<span class="cm">/* quota/sb block count */</span>
	<span class="n">xfs_bmbt_irec_t</span>		<span class="n">new</span><span class="p">;</span>	<span class="cm">/* new record to be inserted */</span>
	<span class="cm">/* REFERENCED */</span>
	<span class="n">uint</span>			<span class="n">qfield</span><span class="p">;</span>	<span class="cm">/* quota field to update */</span>
	<span class="n">xfs_filblks_t</span>		<span class="n">temp</span><span class="p">;</span>	<span class="cm">/* for indirect length calculations */</span>
	<span class="n">xfs_filblks_t</span>		<span class="n">temp2</span><span class="p">;</span>	<span class="cm">/* for indirect length calculations */</span>
	<span class="kt">int</span>			<span class="n">state</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">XFS_STATS_INC</span><span class="p">(</span><span class="n">xs_del_exlist</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">whichfork</span> <span class="o">==</span> <span class="n">XFS_ATTR_FORK</span><span class="p">)</span>
		<span class="n">state</span> <span class="o">|=</span> <span class="n">BMAP_ATTRFORK</span><span class="p">;</span>

	<span class="n">mp</span> <span class="o">=</span> <span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_mount</span><span class="p">;</span>
	<span class="n">ifp</span> <span class="o">=</span> <span class="n">XFS_IFORK_PTR</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">whichfork</span><span class="p">);</span>
	<span class="n">ASSERT</span><span class="p">((</span><span class="o">*</span><span class="n">idx</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="o">*</span><span class="n">idx</span> <span class="o">&lt;</span> <span class="n">ifp</span><span class="o">-&gt;</span><span class="n">if_bytes</span> <span class="o">/</span>
		<span class="p">(</span><span class="n">uint</span><span class="p">)</span><span class="k">sizeof</span><span class="p">(</span><span class="n">xfs_bmbt_rec_t</span><span class="p">)));</span>
	<span class="n">ASSERT</span><span class="p">(</span><span class="n">del</span><span class="o">-&gt;</span><span class="n">br_blockcount</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">ep</span> <span class="o">=</span> <span class="n">xfs_iext_get_ext</span><span class="p">(</span><span class="n">ifp</span><span class="p">,</span> <span class="o">*</span><span class="n">idx</span><span class="p">);</span>
	<span class="n">xfs_bmbt_get_all</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">got</span><span class="p">);</span>
	<span class="n">ASSERT</span><span class="p">(</span><span class="n">got</span><span class="p">.</span><span class="n">br_startoff</span> <span class="o">&lt;=</span> <span class="n">del</span><span class="o">-&gt;</span><span class="n">br_startoff</span><span class="p">);</span>
	<span class="n">del_endoff</span> <span class="o">=</span> <span class="n">del</span><span class="o">-&gt;</span><span class="n">br_startoff</span> <span class="o">+</span> <span class="n">del</span><span class="o">-&gt;</span><span class="n">br_blockcount</span><span class="p">;</span>
	<span class="n">got_endoff</span> <span class="o">=</span> <span class="n">got</span><span class="p">.</span><span class="n">br_startoff</span> <span class="o">+</span> <span class="n">got</span><span class="p">.</span><span class="n">br_blockcount</span><span class="p">;</span>
	<span class="n">ASSERT</span><span class="p">(</span><span class="n">got_endoff</span> <span class="o">&gt;=</span> <span class="n">del_endoff</span><span class="p">);</span>
	<span class="n">delay</span> <span class="o">=</span> <span class="n">isnullstartblock</span><span class="p">(</span><span class="n">got</span><span class="p">.</span><span class="n">br_startblock</span><span class="p">);</span>
	<span class="n">ASSERT</span><span class="p">(</span><span class="n">isnullstartblock</span><span class="p">(</span><span class="n">del</span><span class="o">-&gt;</span><span class="n">br_startblock</span><span class="p">)</span> <span class="o">==</span> <span class="n">delay</span><span class="p">);</span>
	<span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">qfield</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">error</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * If deleting a real allocation, must free up the disk space.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">delay</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">flags</span> <span class="o">=</span> <span class="n">XFS_ILOG_CORE</span><span class="p">;</span>
		<span class="cm">/*</span>
<span class="cm">		 * Realtime allocation.  Free it and record di_nblocks update.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">whichfork</span> <span class="o">==</span> <span class="n">XFS_DATA_FORK</span> <span class="o">&amp;&amp;</span> <span class="n">XFS_IS_REALTIME_INODE</span><span class="p">(</span><span class="n">ip</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">xfs_fsblock_t</span>	<span class="n">bno</span><span class="p">;</span>
			<span class="n">xfs_filblks_t</span>	<span class="n">len</span><span class="p">;</span>

			<span class="n">ASSERT</span><span class="p">(</span><span class="n">do_mod</span><span class="p">(</span><span class="n">del</span><span class="o">-&gt;</span><span class="n">br_blockcount</span><span class="p">,</span>
				      <span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_sb</span><span class="p">.</span><span class="n">sb_rextsize</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">ASSERT</span><span class="p">(</span><span class="n">do_mod</span><span class="p">(</span><span class="n">del</span><span class="o">-&gt;</span><span class="n">br_startblock</span><span class="p">,</span>
				      <span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_sb</span><span class="p">.</span><span class="n">sb_rextsize</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">bno</span> <span class="o">=</span> <span class="n">del</span><span class="o">-&gt;</span><span class="n">br_startblock</span><span class="p">;</span>
			<span class="n">len</span> <span class="o">=</span> <span class="n">del</span><span class="o">-&gt;</span><span class="n">br_blockcount</span><span class="p">;</span>
			<span class="n">do_div</span><span class="p">(</span><span class="n">bno</span><span class="p">,</span> <span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_sb</span><span class="p">.</span><span class="n">sb_rextsize</span><span class="p">);</span>
			<span class="n">do_div</span><span class="p">(</span><span class="n">len</span><span class="p">,</span> <span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_sb</span><span class="p">.</span><span class="n">sb_rextsize</span><span class="p">);</span>
			<span class="n">error</span> <span class="o">=</span> <span class="n">xfs_rtfree_extent</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">bno</span><span class="p">,</span> <span class="p">(</span><span class="n">xfs_extlen_t</span><span class="p">)</span><span class="n">len</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
			<span class="n">do_fx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">nblks</span> <span class="o">=</span> <span class="n">len</span> <span class="o">*</span> <span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_sb</span><span class="p">.</span><span class="n">sb_rextsize</span><span class="p">;</span>
			<span class="n">qfield</span> <span class="o">=</span> <span class="n">XFS_TRANS_DQ_RTBCOUNT</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/*</span>
<span class="cm">		 * Ordinary allocation.</span>
<span class="cm">		 */</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="n">do_fx</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">nblks</span> <span class="o">=</span> <span class="n">del</span><span class="o">-&gt;</span><span class="n">br_blockcount</span><span class="p">;</span>
			<span class="n">qfield</span> <span class="o">=</span> <span class="n">XFS_TRANS_DQ_BCOUNT</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/*</span>
<span class="cm">		 * Set up del_endblock and cur for later.</span>
<span class="cm">		 */</span>
		<span class="n">del_endblock</span> <span class="o">=</span> <span class="n">del</span><span class="o">-&gt;</span><span class="n">br_startblock</span> <span class="o">+</span> <span class="n">del</span><span class="o">-&gt;</span><span class="n">br_blockcount</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cur</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">error</span> <span class="o">=</span> <span class="n">xfs_bmbt_lookup_eq</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">got</span><span class="p">.</span><span class="n">br_startoff</span><span class="p">,</span>
					<span class="n">got</span><span class="p">.</span><span class="n">br_startblock</span><span class="p">,</span> <span class="n">got</span><span class="p">.</span><span class="n">br_blockcount</span><span class="p">,</span>
					<span class="o">&amp;</span><span class="n">i</span><span class="p">)))</span>
				<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
			<span class="n">XFS_WANT_CORRUPTED_GOTO</span><span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="n">done</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">da_old</span> <span class="o">=</span> <span class="n">da_new</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">da_old</span> <span class="o">=</span> <span class="n">startblockval</span><span class="p">(</span><span class="n">got</span><span class="p">.</span><span class="n">br_startblock</span><span class="p">);</span>
		<span class="n">da_new</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">nblks</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">do_fx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/*</span>
<span class="cm">	 * Set flag value to use in switch statement.</span>
<span class="cm">	 * Left-contig is 2, right-contig is 1.</span>
<span class="cm">	 */</span>
	<span class="k">switch</span> <span class="p">(((</span><span class="n">got</span><span class="p">.</span><span class="n">br_startoff</span> <span class="o">==</span> <span class="n">del</span><span class="o">-&gt;</span><span class="n">br_startoff</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">|</span>
		<span class="p">(</span><span class="n">got_endoff</span> <span class="o">==</span> <span class="n">del_endoff</span><span class="p">))</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">3</span>:
		<span class="cm">/*</span>
<span class="cm">		 * Matches the whole extent.  Delete the entry.</span>
<span class="cm">		 */</span>
		<span class="n">xfs_iext_remove</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="o">*</span><span class="n">idx</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
				<span class="n">whichfork</span> <span class="o">==</span> <span class="n">XFS_ATTR_FORK</span> <span class="o">?</span> <span class="n">BMAP_ATTRFORK</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
		<span class="o">--*</span><span class="n">idx</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">delay</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">XFS_IFORK_NEXT_SET</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">whichfork</span><span class="p">,</span>
			<span class="n">XFS_IFORK_NEXTENTS</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">whichfork</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">flags</span> <span class="o">|=</span> <span class="n">XFS_ILOG_CORE</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cur</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">flags</span> <span class="o">|=</span> <span class="n">xfs_ilog_fext</span><span class="p">(</span><span class="n">whichfork</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">error</span> <span class="o">=</span> <span class="n">xfs_btree_delete</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">i</span><span class="p">)))</span>
			<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
		<span class="n">XFS_WANT_CORRUPTED_GOTO</span><span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="n">done</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="mi">2</span>:
		<span class="cm">/*</span>
<span class="cm">		 * Deleting the first part of the extent.</span>
<span class="cm">		 */</span>
		<span class="n">trace_xfs_bmap_pre_update</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="o">*</span><span class="n">idx</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">_THIS_IP_</span><span class="p">);</span>
		<span class="n">xfs_bmbt_set_startoff</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="n">del_endoff</span><span class="p">);</span>
		<span class="n">temp</span> <span class="o">=</span> <span class="n">got</span><span class="p">.</span><span class="n">br_blockcount</span> <span class="o">-</span> <span class="n">del</span><span class="o">-&gt;</span><span class="n">br_blockcount</span><span class="p">;</span>
		<span class="n">xfs_bmbt_set_blockcount</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="n">temp</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">delay</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">temp</span> <span class="o">=</span> <span class="n">XFS_FILBLKS_MIN</span><span class="p">(</span><span class="n">xfs_bmap_worst_indlen</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">temp</span><span class="p">),</span>
				<span class="n">da_old</span><span class="p">);</span>
			<span class="n">xfs_bmbt_set_startblock</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="n">nullstartblock</span><span class="p">((</span><span class="kt">int</span><span class="p">)</span><span class="n">temp</span><span class="p">));</span>
			<span class="n">trace_xfs_bmap_post_update</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="o">*</span><span class="n">idx</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">_THIS_IP_</span><span class="p">);</span>
			<span class="n">da_new</span> <span class="o">=</span> <span class="n">temp</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">xfs_bmbt_set_startblock</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="n">del_endblock</span><span class="p">);</span>
		<span class="n">trace_xfs_bmap_post_update</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="o">*</span><span class="n">idx</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">_THIS_IP_</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cur</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">flags</span> <span class="o">|=</span> <span class="n">xfs_ilog_fext</span><span class="p">(</span><span class="n">whichfork</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">error</span> <span class="o">=</span> <span class="n">xfs_bmbt_update</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">del_endoff</span><span class="p">,</span> <span class="n">del_endblock</span><span class="p">,</span>
				<span class="n">got</span><span class="p">.</span><span class="n">br_blockcount</span> <span class="o">-</span> <span class="n">del</span><span class="o">-&gt;</span><span class="n">br_blockcount</span><span class="p">,</span>
				<span class="n">got</span><span class="p">.</span><span class="n">br_state</span><span class="p">)))</span>
			<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="mi">1</span>:
		<span class="cm">/*</span>
<span class="cm">		 * Deleting the last part of the extent.</span>
<span class="cm">		 */</span>
		<span class="n">temp</span> <span class="o">=</span> <span class="n">got</span><span class="p">.</span><span class="n">br_blockcount</span> <span class="o">-</span> <span class="n">del</span><span class="o">-&gt;</span><span class="n">br_blockcount</span><span class="p">;</span>
		<span class="n">trace_xfs_bmap_pre_update</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="o">*</span><span class="n">idx</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">_THIS_IP_</span><span class="p">);</span>
		<span class="n">xfs_bmbt_set_blockcount</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="n">temp</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">delay</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">temp</span> <span class="o">=</span> <span class="n">XFS_FILBLKS_MIN</span><span class="p">(</span><span class="n">xfs_bmap_worst_indlen</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">temp</span><span class="p">),</span>
				<span class="n">da_old</span><span class="p">);</span>
			<span class="n">xfs_bmbt_set_startblock</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="n">nullstartblock</span><span class="p">((</span><span class="kt">int</span><span class="p">)</span><span class="n">temp</span><span class="p">));</span>
			<span class="n">trace_xfs_bmap_post_update</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="o">*</span><span class="n">idx</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">_THIS_IP_</span><span class="p">);</span>
			<span class="n">da_new</span> <span class="o">=</span> <span class="n">temp</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">trace_xfs_bmap_post_update</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="o">*</span><span class="n">idx</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">_THIS_IP_</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cur</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">flags</span> <span class="o">|=</span> <span class="n">xfs_ilog_fext</span><span class="p">(</span><span class="n">whichfork</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">error</span> <span class="o">=</span> <span class="n">xfs_bmbt_update</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">got</span><span class="p">.</span><span class="n">br_startoff</span><span class="p">,</span>
				<span class="n">got</span><span class="p">.</span><span class="n">br_startblock</span><span class="p">,</span>
				<span class="n">got</span><span class="p">.</span><span class="n">br_blockcount</span> <span class="o">-</span> <span class="n">del</span><span class="o">-&gt;</span><span class="n">br_blockcount</span><span class="p">,</span>
				<span class="n">got</span><span class="p">.</span><span class="n">br_state</span><span class="p">)))</span>
			<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="mi">0</span>:
		<span class="cm">/*</span>
<span class="cm">		 * Deleting the middle of the extent.</span>
<span class="cm">		 */</span>
		<span class="n">temp</span> <span class="o">=</span> <span class="n">del</span><span class="o">-&gt;</span><span class="n">br_startoff</span> <span class="o">-</span> <span class="n">got</span><span class="p">.</span><span class="n">br_startoff</span><span class="p">;</span>
		<span class="n">trace_xfs_bmap_pre_update</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="o">*</span><span class="n">idx</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">_THIS_IP_</span><span class="p">);</span>
		<span class="n">xfs_bmbt_set_blockcount</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="n">temp</span><span class="p">);</span>
		<span class="n">new</span><span class="p">.</span><span class="n">br_startoff</span> <span class="o">=</span> <span class="n">del_endoff</span><span class="p">;</span>
		<span class="n">temp2</span> <span class="o">=</span> <span class="n">got_endoff</span> <span class="o">-</span> <span class="n">del_endoff</span><span class="p">;</span>
		<span class="n">new</span><span class="p">.</span><span class="n">br_blockcount</span> <span class="o">=</span> <span class="n">temp2</span><span class="p">;</span>
		<span class="n">new</span><span class="p">.</span><span class="n">br_state</span> <span class="o">=</span> <span class="n">got</span><span class="p">.</span><span class="n">br_state</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">delay</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">new</span><span class="p">.</span><span class="n">br_startblock</span> <span class="o">=</span> <span class="n">del_endblock</span><span class="p">;</span>
			<span class="n">flags</span> <span class="o">|=</span> <span class="n">XFS_ILOG_CORE</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">cur</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">((</span><span class="n">error</span> <span class="o">=</span> <span class="n">xfs_bmbt_update</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span>
						<span class="n">got</span><span class="p">.</span><span class="n">br_startoff</span><span class="p">,</span>
						<span class="n">got</span><span class="p">.</span><span class="n">br_startblock</span><span class="p">,</span> <span class="n">temp</span><span class="p">,</span>
						<span class="n">got</span><span class="p">.</span><span class="n">br_state</span><span class="p">)))</span>
					<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">((</span><span class="n">error</span> <span class="o">=</span> <span class="n">xfs_btree_increment</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">i</span><span class="p">)))</span>
					<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
				<span class="n">cur</span><span class="o">-&gt;</span><span class="n">bc_rec</span><span class="p">.</span><span class="n">b</span> <span class="o">=</span> <span class="n">new</span><span class="p">;</span>
				<span class="n">error</span> <span class="o">=</span> <span class="n">xfs_btree_insert</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">i</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">error</span> <span class="o">&amp;&amp;</span> <span class="n">error</span> <span class="o">!=</span> <span class="n">ENOSPC</span><span class="p">)</span>
					<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
				<span class="cm">/*</span>
<span class="cm">				 * If get no-space back from btree insert,</span>
<span class="cm">				 * it tried a split, and we have a zero</span>
<span class="cm">				 * block reservation.</span>
<span class="cm">				 * Fix up our state and return the error.</span>
<span class="cm">				 */</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">error</span> <span class="o">==</span> <span class="n">ENOSPC</span><span class="p">)</span> <span class="p">{</span>
					<span class="cm">/*</span>
<span class="cm">					 * Reset the cursor, don&#39;t trust</span>
<span class="cm">					 * it after any insert operation.</span>
<span class="cm">					 */</span>
					<span class="k">if</span> <span class="p">((</span><span class="n">error</span> <span class="o">=</span> <span class="n">xfs_bmbt_lookup_eq</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span>
							<span class="n">got</span><span class="p">.</span><span class="n">br_startoff</span><span class="p">,</span>
							<span class="n">got</span><span class="p">.</span><span class="n">br_startblock</span><span class="p">,</span>
							<span class="n">temp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">i</span><span class="p">)))</span>
						<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
					<span class="n">XFS_WANT_CORRUPTED_GOTO</span><span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="n">done</span><span class="p">);</span>
					<span class="cm">/*</span>
<span class="cm">					 * Update the btree record back</span>
<span class="cm">					 * to the original value.</span>
<span class="cm">					 */</span>
					<span class="k">if</span> <span class="p">((</span><span class="n">error</span> <span class="o">=</span> <span class="n">xfs_bmbt_update</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span>
							<span class="n">got</span><span class="p">.</span><span class="n">br_startoff</span><span class="p">,</span>
							<span class="n">got</span><span class="p">.</span><span class="n">br_startblock</span><span class="p">,</span>
							<span class="n">got</span><span class="p">.</span><span class="n">br_blockcount</span><span class="p">,</span>
							<span class="n">got</span><span class="p">.</span><span class="n">br_state</span><span class="p">)))</span>
						<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
					<span class="cm">/*</span>
<span class="cm">					 * Reset the extent record back</span>
<span class="cm">					 * to the original value.</span>
<span class="cm">					 */</span>
					<span class="n">xfs_bmbt_set_blockcount</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span>
						<span class="n">got</span><span class="p">.</span><span class="n">br_blockcount</span><span class="p">);</span>
					<span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
					<span class="n">error</span> <span class="o">=</span> <span class="n">XFS_ERROR</span><span class="p">(</span><span class="n">ENOSPC</span><span class="p">);</span>
					<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="n">XFS_WANT_CORRUPTED_GOTO</span><span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="n">done</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span>
				<span class="n">flags</span> <span class="o">|=</span> <span class="n">xfs_ilog_fext</span><span class="p">(</span><span class="n">whichfork</span><span class="p">);</span>
			<span class="n">XFS_IFORK_NEXT_SET</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">whichfork</span><span class="p">,</span>
				<span class="n">XFS_IFORK_NEXTENTS</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">whichfork</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">ASSERT</span><span class="p">(</span><span class="n">whichfork</span> <span class="o">==</span> <span class="n">XFS_DATA_FORK</span><span class="p">);</span>
			<span class="n">temp</span> <span class="o">=</span> <span class="n">xfs_bmap_worst_indlen</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">temp</span><span class="p">);</span>
			<span class="n">xfs_bmbt_set_startblock</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="n">nullstartblock</span><span class="p">((</span><span class="kt">int</span><span class="p">)</span><span class="n">temp</span><span class="p">));</span>
			<span class="n">temp2</span> <span class="o">=</span> <span class="n">xfs_bmap_worst_indlen</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">temp2</span><span class="p">);</span>
			<span class="n">new</span><span class="p">.</span><span class="n">br_startblock</span> <span class="o">=</span> <span class="n">nullstartblock</span><span class="p">((</span><span class="kt">int</span><span class="p">)</span><span class="n">temp2</span><span class="p">);</span>
			<span class="n">da_new</span> <span class="o">=</span> <span class="n">temp</span> <span class="o">+</span> <span class="n">temp2</span><span class="p">;</span>
			<span class="k">while</span> <span class="p">(</span><span class="n">da_new</span> <span class="o">&gt;</span> <span class="n">da_old</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">temp</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">temp</span><span class="o">--</span><span class="p">;</span>
					<span class="n">da_new</span><span class="o">--</span><span class="p">;</span>
					<span class="n">xfs_bmbt_set_startblock</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span>
						<span class="n">nullstartblock</span><span class="p">((</span><span class="kt">int</span><span class="p">)</span><span class="n">temp</span><span class="p">));</span>
				<span class="p">}</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">da_new</span> <span class="o">==</span> <span class="n">da_old</span><span class="p">)</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">temp2</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">temp2</span><span class="o">--</span><span class="p">;</span>
					<span class="n">da_new</span><span class="o">--</span><span class="p">;</span>
					<span class="n">new</span><span class="p">.</span><span class="n">br_startblock</span> <span class="o">=</span>
						<span class="n">nullstartblock</span><span class="p">((</span><span class="kt">int</span><span class="p">)</span><span class="n">temp2</span><span class="p">);</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">trace_xfs_bmap_post_update</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="o">*</span><span class="n">idx</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">_THIS_IP_</span><span class="p">);</span>
		<span class="n">xfs_iext_insert</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="o">*</span><span class="n">idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">new</span><span class="p">,</span> <span class="n">state</span><span class="p">);</span>
		<span class="o">++*</span><span class="n">idx</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/*</span>
<span class="cm">	 * If we need to, add to list of extents to delete.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">do_fx</span><span class="p">)</span>
		<span class="n">xfs_bmap_add_free</span><span class="p">(</span><span class="n">del</span><span class="o">-&gt;</span><span class="n">br_startblock</span><span class="p">,</span> <span class="n">del</span><span class="o">-&gt;</span><span class="n">br_blockcount</span><span class="p">,</span> <span class="n">flist</span><span class="p">,</span>
			<span class="n">mp</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 * Adjust inode # blocks in the file.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nblks</span><span class="p">)</span>
		<span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_d</span><span class="p">.</span><span class="n">di_nblocks</span> <span class="o">-=</span> <span class="n">nblks</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * Adjust quota data.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">qfield</span><span class="p">)</span>
		<span class="n">xfs_trans_mod_dquot_byino</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">ip</span><span class="p">,</span> <span class="n">qfield</span><span class="p">,</span> <span class="p">(</span><span class="kt">long</span><span class="p">)</span><span class="o">-</span><span class="n">nblks</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Account for change in delayed indirect blocks.</span>
<span class="cm">	 * Nothing to do for disk quota accounting here.</span>
<span class="cm">	 */</span>
	<span class="n">ASSERT</span><span class="p">(</span><span class="n">da_old</span> <span class="o">&gt;=</span> <span class="n">da_new</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">da_old</span> <span class="o">&gt;</span> <span class="n">da_new</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">xfs_icsb_modify_counters</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="n">XFS_SBS_FDBLOCKS</span><span class="p">,</span>
			<span class="p">(</span><span class="kt">int64_t</span><span class="p">)(</span><span class="n">da_old</span> <span class="o">-</span> <span class="n">da_new</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>
<span class="nl">done:</span>
	<span class="o">*</span><span class="n">logflagsp</span> <span class="o">=</span> <span class="n">flags</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Remove the entry &quot;free&quot; from the free item list.  Prev points to the</span>
<span class="cm"> * previous entry, unless &quot;free&quot; is the head of the list.</span>
<span class="cm"> */</span>
<span class="n">STATIC</span> <span class="kt">void</span>
<span class="n">xfs_bmap_del_free</span><span class="p">(</span>
	<span class="n">xfs_bmap_free_t</span>		<span class="o">*</span><span class="n">flist</span><span class="p">,</span>	<span class="cm">/* free item list header */</span>
	<span class="n">xfs_bmap_free_item_t</span>	<span class="o">*</span><span class="n">prev</span><span class="p">,</span>	<span class="cm">/* previous item on list, if any */</span>
	<span class="n">xfs_bmap_free_item_t</span>	<span class="o">*</span><span class="n">free</span><span class="p">)</span>	<span class="cm">/* list item to be freed */</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">prev</span><span class="p">)</span>
		<span class="n">prev</span><span class="o">-&gt;</span><span class="n">xbfi_next</span> <span class="o">=</span> <span class="n">free</span><span class="o">-&gt;</span><span class="n">xbfi_next</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">flist</span><span class="o">-&gt;</span><span class="n">xbf_first</span> <span class="o">=</span> <span class="n">free</span><span class="o">-&gt;</span><span class="n">xbfi_next</span><span class="p">;</span>
	<span class="n">flist</span><span class="o">-&gt;</span><span class="n">xbf_count</span><span class="o">--</span><span class="p">;</span>
	<span class="n">kmem_zone_free</span><span class="p">(</span><span class="n">xfs_bmap_free_item_zone</span><span class="p">,</span> <span class="n">free</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Convert an extents-format file into a btree-format file.</span>
<span class="cm"> * The new file will have a root block (in the inode) and a single child block.</span>
<span class="cm"> */</span>
<span class="n">STATIC</span> <span class="kt">int</span>					<span class="cm">/* error */</span>
<span class="n">xfs_bmap_extents_to_btree</span><span class="p">(</span>
	<span class="n">xfs_trans_t</span>		<span class="o">*</span><span class="n">tp</span><span class="p">,</span>		<span class="cm">/* transaction pointer */</span>
	<span class="n">xfs_inode_t</span>		<span class="o">*</span><span class="n">ip</span><span class="p">,</span>		<span class="cm">/* incore inode pointer */</span>
	<span class="n">xfs_fsblock_t</span>		<span class="o">*</span><span class="n">firstblock</span><span class="p">,</span>	<span class="cm">/* first-block-allocated */</span>
	<span class="n">xfs_bmap_free_t</span>		<span class="o">*</span><span class="n">flist</span><span class="p">,</span>		<span class="cm">/* blocks freed in xaction */</span>
	<span class="n">xfs_btree_cur_t</span>		<span class="o">**</span><span class="n">curp</span><span class="p">,</span>		<span class="cm">/* cursor returned to caller */</span>
	<span class="kt">int</span>			<span class="n">wasdel</span><span class="p">,</span>		<span class="cm">/* converting a delayed alloc */</span>
	<span class="kt">int</span>			<span class="o">*</span><span class="n">logflagsp</span><span class="p">,</span>	<span class="cm">/* inode logging flags */</span>
	<span class="kt">int</span>			<span class="n">whichfork</span><span class="p">)</span>	<span class="cm">/* data or attr fork */</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">xfs_btree_block</span>	<span class="o">*</span><span class="n">ablock</span><span class="p">;</span>	<span class="cm">/* allocated (child) bt block */</span>
	<span class="n">xfs_buf_t</span>		<span class="o">*</span><span class="n">abp</span><span class="p">;</span>		<span class="cm">/* buffer for ablock */</span>
	<span class="n">xfs_alloc_arg_t</span>		<span class="n">args</span><span class="p">;</span>		<span class="cm">/* allocation arguments */</span>
	<span class="n">xfs_bmbt_rec_t</span>		<span class="o">*</span><span class="n">arp</span><span class="p">;</span>		<span class="cm">/* child record pointer */</span>
	<span class="k">struct</span> <span class="n">xfs_btree_block</span>	<span class="o">*</span><span class="n">block</span><span class="p">;</span>		<span class="cm">/* btree root block */</span>
	<span class="n">xfs_btree_cur_t</span>		<span class="o">*</span><span class="n">cur</span><span class="p">;</span>		<span class="cm">/* bmap btree cursor */</span>
	<span class="n">xfs_bmbt_rec_host_t</span>	<span class="o">*</span><span class="n">ep</span><span class="p">;</span>		<span class="cm">/* extent record pointer */</span>
	<span class="kt">int</span>			<span class="n">error</span><span class="p">;</span>		<span class="cm">/* error return value */</span>
	<span class="n">xfs_extnum_t</span>		<span class="n">i</span><span class="p">,</span> <span class="n">cnt</span><span class="p">;</span>		<span class="cm">/* extent record index */</span>
	<span class="n">xfs_ifork_t</span>		<span class="o">*</span><span class="n">ifp</span><span class="p">;</span>		<span class="cm">/* inode fork pointer */</span>
	<span class="n">xfs_bmbt_key_t</span>		<span class="o">*</span><span class="n">kp</span><span class="p">;</span>		<span class="cm">/* root block key pointer */</span>
	<span class="n">xfs_mount_t</span>		<span class="o">*</span><span class="n">mp</span><span class="p">;</span>		<span class="cm">/* mount structure */</span>
	<span class="n">xfs_extnum_t</span>		<span class="n">nextents</span><span class="p">;</span>	<span class="cm">/* number of file extents */</span>
	<span class="n">xfs_bmbt_ptr_t</span>		<span class="o">*</span><span class="n">pp</span><span class="p">;</span>		<span class="cm">/* root block address pointer */</span>

	<span class="n">ifp</span> <span class="o">=</span> <span class="n">XFS_IFORK_PTR</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">whichfork</span><span class="p">);</span>
	<span class="n">ASSERT</span><span class="p">(</span><span class="n">XFS_IFORK_FORMAT</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">whichfork</span><span class="p">)</span> <span class="o">==</span> <span class="n">XFS_DINODE_FMT_EXTENTS</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Make space in the inode incore.</span>
<span class="cm">	 */</span>
	<span class="n">xfs_iroot_realloc</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">whichfork</span><span class="p">);</span>
	<span class="n">ifp</span><span class="o">-&gt;</span><span class="n">if_flags</span> <span class="o">|=</span> <span class="n">XFS_IFBROOT</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Fill in the root.</span>
<span class="cm">	 */</span>
	<span class="n">block</span> <span class="o">=</span> <span class="n">ifp</span><span class="o">-&gt;</span><span class="n">if_broot</span><span class="p">;</span>
	<span class="n">block</span><span class="o">-&gt;</span><span class="n">bb_magic</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">XFS_BMAP_MAGIC</span><span class="p">);</span>
	<span class="n">block</span><span class="o">-&gt;</span><span class="n">bb_level</span> <span class="o">=</span> <span class="n">cpu_to_be16</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">block</span><span class="o">-&gt;</span><span class="n">bb_numrecs</span> <span class="o">=</span> <span class="n">cpu_to_be16</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">block</span><span class="o">-&gt;</span><span class="n">bb_u</span><span class="p">.</span><span class="n">l</span><span class="p">.</span><span class="n">bb_leftsib</span> <span class="o">=</span> <span class="n">cpu_to_be64</span><span class="p">(</span><span class="n">NULLDFSBNO</span><span class="p">);</span>
	<span class="n">block</span><span class="o">-&gt;</span><span class="n">bb_u</span><span class="p">.</span><span class="n">l</span><span class="p">.</span><span class="n">bb_rightsib</span> <span class="o">=</span> <span class="n">cpu_to_be64</span><span class="p">(</span><span class="n">NULLDFSBNO</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Need a cursor.  Can&#39;t allocate until bb_level is filled in.</span>
<span class="cm">	 */</span>
	<span class="n">mp</span> <span class="o">=</span> <span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_mount</span><span class="p">;</span>
	<span class="n">cur</span> <span class="o">=</span> <span class="n">xfs_bmbt_init_cursor</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="n">tp</span><span class="p">,</span> <span class="n">ip</span><span class="p">,</span> <span class="n">whichfork</span><span class="p">);</span>
	<span class="n">cur</span><span class="o">-&gt;</span><span class="n">bc_private</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">firstblock</span> <span class="o">=</span> <span class="o">*</span><span class="n">firstblock</span><span class="p">;</span>
	<span class="n">cur</span><span class="o">-&gt;</span><span class="n">bc_private</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">flist</span> <span class="o">=</span> <span class="n">flist</span><span class="p">;</span>
	<span class="n">cur</span><span class="o">-&gt;</span><span class="n">bc_private</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">wasdel</span> <span class="o">?</span> <span class="n">XFS_BTCUR_BPRV_WASDEL</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * Convert to a btree with two levels, one record in root.</span>
<span class="cm">	 */</span>
	<span class="n">XFS_IFORK_FMT_SET</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">whichfork</span><span class="p">,</span> <span class="n">XFS_DINODE_FMT_BTREE</span><span class="p">);</span>
	<span class="n">args</span><span class="p">.</span><span class="n">tp</span> <span class="o">=</span> <span class="n">tp</span><span class="p">;</span>
	<span class="n">args</span><span class="p">.</span><span class="n">mp</span> <span class="o">=</span> <span class="n">mp</span><span class="p">;</span>
	<span class="n">args</span><span class="p">.</span><span class="n">firstblock</span> <span class="o">=</span> <span class="o">*</span><span class="n">firstblock</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">firstblock</span> <span class="o">==</span> <span class="n">NULLFSBLOCK</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">args</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">XFS_ALLOCTYPE_START_BNO</span><span class="p">;</span>
		<span class="n">args</span><span class="p">.</span><span class="n">fsbno</span> <span class="o">=</span> <span class="n">XFS_INO_TO_FSB</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_ino</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">flist</span><span class="o">-&gt;</span><span class="n">xbf_low</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">args</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">XFS_ALLOCTYPE_START_BNO</span><span class="p">;</span>
		<span class="n">args</span><span class="p">.</span><span class="n">fsbno</span> <span class="o">=</span> <span class="o">*</span><span class="n">firstblock</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">args</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">XFS_ALLOCTYPE_NEAR_BNO</span><span class="p">;</span>
		<span class="n">args</span><span class="p">.</span><span class="n">fsbno</span> <span class="o">=</span> <span class="o">*</span><span class="n">firstblock</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">args</span><span class="p">.</span><span class="n">minlen</span> <span class="o">=</span> <span class="n">args</span><span class="p">.</span><span class="n">maxlen</span> <span class="o">=</span> <span class="n">args</span><span class="p">.</span><span class="n">prod</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">args</span><span class="p">.</span><span class="n">total</span> <span class="o">=</span> <span class="n">args</span><span class="p">.</span><span class="n">minleft</span> <span class="o">=</span> <span class="n">args</span><span class="p">.</span><span class="n">alignment</span> <span class="o">=</span> <span class="n">args</span><span class="p">.</span><span class="n">mod</span> <span class="o">=</span> <span class="n">args</span><span class="p">.</span><span class="n">isfl</span> <span class="o">=</span>
		<span class="n">args</span><span class="p">.</span><span class="n">minalignslop</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">args</span><span class="p">.</span><span class="n">wasdel</span> <span class="o">=</span> <span class="n">wasdel</span><span class="p">;</span>
	<span class="o">*</span><span class="n">logflagsp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">error</span> <span class="o">=</span> <span class="n">xfs_alloc_vextent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">args</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">xfs_iroot_realloc</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">whichfork</span><span class="p">);</span>
		<span class="n">xfs_btree_del_cursor</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">XFS_BTREE_ERROR</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/*</span>
<span class="cm">	 * Allocation can&#39;t fail, the space was reserved.</span>
<span class="cm">	 */</span>
	<span class="n">ASSERT</span><span class="p">(</span><span class="n">args</span><span class="p">.</span><span class="n">fsbno</span> <span class="o">!=</span> <span class="n">NULLFSBLOCK</span><span class="p">);</span>
	<span class="n">ASSERT</span><span class="p">(</span><span class="o">*</span><span class="n">firstblock</span> <span class="o">==</span> <span class="n">NULLFSBLOCK</span> <span class="o">||</span>
	       <span class="n">args</span><span class="p">.</span><span class="n">agno</span> <span class="o">==</span> <span class="n">XFS_FSB_TO_AGNO</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="o">*</span><span class="n">firstblock</span><span class="p">)</span> <span class="o">||</span>
	       <span class="p">(</span><span class="n">flist</span><span class="o">-&gt;</span><span class="n">xbf_low</span> <span class="o">&amp;&amp;</span>
		<span class="n">args</span><span class="p">.</span><span class="n">agno</span> <span class="o">&gt;</span> <span class="n">XFS_FSB_TO_AGNO</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="o">*</span><span class="n">firstblock</span><span class="p">)));</span>
	<span class="o">*</span><span class="n">firstblock</span> <span class="o">=</span> <span class="n">cur</span><span class="o">-&gt;</span><span class="n">bc_private</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">firstblock</span> <span class="o">=</span> <span class="n">args</span><span class="p">.</span><span class="n">fsbno</span><span class="p">;</span>
	<span class="n">cur</span><span class="o">-&gt;</span><span class="n">bc_private</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">allocated</span><span class="o">++</span><span class="p">;</span>
	<span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_d</span><span class="p">.</span><span class="n">di_nblocks</span><span class="o">++</span><span class="p">;</span>
	<span class="n">xfs_trans_mod_dquot_byino</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">ip</span><span class="p">,</span> <span class="n">XFS_TRANS_DQ_BCOUNT</span><span class="p">,</span> <span class="mi">1L</span><span class="p">);</span>
	<span class="n">abp</span> <span class="o">=</span> <span class="n">xfs_btree_get_bufl</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="n">tp</span><span class="p">,</span> <span class="n">args</span><span class="p">.</span><span class="n">fsbno</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 * Fill in the child block.</span>
<span class="cm">	 */</span>
	<span class="n">ablock</span> <span class="o">=</span> <span class="n">XFS_BUF_TO_BLOCK</span><span class="p">(</span><span class="n">abp</span><span class="p">);</span>
	<span class="n">ablock</span><span class="o">-&gt;</span><span class="n">bb_magic</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">XFS_BMAP_MAGIC</span><span class="p">);</span>
	<span class="n">ablock</span><span class="o">-&gt;</span><span class="n">bb_level</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ablock</span><span class="o">-&gt;</span><span class="n">bb_u</span><span class="p">.</span><span class="n">l</span><span class="p">.</span><span class="n">bb_leftsib</span> <span class="o">=</span> <span class="n">cpu_to_be64</span><span class="p">(</span><span class="n">NULLDFSBNO</span><span class="p">);</span>
	<span class="n">ablock</span><span class="o">-&gt;</span><span class="n">bb_u</span><span class="p">.</span><span class="n">l</span><span class="p">.</span><span class="n">bb_rightsib</span> <span class="o">=</span> <span class="n">cpu_to_be64</span><span class="p">(</span><span class="n">NULLDFSBNO</span><span class="p">);</span>
	<span class="n">arp</span> <span class="o">=</span> <span class="n">XFS_BMBT_REC_ADDR</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="n">ablock</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">nextents</span> <span class="o">=</span> <span class="n">ifp</span><span class="o">-&gt;</span><span class="n">if_bytes</span> <span class="o">/</span> <span class="p">(</span><span class="n">uint</span><span class="p">)</span><span class="k">sizeof</span><span class="p">(</span><span class="n">xfs_bmbt_rec_t</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">cnt</span> <span class="o">=</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">nextents</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ep</span> <span class="o">=</span> <span class="n">xfs_iext_get_ext</span><span class="p">(</span><span class="n">ifp</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">isnullstartblock</span><span class="p">(</span><span class="n">xfs_bmbt_get_startblock</span><span class="p">(</span><span class="n">ep</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">arp</span><span class="o">-&gt;</span><span class="n">l0</span> <span class="o">=</span> <span class="n">cpu_to_be64</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">l0</span><span class="p">);</span>
			<span class="n">arp</span><span class="o">-&gt;</span><span class="n">l1</span> <span class="o">=</span> <span class="n">cpu_to_be64</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">l1</span><span class="p">);</span>
			<span class="n">arp</span><span class="o">++</span><span class="p">;</span> <span class="n">cnt</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">ASSERT</span><span class="p">(</span><span class="n">cnt</span> <span class="o">==</span> <span class="n">XFS_IFORK_NEXTENTS</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">whichfork</span><span class="p">));</span>
	<span class="n">xfs_btree_set_numrecs</span><span class="p">(</span><span class="n">ablock</span><span class="p">,</span> <span class="n">cnt</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Fill in the root key and pointer.</span>
<span class="cm">	 */</span>
	<span class="n">kp</span> <span class="o">=</span> <span class="n">XFS_BMBT_KEY_ADDR</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="n">block</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">arp</span> <span class="o">=</span> <span class="n">XFS_BMBT_REC_ADDR</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="n">ablock</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">kp</span><span class="o">-&gt;</span><span class="n">br_startoff</span> <span class="o">=</span> <span class="n">cpu_to_be64</span><span class="p">(</span><span class="n">xfs_bmbt_disk_get_startoff</span><span class="p">(</span><span class="n">arp</span><span class="p">));</span>
	<span class="n">pp</span> <span class="o">=</span> <span class="n">XFS_BMBT_PTR_ADDR</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="n">block</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">xfs_bmbt_get_maxrecs</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span>
						<span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">block</span><span class="o">-&gt;</span><span class="n">bb_level</span><span class="p">)));</span>
	<span class="o">*</span><span class="n">pp</span> <span class="o">=</span> <span class="n">cpu_to_be64</span><span class="p">(</span><span class="n">args</span><span class="p">.</span><span class="n">fsbno</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Do all this logging at the end so that</span>
<span class="cm">	 * the root is at the right level.</span>
<span class="cm">	 */</span>
	<span class="n">xfs_btree_log_block</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">abp</span><span class="p">,</span> <span class="n">XFS_BB_ALL_BITS</span><span class="p">);</span>
	<span class="n">xfs_btree_log_recs</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">abp</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">ablock</span><span class="o">-&gt;</span><span class="n">bb_numrecs</span><span class="p">));</span>
	<span class="n">ASSERT</span><span class="p">(</span><span class="o">*</span><span class="n">curp</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="o">*</span><span class="n">curp</span> <span class="o">=</span> <span class="n">cur</span><span class="p">;</span>
	<span class="o">*</span><span class="n">logflagsp</span> <span class="o">=</span> <span class="n">XFS_ILOG_CORE</span> <span class="o">|</span> <span class="n">xfs_ilog_fbroot</span><span class="p">(</span><span class="n">whichfork</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Calculate the default attribute fork offset for newly created inodes.</span>
<span class="cm"> */</span>
<span class="n">uint</span>
<span class="n">xfs_default_attroffset</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">xfs_inode</span>	<span class="o">*</span><span class="n">ip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">xfs_mount</span>	<span class="o">*</span><span class="n">mp</span> <span class="o">=</span> <span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_mount</span><span class="p">;</span>
	<span class="n">uint</span>			<span class="n">offset</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_sb</span><span class="p">.</span><span class="n">sb_inodesize</span> <span class="o">==</span> <span class="mi">256</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">offset</span> <span class="o">=</span> <span class="n">XFS_LITINO</span><span class="p">(</span><span class="n">mp</span><span class="p">)</span> <span class="o">-</span>
				<span class="n">XFS_BMDR_SPACE_CALC</span><span class="p">(</span><span class="n">MINABTPTRS</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">offset</span> <span class="o">=</span> <span class="n">XFS_BMDR_SPACE_CALC</span><span class="p">(</span><span class="mi">6</span> <span class="o">*</span> <span class="n">MINABTPTRS</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">ASSERT</span><span class="p">(</span><span class="n">offset</span> <span class="o">&lt;</span> <span class="n">XFS_LITINO</span><span class="p">(</span><span class="n">mp</span><span class="p">));</span>
	<span class="k">return</span> <span class="n">offset</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Helper routine to reset inode di_forkoff field when switching</span>
<span class="cm"> * attribute fork from local to extent format - we reset it where</span>
<span class="cm"> * possible to make space available for inline data fork extents.</span>
<span class="cm"> */</span>
<span class="n">STATIC</span> <span class="kt">void</span>
<span class="n">xfs_bmap_forkoff_reset</span><span class="p">(</span>
	<span class="n">xfs_mount_t</span>	<span class="o">*</span><span class="n">mp</span><span class="p">,</span>
	<span class="n">xfs_inode_t</span>	<span class="o">*</span><span class="n">ip</span><span class="p">,</span>
	<span class="kt">int</span>		<span class="n">whichfork</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">whichfork</span> <span class="o">==</span> <span class="n">XFS_ATTR_FORK</span> <span class="o">&amp;&amp;</span>
	    <span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_d</span><span class="p">.</span><span class="n">di_format</span> <span class="o">!=</span> <span class="n">XFS_DINODE_FMT_DEV</span> <span class="o">&amp;&amp;</span>
	    <span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_d</span><span class="p">.</span><span class="n">di_format</span> <span class="o">!=</span> <span class="n">XFS_DINODE_FMT_UUID</span> <span class="o">&amp;&amp;</span>
	    <span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_d</span><span class="p">.</span><span class="n">di_format</span> <span class="o">!=</span> <span class="n">XFS_DINODE_FMT_BTREE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">uint</span>	<span class="n">dfl_forkoff</span> <span class="o">=</span> <span class="n">xfs_default_attroffset</span><span class="p">(</span><span class="n">ip</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">dfl_forkoff</span> <span class="o">&gt;</span> <span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_d</span><span class="p">.</span><span class="n">di_forkoff</span><span class="p">)</span>
			<span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_d</span><span class="p">.</span><span class="n">di_forkoff</span> <span class="o">=</span> <span class="n">dfl_forkoff</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Convert a local file to an extents file.</span>
<span class="cm"> * This code is out of bounds for data forks of regular files,</span>
<span class="cm"> * since the file data needs to get logged so things will stay consistent.</span>
<span class="cm"> * (The bmap-level manipulations are ok, though).</span>
<span class="cm"> */</span>
<span class="n">STATIC</span> <span class="kt">int</span>				<span class="cm">/* error */</span>
<span class="n">xfs_bmap_local_to_extents</span><span class="p">(</span>
	<span class="n">xfs_trans_t</span>	<span class="o">*</span><span class="n">tp</span><span class="p">,</span>		<span class="cm">/* transaction pointer */</span>
	<span class="n">xfs_inode_t</span>	<span class="o">*</span><span class="n">ip</span><span class="p">,</span>		<span class="cm">/* incore inode pointer */</span>
	<span class="n">xfs_fsblock_t</span>	<span class="o">*</span><span class="n">firstblock</span><span class="p">,</span>	<span class="cm">/* first block allocated in xaction */</span>
	<span class="n">xfs_extlen_t</span>	<span class="n">total</span><span class="p">,</span>		<span class="cm">/* total blocks needed by transaction */</span>
	<span class="kt">int</span>		<span class="o">*</span><span class="n">logflagsp</span><span class="p">,</span>	<span class="cm">/* inode logging flags */</span>
	<span class="kt">int</span>		<span class="n">whichfork</span><span class="p">)</span>	<span class="cm">/* data or attr fork */</span>
<span class="p">{</span>
	<span class="kt">int</span>		<span class="n">error</span><span class="p">;</span>		<span class="cm">/* error return value */</span>
	<span class="kt">int</span>		<span class="n">flags</span><span class="p">;</span>		<span class="cm">/* logging flags returned */</span>
	<span class="n">xfs_ifork_t</span>	<span class="o">*</span><span class="n">ifp</span><span class="p">;</span>		<span class="cm">/* inode fork pointer */</span>

	<span class="cm">/*</span>
<span class="cm">	 * We don&#39;t want to deal with the case of keeping inode data inline yet.</span>
<span class="cm">	 * So sending the data fork of a regular inode is invalid.</span>
<span class="cm">	 */</span>
	<span class="n">ASSERT</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">S_ISREG</span><span class="p">(</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_d</span><span class="p">.</span><span class="n">di_mode</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">whichfork</span> <span class="o">==</span> <span class="n">XFS_DATA_FORK</span><span class="p">));</span>
	<span class="n">ifp</span> <span class="o">=</span> <span class="n">XFS_IFORK_PTR</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">whichfork</span><span class="p">);</span>
	<span class="n">ASSERT</span><span class="p">(</span><span class="n">XFS_IFORK_FORMAT</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">whichfork</span><span class="p">)</span> <span class="o">==</span> <span class="n">XFS_DINODE_FMT_LOCAL</span><span class="p">);</span>
	<span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">error</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ifp</span><span class="o">-&gt;</span><span class="n">if_bytes</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">xfs_alloc_arg_t</span>	<span class="n">args</span><span class="p">;</span>	<span class="cm">/* allocation arguments */</span>
		<span class="n">xfs_buf_t</span>	<span class="o">*</span><span class="n">bp</span><span class="p">;</span>	<span class="cm">/* buffer for extent block */</span>
		<span class="n">xfs_bmbt_rec_host_t</span> <span class="o">*</span><span class="n">ep</span><span class="p">;</span><span class="cm">/* extent record pointer */</span>

		<span class="n">args</span><span class="p">.</span><span class="n">tp</span> <span class="o">=</span> <span class="n">tp</span><span class="p">;</span>
		<span class="n">args</span><span class="p">.</span><span class="n">mp</span> <span class="o">=</span> <span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_mount</span><span class="p">;</span>
		<span class="n">args</span><span class="p">.</span><span class="n">firstblock</span> <span class="o">=</span> <span class="o">*</span><span class="n">firstblock</span><span class="p">;</span>
		<span class="n">ASSERT</span><span class="p">((</span><span class="n">ifp</span><span class="o">-&gt;</span><span class="n">if_flags</span> <span class="o">&amp;</span>
			<span class="p">(</span><span class="n">XFS_IFINLINE</span><span class="o">|</span><span class="n">XFS_IFEXTENTS</span><span class="o">|</span><span class="n">XFS_IFEXTIREC</span><span class="p">))</span> <span class="o">==</span> <span class="n">XFS_IFINLINE</span><span class="p">);</span>
		<span class="cm">/*</span>
<span class="cm">		 * Allocate a block.  We know we need only one, since the</span>
<span class="cm">		 * file currently fits in an inode.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">firstblock</span> <span class="o">==</span> <span class="n">NULLFSBLOCK</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">args</span><span class="p">.</span><span class="n">fsbno</span> <span class="o">=</span> <span class="n">XFS_INO_TO_FSB</span><span class="p">(</span><span class="n">args</span><span class="p">.</span><span class="n">mp</span><span class="p">,</span> <span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_ino</span><span class="p">);</span>
			<span class="n">args</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">XFS_ALLOCTYPE_START_BNO</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">args</span><span class="p">.</span><span class="n">fsbno</span> <span class="o">=</span> <span class="o">*</span><span class="n">firstblock</span><span class="p">;</span>
			<span class="n">args</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">XFS_ALLOCTYPE_NEAR_BNO</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">args</span><span class="p">.</span><span class="n">total</span> <span class="o">=</span> <span class="n">total</span><span class="p">;</span>
		<span class="n">args</span><span class="p">.</span><span class="n">mod</span> <span class="o">=</span> <span class="n">args</span><span class="p">.</span><span class="n">minleft</span> <span class="o">=</span> <span class="n">args</span><span class="p">.</span><span class="n">alignment</span> <span class="o">=</span> <span class="n">args</span><span class="p">.</span><span class="n">wasdel</span> <span class="o">=</span>
			<span class="n">args</span><span class="p">.</span><span class="n">isfl</span> <span class="o">=</span> <span class="n">args</span><span class="p">.</span><span class="n">minalignslop</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">args</span><span class="p">.</span><span class="n">minlen</span> <span class="o">=</span> <span class="n">args</span><span class="p">.</span><span class="n">maxlen</span> <span class="o">=</span> <span class="n">args</span><span class="p">.</span><span class="n">prod</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">error</span> <span class="o">=</span> <span class="n">xfs_alloc_vextent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">args</span><span class="p">)))</span>
			<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
		<span class="cm">/*</span>
<span class="cm">		 * Can&#39;t fail, the space was reserved.</span>
<span class="cm">		 */</span>
		<span class="n">ASSERT</span><span class="p">(</span><span class="n">args</span><span class="p">.</span><span class="n">fsbno</span> <span class="o">!=</span> <span class="n">NULLFSBLOCK</span><span class="p">);</span>
		<span class="n">ASSERT</span><span class="p">(</span><span class="n">args</span><span class="p">.</span><span class="n">len</span> <span class="o">==</span> <span class="mi">1</span><span class="p">);</span>
		<span class="o">*</span><span class="n">firstblock</span> <span class="o">=</span> <span class="n">args</span><span class="p">.</span><span class="n">fsbno</span><span class="p">;</span>
		<span class="n">bp</span> <span class="o">=</span> <span class="n">xfs_btree_get_bufl</span><span class="p">(</span><span class="n">args</span><span class="p">.</span><span class="n">mp</span><span class="p">,</span> <span class="n">tp</span><span class="p">,</span> <span class="n">args</span><span class="p">.</span><span class="n">fsbno</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">b_addr</span><span class="p">,</span> <span class="n">ifp</span><span class="o">-&gt;</span><span class="n">if_u1</span><span class="p">.</span><span class="n">if_data</span><span class="p">,</span> <span class="n">ifp</span><span class="o">-&gt;</span><span class="n">if_bytes</span><span class="p">);</span>
		<span class="n">xfs_trans_log_buf</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">bp</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ifp</span><span class="o">-&gt;</span><span class="n">if_bytes</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">xfs_bmap_forkoff_reset</span><span class="p">(</span><span class="n">args</span><span class="p">.</span><span class="n">mp</span><span class="p">,</span> <span class="n">ip</span><span class="p">,</span> <span class="n">whichfork</span><span class="p">);</span>
		<span class="n">xfs_idata_realloc</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="o">-</span><span class="n">ifp</span><span class="o">-&gt;</span><span class="n">if_bytes</span><span class="p">,</span> <span class="n">whichfork</span><span class="p">);</span>
		<span class="n">xfs_iext_add</span><span class="p">(</span><span class="n">ifp</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">ep</span> <span class="o">=</span> <span class="n">xfs_iext_get_ext</span><span class="p">(</span><span class="n">ifp</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">xfs_bmbt_set_allf</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">args</span><span class="p">.</span><span class="n">fsbno</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">XFS_EXT_NORM</span><span class="p">);</span>
		<span class="n">trace_xfs_bmap_post_update</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
				<span class="n">whichfork</span> <span class="o">==</span> <span class="n">XFS_ATTR_FORK</span> <span class="o">?</span> <span class="n">BMAP_ATTRFORK</span> <span class="o">:</span> <span class="mi">0</span><span class="p">,</span>
				<span class="n">_THIS_IP_</span><span class="p">);</span>
		<span class="n">XFS_IFORK_NEXT_SET</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">whichfork</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_d</span><span class="p">.</span><span class="n">di_nblocks</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">xfs_trans_mod_dquot_byino</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">ip</span><span class="p">,</span>
			<span class="n">XFS_TRANS_DQ_BCOUNT</span><span class="p">,</span> <span class="mi">1L</span><span class="p">);</span>
		<span class="n">flags</span> <span class="o">|=</span> <span class="n">xfs_ilog_fext</span><span class="p">(</span><span class="n">whichfork</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ASSERT</span><span class="p">(</span><span class="n">XFS_IFORK_NEXTENTS</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">whichfork</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">xfs_bmap_forkoff_reset</span><span class="p">(</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_mount</span><span class="p">,</span> <span class="n">ip</span><span class="p">,</span> <span class="n">whichfork</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">ifp</span><span class="o">-&gt;</span><span class="n">if_flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">XFS_IFINLINE</span><span class="p">;</span>
	<span class="n">ifp</span><span class="o">-&gt;</span><span class="n">if_flags</span> <span class="o">|=</span> <span class="n">XFS_IFEXTENTS</span><span class="p">;</span>
	<span class="n">XFS_IFORK_FMT_SET</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">whichfork</span><span class="p">,</span> <span class="n">XFS_DINODE_FMT_EXTENTS</span><span class="p">);</span>
	<span class="n">flags</span> <span class="o">|=</span> <span class="n">XFS_ILOG_CORE</span><span class="p">;</span>
<span class="nl">done:</span>
	<span class="o">*</span><span class="n">logflagsp</span> <span class="o">=</span> <span class="n">flags</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Search the extent records for the entry containing block bno.</span>
<span class="cm"> * If bno lies in a hole, point to the next entry.  If bno lies</span>
<span class="cm"> * past eof, *eofp will be set, and *prevp will contain the last</span>
<span class="cm"> * entry (null if none).  Else, *lastxp will be set to the index</span>
<span class="cm"> * of the found entry; *gotp will contain the entry.</span>
<span class="cm"> */</span>
<span class="n">STATIC</span> <span class="n">xfs_bmbt_rec_host_t</span> <span class="o">*</span>		<span class="cm">/* pointer to found extent entry */</span>
<span class="n">xfs_bmap_search_multi_extents</span><span class="p">(</span>
	<span class="n">xfs_ifork_t</span>	<span class="o">*</span><span class="n">ifp</span><span class="p">,</span>		<span class="cm">/* inode fork pointer */</span>
	<span class="n">xfs_fileoff_t</span>	<span class="n">bno</span><span class="p">,</span>		<span class="cm">/* block number searched for */</span>
	<span class="kt">int</span>		<span class="o">*</span><span class="n">eofp</span><span class="p">,</span>		<span class="cm">/* out: end of file found */</span>
	<span class="n">xfs_extnum_t</span>	<span class="o">*</span><span class="n">lastxp</span><span class="p">,</span>	<span class="cm">/* out: last extent index */</span>
	<span class="n">xfs_bmbt_irec_t</span>	<span class="o">*</span><span class="n">gotp</span><span class="p">,</span>		<span class="cm">/* out: extent entry found */</span>
	<span class="n">xfs_bmbt_irec_t</span>	<span class="o">*</span><span class="n">prevp</span><span class="p">)</span>		<span class="cm">/* out: previous extent entry found */</span>
<span class="p">{</span>
	<span class="n">xfs_bmbt_rec_host_t</span> <span class="o">*</span><span class="n">ep</span><span class="p">;</span>		<span class="cm">/* extent record pointer */</span>
	<span class="n">xfs_extnum_t</span>	<span class="n">lastx</span><span class="p">;</span>		<span class="cm">/* last extent index */</span>

	<span class="cm">/*</span>
<span class="cm">	 * Initialize the extent entry structure to catch access to</span>
<span class="cm">	 * uninitialized br_startblock field.</span>
<span class="cm">	 */</span>
	<span class="n">gotp</span><span class="o">-&gt;</span><span class="n">br_startoff</span> <span class="o">=</span> <span class="mh">0xffa5a5a5a5a5a5a5LL</span><span class="p">;</span>
	<span class="n">gotp</span><span class="o">-&gt;</span><span class="n">br_blockcount</span> <span class="o">=</span> <span class="mh">0xa55a5a5a5a5a5a5aLL</span><span class="p">;</span>
	<span class="n">gotp</span><span class="o">-&gt;</span><span class="n">br_state</span> <span class="o">=</span> <span class="n">XFS_EXT_INVALID</span><span class="p">;</span>
<span class="cp">#if XFS_BIG_BLKNOS</span>
	<span class="n">gotp</span><span class="o">-&gt;</span><span class="n">br_startblock</span> <span class="o">=</span> <span class="mh">0xffffa5a5a5a5a5a5LL</span><span class="p">;</span>
<span class="cp">#else</span>
	<span class="n">gotp</span><span class="o">-&gt;</span><span class="n">br_startblock</span> <span class="o">=</span> <span class="mh">0xffffa5a5</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="n">prevp</span><span class="o">-&gt;</span><span class="n">br_startoff</span> <span class="o">=</span> <span class="n">NULLFILEOFF</span><span class="p">;</span>

	<span class="n">ep</span> <span class="o">=</span> <span class="n">xfs_iext_bno_to_ext</span><span class="p">(</span><span class="n">ifp</span><span class="p">,</span> <span class="n">bno</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">lastx</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lastx</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">xfs_bmbt_get_all</span><span class="p">(</span><span class="n">xfs_iext_get_ext</span><span class="p">(</span><span class="n">ifp</span><span class="p">,</span> <span class="n">lastx</span> <span class="o">-</span> <span class="mi">1</span><span class="p">),</span> <span class="n">prevp</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lastx</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">ifp</span><span class="o">-&gt;</span><span class="n">if_bytes</span> <span class="o">/</span> <span class="p">(</span><span class="n">uint</span><span class="p">)</span><span class="k">sizeof</span><span class="p">(</span><span class="n">xfs_bmbt_rec_t</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">xfs_bmbt_get_all</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="n">gotp</span><span class="p">);</span>
		<span class="o">*</span><span class="n">eofp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">lastx</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="o">*</span><span class="n">gotp</span> <span class="o">=</span> <span class="o">*</span><span class="n">prevp</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="o">*</span><span class="n">eofp</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">ep</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="o">*</span><span class="n">lastxp</span> <span class="o">=</span> <span class="n">lastx</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">ep</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Search the extents list for the inode, for the extent containing bno.</span>
<span class="cm"> * If bno lies in a hole, point to the next entry.  If bno lies past eof,</span>
<span class="cm"> * *eofp will be set, and *prevp will contain the last entry (null if none).</span>
<span class="cm"> * Else, *lastxp will be set to the index of the found</span>
<span class="cm"> * entry; *gotp will contain the entry.</span>
<span class="cm"> */</span>
<span class="n">STATIC</span> <span class="n">xfs_bmbt_rec_host_t</span> <span class="o">*</span>                 <span class="cm">/* pointer to found extent entry */</span>
<span class="n">xfs_bmap_search_extents</span><span class="p">(</span>
	<span class="n">xfs_inode_t</span>     <span class="o">*</span><span class="n">ip</span><span class="p">,</span>            <span class="cm">/* incore inode pointer */</span>
	<span class="n">xfs_fileoff_t</span>   <span class="n">bno</span><span class="p">,</span>            <span class="cm">/* block number searched for */</span>
	<span class="kt">int</span>             <span class="n">fork</span><span class="p">,</span>      	<span class="cm">/* data or attr fork */</span>
	<span class="kt">int</span>             <span class="o">*</span><span class="n">eofp</span><span class="p">,</span>          <span class="cm">/* out: end of file found */</span>
	<span class="n">xfs_extnum_t</span>    <span class="o">*</span><span class="n">lastxp</span><span class="p">,</span>        <span class="cm">/* out: last extent index */</span>
	<span class="n">xfs_bmbt_irec_t</span> <span class="o">*</span><span class="n">gotp</span><span class="p">,</span>          <span class="cm">/* out: extent entry found */</span>
	<span class="n">xfs_bmbt_irec_t</span> <span class="o">*</span><span class="n">prevp</span><span class="p">)</span>         <span class="cm">/* out: previous extent entry found */</span>
<span class="p">{</span>
	<span class="n">xfs_ifork_t</span>	<span class="o">*</span><span class="n">ifp</span><span class="p">;</span>		<span class="cm">/* inode fork pointer */</span>
	<span class="n">xfs_bmbt_rec_host_t</span>  <span class="o">*</span><span class="n">ep</span><span class="p">;</span>            <span class="cm">/* extent record pointer */</span>

	<span class="n">XFS_STATS_INC</span><span class="p">(</span><span class="n">xs_look_exlist</span><span class="p">);</span>
	<span class="n">ifp</span> <span class="o">=</span> <span class="n">XFS_IFORK_PTR</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">fork</span><span class="p">);</span>

	<span class="n">ep</span> <span class="o">=</span> <span class="n">xfs_bmap_search_multi_extents</span><span class="p">(</span><span class="n">ifp</span><span class="p">,</span> <span class="n">bno</span><span class="p">,</span> <span class="n">eofp</span><span class="p">,</span> <span class="n">lastxp</span><span class="p">,</span> <span class="n">gotp</span><span class="p">,</span> <span class="n">prevp</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">gotp</span><span class="o">-&gt;</span><span class="n">br_startblock</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="o">*</span><span class="n">lastxp</span> <span class="o">!=</span> <span class="n">NULLEXTNUM</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		     <span class="o">!</span><span class="p">(</span><span class="n">XFS_IS_REALTIME_INODE</span><span class="p">(</span><span class="n">ip</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">fork</span> <span class="o">==</span> <span class="n">XFS_DATA_FORK</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">xfs_alert_tag</span><span class="p">(</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_mount</span><span class="p">,</span> <span class="n">XFS_PTAG_FSBLOCK_ZERO</span><span class="p">,</span>
				<span class="s">&quot;Access to block zero in inode %llu &quot;</span>
				<span class="s">&quot;start_block: %llx start_off: %llx &quot;</span>
				<span class="s">&quot;blkcnt: %llx extent-state: %x lastx: %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_ino</span><span class="p">,</span>
			<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">gotp</span><span class="o">-&gt;</span><span class="n">br_startblock</span><span class="p">,</span>
			<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">gotp</span><span class="o">-&gt;</span><span class="n">br_startoff</span><span class="p">,</span>
			<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">gotp</span><span class="o">-&gt;</span><span class="n">br_blockcount</span><span class="p">,</span>
			<span class="n">gotp</span><span class="o">-&gt;</span><span class="n">br_state</span><span class="p">,</span> <span class="o">*</span><span class="n">lastxp</span><span class="p">);</span>
		<span class="o">*</span><span class="n">lastxp</span> <span class="o">=</span> <span class="n">NULLEXTNUM</span><span class="p">;</span>
		<span class="o">*</span><span class="n">eofp</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">ep</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Compute the worst-case number of indirect blocks that will be used</span>
<span class="cm"> * for ip&#39;s delayed extent of length &quot;len&quot;.</span>
<span class="cm"> */</span>
<span class="n">STATIC</span> <span class="n">xfs_filblks_t</span>
<span class="n">xfs_bmap_worst_indlen</span><span class="p">(</span>
	<span class="n">xfs_inode_t</span>	<span class="o">*</span><span class="n">ip</span><span class="p">,</span>		<span class="cm">/* incore inode pointer */</span>
	<span class="n">xfs_filblks_t</span>	<span class="n">len</span><span class="p">)</span>		<span class="cm">/* delayed extent length */</span>
<span class="p">{</span>
	<span class="kt">int</span>		<span class="n">level</span><span class="p">;</span>		<span class="cm">/* btree level number */</span>
	<span class="kt">int</span>		<span class="n">maxrecs</span><span class="p">;</span>	<span class="cm">/* maximum record count at this level */</span>
	<span class="n">xfs_mount_t</span>	<span class="o">*</span><span class="n">mp</span><span class="p">;</span>		<span class="cm">/* mount structure */</span>
	<span class="n">xfs_filblks_t</span>	<span class="n">rval</span><span class="p">;</span>		<span class="cm">/* return value */</span>

	<span class="n">mp</span> <span class="o">=</span> <span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_mount</span><span class="p">;</span>
	<span class="n">maxrecs</span> <span class="o">=</span> <span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_bmap_dmxr</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">level</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">rval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	     <span class="n">level</span> <span class="o">&lt;</span> <span class="n">XFS_BM_MAXLEVELS</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="n">XFS_DATA_FORK</span><span class="p">);</span>
	     <span class="n">level</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">len</span> <span class="o">+=</span> <span class="n">maxrecs</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">do_div</span><span class="p">(</span><span class="n">len</span><span class="p">,</span> <span class="n">maxrecs</span><span class="p">);</span>
		<span class="n">rval</span> <span class="o">+=</span> <span class="n">len</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">rval</span> <span class="o">+</span> <span class="n">XFS_BM_MAXLEVELS</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="n">XFS_DATA_FORK</span><span class="p">)</span> <span class="o">-</span>
				<span class="n">level</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">level</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">maxrecs</span> <span class="o">=</span> <span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_bmap_dmxr</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">rval</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Convert inode from non-attributed to attributed.</span>
<span class="cm"> * Must not be in a transaction, ip must not be locked.</span>
<span class="cm"> */</span>
<span class="kt">int</span>						<span class="cm">/* error code */</span>
<span class="n">xfs_bmap_add_attrfork</span><span class="p">(</span>
	<span class="n">xfs_inode_t</span>		<span class="o">*</span><span class="n">ip</span><span class="p">,</span>		<span class="cm">/* incore inode pointer */</span>
	<span class="kt">int</span>			<span class="n">size</span><span class="p">,</span>		<span class="cm">/* space new attribute needs */</span>
	<span class="kt">int</span>			<span class="n">rsvd</span><span class="p">)</span>		<span class="cm">/* xact may use reserved blks */</span>
<span class="p">{</span>
	<span class="n">xfs_fsblock_t</span>		<span class="n">firstblock</span><span class="p">;</span>	<span class="cm">/* 1st block/ag allocated */</span>
	<span class="n">xfs_bmap_free_t</span>		<span class="n">flist</span><span class="p">;</span>		<span class="cm">/* freed extent records */</span>
	<span class="n">xfs_mount_t</span>		<span class="o">*</span><span class="n">mp</span><span class="p">;</span>		<span class="cm">/* mount structure */</span>
	<span class="n">xfs_trans_t</span>		<span class="o">*</span><span class="n">tp</span><span class="p">;</span>		<span class="cm">/* transaction pointer */</span>
	<span class="kt">int</span>			<span class="n">blks</span><span class="p">;</span>		<span class="cm">/* space reservation */</span>
	<span class="kt">int</span>			<span class="n">version</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>	<span class="cm">/* superblock attr version */</span>
	<span class="kt">int</span>			<span class="n">committed</span><span class="p">;</span>	<span class="cm">/* xaction was committed */</span>
	<span class="kt">int</span>			<span class="n">logflags</span><span class="p">;</span>	<span class="cm">/* logging flags */</span>
	<span class="kt">int</span>			<span class="n">error</span><span class="p">;</span>		<span class="cm">/* error return value */</span>

	<span class="n">ASSERT</span><span class="p">(</span><span class="n">XFS_IFORK_Q</span><span class="p">(</span><span class="n">ip</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">mp</span> <span class="o">=</span> <span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_mount</span><span class="p">;</span>
	<span class="n">ASSERT</span><span class="p">(</span><span class="o">!</span><span class="n">XFS_NOT_DQATTACHED</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="n">ip</span><span class="p">));</span>
	<span class="n">tp</span> <span class="o">=</span> <span class="n">xfs_trans_alloc</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="n">XFS_TRANS_ADDAFORK</span><span class="p">);</span>
	<span class="n">blks</span> <span class="o">=</span> <span class="n">XFS_ADDAFORK_SPACE_RES</span><span class="p">(</span><span class="n">mp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rsvd</span><span class="p">)</span>
		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">t_flags</span> <span class="o">|=</span> <span class="n">XFS_TRANS_RESERVE</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">error</span> <span class="o">=</span> <span class="n">xfs_trans_reserve</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">blks</span><span class="p">,</span> <span class="n">XFS_ADDAFORK_LOG_RES</span><span class="p">(</span><span class="n">mp</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span>
			<span class="n">XFS_TRANS_PERM_LOG_RES</span><span class="p">,</span> <span class="n">XFS_ADDAFORK_LOG_COUNT</span><span class="p">)))</span>
		<span class="k">goto</span> <span class="n">error0</span><span class="p">;</span>
	<span class="n">xfs_ilock</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">XFS_ILOCK_EXCL</span><span class="p">);</span>
	<span class="n">error</span> <span class="o">=</span> <span class="n">xfs_trans_reserve_quota_nblks</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">ip</span><span class="p">,</span> <span class="n">blks</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">rsvd</span> <span class="o">?</span>
			<span class="n">XFS_QMOPT_RES_REGBLKS</span> <span class="o">|</span> <span class="n">XFS_QMOPT_FORCE_RES</span> <span class="o">:</span>
			<span class="n">XFS_QMOPT_RES_REGBLKS</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">xfs_iunlock</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">XFS_ILOCK_EXCL</span><span class="p">);</span>
		<span class="n">xfs_trans_cancel</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">XFS_TRANS_RELEASE_LOG_RES</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">XFS_IFORK_Q</span><span class="p">(</span><span class="n">ip</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">error1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_d</span><span class="p">.</span><span class="n">di_aformat</span> <span class="o">!=</span> <span class="n">XFS_DINODE_FMT_EXTENTS</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * For inodes coming from pre-6.2 filesystems.</span>
<span class="cm">		 */</span>
		<span class="n">ASSERT</span><span class="p">(</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_d</span><span class="p">.</span><span class="n">di_aformat</span> <span class="o">==</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_d</span><span class="p">.</span><span class="n">di_aformat</span> <span class="o">=</span> <span class="n">XFS_DINODE_FMT_EXTENTS</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ASSERT</span><span class="p">(</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_d</span><span class="p">.</span><span class="n">di_anextents</span> <span class="o">==</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">xfs_trans_ijoin</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">ip</span><span class="p">,</span> <span class="n">XFS_ILOCK_EXCL</span><span class="p">);</span>
	<span class="n">xfs_trans_log_inode</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">ip</span><span class="p">,</span> <span class="n">XFS_ILOG_CORE</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_d</span><span class="p">.</span><span class="n">di_format</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">XFS_DINODE_FMT_DEV</span>:
		<span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_d</span><span class="p">.</span><span class="n">di_forkoff</span> <span class="o">=</span> <span class="n">roundup</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">xfs_dev_t</span><span class="p">),</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">XFS_DINODE_FMT_UUID</span>:
		<span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_d</span><span class="p">.</span><span class="n">di_forkoff</span> <span class="o">=</span> <span class="n">roundup</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">uuid_t</span><span class="p">),</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">XFS_DINODE_FMT_LOCAL</span>:
	<span class="k">case</span> <span class="n">XFS_DINODE_FMT_EXTENTS</span>:
	<span class="k">case</span> <span class="n">XFS_DINODE_FMT_BTREE</span>:
		<span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_d</span><span class="p">.</span><span class="n">di_forkoff</span> <span class="o">=</span> <span class="n">xfs_attr_shortform_bytesfit</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_d</span><span class="p">.</span><span class="n">di_forkoff</span><span class="p">)</span>
			<span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_d</span><span class="p">.</span><span class="n">di_forkoff</span> <span class="o">=</span> <span class="n">xfs_default_attroffset</span><span class="p">(</span><span class="n">ip</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_flags</span> <span class="o">&amp;</span> <span class="n">XFS_MOUNT_ATTR2</span><span class="p">)</span>
			<span class="n">version</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">ASSERT</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
		<span class="n">error</span> <span class="o">=</span> <span class="n">XFS_ERROR</span><span class="p">(</span><span class="n">EINVAL</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">error1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ASSERT</span><span class="p">(</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_afp</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_afp</span> <span class="o">=</span> <span class="n">kmem_zone_zalloc</span><span class="p">(</span><span class="n">xfs_ifork_zone</span><span class="p">,</span> <span class="n">KM_SLEEP</span><span class="p">);</span>
	<span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_afp</span><span class="o">-&gt;</span><span class="n">if_flags</span> <span class="o">=</span> <span class="n">XFS_IFEXTENTS</span><span class="p">;</span>
	<span class="n">logflags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">xfs_bmap_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">flist</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">firstblock</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_d</span><span class="p">.</span><span class="n">di_format</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">XFS_DINODE_FMT_LOCAL</span>:
		<span class="n">error</span> <span class="o">=</span> <span class="n">xfs_bmap_add_attrfork_local</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">ip</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">firstblock</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">flist</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">logflags</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">XFS_DINODE_FMT_EXTENTS</span>:
		<span class="n">error</span> <span class="o">=</span> <span class="n">xfs_bmap_add_attrfork_extents</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">ip</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">firstblock</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">flist</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">logflags</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">XFS_DINODE_FMT_BTREE</span>:
		<span class="n">error</span> <span class="o">=</span> <span class="n">xfs_bmap_add_attrfork_btree</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">ip</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">firstblock</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">flist</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">logflags</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">error</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">logflags</span><span class="p">)</span>
		<span class="n">xfs_trans_log_inode</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">ip</span><span class="p">,</span> <span class="n">logflags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error2</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">xfs_sb_version_hasattr</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_sb</span><span class="p">)</span> <span class="o">||</span>
	   <span class="p">(</span><span class="o">!</span><span class="n">xfs_sb_version_hasattr2</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_sb</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">version</span> <span class="o">==</span> <span class="mi">2</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">__int64_t</span> <span class="n">sbfields</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_sb_lock</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">xfs_sb_version_hasattr</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_sb</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">xfs_sb_version_addattr</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_sb</span><span class="p">);</span>
			<span class="n">sbfields</span> <span class="o">|=</span> <span class="n">XFS_SB_VERSIONNUM</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">xfs_sb_version_hasattr2</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_sb</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">version</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">xfs_sb_version_addattr2</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_sb</span><span class="p">);</span>
			<span class="n">sbfields</span> <span class="o">|=</span> <span class="p">(</span><span class="n">XFS_SB_VERSIONNUM</span> <span class="o">|</span> <span class="n">XFS_SB_FEATURES2</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sbfields</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_sb_lock</span><span class="p">);</span>
			<span class="n">xfs_mod_sb</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">sbfields</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_sb_lock</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">error</span> <span class="o">=</span> <span class="n">xfs_bmap_finish</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">flist</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">committed</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error2</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">xfs_trans_commit</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">XFS_TRANS_RELEASE_LOG_RES</span><span class="p">);</span>
<span class="nl">error2:</span>
	<span class="n">xfs_bmap_cancel</span><span class="p">(</span><span class="o">&amp;</span><span class="n">flist</span><span class="p">);</span>
<span class="nl">error1:</span>
	<span class="n">xfs_iunlock</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">XFS_ILOCK_EXCL</span><span class="p">);</span>
<span class="nl">error0:</span>
	<span class="n">xfs_trans_cancel</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">XFS_TRANS_RELEASE_LOG_RES</span><span class="o">|</span><span class="n">XFS_TRANS_ABORT</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Add the extent to the list of extents to be free at transaction end.</span>
<span class="cm"> * The list is maintained sorted (by block number).</span>
<span class="cm"> */</span>
<span class="cm">/* ARGSUSED */</span>
<span class="kt">void</span>
<span class="n">xfs_bmap_add_free</span><span class="p">(</span>
	<span class="n">xfs_fsblock_t</span>		<span class="n">bno</span><span class="p">,</span>		<span class="cm">/* fs block number of extent */</span>
	<span class="n">xfs_filblks_t</span>		<span class="n">len</span><span class="p">,</span>		<span class="cm">/* length of extent */</span>
	<span class="n">xfs_bmap_free_t</span>		<span class="o">*</span><span class="n">flist</span><span class="p">,</span>		<span class="cm">/* list of extents */</span>
	<span class="n">xfs_mount_t</span>		<span class="o">*</span><span class="n">mp</span><span class="p">)</span>		<span class="cm">/* mount point structure */</span>
<span class="p">{</span>
	<span class="n">xfs_bmap_free_item_t</span>	<span class="o">*</span><span class="n">cur</span><span class="p">;</span>		<span class="cm">/* current (next) element */</span>
	<span class="n">xfs_bmap_free_item_t</span>	<span class="o">*</span><span class="n">new</span><span class="p">;</span>		<span class="cm">/* new element */</span>
	<span class="n">xfs_bmap_free_item_t</span>	<span class="o">*</span><span class="n">prev</span><span class="p">;</span>		<span class="cm">/* previous element */</span>
<span class="cp">#ifdef DEBUG</span>
	<span class="n">xfs_agnumber_t</span>		<span class="n">agno</span><span class="p">;</span>
	<span class="n">xfs_agblock_t</span>		<span class="n">agbno</span><span class="p">;</span>

	<span class="n">ASSERT</span><span class="p">(</span><span class="n">bno</span> <span class="o">!=</span> <span class="n">NULLFSBLOCK</span><span class="p">);</span>
	<span class="n">ASSERT</span><span class="p">(</span><span class="n">len</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">ASSERT</span><span class="p">(</span><span class="n">len</span> <span class="o">&lt;=</span> <span class="n">MAXEXTLEN</span><span class="p">);</span>
	<span class="n">ASSERT</span><span class="p">(</span><span class="o">!</span><span class="n">isnullstartblock</span><span class="p">(</span><span class="n">bno</span><span class="p">));</span>
	<span class="n">agno</span> <span class="o">=</span> <span class="n">XFS_FSB_TO_AGNO</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="n">bno</span><span class="p">);</span>
	<span class="n">agbno</span> <span class="o">=</span> <span class="n">XFS_FSB_TO_AGBNO</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="n">bno</span><span class="p">);</span>
	<span class="n">ASSERT</span><span class="p">(</span><span class="n">agno</span> <span class="o">&lt;</span> <span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_sb</span><span class="p">.</span><span class="n">sb_agcount</span><span class="p">);</span>
	<span class="n">ASSERT</span><span class="p">(</span><span class="n">agbno</span> <span class="o">&lt;</span> <span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_sb</span><span class="p">.</span><span class="n">sb_agblocks</span><span class="p">);</span>
	<span class="n">ASSERT</span><span class="p">(</span><span class="n">len</span> <span class="o">&lt;</span> <span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_sb</span><span class="p">.</span><span class="n">sb_agblocks</span><span class="p">);</span>
	<span class="n">ASSERT</span><span class="p">(</span><span class="n">agbno</span> <span class="o">+</span> <span class="n">len</span> <span class="o">&lt;=</span> <span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_sb</span><span class="p">.</span><span class="n">sb_agblocks</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="n">ASSERT</span><span class="p">(</span><span class="n">xfs_bmap_free_item_zone</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">new</span> <span class="o">=</span> <span class="n">kmem_zone_alloc</span><span class="p">(</span><span class="n">xfs_bmap_free_item_zone</span><span class="p">,</span> <span class="n">KM_SLEEP</span><span class="p">);</span>
	<span class="n">new</span><span class="o">-&gt;</span><span class="n">xbfi_startblock</span> <span class="o">=</span> <span class="n">bno</span><span class="p">;</span>
	<span class="n">new</span><span class="o">-&gt;</span><span class="n">xbfi_blockcount</span> <span class="o">=</span> <span class="p">(</span><span class="n">xfs_extlen_t</span><span class="p">)</span><span class="n">len</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">prev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">cur</span> <span class="o">=</span> <span class="n">flist</span><span class="o">-&gt;</span><span class="n">xbf_first</span><span class="p">;</span>
	     <span class="n">cur</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">;</span>
	     <span class="n">prev</span> <span class="o">=</span> <span class="n">cur</span><span class="p">,</span> <span class="n">cur</span> <span class="o">=</span> <span class="n">cur</span><span class="o">-&gt;</span><span class="n">xbfi_next</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">xbfi_startblock</span> <span class="o">&gt;=</span> <span class="n">bno</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">prev</span><span class="p">)</span>
		<span class="n">prev</span><span class="o">-&gt;</span><span class="n">xbfi_next</span> <span class="o">=</span> <span class="n">new</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">flist</span><span class="o">-&gt;</span><span class="n">xbf_first</span> <span class="o">=</span> <span class="n">new</span><span class="p">;</span>
	<span class="n">new</span><span class="o">-&gt;</span><span class="n">xbfi_next</span> <span class="o">=</span> <span class="n">cur</span><span class="p">;</span>
	<span class="n">flist</span><span class="o">-&gt;</span><span class="n">xbf_count</span><span class="o">++</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Compute and fill in the value of the maximum depth of a bmap btree</span>
<span class="cm"> * in this filesystem.  Done once, during mount.</span>
<span class="cm"> */</span>
<span class="kt">void</span>
<span class="n">xfs_bmap_compute_maxlevels</span><span class="p">(</span>
	<span class="n">xfs_mount_t</span>	<span class="o">*</span><span class="n">mp</span><span class="p">,</span>		<span class="cm">/* file system mount structure */</span>
	<span class="kt">int</span>		<span class="n">whichfork</span><span class="p">)</span>	<span class="cm">/* data or attr fork */</span>
<span class="p">{</span>
	<span class="kt">int</span>		<span class="n">level</span><span class="p">;</span>		<span class="cm">/* btree level */</span>
	<span class="n">uint</span>		<span class="n">maxblocks</span><span class="p">;</span>	<span class="cm">/* max blocks at this level */</span>
	<span class="n">uint</span>		<span class="n">maxleafents</span><span class="p">;</span>	<span class="cm">/* max leaf entries possible */</span>
	<span class="kt">int</span>		<span class="n">maxrootrecs</span><span class="p">;</span>	<span class="cm">/* max records in root block */</span>
	<span class="kt">int</span>		<span class="n">minleafrecs</span><span class="p">;</span>	<span class="cm">/* min records in leaf block */</span>
	<span class="kt">int</span>		<span class="n">minnoderecs</span><span class="p">;</span>	<span class="cm">/* min records in node block */</span>
	<span class="kt">int</span>		<span class="n">sz</span><span class="p">;</span>		<span class="cm">/* root block size */</span>

	<span class="cm">/*</span>
<span class="cm">	 * The maximum number of extents in a file, hence the maximum</span>
<span class="cm">	 * number of leaf entries, is controlled by the type of di_nextents</span>
<span class="cm">	 * (a signed 32-bit number, xfs_extnum_t), or by di_anextents</span>
<span class="cm">	 * (a signed 16-bit number, xfs_aextnum_t).</span>
<span class="cm">	 *</span>
<span class="cm">	 * Note that we can no longer assume that if we are in ATTR1 that</span>
<span class="cm">	 * the fork offset of all the inodes will be</span>
<span class="cm">	 * (xfs_default_attroffset(ip) &gt;&gt; 3) because we could have mounted</span>
<span class="cm">	 * with ATTR2 and then mounted back with ATTR1, keeping the</span>
<span class="cm">	 * di_forkoff&#39;s fixed but probably at various positions. Therefore,</span>
<span class="cm">	 * for both ATTR1 and ATTR2 we have to assume the worst case scenario</span>
<span class="cm">	 * of a minimum size available.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">whichfork</span> <span class="o">==</span> <span class="n">XFS_DATA_FORK</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">maxleafents</span> <span class="o">=</span> <span class="n">MAXEXTNUM</span><span class="p">;</span>
		<span class="n">sz</span> <span class="o">=</span> <span class="n">XFS_BMDR_SPACE_CALC</span><span class="p">(</span><span class="n">MINDBTPTRS</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">maxleafents</span> <span class="o">=</span> <span class="n">MAXAEXTNUM</span><span class="p">;</span>
		<span class="n">sz</span> <span class="o">=</span> <span class="n">XFS_BMDR_SPACE_CALC</span><span class="p">(</span><span class="n">MINABTPTRS</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">maxrootrecs</span> <span class="o">=</span> <span class="n">xfs_bmdr_maxrecs</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="n">sz</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">minleafrecs</span> <span class="o">=</span> <span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_bmap_dmnr</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">minnoderecs</span> <span class="o">=</span> <span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_bmap_dmnr</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="n">maxblocks</span> <span class="o">=</span> <span class="p">(</span><span class="n">maxleafents</span> <span class="o">+</span> <span class="n">minleafrecs</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="n">minleafrecs</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">level</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">maxblocks</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">;</span> <span class="n">level</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">maxblocks</span> <span class="o">&lt;=</span> <span class="n">maxrootrecs</span><span class="p">)</span>
			<span class="n">maxblocks</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">maxblocks</span> <span class="o">=</span> <span class="p">(</span><span class="n">maxblocks</span> <span class="o">+</span> <span class="n">minnoderecs</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="n">minnoderecs</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_bm_maxlevels</span><span class="p">[</span><span class="n">whichfork</span><span class="p">]</span> <span class="o">=</span> <span class="n">level</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Routine to be called at transaction&#39;s end by xfs_bmapi, xfs_bunmapi</span>
<span class="cm"> * caller.  Frees all the extents that need freeing, which must be done</span>
<span class="cm"> * last due to locking considerations.  We never free any extents in</span>
<span class="cm"> * the first transaction.</span>
<span class="cm"> *</span>
<span class="cm"> * Return 1 if the given transaction was committed and a new one</span>
<span class="cm"> * started, and 0 otherwise in the committed parameter.</span>
<span class="cm"> */</span>
<span class="kt">int</span>						<span class="cm">/* error */</span>
<span class="n">xfs_bmap_finish</span><span class="p">(</span>
	<span class="n">xfs_trans_t</span>		<span class="o">**</span><span class="n">tp</span><span class="p">,</span>		<span class="cm">/* transaction pointer addr */</span>
	<span class="n">xfs_bmap_free_t</span>		<span class="o">*</span><span class="n">flist</span><span class="p">,</span>		<span class="cm">/* i/o: list extents to free */</span>
	<span class="kt">int</span>			<span class="o">*</span><span class="n">committed</span><span class="p">)</span>	<span class="cm">/* xact committed or not */</span>
<span class="p">{</span>
	<span class="n">xfs_efd_log_item_t</span>	<span class="o">*</span><span class="n">efd</span><span class="p">;</span>		<span class="cm">/* extent free data */</span>
	<span class="n">xfs_efi_log_item_t</span>	<span class="o">*</span><span class="n">efi</span><span class="p">;</span>		<span class="cm">/* extent free intention */</span>
	<span class="kt">int</span>			<span class="n">error</span><span class="p">;</span>		<span class="cm">/* error return value */</span>
	<span class="n">xfs_bmap_free_item_t</span>	<span class="o">*</span><span class="n">free</span><span class="p">;</span>		<span class="cm">/* free extent item */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>		<span class="n">logres</span><span class="p">;</span>		<span class="cm">/* new log reservation */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>		<span class="n">logcount</span><span class="p">;</span>	<span class="cm">/* new log count */</span>
	<span class="n">xfs_mount_t</span>		<span class="o">*</span><span class="n">mp</span><span class="p">;</span>		<span class="cm">/* filesystem mount structure */</span>
	<span class="n">xfs_bmap_free_item_t</span>	<span class="o">*</span><span class="n">next</span><span class="p">;</span>		<span class="cm">/* next item on free list */</span>
	<span class="n">xfs_trans_t</span>		<span class="o">*</span><span class="n">ntp</span><span class="p">;</span>		<span class="cm">/* new transaction pointer */</span>

	<span class="n">ASSERT</span><span class="p">((</span><span class="o">*</span><span class="n">tp</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">t_flags</span> <span class="o">&amp;</span> <span class="n">XFS_TRANS_PERM_LOG_RES</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">flist</span><span class="o">-&gt;</span><span class="n">xbf_count</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">committed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ntp</span> <span class="o">=</span> <span class="o">*</span><span class="n">tp</span><span class="p">;</span>
	<span class="n">efi</span> <span class="o">=</span> <span class="n">xfs_trans_get_efi</span><span class="p">(</span><span class="n">ntp</span><span class="p">,</span> <span class="n">flist</span><span class="o">-&gt;</span><span class="n">xbf_count</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">free</span> <span class="o">=</span> <span class="n">flist</span><span class="o">-&gt;</span><span class="n">xbf_first</span><span class="p">;</span> <span class="n">free</span><span class="p">;</span> <span class="n">free</span> <span class="o">=</span> <span class="n">free</span><span class="o">-&gt;</span><span class="n">xbfi_next</span><span class="p">)</span>
		<span class="n">xfs_trans_log_efi_extent</span><span class="p">(</span><span class="n">ntp</span><span class="p">,</span> <span class="n">efi</span><span class="p">,</span> <span class="n">free</span><span class="o">-&gt;</span><span class="n">xbfi_startblock</span><span class="p">,</span>
			<span class="n">free</span><span class="o">-&gt;</span><span class="n">xbfi_blockcount</span><span class="p">);</span>
	<span class="n">logres</span> <span class="o">=</span> <span class="n">ntp</span><span class="o">-&gt;</span><span class="n">t_log_res</span><span class="p">;</span>
	<span class="n">logcount</span> <span class="o">=</span> <span class="n">ntp</span><span class="o">-&gt;</span><span class="n">t_log_count</span><span class="p">;</span>
	<span class="n">ntp</span> <span class="o">=</span> <span class="n">xfs_trans_dup</span><span class="p">(</span><span class="o">*</span><span class="n">tp</span><span class="p">);</span>
	<span class="n">error</span> <span class="o">=</span> <span class="n">xfs_trans_commit</span><span class="p">(</span><span class="o">*</span><span class="n">tp</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="o">*</span><span class="n">tp</span> <span class="o">=</span> <span class="n">ntp</span><span class="p">;</span>
	<span class="o">*</span><span class="n">committed</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * We have a new transaction, so we should return committed=1,</span>
<span class="cm">	 * even though we&#39;re returning an error.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">error</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * transaction commit worked ok so we can drop the extra ticket</span>
<span class="cm">	 * reference that we gained in xfs_trans_dup()</span>
<span class="cm">	 */</span>
	<span class="n">xfs_log_ticket_put</span><span class="p">(</span><span class="n">ntp</span><span class="o">-&gt;</span><span class="n">t_ticket</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">error</span> <span class="o">=</span> <span class="n">xfs_trans_reserve</span><span class="p">(</span><span class="n">ntp</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">logres</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">XFS_TRANS_PERM_LOG_RES</span><span class="p">,</span>
			<span class="n">logcount</span><span class="p">)))</span>
		<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">efd</span> <span class="o">=</span> <span class="n">xfs_trans_get_efd</span><span class="p">(</span><span class="n">ntp</span><span class="p">,</span> <span class="n">efi</span><span class="p">,</span> <span class="n">flist</span><span class="o">-&gt;</span><span class="n">xbf_count</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">free</span> <span class="o">=</span> <span class="n">flist</span><span class="o">-&gt;</span><span class="n">xbf_first</span><span class="p">;</span> <span class="n">free</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">;</span> <span class="n">free</span> <span class="o">=</span> <span class="n">next</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">next</span> <span class="o">=</span> <span class="n">free</span><span class="o">-&gt;</span><span class="n">xbfi_next</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">error</span> <span class="o">=</span> <span class="n">xfs_free_extent</span><span class="p">(</span><span class="n">ntp</span><span class="p">,</span> <span class="n">free</span><span class="o">-&gt;</span><span class="n">xbfi_startblock</span><span class="p">,</span>
				<span class="n">free</span><span class="o">-&gt;</span><span class="n">xbfi_blockcount</span><span class="p">)))</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * The bmap free list will be cleaned up at a</span>
<span class="cm">			 * higher level.  The EFI will be canceled when</span>
<span class="cm">			 * this transaction is aborted.</span>
<span class="cm">			 * Need to force shutdown here to make sure it</span>
<span class="cm">			 * happens, since this transaction may not be</span>
<span class="cm">			 * dirty yet.</span>
<span class="cm">			 */</span>
			<span class="n">mp</span> <span class="o">=</span> <span class="n">ntp</span><span class="o">-&gt;</span><span class="n">t_mountp</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">XFS_FORCED_SHUTDOWN</span><span class="p">(</span><span class="n">mp</span><span class="p">))</span>
				<span class="n">xfs_force_shutdown</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span>
						   <span class="p">(</span><span class="n">error</span> <span class="o">==</span> <span class="n">EFSCORRUPTED</span><span class="p">)</span> <span class="o">?</span>
						   <span class="n">SHUTDOWN_CORRUPT_INCORE</span> <span class="o">:</span>
						   <span class="n">SHUTDOWN_META_IO_ERROR</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">xfs_trans_log_efd_extent</span><span class="p">(</span><span class="n">ntp</span><span class="p">,</span> <span class="n">efd</span><span class="p">,</span> <span class="n">free</span><span class="o">-&gt;</span><span class="n">xbfi_startblock</span><span class="p">,</span>
			<span class="n">free</span><span class="o">-&gt;</span><span class="n">xbfi_blockcount</span><span class="p">);</span>
		<span class="n">xfs_bmap_del_free</span><span class="p">(</span><span class="n">flist</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">free</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Free up any items left in the list.</span>
<span class="cm"> */</span>
<span class="kt">void</span>
<span class="n">xfs_bmap_cancel</span><span class="p">(</span>
	<span class="n">xfs_bmap_free_t</span>		<span class="o">*</span><span class="n">flist</span><span class="p">)</span>	<span class="cm">/* list of bmap_free_items */</span>
<span class="p">{</span>
	<span class="n">xfs_bmap_free_item_t</span>	<span class="o">*</span><span class="n">free</span><span class="p">;</span>	<span class="cm">/* free list item */</span>
	<span class="n">xfs_bmap_free_item_t</span>	<span class="o">*</span><span class="n">next</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">flist</span><span class="o">-&gt;</span><span class="n">xbf_count</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">ASSERT</span><span class="p">(</span><span class="n">flist</span><span class="o">-&gt;</span><span class="n">xbf_first</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">free</span> <span class="o">=</span> <span class="n">flist</span><span class="o">-&gt;</span><span class="n">xbf_first</span><span class="p">;</span> <span class="n">free</span><span class="p">;</span> <span class="n">free</span> <span class="o">=</span> <span class="n">next</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">next</span> <span class="o">=</span> <span class="n">free</span><span class="o">-&gt;</span><span class="n">xbfi_next</span><span class="p">;</span>
		<span class="n">xfs_bmap_del_free</span><span class="p">(</span><span class="n">flist</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">free</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">ASSERT</span><span class="p">(</span><span class="n">flist</span><span class="o">-&gt;</span><span class="n">xbf_count</span> <span class="o">==</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Returns the file-relative block number of the first unused block(s)</span>
<span class="cm"> * in the file with at least &quot;len&quot; logically contiguous blocks free.</span>
<span class="cm"> * This is the lowest-address hole if the file has holes, else the first block</span>
<span class="cm"> * past the end of file.</span>
<span class="cm"> * Return 0 if the file is currently local (in-inode).</span>
<span class="cm"> */</span>
<span class="kt">int</span>						<span class="cm">/* error */</span>
<span class="n">xfs_bmap_first_unused</span><span class="p">(</span>
	<span class="n">xfs_trans_t</span>	<span class="o">*</span><span class="n">tp</span><span class="p">,</span>			<span class="cm">/* transaction pointer */</span>
	<span class="n">xfs_inode_t</span>	<span class="o">*</span><span class="n">ip</span><span class="p">,</span>			<span class="cm">/* incore inode */</span>
	<span class="n">xfs_extlen_t</span>	<span class="n">len</span><span class="p">,</span>			<span class="cm">/* size of hole to find */</span>
	<span class="n">xfs_fileoff_t</span>	<span class="o">*</span><span class="n">first_unused</span><span class="p">,</span>		<span class="cm">/* unused block */</span>
	<span class="kt">int</span>		<span class="n">whichfork</span><span class="p">)</span>		<span class="cm">/* data or attr fork */</span>
<span class="p">{</span>
	<span class="kt">int</span>		<span class="n">error</span><span class="p">;</span>			<span class="cm">/* error return value */</span>
	<span class="kt">int</span>		<span class="n">idx</span><span class="p">;</span>			<span class="cm">/* extent record index */</span>
	<span class="n">xfs_ifork_t</span>	<span class="o">*</span><span class="n">ifp</span><span class="p">;</span>			<span class="cm">/* inode fork pointer */</span>
	<span class="n">xfs_fileoff_t</span>	<span class="n">lastaddr</span><span class="p">;</span>		<span class="cm">/* last block number seen */</span>
	<span class="n">xfs_fileoff_t</span>	<span class="n">lowest</span><span class="p">;</span>			<span class="cm">/* lowest useful block */</span>
	<span class="n">xfs_fileoff_t</span>	<span class="n">max</span><span class="p">;</span>			<span class="cm">/* starting useful block */</span>
	<span class="n">xfs_fileoff_t</span>	<span class="n">off</span><span class="p">;</span>			<span class="cm">/* offset for this block */</span>
	<span class="n">xfs_extnum_t</span>	<span class="n">nextents</span><span class="p">;</span>		<span class="cm">/* number of extent entries */</span>

	<span class="n">ASSERT</span><span class="p">(</span><span class="n">XFS_IFORK_FORMAT</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">whichfork</span><span class="p">)</span> <span class="o">==</span> <span class="n">XFS_DINODE_FMT_BTREE</span> <span class="o">||</span>
	       <span class="n">XFS_IFORK_FORMAT</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">whichfork</span><span class="p">)</span> <span class="o">==</span> <span class="n">XFS_DINODE_FMT_EXTENTS</span> <span class="o">||</span>
	       <span class="n">XFS_IFORK_FORMAT</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">whichfork</span><span class="p">)</span> <span class="o">==</span> <span class="n">XFS_DINODE_FMT_LOCAL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">XFS_IFORK_FORMAT</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">whichfork</span><span class="p">)</span> <span class="o">==</span> <span class="n">XFS_DINODE_FMT_LOCAL</span><span class="p">)</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">first_unused</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ifp</span> <span class="o">=</span> <span class="n">XFS_IFORK_PTR</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">whichfork</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ifp</span><span class="o">-&gt;</span><span class="n">if_flags</span> <span class="o">&amp;</span> <span class="n">XFS_IFEXTENTS</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">error</span> <span class="o">=</span> <span class="n">xfs_iread_extents</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">ip</span><span class="p">,</span> <span class="n">whichfork</span><span class="p">)))</span>
		<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">lowest</span> <span class="o">=</span> <span class="o">*</span><span class="n">first_unused</span><span class="p">;</span>
	<span class="n">nextents</span> <span class="o">=</span> <span class="n">ifp</span><span class="o">-&gt;</span><span class="n">if_bytes</span> <span class="o">/</span> <span class="p">(</span><span class="n">uint</span><span class="p">)</span><span class="k">sizeof</span><span class="p">(</span><span class="n">xfs_bmbt_rec_t</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">lastaddr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">max</span> <span class="o">=</span> <span class="n">lowest</span><span class="p">;</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="n">nextents</span><span class="p">;</span> <span class="n">idx</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">xfs_bmbt_rec_host_t</span> <span class="o">*</span><span class="n">ep</span> <span class="o">=</span> <span class="n">xfs_iext_get_ext</span><span class="p">(</span><span class="n">ifp</span><span class="p">,</span> <span class="n">idx</span><span class="p">);</span>
		<span class="n">off</span> <span class="o">=</span> <span class="n">xfs_bmbt_get_startoff</span><span class="p">(</span><span class="n">ep</span><span class="p">);</span>
		<span class="cm">/*</span>
<span class="cm">		 * See if the hole before this extent will work.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">off</span> <span class="o">&gt;=</span> <span class="n">lowest</span> <span class="o">+</span> <span class="n">len</span> <span class="o">&amp;&amp;</span> <span class="n">off</span> <span class="o">-</span> <span class="n">max</span> <span class="o">&gt;=</span> <span class="n">len</span><span class="p">)</span> <span class="p">{</span>
			<span class="o">*</span><span class="n">first_unused</span> <span class="o">=</span> <span class="n">max</span><span class="p">;</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">lastaddr</span> <span class="o">=</span> <span class="n">off</span> <span class="o">+</span> <span class="n">xfs_bmbt_get_blockcount</span><span class="p">(</span><span class="n">ep</span><span class="p">);</span>
		<span class="n">max</span> <span class="o">=</span> <span class="n">XFS_FILEOFF_MAX</span><span class="p">(</span><span class="n">lastaddr</span><span class="p">,</span> <span class="n">lowest</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="o">*</span><span class="n">first_unused</span> <span class="o">=</span> <span class="n">max</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Returns the file-relative block number of the last block + 1 before</span>
<span class="cm"> * last_block (input value) in the file.</span>
<span class="cm"> * This is not based on i_size, it is based on the extent records.</span>
<span class="cm"> * Returns 0 for local files, as they do not have extent records.</span>
<span class="cm"> */</span>
<span class="kt">int</span>						<span class="cm">/* error */</span>
<span class="n">xfs_bmap_last_before</span><span class="p">(</span>
	<span class="n">xfs_trans_t</span>	<span class="o">*</span><span class="n">tp</span><span class="p">,</span>			<span class="cm">/* transaction pointer */</span>
	<span class="n">xfs_inode_t</span>	<span class="o">*</span><span class="n">ip</span><span class="p">,</span>			<span class="cm">/* incore inode */</span>
	<span class="n">xfs_fileoff_t</span>	<span class="o">*</span><span class="n">last_block</span><span class="p">,</span>		<span class="cm">/* last block */</span>
	<span class="kt">int</span>		<span class="n">whichfork</span><span class="p">)</span>		<span class="cm">/* data or attr fork */</span>
<span class="p">{</span>
	<span class="n">xfs_fileoff_t</span>	<span class="n">bno</span><span class="p">;</span>			<span class="cm">/* input file offset */</span>
	<span class="kt">int</span>		<span class="n">eof</span><span class="p">;</span>			<span class="cm">/* hit end of file */</span>
	<span class="n">xfs_bmbt_rec_host_t</span> <span class="o">*</span><span class="n">ep</span><span class="p">;</span>		<span class="cm">/* pointer to last extent */</span>
	<span class="kt">int</span>		<span class="n">error</span><span class="p">;</span>			<span class="cm">/* error return value */</span>
	<span class="n">xfs_bmbt_irec_t</span>	<span class="n">got</span><span class="p">;</span>			<span class="cm">/* current extent value */</span>
	<span class="n">xfs_ifork_t</span>	<span class="o">*</span><span class="n">ifp</span><span class="p">;</span>			<span class="cm">/* inode fork pointer */</span>
	<span class="n">xfs_extnum_t</span>	<span class="n">lastx</span><span class="p">;</span>			<span class="cm">/* last extent used */</span>
	<span class="n">xfs_bmbt_irec_t</span>	<span class="n">prev</span><span class="p">;</span>			<span class="cm">/* previous extent value */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">XFS_IFORK_FORMAT</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">whichfork</span><span class="p">)</span> <span class="o">!=</span> <span class="n">XFS_DINODE_FMT_BTREE</span> <span class="o">&amp;&amp;</span>
	    <span class="n">XFS_IFORK_FORMAT</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">whichfork</span><span class="p">)</span> <span class="o">!=</span> <span class="n">XFS_DINODE_FMT_EXTENTS</span> <span class="o">&amp;&amp;</span>
	    <span class="n">XFS_IFORK_FORMAT</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">whichfork</span><span class="p">)</span> <span class="o">!=</span> <span class="n">XFS_DINODE_FMT_LOCAL</span><span class="p">)</span>
	       <span class="k">return</span> <span class="n">XFS_ERROR</span><span class="p">(</span><span class="n">EIO</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">XFS_IFORK_FORMAT</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">whichfork</span><span class="p">)</span> <span class="o">==</span> <span class="n">XFS_DINODE_FMT_LOCAL</span><span class="p">)</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">last_block</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ifp</span> <span class="o">=</span> <span class="n">XFS_IFORK_PTR</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">whichfork</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ifp</span><span class="o">-&gt;</span><span class="n">if_flags</span> <span class="o">&amp;</span> <span class="n">XFS_IFEXTENTS</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">error</span> <span class="o">=</span> <span class="n">xfs_iread_extents</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">ip</span><span class="p">,</span> <span class="n">whichfork</span><span class="p">)))</span>
		<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">bno</span> <span class="o">=</span> <span class="o">*</span><span class="n">last_block</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">ep</span> <span class="o">=</span> <span class="n">xfs_bmap_search_extents</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">bno</span><span class="p">,</span> <span class="n">whichfork</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">eof</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">lastx</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">got</span><span class="p">,</span>
		<span class="o">&amp;</span><span class="n">prev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">eof</span> <span class="o">||</span> <span class="n">xfs_bmbt_get_startoff</span><span class="p">(</span><span class="n">ep</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">bno</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">prev</span><span class="p">.</span><span class="n">br_startoff</span> <span class="o">==</span> <span class="n">NULLFILEOFF</span><span class="p">)</span>
			<span class="o">*</span><span class="n">last_block</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="o">*</span><span class="n">last_block</span> <span class="o">=</span> <span class="n">prev</span><span class="p">.</span><span class="n">br_startoff</span> <span class="o">+</span> <span class="n">prev</span><span class="p">.</span><span class="n">br_blockcount</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/*</span>
<span class="cm">	 * Otherwise *last_block is already the right answer.</span>
<span class="cm">	 */</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">STATIC</span> <span class="kt">int</span>
<span class="n">xfs_bmap_last_extent</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">xfs_trans</span>	<span class="o">*</span><span class="n">tp</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">xfs_inode</span>	<span class="o">*</span><span class="n">ip</span><span class="p">,</span>
	<span class="kt">int</span>			<span class="n">whichfork</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">xfs_bmbt_irec</span>	<span class="o">*</span><span class="n">rec</span><span class="p">,</span>
	<span class="kt">int</span>			<span class="o">*</span><span class="n">is_empty</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">xfs_ifork</span>	<span class="o">*</span><span class="n">ifp</span> <span class="o">=</span> <span class="n">XFS_IFORK_PTR</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">whichfork</span><span class="p">);</span>
	<span class="kt">int</span>			<span class="n">error</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">nextents</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ifp</span><span class="o">-&gt;</span><span class="n">if_flags</span> <span class="o">&amp;</span> <span class="n">XFS_IFEXTENTS</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">error</span> <span class="o">=</span> <span class="n">xfs_iread_extents</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">ip</span><span class="p">,</span> <span class="n">whichfork</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">nextents</span> <span class="o">=</span> <span class="n">ifp</span><span class="o">-&gt;</span><span class="n">if_bytes</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">xfs_bmbt_rec_t</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nextents</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">is_empty</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">xfs_bmbt_get_all</span><span class="p">(</span><span class="n">xfs_iext_get_ext</span><span class="p">(</span><span class="n">ifp</span><span class="p">,</span> <span class="n">nextents</span> <span class="o">-</span> <span class="mi">1</span><span class="p">),</span> <span class="n">rec</span><span class="p">);</span>
	<span class="o">*</span><span class="n">is_empty</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Check the last inode extent to determine whether this allocation will result</span>
<span class="cm"> * in blocks being allocated at the end of the file. When we allocate new data</span>
<span class="cm"> * blocks at the end of the file which do not start at the previous data block,</span>
<span class="cm"> * we will try to align the new blocks at stripe unit boundaries.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns 0 in bma-&gt;aeof if the file (fork) is empty as any new write will be</span>
<span class="cm"> * at, or past the EOF.</span>
<span class="cm"> */</span>
<span class="n">STATIC</span> <span class="kt">int</span>
<span class="n">xfs_bmap_isaeof</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">xfs_bmalloca</span>	<span class="o">*</span><span class="n">bma</span><span class="p">,</span>
	<span class="kt">int</span>			<span class="n">whichfork</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">xfs_bmbt_irec</span>	<span class="n">rec</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">is_empty</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">error</span><span class="p">;</span>

	<span class="n">bma</span><span class="o">-&gt;</span><span class="n">aeof</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">error</span> <span class="o">=</span> <span class="n">xfs_bmap_last_extent</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">bma</span><span class="o">-&gt;</span><span class="n">ip</span><span class="p">,</span> <span class="n">whichfork</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rec</span><span class="p">,</span>
				     <span class="o">&amp;</span><span class="n">is_empty</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span> <span class="o">||</span> <span class="n">is_empty</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">error</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Check if we are allocation or past the last extent, or at least into</span>
<span class="cm">	 * the last delayed allocated extent.</span>
<span class="cm">	 */</span>
	<span class="n">bma</span><span class="o">-&gt;</span><span class="n">aeof</span> <span class="o">=</span> <span class="n">bma</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">&gt;=</span> <span class="n">rec</span><span class="p">.</span><span class="n">br_startoff</span> <span class="o">+</span> <span class="n">rec</span><span class="p">.</span><span class="n">br_blockcount</span> <span class="o">||</span>
		<span class="p">(</span><span class="n">bma</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">&gt;=</span> <span class="n">rec</span><span class="p">.</span><span class="n">br_startoff</span> <span class="o">&amp;&amp;</span>
		 <span class="n">isnullstartblock</span><span class="p">(</span><span class="n">rec</span><span class="p">.</span><span class="n">br_startblock</span><span class="p">));</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Check if the endoff is outside the last extent. If so the caller will grow</span>
<span class="cm"> * the allocation to a stripe unit boundary.  All offsets are considered outside</span>
<span class="cm"> * the end of file for an empty fork, so 1 is returned in *eof in that case.</span>
<span class="cm"> */</span>
<span class="kt">int</span>
<span class="n">xfs_bmap_eof</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">xfs_inode</span>	<span class="o">*</span><span class="n">ip</span><span class="p">,</span>
	<span class="n">xfs_fileoff_t</span>		<span class="n">endoff</span><span class="p">,</span>
	<span class="kt">int</span>			<span class="n">whichfork</span><span class="p">,</span>
	<span class="kt">int</span>			<span class="o">*</span><span class="n">eof</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">xfs_bmbt_irec</span>	<span class="n">rec</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">error</span><span class="p">;</span>

	<span class="n">error</span> <span class="o">=</span> <span class="n">xfs_bmap_last_extent</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">ip</span><span class="p">,</span> <span class="n">whichfork</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rec</span><span class="p">,</span> <span class="n">eof</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span> <span class="o">||</span> <span class="o">*</span><span class="n">eof</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">error</span><span class="p">;</span>

	<span class="o">*</span><span class="n">eof</span> <span class="o">=</span> <span class="n">endoff</span> <span class="o">&gt;=</span> <span class="n">rec</span><span class="p">.</span><span class="n">br_startoff</span> <span class="o">+</span> <span class="n">rec</span><span class="p">.</span><span class="n">br_blockcount</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Returns the file-relative block number of the first block past eof in</span>
<span class="cm"> * the file.  This is not based on i_size, it is based on the extent records.</span>
<span class="cm"> * Returns 0 for local files, as they do not have extent records.</span>
<span class="cm"> */</span>
<span class="kt">int</span>
<span class="n">xfs_bmap_last_offset</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">xfs_trans</span>	<span class="o">*</span><span class="n">tp</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">xfs_inode</span>	<span class="o">*</span><span class="n">ip</span><span class="p">,</span>
	<span class="n">xfs_fileoff_t</span>		<span class="o">*</span><span class="n">last_block</span><span class="p">,</span>
	<span class="kt">int</span>			<span class="n">whichfork</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">xfs_bmbt_irec</span>	<span class="n">rec</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">is_empty</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">error</span><span class="p">;</span>

	<span class="o">*</span><span class="n">last_block</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">XFS_IFORK_FORMAT</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">whichfork</span><span class="p">)</span> <span class="o">==</span> <span class="n">XFS_DINODE_FMT_LOCAL</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">XFS_IFORK_FORMAT</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">whichfork</span><span class="p">)</span> <span class="o">!=</span> <span class="n">XFS_DINODE_FMT_BTREE</span> <span class="o">&amp;&amp;</span>
	    <span class="n">XFS_IFORK_FORMAT</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">whichfork</span><span class="p">)</span> <span class="o">!=</span> <span class="n">XFS_DINODE_FMT_EXTENTS</span><span class="p">)</span>
	       <span class="k">return</span> <span class="n">XFS_ERROR</span><span class="p">(</span><span class="n">EIO</span><span class="p">);</span>

	<span class="n">error</span> <span class="o">=</span> <span class="n">xfs_bmap_last_extent</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">ip</span><span class="p">,</span> <span class="n">whichfork</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rec</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">is_empty</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span> <span class="o">||</span> <span class="n">is_empty</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">error</span><span class="p">;</span>

	<span class="o">*</span><span class="n">last_block</span> <span class="o">=</span> <span class="n">rec</span><span class="p">.</span><span class="n">br_startoff</span> <span class="o">+</span> <span class="n">rec</span><span class="p">.</span><span class="n">br_blockcount</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Returns whether the selected fork of the inode has exactly one</span>
<span class="cm"> * block or not.  For the data fork we check this matches di_size,</span>
<span class="cm"> * implying the file&#39;s range is 0..bsize-1.</span>
<span class="cm"> */</span>
<span class="kt">int</span>					<span class="cm">/* 1=&gt;1 block, 0=&gt;otherwise */</span>
<span class="n">xfs_bmap_one_block</span><span class="p">(</span>
	<span class="n">xfs_inode_t</span>	<span class="o">*</span><span class="n">ip</span><span class="p">,</span>		<span class="cm">/* incore inode */</span>
	<span class="kt">int</span>		<span class="n">whichfork</span><span class="p">)</span>	<span class="cm">/* data or attr fork */</span>
<span class="p">{</span>
	<span class="n">xfs_bmbt_rec_host_t</span> <span class="o">*</span><span class="n">ep</span><span class="p">;</span>	<span class="cm">/* ptr to fork&#39;s extent */</span>
	<span class="n">xfs_ifork_t</span>	<span class="o">*</span><span class="n">ifp</span><span class="p">;</span>		<span class="cm">/* inode fork pointer */</span>
	<span class="kt">int</span>		<span class="n">rval</span><span class="p">;</span>		<span class="cm">/* return value */</span>
	<span class="n">xfs_bmbt_irec_t</span>	<span class="n">s</span><span class="p">;</span>		<span class="cm">/* internal version of extent */</span>

<span class="cp">#ifndef DEBUG</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">whichfork</span> <span class="o">==</span> <span class="n">XFS_DATA_FORK</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">XFS_ISIZE</span><span class="p">(</span><span class="n">ip</span><span class="p">)</span> <span class="o">==</span> <span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_mount</span><span class="o">-&gt;</span><span class="n">m_sb</span><span class="p">.</span><span class="n">sb_blocksize</span><span class="p">;</span>
<span class="cp">#endif	</span><span class="cm">/* !DEBUG */</span><span class="cp"></span>
	<span class="k">if</span> <span class="p">(</span><span class="n">XFS_IFORK_NEXTENTS</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">whichfork</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">XFS_IFORK_FORMAT</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">whichfork</span><span class="p">)</span> <span class="o">!=</span> <span class="n">XFS_DINODE_FMT_EXTENTS</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ifp</span> <span class="o">=</span> <span class="n">XFS_IFORK_PTR</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">whichfork</span><span class="p">);</span>
	<span class="n">ASSERT</span><span class="p">(</span><span class="n">ifp</span><span class="o">-&gt;</span><span class="n">if_flags</span> <span class="o">&amp;</span> <span class="n">XFS_IFEXTENTS</span><span class="p">);</span>
	<span class="n">ep</span> <span class="o">=</span> <span class="n">xfs_iext_get_ext</span><span class="p">(</span><span class="n">ifp</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">xfs_bmbt_get_all</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">s</span><span class="p">);</span>
	<span class="n">rval</span> <span class="o">=</span> <span class="n">s</span><span class="p">.</span><span class="n">br_startoff</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">s</span><span class="p">.</span><span class="n">br_blockcount</span> <span class="o">==</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rval</span> <span class="o">&amp;&amp;</span> <span class="n">whichfork</span> <span class="o">==</span> <span class="n">XFS_DATA_FORK</span><span class="p">)</span>
		<span class="n">ASSERT</span><span class="p">(</span><span class="n">XFS_ISIZE</span><span class="p">(</span><span class="n">ip</span><span class="p">)</span> <span class="o">==</span> <span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_mount</span><span class="o">-&gt;</span><span class="n">m_sb</span><span class="p">.</span><span class="n">sb_blocksize</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rval</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">STATIC</span> <span class="kt">int</span>
<span class="n">xfs_bmap_sanity_check</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">xfs_mount</span>	<span class="o">*</span><span class="n">mp</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">xfs_buf</span>		<span class="o">*</span><span class="n">bp</span><span class="p">,</span>
	<span class="kt">int</span>			<span class="n">level</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">xfs_btree_block</span>  <span class="o">*</span><span class="n">block</span> <span class="o">=</span> <span class="n">XFS_BUF_TO_BLOCK</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">block</span><span class="o">-&gt;</span><span class="n">bb_magic</span> <span class="o">!=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">XFS_BMAP_MAGIC</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">block</span><span class="o">-&gt;</span><span class="n">bb_level</span><span class="p">)</span> <span class="o">!=</span> <span class="n">level</span> <span class="o">||</span>
	    <span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">block</span><span class="o">-&gt;</span><span class="n">bb_numrecs</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span>
	    <span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">block</span><span class="o">-&gt;</span><span class="n">bb_numrecs</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_bmap_dmxr</span><span class="p">[</span><span class="n">level</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">])</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Read in the extents to if_extents.</span>
<span class="cm"> * All inode fields are set up by caller, we just traverse the btree</span>
<span class="cm"> * and copy the records in. If the file system cannot contain unwritten</span>
<span class="cm"> * extents, the records are checked for no &quot;state&quot; flags.</span>
<span class="cm"> */</span>
<span class="kt">int</span>					<span class="cm">/* error */</span>
<span class="n">xfs_bmap_read_extents</span><span class="p">(</span>
	<span class="n">xfs_trans_t</span>		<span class="o">*</span><span class="n">tp</span><span class="p">,</span>	<span class="cm">/* transaction pointer */</span>
	<span class="n">xfs_inode_t</span>		<span class="o">*</span><span class="n">ip</span><span class="p">,</span>	<span class="cm">/* incore inode */</span>
	<span class="kt">int</span>			<span class="n">whichfork</span><span class="p">)</span> <span class="cm">/* data or attr fork */</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">xfs_btree_block</span>	<span class="o">*</span><span class="n">block</span><span class="p">;</span>	<span class="cm">/* current btree block */</span>
	<span class="n">xfs_fsblock_t</span>		<span class="n">bno</span><span class="p">;</span>	<span class="cm">/* block # of &quot;block&quot; */</span>
	<span class="n">xfs_buf_t</span>		<span class="o">*</span><span class="n">bp</span><span class="p">;</span>	<span class="cm">/* buffer for &quot;block&quot; */</span>
	<span class="kt">int</span>			<span class="n">error</span><span class="p">;</span>	<span class="cm">/* error return value */</span>
	<span class="n">xfs_exntfmt_t</span>		<span class="n">exntf</span><span class="p">;</span>	<span class="cm">/* XFS_EXTFMT_NOSTATE, if checking */</span>
	<span class="n">xfs_extnum_t</span>		<span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">;</span>	<span class="cm">/* index into the extents list */</span>
	<span class="n">xfs_ifork_t</span>		<span class="o">*</span><span class="n">ifp</span><span class="p">;</span>	<span class="cm">/* fork structure */</span>
	<span class="kt">int</span>			<span class="n">level</span><span class="p">;</span>	<span class="cm">/* btree level, for checking */</span>
	<span class="n">xfs_mount_t</span>		<span class="o">*</span><span class="n">mp</span><span class="p">;</span>	<span class="cm">/* file system mount structure */</span>
	<span class="n">__be64</span>			<span class="o">*</span><span class="n">pp</span><span class="p">;</span>	<span class="cm">/* pointer to block address */</span>
	<span class="cm">/* REFERENCED */</span>
	<span class="n">xfs_extnum_t</span>		<span class="n">room</span><span class="p">;</span>	<span class="cm">/* number of entries there&#39;s room for */</span>

	<span class="n">bno</span> <span class="o">=</span> <span class="n">NULLFSBLOCK</span><span class="p">;</span>
	<span class="n">mp</span> <span class="o">=</span> <span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_mount</span><span class="p">;</span>
	<span class="n">ifp</span> <span class="o">=</span> <span class="n">XFS_IFORK_PTR</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">whichfork</span><span class="p">);</span>
	<span class="n">exntf</span> <span class="o">=</span> <span class="p">(</span><span class="n">whichfork</span> <span class="o">!=</span> <span class="n">XFS_DATA_FORK</span><span class="p">)</span> <span class="o">?</span> <span class="n">XFS_EXTFMT_NOSTATE</span> <span class="o">:</span>
					<span class="n">XFS_EXTFMT_INODE</span><span class="p">(</span><span class="n">ip</span><span class="p">);</span>
	<span class="n">block</span> <span class="o">=</span> <span class="n">ifp</span><span class="o">-&gt;</span><span class="n">if_broot</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * Root level must use BMAP_BROOT_PTR_ADDR macro to get ptr out.</span>
<span class="cm">	 */</span>
	<span class="n">level</span> <span class="o">=</span> <span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">block</span><span class="o">-&gt;</span><span class="n">bb_level</span><span class="p">);</span>
	<span class="n">ASSERT</span><span class="p">(</span><span class="n">level</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">pp</span> <span class="o">=</span> <span class="n">XFS_BMAP_BROOT_PTR_ADDR</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="n">block</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ifp</span><span class="o">-&gt;</span><span class="n">if_broot_bytes</span><span class="p">);</span>
	<span class="n">bno</span> <span class="o">=</span> <span class="n">be64_to_cpu</span><span class="p">(</span><span class="o">*</span><span class="n">pp</span><span class="p">);</span>
	<span class="n">ASSERT</span><span class="p">(</span><span class="n">bno</span> <span class="o">!=</span> <span class="n">NULLDFSBNO</span><span class="p">);</span>
	<span class="n">ASSERT</span><span class="p">(</span><span class="n">XFS_FSB_TO_AGNO</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="n">bno</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_sb</span><span class="p">.</span><span class="n">sb_agcount</span><span class="p">);</span>
	<span class="n">ASSERT</span><span class="p">(</span><span class="n">XFS_FSB_TO_AGBNO</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="n">bno</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_sb</span><span class="p">.</span><span class="n">sb_agblocks</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 * Go down the tree until leaf level is reached, following the first</span>
<span class="cm">	 * pointer (leftmost) at each level.</span>
<span class="cm">	 */</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">level</span><span class="o">--</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">error</span> <span class="o">=</span> <span class="n">xfs_btree_read_bufl</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="n">tp</span><span class="p">,</span> <span class="n">bno</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bp</span><span class="p">,</span>
				<span class="n">XFS_BMAP_BTREE_REF</span><span class="p">)))</span>
			<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
		<span class="n">block</span> <span class="o">=</span> <span class="n">XFS_BUF_TO_BLOCK</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>
		<span class="n">XFS_WANT_CORRUPTED_GOTO</span><span class="p">(</span>
			<span class="n">xfs_bmap_sanity_check</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="n">bp</span><span class="p">,</span> <span class="n">level</span><span class="p">),</span>
			<span class="n">error0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">level</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">pp</span> <span class="o">=</span> <span class="n">XFS_BMBT_PTR_ADDR</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="n">block</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_bmap_dmxr</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
		<span class="n">bno</span> <span class="o">=</span> <span class="n">be64_to_cpu</span><span class="p">(</span><span class="o">*</span><span class="n">pp</span><span class="p">);</span>
		<span class="n">XFS_WANT_CORRUPTED_GOTO</span><span class="p">(</span><span class="n">XFS_FSB_SANITY_CHECK</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="n">bno</span><span class="p">),</span> <span class="n">error0</span><span class="p">);</span>
		<span class="n">xfs_trans_brelse</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">bp</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="cm">/*</span>
<span class="cm">	 * Here with bp and block set to the leftmost leaf node in the tree.</span>
<span class="cm">	 */</span>
	<span class="n">room</span> <span class="o">=</span> <span class="n">ifp</span><span class="o">-&gt;</span><span class="n">if_bytes</span> <span class="o">/</span> <span class="p">(</span><span class="n">uint</span><span class="p">)</span><span class="k">sizeof</span><span class="p">(</span><span class="n">xfs_bmbt_rec_t</span><span class="p">);</span>
	<span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * Loop over all leaf nodes.  Copy information to the extent records.</span>
<span class="cm">	 */</span>
	<span class="k">for</span> <span class="p">(;;)</span> <span class="p">{</span>
		<span class="n">xfs_bmbt_rec_t</span>	<span class="o">*</span><span class="n">frp</span><span class="p">;</span>
		<span class="n">xfs_fsblock_t</span>	<span class="n">nextbno</span><span class="p">;</span>
		<span class="n">xfs_extnum_t</span>	<span class="n">num_recs</span><span class="p">;</span>
		<span class="n">xfs_extnum_t</span>	<span class="n">start</span><span class="p">;</span>

		<span class="n">num_recs</span> <span class="o">=</span> <span class="n">xfs_btree_get_numrecs</span><span class="p">(</span><span class="n">block</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="n">num_recs</span> <span class="o">&gt;</span> <span class="n">room</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">ASSERT</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="n">num_recs</span> <span class="o">&lt;=</span> <span class="n">room</span><span class="p">);</span>
			<span class="n">xfs_warn</span><span class="p">(</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_mount</span><span class="p">,</span>
				<span class="s">&quot;corrupt dinode %Lu, (btree extents).&quot;</span><span class="p">,</span>
				<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span> <span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_ino</span><span class="p">);</span>
			<span class="n">XFS_CORRUPTION_ERROR</span><span class="p">(</span><span class="s">&quot;xfs_bmap_read_extents(1)&quot;</span><span class="p">,</span>
				<span class="n">XFS_ERRLEVEL_LOW</span><span class="p">,</span> <span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_mount</span><span class="p">,</span> <span class="n">block</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">error0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">XFS_WANT_CORRUPTED_GOTO</span><span class="p">(</span>
			<span class="n">xfs_bmap_sanity_check</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="n">bp</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
			<span class="n">error0</span><span class="p">);</span>
		<span class="cm">/*</span>
<span class="cm">		 * Read-ahead the next leaf block, if any.</span>
<span class="cm">		 */</span>
		<span class="n">nextbno</span> <span class="o">=</span> <span class="n">be64_to_cpu</span><span class="p">(</span><span class="n">block</span><span class="o">-&gt;</span><span class="n">bb_u</span><span class="p">.</span><span class="n">l</span><span class="p">.</span><span class="n">bb_rightsib</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">nextbno</span> <span class="o">!=</span> <span class="n">NULLFSBLOCK</span><span class="p">)</span>
			<span class="n">xfs_btree_reada_bufl</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="n">nextbno</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="cm">/*</span>
<span class="cm">		 * Copy records into the extent records.</span>
<span class="cm">		 */</span>
		<span class="n">frp</span> <span class="o">=</span> <span class="n">XFS_BMBT_REC_ADDR</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="n">block</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">start</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">num_recs</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">,</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">frp</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">xfs_bmbt_rec_host_t</span> <span class="o">*</span><span class="n">trp</span> <span class="o">=</span> <span class="n">xfs_iext_get_ext</span><span class="p">(</span><span class="n">ifp</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
			<span class="n">trp</span><span class="o">-&gt;</span><span class="n">l0</span> <span class="o">=</span> <span class="n">be64_to_cpu</span><span class="p">(</span><span class="n">frp</span><span class="o">-&gt;</span><span class="n">l0</span><span class="p">);</span>
			<span class="n">trp</span><span class="o">-&gt;</span><span class="n">l1</span> <span class="o">=</span> <span class="n">be64_to_cpu</span><span class="p">(</span><span class="n">frp</span><span class="o">-&gt;</span><span class="n">l1</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">exntf</span> <span class="o">==</span> <span class="n">XFS_EXTFMT_NOSTATE</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * Check all attribute bmap btree records and</span>
<span class="cm">			 * any &quot;older&quot; data bmap btree records for a</span>
<span class="cm">			 * set bit in the &quot;extent flag&quot; position.</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">xfs_check_nostate_extents</span><span class="p">(</span><span class="n">ifp</span><span class="p">,</span>
					<span class="n">start</span><span class="p">,</span> <span class="n">num_recs</span><span class="p">)))</span> <span class="p">{</span>
				<span class="n">XFS_ERROR_REPORT</span><span class="p">(</span><span class="s">&quot;xfs_bmap_read_extents(2)&quot;</span><span class="p">,</span>
						 <span class="n">XFS_ERRLEVEL_LOW</span><span class="p">,</span>
						 <span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_mount</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">error0</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">xfs_trans_brelse</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">bp</span><span class="p">);</span>
		<span class="n">bno</span> <span class="o">=</span> <span class="n">nextbno</span><span class="p">;</span>
		<span class="cm">/*</span>
<span class="cm">		 * If we&#39;ve reached the end, stop.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bno</span> <span class="o">==</span> <span class="n">NULLFSBLOCK</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">error</span> <span class="o">=</span> <span class="n">xfs_btree_read_bufl</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="n">tp</span><span class="p">,</span> <span class="n">bno</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bp</span><span class="p">,</span>
				<span class="n">XFS_BMAP_BTREE_REF</span><span class="p">)))</span>
			<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
		<span class="n">block</span> <span class="o">=</span> <span class="n">XFS_BUF_TO_BLOCK</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">ASSERT</span><span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="p">(</span><span class="n">ifp</span><span class="o">-&gt;</span><span class="n">if_bytes</span> <span class="o">/</span> <span class="p">(</span><span class="n">uint</span><span class="p">)</span><span class="k">sizeof</span><span class="p">(</span><span class="n">xfs_bmbt_rec_t</span><span class="p">)));</span>
	<span class="n">ASSERT</span><span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">XFS_IFORK_NEXTENTS</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">whichfork</span><span class="p">));</span>
	<span class="n">XFS_BMAP_TRACE_EXLIST</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">whichfork</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">error0:</span>
	<span class="n">xfs_trans_brelse</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">bp</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">XFS_ERROR</span><span class="p">(</span><span class="n">EFSCORRUPTED</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#ifdef DEBUG</span>
<span class="cm">/*</span>
<span class="cm"> * Add bmap trace insert entries for all the contents of the extent records.</span>
<span class="cm"> */</span>
<span class="kt">void</span>
<span class="n">xfs_bmap_trace_exlist</span><span class="p">(</span>
	<span class="n">xfs_inode_t</span>	<span class="o">*</span><span class="n">ip</span><span class="p">,</span>		<span class="cm">/* incore inode pointer */</span>
	<span class="n">xfs_extnum_t</span>	<span class="n">cnt</span><span class="p">,</span>		<span class="cm">/* count of entries in the list */</span>
	<span class="kt">int</span>		<span class="n">whichfork</span><span class="p">,</span>	<span class="cm">/* data or attr fork */</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>	<span class="n">caller_ip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">xfs_extnum_t</span>	<span class="n">idx</span><span class="p">;</span>		<span class="cm">/* extent record index */</span>
	<span class="n">xfs_ifork_t</span>	<span class="o">*</span><span class="n">ifp</span><span class="p">;</span>		<span class="cm">/* inode fork pointer */</span>
	<span class="kt">int</span>		<span class="n">state</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">whichfork</span> <span class="o">==</span> <span class="n">XFS_ATTR_FORK</span><span class="p">)</span>
		<span class="n">state</span> <span class="o">|=</span> <span class="n">BMAP_ATTRFORK</span><span class="p">;</span>

	<span class="n">ifp</span> <span class="o">=</span> <span class="n">XFS_IFORK_PTR</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">whichfork</span><span class="p">);</span>
	<span class="n">ASSERT</span><span class="p">(</span><span class="n">cnt</span> <span class="o">==</span> <span class="p">(</span><span class="n">ifp</span><span class="o">-&gt;</span><span class="n">if_bytes</span> <span class="o">/</span> <span class="p">(</span><span class="n">uint</span><span class="p">)</span><span class="k">sizeof</span><span class="p">(</span><span class="n">xfs_bmbt_rec_t</span><span class="p">)));</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="n">cnt</span><span class="p">;</span> <span class="n">idx</span><span class="o">++</span><span class="p">)</span>
		<span class="n">trace_xfs_extlist</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">idx</span><span class="p">,</span> <span class="n">whichfork</span><span class="p">,</span> <span class="n">caller_ip</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Validate that the bmbt_irecs being returned from bmapi are valid</span>
<span class="cm"> * given the callers original parameters.  Specifically check the</span>
<span class="cm"> * ranges of the returned irecs to ensure that they only extent beyond</span>
<span class="cm"> * the given parameters if the XFS_BMAPI_ENTIRE flag was set.</span>
<span class="cm"> */</span>
<span class="n">STATIC</span> <span class="kt">void</span>
<span class="n">xfs_bmap_validate_ret</span><span class="p">(</span>
	<span class="n">xfs_fileoff_t</span>		<span class="n">bno</span><span class="p">,</span>
	<span class="n">xfs_filblks_t</span>		<span class="n">len</span><span class="p">,</span>
	<span class="kt">int</span>			<span class="n">flags</span><span class="p">,</span>
	<span class="n">xfs_bmbt_irec_t</span>		<span class="o">*</span><span class="n">mval</span><span class="p">,</span>
	<span class="kt">int</span>			<span class="n">nmap</span><span class="p">,</span>
	<span class="kt">int</span>			<span class="n">ret_nmap</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span>			<span class="n">i</span><span class="p">;</span>		<span class="cm">/* index to map values */</span>

	<span class="n">ASSERT</span><span class="p">(</span><span class="n">ret_nmap</span> <span class="o">&lt;=</span> <span class="n">nmap</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ret_nmap</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ASSERT</span><span class="p">(</span><span class="n">mval</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">br_blockcount</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">XFS_BMAPI_ENTIRE</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">ASSERT</span><span class="p">(</span><span class="n">mval</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">br_startoff</span> <span class="o">&gt;=</span> <span class="n">bno</span><span class="p">);</span>
			<span class="n">ASSERT</span><span class="p">(</span><span class="n">mval</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">br_blockcount</span> <span class="o">&lt;=</span> <span class="n">len</span><span class="p">);</span>
			<span class="n">ASSERT</span><span class="p">(</span><span class="n">mval</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">br_startoff</span> <span class="o">+</span> <span class="n">mval</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">br_blockcount</span> <span class="o">&lt;=</span>
			       <span class="n">bno</span> <span class="o">+</span> <span class="n">len</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">ASSERT</span><span class="p">(</span><span class="n">mval</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">br_startoff</span> <span class="o">&lt;</span> <span class="n">bno</span> <span class="o">+</span> <span class="n">len</span><span class="p">);</span>
			<span class="n">ASSERT</span><span class="p">(</span><span class="n">mval</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">br_startoff</span> <span class="o">+</span> <span class="n">mval</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">br_blockcount</span> <span class="o">&gt;</span>
			       <span class="n">bno</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">ASSERT</span><span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span>
		       <span class="n">mval</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">].</span><span class="n">br_startoff</span> <span class="o">+</span> <span class="n">mval</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">].</span><span class="n">br_blockcount</span> <span class="o">==</span>
		       <span class="n">mval</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">br_startoff</span><span class="p">);</span>
		<span class="n">ASSERT</span><span class="p">(</span><span class="n">mval</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">br_startblock</span> <span class="o">!=</span> <span class="n">DELAYSTARTBLOCK</span> <span class="o">&amp;&amp;</span>
		       <span class="n">mval</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">br_startblock</span> <span class="o">!=</span> <span class="n">HOLESTARTBLOCK</span><span class="p">);</span>
		<span class="n">ASSERT</span><span class="p">(</span><span class="n">mval</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">br_state</span> <span class="o">==</span> <span class="n">XFS_EXT_NORM</span> <span class="o">||</span>
		       <span class="n">mval</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">br_state</span> <span class="o">==</span> <span class="n">XFS_EXT_UNWRITTEN</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* DEBUG */</span><span class="cp"></span>


<span class="cm">/*</span>
<span class="cm"> * Trim the returned map to the required bounds</span>
<span class="cm"> */</span>
<span class="n">STATIC</span> <span class="kt">void</span>
<span class="n">xfs_bmapi_trim_map</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">xfs_bmbt_irec</span>	<span class="o">*</span><span class="n">mval</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">xfs_bmbt_irec</span>	<span class="o">*</span><span class="n">got</span><span class="p">,</span>
	<span class="n">xfs_fileoff_t</span>		<span class="o">*</span><span class="n">bno</span><span class="p">,</span>
	<span class="n">xfs_filblks_t</span>		<span class="n">len</span><span class="p">,</span>
	<span class="n">xfs_fileoff_t</span>		<span class="n">obno</span><span class="p">,</span>
	<span class="n">xfs_fileoff_t</span>		<span class="n">end</span><span class="p">,</span>
	<span class="kt">int</span>			<span class="n">n</span><span class="p">,</span>
	<span class="kt">int</span>			<span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">XFS_BMAPI_ENTIRE</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">got</span><span class="o">-&gt;</span><span class="n">br_startoff</span> <span class="o">+</span> <span class="n">got</span><span class="o">-&gt;</span><span class="n">br_blockcount</span> <span class="o">&lt;=</span> <span class="n">obno</span><span class="p">)</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">mval</span> <span class="o">=</span> <span class="o">*</span><span class="n">got</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">isnullstartblock</span><span class="p">(</span><span class="n">got</span><span class="o">-&gt;</span><span class="n">br_startblock</span><span class="p">))</span>
			<span class="n">mval</span><span class="o">-&gt;</span><span class="n">br_startblock</span> <span class="o">=</span> <span class="n">DELAYSTARTBLOCK</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">obno</span> <span class="o">&gt;</span> <span class="o">*</span><span class="n">bno</span><span class="p">)</span>
		<span class="o">*</span><span class="n">bno</span> <span class="o">=</span> <span class="n">obno</span><span class="p">;</span>
	<span class="n">ASSERT</span><span class="p">((</span><span class="o">*</span><span class="n">bno</span> <span class="o">&gt;=</span> <span class="n">obno</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">n</span> <span class="o">==</span> <span class="mi">0</span><span class="p">));</span>
	<span class="n">ASSERT</span><span class="p">(</span><span class="o">*</span><span class="n">bno</span> <span class="o">&lt;</span> <span class="n">end</span><span class="p">);</span>
	<span class="n">mval</span><span class="o">-&gt;</span><span class="n">br_startoff</span> <span class="o">=</span> <span class="o">*</span><span class="n">bno</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">isnullstartblock</span><span class="p">(</span><span class="n">got</span><span class="o">-&gt;</span><span class="n">br_startblock</span><span class="p">))</span>
		<span class="n">mval</span><span class="o">-&gt;</span><span class="n">br_startblock</span> <span class="o">=</span> <span class="n">DELAYSTARTBLOCK</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">mval</span><span class="o">-&gt;</span><span class="n">br_startblock</span> <span class="o">=</span> <span class="n">got</span><span class="o">-&gt;</span><span class="n">br_startblock</span> <span class="o">+</span>
					<span class="p">(</span><span class="o">*</span><span class="n">bno</span> <span class="o">-</span> <span class="n">got</span><span class="o">-&gt;</span><span class="n">br_startoff</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 * Return the minimum of what we got and what we asked for for</span>
<span class="cm">	 * the length.  We can use the len variable here because it is</span>
<span class="cm">	 * modified below and we could have been there before coming</span>
<span class="cm">	 * here if the first part of the allocation didn&#39;t overlap what</span>
<span class="cm">	 * was asked for.</span>
<span class="cm">	 */</span>
	<span class="n">mval</span><span class="o">-&gt;</span><span class="n">br_blockcount</span> <span class="o">=</span> <span class="n">XFS_FILBLKS_MIN</span><span class="p">(</span><span class="n">end</span> <span class="o">-</span> <span class="o">*</span><span class="n">bno</span><span class="p">,</span>
			<span class="n">got</span><span class="o">-&gt;</span><span class="n">br_blockcount</span> <span class="o">-</span> <span class="p">(</span><span class="o">*</span><span class="n">bno</span> <span class="o">-</span> <span class="n">got</span><span class="o">-&gt;</span><span class="n">br_startoff</span><span class="p">));</span>
	<span class="n">mval</span><span class="o">-&gt;</span><span class="n">br_state</span> <span class="o">=</span> <span class="n">got</span><span class="o">-&gt;</span><span class="n">br_state</span><span class="p">;</span>
	<span class="n">ASSERT</span><span class="p">(</span><span class="n">mval</span><span class="o">-&gt;</span><span class="n">br_blockcount</span> <span class="o">&lt;=</span> <span class="n">len</span><span class="p">);</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Update and validate the extent map to return</span>
<span class="cm"> */</span>
<span class="n">STATIC</span> <span class="kt">void</span>
<span class="n">xfs_bmapi_update_map</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">xfs_bmbt_irec</span>	<span class="o">**</span><span class="n">map</span><span class="p">,</span>
	<span class="n">xfs_fileoff_t</span>		<span class="o">*</span><span class="n">bno</span><span class="p">,</span>
	<span class="n">xfs_filblks_t</span>		<span class="o">*</span><span class="n">len</span><span class="p">,</span>
	<span class="n">xfs_fileoff_t</span>		<span class="n">obno</span><span class="p">,</span>
	<span class="n">xfs_fileoff_t</span>		<span class="n">end</span><span class="p">,</span>
	<span class="kt">int</span>			<span class="o">*</span><span class="n">n</span><span class="p">,</span>
	<span class="kt">int</span>			<span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">xfs_bmbt_irec_t</span>	<span class="o">*</span><span class="n">mval</span> <span class="o">=</span> <span class="o">*</span><span class="n">map</span><span class="p">;</span>

	<span class="n">ASSERT</span><span class="p">((</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">XFS_BMAPI_ENTIRE</span><span class="p">)</span> <span class="o">||</span>
	       <span class="p">((</span><span class="n">mval</span><span class="o">-&gt;</span><span class="n">br_startoff</span> <span class="o">+</span> <span class="n">mval</span><span class="o">-&gt;</span><span class="n">br_blockcount</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">end</span><span class="p">));</span>
	<span class="n">ASSERT</span><span class="p">((</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">XFS_BMAPI_ENTIRE</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">mval</span><span class="o">-&gt;</span><span class="n">br_blockcount</span> <span class="o">&lt;=</span> <span class="o">*</span><span class="n">len</span><span class="p">)</span> <span class="o">||</span>
	       <span class="p">(</span><span class="n">mval</span><span class="o">-&gt;</span><span class="n">br_startoff</span> <span class="o">&lt;</span> <span class="n">obno</span><span class="p">));</span>

	<span class="o">*</span><span class="n">bno</span> <span class="o">=</span> <span class="n">mval</span><span class="o">-&gt;</span><span class="n">br_startoff</span> <span class="o">+</span> <span class="n">mval</span><span class="o">-&gt;</span><span class="n">br_blockcount</span><span class="p">;</span>
	<span class="o">*</span><span class="n">len</span> <span class="o">=</span> <span class="n">end</span> <span class="o">-</span> <span class="o">*</span><span class="n">bno</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">n</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">mval</span><span class="o">-&gt;</span><span class="n">br_startoff</span> <span class="o">==</span> <span class="n">mval</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">].</span><span class="n">br_startoff</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* update previous map with new information */</span>
		<span class="n">ASSERT</span><span class="p">(</span><span class="n">mval</span><span class="o">-&gt;</span><span class="n">br_startblock</span> <span class="o">==</span> <span class="n">mval</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">].</span><span class="n">br_startblock</span><span class="p">);</span>
		<span class="n">ASSERT</span><span class="p">(</span><span class="n">mval</span><span class="o">-&gt;</span><span class="n">br_blockcount</span> <span class="o">&gt;</span> <span class="n">mval</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">].</span><span class="n">br_blockcount</span><span class="p">);</span>
		<span class="n">ASSERT</span><span class="p">(</span><span class="n">mval</span><span class="o">-&gt;</span><span class="n">br_state</span> <span class="o">==</span> <span class="n">mval</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">].</span><span class="n">br_state</span><span class="p">);</span>
		<span class="n">mval</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">].</span><span class="n">br_blockcount</span> <span class="o">=</span> <span class="n">mval</span><span class="o">-&gt;</span><span class="n">br_blockcount</span><span class="p">;</span>
		<span class="n">mval</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">].</span><span class="n">br_state</span> <span class="o">=</span> <span class="n">mval</span><span class="o">-&gt;</span><span class="n">br_state</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">n</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">mval</span><span class="o">-&gt;</span><span class="n">br_startblock</span> <span class="o">!=</span> <span class="n">DELAYSTARTBLOCK</span> <span class="o">&amp;&amp;</span>
		   <span class="n">mval</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">].</span><span class="n">br_startblock</span> <span class="o">!=</span> <span class="n">DELAYSTARTBLOCK</span> <span class="o">&amp;&amp;</span>
		   <span class="n">mval</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">].</span><span class="n">br_startblock</span> <span class="o">!=</span> <span class="n">HOLESTARTBLOCK</span> <span class="o">&amp;&amp;</span>
		   <span class="n">mval</span><span class="o">-&gt;</span><span class="n">br_startblock</span> <span class="o">==</span> <span class="n">mval</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">].</span><span class="n">br_startblock</span> <span class="o">+</span>
					  <span class="n">mval</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">].</span><span class="n">br_blockcount</span> <span class="o">&amp;&amp;</span>
		   <span class="p">((</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">XFS_BMAPI_IGSTATE</span><span class="p">)</span> <span class="o">||</span>
			<span class="n">mval</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">].</span><span class="n">br_state</span> <span class="o">==</span> <span class="n">mval</span><span class="o">-&gt;</span><span class="n">br_state</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ASSERT</span><span class="p">(</span><span class="n">mval</span><span class="o">-&gt;</span><span class="n">br_startoff</span> <span class="o">==</span>
		       <span class="n">mval</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">].</span><span class="n">br_startoff</span> <span class="o">+</span> <span class="n">mval</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">].</span><span class="n">br_blockcount</span><span class="p">);</span>
		<span class="n">mval</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">].</span><span class="n">br_blockcount</span> <span class="o">+=</span> <span class="n">mval</span><span class="o">-&gt;</span><span class="n">br_blockcount</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">n</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
		   <span class="n">mval</span><span class="o">-&gt;</span><span class="n">br_startblock</span> <span class="o">==</span> <span class="n">DELAYSTARTBLOCK</span> <span class="o">&amp;&amp;</span>
		   <span class="n">mval</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">].</span><span class="n">br_startblock</span> <span class="o">==</span> <span class="n">DELAYSTARTBLOCK</span> <span class="o">&amp;&amp;</span>
		   <span class="n">mval</span><span class="o">-&gt;</span><span class="n">br_startoff</span> <span class="o">==</span>
		   <span class="n">mval</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">].</span><span class="n">br_startoff</span> <span class="o">+</span> <span class="n">mval</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">].</span><span class="n">br_blockcount</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mval</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">].</span><span class="n">br_blockcount</span> <span class="o">+=</span> <span class="n">mval</span><span class="o">-&gt;</span><span class="n">br_blockcount</span><span class="p">;</span>
		<span class="n">mval</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">].</span><span class="n">br_state</span> <span class="o">=</span> <span class="n">mval</span><span class="o">-&gt;</span><span class="n">br_state</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">((</span><span class="o">*</span><span class="n">n</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		     <span class="p">((</span><span class="n">mval</span><span class="o">-&gt;</span><span class="n">br_startoff</span> <span class="o">+</span> <span class="n">mval</span><span class="o">-&gt;</span><span class="n">br_blockcount</span><span class="p">)</span> <span class="o">&lt;=</span>
		      <span class="n">obno</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">mval</span><span class="o">++</span><span class="p">;</span>
		<span class="p">(</span><span class="o">*</span><span class="n">n</span><span class="p">)</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="o">*</span><span class="n">map</span> <span class="o">=</span> <span class="n">mval</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Map file blocks to filesystem blocks without allocation.</span>
<span class="cm"> */</span>
<span class="kt">int</span>
<span class="n">xfs_bmapi_read</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">xfs_inode</span>	<span class="o">*</span><span class="n">ip</span><span class="p">,</span>
	<span class="n">xfs_fileoff_t</span>		<span class="n">bno</span><span class="p">,</span>
	<span class="n">xfs_filblks_t</span>		<span class="n">len</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">xfs_bmbt_irec</span>	<span class="o">*</span><span class="n">mval</span><span class="p">,</span>
	<span class="kt">int</span>			<span class="o">*</span><span class="n">nmap</span><span class="p">,</span>
	<span class="kt">int</span>			<span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">xfs_mount</span>	<span class="o">*</span><span class="n">mp</span> <span class="o">=</span> <span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_mount</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">xfs_ifork</span>	<span class="o">*</span><span class="n">ifp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">xfs_bmbt_irec</span>	<span class="n">got</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">xfs_bmbt_irec</span>	<span class="n">prev</span><span class="p">;</span>
	<span class="n">xfs_fileoff_t</span>		<span class="n">obno</span><span class="p">;</span>
	<span class="n">xfs_fileoff_t</span>		<span class="n">end</span><span class="p">;</span>
	<span class="n">xfs_extnum_t</span>		<span class="n">lastx</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">error</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">eof</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">n</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">whichfork</span> <span class="o">=</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">XFS_BMAPI_ATTRFORK</span><span class="p">)</span> <span class="o">?</span>
						<span class="n">XFS_ATTR_FORK</span> <span class="o">:</span> <span class="n">XFS_DATA_FORK</span><span class="p">;</span>

	<span class="n">ASSERT</span><span class="p">(</span><span class="o">*</span><span class="n">nmap</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">ASSERT</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">XFS_BMAPI_ATTRFORK</span><span class="o">|</span><span class="n">XFS_BMAPI_ENTIRE</span><span class="o">|</span>
			   <span class="n">XFS_BMAPI_IGSTATE</span><span class="p">)));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">XFS_TEST_ERROR</span><span class="p">(</span>
	    <span class="p">(</span><span class="n">XFS_IFORK_FORMAT</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">whichfork</span><span class="p">)</span> <span class="o">!=</span> <span class="n">XFS_DINODE_FMT_EXTENTS</span> <span class="o">&amp;&amp;</span>
	     <span class="n">XFS_IFORK_FORMAT</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">whichfork</span><span class="p">)</span> <span class="o">!=</span> <span class="n">XFS_DINODE_FMT_BTREE</span><span class="p">),</span>
	     <span class="n">mp</span><span class="p">,</span> <span class="n">XFS_ERRTAG_BMAPIFORMAT</span><span class="p">,</span> <span class="n">XFS_RANDOM_BMAPIFORMAT</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">XFS_ERROR_REPORT</span><span class="p">(</span><span class="s">&quot;xfs_bmapi_read&quot;</span><span class="p">,</span> <span class="n">XFS_ERRLEVEL_LOW</span><span class="p">,</span> <span class="n">mp</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">XFS_ERROR</span><span class="p">(</span><span class="n">EFSCORRUPTED</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">XFS_FORCED_SHUTDOWN</span><span class="p">(</span><span class="n">mp</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">XFS_ERROR</span><span class="p">(</span><span class="n">EIO</span><span class="p">);</span>

	<span class="n">XFS_STATS_INC</span><span class="p">(</span><span class="n">xs_blk_mapr</span><span class="p">);</span>

	<span class="n">ifp</span> <span class="o">=</span> <span class="n">XFS_IFORK_PTR</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">whichfork</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ifp</span><span class="o">-&gt;</span><span class="n">if_flags</span> <span class="o">&amp;</span> <span class="n">XFS_IFEXTENTS</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">error</span> <span class="o">=</span> <span class="n">xfs_iread_extents</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">ip</span><span class="p">,</span> <span class="n">whichfork</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">xfs_bmap_search_extents</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">bno</span><span class="p">,</span> <span class="n">whichfork</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">eof</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">lastx</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">got</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">prev</span><span class="p">);</span>
	<span class="n">end</span> <span class="o">=</span> <span class="n">bno</span> <span class="o">+</span> <span class="n">len</span><span class="p">;</span>
	<span class="n">obno</span> <span class="o">=</span> <span class="n">bno</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">bno</span> <span class="o">&lt;</span> <span class="n">end</span> <span class="o">&amp;&amp;</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="o">*</span><span class="n">nmap</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Reading past eof, act as though there&#39;s a hole up to end. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">eof</span><span class="p">)</span>
			<span class="n">got</span><span class="p">.</span><span class="n">br_startoff</span> <span class="o">=</span> <span class="n">end</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">got</span><span class="p">.</span><span class="n">br_startoff</span> <span class="o">&gt;</span> <span class="n">bno</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Reading in a hole.  */</span>
			<span class="n">mval</span><span class="o">-&gt;</span><span class="n">br_startoff</span> <span class="o">=</span> <span class="n">bno</span><span class="p">;</span>
			<span class="n">mval</span><span class="o">-&gt;</span><span class="n">br_startblock</span> <span class="o">=</span> <span class="n">HOLESTARTBLOCK</span><span class="p">;</span>
			<span class="n">mval</span><span class="o">-&gt;</span><span class="n">br_blockcount</span> <span class="o">=</span>
				<span class="n">XFS_FILBLKS_MIN</span><span class="p">(</span><span class="n">len</span><span class="p">,</span> <span class="n">got</span><span class="p">.</span><span class="n">br_startoff</span> <span class="o">-</span> <span class="n">bno</span><span class="p">);</span>
			<span class="n">mval</span><span class="o">-&gt;</span><span class="n">br_state</span> <span class="o">=</span> <span class="n">XFS_EXT_NORM</span><span class="p">;</span>
			<span class="n">bno</span> <span class="o">+=</span> <span class="n">mval</span><span class="o">-&gt;</span><span class="n">br_blockcount</span><span class="p">;</span>
			<span class="n">len</span> <span class="o">-=</span> <span class="n">mval</span><span class="o">-&gt;</span><span class="n">br_blockcount</span><span class="p">;</span>
			<span class="n">mval</span><span class="o">++</span><span class="p">;</span>
			<span class="n">n</span><span class="o">++</span><span class="p">;</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* set up the extent map to return. */</span>
		<span class="n">xfs_bmapi_trim_map</span><span class="p">(</span><span class="n">mval</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">got</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bno</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">obno</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">xfs_bmapi_update_map</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mval</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bno</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">len</span><span class="p">,</span> <span class="n">obno</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">n</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

		<span class="cm">/* If we&#39;re done, stop now. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bno</span> <span class="o">&gt;=</span> <span class="n">end</span> <span class="o">||</span> <span class="n">n</span> <span class="o">&gt;=</span> <span class="o">*</span><span class="n">nmap</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="cm">/* Else go on to the next record. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="n">lastx</span> <span class="o">&lt;</span> <span class="n">ifp</span><span class="o">-&gt;</span><span class="n">if_bytes</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">xfs_bmbt_rec_t</span><span class="p">))</span>
			<span class="n">xfs_bmbt_get_all</span><span class="p">(</span><span class="n">xfs_iext_get_ext</span><span class="p">(</span><span class="n">ifp</span><span class="p">,</span> <span class="n">lastx</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">got</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">eof</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="o">*</span><span class="n">nmap</span> <span class="o">=</span> <span class="n">n</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">STATIC</span> <span class="kt">int</span>
<span class="n">xfs_bmapi_reserve_delalloc</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">xfs_inode</span>	<span class="o">*</span><span class="n">ip</span><span class="p">,</span>
	<span class="n">xfs_fileoff_t</span>		<span class="n">aoff</span><span class="p">,</span>
	<span class="n">xfs_filblks_t</span>		<span class="n">len</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">xfs_bmbt_irec</span>	<span class="o">*</span><span class="n">got</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">xfs_bmbt_irec</span>	<span class="o">*</span><span class="n">prev</span><span class="p">,</span>
	<span class="n">xfs_extnum_t</span>		<span class="o">*</span><span class="n">lastx</span><span class="p">,</span>
	<span class="kt">int</span>			<span class="n">eof</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">xfs_mount</span>	<span class="o">*</span><span class="n">mp</span> <span class="o">=</span> <span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_mount</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">xfs_ifork</span>	<span class="o">*</span><span class="n">ifp</span> <span class="o">=</span> <span class="n">XFS_IFORK_PTR</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">XFS_DATA_FORK</span><span class="p">);</span>
	<span class="n">xfs_extlen_t</span>		<span class="n">alen</span><span class="p">;</span>
	<span class="n">xfs_extlen_t</span>		<span class="n">indlen</span><span class="p">;</span>
	<span class="kt">char</span>			<span class="n">rt</span> <span class="o">=</span> <span class="n">XFS_IS_REALTIME_INODE</span><span class="p">(</span><span class="n">ip</span><span class="p">);</span>
	<span class="n">xfs_extlen_t</span>		<span class="n">extsz</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">error</span><span class="p">;</span>

	<span class="n">alen</span> <span class="o">=</span> <span class="n">XFS_FILBLKS_MIN</span><span class="p">(</span><span class="n">len</span><span class="p">,</span> <span class="n">MAXEXTLEN</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">eof</span><span class="p">)</span>
		<span class="n">alen</span> <span class="o">=</span> <span class="n">XFS_FILBLKS_MIN</span><span class="p">(</span><span class="n">alen</span><span class="p">,</span> <span class="n">got</span><span class="o">-&gt;</span><span class="n">br_startoff</span> <span class="o">-</span> <span class="n">aoff</span><span class="p">);</span>

	<span class="cm">/* Figure out the extent size, adjust alen */</span>
	<span class="n">extsz</span> <span class="o">=</span> <span class="n">xfs_get_extsz_hint</span><span class="p">(</span><span class="n">ip</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">extsz</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Make sure we don&#39;t exceed a single extent length when we</span>
<span class="cm">		 * align the extent by reducing length we are going to</span>
<span class="cm">		 * allocate by the maximum amount extent size aligment may</span>
<span class="cm">		 * require.</span>
<span class="cm">		 */</span>
		<span class="n">alen</span> <span class="o">=</span> <span class="n">XFS_FILBLKS_MIN</span><span class="p">(</span><span class="n">len</span><span class="p">,</span> <span class="n">MAXEXTLEN</span> <span class="o">-</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">extsz</span> <span class="o">-</span> <span class="mi">1</span><span class="p">));</span>
		<span class="n">error</span> <span class="o">=</span> <span class="n">xfs_bmap_extsize_align</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="n">got</span><span class="p">,</span> <span class="n">prev</span><span class="p">,</span> <span class="n">extsz</span><span class="p">,</span> <span class="n">rt</span><span class="p">,</span> <span class="n">eof</span><span class="p">,</span>
					       <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">aoff</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">alen</span><span class="p">);</span>
		<span class="n">ASSERT</span><span class="p">(</span><span class="o">!</span><span class="n">error</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rt</span><span class="p">)</span>
		<span class="n">extsz</span> <span class="o">=</span> <span class="n">alen</span> <span class="o">/</span> <span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_sb</span><span class="p">.</span><span class="n">sb_rextsize</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Make a transaction-less quota reservation for delayed allocation</span>
<span class="cm">	 * blocks.  This number gets adjusted later.  We return if we haven&#39;t</span>
<span class="cm">	 * allocated blocks already inside this loop.</span>
<span class="cm">	 */</span>
	<span class="n">error</span> <span class="o">=</span> <span class="n">xfs_trans_reserve_quota_nblks</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">ip</span><span class="p">,</span> <span class="p">(</span><span class="kt">long</span><span class="p">)</span><span class="n">alen</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
			<span class="n">rt</span> <span class="o">?</span> <span class="n">XFS_QMOPT_RES_RTBLKS</span> <span class="o">:</span> <span class="n">XFS_QMOPT_RES_REGBLKS</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">error</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Split changing sb for alen and indlen since they could be coming</span>
<span class="cm">	 * from different places.</span>
<span class="cm">	 */</span>
	<span class="n">indlen</span> <span class="o">=</span> <span class="p">(</span><span class="n">xfs_extlen_t</span><span class="p">)</span><span class="n">xfs_bmap_worst_indlen</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">alen</span><span class="p">);</span>
	<span class="n">ASSERT</span><span class="p">(</span><span class="n">indlen</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rt</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">error</span> <span class="o">=</span> <span class="n">xfs_mod_incore_sb</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="n">XFS_SBS_FREXTENTS</span><span class="p">,</span>
					  <span class="o">-</span><span class="p">((</span><span class="kt">int64_t</span><span class="p">)</span><span class="n">extsz</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">error</span> <span class="o">=</span> <span class="n">xfs_icsb_modify_counters</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="n">XFS_SBS_FDBLOCKS</span><span class="p">,</span>
						 <span class="o">-</span><span class="p">((</span><span class="kt">int64_t</span><span class="p">)</span><span class="n">alen</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_unreserve_quota</span><span class="p">;</span>

	<span class="n">error</span> <span class="o">=</span> <span class="n">xfs_icsb_modify_counters</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="n">XFS_SBS_FDBLOCKS</span><span class="p">,</span>
					 <span class="o">-</span><span class="p">((</span><span class="kt">int64_t</span><span class="p">)</span><span class="n">indlen</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_unreserve_blocks</span><span class="p">;</span>


	<span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_delayed_blks</span> <span class="o">+=</span> <span class="n">alen</span><span class="p">;</span>

	<span class="n">got</span><span class="o">-&gt;</span><span class="n">br_startoff</span> <span class="o">=</span> <span class="n">aoff</span><span class="p">;</span>
	<span class="n">got</span><span class="o">-&gt;</span><span class="n">br_startblock</span> <span class="o">=</span> <span class="n">nullstartblock</span><span class="p">(</span><span class="n">indlen</span><span class="p">);</span>
	<span class="n">got</span><span class="o">-&gt;</span><span class="n">br_blockcount</span> <span class="o">=</span> <span class="n">alen</span><span class="p">;</span>
	<span class="n">got</span><span class="o">-&gt;</span><span class="n">br_state</span> <span class="o">=</span> <span class="n">XFS_EXT_NORM</span><span class="p">;</span>
	<span class="n">xfs_bmap_add_extent_hole_delay</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">lastx</span><span class="p">,</span> <span class="n">got</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Update our extent pointer, given that xfs_bmap_add_extent_hole_delay</span>
<span class="cm">	 * might have merged it into one of the neighbouring ones.</span>
<span class="cm">	 */</span>
	<span class="n">xfs_bmbt_get_all</span><span class="p">(</span><span class="n">xfs_iext_get_ext</span><span class="p">(</span><span class="n">ifp</span><span class="p">,</span> <span class="o">*</span><span class="n">lastx</span><span class="p">),</span> <span class="n">got</span><span class="p">);</span>

	<span class="n">ASSERT</span><span class="p">(</span><span class="n">got</span><span class="o">-&gt;</span><span class="n">br_startoff</span> <span class="o">&lt;=</span> <span class="n">aoff</span><span class="p">);</span>
	<span class="n">ASSERT</span><span class="p">(</span><span class="n">got</span><span class="o">-&gt;</span><span class="n">br_startoff</span> <span class="o">+</span> <span class="n">got</span><span class="o">-&gt;</span><span class="n">br_blockcount</span> <span class="o">&gt;=</span> <span class="n">aoff</span> <span class="o">+</span> <span class="n">alen</span><span class="p">);</span>
	<span class="n">ASSERT</span><span class="p">(</span><span class="n">isnullstartblock</span><span class="p">(</span><span class="n">got</span><span class="o">-&gt;</span><span class="n">br_startblock</span><span class="p">));</span>
	<span class="n">ASSERT</span><span class="p">(</span><span class="n">got</span><span class="o">-&gt;</span><span class="n">br_state</span> <span class="o">==</span> <span class="n">XFS_EXT_NORM</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">out_unreserve_blocks:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rt</span><span class="p">)</span>
		<span class="n">xfs_mod_incore_sb</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="n">XFS_SBS_FREXTENTS</span><span class="p">,</span> <span class="n">extsz</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">xfs_icsb_modify_counters</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="n">XFS_SBS_FDBLOCKS</span><span class="p">,</span> <span class="n">alen</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="nl">out_unreserve_quota:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">XFS_IS_QUOTA_ON</span><span class="p">(</span><span class="n">mp</span><span class="p">))</span>
		<span class="n">xfs_trans_unreserve_quota_nblks</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">ip</span><span class="p">,</span> <span class="p">(</span><span class="kt">long</span><span class="p">)</span><span class="n">alen</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">rt</span> <span class="o">?</span>
				<span class="n">XFS_QMOPT_RES_RTBLKS</span> <span class="o">:</span> <span class="n">XFS_QMOPT_RES_REGBLKS</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Map file blocks to filesystem blocks, adding delayed allocations as needed.</span>
<span class="cm"> */</span>
<span class="kt">int</span>
<span class="n">xfs_bmapi_delay</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">xfs_inode</span>	<span class="o">*</span><span class="n">ip</span><span class="p">,</span>	<span class="cm">/* incore inode */</span>
	<span class="n">xfs_fileoff_t</span>		<span class="n">bno</span><span class="p">,</span>	<span class="cm">/* starting file offs. mapped */</span>
	<span class="n">xfs_filblks_t</span>		<span class="n">len</span><span class="p">,</span>	<span class="cm">/* length to map in file */</span>
	<span class="k">struct</span> <span class="n">xfs_bmbt_irec</span>	<span class="o">*</span><span class="n">mval</span><span class="p">,</span>	<span class="cm">/* output: map values */</span>
	<span class="kt">int</span>			<span class="o">*</span><span class="n">nmap</span><span class="p">,</span>	<span class="cm">/* i/o: mval size/count */</span>
	<span class="kt">int</span>			<span class="n">flags</span><span class="p">)</span>	<span class="cm">/* XFS_BMAPI_... */</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">xfs_mount</span>	<span class="o">*</span><span class="n">mp</span> <span class="o">=</span> <span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_mount</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">xfs_ifork</span>	<span class="o">*</span><span class="n">ifp</span> <span class="o">=</span> <span class="n">XFS_IFORK_PTR</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">XFS_DATA_FORK</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">xfs_bmbt_irec</span>	<span class="n">got</span><span class="p">;</span>	<span class="cm">/* current file extent record */</span>
	<span class="k">struct</span> <span class="n">xfs_bmbt_irec</span>	<span class="n">prev</span><span class="p">;</span>	<span class="cm">/* previous file extent record */</span>
	<span class="n">xfs_fileoff_t</span>		<span class="n">obno</span><span class="p">;</span>	<span class="cm">/* old block number (offset) */</span>
	<span class="n">xfs_fileoff_t</span>		<span class="n">end</span><span class="p">;</span>	<span class="cm">/* end of mapped file region */</span>
	<span class="n">xfs_extnum_t</span>		<span class="n">lastx</span><span class="p">;</span>	<span class="cm">/* last useful extent number */</span>
	<span class="kt">int</span>			<span class="n">eof</span><span class="p">;</span>	<span class="cm">/* we&#39;ve hit the end of extents */</span>
	<span class="kt">int</span>			<span class="n">n</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* current extent index */</span>
	<span class="kt">int</span>			<span class="n">error</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">ASSERT</span><span class="p">(</span><span class="o">*</span><span class="n">nmap</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">ASSERT</span><span class="p">(</span><span class="o">*</span><span class="n">nmap</span> <span class="o">&lt;=</span> <span class="n">XFS_BMAP_MAX_NMAP</span><span class="p">);</span>
	<span class="n">ASSERT</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">XFS_BMAPI_ENTIRE</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">XFS_TEST_ERROR</span><span class="p">(</span>
	    <span class="p">(</span><span class="n">XFS_IFORK_FORMAT</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">XFS_DATA_FORK</span><span class="p">)</span> <span class="o">!=</span> <span class="n">XFS_DINODE_FMT_EXTENTS</span> <span class="o">&amp;&amp;</span>
	     <span class="n">XFS_IFORK_FORMAT</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">XFS_DATA_FORK</span><span class="p">)</span> <span class="o">!=</span> <span class="n">XFS_DINODE_FMT_BTREE</span><span class="p">),</span>
	     <span class="n">mp</span><span class="p">,</span> <span class="n">XFS_ERRTAG_BMAPIFORMAT</span><span class="p">,</span> <span class="n">XFS_RANDOM_BMAPIFORMAT</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">XFS_ERROR_REPORT</span><span class="p">(</span><span class="s">&quot;xfs_bmapi_delay&quot;</span><span class="p">,</span> <span class="n">XFS_ERRLEVEL_LOW</span><span class="p">,</span> <span class="n">mp</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">XFS_ERROR</span><span class="p">(</span><span class="n">EFSCORRUPTED</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">XFS_FORCED_SHUTDOWN</span><span class="p">(</span><span class="n">mp</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">XFS_ERROR</span><span class="p">(</span><span class="n">EIO</span><span class="p">);</span>

	<span class="n">XFS_STATS_INC</span><span class="p">(</span><span class="n">xs_blk_mapw</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ifp</span><span class="o">-&gt;</span><span class="n">if_flags</span> <span class="o">&amp;</span> <span class="n">XFS_IFEXTENTS</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">error</span> <span class="o">=</span> <span class="n">xfs_iread_extents</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">ip</span><span class="p">,</span> <span class="n">XFS_DATA_FORK</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">xfs_bmap_search_extents</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">bno</span><span class="p">,</span> <span class="n">XFS_DATA_FORK</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">eof</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">lastx</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">got</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">prev</span><span class="p">);</span>
	<span class="n">end</span> <span class="o">=</span> <span class="n">bno</span> <span class="o">+</span> <span class="n">len</span><span class="p">;</span>
	<span class="n">obno</span> <span class="o">=</span> <span class="n">bno</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">bno</span> <span class="o">&lt;</span> <span class="n">end</span> <span class="o">&amp;&amp;</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="o">*</span><span class="n">nmap</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">eof</span> <span class="o">||</span> <span class="n">got</span><span class="p">.</span><span class="n">br_startoff</span> <span class="o">&gt;</span> <span class="n">bno</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">error</span> <span class="o">=</span> <span class="n">xfs_bmapi_reserve_delalloc</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">bno</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">got</span><span class="p">,</span>
							   <span class="o">&amp;</span><span class="n">prev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">lastx</span><span class="p">,</span> <span class="n">eof</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">n</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
					<span class="o">*</span><span class="n">nmap</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
					<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="cm">/* set up the extent map to return. */</span>
		<span class="n">xfs_bmapi_trim_map</span><span class="p">(</span><span class="n">mval</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">got</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bno</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">obno</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">xfs_bmapi_update_map</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mval</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bno</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">len</span><span class="p">,</span> <span class="n">obno</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">n</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

		<span class="cm">/* If we&#39;re done, stop now. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bno</span> <span class="o">&gt;=</span> <span class="n">end</span> <span class="o">||</span> <span class="n">n</span> <span class="o">&gt;=</span> <span class="o">*</span><span class="n">nmap</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="cm">/* Else go on to the next record. */</span>
		<span class="n">prev</span> <span class="o">=</span> <span class="n">got</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="n">lastx</span> <span class="o">&lt;</span> <span class="n">ifp</span><span class="o">-&gt;</span><span class="n">if_bytes</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">xfs_bmbt_rec_t</span><span class="p">))</span>
			<span class="n">xfs_bmbt_get_all</span><span class="p">(</span><span class="n">xfs_iext_get_ext</span><span class="p">(</span><span class="n">ifp</span><span class="p">,</span> <span class="n">lastx</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">got</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">eof</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="o">*</span><span class="n">nmap</span> <span class="o">=</span> <span class="n">n</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="n">STATIC</span> <span class="kt">int</span>
<span class="n">xfs_bmapi_allocate</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">xfs_bmalloca</span>	<span class="o">*</span><span class="n">bma</span><span class="p">,</span>
	<span class="kt">int</span>			<span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">xfs_mount</span>	<span class="o">*</span><span class="n">mp</span> <span class="o">=</span> <span class="n">bma</span><span class="o">-&gt;</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_mount</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">whichfork</span> <span class="o">=</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">XFS_BMAPI_ATTRFORK</span><span class="p">)</span> <span class="o">?</span>
						<span class="n">XFS_ATTR_FORK</span> <span class="o">:</span> <span class="n">XFS_DATA_FORK</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">xfs_ifork</span>	<span class="o">*</span><span class="n">ifp</span> <span class="o">=</span> <span class="n">XFS_IFORK_PTR</span><span class="p">(</span><span class="n">bma</span><span class="o">-&gt;</span><span class="n">ip</span><span class="p">,</span> <span class="n">whichfork</span><span class="p">);</span>
	<span class="kt">int</span>			<span class="n">tmp_logflags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">error</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">rt</span><span class="p">;</span>

	<span class="n">ASSERT</span><span class="p">(</span><span class="n">bma</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">rt</span> <span class="o">=</span> <span class="p">(</span><span class="n">whichfork</span> <span class="o">==</span> <span class="n">XFS_DATA_FORK</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">XFS_IS_REALTIME_INODE</span><span class="p">(</span><span class="n">bma</span><span class="o">-&gt;</span><span class="n">ip</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * For the wasdelay case, we could also just allocate the stuff asked</span>
<span class="cm">	 * for in this bmap call but that wouldn&#39;t be as good.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bma</span><span class="o">-&gt;</span><span class="n">wasdel</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bma</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">=</span> <span class="p">(</span><span class="n">xfs_extlen_t</span><span class="p">)</span><span class="n">bma</span><span class="o">-&gt;</span><span class="n">got</span><span class="p">.</span><span class="n">br_blockcount</span><span class="p">;</span>
		<span class="n">bma</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">=</span> <span class="n">bma</span><span class="o">-&gt;</span><span class="n">got</span><span class="p">.</span><span class="n">br_startoff</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bma</span><span class="o">-&gt;</span><span class="n">idx</span> <span class="o">!=</span> <span class="n">NULLEXTNUM</span> <span class="o">&amp;&amp;</span> <span class="n">bma</span><span class="o">-&gt;</span><span class="n">idx</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">xfs_bmbt_get_all</span><span class="p">(</span><span class="n">xfs_iext_get_ext</span><span class="p">(</span><span class="n">ifp</span><span class="p">,</span> <span class="n">bma</span><span class="o">-&gt;</span><span class="n">idx</span> <span class="o">-</span> <span class="mi">1</span><span class="p">),</span>
					 <span class="o">&amp;</span><span class="n">bma</span><span class="o">-&gt;</span><span class="n">prev</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">bma</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">=</span> <span class="n">XFS_FILBLKS_MIN</span><span class="p">(</span><span class="n">bma</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">,</span> <span class="n">MAXEXTLEN</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bma</span><span class="o">-&gt;</span><span class="n">eof</span><span class="p">)</span>
			<span class="n">bma</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">=</span> <span class="n">XFS_FILBLKS_MIN</span><span class="p">(</span><span class="n">bma</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">,</span>
					<span class="n">bma</span><span class="o">-&gt;</span><span class="n">got</span><span class="p">.</span><span class="n">br_startoff</span> <span class="o">-</span> <span class="n">bma</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Indicate if this is the first user data in the file, or just any</span>
<span class="cm">	 * user data.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">XFS_BMAPI_METADATA</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">bma</span><span class="o">-&gt;</span><span class="n">userdata</span> <span class="o">=</span> <span class="p">(</span><span class="n">bma</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">?</span>
			<span class="n">XFS_ALLOC_INITIAL_USER_DATA</span> <span class="o">:</span> <span class="n">XFS_ALLOC_USERDATA</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">bma</span><span class="o">-&gt;</span><span class="n">minlen</span> <span class="o">=</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">XFS_BMAPI_CONTIG</span><span class="p">)</span> <span class="o">?</span> <span class="n">bma</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Only want to do the alignment at the eof if it is userdata and</span>
<span class="cm">	 * allocation length is larger than a stripe unit.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_dalign</span> <span class="o">&amp;&amp;</span> <span class="n">bma</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">&gt;=</span> <span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_dalign</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">XFS_BMAPI_METADATA</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">whichfork</span> <span class="o">==</span> <span class="n">XFS_DATA_FORK</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">error</span> <span class="o">=</span> <span class="n">xfs_bmap_isaeof</span><span class="p">(</span><span class="n">bma</span><span class="p">,</span> <span class="n">whichfork</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">error</span> <span class="o">=</span> <span class="n">xfs_bmap_alloc</span><span class="p">(</span><span class="n">bma</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">error</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bma</span><span class="o">-&gt;</span><span class="n">flist</span><span class="o">-&gt;</span><span class="n">xbf_low</span><span class="p">)</span>
		<span class="n">bma</span><span class="o">-&gt;</span><span class="n">minleft</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bma</span><span class="o">-&gt;</span><span class="n">cur</span><span class="p">)</span>
		<span class="n">bma</span><span class="o">-&gt;</span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">bc_private</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">firstblock</span> <span class="o">=</span> <span class="o">*</span><span class="n">bma</span><span class="o">-&gt;</span><span class="n">firstblock</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bma</span><span class="o">-&gt;</span><span class="n">blkno</span> <span class="o">==</span> <span class="n">NULLFSBLOCK</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">ifp</span><span class="o">-&gt;</span><span class="n">if_flags</span> <span class="o">&amp;</span> <span class="n">XFS_IFBROOT</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">bma</span><span class="o">-&gt;</span><span class="n">cur</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bma</span><span class="o">-&gt;</span><span class="n">cur</span> <span class="o">=</span> <span class="n">xfs_bmbt_init_cursor</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="n">bma</span><span class="o">-&gt;</span><span class="n">tp</span><span class="p">,</span> <span class="n">bma</span><span class="o">-&gt;</span><span class="n">ip</span><span class="p">,</span> <span class="n">whichfork</span><span class="p">);</span>
		<span class="n">bma</span><span class="o">-&gt;</span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">bc_private</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">firstblock</span> <span class="o">=</span> <span class="o">*</span><span class="n">bma</span><span class="o">-&gt;</span><span class="n">firstblock</span><span class="p">;</span>
		<span class="n">bma</span><span class="o">-&gt;</span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">bc_private</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">flist</span> <span class="o">=</span> <span class="n">bma</span><span class="o">-&gt;</span><span class="n">flist</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/*</span>
<span class="cm">	 * Bump the number of extents we&#39;ve allocated</span>
<span class="cm">	 * in this call.</span>
<span class="cm">	 */</span>
	<span class="n">bma</span><span class="o">-&gt;</span><span class="n">nallocs</span><span class="o">++</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bma</span><span class="o">-&gt;</span><span class="n">cur</span><span class="p">)</span>
		<span class="n">bma</span><span class="o">-&gt;</span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">bc_private</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span>
			<span class="n">bma</span><span class="o">-&gt;</span><span class="n">wasdel</span> <span class="o">?</span> <span class="n">XFS_BTCUR_BPRV_WASDEL</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">bma</span><span class="o">-&gt;</span><span class="n">got</span><span class="p">.</span><span class="n">br_startoff</span> <span class="o">=</span> <span class="n">bma</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">;</span>
	<span class="n">bma</span><span class="o">-&gt;</span><span class="n">got</span><span class="p">.</span><span class="n">br_startblock</span> <span class="o">=</span> <span class="n">bma</span><span class="o">-&gt;</span><span class="n">blkno</span><span class="p">;</span>
	<span class="n">bma</span><span class="o">-&gt;</span><span class="n">got</span><span class="p">.</span><span class="n">br_blockcount</span> <span class="o">=</span> <span class="n">bma</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">;</span>
	<span class="n">bma</span><span class="o">-&gt;</span><span class="n">got</span><span class="p">.</span><span class="n">br_state</span> <span class="o">=</span> <span class="n">XFS_EXT_NORM</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * A wasdelay extent has been initialized, so shouldn&#39;t be flagged</span>
<span class="cm">	 * as unwritten.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bma</span><span class="o">-&gt;</span><span class="n">wasdel</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">XFS_BMAPI_PREALLOC</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">xfs_sb_version_hasextflgbit</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_sb</span><span class="p">))</span>
		<span class="n">bma</span><span class="o">-&gt;</span><span class="n">got</span><span class="p">.</span><span class="n">br_state</span> <span class="o">=</span> <span class="n">XFS_EXT_UNWRITTEN</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bma</span><span class="o">-&gt;</span><span class="n">wasdel</span><span class="p">)</span>
		<span class="n">error</span> <span class="o">=</span> <span class="n">xfs_bmap_add_extent_delay_real</span><span class="p">(</span><span class="n">bma</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">error</span> <span class="o">=</span> <span class="n">xfs_bmap_add_extent_hole_real</span><span class="p">(</span><span class="n">bma</span><span class="p">,</span> <span class="n">whichfork</span><span class="p">);</span>

	<span class="n">bma</span><span class="o">-&gt;</span><span class="n">logflags</span> <span class="o">|=</span> <span class="n">tmp_logflags</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">error</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Update our extent pointer, given that xfs_bmap_add_extent_delay_real</span>
<span class="cm">	 * or xfs_bmap_add_extent_hole_real might have merged it into one of</span>
<span class="cm">	 * the neighbouring ones.</span>
<span class="cm">	 */</span>
	<span class="n">xfs_bmbt_get_all</span><span class="p">(</span><span class="n">xfs_iext_get_ext</span><span class="p">(</span><span class="n">ifp</span><span class="p">,</span> <span class="n">bma</span><span class="o">-&gt;</span><span class="n">idx</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">bma</span><span class="o">-&gt;</span><span class="n">got</span><span class="p">);</span>

	<span class="n">ASSERT</span><span class="p">(</span><span class="n">bma</span><span class="o">-&gt;</span><span class="n">got</span><span class="p">.</span><span class="n">br_startoff</span> <span class="o">&lt;=</span> <span class="n">bma</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">);</span>
	<span class="n">ASSERT</span><span class="p">(</span><span class="n">bma</span><span class="o">-&gt;</span><span class="n">got</span><span class="p">.</span><span class="n">br_startoff</span> <span class="o">+</span> <span class="n">bma</span><span class="o">-&gt;</span><span class="n">got</span><span class="p">.</span><span class="n">br_blockcount</span> <span class="o">&gt;=</span>
	       <span class="n">bma</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">+</span> <span class="n">bma</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">);</span>
	<span class="n">ASSERT</span><span class="p">(</span><span class="n">bma</span><span class="o">-&gt;</span><span class="n">got</span><span class="p">.</span><span class="n">br_state</span> <span class="o">==</span> <span class="n">XFS_EXT_NORM</span> <span class="o">||</span>
	       <span class="n">bma</span><span class="o">-&gt;</span><span class="n">got</span><span class="p">.</span><span class="n">br_state</span> <span class="o">==</span> <span class="n">XFS_EXT_UNWRITTEN</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">STATIC</span> <span class="kt">int</span>
<span class="n">xfs_bmapi_convert_unwritten</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">xfs_bmalloca</span>	<span class="o">*</span><span class="n">bma</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">xfs_bmbt_irec</span>	<span class="o">*</span><span class="n">mval</span><span class="p">,</span>
	<span class="n">xfs_filblks_t</span>		<span class="n">len</span><span class="p">,</span>
	<span class="kt">int</span>			<span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span>			<span class="n">whichfork</span> <span class="o">=</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">XFS_BMAPI_ATTRFORK</span><span class="p">)</span> <span class="o">?</span>
						<span class="n">XFS_ATTR_FORK</span> <span class="o">:</span> <span class="n">XFS_DATA_FORK</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">xfs_ifork</span>	<span class="o">*</span><span class="n">ifp</span> <span class="o">=</span> <span class="n">XFS_IFORK_PTR</span><span class="p">(</span><span class="n">bma</span><span class="o">-&gt;</span><span class="n">ip</span><span class="p">,</span> <span class="n">whichfork</span><span class="p">);</span>
	<span class="kt">int</span>			<span class="n">tmp_logflags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">error</span><span class="p">;</span>

	<span class="cm">/* check if we need to do unwritten-&gt;real conversion */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mval</span><span class="o">-&gt;</span><span class="n">br_state</span> <span class="o">==</span> <span class="n">XFS_EXT_UNWRITTEN</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">XFS_BMAPI_PREALLOC</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* check if we need to do real-&gt;unwritten conversion */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mval</span><span class="o">-&gt;</span><span class="n">br_state</span> <span class="o">==</span> <span class="n">XFS_EXT_NORM</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">XFS_BMAPI_PREALLOC</span> <span class="o">|</span> <span class="n">XFS_BMAPI_CONVERT</span><span class="p">))</span> <span class="o">!=</span>
			<span class="p">(</span><span class="n">XFS_BMAPI_PREALLOC</span> <span class="o">|</span> <span class="n">XFS_BMAPI_CONVERT</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Modify (by adding) the state flag, if writing.</span>
<span class="cm">	 */</span>
	<span class="n">ASSERT</span><span class="p">(</span><span class="n">mval</span><span class="o">-&gt;</span><span class="n">br_blockcount</span> <span class="o">&lt;=</span> <span class="n">len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">ifp</span><span class="o">-&gt;</span><span class="n">if_flags</span> <span class="o">&amp;</span> <span class="n">XFS_IFBROOT</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">bma</span><span class="o">-&gt;</span><span class="n">cur</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bma</span><span class="o">-&gt;</span><span class="n">cur</span> <span class="o">=</span> <span class="n">xfs_bmbt_init_cursor</span><span class="p">(</span><span class="n">bma</span><span class="o">-&gt;</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_mount</span><span class="p">,</span> <span class="n">bma</span><span class="o">-&gt;</span><span class="n">tp</span><span class="p">,</span>
					<span class="n">bma</span><span class="o">-&gt;</span><span class="n">ip</span><span class="p">,</span> <span class="n">whichfork</span><span class="p">);</span>
		<span class="n">bma</span><span class="o">-&gt;</span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">bc_private</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">firstblock</span> <span class="o">=</span> <span class="o">*</span><span class="n">bma</span><span class="o">-&gt;</span><span class="n">firstblock</span><span class="p">;</span>
		<span class="n">bma</span><span class="o">-&gt;</span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">bc_private</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">flist</span> <span class="o">=</span> <span class="n">bma</span><span class="o">-&gt;</span><span class="n">flist</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">mval</span><span class="o">-&gt;</span><span class="n">br_state</span> <span class="o">=</span> <span class="p">(</span><span class="n">mval</span><span class="o">-&gt;</span><span class="n">br_state</span> <span class="o">==</span> <span class="n">XFS_EXT_UNWRITTEN</span><span class="p">)</span>
				<span class="o">?</span> <span class="n">XFS_EXT_NORM</span> <span class="o">:</span> <span class="n">XFS_EXT_UNWRITTEN</span><span class="p">;</span>

	<span class="n">error</span> <span class="o">=</span> <span class="n">xfs_bmap_add_extent_unwritten_real</span><span class="p">(</span><span class="n">bma</span><span class="o">-&gt;</span><span class="n">tp</span><span class="p">,</span> <span class="n">bma</span><span class="o">-&gt;</span><span class="n">ip</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bma</span><span class="o">-&gt;</span><span class="n">idx</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">bma</span><span class="o">-&gt;</span><span class="n">cur</span><span class="p">,</span> <span class="n">mval</span><span class="p">,</span> <span class="n">bma</span><span class="o">-&gt;</span><span class="n">firstblock</span><span class="p">,</span> <span class="n">bma</span><span class="o">-&gt;</span><span class="n">flist</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">tmp_logflags</span><span class="p">);</span>
	<span class="n">bma</span><span class="o">-&gt;</span><span class="n">logflags</span> <span class="o">|=</span> <span class="n">tmp_logflags</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">error</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Update our extent pointer, given that</span>
<span class="cm">	 * xfs_bmap_add_extent_unwritten_real might have merged it into one</span>
<span class="cm">	 * of the neighbouring ones.</span>
<span class="cm">	 */</span>
	<span class="n">xfs_bmbt_get_all</span><span class="p">(</span><span class="n">xfs_iext_get_ext</span><span class="p">(</span><span class="n">ifp</span><span class="p">,</span> <span class="n">bma</span><span class="o">-&gt;</span><span class="n">idx</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">bma</span><span class="o">-&gt;</span><span class="n">got</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * We may have combined previously unwritten space with written space,</span>
<span class="cm">	 * so generate another request.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mval</span><span class="o">-&gt;</span><span class="n">br_blockcount</span> <span class="o">&lt;</span> <span class="n">len</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">EAGAIN</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Map file blocks to filesystem blocks, and allocate blocks or convert the</span>
<span class="cm"> * extent state if necessary.  Details behaviour is controlled by the flags</span>
<span class="cm"> * parameter.  Only allocates blocks from a single allocation group, to avoid</span>
<span class="cm"> * locking problems.</span>
<span class="cm"> *</span>
<span class="cm"> * The returned value in &quot;firstblock&quot; from the first call in a transaction</span>
<span class="cm"> * must be remembered and presented to subsequent calls in &quot;firstblock&quot;.</span>
<span class="cm"> * An upper bound for the number of blocks to be allocated is supplied to</span>
<span class="cm"> * the first call in &quot;total&quot;; if no allocation group has that many free</span>
<span class="cm"> * blocks then the call will fail (return NULLFSBLOCK in &quot;firstblock&quot;).</span>
<span class="cm"> */</span>
<span class="kt">int</span>
<span class="n">xfs_bmapi_write</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">xfs_trans</span>	<span class="o">*</span><span class="n">tp</span><span class="p">,</span>		<span class="cm">/* transaction pointer */</span>
	<span class="k">struct</span> <span class="n">xfs_inode</span>	<span class="o">*</span><span class="n">ip</span><span class="p">,</span>		<span class="cm">/* incore inode */</span>
	<span class="n">xfs_fileoff_t</span>		<span class="n">bno</span><span class="p">,</span>		<span class="cm">/* starting file offs. mapped */</span>
	<span class="n">xfs_filblks_t</span>		<span class="n">len</span><span class="p">,</span>		<span class="cm">/* length to map in file */</span>
	<span class="kt">int</span>			<span class="n">flags</span><span class="p">,</span>		<span class="cm">/* XFS_BMAPI_... */</span>
	<span class="n">xfs_fsblock_t</span>		<span class="o">*</span><span class="n">firstblock</span><span class="p">,</span>	<span class="cm">/* first allocated block</span>
<span class="cm">						   controls a.g. for allocs */</span>
	<span class="n">xfs_extlen_t</span>		<span class="n">total</span><span class="p">,</span>		<span class="cm">/* total blocks needed */</span>
	<span class="k">struct</span> <span class="n">xfs_bmbt_irec</span>	<span class="o">*</span><span class="n">mval</span><span class="p">,</span>		<span class="cm">/* output: map values */</span>
	<span class="kt">int</span>			<span class="o">*</span><span class="n">nmap</span><span class="p">,</span>		<span class="cm">/* i/o: mval size/count */</span>
	<span class="k">struct</span> <span class="n">xfs_bmap_free</span>	<span class="o">*</span><span class="n">flist</span><span class="p">)</span>		<span class="cm">/* i/o: list extents to free */</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">xfs_mount</span>	<span class="o">*</span><span class="n">mp</span> <span class="o">=</span> <span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_mount</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">xfs_ifork</span>	<span class="o">*</span><span class="n">ifp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">xfs_bmalloca</span>	<span class="n">bma</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">0</span> <span class="p">};</span>	<span class="cm">/* args for xfs_bmap_alloc */</span>
	<span class="n">xfs_fileoff_t</span>		<span class="n">end</span><span class="p">;</span>		<span class="cm">/* end of mapped file region */</span>
	<span class="kt">int</span>			<span class="n">eof</span><span class="p">;</span>		<span class="cm">/* after the end of extents */</span>
	<span class="kt">int</span>			<span class="n">error</span><span class="p">;</span>		<span class="cm">/* error return */</span>
	<span class="kt">int</span>			<span class="n">n</span><span class="p">;</span>		<span class="cm">/* current extent index */</span>
	<span class="n">xfs_fileoff_t</span>		<span class="n">obno</span><span class="p">;</span>		<span class="cm">/* old block number (offset) */</span>
	<span class="kt">int</span>			<span class="n">whichfork</span><span class="p">;</span>	<span class="cm">/* data or attr fork */</span>
	<span class="kt">char</span>			<span class="n">inhole</span><span class="p">;</span>		<span class="cm">/* current location is hole in file */</span>
	<span class="kt">char</span>			<span class="n">wasdelay</span><span class="p">;</span>	<span class="cm">/* old extent was delayed */</span>

<span class="cp">#ifdef DEBUG</span>
	<span class="n">xfs_fileoff_t</span>		<span class="n">orig_bno</span><span class="p">;</span>	<span class="cm">/* original block number value */</span>
	<span class="kt">int</span>			<span class="n">orig_flags</span><span class="p">;</span>	<span class="cm">/* original flags arg value */</span>
	<span class="n">xfs_filblks_t</span>		<span class="n">orig_len</span><span class="p">;</span>	<span class="cm">/* original value of len arg */</span>
	<span class="k">struct</span> <span class="n">xfs_bmbt_irec</span>	<span class="o">*</span><span class="n">orig_mval</span><span class="p">;</span>	<span class="cm">/* original value of mval */</span>
	<span class="kt">int</span>			<span class="n">orig_nmap</span><span class="p">;</span>	<span class="cm">/* original value of *nmap */</span>

	<span class="n">orig_bno</span> <span class="o">=</span> <span class="n">bno</span><span class="p">;</span>
	<span class="n">orig_len</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>
	<span class="n">orig_flags</span> <span class="o">=</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">orig_mval</span> <span class="o">=</span> <span class="n">mval</span><span class="p">;</span>
	<span class="n">orig_nmap</span> <span class="o">=</span> <span class="o">*</span><span class="n">nmap</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="n">ASSERT</span><span class="p">(</span><span class="o">*</span><span class="n">nmap</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">ASSERT</span><span class="p">(</span><span class="o">*</span><span class="n">nmap</span> <span class="o">&lt;=</span> <span class="n">XFS_BMAP_MAX_NMAP</span><span class="p">);</span>
	<span class="n">ASSERT</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">XFS_BMAPI_IGSTATE</span><span class="p">));</span>
	<span class="n">ASSERT</span><span class="p">(</span><span class="n">tp</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">ASSERT</span><span class="p">(</span><span class="n">len</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">whichfork</span> <span class="o">=</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">XFS_BMAPI_ATTRFORK</span><span class="p">)</span> <span class="o">?</span>
		<span class="n">XFS_ATTR_FORK</span> <span class="o">:</span> <span class="n">XFS_DATA_FORK</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">XFS_TEST_ERROR</span><span class="p">(</span>
	    <span class="p">(</span><span class="n">XFS_IFORK_FORMAT</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">whichfork</span><span class="p">)</span> <span class="o">!=</span> <span class="n">XFS_DINODE_FMT_EXTENTS</span> <span class="o">&amp;&amp;</span>
	     <span class="n">XFS_IFORK_FORMAT</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">whichfork</span><span class="p">)</span> <span class="o">!=</span> <span class="n">XFS_DINODE_FMT_BTREE</span> <span class="o">&amp;&amp;</span>
	     <span class="n">XFS_IFORK_FORMAT</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">whichfork</span><span class="p">)</span> <span class="o">!=</span> <span class="n">XFS_DINODE_FMT_LOCAL</span><span class="p">),</span>
	     <span class="n">mp</span><span class="p">,</span> <span class="n">XFS_ERRTAG_BMAPIFORMAT</span><span class="p">,</span> <span class="n">XFS_RANDOM_BMAPIFORMAT</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">XFS_ERROR_REPORT</span><span class="p">(</span><span class="s">&quot;xfs_bmapi_write&quot;</span><span class="p">,</span> <span class="n">XFS_ERRLEVEL_LOW</span><span class="p">,</span> <span class="n">mp</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">XFS_ERROR</span><span class="p">(</span><span class="n">EFSCORRUPTED</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">XFS_FORCED_SHUTDOWN</span><span class="p">(</span><span class="n">mp</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">XFS_ERROR</span><span class="p">(</span><span class="n">EIO</span><span class="p">);</span>

	<span class="n">ifp</span> <span class="o">=</span> <span class="n">XFS_IFORK_PTR</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">whichfork</span><span class="p">);</span>

	<span class="n">XFS_STATS_INC</span><span class="p">(</span><span class="n">xs_blk_mapw</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">XFS_IFORK_FORMAT</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">whichfork</span><span class="p">)</span> <span class="o">==</span> <span class="n">XFS_DINODE_FMT_LOCAL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">error</span> <span class="o">=</span> <span class="n">xfs_bmap_local_to_extents</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">ip</span><span class="p">,</span> <span class="n">firstblock</span><span class="p">,</span> <span class="n">total</span><span class="p">,</span>
						  <span class="o">&amp;</span><span class="n">bma</span><span class="p">.</span><span class="n">logflags</span><span class="p">,</span> <span class="n">whichfork</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">error0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">firstblock</span> <span class="o">==</span> <span class="n">NULLFSBLOCK</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">XFS_IFORK_FORMAT</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">whichfork</span><span class="p">)</span> <span class="o">==</span> <span class="n">XFS_DINODE_FMT_BTREE</span><span class="p">)</span>
			<span class="n">bma</span><span class="p">.</span><span class="n">minleft</span> <span class="o">=</span> <span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">ifp</span><span class="o">-&gt;</span><span class="n">if_broot</span><span class="o">-&gt;</span><span class="n">bb_level</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">bma</span><span class="p">.</span><span class="n">minleft</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">bma</span><span class="p">.</span><span class="n">minleft</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ifp</span><span class="o">-&gt;</span><span class="n">if_flags</span> <span class="o">&amp;</span> <span class="n">XFS_IFEXTENTS</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">error</span> <span class="o">=</span> <span class="n">xfs_iread_extents</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">ip</span><span class="p">,</span> <span class="n">whichfork</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">error0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">xfs_bmap_search_extents</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">bno</span><span class="p">,</span> <span class="n">whichfork</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">eof</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bma</span><span class="p">.</span><span class="n">idx</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bma</span><span class="p">.</span><span class="n">got</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="n">bma</span><span class="p">.</span><span class="n">prev</span><span class="p">);</span>
	<span class="n">n</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">end</span> <span class="o">=</span> <span class="n">bno</span> <span class="o">+</span> <span class="n">len</span><span class="p">;</span>
	<span class="n">obno</span> <span class="o">=</span> <span class="n">bno</span><span class="p">;</span>

	<span class="n">bma</span><span class="p">.</span><span class="n">tp</span> <span class="o">=</span> <span class="n">tp</span><span class="p">;</span>
	<span class="n">bma</span><span class="p">.</span><span class="n">ip</span> <span class="o">=</span> <span class="n">ip</span><span class="p">;</span>
	<span class="n">bma</span><span class="p">.</span><span class="n">total</span> <span class="o">=</span> <span class="n">total</span><span class="p">;</span>
	<span class="n">bma</span><span class="p">.</span><span class="n">userdata</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">bma</span><span class="p">.</span><span class="n">flist</span> <span class="o">=</span> <span class="n">flist</span><span class="p">;</span>
	<span class="n">bma</span><span class="p">.</span><span class="n">firstblock</span> <span class="o">=</span> <span class="n">firstblock</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">bno</span> <span class="o">&lt;</span> <span class="n">end</span> <span class="o">&amp;&amp;</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="o">*</span><span class="n">nmap</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">inhole</span> <span class="o">=</span> <span class="n">eof</span> <span class="o">||</span> <span class="n">bma</span><span class="p">.</span><span class="n">got</span><span class="p">.</span><span class="n">br_startoff</span> <span class="o">&gt;</span> <span class="n">bno</span><span class="p">;</span>
		<span class="n">wasdelay</span> <span class="o">=</span> <span class="o">!</span><span class="n">inhole</span> <span class="o">&amp;&amp;</span> <span class="n">isnullstartblock</span><span class="p">(</span><span class="n">bma</span><span class="p">.</span><span class="n">got</span><span class="p">.</span><span class="n">br_startblock</span><span class="p">);</span>

		<span class="cm">/*</span>
<span class="cm">		 * First, deal with the hole before the allocated space</span>
<span class="cm">		 * that we found, if any.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">inhole</span> <span class="o">||</span> <span class="n">wasdelay</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">bma</span><span class="p">.</span><span class="n">eof</span> <span class="o">=</span> <span class="n">eof</span><span class="p">;</span>
			<span class="n">bma</span><span class="p">.</span><span class="n">conv</span> <span class="o">=</span> <span class="o">!!</span><span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">XFS_BMAPI_CONVERT</span><span class="p">);</span>
			<span class="n">bma</span><span class="p">.</span><span class="n">wasdel</span> <span class="o">=</span> <span class="n">wasdelay</span><span class="p">;</span>
			<span class="n">bma</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="n">bno</span><span class="p">;</span>

			<span class="cm">/*</span>
<span class="cm">			 * There&#39;s a 32/64 bit type mismatch between the</span>
<span class="cm">			 * allocation length request (which can be 64 bits in</span>
<span class="cm">			 * length) and the bma length request, which is</span>
<span class="cm">			 * xfs_extlen_t and therefore 32 bits. Hence we have to</span>
<span class="cm">			 * check for 32-bit overflows and handle them here.</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">xfs_filblks_t</span><span class="p">)</span><span class="n">MAXEXTLEN</span><span class="p">)</span>
				<span class="n">bma</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="n">MAXEXTLEN</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">bma</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>

			<span class="n">ASSERT</span><span class="p">(</span><span class="n">len</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">ASSERT</span><span class="p">(</span><span class="n">bma</span><span class="p">.</span><span class="n">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">error</span> <span class="o">=</span> <span class="n">xfs_bmapi_allocate</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bma</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">error0</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">bma</span><span class="p">.</span><span class="n">blkno</span> <span class="o">==</span> <span class="n">NULLFSBLOCK</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* Deal with the allocated space we found.  */</span>
		<span class="n">xfs_bmapi_trim_map</span><span class="p">(</span><span class="n">mval</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bma</span><span class="p">.</span><span class="n">got</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bno</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">obno</span><span class="p">,</span>
							<span class="n">end</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

		<span class="cm">/* Execute unwritten extent conversion if necessary */</span>
		<span class="n">error</span> <span class="o">=</span> <span class="n">xfs_bmapi_convert_unwritten</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bma</span><span class="p">,</span> <span class="n">mval</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">error</span> <span class="o">==</span> <span class="n">EAGAIN</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">error0</span><span class="p">;</span>

		<span class="cm">/* update the extent map to return */</span>
		<span class="n">xfs_bmapi_update_map</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mval</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bno</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">len</span><span class="p">,</span> <span class="n">obno</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">n</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

		<span class="cm">/*</span>
<span class="cm">		 * If we&#39;re done, stop now.  Stop when we&#39;ve allocated</span>
<span class="cm">		 * XFS_BMAP_MAX_NMAP extents no matter what.  Otherwise</span>
<span class="cm">		 * the transaction may get too big.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bno</span> <span class="o">&gt;=</span> <span class="n">end</span> <span class="o">||</span> <span class="n">n</span> <span class="o">&gt;=</span> <span class="o">*</span><span class="n">nmap</span> <span class="o">||</span> <span class="n">bma</span><span class="p">.</span><span class="n">nallocs</span> <span class="o">&gt;=</span> <span class="o">*</span><span class="n">nmap</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="cm">/* Else go on to the next record. */</span>
		<span class="n">bma</span><span class="p">.</span><span class="n">prev</span> <span class="o">=</span> <span class="n">bma</span><span class="p">.</span><span class="n">got</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="n">bma</span><span class="p">.</span><span class="n">idx</span> <span class="o">&lt;</span> <span class="n">ifp</span><span class="o">-&gt;</span><span class="n">if_bytes</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">xfs_bmbt_rec_t</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">xfs_bmbt_get_all</span><span class="p">(</span><span class="n">xfs_iext_get_ext</span><span class="p">(</span><span class="n">ifp</span><span class="p">,</span> <span class="n">bma</span><span class="p">.</span><span class="n">idx</span><span class="p">),</span>
					 <span class="o">&amp;</span><span class="n">bma</span><span class="p">.</span><span class="n">got</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">eof</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="o">*</span><span class="n">nmap</span> <span class="o">=</span> <span class="n">n</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Transform from btree to extents, give it cur.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">xfs_bmap_wants_extents</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">whichfork</span><span class="p">))</span> <span class="p">{</span>
		<span class="kt">int</span>		<span class="n">tmp_logflags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">ASSERT</span><span class="p">(</span><span class="n">bma</span><span class="p">.</span><span class="n">cur</span><span class="p">);</span>
		<span class="n">error</span> <span class="o">=</span> <span class="n">xfs_bmap_btree_to_extents</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">ip</span><span class="p">,</span> <span class="n">bma</span><span class="p">.</span><span class="n">cur</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">tmp_logflags</span><span class="p">,</span> <span class="n">whichfork</span><span class="p">);</span>
		<span class="n">bma</span><span class="p">.</span><span class="n">logflags</span> <span class="o">|=</span> <span class="n">tmp_logflags</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">error0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ASSERT</span><span class="p">(</span><span class="n">XFS_IFORK_FORMAT</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">whichfork</span><span class="p">)</span> <span class="o">!=</span> <span class="n">XFS_DINODE_FMT_BTREE</span> <span class="o">||</span>
	       <span class="n">XFS_IFORK_NEXTENTS</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">whichfork</span><span class="p">)</span> <span class="o">&gt;</span>
		<span class="n">XFS_IFORK_MAXEXT</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">whichfork</span><span class="p">));</span>
	<span class="n">error</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">error0:</span>
	<span class="cm">/*</span>
<span class="cm">	 * Log everything.  Do this after conversion, there&#39;s no point in</span>
<span class="cm">	 * logging the extent records if we&#39;ve converted to btree format.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">bma</span><span class="p">.</span><span class="n">logflags</span> <span class="o">&amp;</span> <span class="n">xfs_ilog_fext</span><span class="p">(</span><span class="n">whichfork</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
	    <span class="n">XFS_IFORK_FORMAT</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">whichfork</span><span class="p">)</span> <span class="o">!=</span> <span class="n">XFS_DINODE_FMT_EXTENTS</span><span class="p">)</span>
		<span class="n">bma</span><span class="p">.</span><span class="n">logflags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">xfs_ilog_fext</span><span class="p">(</span><span class="n">whichfork</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">bma</span><span class="p">.</span><span class="n">logflags</span> <span class="o">&amp;</span> <span class="n">xfs_ilog_fbroot</span><span class="p">(</span><span class="n">whichfork</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
		 <span class="n">XFS_IFORK_FORMAT</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">whichfork</span><span class="p">)</span> <span class="o">!=</span> <span class="n">XFS_DINODE_FMT_BTREE</span><span class="p">)</span>
		<span class="n">bma</span><span class="p">.</span><span class="n">logflags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">xfs_ilog_fbroot</span><span class="p">(</span><span class="n">whichfork</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 * Log whatever the flags say, even if error.  Otherwise we might miss</span>
<span class="cm">	 * detecting a case where the data is changed, there&#39;s an error,</span>
<span class="cm">	 * and it&#39;s not logged so we don&#39;t shutdown when we should.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bma</span><span class="p">.</span><span class="n">logflags</span><span class="p">)</span>
		<span class="n">xfs_trans_log_inode</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">ip</span><span class="p">,</span> <span class="n">bma</span><span class="p">.</span><span class="n">logflags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bma</span><span class="p">.</span><span class="n">cur</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ASSERT</span><span class="p">(</span><span class="o">*</span><span class="n">firstblock</span> <span class="o">==</span> <span class="n">NULLFSBLOCK</span> <span class="o">||</span>
			       <span class="n">XFS_FSB_TO_AGNO</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="o">*</span><span class="n">firstblock</span><span class="p">)</span> <span class="o">==</span>
			       <span class="n">XFS_FSB_TO_AGNO</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span>
				       <span class="n">bma</span><span class="p">.</span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">bc_private</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">firstblock</span><span class="p">)</span> <span class="o">||</span>
			       <span class="p">(</span><span class="n">flist</span><span class="o">-&gt;</span><span class="n">xbf_low</span> <span class="o">&amp;&amp;</span>
				<span class="n">XFS_FSB_TO_AGNO</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="o">*</span><span class="n">firstblock</span><span class="p">)</span> <span class="o">&lt;</span>
				<span class="n">XFS_FSB_TO_AGNO</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span>
					<span class="n">bma</span><span class="p">.</span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">bc_private</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">firstblock</span><span class="p">)));</span>
			<span class="o">*</span><span class="n">firstblock</span> <span class="o">=</span> <span class="n">bma</span><span class="p">.</span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">bc_private</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">firstblock</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">xfs_btree_del_cursor</span><span class="p">(</span><span class="n">bma</span><span class="p">.</span><span class="n">cur</span><span class="p">,</span>
			<span class="n">error</span> <span class="o">?</span> <span class="n">XFS_BTREE_ERROR</span> <span class="o">:</span> <span class="n">XFS_BTREE_NOERROR</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">error</span><span class="p">)</span>
		<span class="n">xfs_bmap_validate_ret</span><span class="p">(</span><span class="n">orig_bno</span><span class="p">,</span> <span class="n">orig_len</span><span class="p">,</span> <span class="n">orig_flags</span><span class="p">,</span> <span class="n">orig_mval</span><span class="p">,</span>
			<span class="n">orig_nmap</span><span class="p">,</span> <span class="o">*</span><span class="n">nmap</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Unmap (remove) blocks from a file.</span>
<span class="cm"> * If nexts is nonzero then the number of extents to remove is limited to</span>
<span class="cm"> * that value.  If not all extents in the block range can be removed then</span>
<span class="cm"> * *done is set.</span>
<span class="cm"> */</span>
<span class="kt">int</span>						<span class="cm">/* error */</span>
<span class="n">xfs_bunmapi</span><span class="p">(</span>
	<span class="n">xfs_trans_t</span>		<span class="o">*</span><span class="n">tp</span><span class="p">,</span>		<span class="cm">/* transaction pointer */</span>
	<span class="k">struct</span> <span class="n">xfs_inode</span>	<span class="o">*</span><span class="n">ip</span><span class="p">,</span>		<span class="cm">/* incore inode */</span>
	<span class="n">xfs_fileoff_t</span>		<span class="n">bno</span><span class="p">,</span>		<span class="cm">/* starting offset to unmap */</span>
	<span class="n">xfs_filblks_t</span>		<span class="n">len</span><span class="p">,</span>		<span class="cm">/* length to unmap in file */</span>
	<span class="kt">int</span>			<span class="n">flags</span><span class="p">,</span>		<span class="cm">/* misc flags */</span>
	<span class="n">xfs_extnum_t</span>		<span class="n">nexts</span><span class="p">,</span>		<span class="cm">/* number of extents max */</span>
	<span class="n">xfs_fsblock_t</span>		<span class="o">*</span><span class="n">firstblock</span><span class="p">,</span>	<span class="cm">/* first allocated block</span>
<span class="cm">						   controls a.g. for allocs */</span>
	<span class="n">xfs_bmap_free_t</span>		<span class="o">*</span><span class="n">flist</span><span class="p">,</span>		<span class="cm">/* i/o: list extents to free */</span>
	<span class="kt">int</span>			<span class="o">*</span><span class="n">done</span><span class="p">)</span>		<span class="cm">/* set if not done yet */</span>
<span class="p">{</span>
	<span class="n">xfs_btree_cur_t</span>		<span class="o">*</span><span class="n">cur</span><span class="p">;</span>		<span class="cm">/* bmap btree cursor */</span>
	<span class="n">xfs_bmbt_irec_t</span>		<span class="n">del</span><span class="p">;</span>		<span class="cm">/* extent being deleted */</span>
	<span class="kt">int</span>			<span class="n">eof</span><span class="p">;</span>		<span class="cm">/* is deleting at eof */</span>
	<span class="n">xfs_bmbt_rec_host_t</span>	<span class="o">*</span><span class="n">ep</span><span class="p">;</span>		<span class="cm">/* extent record pointer */</span>
	<span class="kt">int</span>			<span class="n">error</span><span class="p">;</span>		<span class="cm">/* error return value */</span>
	<span class="n">xfs_extnum_t</span>		<span class="n">extno</span><span class="p">;</span>		<span class="cm">/* extent number in list */</span>
	<span class="n">xfs_bmbt_irec_t</span>		<span class="n">got</span><span class="p">;</span>		<span class="cm">/* current extent record */</span>
	<span class="n">xfs_ifork_t</span>		<span class="o">*</span><span class="n">ifp</span><span class="p">;</span>		<span class="cm">/* inode fork pointer */</span>
	<span class="kt">int</span>			<span class="n">isrt</span><span class="p">;</span>		<span class="cm">/* freeing in rt area */</span>
	<span class="n">xfs_extnum_t</span>		<span class="n">lastx</span><span class="p">;</span>		<span class="cm">/* last extent index used */</span>
	<span class="kt">int</span>			<span class="n">logflags</span><span class="p">;</span>	<span class="cm">/* transaction logging flags */</span>
	<span class="n">xfs_extlen_t</span>		<span class="n">mod</span><span class="p">;</span>		<span class="cm">/* rt extent offset */</span>
	<span class="n">xfs_mount_t</span>		<span class="o">*</span><span class="n">mp</span><span class="p">;</span>		<span class="cm">/* mount structure */</span>
	<span class="n">xfs_extnum_t</span>		<span class="n">nextents</span><span class="p">;</span>	<span class="cm">/* number of file extents */</span>
	<span class="n">xfs_bmbt_irec_t</span>		<span class="n">prev</span><span class="p">;</span>		<span class="cm">/* previous extent record */</span>
	<span class="n">xfs_fileoff_t</span>		<span class="n">start</span><span class="p">;</span>		<span class="cm">/* first file offset deleted */</span>
	<span class="kt">int</span>			<span class="n">tmp_logflags</span><span class="p">;</span>	<span class="cm">/* partial logging flags */</span>
	<span class="kt">int</span>			<span class="n">wasdel</span><span class="p">;</span>		<span class="cm">/* was a delayed alloc extent */</span>
	<span class="kt">int</span>			<span class="n">whichfork</span><span class="p">;</span>	<span class="cm">/* data or attribute fork */</span>
	<span class="n">xfs_fsblock_t</span>		<span class="n">sum</span><span class="p">;</span>

	<span class="n">trace_xfs_bunmap</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">bno</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">flags</span><span class="p">,</span> <span class="n">_RET_IP_</span><span class="p">);</span>

	<span class="n">whichfork</span> <span class="o">=</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">XFS_BMAPI_ATTRFORK</span><span class="p">)</span> <span class="o">?</span>
		<span class="n">XFS_ATTR_FORK</span> <span class="o">:</span> <span class="n">XFS_DATA_FORK</span><span class="p">;</span>
	<span class="n">ifp</span> <span class="o">=</span> <span class="n">XFS_IFORK_PTR</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">whichfork</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span>
	    <span class="n">XFS_IFORK_FORMAT</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">whichfork</span><span class="p">)</span> <span class="o">!=</span> <span class="n">XFS_DINODE_FMT_EXTENTS</span> <span class="o">&amp;&amp;</span>
	    <span class="n">XFS_IFORK_FORMAT</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">whichfork</span><span class="p">)</span> <span class="o">!=</span> <span class="n">XFS_DINODE_FMT_BTREE</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">XFS_ERROR_REPORT</span><span class="p">(</span><span class="s">&quot;xfs_bunmapi&quot;</span><span class="p">,</span> <span class="n">XFS_ERRLEVEL_LOW</span><span class="p">,</span>
				 <span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_mount</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">XFS_ERROR</span><span class="p">(</span><span class="n">EFSCORRUPTED</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">mp</span> <span class="o">=</span> <span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_mount</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">XFS_FORCED_SHUTDOWN</span><span class="p">(</span><span class="n">mp</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">XFS_ERROR</span><span class="p">(</span><span class="n">EIO</span><span class="p">);</span>

	<span class="n">ASSERT</span><span class="p">(</span><span class="n">len</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">ASSERT</span><span class="p">(</span><span class="n">nexts</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ifp</span><span class="o">-&gt;</span><span class="n">if_flags</span> <span class="o">&amp;</span> <span class="n">XFS_IFEXTENTS</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">error</span> <span class="o">=</span> <span class="n">xfs_iread_extents</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">ip</span><span class="p">,</span> <span class="n">whichfork</span><span class="p">)))</span>
		<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">nextents</span> <span class="o">=</span> <span class="n">ifp</span><span class="o">-&gt;</span><span class="n">if_bytes</span> <span class="o">/</span> <span class="p">(</span><span class="n">uint</span><span class="p">)</span><span class="k">sizeof</span><span class="p">(</span><span class="n">xfs_bmbt_rec_t</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nextents</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">done</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">XFS_STATS_INC</span><span class="p">(</span><span class="n">xs_blk_unmap</span><span class="p">);</span>
	<span class="n">isrt</span> <span class="o">=</span> <span class="p">(</span><span class="n">whichfork</span> <span class="o">==</span> <span class="n">XFS_DATA_FORK</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">XFS_IS_REALTIME_INODE</span><span class="p">(</span><span class="n">ip</span><span class="p">);</span>
	<span class="n">start</span> <span class="o">=</span> <span class="n">bno</span><span class="p">;</span>
	<span class="n">bno</span> <span class="o">=</span> <span class="n">start</span> <span class="o">+</span> <span class="n">len</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">ep</span> <span class="o">=</span> <span class="n">xfs_bmap_search_extents</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">bno</span><span class="p">,</span> <span class="n">whichfork</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">eof</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">lastx</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">got</span><span class="p">,</span>
		<span class="o">&amp;</span><span class="n">prev</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Check to see if the given block number is past the end of the</span>
<span class="cm">	 * file, back up to the last block if so...</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">eof</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ep</span> <span class="o">=</span> <span class="n">xfs_iext_get_ext</span><span class="p">(</span><span class="n">ifp</span><span class="p">,</span> <span class="o">--</span><span class="n">lastx</span><span class="p">);</span>
		<span class="n">xfs_bmbt_get_all</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">got</span><span class="p">);</span>
		<span class="n">bno</span> <span class="o">=</span> <span class="n">got</span><span class="p">.</span><span class="n">br_startoff</span> <span class="o">+</span> <span class="n">got</span><span class="p">.</span><span class="n">br_blockcount</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">logflags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ifp</span><span class="o">-&gt;</span><span class="n">if_flags</span> <span class="o">&amp;</span> <span class="n">XFS_IFBROOT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ASSERT</span><span class="p">(</span><span class="n">XFS_IFORK_FORMAT</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">whichfork</span><span class="p">)</span> <span class="o">==</span> <span class="n">XFS_DINODE_FMT_BTREE</span><span class="p">);</span>
		<span class="n">cur</span> <span class="o">=</span> <span class="n">xfs_bmbt_init_cursor</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="n">tp</span><span class="p">,</span> <span class="n">ip</span><span class="p">,</span> <span class="n">whichfork</span><span class="p">);</span>
		<span class="n">cur</span><span class="o">-&gt;</span><span class="n">bc_private</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">firstblock</span> <span class="o">=</span> <span class="o">*</span><span class="n">firstblock</span><span class="p">;</span>
		<span class="n">cur</span><span class="o">-&gt;</span><span class="n">bc_private</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">flist</span> <span class="o">=</span> <span class="n">flist</span><span class="p">;</span>
		<span class="n">cur</span><span class="o">-&gt;</span><span class="n">bc_private</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">cur</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">isrt</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Synchronize by locking the bitmap inode.</span>
<span class="cm">		 */</span>
		<span class="n">xfs_ilock</span><span class="p">(</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_rbmip</span><span class="p">,</span> <span class="n">XFS_ILOCK_EXCL</span><span class="p">);</span>
		<span class="n">xfs_trans_ijoin</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_rbmip</span><span class="p">,</span> <span class="n">XFS_ILOCK_EXCL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">extno</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">bno</span> <span class="o">!=</span> <span class="p">(</span><span class="n">xfs_fileoff_t</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">bno</span> <span class="o">&gt;=</span> <span class="n">start</span> <span class="o">&amp;&amp;</span> <span class="n">lastx</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
	       <span class="p">(</span><span class="n">nexts</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">extno</span> <span class="o">&lt;</span> <span class="n">nexts</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Is the found extent after a hole in which bno lives?</span>
<span class="cm">		 * Just back up to the previous extent, if so.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">got</span><span class="p">.</span><span class="n">br_startoff</span> <span class="o">&gt;</span> <span class="n">bno</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">--</span><span class="n">lastx</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="n">ep</span> <span class="o">=</span> <span class="n">xfs_iext_get_ext</span><span class="p">(</span><span class="n">ifp</span><span class="p">,</span> <span class="n">lastx</span><span class="p">);</span>
			<span class="n">xfs_bmbt_get_all</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">got</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="cm">/*</span>
<span class="cm">		 * Is the last block of this extent before the range</span>
<span class="cm">		 * we&#39;re supposed to delete?  If so, we&#39;re done.</span>
<span class="cm">		 */</span>
		<span class="n">bno</span> <span class="o">=</span> <span class="n">XFS_FILEOFF_MIN</span><span class="p">(</span><span class="n">bno</span><span class="p">,</span>
			<span class="n">got</span><span class="p">.</span><span class="n">br_startoff</span> <span class="o">+</span> <span class="n">got</span><span class="p">.</span><span class="n">br_blockcount</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bno</span> <span class="o">&lt;</span> <span class="n">start</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="cm">/*</span>
<span class="cm">		 * Then deal with the (possibly delayed) allocated space</span>
<span class="cm">		 * we found.</span>
<span class="cm">		 */</span>
		<span class="n">ASSERT</span><span class="p">(</span><span class="n">ep</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="n">del</span> <span class="o">=</span> <span class="n">got</span><span class="p">;</span>
		<span class="n">wasdel</span> <span class="o">=</span> <span class="n">isnullstartblock</span><span class="p">(</span><span class="n">del</span><span class="p">.</span><span class="n">br_startblock</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">got</span><span class="p">.</span><span class="n">br_startoff</span> <span class="o">&lt;</span> <span class="n">start</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">del</span><span class="p">.</span><span class="n">br_startoff</span> <span class="o">=</span> <span class="n">start</span><span class="p">;</span>
			<span class="n">del</span><span class="p">.</span><span class="n">br_blockcount</span> <span class="o">-=</span> <span class="n">start</span> <span class="o">-</span> <span class="n">got</span><span class="p">.</span><span class="n">br_startoff</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">wasdel</span><span class="p">)</span>
				<span class="n">del</span><span class="p">.</span><span class="n">br_startblock</span> <span class="o">+=</span> <span class="n">start</span> <span class="o">-</span> <span class="n">got</span><span class="p">.</span><span class="n">br_startoff</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">del</span><span class="p">.</span><span class="n">br_startoff</span> <span class="o">+</span> <span class="n">del</span><span class="p">.</span><span class="n">br_blockcount</span> <span class="o">&gt;</span> <span class="n">bno</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
			<span class="n">del</span><span class="p">.</span><span class="n">br_blockcount</span> <span class="o">=</span> <span class="n">bno</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">del</span><span class="p">.</span><span class="n">br_startoff</span><span class="p">;</span>
		<span class="n">sum</span> <span class="o">=</span> <span class="n">del</span><span class="p">.</span><span class="n">br_startblock</span> <span class="o">+</span> <span class="n">del</span><span class="p">.</span><span class="n">br_blockcount</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">isrt</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">mod</span> <span class="o">=</span> <span class="n">do_mod</span><span class="p">(</span><span class="n">sum</span><span class="p">,</span> <span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_sb</span><span class="p">.</span><span class="n">sb_rextsize</span><span class="p">)))</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * Realtime extent not lined up at the end.</span>
<span class="cm">			 * The extent could have been split into written</span>
<span class="cm">			 * and unwritten pieces, or we could just be</span>
<span class="cm">			 * unmapping part of it.  But we can&#39;t really</span>
<span class="cm">			 * get rid of part of a realtime extent.</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">del</span><span class="p">.</span><span class="n">br_state</span> <span class="o">==</span> <span class="n">XFS_EXT_UNWRITTEN</span> <span class="o">||</span>
			    <span class="o">!</span><span class="n">xfs_sb_version_hasextflgbit</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_sb</span><span class="p">))</span> <span class="p">{</span>
				<span class="cm">/*</span>
<span class="cm">				 * This piece is unwritten, or we&#39;re not</span>
<span class="cm">				 * using unwritten extents.  Skip over it.</span>
<span class="cm">				 */</span>
				<span class="n">ASSERT</span><span class="p">(</span><span class="n">bno</span> <span class="o">&gt;=</span> <span class="n">mod</span><span class="p">);</span>
				<span class="n">bno</span> <span class="o">-=</span> <span class="n">mod</span> <span class="o">&gt;</span> <span class="n">del</span><span class="p">.</span><span class="n">br_blockcount</span> <span class="o">?</span>
					<span class="n">del</span><span class="p">.</span><span class="n">br_blockcount</span> <span class="o">:</span> <span class="n">mod</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">bno</span> <span class="o">&lt;</span> <span class="n">got</span><span class="p">.</span><span class="n">br_startoff</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="o">--</span><span class="n">lastx</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
						<span class="n">xfs_bmbt_get_all</span><span class="p">(</span><span class="n">xfs_iext_get_ext</span><span class="p">(</span>
							<span class="n">ifp</span><span class="p">,</span> <span class="n">lastx</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">got</span><span class="p">);</span>
				<span class="p">}</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="cm">/*</span>
<span class="cm">			 * It&#39;s written, turn it unwritten.</span>
<span class="cm">			 * This is better than zeroing it.</span>
<span class="cm">			 */</span>
			<span class="n">ASSERT</span><span class="p">(</span><span class="n">del</span><span class="p">.</span><span class="n">br_state</span> <span class="o">==</span> <span class="n">XFS_EXT_NORM</span><span class="p">);</span>
			<span class="n">ASSERT</span><span class="p">(</span><span class="n">xfs_trans_get_block_res</span><span class="p">(</span><span class="n">tp</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">);</span>
			<span class="cm">/*</span>
<span class="cm">			 * If this spans a realtime extent boundary,</span>
<span class="cm">			 * chop it back to the start of the one we end at.</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">del</span><span class="p">.</span><span class="n">br_blockcount</span> <span class="o">&gt;</span> <span class="n">mod</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">del</span><span class="p">.</span><span class="n">br_startoff</span> <span class="o">+=</span> <span class="n">del</span><span class="p">.</span><span class="n">br_blockcount</span> <span class="o">-</span> <span class="n">mod</span><span class="p">;</span>
				<span class="n">del</span><span class="p">.</span><span class="n">br_startblock</span> <span class="o">+=</span> <span class="n">del</span><span class="p">.</span><span class="n">br_blockcount</span> <span class="o">-</span> <span class="n">mod</span><span class="p">;</span>
				<span class="n">del</span><span class="p">.</span><span class="n">br_blockcount</span> <span class="o">=</span> <span class="n">mod</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">del</span><span class="p">.</span><span class="n">br_state</span> <span class="o">=</span> <span class="n">XFS_EXT_UNWRITTEN</span><span class="p">;</span>
			<span class="n">error</span> <span class="o">=</span> <span class="n">xfs_bmap_add_extent_unwritten_real</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">ip</span><span class="p">,</span>
					<span class="o">&amp;</span><span class="n">lastx</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cur</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">del</span><span class="p">,</span> <span class="n">firstblock</span><span class="p">,</span> <span class="n">flist</span><span class="p">,</span>
					<span class="o">&amp;</span><span class="n">logflags</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">error0</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">nodelete</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">isrt</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">mod</span> <span class="o">=</span> <span class="n">do_mod</span><span class="p">(</span><span class="n">del</span><span class="p">.</span><span class="n">br_startblock</span><span class="p">,</span> <span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_sb</span><span class="p">.</span><span class="n">sb_rextsize</span><span class="p">)))</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * Realtime extent is lined up at the end but not</span>
<span class="cm">			 * at the front.  We&#39;ll get rid of full extents if</span>
<span class="cm">			 * we can.</span>
<span class="cm">			 */</span>
			<span class="n">mod</span> <span class="o">=</span> <span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_sb</span><span class="p">.</span><span class="n">sb_rextsize</span> <span class="o">-</span> <span class="n">mod</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">del</span><span class="p">.</span><span class="n">br_blockcount</span> <span class="o">&gt;</span> <span class="n">mod</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">del</span><span class="p">.</span><span class="n">br_blockcount</span> <span class="o">-=</span> <span class="n">mod</span><span class="p">;</span>
				<span class="n">del</span><span class="p">.</span><span class="n">br_startoff</span> <span class="o">+=</span> <span class="n">mod</span><span class="p">;</span>
				<span class="n">del</span><span class="p">.</span><span class="n">br_startblock</span> <span class="o">+=</span> <span class="n">mod</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">del</span><span class="p">.</span><span class="n">br_startoff</span> <span class="o">==</span> <span class="n">start</span> <span class="o">&amp;&amp;</span>
				    <span class="p">(</span><span class="n">del</span><span class="p">.</span><span class="n">br_state</span> <span class="o">==</span> <span class="n">XFS_EXT_UNWRITTEN</span> <span class="o">||</span>
				     <span class="n">xfs_trans_get_block_res</span><span class="p">(</span><span class="n">tp</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span> <span class="o">||</span>
				   <span class="o">!</span><span class="n">xfs_sb_version_hasextflgbit</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_sb</span><span class="p">))</span> <span class="p">{</span>
				<span class="cm">/*</span>
<span class="cm">				 * Can&#39;t make it unwritten.  There isn&#39;t</span>
<span class="cm">				 * a full extent here so just skip it.</span>
<span class="cm">				 */</span>
				<span class="n">ASSERT</span><span class="p">(</span><span class="n">bno</span> <span class="o">&gt;=</span> <span class="n">del</span><span class="p">.</span><span class="n">br_blockcount</span><span class="p">);</span>
				<span class="n">bno</span> <span class="o">-=</span> <span class="n">del</span><span class="p">.</span><span class="n">br_blockcount</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">got</span><span class="p">.</span><span class="n">br_startoff</span> <span class="o">&gt;</span> <span class="n">bno</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="o">--</span><span class="n">lastx</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
						<span class="n">ep</span> <span class="o">=</span> <span class="n">xfs_iext_get_ext</span><span class="p">(</span><span class="n">ifp</span><span class="p">,</span>
								      <span class="n">lastx</span><span class="p">);</span>
						<span class="n">xfs_bmbt_get_all</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">got</span><span class="p">);</span>
					<span class="p">}</span>
				<span class="p">}</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">del</span><span class="p">.</span><span class="n">br_state</span> <span class="o">==</span> <span class="n">XFS_EXT_UNWRITTEN</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/*</span>
<span class="cm">				 * This one is already unwritten.</span>
<span class="cm">				 * It must have a written left neighbor.</span>
<span class="cm">				 * Unwrite the killed part of that one and</span>
<span class="cm">				 * try again.</span>
<span class="cm">				 */</span>
				<span class="n">ASSERT</span><span class="p">(</span><span class="n">lastx</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">);</span>
				<span class="n">xfs_bmbt_get_all</span><span class="p">(</span><span class="n">xfs_iext_get_ext</span><span class="p">(</span><span class="n">ifp</span><span class="p">,</span>
						<span class="n">lastx</span> <span class="o">-</span> <span class="mi">1</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">prev</span><span class="p">);</span>
				<span class="n">ASSERT</span><span class="p">(</span><span class="n">prev</span><span class="p">.</span><span class="n">br_state</span> <span class="o">==</span> <span class="n">XFS_EXT_NORM</span><span class="p">);</span>
				<span class="n">ASSERT</span><span class="p">(</span><span class="o">!</span><span class="n">isnullstartblock</span><span class="p">(</span><span class="n">prev</span><span class="p">.</span><span class="n">br_startblock</span><span class="p">));</span>
				<span class="n">ASSERT</span><span class="p">(</span><span class="n">del</span><span class="p">.</span><span class="n">br_startblock</span> <span class="o">==</span>
				       <span class="n">prev</span><span class="p">.</span><span class="n">br_startblock</span> <span class="o">+</span> <span class="n">prev</span><span class="p">.</span><span class="n">br_blockcount</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">prev</span><span class="p">.</span><span class="n">br_startoff</span> <span class="o">&lt;</span> <span class="n">start</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">mod</span> <span class="o">=</span> <span class="n">start</span> <span class="o">-</span> <span class="n">prev</span><span class="p">.</span><span class="n">br_startoff</span><span class="p">;</span>
					<span class="n">prev</span><span class="p">.</span><span class="n">br_blockcount</span> <span class="o">-=</span> <span class="n">mod</span><span class="p">;</span>
					<span class="n">prev</span><span class="p">.</span><span class="n">br_startblock</span> <span class="o">+=</span> <span class="n">mod</span><span class="p">;</span>
					<span class="n">prev</span><span class="p">.</span><span class="n">br_startoff</span> <span class="o">=</span> <span class="n">start</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="n">prev</span><span class="p">.</span><span class="n">br_state</span> <span class="o">=</span> <span class="n">XFS_EXT_UNWRITTEN</span><span class="p">;</span>
				<span class="n">lastx</span><span class="o">--</span><span class="p">;</span>
				<span class="n">error</span> <span class="o">=</span> <span class="n">xfs_bmap_add_extent_unwritten_real</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span>
						<span class="n">ip</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">lastx</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cur</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">prev</span><span class="p">,</span>
						<span class="n">firstblock</span><span class="p">,</span> <span class="n">flist</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">logflags</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
					<span class="k">goto</span> <span class="n">error0</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">nodelete</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">ASSERT</span><span class="p">(</span><span class="n">del</span><span class="p">.</span><span class="n">br_state</span> <span class="o">==</span> <span class="n">XFS_EXT_NORM</span><span class="p">);</span>
				<span class="n">del</span><span class="p">.</span><span class="n">br_state</span> <span class="o">=</span> <span class="n">XFS_EXT_UNWRITTEN</span><span class="p">;</span>
				<span class="n">error</span> <span class="o">=</span> <span class="n">xfs_bmap_add_extent_unwritten_real</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span>
						<span class="n">ip</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">lastx</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cur</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">del</span><span class="p">,</span>
						<span class="n">firstblock</span><span class="p">,</span> <span class="n">flist</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">logflags</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
					<span class="k">goto</span> <span class="n">error0</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">nodelete</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">wasdel</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ASSERT</span><span class="p">(</span><span class="n">startblockval</span><span class="p">(</span><span class="n">del</span><span class="p">.</span><span class="n">br_startblock</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">);</span>
			<span class="cm">/* Update realtime/data freespace, unreserve quota */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">isrt</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">xfs_filblks_t</span> <span class="n">rtexts</span><span class="p">;</span>

				<span class="n">rtexts</span> <span class="o">=</span> <span class="n">XFS_FSB_TO_B</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="n">del</span><span class="p">.</span><span class="n">br_blockcount</span><span class="p">);</span>
				<span class="n">do_div</span><span class="p">(</span><span class="n">rtexts</span><span class="p">,</span> <span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_sb</span><span class="p">.</span><span class="n">sb_rextsize</span><span class="p">);</span>
				<span class="n">xfs_mod_incore_sb</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="n">XFS_SBS_FREXTENTS</span><span class="p">,</span>
						<span class="p">(</span><span class="kt">int64_t</span><span class="p">)</span><span class="n">rtexts</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
				<span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">xfs_trans_reserve_quota_nblks</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span>
					<span class="n">ip</span><span class="p">,</span> <span class="o">-</span><span class="p">((</span><span class="kt">long</span><span class="p">)</span><span class="n">del</span><span class="p">.</span><span class="n">br_blockcount</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span>
					<span class="n">XFS_QMOPT_RES_RTBLKS</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">xfs_icsb_modify_counters</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="n">XFS_SBS_FDBLOCKS</span><span class="p">,</span>
						<span class="p">(</span><span class="kt">int64_t</span><span class="p">)</span><span class="n">del</span><span class="p">.</span><span class="n">br_blockcount</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
				<span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">xfs_trans_reserve_quota_nblks</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span>
					<span class="n">ip</span><span class="p">,</span> <span class="o">-</span><span class="p">((</span><span class="kt">long</span><span class="p">)</span><span class="n">del</span><span class="p">.</span><span class="n">br_blockcount</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span>
					<span class="n">XFS_QMOPT_RES_REGBLKS</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_delayed_blks</span> <span class="o">-=</span> <span class="n">del</span><span class="p">.</span><span class="n">br_blockcount</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">cur</span><span class="p">)</span>
				<span class="n">cur</span><span class="o">-&gt;</span><span class="n">bc_private</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">flags</span> <span class="o">|=</span>
					<span class="n">XFS_BTCUR_BPRV_WASDEL</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">cur</span><span class="p">)</span>
			<span class="n">cur</span><span class="o">-&gt;</span><span class="n">bc_private</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">XFS_BTCUR_BPRV_WASDEL</span><span class="p">;</span>
		<span class="cm">/*</span>
<span class="cm">		 * If it&#39;s the case where the directory code is running</span>
<span class="cm">		 * with no block reservation, and the deleted block is in</span>
<span class="cm">		 * the middle of its extent, and the resulting insert</span>
<span class="cm">		 * of an extent would cause transformation to btree format,</span>
<span class="cm">		 * then reject it.  The calling code will then swap</span>
<span class="cm">		 * blocks around instead.</span>
<span class="cm">		 * We have to do this now, rather than waiting for the</span>
<span class="cm">		 * conversion to btree format, since the transaction</span>
<span class="cm">		 * will be dirty.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">wasdel</span> <span class="o">&amp;&amp;</span> <span class="n">xfs_trans_get_block_res</span><span class="p">(</span><span class="n">tp</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
		    <span class="n">XFS_IFORK_FORMAT</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">whichfork</span><span class="p">)</span> <span class="o">==</span> <span class="n">XFS_DINODE_FMT_EXTENTS</span> <span class="o">&amp;&amp;</span>
		    <span class="n">XFS_IFORK_NEXTENTS</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">whichfork</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="cm">/* Note the &gt;= */</span>
			<span class="n">XFS_IFORK_MAXEXT</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">whichfork</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="n">del</span><span class="p">.</span><span class="n">br_startoff</span> <span class="o">&gt;</span> <span class="n">got</span><span class="p">.</span><span class="n">br_startoff</span> <span class="o">&amp;&amp;</span>
		    <span class="n">del</span><span class="p">.</span><span class="n">br_startoff</span> <span class="o">+</span> <span class="n">del</span><span class="p">.</span><span class="n">br_blockcount</span> <span class="o">&lt;</span>
		    <span class="n">got</span><span class="p">.</span><span class="n">br_startoff</span> <span class="o">+</span> <span class="n">got</span><span class="p">.</span><span class="n">br_blockcount</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">error</span> <span class="o">=</span> <span class="n">XFS_ERROR</span><span class="p">(</span><span class="n">ENOSPC</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">error0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">error</span> <span class="o">=</span> <span class="n">xfs_bmap_del_extent</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">tp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">lastx</span><span class="p">,</span> <span class="n">flist</span><span class="p">,</span> <span class="n">cur</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">del</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="n">tmp_logflags</span><span class="p">,</span> <span class="n">whichfork</span><span class="p">);</span>
		<span class="n">logflags</span> <span class="o">|=</span> <span class="n">tmp_logflags</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">error0</span><span class="p">;</span>
		<span class="n">bno</span> <span class="o">=</span> <span class="n">del</span><span class="p">.</span><span class="n">br_startoff</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
<span class="nl">nodelete:</span>
		<span class="cm">/*</span>
<span class="cm">		 * If not done go on to the next (previous) record.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bno</span> <span class="o">!=</span> <span class="p">(</span><span class="n">xfs_fileoff_t</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">bno</span> <span class="o">&gt;=</span> <span class="n">start</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">lastx</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ep</span> <span class="o">=</span> <span class="n">xfs_iext_get_ext</span><span class="p">(</span><span class="n">ifp</span><span class="p">,</span> <span class="n">lastx</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">xfs_bmbt_get_startoff</span><span class="p">(</span><span class="n">ep</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">bno</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="o">--</span><span class="n">lastx</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
						<span class="n">ep</span> <span class="o">=</span> <span class="n">xfs_iext_get_ext</span><span class="p">(</span><span class="n">ifp</span><span class="p">,</span>
								      <span class="n">lastx</span><span class="p">);</span>
				<span class="p">}</span>
				<span class="n">xfs_bmbt_get_all</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">got</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">extno</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="o">*</span><span class="n">done</span> <span class="o">=</span> <span class="n">bno</span> <span class="o">==</span> <span class="p">(</span><span class="n">xfs_fileoff_t</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span> <span class="o">||</span> <span class="n">bno</span> <span class="o">&lt;</span> <span class="n">start</span> <span class="o">||</span> <span class="n">lastx</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Convert to a btree if necessary.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">xfs_bmap_needs_btree</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">whichfork</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ASSERT</span><span class="p">(</span><span class="n">cur</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="n">error</span> <span class="o">=</span> <span class="n">xfs_bmap_extents_to_btree</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">ip</span><span class="p">,</span> <span class="n">firstblock</span><span class="p">,</span> <span class="n">flist</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">cur</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tmp_logflags</span><span class="p">,</span> <span class="n">whichfork</span><span class="p">);</span>
		<span class="n">logflags</span> <span class="o">|=</span> <span class="n">tmp_logflags</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">error0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/*</span>
<span class="cm">	 * transform from btree to extents, give it cur</span>
<span class="cm">	 */</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">xfs_bmap_wants_extents</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">whichfork</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ASSERT</span><span class="p">(</span><span class="n">cur</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="n">error</span> <span class="o">=</span> <span class="n">xfs_bmap_btree_to_extents</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">ip</span><span class="p">,</span> <span class="n">cur</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tmp_logflags</span><span class="p">,</span>
			<span class="n">whichfork</span><span class="p">);</span>
		<span class="n">logflags</span> <span class="o">|=</span> <span class="n">tmp_logflags</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">error0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/*</span>
<span class="cm">	 * transform from extents to local?</span>
<span class="cm">	 */</span>
	<span class="n">error</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">error0:</span>
	<span class="cm">/*</span>
<span class="cm">	 * Log everything.  Do this after conversion, there&#39;s no point in</span>
<span class="cm">	 * logging the extent records if we&#39;ve converted to btree format.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">logflags</span> <span class="o">&amp;</span> <span class="n">xfs_ilog_fext</span><span class="p">(</span><span class="n">whichfork</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
	    <span class="n">XFS_IFORK_FORMAT</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">whichfork</span><span class="p">)</span> <span class="o">!=</span> <span class="n">XFS_DINODE_FMT_EXTENTS</span><span class="p">)</span>
		<span class="n">logflags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">xfs_ilog_fext</span><span class="p">(</span><span class="n">whichfork</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">logflags</span> <span class="o">&amp;</span> <span class="n">xfs_ilog_fbroot</span><span class="p">(</span><span class="n">whichfork</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
		 <span class="n">XFS_IFORK_FORMAT</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">whichfork</span><span class="p">)</span> <span class="o">!=</span> <span class="n">XFS_DINODE_FMT_BTREE</span><span class="p">)</span>
		<span class="n">logflags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">xfs_ilog_fbroot</span><span class="p">(</span><span class="n">whichfork</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 * Log inode even in the error case, if the transaction</span>
<span class="cm">	 * is dirty we&#39;ll need to shut down the filesystem.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">logflags</span><span class="p">)</span>
		<span class="n">xfs_trans_log_inode</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">ip</span><span class="p">,</span> <span class="n">logflags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cur</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
			<span class="o">*</span><span class="n">firstblock</span> <span class="o">=</span> <span class="n">cur</span><span class="o">-&gt;</span><span class="n">bc_private</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">firstblock</span><span class="p">;</span>
			<span class="n">cur</span><span class="o">-&gt;</span><span class="n">bc_private</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">allocated</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">xfs_btree_del_cursor</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span>
			<span class="n">error</span> <span class="o">?</span> <span class="n">XFS_BTREE_ERROR</span> <span class="o">:</span> <span class="n">XFS_BTREE_NOERROR</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * returns 1 for success, 0 if we failed to map the extent.</span>
<span class="cm"> */</span>
<span class="n">STATIC</span> <span class="kt">int</span>
<span class="n">xfs_getbmapx_fix_eof_hole</span><span class="p">(</span>
	<span class="n">xfs_inode_t</span>		<span class="o">*</span><span class="n">ip</span><span class="p">,</span>		<span class="cm">/* xfs incore inode pointer */</span>
	<span class="k">struct</span> <span class="n">getbmapx</span>		<span class="o">*</span><span class="n">out</span><span class="p">,</span>		<span class="cm">/* output structure */</span>
	<span class="kt">int</span>			<span class="n">prealloced</span><span class="p">,</span>	<span class="cm">/* this is a file with</span>
<span class="cm">						 * preallocated data space */</span>
	<span class="n">__int64_t</span>		<span class="n">end</span><span class="p">,</span>		<span class="cm">/* last block requested */</span>
	<span class="n">xfs_fsblock_t</span>		<span class="n">startblock</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">__int64_t</span>		<span class="n">fixlen</span><span class="p">;</span>
	<span class="n">xfs_mount_t</span>		<span class="o">*</span><span class="n">mp</span><span class="p">;</span>		<span class="cm">/* file system mount point */</span>
	<span class="n">xfs_ifork_t</span>		<span class="o">*</span><span class="n">ifp</span><span class="p">;</span>		<span class="cm">/* inode fork pointer */</span>
	<span class="n">xfs_extnum_t</span>		<span class="n">lastx</span><span class="p">;</span>		<span class="cm">/* last extent pointer */</span>
	<span class="n">xfs_fileoff_t</span>		<span class="n">fileblock</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">startblock</span> <span class="o">==</span> <span class="n">HOLESTARTBLOCK</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mp</span> <span class="o">=</span> <span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_mount</span><span class="p">;</span>
		<span class="n">out</span><span class="o">-&gt;</span><span class="n">bmv_block</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="n">fixlen</span> <span class="o">=</span> <span class="n">XFS_FSB_TO_BB</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="n">XFS_B_TO_FSB</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="n">XFS_ISIZE</span><span class="p">(</span><span class="n">ip</span><span class="p">)));</span>
		<span class="n">fixlen</span> <span class="o">-=</span> <span class="n">out</span><span class="o">-&gt;</span><span class="n">bmv_offset</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">prealloced</span> <span class="o">&amp;&amp;</span> <span class="n">out</span><span class="o">-&gt;</span><span class="n">bmv_offset</span> <span class="o">+</span> <span class="n">out</span><span class="o">-&gt;</span><span class="n">bmv_length</span> <span class="o">==</span> <span class="n">end</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Came to hole at EOF. Trim it. */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">fixlen</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">out</span><span class="o">-&gt;</span><span class="n">bmv_length</span> <span class="o">=</span> <span class="n">fixlen</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">startblock</span> <span class="o">==</span> <span class="n">DELAYSTARTBLOCK</span><span class="p">)</span>
			<span class="n">out</span><span class="o">-&gt;</span><span class="n">bmv_block</span> <span class="o">=</span> <span class="o">-</span><span class="mi">2</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">out</span><span class="o">-&gt;</span><span class="n">bmv_block</span> <span class="o">=</span> <span class="n">xfs_fsb_to_db</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">startblock</span><span class="p">);</span>
		<span class="n">fileblock</span> <span class="o">=</span> <span class="n">XFS_BB_TO_FSB</span><span class="p">(</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_mount</span><span class="p">,</span> <span class="n">out</span><span class="o">-&gt;</span><span class="n">bmv_offset</span><span class="p">);</span>
		<span class="n">ifp</span> <span class="o">=</span> <span class="n">XFS_IFORK_PTR</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">XFS_DATA_FORK</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">xfs_iext_bno_to_ext</span><span class="p">(</span><span class="n">ifp</span><span class="p">,</span> <span class="n">fileblock</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">lastx</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		   <span class="p">(</span><span class="n">lastx</span> <span class="o">==</span> <span class="p">(</span><span class="n">ifp</span><span class="o">-&gt;</span><span class="n">if_bytes</span> <span class="o">/</span> <span class="p">(</span><span class="n">uint</span><span class="p">)</span><span class="k">sizeof</span><span class="p">(</span><span class="n">xfs_bmbt_rec_t</span><span class="p">))</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>
			<span class="n">out</span><span class="o">-&gt;</span><span class="n">bmv_oflags</span> <span class="o">|=</span> <span class="n">BMV_OF_LAST</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Get inode&#39;s extents as described in bmv, and format for output.</span>
<span class="cm"> * Calls formatter to fill the user&#39;s buffer until all extents</span>
<span class="cm"> * are mapped, until the passed-in bmv-&gt;bmv_count slots have</span>
<span class="cm"> * been filled, or until the formatter short-circuits the loop,</span>
<span class="cm"> * if it is tracking filled-in extents on its own.</span>
<span class="cm"> */</span>
<span class="kt">int</span>						<span class="cm">/* error code */</span>
<span class="n">xfs_getbmap</span><span class="p">(</span>
	<span class="n">xfs_inode_t</span>		<span class="o">*</span><span class="n">ip</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">getbmapx</span>		<span class="o">*</span><span class="n">bmv</span><span class="p">,</span>		<span class="cm">/* user bmap structure */</span>
	<span class="n">xfs_bmap_format_t</span>	<span class="n">formatter</span><span class="p">,</span>	<span class="cm">/* format to user */</span>
	<span class="kt">void</span>			<span class="o">*</span><span class="n">arg</span><span class="p">)</span>		<span class="cm">/* formatter arg */</span>
<span class="p">{</span>
	<span class="n">__int64_t</span>		<span class="n">bmvend</span><span class="p">;</span>		<span class="cm">/* last block requested */</span>
	<span class="kt">int</span>			<span class="n">error</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* return value */</span>
	<span class="n">__int64_t</span>		<span class="n">fixlen</span><span class="p">;</span>		<span class="cm">/* length for -1 case */</span>
	<span class="kt">int</span>			<span class="n">i</span><span class="p">;</span>		<span class="cm">/* extent number */</span>
	<span class="kt">int</span>			<span class="n">lock</span><span class="p">;</span>		<span class="cm">/* lock state */</span>
	<span class="n">xfs_bmbt_irec_t</span>		<span class="o">*</span><span class="n">map</span><span class="p">;</span>		<span class="cm">/* buffer for user&#39;s data */</span>
	<span class="n">xfs_mount_t</span>		<span class="o">*</span><span class="n">mp</span><span class="p">;</span>		<span class="cm">/* file system mount point */</span>
	<span class="kt">int</span>			<span class="n">nex</span><span class="p">;</span>		<span class="cm">/* # of user extents can do */</span>
	<span class="kt">int</span>			<span class="n">nexleft</span><span class="p">;</span>	<span class="cm">/* # of user extents left */</span>
	<span class="kt">int</span>			<span class="n">subnex</span><span class="p">;</span>		<span class="cm">/* # of bmapi&#39;s can do */</span>
	<span class="kt">int</span>			<span class="n">nmap</span><span class="p">;</span>		<span class="cm">/* number of map entries */</span>
	<span class="k">struct</span> <span class="n">getbmapx</span>		<span class="o">*</span><span class="n">out</span><span class="p">;</span>		<span class="cm">/* output structure */</span>
	<span class="kt">int</span>			<span class="n">whichfork</span><span class="p">;</span>	<span class="cm">/* data or attr fork */</span>
	<span class="kt">int</span>			<span class="n">prealloced</span><span class="p">;</span>	<span class="cm">/* this is a file with</span>
<span class="cm">						 * preallocated data space */</span>
	<span class="kt">int</span>			<span class="n">iflags</span><span class="p">;</span>		<span class="cm">/* interface flags */</span>
	<span class="kt">int</span>			<span class="n">bmapi_flags</span><span class="p">;</span>	<span class="cm">/* flags for xfs_bmapi */</span>
	<span class="kt">int</span>			<span class="n">cur_ext</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">mp</span> <span class="o">=</span> <span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_mount</span><span class="p">;</span>
	<span class="n">iflags</span> <span class="o">=</span> <span class="n">bmv</span><span class="o">-&gt;</span><span class="n">bmv_iflags</span><span class="p">;</span>
	<span class="n">whichfork</span> <span class="o">=</span> <span class="n">iflags</span> <span class="o">&amp;</span> <span class="n">BMV_IF_ATTRFORK</span> <span class="o">?</span> <span class="n">XFS_ATTR_FORK</span> <span class="o">:</span> <span class="n">XFS_DATA_FORK</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">whichfork</span> <span class="o">==</span> <span class="n">XFS_ATTR_FORK</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">XFS_IFORK_Q</span><span class="p">(</span><span class="n">ip</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_d</span><span class="p">.</span><span class="n">di_aformat</span> <span class="o">!=</span> <span class="n">XFS_DINODE_FMT_EXTENTS</span> <span class="o">&amp;&amp;</span>
			    <span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_d</span><span class="p">.</span><span class="n">di_aformat</span> <span class="o">!=</span> <span class="n">XFS_DINODE_FMT_BTREE</span> <span class="o">&amp;&amp;</span>
			    <span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_d</span><span class="p">.</span><span class="n">di_aformat</span> <span class="o">!=</span> <span class="n">XFS_DINODE_FMT_LOCAL</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">XFS_ERROR</span><span class="p">(</span><span class="n">EINVAL</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span>
			   <span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_d</span><span class="p">.</span><span class="n">di_aformat</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
			   <span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_d</span><span class="p">.</span><span class="n">di_aformat</span> <span class="o">!=</span> <span class="n">XFS_DINODE_FMT_EXTENTS</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">XFS_ERROR_REPORT</span><span class="p">(</span><span class="s">&quot;xfs_getbmap&quot;</span><span class="p">,</span> <span class="n">XFS_ERRLEVEL_LOW</span><span class="p">,</span>
					 <span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_mount</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">XFS_ERROR</span><span class="p">(</span><span class="n">EFSCORRUPTED</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">prealloced</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">fixlen</span> <span class="o">=</span> <span class="mi">1LL</span> <span class="o">&lt;&lt;</span> <span class="mi">32</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_d</span><span class="p">.</span><span class="n">di_format</span> <span class="o">!=</span> <span class="n">XFS_DINODE_FMT_EXTENTS</span> <span class="o">&amp;&amp;</span>
		    <span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_d</span><span class="p">.</span><span class="n">di_format</span> <span class="o">!=</span> <span class="n">XFS_DINODE_FMT_BTREE</span> <span class="o">&amp;&amp;</span>
		    <span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_d</span><span class="p">.</span><span class="n">di_format</span> <span class="o">!=</span> <span class="n">XFS_DINODE_FMT_LOCAL</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">XFS_ERROR</span><span class="p">(</span><span class="n">EINVAL</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">xfs_get_extsz_hint</span><span class="p">(</span><span class="n">ip</span><span class="p">)</span> <span class="o">||</span>
		    <span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_d</span><span class="p">.</span><span class="n">di_flags</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">XFS_DIFLAG_PREALLOC</span><span class="o">|</span><span class="n">XFS_DIFLAG_APPEND</span><span class="p">)){</span>
			<span class="n">prealloced</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">fixlen</span> <span class="o">=</span> <span class="n">XFS_MAXIOFFSET</span><span class="p">(</span><span class="n">mp</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">prealloced</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">fixlen</span> <span class="o">=</span> <span class="n">XFS_ISIZE</span><span class="p">(</span><span class="n">ip</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bmv</span><span class="o">-&gt;</span><span class="n">bmv_length</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fixlen</span> <span class="o">=</span> <span class="n">XFS_FSB_TO_BB</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="n">XFS_B_TO_FSB</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="n">fixlen</span><span class="p">));</span>
		<span class="n">bmv</span><span class="o">-&gt;</span><span class="n">bmv_length</span> <span class="o">=</span>
			<span class="n">max_t</span><span class="p">(</span><span class="n">__int64_t</span><span class="p">,</span> <span class="n">fixlen</span> <span class="o">-</span> <span class="n">bmv</span><span class="o">-&gt;</span><span class="n">bmv_offset</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">bmv</span><span class="o">-&gt;</span><span class="n">bmv_length</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bmv</span><span class="o">-&gt;</span><span class="n">bmv_entries</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">bmv</span><span class="o">-&gt;</span><span class="n">bmv_length</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span> <span class="n">XFS_ERROR</span><span class="p">(</span><span class="n">EINVAL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">nex</span> <span class="o">=</span> <span class="n">bmv</span><span class="o">-&gt;</span><span class="n">bmv_count</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nex</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">XFS_ERROR</span><span class="p">(</span><span class="n">EINVAL</span><span class="p">);</span>
	<span class="n">bmvend</span> <span class="o">=</span> <span class="n">bmv</span><span class="o">-&gt;</span><span class="n">bmv_offset</span> <span class="o">+</span> <span class="n">bmv</span><span class="o">-&gt;</span><span class="n">bmv_length</span><span class="p">;</span>


	<span class="k">if</span> <span class="p">(</span><span class="n">bmv</span><span class="o">-&gt;</span><span class="n">bmv_count</span> <span class="o">&gt;</span> <span class="n">ULONG_MAX</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">getbmapx</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">XFS_ERROR</span><span class="p">(</span><span class="n">ENOMEM</span><span class="p">);</span>
	<span class="n">out</span> <span class="o">=</span> <span class="n">kmem_zalloc</span><span class="p">(</span><span class="n">bmv</span><span class="o">-&gt;</span><span class="n">bmv_count</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">getbmapx</span><span class="p">),</span> <span class="n">KM_MAYFAIL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">out</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">out</span> <span class="o">=</span> <span class="n">kmem_zalloc_large</span><span class="p">(</span><span class="n">bmv</span><span class="o">-&gt;</span><span class="n">bmv_count</span> <span class="o">*</span>
					<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">getbmapx</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">out</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">XFS_ERROR</span><span class="p">(</span><span class="n">ENOMEM</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">xfs_ilock</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">XFS_IOLOCK_SHARED</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">whichfork</span> <span class="o">==</span> <span class="n">XFS_DATA_FORK</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">iflags</span> <span class="o">&amp;</span> <span class="n">BMV_IF_DELALLOC</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_delayed_blks</span> <span class="o">||</span> <span class="n">XFS_ISIZE</span><span class="p">(</span><span class="n">ip</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_d</span><span class="p">.</span><span class="n">di_size</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">error</span> <span class="o">=</span> <span class="n">xfs_flush_pages</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">FI_REMAPF</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">out_unlock_iolock</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/*</span>
<span class="cm">		 * even after flushing the inode, there can still be delalloc</span>
<span class="cm">		 * blocks on the inode beyond EOF due to speculative</span>
<span class="cm">		 * preallocation. These are not removed until the release</span>
<span class="cm">		 * function is called or the inode is inactivated. Hence we</span>
<span class="cm">		 * cannot assert here that ip-&gt;i_delayed_blks == 0.</span>
<span class="cm">		 */</span>
	<span class="p">}</span>

	<span class="n">lock</span> <span class="o">=</span> <span class="n">xfs_ilock_map_shared</span><span class="p">(</span><span class="n">ip</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Don&#39;t let nex be bigger than the number of extents</span>
<span class="cm">	 * we can have assuming alternating holes and real extents.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nex</span> <span class="o">&gt;</span> <span class="n">XFS_IFORK_NEXTENTS</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">whichfork</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">nex</span> <span class="o">=</span> <span class="n">XFS_IFORK_NEXTENTS</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">whichfork</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">bmapi_flags</span> <span class="o">=</span> <span class="n">xfs_bmapi_aflag</span><span class="p">(</span><span class="n">whichfork</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">iflags</span> <span class="o">&amp;</span> <span class="n">BMV_IF_PREALLOC</span><span class="p">))</span>
		<span class="n">bmapi_flags</span> <span class="o">|=</span> <span class="n">XFS_BMAPI_IGSTATE</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Allocate enough space to handle &quot;subnex&quot; maps at a time.</span>
<span class="cm">	 */</span>
	<span class="n">error</span> <span class="o">=</span> <span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">subnex</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>
	<span class="n">map</span> <span class="o">=</span> <span class="n">kmem_alloc</span><span class="p">(</span><span class="n">subnex</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">map</span><span class="p">),</span> <span class="n">KM_MAYFAIL</span> <span class="o">|</span> <span class="n">KM_NOFS</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">map</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_unlock_ilock</span><span class="p">;</span>

	<span class="n">bmv</span><span class="o">-&gt;</span><span class="n">bmv_entries</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">XFS_IFORK_NEXTENTS</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">whichfork</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">whichfork</span> <span class="o">==</span> <span class="n">XFS_ATTR_FORK</span> <span class="o">||</span> <span class="o">!</span><span class="p">(</span><span class="n">iflags</span> <span class="o">&amp;</span> <span class="n">BMV_IF_DELALLOC</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">error</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out_free_map</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">nexleft</span> <span class="o">=</span> <span class="n">nex</span><span class="p">;</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="n">nmap</span> <span class="o">=</span> <span class="p">(</span><span class="n">nexleft</span> <span class="o">&gt;</span> <span class="n">subnex</span><span class="p">)</span> <span class="o">?</span> <span class="n">subnex</span> <span class="o">:</span> <span class="n">nexleft</span><span class="p">;</span>
		<span class="n">error</span> <span class="o">=</span> <span class="n">xfs_bmapi_read</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">XFS_BB_TO_FSBT</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="n">bmv</span><span class="o">-&gt;</span><span class="n">bmv_offset</span><span class="p">),</span>
				       <span class="n">XFS_BB_TO_FSB</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="n">bmv</span><span class="o">-&gt;</span><span class="n">bmv_length</span><span class="p">),</span>
				       <span class="n">map</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">nmap</span><span class="p">,</span> <span class="n">bmapi_flags</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out_free_map</span><span class="p">;</span>
		<span class="n">ASSERT</span><span class="p">(</span><span class="n">nmap</span> <span class="o">&lt;=</span> <span class="n">subnex</span><span class="p">);</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">nmap</span> <span class="o">&amp;&amp;</span> <span class="n">nexleft</span> <span class="o">&amp;&amp;</span> <span class="n">bmv</span><span class="o">-&gt;</span><span class="n">bmv_length</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">out</span><span class="p">[</span><span class="n">cur_ext</span><span class="p">].</span><span class="n">bmv_oflags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">map</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">br_state</span> <span class="o">==</span> <span class="n">XFS_EXT_UNWRITTEN</span><span class="p">)</span>
				<span class="n">out</span><span class="p">[</span><span class="n">cur_ext</span><span class="p">].</span><span class="n">bmv_oflags</span> <span class="o">|=</span> <span class="n">BMV_OF_PREALLOC</span><span class="p">;</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">map</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">br_startblock</span> <span class="o">==</span> <span class="n">DELAYSTARTBLOCK</span><span class="p">)</span>
				<span class="n">out</span><span class="p">[</span><span class="n">cur_ext</span><span class="p">].</span><span class="n">bmv_oflags</span> <span class="o">|=</span> <span class="n">BMV_OF_DELALLOC</span><span class="p">;</span>
			<span class="n">out</span><span class="p">[</span><span class="n">cur_ext</span><span class="p">].</span><span class="n">bmv_offset</span> <span class="o">=</span>
				<span class="n">XFS_FSB_TO_BB</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="n">map</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">br_startoff</span><span class="p">);</span>
			<span class="n">out</span><span class="p">[</span><span class="n">cur_ext</span><span class="p">].</span><span class="n">bmv_length</span> <span class="o">=</span>
				<span class="n">XFS_FSB_TO_BB</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="n">map</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">br_blockcount</span><span class="p">);</span>
			<span class="n">out</span><span class="p">[</span><span class="n">cur_ext</span><span class="p">].</span><span class="n">bmv_unused1</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">out</span><span class="p">[</span><span class="n">cur_ext</span><span class="p">].</span><span class="n">bmv_unused2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

			<span class="cm">/*</span>
<span class="cm">			 * delayed allocation extents that start beyond EOF can</span>
<span class="cm">			 * occur due to speculative EOF allocation when the</span>
<span class="cm">			 * delalloc extent is larger than the largest freespace</span>
<span class="cm">			 * extent at conversion time. These extents cannot be</span>
<span class="cm">			 * converted by data writeback, so can exist here even</span>
<span class="cm">			 * if we are not supposed to be finding delalloc</span>
<span class="cm">			 * extents.</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">map</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">br_startblock</span> <span class="o">==</span> <span class="n">DELAYSTARTBLOCK</span> <span class="o">&amp;&amp;</span>
			    <span class="n">map</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">br_startoff</span> <span class="o">&lt;=</span> <span class="n">XFS_B_TO_FSB</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="n">XFS_ISIZE</span><span class="p">(</span><span class="n">ip</span><span class="p">)))</span>
				<span class="n">ASSERT</span><span class="p">((</span><span class="n">iflags</span> <span class="o">&amp;</span> <span class="n">BMV_IF_DELALLOC</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">);</span>

                        <span class="k">if</span> <span class="p">(</span><span class="n">map</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">br_startblock</span> <span class="o">==</span> <span class="n">HOLESTARTBLOCK</span> <span class="o">&amp;&amp;</span>
			    <span class="n">whichfork</span> <span class="o">==</span> <span class="n">XFS_ATTR_FORK</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* came to the end of attribute fork */</span>
				<span class="n">out</span><span class="p">[</span><span class="n">cur_ext</span><span class="p">].</span><span class="n">bmv_oflags</span> <span class="o">|=</span> <span class="n">BMV_OF_LAST</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">out_free_map</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">xfs_getbmapx_fix_eof_hole</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">out</span><span class="p">[</span><span class="n">cur_ext</span><span class="p">],</span>
					<span class="n">prealloced</span><span class="p">,</span> <span class="n">bmvend</span><span class="p">,</span>
					<span class="n">map</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">br_startblock</span><span class="p">))</span>
				<span class="k">goto</span> <span class="n">out_free_map</span><span class="p">;</span>

			<span class="n">bmv</span><span class="o">-&gt;</span><span class="n">bmv_offset</span> <span class="o">=</span>
				<span class="n">out</span><span class="p">[</span><span class="n">cur_ext</span><span class="p">].</span><span class="n">bmv_offset</span> <span class="o">+</span>
				<span class="n">out</span><span class="p">[</span><span class="n">cur_ext</span><span class="p">].</span><span class="n">bmv_length</span><span class="p">;</span>
			<span class="n">bmv</span><span class="o">-&gt;</span><span class="n">bmv_length</span> <span class="o">=</span>
				<span class="n">max_t</span><span class="p">(</span><span class="n">__int64_t</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">bmvend</span> <span class="o">-</span> <span class="n">bmv</span><span class="o">-&gt;</span><span class="n">bmv_offset</span><span class="p">);</span>

			<span class="cm">/*</span>
<span class="cm">			 * In case we don&#39;t want to return the hole,</span>
<span class="cm">			 * don&#39;t increase cur_ext so that we can reuse</span>
<span class="cm">			 * it in the next loop.</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">iflags</span> <span class="o">&amp;</span> <span class="n">BMV_IF_NO_HOLES</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			    <span class="n">map</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">br_startblock</span> <span class="o">==</span> <span class="n">HOLESTARTBLOCK</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">out</span><span class="p">[</span><span class="n">cur_ext</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">out</span><span class="p">[</span><span class="n">cur_ext</span><span class="p">]));</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">nexleft</span><span class="o">--</span><span class="p">;</span>
			<span class="n">bmv</span><span class="o">-&gt;</span><span class="n">bmv_entries</span><span class="o">++</span><span class="p">;</span>
			<span class="n">cur_ext</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">nmap</span> <span class="o">&amp;&amp;</span> <span class="n">nexleft</span> <span class="o">&amp;&amp;</span> <span class="n">bmv</span><span class="o">-&gt;</span><span class="n">bmv_length</span><span class="p">);</span>

 <span class="nl">out_free_map:</span>
	<span class="n">kmem_free</span><span class="p">(</span><span class="n">map</span><span class="p">);</span>
 <span class="nl">out_unlock_ilock:</span>
	<span class="n">xfs_iunlock_map_shared</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">lock</span><span class="p">);</span>
 <span class="nl">out_unlock_iolock:</span>
	<span class="n">xfs_iunlock</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">XFS_IOLOCK_SHARED</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">cur_ext</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">full</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* user array is full */</span>

		<span class="cm">/* format results &amp; advance arg */</span>
		<span class="n">error</span> <span class="o">=</span> <span class="n">formatter</span><span class="p">(</span><span class="o">&amp;</span><span class="n">arg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">out</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">full</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">error</span> <span class="o">||</span> <span class="n">full</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">is_vmalloc_addr</span><span class="p">(</span><span class="n">out</span><span class="p">))</span>
		<span class="n">kmem_free_large</span><span class="p">(</span><span class="n">out</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">kmem_free</span><span class="p">(</span><span class="n">out</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef DEBUG</span>
<span class="n">STATIC</span> <span class="k">struct</span> <span class="n">xfs_buf</span> <span class="o">*</span>
<span class="n">xfs_bmap_get_bp</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">xfs_btree_cur</span>	<span class="o">*</span><span class="n">cur</span><span class="p">,</span>
	<span class="n">xfs_fsblock_t</span>		<span class="n">bno</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">xfs_log_item_desc</span> <span class="o">*</span><span class="n">lidp</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cur</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">XFS_BTREE_MAXLEVELS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">bc_bufs</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">XFS_BUF_ADDR</span><span class="p">(</span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">bc_bufs</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">==</span> <span class="n">bno</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">cur</span><span class="o">-&gt;</span><span class="n">bc_bufs</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
	<span class="p">}</span>

	<span class="cm">/* Chase down all the log items to see if the bp is there */</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">lidp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">bc_tp</span><span class="o">-&gt;</span><span class="n">t_items</span><span class="p">,</span> <span class="n">lid_trans</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">xfs_buf_log_item</span>	<span class="o">*</span><span class="n">bip</span><span class="p">;</span>
		<span class="n">bip</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">xfs_buf_log_item</span> <span class="o">*</span><span class="p">)</span><span class="n">lidp</span><span class="o">-&gt;</span><span class="n">lid_item</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bip</span><span class="o">-&gt;</span><span class="n">bli_item</span><span class="p">.</span><span class="n">li_type</span> <span class="o">==</span> <span class="n">XFS_LI_BUF</span> <span class="o">&amp;&amp;</span>
		    <span class="n">XFS_BUF_ADDR</span><span class="p">(</span><span class="n">bip</span><span class="o">-&gt;</span><span class="n">bli_buf</span><span class="p">)</span> <span class="o">==</span> <span class="n">bno</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">bip</span><span class="o">-&gt;</span><span class="n">bli_buf</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">STATIC</span> <span class="kt">void</span>
<span class="n">xfs_check_block</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">xfs_btree_block</span>	<span class="o">*</span><span class="n">block</span><span class="p">,</span>
	<span class="n">xfs_mount_t</span>		<span class="o">*</span><span class="n">mp</span><span class="p">,</span>
	<span class="kt">int</span>			<span class="n">root</span><span class="p">,</span>
	<span class="kt">short</span>			<span class="n">sz</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span>			<span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">dmxr</span><span class="p">;</span>
	<span class="n">__be64</span>			<span class="o">*</span><span class="n">pp</span><span class="p">,</span> <span class="o">*</span><span class="n">thispa</span><span class="p">;</span>	<span class="cm">/* pointer to block address */</span>
	<span class="n">xfs_bmbt_key_t</span>		<span class="o">*</span><span class="n">prevp</span><span class="p">,</span> <span class="o">*</span><span class="n">keyp</span><span class="p">;</span>

	<span class="n">ASSERT</span><span class="p">(</span><span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">block</span><span class="o">-&gt;</span><span class="n">bb_level</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">prevp</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">for</span><span class="p">(</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">xfs_btree_get_numrecs</span><span class="p">(</span><span class="n">block</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dmxr</span> <span class="o">=</span> <span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_bmap_dmxr</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
		<span class="n">keyp</span> <span class="o">=</span> <span class="n">XFS_BMBT_KEY_ADDR</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="n">block</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">prevp</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ASSERT</span><span class="p">(</span><span class="n">be64_to_cpu</span><span class="p">(</span><span class="n">prevp</span><span class="o">-&gt;</span><span class="n">br_startoff</span><span class="p">)</span> <span class="o">&lt;</span>
			       <span class="n">be64_to_cpu</span><span class="p">(</span><span class="n">keyp</span><span class="o">-&gt;</span><span class="n">br_startoff</span><span class="p">));</span>
		<span class="p">}</span>
		<span class="n">prevp</span> <span class="o">=</span> <span class="n">keyp</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * Compare the block numbers to see if there are dups.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">root</span><span class="p">)</span>
			<span class="n">pp</span> <span class="o">=</span> <span class="n">XFS_BMAP_BROOT_PTR_ADDR</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="n">block</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">sz</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">pp</span> <span class="o">=</span> <span class="n">XFS_BMBT_PTR_ADDR</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="n">block</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">dmxr</span><span class="p">);</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;=</span> <span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">block</span><span class="o">-&gt;</span><span class="n">bb_numrecs</span><span class="p">);</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">root</span><span class="p">)</span>
				<span class="n">thispa</span> <span class="o">=</span> <span class="n">XFS_BMAP_BROOT_PTR_ADDR</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="n">block</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">sz</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">thispa</span> <span class="o">=</span> <span class="n">XFS_BMBT_PTR_ADDR</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="n">block</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">dmxr</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">thispa</span> <span class="o">==</span> <span class="o">*</span><span class="n">pp</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">xfs_warn</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="s">&quot;%s: thispa(%d) == pp(%d) %Ld&quot;</span><span class="p">,</span>
					<span class="n">__func__</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span>
					<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">be64_to_cpu</span><span class="p">(</span><span class="o">*</span><span class="n">thispa</span><span class="p">));</span>
				<span class="n">panic</span><span class="p">(</span><span class="s">&quot;%s: ptrs are equal in node</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">__func__</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Check that the extents for the inode ip are in the right order in all</span>
<span class="cm"> * btree leaves.</span>
<span class="cm"> */</span>

<span class="n">STATIC</span> <span class="kt">void</span>
<span class="n">xfs_bmap_check_leaf_extents</span><span class="p">(</span>
	<span class="n">xfs_btree_cur_t</span>		<span class="o">*</span><span class="n">cur</span><span class="p">,</span>	<span class="cm">/* btree cursor or null */</span>
	<span class="n">xfs_inode_t</span>		<span class="o">*</span><span class="n">ip</span><span class="p">,</span>		<span class="cm">/* incore inode pointer */</span>
	<span class="kt">int</span>			<span class="n">whichfork</span><span class="p">)</span>	<span class="cm">/* data or attr fork */</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">xfs_btree_block</span>	<span class="o">*</span><span class="n">block</span><span class="p">;</span>	<span class="cm">/* current btree block */</span>
	<span class="n">xfs_fsblock_t</span>		<span class="n">bno</span><span class="p">;</span>	<span class="cm">/* block # of &quot;block&quot; */</span>
	<span class="n">xfs_buf_t</span>		<span class="o">*</span><span class="n">bp</span><span class="p">;</span>	<span class="cm">/* buffer for &quot;block&quot; */</span>
	<span class="kt">int</span>			<span class="n">error</span><span class="p">;</span>	<span class="cm">/* error return value */</span>
	<span class="n">xfs_extnum_t</span>		<span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">j</span><span class="p">;</span>	<span class="cm">/* index into the extents list */</span>
	<span class="n">xfs_ifork_t</span>		<span class="o">*</span><span class="n">ifp</span><span class="p">;</span>	<span class="cm">/* fork structure */</span>
	<span class="kt">int</span>			<span class="n">level</span><span class="p">;</span>	<span class="cm">/* btree level, for checking */</span>
	<span class="n">xfs_mount_t</span>		<span class="o">*</span><span class="n">mp</span><span class="p">;</span>	<span class="cm">/* file system mount structure */</span>
	<span class="n">__be64</span>			<span class="o">*</span><span class="n">pp</span><span class="p">;</span>	<span class="cm">/* pointer to block address */</span>
	<span class="n">xfs_bmbt_rec_t</span>		<span class="o">*</span><span class="n">ep</span><span class="p">;</span>	<span class="cm">/* pointer to current extent */</span>
	<span class="n">xfs_bmbt_rec_t</span>		<span class="n">last</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">};</span> <span class="cm">/* last extent in prev block */</span>
	<span class="n">xfs_bmbt_rec_t</span>		<span class="o">*</span><span class="n">nextp</span><span class="p">;</span>	<span class="cm">/* pointer to next extent */</span>
	<span class="kt">int</span>			<span class="n">bp_release</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">XFS_IFORK_FORMAT</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">whichfork</span><span class="p">)</span> <span class="o">!=</span> <span class="n">XFS_DINODE_FMT_BTREE</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">bno</span> <span class="o">=</span> <span class="n">NULLFSBLOCK</span><span class="p">;</span>
	<span class="n">mp</span> <span class="o">=</span> <span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_mount</span><span class="p">;</span>
	<span class="n">ifp</span> <span class="o">=</span> <span class="n">XFS_IFORK_PTR</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">whichfork</span><span class="p">);</span>
	<span class="n">block</span> <span class="o">=</span> <span class="n">ifp</span><span class="o">-&gt;</span><span class="n">if_broot</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * Root level must use BMAP_BROOT_PTR_ADDR macro to get ptr out.</span>
<span class="cm">	 */</span>
	<span class="n">level</span> <span class="o">=</span> <span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">block</span><span class="o">-&gt;</span><span class="n">bb_level</span><span class="p">);</span>
	<span class="n">ASSERT</span><span class="p">(</span><span class="n">level</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">xfs_check_block</span><span class="p">(</span><span class="n">block</span><span class="p">,</span> <span class="n">mp</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ifp</span><span class="o">-&gt;</span><span class="n">if_broot_bytes</span><span class="p">);</span>
	<span class="n">pp</span> <span class="o">=</span> <span class="n">XFS_BMAP_BROOT_PTR_ADDR</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="n">block</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ifp</span><span class="o">-&gt;</span><span class="n">if_broot_bytes</span><span class="p">);</span>
	<span class="n">bno</span> <span class="o">=</span> <span class="n">be64_to_cpu</span><span class="p">(</span><span class="o">*</span><span class="n">pp</span><span class="p">);</span>

	<span class="n">ASSERT</span><span class="p">(</span><span class="n">bno</span> <span class="o">!=</span> <span class="n">NULLDFSBNO</span><span class="p">);</span>
	<span class="n">ASSERT</span><span class="p">(</span><span class="n">XFS_FSB_TO_AGNO</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="n">bno</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_sb</span><span class="p">.</span><span class="n">sb_agcount</span><span class="p">);</span>
	<span class="n">ASSERT</span><span class="p">(</span><span class="n">XFS_FSB_TO_AGBNO</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="n">bno</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_sb</span><span class="p">.</span><span class="n">sb_agblocks</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Go down the tree until leaf level is reached, following the first</span>
<span class="cm">	 * pointer (leftmost) at each level.</span>
<span class="cm">	 */</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">level</span><span class="o">--</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* See if buf is in cur first */</span>
		<span class="n">bp</span> <span class="o">=</span> <span class="n">xfs_bmap_get_bp</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">XFS_FSB_TO_DADDR</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="n">bno</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bp</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">bp_release</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">bp_release</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bp</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">error</span> <span class="o">=</span> <span class="n">xfs_btree_read_bufl</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">bno</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bp</span><span class="p">,</span>
				<span class="n">XFS_BMAP_BTREE_REF</span><span class="p">)))</span>
			<span class="k">goto</span> <span class="n">error_norelse</span><span class="p">;</span>
		<span class="n">block</span> <span class="o">=</span> <span class="n">XFS_BUF_TO_BLOCK</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>
		<span class="n">XFS_WANT_CORRUPTED_GOTO</span><span class="p">(</span>
			<span class="n">xfs_bmap_sanity_check</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="n">bp</span><span class="p">,</span> <span class="n">level</span><span class="p">),</span>
			<span class="n">error0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">level</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * Check this block for basic sanity (increasing keys and</span>
<span class="cm">		 * no duplicate blocks).</span>
<span class="cm">		 */</span>

		<span class="n">xfs_check_block</span><span class="p">(</span><span class="n">block</span><span class="p">,</span> <span class="n">mp</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">pp</span> <span class="o">=</span> <span class="n">XFS_BMBT_PTR_ADDR</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="n">block</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_bmap_dmxr</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
		<span class="n">bno</span> <span class="o">=</span> <span class="n">be64_to_cpu</span><span class="p">(</span><span class="o">*</span><span class="n">pp</span><span class="p">);</span>
		<span class="n">XFS_WANT_CORRUPTED_GOTO</span><span class="p">(</span><span class="n">XFS_FSB_SANITY_CHECK</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="n">bno</span><span class="p">),</span> <span class="n">error0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bp_release</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">bp_release</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">xfs_trans_brelse</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">bp</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Here with bp and block set to the leftmost leaf node in the tree.</span>
<span class="cm">	 */</span>
	<span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Loop over all leaf nodes checking that all extents are in the right order.</span>
<span class="cm">	 */</span>
	<span class="k">for</span> <span class="p">(;;)</span> <span class="p">{</span>
		<span class="n">xfs_fsblock_t</span>	<span class="n">nextbno</span><span class="p">;</span>
		<span class="n">xfs_extnum_t</span>	<span class="n">num_recs</span><span class="p">;</span>


		<span class="n">num_recs</span> <span class="o">=</span> <span class="n">xfs_btree_get_numrecs</span><span class="p">(</span><span class="n">block</span><span class="p">);</span>

		<span class="cm">/*</span>
<span class="cm">		 * Read-ahead the next leaf block, if any.</span>
<span class="cm">		 */</span>

		<span class="n">nextbno</span> <span class="o">=</span> <span class="n">be64_to_cpu</span><span class="p">(</span><span class="n">block</span><span class="o">-&gt;</span><span class="n">bb_u</span><span class="p">.</span><span class="n">l</span><span class="p">.</span><span class="n">bb_rightsib</span><span class="p">);</span>

		<span class="cm">/*</span>
<span class="cm">		 * Check all the extents to make sure they are OK.</span>
<span class="cm">		 * If we had a previous block, the last entry should</span>
<span class="cm">		 * conform with the first entry in this one.</span>
<span class="cm">		 */</span>

		<span class="n">ep</span> <span class="o">=</span> <span class="n">XFS_BMBT_REC_ADDR</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="n">block</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ASSERT</span><span class="p">(</span><span class="n">xfs_bmbt_disk_get_startoff</span><span class="p">(</span><span class="o">&amp;</span><span class="n">last</span><span class="p">)</span> <span class="o">+</span>
			       <span class="n">xfs_bmbt_disk_get_blockcount</span><span class="p">(</span><span class="o">&amp;</span><span class="n">last</span><span class="p">)</span> <span class="o">&lt;=</span>
			       <span class="n">xfs_bmbt_disk_get_startoff</span><span class="p">(</span><span class="n">ep</span><span class="p">));</span>
		<span class="p">}</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">num_recs</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">nextp</span> <span class="o">=</span> <span class="n">XFS_BMBT_REC_ADDR</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="n">block</span><span class="p">,</span> <span class="n">j</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
			<span class="n">ASSERT</span><span class="p">(</span><span class="n">xfs_bmbt_disk_get_startoff</span><span class="p">(</span><span class="n">ep</span><span class="p">)</span> <span class="o">+</span>
			       <span class="n">xfs_bmbt_disk_get_blockcount</span><span class="p">(</span><span class="n">ep</span><span class="p">)</span> <span class="o">&lt;=</span>
			       <span class="n">xfs_bmbt_disk_get_startoff</span><span class="p">(</span><span class="n">nextp</span><span class="p">));</span>
			<span class="n">ep</span> <span class="o">=</span> <span class="n">nextp</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">last</span> <span class="o">=</span> <span class="o">*</span><span class="n">ep</span><span class="p">;</span>
		<span class="n">i</span> <span class="o">+=</span> <span class="n">num_recs</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bp_release</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">bp_release</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">xfs_trans_brelse</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">bp</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">bno</span> <span class="o">=</span> <span class="n">nextbno</span><span class="p">;</span>
		<span class="cm">/*</span>
<span class="cm">		 * If we&#39;ve reached the end, stop.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bno</span> <span class="o">==</span> <span class="n">NULLFSBLOCK</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">bp</span> <span class="o">=</span> <span class="n">xfs_bmap_get_bp</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">XFS_FSB_TO_DADDR</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="n">bno</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bp</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">bp_release</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">bp_release</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bp</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">error</span> <span class="o">=</span> <span class="n">xfs_btree_read_bufl</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">bno</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bp</span><span class="p">,</span>
				<span class="n">XFS_BMAP_BTREE_REF</span><span class="p">)))</span>
			<span class="k">goto</span> <span class="n">error_norelse</span><span class="p">;</span>
		<span class="n">block</span> <span class="o">=</span> <span class="n">XFS_BUF_TO_BLOCK</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bp_release</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bp_release</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">xfs_trans_brelse</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">bp</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span><span class="p">;</span>

<span class="nl">error0:</span>
	<span class="n">xfs_warn</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="s">&quot;%s: at error0&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bp_release</span><span class="p">)</span>
		<span class="n">xfs_trans_brelse</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">bp</span><span class="p">);</span>
<span class="nl">error_norelse:</span>
	<span class="n">xfs_warn</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="s">&quot;%s: BAD after btree leaves for %d extents&quot;</span><span class="p">,</span>
		<span class="n">__func__</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
	<span class="n">panic</span><span class="p">(</span><span class="s">&quot;%s: CORRUPTED BTREE OR SOMETHING&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="cm">/*</span>
<span class="cm"> * Count fsblocks of the given fork.</span>
<span class="cm"> */</span>
<span class="kt">int</span>						<span class="cm">/* error */</span>
<span class="n">xfs_bmap_count_blocks</span><span class="p">(</span>
	<span class="n">xfs_trans_t</span>		<span class="o">*</span><span class="n">tp</span><span class="p">,</span>		<span class="cm">/* transaction pointer */</span>
	<span class="n">xfs_inode_t</span>		<span class="o">*</span><span class="n">ip</span><span class="p">,</span>		<span class="cm">/* incore inode */</span>
	<span class="kt">int</span>			<span class="n">whichfork</span><span class="p">,</span>	<span class="cm">/* data or attr fork */</span>
	<span class="kt">int</span>			<span class="o">*</span><span class="n">count</span><span class="p">)</span>		<span class="cm">/* out: count of blocks */</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">xfs_btree_block</span>	<span class="o">*</span><span class="n">block</span><span class="p">;</span>	<span class="cm">/* current btree block */</span>
	<span class="n">xfs_fsblock_t</span>		<span class="n">bno</span><span class="p">;</span>	<span class="cm">/* block # of &quot;block&quot; */</span>
	<span class="n">xfs_ifork_t</span>		<span class="o">*</span><span class="n">ifp</span><span class="p">;</span>	<span class="cm">/* fork structure */</span>
	<span class="kt">int</span>			<span class="n">level</span><span class="p">;</span>	<span class="cm">/* btree level, for checking */</span>
	<span class="n">xfs_mount_t</span>		<span class="o">*</span><span class="n">mp</span><span class="p">;</span>	<span class="cm">/* file system mount structure */</span>
	<span class="n">__be64</span>			<span class="o">*</span><span class="n">pp</span><span class="p">;</span>	<span class="cm">/* pointer to block address */</span>

	<span class="n">bno</span> <span class="o">=</span> <span class="n">NULLFSBLOCK</span><span class="p">;</span>
	<span class="n">mp</span> <span class="o">=</span> <span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_mount</span><span class="p">;</span>
	<span class="n">ifp</span> <span class="o">=</span> <span class="n">XFS_IFORK_PTR</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">whichfork</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span> <span class="n">XFS_IFORK_FORMAT</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">whichfork</span><span class="p">)</span> <span class="o">==</span> <span class="n">XFS_DINODE_FMT_EXTENTS</span> <span class="p">)</span> <span class="p">{</span>
		<span class="n">xfs_bmap_count_leaves</span><span class="p">(</span><span class="n">ifp</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
			<span class="n">ifp</span><span class="o">-&gt;</span><span class="n">if_bytes</span> <span class="o">/</span> <span class="p">(</span><span class="n">uint</span><span class="p">)</span><span class="k">sizeof</span><span class="p">(</span><span class="n">xfs_bmbt_rec_t</span><span class="p">),</span>
			<span class="n">count</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Root level must use BMAP_BROOT_PTR_ADDR macro to get ptr out.</span>
<span class="cm">	 */</span>
	<span class="n">block</span> <span class="o">=</span> <span class="n">ifp</span><span class="o">-&gt;</span><span class="n">if_broot</span><span class="p">;</span>
	<span class="n">level</span> <span class="o">=</span> <span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">block</span><span class="o">-&gt;</span><span class="n">bb_level</span><span class="p">);</span>
	<span class="n">ASSERT</span><span class="p">(</span><span class="n">level</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">pp</span> <span class="o">=</span> <span class="n">XFS_BMAP_BROOT_PTR_ADDR</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="n">block</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ifp</span><span class="o">-&gt;</span><span class="n">if_broot_bytes</span><span class="p">);</span>
	<span class="n">bno</span> <span class="o">=</span> <span class="n">be64_to_cpu</span><span class="p">(</span><span class="o">*</span><span class="n">pp</span><span class="p">);</span>
	<span class="n">ASSERT</span><span class="p">(</span><span class="n">bno</span> <span class="o">!=</span> <span class="n">NULLDFSBNO</span><span class="p">);</span>
	<span class="n">ASSERT</span><span class="p">(</span><span class="n">XFS_FSB_TO_AGNO</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="n">bno</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_sb</span><span class="p">.</span><span class="n">sb_agcount</span><span class="p">);</span>
	<span class="n">ASSERT</span><span class="p">(</span><span class="n">XFS_FSB_TO_AGBNO</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="n">bno</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_sb</span><span class="p">.</span><span class="n">sb_agblocks</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">xfs_bmap_count_tree</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="n">tp</span><span class="p">,</span> <span class="n">ifp</span><span class="p">,</span> <span class="n">bno</span><span class="p">,</span> <span class="n">level</span><span class="p">,</span> <span class="n">count</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">XFS_ERROR_REPORT</span><span class="p">(</span><span class="s">&quot;xfs_bmap_count_blocks(2)&quot;</span><span class="p">,</span> <span class="n">XFS_ERRLEVEL_LOW</span><span class="p">,</span>
				 <span class="n">mp</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">XFS_ERROR</span><span class="p">(</span><span class="n">EFSCORRUPTED</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Recursively walks each level of a btree</span>
<span class="cm"> * to count total fsblocks is use.</span>
<span class="cm"> */</span>
<span class="n">STATIC</span> <span class="kt">int</span>                                     <span class="cm">/* error */</span>
<span class="n">xfs_bmap_count_tree</span><span class="p">(</span>
	<span class="n">xfs_mount_t</span>     <span class="o">*</span><span class="n">mp</span><span class="p">,</span>            <span class="cm">/* file system mount point */</span>
	<span class="n">xfs_trans_t</span>     <span class="o">*</span><span class="n">tp</span><span class="p">,</span>            <span class="cm">/* transaction pointer */</span>
	<span class="n">xfs_ifork_t</span>	<span class="o">*</span><span class="n">ifp</span><span class="p">,</span>		<span class="cm">/* inode fork pointer */</span>
	<span class="n">xfs_fsblock_t</span>   <span class="n">blockno</span><span class="p">,</span>	<span class="cm">/* file system block number */</span>
	<span class="kt">int</span>             <span class="n">levelin</span><span class="p">,</span>	<span class="cm">/* level in btree */</span>
	<span class="kt">int</span>		<span class="o">*</span><span class="n">count</span><span class="p">)</span>		<span class="cm">/* Count of blocks */</span>
<span class="p">{</span>
	<span class="kt">int</span>			<span class="n">error</span><span class="p">;</span>
	<span class="n">xfs_buf_t</span>		<span class="o">*</span><span class="n">bp</span><span class="p">,</span> <span class="o">*</span><span class="n">nbp</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">level</span> <span class="o">=</span> <span class="n">levelin</span><span class="p">;</span>
	<span class="n">__be64</span>			<span class="o">*</span><span class="n">pp</span><span class="p">;</span>
	<span class="n">xfs_fsblock_t</span>           <span class="n">bno</span> <span class="o">=</span> <span class="n">blockno</span><span class="p">;</span>
	<span class="n">xfs_fsblock_t</span>		<span class="n">nextbno</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">xfs_btree_block</span>	<span class="o">*</span><span class="n">block</span><span class="p">,</span> <span class="o">*</span><span class="n">nextblock</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">numrecs</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">error</span> <span class="o">=</span> <span class="n">xfs_btree_read_bufl</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="n">tp</span><span class="p">,</span> <span class="n">bno</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bp</span><span class="p">,</span> <span class="n">XFS_BMAP_BTREE_REF</span><span class="p">)))</span>
		<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
	<span class="o">*</span><span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">block</span> <span class="o">=</span> <span class="n">XFS_BUF_TO_BLOCK</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">--</span><span class="n">level</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Not at node above leaves, count this level of nodes */</span>
		<span class="n">nextbno</span> <span class="o">=</span> <span class="n">be64_to_cpu</span><span class="p">(</span><span class="n">block</span><span class="o">-&gt;</span><span class="n">bb_u</span><span class="p">.</span><span class="n">l</span><span class="p">.</span><span class="n">bb_rightsib</span><span class="p">);</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">nextbno</span> <span class="o">!=</span> <span class="n">NULLFSBLOCK</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">error</span> <span class="o">=</span> <span class="n">xfs_btree_read_bufl</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="n">tp</span><span class="p">,</span> <span class="n">nextbno</span><span class="p">,</span>
				<span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">nbp</span><span class="p">,</span> <span class="n">XFS_BMAP_BTREE_REF</span><span class="p">)))</span>
				<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
			<span class="o">*</span><span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">nextblock</span> <span class="o">=</span> <span class="n">XFS_BUF_TO_BLOCK</span><span class="p">(</span><span class="n">nbp</span><span class="p">);</span>
			<span class="n">nextbno</span> <span class="o">=</span> <span class="n">be64_to_cpu</span><span class="p">(</span><span class="n">nextblock</span><span class="o">-&gt;</span><span class="n">bb_u</span><span class="p">.</span><span class="n">l</span><span class="p">.</span><span class="n">bb_rightsib</span><span class="p">);</span>
			<span class="n">xfs_trans_brelse</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">nbp</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="cm">/* Dive to the next level */</span>
		<span class="n">pp</span> <span class="o">=</span> <span class="n">XFS_BMBT_PTR_ADDR</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="n">block</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_bmap_dmxr</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
		<span class="n">bno</span> <span class="o">=</span> <span class="n">be64_to_cpu</span><span class="p">(</span><span class="o">*</span><span class="n">pp</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">((</span><span class="n">error</span> <span class="o">=</span>
		     <span class="n">xfs_bmap_count_tree</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="n">tp</span><span class="p">,</span> <span class="n">ifp</span><span class="p">,</span> <span class="n">bno</span><span class="p">,</span> <span class="n">level</span><span class="p">,</span> <span class="n">count</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">xfs_trans_brelse</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">bp</span><span class="p">);</span>
			<span class="n">XFS_ERROR_REPORT</span><span class="p">(</span><span class="s">&quot;xfs_bmap_count_tree(1)&quot;</span><span class="p">,</span>
					 <span class="n">XFS_ERRLEVEL_LOW</span><span class="p">,</span> <span class="n">mp</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">XFS_ERROR</span><span class="p">(</span><span class="n">EFSCORRUPTED</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">xfs_trans_brelse</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">bp</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* count all level 1 nodes and their leaves */</span>
		<span class="k">for</span> <span class="p">(;;)</span> <span class="p">{</span>
			<span class="n">nextbno</span> <span class="o">=</span> <span class="n">be64_to_cpu</span><span class="p">(</span><span class="n">block</span><span class="o">-&gt;</span><span class="n">bb_u</span><span class="p">.</span><span class="n">l</span><span class="p">.</span><span class="n">bb_rightsib</span><span class="p">);</span>
			<span class="n">numrecs</span> <span class="o">=</span> <span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">block</span><span class="o">-&gt;</span><span class="n">bb_numrecs</span><span class="p">);</span>
			<span class="n">xfs_bmap_disk_count_leaves</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="n">block</span><span class="p">,</span> <span class="n">numrecs</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
			<span class="n">xfs_trans_brelse</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">bp</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">nextbno</span> <span class="o">==</span> <span class="n">NULLFSBLOCK</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="n">bno</span> <span class="o">=</span> <span class="n">nextbno</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">error</span> <span class="o">=</span> <span class="n">xfs_btree_read_bufl</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="n">tp</span><span class="p">,</span> <span class="n">bno</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bp</span><span class="p">,</span>
				<span class="n">XFS_BMAP_BTREE_REF</span><span class="p">)))</span>
				<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
			<span class="o">*</span><span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">block</span> <span class="o">=</span> <span class="n">XFS_BUF_TO_BLOCK</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Count leaf blocks given a range of extent records.</span>
<span class="cm"> */</span>
<span class="n">STATIC</span> <span class="kt">void</span>
<span class="n">xfs_bmap_count_leaves</span><span class="p">(</span>
	<span class="n">xfs_ifork_t</span>		<span class="o">*</span><span class="n">ifp</span><span class="p">,</span>
	<span class="n">xfs_extnum_t</span>		<span class="n">idx</span><span class="p">,</span>
	<span class="kt">int</span>			<span class="n">numrecs</span><span class="p">,</span>
	<span class="kt">int</span>			<span class="o">*</span><span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span>		<span class="n">b</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">b</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">b</span> <span class="o">&lt;</span> <span class="n">numrecs</span><span class="p">;</span> <span class="n">b</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">xfs_bmbt_rec_host_t</span> <span class="o">*</span><span class="n">frp</span> <span class="o">=</span> <span class="n">xfs_iext_get_ext</span><span class="p">(</span><span class="n">ifp</span><span class="p">,</span> <span class="n">idx</span> <span class="o">+</span> <span class="n">b</span><span class="p">);</span>
		<span class="o">*</span><span class="n">count</span> <span class="o">+=</span> <span class="n">xfs_bmbt_get_blockcount</span><span class="p">(</span><span class="n">frp</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Count leaf blocks given a range of extent records originally</span>
<span class="cm"> * in btree format.</span>
<span class="cm"> */</span>
<span class="n">STATIC</span> <span class="kt">void</span>
<span class="n">xfs_bmap_disk_count_leaves</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">xfs_mount</span>	<span class="o">*</span><span class="n">mp</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">xfs_btree_block</span>	<span class="o">*</span><span class="n">block</span><span class="p">,</span>
	<span class="kt">int</span>			<span class="n">numrecs</span><span class="p">,</span>
	<span class="kt">int</span>			<span class="o">*</span><span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span>		<span class="n">b</span><span class="p">;</span>
	<span class="n">xfs_bmbt_rec_t</span>	<span class="o">*</span><span class="n">frp</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">b</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">b</span> <span class="o">&lt;=</span> <span class="n">numrecs</span><span class="p">;</span> <span class="n">b</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">frp</span> <span class="o">=</span> <span class="n">XFS_BMBT_REC_ADDR</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="n">block</span><span class="p">,</span> <span class="n">b</span><span class="p">);</span>
		<span class="o">*</span><span class="n">count</span> <span class="o">+=</span> <span class="n">xfs_bmbt_disk_get_blockcount</span><span class="p">(</span><span class="n">frp</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * dead simple method of punching delalyed allocation blocks from a range in</span>
<span class="cm"> * the inode. Walks a block at a time so will be slow, but is only executed in</span>
<span class="cm"> * rare error cases so the overhead is not critical. This will alays punch out</span>
<span class="cm"> * both the start and end blocks, even if the ranges only partially overlap</span>
<span class="cm"> * them, so it is up to the caller to ensure that partial blocks are not</span>
<span class="cm"> * passed in.</span>
<span class="cm"> */</span>
<span class="kt">int</span>
<span class="n">xfs_bmap_punch_delalloc_range</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">xfs_inode</span>	<span class="o">*</span><span class="n">ip</span><span class="p">,</span>
	<span class="n">xfs_fileoff_t</span>		<span class="n">start_fsb</span><span class="p">,</span>
	<span class="n">xfs_fileoff_t</span>		<span class="n">length</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">xfs_fileoff_t</span>		<span class="n">remaining</span> <span class="o">=</span> <span class="n">length</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">error</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">ASSERT</span><span class="p">(</span><span class="n">xfs_isilocked</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">XFS_ILOCK_EXCL</span><span class="p">));</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="kt">int</span>		<span class="n">done</span><span class="p">;</span>
		<span class="n">xfs_bmbt_irec_t</span>	<span class="n">imap</span><span class="p">;</span>
		<span class="kt">int</span>		<span class="n">nimaps</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">xfs_fsblock_t</span>	<span class="n">firstblock</span><span class="p">;</span>
		<span class="n">xfs_bmap_free_t</span> <span class="n">flist</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * Map the range first and check that it is a delalloc extent</span>
<span class="cm">		 * before trying to unmap the range. Otherwise we will be</span>
<span class="cm">		 * trying to remove a real extent (which requires a</span>
<span class="cm">		 * transaction) or a hole, which is probably a bad idea...</span>
<span class="cm">		 */</span>
		<span class="n">error</span> <span class="o">=</span> <span class="n">xfs_bmapi_read</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">start_fsb</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">imap</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">nimaps</span><span class="p">,</span>
				       <span class="n">XFS_BMAPI_ENTIRE</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* something screwed, just bail */</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">XFS_FORCED_SHUTDOWN</span><span class="p">(</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_mount</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">xfs_alert</span><span class="p">(</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_mount</span><span class="p">,</span>
			<span class="s">&quot;Failed delalloc mapping lookup ino %lld fsb %lld.&quot;</span><span class="p">,</span>
						<span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_ino</span><span class="p">,</span> <span class="n">start_fsb</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">nimaps</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* nothing there */</span>
			<span class="k">goto</span> <span class="n">next_block</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">imap</span><span class="p">.</span><span class="n">br_startblock</span> <span class="o">!=</span> <span class="n">DELAYSTARTBLOCK</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* been converted, ignore */</span>
			<span class="k">goto</span> <span class="n">next_block</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">WARN_ON</span><span class="p">(</span><span class="n">imap</span><span class="p">.</span><span class="n">br_blockcount</span> <span class="o">==</span> <span class="mi">0</span><span class="p">);</span>

		<span class="cm">/*</span>
<span class="cm">		 * Note: while we initialise the firstblock/flist pair, they</span>
<span class="cm">		 * should never be used because blocks should never be</span>
<span class="cm">		 * allocated or freed for a delalloc extent and hence we need</span>
<span class="cm">		 * don&#39;t cancel or finish them after the xfs_bunmapi() call.</span>
<span class="cm">		 */</span>
		<span class="n">xfs_bmap_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">flist</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">firstblock</span><span class="p">);</span>
		<span class="n">error</span> <span class="o">=</span> <span class="n">xfs_bunmapi</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">ip</span><span class="p">,</span> <span class="n">start_fsb</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">firstblock</span><span class="p">,</span>
					<span class="o">&amp;</span><span class="n">flist</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">done</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">ASSERT</span><span class="p">(</span><span class="o">!</span><span class="n">flist</span><span class="p">.</span><span class="n">xbf_count</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">flist</span><span class="p">.</span><span class="n">xbf_first</span><span class="p">);</span>
<span class="nl">next_block:</span>
		<span class="n">start_fsb</span><span class="o">++</span><span class="p">;</span>
		<span class="n">remaining</span><span class="o">--</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">while</span><span class="p">(</span><span class="n">remaining</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Convert the given file system block to a disk block.  We have to treat it</span>
<span class="cm"> * differently based on whether the file is a real time file or not, because the</span>
<span class="cm"> * bmap code does.</span>
<span class="cm"> */</span>
<span class="n">xfs_daddr_t</span>
<span class="n">xfs_fsb_to_db</span><span class="p">(</span><span class="k">struct</span> <span class="n">xfs_inode</span> <span class="o">*</span><span class="n">ip</span><span class="p">,</span> <span class="n">xfs_fsblock_t</span> <span class="n">fsb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">XFS_IS_REALTIME_INODE</span><span class="p">(</span><span class="n">ip</span><span class="p">)</span> <span class="o">?</span> \
		 <span class="p">(</span><span class="n">xfs_daddr_t</span><span class="p">)</span><span class="n">XFS_FSB_TO_BB</span><span class="p">((</span><span class="n">ip</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">i_mount</span><span class="p">,</span> <span class="p">(</span><span class="n">fsb</span><span class="p">))</span> <span class="o">:</span> \
		 <span class="n">XFS_FSB_TO_DADDR</span><span class="p">((</span><span class="n">ip</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">i_mount</span><span class="p">,</span> <span class="p">(</span><span class="n">fsb</span><span class="p">)));</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
