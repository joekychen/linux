<!DOCTYPE html>
<html><head><title>joekychen/linux » fs › xfs › xfs_ioctl.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>xfs_ioctl.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Copyright (c) 2000-2005 Silicon Graphics, Inc.</span>
<span class="cm"> * All Rights Reserved.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or</span>
<span class="cm"> * modify it under the terms of the GNU General Public License as</span>
<span class="cm"> * published by the Free Software Foundation.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is distributed in the hope that it would be useful,</span>
<span class="cm"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm"> * GNU General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> * You should have received a copy of the GNU General Public License</span>
<span class="cm"> * along with this program; if not, write the Free Software Foundation,</span>
<span class="cm"> * Inc.,  51 Franklin St, Fifth Floor, Boston, MA  02110-1301  USA</span>
<span class="cm"> */</span>
<span class="cp">#include &quot;xfs.h&quot;</span>
<span class="cp">#include &quot;xfs_fs.h&quot;</span>
<span class="cp">#include &quot;xfs_log.h&quot;</span>
<span class="cp">#include &quot;xfs_trans.h&quot;</span>
<span class="cp">#include &quot;xfs_sb.h&quot;</span>
<span class="cp">#include &quot;xfs_ag.h&quot;</span>
<span class="cp">#include &quot;xfs_alloc.h&quot;</span>
<span class="cp">#include &quot;xfs_mount.h&quot;</span>
<span class="cp">#include &quot;xfs_bmap_btree.h&quot;</span>
<span class="cp">#include &quot;xfs_dinode.h&quot;</span>
<span class="cp">#include &quot;xfs_inode.h&quot;</span>
<span class="cp">#include &quot;xfs_ioctl.h&quot;</span>
<span class="cp">#include &quot;xfs_rtalloc.h&quot;</span>
<span class="cp">#include &quot;xfs_itable.h&quot;</span>
<span class="cp">#include &quot;xfs_error.h&quot;</span>
<span class="cp">#include &quot;xfs_attr.h&quot;</span>
<span class="cp">#include &quot;xfs_bmap.h&quot;</span>
<span class="cp">#include &quot;xfs_buf_item.h&quot;</span>
<span class="cp">#include &quot;xfs_utils.h&quot;</span>
<span class="cp">#include &quot;xfs_dfrag.h&quot;</span>
<span class="cp">#include &quot;xfs_fsops.h&quot;</span>
<span class="cp">#include &quot;xfs_vnodeops.h&quot;</span>
<span class="cp">#include &quot;xfs_discard.h&quot;</span>
<span class="cp">#include &quot;xfs_quota.h&quot;</span>
<span class="cp">#include &quot;xfs_inode_item.h&quot;</span>
<span class="cp">#include &quot;xfs_export.h&quot;</span>
<span class="cp">#include &quot;xfs_trace.h&quot;</span>

<span class="cp">#include &lt;linux/capability.h&gt;</span>
<span class="cp">#include &lt;linux/dcache.h&gt;</span>
<span class="cp">#include &lt;linux/mount.h&gt;</span>
<span class="cp">#include &lt;linux/namei.h&gt;</span>
<span class="cp">#include &lt;linux/pagemap.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/exportfs.h&gt;</span>

<span class="cm">/*</span>
<span class="cm"> * xfs_find_handle maps from userspace xfs_fsop_handlereq structure to</span>
<span class="cm"> * a file or fs handle.</span>
<span class="cm"> *</span>
<span class="cm"> * XFS_IOC_PATH_TO_FSHANDLE</span>
<span class="cm"> *    returns fs handle for a mount point or path within that mount point</span>
<span class="cm"> * XFS_IOC_FD_TO_HANDLE</span>
<span class="cm"> *    returns full handle for a FD opened in user space</span>
<span class="cm"> * XFS_IOC_PATH_TO_HANDLE</span>
<span class="cm"> *    returns full handle for a path</span>
<span class="cm"> */</span>
<span class="kt">int</span>
<span class="nf">xfs_find_handle</span><span class="p">(</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>		<span class="n">cmd</span><span class="p">,</span>
	<span class="n">xfs_fsop_handlereq_t</span>	<span class="o">*</span><span class="n">hreq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span>			<span class="n">hsize</span><span class="p">;</span>
	<span class="n">xfs_handle_t</span>		<span class="n">handle</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">inode</span>		<span class="o">*</span><span class="n">inode</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">file</span>		<span class="o">*</span><span class="n">file</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">path</span>		<span class="n">path</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">error</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">xfs_inode</span>	<span class="o">*</span><span class="n">ip</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span> <span class="o">==</span> <span class="n">XFS_IOC_FD_TO_HANDLE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">file</span> <span class="o">=</span> <span class="n">fget</span><span class="p">(</span><span class="n">hreq</span><span class="o">-&gt;</span><span class="n">fd</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">file</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EBADF</span><span class="p">;</span>
		<span class="n">inode</span> <span class="o">=</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">f_path</span><span class="p">.</span><span class="n">dentry</span><span class="o">-&gt;</span><span class="n">d_inode</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">error</span> <span class="o">=</span> <span class="n">user_lpath</span><span class="p">((</span><span class="k">const</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">hreq</span><span class="o">-&gt;</span><span class="n">path</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">path</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
		<span class="n">inode</span> <span class="o">=</span> <span class="n">path</span><span class="p">.</span><span class="n">dentry</span><span class="o">-&gt;</span><span class="n">d_inode</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ip</span> <span class="o">=</span> <span class="n">XFS_I</span><span class="p">(</span><span class="n">inode</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * We can only generate handles for inodes residing on a XFS filesystem,</span>
<span class="cm">	 * and only for regular files, directories or symbolic links.</span>
<span class="cm">	 */</span>
	<span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_sb</span><span class="o">-&gt;</span><span class="n">s_magic</span> <span class="o">!=</span> <span class="n">XFS_SB_MAGIC</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_put</span><span class="p">;</span>

	<span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBADF</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">S_ISREG</span><span class="p">(</span><span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_mode</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="n">S_ISDIR</span><span class="p">(</span><span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_mode</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="n">S_ISLNK</span><span class="p">(</span><span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_mode</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out_put</span><span class="p">;</span>


	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">handle</span><span class="p">.</span><span class="n">ha_fsid</span><span class="p">,</span> <span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_mount</span><span class="o">-&gt;</span><span class="n">m_fixedfsid</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">xfs_fsid_t</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span> <span class="o">==</span> <span class="n">XFS_IOC_PATH_TO_FSHANDLE</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * This handle only contains an fsid, zero the rest.</span>
<span class="cm">		 */</span>
		<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">handle</span><span class="p">.</span><span class="n">ha_fid</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">handle</span><span class="p">.</span><span class="n">ha_fid</span><span class="p">));</span>
		<span class="n">hsize</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">xfs_fsid_t</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="kt">int</span>		<span class="n">lock_mode</span><span class="p">;</span>

		<span class="n">lock_mode</span> <span class="o">=</span> <span class="n">xfs_ilock_map_shared</span><span class="p">(</span><span class="n">ip</span><span class="p">);</span>
		<span class="n">handle</span><span class="p">.</span><span class="n">ha_fid</span><span class="p">.</span><span class="n">fid_len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">xfs_fid_t</span><span class="p">)</span> <span class="o">-</span>
					<span class="k">sizeof</span><span class="p">(</span><span class="n">handle</span><span class="p">.</span><span class="n">ha_fid</span><span class="p">.</span><span class="n">fid_len</span><span class="p">);</span>
		<span class="n">handle</span><span class="p">.</span><span class="n">ha_fid</span><span class="p">.</span><span class="n">fid_pad</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">handle</span><span class="p">.</span><span class="n">ha_fid</span><span class="p">.</span><span class="n">fid_gen</span> <span class="o">=</span> <span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_d</span><span class="p">.</span><span class="n">di_gen</span><span class="p">;</span>
		<span class="n">handle</span><span class="p">.</span><span class="n">ha_fid</span><span class="p">.</span><span class="n">fid_ino</span> <span class="o">=</span> <span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_ino</span><span class="p">;</span>
		<span class="n">xfs_iunlock_map_shared</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">lock_mode</span><span class="p">);</span>

		<span class="n">hsize</span> <span class="o">=</span> <span class="n">XFS_HSIZE</span><span class="p">(</span><span class="n">handle</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">hreq</span><span class="o">-&gt;</span><span class="n">ohandle</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">handle</span><span class="p">,</span> <span class="n">hsize</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">copy_to_user</span><span class="p">(</span><span class="n">hreq</span><span class="o">-&gt;</span><span class="n">ohandlen</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hsize</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">__s32</span><span class="p">)))</span>
		<span class="k">goto</span> <span class="n">out_put</span><span class="p">;</span>

	<span class="n">error</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

 <span class="nl">out_put:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span> <span class="o">==</span> <span class="n">XFS_IOC_FD_TO_HANDLE</span><span class="p">)</span>
		<span class="n">fput</span><span class="p">(</span><span class="n">file</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">path_put</span><span class="p">(</span><span class="o">&amp;</span><span class="n">path</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * No need to do permission checks on the various pathname components</span>
<span class="cm"> * as the handle operations are privileged.</span>
<span class="cm"> */</span>
<span class="n">STATIC</span> <span class="kt">int</span>
<span class="nf">xfs_handle_acceptable</span><span class="p">(</span>
	<span class="kt">void</span>			<span class="o">*</span><span class="n">context</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">dentry</span>		<span class="o">*</span><span class="n">dentry</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Convert userspace handle data into a dentry.</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span>
<span class="nf">xfs_handle_to_dentry</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">file</span>		<span class="o">*</span><span class="n">parfilp</span><span class="p">,</span>
	<span class="kt">void</span> <span class="n">__user</span>		<span class="o">*</span><span class="n">uhandle</span><span class="p">,</span>
	<span class="n">u32</span>			<span class="n">hlen</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">xfs_handle_t</span>		<span class="n">handle</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">xfs_fid64</span>	<span class="n">fid</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Only allow handle opens under a directory.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">S_ISDIR</span><span class="p">(</span><span class="n">parfilp</span><span class="o">-&gt;</span><span class="n">f_path</span><span class="p">.</span><span class="n">dentry</span><span class="o">-&gt;</span><span class="n">d_inode</span><span class="o">-&gt;</span><span class="n">i_mode</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">ENOTDIR</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hlen</span> <span class="o">!=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">xfs_handle_t</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">EINVAL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">handle</span><span class="p">,</span> <span class="n">uhandle</span><span class="p">,</span> <span class="n">hlen</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">EFAULT</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">handle</span><span class="p">.</span><span class="n">ha_fid</span><span class="p">.</span><span class="n">fid_len</span> <span class="o">!=</span>
	    <span class="k">sizeof</span><span class="p">(</span><span class="n">handle</span><span class="p">.</span><span class="n">ha_fid</span><span class="p">)</span> <span class="o">-</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">handle</span><span class="p">.</span><span class="n">ha_fid</span><span class="p">.</span><span class="n">fid_len</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">EINVAL</span><span class="p">);</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fid</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">fid</span><span class="p">));</span>
	<span class="n">fid</span><span class="p">.</span><span class="n">ino</span> <span class="o">=</span> <span class="n">handle</span><span class="p">.</span><span class="n">ha_fid</span><span class="p">.</span><span class="n">fid_ino</span><span class="p">;</span>
	<span class="n">fid</span><span class="p">.</span><span class="n">gen</span> <span class="o">=</span> <span class="n">handle</span><span class="p">.</span><span class="n">ha_fid</span><span class="p">.</span><span class="n">fid_gen</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">exportfs_decode_fh</span><span class="p">(</span><span class="n">parfilp</span><span class="o">-&gt;</span><span class="n">f_path</span><span class="p">.</span><span class="n">mnt</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">fid</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">fid</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span>
			<span class="n">FILEID_INO32_GEN</span> <span class="o">|</span> <span class="n">XFS_FILEID_TYPE_64FLAG</span><span class="p">,</span>
			<span class="n">xfs_handle_acceptable</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">STATIC</span> <span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span>
<span class="nf">xfs_handlereq_to_dentry</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">file</span>		<span class="o">*</span><span class="n">parfilp</span><span class="p">,</span>
	<span class="n">xfs_fsop_handlereq_t</span>	<span class="o">*</span><span class="n">hreq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">xfs_handle_to_dentry</span><span class="p">(</span><span class="n">parfilp</span><span class="p">,</span> <span class="n">hreq</span><span class="o">-&gt;</span><span class="n">ihandle</span><span class="p">,</span> <span class="n">hreq</span><span class="o">-&gt;</span><span class="n">ihandlen</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="nf">xfs_open_by_handle</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">file</span>		<span class="o">*</span><span class="n">parfilp</span><span class="p">,</span>
	<span class="n">xfs_fsop_handlereq_t</span>	<span class="o">*</span><span class="n">hreq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">cred</span>	<span class="o">*</span><span class="n">cred</span> <span class="o">=</span> <span class="n">current_cred</span><span class="p">();</span>
	<span class="kt">int</span>			<span class="n">error</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">fd</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">permflag</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">file</span>		<span class="o">*</span><span class="n">filp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">inode</span>		<span class="o">*</span><span class="n">inode</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dentry</span>		<span class="o">*</span><span class="n">dentry</span><span class="p">;</span>
	<span class="n">fmode_t</span>			<span class="n">fmode</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">capable</span><span class="p">(</span><span class="n">CAP_SYS_ADMIN</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">XFS_ERROR</span><span class="p">(</span><span class="n">EPERM</span><span class="p">);</span>

	<span class="n">dentry</span> <span class="o">=</span> <span class="n">xfs_handlereq_to_dentry</span><span class="p">(</span><span class="n">parfilp</span><span class="p">,</span> <span class="n">hreq</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">dentry</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">dentry</span><span class="p">);</span>
	<span class="n">inode</span> <span class="o">=</span> <span class="n">dentry</span><span class="o">-&gt;</span><span class="n">d_inode</span><span class="p">;</span>

	<span class="cm">/* Restrict xfs_open_by_handle to directories &amp; regular files. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">S_ISREG</span><span class="p">(</span><span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_mode</span><span class="p">)</span> <span class="o">||</span> <span class="n">S_ISDIR</span><span class="p">(</span><span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_mode</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">XFS_ERROR</span><span class="p">(</span><span class="n">EPERM</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_dput</span><span class="p">;</span>
	<span class="p">}</span>

<span class="cp">#if BITS_PER_LONG != 32</span>
	<span class="n">hreq</span><span class="o">-&gt;</span><span class="n">oflags</span> <span class="o">|=</span> <span class="n">O_LARGEFILE</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="n">permflag</span> <span class="o">=</span> <span class="n">hreq</span><span class="o">-&gt;</span><span class="n">oflags</span><span class="p">;</span>
	<span class="n">fmode</span> <span class="o">=</span> <span class="n">OPEN_FMODE</span><span class="p">(</span><span class="n">permflag</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="o">!</span><span class="p">(</span><span class="n">permflag</span> <span class="o">&amp;</span> <span class="n">O_APPEND</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">permflag</span> <span class="o">&amp;</span> <span class="n">O_TRUNC</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">fmode</span> <span class="o">&amp;</span> <span class="n">FMODE_WRITE</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">IS_APPEND</span><span class="p">(</span><span class="n">inode</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">XFS_ERROR</span><span class="p">(</span><span class="n">EPERM</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_dput</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">fmode</span> <span class="o">&amp;</span> <span class="n">FMODE_WRITE</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">IS_IMMUTABLE</span><span class="p">(</span><span class="n">inode</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">XFS_ERROR</span><span class="p">(</span><span class="n">EACCES</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_dput</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Can&#39;t write directories. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">S_ISDIR</span><span class="p">(</span><span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_mode</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">fmode</span> <span class="o">&amp;</span> <span class="n">FMODE_WRITE</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">XFS_ERROR</span><span class="p">(</span><span class="n">EISDIR</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_dput</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">fd</span> <span class="o">=</span> <span class="n">get_unused_fd</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fd</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">error</span> <span class="o">=</span> <span class="n">fd</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out_dput</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">filp</span> <span class="o">=</span> <span class="n">dentry_open</span><span class="p">(</span><span class="n">dentry</span><span class="p">,</span> <span class="n">mntget</span><span class="p">(</span><span class="n">parfilp</span><span class="o">-&gt;</span><span class="n">f_path</span><span class="p">.</span><span class="n">mnt</span><span class="p">),</span>
			   <span class="n">hreq</span><span class="o">-&gt;</span><span class="n">oflags</span><span class="p">,</span> <span class="n">cred</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">filp</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">put_unused_fd</span><span class="p">(</span><span class="n">fd</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">filp</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">S_ISREG</span><span class="p">(</span><span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_mode</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">filp</span><span class="o">-&gt;</span><span class="n">f_flags</span> <span class="o">|=</span> <span class="n">O_NOATIME</span><span class="p">;</span>
		<span class="n">filp</span><span class="o">-&gt;</span><span class="n">f_mode</span> <span class="o">|=</span> <span class="n">FMODE_NOCMTIME</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">fd_install</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">filp</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">fd</span><span class="p">;</span>

 <span class="nl">out_dput:</span>
	<span class="n">dput</span><span class="p">(</span><span class="n">dentry</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * This is a copy from fs/namei.c:vfs_readlink(), except for removing it&#39;s</span>
<span class="cm"> * unused first argument.</span>
<span class="cm"> */</span>
<span class="n">STATIC</span> <span class="kt">int</span>
<span class="nf">do_readlink</span><span class="p">(</span>
	<span class="kt">char</span> <span class="n">__user</span>		<span class="o">*</span><span class="n">buffer</span><span class="p">,</span>
	<span class="kt">int</span>			<span class="n">buflen</span><span class="p">,</span>
	<span class="k">const</span> <span class="kt">char</span>		<span class="o">*</span><span class="n">link</span><span class="p">)</span>
<span class="p">{</span>
        <span class="kt">int</span> <span class="n">len</span><span class="p">;</span>

	<span class="n">len</span> <span class="o">=</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">link</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">link</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">len</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">link</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;</span> <span class="p">(</span><span class="kt">unsigned</span><span class="p">)</span> <span class="n">buflen</span><span class="p">)</span>
		<span class="n">len</span> <span class="o">=</span> <span class="n">buflen</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="n">link</span><span class="p">,</span> <span class="n">len</span><span class="p">))</span>
		<span class="n">len</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
 <span class="nl">out:</span>
	<span class="k">return</span> <span class="n">len</span><span class="p">;</span>
<span class="p">}</span>


<span class="kt">int</span>
<span class="nf">xfs_readlink_by_handle</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">file</span>		<span class="o">*</span><span class="n">parfilp</span><span class="p">,</span>
	<span class="n">xfs_fsop_handlereq_t</span>	<span class="o">*</span><span class="n">hreq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dentry</span>		<span class="o">*</span><span class="n">dentry</span><span class="p">;</span>
	<span class="n">__u32</span>			<span class="n">olen</span><span class="p">;</span>
	<span class="kt">void</span>			<span class="o">*</span><span class="n">link</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">error</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">capable</span><span class="p">(</span><span class="n">CAP_SYS_ADMIN</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">XFS_ERROR</span><span class="p">(</span><span class="n">EPERM</span><span class="p">);</span>

	<span class="n">dentry</span> <span class="o">=</span> <span class="n">xfs_handlereq_to_dentry</span><span class="p">(</span><span class="n">parfilp</span><span class="p">,</span> <span class="n">hreq</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">dentry</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">dentry</span><span class="p">);</span>

	<span class="cm">/* Restrict this handle operation to symlinks only. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">S_ISLNK</span><span class="p">(</span><span class="n">dentry</span><span class="o">-&gt;</span><span class="n">d_inode</span><span class="o">-&gt;</span><span class="n">i_mode</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">XFS_ERROR</span><span class="p">(</span><span class="n">EINVAL</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_dput</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">olen</span><span class="p">,</span> <span class="n">hreq</span><span class="o">-&gt;</span><span class="n">ohandlen</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">__u32</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">XFS_ERROR</span><span class="p">(</span><span class="n">EFAULT</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_dput</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">link</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">MAXPATHLEN</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">link</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">XFS_ERROR</span><span class="p">(</span><span class="n">ENOMEM</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_dput</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">xfs_readlink</span><span class="p">(</span><span class="n">XFS_I</span><span class="p">(</span><span class="n">dentry</span><span class="o">-&gt;</span><span class="n">d_inode</span><span class="p">),</span> <span class="n">link</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_kfree</span><span class="p">;</span>
	<span class="n">error</span> <span class="o">=</span> <span class="n">do_readlink</span><span class="p">(</span><span class="n">hreq</span><span class="o">-&gt;</span><span class="n">ohandle</span><span class="p">,</span> <span class="n">olen</span><span class="p">,</span> <span class="n">link</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_kfree</span><span class="p">;</span>

 <span class="nl">out_kfree:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">link</span><span class="p">);</span>
 <span class="nl">out_dput:</span>
	<span class="n">dput</span><span class="p">(</span><span class="n">dentry</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">STATIC</span> <span class="kt">int</span>
<span class="nf">xfs_fssetdm_by_handle</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">file</span>		<span class="o">*</span><span class="n">parfilp</span><span class="p">,</span>
	<span class="kt">void</span>			<span class="n">__user</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span>			<span class="n">error</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fsdmidata</span>	<span class="n">fsd</span><span class="p">;</span>
	<span class="n">xfs_fsop_setdm_handlereq_t</span> <span class="n">dmhreq</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dentry</span>		<span class="o">*</span><span class="n">dentry</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">capable</span><span class="p">(</span><span class="n">CAP_MKNOD</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">XFS_ERROR</span><span class="p">(</span><span class="n">EPERM</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dmhreq</span><span class="p">,</span> <span class="n">arg</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">xfs_fsop_setdm_handlereq_t</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">XFS_ERROR</span><span class="p">(</span><span class="n">EFAULT</span><span class="p">);</span>

	<span class="n">dentry</span> <span class="o">=</span> <span class="n">xfs_handlereq_to_dentry</span><span class="p">(</span><span class="n">parfilp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dmhreq</span><span class="p">.</span><span class="n">hreq</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">dentry</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">dentry</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">IS_IMMUTABLE</span><span class="p">(</span><span class="n">dentry</span><span class="o">-&gt;</span><span class="n">d_inode</span><span class="p">)</span> <span class="o">||</span> <span class="n">IS_APPEND</span><span class="p">(</span><span class="n">dentry</span><span class="o">-&gt;</span><span class="n">d_inode</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">XFS_ERROR</span><span class="p">(</span><span class="n">EPERM</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fsd</span><span class="p">,</span> <span class="n">dmhreq</span><span class="p">.</span><span class="n">data</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">fsd</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">XFS_ERROR</span><span class="p">(</span><span class="n">EFAULT</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">xfs_set_dmattrs</span><span class="p">(</span><span class="n">XFS_I</span><span class="p">(</span><span class="n">dentry</span><span class="o">-&gt;</span><span class="n">d_inode</span><span class="p">),</span> <span class="n">fsd</span><span class="p">.</span><span class="n">fsd_dmevmask</span><span class="p">,</span>
				 <span class="n">fsd</span><span class="p">.</span><span class="n">fsd_dmstate</span><span class="p">);</span>

 <span class="nl">out:</span>
	<span class="n">dput</span><span class="p">(</span><span class="n">dentry</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">STATIC</span> <span class="kt">int</span>
<span class="nf">xfs_attrlist_by_handle</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">file</span>		<span class="o">*</span><span class="n">parfilp</span><span class="p">,</span>
	<span class="kt">void</span>			<span class="n">__user</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span>			<span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">attrlist_cursor_kern_t</span>	<span class="o">*</span><span class="n">cursor</span><span class="p">;</span>
	<span class="n">xfs_fsop_attrlist_handlereq_t</span> <span class="n">al_hreq</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dentry</span>		<span class="o">*</span><span class="n">dentry</span><span class="p">;</span>
	<span class="kt">char</span>			<span class="o">*</span><span class="n">kbuf</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">capable</span><span class="p">(</span><span class="n">CAP_SYS_ADMIN</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">XFS_ERROR</span><span class="p">(</span><span class="n">EPERM</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">al_hreq</span><span class="p">,</span> <span class="n">arg</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">xfs_fsop_attrlist_handlereq_t</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">XFS_ERROR</span><span class="p">(</span><span class="n">EFAULT</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">al_hreq</span><span class="p">.</span><span class="n">buflen</span> <span class="o">&gt;</span> <span class="n">XATTR_LIST_MAX</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">XFS_ERROR</span><span class="p">(</span><span class="n">EINVAL</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Reject flags, only allow namespaces.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">al_hreq</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">ATTR_ROOT</span> <span class="o">|</span> <span class="n">ATTR_SECURE</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">XFS_ERROR</span><span class="p">(</span><span class="n">EINVAL</span><span class="p">);</span>

	<span class="n">dentry</span> <span class="o">=</span> <span class="n">xfs_handlereq_to_dentry</span><span class="p">(</span><span class="n">parfilp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">al_hreq</span><span class="p">.</span><span class="n">hreq</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">dentry</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">dentry</span><span class="p">);</span>

	<span class="n">kbuf</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="n">al_hreq</span><span class="p">.</span><span class="n">buflen</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">kbuf</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_dput</span><span class="p">;</span>

	<span class="n">cursor</span> <span class="o">=</span> <span class="p">(</span><span class="n">attrlist_cursor_kern_t</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">al_hreq</span><span class="p">.</span><span class="n">pos</span><span class="p">;</span>
	<span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">xfs_attr_list</span><span class="p">(</span><span class="n">XFS_I</span><span class="p">(</span><span class="n">dentry</span><span class="o">-&gt;</span><span class="n">d_inode</span><span class="p">),</span> <span class="n">kbuf</span><span class="p">,</span> <span class="n">al_hreq</span><span class="p">.</span><span class="n">buflen</span><span class="p">,</span>
					<span class="n">al_hreq</span><span class="p">.</span><span class="n">flags</span><span class="p">,</span> <span class="n">cursor</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_kfree</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">al_hreq</span><span class="p">.</span><span class="n">buffer</span><span class="p">,</span> <span class="n">kbuf</span><span class="p">,</span> <span class="n">al_hreq</span><span class="p">.</span><span class="n">buflen</span><span class="p">))</span>
		<span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

 <span class="nl">out_kfree:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">kbuf</span><span class="p">);</span>
 <span class="nl">out_dput:</span>
	<span class="n">dput</span><span class="p">(</span><span class="n">dentry</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="nf">xfs_attrmulti_attr_get</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">inode</span>		<span class="o">*</span><span class="n">inode</span><span class="p">,</span>
	<span class="kt">unsigned</span> <span class="kt">char</span>		<span class="o">*</span><span class="n">name</span><span class="p">,</span>
	<span class="kt">unsigned</span> <span class="kt">char</span>		<span class="n">__user</span> <span class="o">*</span><span class="n">ubuf</span><span class="p">,</span>
	<span class="n">__uint32_t</span>		<span class="o">*</span><span class="n">len</span><span class="p">,</span>
	<span class="n">__uint32_t</span>		<span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span>		<span class="o">*</span><span class="n">kbuf</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">error</span> <span class="o">=</span> <span class="n">EFAULT</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">len</span> <span class="o">&gt;</span> <span class="n">XATTR_SIZE_MAX</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">kbuf</span> <span class="o">=</span> <span class="n">kmem_zalloc</span><span class="p">(</span><span class="o">*</span><span class="n">len</span><span class="p">,</span> <span class="n">KM_SLEEP</span> <span class="o">|</span> <span class="n">KM_MAYFAIL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">kbuf</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kbuf</span> <span class="o">=</span> <span class="n">kmem_zalloc_large</span><span class="p">(</span><span class="o">*</span><span class="n">len</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">kbuf</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">error</span> <span class="o">=</span> <span class="n">xfs_attr_get</span><span class="p">(</span><span class="n">XFS_I</span><span class="p">(</span><span class="n">inode</span><span class="p">),</span> <span class="n">name</span><span class="p">,</span> <span class="n">kbuf</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="p">)</span><span class="n">len</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_kfree</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">ubuf</span><span class="p">,</span> <span class="n">kbuf</span><span class="p">,</span> <span class="o">*</span><span class="n">len</span><span class="p">))</span>
		<span class="n">error</span> <span class="o">=</span> <span class="n">EFAULT</span><span class="p">;</span>

 <span class="nl">out_kfree:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">is_vmalloc_addr</span><span class="p">(</span><span class="n">kbuf</span><span class="p">))</span>
		<span class="n">kmem_free_large</span><span class="p">(</span><span class="n">kbuf</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">kmem_free</span><span class="p">(</span><span class="n">kbuf</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="nf">xfs_attrmulti_attr_set</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">inode</span>		<span class="o">*</span><span class="n">inode</span><span class="p">,</span>
	<span class="kt">unsigned</span> <span class="kt">char</span>		<span class="o">*</span><span class="n">name</span><span class="p">,</span>
	<span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span>	<span class="n">__user</span> <span class="o">*</span><span class="n">ubuf</span><span class="p">,</span>
	<span class="n">__uint32_t</span>		<span class="n">len</span><span class="p">,</span>
	<span class="n">__uint32_t</span>		<span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span>		<span class="o">*</span><span class="n">kbuf</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">error</span> <span class="o">=</span> <span class="n">EFAULT</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">IS_IMMUTABLE</span><span class="p">(</span><span class="n">inode</span><span class="p">)</span> <span class="o">||</span> <span class="n">IS_APPEND</span><span class="p">(</span><span class="n">inode</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">EPERM</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;</span> <span class="n">XATTR_SIZE_MAX</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">kbuf</span> <span class="o">=</span> <span class="n">memdup_user</span><span class="p">(</span><span class="n">ubuf</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">kbuf</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">kbuf</span><span class="p">);</span>

	<span class="n">error</span> <span class="o">=</span> <span class="n">xfs_attr_set</span><span class="p">(</span><span class="n">XFS_I</span><span class="p">(</span><span class="n">inode</span><span class="p">),</span> <span class="n">name</span><span class="p">,</span> <span class="n">kbuf</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="nf">xfs_attrmulti_attr_remove</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">inode</span>		<span class="o">*</span><span class="n">inode</span><span class="p">,</span>
	<span class="kt">unsigned</span> <span class="kt">char</span>		<span class="o">*</span><span class="n">name</span><span class="p">,</span>
	<span class="n">__uint32_t</span>		<span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_IMMUTABLE</span><span class="p">(</span><span class="n">inode</span><span class="p">)</span> <span class="o">||</span> <span class="n">IS_APPEND</span><span class="p">(</span><span class="n">inode</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">EPERM</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">xfs_attr_remove</span><span class="p">(</span><span class="n">XFS_I</span><span class="p">(</span><span class="n">inode</span><span class="p">),</span> <span class="n">name</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">STATIC</span> <span class="kt">int</span>
<span class="nf">xfs_attrmulti_by_handle</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">file</span>		<span class="o">*</span><span class="n">parfilp</span><span class="p">,</span>
	<span class="kt">void</span>			<span class="n">__user</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span>			<span class="n">error</span><span class="p">;</span>
	<span class="n">xfs_attr_multiop_t</span>	<span class="o">*</span><span class="n">ops</span><span class="p">;</span>
	<span class="n">xfs_fsop_attrmulti_handlereq_t</span> <span class="n">am_hreq</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dentry</span>		<span class="o">*</span><span class="n">dentry</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>		<span class="n">i</span><span class="p">,</span> <span class="n">size</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span>		<span class="o">*</span><span class="n">attr_name</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">capable</span><span class="p">(</span><span class="n">CAP_SYS_ADMIN</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">XFS_ERROR</span><span class="p">(</span><span class="n">EPERM</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">am_hreq</span><span class="p">,</span> <span class="n">arg</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">xfs_fsop_attrmulti_handlereq_t</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">XFS_ERROR</span><span class="p">(</span><span class="n">EFAULT</span><span class="p">);</span>

	<span class="cm">/* overflow check */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">am_hreq</span><span class="p">.</span><span class="n">opcount</span> <span class="o">&gt;=</span> <span class="n">INT_MAX</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">xfs_attr_multiop_t</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">E2BIG</span><span class="p">;</span>

	<span class="n">dentry</span> <span class="o">=</span> <span class="n">xfs_handlereq_to_dentry</span><span class="p">(</span><span class="n">parfilp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">am_hreq</span><span class="p">.</span><span class="n">hreq</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">dentry</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">dentry</span><span class="p">);</span>

	<span class="n">error</span> <span class="o">=</span> <span class="n">E2BIG</span><span class="p">;</span>
	<span class="n">size</span> <span class="o">=</span> <span class="n">am_hreq</span><span class="p">.</span><span class="n">opcount</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">xfs_attr_multiop_t</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">size</span> <span class="o">||</span> <span class="n">size</span> <span class="o">&gt;</span> <span class="mi">16</span> <span class="o">*</span> <span class="n">PAGE_SIZE</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_dput</span><span class="p">;</span>

	<span class="n">ops</span> <span class="o">=</span> <span class="n">memdup_user</span><span class="p">(</span><span class="n">am_hreq</span><span class="p">.</span><span class="n">ops</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">ops</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">error</span> <span class="o">=</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">ops</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_dput</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">attr_name</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">MAXNAMELEN</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">attr_name</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_kfree_ops</span><span class="p">;</span>

	<span class="n">error</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">am_hreq</span><span class="p">.</span><span class="n">opcount</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ops</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">am_error</span> <span class="o">=</span> <span class="n">strncpy_from_user</span><span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">attr_name</span><span class="p">,</span>
				<span class="n">ops</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">am_attrname</span><span class="p">,</span> <span class="n">MAXNAMELEN</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ops</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">am_error</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">ops</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">am_error</span> <span class="o">==</span> <span class="n">MAXNAMELEN</span><span class="p">)</span>
			<span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">ERANGE</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ops</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">am_error</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">ops</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">am_opcode</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">ATTR_OP_GET</span>:
			<span class="n">ops</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">am_error</span> <span class="o">=</span> <span class="n">xfs_attrmulti_attr_get</span><span class="p">(</span>
					<span class="n">dentry</span><span class="o">-&gt;</span><span class="n">d_inode</span><span class="p">,</span> <span class="n">attr_name</span><span class="p">,</span>
					<span class="n">ops</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">am_attrvalue</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ops</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">am_length</span><span class="p">,</span>
					<span class="n">ops</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">am_flags</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">ATTR_OP_SET</span>:
			<span class="n">ops</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">am_error</span> <span class="o">=</span> <span class="n">mnt_want_write_file</span><span class="p">(</span><span class="n">parfilp</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ops</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">am_error</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="n">ops</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">am_error</span> <span class="o">=</span> <span class="n">xfs_attrmulti_attr_set</span><span class="p">(</span>
					<span class="n">dentry</span><span class="o">-&gt;</span><span class="n">d_inode</span><span class="p">,</span> <span class="n">attr_name</span><span class="p">,</span>
					<span class="n">ops</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">am_attrvalue</span><span class="p">,</span> <span class="n">ops</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">am_length</span><span class="p">,</span>
					<span class="n">ops</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">am_flags</span><span class="p">);</span>
			<span class="n">mnt_drop_write_file</span><span class="p">(</span><span class="n">parfilp</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">ATTR_OP_REMOVE</span>:
			<span class="n">ops</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">am_error</span> <span class="o">=</span> <span class="n">mnt_want_write_file</span><span class="p">(</span><span class="n">parfilp</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ops</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">am_error</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="n">ops</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">am_error</span> <span class="o">=</span> <span class="n">xfs_attrmulti_attr_remove</span><span class="p">(</span>
					<span class="n">dentry</span><span class="o">-&gt;</span><span class="n">d_inode</span><span class="p">,</span> <span class="n">attr_name</span><span class="p">,</span>
					<span class="n">ops</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">am_flags</span><span class="p">);</span>
			<span class="n">mnt_drop_write_file</span><span class="p">(</span><span class="n">parfilp</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">ops</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">am_error</span> <span class="o">=</span> <span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">am_hreq</span><span class="p">.</span><span class="n">ops</span><span class="p">,</span> <span class="n">ops</span><span class="p">,</span> <span class="n">size</span><span class="p">))</span>
		<span class="n">error</span> <span class="o">=</span> <span class="n">XFS_ERROR</span><span class="p">(</span><span class="n">EFAULT</span><span class="p">);</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">attr_name</span><span class="p">);</span>
 <span class="nl">out_kfree_ops:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">ops</span><span class="p">);</span>
 <span class="nl">out_dput:</span>
	<span class="n">dput</span><span class="p">(</span><span class="n">dentry</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">error</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="nf">xfs_ioc_space</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">xfs_inode</span>	<span class="o">*</span><span class="n">ip</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">inode</span>		<span class="o">*</span><span class="n">inode</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">file</span>		<span class="o">*</span><span class="n">filp</span><span class="p">,</span>
	<span class="kt">int</span>			<span class="n">ioflags</span><span class="p">,</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>		<span class="n">cmd</span><span class="p">,</span>
	<span class="n">xfs_flock64_t</span>		<span class="o">*</span><span class="n">bf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span>			<span class="n">attr_flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">error</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Only allow the sys admin to reserve space unless</span>
<span class="cm">	 * unwritten extents are enabled.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">xfs_sb_version_hasextflgbit</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_mount</span><span class="o">-&gt;</span><span class="n">m_sb</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="n">capable</span><span class="p">(</span><span class="n">CAP_SYS_ADMIN</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">XFS_ERROR</span><span class="p">(</span><span class="n">EPERM</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_flags</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">S_IMMUTABLE</span><span class="o">|</span><span class="n">S_APPEND</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">XFS_ERROR</span><span class="p">(</span><span class="n">EPERM</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">filp</span><span class="o">-&gt;</span><span class="n">f_mode</span> <span class="o">&amp;</span> <span class="n">FMODE_WRITE</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">XFS_ERROR</span><span class="p">(</span><span class="n">EBADF</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">S_ISREG</span><span class="p">(</span><span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_mode</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">XFS_ERROR</span><span class="p">(</span><span class="n">EINVAL</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">filp</span><span class="o">-&gt;</span><span class="n">f_flags</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">O_NDELAY</span><span class="o">|</span><span class="n">O_NONBLOCK</span><span class="p">))</span>
		<span class="n">attr_flags</span> <span class="o">|=</span> <span class="n">XFS_ATTR_NONBLOCK</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">filp</span><span class="o">-&gt;</span><span class="n">f_flags</span> <span class="o">&amp;</span> <span class="n">O_DSYNC</span><span class="p">)</span>
		<span class="n">attr_flags</span> <span class="o">|=</span> <span class="n">XFS_ATTR_SYNC</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ioflags</span> <span class="o">&amp;</span> <span class="n">IO_INVIS</span><span class="p">)</span>
		<span class="n">attr_flags</span> <span class="o">|=</span> <span class="n">XFS_ATTR_DMI</span><span class="p">;</span>

	<span class="n">error</span> <span class="o">=</span> <span class="n">xfs_change_file_space</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">bf</span><span class="p">,</span> <span class="n">filp</span><span class="o">-&gt;</span><span class="n">f_pos</span><span class="p">,</span> <span class="n">attr_flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">error</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">STATIC</span> <span class="kt">int</span>
<span class="nf">xfs_ioc_bulkstat</span><span class="p">(</span>
	<span class="n">xfs_mount_t</span>		<span class="o">*</span><span class="n">mp</span><span class="p">,</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>		<span class="n">cmd</span><span class="p">,</span>
	<span class="kt">void</span>			<span class="n">__user</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">xfs_fsop_bulkreq_t</span>	<span class="n">bulkreq</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">count</span><span class="p">;</span>	<span class="cm">/* # of records returned */</span>
	<span class="n">xfs_ino_t</span>		<span class="n">inlast</span><span class="p">;</span>	<span class="cm">/* last inode number */</span>
	<span class="kt">int</span>			<span class="n">done</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">error</span><span class="p">;</span>

	<span class="cm">/* done = 1 if there are more stats to get and if bulkstat */</span>
	<span class="cm">/* should be called again (unused here, but used in dmapi) */</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">capable</span><span class="p">(</span><span class="n">CAP_SYS_ADMIN</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">XFS_FORCED_SHUTDOWN</span><span class="p">(</span><span class="n">mp</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">XFS_ERROR</span><span class="p">(</span><span class="n">EIO</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bulkreq</span><span class="p">,</span> <span class="n">arg</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">xfs_fsop_bulkreq_t</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">XFS_ERROR</span><span class="p">(</span><span class="n">EFAULT</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">inlast</span><span class="p">,</span> <span class="n">bulkreq</span><span class="p">.</span><span class="n">lastip</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">__s64</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">XFS_ERROR</span><span class="p">(</span><span class="n">EFAULT</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">count</span> <span class="o">=</span> <span class="n">bulkreq</span><span class="p">.</span><span class="n">icount</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">XFS_ERROR</span><span class="p">(</span><span class="n">EINVAL</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bulkreq</span><span class="p">.</span><span class="n">ubuffer</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">XFS_ERROR</span><span class="p">(</span><span class="n">EINVAL</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span> <span class="o">==</span> <span class="n">XFS_IOC_FSINUMBERS</span><span class="p">)</span>
		<span class="n">error</span> <span class="o">=</span> <span class="n">xfs_inumbers</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">inlast</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">count</span><span class="p">,</span>
					<span class="n">bulkreq</span><span class="p">.</span><span class="n">ubuffer</span><span class="p">,</span> <span class="n">xfs_inumbers_fmt</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">cmd</span> <span class="o">==</span> <span class="n">XFS_IOC_FSBULKSTAT_SINGLE</span><span class="p">)</span>
		<span class="n">error</span> <span class="o">=</span> <span class="n">xfs_bulkstat_single</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">inlast</span><span class="p">,</span>
						<span class="n">bulkreq</span><span class="p">.</span><span class="n">ubuffer</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">done</span><span class="p">);</span>
	<span class="k">else</span>	<span class="cm">/* XFS_IOC_FSBULKSTAT */</span>
		<span class="n">error</span> <span class="o">=</span> <span class="n">xfs_bulkstat</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">inlast</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">count</span><span class="p">,</span> <span class="n">xfs_bulkstat_one</span><span class="p">,</span>
				     <span class="k">sizeof</span><span class="p">(</span><span class="n">xfs_bstat_t</span><span class="p">),</span> <span class="n">bulkreq</span><span class="p">.</span><span class="n">ubuffer</span><span class="p">,</span>
				     <span class="o">&amp;</span><span class="n">done</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">error</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bulkreq</span><span class="p">.</span><span class="n">ocount</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">bulkreq</span><span class="p">.</span><span class="n">lastip</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">inlast</span><span class="p">,</span>
						<span class="k">sizeof</span><span class="p">(</span><span class="n">xfs_ino_t</span><span class="p">)))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">XFS_ERROR</span><span class="p">(</span><span class="n">EFAULT</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">bulkreq</span><span class="p">.</span><span class="n">ocount</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">count</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">count</span><span class="p">)))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">XFS_ERROR</span><span class="p">(</span><span class="n">EFAULT</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">STATIC</span> <span class="kt">int</span>
<span class="nf">xfs_ioc_fsgeometry_v1</span><span class="p">(</span>
	<span class="n">xfs_mount_t</span>		<span class="o">*</span><span class="n">mp</span><span class="p">,</span>
	<span class="kt">void</span>			<span class="n">__user</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">xfs_fsop_geom_t</span>         <span class="n">fsgeo</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">error</span><span class="p">;</span>

	<span class="n">error</span> <span class="o">=</span> <span class="n">xfs_fs_geometry</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fsgeo</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">error</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Caller should have passed an argument of type</span>
<span class="cm">	 * xfs_fsop_geom_v1_t.  This is a proper subset of the</span>
<span class="cm">	 * xfs_fsop_geom_t that xfs_fs_geometry() fills in.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fsgeo</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">xfs_fsop_geom_v1_t</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">XFS_ERROR</span><span class="p">(</span><span class="n">EFAULT</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">STATIC</span> <span class="kt">int</span>
<span class="nf">xfs_ioc_fsgeometry</span><span class="p">(</span>
	<span class="n">xfs_mount_t</span>		<span class="o">*</span><span class="n">mp</span><span class="p">,</span>
	<span class="kt">void</span>			<span class="n">__user</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">xfs_fsop_geom_t</span>		<span class="n">fsgeo</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">error</span><span class="p">;</span>

	<span class="n">error</span> <span class="o">=</span> <span class="n">xfs_fs_geometry</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fsgeo</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">error</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fsgeo</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">fsgeo</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">XFS_ERROR</span><span class="p">(</span><span class="n">EFAULT</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Linux extended inode flags interface.</span>
<span class="cm"> */</span>

<span class="n">STATIC</span> <span class="kt">unsigned</span> <span class="kt">int</span>
<span class="nf">xfs_merge_ioc_xflags</span><span class="p">(</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>	<span class="n">flags</span><span class="p">,</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>	<span class="n">start</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>	<span class="n">xflags</span> <span class="o">=</span> <span class="n">start</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">FS_IMMUTABLE_FL</span><span class="p">)</span>
		<span class="n">xflags</span> <span class="o">|=</span> <span class="n">XFS_XFLAG_IMMUTABLE</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">xflags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">XFS_XFLAG_IMMUTABLE</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">FS_APPEND_FL</span><span class="p">)</span>
		<span class="n">xflags</span> <span class="o">|=</span> <span class="n">XFS_XFLAG_APPEND</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">xflags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">XFS_XFLAG_APPEND</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">FS_SYNC_FL</span><span class="p">)</span>
		<span class="n">xflags</span> <span class="o">|=</span> <span class="n">XFS_XFLAG_SYNC</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">xflags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">XFS_XFLAG_SYNC</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">FS_NOATIME_FL</span><span class="p">)</span>
		<span class="n">xflags</span> <span class="o">|=</span> <span class="n">XFS_XFLAG_NOATIME</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">xflags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">XFS_XFLAG_NOATIME</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">FS_NODUMP_FL</span><span class="p">)</span>
		<span class="n">xflags</span> <span class="o">|=</span> <span class="n">XFS_XFLAG_NODUMP</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">xflags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">XFS_XFLAG_NODUMP</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">xflags</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">STATIC</span> <span class="kt">unsigned</span> <span class="kt">int</span>
<span class="nf">xfs_di2lxflags</span><span class="p">(</span>
	<span class="n">__uint16_t</span>	<span class="n">di_flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>	<span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">di_flags</span> <span class="o">&amp;</span> <span class="n">XFS_DIFLAG_IMMUTABLE</span><span class="p">)</span>
		<span class="n">flags</span> <span class="o">|=</span> <span class="n">FS_IMMUTABLE_FL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">di_flags</span> <span class="o">&amp;</span> <span class="n">XFS_DIFLAG_APPEND</span><span class="p">)</span>
		<span class="n">flags</span> <span class="o">|=</span> <span class="n">FS_APPEND_FL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">di_flags</span> <span class="o">&amp;</span> <span class="n">XFS_DIFLAG_SYNC</span><span class="p">)</span>
		<span class="n">flags</span> <span class="o">|=</span> <span class="n">FS_SYNC_FL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">di_flags</span> <span class="o">&amp;</span> <span class="n">XFS_DIFLAG_NOATIME</span><span class="p">)</span>
		<span class="n">flags</span> <span class="o">|=</span> <span class="n">FS_NOATIME_FL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">di_flags</span> <span class="o">&amp;</span> <span class="n">XFS_DIFLAG_NODUMP</span><span class="p">)</span>
		<span class="n">flags</span> <span class="o">|=</span> <span class="n">FS_NODUMP_FL</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">flags</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">STATIC</span> <span class="kt">int</span>
<span class="nf">xfs_ioc_fsgetxattr</span><span class="p">(</span>
	<span class="n">xfs_inode_t</span>		<span class="o">*</span><span class="n">ip</span><span class="p">,</span>
	<span class="kt">int</span>			<span class="n">attr</span><span class="p">,</span>
	<span class="kt">void</span>			<span class="n">__user</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fsxattr</span>		<span class="n">fa</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fa</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">fsxattr</span><span class="p">));</span>

	<span class="n">xfs_ilock</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">XFS_ILOCK_SHARED</span><span class="p">);</span>
	<span class="n">fa</span><span class="p">.</span><span class="n">fsx_xflags</span> <span class="o">=</span> <span class="n">xfs_ip2xflags</span><span class="p">(</span><span class="n">ip</span><span class="p">);</span>
	<span class="n">fa</span><span class="p">.</span><span class="n">fsx_extsize</span> <span class="o">=</span> <span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_d</span><span class="p">.</span><span class="n">di_extsize</span> <span class="o">&lt;&lt;</span> <span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_mount</span><span class="o">-&gt;</span><span class="n">m_sb</span><span class="p">.</span><span class="n">sb_blocklog</span><span class="p">;</span>
	<span class="n">fa</span><span class="p">.</span><span class="n">fsx_projid</span> <span class="o">=</span> <span class="n">xfs_get_projid</span><span class="p">(</span><span class="n">ip</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">attr</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_afp</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_afp</span><span class="o">-&gt;</span><span class="n">if_flags</span> <span class="o">&amp;</span> <span class="n">XFS_IFEXTENTS</span><span class="p">)</span>
				<span class="n">fa</span><span class="p">.</span><span class="n">fsx_nextents</span> <span class="o">=</span> <span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_afp</span><span class="o">-&gt;</span><span class="n">if_bytes</span> <span class="o">/</span>
							<span class="k">sizeof</span><span class="p">(</span><span class="n">xfs_bmbt_rec_t</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">fa</span><span class="p">.</span><span class="n">fsx_nextents</span> <span class="o">=</span> <span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_d</span><span class="p">.</span><span class="n">di_anextents</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">fa</span><span class="p">.</span><span class="n">fsx_nextents</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_df</span><span class="p">.</span><span class="n">if_flags</span> <span class="o">&amp;</span> <span class="n">XFS_IFEXTENTS</span><span class="p">)</span>
			<span class="n">fa</span><span class="p">.</span><span class="n">fsx_nextents</span> <span class="o">=</span> <span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_df</span><span class="p">.</span><span class="n">if_bytes</span> <span class="o">/</span>
						<span class="k">sizeof</span><span class="p">(</span><span class="n">xfs_bmbt_rec_t</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">fa</span><span class="p">.</span><span class="n">fsx_nextents</span> <span class="o">=</span> <span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_d</span><span class="p">.</span><span class="n">di_nextents</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">xfs_iunlock</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">XFS_ILOCK_SHARED</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fa</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">fa</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">STATIC</span> <span class="kt">void</span>
<span class="nf">xfs_set_diflags</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">xfs_inode</span>	<span class="o">*</span><span class="n">ip</span><span class="p">,</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>		<span class="n">xflags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>		<span class="n">di_flags</span><span class="p">;</span>

	<span class="cm">/* can&#39;t set PREALLOC this way, just preserve it */</span>
	<span class="n">di_flags</span> <span class="o">=</span> <span class="p">(</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_d</span><span class="p">.</span><span class="n">di_flags</span> <span class="o">&amp;</span> <span class="n">XFS_DIFLAG_PREALLOC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">xflags</span> <span class="o">&amp;</span> <span class="n">XFS_XFLAG_IMMUTABLE</span><span class="p">)</span>
		<span class="n">di_flags</span> <span class="o">|=</span> <span class="n">XFS_DIFLAG_IMMUTABLE</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">xflags</span> <span class="o">&amp;</span> <span class="n">XFS_XFLAG_APPEND</span><span class="p">)</span>
		<span class="n">di_flags</span> <span class="o">|=</span> <span class="n">XFS_DIFLAG_APPEND</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">xflags</span> <span class="o">&amp;</span> <span class="n">XFS_XFLAG_SYNC</span><span class="p">)</span>
		<span class="n">di_flags</span> <span class="o">|=</span> <span class="n">XFS_DIFLAG_SYNC</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">xflags</span> <span class="o">&amp;</span> <span class="n">XFS_XFLAG_NOATIME</span><span class="p">)</span>
		<span class="n">di_flags</span> <span class="o">|=</span> <span class="n">XFS_DIFLAG_NOATIME</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">xflags</span> <span class="o">&amp;</span> <span class="n">XFS_XFLAG_NODUMP</span><span class="p">)</span>
		<span class="n">di_flags</span> <span class="o">|=</span> <span class="n">XFS_DIFLAG_NODUMP</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">xflags</span> <span class="o">&amp;</span> <span class="n">XFS_XFLAG_PROJINHERIT</span><span class="p">)</span>
		<span class="n">di_flags</span> <span class="o">|=</span> <span class="n">XFS_DIFLAG_PROJINHERIT</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">xflags</span> <span class="o">&amp;</span> <span class="n">XFS_XFLAG_NODEFRAG</span><span class="p">)</span>
		<span class="n">di_flags</span> <span class="o">|=</span> <span class="n">XFS_DIFLAG_NODEFRAG</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">xflags</span> <span class="o">&amp;</span> <span class="n">XFS_XFLAG_FILESTREAM</span><span class="p">)</span>
		<span class="n">di_flags</span> <span class="o">|=</span> <span class="n">XFS_DIFLAG_FILESTREAM</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">S_ISDIR</span><span class="p">(</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_d</span><span class="p">.</span><span class="n">di_mode</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">xflags</span> <span class="o">&amp;</span> <span class="n">XFS_XFLAG_RTINHERIT</span><span class="p">)</span>
			<span class="n">di_flags</span> <span class="o">|=</span> <span class="n">XFS_DIFLAG_RTINHERIT</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">xflags</span> <span class="o">&amp;</span> <span class="n">XFS_XFLAG_NOSYMLINKS</span><span class="p">)</span>
			<span class="n">di_flags</span> <span class="o">|=</span> <span class="n">XFS_DIFLAG_NOSYMLINKS</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">xflags</span> <span class="o">&amp;</span> <span class="n">XFS_XFLAG_EXTSZINHERIT</span><span class="p">)</span>
			<span class="n">di_flags</span> <span class="o">|=</span> <span class="n">XFS_DIFLAG_EXTSZINHERIT</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">S_ISREG</span><span class="p">(</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_d</span><span class="p">.</span><span class="n">di_mode</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">xflags</span> <span class="o">&amp;</span> <span class="n">XFS_XFLAG_REALTIME</span><span class="p">)</span>
			<span class="n">di_flags</span> <span class="o">|=</span> <span class="n">XFS_DIFLAG_REALTIME</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">xflags</span> <span class="o">&amp;</span> <span class="n">XFS_XFLAG_EXTSIZE</span><span class="p">)</span>
			<span class="n">di_flags</span> <span class="o">|=</span> <span class="n">XFS_DIFLAG_EXTSIZE</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_d</span><span class="p">.</span><span class="n">di_flags</span> <span class="o">=</span> <span class="n">di_flags</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">STATIC</span> <span class="kt">void</span>
<span class="nf">xfs_diflags_to_linux</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">xfs_inode</span>	<span class="o">*</span><span class="n">ip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">inode</span>		<span class="o">*</span><span class="n">inode</span> <span class="o">=</span> <span class="n">VFS_I</span><span class="p">(</span><span class="n">ip</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>		<span class="n">xflags</span> <span class="o">=</span> <span class="n">xfs_ip2xflags</span><span class="p">(</span><span class="n">ip</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">xflags</span> <span class="o">&amp;</span> <span class="n">XFS_XFLAG_IMMUTABLE</span><span class="p">)</span>
		<span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_flags</span> <span class="o">|=</span> <span class="n">S_IMMUTABLE</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">S_IMMUTABLE</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">xflags</span> <span class="o">&amp;</span> <span class="n">XFS_XFLAG_APPEND</span><span class="p">)</span>
		<span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_flags</span> <span class="o">|=</span> <span class="n">S_APPEND</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">S_APPEND</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">xflags</span> <span class="o">&amp;</span> <span class="n">XFS_XFLAG_SYNC</span><span class="p">)</span>
		<span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_flags</span> <span class="o">|=</span> <span class="n">S_SYNC</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">S_SYNC</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">xflags</span> <span class="o">&amp;</span> <span class="n">XFS_XFLAG_NOATIME</span><span class="p">)</span>
		<span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_flags</span> <span class="o">|=</span> <span class="n">S_NOATIME</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">S_NOATIME</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define FSX_PROJID	1</span>
<span class="cp">#define FSX_EXTSIZE	2</span>
<span class="cp">#define FSX_XFLAGS	4</span>
<span class="cp">#define FSX_NONBLOCK	8</span>

<span class="n">STATIC</span> <span class="kt">int</span>
<span class="nf">xfs_ioctl_setattr</span><span class="p">(</span>
	<span class="n">xfs_inode_t</span>		<span class="o">*</span><span class="n">ip</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">fsxattr</span>		<span class="o">*</span><span class="n">fa</span><span class="p">,</span>
	<span class="kt">int</span>			<span class="n">mask</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">xfs_mount</span>	<span class="o">*</span><span class="n">mp</span> <span class="o">=</span> <span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_mount</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">xfs_trans</span>	<span class="o">*</span><span class="n">tp</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>		<span class="n">lock_flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">xfs_dquot</span>	<span class="o">*</span><span class="n">udqp</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">xfs_dquot</span>	<span class="o">*</span><span class="n">gdqp</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">xfs_dquot</span>	<span class="o">*</span><span class="n">olddquot</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">code</span><span class="p">;</span>

	<span class="n">trace_xfs_ioctl_setattr</span><span class="p">(</span><span class="n">ip</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_flags</span> <span class="o">&amp;</span> <span class="n">XFS_MOUNT_RDONLY</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">XFS_ERROR</span><span class="p">(</span><span class="n">EROFS</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">XFS_FORCED_SHUTDOWN</span><span class="p">(</span><span class="n">mp</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">XFS_ERROR</span><span class="p">(</span><span class="n">EIO</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Disallow 32bit project ids when projid32bit feature is not enabled.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="n">FSX_PROJID</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">fa</span><span class="o">-&gt;</span><span class="n">fsx_projid</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">__uint16_t</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			<span class="o">!</span><span class="n">xfs_sb_version_hasprojid32bit</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_mount</span><span class="o">-&gt;</span><span class="n">m_sb</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">XFS_ERROR</span><span class="p">(</span><span class="n">EINVAL</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * If disk quotas is on, we make sure that the dquots do exist on disk,</span>
<span class="cm">	 * before we start any other transactions. Trying to do this later</span>
<span class="cm">	 * is messy. We don&#39;t care to take a readlock to look at the ids</span>
<span class="cm">	 * in inode here, because we can&#39;t hold it across the trans_reserve.</span>
<span class="cm">	 * If the IDs do change before we take the ilock, we&#39;re covered</span>
<span class="cm">	 * because the i_*dquot fields will get updated anyway.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">XFS_IS_QUOTA_ON</span><span class="p">(</span><span class="n">mp</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="n">FSX_PROJID</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">code</span> <span class="o">=</span> <span class="n">xfs_qm_vop_dqalloc</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_d</span><span class="p">.</span><span class="n">di_uid</span><span class="p">,</span>
					 <span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_d</span><span class="p">.</span><span class="n">di_gid</span><span class="p">,</span> <span class="n">fa</span><span class="o">-&gt;</span><span class="n">fsx_projid</span><span class="p">,</span>
					 <span class="n">XFS_QMOPT_PQUOTA</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">udqp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">gdqp</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">code</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">code</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * For the other attributes, we acquire the inode lock and</span>
<span class="cm">	 * first do an error checking pass.</span>
<span class="cm">	 */</span>
	<span class="n">tp</span> <span class="o">=</span> <span class="n">xfs_trans_alloc</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="n">XFS_TRANS_SETATTR_NOT_SIZE</span><span class="p">);</span>
	<span class="n">code</span> <span class="o">=</span> <span class="n">xfs_trans_reserve</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">XFS_ICHANGE_LOG_RES</span><span class="p">(</span><span class="n">mp</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">code</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error_return</span><span class="p">;</span>

	<span class="n">lock_flags</span> <span class="o">=</span> <span class="n">XFS_ILOCK_EXCL</span><span class="p">;</span>
	<span class="n">xfs_ilock</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">lock_flags</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * CAP_FOWNER overrides the following restrictions:</span>
<span class="cm">	 *</span>
<span class="cm">	 * The user ID of the calling process must be equal</span>
<span class="cm">	 * to the file owner ID, except in cases where the</span>
<span class="cm">	 * CAP_FSETID capability is applicable.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">current_fsuid</span><span class="p">()</span> <span class="o">!=</span> <span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_d</span><span class="p">.</span><span class="n">di_uid</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">capable</span><span class="p">(</span><span class="n">CAP_FOWNER</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">code</span> <span class="o">=</span> <span class="n">XFS_ERROR</span><span class="p">(</span><span class="n">EPERM</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">error_return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Do a quota reservation only if projid is actually going to change.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="n">FSX_PROJID</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">XFS_IS_QUOTA_RUNNING</span><span class="p">(</span><span class="n">mp</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="n">XFS_IS_PQUOTA_ON</span><span class="p">(</span><span class="n">mp</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="n">xfs_get_projid</span><span class="p">(</span><span class="n">ip</span><span class="p">)</span> <span class="o">!=</span> <span class="n">fa</span><span class="o">-&gt;</span><span class="n">fsx_projid</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ASSERT</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>
			<span class="n">code</span> <span class="o">=</span> <span class="n">xfs_qm_vop_chown_reserve</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">ip</span><span class="p">,</span> <span class="n">udqp</span><span class="p">,</span> <span class="n">gdqp</span><span class="p">,</span>
						<span class="n">capable</span><span class="p">(</span><span class="n">CAP_FOWNER</span><span class="p">)</span> <span class="o">?</span>
						<span class="n">XFS_QMOPT_FORCE_RES</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">code</span><span class="p">)</span>	<span class="cm">/* out of quota */</span>
				<span class="k">goto</span> <span class="n">error_return</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="n">FSX_EXTSIZE</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Can&#39;t change extent size if any extents are allocated.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_d</span><span class="p">.</span><span class="n">di_nextents</span> <span class="o">&amp;&amp;</span>
		    <span class="p">((</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_d</span><span class="p">.</span><span class="n">di_extsize</span> <span class="o">&lt;&lt;</span> <span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_sb</span><span class="p">.</span><span class="n">sb_blocklog</span><span class="p">)</span> <span class="o">!=</span>
		     <span class="n">fa</span><span class="o">-&gt;</span><span class="n">fsx_extsize</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">code</span> <span class="o">=</span> <span class="n">XFS_ERROR</span><span class="p">(</span><span class="n">EINVAL</span><span class="p">);</span>	<span class="cm">/* EFBIG? */</span>
			<span class="k">goto</span> <span class="n">error_return</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/*</span>
<span class="cm">		 * Extent size must be a multiple of the appropriate block</span>
<span class="cm">		 * size, if set at all. It must also be smaller than the</span>
<span class="cm">		 * maximum extent size supported by the filesystem.</span>
<span class="cm">		 *</span>
<span class="cm">		 * Also, for non-realtime files, limit the extent size hint to</span>
<span class="cm">		 * half the size of the AGs in the filesystem so alignment</span>
<span class="cm">		 * doesn&#39;t result in extents larger than an AG.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">fa</span><span class="o">-&gt;</span><span class="n">fsx_extsize</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">xfs_extlen_t</span>    <span class="n">size</span><span class="p">;</span>
			<span class="n">xfs_fsblock_t</span>   <span class="n">extsize_fsb</span><span class="p">;</span>

			<span class="n">extsize_fsb</span> <span class="o">=</span> <span class="n">XFS_B_TO_FSB</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="n">fa</span><span class="o">-&gt;</span><span class="n">fsx_extsize</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">extsize_fsb</span> <span class="o">&gt;</span> <span class="n">MAXEXTLEN</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">code</span> <span class="o">=</span> <span class="n">XFS_ERROR</span><span class="p">(</span><span class="n">EINVAL</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">error_return</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">XFS_IS_REALTIME_INODE</span><span class="p">(</span><span class="n">ip</span><span class="p">)</span> <span class="o">||</span>
			    <span class="p">((</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="n">FSX_XFLAGS</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			    <span class="p">(</span><span class="n">fa</span><span class="o">-&gt;</span><span class="n">fsx_xflags</span> <span class="o">&amp;</span> <span class="n">XFS_XFLAG_REALTIME</span><span class="p">)))</span> <span class="p">{</span>
				<span class="n">size</span> <span class="o">=</span> <span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_sb</span><span class="p">.</span><span class="n">sb_rextsize</span> <span class="o">&lt;&lt;</span>
				       <span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_sb</span><span class="p">.</span><span class="n">sb_blocklog</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">size</span> <span class="o">=</span> <span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_sb</span><span class="p">.</span><span class="n">sb_blocksize</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">extsize_fsb</span> <span class="o">&gt;</span> <span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_sb</span><span class="p">.</span><span class="n">sb_agblocks</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">code</span> <span class="o">=</span> <span class="n">XFS_ERROR</span><span class="p">(</span><span class="n">EINVAL</span><span class="p">);</span>
					<span class="k">goto</span> <span class="n">error_return</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">fa</span><span class="o">-&gt;</span><span class="n">fsx_extsize</span> <span class="o">%</span> <span class="n">size</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">code</span> <span class="o">=</span> <span class="n">XFS_ERROR</span><span class="p">(</span><span class="n">EINVAL</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">error_return</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>


	<span class="k">if</span> <span class="p">(</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="n">FSX_XFLAGS</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Can&#39;t change realtime flag if any extents are allocated.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_d</span><span class="p">.</span><span class="n">di_nextents</span> <span class="o">||</span> <span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_delayed_blks</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">XFS_IS_REALTIME_INODE</span><span class="p">(</span><span class="n">ip</span><span class="p">))</span> <span class="o">!=</span>
		    <span class="p">(</span><span class="n">fa</span><span class="o">-&gt;</span><span class="n">fsx_xflags</span> <span class="o">&amp;</span> <span class="n">XFS_XFLAG_REALTIME</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">code</span> <span class="o">=</span> <span class="n">XFS_ERROR</span><span class="p">(</span><span class="n">EINVAL</span><span class="p">);</span>	<span class="cm">/* EFBIG? */</span>
			<span class="k">goto</span> <span class="n">error_return</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/*</span>
<span class="cm">		 * If realtime flag is set then must have realtime data.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">fa</span><span class="o">-&gt;</span><span class="n">fsx_xflags</span> <span class="o">&amp;</span> <span class="n">XFS_XFLAG_REALTIME</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_sb</span><span class="p">.</span><span class="n">sb_rblocks</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span>
			    <span class="p">(</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_sb</span><span class="p">.</span><span class="n">sb_rextsize</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span>
			    <span class="p">(</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_d</span><span class="p">.</span><span class="n">di_extsize</span> <span class="o">%</span> <span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_sb</span><span class="p">.</span><span class="n">sb_rextsize</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">code</span> <span class="o">=</span> <span class="n">XFS_ERROR</span><span class="p">(</span><span class="n">EINVAL</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">error_return</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="cm">/*</span>
<span class="cm">		 * Can&#39;t modify an immutable/append-only file unless</span>
<span class="cm">		 * we have appropriate permission.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_d</span><span class="p">.</span><span class="n">di_flags</span> <span class="o">&amp;</span>
				<span class="p">(</span><span class="n">XFS_DIFLAG_IMMUTABLE</span><span class="o">|</span><span class="n">XFS_DIFLAG_APPEND</span><span class="p">)</span> <span class="o">||</span>
		     <span class="p">(</span><span class="n">fa</span><span class="o">-&gt;</span><span class="n">fsx_xflags</span> <span class="o">&amp;</span>
				<span class="p">(</span><span class="n">XFS_XFLAG_IMMUTABLE</span> <span class="o">|</span> <span class="n">XFS_XFLAG_APPEND</span><span class="p">)))</span> <span class="o">&amp;&amp;</span>
		    <span class="o">!</span><span class="n">capable</span><span class="p">(</span><span class="n">CAP_LINUX_IMMUTABLE</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">code</span> <span class="o">=</span> <span class="n">XFS_ERROR</span><span class="p">(</span><span class="n">EPERM</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">error_return</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">xfs_trans_ijoin</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">ip</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Change file ownership.  Must be the owner or privileged.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="n">FSX_PROJID</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * CAP_FSETID overrides the following restrictions:</span>
<span class="cm">		 *</span>
<span class="cm">		 * The set-user-ID and set-group-ID bits of a file will be</span>
<span class="cm">		 * cleared upon successful return from chown()</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_d</span><span class="p">.</span><span class="n">di_mode</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">S_ISUID</span><span class="o">|</span><span class="n">S_ISGID</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
		    <span class="o">!</span><span class="n">capable</span><span class="p">(</span><span class="n">CAP_FSETID</span><span class="p">))</span>
			<span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_d</span><span class="p">.</span><span class="n">di_mode</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">S_ISUID</span><span class="o">|</span><span class="n">S_ISGID</span><span class="p">);</span>

		<span class="cm">/*</span>
<span class="cm">		 * Change the ownerships and register quota modifications</span>
<span class="cm">		 * in the transaction.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">xfs_get_projid</span><span class="p">(</span><span class="n">ip</span><span class="p">)</span> <span class="o">!=</span> <span class="n">fa</span><span class="o">-&gt;</span><span class="n">fsx_projid</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">XFS_IS_QUOTA_RUNNING</span><span class="p">(</span><span class="n">mp</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">XFS_IS_PQUOTA_ON</span><span class="p">(</span><span class="n">mp</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">olddquot</span> <span class="o">=</span> <span class="n">xfs_qm_vop_chown</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">ip</span><span class="p">,</span>
							<span class="o">&amp;</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_gdquot</span><span class="p">,</span> <span class="n">gdqp</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">xfs_set_projid</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">fa</span><span class="o">-&gt;</span><span class="n">fsx_projid</span><span class="p">);</span>

			<span class="cm">/*</span>
<span class="cm">			 * We may have to rev the inode as well as</span>
<span class="cm">			 * the superblock version number since projids didn&#39;t</span>
<span class="cm">			 * exist before DINODE_VERSION_2 and SB_VERSION_NLINK.</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_d</span><span class="p">.</span><span class="n">di_version</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
				<span class="n">xfs_bump_ino_vers2</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">ip</span><span class="p">);</span>
		<span class="p">}</span>

	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="n">FSX_EXTSIZE</span><span class="p">)</span>
		<span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_d</span><span class="p">.</span><span class="n">di_extsize</span> <span class="o">=</span> <span class="n">fa</span><span class="o">-&gt;</span><span class="n">fsx_extsize</span> <span class="o">&gt;&gt;</span> <span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_sb</span><span class="p">.</span><span class="n">sb_blocklog</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="n">FSX_XFLAGS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">xfs_set_diflags</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">fa</span><span class="o">-&gt;</span><span class="n">fsx_xflags</span><span class="p">);</span>
		<span class="n">xfs_diflags_to_linux</span><span class="p">(</span><span class="n">ip</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">xfs_trans_ichgtime</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">ip</span><span class="p">,</span> <span class="n">XFS_ICHGTIME_CHG</span><span class="p">);</span>
	<span class="n">xfs_trans_log_inode</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">ip</span><span class="p">,</span> <span class="n">XFS_ILOG_CORE</span><span class="p">);</span>

	<span class="n">XFS_STATS_INC</span><span class="p">(</span><span class="n">xs_ig_attrchg</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * If this is a synchronous mount, make sure that the</span>
<span class="cm">	 * transaction goes to disk before returning to the user.</span>
<span class="cm">	 * This is slightly sub-optimal in that truncates require</span>
<span class="cm">	 * two sync transactions instead of one for wsync filesystems.</span>
<span class="cm">	 * One for the truncate and one for the timestamps since we</span>
<span class="cm">	 * don&#39;t want to change the timestamps unless we&#39;re sure the</span>
<span class="cm">	 * truncate worked.  Truncates are less than 1% of the laddis</span>
<span class="cm">	 * mix so this probably isn&#39;t worth the trouble to optimize.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_flags</span> <span class="o">&amp;</span> <span class="n">XFS_MOUNT_WSYNC</span><span class="p">)</span>
		<span class="n">xfs_trans_set_sync</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>
	<span class="n">code</span> <span class="o">=</span> <span class="n">xfs_trans_commit</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">xfs_iunlock</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">lock_flags</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Release any dquot(s) the inode had kept before chown.</span>
<span class="cm">	 */</span>
	<span class="n">xfs_qm_dqrele</span><span class="p">(</span><span class="n">olddquot</span><span class="p">);</span>
	<span class="n">xfs_qm_dqrele</span><span class="p">(</span><span class="n">udqp</span><span class="p">);</span>
	<span class="n">xfs_qm_dqrele</span><span class="p">(</span><span class="n">gdqp</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">code</span><span class="p">;</span>

 <span class="nl">error_return:</span>
	<span class="n">xfs_qm_dqrele</span><span class="p">(</span><span class="n">udqp</span><span class="p">);</span>
	<span class="n">xfs_qm_dqrele</span><span class="p">(</span><span class="n">gdqp</span><span class="p">);</span>
	<span class="n">xfs_trans_cancel</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lock_flags</span><span class="p">)</span>
		<span class="n">xfs_iunlock</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">lock_flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">code</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">STATIC</span> <span class="kt">int</span>
<span class="nf">xfs_ioc_fssetxattr</span><span class="p">(</span>
	<span class="n">xfs_inode_t</span>		<span class="o">*</span><span class="n">ip</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">file</span>		<span class="o">*</span><span class="n">filp</span><span class="p">,</span>
	<span class="kt">void</span>			<span class="n">__user</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fsxattr</span>		<span class="n">fa</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>		<span class="n">mask</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fa</span><span class="p">,</span> <span class="n">arg</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">fa</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

	<span class="n">mask</span> <span class="o">=</span> <span class="n">FSX_XFLAGS</span> <span class="o">|</span> <span class="n">FSX_EXTSIZE</span> <span class="o">|</span> <span class="n">FSX_PROJID</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">filp</span><span class="o">-&gt;</span><span class="n">f_flags</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">O_NDELAY</span><span class="o">|</span><span class="n">O_NONBLOCK</span><span class="p">))</span>
		<span class="n">mask</span> <span class="o">|=</span> <span class="n">FSX_NONBLOCK</span><span class="p">;</span>

	<span class="k">return</span> <span class="o">-</span><span class="n">xfs_ioctl_setattr</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fa</span><span class="p">,</span> <span class="n">mask</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">STATIC</span> <span class="kt">int</span>
<span class="nf">xfs_ioc_getxflags</span><span class="p">(</span>
	<span class="n">xfs_inode_t</span>		<span class="o">*</span><span class="n">ip</span><span class="p">,</span>
	<span class="kt">void</span>			<span class="n">__user</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>		<span class="n">flags</span><span class="p">;</span>

	<span class="n">flags</span> <span class="o">=</span> <span class="n">xfs_di2lxflags</span><span class="p">(</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_d</span><span class="p">.</span><span class="n">di_flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">flags</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">flags</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">STATIC</span> <span class="kt">int</span>
<span class="nf">xfs_ioc_setxflags</span><span class="p">(</span>
	<span class="n">xfs_inode_t</span>		<span class="o">*</span><span class="n">ip</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">file</span>		<span class="o">*</span><span class="n">filp</span><span class="p">,</span>
	<span class="kt">void</span>			<span class="n">__user</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fsxattr</span>		<span class="n">fa</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>		<span class="n">flags</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>		<span class="n">mask</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">flags</span><span class="p">,</span> <span class="n">arg</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">flags</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">FS_IMMUTABLE_FL</span> <span class="o">|</span> <span class="n">FS_APPEND_FL</span> <span class="o">|</span> \
		      <span class="n">FS_NOATIME_FL</span> <span class="o">|</span> <span class="n">FS_NODUMP_FL</span> <span class="o">|</span> \
		      <span class="n">FS_SYNC_FL</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>

	<span class="n">mask</span> <span class="o">=</span> <span class="n">FSX_XFLAGS</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">filp</span><span class="o">-&gt;</span><span class="n">f_flags</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">O_NDELAY</span><span class="o">|</span><span class="n">O_NONBLOCK</span><span class="p">))</span>
		<span class="n">mask</span> <span class="o">|=</span> <span class="n">FSX_NONBLOCK</span><span class="p">;</span>
	<span class="n">fa</span><span class="p">.</span><span class="n">fsx_xflags</span> <span class="o">=</span> <span class="n">xfs_merge_ioc_xflags</span><span class="p">(</span><span class="n">flags</span><span class="p">,</span> <span class="n">xfs_ip2xflags</span><span class="p">(</span><span class="n">ip</span><span class="p">));</span>

	<span class="k">return</span> <span class="o">-</span><span class="n">xfs_ioctl_setattr</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fa</span><span class="p">,</span> <span class="n">mask</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">STATIC</span> <span class="kt">int</span>
<span class="nf">xfs_getbmap_format</span><span class="p">(</span><span class="kt">void</span> <span class="o">**</span><span class="n">ap</span><span class="p">,</span> <span class="k">struct</span> <span class="n">getbmapx</span> <span class="o">*</span><span class="n">bmv</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">full</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">getbmap</span> <span class="n">__user</span>	<span class="o">*</span><span class="n">base</span> <span class="o">=</span> <span class="o">*</span><span class="n">ap</span><span class="p">;</span>

	<span class="cm">/* copy only getbmap portion (not getbmapx) */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="n">bmv</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">getbmap</span><span class="p">)))</span>
		<span class="k">return</span> <span class="n">XFS_ERROR</span><span class="p">(</span><span class="n">EFAULT</span><span class="p">);</span>

	<span class="o">*</span><span class="n">ap</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">getbmap</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">STATIC</span> <span class="kt">int</span>
<span class="nf">xfs_ioc_getbmap</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">xfs_inode</span>	<span class="o">*</span><span class="n">ip</span><span class="p">,</span>
	<span class="kt">int</span>			<span class="n">ioflags</span><span class="p">,</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>		<span class="n">cmd</span><span class="p">,</span>
	<span class="kt">void</span>			<span class="n">__user</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">getbmapx</span>		<span class="n">bmx</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">error</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bmx</span><span class="p">,</span> <span class="n">arg</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">getbmapx</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">XFS_ERROR</span><span class="p">(</span><span class="n">EFAULT</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bmx</span><span class="p">.</span><span class="n">bmv_count</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">XFS_ERROR</span><span class="p">(</span><span class="n">EINVAL</span><span class="p">);</span>

	<span class="n">bmx</span><span class="p">.</span><span class="n">bmv_iflags</span> <span class="o">=</span> <span class="p">(</span><span class="n">cmd</span> <span class="o">==</span> <span class="n">XFS_IOC_GETBMAPA</span> <span class="o">?</span> <span class="n">BMV_IF_ATTRFORK</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ioflags</span> <span class="o">&amp;</span> <span class="n">IO_INVIS</span><span class="p">)</span>
		<span class="n">bmx</span><span class="p">.</span><span class="n">bmv_iflags</span> <span class="o">|=</span> <span class="n">BMV_IF_NO_DMAPI_READ</span><span class="p">;</span>

	<span class="n">error</span> <span class="o">=</span> <span class="n">xfs_getbmap</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bmx</span><span class="p">,</span> <span class="n">xfs_getbmap_format</span><span class="p">,</span>
			    <span class="p">(</span><span class="k">struct</span> <span class="n">getbmap</span> <span class="o">*</span><span class="p">)</span><span class="n">arg</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">error</span><span class="p">;</span>

	<span class="cm">/* copy back header - only size of getbmap */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bmx</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">getbmap</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">XFS_ERROR</span><span class="p">(</span><span class="n">EFAULT</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">STATIC</span> <span class="kt">int</span>
<span class="nf">xfs_getbmapx_format</span><span class="p">(</span><span class="kt">void</span> <span class="o">**</span><span class="n">ap</span><span class="p">,</span> <span class="k">struct</span> <span class="n">getbmapx</span> <span class="o">*</span><span class="n">bmv</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">full</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">getbmapx</span> <span class="n">__user</span>	<span class="o">*</span><span class="n">base</span> <span class="o">=</span> <span class="o">*</span><span class="n">ap</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="n">bmv</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">getbmapx</span><span class="p">)))</span>
		<span class="k">return</span> <span class="n">XFS_ERROR</span><span class="p">(</span><span class="n">EFAULT</span><span class="p">);</span>

	<span class="o">*</span><span class="n">ap</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">getbmapx</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">STATIC</span> <span class="kt">int</span>
<span class="nf">xfs_ioc_getbmapx</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">xfs_inode</span>	<span class="o">*</span><span class="n">ip</span><span class="p">,</span>
	<span class="kt">void</span>			<span class="n">__user</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">getbmapx</span>		<span class="n">bmx</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">error</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bmx</span><span class="p">,</span> <span class="n">arg</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">bmx</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">XFS_ERROR</span><span class="p">(</span><span class="n">EFAULT</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bmx</span><span class="p">.</span><span class="n">bmv_count</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">XFS_ERROR</span><span class="p">(</span><span class="n">EINVAL</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bmx</span><span class="p">.</span><span class="n">bmv_iflags</span> <span class="o">&amp;</span> <span class="p">(</span><span class="o">~</span><span class="n">BMV_IF_VALID</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">XFS_ERROR</span><span class="p">(</span><span class="n">EINVAL</span><span class="p">);</span>

	<span class="n">error</span> <span class="o">=</span> <span class="n">xfs_getbmap</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bmx</span><span class="p">,</span> <span class="n">xfs_getbmapx_format</span><span class="p">,</span>
			    <span class="p">(</span><span class="k">struct</span> <span class="n">getbmapx</span> <span class="o">*</span><span class="p">)</span><span class="n">arg</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">error</span><span class="p">;</span>

	<span class="cm">/* copy back header */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bmx</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">getbmapx</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">XFS_ERROR</span><span class="p">(</span><span class="n">EFAULT</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Note: some of the ioctl&#39;s return positive numbers as a</span>
<span class="cm"> * byte count indicating success, such as readlink_by_handle.</span>
<span class="cm"> * So we don&#39;t &quot;sign flip&quot; like most other routines.  This means</span>
<span class="cm"> * true errors need to be returned as a negative value.</span>
<span class="cm"> */</span>
<span class="kt">long</span>
<span class="nf">xfs_file_ioctl</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">file</span>		<span class="o">*</span><span class="n">filp</span><span class="p">,</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>		<span class="n">cmd</span><span class="p">,</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>		<span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">inode</span>		<span class="o">*</span><span class="n">inode</span> <span class="o">=</span> <span class="n">filp</span><span class="o">-&gt;</span><span class="n">f_path</span><span class="p">.</span><span class="n">dentry</span><span class="o">-&gt;</span><span class="n">d_inode</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">xfs_inode</span>	<span class="o">*</span><span class="n">ip</span> <span class="o">=</span> <span class="n">XFS_I</span><span class="p">(</span><span class="n">inode</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">xfs_mount</span>	<span class="o">*</span><span class="n">mp</span> <span class="o">=</span> <span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_mount</span><span class="p">;</span>
	<span class="kt">void</span>			<span class="n">__user</span> <span class="o">*</span><span class="n">arg</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">p</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">ioflags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">error</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">filp</span><span class="o">-&gt;</span><span class="n">f_mode</span> <span class="o">&amp;</span> <span class="n">FMODE_NOCMTIME</span><span class="p">)</span>
		<span class="n">ioflags</span> <span class="o">|=</span> <span class="n">IO_INVIS</span><span class="p">;</span>

	<span class="n">trace_xfs_file_ioctl</span><span class="p">(</span><span class="n">ip</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">FITRIM</span>:
		<span class="k">return</span> <span class="n">xfs_ioc_trim</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="n">arg</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">XFS_IOC_ALLOCSP</span>:
	<span class="k">case</span> <span class="n">XFS_IOC_FREESP</span>:
	<span class="k">case</span> <span class="n">XFS_IOC_RESVSP</span>:
	<span class="k">case</span> <span class="n">XFS_IOC_UNRESVSP</span>:
	<span class="k">case</span> <span class="n">XFS_IOC_ALLOCSP64</span>:
	<span class="k">case</span> <span class="n">XFS_IOC_FREESP64</span>:
	<span class="k">case</span> <span class="n">XFS_IOC_RESVSP64</span>:
	<span class="k">case</span> <span class="n">XFS_IOC_UNRESVSP64</span>:
	<span class="k">case</span> <span class="n">XFS_IOC_ZERO_RANGE</span>: <span class="p">{</span>
		<span class="n">xfs_flock64_t</span>		<span class="n">bf</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bf</span><span class="p">,</span> <span class="n">arg</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">bf</span><span class="p">)))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">XFS_ERROR</span><span class="p">(</span><span class="n">EFAULT</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">xfs_ioc_space</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">inode</span><span class="p">,</span> <span class="n">filp</span><span class="p">,</span> <span class="n">ioflags</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bf</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">case</span> <span class="n">XFS_IOC_DIOINFO</span>: <span class="p">{</span>
		<span class="k">struct</span> <span class="n">dioattr</span>	<span class="n">da</span><span class="p">;</span>
		<span class="n">xfs_buftarg_t</span>	<span class="o">*</span><span class="n">target</span> <span class="o">=</span>
			<span class="n">XFS_IS_REALTIME_INODE</span><span class="p">(</span><span class="n">ip</span><span class="p">)</span> <span class="o">?</span>
			<span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_rtdev_targp</span> <span class="o">:</span> <span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_ddev_targp</span><span class="p">;</span>

		<span class="n">da</span><span class="p">.</span><span class="n">d_mem</span> <span class="o">=</span> <span class="n">da</span><span class="p">.</span><span class="n">d_miniosz</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">target</span><span class="o">-&gt;</span><span class="n">bt_sshift</span><span class="p">;</span>
		<span class="n">da</span><span class="p">.</span><span class="n">d_maxiosz</span> <span class="o">=</span> <span class="n">INT_MAX</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">da</span><span class="p">.</span><span class="n">d_miniosz</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">da</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">da</span><span class="p">)))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">XFS_ERROR</span><span class="p">(</span><span class="n">EFAULT</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">case</span> <span class="n">XFS_IOC_FSBULKSTAT_SINGLE</span>:
	<span class="k">case</span> <span class="n">XFS_IOC_FSBULKSTAT</span>:
	<span class="k">case</span> <span class="n">XFS_IOC_FSINUMBERS</span>:
		<span class="k">return</span> <span class="n">xfs_ioc_bulkstat</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">arg</span><span class="p">);</span>

	<span class="k">case</span> <span class="n">XFS_IOC_FSGEOMETRY_V1</span>:
		<span class="k">return</span> <span class="n">xfs_ioc_fsgeometry_v1</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="n">arg</span><span class="p">);</span>

	<span class="k">case</span> <span class="n">XFS_IOC_FSGEOMETRY</span>:
		<span class="k">return</span> <span class="n">xfs_ioc_fsgeometry</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="n">arg</span><span class="p">);</span>

	<span class="k">case</span> <span class="n">XFS_IOC_GETVERSION</span>:
		<span class="k">return</span> <span class="n">put_user</span><span class="p">(</span><span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_generation</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">arg</span><span class="p">);</span>

	<span class="k">case</span> <span class="n">XFS_IOC_FSGETXATTR</span>:
		<span class="k">return</span> <span class="n">xfs_ioc_fsgetxattr</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">arg</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">XFS_IOC_FSGETXATTRA</span>:
		<span class="k">return</span> <span class="n">xfs_ioc_fsgetxattr</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">arg</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">XFS_IOC_FSSETXATTR</span>:
		<span class="k">return</span> <span class="n">xfs_ioc_fssetxattr</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">filp</span><span class="p">,</span> <span class="n">arg</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">XFS_IOC_GETXFLAGS</span>:
		<span class="k">return</span> <span class="n">xfs_ioc_getxflags</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">arg</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">XFS_IOC_SETXFLAGS</span>:
		<span class="k">return</span> <span class="n">xfs_ioc_setxflags</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">filp</span><span class="p">,</span> <span class="n">arg</span><span class="p">);</span>

	<span class="k">case</span> <span class="n">XFS_IOC_FSSETDM</span>: <span class="p">{</span>
		<span class="k">struct</span> <span class="n">fsdmidata</span>	<span class="n">dmi</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dmi</span><span class="p">,</span> <span class="n">arg</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">dmi</span><span class="p">)))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">XFS_ERROR</span><span class="p">(</span><span class="n">EFAULT</span><span class="p">);</span>

		<span class="n">error</span> <span class="o">=</span> <span class="n">xfs_set_dmattrs</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">dmi</span><span class="p">.</span><span class="n">fsd_dmevmask</span><span class="p">,</span>
				<span class="n">dmi</span><span class="p">.</span><span class="n">fsd_dmstate</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">error</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">case</span> <span class="n">XFS_IOC_GETBMAP</span>:
	<span class="k">case</span> <span class="n">XFS_IOC_GETBMAPA</span>:
		<span class="k">return</span> <span class="n">xfs_ioc_getbmap</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">ioflags</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">arg</span><span class="p">);</span>

	<span class="k">case</span> <span class="n">XFS_IOC_GETBMAPX</span>:
		<span class="k">return</span> <span class="n">xfs_ioc_getbmapx</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">arg</span><span class="p">);</span>

	<span class="k">case</span> <span class="n">XFS_IOC_FD_TO_HANDLE</span>:
	<span class="k">case</span> <span class="n">XFS_IOC_PATH_TO_HANDLE</span>:
	<span class="k">case</span> <span class="n">XFS_IOC_PATH_TO_FSHANDLE</span>: <span class="p">{</span>
		<span class="n">xfs_fsop_handlereq_t</span>	<span class="n">hreq</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hreq</span><span class="p">,</span> <span class="n">arg</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">hreq</span><span class="p">)))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">XFS_ERROR</span><span class="p">(</span><span class="n">EFAULT</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">xfs_find_handle</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hreq</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">case</span> <span class="n">XFS_IOC_OPEN_BY_HANDLE</span>: <span class="p">{</span>
		<span class="n">xfs_fsop_handlereq_t</span>	<span class="n">hreq</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hreq</span><span class="p">,</span> <span class="n">arg</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">xfs_fsop_handlereq_t</span><span class="p">)))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">XFS_ERROR</span><span class="p">(</span><span class="n">EFAULT</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">xfs_open_by_handle</span><span class="p">(</span><span class="n">filp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hreq</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">case</span> <span class="n">XFS_IOC_FSSETDM_BY_HANDLE</span>:
		<span class="k">return</span> <span class="n">xfs_fssetdm_by_handle</span><span class="p">(</span><span class="n">filp</span><span class="p">,</span> <span class="n">arg</span><span class="p">);</span>

	<span class="k">case</span> <span class="n">XFS_IOC_READLINK_BY_HANDLE</span>: <span class="p">{</span>
		<span class="n">xfs_fsop_handlereq_t</span>	<span class="n">hreq</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hreq</span><span class="p">,</span> <span class="n">arg</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">xfs_fsop_handlereq_t</span><span class="p">)))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">XFS_ERROR</span><span class="p">(</span><span class="n">EFAULT</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">xfs_readlink_by_handle</span><span class="p">(</span><span class="n">filp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hreq</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">case</span> <span class="n">XFS_IOC_ATTRLIST_BY_HANDLE</span>:
		<span class="k">return</span> <span class="n">xfs_attrlist_by_handle</span><span class="p">(</span><span class="n">filp</span><span class="p">,</span> <span class="n">arg</span><span class="p">);</span>

	<span class="k">case</span> <span class="n">XFS_IOC_ATTRMULTI_BY_HANDLE</span>:
		<span class="k">return</span> <span class="n">xfs_attrmulti_by_handle</span><span class="p">(</span><span class="n">filp</span><span class="p">,</span> <span class="n">arg</span><span class="p">);</span>

	<span class="k">case</span> <span class="n">XFS_IOC_SWAPEXT</span>: <span class="p">{</span>
		<span class="k">struct</span> <span class="n">xfs_swapext</span>	<span class="n">sxp</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sxp</span><span class="p">,</span> <span class="n">arg</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">xfs_swapext_t</span><span class="p">)))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">XFS_ERROR</span><span class="p">(</span><span class="n">EFAULT</span><span class="p">);</span>
		<span class="n">error</span> <span class="o">=</span> <span class="n">xfs_swapext</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sxp</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">error</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">case</span> <span class="n">XFS_IOC_FSCOUNTS</span>: <span class="p">{</span>
		<span class="n">xfs_fsop_counts_t</span> <span class="n">out</span><span class="p">;</span>

		<span class="n">error</span> <span class="o">=</span> <span class="n">xfs_fs_counts</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">out</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">error</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">out</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">out</span><span class="p">)))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">XFS_ERROR</span><span class="p">(</span><span class="n">EFAULT</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">case</span> <span class="n">XFS_IOC_SET_RESBLKS</span>: <span class="p">{</span>
		<span class="n">xfs_fsop_resblks_t</span> <span class="n">inout</span><span class="p">;</span>
		<span class="n">__uint64_t</span>	   <span class="n">in</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">capable</span><span class="p">(</span><span class="n">CAP_SYS_ADMIN</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_flags</span> <span class="o">&amp;</span> <span class="n">XFS_MOUNT_RDONLY</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">XFS_ERROR</span><span class="p">(</span><span class="n">EROFS</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">inout</span><span class="p">,</span> <span class="n">arg</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">inout</span><span class="p">)))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">XFS_ERROR</span><span class="p">(</span><span class="n">EFAULT</span><span class="p">);</span>

		<span class="cm">/* input parameter is passed in resblks field of structure */</span>
		<span class="n">in</span> <span class="o">=</span> <span class="n">inout</span><span class="p">.</span><span class="n">resblks</span><span class="p">;</span>
		<span class="n">error</span> <span class="o">=</span> <span class="n">xfs_reserve_blocks</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">in</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">inout</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">error</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">inout</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">inout</span><span class="p">)))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">XFS_ERROR</span><span class="p">(</span><span class="n">EFAULT</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">case</span> <span class="n">XFS_IOC_GET_RESBLKS</span>: <span class="p">{</span>
		<span class="n">xfs_fsop_resblks_t</span> <span class="n">out</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">capable</span><span class="p">(</span><span class="n">CAP_SYS_ADMIN</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>

		<span class="n">error</span> <span class="o">=</span> <span class="n">xfs_reserve_blocks</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">out</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">error</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">out</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">out</span><span class="p">)))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">XFS_ERROR</span><span class="p">(</span><span class="n">EFAULT</span><span class="p">);</span>

		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">case</span> <span class="n">XFS_IOC_FSGROWFSDATA</span>: <span class="p">{</span>
		<span class="n">xfs_growfs_data_t</span> <span class="n">in</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">in</span><span class="p">,</span> <span class="n">arg</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">in</span><span class="p">)))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">XFS_ERROR</span><span class="p">(</span><span class="n">EFAULT</span><span class="p">);</span>

		<span class="n">error</span> <span class="o">=</span> <span class="n">xfs_growfs_data</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">in</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">error</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">case</span> <span class="n">XFS_IOC_FSGROWFSLOG</span>: <span class="p">{</span>
		<span class="n">xfs_growfs_log_t</span> <span class="n">in</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">in</span><span class="p">,</span> <span class="n">arg</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">in</span><span class="p">)))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">XFS_ERROR</span><span class="p">(</span><span class="n">EFAULT</span><span class="p">);</span>

		<span class="n">error</span> <span class="o">=</span> <span class="n">xfs_growfs_log</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">in</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">error</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">case</span> <span class="n">XFS_IOC_FSGROWFSRT</span>: <span class="p">{</span>
		<span class="n">xfs_growfs_rt_t</span> <span class="n">in</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">in</span><span class="p">,</span> <span class="n">arg</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">in</span><span class="p">)))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">XFS_ERROR</span><span class="p">(</span><span class="n">EFAULT</span><span class="p">);</span>

		<span class="n">error</span> <span class="o">=</span> <span class="n">xfs_growfs_rt</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">in</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">error</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">case</span> <span class="n">XFS_IOC_GOINGDOWN</span>: <span class="p">{</span>
		<span class="n">__uint32_t</span> <span class="n">in</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">capable</span><span class="p">(</span><span class="n">CAP_SYS_ADMIN</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">get_user</span><span class="p">(</span><span class="n">in</span><span class="p">,</span> <span class="p">(</span><span class="n">__uint32_t</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">arg</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">XFS_ERROR</span><span class="p">(</span><span class="n">EFAULT</span><span class="p">);</span>

		<span class="n">error</span> <span class="o">=</span> <span class="n">xfs_fs_goingdown</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="n">in</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">error</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">case</span> <span class="n">XFS_IOC_ERROR_INJECTION</span>: <span class="p">{</span>
		<span class="n">xfs_error_injection_t</span> <span class="n">in</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">capable</span><span class="p">(</span><span class="n">CAP_SYS_ADMIN</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">in</span><span class="p">,</span> <span class="n">arg</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">in</span><span class="p">)))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">XFS_ERROR</span><span class="p">(</span><span class="n">EFAULT</span><span class="p">);</span>

		<span class="n">error</span> <span class="o">=</span> <span class="n">xfs_errortag_add</span><span class="p">(</span><span class="n">in</span><span class="p">.</span><span class="n">errtag</span><span class="p">,</span> <span class="n">mp</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">error</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">case</span> <span class="n">XFS_IOC_ERROR_CLEARALL</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">capable</span><span class="p">(</span><span class="n">CAP_SYS_ADMIN</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>

		<span class="n">error</span> <span class="o">=</span> <span class="n">xfs_errortag_clearall</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">error</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOTTY</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
