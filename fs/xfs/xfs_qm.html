<!DOCTYPE html>
<html><head><title>joekychen/linux » fs › xfs › xfs_qm.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>xfs_qm.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Copyright (c) 2000-2005 Silicon Graphics, Inc.</span>
<span class="cm"> * All Rights Reserved.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or</span>
<span class="cm"> * modify it under the terms of the GNU General Public License as</span>
<span class="cm"> * published by the Free Software Foundation.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is distributed in the hope that it would be useful,</span>
<span class="cm"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm"> * GNU General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> * You should have received a copy of the GNU General Public License</span>
<span class="cm"> * along with this program; if not, write the Free Software Foundation,</span>
<span class="cm"> * Inc.,  51 Franklin St, Fifth Floor, Boston, MA  02110-1301  USA</span>
<span class="cm"> */</span>
<span class="cp">#include &quot;xfs.h&quot;</span>
<span class="cp">#include &quot;xfs_fs.h&quot;</span>
<span class="cp">#include &quot;xfs_bit.h&quot;</span>
<span class="cp">#include &quot;xfs_log.h&quot;</span>
<span class="cp">#include &quot;xfs_trans.h&quot;</span>
<span class="cp">#include &quot;xfs_sb.h&quot;</span>
<span class="cp">#include &quot;xfs_ag.h&quot;</span>
<span class="cp">#include &quot;xfs_alloc.h&quot;</span>
<span class="cp">#include &quot;xfs_quota.h&quot;</span>
<span class="cp">#include &quot;xfs_mount.h&quot;</span>
<span class="cp">#include &quot;xfs_bmap_btree.h&quot;</span>
<span class="cp">#include &quot;xfs_ialloc_btree.h&quot;</span>
<span class="cp">#include &quot;xfs_dinode.h&quot;</span>
<span class="cp">#include &quot;xfs_inode.h&quot;</span>
<span class="cp">#include &quot;xfs_ialloc.h&quot;</span>
<span class="cp">#include &quot;xfs_itable.h&quot;</span>
<span class="cp">#include &quot;xfs_rtalloc.h&quot;</span>
<span class="cp">#include &quot;xfs_error.h&quot;</span>
<span class="cp">#include &quot;xfs_bmap.h&quot;</span>
<span class="cp">#include &quot;xfs_attr.h&quot;</span>
<span class="cp">#include &quot;xfs_buf_item.h&quot;</span>
<span class="cp">#include &quot;xfs_trans_space.h&quot;</span>
<span class="cp">#include &quot;xfs_utils.h&quot;</span>
<span class="cp">#include &quot;xfs_qm.h&quot;</span>
<span class="cp">#include &quot;xfs_trace.h&quot;</span>

<span class="cm">/*</span>
<span class="cm"> * The global quota manager. There is only one of these for the entire</span>
<span class="cm"> * system, _not_ one per file system. XQM keeps track of the overall</span>
<span class="cm"> * quota functionality, including maintaining the freelist and hash</span>
<span class="cm"> * tables of dquots.</span>
<span class="cm"> */</span>
<span class="n">STATIC</span> <span class="kt">int</span>	<span class="n">xfs_qm_init_quotainos</span><span class="p">(</span><span class="n">xfs_mount_t</span> <span class="o">*</span><span class="p">);</span>
<span class="n">STATIC</span> <span class="kt">int</span>	<span class="n">xfs_qm_init_quotainfo</span><span class="p">(</span><span class="n">xfs_mount_t</span> <span class="o">*</span><span class="p">);</span>
<span class="n">STATIC</span> <span class="kt">int</span>	<span class="n">xfs_qm_shake</span><span class="p">(</span><span class="k">struct</span> <span class="n">shrinker</span> <span class="o">*</span><span class="p">,</span> <span class="k">struct</span> <span class="n">shrink_control</span> <span class="o">*</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * We use the batch lookup interface to iterate over the dquots as it</span>
<span class="cm"> * currently is the only interface into the radix tree code that allows</span>
<span class="cm"> * fuzzy lookups instead of exact matches.  Holding the lock over multiple</span>
<span class="cm"> * operations is fine as all callers are used either during mount/umount</span>
<span class="cm"> * or quotaoff.</span>
<span class="cm"> */</span>
<span class="cp">#define XFS_DQ_LOOKUP_BATCH	32</span>

<span class="n">STATIC</span> <span class="kt">int</span>
<span class="nf">xfs_qm_dquot_walk</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">xfs_mount</span>	<span class="o">*</span><span class="n">mp</span><span class="p">,</span>
	<span class="kt">int</span>			<span class="n">type</span><span class="p">,</span>
	<span class="kt">int</span>			<span class="p">(</span><span class="o">*</span><span class="n">execute</span><span class="p">)(</span><span class="k">struct</span> <span class="n">xfs_dquot</span> <span class="o">*</span><span class="n">dqp</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">),</span>
	<span class="kt">void</span>			<span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">xfs_quotainfo</span>	<span class="o">*</span><span class="n">qi</span> <span class="o">=</span> <span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_quotainfo</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">radix_tree_root</span>	<span class="o">*</span><span class="n">tree</span> <span class="o">=</span> <span class="n">XFS_DQUOT_TREE</span><span class="p">(</span><span class="n">qi</span><span class="p">,</span> <span class="n">type</span><span class="p">);</span>
	<span class="kt">uint32_t</span>		<span class="n">next_index</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">last_error</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">skipped</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">nr_found</span><span class="p">;</span>

<span class="nl">restart:</span>
	<span class="n">skipped</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">next_index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">nr_found</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">xfs_dquot</span> <span class="o">*</span><span class="n">batch</span><span class="p">[</span><span class="n">XFS_DQ_LOOKUP_BATCH</span><span class="p">];</span>
		<span class="kt">int</span>		<span class="n">error</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="kt">int</span>		<span class="n">i</span><span class="p">;</span>

		<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qi</span><span class="o">-&gt;</span><span class="n">qi_tree_lock</span><span class="p">);</span>
		<span class="n">nr_found</span> <span class="o">=</span> <span class="n">radix_tree_gang_lookup</span><span class="p">(</span><span class="n">tree</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">**</span><span class="p">)</span><span class="n">batch</span><span class="p">,</span>
					<span class="n">next_index</span><span class="p">,</span> <span class="n">XFS_DQ_LOOKUP_BATCH</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">nr_found</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qi</span><span class="o">-&gt;</span><span class="n">qi_tree_lock</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">nr_found</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">xfs_dquot</span> <span class="o">*</span><span class="n">dqp</span> <span class="o">=</span> <span class="n">batch</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

			<span class="n">next_index</span> <span class="o">=</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">dqp</span><span class="o">-&gt;</span><span class="n">q_core</span><span class="p">.</span><span class="n">d_id</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>

			<span class="n">error</span> <span class="o">=</span> <span class="n">execute</span><span class="p">(</span><span class="n">batch</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">data</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">error</span> <span class="o">==</span> <span class="n">EAGAIN</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">skipped</span><span class="o">++</span><span class="p">;</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">error</span> <span class="o">&amp;&amp;</span> <span class="n">last_error</span> <span class="o">!=</span> <span class="n">EFSCORRUPTED</span><span class="p">)</span>
				<span class="n">last_error</span> <span class="o">=</span> <span class="n">error</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qi</span><span class="o">-&gt;</span><span class="n">qi_tree_lock</span><span class="p">);</span>

		<span class="cm">/* bail out if the filesystem is corrupted.  */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">last_error</span> <span class="o">==</span> <span class="n">EFSCORRUPTED</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">skipped</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">skipped</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">delay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">restart</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">last_error</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * Purge a dquot from all tracking data structures and free it.</span>
<span class="cm"> */</span>
<span class="n">STATIC</span> <span class="kt">int</span>
<span class="nf">xfs_qm_dqpurge</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">xfs_dquot</span>	<span class="o">*</span><span class="n">dqp</span><span class="p">,</span>
	<span class="kt">void</span>			<span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">xfs_mount</span>	<span class="o">*</span><span class="n">mp</span> <span class="o">=</span> <span class="n">dqp</span><span class="o">-&gt;</span><span class="n">q_mount</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">xfs_quotainfo</span>	<span class="o">*</span><span class="n">qi</span> <span class="o">=</span> <span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_quotainfo</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">xfs_dquot</span>	<span class="o">*</span><span class="n">gdqp</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">xfs_dqlock</span><span class="p">(</span><span class="n">dqp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">dqp</span><span class="o">-&gt;</span><span class="n">dq_flags</span> <span class="o">&amp;</span> <span class="n">XFS_DQ_FREEING</span><span class="p">)</span> <span class="o">||</span> <span class="n">dqp</span><span class="o">-&gt;</span><span class="n">q_nrefs</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">xfs_dqunlock</span><span class="p">(</span><span class="n">dqp</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">EAGAIN</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * If this quota has a group hint attached, prepare for releasing it</span>
<span class="cm">	 * now.</span>
<span class="cm">	 */</span>
	<span class="n">gdqp</span> <span class="o">=</span> <span class="n">dqp</span><span class="o">-&gt;</span><span class="n">q_gdquot</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">gdqp</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">xfs_dqlock</span><span class="p">(</span><span class="n">gdqp</span><span class="p">);</span>
		<span class="n">dqp</span><span class="o">-&gt;</span><span class="n">q_gdquot</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dqp</span><span class="o">-&gt;</span><span class="n">dq_flags</span> <span class="o">|=</span> <span class="n">XFS_DQ_FREEING</span><span class="p">;</span>

	<span class="n">xfs_dqflock</span><span class="p">(</span><span class="n">dqp</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * If we are turning this type of quotas off, we don&#39;t care</span>
<span class="cm">	 * about the dirty metadata sitting in this dquot. OTOH, if</span>
<span class="cm">	 * we&#39;re unmounting, we do care, so we flush it and wait.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">XFS_DQ_IS_DIRTY</span><span class="p">(</span><span class="n">dqp</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">xfs_buf</span>	<span class="o">*</span><span class="n">bp</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="kt">int</span>		<span class="n">error</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * We don&#39;t care about getting disk errors here. We need</span>
<span class="cm">		 * to purge this dquot anyway, so we go ahead regardless.</span>
<span class="cm">		 */</span>
		<span class="n">error</span> <span class="o">=</span> <span class="n">xfs_qm_dqflush</span><span class="p">(</span><span class="n">dqp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bp</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">xfs_warn</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="s">&quot;%s: dquot %p flush failed&quot;</span><span class="p">,</span>
				<span class="n">__func__</span><span class="p">,</span> <span class="n">dqp</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">error</span> <span class="o">=</span> <span class="n">xfs_bwrite</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>
			<span class="n">xfs_buf_relse</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">xfs_dqflock</span><span class="p">(</span><span class="n">dqp</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">ASSERT</span><span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dqp</span><span class="o">-&gt;</span><span class="n">q_pincount</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">ASSERT</span><span class="p">(</span><span class="n">XFS_FORCED_SHUTDOWN</span><span class="p">(</span><span class="n">mp</span><span class="p">)</span> <span class="o">||</span>
	       <span class="o">!</span><span class="p">(</span><span class="n">dqp</span><span class="o">-&gt;</span><span class="n">q_logitem</span><span class="p">.</span><span class="n">qli_item</span><span class="p">.</span><span class="n">li_flags</span> <span class="o">&amp;</span> <span class="n">XFS_LI_IN_AIL</span><span class="p">));</span>

	<span class="n">xfs_dqfunlock</span><span class="p">(</span><span class="n">dqp</span><span class="p">);</span>
	<span class="n">xfs_dqunlock</span><span class="p">(</span><span class="n">dqp</span><span class="p">);</span>

	<span class="n">radix_tree_delete</span><span class="p">(</span><span class="n">XFS_DQUOT_TREE</span><span class="p">(</span><span class="n">qi</span><span class="p">,</span> <span class="n">dqp</span><span class="o">-&gt;</span><span class="n">q_core</span><span class="p">.</span><span class="n">d_flags</span><span class="p">),</span>
			  <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">dqp</span><span class="o">-&gt;</span><span class="n">q_core</span><span class="p">.</span><span class="n">d_id</span><span class="p">));</span>
	<span class="n">qi</span><span class="o">-&gt;</span><span class="n">qi_dquots</span><span class="o">--</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * We move dquots to the freelist as soon as their reference count</span>
<span class="cm">	 * hits zero, so it really should be on the freelist here.</span>
<span class="cm">	 */</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qi</span><span class="o">-&gt;</span><span class="n">qi_lru_lock</span><span class="p">);</span>
	<span class="n">ASSERT</span><span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dqp</span><span class="o">-&gt;</span><span class="n">q_lru</span><span class="p">));</span>
	<span class="n">list_del_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dqp</span><span class="o">-&gt;</span><span class="n">q_lru</span><span class="p">);</span>
	<span class="n">qi</span><span class="o">-&gt;</span><span class="n">qi_lru_count</span><span class="o">--</span><span class="p">;</span>
	<span class="n">XFS_STATS_DEC</span><span class="p">(</span><span class="n">xs_qm_dquot_unused</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qi</span><span class="o">-&gt;</span><span class="n">qi_lru_lock</span><span class="p">);</span>

	<span class="n">xfs_qm_dqdestroy</span><span class="p">(</span><span class="n">dqp</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">gdqp</span><span class="p">)</span>
		<span class="n">xfs_qm_dqput</span><span class="p">(</span><span class="n">gdqp</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Purge the dquot cache.</span>
<span class="cm"> */</span>
<span class="kt">void</span>
<span class="nf">xfs_qm_dqpurge_all</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">xfs_mount</span>	<span class="o">*</span><span class="n">mp</span><span class="p">,</span>
	<span class="n">uint</span>			<span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">XFS_QMOPT_UQUOTA</span><span class="p">)</span>
		<span class="n">xfs_qm_dquot_walk</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="n">XFS_DQ_USER</span><span class="p">,</span> <span class="n">xfs_qm_dqpurge</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">XFS_QMOPT_GQUOTA</span><span class="p">)</span>
		<span class="n">xfs_qm_dquot_walk</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="n">XFS_DQ_GROUP</span><span class="p">,</span> <span class="n">xfs_qm_dqpurge</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">XFS_QMOPT_PQUOTA</span><span class="p">)</span>
		<span class="n">xfs_qm_dquot_walk</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="n">XFS_DQ_PROJ</span><span class="p">,</span> <span class="n">xfs_qm_dqpurge</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Just destroy the quotainfo structure.</span>
<span class="cm"> */</span>
<span class="kt">void</span>
<span class="nf">xfs_qm_unmount</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">xfs_mount</span>	<span class="o">*</span><span class="n">mp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_quotainfo</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">xfs_qm_dqpurge_all</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="n">XFS_QMOPT_QUOTALL</span><span class="p">);</span>
		<span class="n">xfs_qm_destroy_quotainfo</span><span class="p">(</span><span class="n">mp</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * This is called from xfs_mountfs to start quotas and initialize all</span>
<span class="cm"> * necessary data structures like quotainfo.  This is also responsible for</span>
<span class="cm"> * running a quotacheck as necessary.  We are guaranteed that the superblock</span>
<span class="cm"> * is consistently read in at this point.</span>
<span class="cm"> *</span>
<span class="cm"> * If we fail here, the mount will continue with quota turned off. We don&#39;t</span>
<span class="cm"> * need to inidicate success or failure at all.</span>
<span class="cm"> */</span>
<span class="kt">void</span>
<span class="nf">xfs_qm_mount_quotas</span><span class="p">(</span>
	<span class="n">xfs_mount_t</span>	<span class="o">*</span><span class="n">mp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span>		<span class="n">error</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">uint</span>		<span class="n">sbf</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * If quotas on realtime volumes is not supported, we disable</span>
<span class="cm">	 * quotas immediately.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_sb</span><span class="p">.</span><span class="n">sb_rextents</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">xfs_notice</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="s">&quot;Cannot turn on quotas for realtime filesystem&quot;</span><span class="p">);</span>
		<span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_qflags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">write_changes</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ASSERT</span><span class="p">(</span><span class="n">XFS_IS_QUOTA_RUNNING</span><span class="p">(</span><span class="n">mp</span><span class="p">));</span>

	<span class="cm">/*</span>
<span class="cm">	 * Allocate the quotainfo structure inside the mount struct, and</span>
<span class="cm">	 * create quotainode(s), and change/rev superblock if necessary.</span>
<span class="cm">	 */</span>
	<span class="n">error</span> <span class="o">=</span> <span class="n">xfs_qm_init_quotainfo</span><span class="p">(</span><span class="n">mp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * We must turn off quotas.</span>
<span class="cm">		 */</span>
		<span class="n">ASSERT</span><span class="p">(</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_quotainfo</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_qflags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">write_changes</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/*</span>
<span class="cm">	 * If any of the quotas are not consistent, do a quotacheck.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">XFS_QM_NEED_QUOTACHECK</span><span class="p">(</span><span class="n">mp</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">error</span> <span class="o">=</span> <span class="n">xfs_qm_quotacheck</span><span class="p">(</span><span class="n">mp</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Quotacheck failed and disabled quotas. */</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="cm">/* </span>
<span class="cm">	 * If one type of quotas is off, then it will lose its</span>
<span class="cm">	 * quotachecked status, since we won&#39;t be doing accounting for</span>
<span class="cm">	 * that type anymore.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">XFS_IS_UQUOTA_ON</span><span class="p">(</span><span class="n">mp</span><span class="p">))</span>
		<span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_qflags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">XFS_UQUOTA_CHKD</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">XFS_IS_GQUOTA_ON</span><span class="p">(</span><span class="n">mp</span><span class="p">)</span> <span class="o">||</span> <span class="n">XFS_IS_PQUOTA_ON</span><span class="p">(</span><span class="n">mp</span><span class="p">)))</span>
		<span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_qflags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">XFS_OQUOTA_CHKD</span><span class="p">;</span>

 <span class="nl">write_changes:</span>
	<span class="cm">/*</span>
<span class="cm">	 * We actually don&#39;t have to acquire the m_sb_lock at all.</span>
<span class="cm">	 * This can only be called from mount, and that&#39;s single threaded. XXX</span>
<span class="cm">	 */</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_sb_lock</span><span class="p">);</span>
	<span class="n">sbf</span> <span class="o">=</span> <span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_sb</span><span class="p">.</span><span class="n">sb_qflags</span><span class="p">;</span>
	<span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_sb</span><span class="p">.</span><span class="n">sb_qflags</span> <span class="o">=</span> <span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_qflags</span> <span class="o">&amp;</span> <span class="n">XFS_MOUNT_QUOTA_ALL</span><span class="p">;</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_sb_lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sbf</span> <span class="o">!=</span> <span class="p">(</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_qflags</span> <span class="o">&amp;</span> <span class="n">XFS_MOUNT_QUOTA_ALL</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">xfs_qm_write_sb_changes</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="n">XFS_SB_QFLAGS</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * We could only have been turning quotas off.</span>
<span class="cm">			 * We aren&#39;t in very good shape actually because</span>
<span class="cm">			 * the incore structures are convinced that quotas are</span>
<span class="cm">			 * off, but the on disk superblock doesn&#39;t know that !</span>
<span class="cm">			 */</span>
			<span class="n">ASSERT</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">XFS_IS_QUOTA_RUNNING</span><span class="p">(</span><span class="n">mp</span><span class="p">)));</span>
			<span class="n">xfs_alert</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="s">&quot;%s: Superblock update failed!&quot;</span><span class="p">,</span>
				<span class="n">__func__</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">xfs_warn</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="s">&quot;Failed to initialize disk quotas.&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Called from the vfsops layer.</span>
<span class="cm"> */</span>
<span class="kt">void</span>
<span class="nf">xfs_qm_unmount_quotas</span><span class="p">(</span>
	<span class="n">xfs_mount_t</span>	<span class="o">*</span><span class="n">mp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/*</span>
<span class="cm">	 * Release the dquots that root inode, et al might be holding,</span>
<span class="cm">	 * before we flush quotas and blow away the quotainfo structure.</span>
<span class="cm">	 */</span>
	<span class="n">ASSERT</span><span class="p">(</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_rootip</span><span class="p">);</span>
	<span class="n">xfs_qm_dqdetach</span><span class="p">(</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_rootip</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_rbmip</span><span class="p">)</span>
		<span class="n">xfs_qm_dqdetach</span><span class="p">(</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_rbmip</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_rsumip</span><span class="p">)</span>
		<span class="n">xfs_qm_dqdetach</span><span class="p">(</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_rsumip</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Release the quota inodes.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_quotainfo</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_quotainfo</span><span class="o">-&gt;</span><span class="n">qi_uquotaip</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">IRELE</span><span class="p">(</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_quotainfo</span><span class="o">-&gt;</span><span class="n">qi_uquotaip</span><span class="p">);</span>
			<span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_quotainfo</span><span class="o">-&gt;</span><span class="n">qi_uquotaip</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_quotainfo</span><span class="o">-&gt;</span><span class="n">qi_gquotaip</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">IRELE</span><span class="p">(</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_quotainfo</span><span class="o">-&gt;</span><span class="n">qi_gquotaip</span><span class="p">);</span>
			<span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_quotainfo</span><span class="o">-&gt;</span><span class="n">qi_gquotaip</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="n">STATIC</span> <span class="kt">int</span>
<span class="nf">xfs_qm_dqattach_one</span><span class="p">(</span>
	<span class="n">xfs_inode_t</span>	<span class="o">*</span><span class="n">ip</span><span class="p">,</span>
	<span class="n">xfs_dqid_t</span>	<span class="n">id</span><span class="p">,</span>
	<span class="n">uint</span>		<span class="n">type</span><span class="p">,</span>
	<span class="n">uint</span>		<span class="n">doalloc</span><span class="p">,</span>
	<span class="n">xfs_dquot_t</span>	<span class="o">*</span><span class="n">udqhint</span><span class="p">,</span> <span class="cm">/* hint */</span>
	<span class="n">xfs_dquot_t</span>	<span class="o">**</span><span class="n">IO_idqpp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">xfs_dquot_t</span>	<span class="o">*</span><span class="n">dqp</span><span class="p">;</span>
	<span class="kt">int</span>		<span class="n">error</span><span class="p">;</span>

	<span class="n">ASSERT</span><span class="p">(</span><span class="n">xfs_isilocked</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">XFS_ILOCK_EXCL</span><span class="p">));</span>
	<span class="n">error</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * See if we already have it in the inode itself. IO_idqpp is</span>
<span class="cm">	 * &amp;i_udquot or &amp;i_gdquot. This made the code look weird, but</span>
<span class="cm">	 * made the logic a lot simpler.</span>
<span class="cm">	 */</span>
	<span class="n">dqp</span> <span class="o">=</span> <span class="o">*</span><span class="n">IO_idqpp</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dqp</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">trace_xfs_dqattach_found</span><span class="p">(</span><span class="n">dqp</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * udqhint is the i_udquot field in inode, and is non-NULL only</span>
<span class="cm">	 * when the type arg is group/project. Its purpose is to save a</span>
<span class="cm">	 * lookup by dqid (xfs_qm_dqget) by caching a group dquot inside</span>
<span class="cm">	 * the user dquot.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">udqhint</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ASSERT</span><span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="n">XFS_DQ_GROUP</span> <span class="o">||</span> <span class="n">type</span> <span class="o">==</span> <span class="n">XFS_DQ_PROJ</span><span class="p">);</span>
		<span class="n">xfs_dqlock</span><span class="p">(</span><span class="n">udqhint</span><span class="p">);</span>

		<span class="cm">/*</span>
<span class="cm">		 * No need to take dqlock to look at the id.</span>
<span class="cm">		 *</span>
<span class="cm">		 * The ID can&#39;t change until it gets reclaimed, and it won&#39;t</span>
<span class="cm">		 * be reclaimed as long as we have a ref from inode and we</span>
<span class="cm">		 * hold the ilock.</span>
<span class="cm">		 */</span>
		<span class="n">dqp</span> <span class="o">=</span> <span class="n">udqhint</span><span class="o">-&gt;</span><span class="n">q_gdquot</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dqp</span> <span class="o">&amp;&amp;</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">dqp</span><span class="o">-&gt;</span><span class="n">q_core</span><span class="p">.</span><span class="n">d_id</span><span class="p">)</span> <span class="o">==</span> <span class="n">id</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ASSERT</span><span class="p">(</span><span class="o">*</span><span class="n">IO_idqpp</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">);</span>

			<span class="o">*</span><span class="n">IO_idqpp</span> <span class="o">=</span> <span class="n">xfs_qm_dqhold</span><span class="p">(</span><span class="n">dqp</span><span class="p">);</span>
			<span class="n">xfs_dqunlock</span><span class="p">(</span><span class="n">udqhint</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/*</span>
<span class="cm">		 * We can&#39;t hold a dquot lock when we call the dqget code.</span>
<span class="cm">		 * We&#39;ll deadlock in no time, because of (not conforming to)</span>
<span class="cm">		 * lock ordering - the inodelock comes before any dquot lock,</span>
<span class="cm">		 * and we may drop and reacquire the ilock in xfs_qm_dqget().</span>
<span class="cm">		 */</span>
		<span class="n">xfs_dqunlock</span><span class="p">(</span><span class="n">udqhint</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Find the dquot from somewhere. This bumps the</span>
<span class="cm">	 * reference count of dquot and returns it locked.</span>
<span class="cm">	 * This can return ENOENT if dquot didn&#39;t exist on</span>
<span class="cm">	 * disk and we didn&#39;t ask it to allocate;</span>
<span class="cm">	 * ESRCH if quotas got turned off suddenly.</span>
<span class="cm">	 */</span>
	<span class="n">error</span> <span class="o">=</span> <span class="n">xfs_qm_dqget</span><span class="p">(</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_mount</span><span class="p">,</span> <span class="n">ip</span><span class="p">,</span> <span class="n">id</span><span class="p">,</span> <span class="n">type</span><span class="p">,</span>
			     <span class="n">doalloc</span> <span class="o">|</span> <span class="n">XFS_QMOPT_DOWARN</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dqp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">error</span><span class="p">;</span>

	<span class="n">trace_xfs_dqattach_get</span><span class="p">(</span><span class="n">dqp</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * dqget may have dropped and re-acquired the ilock, but it guarantees</span>
<span class="cm">	 * that the dquot returned is the one that should go in the inode.</span>
<span class="cm">	 */</span>
	<span class="o">*</span><span class="n">IO_idqpp</span> <span class="o">=</span> <span class="n">dqp</span><span class="p">;</span>
	<span class="n">xfs_dqunlock</span><span class="p">(</span><span class="n">dqp</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * Given a udquot and gdquot, attach a ptr to the group dquot in the</span>
<span class="cm"> * udquot as a hint for future lookups.</span>
<span class="cm"> */</span>
<span class="n">STATIC</span> <span class="kt">void</span>
<span class="nf">xfs_qm_dqattach_grouphint</span><span class="p">(</span>
	<span class="n">xfs_dquot_t</span>	<span class="o">*</span><span class="n">udq</span><span class="p">,</span>
	<span class="n">xfs_dquot_t</span>	<span class="o">*</span><span class="n">gdq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">xfs_dquot_t</span>	<span class="o">*</span><span class="n">tmp</span><span class="p">;</span>

	<span class="n">xfs_dqlock</span><span class="p">(</span><span class="n">udq</span><span class="p">);</span>

	<span class="n">tmp</span> <span class="o">=</span> <span class="n">udq</span><span class="o">-&gt;</span><span class="n">q_gdquot</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tmp</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">==</span> <span class="n">gdq</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>

		<span class="n">udq</span><span class="o">-&gt;</span><span class="n">q_gdquot</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">xfs_qm_dqrele</span><span class="p">(</span><span class="n">tmp</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">udq</span><span class="o">-&gt;</span><span class="n">q_gdquot</span> <span class="o">=</span> <span class="n">xfs_qm_dqhold</span><span class="p">(</span><span class="n">gdq</span><span class="p">);</span>
<span class="nl">done:</span>
	<span class="n">xfs_dqunlock</span><span class="p">(</span><span class="n">udq</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span>
<span class="nf">xfs_qm_need_dqattach</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">xfs_inode</span>	<span class="o">*</span><span class="n">ip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">xfs_mount</span>	<span class="o">*</span><span class="n">mp</span> <span class="o">=</span> <span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_mount</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">XFS_IS_QUOTA_RUNNING</span><span class="p">(</span><span class="n">mp</span><span class="p">))</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">XFS_IS_QUOTA_ON</span><span class="p">(</span><span class="n">mp</span><span class="p">))</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">XFS_NOT_DQATTACHED</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="n">ip</span><span class="p">))</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_ino</span> <span class="o">==</span> <span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_sb</span><span class="p">.</span><span class="n">sb_uquotino</span> <span class="o">||</span>
	    <span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_ino</span> <span class="o">==</span> <span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_sb</span><span class="p">.</span><span class="n">sb_gquotino</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
	<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Given a locked inode, attach dquot(s) to it, taking U/G/P-QUOTAON</span>
<span class="cm"> * into account.</span>
<span class="cm"> * If XFS_QMOPT_DQALLOC, the dquot(s) will be allocated if needed.</span>
<span class="cm"> * Inode may get unlocked and relocked in here, and the caller must deal with</span>
<span class="cm"> * the consequences.</span>
<span class="cm"> */</span>
<span class="kt">int</span>
<span class="nf">xfs_qm_dqattach_locked</span><span class="p">(</span>
	<span class="n">xfs_inode_t</span>	<span class="o">*</span><span class="n">ip</span><span class="p">,</span>
	<span class="n">uint</span>		<span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">xfs_mount_t</span>	<span class="o">*</span><span class="n">mp</span> <span class="o">=</span> <span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_mount</span><span class="p">;</span>
	<span class="n">uint</span>		<span class="n">nquotas</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span>		<span class="n">error</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">xfs_qm_need_dqattach</span><span class="p">(</span><span class="n">ip</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">ASSERT</span><span class="p">(</span><span class="n">xfs_isilocked</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">XFS_ILOCK_EXCL</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">XFS_IS_UQUOTA_ON</span><span class="p">(</span><span class="n">mp</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">error</span> <span class="o">=</span> <span class="n">xfs_qm_dqattach_one</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_d</span><span class="p">.</span><span class="n">di_uid</span><span class="p">,</span> <span class="n">XFS_DQ_USER</span><span class="p">,</span>
						<span class="n">flags</span> <span class="o">&amp;</span> <span class="n">XFS_QMOPT_DQALLOC</span><span class="p">,</span>
						<span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_udquot</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
		<span class="n">nquotas</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ASSERT</span><span class="p">(</span><span class="n">xfs_isilocked</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">XFS_ILOCK_EXCL</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">XFS_IS_OQUOTA_ON</span><span class="p">(</span><span class="n">mp</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">error</span> <span class="o">=</span> <span class="n">XFS_IS_GQUOTA_ON</span><span class="p">(</span><span class="n">mp</span><span class="p">)</span> <span class="o">?</span>
			<span class="n">xfs_qm_dqattach_one</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_d</span><span class="p">.</span><span class="n">di_gid</span><span class="p">,</span> <span class="n">XFS_DQ_GROUP</span><span class="p">,</span>
						<span class="n">flags</span> <span class="o">&amp;</span> <span class="n">XFS_QMOPT_DQALLOC</span><span class="p">,</span>
						<span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_udquot</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_gdquot</span><span class="p">)</span> <span class="o">:</span>
			<span class="n">xfs_qm_dqattach_one</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">xfs_get_projid</span><span class="p">(</span><span class="n">ip</span><span class="p">),</span> <span class="n">XFS_DQ_PROJ</span><span class="p">,</span>
						<span class="n">flags</span> <span class="o">&amp;</span> <span class="n">XFS_QMOPT_DQALLOC</span><span class="p">,</span>
						<span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_udquot</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_gdquot</span><span class="p">);</span>
		<span class="cm">/*</span>
<span class="cm">		 * Don&#39;t worry about the udquot that we may have</span>
<span class="cm">		 * attached above. It&#39;ll get detached, if not already.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
		<span class="n">nquotas</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Attach this group quota to the user quota as a hint.</span>
<span class="cm">	 * This WON&#39;T, in general, result in a thrash.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nquotas</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ASSERT</span><span class="p">(</span><span class="n">xfs_isilocked</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">XFS_ILOCK_EXCL</span><span class="p">));</span>
		<span class="n">ASSERT</span><span class="p">(</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_udquot</span><span class="p">);</span>
		<span class="n">ASSERT</span><span class="p">(</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_gdquot</span><span class="p">);</span>

		<span class="cm">/*</span>
<span class="cm">		 * We do not have i_udquot locked at this point, but this check</span>
<span class="cm">		 * is OK since we don&#39;t depend on the i_gdquot to be accurate</span>
<span class="cm">		 * 100% all the time. It is just a hint, and this will</span>
<span class="cm">		 * succeed in general.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_udquot</span><span class="o">-&gt;</span><span class="n">q_gdquot</span> <span class="o">!=</span> <span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_gdquot</span><span class="p">)</span>
			<span class="n">xfs_qm_dqattach_grouphint</span><span class="p">(</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_udquot</span><span class="p">,</span> <span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_gdquot</span><span class="p">);</span>
	<span class="p">}</span>

 <span class="nl">done:</span>
<span class="cp">#ifdef DEBUG</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">XFS_IS_UQUOTA_ON</span><span class="p">(</span><span class="n">mp</span><span class="p">))</span>
			<span class="n">ASSERT</span><span class="p">(</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_udquot</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">XFS_IS_OQUOTA_ON</span><span class="p">(</span><span class="n">mp</span><span class="p">))</span>
			<span class="n">ASSERT</span><span class="p">(</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_gdquot</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">ASSERT</span><span class="p">(</span><span class="n">xfs_isilocked</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">XFS_ILOCK_EXCL</span><span class="p">));</span>
<span class="cp">#endif</span>
	<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="nf">xfs_qm_dqattach</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">xfs_inode</span>	<span class="o">*</span><span class="n">ip</span><span class="p">,</span>
	<span class="n">uint</span>			<span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span>			<span class="n">error</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">xfs_qm_need_dqattach</span><span class="p">(</span><span class="n">ip</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">xfs_ilock</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">XFS_ILOCK_EXCL</span><span class="p">);</span>
	<span class="n">error</span> <span class="o">=</span> <span class="n">xfs_qm_dqattach_locked</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">xfs_iunlock</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">XFS_ILOCK_EXCL</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Release dquots (and their references) if any.</span>
<span class="cm"> * The inode should be locked EXCL except when this&#39;s called by</span>
<span class="cm"> * xfs_ireclaim.</span>
<span class="cm"> */</span>
<span class="kt">void</span>
<span class="nf">xfs_qm_dqdetach</span><span class="p">(</span>
	<span class="n">xfs_inode_t</span>	<span class="o">*</span><span class="n">ip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_udquot</span> <span class="o">||</span> <span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_gdquot</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">trace_xfs_dquot_dqdetach</span><span class="p">(</span><span class="n">ip</span><span class="p">);</span>

	<span class="n">ASSERT</span><span class="p">(</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_ino</span> <span class="o">!=</span> <span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_mount</span><span class="o">-&gt;</span><span class="n">m_sb</span><span class="p">.</span><span class="n">sb_uquotino</span><span class="p">);</span>
	<span class="n">ASSERT</span><span class="p">(</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_ino</span> <span class="o">!=</span> <span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_mount</span><span class="o">-&gt;</span><span class="n">m_sb</span><span class="p">.</span><span class="n">sb_gquotino</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_udquot</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">xfs_qm_dqrele</span><span class="p">(</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_udquot</span><span class="p">);</span>
		<span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_udquot</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_gdquot</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">xfs_qm_dqrele</span><span class="p">(</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_gdquot</span><span class="p">);</span>
		<span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_gdquot</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * This initializes all the quota information that&#39;s kept in the</span>
<span class="cm"> * mount structure</span>
<span class="cm"> */</span>
<span class="n">STATIC</span> <span class="kt">int</span>
<span class="nf">xfs_qm_init_quotainfo</span><span class="p">(</span>
	<span class="n">xfs_mount_t</span>	<span class="o">*</span><span class="n">mp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">xfs_quotainfo_t</span> <span class="o">*</span><span class="n">qinf</span><span class="p">;</span>
	<span class="kt">int</span>		<span class="n">error</span><span class="p">;</span>
	<span class="n">xfs_dquot_t</span>	<span class="o">*</span><span class="n">dqp</span><span class="p">;</span>

	<span class="n">ASSERT</span><span class="p">(</span><span class="n">XFS_IS_QUOTA_RUNNING</span><span class="p">(</span><span class="n">mp</span><span class="p">));</span>

	<span class="n">qinf</span> <span class="o">=</span> <span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_quotainfo</span> <span class="o">=</span> <span class="n">kmem_zalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">xfs_quotainfo_t</span><span class="p">),</span> <span class="n">KM_SLEEP</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * See if quotainodes are setup, and if not, allocate them,</span>
<span class="cm">	 * and change the superblock accordingly.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">error</span> <span class="o">=</span> <span class="n">xfs_qm_init_quotainos</span><span class="p">(</span><span class="n">mp</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">kmem_free</span><span class="p">(</span><span class="n">qinf</span><span class="p">);</span>
		<span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_quotainfo</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">INIT_RADIX_TREE</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qinf</span><span class="o">-&gt;</span><span class="n">qi_uquota_tree</span><span class="p">,</span> <span class="n">GFP_NOFS</span><span class="p">);</span>
	<span class="n">INIT_RADIX_TREE</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qinf</span><span class="o">-&gt;</span><span class="n">qi_gquota_tree</span><span class="p">,</span> <span class="n">GFP_NOFS</span><span class="p">);</span>
	<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qinf</span><span class="o">-&gt;</span><span class="n">qi_tree_lock</span><span class="p">);</span>

	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qinf</span><span class="o">-&gt;</span><span class="n">qi_lru_list</span><span class="p">);</span>
	<span class="n">qinf</span><span class="o">-&gt;</span><span class="n">qi_lru_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qinf</span><span class="o">-&gt;</span><span class="n">qi_lru_lock</span><span class="p">);</span>

	<span class="cm">/* mutex used to serialize quotaoffs */</span>
	<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qinf</span><span class="o">-&gt;</span><span class="n">qi_quotaofflock</span><span class="p">);</span>

	<span class="cm">/* Precalc some constants */</span>
	<span class="n">qinf</span><span class="o">-&gt;</span><span class="n">qi_dqchunklen</span> <span class="o">=</span> <span class="n">XFS_FSB_TO_BB</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="n">XFS_DQUOT_CLUSTER_SIZE_FSB</span><span class="p">);</span>
	<span class="n">ASSERT</span><span class="p">(</span><span class="n">qinf</span><span class="o">-&gt;</span><span class="n">qi_dqchunklen</span><span class="p">);</span>
	<span class="n">qinf</span><span class="o">-&gt;</span><span class="n">qi_dqperchunk</span> <span class="o">=</span> <span class="n">BBTOB</span><span class="p">(</span><span class="n">qinf</span><span class="o">-&gt;</span><span class="n">qi_dqchunklen</span><span class="p">);</span>
	<span class="n">do_div</span><span class="p">(</span><span class="n">qinf</span><span class="o">-&gt;</span><span class="n">qi_dqperchunk</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">xfs_dqblk_t</span><span class="p">));</span>

	<span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_qflags</span> <span class="o">|=</span> <span class="p">(</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_sb</span><span class="p">.</span><span class="n">sb_qflags</span> <span class="o">&amp;</span> <span class="n">XFS_ALL_QUOTA_CHKD</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * We try to get the limits from the superuser&#39;s limits fields.</span>
<span class="cm">	 * This is quite hacky, but it is standard quota practice.</span>
<span class="cm">	 *</span>
<span class="cm">	 * We look at the USR dquot with id == 0 first, but if user quotas</span>
<span class="cm">	 * are not enabled we goto the GRP dquot with id == 0.</span>
<span class="cm">	 * We don&#39;t really care to keep separate default limits for user</span>
<span class="cm">	 * and group quotas, at least not at this point.</span>
<span class="cm">	 *</span>
<span class="cm">	 * Since we may not have done a quotacheck by this point, just read</span>
<span class="cm">	 * the dquot without attaching it to any hashtables or lists.</span>
<span class="cm">	 */</span>
	<span class="n">error</span> <span class="o">=</span> <span class="n">xfs_qm_dqread</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
			<span class="n">XFS_IS_UQUOTA_RUNNING</span><span class="p">(</span><span class="n">mp</span><span class="p">)</span> <span class="o">?</span> <span class="n">XFS_DQ_USER</span> <span class="o">:</span>
			 <span class="p">(</span><span class="n">XFS_IS_GQUOTA_RUNNING</span><span class="p">(</span><span class="n">mp</span><span class="p">)</span> <span class="o">?</span> <span class="n">XFS_DQ_GROUP</span> <span class="o">:</span>
			  <span class="n">XFS_DQ_PROJ</span><span class="p">),</span>
			<span class="n">XFS_QMOPT_DOWARN</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dqp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">xfs_disk_dquot_t</span>	<span class="o">*</span><span class="n">ddqp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dqp</span><span class="o">-&gt;</span><span class="n">q_core</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * The warnings and timers set the grace period given to</span>
<span class="cm">		 * a user or group before he or she can not perform any</span>
<span class="cm">		 * more writing. If it is zero, a default is used.</span>
<span class="cm">		 */</span>
		<span class="n">qinf</span><span class="o">-&gt;</span><span class="n">qi_btimelimit</span> <span class="o">=</span> <span class="n">ddqp</span><span class="o">-&gt;</span><span class="n">d_btimer</span> <span class="o">?</span>
			<span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">ddqp</span><span class="o">-&gt;</span><span class="n">d_btimer</span><span class="p">)</span> <span class="o">:</span> <span class="n">XFS_QM_BTIMELIMIT</span><span class="p">;</span>
		<span class="n">qinf</span><span class="o">-&gt;</span><span class="n">qi_itimelimit</span> <span class="o">=</span> <span class="n">ddqp</span><span class="o">-&gt;</span><span class="n">d_itimer</span> <span class="o">?</span>
			<span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">ddqp</span><span class="o">-&gt;</span><span class="n">d_itimer</span><span class="p">)</span> <span class="o">:</span> <span class="n">XFS_QM_ITIMELIMIT</span><span class="p">;</span>
		<span class="n">qinf</span><span class="o">-&gt;</span><span class="n">qi_rtbtimelimit</span> <span class="o">=</span> <span class="n">ddqp</span><span class="o">-&gt;</span><span class="n">d_rtbtimer</span> <span class="o">?</span>
			<span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">ddqp</span><span class="o">-&gt;</span><span class="n">d_rtbtimer</span><span class="p">)</span> <span class="o">:</span> <span class="n">XFS_QM_RTBTIMELIMIT</span><span class="p">;</span>
		<span class="n">qinf</span><span class="o">-&gt;</span><span class="n">qi_bwarnlimit</span> <span class="o">=</span> <span class="n">ddqp</span><span class="o">-&gt;</span><span class="n">d_bwarns</span> <span class="o">?</span>
			<span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">ddqp</span><span class="o">-&gt;</span><span class="n">d_bwarns</span><span class="p">)</span> <span class="o">:</span> <span class="n">XFS_QM_BWARNLIMIT</span><span class="p">;</span>
		<span class="n">qinf</span><span class="o">-&gt;</span><span class="n">qi_iwarnlimit</span> <span class="o">=</span> <span class="n">ddqp</span><span class="o">-&gt;</span><span class="n">d_iwarns</span> <span class="o">?</span>
			<span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">ddqp</span><span class="o">-&gt;</span><span class="n">d_iwarns</span><span class="p">)</span> <span class="o">:</span> <span class="n">XFS_QM_IWARNLIMIT</span><span class="p">;</span>
		<span class="n">qinf</span><span class="o">-&gt;</span><span class="n">qi_rtbwarnlimit</span> <span class="o">=</span> <span class="n">ddqp</span><span class="o">-&gt;</span><span class="n">d_rtbwarns</span> <span class="o">?</span>
			<span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">ddqp</span><span class="o">-&gt;</span><span class="n">d_rtbwarns</span><span class="p">)</span> <span class="o">:</span> <span class="n">XFS_QM_RTBWARNLIMIT</span><span class="p">;</span>
		<span class="n">qinf</span><span class="o">-&gt;</span><span class="n">qi_bhardlimit</span> <span class="o">=</span> <span class="n">be64_to_cpu</span><span class="p">(</span><span class="n">ddqp</span><span class="o">-&gt;</span><span class="n">d_blk_hardlimit</span><span class="p">);</span>
		<span class="n">qinf</span><span class="o">-&gt;</span><span class="n">qi_bsoftlimit</span> <span class="o">=</span> <span class="n">be64_to_cpu</span><span class="p">(</span><span class="n">ddqp</span><span class="o">-&gt;</span><span class="n">d_blk_softlimit</span><span class="p">);</span>
		<span class="n">qinf</span><span class="o">-&gt;</span><span class="n">qi_ihardlimit</span> <span class="o">=</span> <span class="n">be64_to_cpu</span><span class="p">(</span><span class="n">ddqp</span><span class="o">-&gt;</span><span class="n">d_ino_hardlimit</span><span class="p">);</span>
		<span class="n">qinf</span><span class="o">-&gt;</span><span class="n">qi_isoftlimit</span> <span class="o">=</span> <span class="n">be64_to_cpu</span><span class="p">(</span><span class="n">ddqp</span><span class="o">-&gt;</span><span class="n">d_ino_softlimit</span><span class="p">);</span>
		<span class="n">qinf</span><span class="o">-&gt;</span><span class="n">qi_rtbhardlimit</span> <span class="o">=</span> <span class="n">be64_to_cpu</span><span class="p">(</span><span class="n">ddqp</span><span class="o">-&gt;</span><span class="n">d_rtb_hardlimit</span><span class="p">);</span>
		<span class="n">qinf</span><span class="o">-&gt;</span><span class="n">qi_rtbsoftlimit</span> <span class="o">=</span> <span class="n">be64_to_cpu</span><span class="p">(</span><span class="n">ddqp</span><span class="o">-&gt;</span><span class="n">d_rtb_softlimit</span><span class="p">);</span>
 
		<span class="n">xfs_qm_dqdestroy</span><span class="p">(</span><span class="n">dqp</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">qinf</span><span class="o">-&gt;</span><span class="n">qi_btimelimit</span> <span class="o">=</span> <span class="n">XFS_QM_BTIMELIMIT</span><span class="p">;</span>
		<span class="n">qinf</span><span class="o">-&gt;</span><span class="n">qi_itimelimit</span> <span class="o">=</span> <span class="n">XFS_QM_ITIMELIMIT</span><span class="p">;</span>
		<span class="n">qinf</span><span class="o">-&gt;</span><span class="n">qi_rtbtimelimit</span> <span class="o">=</span> <span class="n">XFS_QM_RTBTIMELIMIT</span><span class="p">;</span>
		<span class="n">qinf</span><span class="o">-&gt;</span><span class="n">qi_bwarnlimit</span> <span class="o">=</span> <span class="n">XFS_QM_BWARNLIMIT</span><span class="p">;</span>
		<span class="n">qinf</span><span class="o">-&gt;</span><span class="n">qi_iwarnlimit</span> <span class="o">=</span> <span class="n">XFS_QM_IWARNLIMIT</span><span class="p">;</span>
		<span class="n">qinf</span><span class="o">-&gt;</span><span class="n">qi_rtbwarnlimit</span> <span class="o">=</span> <span class="n">XFS_QM_RTBWARNLIMIT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">qinf</span><span class="o">-&gt;</span><span class="n">qi_shrinker</span><span class="p">.</span><span class="n">shrink</span> <span class="o">=</span> <span class="n">xfs_qm_shake</span><span class="p">;</span>
	<span class="n">qinf</span><span class="o">-&gt;</span><span class="n">qi_shrinker</span><span class="p">.</span><span class="n">seeks</span> <span class="o">=</span> <span class="n">DEFAULT_SEEKS</span><span class="p">;</span>
	<span class="n">register_shrinker</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qinf</span><span class="o">-&gt;</span><span class="n">qi_shrinker</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * Gets called when unmounting a filesystem or when all quotas get</span>
<span class="cm"> * turned off.</span>
<span class="cm"> * This purges the quota inodes, destroys locks and frees itself.</span>
<span class="cm"> */</span>
<span class="kt">void</span>
<span class="nf">xfs_qm_destroy_quotainfo</span><span class="p">(</span>
	<span class="n">xfs_mount_t</span>	<span class="o">*</span><span class="n">mp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">xfs_quotainfo_t</span> <span class="o">*</span><span class="n">qi</span><span class="p">;</span>

	<span class="n">qi</span> <span class="o">=</span> <span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_quotainfo</span><span class="p">;</span>
	<span class="n">ASSERT</span><span class="p">(</span><span class="n">qi</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="n">unregister_shrinker</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qi</span><span class="o">-&gt;</span><span class="n">qi_shrinker</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">qi</span><span class="o">-&gt;</span><span class="n">qi_uquotaip</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">IRELE</span><span class="p">(</span><span class="n">qi</span><span class="o">-&gt;</span><span class="n">qi_uquotaip</span><span class="p">);</span>
		<span class="n">qi</span><span class="o">-&gt;</span><span class="n">qi_uquotaip</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span> <span class="cm">/* paranoia */</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">qi</span><span class="o">-&gt;</span><span class="n">qi_gquotaip</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">IRELE</span><span class="p">(</span><span class="n">qi</span><span class="o">-&gt;</span><span class="n">qi_gquotaip</span><span class="p">);</span>
		<span class="n">qi</span><span class="o">-&gt;</span><span class="n">qi_gquotaip</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">mutex_destroy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qi</span><span class="o">-&gt;</span><span class="n">qi_quotaofflock</span><span class="p">);</span>
	<span class="n">kmem_free</span><span class="p">(</span><span class="n">qi</span><span class="p">);</span>
	<span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_quotainfo</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Create an inode and return with a reference already taken, but unlocked</span>
<span class="cm"> * This is how we create quota inodes</span>
<span class="cm"> */</span>
<span class="n">STATIC</span> <span class="kt">int</span>
<span class="nf">xfs_qm_qino_alloc</span><span class="p">(</span>
	<span class="n">xfs_mount_t</span>	<span class="o">*</span><span class="n">mp</span><span class="p">,</span>
	<span class="n">xfs_inode_t</span>	<span class="o">**</span><span class="n">ip</span><span class="p">,</span>
	<span class="n">__int64_t</span>	<span class="n">sbfields</span><span class="p">,</span>
	<span class="n">uint</span>		<span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">xfs_trans_t</span>	<span class="o">*</span><span class="n">tp</span><span class="p">;</span>
	<span class="kt">int</span>		<span class="n">error</span><span class="p">;</span>
	<span class="kt">int</span>		<span class="n">committed</span><span class="p">;</span>

	<span class="n">tp</span> <span class="o">=</span> <span class="n">xfs_trans_alloc</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="n">XFS_TRANS_QM_QINOCREATE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">error</span> <span class="o">=</span> <span class="n">xfs_trans_reserve</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span>
				      <span class="n">XFS_QM_QINOCREATE_SPACE_RES</span><span class="p">(</span><span class="n">mp</span><span class="p">),</span>
				      <span class="n">XFS_CREATE_LOG_RES</span><span class="p">(</span><span class="n">mp</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span>
				      <span class="n">XFS_TRANS_PERM_LOG_RES</span><span class="p">,</span>
				      <span class="n">XFS_CREATE_LOG_COUNT</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">xfs_trans_cancel</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">error</span> <span class="o">=</span> <span class="n">xfs_dir_ialloc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tp</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">S_IFREG</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ip</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">committed</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">xfs_trans_cancel</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">XFS_TRANS_RELEASE_LOG_RES</span> <span class="o">|</span>
				 <span class="n">XFS_TRANS_ABORT</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Make the changes in the superblock, and log those too.</span>
<span class="cm">	 * sbfields arg may contain fields other than *QUOTINO;</span>
<span class="cm">	 * VERSIONNUM for example.</span>
<span class="cm">	 */</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_sb_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">XFS_QMOPT_SBVERSION</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ASSERT</span><span class="p">(</span><span class="o">!</span><span class="n">xfs_sb_version_hasquota</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_sb</span><span class="p">));</span>
		<span class="n">ASSERT</span><span class="p">((</span><span class="n">sbfields</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">XFS_SB_VERSIONNUM</span> <span class="o">|</span> <span class="n">XFS_SB_UQUOTINO</span> <span class="o">|</span>
				   <span class="n">XFS_SB_GQUOTINO</span> <span class="o">|</span> <span class="n">XFS_SB_QFLAGS</span><span class="p">))</span> <span class="o">==</span>
		       <span class="p">(</span><span class="n">XFS_SB_VERSIONNUM</span> <span class="o">|</span> <span class="n">XFS_SB_UQUOTINO</span> <span class="o">|</span>
			<span class="n">XFS_SB_GQUOTINO</span> <span class="o">|</span> <span class="n">XFS_SB_QFLAGS</span><span class="p">));</span>

		<span class="n">xfs_sb_version_addquota</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_sb</span><span class="p">);</span>
		<span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_sb</span><span class="p">.</span><span class="n">sb_uquotino</span> <span class="o">=</span> <span class="n">NULLFSINO</span><span class="p">;</span>
		<span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_sb</span><span class="p">.</span><span class="n">sb_gquotino</span> <span class="o">=</span> <span class="n">NULLFSINO</span><span class="p">;</span>

		<span class="cm">/* qflags will get updated _after_ quotacheck */</span>
		<span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_sb</span><span class="p">.</span><span class="n">sb_qflags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">XFS_QMOPT_UQUOTA</span><span class="p">)</span>
		<span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_sb</span><span class="p">.</span><span class="n">sb_uquotino</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="n">ip</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">i_ino</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_sb</span><span class="p">.</span><span class="n">sb_gquotino</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="n">ip</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">i_ino</span><span class="p">;</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_sb_lock</span><span class="p">);</span>
	<span class="n">xfs_mod_sb</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">sbfields</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">error</span> <span class="o">=</span> <span class="n">xfs_trans_commit</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">XFS_TRANS_RELEASE_LOG_RES</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">xfs_alert</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="s">&quot;%s failed (error %d)!&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">error</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="n">STATIC</span> <span class="kt">void</span>
<span class="nf">xfs_qm_reset_dqcounts</span><span class="p">(</span>
	<span class="n">xfs_mount_t</span>	<span class="o">*</span><span class="n">mp</span><span class="p">,</span>
	<span class="n">xfs_buf_t</span>	<span class="o">*</span><span class="n">bp</span><span class="p">,</span>
	<span class="n">xfs_dqid_t</span>	<span class="n">id</span><span class="p">,</span>
	<span class="n">uint</span>		<span class="n">type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">xfs_disk_dquot_t</span>	<span class="o">*</span><span class="n">ddq</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">j</span><span class="p">;</span>

	<span class="n">trace_xfs_reset_dqcounts</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">_RET_IP_</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Reset all counters and timers. They&#39;ll be</span>
<span class="cm">	 * started afresh by xfs_qm_quotacheck.</span>
<span class="cm">	 */</span>
<span class="cp">#ifdef DEBUG</span>
	<span class="n">j</span> <span class="o">=</span> <span class="n">XFS_FSB_TO_B</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="n">XFS_DQUOT_CLUSTER_SIZE_FSB</span><span class="p">);</span>
	<span class="n">do_div</span><span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">xfs_dqblk_t</span><span class="p">));</span>
	<span class="n">ASSERT</span><span class="p">(</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_quotainfo</span><span class="o">-&gt;</span><span class="n">qi_dqperchunk</span> <span class="o">==</span> <span class="n">j</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="n">ddq</span> <span class="o">=</span> <span class="n">bp</span><span class="o">-&gt;</span><span class="n">b_addr</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_quotainfo</span><span class="o">-&gt;</span><span class="n">qi_dqperchunk</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Do a sanity check, and if needed, repair the dqblk. Don&#39;t</span>
<span class="cm">		 * output any warnings because it&#39;s perfectly possible to</span>
<span class="cm">		 * find uninitialised dquot blks. See comment in xfs_qm_dqcheck.</span>
<span class="cm">		 */</span>
		<span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">xfs_qm_dqcheck</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="n">ddq</span><span class="p">,</span> <span class="n">id</span><span class="o">+</span><span class="n">j</span><span class="p">,</span> <span class="n">type</span><span class="p">,</span> <span class="n">XFS_QMOPT_DQREPAIR</span><span class="p">,</span>
				      <span class="s">&quot;xfs_quotacheck&quot;</span><span class="p">);</span>
		<span class="n">ddq</span><span class="o">-&gt;</span><span class="n">d_bcount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">ddq</span><span class="o">-&gt;</span><span class="n">d_icount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">ddq</span><span class="o">-&gt;</span><span class="n">d_rtbcount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">ddq</span><span class="o">-&gt;</span><span class="n">d_btimer</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">ddq</span><span class="o">-&gt;</span><span class="n">d_itimer</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">ddq</span><span class="o">-&gt;</span><span class="n">d_rtbtimer</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">ddq</span><span class="o">-&gt;</span><span class="n">d_bwarns</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">ddq</span><span class="o">-&gt;</span><span class="n">d_iwarns</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">ddq</span><span class="o">-&gt;</span><span class="n">d_rtbwarns</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">ddq</span> <span class="o">=</span> <span class="p">(</span><span class="n">xfs_disk_dquot_t</span> <span class="o">*</span><span class="p">)</span> <span class="p">((</span><span class="n">xfs_dqblk_t</span> <span class="o">*</span><span class="p">)</span><span class="n">ddq</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="n">STATIC</span> <span class="kt">int</span>
<span class="nf">xfs_qm_dqiter_bufs</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">xfs_mount</span>	<span class="o">*</span><span class="n">mp</span><span class="p">,</span>
	<span class="n">xfs_dqid_t</span>		<span class="n">firstid</span><span class="p">,</span>
	<span class="n">xfs_fsblock_t</span>		<span class="n">bno</span><span class="p">,</span>
	<span class="n">xfs_filblks_t</span>		<span class="n">blkcnt</span><span class="p">,</span>
	<span class="n">uint</span>			<span class="n">flags</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">list_head</span>	<span class="o">*</span><span class="n">buffer_list</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">xfs_buf</span>		<span class="o">*</span><span class="n">bp</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">error</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">type</span><span class="p">;</span>

	<span class="n">ASSERT</span><span class="p">(</span><span class="n">blkcnt</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">type</span> <span class="o">=</span> <span class="n">flags</span> <span class="o">&amp;</span> <span class="n">XFS_QMOPT_UQUOTA</span> <span class="o">?</span> <span class="n">XFS_DQ_USER</span> <span class="o">:</span>
		<span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">XFS_QMOPT_PQUOTA</span> <span class="o">?</span> <span class="n">XFS_DQ_PROJ</span> <span class="o">:</span> <span class="n">XFS_DQ_GROUP</span><span class="p">);</span>
	<span class="n">error</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Blkcnt arg can be a very big number, and might even be</span>
<span class="cm">	 * larger than the log itself. So, we have to break it up into</span>
<span class="cm">	 * manageable-sized transactions.</span>
<span class="cm">	 * Note that we don&#39;t start a permanent transaction here; we might</span>
<span class="cm">	 * not be able to get a log reservation for the whole thing up front,</span>
<span class="cm">	 * and we don&#39;t really care to either, because we just discard</span>
<span class="cm">	 * everything if we were to crash in the middle of this loop.</span>
<span class="cm">	 */</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">blkcnt</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">error</span> <span class="o">=</span> <span class="n">xfs_trans_read_buf</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_ddev_targp</span><span class="p">,</span>
			      <span class="n">XFS_FSB_TO_DADDR</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="n">bno</span><span class="p">),</span>
			      <span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_quotainfo</span><span class="o">-&gt;</span><span class="n">qi_dqchunklen</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bp</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">xfs_qm_reset_dqcounts</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="n">bp</span><span class="p">,</span> <span class="n">firstid</span><span class="p">,</span> <span class="n">type</span><span class="p">);</span>
		<span class="n">xfs_buf_delwri_queue</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">buffer_list</span><span class="p">);</span>
		<span class="n">xfs_buf_relse</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>
		<span class="cm">/*</span>
<span class="cm">		 * goto the next block.</span>
<span class="cm">		 */</span>
		<span class="n">bno</span><span class="o">++</span><span class="p">;</span>
		<span class="n">firstid</span> <span class="o">+=</span> <span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_quotainfo</span><span class="o">-&gt;</span><span class="n">qi_dqperchunk</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Iterate over all allocated USR/GRP/PRJ dquots in the system, calling a</span>
<span class="cm"> * caller supplied function for every chunk of dquots that we find.</span>
<span class="cm"> */</span>
<span class="n">STATIC</span> <span class="kt">int</span>
<span class="nf">xfs_qm_dqiterate</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">xfs_mount</span>	<span class="o">*</span><span class="n">mp</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">xfs_inode</span>	<span class="o">*</span><span class="n">qip</span><span class="p">,</span>
	<span class="n">uint</span>			<span class="n">flags</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">list_head</span>	<span class="o">*</span><span class="n">buffer_list</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">xfs_bmbt_irec</span>	<span class="o">*</span><span class="n">map</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">i</span><span class="p">,</span> <span class="n">nmaps</span><span class="p">;</span>	<span class="cm">/* number of map entries */</span>
	<span class="kt">int</span>			<span class="n">error</span><span class="p">;</span>		<span class="cm">/* return value */</span>
	<span class="n">xfs_fileoff_t</span>		<span class="n">lblkno</span><span class="p">;</span>
	<span class="n">xfs_filblks_t</span>		<span class="n">maxlblkcnt</span><span class="p">;</span>
	<span class="n">xfs_dqid_t</span>		<span class="n">firstid</span><span class="p">;</span>
	<span class="n">xfs_fsblock_t</span>		<span class="n">rablkno</span><span class="p">;</span>
	<span class="n">xfs_filblks_t</span>		<span class="n">rablkcnt</span><span class="p">;</span>

	<span class="n">error</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * This looks racy, but we can&#39;t keep an inode lock across a</span>
<span class="cm">	 * trans_reserve. But, this gets called during quotacheck, and that</span>
<span class="cm">	 * happens only at mount time which is single threaded.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">qip</span><span class="o">-&gt;</span><span class="n">i_d</span><span class="p">.</span><span class="n">di_nblocks</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">map</span> <span class="o">=</span> <span class="n">kmem_alloc</span><span class="p">(</span><span class="n">XFS_DQITER_MAP_SIZE</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">map</span><span class="p">),</span> <span class="n">KM_SLEEP</span><span class="p">);</span>

	<span class="n">lblkno</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">maxlblkcnt</span> <span class="o">=</span> <span class="n">XFS_B_TO_FSB</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="p">(</span><span class="n">xfs_ufsize_t</span><span class="p">)</span><span class="n">XFS_MAXIOFFSET</span><span class="p">(</span><span class="n">mp</span><span class="p">));</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="n">nmaps</span> <span class="o">=</span> <span class="n">XFS_DQITER_MAP_SIZE</span><span class="p">;</span>
		<span class="cm">/*</span>
<span class="cm">		 * We aren&#39;t changing the inode itself. Just changing</span>
<span class="cm">		 * some of its data. No new blocks are added here, and</span>
<span class="cm">		 * the inode is never added to the transaction.</span>
<span class="cm">		 */</span>
		<span class="n">xfs_ilock</span><span class="p">(</span><span class="n">qip</span><span class="p">,</span> <span class="n">XFS_ILOCK_SHARED</span><span class="p">);</span>
		<span class="n">error</span> <span class="o">=</span> <span class="n">xfs_bmapi_read</span><span class="p">(</span><span class="n">qip</span><span class="p">,</span> <span class="n">lblkno</span><span class="p">,</span> <span class="n">maxlblkcnt</span> <span class="o">-</span> <span class="n">lblkno</span><span class="p">,</span>
				       <span class="n">map</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">nmaps</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">xfs_iunlock</span><span class="p">(</span><span class="n">qip</span><span class="p">,</span> <span class="n">XFS_ILOCK_SHARED</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">ASSERT</span><span class="p">(</span><span class="n">nmaps</span> <span class="o">&lt;=</span> <span class="n">XFS_DQITER_MAP_SIZE</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">nmaps</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ASSERT</span><span class="p">(</span><span class="n">map</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">br_startblock</span> <span class="o">!=</span> <span class="n">DELAYSTARTBLOCK</span><span class="p">);</span>
			<span class="n">ASSERT</span><span class="p">(</span><span class="n">map</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">br_blockcount</span><span class="p">);</span>


			<span class="n">lblkno</span> <span class="o">+=</span> <span class="n">map</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">br_blockcount</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">map</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">br_startblock</span> <span class="o">==</span> <span class="n">HOLESTARTBLOCK</span><span class="p">)</span>
				<span class="k">continue</span><span class="p">;</span>

			<span class="n">firstid</span> <span class="o">=</span> <span class="p">(</span><span class="n">xfs_dqid_t</span><span class="p">)</span> <span class="n">map</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">br_startoff</span> <span class="o">*</span>
				<span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_quotainfo</span><span class="o">-&gt;</span><span class="n">qi_dqperchunk</span><span class="p">;</span>
			<span class="cm">/*</span>
<span class="cm">			 * Do a read-ahead on the next extent.</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span> <span class="o">&lt;</span> <span class="n">nmaps</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			    <span class="p">(</span><span class="n">map</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">].</span><span class="n">br_startblock</span> <span class="o">!=</span> <span class="n">HOLESTARTBLOCK</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">rablkcnt</span> <span class="o">=</span>  <span class="n">map</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">].</span><span class="n">br_blockcount</span><span class="p">;</span>
				<span class="n">rablkno</span> <span class="o">=</span> <span class="n">map</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">].</span><span class="n">br_startblock</span><span class="p">;</span>
				<span class="k">while</span> <span class="p">(</span><span class="n">rablkcnt</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">xfs_buf_readahead</span><span class="p">(</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_ddev_targp</span><span class="p">,</span>
					       <span class="n">XFS_FSB_TO_DADDR</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="n">rablkno</span><span class="p">),</span>
					       <span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_quotainfo</span><span class="o">-&gt;</span><span class="n">qi_dqchunklen</span><span class="p">);</span>
					<span class="n">rablkno</span><span class="o">++</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="cm">/*</span>
<span class="cm">			 * Iterate thru all the blks in the extent and</span>
<span class="cm">			 * reset the counters of all the dquots inside them.</span>
<span class="cm">			 */</span>
			<span class="n">error</span> <span class="o">=</span> <span class="n">xfs_qm_dqiter_bufs</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="n">firstid</span><span class="p">,</span>
						   <span class="n">map</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">br_startblock</span><span class="p">,</span>
						   <span class="n">map</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">br_blockcount</span><span class="p">,</span>
						   <span class="n">flags</span><span class="p">,</span> <span class="n">buffer_list</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">nmaps</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">);</span>

<span class="nl">out:</span>
	<span class="n">kmem_free</span><span class="p">(</span><span class="n">map</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Called by dqusage_adjust in doing a quotacheck.</span>
<span class="cm"> *</span>
<span class="cm"> * Given the inode, and a dquot id this updates both the incore dqout as well</span>
<span class="cm"> * as the buffer copy. This is so that once the quotacheck is done, we can</span>
<span class="cm"> * just log all the buffers, as opposed to logging numerous updates to</span>
<span class="cm"> * individual dquots.</span>
<span class="cm"> */</span>
<span class="n">STATIC</span> <span class="kt">int</span>
<span class="nf">xfs_qm_quotacheck_dqadjust</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">xfs_inode</span>	<span class="o">*</span><span class="n">ip</span><span class="p">,</span>
	<span class="n">xfs_dqid_t</span>		<span class="n">id</span><span class="p">,</span>
	<span class="n">uint</span>			<span class="n">type</span><span class="p">,</span>
	<span class="n">xfs_qcnt_t</span>		<span class="n">nblks</span><span class="p">,</span>
	<span class="n">xfs_qcnt_t</span>		<span class="n">rtblks</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">xfs_mount</span>	<span class="o">*</span><span class="n">mp</span> <span class="o">=</span> <span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_mount</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">xfs_dquot</span>	<span class="o">*</span><span class="n">dqp</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">error</span><span class="p">;</span>

	<span class="n">error</span> <span class="o">=</span> <span class="n">xfs_qm_dqget</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="n">ip</span><span class="p">,</span> <span class="n">id</span><span class="p">,</span> <span class="n">type</span><span class="p">,</span>
			     <span class="n">XFS_QMOPT_DQALLOC</span> <span class="o">|</span> <span class="n">XFS_QMOPT_DOWARN</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dqp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Shouldn&#39;t be able to turn off quotas here.</span>
<span class="cm">		 */</span>
		<span class="n">ASSERT</span><span class="p">(</span><span class="n">error</span> <span class="o">!=</span> <span class="n">ESRCH</span><span class="p">);</span>
		<span class="n">ASSERT</span><span class="p">(</span><span class="n">error</span> <span class="o">!=</span> <span class="n">ENOENT</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">trace_xfs_dqadjust</span><span class="p">(</span><span class="n">dqp</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Adjust the inode count and the block count to reflect this inode&#39;s</span>
<span class="cm">	 * resource usage.</span>
<span class="cm">	 */</span>
	<span class="n">be64_add_cpu</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dqp</span><span class="o">-&gt;</span><span class="n">q_core</span><span class="p">.</span><span class="n">d_icount</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">dqp</span><span class="o">-&gt;</span><span class="n">q_res_icount</span><span class="o">++</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nblks</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">be64_add_cpu</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dqp</span><span class="o">-&gt;</span><span class="n">q_core</span><span class="p">.</span><span class="n">d_bcount</span><span class="p">,</span> <span class="n">nblks</span><span class="p">);</span>
		<span class="n">dqp</span><span class="o">-&gt;</span><span class="n">q_res_bcount</span> <span class="o">+=</span> <span class="n">nblks</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rtblks</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">be64_add_cpu</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dqp</span><span class="o">-&gt;</span><span class="n">q_core</span><span class="p">.</span><span class="n">d_rtbcount</span><span class="p">,</span> <span class="n">rtblks</span><span class="p">);</span>
		<span class="n">dqp</span><span class="o">-&gt;</span><span class="n">q_res_rtbcount</span> <span class="o">+=</span> <span class="n">rtblks</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Set default limits, adjust timers (since we changed usages)</span>
<span class="cm">	 *</span>
<span class="cm">	 * There are no timers for the default values set in the root dquot.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dqp</span><span class="o">-&gt;</span><span class="n">q_core</span><span class="p">.</span><span class="n">d_id</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">xfs_qm_adjust_dqlimits</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dqp</span><span class="o">-&gt;</span><span class="n">q_core</span><span class="p">);</span>
		<span class="n">xfs_qm_adjust_dqtimers</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dqp</span><span class="o">-&gt;</span><span class="n">q_core</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">dqp</span><span class="o">-&gt;</span><span class="n">dq_flags</span> <span class="o">|=</span> <span class="n">XFS_DQ_DIRTY</span><span class="p">;</span>
	<span class="n">xfs_qm_dqput</span><span class="p">(</span><span class="n">dqp</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">STATIC</span> <span class="kt">int</span>
<span class="nf">xfs_qm_get_rtblks</span><span class="p">(</span>
	<span class="n">xfs_inode_t</span>	<span class="o">*</span><span class="n">ip</span><span class="p">,</span>
	<span class="n">xfs_qcnt_t</span>	<span class="o">*</span><span class="n">O_rtblks</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">xfs_filblks_t</span>	<span class="n">rtblks</span><span class="p">;</span>			<span class="cm">/* total rt blks */</span>
	<span class="n">xfs_extnum_t</span>	<span class="n">idx</span><span class="p">;</span>			<span class="cm">/* extent record index */</span>
	<span class="n">xfs_ifork_t</span>	<span class="o">*</span><span class="n">ifp</span><span class="p">;</span>			<span class="cm">/* inode fork pointer */</span>
	<span class="n">xfs_extnum_t</span>	<span class="n">nextents</span><span class="p">;</span>		<span class="cm">/* number of extent entries */</span>
	<span class="kt">int</span>		<span class="n">error</span><span class="p">;</span>

	<span class="n">ASSERT</span><span class="p">(</span><span class="n">XFS_IS_REALTIME_INODE</span><span class="p">(</span><span class="n">ip</span><span class="p">));</span>
	<span class="n">ifp</span> <span class="o">=</span> <span class="n">XFS_IFORK_PTR</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">XFS_DATA_FORK</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ifp</span><span class="o">-&gt;</span><span class="n">if_flags</span> <span class="o">&amp;</span> <span class="n">XFS_IFEXTENTS</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">error</span> <span class="o">=</span> <span class="n">xfs_iread_extents</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">ip</span><span class="p">,</span> <span class="n">XFS_DATA_FORK</span><span class="p">)))</span>
			<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">rtblks</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">nextents</span> <span class="o">=</span> <span class="n">ifp</span><span class="o">-&gt;</span><span class="n">if_bytes</span> <span class="o">/</span> <span class="p">(</span><span class="n">uint</span><span class="p">)</span><span class="k">sizeof</span><span class="p">(</span><span class="n">xfs_bmbt_rec_t</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="n">nextents</span><span class="p">;</span> <span class="n">idx</span><span class="o">++</span><span class="p">)</span>
		<span class="n">rtblks</span> <span class="o">+=</span> <span class="n">xfs_bmbt_get_blockcount</span><span class="p">(</span><span class="n">xfs_iext_get_ext</span><span class="p">(</span><span class="n">ifp</span><span class="p">,</span> <span class="n">idx</span><span class="p">));</span>
	<span class="o">*</span><span class="n">O_rtblks</span> <span class="o">=</span> <span class="p">(</span><span class="n">xfs_qcnt_t</span><span class="p">)</span><span class="n">rtblks</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * callback routine supplied to bulkstat(). Given an inumber, find its</span>
<span class="cm"> * dquots and update them to account for resources taken by that inode.</span>
<span class="cm"> */</span>
<span class="cm">/* ARGSUSED */</span>
<span class="n">STATIC</span> <span class="kt">int</span>
<span class="nf">xfs_qm_dqusage_adjust</span><span class="p">(</span>
	<span class="n">xfs_mount_t</span>	<span class="o">*</span><span class="n">mp</span><span class="p">,</span>		<span class="cm">/* mount point for filesystem */</span>
	<span class="n">xfs_ino_t</span>	<span class="n">ino</span><span class="p">,</span>		<span class="cm">/* inode number to get data for */</span>
	<span class="kt">void</span>		<span class="n">__user</span> <span class="o">*</span><span class="n">buffer</span><span class="p">,</span>	<span class="cm">/* not used */</span>
	<span class="kt">int</span>		<span class="n">ubsize</span><span class="p">,</span>		<span class="cm">/* not used */</span>
	<span class="kt">int</span>		<span class="o">*</span><span class="n">ubused</span><span class="p">,</span>	<span class="cm">/* not used */</span>
	<span class="kt">int</span>		<span class="o">*</span><span class="n">res</span><span class="p">)</span>		<span class="cm">/* result code value */</span>
<span class="p">{</span>
	<span class="n">xfs_inode_t</span>	<span class="o">*</span><span class="n">ip</span><span class="p">;</span>
	<span class="n">xfs_qcnt_t</span>	<span class="n">nblks</span><span class="p">,</span> <span class="n">rtblks</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span>		<span class="n">error</span><span class="p">;</span>

	<span class="n">ASSERT</span><span class="p">(</span><span class="n">XFS_IS_QUOTA_RUNNING</span><span class="p">(</span><span class="n">mp</span><span class="p">));</span>

	<span class="cm">/*</span>
<span class="cm">	 * rootino must have its resources accounted for, not so with the quota</span>
<span class="cm">	 * inodes.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ino</span> <span class="o">==</span> <span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_sb</span><span class="p">.</span><span class="n">sb_uquotino</span> <span class="o">||</span> <span class="n">ino</span> <span class="o">==</span> <span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_sb</span><span class="p">.</span><span class="n">sb_gquotino</span><span class="p">)</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">res</span> <span class="o">=</span> <span class="n">BULKSTAT_RV_NOTHING</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">XFS_ERROR</span><span class="p">(</span><span class="n">EINVAL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * We don&#39;t _need_ to take the ilock EXCL. However, the xfs_qm_dqget</span>
<span class="cm">	 * interface expects the inode to be exclusively locked because that&#39;s</span>
<span class="cm">	 * the case in all other instances. It&#39;s OK that we do this because</span>
<span class="cm">	 * quotacheck is done only at mount time.</span>
<span class="cm">	 */</span>
	<span class="n">error</span> <span class="o">=</span> <span class="n">xfs_iget</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">ino</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">XFS_ILOCK_EXCL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ip</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">res</span> <span class="o">=</span> <span class="n">BULKSTAT_RV_NOTHING</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ASSERT</span><span class="p">(</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_delayed_blks</span> <span class="o">==</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">XFS_IS_REALTIME_INODE</span><span class="p">(</span><span class="n">ip</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Walk thru the extent list and count the realtime blocks.</span>
<span class="cm">		 */</span>
		<span class="n">error</span> <span class="o">=</span> <span class="n">xfs_qm_get_rtblks</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rtblks</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">error0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">nblks</span> <span class="o">=</span> <span class="p">(</span><span class="n">xfs_qcnt_t</span><span class="p">)</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_d</span><span class="p">.</span><span class="n">di_nblocks</span> <span class="o">-</span> <span class="n">rtblks</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Add the (disk blocks and inode) resources occupied by this</span>
<span class="cm">	 * inode to its dquots. We do this adjustment in the incore dquot,</span>
<span class="cm">	 * and also copy the changes to its buffer.</span>
<span class="cm">	 * We don&#39;t care about putting these changes in a transaction</span>
<span class="cm">	 * envelope because if we crash in the middle of a &#39;quotacheck&#39;</span>
<span class="cm">	 * we have to start from the beginning anyway.</span>
<span class="cm">	 * Once we&#39;re done, we&#39;ll log all the dquot bufs.</span>
<span class="cm">	 *</span>
<span class="cm">	 * The *QUOTA_ON checks below may look pretty racy, but quotachecks</span>
<span class="cm">	 * and quotaoffs don&#39;t race. (Quotachecks happen at mount time only).</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">XFS_IS_UQUOTA_ON</span><span class="p">(</span><span class="n">mp</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">error</span> <span class="o">=</span> <span class="n">xfs_qm_quotacheck_dqadjust</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_d</span><span class="p">.</span><span class="n">di_uid</span><span class="p">,</span>
						   <span class="n">XFS_DQ_USER</span><span class="p">,</span> <span class="n">nblks</span><span class="p">,</span> <span class="n">rtblks</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">error0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">XFS_IS_GQUOTA_ON</span><span class="p">(</span><span class="n">mp</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">error</span> <span class="o">=</span> <span class="n">xfs_qm_quotacheck_dqadjust</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_d</span><span class="p">.</span><span class="n">di_gid</span><span class="p">,</span>
						   <span class="n">XFS_DQ_GROUP</span><span class="p">,</span> <span class="n">nblks</span><span class="p">,</span> <span class="n">rtblks</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">error0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">XFS_IS_PQUOTA_ON</span><span class="p">(</span><span class="n">mp</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">error</span> <span class="o">=</span> <span class="n">xfs_qm_quotacheck_dqadjust</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">xfs_get_projid</span><span class="p">(</span><span class="n">ip</span><span class="p">),</span>
						   <span class="n">XFS_DQ_PROJ</span><span class="p">,</span> <span class="n">nblks</span><span class="p">,</span> <span class="n">rtblks</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">error0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">xfs_iunlock</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">XFS_ILOCK_EXCL</span><span class="p">);</span>
	<span class="n">IRELE</span><span class="p">(</span><span class="n">ip</span><span class="p">);</span>
	<span class="o">*</span><span class="n">res</span> <span class="o">=</span> <span class="n">BULKSTAT_RV_DIDONE</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">error0:</span>
	<span class="n">xfs_iunlock</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">XFS_ILOCK_EXCL</span><span class="p">);</span>
	<span class="n">IRELE</span><span class="p">(</span><span class="n">ip</span><span class="p">);</span>
	<span class="o">*</span><span class="n">res</span> <span class="o">=</span> <span class="n">BULKSTAT_RV_GIVEUP</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">STATIC</span> <span class="kt">int</span>
<span class="nf">xfs_qm_flush_one</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">xfs_dquot</span>	<span class="o">*</span><span class="n">dqp</span><span class="p">,</span>
	<span class="kt">void</span>			<span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">list_head</span>	<span class="o">*</span><span class="n">buffer_list</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">xfs_buf</span>		<span class="o">*</span><span class="n">bp</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">error</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">xfs_dqlock</span><span class="p">(</span><span class="n">dqp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dqp</span><span class="o">-&gt;</span><span class="n">dq_flags</span> <span class="o">&amp;</span> <span class="n">XFS_DQ_FREEING</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_unlock</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">XFS_DQ_IS_DIRTY</span><span class="p">(</span><span class="n">dqp</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out_unlock</span><span class="p">;</span>

	<span class="n">xfs_dqflock</span><span class="p">(</span><span class="n">dqp</span><span class="p">);</span>
	<span class="n">error</span> <span class="o">=</span> <span class="n">xfs_qm_dqflush</span><span class="p">(</span><span class="n">dqp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_unlock</span><span class="p">;</span>

	<span class="n">xfs_buf_delwri_queue</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">buffer_list</span><span class="p">);</span>
	<span class="n">xfs_buf_relse</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>
<span class="nl">out_unlock:</span>
	<span class="n">xfs_dqunlock</span><span class="p">(</span><span class="n">dqp</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Walk thru all the filesystem inodes and construct a consistent view</span>
<span class="cm"> * of the disk quota world. If the quotacheck fails, disable quotas.</span>
<span class="cm"> */</span>
<span class="kt">int</span>
<span class="nf">xfs_qm_quotacheck</span><span class="p">(</span>
	<span class="n">xfs_mount_t</span>	<span class="o">*</span><span class="n">mp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span>		<span class="n">done</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">error</span><span class="p">,</span> <span class="n">error2</span><span class="p">;</span>
	<span class="n">xfs_ino_t</span>	<span class="n">lastino</span><span class="p">;</span>
	<span class="kt">size_t</span>		<span class="n">structsz</span><span class="p">;</span>
	<span class="n">xfs_inode_t</span>	<span class="o">*</span><span class="n">uip</span><span class="p">,</span> <span class="o">*</span><span class="n">gip</span><span class="p">;</span>
	<span class="n">uint</span>		<span class="n">flags</span><span class="p">;</span>
	<span class="n">LIST_HEAD</span>	<span class="p">(</span><span class="n">buffer_list</span><span class="p">);</span>

	<span class="n">count</span> <span class="o">=</span> <span class="n">INT_MAX</span><span class="p">;</span>
	<span class="n">structsz</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">lastino</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">ASSERT</span><span class="p">(</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_quotainfo</span><span class="o">-&gt;</span><span class="n">qi_uquotaip</span> <span class="o">||</span> <span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_quotainfo</span><span class="o">-&gt;</span><span class="n">qi_gquotaip</span><span class="p">);</span>
	<span class="n">ASSERT</span><span class="p">(</span><span class="n">XFS_IS_QUOTA_RUNNING</span><span class="p">(</span><span class="n">mp</span><span class="p">));</span>

	<span class="n">xfs_notice</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="s">&quot;Quotacheck needed: Please wait.&quot;</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * First we go thru all the dquots on disk, USR and GRP/PRJ, and reset</span>
<span class="cm">	 * their counters to zero. We need a clean slate.</span>
<span class="cm">	 * We don&#39;t log our changes till later.</span>
<span class="cm">	 */</span>
	<span class="n">uip</span> <span class="o">=</span> <span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_quotainfo</span><span class="o">-&gt;</span><span class="n">qi_uquotaip</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">uip</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">error</span> <span class="o">=</span> <span class="n">xfs_qm_dqiterate</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="n">uip</span><span class="p">,</span> <span class="n">XFS_QMOPT_UQUOTA</span><span class="p">,</span>
					 <span class="o">&amp;</span><span class="n">buffer_list</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">error_return</span><span class="p">;</span>
		<span class="n">flags</span> <span class="o">|=</span> <span class="n">XFS_UQUOTA_CHKD</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">gip</span> <span class="o">=</span> <span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_quotainfo</span><span class="o">-&gt;</span><span class="n">qi_gquotaip</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">gip</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">error</span> <span class="o">=</span> <span class="n">xfs_qm_dqiterate</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="n">gip</span><span class="p">,</span> <span class="n">XFS_IS_GQUOTA_ON</span><span class="p">(</span><span class="n">mp</span><span class="p">)</span> <span class="o">?</span>
					 <span class="n">XFS_QMOPT_GQUOTA</span> <span class="o">:</span> <span class="n">XFS_QMOPT_PQUOTA</span><span class="p">,</span>
					 <span class="o">&amp;</span><span class="n">buffer_list</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">error_return</span><span class="p">;</span>
		<span class="n">flags</span> <span class="o">|=</span> <span class="n">XFS_OQUOTA_CHKD</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Iterate thru all the inodes in the file system,</span>
<span class="cm">		 * adjusting the corresponding dquot counters in core.</span>
<span class="cm">		 */</span>
		<span class="n">error</span> <span class="o">=</span> <span class="n">xfs_bulkstat</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">lastino</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">count</span><span class="p">,</span>
				     <span class="n">xfs_qm_dqusage_adjust</span><span class="p">,</span>
				     <span class="n">structsz</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">done</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">done</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * We&#39;ve made all the changes that we need to make incore.  Flush them</span>
<span class="cm">	 * down to disk buffers if everything was updated successfully.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">XFS_IS_UQUOTA_ON</span><span class="p">(</span><span class="n">mp</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">error</span> <span class="o">=</span> <span class="n">xfs_qm_dquot_walk</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="n">XFS_DQ_USER</span><span class="p">,</span> <span class="n">xfs_qm_flush_one</span><span class="p">,</span>
					  <span class="o">&amp;</span><span class="n">buffer_list</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">XFS_IS_GQUOTA_ON</span><span class="p">(</span><span class="n">mp</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">error2</span> <span class="o">=</span> <span class="n">xfs_qm_dquot_walk</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="n">XFS_DQ_GROUP</span><span class="p">,</span> <span class="n">xfs_qm_flush_one</span><span class="p">,</span>
					   <span class="o">&amp;</span><span class="n">buffer_list</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">error</span><span class="p">)</span>
			<span class="n">error</span> <span class="o">=</span> <span class="n">error2</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">XFS_IS_PQUOTA_ON</span><span class="p">(</span><span class="n">mp</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">error2</span> <span class="o">=</span> <span class="n">xfs_qm_dquot_walk</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="n">XFS_DQ_PROJ</span><span class="p">,</span> <span class="n">xfs_qm_flush_one</span><span class="p">,</span>
					   <span class="o">&amp;</span><span class="n">buffer_list</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">error</span><span class="p">)</span>
			<span class="n">error</span> <span class="o">=</span> <span class="n">error2</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">error2</span> <span class="o">=</span> <span class="n">xfs_buf_delwri_submit</span><span class="p">(</span><span class="o">&amp;</span><span class="n">buffer_list</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">error</span><span class="p">)</span>
		<span class="n">error</span> <span class="o">=</span> <span class="n">error2</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * We can get this error if we couldn&#39;t do a dquot allocation inside</span>
<span class="cm">	 * xfs_qm_dqusage_adjust (via bulkstat). We don&#39;t care about the</span>
<span class="cm">	 * dirty dquots that might be cached, we just want to get rid of them</span>
<span class="cm">	 * and turn quotaoff. The dquots won&#39;t be attached to any of the inodes</span>
<span class="cm">	 * at this point (because we intentionally didn&#39;t in dqget_noattach).</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">xfs_qm_dqpurge_all</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="n">XFS_QMOPT_QUOTALL</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">error_return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * If one type of quotas is off, then it will lose its</span>
<span class="cm">	 * quotachecked status, since we won&#39;t be doing accounting for</span>
<span class="cm">	 * that type anymore.</span>
<span class="cm">	 */</span>
	<span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_qflags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">XFS_ALL_QUOTA_CHKD</span><span class="p">;</span>
	<span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_qflags</span> <span class="o">|=</span> <span class="n">flags</span><span class="p">;</span>

 <span class="nl">error_return:</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">buffer_list</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">xfs_buf</span> <span class="o">*</span><span class="n">bp</span> <span class="o">=</span>
			<span class="n">list_first_entry</span><span class="p">(</span><span class="o">&amp;</span><span class="n">buffer_list</span><span class="p">,</span> <span class="k">struct</span> <span class="n">xfs_buf</span><span class="p">,</span> <span class="n">b_list</span><span class="p">);</span>
		<span class="n">list_del_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">b_list</span><span class="p">);</span>
		<span class="n">xfs_buf_relse</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">xfs_warn</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span>
	<span class="s">&quot;Quotacheck: Unsuccessful (Error %d): Disabling quotas.&quot;</span><span class="p">,</span>
			<span class="n">error</span><span class="p">);</span>
		<span class="cm">/*</span>
<span class="cm">		 * We must turn off quotas.</span>
<span class="cm">		 */</span>
		<span class="n">ASSERT</span><span class="p">(</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_quotainfo</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="n">xfs_qm_destroy_quotainfo</span><span class="p">(</span><span class="n">mp</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">xfs_mount_reset_sbqflags</span><span class="p">(</span><span class="n">mp</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">xfs_warn</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span>
				<span class="s">&quot;Quotacheck: Failed to reset quota flags.&quot;</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">xfs_notice</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="s">&quot;Quotacheck: Done.&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">error</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * This is called after the superblock has been read in and we&#39;re ready to</span>
<span class="cm"> * iget the quota inodes.</span>
<span class="cm"> */</span>
<span class="n">STATIC</span> <span class="kt">int</span>
<span class="nf">xfs_qm_init_quotainos</span><span class="p">(</span>
	<span class="n">xfs_mount_t</span>	<span class="o">*</span><span class="n">mp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">xfs_inode_t</span>	<span class="o">*</span><span class="n">uip</span><span class="p">,</span> <span class="o">*</span><span class="n">gip</span><span class="p">;</span>
	<span class="kt">int</span>		<span class="n">error</span><span class="p">;</span>
	<span class="n">__int64_t</span>	<span class="n">sbflags</span><span class="p">;</span>
	<span class="n">uint</span>		<span class="n">flags</span><span class="p">;</span>

	<span class="n">ASSERT</span><span class="p">(</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_quotainfo</span><span class="p">);</span>
	<span class="n">uip</span> <span class="o">=</span> <span class="n">gip</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">sbflags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Get the uquota and gquota inodes</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">xfs_sb_version_hasquota</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_sb</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">XFS_IS_UQUOTA_ON</span><span class="p">(</span><span class="n">mp</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_sb</span><span class="p">.</span><span class="n">sb_uquotino</span> <span class="o">!=</span> <span class="n">NULLFSINO</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ASSERT</span><span class="p">(</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_sb</span><span class="p">.</span><span class="n">sb_uquotino</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">error</span> <span class="o">=</span> <span class="n">xfs_iget</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_sb</span><span class="p">.</span><span class="n">sb_uquotino</span><span class="p">,</span>
					     <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">uip</span><span class="p">)))</span>
				<span class="k">return</span> <span class="n">XFS_ERROR</span><span class="p">(</span><span class="n">error</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">XFS_IS_OQUOTA_ON</span><span class="p">(</span><span class="n">mp</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_sb</span><span class="p">.</span><span class="n">sb_gquotino</span> <span class="o">!=</span> <span class="n">NULLFSINO</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ASSERT</span><span class="p">(</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_sb</span><span class="p">.</span><span class="n">sb_gquotino</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">error</span> <span class="o">=</span> <span class="n">xfs_iget</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_sb</span><span class="p">.</span><span class="n">sb_gquotino</span><span class="p">,</span>
					     <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">gip</span><span class="p">)))</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">uip</span><span class="p">)</span>
					<span class="n">IRELE</span><span class="p">(</span><span class="n">uip</span><span class="p">);</span>
				<span class="k">return</span> <span class="n">XFS_ERROR</span><span class="p">(</span><span class="n">error</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">flags</span> <span class="o">|=</span> <span class="n">XFS_QMOPT_SBVERSION</span><span class="p">;</span>
		<span class="n">sbflags</span> <span class="o">|=</span> <span class="p">(</span><span class="n">XFS_SB_VERSIONNUM</span> <span class="o">|</span> <span class="n">XFS_SB_UQUOTINO</span> <span class="o">|</span>
			    <span class="n">XFS_SB_GQUOTINO</span> <span class="o">|</span> <span class="n">XFS_SB_QFLAGS</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Create the two inodes, if they don&#39;t exist already. The changes</span>
<span class="cm">	 * made above will get added to a transaction and logged in one of</span>
<span class="cm">	 * the qino_alloc calls below.  If the device is readonly,</span>
<span class="cm">	 * temporarily switch to read-write to do this.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">XFS_IS_UQUOTA_ON</span><span class="p">(</span><span class="n">mp</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">uip</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">error</span> <span class="o">=</span> <span class="n">xfs_qm_qino_alloc</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">uip</span><span class="p">,</span>
					      <span class="n">sbflags</span> <span class="o">|</span> <span class="n">XFS_SB_UQUOTINO</span><span class="p">,</span>
					      <span class="n">flags</span> <span class="o">|</span> <span class="n">XFS_QMOPT_UQUOTA</span><span class="p">)))</span>
			<span class="k">return</span> <span class="n">XFS_ERROR</span><span class="p">(</span><span class="n">error</span><span class="p">);</span>

		<span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">XFS_QMOPT_SBVERSION</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">XFS_IS_OQUOTA_ON</span><span class="p">(</span><span class="n">mp</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">gip</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">flags</span> <span class="o">|=</span> <span class="p">(</span><span class="n">XFS_IS_GQUOTA_ON</span><span class="p">(</span><span class="n">mp</span><span class="p">)</span> <span class="o">?</span>
				<span class="n">XFS_QMOPT_GQUOTA</span> <span class="o">:</span> <span class="n">XFS_QMOPT_PQUOTA</span><span class="p">);</span>
		<span class="n">error</span> <span class="o">=</span> <span class="n">xfs_qm_qino_alloc</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">gip</span><span class="p">,</span>
					  <span class="n">sbflags</span> <span class="o">|</span> <span class="n">XFS_SB_GQUOTINO</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">uip</span><span class="p">)</span>
				<span class="n">IRELE</span><span class="p">(</span><span class="n">uip</span><span class="p">);</span>

			<span class="k">return</span> <span class="n">XFS_ERROR</span><span class="p">(</span><span class="n">error</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_quotainfo</span><span class="o">-&gt;</span><span class="n">qi_uquotaip</span> <span class="o">=</span> <span class="n">uip</span><span class="p">;</span>
	<span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_quotainfo</span><span class="o">-&gt;</span><span class="n">qi_gquotaip</span> <span class="o">=</span> <span class="n">gip</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">STATIC</span> <span class="kt">void</span>
<span class="nf">xfs_qm_dqfree_one</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">xfs_dquot</span>	<span class="o">*</span><span class="n">dqp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">xfs_mount</span>	<span class="o">*</span><span class="n">mp</span> <span class="o">=</span> <span class="n">dqp</span><span class="o">-&gt;</span><span class="n">q_mount</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">xfs_quotainfo</span>	<span class="o">*</span><span class="n">qi</span> <span class="o">=</span> <span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_quotainfo</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qi</span><span class="o">-&gt;</span><span class="n">qi_tree_lock</span><span class="p">);</span>
	<span class="n">radix_tree_delete</span><span class="p">(</span><span class="n">XFS_DQUOT_TREE</span><span class="p">(</span><span class="n">qi</span><span class="p">,</span> <span class="n">dqp</span><span class="o">-&gt;</span><span class="n">q_core</span><span class="p">.</span><span class="n">d_flags</span><span class="p">),</span>
			  <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">dqp</span><span class="o">-&gt;</span><span class="n">q_core</span><span class="p">.</span><span class="n">d_id</span><span class="p">));</span>

	<span class="n">qi</span><span class="o">-&gt;</span><span class="n">qi_dquots</span><span class="o">--</span><span class="p">;</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qi</span><span class="o">-&gt;</span><span class="n">qi_tree_lock</span><span class="p">);</span>

	<span class="n">xfs_qm_dqdestroy</span><span class="p">(</span><span class="n">dqp</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">STATIC</span> <span class="kt">void</span>
<span class="nf">xfs_qm_dqreclaim_one</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">xfs_dquot</span>	<span class="o">*</span><span class="n">dqp</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">list_head</span>	<span class="o">*</span><span class="n">buffer_list</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">list_head</span>	<span class="o">*</span><span class="n">dispose_list</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">xfs_mount</span>	<span class="o">*</span><span class="n">mp</span> <span class="o">=</span> <span class="n">dqp</span><span class="o">-&gt;</span><span class="n">q_mount</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">xfs_quotainfo</span>	<span class="o">*</span><span class="n">qi</span> <span class="o">=</span> <span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_quotainfo</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">error</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">xfs_dqlock_nowait</span><span class="p">(</span><span class="n">dqp</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out_busy</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * This dquot has acquired a reference in the meantime remove it from</span>
<span class="cm">	 * the freelist and try again.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dqp</span><span class="o">-&gt;</span><span class="n">q_nrefs</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">xfs_dqunlock</span><span class="p">(</span><span class="n">dqp</span><span class="p">);</span>

		<span class="n">trace_xfs_dqreclaim_want</span><span class="p">(</span><span class="n">dqp</span><span class="p">);</span>
		<span class="n">XFS_STATS_INC</span><span class="p">(</span><span class="n">xs_qm_dqwants</span><span class="p">);</span>

		<span class="n">list_del_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dqp</span><span class="o">-&gt;</span><span class="n">q_lru</span><span class="p">);</span>
		<span class="n">qi</span><span class="o">-&gt;</span><span class="n">qi_lru_count</span><span class="o">--</span><span class="p">;</span>
		<span class="n">XFS_STATS_DEC</span><span class="p">(</span><span class="n">xs_qm_dquot_unused</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Try to grab the flush lock. If this dquot is in the process of</span>
<span class="cm">	 * getting flushed to disk, we don&#39;t want to reclaim it.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">xfs_dqflock_nowait</span><span class="p">(</span><span class="n">dqp</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out_busy</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">XFS_DQ_IS_DIRTY</span><span class="p">(</span><span class="n">dqp</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">xfs_buf</span>	<span class="o">*</span><span class="n">bp</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

		<span class="n">trace_xfs_dqreclaim_dirty</span><span class="p">(</span><span class="n">dqp</span><span class="p">);</span>

		<span class="n">error</span> <span class="o">=</span> <span class="n">xfs_qm_dqflush</span><span class="p">(</span><span class="n">dqp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bp</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">xfs_warn</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="s">&quot;%s: dquot %p flush failed&quot;</span><span class="p">,</span>
				 <span class="n">__func__</span><span class="p">,</span> <span class="n">dqp</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">out_busy</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">xfs_buf_delwri_queue</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">buffer_list</span><span class="p">);</span>
		<span class="n">xfs_buf_relse</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>
		<span class="cm">/*</span>
<span class="cm">		 * Give the dquot another try on the freelist, as the</span>
<span class="cm">		 * flushing will take some time.</span>
<span class="cm">		 */</span>
		<span class="k">goto</span> <span class="n">out_busy</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">xfs_dqfunlock</span><span class="p">(</span><span class="n">dqp</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Prevent lookups now that we are past the point of no return.</span>
<span class="cm">	 */</span>
	<span class="n">dqp</span><span class="o">-&gt;</span><span class="n">dq_flags</span> <span class="o">|=</span> <span class="n">XFS_DQ_FREEING</span><span class="p">;</span>
	<span class="n">xfs_dqunlock</span><span class="p">(</span><span class="n">dqp</span><span class="p">);</span>

	<span class="n">ASSERT</span><span class="p">(</span><span class="n">dqp</span><span class="o">-&gt;</span><span class="n">q_nrefs</span> <span class="o">==</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">list_move_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dqp</span><span class="o">-&gt;</span><span class="n">q_lru</span><span class="p">,</span> <span class="n">dispose_list</span><span class="p">);</span>
	<span class="n">qi</span><span class="o">-&gt;</span><span class="n">qi_lru_count</span><span class="o">--</span><span class="p">;</span>
	<span class="n">XFS_STATS_DEC</span><span class="p">(</span><span class="n">xs_qm_dquot_unused</span><span class="p">);</span>

	<span class="n">trace_xfs_dqreclaim_done</span><span class="p">(</span><span class="n">dqp</span><span class="p">);</span>
	<span class="n">XFS_STATS_INC</span><span class="p">(</span><span class="n">xs_qm_dqreclaims</span><span class="p">);</span>
	<span class="k">return</span><span class="p">;</span>

<span class="nl">out_busy:</span>
	<span class="n">xfs_dqunlock</span><span class="p">(</span><span class="n">dqp</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Move the dquot to the tail of the list so that we don&#39;t spin on it.</span>
<span class="cm">	 */</span>
	<span class="n">list_move_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dqp</span><span class="o">-&gt;</span><span class="n">q_lru</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">qi</span><span class="o">-&gt;</span><span class="n">qi_lru_list</span><span class="p">);</span>

	<span class="n">trace_xfs_dqreclaim_busy</span><span class="p">(</span><span class="n">dqp</span><span class="p">);</span>
	<span class="n">XFS_STATS_INC</span><span class="p">(</span><span class="n">xs_qm_dqreclaim_misses</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">STATIC</span> <span class="kt">int</span>
<span class="nf">xfs_qm_shake</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">shrinker</span>		<span class="o">*</span><span class="n">shrink</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">shrink_control</span>	<span class="o">*</span><span class="n">sc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">xfs_quotainfo</span>	<span class="o">*</span><span class="n">qi</span> <span class="o">=</span>
		<span class="n">container_of</span><span class="p">(</span><span class="n">shrink</span><span class="p">,</span> <span class="k">struct</span> <span class="n">xfs_quotainfo</span><span class="p">,</span> <span class="n">qi_shrinker</span><span class="p">);</span>
	<span class="kt">int</span>			<span class="n">nr_to_scan</span> <span class="o">=</span> <span class="n">sc</span><span class="o">-&gt;</span><span class="n">nr_to_scan</span><span class="p">;</span>
	<span class="n">LIST_HEAD</span>		<span class="p">(</span><span class="n">buffer_list</span><span class="p">);</span>
	<span class="n">LIST_HEAD</span>		<span class="p">(</span><span class="n">dispose_list</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">xfs_dquot</span>	<span class="o">*</span><span class="n">dqp</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">error</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">gfp_mask</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">__GFP_FS</span><span class="o">|</span><span class="n">__GFP_WAIT</span><span class="p">))</span> <span class="o">!=</span> <span class="p">(</span><span class="n">__GFP_FS</span><span class="o">|</span><span class="n">__GFP_WAIT</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">nr_to_scan</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qi</span><span class="o">-&gt;</span><span class="n">qi_lru_lock</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qi</span><span class="o">-&gt;</span><span class="n">qi_lru_list</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">nr_to_scan</span><span class="o">--</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">dqp</span> <span class="o">=</span> <span class="n">list_first_entry</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qi</span><span class="o">-&gt;</span><span class="n">qi_lru_list</span><span class="p">,</span> <span class="k">struct</span> <span class="n">xfs_dquot</span><span class="p">,</span>
				       <span class="n">q_lru</span><span class="p">);</span>
		<span class="n">xfs_qm_dqreclaim_one</span><span class="p">(</span><span class="n">dqp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">buffer_list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dispose_list</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qi</span><span class="o">-&gt;</span><span class="n">qi_lru_lock</span><span class="p">);</span>

	<span class="n">error</span> <span class="o">=</span> <span class="n">xfs_buf_delwri_submit</span><span class="p">(</span><span class="o">&amp;</span><span class="n">buffer_list</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
		<span class="n">xfs_warn</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;%s: dquot reclaim failed&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dispose_list</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dqp</span> <span class="o">=</span> <span class="n">list_first_entry</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dispose_list</span><span class="p">,</span> <span class="k">struct</span> <span class="n">xfs_dquot</span><span class="p">,</span> <span class="n">q_lru</span><span class="p">);</span>
		<span class="n">list_del_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dqp</span><span class="o">-&gt;</span><span class="n">q_lru</span><span class="p">);</span>
		<span class="n">xfs_qm_dqfree_one</span><span class="p">(</span><span class="n">dqp</span><span class="p">);</span>
	<span class="p">}</span>

<span class="nl">out:</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">qi</span><span class="o">-&gt;</span><span class="n">qi_lru_count</span> <span class="o">/</span> <span class="mi">100</span><span class="p">)</span> <span class="o">*</span> <span class="n">sysctl_vfs_cache_pressure</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Start a transaction and write the incore superblock changes to</span>
<span class="cm"> * disk. flags parameter indicates which fields have changed.</span>
<span class="cm"> */</span>
<span class="kt">int</span>
<span class="nf">xfs_qm_write_sb_changes</span><span class="p">(</span>
	<span class="n">xfs_mount_t</span>	<span class="o">*</span><span class="n">mp</span><span class="p">,</span>
	<span class="n">__int64_t</span>	<span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">xfs_trans_t</span>	<span class="o">*</span><span class="n">tp</span><span class="p">;</span>
	<span class="kt">int</span>		<span class="n">error</span><span class="p">;</span>

	<span class="n">tp</span> <span class="o">=</span> <span class="n">xfs_trans_alloc</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="n">XFS_TRANS_QM_SBCHANGE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">error</span> <span class="o">=</span> <span class="n">xfs_trans_reserve</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
				      <span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_sb</span><span class="p">.</span><span class="n">sb_sectsize</span> <span class="o">+</span> <span class="mi">128</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
				      <span class="mi">0</span><span class="p">,</span>
				      <span class="n">XFS_DEFAULT_LOG_COUNT</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">xfs_trans_cancel</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">xfs_mod_sb</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">error</span> <span class="o">=</span> <span class="n">xfs_trans_commit</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/* --------------- utility functions for vnodeops ---------------- */</span>


<span class="cm">/*</span>
<span class="cm"> * Given an inode, a uid, gid and prid make sure that we have</span>
<span class="cm"> * allocated relevant dquot(s) on disk, and that we won&#39;t exceed inode</span>
<span class="cm"> * quotas by creating this file.</span>
<span class="cm"> * This also attaches dquot(s) to the given inode after locking it,</span>
<span class="cm"> * and returns the dquots corresponding to the uid and/or gid.</span>
<span class="cm"> *</span>
<span class="cm"> * in	: inode (unlocked)</span>
<span class="cm"> * out	: udquot, gdquot with references taken and unlocked</span>
<span class="cm"> */</span>
<span class="kt">int</span>
<span class="nf">xfs_qm_vop_dqalloc</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">xfs_inode</span>	<span class="o">*</span><span class="n">ip</span><span class="p">,</span>
	<span class="n">uid_t</span>			<span class="n">uid</span><span class="p">,</span>
	<span class="n">gid_t</span>			<span class="n">gid</span><span class="p">,</span>
	<span class="n">prid_t</span>			<span class="n">prid</span><span class="p">,</span>
	<span class="n">uint</span>			<span class="n">flags</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">xfs_dquot</span>	<span class="o">**</span><span class="n">O_udqpp</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">xfs_dquot</span>	<span class="o">**</span><span class="n">O_gdqpp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">xfs_mount</span>	<span class="o">*</span><span class="n">mp</span> <span class="o">=</span> <span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_mount</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">xfs_dquot</span>	<span class="o">*</span><span class="n">uq</span><span class="p">,</span> <span class="o">*</span><span class="n">gq</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">error</span><span class="p">;</span>
	<span class="n">uint</span>			<span class="n">lockflags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">XFS_IS_QUOTA_RUNNING</span><span class="p">(</span><span class="n">mp</span><span class="p">)</span> <span class="o">||</span> <span class="o">!</span><span class="n">XFS_IS_QUOTA_ON</span><span class="p">(</span><span class="n">mp</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">lockflags</span> <span class="o">=</span> <span class="n">XFS_ILOCK_EXCL</span><span class="p">;</span>
	<span class="n">xfs_ilock</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">lockflags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">XFS_QMOPT_INHERIT</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">XFS_INHERIT_GID</span><span class="p">(</span><span class="n">ip</span><span class="p">))</span>
		<span class="n">gid</span> <span class="o">=</span> <span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_d</span><span class="p">.</span><span class="n">di_gid</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Attach the dquot(s) to this inode, doing a dquot allocation</span>
<span class="cm">	 * if necessary. The dquot(s) will not be locked.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">XFS_NOT_DQATTACHED</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="n">ip</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">error</span> <span class="o">=</span> <span class="n">xfs_qm_dqattach_locked</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">XFS_QMOPT_DQALLOC</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">xfs_iunlock</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">lockflags</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">uq</span> <span class="o">=</span> <span class="n">gq</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">XFS_QMOPT_UQUOTA</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">XFS_IS_UQUOTA_ON</span><span class="p">(</span><span class="n">mp</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_d</span><span class="p">.</span><span class="n">di_uid</span> <span class="o">!=</span> <span class="n">uid</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * What we need is the dquot that has this uid, and</span>
<span class="cm">			 * if we send the inode to dqget, the uid of the inode</span>
<span class="cm">			 * takes priority over what&#39;s sent in the uid argument.</span>
<span class="cm">			 * We must unlock inode here before calling dqget if</span>
<span class="cm">			 * we&#39;re not sending the inode, because otherwise</span>
<span class="cm">			 * we&#39;ll deadlock by doing trans_reserve while</span>
<span class="cm">			 * holding ilock.</span>
<span class="cm">			 */</span>
			<span class="n">xfs_iunlock</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">lockflags</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">error</span> <span class="o">=</span> <span class="n">xfs_qm_dqget</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="p">(</span><span class="n">xfs_dqid_t</span><span class="p">)</span> <span class="n">uid</span><span class="p">,</span>
						 <span class="n">XFS_DQ_USER</span><span class="p">,</span>
						 <span class="n">XFS_QMOPT_DQALLOC</span> <span class="o">|</span>
						 <span class="n">XFS_QMOPT_DOWARN</span><span class="p">,</span>
						 <span class="o">&amp;</span><span class="n">uq</span><span class="p">)))</span> <span class="p">{</span>
				<span class="n">ASSERT</span><span class="p">(</span><span class="n">error</span> <span class="o">!=</span> <span class="n">ENOENT</span><span class="p">);</span>
				<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="cm">/*</span>
<span class="cm">			 * Get the ilock in the right order.</span>
<span class="cm">			 */</span>
			<span class="n">xfs_dqunlock</span><span class="p">(</span><span class="n">uq</span><span class="p">);</span>
			<span class="n">lockflags</span> <span class="o">=</span> <span class="n">XFS_ILOCK_SHARED</span><span class="p">;</span>
			<span class="n">xfs_ilock</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">lockflags</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * Take an extra reference, because we&#39;ll return</span>
<span class="cm">			 * this to caller</span>
<span class="cm">			 */</span>
			<span class="n">ASSERT</span><span class="p">(</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_udquot</span><span class="p">);</span>
			<span class="n">uq</span> <span class="o">=</span> <span class="n">xfs_qm_dqhold</span><span class="p">(</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_udquot</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">XFS_QMOPT_GQUOTA</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">XFS_IS_GQUOTA_ON</span><span class="p">(</span><span class="n">mp</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_d</span><span class="p">.</span><span class="n">di_gid</span> <span class="o">!=</span> <span class="n">gid</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">xfs_iunlock</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">lockflags</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">error</span> <span class="o">=</span> <span class="n">xfs_qm_dqget</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="p">(</span><span class="n">xfs_dqid_t</span><span class="p">)</span><span class="n">gid</span><span class="p">,</span>
						 <span class="n">XFS_DQ_GROUP</span><span class="p">,</span>
						 <span class="n">XFS_QMOPT_DQALLOC</span> <span class="o">|</span>
						 <span class="n">XFS_QMOPT_DOWARN</span><span class="p">,</span>
						 <span class="o">&amp;</span><span class="n">gq</span><span class="p">)))</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">uq</span><span class="p">)</span>
					<span class="n">xfs_qm_dqrele</span><span class="p">(</span><span class="n">uq</span><span class="p">);</span>
				<span class="n">ASSERT</span><span class="p">(</span><span class="n">error</span> <span class="o">!=</span> <span class="n">ENOENT</span><span class="p">);</span>
				<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">xfs_dqunlock</span><span class="p">(</span><span class="n">gq</span><span class="p">);</span>
			<span class="n">lockflags</span> <span class="o">=</span> <span class="n">XFS_ILOCK_SHARED</span><span class="p">;</span>
			<span class="n">xfs_ilock</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">lockflags</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">ASSERT</span><span class="p">(</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_gdquot</span><span class="p">);</span>
			<span class="n">gq</span> <span class="o">=</span> <span class="n">xfs_qm_dqhold</span><span class="p">(</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_gdquot</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">XFS_QMOPT_PQUOTA</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">XFS_IS_PQUOTA_ON</span><span class="p">(</span><span class="n">mp</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">xfs_get_projid</span><span class="p">(</span><span class="n">ip</span><span class="p">)</span> <span class="o">!=</span> <span class="n">prid</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">xfs_iunlock</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">lockflags</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">error</span> <span class="o">=</span> <span class="n">xfs_qm_dqget</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="p">(</span><span class="n">xfs_dqid_t</span><span class="p">)</span><span class="n">prid</span><span class="p">,</span>
						 <span class="n">XFS_DQ_PROJ</span><span class="p">,</span>
						 <span class="n">XFS_QMOPT_DQALLOC</span> <span class="o">|</span>
						 <span class="n">XFS_QMOPT_DOWARN</span><span class="p">,</span>
						 <span class="o">&amp;</span><span class="n">gq</span><span class="p">)))</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">uq</span><span class="p">)</span>
					<span class="n">xfs_qm_dqrele</span><span class="p">(</span><span class="n">uq</span><span class="p">);</span>
				<span class="n">ASSERT</span><span class="p">(</span><span class="n">error</span> <span class="o">!=</span> <span class="n">ENOENT</span><span class="p">);</span>
				<span class="k">return</span> <span class="p">(</span><span class="n">error</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">xfs_dqunlock</span><span class="p">(</span><span class="n">gq</span><span class="p">);</span>
			<span class="n">lockflags</span> <span class="o">=</span> <span class="n">XFS_ILOCK_SHARED</span><span class="p">;</span>
			<span class="n">xfs_ilock</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">lockflags</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">ASSERT</span><span class="p">(</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_gdquot</span><span class="p">);</span>
			<span class="n">gq</span> <span class="o">=</span> <span class="n">xfs_qm_dqhold</span><span class="p">(</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_gdquot</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">uq</span><span class="p">)</span>
		<span class="n">trace_xfs_dquot_dqalloc</span><span class="p">(</span><span class="n">ip</span><span class="p">);</span>

	<span class="n">xfs_iunlock</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">lockflags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">O_udqpp</span><span class="p">)</span>
		<span class="o">*</span><span class="n">O_udqpp</span> <span class="o">=</span> <span class="n">uq</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">uq</span><span class="p">)</span>
		<span class="n">xfs_qm_dqrele</span><span class="p">(</span><span class="n">uq</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">O_gdqpp</span><span class="p">)</span>
		<span class="o">*</span><span class="n">O_gdqpp</span> <span class="o">=</span> <span class="n">gq</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">gq</span><span class="p">)</span>
		<span class="n">xfs_qm_dqrele</span><span class="p">(</span><span class="n">gq</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Actually transfer ownership, and do dquot modifications.</span>
<span class="cm"> * These were already reserved.</span>
<span class="cm"> */</span>
<span class="n">xfs_dquot_t</span> <span class="o">*</span>
<span class="nf">xfs_qm_vop_chown</span><span class="p">(</span>
	<span class="n">xfs_trans_t</span>	<span class="o">*</span><span class="n">tp</span><span class="p">,</span>
	<span class="n">xfs_inode_t</span>	<span class="o">*</span><span class="n">ip</span><span class="p">,</span>
	<span class="n">xfs_dquot_t</span>	<span class="o">**</span><span class="n">IO_olddq</span><span class="p">,</span>
	<span class="n">xfs_dquot_t</span>	<span class="o">*</span><span class="n">newdq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">xfs_dquot_t</span>	<span class="o">*</span><span class="n">prevdq</span><span class="p">;</span>
	<span class="n">uint</span>		<span class="n">bfield</span> <span class="o">=</span> <span class="n">XFS_IS_REALTIME_INODE</span><span class="p">(</span><span class="n">ip</span><span class="p">)</span> <span class="o">?</span>
				 <span class="n">XFS_TRANS_DQ_RTBCOUNT</span> <span class="o">:</span> <span class="n">XFS_TRANS_DQ_BCOUNT</span><span class="p">;</span>


	<span class="n">ASSERT</span><span class="p">(</span><span class="n">xfs_isilocked</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">XFS_ILOCK_EXCL</span><span class="p">));</span>
	<span class="n">ASSERT</span><span class="p">(</span><span class="n">XFS_IS_QUOTA_RUNNING</span><span class="p">(</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_mount</span><span class="p">));</span>

	<span class="cm">/* old dquot */</span>
	<span class="n">prevdq</span> <span class="o">=</span> <span class="o">*</span><span class="n">IO_olddq</span><span class="p">;</span>
	<span class="n">ASSERT</span><span class="p">(</span><span class="n">prevdq</span><span class="p">);</span>
	<span class="n">ASSERT</span><span class="p">(</span><span class="n">prevdq</span> <span class="o">!=</span> <span class="n">newdq</span><span class="p">);</span>

	<span class="n">xfs_trans_mod_dquot</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">prevdq</span><span class="p">,</span> <span class="n">bfield</span><span class="p">,</span> <span class="o">-</span><span class="p">(</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_d</span><span class="p">.</span><span class="n">di_nblocks</span><span class="p">));</span>
	<span class="n">xfs_trans_mod_dquot</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">prevdq</span><span class="p">,</span> <span class="n">XFS_TRANS_DQ_ICOUNT</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>

	<span class="cm">/* the sparkling new dquot */</span>
	<span class="n">xfs_trans_mod_dquot</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">newdq</span><span class="p">,</span> <span class="n">bfield</span><span class="p">,</span> <span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_d</span><span class="p">.</span><span class="n">di_nblocks</span><span class="p">);</span>
	<span class="n">xfs_trans_mod_dquot</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">newdq</span><span class="p">,</span> <span class="n">XFS_TRANS_DQ_ICOUNT</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Take an extra reference, because the inode is going to keep</span>
<span class="cm">	 * this dquot pointer even after the trans_commit.</span>
<span class="cm">	 */</span>
	<span class="o">*</span><span class="n">IO_olddq</span> <span class="o">=</span> <span class="n">xfs_qm_dqhold</span><span class="p">(</span><span class="n">newdq</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">prevdq</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Quota reservations for setattr(AT_UID|AT_GID|AT_PROJID).</span>
<span class="cm"> */</span>
<span class="kt">int</span>
<span class="nf">xfs_qm_vop_chown_reserve</span><span class="p">(</span>
	<span class="n">xfs_trans_t</span>	<span class="o">*</span><span class="n">tp</span><span class="p">,</span>
	<span class="n">xfs_inode_t</span>	<span class="o">*</span><span class="n">ip</span><span class="p">,</span>
	<span class="n">xfs_dquot_t</span>	<span class="o">*</span><span class="n">udqp</span><span class="p">,</span>
	<span class="n">xfs_dquot_t</span>	<span class="o">*</span><span class="n">gdqp</span><span class="p">,</span>
	<span class="n">uint</span>		<span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">xfs_mount_t</span>	<span class="o">*</span><span class="n">mp</span> <span class="o">=</span> <span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_mount</span><span class="p">;</span>
	<span class="n">uint</span>		<span class="n">delblks</span><span class="p">,</span> <span class="n">blkflags</span><span class="p">,</span> <span class="n">prjflags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">xfs_dquot_t</span>	<span class="o">*</span><span class="n">unresudq</span><span class="p">,</span> <span class="o">*</span><span class="n">unresgdq</span><span class="p">,</span> <span class="o">*</span><span class="n">delblksudq</span><span class="p">,</span> <span class="o">*</span><span class="n">delblksgdq</span><span class="p">;</span>
	<span class="kt">int</span>		<span class="n">error</span><span class="p">;</span>


	<span class="n">ASSERT</span><span class="p">(</span><span class="n">xfs_isilocked</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">XFS_ILOCK_EXCL</span><span class="o">|</span><span class="n">XFS_ILOCK_SHARED</span><span class="p">));</span>
	<span class="n">ASSERT</span><span class="p">(</span><span class="n">XFS_IS_QUOTA_RUNNING</span><span class="p">(</span><span class="n">mp</span><span class="p">));</span>

	<span class="n">delblks</span> <span class="o">=</span> <span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_delayed_blks</span><span class="p">;</span>
	<span class="n">delblksudq</span> <span class="o">=</span> <span class="n">delblksgdq</span> <span class="o">=</span> <span class="n">unresudq</span> <span class="o">=</span> <span class="n">unresgdq</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">blkflags</span> <span class="o">=</span> <span class="n">XFS_IS_REALTIME_INODE</span><span class="p">(</span><span class="n">ip</span><span class="p">)</span> <span class="o">?</span>
			<span class="n">XFS_QMOPT_RES_RTBLKS</span> <span class="o">:</span> <span class="n">XFS_QMOPT_RES_REGBLKS</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">XFS_IS_UQUOTA_ON</span><span class="p">(</span><span class="n">mp</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">udqp</span> <span class="o">&amp;&amp;</span>
	    <span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_d</span><span class="p">.</span><span class="n">di_uid</span> <span class="o">!=</span> <span class="p">(</span><span class="n">uid_t</span><span class="p">)</span><span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">udqp</span><span class="o">-&gt;</span><span class="n">q_core</span><span class="p">.</span><span class="n">d_id</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">delblksudq</span> <span class="o">=</span> <span class="n">udqp</span><span class="p">;</span>
		<span class="cm">/*</span>
<span class="cm">		 * If there are delayed allocation blocks, then we have to</span>
<span class="cm">		 * unreserve those from the old dquot, and add them to the</span>
<span class="cm">		 * new dquot.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">delblks</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ASSERT</span><span class="p">(</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_udquot</span><span class="p">);</span>
			<span class="n">unresudq</span> <span class="o">=</span> <span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_udquot</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">XFS_IS_OQUOTA_ON</span><span class="p">(</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_mount</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">gdqp</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">XFS_IS_PQUOTA_ON</span><span class="p">(</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_mount</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		     <span class="n">xfs_get_projid</span><span class="p">(</span><span class="n">ip</span><span class="p">)</span> <span class="o">!=</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">gdqp</span><span class="o">-&gt;</span><span class="n">q_core</span><span class="p">.</span><span class="n">d_id</span><span class="p">))</span>
			<span class="n">prjflags</span> <span class="o">=</span> <span class="n">XFS_QMOPT_ENOSPC</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">prjflags</span> <span class="o">||</span>
		    <span class="p">(</span><span class="n">XFS_IS_GQUOTA_ON</span><span class="p">(</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_mount</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		     <span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_d</span><span class="p">.</span><span class="n">di_gid</span> <span class="o">!=</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">gdqp</span><span class="o">-&gt;</span><span class="n">q_core</span><span class="p">.</span><span class="n">d_id</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">delblksgdq</span> <span class="o">=</span> <span class="n">gdqp</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">delblks</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ASSERT</span><span class="p">(</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_gdquot</span><span class="p">);</span>
				<span class="n">unresgdq</span> <span class="o">=</span> <span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_gdquot</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">error</span> <span class="o">=</span> <span class="n">xfs_trans_reserve_quota_bydquots</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_mount</span><span class="p">,</span>
				<span class="n">delblksudq</span><span class="p">,</span> <span class="n">delblksgdq</span><span class="p">,</span> <span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_d</span><span class="p">.</span><span class="n">di_nblocks</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
				<span class="n">flags</span> <span class="o">|</span> <span class="n">blkflags</span> <span class="o">|</span> <span class="n">prjflags</span><span class="p">)))</span>
		<span class="k">return</span> <span class="p">(</span><span class="n">error</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Do the delayed blks reservations/unreservations now. Since, these</span>
<span class="cm">	 * are done without the help of a transaction, if a reservation fails</span>
<span class="cm">	 * its previous reservations won&#39;t be automatically undone by trans</span>
<span class="cm">	 * code. So, we have to do it manually here.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">delblks</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Do the reservations first. Unreservation can&#39;t fail.</span>
<span class="cm">		 */</span>
		<span class="n">ASSERT</span><span class="p">(</span><span class="n">delblksudq</span> <span class="o">||</span> <span class="n">delblksgdq</span><span class="p">);</span>
		<span class="n">ASSERT</span><span class="p">(</span><span class="n">unresudq</span> <span class="o">||</span> <span class="n">unresgdq</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">error</span> <span class="o">=</span> <span class="n">xfs_trans_reserve_quota_bydquots</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_mount</span><span class="p">,</span>
				<span class="n">delblksudq</span><span class="p">,</span> <span class="n">delblksgdq</span><span class="p">,</span> <span class="p">(</span><span class="n">xfs_qcnt_t</span><span class="p">)</span><span class="n">delblks</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
				<span class="n">flags</span> <span class="o">|</span> <span class="n">blkflags</span> <span class="o">|</span> <span class="n">prjflags</span><span class="p">)))</span>
			<span class="k">return</span> <span class="p">(</span><span class="n">error</span><span class="p">);</span>
		<span class="n">xfs_trans_reserve_quota_bydquots</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_mount</span><span class="p">,</span>
				<span class="n">unresudq</span><span class="p">,</span> <span class="n">unresgdq</span><span class="p">,</span> <span class="o">-</span><span class="p">((</span><span class="n">xfs_qcnt_t</span><span class="p">)</span><span class="n">delblks</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span>
				<span class="n">blkflags</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="nf">xfs_qm_vop_rename_dqattach</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">xfs_inode</span>	<span class="o">**</span><span class="n">i_tab</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">xfs_mount</span>	<span class="o">*</span><span class="n">mp</span> <span class="o">=</span> <span class="n">i_tab</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">i_mount</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">XFS_IS_QUOTA_RUNNING</span><span class="p">(</span><span class="n">mp</span><span class="p">)</span> <span class="o">||</span> <span class="o">!</span><span class="n">XFS_IS_QUOTA_ON</span><span class="p">(</span><span class="n">mp</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="mi">4</span> <span class="o">&amp;&amp;</span> <span class="n">i_tab</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">xfs_inode</span>	<span class="o">*</span><span class="n">ip</span> <span class="o">=</span> <span class="n">i_tab</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="kt">int</span>			<span class="n">error</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * Watch out for duplicate entries in the table.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">ip</span> <span class="o">!=</span> <span class="n">i_tab</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">XFS_NOT_DQATTACHED</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="n">ip</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">error</span> <span class="o">=</span> <span class="n">xfs_qm_dqattach</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
					<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">xfs_qm_vop_create_dqattach</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">xfs_trans</span>	<span class="o">*</span><span class="n">tp</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">xfs_inode</span>	<span class="o">*</span><span class="n">ip</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">xfs_dquot</span>	<span class="o">*</span><span class="n">udqp</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">xfs_dquot</span>	<span class="o">*</span><span class="n">gdqp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">xfs_mount</span>	<span class="o">*</span><span class="n">mp</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">t_mountp</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">XFS_IS_QUOTA_RUNNING</span><span class="p">(</span><span class="n">mp</span><span class="p">)</span> <span class="o">||</span> <span class="o">!</span><span class="n">XFS_IS_QUOTA_ON</span><span class="p">(</span><span class="n">mp</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">ASSERT</span><span class="p">(</span><span class="n">xfs_isilocked</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">XFS_ILOCK_EXCL</span><span class="p">));</span>
	<span class="n">ASSERT</span><span class="p">(</span><span class="n">XFS_IS_QUOTA_RUNNING</span><span class="p">(</span><span class="n">mp</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">udqp</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ASSERT</span><span class="p">(</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_udquot</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="n">ASSERT</span><span class="p">(</span><span class="n">XFS_IS_UQUOTA_ON</span><span class="p">(</span><span class="n">mp</span><span class="p">));</span>
		<span class="n">ASSERT</span><span class="p">(</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_d</span><span class="p">.</span><span class="n">di_uid</span> <span class="o">==</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">udqp</span><span class="o">-&gt;</span><span class="n">q_core</span><span class="p">.</span><span class="n">d_id</span><span class="p">));</span>

		<span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_udquot</span> <span class="o">=</span> <span class="n">xfs_qm_dqhold</span><span class="p">(</span><span class="n">udqp</span><span class="p">);</span>
		<span class="n">xfs_trans_mod_dquot</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">udqp</span><span class="p">,</span> <span class="n">XFS_TRANS_DQ_ICOUNT</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">gdqp</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ASSERT</span><span class="p">(</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_gdquot</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="n">ASSERT</span><span class="p">(</span><span class="n">XFS_IS_OQUOTA_ON</span><span class="p">(</span><span class="n">mp</span><span class="p">));</span>
		<span class="n">ASSERT</span><span class="p">((</span><span class="n">XFS_IS_GQUOTA_ON</span><span class="p">(</span><span class="n">mp</span><span class="p">)</span> <span class="o">?</span>
			<span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_d</span><span class="p">.</span><span class="n">di_gid</span> <span class="o">:</span> <span class="n">xfs_get_projid</span><span class="p">(</span><span class="n">ip</span><span class="p">))</span> <span class="o">==</span>
				<span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">gdqp</span><span class="o">-&gt;</span><span class="n">q_core</span><span class="p">.</span><span class="n">d_id</span><span class="p">));</span>

		<span class="n">ip</span><span class="o">-&gt;</span><span class="n">i_gdquot</span> <span class="o">=</span> <span class="n">xfs_qm_dqhold</span><span class="p">(</span><span class="n">gdqp</span><span class="p">);</span>
		<span class="n">xfs_trans_mod_dquot</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">gdqp</span><span class="p">,</span> <span class="n">XFS_TRANS_DQ_ICOUNT</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
