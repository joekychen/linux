<!DOCTYPE html>
<html><head><title>joekychen/linux » fs › xfs › xfs_btree.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>xfs_btree.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Copyright (c) 2000-2002,2005 Silicon Graphics, Inc.</span>
<span class="cm"> * All Rights Reserved.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or</span>
<span class="cm"> * modify it under the terms of the GNU General Public License as</span>
<span class="cm"> * published by the Free Software Foundation.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is distributed in the hope that it would be useful,</span>
<span class="cm"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm"> * GNU General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> * You should have received a copy of the GNU General Public License</span>
<span class="cm"> * along with this program; if not, write the Free Software Foundation,</span>
<span class="cm"> * Inc.,  51 Franklin St, Fifth Floor, Boston, MA  02110-1301  USA</span>
<span class="cm"> */</span>
<span class="cp">#include &quot;xfs.h&quot;</span>
<span class="cp">#include &quot;xfs_fs.h&quot;</span>
<span class="cp">#include &quot;xfs_types.h&quot;</span>
<span class="cp">#include &quot;xfs_bit.h&quot;</span>
<span class="cp">#include &quot;xfs_log.h&quot;</span>
<span class="cp">#include &quot;xfs_trans.h&quot;</span>
<span class="cp">#include &quot;xfs_sb.h&quot;</span>
<span class="cp">#include &quot;xfs_ag.h&quot;</span>
<span class="cp">#include &quot;xfs_mount.h&quot;</span>
<span class="cp">#include &quot;xfs_bmap_btree.h&quot;</span>
<span class="cp">#include &quot;xfs_alloc_btree.h&quot;</span>
<span class="cp">#include &quot;xfs_ialloc_btree.h&quot;</span>
<span class="cp">#include &quot;xfs_dinode.h&quot;</span>
<span class="cp">#include &quot;xfs_inode.h&quot;</span>
<span class="cp">#include &quot;xfs_inode_item.h&quot;</span>
<span class="cp">#include &quot;xfs_btree.h&quot;</span>
<span class="cp">#include &quot;xfs_error.h&quot;</span>
<span class="cp">#include &quot;xfs_trace.h&quot;</span>

<span class="cm">/*</span>
<span class="cm"> * Cursor allocation zone.</span>
<span class="cm"> */</span>
<span class="n">kmem_zone_t</span>	<span class="o">*</span><span class="n">xfs_btree_cur_zone</span><span class="p">;</span>

<span class="cm">/*</span>
<span class="cm"> * Btree magic numbers.</span>
<span class="cm"> */</span>
<span class="k">const</span> <span class="n">__uint32_t</span> <span class="n">xfs_magics</span><span class="p">[</span><span class="n">XFS_BTNUM_MAX</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">XFS_ABTB_MAGIC</span><span class="p">,</span> <span class="n">XFS_ABTC_MAGIC</span><span class="p">,</span> <span class="n">XFS_BMAP_MAGIC</span><span class="p">,</span> <span class="n">XFS_IBT_MAGIC</span>
<span class="p">};</span>


<span class="n">STATIC</span> <span class="kt">int</span>				<span class="cm">/* error (0 or EFSCORRUPTED) */</span>
<span class="n">xfs_btree_check_lblock</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">xfs_btree_cur</span>	<span class="o">*</span><span class="n">cur</span><span class="p">,</span>	<span class="cm">/* btree cursor */</span>
	<span class="k">struct</span> <span class="n">xfs_btree_block</span>	<span class="o">*</span><span class="n">block</span><span class="p">,</span>	<span class="cm">/* btree long form block pointer */</span>
	<span class="kt">int</span>			<span class="n">level</span><span class="p">,</span>	<span class="cm">/* level of the btree block */</span>
	<span class="k">struct</span> <span class="n">xfs_buf</span>		<span class="o">*</span><span class="n">bp</span><span class="p">)</span>	<span class="cm">/* buffer for block, if any */</span>
<span class="p">{</span>
	<span class="kt">int</span>			<span class="n">lblock_ok</span><span class="p">;</span> <span class="cm">/* block passes checks */</span>
	<span class="k">struct</span> <span class="n">xfs_mount</span>	<span class="o">*</span><span class="n">mp</span><span class="p">;</span>	<span class="cm">/* file system mount point */</span>

	<span class="n">mp</span> <span class="o">=</span> <span class="n">cur</span><span class="o">-&gt;</span><span class="n">bc_mp</span><span class="p">;</span>
	<span class="n">lblock_ok</span> <span class="o">=</span>
		<span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">block</span><span class="o">-&gt;</span><span class="n">bb_magic</span><span class="p">)</span> <span class="o">==</span> <span class="n">xfs_magics</span><span class="p">[</span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">bc_btnum</span><span class="p">]</span> <span class="o">&amp;&amp;</span>
		<span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">block</span><span class="o">-&gt;</span><span class="n">bb_level</span><span class="p">)</span> <span class="o">==</span> <span class="n">level</span> <span class="o">&amp;&amp;</span>
		<span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">block</span><span class="o">-&gt;</span><span class="n">bb_numrecs</span><span class="p">)</span> <span class="o">&lt;=</span>
			<span class="n">cur</span><span class="o">-&gt;</span><span class="n">bc_ops</span><span class="o">-&gt;</span><span class="n">get_maxrecs</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">level</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		<span class="n">block</span><span class="o">-&gt;</span><span class="n">bb_u</span><span class="p">.</span><span class="n">l</span><span class="p">.</span><span class="n">bb_leftsib</span> <span class="o">&amp;&amp;</span>
		<span class="p">(</span><span class="n">block</span><span class="o">-&gt;</span><span class="n">bb_u</span><span class="p">.</span><span class="n">l</span><span class="p">.</span><span class="n">bb_leftsib</span> <span class="o">==</span> <span class="n">cpu_to_be64</span><span class="p">(</span><span class="n">NULLDFSBNO</span><span class="p">)</span> <span class="o">||</span>
		 <span class="n">XFS_FSB_SANITY_CHECK</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span>
		 	<span class="n">be64_to_cpu</span><span class="p">(</span><span class="n">block</span><span class="o">-&gt;</span><span class="n">bb_u</span><span class="p">.</span><span class="n">l</span><span class="p">.</span><span class="n">bb_leftsib</span><span class="p">)))</span> <span class="o">&amp;&amp;</span>
		<span class="n">block</span><span class="o">-&gt;</span><span class="n">bb_u</span><span class="p">.</span><span class="n">l</span><span class="p">.</span><span class="n">bb_rightsib</span> <span class="o">&amp;&amp;</span>
		<span class="p">(</span><span class="n">block</span><span class="o">-&gt;</span><span class="n">bb_u</span><span class="p">.</span><span class="n">l</span><span class="p">.</span><span class="n">bb_rightsib</span> <span class="o">==</span> <span class="n">cpu_to_be64</span><span class="p">(</span><span class="n">NULLDFSBNO</span><span class="p">)</span> <span class="o">||</span>
		 <span class="n">XFS_FSB_SANITY_CHECK</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span>
		 	<span class="n">be64_to_cpu</span><span class="p">(</span><span class="n">block</span><span class="o">-&gt;</span><span class="n">bb_u</span><span class="p">.</span><span class="n">l</span><span class="p">.</span><span class="n">bb_rightsib</span><span class="p">)));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">XFS_TEST_ERROR</span><span class="p">(</span><span class="o">!</span><span class="n">lblock_ok</span><span class="p">,</span> <span class="n">mp</span><span class="p">,</span>
			<span class="n">XFS_ERRTAG_BTREE_CHECK_LBLOCK</span><span class="p">,</span>
			<span class="n">XFS_RANDOM_BTREE_CHECK_LBLOCK</span><span class="p">)))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bp</span><span class="p">)</span>
			<span class="n">trace_xfs_btree_corrupt</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">_RET_IP_</span><span class="p">);</span>
		<span class="n">XFS_ERROR_REPORT</span><span class="p">(</span><span class="s">&quot;xfs_btree_check_lblock&quot;</span><span class="p">,</span> <span class="n">XFS_ERRLEVEL_LOW</span><span class="p">,</span>
				 <span class="n">mp</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">XFS_ERROR</span><span class="p">(</span><span class="n">EFSCORRUPTED</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">STATIC</span> <span class="kt">int</span>				<span class="cm">/* error (0 or EFSCORRUPTED) */</span>
<span class="n">xfs_btree_check_sblock</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">xfs_btree_cur</span>	<span class="o">*</span><span class="n">cur</span><span class="p">,</span>	<span class="cm">/* btree cursor */</span>
	<span class="k">struct</span> <span class="n">xfs_btree_block</span>	<span class="o">*</span><span class="n">block</span><span class="p">,</span>	<span class="cm">/* btree short form block pointer */</span>
	<span class="kt">int</span>			<span class="n">level</span><span class="p">,</span>	<span class="cm">/* level of the btree block */</span>
	<span class="k">struct</span> <span class="n">xfs_buf</span>		<span class="o">*</span><span class="n">bp</span><span class="p">)</span>	<span class="cm">/* buffer containing block */</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">xfs_buf</span>		<span class="o">*</span><span class="n">agbp</span><span class="p">;</span>	<span class="cm">/* buffer for ag. freespace struct */</span>
	<span class="k">struct</span> <span class="n">xfs_agf</span>		<span class="o">*</span><span class="n">agf</span><span class="p">;</span>	<span class="cm">/* ag. freespace structure */</span>
	<span class="n">xfs_agblock_t</span>		<span class="n">agflen</span><span class="p">;</span>	<span class="cm">/* native ag. freespace length */</span>
	<span class="kt">int</span>			<span class="n">sblock_ok</span><span class="p">;</span> <span class="cm">/* block passes checks */</span>

	<span class="n">agbp</span> <span class="o">=</span> <span class="n">cur</span><span class="o">-&gt;</span><span class="n">bc_private</span><span class="p">.</span><span class="n">a</span><span class="p">.</span><span class="n">agbp</span><span class="p">;</span>
	<span class="n">agf</span> <span class="o">=</span> <span class="n">XFS_BUF_TO_AGF</span><span class="p">(</span><span class="n">agbp</span><span class="p">);</span>
	<span class="n">agflen</span> <span class="o">=</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">agf</span><span class="o">-&gt;</span><span class="n">agf_length</span><span class="p">);</span>
	<span class="n">sblock_ok</span> <span class="o">=</span>
		<span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">block</span><span class="o">-&gt;</span><span class="n">bb_magic</span><span class="p">)</span> <span class="o">==</span> <span class="n">xfs_magics</span><span class="p">[</span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">bc_btnum</span><span class="p">]</span> <span class="o">&amp;&amp;</span>
		<span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">block</span><span class="o">-&gt;</span><span class="n">bb_level</span><span class="p">)</span> <span class="o">==</span> <span class="n">level</span> <span class="o">&amp;&amp;</span>
		<span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">block</span><span class="o">-&gt;</span><span class="n">bb_numrecs</span><span class="p">)</span> <span class="o">&lt;=</span>
			<span class="n">cur</span><span class="o">-&gt;</span><span class="n">bc_ops</span><span class="o">-&gt;</span><span class="n">get_maxrecs</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">level</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		<span class="p">(</span><span class="n">block</span><span class="o">-&gt;</span><span class="n">bb_u</span><span class="p">.</span><span class="n">s</span><span class="p">.</span><span class="n">bb_leftsib</span> <span class="o">==</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">NULLAGBLOCK</span><span class="p">)</span> <span class="o">||</span>
		 <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">block</span><span class="o">-&gt;</span><span class="n">bb_u</span><span class="p">.</span><span class="n">s</span><span class="p">.</span><span class="n">bb_leftsib</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">agflen</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		<span class="n">block</span><span class="o">-&gt;</span><span class="n">bb_u</span><span class="p">.</span><span class="n">s</span><span class="p">.</span><span class="n">bb_leftsib</span> <span class="o">&amp;&amp;</span>
		<span class="p">(</span><span class="n">block</span><span class="o">-&gt;</span><span class="n">bb_u</span><span class="p">.</span><span class="n">s</span><span class="p">.</span><span class="n">bb_rightsib</span> <span class="o">==</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">NULLAGBLOCK</span><span class="p">)</span> <span class="o">||</span>
		 <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">block</span><span class="o">-&gt;</span><span class="n">bb_u</span><span class="p">.</span><span class="n">s</span><span class="p">.</span><span class="n">bb_rightsib</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">agflen</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		<span class="n">block</span><span class="o">-&gt;</span><span class="n">bb_u</span><span class="p">.</span><span class="n">s</span><span class="p">.</span><span class="n">bb_rightsib</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">XFS_TEST_ERROR</span><span class="p">(</span><span class="o">!</span><span class="n">sblock_ok</span><span class="p">,</span> <span class="n">cur</span><span class="o">-&gt;</span><span class="n">bc_mp</span><span class="p">,</span>
			<span class="n">XFS_ERRTAG_BTREE_CHECK_SBLOCK</span><span class="p">,</span>
			<span class="n">XFS_RANDOM_BTREE_CHECK_SBLOCK</span><span class="p">)))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bp</span><span class="p">)</span>
			<span class="n">trace_xfs_btree_corrupt</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">_RET_IP_</span><span class="p">);</span>
		<span class="n">XFS_CORRUPTION_ERROR</span><span class="p">(</span><span class="s">&quot;xfs_btree_check_sblock&quot;</span><span class="p">,</span>
			<span class="n">XFS_ERRLEVEL_LOW</span><span class="p">,</span> <span class="n">cur</span><span class="o">-&gt;</span><span class="n">bc_mp</span><span class="p">,</span> <span class="n">block</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">XFS_ERROR</span><span class="p">(</span><span class="n">EFSCORRUPTED</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Debug routine: check that block header is ok.</span>
<span class="cm"> */</span>
<span class="kt">int</span>
<span class="n">xfs_btree_check_block</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">xfs_btree_cur</span>	<span class="o">*</span><span class="n">cur</span><span class="p">,</span>	<span class="cm">/* btree cursor */</span>
	<span class="k">struct</span> <span class="n">xfs_btree_block</span>	<span class="o">*</span><span class="n">block</span><span class="p">,</span>	<span class="cm">/* generic btree block pointer */</span>
	<span class="kt">int</span>			<span class="n">level</span><span class="p">,</span>	<span class="cm">/* level of the btree block */</span>
	<span class="k">struct</span> <span class="n">xfs_buf</span>		<span class="o">*</span><span class="n">bp</span><span class="p">)</span>	<span class="cm">/* buffer containing block, if any */</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">bc_flags</span> <span class="o">&amp;</span> <span class="n">XFS_BTREE_LONG_PTRS</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">xfs_btree_check_lblock</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">block</span><span class="p">,</span> <span class="n">level</span><span class="p">,</span> <span class="n">bp</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="n">xfs_btree_check_sblock</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">block</span><span class="p">,</span> <span class="n">level</span><span class="p">,</span> <span class="n">bp</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Check that (long) pointer is ok.</span>
<span class="cm"> */</span>
<span class="kt">int</span>					<span class="cm">/* error (0 or EFSCORRUPTED) */</span>
<span class="n">xfs_btree_check_lptr</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">xfs_btree_cur</span>	<span class="o">*</span><span class="n">cur</span><span class="p">,</span>	<span class="cm">/* btree cursor */</span>
	<span class="n">xfs_dfsbno_t</span>		<span class="n">bno</span><span class="p">,</span>	<span class="cm">/* btree block disk address */</span>
	<span class="kt">int</span>			<span class="n">level</span><span class="p">)</span>	<span class="cm">/* btree block level */</span>
<span class="p">{</span>
	<span class="n">XFS_WANT_CORRUPTED_RETURN</span><span class="p">(</span>
		<span class="n">level</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
		<span class="n">bno</span> <span class="o">!=</span> <span class="n">NULLDFSBNO</span> <span class="o">&amp;&amp;</span>
		<span class="n">XFS_FSB_SANITY_CHECK</span><span class="p">(</span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">bc_mp</span><span class="p">,</span> <span class="n">bno</span><span class="p">));</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef DEBUG</span>
<span class="cm">/*</span>
<span class="cm"> * Check that (short) pointer is ok.</span>
<span class="cm"> */</span>
<span class="n">STATIC</span> <span class="kt">int</span>				<span class="cm">/* error (0 or EFSCORRUPTED) */</span>
<span class="n">xfs_btree_check_sptr</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">xfs_btree_cur</span>	<span class="o">*</span><span class="n">cur</span><span class="p">,</span>	<span class="cm">/* btree cursor */</span>
	<span class="n">xfs_agblock_t</span>		<span class="n">bno</span><span class="p">,</span>	<span class="cm">/* btree block disk address */</span>
	<span class="kt">int</span>			<span class="n">level</span><span class="p">)</span>	<span class="cm">/* btree block level */</span>
<span class="p">{</span>
	<span class="n">xfs_agblock_t</span>		<span class="n">agblocks</span> <span class="o">=</span> <span class="n">cur</span><span class="o">-&gt;</span><span class="n">bc_mp</span><span class="o">-&gt;</span><span class="n">m_sb</span><span class="p">.</span><span class="n">sb_agblocks</span><span class="p">;</span>

	<span class="n">XFS_WANT_CORRUPTED_RETURN</span><span class="p">(</span>
		<span class="n">level</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
		<span class="n">bno</span> <span class="o">!=</span> <span class="n">NULLAGBLOCK</span> <span class="o">&amp;&amp;</span>
		<span class="n">bno</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
		<span class="n">bno</span> <span class="o">&lt;</span> <span class="n">agblocks</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Check that block ptr is ok.</span>
<span class="cm"> */</span>
<span class="n">STATIC</span> <span class="kt">int</span>				<span class="cm">/* error (0 or EFSCORRUPTED) */</span>
<span class="n">xfs_btree_check_ptr</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">xfs_btree_cur</span>	<span class="o">*</span><span class="n">cur</span><span class="p">,</span>	<span class="cm">/* btree cursor */</span>
	<span class="k">union</span> <span class="n">xfs_btree_ptr</span>	<span class="o">*</span><span class="n">ptr</span><span class="p">,</span>	<span class="cm">/* btree block disk address */</span>
	<span class="kt">int</span>			<span class="n">index</span><span class="p">,</span>	<span class="cm">/* offset from ptr to check */</span>
	<span class="kt">int</span>			<span class="n">level</span><span class="p">)</span>	<span class="cm">/* btree block level */</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">bc_flags</span> <span class="o">&amp;</span> <span class="n">XFS_BTREE_LONG_PTRS</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span> <span class="n">xfs_btree_check_lptr</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span>
				<span class="n">be64_to_cpu</span><span class="p">((</span><span class="o">&amp;</span><span class="n">ptr</span><span class="o">-&gt;</span><span class="n">l</span><span class="p">)[</span><span class="n">index</span><span class="p">]),</span> <span class="n">level</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">return</span> <span class="n">xfs_btree_check_sptr</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span>
				<span class="n">be32_to_cpu</span><span class="p">((</span><span class="o">&amp;</span><span class="n">ptr</span><span class="o">-&gt;</span><span class="n">s</span><span class="p">)[</span><span class="n">index</span><span class="p">]),</span> <span class="n">level</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="cm">/*</span>
<span class="cm"> * Delete the btree cursor.</span>
<span class="cm"> */</span>
<span class="kt">void</span>
<span class="n">xfs_btree_del_cursor</span><span class="p">(</span>
	<span class="n">xfs_btree_cur_t</span>	<span class="o">*</span><span class="n">cur</span><span class="p">,</span>		<span class="cm">/* btree cursor */</span>
	<span class="kt">int</span>		<span class="n">error</span><span class="p">)</span>		<span class="cm">/* del because of error */</span>
<span class="p">{</span>
	<span class="kt">int</span>		<span class="n">i</span><span class="p">;</span>		<span class="cm">/* btree level */</span>

	<span class="cm">/*</span>
<span class="cm">	 * Clear the buffer pointers, and release the buffers.</span>
<span class="cm">	 * If we&#39;re doing this in the face of an error, we</span>
<span class="cm">	 * need to make sure to inspect all of the entries</span>
<span class="cm">	 * in the bc_bufs array for buffers to be unlocked.</span>
<span class="cm">	 * This is because some of the btree code works from</span>
<span class="cm">	 * level n down to 0, and if we get an error along</span>
<span class="cm">	 * the way we won&#39;t have initialized all the entries</span>
<span class="cm">	 * down to 0.</span>
<span class="cm">	 */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">cur</span><span class="o">-&gt;</span><span class="n">bc_nlevels</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">bc_bufs</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
			<span class="n">xfs_trans_brelse</span><span class="p">(</span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">bc_tp</span><span class="p">,</span> <span class="n">cur</span><span class="o">-&gt;</span><span class="n">bc_bufs</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">error</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/*</span>
<span class="cm">	 * Can&#39;t free a bmap cursor without having dealt with the</span>
<span class="cm">	 * allocated indirect blocks&#39; accounting.</span>
<span class="cm">	 */</span>
	<span class="n">ASSERT</span><span class="p">(</span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">bc_btnum</span> <span class="o">!=</span> <span class="n">XFS_BTNUM_BMAP</span> <span class="o">||</span>
	       <span class="n">cur</span><span class="o">-&gt;</span><span class="n">bc_private</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">allocated</span> <span class="o">==</span> <span class="mi">0</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 * Free the cursor.</span>
<span class="cm">	 */</span>
	<span class="n">kmem_zone_free</span><span class="p">(</span><span class="n">xfs_btree_cur_zone</span><span class="p">,</span> <span class="n">cur</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Duplicate the btree cursor.</span>
<span class="cm"> * Allocate a new one, copy the record, re-get the buffers.</span>
<span class="cm"> */</span>
<span class="kt">int</span>					<span class="cm">/* error */</span>
<span class="n">xfs_btree_dup_cursor</span><span class="p">(</span>
	<span class="n">xfs_btree_cur_t</span>	<span class="o">*</span><span class="n">cur</span><span class="p">,</span>		<span class="cm">/* input cursor */</span>
	<span class="n">xfs_btree_cur_t</span>	<span class="o">**</span><span class="n">ncur</span><span class="p">)</span>		<span class="cm">/* output cursor */</span>
<span class="p">{</span>
	<span class="n">xfs_buf_t</span>	<span class="o">*</span><span class="n">bp</span><span class="p">;</span>		<span class="cm">/* btree block&#39;s buffer pointer */</span>
	<span class="kt">int</span>		<span class="n">error</span><span class="p">;</span>		<span class="cm">/* error return value */</span>
	<span class="kt">int</span>		<span class="n">i</span><span class="p">;</span>		<span class="cm">/* level number of btree block */</span>
	<span class="n">xfs_mount_t</span>	<span class="o">*</span><span class="n">mp</span><span class="p">;</span>		<span class="cm">/* mount structure for filesystem */</span>
	<span class="n">xfs_btree_cur_t</span>	<span class="o">*</span><span class="n">new</span><span class="p">;</span>		<span class="cm">/* new cursor value */</span>
	<span class="n">xfs_trans_t</span>	<span class="o">*</span><span class="n">tp</span><span class="p">;</span>		<span class="cm">/* transaction pointer, can be NULL */</span>

	<span class="n">tp</span> <span class="o">=</span> <span class="n">cur</span><span class="o">-&gt;</span><span class="n">bc_tp</span><span class="p">;</span>
	<span class="n">mp</span> <span class="o">=</span> <span class="n">cur</span><span class="o">-&gt;</span><span class="n">bc_mp</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Allocate a new cursor like the old one.</span>
<span class="cm">	 */</span>
	<span class="n">new</span> <span class="o">=</span> <span class="n">cur</span><span class="o">-&gt;</span><span class="n">bc_ops</span><span class="o">-&gt;</span><span class="n">dup_cursor</span><span class="p">(</span><span class="n">cur</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Copy the record currently in the cursor.</span>
<span class="cm">	 */</span>
	<span class="n">new</span><span class="o">-&gt;</span><span class="n">bc_rec</span> <span class="o">=</span> <span class="n">cur</span><span class="o">-&gt;</span><span class="n">bc_rec</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * For each level current, re-get the buffer and copy the ptr value.</span>
<span class="cm">	 */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">new</span><span class="o">-&gt;</span><span class="n">bc_nlevels</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">new</span><span class="o">-&gt;</span><span class="n">bc_ptrs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">cur</span><span class="o">-&gt;</span><span class="n">bc_ptrs</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="n">new</span><span class="o">-&gt;</span><span class="n">bc_ra</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">cur</span><span class="o">-&gt;</span><span class="n">bc_ra</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">bp</span> <span class="o">=</span> <span class="n">cur</span><span class="o">-&gt;</span><span class="n">bc_bufs</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">error</span> <span class="o">=</span> <span class="n">xfs_trans_read_buf</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="n">tp</span><span class="p">,</span> <span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_ddev_targp</span><span class="p">,</span>
				<span class="n">XFS_BUF_ADDR</span><span class="p">(</span><span class="n">bp</span><span class="p">),</span> <span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_bsize</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bp</span><span class="p">)))</span> <span class="p">{</span>
				<span class="n">xfs_btree_del_cursor</span><span class="p">(</span><span class="n">new</span><span class="p">,</span> <span class="n">error</span><span class="p">);</span>
				<span class="o">*</span><span class="n">ncur</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
				<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">new</span><span class="o">-&gt;</span><span class="n">bc_bufs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">bp</span><span class="p">;</span>
			<span class="n">ASSERT</span><span class="p">(</span><span class="o">!</span><span class="n">xfs_buf_geterror</span><span class="p">(</span><span class="n">bp</span><span class="p">));</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">new</span><span class="o">-&gt;</span><span class="n">bc_bufs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="o">*</span><span class="n">ncur</span> <span class="o">=</span> <span class="n">new</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * XFS btree block layout and addressing:</span>
<span class="cm"> *</span>
<span class="cm"> * There are two types of blocks in the btree: leaf and non-leaf blocks.</span>
<span class="cm"> *</span>
<span class="cm"> * The leaf record start with a header then followed by records containing</span>
<span class="cm"> * the values.  A non-leaf block also starts with the same header, and</span>
<span class="cm"> * then first contains lookup keys followed by an equal number of pointers</span>
<span class="cm"> * to the btree blocks at the previous level.</span>
<span class="cm"> *</span>
<span class="cm"> *		+--------+-------+-------+-------+-------+-------+-------+</span>
<span class="cm"> * Leaf:	| header | rec 1 | rec 2 | rec 3 | rec 4 | rec 5 | rec N |</span>
<span class="cm"> *		+--------+-------+-------+-------+-------+-------+-------+</span>
<span class="cm"> *</span>
<span class="cm"> *		+--------+-------+-------+-------+-------+-------+-------+</span>
<span class="cm"> * Non-Leaf:	| header | key 1 | key 2 | key N | ptr 1 | ptr 2 | ptr N |</span>
<span class="cm"> *		+--------+-------+-------+-------+-------+-------+-------+</span>
<span class="cm"> *</span>
<span class="cm"> * The header is called struct xfs_btree_block for reasons better left unknown</span>
<span class="cm"> * and comes in different versions for short (32bit) and long (64bit) block</span>
<span class="cm"> * pointers.  The record and key structures are defined by the btree instances</span>
<span class="cm"> * and opaque to the btree core.  The block pointers are simple disk endian</span>
<span class="cm"> * integers, available in a short (32bit) and long (64bit) variant.</span>
<span class="cm"> *</span>
<span class="cm"> * The helpers below calculate the offset of a given record, key or pointer</span>
<span class="cm"> * into a btree block (xfs_btree_*_offset) or return a pointer to the given</span>
<span class="cm"> * record, key or pointer (xfs_btree_*_addr).  Note that all addressing</span>
<span class="cm"> * inside the btree block is done using indices starting at one, not zero!</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> * Return size of the btree block header for this btree instance.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">size_t</span> <span class="n">xfs_btree_block_len</span><span class="p">(</span><span class="k">struct</span> <span class="n">xfs_btree_cur</span> <span class="o">*</span><span class="n">cur</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">bc_flags</span> <span class="o">&amp;</span> <span class="n">XFS_BTREE_LONG_PTRS</span><span class="p">)</span> <span class="o">?</span>
		<span class="n">XFS_BTREE_LBLOCK_LEN</span> <span class="o">:</span>
		<span class="n">XFS_BTREE_SBLOCK_LEN</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Return size of btree block pointers for this btree instance.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">size_t</span> <span class="n">xfs_btree_ptr_len</span><span class="p">(</span><span class="k">struct</span> <span class="n">xfs_btree_cur</span> <span class="o">*</span><span class="n">cur</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">bc_flags</span> <span class="o">&amp;</span> <span class="n">XFS_BTREE_LONG_PTRS</span><span class="p">)</span> <span class="o">?</span>
		<span class="k">sizeof</span><span class="p">(</span><span class="n">__be64</span><span class="p">)</span> <span class="o">:</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">__be32</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Calculate offset of the n-th record in a btree block.</span>
<span class="cm"> */</span>
<span class="n">STATIC</span> <span class="kt">size_t</span>
<span class="n">xfs_btree_rec_offset</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">xfs_btree_cur</span>	<span class="o">*</span><span class="n">cur</span><span class="p">,</span>
	<span class="kt">int</span>			<span class="n">n</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">xfs_btree_block_len</span><span class="p">(</span><span class="n">cur</span><span class="p">)</span> <span class="o">+</span>
		<span class="p">(</span><span class="n">n</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">cur</span><span class="o">-&gt;</span><span class="n">bc_ops</span><span class="o">-&gt;</span><span class="n">rec_len</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Calculate offset of the n-th key in a btree block.</span>
<span class="cm"> */</span>
<span class="n">STATIC</span> <span class="kt">size_t</span>
<span class="n">xfs_btree_key_offset</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">xfs_btree_cur</span>	<span class="o">*</span><span class="n">cur</span><span class="p">,</span>
	<span class="kt">int</span>			<span class="n">n</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">xfs_btree_block_len</span><span class="p">(</span><span class="n">cur</span><span class="p">)</span> <span class="o">+</span>
		<span class="p">(</span><span class="n">n</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">cur</span><span class="o">-&gt;</span><span class="n">bc_ops</span><span class="o">-&gt;</span><span class="n">key_len</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Calculate offset of the n-th block pointer in a btree block.</span>
<span class="cm"> */</span>
<span class="n">STATIC</span> <span class="kt">size_t</span>
<span class="n">xfs_btree_ptr_offset</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">xfs_btree_cur</span>	<span class="o">*</span><span class="n">cur</span><span class="p">,</span>
	<span class="kt">int</span>			<span class="n">n</span><span class="p">,</span>
	<span class="kt">int</span>			<span class="n">level</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">xfs_btree_block_len</span><span class="p">(</span><span class="n">cur</span><span class="p">)</span> <span class="o">+</span>
		<span class="n">cur</span><span class="o">-&gt;</span><span class="n">bc_ops</span><span class="o">-&gt;</span><span class="n">get_maxrecs</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">level</span><span class="p">)</span> <span class="o">*</span> <span class="n">cur</span><span class="o">-&gt;</span><span class="n">bc_ops</span><span class="o">-&gt;</span><span class="n">key_len</span> <span class="o">+</span>
		<span class="p">(</span><span class="n">n</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">xfs_btree_ptr_len</span><span class="p">(</span><span class="n">cur</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Return a pointer to the n-th record in the btree block.</span>
<span class="cm"> */</span>
<span class="n">STATIC</span> <span class="k">union</span> <span class="n">xfs_btree_rec</span> <span class="o">*</span>
<span class="n">xfs_btree_rec_addr</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">xfs_btree_cur</span>	<span class="o">*</span><span class="n">cur</span><span class="p">,</span>
	<span class="kt">int</span>			<span class="n">n</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">xfs_btree_block</span>	<span class="o">*</span><span class="n">block</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="k">union</span> <span class="n">xfs_btree_rec</span> <span class="o">*</span><span class="p">)</span>
		<span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">block</span> <span class="o">+</span> <span class="n">xfs_btree_rec_offset</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">n</span><span class="p">));</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Return a pointer to the n-th key in the btree block.</span>
<span class="cm"> */</span>
<span class="n">STATIC</span> <span class="k">union</span> <span class="n">xfs_btree_key</span> <span class="o">*</span>
<span class="n">xfs_btree_key_addr</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">xfs_btree_cur</span>	<span class="o">*</span><span class="n">cur</span><span class="p">,</span>
	<span class="kt">int</span>			<span class="n">n</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">xfs_btree_block</span>	<span class="o">*</span><span class="n">block</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="k">union</span> <span class="n">xfs_btree_key</span> <span class="o">*</span><span class="p">)</span>
		<span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">block</span> <span class="o">+</span> <span class="n">xfs_btree_key_offset</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">n</span><span class="p">));</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Return a pointer to the n-th block pointer in the btree block.</span>
<span class="cm"> */</span>
<span class="n">STATIC</span> <span class="k">union</span> <span class="n">xfs_btree_ptr</span> <span class="o">*</span>
<span class="n">xfs_btree_ptr_addr</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">xfs_btree_cur</span>	<span class="o">*</span><span class="n">cur</span><span class="p">,</span>
	<span class="kt">int</span>			<span class="n">n</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">xfs_btree_block</span>	<span class="o">*</span><span class="n">block</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span>			<span class="n">level</span> <span class="o">=</span> <span class="n">xfs_btree_get_level</span><span class="p">(</span><span class="n">block</span><span class="p">);</span>

	<span class="n">ASSERT</span><span class="p">(</span><span class="n">block</span><span class="o">-&gt;</span><span class="n">bb_level</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">return</span> <span class="p">(</span><span class="k">union</span> <span class="n">xfs_btree_ptr</span> <span class="o">*</span><span class="p">)</span>
		<span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">block</span> <span class="o">+</span> <span class="n">xfs_btree_ptr_offset</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">level</span><span class="p">));</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Get a the root block which is stored in the inode.</span>
<span class="cm"> *</span>
<span class="cm"> * For now this btree implementation assumes the btree root is always</span>
<span class="cm"> * stored in the if_broot field of an inode fork.</span>
<span class="cm"> */</span>
<span class="n">STATIC</span> <span class="k">struct</span> <span class="n">xfs_btree_block</span> <span class="o">*</span>
<span class="n">xfs_btree_get_iroot</span><span class="p">(</span>
       <span class="k">struct</span> <span class="n">xfs_btree_cur</span>    <span class="o">*</span><span class="n">cur</span><span class="p">)</span>
<span class="p">{</span>
       <span class="k">struct</span> <span class="n">xfs_ifork</span>        <span class="o">*</span><span class="n">ifp</span><span class="p">;</span>

       <span class="n">ifp</span> <span class="o">=</span> <span class="n">XFS_IFORK_PTR</span><span class="p">(</span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">bc_private</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">ip</span><span class="p">,</span> <span class="n">cur</span><span class="o">-&gt;</span><span class="n">bc_private</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">whichfork</span><span class="p">);</span>
       <span class="k">return</span> <span class="p">(</span><span class="k">struct</span> <span class="n">xfs_btree_block</span> <span class="o">*</span><span class="p">)</span><span class="n">ifp</span><span class="o">-&gt;</span><span class="n">if_broot</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Retrieve the block pointer from the cursor at the given level.</span>
<span class="cm"> * This may be an inode btree root or from a buffer.</span>
<span class="cm"> */</span>
<span class="n">STATIC</span> <span class="k">struct</span> <span class="n">xfs_btree_block</span> <span class="o">*</span>		<span class="cm">/* generic btree block pointer */</span>
<span class="n">xfs_btree_get_block</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">xfs_btree_cur</span>	<span class="o">*</span><span class="n">cur</span><span class="p">,</span>	<span class="cm">/* btree cursor */</span>
	<span class="kt">int</span>			<span class="n">level</span><span class="p">,</span>	<span class="cm">/* level in btree */</span>
	<span class="k">struct</span> <span class="n">xfs_buf</span>		<span class="o">**</span><span class="n">bpp</span><span class="p">)</span>	<span class="cm">/* buffer containing the block */</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">bc_flags</span> <span class="o">&amp;</span> <span class="n">XFS_BTREE_ROOT_IN_INODE</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">level</span> <span class="o">==</span> <span class="n">cur</span><span class="o">-&gt;</span><span class="n">bc_nlevels</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">bpp</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">xfs_btree_get_iroot</span><span class="p">(</span><span class="n">cur</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="o">*</span><span class="n">bpp</span> <span class="o">=</span> <span class="n">cur</span><span class="o">-&gt;</span><span class="n">bc_bufs</span><span class="p">[</span><span class="n">level</span><span class="p">];</span>
	<span class="k">return</span> <span class="n">XFS_BUF_TO_BLOCK</span><span class="p">(</span><span class="o">*</span><span class="n">bpp</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Get a buffer for the block, return it with no data read.</span>
<span class="cm"> * Long-form addressing.</span>
<span class="cm"> */</span>
<span class="n">xfs_buf_t</span> <span class="o">*</span>				<span class="cm">/* buffer for fsbno */</span>
<span class="n">xfs_btree_get_bufl</span><span class="p">(</span>
	<span class="n">xfs_mount_t</span>	<span class="o">*</span><span class="n">mp</span><span class="p">,</span>		<span class="cm">/* file system mount point */</span>
	<span class="n">xfs_trans_t</span>	<span class="o">*</span><span class="n">tp</span><span class="p">,</span>		<span class="cm">/* transaction pointer */</span>
	<span class="n">xfs_fsblock_t</span>	<span class="n">fsbno</span><span class="p">,</span>		<span class="cm">/* file system block number */</span>
	<span class="n">uint</span>		<span class="n">lock</span><span class="p">)</span>		<span class="cm">/* lock flags for get_buf */</span>
<span class="p">{</span>
	<span class="n">xfs_buf_t</span>	<span class="o">*</span><span class="n">bp</span><span class="p">;</span>		<span class="cm">/* buffer pointer (return value) */</span>
	<span class="n">xfs_daddr_t</span>		<span class="n">d</span><span class="p">;</span>		<span class="cm">/* real disk block address */</span>

	<span class="n">ASSERT</span><span class="p">(</span><span class="n">fsbno</span> <span class="o">!=</span> <span class="n">NULLFSBLOCK</span><span class="p">);</span>
	<span class="n">d</span> <span class="o">=</span> <span class="n">XFS_FSB_TO_DADDR</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="n">fsbno</span><span class="p">);</span>
	<span class="n">bp</span> <span class="o">=</span> <span class="n">xfs_trans_get_buf</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_ddev_targp</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_bsize</span><span class="p">,</span> <span class="n">lock</span><span class="p">);</span>
	<span class="n">ASSERT</span><span class="p">(</span><span class="o">!</span><span class="n">xfs_buf_geterror</span><span class="p">(</span><span class="n">bp</span><span class="p">));</span>
	<span class="k">return</span> <span class="n">bp</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Get a buffer for the block, return it with no data read.</span>
<span class="cm"> * Short-form addressing.</span>
<span class="cm"> */</span>
<span class="n">xfs_buf_t</span> <span class="o">*</span>				<span class="cm">/* buffer for agno/agbno */</span>
<span class="n">xfs_btree_get_bufs</span><span class="p">(</span>
	<span class="n">xfs_mount_t</span>	<span class="o">*</span><span class="n">mp</span><span class="p">,</span>		<span class="cm">/* file system mount point */</span>
	<span class="n">xfs_trans_t</span>	<span class="o">*</span><span class="n">tp</span><span class="p">,</span>		<span class="cm">/* transaction pointer */</span>
	<span class="n">xfs_agnumber_t</span>	<span class="n">agno</span><span class="p">,</span>		<span class="cm">/* allocation group number */</span>
	<span class="n">xfs_agblock_t</span>	<span class="n">agbno</span><span class="p">,</span>		<span class="cm">/* allocation group block number */</span>
	<span class="n">uint</span>		<span class="n">lock</span><span class="p">)</span>		<span class="cm">/* lock flags for get_buf */</span>
<span class="p">{</span>
	<span class="n">xfs_buf_t</span>	<span class="o">*</span><span class="n">bp</span><span class="p">;</span>		<span class="cm">/* buffer pointer (return value) */</span>
	<span class="n">xfs_daddr_t</span>		<span class="n">d</span><span class="p">;</span>		<span class="cm">/* real disk block address */</span>

	<span class="n">ASSERT</span><span class="p">(</span><span class="n">agno</span> <span class="o">!=</span> <span class="n">NULLAGNUMBER</span><span class="p">);</span>
	<span class="n">ASSERT</span><span class="p">(</span><span class="n">agbno</span> <span class="o">!=</span> <span class="n">NULLAGBLOCK</span><span class="p">);</span>
	<span class="n">d</span> <span class="o">=</span> <span class="n">XFS_AGB_TO_DADDR</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="n">agno</span><span class="p">,</span> <span class="n">agbno</span><span class="p">);</span>
	<span class="n">bp</span> <span class="o">=</span> <span class="n">xfs_trans_get_buf</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_ddev_targp</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_bsize</span><span class="p">,</span> <span class="n">lock</span><span class="p">);</span>
	<span class="n">ASSERT</span><span class="p">(</span><span class="o">!</span><span class="n">xfs_buf_geterror</span><span class="p">(</span><span class="n">bp</span><span class="p">));</span>
	<span class="k">return</span> <span class="n">bp</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Check for the cursor referring to the last block at the given level.</span>
<span class="cm"> */</span>
<span class="kt">int</span>					<span class="cm">/* 1=is last block, 0=not last block */</span>
<span class="n">xfs_btree_islastblock</span><span class="p">(</span>
	<span class="n">xfs_btree_cur_t</span>		<span class="o">*</span><span class="n">cur</span><span class="p">,</span>	<span class="cm">/* btree cursor */</span>
	<span class="kt">int</span>			<span class="n">level</span><span class="p">)</span>	<span class="cm">/* level to check */</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">xfs_btree_block</span>	<span class="o">*</span><span class="n">block</span><span class="p">;</span>	<span class="cm">/* generic btree block pointer */</span>
	<span class="n">xfs_buf_t</span>		<span class="o">*</span><span class="n">bp</span><span class="p">;</span>	<span class="cm">/* buffer containing block */</span>

	<span class="n">block</span> <span class="o">=</span> <span class="n">xfs_btree_get_block</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">level</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bp</span><span class="p">);</span>
	<span class="n">xfs_btree_check_block</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">block</span><span class="p">,</span> <span class="n">level</span><span class="p">,</span> <span class="n">bp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">bc_flags</span> <span class="o">&amp;</span> <span class="n">XFS_BTREE_LONG_PTRS</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">block</span><span class="o">-&gt;</span><span class="n">bb_u</span><span class="p">.</span><span class="n">l</span><span class="p">.</span><span class="n">bb_rightsib</span> <span class="o">==</span> <span class="n">cpu_to_be64</span><span class="p">(</span><span class="n">NULLDFSBNO</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="n">block</span><span class="o">-&gt;</span><span class="n">bb_u</span><span class="p">.</span><span class="n">s</span><span class="p">.</span><span class="n">bb_rightsib</span> <span class="o">==</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">NULLAGBLOCK</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Change the cursor to point to the first record at the given level.</span>
<span class="cm"> * Other levels are unaffected.</span>
<span class="cm"> */</span>
<span class="n">STATIC</span> <span class="kt">int</span>				<span class="cm">/* success=1, failure=0 */</span>
<span class="n">xfs_btree_firstrec</span><span class="p">(</span>
	<span class="n">xfs_btree_cur_t</span>		<span class="o">*</span><span class="n">cur</span><span class="p">,</span>	<span class="cm">/* btree cursor */</span>
	<span class="kt">int</span>			<span class="n">level</span><span class="p">)</span>	<span class="cm">/* level to change */</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">xfs_btree_block</span>	<span class="o">*</span><span class="n">block</span><span class="p">;</span>	<span class="cm">/* generic btree block pointer */</span>
	<span class="n">xfs_buf_t</span>		<span class="o">*</span><span class="n">bp</span><span class="p">;</span>	<span class="cm">/* buffer containing block */</span>

	<span class="cm">/*</span>
<span class="cm">	 * Get the block pointer for this level.</span>
<span class="cm">	 */</span>
	<span class="n">block</span> <span class="o">=</span> <span class="n">xfs_btree_get_block</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">level</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bp</span><span class="p">);</span>
	<span class="n">xfs_btree_check_block</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">block</span><span class="p">,</span> <span class="n">level</span><span class="p">,</span> <span class="n">bp</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 * It&#39;s empty, there is no such record.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">block</span><span class="o">-&gt;</span><span class="n">bb_numrecs</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * Set the ptr value to 1, that&#39;s the first record/key.</span>
<span class="cm">	 */</span>
	<span class="n">cur</span><span class="o">-&gt;</span><span class="n">bc_ptrs</span><span class="p">[</span><span class="n">level</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Change the cursor to point to the last record in the current block</span>
<span class="cm"> * at the given level.  Other levels are unaffected.</span>
<span class="cm"> */</span>
<span class="n">STATIC</span> <span class="kt">int</span>				<span class="cm">/* success=1, failure=0 */</span>
<span class="n">xfs_btree_lastrec</span><span class="p">(</span>
	<span class="n">xfs_btree_cur_t</span>		<span class="o">*</span><span class="n">cur</span><span class="p">,</span>	<span class="cm">/* btree cursor */</span>
	<span class="kt">int</span>			<span class="n">level</span><span class="p">)</span>	<span class="cm">/* level to change */</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">xfs_btree_block</span>	<span class="o">*</span><span class="n">block</span><span class="p">;</span>	<span class="cm">/* generic btree block pointer */</span>
	<span class="n">xfs_buf_t</span>		<span class="o">*</span><span class="n">bp</span><span class="p">;</span>	<span class="cm">/* buffer containing block */</span>

	<span class="cm">/*</span>
<span class="cm">	 * Get the block pointer for this level.</span>
<span class="cm">	 */</span>
	<span class="n">block</span> <span class="o">=</span> <span class="n">xfs_btree_get_block</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">level</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bp</span><span class="p">);</span>
	<span class="n">xfs_btree_check_block</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">block</span><span class="p">,</span> <span class="n">level</span><span class="p">,</span> <span class="n">bp</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 * It&#39;s empty, there is no such record.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">block</span><span class="o">-&gt;</span><span class="n">bb_numrecs</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * Set the ptr value to numrecs, that&#39;s the last record/key.</span>
<span class="cm">	 */</span>
	<span class="n">cur</span><span class="o">-&gt;</span><span class="n">bc_ptrs</span><span class="p">[</span><span class="n">level</span><span class="p">]</span> <span class="o">=</span> <span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">block</span><span class="o">-&gt;</span><span class="n">bb_numrecs</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Compute first and last byte offsets for the fields given.</span>
<span class="cm"> * Interprets the offsets table, which contains struct field offsets.</span>
<span class="cm"> */</span>
<span class="kt">void</span>
<span class="n">xfs_btree_offsets</span><span class="p">(</span>
	<span class="n">__int64_t</span>	<span class="n">fields</span><span class="p">,</span>		<span class="cm">/* bitmask of fields */</span>
	<span class="k">const</span> <span class="kt">short</span>	<span class="o">*</span><span class="n">offsets</span><span class="p">,</span>	<span class="cm">/* table of field offsets */</span>
	<span class="kt">int</span>		<span class="n">nbits</span><span class="p">,</span>		<span class="cm">/* number of bits to inspect */</span>
	<span class="kt">int</span>		<span class="o">*</span><span class="n">first</span><span class="p">,</span>		<span class="cm">/* output: first byte offset */</span>
	<span class="kt">int</span>		<span class="o">*</span><span class="n">last</span><span class="p">)</span>		<span class="cm">/* output: last byte offset */</span>
<span class="p">{</span>
	<span class="kt">int</span>		<span class="n">i</span><span class="p">;</span>		<span class="cm">/* current bit number */</span>
	<span class="n">__int64_t</span>	<span class="n">imask</span><span class="p">;</span>		<span class="cm">/* mask for current bit number */</span>

	<span class="n">ASSERT</span><span class="p">(</span><span class="n">fields</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 * Find the lowest bit, so the first byte offset.</span>
<span class="cm">	 */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">imask</span> <span class="o">=</span> <span class="mi">1LL</span><span class="p">;</span> <span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">imask</span> <span class="o">&lt;&lt;=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">imask</span> <span class="o">&amp;</span> <span class="n">fields</span><span class="p">)</span> <span class="p">{</span>
			<span class="o">*</span><span class="n">first</span> <span class="o">=</span> <span class="n">offsets</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="cm">/*</span>
<span class="cm">	 * Find the highest bit, so the last byte offset.</span>
<span class="cm">	 */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">nbits</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">imask</span> <span class="o">=</span> <span class="mi">1LL</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">;</span> <span class="p">;</span> <span class="n">i</span><span class="o">--</span><span class="p">,</span> <span class="n">imask</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">imask</span> <span class="o">&amp;</span> <span class="n">fields</span><span class="p">)</span> <span class="p">{</span>
			<span class="o">*</span><span class="n">last</span> <span class="o">=</span> <span class="n">offsets</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Get a buffer for the block, return it read in.</span>
<span class="cm"> * Long-form addressing.</span>
<span class="cm"> */</span>
<span class="kt">int</span>					<span class="cm">/* error */</span>
<span class="n">xfs_btree_read_bufl</span><span class="p">(</span>
	<span class="n">xfs_mount_t</span>	<span class="o">*</span><span class="n">mp</span><span class="p">,</span>		<span class="cm">/* file system mount point */</span>
	<span class="n">xfs_trans_t</span>	<span class="o">*</span><span class="n">tp</span><span class="p">,</span>		<span class="cm">/* transaction pointer */</span>
	<span class="n">xfs_fsblock_t</span>	<span class="n">fsbno</span><span class="p">,</span>		<span class="cm">/* file system block number */</span>
	<span class="n">uint</span>		<span class="n">lock</span><span class="p">,</span>		<span class="cm">/* lock flags for read_buf */</span>
	<span class="n">xfs_buf_t</span>	<span class="o">**</span><span class="n">bpp</span><span class="p">,</span>		<span class="cm">/* buffer for fsbno */</span>
	<span class="kt">int</span>		<span class="n">refval</span><span class="p">)</span>		<span class="cm">/* ref count value for buffer */</span>
<span class="p">{</span>
	<span class="n">xfs_buf_t</span>	<span class="o">*</span><span class="n">bp</span><span class="p">;</span>		<span class="cm">/* return value */</span>
	<span class="n">xfs_daddr_t</span>		<span class="n">d</span><span class="p">;</span>		<span class="cm">/* real disk block address */</span>
	<span class="kt">int</span>		<span class="n">error</span><span class="p">;</span>

	<span class="n">ASSERT</span><span class="p">(</span><span class="n">fsbno</span> <span class="o">!=</span> <span class="n">NULLFSBLOCK</span><span class="p">);</span>
	<span class="n">d</span> <span class="o">=</span> <span class="n">XFS_FSB_TO_DADDR</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="n">fsbno</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">error</span> <span class="o">=</span> <span class="n">xfs_trans_read_buf</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="n">tp</span><span class="p">,</span> <span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_ddev_targp</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span>
			<span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_bsize</span><span class="p">,</span> <span class="n">lock</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bp</span><span class="p">)))</span> <span class="p">{</span>
		<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ASSERT</span><span class="p">(</span><span class="o">!</span><span class="n">xfs_buf_geterror</span><span class="p">(</span><span class="n">bp</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bp</span><span class="p">)</span>
		<span class="n">xfs_buf_set_ref</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">refval</span><span class="p">);</span>
	<span class="o">*</span><span class="n">bpp</span> <span class="o">=</span> <span class="n">bp</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Read-ahead the block, don&#39;t wait for it, don&#39;t return a buffer.</span>
<span class="cm"> * Long-form addressing.</span>
<span class="cm"> */</span>
<span class="cm">/* ARGSUSED */</span>
<span class="kt">void</span>
<span class="n">xfs_btree_reada_bufl</span><span class="p">(</span>
	<span class="n">xfs_mount_t</span>	<span class="o">*</span><span class="n">mp</span><span class="p">,</span>		<span class="cm">/* file system mount point */</span>
	<span class="n">xfs_fsblock_t</span>	<span class="n">fsbno</span><span class="p">,</span>		<span class="cm">/* file system block number */</span>
	<span class="n">xfs_extlen_t</span>	<span class="n">count</span><span class="p">)</span>		<span class="cm">/* count of filesystem blocks */</span>
<span class="p">{</span>
	<span class="n">xfs_daddr_t</span>		<span class="n">d</span><span class="p">;</span>

	<span class="n">ASSERT</span><span class="p">(</span><span class="n">fsbno</span> <span class="o">!=</span> <span class="n">NULLFSBLOCK</span><span class="p">);</span>
	<span class="n">d</span> <span class="o">=</span> <span class="n">XFS_FSB_TO_DADDR</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="n">fsbno</span><span class="p">);</span>
	<span class="n">xfs_buf_readahead</span><span class="p">(</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_ddev_targp</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_bsize</span> <span class="o">*</span> <span class="n">count</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Read-ahead the block, don&#39;t wait for it, don&#39;t return a buffer.</span>
<span class="cm"> * Short-form addressing.</span>
<span class="cm"> */</span>
<span class="cm">/* ARGSUSED */</span>
<span class="kt">void</span>
<span class="n">xfs_btree_reada_bufs</span><span class="p">(</span>
	<span class="n">xfs_mount_t</span>	<span class="o">*</span><span class="n">mp</span><span class="p">,</span>		<span class="cm">/* file system mount point */</span>
	<span class="n">xfs_agnumber_t</span>	<span class="n">agno</span><span class="p">,</span>		<span class="cm">/* allocation group number */</span>
	<span class="n">xfs_agblock_t</span>	<span class="n">agbno</span><span class="p">,</span>		<span class="cm">/* allocation group block number */</span>
	<span class="n">xfs_extlen_t</span>	<span class="n">count</span><span class="p">)</span>		<span class="cm">/* count of filesystem blocks */</span>
<span class="p">{</span>
	<span class="n">xfs_daddr_t</span>		<span class="n">d</span><span class="p">;</span>

	<span class="n">ASSERT</span><span class="p">(</span><span class="n">agno</span> <span class="o">!=</span> <span class="n">NULLAGNUMBER</span><span class="p">);</span>
	<span class="n">ASSERT</span><span class="p">(</span><span class="n">agbno</span> <span class="o">!=</span> <span class="n">NULLAGBLOCK</span><span class="p">);</span>
	<span class="n">d</span> <span class="o">=</span> <span class="n">XFS_AGB_TO_DADDR</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="n">agno</span><span class="p">,</span> <span class="n">agbno</span><span class="p">);</span>
	<span class="n">xfs_buf_readahead</span><span class="p">(</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_ddev_targp</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_bsize</span> <span class="o">*</span> <span class="n">count</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">STATIC</span> <span class="kt">int</span>
<span class="n">xfs_btree_readahead_lblock</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">xfs_btree_cur</span>	<span class="o">*</span><span class="n">cur</span><span class="p">,</span>
	<span class="kt">int</span>			<span class="n">lr</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">xfs_btree_block</span>	<span class="o">*</span><span class="n">block</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span>			<span class="n">rval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">xfs_dfsbno_t</span>		<span class="n">left</span> <span class="o">=</span> <span class="n">be64_to_cpu</span><span class="p">(</span><span class="n">block</span><span class="o">-&gt;</span><span class="n">bb_u</span><span class="p">.</span><span class="n">l</span><span class="p">.</span><span class="n">bb_leftsib</span><span class="p">);</span>
	<span class="n">xfs_dfsbno_t</span>		<span class="n">right</span> <span class="o">=</span> <span class="n">be64_to_cpu</span><span class="p">(</span><span class="n">block</span><span class="o">-&gt;</span><span class="n">bb_u</span><span class="p">.</span><span class="n">l</span><span class="p">.</span><span class="n">bb_rightsib</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">lr</span> <span class="o">&amp;</span> <span class="n">XFS_BTCUR_LEFTRA</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">left</span> <span class="o">!=</span> <span class="n">NULLDFSBNO</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">xfs_btree_reada_bufl</span><span class="p">(</span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">bc_mp</span><span class="p">,</span> <span class="n">left</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">rval</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">lr</span> <span class="o">&amp;</span> <span class="n">XFS_BTCUR_RIGHTRA</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">right</span> <span class="o">!=</span> <span class="n">NULLDFSBNO</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">xfs_btree_reada_bufl</span><span class="p">(</span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">bc_mp</span><span class="p">,</span> <span class="n">right</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">rval</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">rval</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">STATIC</span> <span class="kt">int</span>
<span class="n">xfs_btree_readahead_sblock</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">xfs_btree_cur</span>	<span class="o">*</span><span class="n">cur</span><span class="p">,</span>
	<span class="kt">int</span>			<span class="n">lr</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">xfs_btree_block</span> <span class="o">*</span><span class="n">block</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span>			<span class="n">rval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">xfs_agblock_t</span>		<span class="n">left</span> <span class="o">=</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">block</span><span class="o">-&gt;</span><span class="n">bb_u</span><span class="p">.</span><span class="n">s</span><span class="p">.</span><span class="n">bb_leftsib</span><span class="p">);</span>
	<span class="n">xfs_agblock_t</span>		<span class="n">right</span> <span class="o">=</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">block</span><span class="o">-&gt;</span><span class="n">bb_u</span><span class="p">.</span><span class="n">s</span><span class="p">.</span><span class="n">bb_rightsib</span><span class="p">);</span>


	<span class="k">if</span> <span class="p">((</span><span class="n">lr</span> <span class="o">&amp;</span> <span class="n">XFS_BTCUR_LEFTRA</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">left</span> <span class="o">!=</span> <span class="n">NULLAGBLOCK</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">xfs_btree_reada_bufs</span><span class="p">(</span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">bc_mp</span><span class="p">,</span> <span class="n">cur</span><span class="o">-&gt;</span><span class="n">bc_private</span><span class="p">.</span><span class="n">a</span><span class="p">.</span><span class="n">agno</span><span class="p">,</span>
				     <span class="n">left</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">rval</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">lr</span> <span class="o">&amp;</span> <span class="n">XFS_BTCUR_RIGHTRA</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">right</span> <span class="o">!=</span> <span class="n">NULLAGBLOCK</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">xfs_btree_reada_bufs</span><span class="p">(</span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">bc_mp</span><span class="p">,</span> <span class="n">cur</span><span class="o">-&gt;</span><span class="n">bc_private</span><span class="p">.</span><span class="n">a</span><span class="p">.</span><span class="n">agno</span><span class="p">,</span>
				     <span class="n">right</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">rval</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">rval</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Read-ahead btree blocks, at the given level.</span>
<span class="cm"> * Bits in lr are set from XFS_BTCUR_{LEFT,RIGHT}RA.</span>
<span class="cm"> */</span>
<span class="n">STATIC</span> <span class="kt">int</span>
<span class="n">xfs_btree_readahead</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">xfs_btree_cur</span>	<span class="o">*</span><span class="n">cur</span><span class="p">,</span>		<span class="cm">/* btree cursor */</span>
	<span class="kt">int</span>			<span class="n">lev</span><span class="p">,</span>		<span class="cm">/* level in btree */</span>
	<span class="kt">int</span>			<span class="n">lr</span><span class="p">)</span>		<span class="cm">/* left/right bits */</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">xfs_btree_block</span>	<span class="o">*</span><span class="n">block</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * No readahead needed if we are at the root level and the</span>
<span class="cm">	 * btree root is stored in the inode.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">bc_flags</span> <span class="o">&amp;</span> <span class="n">XFS_BTREE_ROOT_IN_INODE</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">lev</span> <span class="o">==</span> <span class="n">cur</span><span class="o">-&gt;</span><span class="n">bc_nlevels</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">bc_ra</span><span class="p">[</span><span class="n">lev</span><span class="p">]</span> <span class="o">|</span> <span class="n">lr</span><span class="p">)</span> <span class="o">==</span> <span class="n">cur</span><span class="o">-&gt;</span><span class="n">bc_ra</span><span class="p">[</span><span class="n">lev</span><span class="p">])</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">cur</span><span class="o">-&gt;</span><span class="n">bc_ra</span><span class="p">[</span><span class="n">lev</span><span class="p">]</span> <span class="o">|=</span> <span class="n">lr</span><span class="p">;</span>
	<span class="n">block</span> <span class="o">=</span> <span class="n">XFS_BUF_TO_BLOCK</span><span class="p">(</span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">bc_bufs</span><span class="p">[</span><span class="n">lev</span><span class="p">]);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">bc_flags</span> <span class="o">&amp;</span> <span class="n">XFS_BTREE_LONG_PTRS</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">xfs_btree_readahead_lblock</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">lr</span><span class="p">,</span> <span class="n">block</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">xfs_btree_readahead_sblock</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">lr</span><span class="p">,</span> <span class="n">block</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Set the buffer for level &quot;lev&quot; in the cursor to bp, releasing</span>
<span class="cm"> * any previous buffer.</span>
<span class="cm"> */</span>
<span class="n">STATIC</span> <span class="kt">void</span>
<span class="n">xfs_btree_setbuf</span><span class="p">(</span>
	<span class="n">xfs_btree_cur_t</span>		<span class="o">*</span><span class="n">cur</span><span class="p">,</span>	<span class="cm">/* btree cursor */</span>
	<span class="kt">int</span>			<span class="n">lev</span><span class="p">,</span>	<span class="cm">/* level in btree */</span>
	<span class="n">xfs_buf_t</span>		<span class="o">*</span><span class="n">bp</span><span class="p">)</span>	<span class="cm">/* new buffer to set */</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">xfs_btree_block</span>	<span class="o">*</span><span class="n">b</span><span class="p">;</span>	<span class="cm">/* btree block */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">bc_bufs</span><span class="p">[</span><span class="n">lev</span><span class="p">])</span>
		<span class="n">xfs_trans_brelse</span><span class="p">(</span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">bc_tp</span><span class="p">,</span> <span class="n">cur</span><span class="o">-&gt;</span><span class="n">bc_bufs</span><span class="p">[</span><span class="n">lev</span><span class="p">]);</span>
	<span class="n">cur</span><span class="o">-&gt;</span><span class="n">bc_bufs</span><span class="p">[</span><span class="n">lev</span><span class="p">]</span> <span class="o">=</span> <span class="n">bp</span><span class="p">;</span>
	<span class="n">cur</span><span class="o">-&gt;</span><span class="n">bc_ra</span><span class="p">[</span><span class="n">lev</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">b</span> <span class="o">=</span> <span class="n">XFS_BUF_TO_BLOCK</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">bc_flags</span> <span class="o">&amp;</span> <span class="n">XFS_BTREE_LONG_PTRS</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">b</span><span class="o">-&gt;</span><span class="n">bb_u</span><span class="p">.</span><span class="n">l</span><span class="p">.</span><span class="n">bb_leftsib</span> <span class="o">==</span> <span class="n">cpu_to_be64</span><span class="p">(</span><span class="n">NULLDFSBNO</span><span class="p">))</span>
			<span class="n">cur</span><span class="o">-&gt;</span><span class="n">bc_ra</span><span class="p">[</span><span class="n">lev</span><span class="p">]</span> <span class="o">|=</span> <span class="n">XFS_BTCUR_LEFTRA</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">b</span><span class="o">-&gt;</span><span class="n">bb_u</span><span class="p">.</span><span class="n">l</span><span class="p">.</span><span class="n">bb_rightsib</span> <span class="o">==</span> <span class="n">cpu_to_be64</span><span class="p">(</span><span class="n">NULLDFSBNO</span><span class="p">))</span>
			<span class="n">cur</span><span class="o">-&gt;</span><span class="n">bc_ra</span><span class="p">[</span><span class="n">lev</span><span class="p">]</span> <span class="o">|=</span> <span class="n">XFS_BTCUR_RIGHTRA</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">b</span><span class="o">-&gt;</span><span class="n">bb_u</span><span class="p">.</span><span class="n">s</span><span class="p">.</span><span class="n">bb_leftsib</span> <span class="o">==</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">NULLAGBLOCK</span><span class="p">))</span>
			<span class="n">cur</span><span class="o">-&gt;</span><span class="n">bc_ra</span><span class="p">[</span><span class="n">lev</span><span class="p">]</span> <span class="o">|=</span> <span class="n">XFS_BTCUR_LEFTRA</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">b</span><span class="o">-&gt;</span><span class="n">bb_u</span><span class="p">.</span><span class="n">s</span><span class="p">.</span><span class="n">bb_rightsib</span> <span class="o">==</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">NULLAGBLOCK</span><span class="p">))</span>
			<span class="n">cur</span><span class="o">-&gt;</span><span class="n">bc_ra</span><span class="p">[</span><span class="n">lev</span><span class="p">]</span> <span class="o">|=</span> <span class="n">XFS_BTCUR_RIGHTRA</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="n">STATIC</span> <span class="kt">int</span>
<span class="n">xfs_btree_ptr_is_null</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">xfs_btree_cur</span>	<span class="o">*</span><span class="n">cur</span><span class="p">,</span>
	<span class="k">union</span> <span class="n">xfs_btree_ptr</span>	<span class="o">*</span><span class="n">ptr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">bc_flags</span> <span class="o">&amp;</span> <span class="n">XFS_BTREE_LONG_PTRS</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ptr</span><span class="o">-&gt;</span><span class="n">l</span> <span class="o">==</span> <span class="n">cpu_to_be64</span><span class="p">(</span><span class="n">NULLDFSBNO</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="n">ptr</span><span class="o">-&gt;</span><span class="n">s</span> <span class="o">==</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">NULLAGBLOCK</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">STATIC</span> <span class="kt">void</span>
<span class="n">xfs_btree_set_ptr_null</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">xfs_btree_cur</span>	<span class="o">*</span><span class="n">cur</span><span class="p">,</span>
	<span class="k">union</span> <span class="n">xfs_btree_ptr</span>	<span class="o">*</span><span class="n">ptr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">bc_flags</span> <span class="o">&amp;</span> <span class="n">XFS_BTREE_LONG_PTRS</span><span class="p">)</span>
		<span class="n">ptr</span><span class="o">-&gt;</span><span class="n">l</span> <span class="o">=</span> <span class="n">cpu_to_be64</span><span class="p">(</span><span class="n">NULLDFSBNO</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">ptr</span><span class="o">-&gt;</span><span class="n">s</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">NULLAGBLOCK</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Get/set/init sibling pointers</span>
<span class="cm"> */</span>
<span class="n">STATIC</span> <span class="kt">void</span>
<span class="n">xfs_btree_get_sibling</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">xfs_btree_cur</span>	<span class="o">*</span><span class="n">cur</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">xfs_btree_block</span>	<span class="o">*</span><span class="n">block</span><span class="p">,</span>
	<span class="k">union</span> <span class="n">xfs_btree_ptr</span>	<span class="o">*</span><span class="n">ptr</span><span class="p">,</span>
	<span class="kt">int</span>			<span class="n">lr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ASSERT</span><span class="p">(</span><span class="n">lr</span> <span class="o">==</span> <span class="n">XFS_BB_LEFTSIB</span> <span class="o">||</span> <span class="n">lr</span> <span class="o">==</span> <span class="n">XFS_BB_RIGHTSIB</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">bc_flags</span> <span class="o">&amp;</span> <span class="n">XFS_BTREE_LONG_PTRS</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">lr</span> <span class="o">==</span> <span class="n">XFS_BB_RIGHTSIB</span><span class="p">)</span>
			<span class="n">ptr</span><span class="o">-&gt;</span><span class="n">l</span> <span class="o">=</span> <span class="n">block</span><span class="o">-&gt;</span><span class="n">bb_u</span><span class="p">.</span><span class="n">l</span><span class="p">.</span><span class="n">bb_rightsib</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">ptr</span><span class="o">-&gt;</span><span class="n">l</span> <span class="o">=</span> <span class="n">block</span><span class="o">-&gt;</span><span class="n">bb_u</span><span class="p">.</span><span class="n">l</span><span class="p">.</span><span class="n">bb_leftsib</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">lr</span> <span class="o">==</span> <span class="n">XFS_BB_RIGHTSIB</span><span class="p">)</span>
			<span class="n">ptr</span><span class="o">-&gt;</span><span class="n">s</span> <span class="o">=</span> <span class="n">block</span><span class="o">-&gt;</span><span class="n">bb_u</span><span class="p">.</span><span class="n">s</span><span class="p">.</span><span class="n">bb_rightsib</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">ptr</span><span class="o">-&gt;</span><span class="n">s</span> <span class="o">=</span> <span class="n">block</span><span class="o">-&gt;</span><span class="n">bb_u</span><span class="p">.</span><span class="n">s</span><span class="p">.</span><span class="n">bb_leftsib</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="n">STATIC</span> <span class="kt">void</span>
<span class="n">xfs_btree_set_sibling</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">xfs_btree_cur</span>	<span class="o">*</span><span class="n">cur</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">xfs_btree_block</span>	<span class="o">*</span><span class="n">block</span><span class="p">,</span>
	<span class="k">union</span> <span class="n">xfs_btree_ptr</span>	<span class="o">*</span><span class="n">ptr</span><span class="p">,</span>
	<span class="kt">int</span>			<span class="n">lr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ASSERT</span><span class="p">(</span><span class="n">lr</span> <span class="o">==</span> <span class="n">XFS_BB_LEFTSIB</span> <span class="o">||</span> <span class="n">lr</span> <span class="o">==</span> <span class="n">XFS_BB_RIGHTSIB</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">bc_flags</span> <span class="o">&amp;</span> <span class="n">XFS_BTREE_LONG_PTRS</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">lr</span> <span class="o">==</span> <span class="n">XFS_BB_RIGHTSIB</span><span class="p">)</span>
			<span class="n">block</span><span class="o">-&gt;</span><span class="n">bb_u</span><span class="p">.</span><span class="n">l</span><span class="p">.</span><span class="n">bb_rightsib</span> <span class="o">=</span> <span class="n">ptr</span><span class="o">-&gt;</span><span class="n">l</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">block</span><span class="o">-&gt;</span><span class="n">bb_u</span><span class="p">.</span><span class="n">l</span><span class="p">.</span><span class="n">bb_leftsib</span> <span class="o">=</span> <span class="n">ptr</span><span class="o">-&gt;</span><span class="n">l</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">lr</span> <span class="o">==</span> <span class="n">XFS_BB_RIGHTSIB</span><span class="p">)</span>
			<span class="n">block</span><span class="o">-&gt;</span><span class="n">bb_u</span><span class="p">.</span><span class="n">s</span><span class="p">.</span><span class="n">bb_rightsib</span> <span class="o">=</span> <span class="n">ptr</span><span class="o">-&gt;</span><span class="n">s</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">block</span><span class="o">-&gt;</span><span class="n">bb_u</span><span class="p">.</span><span class="n">s</span><span class="p">.</span><span class="n">bb_leftsib</span> <span class="o">=</span> <span class="n">ptr</span><span class="o">-&gt;</span><span class="n">s</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="n">STATIC</span> <span class="kt">void</span>
<span class="n">xfs_btree_init_block</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">xfs_btree_cur</span>	<span class="o">*</span><span class="n">cur</span><span class="p">,</span>
	<span class="kt">int</span>			<span class="n">level</span><span class="p">,</span>
	<span class="kt">int</span>			<span class="n">numrecs</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">xfs_btree_block</span>	<span class="o">*</span><span class="n">new</span><span class="p">)</span>	<span class="cm">/* new block */</span>
<span class="p">{</span>
	<span class="n">new</span><span class="o">-&gt;</span><span class="n">bb_magic</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">xfs_magics</span><span class="p">[</span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">bc_btnum</span><span class="p">]);</span>
	<span class="n">new</span><span class="o">-&gt;</span><span class="n">bb_level</span> <span class="o">=</span> <span class="n">cpu_to_be16</span><span class="p">(</span><span class="n">level</span><span class="p">);</span>
	<span class="n">new</span><span class="o">-&gt;</span><span class="n">bb_numrecs</span> <span class="o">=</span> <span class="n">cpu_to_be16</span><span class="p">(</span><span class="n">numrecs</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">bc_flags</span> <span class="o">&amp;</span> <span class="n">XFS_BTREE_LONG_PTRS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">new</span><span class="o">-&gt;</span><span class="n">bb_u</span><span class="p">.</span><span class="n">l</span><span class="p">.</span><span class="n">bb_leftsib</span> <span class="o">=</span> <span class="n">cpu_to_be64</span><span class="p">(</span><span class="n">NULLDFSBNO</span><span class="p">);</span>
		<span class="n">new</span><span class="o">-&gt;</span><span class="n">bb_u</span><span class="p">.</span><span class="n">l</span><span class="p">.</span><span class="n">bb_rightsib</span> <span class="o">=</span> <span class="n">cpu_to_be64</span><span class="p">(</span><span class="n">NULLDFSBNO</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">new</span><span class="o">-&gt;</span><span class="n">bb_u</span><span class="p">.</span><span class="n">s</span><span class="p">.</span><span class="n">bb_leftsib</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">NULLAGBLOCK</span><span class="p">);</span>
		<span class="n">new</span><span class="o">-&gt;</span><span class="n">bb_u</span><span class="p">.</span><span class="n">s</span><span class="p">.</span><span class="n">bb_rightsib</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">NULLAGBLOCK</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Return true if ptr is the last record in the btree and</span>
<span class="cm"> * we need to track updateѕ to this record.  The decision</span>
<span class="cm"> * will be further refined in the update_lastrec method.</span>
<span class="cm"> */</span>
<span class="n">STATIC</span> <span class="kt">int</span>
<span class="n">xfs_btree_is_lastrec</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">xfs_btree_cur</span>	<span class="o">*</span><span class="n">cur</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">xfs_btree_block</span>	<span class="o">*</span><span class="n">block</span><span class="p">,</span>
	<span class="kt">int</span>			<span class="n">level</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">union</span> <span class="n">xfs_btree_ptr</span>	<span class="n">ptr</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">level</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">bc_flags</span> <span class="o">&amp;</span> <span class="n">XFS_BTREE_LASTREC_UPDATE</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">xfs_btree_get_sibling</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">block</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ptr</span><span class="p">,</span> <span class="n">XFS_BB_RIGHTSIB</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">xfs_btree_ptr_is_null</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ptr</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">STATIC</span> <span class="kt">void</span>
<span class="n">xfs_btree_buf_to_ptr</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">xfs_btree_cur</span>	<span class="o">*</span><span class="n">cur</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">xfs_buf</span>		<span class="o">*</span><span class="n">bp</span><span class="p">,</span>
	<span class="k">union</span> <span class="n">xfs_btree_ptr</span>	<span class="o">*</span><span class="n">ptr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">bc_flags</span> <span class="o">&amp;</span> <span class="n">XFS_BTREE_LONG_PTRS</span><span class="p">)</span>
		<span class="n">ptr</span><span class="o">-&gt;</span><span class="n">l</span> <span class="o">=</span> <span class="n">cpu_to_be64</span><span class="p">(</span><span class="n">XFS_DADDR_TO_FSB</span><span class="p">(</span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">bc_mp</span><span class="p">,</span>
					<span class="n">XFS_BUF_ADDR</span><span class="p">(</span><span class="n">bp</span><span class="p">)));</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">ptr</span><span class="o">-&gt;</span><span class="n">s</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">xfs_daddr_to_agbno</span><span class="p">(</span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">bc_mp</span><span class="p">,</span>
					<span class="n">XFS_BUF_ADDR</span><span class="p">(</span><span class="n">bp</span><span class="p">)));</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="n">STATIC</span> <span class="n">xfs_daddr_t</span>
<span class="n">xfs_btree_ptr_to_daddr</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">xfs_btree_cur</span>	<span class="o">*</span><span class="n">cur</span><span class="p">,</span>
	<span class="k">union</span> <span class="n">xfs_btree_ptr</span>	<span class="o">*</span><span class="n">ptr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">bc_flags</span> <span class="o">&amp;</span> <span class="n">XFS_BTREE_LONG_PTRS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ASSERT</span><span class="p">(</span><span class="n">ptr</span><span class="o">-&gt;</span><span class="n">l</span> <span class="o">!=</span> <span class="n">cpu_to_be64</span><span class="p">(</span><span class="n">NULLDFSBNO</span><span class="p">));</span>

		<span class="k">return</span> <span class="n">XFS_FSB_TO_DADDR</span><span class="p">(</span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">bc_mp</span><span class="p">,</span> <span class="n">be64_to_cpu</span><span class="p">(</span><span class="n">ptr</span><span class="o">-&gt;</span><span class="n">l</span><span class="p">));</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ASSERT</span><span class="p">(</span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">bc_private</span><span class="p">.</span><span class="n">a</span><span class="p">.</span><span class="n">agno</span> <span class="o">!=</span> <span class="n">NULLAGNUMBER</span><span class="p">);</span>
		<span class="n">ASSERT</span><span class="p">(</span><span class="n">ptr</span><span class="o">-&gt;</span><span class="n">s</span> <span class="o">!=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">NULLAGBLOCK</span><span class="p">));</span>

		<span class="k">return</span> <span class="n">XFS_AGB_TO_DADDR</span><span class="p">(</span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">bc_mp</span><span class="p">,</span> <span class="n">cur</span><span class="o">-&gt;</span><span class="n">bc_private</span><span class="p">.</span><span class="n">a</span><span class="p">.</span><span class="n">agno</span><span class="p">,</span>
					<span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">ptr</span><span class="o">-&gt;</span><span class="n">s</span><span class="p">));</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="n">STATIC</span> <span class="kt">void</span>
<span class="n">xfs_btree_set_refs</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">xfs_btree_cur</span>	<span class="o">*</span><span class="n">cur</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">xfs_buf</span>		<span class="o">*</span><span class="n">bp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">bc_btnum</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">XFS_BTNUM_BNO</span>:
	<span class="k">case</span> <span class="n">XFS_BTNUM_CNT</span>:
		<span class="n">xfs_buf_set_ref</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">XFS_ALLOC_BTREE_REF</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">XFS_BTNUM_INO</span>:
		<span class="n">xfs_buf_set_ref</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">XFS_INO_BTREE_REF</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">XFS_BTNUM_BMAP</span>:
		<span class="n">xfs_buf_set_ref</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">XFS_BMAP_BTREE_REF</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">ASSERT</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="n">STATIC</span> <span class="kt">int</span>
<span class="n">xfs_btree_get_buf_block</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">xfs_btree_cur</span>	<span class="o">*</span><span class="n">cur</span><span class="p">,</span>
	<span class="k">union</span> <span class="n">xfs_btree_ptr</span>	<span class="o">*</span><span class="n">ptr</span><span class="p">,</span>
	<span class="kt">int</span>			<span class="n">flags</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">xfs_btree_block</span>	<span class="o">**</span><span class="n">block</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">xfs_buf</span>		<span class="o">**</span><span class="n">bpp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">xfs_mount</span>	<span class="o">*</span><span class="n">mp</span> <span class="o">=</span> <span class="n">cur</span><span class="o">-&gt;</span><span class="n">bc_mp</span><span class="p">;</span>
	<span class="n">xfs_daddr_t</span>		<span class="n">d</span><span class="p">;</span>

	<span class="cm">/* need to sort out how callers deal with failures first */</span>
	<span class="n">ASSERT</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">XBF_TRYLOCK</span><span class="p">));</span>

	<span class="n">d</span> <span class="o">=</span> <span class="n">xfs_btree_ptr_to_daddr</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">ptr</span><span class="p">);</span>
	<span class="o">*</span><span class="n">bpp</span> <span class="o">=</span> <span class="n">xfs_trans_get_buf</span><span class="p">(</span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">bc_tp</span><span class="p">,</span> <span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_ddev_targp</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span>
				 <span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_bsize</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!*</span><span class="n">bpp</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ENOMEM</span><span class="p">;</span>

	<span class="o">*</span><span class="n">block</span> <span class="o">=</span> <span class="n">XFS_BUF_TO_BLOCK</span><span class="p">(</span><span class="o">*</span><span class="n">bpp</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Read in the buffer at the given ptr and return the buffer and</span>
<span class="cm"> * the block pointer within the buffer.</span>
<span class="cm"> */</span>
<span class="n">STATIC</span> <span class="kt">int</span>
<span class="n">xfs_btree_read_buf_block</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">xfs_btree_cur</span>	<span class="o">*</span><span class="n">cur</span><span class="p">,</span>
	<span class="k">union</span> <span class="n">xfs_btree_ptr</span>	<span class="o">*</span><span class="n">ptr</span><span class="p">,</span>
	<span class="kt">int</span>			<span class="n">level</span><span class="p">,</span>
	<span class="kt">int</span>			<span class="n">flags</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">xfs_btree_block</span>	<span class="o">**</span><span class="n">block</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">xfs_buf</span>		<span class="o">**</span><span class="n">bpp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">xfs_mount</span>	<span class="o">*</span><span class="n">mp</span> <span class="o">=</span> <span class="n">cur</span><span class="o">-&gt;</span><span class="n">bc_mp</span><span class="p">;</span>
	<span class="n">xfs_daddr_t</span>		<span class="n">d</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">error</span><span class="p">;</span>

	<span class="cm">/* need to sort out how callers deal with failures first */</span>
	<span class="n">ASSERT</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">XBF_TRYLOCK</span><span class="p">));</span>

	<span class="n">d</span> <span class="o">=</span> <span class="n">xfs_btree_ptr_to_daddr</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">ptr</span><span class="p">);</span>
	<span class="n">error</span> <span class="o">=</span> <span class="n">xfs_trans_read_buf</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="n">cur</span><span class="o">-&gt;</span><span class="n">bc_tp</span><span class="p">,</span> <span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_ddev_targp</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span>
				   <span class="n">mp</span><span class="o">-&gt;</span><span class="n">m_bsize</span><span class="p">,</span> <span class="n">flags</span><span class="p">,</span> <span class="n">bpp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">error</span><span class="p">;</span>

	<span class="n">ASSERT</span><span class="p">(</span><span class="o">!</span><span class="n">xfs_buf_geterror</span><span class="p">(</span><span class="o">*</span><span class="n">bpp</span><span class="p">));</span>

	<span class="n">xfs_btree_set_refs</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="o">*</span><span class="n">bpp</span><span class="p">);</span>
	<span class="o">*</span><span class="n">block</span> <span class="o">=</span> <span class="n">XFS_BUF_TO_BLOCK</span><span class="p">(</span><span class="o">*</span><span class="n">bpp</span><span class="p">);</span>

	<span class="n">error</span> <span class="o">=</span> <span class="n">xfs_btree_check_block</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="o">*</span><span class="n">block</span><span class="p">,</span> <span class="n">level</span><span class="p">,</span> <span class="o">*</span><span class="n">bpp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
		<span class="n">xfs_trans_brelse</span><span class="p">(</span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">bc_tp</span><span class="p">,</span> <span class="o">*</span><span class="n">bpp</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Copy keys from one btree block to another.</span>
<span class="cm"> */</span>
<span class="n">STATIC</span> <span class="kt">void</span>
<span class="n">xfs_btree_copy_keys</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">xfs_btree_cur</span>	<span class="o">*</span><span class="n">cur</span><span class="p">,</span>
	<span class="k">union</span> <span class="n">xfs_btree_key</span>	<span class="o">*</span><span class="n">dst_key</span><span class="p">,</span>
	<span class="k">union</span> <span class="n">xfs_btree_key</span>	<span class="o">*</span><span class="n">src_key</span><span class="p">,</span>
	<span class="kt">int</span>			<span class="n">numkeys</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ASSERT</span><span class="p">(</span><span class="n">numkeys</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">dst_key</span><span class="p">,</span> <span class="n">src_key</span><span class="p">,</span> <span class="n">numkeys</span> <span class="o">*</span> <span class="n">cur</span><span class="o">-&gt;</span><span class="n">bc_ops</span><span class="o">-&gt;</span><span class="n">key_len</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Copy records from one btree block to another.</span>
<span class="cm"> */</span>
<span class="n">STATIC</span> <span class="kt">void</span>
<span class="n">xfs_btree_copy_recs</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">xfs_btree_cur</span>	<span class="o">*</span><span class="n">cur</span><span class="p">,</span>
	<span class="k">union</span> <span class="n">xfs_btree_rec</span>	<span class="o">*</span><span class="n">dst_rec</span><span class="p">,</span>
	<span class="k">union</span> <span class="n">xfs_btree_rec</span>	<span class="o">*</span><span class="n">src_rec</span><span class="p">,</span>
	<span class="kt">int</span>			<span class="n">numrecs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ASSERT</span><span class="p">(</span><span class="n">numrecs</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">dst_rec</span><span class="p">,</span> <span class="n">src_rec</span><span class="p">,</span> <span class="n">numrecs</span> <span class="o">*</span> <span class="n">cur</span><span class="o">-&gt;</span><span class="n">bc_ops</span><span class="o">-&gt;</span><span class="n">rec_len</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Copy block pointers from one btree block to another.</span>
<span class="cm"> */</span>
<span class="n">STATIC</span> <span class="kt">void</span>
<span class="n">xfs_btree_copy_ptrs</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">xfs_btree_cur</span>	<span class="o">*</span><span class="n">cur</span><span class="p">,</span>
	<span class="k">union</span> <span class="n">xfs_btree_ptr</span>	<span class="o">*</span><span class="n">dst_ptr</span><span class="p">,</span>
	<span class="k">union</span> <span class="n">xfs_btree_ptr</span>	<span class="o">*</span><span class="n">src_ptr</span><span class="p">,</span>
	<span class="kt">int</span>			<span class="n">numptrs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ASSERT</span><span class="p">(</span><span class="n">numptrs</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">dst_ptr</span><span class="p">,</span> <span class="n">src_ptr</span><span class="p">,</span> <span class="n">numptrs</span> <span class="o">*</span> <span class="n">xfs_btree_ptr_len</span><span class="p">(</span><span class="n">cur</span><span class="p">));</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Shift keys one index left/right inside a single btree block.</span>
<span class="cm"> */</span>
<span class="n">STATIC</span> <span class="kt">void</span>
<span class="n">xfs_btree_shift_keys</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">xfs_btree_cur</span>	<span class="o">*</span><span class="n">cur</span><span class="p">,</span>
	<span class="k">union</span> <span class="n">xfs_btree_key</span>	<span class="o">*</span><span class="n">key</span><span class="p">,</span>
	<span class="kt">int</span>			<span class="n">dir</span><span class="p">,</span>
	<span class="kt">int</span>			<span class="n">numkeys</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span>			<span class="o">*</span><span class="n">dst_key</span><span class="p">;</span>

	<span class="n">ASSERT</span><span class="p">(</span><span class="n">numkeys</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">ASSERT</span><span class="p">(</span><span class="n">dir</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">||</span> <span class="n">dir</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>

	<span class="n">dst_key</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">key</span> <span class="o">+</span> <span class="p">(</span><span class="n">dir</span> <span class="o">*</span> <span class="n">cur</span><span class="o">-&gt;</span><span class="n">bc_ops</span><span class="o">-&gt;</span><span class="n">key_len</span><span class="p">);</span>
	<span class="n">memmove</span><span class="p">(</span><span class="n">dst_key</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">numkeys</span> <span class="o">*</span> <span class="n">cur</span><span class="o">-&gt;</span><span class="n">bc_ops</span><span class="o">-&gt;</span><span class="n">key_len</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Shift records one index left/right inside a single btree block.</span>
<span class="cm"> */</span>
<span class="n">STATIC</span> <span class="kt">void</span>
<span class="n">xfs_btree_shift_recs</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">xfs_btree_cur</span>	<span class="o">*</span><span class="n">cur</span><span class="p">,</span>
	<span class="k">union</span> <span class="n">xfs_btree_rec</span>	<span class="o">*</span><span class="n">rec</span><span class="p">,</span>
	<span class="kt">int</span>			<span class="n">dir</span><span class="p">,</span>
	<span class="kt">int</span>			<span class="n">numrecs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span>			<span class="o">*</span><span class="n">dst_rec</span><span class="p">;</span>

	<span class="n">ASSERT</span><span class="p">(</span><span class="n">numrecs</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">ASSERT</span><span class="p">(</span><span class="n">dir</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">||</span> <span class="n">dir</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>

	<span class="n">dst_rec</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">rec</span> <span class="o">+</span> <span class="p">(</span><span class="n">dir</span> <span class="o">*</span> <span class="n">cur</span><span class="o">-&gt;</span><span class="n">bc_ops</span><span class="o">-&gt;</span><span class="n">rec_len</span><span class="p">);</span>
	<span class="n">memmove</span><span class="p">(</span><span class="n">dst_rec</span><span class="p">,</span> <span class="n">rec</span><span class="p">,</span> <span class="n">numrecs</span> <span class="o">*</span> <span class="n">cur</span><span class="o">-&gt;</span><span class="n">bc_ops</span><span class="o">-&gt;</span><span class="n">rec_len</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Shift block pointers one index left/right inside a single btree block.</span>
<span class="cm"> */</span>
<span class="n">STATIC</span> <span class="kt">void</span>
<span class="n">xfs_btree_shift_ptrs</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">xfs_btree_cur</span>	<span class="o">*</span><span class="n">cur</span><span class="p">,</span>
	<span class="k">union</span> <span class="n">xfs_btree_ptr</span>	<span class="o">*</span><span class="n">ptr</span><span class="p">,</span>
	<span class="kt">int</span>			<span class="n">dir</span><span class="p">,</span>
	<span class="kt">int</span>			<span class="n">numptrs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span>			<span class="o">*</span><span class="n">dst_ptr</span><span class="p">;</span>

	<span class="n">ASSERT</span><span class="p">(</span><span class="n">numptrs</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">ASSERT</span><span class="p">(</span><span class="n">dir</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">||</span> <span class="n">dir</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>

	<span class="n">dst_ptr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">ptr</span> <span class="o">+</span> <span class="p">(</span><span class="n">dir</span> <span class="o">*</span> <span class="n">xfs_btree_ptr_len</span><span class="p">(</span><span class="n">cur</span><span class="p">));</span>
	<span class="n">memmove</span><span class="p">(</span><span class="n">dst_ptr</span><span class="p">,</span> <span class="n">ptr</span><span class="p">,</span> <span class="n">numptrs</span> <span class="o">*</span> <span class="n">xfs_btree_ptr_len</span><span class="p">(</span><span class="n">cur</span><span class="p">));</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Log key values from the btree block.</span>
<span class="cm"> */</span>
<span class="n">STATIC</span> <span class="kt">void</span>
<span class="n">xfs_btree_log_keys</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">xfs_btree_cur</span>	<span class="o">*</span><span class="n">cur</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">xfs_buf</span>		<span class="o">*</span><span class="n">bp</span><span class="p">,</span>
	<span class="kt">int</span>			<span class="n">first</span><span class="p">,</span>
	<span class="kt">int</span>			<span class="n">last</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">XFS_BTREE_TRACE_CURSOR</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">XBT_ENTRY</span><span class="p">);</span>
	<span class="n">XFS_BTREE_TRACE_ARGBII</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">bp</span><span class="p">,</span> <span class="n">first</span><span class="p">,</span> <span class="n">last</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bp</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">xfs_trans_log_buf</span><span class="p">(</span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">bc_tp</span><span class="p">,</span> <span class="n">bp</span><span class="p">,</span>
				  <span class="n">xfs_btree_key_offset</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">first</span><span class="p">),</span>
				  <span class="n">xfs_btree_key_offset</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">last</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">xfs_trans_log_inode</span><span class="p">(</span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">bc_tp</span><span class="p">,</span> <span class="n">cur</span><span class="o">-&gt;</span><span class="n">bc_private</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">ip</span><span class="p">,</span>
				<span class="n">xfs_ilog_fbroot</span><span class="p">(</span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">bc_private</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">whichfork</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="n">XFS_BTREE_TRACE_CURSOR</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">XBT_EXIT</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Log record values from the btree block.</span>
<span class="cm"> */</span>
<span class="kt">void</span>
<span class="n">xfs_btree_log_recs</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">xfs_btree_cur</span>	<span class="o">*</span><span class="n">cur</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">xfs_buf</span>		<span class="o">*</span><span class="n">bp</span><span class="p">,</span>
	<span class="kt">int</span>			<span class="n">first</span><span class="p">,</span>
	<span class="kt">int</span>			<span class="n">last</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">XFS_BTREE_TRACE_CURSOR</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">XBT_ENTRY</span><span class="p">);</span>
	<span class="n">XFS_BTREE_TRACE_ARGBII</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">bp</span><span class="p">,</span> <span class="n">first</span><span class="p">,</span> <span class="n">last</span><span class="p">);</span>

	<span class="n">xfs_trans_log_buf</span><span class="p">(</span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">bc_tp</span><span class="p">,</span> <span class="n">bp</span><span class="p">,</span>
			  <span class="n">xfs_btree_rec_offset</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">first</span><span class="p">),</span>
			  <span class="n">xfs_btree_rec_offset</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">last</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">XFS_BTREE_TRACE_CURSOR</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">XBT_EXIT</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Log block pointer fields from a btree block (nonleaf).</span>
<span class="cm"> */</span>
<span class="n">STATIC</span> <span class="kt">void</span>
<span class="n">xfs_btree_log_ptrs</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">xfs_btree_cur</span>	<span class="o">*</span><span class="n">cur</span><span class="p">,</span>	<span class="cm">/* btree cursor */</span>
	<span class="k">struct</span> <span class="n">xfs_buf</span>		<span class="o">*</span><span class="n">bp</span><span class="p">,</span>	<span class="cm">/* buffer containing btree block */</span>
	<span class="kt">int</span>			<span class="n">first</span><span class="p">,</span>	<span class="cm">/* index of first pointer to log */</span>
	<span class="kt">int</span>			<span class="n">last</span><span class="p">)</span>	<span class="cm">/* index of last pointer to log */</span>
<span class="p">{</span>
	<span class="n">XFS_BTREE_TRACE_CURSOR</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">XBT_ENTRY</span><span class="p">);</span>
	<span class="n">XFS_BTREE_TRACE_ARGBII</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">bp</span><span class="p">,</span> <span class="n">first</span><span class="p">,</span> <span class="n">last</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bp</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">xfs_btree_block</span>	<span class="o">*</span><span class="n">block</span> <span class="o">=</span> <span class="n">XFS_BUF_TO_BLOCK</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>
		<span class="kt">int</span>			<span class="n">level</span> <span class="o">=</span> <span class="n">xfs_btree_get_level</span><span class="p">(</span><span class="n">block</span><span class="p">);</span>

		<span class="n">xfs_trans_log_buf</span><span class="p">(</span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">bc_tp</span><span class="p">,</span> <span class="n">bp</span><span class="p">,</span>
				<span class="n">xfs_btree_ptr_offset</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">first</span><span class="p">,</span> <span class="n">level</span><span class="p">),</span>
				<span class="n">xfs_btree_ptr_offset</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">last</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">level</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">xfs_trans_log_inode</span><span class="p">(</span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">bc_tp</span><span class="p">,</span> <span class="n">cur</span><span class="o">-&gt;</span><span class="n">bc_private</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">ip</span><span class="p">,</span>
			<span class="n">xfs_ilog_fbroot</span><span class="p">(</span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">bc_private</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">whichfork</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="n">XFS_BTREE_TRACE_CURSOR</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">XBT_EXIT</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Log fields from a btree block header.</span>
<span class="cm"> */</span>
<span class="kt">void</span>
<span class="n">xfs_btree_log_block</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">xfs_btree_cur</span>	<span class="o">*</span><span class="n">cur</span><span class="p">,</span>	<span class="cm">/* btree cursor */</span>
	<span class="k">struct</span> <span class="n">xfs_buf</span>		<span class="o">*</span><span class="n">bp</span><span class="p">,</span>	<span class="cm">/* buffer containing btree block */</span>
	<span class="kt">int</span>			<span class="n">fields</span><span class="p">)</span>	<span class="cm">/* mask of fields: XFS_BB_... */</span>
<span class="p">{</span>
	<span class="kt">int</span>			<span class="n">first</span><span class="p">;</span>	<span class="cm">/* first byte offset logged */</span>
	<span class="kt">int</span>			<span class="n">last</span><span class="p">;</span>	<span class="cm">/* last byte offset logged */</span>
	<span class="k">static</span> <span class="k">const</span> <span class="kt">short</span>	<span class="n">soffsets</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>	<span class="cm">/* table of offsets (short) */</span>
		<span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">xfs_btree_block</span><span class="p">,</span> <span class="n">bb_magic</span><span class="p">),</span>
		<span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">xfs_btree_block</span><span class="p">,</span> <span class="n">bb_level</span><span class="p">),</span>
		<span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">xfs_btree_block</span><span class="p">,</span> <span class="n">bb_numrecs</span><span class="p">),</span>
		<span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">xfs_btree_block</span><span class="p">,</span> <span class="n">bb_u</span><span class="p">.</span><span class="n">s</span><span class="p">.</span><span class="n">bb_leftsib</span><span class="p">),</span>
		<span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">xfs_btree_block</span><span class="p">,</span> <span class="n">bb_u</span><span class="p">.</span><span class="n">s</span><span class="p">.</span><span class="n">bb_rightsib</span><span class="p">),</span>
		<span class="n">XFS_BTREE_SBLOCK_LEN</span>
	<span class="p">};</span>
	<span class="k">static</span> <span class="k">const</span> <span class="kt">short</span>	<span class="n">loffsets</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>	<span class="cm">/* table of offsets (long) */</span>
		<span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">xfs_btree_block</span><span class="p">,</span> <span class="n">bb_magic</span><span class="p">),</span>
		<span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">xfs_btree_block</span><span class="p">,</span> <span class="n">bb_level</span><span class="p">),</span>
		<span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">xfs_btree_block</span><span class="p">,</span> <span class="n">bb_numrecs</span><span class="p">),</span>
		<span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">xfs_btree_block</span><span class="p">,</span> <span class="n">bb_u</span><span class="p">.</span><span class="n">l</span><span class="p">.</span><span class="n">bb_leftsib</span><span class="p">),</span>
		<span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">xfs_btree_block</span><span class="p">,</span> <span class="n">bb_u</span><span class="p">.</span><span class="n">l</span><span class="p">.</span><span class="n">bb_rightsib</span><span class="p">),</span>
		<span class="n">XFS_BTREE_LBLOCK_LEN</span>
	<span class="p">};</span>

	<span class="n">XFS_BTREE_TRACE_CURSOR</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">XBT_ENTRY</span><span class="p">);</span>
	<span class="n">XFS_BTREE_TRACE_ARGBI</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">bp</span><span class="p">,</span> <span class="n">fields</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bp</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">xfs_btree_offsets</span><span class="p">(</span><span class="n">fields</span><span class="p">,</span>
				  <span class="p">(</span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">bc_flags</span> <span class="o">&amp;</span> <span class="n">XFS_BTREE_LONG_PTRS</span><span class="p">)</span> <span class="o">?</span>
					<span class="n">loffsets</span> <span class="o">:</span> <span class="n">soffsets</span><span class="p">,</span>
				  <span class="n">XFS_BB_NUM_BITS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">first</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">last</span><span class="p">);</span>
		<span class="n">xfs_trans_log_buf</span><span class="p">(</span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">bc_tp</span><span class="p">,</span> <span class="n">bp</span><span class="p">,</span> <span class="n">first</span><span class="p">,</span> <span class="n">last</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">xfs_trans_log_inode</span><span class="p">(</span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">bc_tp</span><span class="p">,</span> <span class="n">cur</span><span class="o">-&gt;</span><span class="n">bc_private</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">ip</span><span class="p">,</span>
			<span class="n">xfs_ilog_fbroot</span><span class="p">(</span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">bc_private</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">whichfork</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="n">XFS_BTREE_TRACE_CURSOR</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">XBT_EXIT</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Increment cursor by one record at the level.</span>
<span class="cm"> * For nonzero levels the leaf-ward information is untouched.</span>
<span class="cm"> */</span>
<span class="kt">int</span>						<span class="cm">/* error */</span>
<span class="n">xfs_btree_increment</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">xfs_btree_cur</span>	<span class="o">*</span><span class="n">cur</span><span class="p">,</span>
	<span class="kt">int</span>			<span class="n">level</span><span class="p">,</span>
	<span class="kt">int</span>			<span class="o">*</span><span class="n">stat</span><span class="p">)</span>		<span class="cm">/* success/failure */</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">xfs_btree_block</span>	<span class="o">*</span><span class="n">block</span><span class="p">;</span>
	<span class="k">union</span> <span class="n">xfs_btree_ptr</span>	<span class="n">ptr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">xfs_buf</span>		<span class="o">*</span><span class="n">bp</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">error</span><span class="p">;</span>		<span class="cm">/* error return value */</span>
	<span class="kt">int</span>			<span class="n">lev</span><span class="p">;</span>

	<span class="n">XFS_BTREE_TRACE_CURSOR</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">XBT_ENTRY</span><span class="p">);</span>
	<span class="n">XFS_BTREE_TRACE_ARGI</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">level</span><span class="p">);</span>

	<span class="n">ASSERT</span><span class="p">(</span><span class="n">level</span> <span class="o">&lt;</span> <span class="n">cur</span><span class="o">-&gt;</span><span class="n">bc_nlevels</span><span class="p">);</span>

	<span class="cm">/* Read-ahead to the right at this level. */</span>
	<span class="n">xfs_btree_readahead</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">level</span><span class="p">,</span> <span class="n">XFS_BTCUR_RIGHTRA</span><span class="p">);</span>

	<span class="cm">/* Get a pointer to the btree block. */</span>
	<span class="n">block</span> <span class="o">=</span> <span class="n">xfs_btree_get_block</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">level</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bp</span><span class="p">);</span>

<span class="cp">#ifdef DEBUG</span>
	<span class="n">error</span> <span class="o">=</span> <span class="n">xfs_btree_check_block</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">block</span><span class="p">,</span> <span class="n">level</span><span class="p">,</span> <span class="n">bp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error0</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="cm">/* We&#39;re done if we remain in the block after the increment. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">bc_ptrs</span><span class="p">[</span><span class="n">level</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">xfs_btree_get_numrecs</span><span class="p">(</span><span class="n">block</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out1</span><span class="p">;</span>

	<span class="cm">/* Fail if we just went off the right edge of the tree. */</span>
	<span class="n">xfs_btree_get_sibling</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">block</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ptr</span><span class="p">,</span> <span class="n">XFS_BB_RIGHTSIB</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">xfs_btree_ptr_is_null</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ptr</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out0</span><span class="p">;</span>

	<span class="n">XFS_BTREE_STATS_INC</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">increment</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * March up the tree incrementing pointers.</span>
<span class="cm">	 * Stop when we don&#39;t go off the right edge of a block.</span>
<span class="cm">	 */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">lev</span> <span class="o">=</span> <span class="n">level</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span> <span class="n">lev</span> <span class="o">&lt;</span> <span class="n">cur</span><span class="o">-&gt;</span><span class="n">bc_nlevels</span><span class="p">;</span> <span class="n">lev</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">block</span> <span class="o">=</span> <span class="n">xfs_btree_get_block</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">lev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bp</span><span class="p">);</span>

<span class="cp">#ifdef DEBUG</span>
		<span class="n">error</span> <span class="o">=</span> <span class="n">xfs_btree_check_block</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">block</span><span class="p">,</span> <span class="n">lev</span><span class="p">,</span> <span class="n">bp</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">error0</span><span class="p">;</span>
<span class="cp">#endif</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">bc_ptrs</span><span class="p">[</span><span class="n">lev</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">xfs_btree_get_numrecs</span><span class="p">(</span><span class="n">block</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="cm">/* Read-ahead the right block for the next loop. */</span>
		<span class="n">xfs_btree_readahead</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">lev</span><span class="p">,</span> <span class="n">XFS_BTCUR_RIGHTRA</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * If we went off the root then we are either seriously</span>
<span class="cm">	 * confused or have the tree root in an inode.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lev</span> <span class="o">==</span> <span class="n">cur</span><span class="o">-&gt;</span><span class="n">bc_nlevels</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">bc_flags</span> <span class="o">&amp;</span> <span class="n">XFS_BTREE_ROOT_IN_INODE</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out0</span><span class="p">;</span>
		<span class="n">ASSERT</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
		<span class="n">error</span> <span class="o">=</span> <span class="n">EFSCORRUPTED</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">error0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ASSERT</span><span class="p">(</span><span class="n">lev</span> <span class="o">&lt;</span> <span class="n">cur</span><span class="o">-&gt;</span><span class="n">bc_nlevels</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Now walk back down the tree, fixing up the cursor&#39;s buffer</span>
<span class="cm">	 * pointers and key numbers.</span>
<span class="cm">	 */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">block</span> <span class="o">=</span> <span class="n">xfs_btree_get_block</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">lev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bp</span><span class="p">);</span> <span class="n">lev</span> <span class="o">&gt;</span> <span class="n">level</span><span class="p">;</span> <span class="p">)</span> <span class="p">{</span>
		<span class="k">union</span> <span class="n">xfs_btree_ptr</span>	<span class="o">*</span><span class="n">ptrp</span><span class="p">;</span>

		<span class="n">ptrp</span> <span class="o">=</span> <span class="n">xfs_btree_ptr_addr</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">cur</span><span class="o">-&gt;</span><span class="n">bc_ptrs</span><span class="p">[</span><span class="n">lev</span><span class="p">],</span> <span class="n">block</span><span class="p">);</span>
		<span class="n">error</span> <span class="o">=</span> <span class="n">xfs_btree_read_buf_block</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">ptrp</span><span class="p">,</span> <span class="o">--</span><span class="n">lev</span><span class="p">,</span>
							<span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">block</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bp</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">error0</span><span class="p">;</span>

		<span class="n">xfs_btree_setbuf</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">lev</span><span class="p">,</span> <span class="n">bp</span><span class="p">);</span>
		<span class="n">cur</span><span class="o">-&gt;</span><span class="n">bc_ptrs</span><span class="p">[</span><span class="n">lev</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
<span class="nl">out1:</span>
	<span class="n">XFS_BTREE_TRACE_CURSOR</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">XBT_EXIT</span><span class="p">);</span>
	<span class="o">*</span><span class="n">stat</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">out0:</span>
	<span class="n">XFS_BTREE_TRACE_CURSOR</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">XBT_EXIT</span><span class="p">);</span>
	<span class="o">*</span><span class="n">stat</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">error0:</span>
	<span class="n">XFS_BTREE_TRACE_CURSOR</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">XBT_ERROR</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Decrement cursor by one record at the level.</span>
<span class="cm"> * For nonzero levels the leaf-ward information is untouched.</span>
<span class="cm"> */</span>
<span class="kt">int</span>						<span class="cm">/* error */</span>
<span class="n">xfs_btree_decrement</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">xfs_btree_cur</span>	<span class="o">*</span><span class="n">cur</span><span class="p">,</span>
	<span class="kt">int</span>			<span class="n">level</span><span class="p">,</span>
	<span class="kt">int</span>			<span class="o">*</span><span class="n">stat</span><span class="p">)</span>		<span class="cm">/* success/failure */</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">xfs_btree_block</span>	<span class="o">*</span><span class="n">block</span><span class="p">;</span>
	<span class="n">xfs_buf_t</span>		<span class="o">*</span><span class="n">bp</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">error</span><span class="p">;</span>		<span class="cm">/* error return value */</span>
	<span class="kt">int</span>			<span class="n">lev</span><span class="p">;</span>
	<span class="k">union</span> <span class="n">xfs_btree_ptr</span>	<span class="n">ptr</span><span class="p">;</span>

	<span class="n">XFS_BTREE_TRACE_CURSOR</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">XBT_ENTRY</span><span class="p">);</span>
	<span class="n">XFS_BTREE_TRACE_ARGI</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">level</span><span class="p">);</span>

	<span class="n">ASSERT</span><span class="p">(</span><span class="n">level</span> <span class="o">&lt;</span> <span class="n">cur</span><span class="o">-&gt;</span><span class="n">bc_nlevels</span><span class="p">);</span>

	<span class="cm">/* Read-ahead to the left at this level. */</span>
	<span class="n">xfs_btree_readahead</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">level</span><span class="p">,</span> <span class="n">XFS_BTCUR_LEFTRA</span><span class="p">);</span>

	<span class="cm">/* We&#39;re done if we remain in the block after the decrement. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">--</span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">bc_ptrs</span><span class="p">[</span><span class="n">level</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out1</span><span class="p">;</span>

	<span class="cm">/* Get a pointer to the btree block. */</span>
	<span class="n">block</span> <span class="o">=</span> <span class="n">xfs_btree_get_block</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">level</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bp</span><span class="p">);</span>

<span class="cp">#ifdef DEBUG</span>
	<span class="n">error</span> <span class="o">=</span> <span class="n">xfs_btree_check_block</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">block</span><span class="p">,</span> <span class="n">level</span><span class="p">,</span> <span class="n">bp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error0</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="cm">/* Fail if we just went off the left edge of the tree. */</span>
	<span class="n">xfs_btree_get_sibling</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">block</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ptr</span><span class="p">,</span> <span class="n">XFS_BB_LEFTSIB</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">xfs_btree_ptr_is_null</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ptr</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out0</span><span class="p">;</span>

	<span class="n">XFS_BTREE_STATS_INC</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">decrement</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * March up the tree decrementing pointers.</span>
<span class="cm">	 * Stop when we don&#39;t go off the left edge of a block.</span>
<span class="cm">	 */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">lev</span> <span class="o">=</span> <span class="n">level</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span> <span class="n">lev</span> <span class="o">&lt;</span> <span class="n">cur</span><span class="o">-&gt;</span><span class="n">bc_nlevels</span><span class="p">;</span> <span class="n">lev</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">--</span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">bc_ptrs</span><span class="p">[</span><span class="n">lev</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="cm">/* Read-ahead the left block for the next loop. */</span>
		<span class="n">xfs_btree_readahead</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">lev</span><span class="p">,</span> <span class="n">XFS_BTCUR_LEFTRA</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * If we went off the root then we are seriously confused.</span>
<span class="cm">	 * or the root of the tree is in an inode.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lev</span> <span class="o">==</span> <span class="n">cur</span><span class="o">-&gt;</span><span class="n">bc_nlevels</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">bc_flags</span> <span class="o">&amp;</span> <span class="n">XFS_BTREE_ROOT_IN_INODE</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out0</span><span class="p">;</span>
		<span class="n">ASSERT</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
		<span class="n">error</span> <span class="o">=</span> <span class="n">EFSCORRUPTED</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">error0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ASSERT</span><span class="p">(</span><span class="n">lev</span> <span class="o">&lt;</span> <span class="n">cur</span><span class="o">-&gt;</span><span class="n">bc_nlevels</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Now walk back down the tree, fixing up the cursor&#39;s buffer</span>
<span class="cm">	 * pointers and key numbers.</span>
<span class="cm">	 */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">block</span> <span class="o">=</span> <span class="n">xfs_btree_get_block</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">lev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bp</span><span class="p">);</span> <span class="n">lev</span> <span class="o">&gt;</span> <span class="n">level</span><span class="p">;</span> <span class="p">)</span> <span class="p">{</span>
		<span class="k">union</span> <span class="n">xfs_btree_ptr</span>	<span class="o">*</span><span class="n">ptrp</span><span class="p">;</span>

		<span class="n">ptrp</span> <span class="o">=</span> <span class="n">xfs_btree_ptr_addr</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">cur</span><span class="o">-&gt;</span><span class="n">bc_ptrs</span><span class="p">[</span><span class="n">lev</span><span class="p">],</span> <span class="n">block</span><span class="p">);</span>
		<span class="n">error</span> <span class="o">=</span> <span class="n">xfs_btree_read_buf_block</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">ptrp</span><span class="p">,</span> <span class="o">--</span><span class="n">lev</span><span class="p">,</span>
							<span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">block</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bp</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">error0</span><span class="p">;</span>
		<span class="n">xfs_btree_setbuf</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">lev</span><span class="p">,</span> <span class="n">bp</span><span class="p">);</span>
		<span class="n">cur</span><span class="o">-&gt;</span><span class="n">bc_ptrs</span><span class="p">[</span><span class="n">lev</span><span class="p">]</span> <span class="o">=</span> <span class="n">xfs_btree_get_numrecs</span><span class="p">(</span><span class="n">block</span><span class="p">);</span>
	<span class="p">}</span>
<span class="nl">out1:</span>
	<span class="n">XFS_BTREE_TRACE_CURSOR</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">XBT_EXIT</span><span class="p">);</span>
	<span class="o">*</span><span class="n">stat</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">out0:</span>
	<span class="n">XFS_BTREE_TRACE_CURSOR</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">XBT_EXIT</span><span class="p">);</span>
	<span class="o">*</span><span class="n">stat</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">error0:</span>
	<span class="n">XFS_BTREE_TRACE_CURSOR</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">XBT_ERROR</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">STATIC</span> <span class="kt">int</span>
<span class="n">xfs_btree_lookup_get_block</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">xfs_btree_cur</span>	<span class="o">*</span><span class="n">cur</span><span class="p">,</span>	<span class="cm">/* btree cursor */</span>
	<span class="kt">int</span>			<span class="n">level</span><span class="p">,</span>	<span class="cm">/* level in the btree */</span>
	<span class="k">union</span> <span class="n">xfs_btree_ptr</span>	<span class="o">*</span><span class="n">pp</span><span class="p">,</span>	<span class="cm">/* ptr to btree block */</span>
	<span class="k">struct</span> <span class="n">xfs_btree_block</span>	<span class="o">**</span><span class="n">blkp</span><span class="p">)</span> <span class="cm">/* return btree block */</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">xfs_buf</span>		<span class="o">*</span><span class="n">bp</span><span class="p">;</span>	<span class="cm">/* buffer pointer for btree block */</span>
	<span class="kt">int</span>			<span class="n">error</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* special case the root block if in an inode */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">bc_flags</span> <span class="o">&amp;</span> <span class="n">XFS_BTREE_ROOT_IN_INODE</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">level</span> <span class="o">==</span> <span class="n">cur</span><span class="o">-&gt;</span><span class="n">bc_nlevels</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">blkp</span> <span class="o">=</span> <span class="n">xfs_btree_get_iroot</span><span class="p">(</span><span class="n">cur</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * If the old buffer at this level for the disk address we are</span>
<span class="cm">	 * looking for re-use it.</span>
<span class="cm">	 *</span>
<span class="cm">	 * Otherwise throw it away and get a new one.</span>
<span class="cm">	 */</span>
	<span class="n">bp</span> <span class="o">=</span> <span class="n">cur</span><span class="o">-&gt;</span><span class="n">bc_bufs</span><span class="p">[</span><span class="n">level</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bp</span> <span class="o">&amp;&amp;</span> <span class="n">XFS_BUF_ADDR</span><span class="p">(</span><span class="n">bp</span><span class="p">)</span> <span class="o">==</span> <span class="n">xfs_btree_ptr_to_daddr</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">pp</span><span class="p">))</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">blkp</span> <span class="o">=</span> <span class="n">XFS_BUF_TO_BLOCK</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">error</span> <span class="o">=</span> <span class="n">xfs_btree_read_buf_block</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">pp</span><span class="p">,</span> <span class="n">level</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">blkp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">error</span><span class="p">;</span>

	<span class="n">xfs_btree_setbuf</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">level</span><span class="p">,</span> <span class="n">bp</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Get current search key.  For level 0 we don&#39;t actually have a key</span>
<span class="cm"> * structure so we make one up from the record.  For all other levels</span>
<span class="cm"> * we just return the right key.</span>
<span class="cm"> */</span>
<span class="n">STATIC</span> <span class="k">union</span> <span class="n">xfs_btree_key</span> <span class="o">*</span>
<span class="n">xfs_lookup_get_search_key</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">xfs_btree_cur</span>	<span class="o">*</span><span class="n">cur</span><span class="p">,</span>
	<span class="kt">int</span>			<span class="n">level</span><span class="p">,</span>
	<span class="kt">int</span>			<span class="n">keyno</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">xfs_btree_block</span>	<span class="o">*</span><span class="n">block</span><span class="p">,</span>
	<span class="k">union</span> <span class="n">xfs_btree_key</span>	<span class="o">*</span><span class="n">kp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">level</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cur</span><span class="o">-&gt;</span><span class="n">bc_ops</span><span class="o">-&gt;</span><span class="n">init_key_from_rec</span><span class="p">(</span><span class="n">kp</span><span class="p">,</span>
				<span class="n">xfs_btree_rec_addr</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">keyno</span><span class="p">,</span> <span class="n">block</span><span class="p">));</span>
		<span class="k">return</span> <span class="n">kp</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">xfs_btree_key_addr</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">keyno</span><span class="p">,</span> <span class="n">block</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Lookup the record.  The cursor is made to point to it, based on dir.</span>
<span class="cm"> * Return 0 if can&#39;t find any such record, 1 for success.</span>
<span class="cm"> */</span>
<span class="kt">int</span>					<span class="cm">/* error */</span>
<span class="n">xfs_btree_lookup</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">xfs_btree_cur</span>	<span class="o">*</span><span class="n">cur</span><span class="p">,</span>	<span class="cm">/* btree cursor */</span>
	<span class="n">xfs_lookup_t</span>		<span class="n">dir</span><span class="p">,</span>	<span class="cm">/* &lt;=, ==, or &gt;= */</span>
	<span class="kt">int</span>			<span class="o">*</span><span class="n">stat</span><span class="p">)</span>	<span class="cm">/* success/failure */</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">xfs_btree_block</span>	<span class="o">*</span><span class="n">block</span><span class="p">;</span>	<span class="cm">/* current btree block */</span>
	<span class="n">__int64_t</span>		<span class="n">diff</span><span class="p">;</span>	<span class="cm">/* difference for the current key */</span>
	<span class="kt">int</span>			<span class="n">error</span><span class="p">;</span>	<span class="cm">/* error return value */</span>
	<span class="kt">int</span>			<span class="n">keyno</span><span class="p">;</span>	<span class="cm">/* current key number */</span>
	<span class="kt">int</span>			<span class="n">level</span><span class="p">;</span>	<span class="cm">/* level in the btree */</span>
	<span class="k">union</span> <span class="n">xfs_btree_ptr</span>	<span class="o">*</span><span class="n">pp</span><span class="p">;</span>	<span class="cm">/* ptr to btree block */</span>
	<span class="k">union</span> <span class="n">xfs_btree_ptr</span>	<span class="n">ptr</span><span class="p">;</span>	<span class="cm">/* ptr to btree block */</span>

	<span class="n">XFS_BTREE_TRACE_CURSOR</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">XBT_ENTRY</span><span class="p">);</span>
	<span class="n">XFS_BTREE_TRACE_ARGI</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">dir</span><span class="p">);</span>

	<span class="n">XFS_BTREE_STATS_INC</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">lookup</span><span class="p">);</span>

	<span class="n">block</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">keyno</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* initialise start pointer from cursor */</span>
	<span class="n">cur</span><span class="o">-&gt;</span><span class="n">bc_ops</span><span class="o">-&gt;</span><span class="n">init_ptr_from_cur</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ptr</span><span class="p">);</span>
	<span class="n">pp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ptr</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Iterate over each level in the btree, starting at the root.</span>
<span class="cm">	 * For each level above the leaves, find the key we need, based</span>
<span class="cm">	 * on the lookup record, then follow the corresponding block</span>
<span class="cm">	 * pointer down to the next level.</span>
<span class="cm">	 */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">level</span> <span class="o">=</span> <span class="n">cur</span><span class="o">-&gt;</span><span class="n">bc_nlevels</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">diff</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">level</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">level</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Get the block we need to do the lookup on. */</span>
		<span class="n">error</span> <span class="o">=</span> <span class="n">xfs_btree_lookup_get_block</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">level</span><span class="p">,</span> <span class="n">pp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">block</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">error0</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">diff</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * If we already had a key match at a higher level, we</span>
<span class="cm">			 * know we need to use the first entry in this block.</span>
<span class="cm">			 */</span>
			<span class="n">keyno</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* Otherwise search this block. Do a binary search. */</span>

			<span class="kt">int</span>	<span class="n">high</span><span class="p">;</span>	<span class="cm">/* high entry number */</span>
			<span class="kt">int</span>	<span class="n">low</span><span class="p">;</span>	<span class="cm">/* low entry number */</span>

			<span class="cm">/* Set low and high entry numbers, 1-based. */</span>
			<span class="n">low</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">high</span> <span class="o">=</span> <span class="n">xfs_btree_get_numrecs</span><span class="p">(</span><span class="n">block</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">high</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* Block is empty, must be an empty leaf. */</span>
				<span class="n">ASSERT</span><span class="p">(</span><span class="n">level</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">cur</span><span class="o">-&gt;</span><span class="n">bc_nlevels</span> <span class="o">==</span> <span class="mi">1</span><span class="p">);</span>

				<span class="n">cur</span><span class="o">-&gt;</span><span class="n">bc_ptrs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">dir</span> <span class="o">!=</span> <span class="n">XFS_LOOKUP_LE</span><span class="p">;</span>
				<span class="n">XFS_BTREE_TRACE_CURSOR</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">XBT_EXIT</span><span class="p">);</span>
				<span class="o">*</span><span class="n">stat</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="cm">/* Binary search the block. */</span>
			<span class="k">while</span> <span class="p">(</span><span class="n">low</span> <span class="o">&lt;=</span> <span class="n">high</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">union</span> <span class="n">xfs_btree_key</span>	<span class="n">key</span><span class="p">;</span>
				<span class="k">union</span> <span class="n">xfs_btree_key</span>	<span class="o">*</span><span class="n">kp</span><span class="p">;</span>

				<span class="n">XFS_BTREE_STATS_INC</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">compare</span><span class="p">);</span>

				<span class="cm">/* keyno is average of low and high. */</span>
				<span class="n">keyno</span> <span class="o">=</span> <span class="p">(</span><span class="n">low</span> <span class="o">+</span> <span class="n">high</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">;</span>

				<span class="cm">/* Get current search key */</span>
				<span class="n">kp</span> <span class="o">=</span> <span class="n">xfs_lookup_get_search_key</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">level</span><span class="p">,</span>
						<span class="n">keyno</span><span class="p">,</span> <span class="n">block</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">key</span><span class="p">);</span>

				<span class="cm">/*</span>
<span class="cm">				 * Compute difference to get next direction:</span>
<span class="cm">				 *  - less than, move right</span>
<span class="cm">				 *  - greater than, move left</span>
<span class="cm">				 *  - equal, we&#39;re done</span>
<span class="cm">				 */</span>
				<span class="n">diff</span> <span class="o">=</span> <span class="n">cur</span><span class="o">-&gt;</span><span class="n">bc_ops</span><span class="o">-&gt;</span><span class="n">key_diff</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">kp</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">diff</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
					<span class="n">low</span> <span class="o">=</span> <span class="n">keyno</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
				<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">diff</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
					<span class="n">high</span> <span class="o">=</span> <span class="n">keyno</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
				<span class="k">else</span>
					<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="cm">/*</span>
<span class="cm">		 * If there are more levels, set up for the next level</span>
<span class="cm">		 * by getting the block number and filling in the cursor.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">level</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * If we moved left, need the previous key number,</span>
<span class="cm">			 * unless there isn&#39;t one.</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">diff</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="o">--</span><span class="n">keyno</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span>
				<span class="n">keyno</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">pp</span> <span class="o">=</span> <span class="n">xfs_btree_ptr_addr</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">keyno</span><span class="p">,</span> <span class="n">block</span><span class="p">);</span>

<span class="cp">#ifdef DEBUG</span>
			<span class="n">error</span> <span class="o">=</span> <span class="n">xfs_btree_check_ptr</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">pp</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">level</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">error0</span><span class="p">;</span>
<span class="cp">#endif</span>
			<span class="n">cur</span><span class="o">-&gt;</span><span class="n">bc_ptrs</span><span class="p">[</span><span class="n">level</span><span class="p">]</span> <span class="o">=</span> <span class="n">keyno</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* Done with the search. See if we need to adjust the results. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dir</span> <span class="o">!=</span> <span class="n">XFS_LOOKUP_LE</span> <span class="o">&amp;&amp;</span> <span class="n">diff</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">keyno</span><span class="o">++</span><span class="p">;</span>
		<span class="cm">/*</span>
<span class="cm">		 * If ge search and we went off the end of the block, but it&#39;s</span>
<span class="cm">		 * not the last block, we&#39;re in the wrong block.</span>
<span class="cm">		 */</span>
		<span class="n">xfs_btree_get_sibling</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">block</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ptr</span><span class="p">,</span> <span class="n">XFS_BB_RIGHTSIB</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dir</span> <span class="o">==</span> <span class="n">XFS_LOOKUP_GE</span> <span class="o">&amp;&amp;</span>
		    <span class="n">keyno</span> <span class="o">&gt;</span> <span class="n">xfs_btree_get_numrecs</span><span class="p">(</span><span class="n">block</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="o">!</span><span class="n">xfs_btree_ptr_is_null</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ptr</span><span class="p">))</span> <span class="p">{</span>
			<span class="kt">int</span>	<span class="n">i</span><span class="p">;</span>

			<span class="n">cur</span><span class="o">-&gt;</span><span class="n">bc_ptrs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">keyno</span><span class="p">;</span>
			<span class="n">error</span> <span class="o">=</span> <span class="n">xfs_btree_increment</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">i</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">error0</span><span class="p">;</span>
			<span class="n">XFS_WANT_CORRUPTED_RETURN</span><span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">1</span><span class="p">);</span>
			<span class="n">XFS_BTREE_TRACE_CURSOR</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">XBT_EXIT</span><span class="p">);</span>
			<span class="o">*</span><span class="n">stat</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">dir</span> <span class="o">==</span> <span class="n">XFS_LOOKUP_LE</span> <span class="o">&amp;&amp;</span> <span class="n">diff</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">keyno</span><span class="o">--</span><span class="p">;</span>
	<span class="n">cur</span><span class="o">-&gt;</span><span class="n">bc_ptrs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">keyno</span><span class="p">;</span>

	<span class="cm">/* Return if we succeeded or not. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">keyno</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">keyno</span> <span class="o">&gt;</span> <span class="n">xfs_btree_get_numrecs</span><span class="p">(</span><span class="n">block</span><span class="p">))</span>
		<span class="o">*</span><span class="n">stat</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">dir</span> <span class="o">!=</span> <span class="n">XFS_LOOKUP_EQ</span> <span class="o">||</span> <span class="n">diff</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="o">*</span><span class="n">stat</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="o">*</span><span class="n">stat</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">XFS_BTREE_TRACE_CURSOR</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">XBT_EXIT</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">error0:</span>
	<span class="n">XFS_BTREE_TRACE_CURSOR</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">XBT_ERROR</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Update keys at all levels from here to the root along the cursor&#39;s path.</span>
<span class="cm"> */</span>
<span class="n">STATIC</span> <span class="kt">int</span>
<span class="n">xfs_btree_updkey</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">xfs_btree_cur</span>	<span class="o">*</span><span class="n">cur</span><span class="p">,</span>
	<span class="k">union</span> <span class="n">xfs_btree_key</span>	<span class="o">*</span><span class="n">keyp</span><span class="p">,</span>
	<span class="kt">int</span>			<span class="n">level</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">xfs_btree_block</span>	<span class="o">*</span><span class="n">block</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">xfs_buf</span>		<span class="o">*</span><span class="n">bp</span><span class="p">;</span>
	<span class="k">union</span> <span class="n">xfs_btree_key</span>	<span class="o">*</span><span class="n">kp</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">ptr</span><span class="p">;</span>

	<span class="n">XFS_BTREE_TRACE_CURSOR</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">XBT_ENTRY</span><span class="p">);</span>
	<span class="n">XFS_BTREE_TRACE_ARGIK</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">level</span><span class="p">,</span> <span class="n">keyp</span><span class="p">);</span>

	<span class="n">ASSERT</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">bc_flags</span> <span class="o">&amp;</span> <span class="n">XFS_BTREE_ROOT_IN_INODE</span><span class="p">)</span> <span class="o">||</span> <span class="n">level</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Go up the tree from this level toward the root.</span>
<span class="cm">	 * At each level, update the key value to the value input.</span>
<span class="cm">	 * Stop when we reach a level where the cursor isn&#39;t pointing</span>
<span class="cm">	 * at the first entry in the block.</span>
<span class="cm">	 */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">ptr</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">ptr</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">level</span> <span class="o">&lt;</span> <span class="n">cur</span><span class="o">-&gt;</span><span class="n">bc_nlevels</span><span class="p">;</span> <span class="n">level</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#ifdef DEBUG</span>
		<span class="kt">int</span>		<span class="n">error</span><span class="p">;</span>
<span class="cp">#endif</span>
		<span class="n">block</span> <span class="o">=</span> <span class="n">xfs_btree_get_block</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">level</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bp</span><span class="p">);</span>
<span class="cp">#ifdef DEBUG</span>
		<span class="n">error</span> <span class="o">=</span> <span class="n">xfs_btree_check_block</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">block</span><span class="p">,</span> <span class="n">level</span><span class="p">,</span> <span class="n">bp</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">XFS_BTREE_TRACE_CURSOR</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">XBT_ERROR</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
		<span class="p">}</span>
<span class="cp">#endif</span>
		<span class="n">ptr</span> <span class="o">=</span> <span class="n">cur</span><span class="o">-&gt;</span><span class="n">bc_ptrs</span><span class="p">[</span><span class="n">level</span><span class="p">];</span>
		<span class="n">kp</span> <span class="o">=</span> <span class="n">xfs_btree_key_addr</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">ptr</span><span class="p">,</span> <span class="n">block</span><span class="p">);</span>
		<span class="n">xfs_btree_copy_keys</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">kp</span><span class="p">,</span> <span class="n">keyp</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">xfs_btree_log_keys</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">bp</span><span class="p">,</span> <span class="n">ptr</span><span class="p">,</span> <span class="n">ptr</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">XFS_BTREE_TRACE_CURSOR</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">XBT_EXIT</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Update the record referred to by cur to the value in the</span>
<span class="cm"> * given record. This either works (return 0) or gets an</span>
<span class="cm"> * EFSCORRUPTED error.</span>
<span class="cm"> */</span>
<span class="kt">int</span>
<span class="n">xfs_btree_update</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">xfs_btree_cur</span>	<span class="o">*</span><span class="n">cur</span><span class="p">,</span>
	<span class="k">union</span> <span class="n">xfs_btree_rec</span>	<span class="o">*</span><span class="n">rec</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">xfs_btree_block</span>	<span class="o">*</span><span class="n">block</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">xfs_buf</span>		<span class="o">*</span><span class="n">bp</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">error</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">ptr</span><span class="p">;</span>
	<span class="k">union</span> <span class="n">xfs_btree_rec</span>	<span class="o">*</span><span class="n">rp</span><span class="p">;</span>

	<span class="n">XFS_BTREE_TRACE_CURSOR</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">XBT_ENTRY</span><span class="p">);</span>
	<span class="n">XFS_BTREE_TRACE_ARGR</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">rec</span><span class="p">);</span>

	<span class="cm">/* Pick up the current block. */</span>
	<span class="n">block</span> <span class="o">=</span> <span class="n">xfs_btree_get_block</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bp</span><span class="p">);</span>

<span class="cp">#ifdef DEBUG</span>
	<span class="n">error</span> <span class="o">=</span> <span class="n">xfs_btree_check_block</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">block</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">bp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error0</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="cm">/* Get the address of the rec to be updated. */</span>
	<span class="n">ptr</span> <span class="o">=</span> <span class="n">cur</span><span class="o">-&gt;</span><span class="n">bc_ptrs</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">rp</span> <span class="o">=</span> <span class="n">xfs_btree_rec_addr</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">ptr</span><span class="p">,</span> <span class="n">block</span><span class="p">);</span>

	<span class="cm">/* Fill in the new contents and log them. */</span>
	<span class="n">xfs_btree_copy_recs</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">rp</span><span class="p">,</span> <span class="n">rec</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">xfs_btree_log_recs</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">bp</span><span class="p">,</span> <span class="n">ptr</span><span class="p">,</span> <span class="n">ptr</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * If we are tracking the last record in the tree and</span>
<span class="cm">	 * we are at the far right edge of the tree, update it.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">xfs_btree_is_lastrec</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">block</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">cur</span><span class="o">-&gt;</span><span class="n">bc_ops</span><span class="o">-&gt;</span><span class="n">update_lastrec</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">block</span><span class="p">,</span> <span class="n">rec</span><span class="p">,</span>
					    <span class="n">ptr</span><span class="p">,</span> <span class="n">LASTREC_UPDATE</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Updating first rec in leaf. Pass new key value up to our parent. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ptr</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">union</span> <span class="n">xfs_btree_key</span>	<span class="n">key</span><span class="p">;</span>

		<span class="n">cur</span><span class="o">-&gt;</span><span class="n">bc_ops</span><span class="o">-&gt;</span><span class="n">init_key_from_rec</span><span class="p">(</span><span class="o">&amp;</span><span class="n">key</span><span class="p">,</span> <span class="n">rec</span><span class="p">);</span>
		<span class="n">error</span> <span class="o">=</span> <span class="n">xfs_btree_updkey</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">key</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">error0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">XFS_BTREE_TRACE_CURSOR</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">XBT_EXIT</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">error0:</span>
	<span class="n">XFS_BTREE_TRACE_CURSOR</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">XBT_ERROR</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Move 1 record left from cur/level if possible.</span>
<span class="cm"> * Update cur to reflect the new path.</span>
<span class="cm"> */</span>
<span class="n">STATIC</span> <span class="kt">int</span>					<span class="cm">/* error */</span>
<span class="n">xfs_btree_lshift</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">xfs_btree_cur</span>	<span class="o">*</span><span class="n">cur</span><span class="p">,</span>
	<span class="kt">int</span>			<span class="n">level</span><span class="p">,</span>
	<span class="kt">int</span>			<span class="o">*</span><span class="n">stat</span><span class="p">)</span>		<span class="cm">/* success/failure */</span>
<span class="p">{</span>
	<span class="k">union</span> <span class="n">xfs_btree_key</span>	<span class="n">key</span><span class="p">;</span>		<span class="cm">/* btree key */</span>
	<span class="k">struct</span> <span class="n">xfs_buf</span>		<span class="o">*</span><span class="n">lbp</span><span class="p">;</span>		<span class="cm">/* left buffer pointer */</span>
	<span class="k">struct</span> <span class="n">xfs_btree_block</span>	<span class="o">*</span><span class="n">left</span><span class="p">;</span>		<span class="cm">/* left btree block */</span>
	<span class="kt">int</span>			<span class="n">lrecs</span><span class="p">;</span>		<span class="cm">/* left record count */</span>
	<span class="k">struct</span> <span class="n">xfs_buf</span>		<span class="o">*</span><span class="n">rbp</span><span class="p">;</span>		<span class="cm">/* right buffer pointer */</span>
	<span class="k">struct</span> <span class="n">xfs_btree_block</span>	<span class="o">*</span><span class="n">right</span><span class="p">;</span>		<span class="cm">/* right btree block */</span>
	<span class="kt">int</span>			<span class="n">rrecs</span><span class="p">;</span>		<span class="cm">/* right record count */</span>
	<span class="k">union</span> <span class="n">xfs_btree_ptr</span>	<span class="n">lptr</span><span class="p">;</span>		<span class="cm">/* left btree pointer */</span>
	<span class="k">union</span> <span class="n">xfs_btree_key</span>	<span class="o">*</span><span class="n">rkp</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>	<span class="cm">/* right btree key */</span>
	<span class="k">union</span> <span class="n">xfs_btree_ptr</span>	<span class="o">*</span><span class="n">rpp</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>	<span class="cm">/* right address pointer */</span>
	<span class="k">union</span> <span class="n">xfs_btree_rec</span>	<span class="o">*</span><span class="n">rrp</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>	<span class="cm">/* right record pointer */</span>
	<span class="kt">int</span>			<span class="n">error</span><span class="p">;</span>		<span class="cm">/* error return value */</span>

	<span class="n">XFS_BTREE_TRACE_CURSOR</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">XBT_ENTRY</span><span class="p">);</span>
	<span class="n">XFS_BTREE_TRACE_ARGI</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">level</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">bc_flags</span> <span class="o">&amp;</span> <span class="n">XFS_BTREE_ROOT_IN_INODE</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">level</span> <span class="o">==</span> <span class="n">cur</span><span class="o">-&gt;</span><span class="n">bc_nlevels</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out0</span><span class="p">;</span>

	<span class="cm">/* Set up variables for this block as &quot;right&quot;. */</span>
	<span class="n">right</span> <span class="o">=</span> <span class="n">xfs_btree_get_block</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">level</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rbp</span><span class="p">);</span>

<span class="cp">#ifdef DEBUG</span>
	<span class="n">error</span> <span class="o">=</span> <span class="n">xfs_btree_check_block</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">right</span><span class="p">,</span> <span class="n">level</span><span class="p">,</span> <span class="n">rbp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error0</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="cm">/* If we&#39;ve got no left sibling then we can&#39;t shift an entry left. */</span>
	<span class="n">xfs_btree_get_sibling</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">right</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">lptr</span><span class="p">,</span> <span class="n">XFS_BB_LEFTSIB</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">xfs_btree_ptr_is_null</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">lptr</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out0</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * If the cursor entry is the one that would be moved, don&#39;t</span>
<span class="cm">	 * do it... it&#39;s too complicated.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">bc_ptrs</span><span class="p">[</span><span class="n">level</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out0</span><span class="p">;</span>

	<span class="cm">/* Set up the left neighbor as &quot;left&quot;. */</span>
	<span class="n">error</span> <span class="o">=</span> <span class="n">xfs_btree_read_buf_block</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">lptr</span><span class="p">,</span> <span class="n">level</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">left</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">lbp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error0</span><span class="p">;</span>

	<span class="cm">/* If it&#39;s full, it can&#39;t take another entry. */</span>
	<span class="n">lrecs</span> <span class="o">=</span> <span class="n">xfs_btree_get_numrecs</span><span class="p">(</span><span class="n">left</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lrecs</span> <span class="o">==</span> <span class="n">cur</span><span class="o">-&gt;</span><span class="n">bc_ops</span><span class="o">-&gt;</span><span class="n">get_maxrecs</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">level</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out0</span><span class="p">;</span>

	<span class="n">rrecs</span> <span class="o">=</span> <span class="n">xfs_btree_get_numrecs</span><span class="p">(</span><span class="n">right</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * We add one entry to the left side and remove one for the right side.</span>
<span class="cm">	 * Account for it here, the changes will be updated on disk and logged</span>
<span class="cm">	 * later.</span>
<span class="cm">	 */</span>
	<span class="n">lrecs</span><span class="o">++</span><span class="p">;</span>
	<span class="n">rrecs</span><span class="o">--</span><span class="p">;</span>

	<span class="n">XFS_BTREE_STATS_INC</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">lshift</span><span class="p">);</span>
	<span class="n">XFS_BTREE_STATS_ADD</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">moves</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * If non-leaf, copy a key and a ptr to the left block.</span>
<span class="cm">	 * Log the changes to the left block.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">level</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* It&#39;s a non-leaf.  Move keys and pointers. */</span>
		<span class="k">union</span> <span class="n">xfs_btree_key</span>	<span class="o">*</span><span class="n">lkp</span><span class="p">;</span>	<span class="cm">/* left btree key */</span>
		<span class="k">union</span> <span class="n">xfs_btree_ptr</span>	<span class="o">*</span><span class="n">lpp</span><span class="p">;</span>	<span class="cm">/* left address pointer */</span>

		<span class="n">lkp</span> <span class="o">=</span> <span class="n">xfs_btree_key_addr</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">lrecs</span><span class="p">,</span> <span class="n">left</span><span class="p">);</span>
		<span class="n">rkp</span> <span class="o">=</span> <span class="n">xfs_btree_key_addr</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">right</span><span class="p">);</span>

		<span class="n">lpp</span> <span class="o">=</span> <span class="n">xfs_btree_ptr_addr</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">lrecs</span><span class="p">,</span> <span class="n">left</span><span class="p">);</span>
		<span class="n">rpp</span> <span class="o">=</span> <span class="n">xfs_btree_ptr_addr</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">right</span><span class="p">);</span>
<span class="cp">#ifdef DEBUG</span>
		<span class="n">error</span> <span class="o">=</span> <span class="n">xfs_btree_check_ptr</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">rpp</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">level</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">error0</span><span class="p">;</span>
<span class="cp">#endif</span>
		<span class="n">xfs_btree_copy_keys</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">lkp</span><span class="p">,</span> <span class="n">rkp</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">xfs_btree_copy_ptrs</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">lpp</span><span class="p">,</span> <span class="n">rpp</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

		<span class="n">xfs_btree_log_keys</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">lbp</span><span class="p">,</span> <span class="n">lrecs</span><span class="p">,</span> <span class="n">lrecs</span><span class="p">);</span>
		<span class="n">xfs_btree_log_ptrs</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">lbp</span><span class="p">,</span> <span class="n">lrecs</span><span class="p">,</span> <span class="n">lrecs</span><span class="p">);</span>

		<span class="n">ASSERT</span><span class="p">(</span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">bc_ops</span><span class="o">-&gt;</span><span class="n">keys_inorder</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span>
			<span class="n">xfs_btree_key_addr</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">lrecs</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">left</span><span class="p">),</span> <span class="n">lkp</span><span class="p">));</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* It&#39;s a leaf.  Move records.  */</span>
		<span class="k">union</span> <span class="n">xfs_btree_rec</span>	<span class="o">*</span><span class="n">lrp</span><span class="p">;</span>	<span class="cm">/* left record pointer */</span>

		<span class="n">lrp</span> <span class="o">=</span> <span class="n">xfs_btree_rec_addr</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">lrecs</span><span class="p">,</span> <span class="n">left</span><span class="p">);</span>
		<span class="n">rrp</span> <span class="o">=</span> <span class="n">xfs_btree_rec_addr</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">right</span><span class="p">);</span>

		<span class="n">xfs_btree_copy_recs</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">lrp</span><span class="p">,</span> <span class="n">rrp</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">xfs_btree_log_recs</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">lbp</span><span class="p">,</span> <span class="n">lrecs</span><span class="p">,</span> <span class="n">lrecs</span><span class="p">);</span>

		<span class="n">ASSERT</span><span class="p">(</span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">bc_ops</span><span class="o">-&gt;</span><span class="n">recs_inorder</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span>
			<span class="n">xfs_btree_rec_addr</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">lrecs</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">left</span><span class="p">),</span> <span class="n">lrp</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="n">xfs_btree_set_numrecs</span><span class="p">(</span><span class="n">left</span><span class="p">,</span> <span class="n">lrecs</span><span class="p">);</span>
	<span class="n">xfs_btree_log_block</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">lbp</span><span class="p">,</span> <span class="n">XFS_BB_NUMRECS</span><span class="p">);</span>

	<span class="n">xfs_btree_set_numrecs</span><span class="p">(</span><span class="n">right</span><span class="p">,</span> <span class="n">rrecs</span><span class="p">);</span>
	<span class="n">xfs_btree_log_block</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">rbp</span><span class="p">,</span> <span class="n">XFS_BB_NUMRECS</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Slide the contents of right down one entry.</span>
<span class="cm">	 */</span>
	<span class="n">XFS_BTREE_STATS_ADD</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">moves</span><span class="p">,</span> <span class="n">rrecs</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">level</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* It&#39;s a nonleaf. operate on keys and ptrs */</span>
<span class="cp">#ifdef DEBUG</span>
		<span class="kt">int</span>			<span class="n">i</span><span class="p">;</span>		<span class="cm">/* loop index */</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">rrecs</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">error</span> <span class="o">=</span> <span class="n">xfs_btree_check_ptr</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">rpp</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">level</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">error0</span><span class="p">;</span>
		<span class="p">}</span>
<span class="cp">#endif</span>
		<span class="n">xfs_btree_shift_keys</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span>
				<span class="n">xfs_btree_key_addr</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">right</span><span class="p">),</span>
				<span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">rrecs</span><span class="p">);</span>
		<span class="n">xfs_btree_shift_ptrs</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span>
				<span class="n">xfs_btree_ptr_addr</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">right</span><span class="p">),</span>
				<span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">rrecs</span><span class="p">);</span>

		<span class="n">xfs_btree_log_keys</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">rbp</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">rrecs</span><span class="p">);</span>
		<span class="n">xfs_btree_log_ptrs</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">rbp</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">rrecs</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* It&#39;s a leaf. operate on records */</span>
		<span class="n">xfs_btree_shift_recs</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span>
			<span class="n">xfs_btree_rec_addr</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">right</span><span class="p">),</span>
			<span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">rrecs</span><span class="p">);</span>
		<span class="n">xfs_btree_log_recs</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">rbp</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">rrecs</span><span class="p">);</span>

		<span class="cm">/*</span>
<span class="cm">		 * If it&#39;s the first record in the block, we&#39;ll need a key</span>
<span class="cm">		 * structure to pass up to the next level (updkey).</span>
<span class="cm">		 */</span>
		<span class="n">cur</span><span class="o">-&gt;</span><span class="n">bc_ops</span><span class="o">-&gt;</span><span class="n">init_key_from_rec</span><span class="p">(</span><span class="o">&amp;</span><span class="n">key</span><span class="p">,</span>
			<span class="n">xfs_btree_rec_addr</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">right</span><span class="p">));</span>
		<span class="n">rkp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">key</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Update the parent key values of right. */</span>
	<span class="n">error</span> <span class="o">=</span> <span class="n">xfs_btree_updkey</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">rkp</span><span class="p">,</span> <span class="n">level</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error0</span><span class="p">;</span>

	<span class="cm">/* Slide the cursor value left one. */</span>
	<span class="n">cur</span><span class="o">-&gt;</span><span class="n">bc_ptrs</span><span class="p">[</span><span class="n">level</span><span class="p">]</span><span class="o">--</span><span class="p">;</span>

	<span class="n">XFS_BTREE_TRACE_CURSOR</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">XBT_EXIT</span><span class="p">);</span>
	<span class="o">*</span><span class="n">stat</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">out0:</span>
	<span class="n">XFS_BTREE_TRACE_CURSOR</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">XBT_EXIT</span><span class="p">);</span>
	<span class="o">*</span><span class="n">stat</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">error0:</span>
	<span class="n">XFS_BTREE_TRACE_CURSOR</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">XBT_ERROR</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Move 1 record right from cur/level if possible.</span>
<span class="cm"> * Update cur to reflect the new path.</span>
<span class="cm"> */</span>
<span class="n">STATIC</span> <span class="kt">int</span>					<span class="cm">/* error */</span>
<span class="n">xfs_btree_rshift</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">xfs_btree_cur</span>	<span class="o">*</span><span class="n">cur</span><span class="p">,</span>
	<span class="kt">int</span>			<span class="n">level</span><span class="p">,</span>
	<span class="kt">int</span>			<span class="o">*</span><span class="n">stat</span><span class="p">)</span>		<span class="cm">/* success/failure */</span>
<span class="p">{</span>
	<span class="k">union</span> <span class="n">xfs_btree_key</span>	<span class="n">key</span><span class="p">;</span>		<span class="cm">/* btree key */</span>
	<span class="k">struct</span> <span class="n">xfs_buf</span>		<span class="o">*</span><span class="n">lbp</span><span class="p">;</span>		<span class="cm">/* left buffer pointer */</span>
	<span class="k">struct</span> <span class="n">xfs_btree_block</span>	<span class="o">*</span><span class="n">left</span><span class="p">;</span>		<span class="cm">/* left btree block */</span>
	<span class="k">struct</span> <span class="n">xfs_buf</span>		<span class="o">*</span><span class="n">rbp</span><span class="p">;</span>		<span class="cm">/* right buffer pointer */</span>
	<span class="k">struct</span> <span class="n">xfs_btree_block</span>	<span class="o">*</span><span class="n">right</span><span class="p">;</span>		<span class="cm">/* right btree block */</span>
	<span class="k">struct</span> <span class="n">xfs_btree_cur</span>	<span class="o">*</span><span class="n">tcur</span><span class="p">;</span>		<span class="cm">/* temporary btree cursor */</span>
	<span class="k">union</span> <span class="n">xfs_btree_ptr</span>	<span class="n">rptr</span><span class="p">;</span>		<span class="cm">/* right block pointer */</span>
	<span class="k">union</span> <span class="n">xfs_btree_key</span>	<span class="o">*</span><span class="n">rkp</span><span class="p">;</span>		<span class="cm">/* right btree key */</span>
	<span class="kt">int</span>			<span class="n">rrecs</span><span class="p">;</span>		<span class="cm">/* right record count */</span>
	<span class="kt">int</span>			<span class="n">lrecs</span><span class="p">;</span>		<span class="cm">/* left record count */</span>
	<span class="kt">int</span>			<span class="n">error</span><span class="p">;</span>		<span class="cm">/* error return value */</span>
	<span class="kt">int</span>			<span class="n">i</span><span class="p">;</span>		<span class="cm">/* loop counter */</span>

	<span class="n">XFS_BTREE_TRACE_CURSOR</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">XBT_ENTRY</span><span class="p">);</span>
	<span class="n">XFS_BTREE_TRACE_ARGI</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">level</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">bc_flags</span> <span class="o">&amp;</span> <span class="n">XFS_BTREE_ROOT_IN_INODE</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">level</span> <span class="o">==</span> <span class="n">cur</span><span class="o">-&gt;</span><span class="n">bc_nlevels</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out0</span><span class="p">;</span>

	<span class="cm">/* Set up variables for this block as &quot;left&quot;. */</span>
	<span class="n">left</span> <span class="o">=</span> <span class="n">xfs_btree_get_block</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">level</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">lbp</span><span class="p">);</span>

<span class="cp">#ifdef DEBUG</span>
	<span class="n">error</span> <span class="o">=</span> <span class="n">xfs_btree_check_block</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">left</span><span class="p">,</span> <span class="n">level</span><span class="p">,</span> <span class="n">lbp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error0</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="cm">/* If we&#39;ve got no right sibling then we can&#39;t shift an entry right. */</span>
	<span class="n">xfs_btree_get_sibling</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">left</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rptr</span><span class="p">,</span> <span class="n">XFS_BB_RIGHTSIB</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">xfs_btree_ptr_is_null</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rptr</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out0</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * If the cursor entry is the one that would be moved, don&#39;t</span>
<span class="cm">	 * do it... it&#39;s too complicated.</span>
<span class="cm">	 */</span>
	<span class="n">lrecs</span> <span class="o">=</span> <span class="n">xfs_btree_get_numrecs</span><span class="p">(</span><span class="n">left</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">bc_ptrs</span><span class="p">[</span><span class="n">level</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">lrecs</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out0</span><span class="p">;</span>

	<span class="cm">/* Set up the right neighbor as &quot;right&quot;. */</span>
	<span class="n">error</span> <span class="o">=</span> <span class="n">xfs_btree_read_buf_block</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rptr</span><span class="p">,</span> <span class="n">level</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">right</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rbp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error0</span><span class="p">;</span>

	<span class="cm">/* If it&#39;s full, it can&#39;t take another entry. */</span>
	<span class="n">rrecs</span> <span class="o">=</span> <span class="n">xfs_btree_get_numrecs</span><span class="p">(</span><span class="n">right</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rrecs</span> <span class="o">==</span> <span class="n">cur</span><span class="o">-&gt;</span><span class="n">bc_ops</span><span class="o">-&gt;</span><span class="n">get_maxrecs</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">level</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out0</span><span class="p">;</span>

	<span class="n">XFS_BTREE_STATS_INC</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">rshift</span><span class="p">);</span>
	<span class="n">XFS_BTREE_STATS_ADD</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">moves</span><span class="p">,</span> <span class="n">rrecs</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Make a hole at the start of the right neighbor block, then</span>
<span class="cm">	 * copy the last left block entry to the hole.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">level</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* It&#39;s a nonleaf. make a hole in the keys and ptrs */</span>
		<span class="k">union</span> <span class="n">xfs_btree_key</span>	<span class="o">*</span><span class="n">lkp</span><span class="p">;</span>
		<span class="k">union</span> <span class="n">xfs_btree_ptr</span>	<span class="o">*</span><span class="n">lpp</span><span class="p">;</span>
		<span class="k">union</span> <span class="n">xfs_btree_ptr</span>	<span class="o">*</span><span class="n">rpp</span><span class="p">;</span>

		<span class="n">lkp</span> <span class="o">=</span> <span class="n">xfs_btree_key_addr</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">lrecs</span><span class="p">,</span> <span class="n">left</span><span class="p">);</span>
		<span class="n">lpp</span> <span class="o">=</span> <span class="n">xfs_btree_ptr_addr</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">lrecs</span><span class="p">,</span> <span class="n">left</span><span class="p">);</span>
		<span class="n">rkp</span> <span class="o">=</span> <span class="n">xfs_btree_key_addr</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">right</span><span class="p">);</span>
		<span class="n">rpp</span> <span class="o">=</span> <span class="n">xfs_btree_ptr_addr</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">right</span><span class="p">);</span>

<span class="cp">#ifdef DEBUG</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">rrecs</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">error</span> <span class="o">=</span> <span class="n">xfs_btree_check_ptr</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">rpp</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">level</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">error0</span><span class="p">;</span>
		<span class="p">}</span>
<span class="cp">#endif</span>

		<span class="n">xfs_btree_shift_keys</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">rkp</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">rrecs</span><span class="p">);</span>
		<span class="n">xfs_btree_shift_ptrs</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">rpp</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">rrecs</span><span class="p">);</span>

<span class="cp">#ifdef DEBUG</span>
		<span class="n">error</span> <span class="o">=</span> <span class="n">xfs_btree_check_ptr</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">lpp</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">level</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">error0</span><span class="p">;</span>
<span class="cp">#endif</span>

		<span class="cm">/* Now put the new data in, and log it. */</span>
		<span class="n">xfs_btree_copy_keys</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">rkp</span><span class="p">,</span> <span class="n">lkp</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">xfs_btree_copy_ptrs</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">rpp</span><span class="p">,</span> <span class="n">lpp</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

		<span class="n">xfs_btree_log_keys</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">rbp</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">rrecs</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">xfs_btree_log_ptrs</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">rbp</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">rrecs</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>

		<span class="n">ASSERT</span><span class="p">(</span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">bc_ops</span><span class="o">-&gt;</span><span class="n">keys_inorder</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">rkp</span><span class="p">,</span>
			<span class="n">xfs_btree_key_addr</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">right</span><span class="p">)));</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* It&#39;s a leaf. make a hole in the records */</span>
		<span class="k">union</span> <span class="n">xfs_btree_rec</span>	<span class="o">*</span><span class="n">lrp</span><span class="p">;</span>
		<span class="k">union</span> <span class="n">xfs_btree_rec</span>	<span class="o">*</span><span class="n">rrp</span><span class="p">;</span>

		<span class="n">lrp</span> <span class="o">=</span> <span class="n">xfs_btree_rec_addr</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">lrecs</span><span class="p">,</span> <span class="n">left</span><span class="p">);</span>
		<span class="n">rrp</span> <span class="o">=</span> <span class="n">xfs_btree_rec_addr</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">right</span><span class="p">);</span>

		<span class="n">xfs_btree_shift_recs</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">rrp</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">rrecs</span><span class="p">);</span>

		<span class="cm">/* Now put the new data in, and log it. */</span>
		<span class="n">xfs_btree_copy_recs</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">rrp</span><span class="p">,</span> <span class="n">lrp</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">xfs_btree_log_recs</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">rbp</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">rrecs</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>

		<span class="n">cur</span><span class="o">-&gt;</span><span class="n">bc_ops</span><span class="o">-&gt;</span><span class="n">init_key_from_rec</span><span class="p">(</span><span class="o">&amp;</span><span class="n">key</span><span class="p">,</span> <span class="n">rrp</span><span class="p">);</span>
		<span class="n">rkp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">key</span><span class="p">;</span>

		<span class="n">ASSERT</span><span class="p">(</span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">bc_ops</span><span class="o">-&gt;</span><span class="n">recs_inorder</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">rrp</span><span class="p">,</span>
			<span class="n">xfs_btree_rec_addr</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">right</span><span class="p">)));</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Decrement and log left&#39;s numrecs, bump and log right&#39;s numrecs.</span>
<span class="cm">	 */</span>
	<span class="n">xfs_btree_set_numrecs</span><span class="p">(</span><span class="n">left</span><span class="p">,</span> <span class="o">--</span><span class="n">lrecs</span><span class="p">);</span>
	<span class="n">xfs_btree_log_block</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">lbp</span><span class="p">,</span> <span class="n">XFS_BB_NUMRECS</span><span class="p">);</span>

	<span class="n">xfs_btree_set_numrecs</span><span class="p">(</span><span class="n">right</span><span class="p">,</span> <span class="o">++</span><span class="n">rrecs</span><span class="p">);</span>
	<span class="n">xfs_btree_log_block</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">rbp</span><span class="p">,</span> <span class="n">XFS_BB_NUMRECS</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Using a temporary cursor, update the parent key values of the</span>
<span class="cm">	 * block on the right.</span>
<span class="cm">	 */</span>
	<span class="n">error</span> <span class="o">=</span> <span class="n">xfs_btree_dup_cursor</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tcur</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error0</span><span class="p">;</span>
	<span class="n">i</span> <span class="o">=</span> <span class="n">xfs_btree_lastrec</span><span class="p">(</span><span class="n">tcur</span><span class="p">,</span> <span class="n">level</span><span class="p">);</span>
	<span class="n">XFS_WANT_CORRUPTED_GOTO</span><span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="n">error0</span><span class="p">);</span>

	<span class="n">error</span> <span class="o">=</span> <span class="n">xfs_btree_increment</span><span class="p">(</span><span class="n">tcur</span><span class="p">,</span> <span class="n">level</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">i</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error1</span><span class="p">;</span>

	<span class="n">error</span> <span class="o">=</span> <span class="n">xfs_btree_updkey</span><span class="p">(</span><span class="n">tcur</span><span class="p">,</span> <span class="n">rkp</span><span class="p">,</span> <span class="n">level</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error1</span><span class="p">;</span>

	<span class="n">xfs_btree_del_cursor</span><span class="p">(</span><span class="n">tcur</span><span class="p">,</span> <span class="n">XFS_BTREE_NOERROR</span><span class="p">);</span>

	<span class="n">XFS_BTREE_TRACE_CURSOR</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">XBT_EXIT</span><span class="p">);</span>
	<span class="o">*</span><span class="n">stat</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">out0:</span>
	<span class="n">XFS_BTREE_TRACE_CURSOR</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">XBT_EXIT</span><span class="p">);</span>
	<span class="o">*</span><span class="n">stat</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">error0:</span>
	<span class="n">XFS_BTREE_TRACE_CURSOR</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">XBT_ERROR</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">error</span><span class="p">;</span>

<span class="nl">error1:</span>
	<span class="n">XFS_BTREE_TRACE_CURSOR</span><span class="p">(</span><span class="n">tcur</span><span class="p">,</span> <span class="n">XBT_ERROR</span><span class="p">);</span>
	<span class="n">xfs_btree_del_cursor</span><span class="p">(</span><span class="n">tcur</span><span class="p">,</span> <span class="n">XFS_BTREE_ERROR</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Split cur/level block in half.</span>
<span class="cm"> * Return new block number and the key to its first</span>
<span class="cm"> * record (to be inserted into parent).</span>
<span class="cm"> */</span>
<span class="n">STATIC</span> <span class="kt">int</span>					<span class="cm">/* error */</span>
<span class="n">xfs_btree_split</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">xfs_btree_cur</span>	<span class="o">*</span><span class="n">cur</span><span class="p">,</span>
	<span class="kt">int</span>			<span class="n">level</span><span class="p">,</span>
	<span class="k">union</span> <span class="n">xfs_btree_ptr</span>	<span class="o">*</span><span class="n">ptrp</span><span class="p">,</span>
	<span class="k">union</span> <span class="n">xfs_btree_key</span>	<span class="o">*</span><span class="n">key</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">xfs_btree_cur</span>	<span class="o">**</span><span class="n">curp</span><span class="p">,</span>
	<span class="kt">int</span>			<span class="o">*</span><span class="n">stat</span><span class="p">)</span>		<span class="cm">/* success/failure */</span>
<span class="p">{</span>
	<span class="k">union</span> <span class="n">xfs_btree_ptr</span>	<span class="n">lptr</span><span class="p">;</span>		<span class="cm">/* left sibling block ptr */</span>
	<span class="k">struct</span> <span class="n">xfs_buf</span>		<span class="o">*</span><span class="n">lbp</span><span class="p">;</span>		<span class="cm">/* left buffer pointer */</span>
	<span class="k">struct</span> <span class="n">xfs_btree_block</span>	<span class="o">*</span><span class="n">left</span><span class="p">;</span>		<span class="cm">/* left btree block */</span>
	<span class="k">union</span> <span class="n">xfs_btree_ptr</span>	<span class="n">rptr</span><span class="p">;</span>		<span class="cm">/* right sibling block ptr */</span>
	<span class="k">struct</span> <span class="n">xfs_buf</span>		<span class="o">*</span><span class="n">rbp</span><span class="p">;</span>		<span class="cm">/* right buffer pointer */</span>
	<span class="k">struct</span> <span class="n">xfs_btree_block</span>	<span class="o">*</span><span class="n">right</span><span class="p">;</span>		<span class="cm">/* right btree block */</span>
	<span class="k">union</span> <span class="n">xfs_btree_ptr</span>	<span class="n">rrptr</span><span class="p">;</span>		<span class="cm">/* right-right sibling ptr */</span>
	<span class="k">struct</span> <span class="n">xfs_buf</span>		<span class="o">*</span><span class="n">rrbp</span><span class="p">;</span>		<span class="cm">/* right-right buffer pointer */</span>
	<span class="k">struct</span> <span class="n">xfs_btree_block</span>	<span class="o">*</span><span class="n">rrblock</span><span class="p">;</span>	<span class="cm">/* right-right btree block */</span>
	<span class="kt">int</span>			<span class="n">lrecs</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">rrecs</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">src_index</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">error</span><span class="p">;</span>		<span class="cm">/* error return value */</span>
<span class="cp">#ifdef DEBUG</span>
	<span class="kt">int</span>			<span class="n">i</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="n">XFS_BTREE_TRACE_CURSOR</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">XBT_ENTRY</span><span class="p">);</span>
	<span class="n">XFS_BTREE_TRACE_ARGIPK</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">level</span><span class="p">,</span> <span class="o">*</span><span class="n">ptrp</span><span class="p">,</span> <span class="n">key</span><span class="p">);</span>

	<span class="n">XFS_BTREE_STATS_INC</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">split</span><span class="p">);</span>

	<span class="cm">/* Set up left block (current one). */</span>
	<span class="n">left</span> <span class="o">=</span> <span class="n">xfs_btree_get_block</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">level</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">lbp</span><span class="p">);</span>

<span class="cp">#ifdef DEBUG</span>
	<span class="n">error</span> <span class="o">=</span> <span class="n">xfs_btree_check_block</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">left</span><span class="p">,</span> <span class="n">level</span><span class="p">,</span> <span class="n">lbp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error0</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="n">xfs_btree_buf_to_ptr</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">lbp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">lptr</span><span class="p">);</span>

	<span class="cm">/* Allocate the new block. If we can&#39;t do it, we&#39;re toast. Give up. */</span>
	<span class="n">error</span> <span class="o">=</span> <span class="n">cur</span><span class="o">-&gt;</span><span class="n">bc_ops</span><span class="o">-&gt;</span><span class="n">alloc_block</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">lptr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rptr</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">stat</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">stat</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out0</span><span class="p">;</span>
	<span class="n">XFS_BTREE_STATS_INC</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">alloc</span><span class="p">);</span>

	<span class="cm">/* Set up the new block as &quot;right&quot;. */</span>
	<span class="n">error</span> <span class="o">=</span> <span class="n">xfs_btree_get_buf_block</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rptr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">right</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rbp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error0</span><span class="p">;</span>

	<span class="cm">/* Fill in the btree header for the new right block. */</span>
	<span class="n">xfs_btree_init_block</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">xfs_btree_get_level</span><span class="p">(</span><span class="n">left</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="n">right</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Split the entries between the old and the new block evenly.</span>
<span class="cm">	 * Make sure that if there&#39;s an odd number of entries now, that</span>
<span class="cm">	 * each new block will have the same number of entries.</span>
<span class="cm">	 */</span>
	<span class="n">lrecs</span> <span class="o">=</span> <span class="n">xfs_btree_get_numrecs</span><span class="p">(</span><span class="n">left</span><span class="p">);</span>
	<span class="n">rrecs</span> <span class="o">=</span> <span class="n">lrecs</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">lrecs</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">cur</span><span class="o">-&gt;</span><span class="n">bc_ptrs</span><span class="p">[</span><span class="n">level</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">rrecs</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">rrecs</span><span class="o">++</span><span class="p">;</span>
	<span class="n">src_index</span> <span class="o">=</span> <span class="p">(</span><span class="n">lrecs</span> <span class="o">-</span> <span class="n">rrecs</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">XFS_BTREE_STATS_ADD</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">moves</span><span class="p">,</span> <span class="n">rrecs</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Copy btree block entries from the left block over to the</span>
<span class="cm">	 * new block, the right. Update the right block and log the</span>
<span class="cm">	 * changes.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">level</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* It&#39;s a non-leaf.  Move keys and pointers. */</span>
		<span class="k">union</span> <span class="n">xfs_btree_key</span>	<span class="o">*</span><span class="n">lkp</span><span class="p">;</span>	<span class="cm">/* left btree key */</span>
		<span class="k">union</span> <span class="n">xfs_btree_ptr</span>	<span class="o">*</span><span class="n">lpp</span><span class="p">;</span>	<span class="cm">/* left address pointer */</span>
		<span class="k">union</span> <span class="n">xfs_btree_key</span>	<span class="o">*</span><span class="n">rkp</span><span class="p">;</span>	<span class="cm">/* right btree key */</span>
		<span class="k">union</span> <span class="n">xfs_btree_ptr</span>	<span class="o">*</span><span class="n">rpp</span><span class="p">;</span>	<span class="cm">/* right address pointer */</span>

		<span class="n">lkp</span> <span class="o">=</span> <span class="n">xfs_btree_key_addr</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">src_index</span><span class="p">,</span> <span class="n">left</span><span class="p">);</span>
		<span class="n">lpp</span> <span class="o">=</span> <span class="n">xfs_btree_ptr_addr</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">src_index</span><span class="p">,</span> <span class="n">left</span><span class="p">);</span>
		<span class="n">rkp</span> <span class="o">=</span> <span class="n">xfs_btree_key_addr</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">right</span><span class="p">);</span>
		<span class="n">rpp</span> <span class="o">=</span> <span class="n">xfs_btree_ptr_addr</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">right</span><span class="p">);</span>

<span class="cp">#ifdef DEBUG</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">src_index</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">rrecs</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">error</span> <span class="o">=</span> <span class="n">xfs_btree_check_ptr</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">lpp</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">level</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">error0</span><span class="p">;</span>
		<span class="p">}</span>
<span class="cp">#endif</span>

		<span class="n">xfs_btree_copy_keys</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">rkp</span><span class="p">,</span> <span class="n">lkp</span><span class="p">,</span> <span class="n">rrecs</span><span class="p">);</span>
		<span class="n">xfs_btree_copy_ptrs</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">rpp</span><span class="p">,</span> <span class="n">lpp</span><span class="p">,</span> <span class="n">rrecs</span><span class="p">);</span>

		<span class="n">xfs_btree_log_keys</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">rbp</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">rrecs</span><span class="p">);</span>
		<span class="n">xfs_btree_log_ptrs</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">rbp</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">rrecs</span><span class="p">);</span>

		<span class="cm">/* Grab the keys to the entries moved to the right block */</span>
		<span class="n">xfs_btree_copy_keys</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">rkp</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* It&#39;s a leaf.  Move records.  */</span>
		<span class="k">union</span> <span class="n">xfs_btree_rec</span>	<span class="o">*</span><span class="n">lrp</span><span class="p">;</span>	<span class="cm">/* left record pointer */</span>
		<span class="k">union</span> <span class="n">xfs_btree_rec</span>	<span class="o">*</span><span class="n">rrp</span><span class="p">;</span>	<span class="cm">/* right record pointer */</span>

		<span class="n">lrp</span> <span class="o">=</span> <span class="n">xfs_btree_rec_addr</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">src_index</span><span class="p">,</span> <span class="n">left</span><span class="p">);</span>
		<span class="n">rrp</span> <span class="o">=</span> <span class="n">xfs_btree_rec_addr</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">right</span><span class="p">);</span>

		<span class="n">xfs_btree_copy_recs</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">rrp</span><span class="p">,</span> <span class="n">lrp</span><span class="p">,</span> <span class="n">rrecs</span><span class="p">);</span>
		<span class="n">xfs_btree_log_recs</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">rbp</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">rrecs</span><span class="p">);</span>

		<span class="n">cur</span><span class="o">-&gt;</span><span class="n">bc_ops</span><span class="o">-&gt;</span><span class="n">init_key_from_rec</span><span class="p">(</span><span class="n">key</span><span class="p">,</span>
			<span class="n">xfs_btree_rec_addr</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">right</span><span class="p">));</span>
	<span class="p">}</span>


	<span class="cm">/*</span>
<span class="cm">	 * Find the left block number by looking in the buffer.</span>
<span class="cm">	 * Adjust numrecs, sibling pointers.</span>
<span class="cm">	 */</span>
	<span class="n">xfs_btree_get_sibling</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">left</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rrptr</span><span class="p">,</span> <span class="n">XFS_BB_RIGHTSIB</span><span class="p">);</span>
	<span class="n">xfs_btree_set_sibling</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">right</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rrptr</span><span class="p">,</span> <span class="n">XFS_BB_RIGHTSIB</span><span class="p">);</span>
	<span class="n">xfs_btree_set_sibling</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">right</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">lptr</span><span class="p">,</span> <span class="n">XFS_BB_LEFTSIB</span><span class="p">);</span>
	<span class="n">xfs_btree_set_sibling</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">left</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rptr</span><span class="p">,</span> <span class="n">XFS_BB_RIGHTSIB</span><span class="p">);</span>

	<span class="n">lrecs</span> <span class="o">-=</span> <span class="n">rrecs</span><span class="p">;</span>
	<span class="n">xfs_btree_set_numrecs</span><span class="p">(</span><span class="n">left</span><span class="p">,</span> <span class="n">lrecs</span><span class="p">);</span>
	<span class="n">xfs_btree_set_numrecs</span><span class="p">(</span><span class="n">right</span><span class="p">,</span> <span class="n">xfs_btree_get_numrecs</span><span class="p">(</span><span class="n">right</span><span class="p">)</span> <span class="o">+</span> <span class="n">rrecs</span><span class="p">);</span>

	<span class="n">xfs_btree_log_block</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">rbp</span><span class="p">,</span> <span class="n">XFS_BB_ALL_BITS</span><span class="p">);</span>
	<span class="n">xfs_btree_log_block</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">lbp</span><span class="p">,</span> <span class="n">XFS_BB_NUMRECS</span> <span class="o">|</span> <span class="n">XFS_BB_RIGHTSIB</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * If there&#39;s a block to the new block&#39;s right, make that block</span>
<span class="cm">	 * point back to right instead of to left.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">xfs_btree_ptr_is_null</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rrptr</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">error</span> <span class="o">=</span> <span class="n">xfs_btree_read_buf_block</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rrptr</span><span class="p">,</span> <span class="n">level</span><span class="p">,</span>
							<span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rrblock</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rrbp</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">error0</span><span class="p">;</span>
		<span class="n">xfs_btree_set_sibling</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">rrblock</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rptr</span><span class="p">,</span> <span class="n">XFS_BB_LEFTSIB</span><span class="p">);</span>
		<span class="n">xfs_btree_log_block</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">rrbp</span><span class="p">,</span> <span class="n">XFS_BB_LEFTSIB</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="cm">/*</span>
<span class="cm">	 * If the cursor is really in the right block, move it there.</span>
<span class="cm">	 * If it&#39;s just pointing past the last entry in left, then we&#39;ll</span>
<span class="cm">	 * insert there, so don&#39;t change anything in that case.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">bc_ptrs</span><span class="p">[</span><span class="n">level</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">lrecs</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">xfs_btree_setbuf</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">level</span><span class="p">,</span> <span class="n">rbp</span><span class="p">);</span>
		<span class="n">cur</span><span class="o">-&gt;</span><span class="n">bc_ptrs</span><span class="p">[</span><span class="n">level</span><span class="p">]</span> <span class="o">-=</span> <span class="n">lrecs</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/*</span>
<span class="cm">	 * If there are more levels, we&#39;ll need another cursor which refers</span>
<span class="cm">	 * the right block, no matter where this cursor was.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">level</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">&lt;</span> <span class="n">cur</span><span class="o">-&gt;</span><span class="n">bc_nlevels</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">error</span> <span class="o">=</span> <span class="n">xfs_btree_dup_cursor</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">curp</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">error0</span><span class="p">;</span>
		<span class="p">(</span><span class="o">*</span><span class="n">curp</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">bc_ptrs</span><span class="p">[</span><span class="n">level</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="o">*</span><span class="n">ptrp</span> <span class="o">=</span> <span class="n">rptr</span><span class="p">;</span>
	<span class="n">XFS_BTREE_TRACE_CURSOR</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">XBT_EXIT</span><span class="p">);</span>
	<span class="o">*</span><span class="n">stat</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">out0:</span>
	<span class="n">XFS_BTREE_TRACE_CURSOR</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">XBT_EXIT</span><span class="p">);</span>
	<span class="o">*</span><span class="n">stat</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">error0:</span>
	<span class="n">XFS_BTREE_TRACE_CURSOR</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">XBT_ERROR</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Copy the old inode root contents into a real block and make the</span>
<span class="cm"> * broot point to it.</span>
<span class="cm"> */</span>
<span class="kt">int</span>						<span class="cm">/* error */</span>
<span class="n">xfs_btree_new_iroot</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">xfs_btree_cur</span>	<span class="o">*</span><span class="n">cur</span><span class="p">,</span>		<span class="cm">/* btree cursor */</span>
	<span class="kt">int</span>			<span class="o">*</span><span class="n">logflags</span><span class="p">,</span>	<span class="cm">/* logging flags for inode */</span>
	<span class="kt">int</span>			<span class="o">*</span><span class="n">stat</span><span class="p">)</span>		<span class="cm">/* return status - 0 fail */</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">xfs_buf</span>		<span class="o">*</span><span class="n">cbp</span><span class="p">;</span>		<span class="cm">/* buffer for cblock */</span>
	<span class="k">struct</span> <span class="n">xfs_btree_block</span>	<span class="o">*</span><span class="n">block</span><span class="p">;</span>		<span class="cm">/* btree block */</span>
	<span class="k">struct</span> <span class="n">xfs_btree_block</span>	<span class="o">*</span><span class="n">cblock</span><span class="p">;</span>	<span class="cm">/* child btree block */</span>
	<span class="k">union</span> <span class="n">xfs_btree_key</span>	<span class="o">*</span><span class="n">ckp</span><span class="p">;</span>		<span class="cm">/* child key pointer */</span>
	<span class="k">union</span> <span class="n">xfs_btree_ptr</span>	<span class="o">*</span><span class="n">cpp</span><span class="p">;</span>		<span class="cm">/* child ptr pointer */</span>
	<span class="k">union</span> <span class="n">xfs_btree_key</span>	<span class="o">*</span><span class="n">kp</span><span class="p">;</span>		<span class="cm">/* pointer to btree key */</span>
	<span class="k">union</span> <span class="n">xfs_btree_ptr</span>	<span class="o">*</span><span class="n">pp</span><span class="p">;</span>		<span class="cm">/* pointer to block addr */</span>
	<span class="k">union</span> <span class="n">xfs_btree_ptr</span>	<span class="n">nptr</span><span class="p">;</span>		<span class="cm">/* new block addr */</span>
	<span class="kt">int</span>			<span class="n">level</span><span class="p">;</span>		<span class="cm">/* btree level */</span>
	<span class="kt">int</span>			<span class="n">error</span><span class="p">;</span>		<span class="cm">/* error return code */</span>
<span class="cp">#ifdef DEBUG</span>
	<span class="kt">int</span>			<span class="n">i</span><span class="p">;</span>		<span class="cm">/* loop counter */</span>
<span class="cp">#endif</span>

	<span class="n">XFS_BTREE_TRACE_CURSOR</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">XBT_ENTRY</span><span class="p">);</span>
	<span class="n">XFS_BTREE_STATS_INC</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">newroot</span><span class="p">);</span>

	<span class="n">ASSERT</span><span class="p">(</span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">bc_flags</span> <span class="o">&amp;</span> <span class="n">XFS_BTREE_ROOT_IN_INODE</span><span class="p">);</span>

	<span class="n">level</span> <span class="o">=</span> <span class="n">cur</span><span class="o">-&gt;</span><span class="n">bc_nlevels</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">block</span> <span class="o">=</span> <span class="n">xfs_btree_get_iroot</span><span class="p">(</span><span class="n">cur</span><span class="p">);</span>
	<span class="n">pp</span> <span class="o">=</span> <span class="n">xfs_btree_ptr_addr</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">block</span><span class="p">);</span>

	<span class="cm">/* Allocate the new block. If we can&#39;t do it, we&#39;re toast. Give up. */</span>
	<span class="n">error</span> <span class="o">=</span> <span class="n">cur</span><span class="o">-&gt;</span><span class="n">bc_ops</span><span class="o">-&gt;</span><span class="n">alloc_block</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">pp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">nptr</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">stat</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">stat</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">XFS_BTREE_TRACE_CURSOR</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">XBT_EXIT</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">XFS_BTREE_STATS_INC</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">alloc</span><span class="p">);</span>

	<span class="cm">/* Copy the root into a real block. */</span>
	<span class="n">error</span> <span class="o">=</span> <span class="n">xfs_btree_get_buf_block</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">nptr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cblock</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cbp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error0</span><span class="p">;</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">cblock</span><span class="p">,</span> <span class="n">block</span><span class="p">,</span> <span class="n">xfs_btree_block_len</span><span class="p">(</span><span class="n">cur</span><span class="p">));</span>

	<span class="n">be16_add_cpu</span><span class="p">(</span><span class="o">&amp;</span><span class="n">block</span><span class="o">-&gt;</span><span class="n">bb_level</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">xfs_btree_set_numrecs</span><span class="p">(</span><span class="n">block</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">cur</span><span class="o">-&gt;</span><span class="n">bc_nlevels</span><span class="o">++</span><span class="p">;</span>
	<span class="n">cur</span><span class="o">-&gt;</span><span class="n">bc_ptrs</span><span class="p">[</span><span class="n">level</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">kp</span> <span class="o">=</span> <span class="n">xfs_btree_key_addr</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">block</span><span class="p">);</span>
	<span class="n">ckp</span> <span class="o">=</span> <span class="n">xfs_btree_key_addr</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">cblock</span><span class="p">);</span>
	<span class="n">xfs_btree_copy_keys</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">ckp</span><span class="p">,</span> <span class="n">kp</span><span class="p">,</span> <span class="n">xfs_btree_get_numrecs</span><span class="p">(</span><span class="n">cblock</span><span class="p">));</span>

	<span class="n">cpp</span> <span class="o">=</span> <span class="n">xfs_btree_ptr_addr</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">cblock</span><span class="p">);</span>
<span class="cp">#ifdef DEBUG</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">cblock</span><span class="o">-&gt;</span><span class="n">bb_numrecs</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">error</span> <span class="o">=</span> <span class="n">xfs_btree_check_ptr</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">pp</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">level</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">error0</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
	<span class="n">xfs_btree_copy_ptrs</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">cpp</span><span class="p">,</span> <span class="n">pp</span><span class="p">,</span> <span class="n">xfs_btree_get_numrecs</span><span class="p">(</span><span class="n">cblock</span><span class="p">));</span>

<span class="cp">#ifdef DEBUG</span>
	<span class="n">error</span> <span class="o">=</span> <span class="n">xfs_btree_check_ptr</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">nptr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">level</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error0</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="n">xfs_btree_copy_ptrs</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">pp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">nptr</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">xfs_iroot_realloc</span><span class="p">(</span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">bc_private</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">ip</span><span class="p">,</span>
			  <span class="mi">1</span> <span class="o">-</span> <span class="n">xfs_btree_get_numrecs</span><span class="p">(</span><span class="n">cblock</span><span class="p">),</span>
			  <span class="n">cur</span><span class="o">-&gt;</span><span class="n">bc_private</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">whichfork</span><span class="p">);</span>

	<span class="n">xfs_btree_setbuf</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">level</span><span class="p">,</span> <span class="n">cbp</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Do all this logging at the end so that</span>
<span class="cm">	 * the root is at the right level.</span>
<span class="cm">	 */</span>
	<span class="n">xfs_btree_log_block</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">cbp</span><span class="p">,</span> <span class="n">XFS_BB_ALL_BITS</span><span class="p">);</span>
	<span class="n">xfs_btree_log_keys</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">cbp</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">cblock</span><span class="o">-&gt;</span><span class="n">bb_numrecs</span><span class="p">));</span>
	<span class="n">xfs_btree_log_ptrs</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">cbp</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">cblock</span><span class="o">-&gt;</span><span class="n">bb_numrecs</span><span class="p">));</span>

	<span class="o">*</span><span class="n">logflags</span> <span class="o">|=</span>
		<span class="n">XFS_ILOG_CORE</span> <span class="o">|</span> <span class="n">xfs_ilog_fbroot</span><span class="p">(</span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">bc_private</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">whichfork</span><span class="p">);</span>
	<span class="o">*</span><span class="n">stat</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">XFS_BTREE_TRACE_CURSOR</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">XBT_EXIT</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">error0:</span>
	<span class="n">XFS_BTREE_TRACE_CURSOR</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">XBT_ERROR</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Allocate a new root block, fill it in.</span>
<span class="cm"> */</span>
<span class="n">STATIC</span> <span class="kt">int</span>				<span class="cm">/* error */</span>
<span class="n">xfs_btree_new_root</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">xfs_btree_cur</span>	<span class="o">*</span><span class="n">cur</span><span class="p">,</span>	<span class="cm">/* btree cursor */</span>
	<span class="kt">int</span>			<span class="o">*</span><span class="n">stat</span><span class="p">)</span>	<span class="cm">/* success/failure */</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">xfs_btree_block</span>	<span class="o">*</span><span class="n">block</span><span class="p">;</span>	<span class="cm">/* one half of the old root block */</span>
	<span class="k">struct</span> <span class="n">xfs_buf</span>		<span class="o">*</span><span class="n">bp</span><span class="p">;</span>	<span class="cm">/* buffer containing block */</span>
	<span class="kt">int</span>			<span class="n">error</span><span class="p">;</span>	<span class="cm">/* error return value */</span>
	<span class="k">struct</span> <span class="n">xfs_buf</span>		<span class="o">*</span><span class="n">lbp</span><span class="p">;</span>	<span class="cm">/* left buffer pointer */</span>
	<span class="k">struct</span> <span class="n">xfs_btree_block</span>	<span class="o">*</span><span class="n">left</span><span class="p">;</span>	<span class="cm">/* left btree block */</span>
	<span class="k">struct</span> <span class="n">xfs_buf</span>		<span class="o">*</span><span class="n">nbp</span><span class="p">;</span>	<span class="cm">/* new (root) buffer */</span>
	<span class="k">struct</span> <span class="n">xfs_btree_block</span>	<span class="o">*</span><span class="n">new</span><span class="p">;</span>	<span class="cm">/* new (root) btree block */</span>
	<span class="kt">int</span>			<span class="n">nptr</span><span class="p">;</span>	<span class="cm">/* new value for key index, 1 or 2 */</span>
	<span class="k">struct</span> <span class="n">xfs_buf</span>		<span class="o">*</span><span class="n">rbp</span><span class="p">;</span>	<span class="cm">/* right buffer pointer */</span>
	<span class="k">struct</span> <span class="n">xfs_btree_block</span>	<span class="o">*</span><span class="n">right</span><span class="p">;</span>	<span class="cm">/* right btree block */</span>
	<span class="k">union</span> <span class="n">xfs_btree_ptr</span>	<span class="n">rptr</span><span class="p">;</span>
	<span class="k">union</span> <span class="n">xfs_btree_ptr</span>	<span class="n">lptr</span><span class="p">;</span>

	<span class="n">XFS_BTREE_TRACE_CURSOR</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">XBT_ENTRY</span><span class="p">);</span>
	<span class="n">XFS_BTREE_STATS_INC</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">newroot</span><span class="p">);</span>

	<span class="cm">/* initialise our start point from the cursor */</span>
	<span class="n">cur</span><span class="o">-&gt;</span><span class="n">bc_ops</span><span class="o">-&gt;</span><span class="n">init_ptr_from_cur</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rptr</span><span class="p">);</span>

	<span class="cm">/* Allocate the new block. If we can&#39;t do it, we&#39;re toast. Give up. */</span>
	<span class="n">error</span> <span class="o">=</span> <span class="n">cur</span><span class="o">-&gt;</span><span class="n">bc_ops</span><span class="o">-&gt;</span><span class="n">alloc_block</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rptr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">lptr</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">stat</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">stat</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out0</span><span class="p">;</span>
	<span class="n">XFS_BTREE_STATS_INC</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">alloc</span><span class="p">);</span>

	<span class="cm">/* Set up the new block. */</span>
	<span class="n">error</span> <span class="o">=</span> <span class="n">xfs_btree_get_buf_block</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">lptr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">new</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">nbp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error0</span><span class="p">;</span>

	<span class="cm">/* Set the root in the holding structure  increasing the level by 1. */</span>
	<span class="n">cur</span><span class="o">-&gt;</span><span class="n">bc_ops</span><span class="o">-&gt;</span><span class="n">set_root</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">lptr</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * At the previous root level there are now two blocks: the old root,</span>
<span class="cm">	 * and the new block generated when it was split.  We don&#39;t know which</span>
<span class="cm">	 * one the cursor is pointing at, so we set up variables &quot;left&quot; and</span>
<span class="cm">	 * &quot;right&quot; for each case.</span>
<span class="cm">	 */</span>
	<span class="n">block</span> <span class="o">=</span> <span class="n">xfs_btree_get_block</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">cur</span><span class="o">-&gt;</span><span class="n">bc_nlevels</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bp</span><span class="p">);</span>

<span class="cp">#ifdef DEBUG</span>
	<span class="n">error</span> <span class="o">=</span> <span class="n">xfs_btree_check_block</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">block</span><span class="p">,</span> <span class="n">cur</span><span class="o">-&gt;</span><span class="n">bc_nlevels</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">bp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error0</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="n">xfs_btree_get_sibling</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">block</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rptr</span><span class="p">,</span> <span class="n">XFS_BB_RIGHTSIB</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">xfs_btree_ptr_is_null</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rptr</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* Our block is left, pick up the right block. */</span>
		<span class="n">lbp</span> <span class="o">=</span> <span class="n">bp</span><span class="p">;</span>
		<span class="n">xfs_btree_buf_to_ptr</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">lbp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">lptr</span><span class="p">);</span>
		<span class="n">left</span> <span class="o">=</span> <span class="n">block</span><span class="p">;</span>
		<span class="n">error</span> <span class="o">=</span> <span class="n">xfs_btree_read_buf_block</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rptr</span><span class="p">,</span>
					<span class="n">cur</span><span class="o">-&gt;</span><span class="n">bc_nlevels</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">right</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rbp</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">error0</span><span class="p">;</span>
		<span class="n">bp</span> <span class="o">=</span> <span class="n">rbp</span><span class="p">;</span>
		<span class="n">nptr</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* Our block is right, pick up the left block. */</span>
		<span class="n">rbp</span> <span class="o">=</span> <span class="n">bp</span><span class="p">;</span>
		<span class="n">xfs_btree_buf_to_ptr</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">rbp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rptr</span><span class="p">);</span>
		<span class="n">right</span> <span class="o">=</span> <span class="n">block</span><span class="p">;</span>
		<span class="n">xfs_btree_get_sibling</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">right</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">lptr</span><span class="p">,</span> <span class="n">XFS_BB_LEFTSIB</span><span class="p">);</span>
		<span class="n">error</span> <span class="o">=</span> <span class="n">xfs_btree_read_buf_block</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">lptr</span><span class="p">,</span>
					<span class="n">cur</span><span class="o">-&gt;</span><span class="n">bc_nlevels</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">left</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">lbp</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">error0</span><span class="p">;</span>
		<span class="n">bp</span> <span class="o">=</span> <span class="n">lbp</span><span class="p">;</span>
		<span class="n">nptr</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* Fill in the new block&#39;s btree header and log it. */</span>
	<span class="n">xfs_btree_init_block</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">cur</span><span class="o">-&gt;</span><span class="n">bc_nlevels</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">new</span><span class="p">);</span>
	<span class="n">xfs_btree_log_block</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">nbp</span><span class="p">,</span> <span class="n">XFS_BB_ALL_BITS</span><span class="p">);</span>
	<span class="n">ASSERT</span><span class="p">(</span><span class="o">!</span><span class="n">xfs_btree_ptr_is_null</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">lptr</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			<span class="o">!</span><span class="n">xfs_btree_ptr_is_null</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rptr</span><span class="p">));</span>

	<span class="cm">/* Fill in the key data in the new root. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">xfs_btree_get_level</span><span class="p">(</span><span class="n">left</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">xfs_btree_copy_keys</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span>
				<span class="n">xfs_btree_key_addr</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">new</span><span class="p">),</span>
				<span class="n">xfs_btree_key_addr</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">left</span><span class="p">),</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">xfs_btree_copy_keys</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span>
				<span class="n">xfs_btree_key_addr</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">new</span><span class="p">),</span>
				<span class="n">xfs_btree_key_addr</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">right</span><span class="p">),</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">cur</span><span class="o">-&gt;</span><span class="n">bc_ops</span><span class="o">-&gt;</span><span class="n">init_key_from_rec</span><span class="p">(</span>
				<span class="n">xfs_btree_key_addr</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">new</span><span class="p">),</span>
				<span class="n">xfs_btree_rec_addr</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">left</span><span class="p">));</span>
		<span class="n">cur</span><span class="o">-&gt;</span><span class="n">bc_ops</span><span class="o">-&gt;</span><span class="n">init_key_from_rec</span><span class="p">(</span>
				<span class="n">xfs_btree_key_addr</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">new</span><span class="p">),</span>
				<span class="n">xfs_btree_rec_addr</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">right</span><span class="p">));</span>
	<span class="p">}</span>
	<span class="n">xfs_btree_log_keys</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">nbp</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>

	<span class="cm">/* Fill in the pointer data in the new root. */</span>
	<span class="n">xfs_btree_copy_ptrs</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span>
		<span class="n">xfs_btree_ptr_addr</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">new</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">lptr</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">xfs_btree_copy_ptrs</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span>
		<span class="n">xfs_btree_ptr_addr</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">new</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">rptr</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">xfs_btree_log_ptrs</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">nbp</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>

	<span class="cm">/* Fix up the cursor. */</span>
	<span class="n">xfs_btree_setbuf</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">cur</span><span class="o">-&gt;</span><span class="n">bc_nlevels</span><span class="p">,</span> <span class="n">nbp</span><span class="p">);</span>
	<span class="n">cur</span><span class="o">-&gt;</span><span class="n">bc_ptrs</span><span class="p">[</span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">bc_nlevels</span><span class="p">]</span> <span class="o">=</span> <span class="n">nptr</span><span class="p">;</span>
	<span class="n">cur</span><span class="o">-&gt;</span><span class="n">bc_nlevels</span><span class="o">++</span><span class="p">;</span>
	<span class="n">XFS_BTREE_TRACE_CURSOR</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">XBT_EXIT</span><span class="p">);</span>
	<span class="o">*</span><span class="n">stat</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">error0:</span>
	<span class="n">XFS_BTREE_TRACE_CURSOR</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">XBT_ERROR</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
<span class="nl">out0:</span>
	<span class="n">XFS_BTREE_TRACE_CURSOR</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">XBT_EXIT</span><span class="p">);</span>
	<span class="o">*</span><span class="n">stat</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">STATIC</span> <span class="kt">int</span>
<span class="n">xfs_btree_make_block_unfull</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">xfs_btree_cur</span>	<span class="o">*</span><span class="n">cur</span><span class="p">,</span>	<span class="cm">/* btree cursor */</span>
	<span class="kt">int</span>			<span class="n">level</span><span class="p">,</span>	<span class="cm">/* btree level */</span>
	<span class="kt">int</span>			<span class="n">numrecs</span><span class="p">,</span><span class="cm">/* # of recs in block */</span>
	<span class="kt">int</span>			<span class="o">*</span><span class="n">oindex</span><span class="p">,</span><span class="cm">/* old tree index */</span>
	<span class="kt">int</span>			<span class="o">*</span><span class="n">index</span><span class="p">,</span>	<span class="cm">/* new tree index */</span>
	<span class="k">union</span> <span class="n">xfs_btree_ptr</span>	<span class="o">*</span><span class="n">nptr</span><span class="p">,</span>	<span class="cm">/* new btree ptr */</span>
	<span class="k">struct</span> <span class="n">xfs_btree_cur</span>	<span class="o">**</span><span class="n">ncur</span><span class="p">,</span>	<span class="cm">/* new btree cursor */</span>
	<span class="k">union</span> <span class="n">xfs_btree_rec</span>	<span class="o">*</span><span class="n">nrec</span><span class="p">,</span>	<span class="cm">/* new record */</span>
	<span class="kt">int</span>			<span class="o">*</span><span class="n">stat</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">union</span> <span class="n">xfs_btree_key</span>	<span class="n">key</span><span class="p">;</span>	<span class="cm">/* new btree key value */</span>
	<span class="kt">int</span>			<span class="n">error</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">bc_flags</span> <span class="o">&amp;</span> <span class="n">XFS_BTREE_ROOT_IN_INODE</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">level</span> <span class="o">==</span> <span class="n">cur</span><span class="o">-&gt;</span><span class="n">bc_nlevels</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
	    	<span class="k">struct</span> <span class="n">xfs_inode</span> <span class="o">*</span><span class="n">ip</span> <span class="o">=</span> <span class="n">cur</span><span class="o">-&gt;</span><span class="n">bc_private</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">ip</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">numrecs</span> <span class="o">&lt;</span> <span class="n">cur</span><span class="o">-&gt;</span><span class="n">bc_ops</span><span class="o">-&gt;</span><span class="n">get_dmaxrecs</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">level</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* A root block that can be made bigger. */</span>

			<span class="n">xfs_iroot_realloc</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">cur</span><span class="o">-&gt;</span><span class="n">bc_private</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">whichfork</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* A root block that needs replacing */</span>
			<span class="kt">int</span>	<span class="n">logflags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

			<span class="n">error</span> <span class="o">=</span> <span class="n">xfs_btree_new_iroot</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">logflags</span><span class="p">,</span> <span class="n">stat</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">error</span> <span class="o">||</span> <span class="o">*</span><span class="n">stat</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">error</span><span class="p">;</span>

			<span class="n">xfs_trans_log_inode</span><span class="p">(</span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">bc_tp</span><span class="p">,</span> <span class="n">ip</span><span class="p">,</span> <span class="n">logflags</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* First, try shifting an entry to the right neighbor. */</span>
	<span class="n">error</span> <span class="o">=</span> <span class="n">xfs_btree_rshift</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">level</span><span class="p">,</span> <span class="n">stat</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span> <span class="o">||</span> <span class="o">*</span><span class="n">stat</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">error</span><span class="p">;</span>

	<span class="cm">/* Next, try shifting an entry to the left neighbor. */</span>
	<span class="n">error</span> <span class="o">=</span> <span class="n">xfs_btree_lshift</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">level</span><span class="p">,</span> <span class="n">stat</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">error</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">stat</span><span class="p">)</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">oindex</span> <span class="o">=</span> <span class="o">*</span><span class="n">index</span> <span class="o">=</span> <span class="n">cur</span><span class="o">-&gt;</span><span class="n">bc_ptrs</span><span class="p">[</span><span class="n">level</span><span class="p">];</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Next, try splitting the current block in half.</span>
<span class="cm">	 *</span>
<span class="cm">	 * If this works we have to re-set our variables because we</span>
<span class="cm">	 * could be in a different block now.</span>
<span class="cm">	 */</span>
	<span class="n">error</span> <span class="o">=</span> <span class="n">xfs_btree_split</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">level</span><span class="p">,</span> <span class="n">nptr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">key</span><span class="p">,</span> <span class="n">ncur</span><span class="p">,</span> <span class="n">stat</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span> <span class="o">||</span> <span class="o">*</span><span class="n">stat</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">error</span><span class="p">;</span>


	<span class="o">*</span><span class="n">index</span> <span class="o">=</span> <span class="n">cur</span><span class="o">-&gt;</span><span class="n">bc_ptrs</span><span class="p">[</span><span class="n">level</span><span class="p">];</span>
	<span class="n">cur</span><span class="o">-&gt;</span><span class="n">bc_ops</span><span class="o">-&gt;</span><span class="n">init_rec_from_key</span><span class="p">(</span><span class="o">&amp;</span><span class="n">key</span><span class="p">,</span> <span class="n">nrec</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Insert one record/level.  Return information to the caller</span>
<span class="cm"> * allowing the next level up to proceed if necessary.</span>
<span class="cm"> */</span>
<span class="n">STATIC</span> <span class="kt">int</span>
<span class="n">xfs_btree_insrec</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">xfs_btree_cur</span>	<span class="o">*</span><span class="n">cur</span><span class="p">,</span>	<span class="cm">/* btree cursor */</span>
	<span class="kt">int</span>			<span class="n">level</span><span class="p">,</span>	<span class="cm">/* level to insert record at */</span>
	<span class="k">union</span> <span class="n">xfs_btree_ptr</span>	<span class="o">*</span><span class="n">ptrp</span><span class="p">,</span>	<span class="cm">/* i/o: block number inserted */</span>
	<span class="k">union</span> <span class="n">xfs_btree_rec</span>	<span class="o">*</span><span class="n">recp</span><span class="p">,</span>	<span class="cm">/* i/o: record data inserted */</span>
	<span class="k">struct</span> <span class="n">xfs_btree_cur</span>	<span class="o">**</span><span class="n">curp</span><span class="p">,</span>	<span class="cm">/* output: new cursor replacing cur */</span>
	<span class="kt">int</span>			<span class="o">*</span><span class="n">stat</span><span class="p">)</span>	<span class="cm">/* success/failure */</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">xfs_btree_block</span>	<span class="o">*</span><span class="n">block</span><span class="p">;</span>	<span class="cm">/* btree block */</span>
	<span class="k">struct</span> <span class="n">xfs_buf</span>		<span class="o">*</span><span class="n">bp</span><span class="p">;</span>	<span class="cm">/* buffer for block */</span>
	<span class="k">union</span> <span class="n">xfs_btree_key</span>	<span class="n">key</span><span class="p">;</span>	<span class="cm">/* btree key */</span>
	<span class="k">union</span> <span class="n">xfs_btree_ptr</span>	<span class="n">nptr</span><span class="p">;</span>	<span class="cm">/* new block ptr */</span>
	<span class="k">struct</span> <span class="n">xfs_btree_cur</span>	<span class="o">*</span><span class="n">ncur</span><span class="p">;</span>	<span class="cm">/* new btree cursor */</span>
	<span class="k">union</span> <span class="n">xfs_btree_rec</span>	<span class="n">nrec</span><span class="p">;</span>	<span class="cm">/* new record count */</span>
	<span class="kt">int</span>			<span class="n">optr</span><span class="p">;</span>	<span class="cm">/* old key/record index */</span>
	<span class="kt">int</span>			<span class="n">ptr</span><span class="p">;</span>	<span class="cm">/* key/record index */</span>
	<span class="kt">int</span>			<span class="n">numrecs</span><span class="p">;</span><span class="cm">/* number of records */</span>
	<span class="kt">int</span>			<span class="n">error</span><span class="p">;</span>	<span class="cm">/* error return value */</span>
<span class="cp">#ifdef DEBUG</span>
	<span class="kt">int</span>			<span class="n">i</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="n">XFS_BTREE_TRACE_CURSOR</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">XBT_ENTRY</span><span class="p">);</span>
	<span class="n">XFS_BTREE_TRACE_ARGIPR</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">level</span><span class="p">,</span> <span class="o">*</span><span class="n">ptrp</span><span class="p">,</span> <span class="n">recp</span><span class="p">);</span>

	<span class="n">ncur</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * If we have an external root pointer, and we&#39;ve made it to the</span>
<span class="cm">	 * root level, allocate a new root block and we&#39;re done.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">bc_flags</span> <span class="o">&amp;</span> <span class="n">XFS_BTREE_ROOT_IN_INODE</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">level</span> <span class="o">&gt;=</span> <span class="n">cur</span><span class="o">-&gt;</span><span class="n">bc_nlevels</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">error</span> <span class="o">=</span> <span class="n">xfs_btree_new_root</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">stat</span><span class="p">);</span>
		<span class="n">xfs_btree_set_ptr_null</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">ptrp</span><span class="p">);</span>

		<span class="n">XFS_BTREE_TRACE_CURSOR</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">XBT_EXIT</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* If we&#39;re off the left edge, return failure. */</span>
	<span class="n">ptr</span> <span class="o">=</span> <span class="n">cur</span><span class="o">-&gt;</span><span class="n">bc_ptrs</span><span class="p">[</span><span class="n">level</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ptr</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">XFS_BTREE_TRACE_CURSOR</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">XBT_EXIT</span><span class="p">);</span>
		<span class="o">*</span><span class="n">stat</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Make a key out of the record data to be inserted, and save it. */</span>
	<span class="n">cur</span><span class="o">-&gt;</span><span class="n">bc_ops</span><span class="o">-&gt;</span><span class="n">init_key_from_rec</span><span class="p">(</span><span class="o">&amp;</span><span class="n">key</span><span class="p">,</span> <span class="n">recp</span><span class="p">);</span>

	<span class="n">optr</span> <span class="o">=</span> <span class="n">ptr</span><span class="p">;</span>

	<span class="n">XFS_BTREE_STATS_INC</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">insrec</span><span class="p">);</span>

	<span class="cm">/* Get pointers to the btree buffer and block. */</span>
	<span class="n">block</span> <span class="o">=</span> <span class="n">xfs_btree_get_block</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">level</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bp</span><span class="p">);</span>
	<span class="n">numrecs</span> <span class="o">=</span> <span class="n">xfs_btree_get_numrecs</span><span class="p">(</span><span class="n">block</span><span class="p">);</span>

<span class="cp">#ifdef DEBUG</span>
	<span class="n">error</span> <span class="o">=</span> <span class="n">xfs_btree_check_block</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">block</span><span class="p">,</span> <span class="n">level</span><span class="p">,</span> <span class="n">bp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error0</span><span class="p">;</span>

	<span class="cm">/* Check that the new entry is being inserted in the right place. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ptr</span> <span class="o">&lt;=</span> <span class="n">numrecs</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">level</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ASSERT</span><span class="p">(</span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">bc_ops</span><span class="o">-&gt;</span><span class="n">recs_inorder</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">recp</span><span class="p">,</span>
				<span class="n">xfs_btree_rec_addr</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">ptr</span><span class="p">,</span> <span class="n">block</span><span class="p">)));</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">ASSERT</span><span class="p">(</span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">bc_ops</span><span class="o">-&gt;</span><span class="n">keys_inorder</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">key</span><span class="p">,</span>
				<span class="n">xfs_btree_key_addr</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">ptr</span><span class="p">,</span> <span class="n">block</span><span class="p">)));</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="cp">#endif</span>

	<span class="cm">/*</span>
<span class="cm">	 * If the block is full, we can&#39;t insert the new entry until we</span>
<span class="cm">	 * make the block un-full.</span>
<span class="cm">	 */</span>
	<span class="n">xfs_btree_set_ptr_null</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">nptr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">numrecs</span> <span class="o">==</span> <span class="n">cur</span><span class="o">-&gt;</span><span class="n">bc_ops</span><span class="o">-&gt;</span><span class="n">get_maxrecs</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">level</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">error</span> <span class="o">=</span> <span class="n">xfs_btree_make_block_unfull</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">level</span><span class="p">,</span> <span class="n">numrecs</span><span class="p">,</span>
					<span class="o">&amp;</span><span class="n">optr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ptr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">nptr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ncur</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">nrec</span><span class="p">,</span> <span class="n">stat</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">error</span> <span class="o">||</span> <span class="o">*</span><span class="n">stat</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">error0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * The current block may have changed if the block was</span>
<span class="cm">	 * previously full and we have just made space in it.</span>
<span class="cm">	 */</span>
	<span class="n">block</span> <span class="o">=</span> <span class="n">xfs_btree_get_block</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">level</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bp</span><span class="p">);</span>
	<span class="n">numrecs</span> <span class="o">=</span> <span class="n">xfs_btree_get_numrecs</span><span class="p">(</span><span class="n">block</span><span class="p">);</span>

<span class="cp">#ifdef DEBUG</span>
	<span class="n">error</span> <span class="o">=</span> <span class="n">xfs_btree_check_block</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">block</span><span class="p">,</span> <span class="n">level</span><span class="p">,</span> <span class="n">bp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="cm">/*</span>
<span class="cm">	 * At this point we know there&#39;s room for our new entry in the block</span>
<span class="cm">	 * we&#39;re pointing at.</span>
<span class="cm">	 */</span>
	<span class="n">XFS_BTREE_STATS_ADD</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">moves</span><span class="p">,</span> <span class="n">numrecs</span> <span class="o">-</span> <span class="n">ptr</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">level</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* It&#39;s a nonleaf. make a hole in the keys and ptrs */</span>
		<span class="k">union</span> <span class="n">xfs_btree_key</span>	<span class="o">*</span><span class="n">kp</span><span class="p">;</span>
		<span class="k">union</span> <span class="n">xfs_btree_ptr</span>	<span class="o">*</span><span class="n">pp</span><span class="p">;</span>

		<span class="n">kp</span> <span class="o">=</span> <span class="n">xfs_btree_key_addr</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">ptr</span><span class="p">,</span> <span class="n">block</span><span class="p">);</span>
		<span class="n">pp</span> <span class="o">=</span> <span class="n">xfs_btree_ptr_addr</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">ptr</span><span class="p">,</span> <span class="n">block</span><span class="p">);</span>

<span class="cp">#ifdef DEBUG</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">numrecs</span> <span class="o">-</span> <span class="n">ptr</span><span class="p">;</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">error</span> <span class="o">=</span> <span class="n">xfs_btree_check_ptr</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">pp</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">level</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
		<span class="p">}</span>
<span class="cp">#endif</span>

		<span class="n">xfs_btree_shift_keys</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">kp</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">numrecs</span> <span class="o">-</span> <span class="n">ptr</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">xfs_btree_shift_ptrs</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">pp</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">numrecs</span> <span class="o">-</span> <span class="n">ptr</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>

<span class="cp">#ifdef DEBUG</span>
		<span class="n">error</span> <span class="o">=</span> <span class="n">xfs_btree_check_ptr</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">ptrp</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">level</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">error0</span><span class="p">;</span>
<span class="cp">#endif</span>

		<span class="cm">/* Now put the new data in, bump numrecs and log it. */</span>
		<span class="n">xfs_btree_copy_keys</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">kp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">key</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">xfs_btree_copy_ptrs</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">pp</span><span class="p">,</span> <span class="n">ptrp</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">numrecs</span><span class="o">++</span><span class="p">;</span>
		<span class="n">xfs_btree_set_numrecs</span><span class="p">(</span><span class="n">block</span><span class="p">,</span> <span class="n">numrecs</span><span class="p">);</span>
		<span class="n">xfs_btree_log_ptrs</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">bp</span><span class="p">,</span> <span class="n">ptr</span><span class="p">,</span> <span class="n">numrecs</span><span class="p">);</span>
		<span class="n">xfs_btree_log_keys</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">bp</span><span class="p">,</span> <span class="n">ptr</span><span class="p">,</span> <span class="n">numrecs</span><span class="p">);</span>
<span class="cp">#ifdef DEBUG</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ptr</span> <span class="o">&lt;</span> <span class="n">numrecs</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ASSERT</span><span class="p">(</span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">bc_ops</span><span class="o">-&gt;</span><span class="n">keys_inorder</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">kp</span><span class="p">,</span>
				<span class="n">xfs_btree_key_addr</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">ptr</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">block</span><span class="p">)));</span>
		<span class="p">}</span>
<span class="cp">#endif</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* It&#39;s a leaf. make a hole in the records */</span>
		<span class="k">union</span> <span class="n">xfs_btree_rec</span>             <span class="o">*</span><span class="n">rp</span><span class="p">;</span>

		<span class="n">rp</span> <span class="o">=</span> <span class="n">xfs_btree_rec_addr</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">ptr</span><span class="p">,</span> <span class="n">block</span><span class="p">);</span>

		<span class="n">xfs_btree_shift_recs</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">rp</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">numrecs</span> <span class="o">-</span> <span class="n">ptr</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>

		<span class="cm">/* Now put the new data in, bump numrecs and log it. */</span>
		<span class="n">xfs_btree_copy_recs</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">rp</span><span class="p">,</span> <span class="n">recp</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">xfs_btree_set_numrecs</span><span class="p">(</span><span class="n">block</span><span class="p">,</span> <span class="o">++</span><span class="n">numrecs</span><span class="p">);</span>
		<span class="n">xfs_btree_log_recs</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">bp</span><span class="p">,</span> <span class="n">ptr</span><span class="p">,</span> <span class="n">numrecs</span><span class="p">);</span>
<span class="cp">#ifdef DEBUG</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ptr</span> <span class="o">&lt;</span> <span class="n">numrecs</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ASSERT</span><span class="p">(</span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">bc_ops</span><span class="o">-&gt;</span><span class="n">recs_inorder</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">rp</span><span class="p">,</span>
				<span class="n">xfs_btree_rec_addr</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">ptr</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">block</span><span class="p">)));</span>
		<span class="p">}</span>
<span class="cp">#endif</span>
	<span class="p">}</span>

	<span class="cm">/* Log the new number of records in the btree header. */</span>
	<span class="n">xfs_btree_log_block</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">bp</span><span class="p">,</span> <span class="n">XFS_BB_NUMRECS</span><span class="p">);</span>

	<span class="cm">/* If we inserted at the start of a block, update the parents&#39; keys. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">optr</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">error</span> <span class="o">=</span> <span class="n">xfs_btree_updkey</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">key</span><span class="p">,</span> <span class="n">level</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">error0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * If we are tracking the last record in the tree and</span>
<span class="cm">	 * we are at the far right edge of the tree, update it.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">xfs_btree_is_lastrec</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">block</span><span class="p">,</span> <span class="n">level</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">cur</span><span class="o">-&gt;</span><span class="n">bc_ops</span><span class="o">-&gt;</span><span class="n">update_lastrec</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">block</span><span class="p">,</span> <span class="n">recp</span><span class="p">,</span>
					    <span class="n">ptr</span><span class="p">,</span> <span class="n">LASTREC_INSREC</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Return the new block number, if any.</span>
<span class="cm">	 * If there is one, give back a record value and a cursor too.</span>
<span class="cm">	 */</span>
	<span class="o">*</span><span class="n">ptrp</span> <span class="o">=</span> <span class="n">nptr</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">xfs_btree_ptr_is_null</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">nptr</span><span class="p">))</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">recp</span> <span class="o">=</span> <span class="n">nrec</span><span class="p">;</span>
		<span class="o">*</span><span class="n">curp</span> <span class="o">=</span> <span class="n">ncur</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">XFS_BTREE_TRACE_CURSOR</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">XBT_EXIT</span><span class="p">);</span>
	<span class="o">*</span><span class="n">stat</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">error0:</span>
	<span class="n">XFS_BTREE_TRACE_CURSOR</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">XBT_ERROR</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Insert the record at the point referenced by cur.</span>
<span class="cm"> *</span>
<span class="cm"> * A multi-level split of the tree on insert will invalidate the original</span>
<span class="cm"> * cursor.  All callers of this function should assume that the cursor is</span>
<span class="cm"> * no longer valid and revalidate it.</span>
<span class="cm"> */</span>
<span class="kt">int</span>
<span class="n">xfs_btree_insert</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">xfs_btree_cur</span>	<span class="o">*</span><span class="n">cur</span><span class="p">,</span>
	<span class="kt">int</span>			<span class="o">*</span><span class="n">stat</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span>			<span class="n">error</span><span class="p">;</span>	<span class="cm">/* error return value */</span>
	<span class="kt">int</span>			<span class="n">i</span><span class="p">;</span>	<span class="cm">/* result value, 0 for failure */</span>
	<span class="kt">int</span>			<span class="n">level</span><span class="p">;</span>	<span class="cm">/* current level number in btree */</span>
	<span class="k">union</span> <span class="n">xfs_btree_ptr</span>	<span class="n">nptr</span><span class="p">;</span>	<span class="cm">/* new block number (split result) */</span>
	<span class="k">struct</span> <span class="n">xfs_btree_cur</span>	<span class="o">*</span><span class="n">ncur</span><span class="p">;</span>	<span class="cm">/* new cursor (split result) */</span>
	<span class="k">struct</span> <span class="n">xfs_btree_cur</span>	<span class="o">*</span><span class="n">pcur</span><span class="p">;</span>	<span class="cm">/* previous level&#39;s cursor */</span>
	<span class="k">union</span> <span class="n">xfs_btree_rec</span>	<span class="n">rec</span><span class="p">;</span>	<span class="cm">/* record to insert */</span>

	<span class="n">level</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ncur</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">pcur</span> <span class="o">=</span> <span class="n">cur</span><span class="p">;</span>

	<span class="n">xfs_btree_set_ptr_null</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">nptr</span><span class="p">);</span>
	<span class="n">cur</span><span class="o">-&gt;</span><span class="n">bc_ops</span><span class="o">-&gt;</span><span class="n">init_rec_from_cur</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rec</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Loop going up the tree, starting at the leaf level.</span>
<span class="cm">	 * Stop when we don&#39;t get a split block, that must mean that</span>
<span class="cm">	 * the insert is finished with this level.</span>
<span class="cm">	 */</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Insert nrec/nptr into this level of the tree.</span>
<span class="cm">		 * Note if we fail, nptr will be null.</span>
<span class="cm">		 */</span>
		<span class="n">error</span> <span class="o">=</span> <span class="n">xfs_btree_insrec</span><span class="p">(</span><span class="n">pcur</span><span class="p">,</span> <span class="n">level</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">nptr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rec</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ncur</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">i</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">pcur</span> <span class="o">!=</span> <span class="n">cur</span><span class="p">)</span>
				<span class="n">xfs_btree_del_cursor</span><span class="p">(</span><span class="n">pcur</span><span class="p">,</span> <span class="n">XFS_BTREE_ERROR</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">error0</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">XFS_WANT_CORRUPTED_GOTO</span><span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="n">error0</span><span class="p">);</span>
		<span class="n">level</span><span class="o">++</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * See if the cursor we just used is trash.</span>
<span class="cm">		 * Can&#39;t trash the caller&#39;s cursor, but otherwise we should</span>
<span class="cm">		 * if ncur is a new cursor or we&#39;re about to be done.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pcur</span> <span class="o">!=</span> <span class="n">cur</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">ncur</span> <span class="o">||</span> <span class="n">xfs_btree_ptr_is_null</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">nptr</span><span class="p">)))</span> <span class="p">{</span>
			<span class="cm">/* Save the state from the cursor before we trash it */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">bc_ops</span><span class="o">-&gt;</span><span class="n">update_cursor</span><span class="p">)</span>
				<span class="n">cur</span><span class="o">-&gt;</span><span class="n">bc_ops</span><span class="o">-&gt;</span><span class="n">update_cursor</span><span class="p">(</span><span class="n">pcur</span><span class="p">,</span> <span class="n">cur</span><span class="p">);</span>
			<span class="n">cur</span><span class="o">-&gt;</span><span class="n">bc_nlevels</span> <span class="o">=</span> <span class="n">pcur</span><span class="o">-&gt;</span><span class="n">bc_nlevels</span><span class="p">;</span>
			<span class="n">xfs_btree_del_cursor</span><span class="p">(</span><span class="n">pcur</span><span class="p">,</span> <span class="n">XFS_BTREE_NOERROR</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="cm">/* If we got a new cursor, switch to it. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ncur</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pcur</span> <span class="o">=</span> <span class="n">ncur</span><span class="p">;</span>
			<span class="n">ncur</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">xfs_btree_ptr_is_null</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">nptr</span><span class="p">));</span>

	<span class="n">XFS_BTREE_TRACE_CURSOR</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">XBT_EXIT</span><span class="p">);</span>
	<span class="o">*</span><span class="n">stat</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">error0:</span>
	<span class="n">XFS_BTREE_TRACE_CURSOR</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">XBT_ERROR</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Try to merge a non-leaf block back into the inode root.</span>
<span class="cm"> *</span>
<span class="cm"> * Note: the killroot names comes from the fact that we&#39;re effectively</span>
<span class="cm"> * killing the old root block.  But because we can&#39;t just delete the</span>
<span class="cm"> * inode we have to copy the single block it was pointing to into the</span>
<span class="cm"> * inode.</span>
<span class="cm"> */</span>
<span class="n">STATIC</span> <span class="kt">int</span>
<span class="n">xfs_btree_kill_iroot</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">xfs_btree_cur</span>	<span class="o">*</span><span class="n">cur</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span>			<span class="n">whichfork</span> <span class="o">=</span> <span class="n">cur</span><span class="o">-&gt;</span><span class="n">bc_private</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">whichfork</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">xfs_inode</span>	<span class="o">*</span><span class="n">ip</span> <span class="o">=</span> <span class="n">cur</span><span class="o">-&gt;</span><span class="n">bc_private</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">ip</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">xfs_ifork</span>	<span class="o">*</span><span class="n">ifp</span> <span class="o">=</span> <span class="n">XFS_IFORK_PTR</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">whichfork</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">xfs_btree_block</span>	<span class="o">*</span><span class="n">block</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">xfs_btree_block</span>	<span class="o">*</span><span class="n">cblock</span><span class="p">;</span>
	<span class="k">union</span> <span class="n">xfs_btree_key</span>	<span class="o">*</span><span class="n">kp</span><span class="p">;</span>
	<span class="k">union</span> <span class="n">xfs_btree_key</span>	<span class="o">*</span><span class="n">ckp</span><span class="p">;</span>
	<span class="k">union</span> <span class="n">xfs_btree_ptr</span>	<span class="o">*</span><span class="n">pp</span><span class="p">;</span>
	<span class="k">union</span> <span class="n">xfs_btree_ptr</span>	<span class="o">*</span><span class="n">cpp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">xfs_buf</span>		<span class="o">*</span><span class="n">cbp</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">level</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">index</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">numrecs</span><span class="p">;</span>
<span class="cp">#ifdef DEBUG</span>
	<span class="k">union</span> <span class="n">xfs_btree_ptr</span>	<span class="n">ptr</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">i</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="n">XFS_BTREE_TRACE_CURSOR</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">XBT_ENTRY</span><span class="p">);</span>

	<span class="n">ASSERT</span><span class="p">(</span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">bc_flags</span> <span class="o">&amp;</span> <span class="n">XFS_BTREE_ROOT_IN_INODE</span><span class="p">);</span>
	<span class="n">ASSERT</span><span class="p">(</span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">bc_nlevels</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Don&#39;t deal with the root block needs to be a leaf case.</span>
<span class="cm">	 * We&#39;re just going to turn the thing back into extents anyway.</span>
<span class="cm">	 */</span>
	<span class="n">level</span> <span class="o">=</span> <span class="n">cur</span><span class="o">-&gt;</span><span class="n">bc_nlevels</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">level</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out0</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Give up if the root has multiple children.</span>
<span class="cm">	 */</span>
	<span class="n">block</span> <span class="o">=</span> <span class="n">xfs_btree_get_iroot</span><span class="p">(</span><span class="n">cur</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">xfs_btree_get_numrecs</span><span class="p">(</span><span class="n">block</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out0</span><span class="p">;</span>

	<span class="n">cblock</span> <span class="o">=</span> <span class="n">xfs_btree_get_block</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">level</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cbp</span><span class="p">);</span>
	<span class="n">numrecs</span> <span class="o">=</span> <span class="n">xfs_btree_get_numrecs</span><span class="p">(</span><span class="n">cblock</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Only do this if the next level will fit.</span>
<span class="cm">	 * Then the data must be copied up to the inode,</span>
<span class="cm">	 * instead of freeing the root you free the next level.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">numrecs</span> <span class="o">&gt;</span> <span class="n">cur</span><span class="o">-&gt;</span><span class="n">bc_ops</span><span class="o">-&gt;</span><span class="n">get_dmaxrecs</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">level</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out0</span><span class="p">;</span>

	<span class="n">XFS_BTREE_STATS_INC</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">killroot</span><span class="p">);</span>

<span class="cp">#ifdef DEBUG</span>
	<span class="n">xfs_btree_get_sibling</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">block</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ptr</span><span class="p">,</span> <span class="n">XFS_BB_LEFTSIB</span><span class="p">);</span>
	<span class="n">ASSERT</span><span class="p">(</span><span class="n">xfs_btree_ptr_is_null</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ptr</span><span class="p">));</span>
	<span class="n">xfs_btree_get_sibling</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">block</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ptr</span><span class="p">,</span> <span class="n">XFS_BB_RIGHTSIB</span><span class="p">);</span>
	<span class="n">ASSERT</span><span class="p">(</span><span class="n">xfs_btree_ptr_is_null</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ptr</span><span class="p">));</span>
<span class="cp">#endif</span>

	<span class="n">index</span> <span class="o">=</span> <span class="n">numrecs</span> <span class="o">-</span> <span class="n">cur</span><span class="o">-&gt;</span><span class="n">bc_ops</span><span class="o">-&gt;</span><span class="n">get_maxrecs</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">level</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">index</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">xfs_iroot_realloc</span><span class="p">(</span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">bc_private</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">ip</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span>
				  <span class="n">cur</span><span class="o">-&gt;</span><span class="n">bc_private</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">whichfork</span><span class="p">);</span>
		<span class="n">block</span> <span class="o">=</span> <span class="n">ifp</span><span class="o">-&gt;</span><span class="n">if_broot</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">be16_add_cpu</span><span class="p">(</span><span class="o">&amp;</span><span class="n">block</span><span class="o">-&gt;</span><span class="n">bb_numrecs</span><span class="p">,</span> <span class="n">index</span><span class="p">);</span>
	<span class="n">ASSERT</span><span class="p">(</span><span class="n">block</span><span class="o">-&gt;</span><span class="n">bb_numrecs</span> <span class="o">==</span> <span class="n">cblock</span><span class="o">-&gt;</span><span class="n">bb_numrecs</span><span class="p">);</span>

	<span class="n">kp</span> <span class="o">=</span> <span class="n">xfs_btree_key_addr</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">block</span><span class="p">);</span>
	<span class="n">ckp</span> <span class="o">=</span> <span class="n">xfs_btree_key_addr</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">cblock</span><span class="p">);</span>
	<span class="n">xfs_btree_copy_keys</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">kp</span><span class="p">,</span> <span class="n">ckp</span><span class="p">,</span> <span class="n">numrecs</span><span class="p">);</span>

	<span class="n">pp</span> <span class="o">=</span> <span class="n">xfs_btree_ptr_addr</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">block</span><span class="p">);</span>
	<span class="n">cpp</span> <span class="o">=</span> <span class="n">xfs_btree_ptr_addr</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">cblock</span><span class="p">);</span>
<span class="cp">#ifdef DEBUG</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">numrecs</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span>		<span class="n">error</span><span class="p">;</span>

		<span class="n">error</span> <span class="o">=</span> <span class="n">xfs_btree_check_ptr</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">cpp</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">level</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">XFS_BTREE_TRACE_CURSOR</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">XBT_ERROR</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
	<span class="n">xfs_btree_copy_ptrs</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">pp</span><span class="p">,</span> <span class="n">cpp</span><span class="p">,</span> <span class="n">numrecs</span><span class="p">);</span>

	<span class="n">cur</span><span class="o">-&gt;</span><span class="n">bc_ops</span><span class="o">-&gt;</span><span class="n">free_block</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">cbp</span><span class="p">);</span>
	<span class="n">XFS_BTREE_STATS_INC</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">free</span><span class="p">);</span>

	<span class="n">cur</span><span class="o">-&gt;</span><span class="n">bc_bufs</span><span class="p">[</span><span class="n">level</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">be16_add_cpu</span><span class="p">(</span><span class="o">&amp;</span><span class="n">block</span><span class="o">-&gt;</span><span class="n">bb_level</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">xfs_trans_log_inode</span><span class="p">(</span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">bc_tp</span><span class="p">,</span> <span class="n">ip</span><span class="p">,</span>
		<span class="n">XFS_ILOG_CORE</span> <span class="o">|</span> <span class="n">xfs_ilog_fbroot</span><span class="p">(</span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">bc_private</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">whichfork</span><span class="p">));</span>
	<span class="n">cur</span><span class="o">-&gt;</span><span class="n">bc_nlevels</span><span class="o">--</span><span class="p">;</span>
<span class="nl">out0:</span>
	<span class="n">XFS_BTREE_TRACE_CURSOR</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">XBT_EXIT</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Kill the current root node, and replace it with it&#39;s only child node.</span>
<span class="cm"> */</span>
<span class="n">STATIC</span> <span class="kt">int</span>
<span class="n">xfs_btree_kill_root</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">xfs_btree_cur</span>	<span class="o">*</span><span class="n">cur</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">xfs_buf</span>		<span class="o">*</span><span class="n">bp</span><span class="p">,</span>
	<span class="kt">int</span>			<span class="n">level</span><span class="p">,</span>
	<span class="k">union</span> <span class="n">xfs_btree_ptr</span>	<span class="o">*</span><span class="n">newroot</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span>			<span class="n">error</span><span class="p">;</span>

	<span class="n">XFS_BTREE_TRACE_CURSOR</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">XBT_ENTRY</span><span class="p">);</span>
	<span class="n">XFS_BTREE_STATS_INC</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">killroot</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Update the root pointer, decreasing the level by 1 and then</span>
<span class="cm">	 * free the old root.</span>
<span class="cm">	 */</span>
	<span class="n">cur</span><span class="o">-&gt;</span><span class="n">bc_ops</span><span class="o">-&gt;</span><span class="n">set_root</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">newroot</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>

	<span class="n">error</span> <span class="o">=</span> <span class="n">cur</span><span class="o">-&gt;</span><span class="n">bc_ops</span><span class="o">-&gt;</span><span class="n">free_block</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">bp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">XFS_BTREE_TRACE_CURSOR</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">XBT_ERROR</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">XFS_BTREE_STATS_INC</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">free</span><span class="p">);</span>

	<span class="n">cur</span><span class="o">-&gt;</span><span class="n">bc_bufs</span><span class="p">[</span><span class="n">level</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">cur</span><span class="o">-&gt;</span><span class="n">bc_ra</span><span class="p">[</span><span class="n">level</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">cur</span><span class="o">-&gt;</span><span class="n">bc_nlevels</span><span class="o">--</span><span class="p">;</span>

	<span class="n">XFS_BTREE_TRACE_CURSOR</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">XBT_EXIT</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">STATIC</span> <span class="kt">int</span>
<span class="n">xfs_btree_dec_cursor</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">xfs_btree_cur</span>	<span class="o">*</span><span class="n">cur</span><span class="p">,</span>
	<span class="kt">int</span>			<span class="n">level</span><span class="p">,</span>
	<span class="kt">int</span>			<span class="o">*</span><span class="n">stat</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span>			<span class="n">error</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">level</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">error</span> <span class="o">=</span> <span class="n">xfs_btree_decrement</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">level</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">i</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">XFS_BTREE_TRACE_CURSOR</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">XBT_EXIT</span><span class="p">);</span>
	<span class="o">*</span><span class="n">stat</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Single level of the btree record deletion routine.</span>
<span class="cm"> * Delete record pointed to by cur/level.</span>
<span class="cm"> * Remove the record from its block then rebalance the tree.</span>
<span class="cm"> * Return 0 for error, 1 for done, 2 to go on to the next level.</span>
<span class="cm"> */</span>
<span class="n">STATIC</span> <span class="kt">int</span>					<span class="cm">/* error */</span>
<span class="n">xfs_btree_delrec</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">xfs_btree_cur</span>	<span class="o">*</span><span class="n">cur</span><span class="p">,</span>		<span class="cm">/* btree cursor */</span>
	<span class="kt">int</span>			<span class="n">level</span><span class="p">,</span>		<span class="cm">/* level removing record from */</span>
	<span class="kt">int</span>			<span class="o">*</span><span class="n">stat</span><span class="p">)</span>		<span class="cm">/* fail/done/go-on */</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">xfs_btree_block</span>	<span class="o">*</span><span class="n">block</span><span class="p">;</span>		<span class="cm">/* btree block */</span>
	<span class="k">union</span> <span class="n">xfs_btree_ptr</span>	<span class="n">cptr</span><span class="p">;</span>		<span class="cm">/* current block ptr */</span>
	<span class="k">struct</span> <span class="n">xfs_buf</span>		<span class="o">*</span><span class="n">bp</span><span class="p">;</span>		<span class="cm">/* buffer for block */</span>
	<span class="kt">int</span>			<span class="n">error</span><span class="p">;</span>		<span class="cm">/* error return value */</span>
	<span class="kt">int</span>			<span class="n">i</span><span class="p">;</span>		<span class="cm">/* loop counter */</span>
	<span class="k">union</span> <span class="n">xfs_btree_key</span>	<span class="n">key</span><span class="p">;</span>		<span class="cm">/* storage for keyp */</span>
	<span class="k">union</span> <span class="n">xfs_btree_key</span>	<span class="o">*</span><span class="n">keyp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">key</span><span class="p">;</span>	<span class="cm">/* passed to the next level */</span>
	<span class="k">union</span> <span class="n">xfs_btree_ptr</span>	<span class="n">lptr</span><span class="p">;</span>		<span class="cm">/* left sibling block ptr */</span>
	<span class="k">struct</span> <span class="n">xfs_buf</span>		<span class="o">*</span><span class="n">lbp</span><span class="p">;</span>		<span class="cm">/* left buffer pointer */</span>
	<span class="k">struct</span> <span class="n">xfs_btree_block</span>	<span class="o">*</span><span class="n">left</span><span class="p">;</span>		<span class="cm">/* left btree block */</span>
	<span class="kt">int</span>			<span class="n">lrecs</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* left record count */</span>
	<span class="kt">int</span>			<span class="n">ptr</span><span class="p">;</span>		<span class="cm">/* key/record index */</span>
	<span class="k">union</span> <span class="n">xfs_btree_ptr</span>	<span class="n">rptr</span><span class="p">;</span>		<span class="cm">/* right sibling block ptr */</span>
	<span class="k">struct</span> <span class="n">xfs_buf</span>		<span class="o">*</span><span class="n">rbp</span><span class="p">;</span>		<span class="cm">/* right buffer pointer */</span>
	<span class="k">struct</span> <span class="n">xfs_btree_block</span>	<span class="o">*</span><span class="n">right</span><span class="p">;</span>		<span class="cm">/* right btree block */</span>
	<span class="k">struct</span> <span class="n">xfs_btree_block</span>	<span class="o">*</span><span class="n">rrblock</span><span class="p">;</span>	<span class="cm">/* right-right btree block */</span>
	<span class="k">struct</span> <span class="n">xfs_buf</span>		<span class="o">*</span><span class="n">rrbp</span><span class="p">;</span>		<span class="cm">/* right-right buffer pointer */</span>
	<span class="kt">int</span>			<span class="n">rrecs</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* right record count */</span>
	<span class="k">struct</span> <span class="n">xfs_btree_cur</span>	<span class="o">*</span><span class="n">tcur</span><span class="p">;</span>		<span class="cm">/* temporary btree cursor */</span>
	<span class="kt">int</span>			<span class="n">numrecs</span><span class="p">;</span>	<span class="cm">/* temporary numrec count */</span>

	<span class="n">XFS_BTREE_TRACE_CURSOR</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">XBT_ENTRY</span><span class="p">);</span>
	<span class="n">XFS_BTREE_TRACE_ARGI</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">level</span><span class="p">);</span>

	<span class="n">tcur</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="cm">/* Get the index of the entry being deleted, check for nothing there. */</span>
	<span class="n">ptr</span> <span class="o">=</span> <span class="n">cur</span><span class="o">-&gt;</span><span class="n">bc_ptrs</span><span class="p">[</span><span class="n">level</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ptr</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">XFS_BTREE_TRACE_CURSOR</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">XBT_EXIT</span><span class="p">);</span>
		<span class="o">*</span><span class="n">stat</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Get the buffer &amp; block containing the record or key/ptr. */</span>
	<span class="n">block</span> <span class="o">=</span> <span class="n">xfs_btree_get_block</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">level</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bp</span><span class="p">);</span>
	<span class="n">numrecs</span> <span class="o">=</span> <span class="n">xfs_btree_get_numrecs</span><span class="p">(</span><span class="n">block</span><span class="p">);</span>

<span class="cp">#ifdef DEBUG</span>
	<span class="n">error</span> <span class="o">=</span> <span class="n">xfs_btree_check_block</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">block</span><span class="p">,</span> <span class="n">level</span><span class="p">,</span> <span class="n">bp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error0</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="cm">/* Fail if we&#39;re off the end of the block. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ptr</span> <span class="o">&gt;</span> <span class="n">numrecs</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">XFS_BTREE_TRACE_CURSOR</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">XBT_EXIT</span><span class="p">);</span>
		<span class="o">*</span><span class="n">stat</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">XFS_BTREE_STATS_INC</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">delrec</span><span class="p">);</span>
	<span class="n">XFS_BTREE_STATS_ADD</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">moves</span><span class="p">,</span> <span class="n">numrecs</span> <span class="o">-</span> <span class="n">ptr</span><span class="p">);</span>

	<span class="cm">/* Excise the entries being deleted. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">level</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* It&#39;s a nonleaf. operate on keys and ptrs */</span>
		<span class="k">union</span> <span class="n">xfs_btree_key</span>	<span class="o">*</span><span class="n">lkp</span><span class="p">;</span>
		<span class="k">union</span> <span class="n">xfs_btree_ptr</span>	<span class="o">*</span><span class="n">lpp</span><span class="p">;</span>

		<span class="n">lkp</span> <span class="o">=</span> <span class="n">xfs_btree_key_addr</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">ptr</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">block</span><span class="p">);</span>
		<span class="n">lpp</span> <span class="o">=</span> <span class="n">xfs_btree_ptr_addr</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">ptr</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">block</span><span class="p">);</span>

<span class="cp">#ifdef DEBUG</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">numrecs</span> <span class="o">-</span> <span class="n">ptr</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">error</span> <span class="o">=</span> <span class="n">xfs_btree_check_ptr</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">lpp</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">level</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">error0</span><span class="p">;</span>
		<span class="p">}</span>
<span class="cp">#endif</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ptr</span> <span class="o">&lt;</span> <span class="n">numrecs</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">xfs_btree_shift_keys</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">lkp</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">numrecs</span> <span class="o">-</span> <span class="n">ptr</span><span class="p">);</span>
			<span class="n">xfs_btree_shift_ptrs</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">lpp</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">numrecs</span> <span class="o">-</span> <span class="n">ptr</span><span class="p">);</span>
			<span class="n">xfs_btree_log_keys</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">bp</span><span class="p">,</span> <span class="n">ptr</span><span class="p">,</span> <span class="n">numrecs</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
			<span class="n">xfs_btree_log_ptrs</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">bp</span><span class="p">,</span> <span class="n">ptr</span><span class="p">,</span> <span class="n">numrecs</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="cm">/*</span>
<span class="cm">		 * If it&#39;s the first record in the block, we&#39;ll need to pass a</span>
<span class="cm">		 * key up to the next level (updkey).</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ptr</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
			<span class="n">keyp</span> <span class="o">=</span> <span class="n">xfs_btree_key_addr</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">block</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* It&#39;s a leaf. operate on records */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ptr</span> <span class="o">&lt;</span> <span class="n">numrecs</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">xfs_btree_shift_recs</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span>
				<span class="n">xfs_btree_rec_addr</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">ptr</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">block</span><span class="p">),</span>
				<span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">numrecs</span> <span class="o">-</span> <span class="n">ptr</span><span class="p">);</span>
			<span class="n">xfs_btree_log_recs</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">bp</span><span class="p">,</span> <span class="n">ptr</span><span class="p">,</span> <span class="n">numrecs</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="cm">/*</span>
<span class="cm">		 * If it&#39;s the first record in the block, we&#39;ll need a key</span>
<span class="cm">		 * structure to pass up to the next level (updkey).</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ptr</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">cur</span><span class="o">-&gt;</span><span class="n">bc_ops</span><span class="o">-&gt;</span><span class="n">init_key_from_rec</span><span class="p">(</span><span class="o">&amp;</span><span class="n">key</span><span class="p">,</span>
					<span class="n">xfs_btree_rec_addr</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">block</span><span class="p">));</span>
			<span class="n">keyp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">key</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Decrement and log the number of entries in the block.</span>
<span class="cm">	 */</span>
	<span class="n">xfs_btree_set_numrecs</span><span class="p">(</span><span class="n">block</span><span class="p">,</span> <span class="o">--</span><span class="n">numrecs</span><span class="p">);</span>
	<span class="n">xfs_btree_log_block</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">bp</span><span class="p">,</span> <span class="n">XFS_BB_NUMRECS</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * If we are tracking the last record in the tree and</span>
<span class="cm">	 * we are at the far right edge of the tree, update it.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">xfs_btree_is_lastrec</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">block</span><span class="p">,</span> <span class="n">level</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">cur</span><span class="o">-&gt;</span><span class="n">bc_ops</span><span class="o">-&gt;</span><span class="n">update_lastrec</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">block</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span>
					    <span class="n">ptr</span><span class="p">,</span> <span class="n">LASTREC_DELREC</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * We&#39;re at the root level.  First, shrink the root block in-memory.</span>
<span class="cm">	 * Try to get rid of the next level down.  If we can&#39;t then there&#39;s</span>
<span class="cm">	 * nothing left to do.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">level</span> <span class="o">==</span> <span class="n">cur</span><span class="o">-&gt;</span><span class="n">bc_nlevels</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">bc_flags</span> <span class="o">&amp;</span> <span class="n">XFS_BTREE_ROOT_IN_INODE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">xfs_iroot_realloc</span><span class="p">(</span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">bc_private</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">ip</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
					  <span class="n">cur</span><span class="o">-&gt;</span><span class="n">bc_private</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">whichfork</span><span class="p">);</span>

			<span class="n">error</span> <span class="o">=</span> <span class="n">xfs_btree_kill_iroot</span><span class="p">(</span><span class="n">cur</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">error0</span><span class="p">;</span>

			<span class="n">error</span> <span class="o">=</span> <span class="n">xfs_btree_dec_cursor</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">level</span><span class="p">,</span> <span class="n">stat</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">error0</span><span class="p">;</span>
			<span class="o">*</span><span class="n">stat</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/*</span>
<span class="cm">		 * If this is the root level, and there&#39;s only one entry left,</span>
<span class="cm">		 * and it&#39;s NOT the leaf level, then we can get rid of this</span>
<span class="cm">		 * level.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">numrecs</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">level</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">union</span> <span class="n">xfs_btree_ptr</span>	<span class="o">*</span><span class="n">pp</span><span class="p">;</span>
			<span class="cm">/*</span>
<span class="cm">			 * pp is still set to the first pointer in the block.</span>
<span class="cm">			 * Make it the new root of the btree.</span>
<span class="cm">			 */</span>
			<span class="n">pp</span> <span class="o">=</span> <span class="n">xfs_btree_ptr_addr</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">block</span><span class="p">);</span>
			<span class="n">error</span> <span class="o">=</span> <span class="n">xfs_btree_kill_root</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">bp</span><span class="p">,</span> <span class="n">level</span><span class="p">,</span> <span class="n">pp</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">error0</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">level</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">error</span> <span class="o">=</span> <span class="n">xfs_btree_dec_cursor</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">level</span><span class="p">,</span> <span class="n">stat</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">error0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="o">*</span><span class="n">stat</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * If we deleted the leftmost entry in the block, update the</span>
<span class="cm">	 * key values above us in the tree.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ptr</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">error</span> <span class="o">=</span> <span class="n">xfs_btree_updkey</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">keyp</span><span class="p">,</span> <span class="n">level</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">error0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * If the number of records remaining in the block is at least</span>
<span class="cm">	 * the minimum, we&#39;re done.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">numrecs</span> <span class="o">&gt;=</span> <span class="n">cur</span><span class="o">-&gt;</span><span class="n">bc_ops</span><span class="o">-&gt;</span><span class="n">get_minrecs</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">level</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">error</span> <span class="o">=</span> <span class="n">xfs_btree_dec_cursor</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">level</span><span class="p">,</span> <span class="n">stat</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">error0</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Otherwise, we have to move some records around to keep the</span>
<span class="cm">	 * tree balanced.  Look at the left and right sibling blocks to</span>
<span class="cm">	 * see if we can re-balance by moving only one record.</span>
<span class="cm">	 */</span>
	<span class="n">xfs_btree_get_sibling</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">block</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rptr</span><span class="p">,</span> <span class="n">XFS_BB_RIGHTSIB</span><span class="p">);</span>
	<span class="n">xfs_btree_get_sibling</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">block</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">lptr</span><span class="p">,</span> <span class="n">XFS_BB_LEFTSIB</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">bc_flags</span> <span class="o">&amp;</span> <span class="n">XFS_BTREE_ROOT_IN_INODE</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * One child of root, need to get a chance to copy its contents</span>
<span class="cm">		 * into the root and delete it. Can&#39;t go up to next level,</span>
<span class="cm">		 * there&#39;s nothing to delete there.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">xfs_btree_ptr_is_null</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rptr</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="n">xfs_btree_ptr_is_null</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">lptr</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="n">level</span> <span class="o">==</span> <span class="n">cur</span><span class="o">-&gt;</span><span class="n">bc_nlevels</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">error</span> <span class="o">=</span> <span class="n">xfs_btree_kill_iroot</span><span class="p">(</span><span class="n">cur</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">error</span><span class="p">)</span>
				<span class="n">error</span> <span class="o">=</span> <span class="n">xfs_btree_dec_cursor</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">level</span><span class="p">,</span> <span class="n">stat</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">error0</span><span class="p">;</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">ASSERT</span><span class="p">(</span><span class="o">!</span><span class="n">xfs_btree_ptr_is_null</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rptr</span><span class="p">)</span> <span class="o">||</span>
	       <span class="o">!</span><span class="n">xfs_btree_ptr_is_null</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">lptr</span><span class="p">));</span>

	<span class="cm">/*</span>
<span class="cm">	 * Duplicate the cursor so our btree manipulations here won&#39;t</span>
<span class="cm">	 * disrupt the next level up.</span>
<span class="cm">	 */</span>
	<span class="n">error</span> <span class="o">=</span> <span class="n">xfs_btree_dup_cursor</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tcur</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error0</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * If there&#39;s a right sibling, see if it&#39;s ok to shift an entry</span>
<span class="cm">	 * out of it.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">xfs_btree_ptr_is_null</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rptr</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Move the temp cursor to the last entry in the next block.</span>
<span class="cm">		 * Actually any entry but the first would suffice.</span>
<span class="cm">		 */</span>
		<span class="n">i</span> <span class="o">=</span> <span class="n">xfs_btree_lastrec</span><span class="p">(</span><span class="n">tcur</span><span class="p">,</span> <span class="n">level</span><span class="p">);</span>
		<span class="n">XFS_WANT_CORRUPTED_GOTO</span><span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="n">error0</span><span class="p">);</span>

		<span class="n">error</span> <span class="o">=</span> <span class="n">xfs_btree_increment</span><span class="p">(</span><span class="n">tcur</span><span class="p">,</span> <span class="n">level</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">i</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">error0</span><span class="p">;</span>
		<span class="n">XFS_WANT_CORRUPTED_GOTO</span><span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="n">error0</span><span class="p">);</span>

		<span class="n">i</span> <span class="o">=</span> <span class="n">xfs_btree_lastrec</span><span class="p">(</span><span class="n">tcur</span><span class="p">,</span> <span class="n">level</span><span class="p">);</span>
		<span class="n">XFS_WANT_CORRUPTED_GOTO</span><span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="n">error0</span><span class="p">);</span>

		<span class="cm">/* Grab a pointer to the block. */</span>
		<span class="n">right</span> <span class="o">=</span> <span class="n">xfs_btree_get_block</span><span class="p">(</span><span class="n">tcur</span><span class="p">,</span> <span class="n">level</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rbp</span><span class="p">);</span>
<span class="cp">#ifdef DEBUG</span>
		<span class="n">error</span> <span class="o">=</span> <span class="n">xfs_btree_check_block</span><span class="p">(</span><span class="n">tcur</span><span class="p">,</span> <span class="n">right</span><span class="p">,</span> <span class="n">level</span><span class="p">,</span> <span class="n">rbp</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">error0</span><span class="p">;</span>
<span class="cp">#endif</span>
		<span class="cm">/* Grab the current block number, for future use. */</span>
		<span class="n">xfs_btree_get_sibling</span><span class="p">(</span><span class="n">tcur</span><span class="p">,</span> <span class="n">right</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cptr</span><span class="p">,</span> <span class="n">XFS_BB_LEFTSIB</span><span class="p">);</span>

		<span class="cm">/*</span>
<span class="cm">		 * If right block is full enough so that removing one entry</span>
<span class="cm">		 * won&#39;t make it too empty, and left-shifting an entry out</span>
<span class="cm">		 * of right to us works, we&#39;re done.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">xfs_btree_get_numrecs</span><span class="p">(</span><span class="n">right</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">&gt;=</span>
		    <span class="n">cur</span><span class="o">-&gt;</span><span class="n">bc_ops</span><span class="o">-&gt;</span><span class="n">get_minrecs</span><span class="p">(</span><span class="n">tcur</span><span class="p">,</span> <span class="n">level</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">error</span> <span class="o">=</span> <span class="n">xfs_btree_lshift</span><span class="p">(</span><span class="n">tcur</span><span class="p">,</span> <span class="n">level</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">i</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">error0</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ASSERT</span><span class="p">(</span><span class="n">xfs_btree_get_numrecs</span><span class="p">(</span><span class="n">block</span><span class="p">)</span> <span class="o">&gt;=</span>
				       <span class="n">cur</span><span class="o">-&gt;</span><span class="n">bc_ops</span><span class="o">-&gt;</span><span class="n">get_minrecs</span><span class="p">(</span><span class="n">tcur</span><span class="p">,</span> <span class="n">level</span><span class="p">));</span>

				<span class="n">xfs_btree_del_cursor</span><span class="p">(</span><span class="n">tcur</span><span class="p">,</span> <span class="n">XFS_BTREE_NOERROR</span><span class="p">);</span>
				<span class="n">tcur</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

				<span class="n">error</span> <span class="o">=</span> <span class="n">xfs_btree_dec_cursor</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">level</span><span class="p">,</span> <span class="n">stat</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
					<span class="k">goto</span> <span class="n">error0</span><span class="p">;</span>
				<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="cm">/*</span>
<span class="cm">		 * Otherwise, grab the number of records in right for</span>
<span class="cm">		 * future reference, and fix up the temp cursor to point</span>
<span class="cm">		 * to our block again (last record).</span>
<span class="cm">		 */</span>
		<span class="n">rrecs</span> <span class="o">=</span> <span class="n">xfs_btree_get_numrecs</span><span class="p">(</span><span class="n">right</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">xfs_btree_ptr_is_null</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">lptr</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">i</span> <span class="o">=</span> <span class="n">xfs_btree_firstrec</span><span class="p">(</span><span class="n">tcur</span><span class="p">,</span> <span class="n">level</span><span class="p">);</span>
			<span class="n">XFS_WANT_CORRUPTED_GOTO</span><span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="n">error0</span><span class="p">);</span>

			<span class="n">error</span> <span class="o">=</span> <span class="n">xfs_btree_decrement</span><span class="p">(</span><span class="n">tcur</span><span class="p">,</span> <span class="n">level</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">i</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">error0</span><span class="p">;</span>
			<span class="n">XFS_WANT_CORRUPTED_GOTO</span><span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="n">error0</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * If there&#39;s a left sibling, see if it&#39;s ok to shift an entry</span>
<span class="cm">	 * out of it.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">xfs_btree_ptr_is_null</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">lptr</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Move the temp cursor to the first entry in the</span>
<span class="cm">		 * previous block.</span>
<span class="cm">		 */</span>
		<span class="n">i</span> <span class="o">=</span> <span class="n">xfs_btree_firstrec</span><span class="p">(</span><span class="n">tcur</span><span class="p">,</span> <span class="n">level</span><span class="p">);</span>
		<span class="n">XFS_WANT_CORRUPTED_GOTO</span><span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="n">error0</span><span class="p">);</span>

		<span class="n">error</span> <span class="o">=</span> <span class="n">xfs_btree_decrement</span><span class="p">(</span><span class="n">tcur</span><span class="p">,</span> <span class="n">level</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">i</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">error0</span><span class="p">;</span>
		<span class="n">i</span> <span class="o">=</span> <span class="n">xfs_btree_firstrec</span><span class="p">(</span><span class="n">tcur</span><span class="p">,</span> <span class="n">level</span><span class="p">);</span>
		<span class="n">XFS_WANT_CORRUPTED_GOTO</span><span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="n">error0</span><span class="p">);</span>

		<span class="cm">/* Grab a pointer to the block. */</span>
		<span class="n">left</span> <span class="o">=</span> <span class="n">xfs_btree_get_block</span><span class="p">(</span><span class="n">tcur</span><span class="p">,</span> <span class="n">level</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">lbp</span><span class="p">);</span>
<span class="cp">#ifdef DEBUG</span>
		<span class="n">error</span> <span class="o">=</span> <span class="n">xfs_btree_check_block</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">left</span><span class="p">,</span> <span class="n">level</span><span class="p">,</span> <span class="n">lbp</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">error0</span><span class="p">;</span>
<span class="cp">#endif</span>
		<span class="cm">/* Grab the current block number, for future use. */</span>
		<span class="n">xfs_btree_get_sibling</span><span class="p">(</span><span class="n">tcur</span><span class="p">,</span> <span class="n">left</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cptr</span><span class="p">,</span> <span class="n">XFS_BB_RIGHTSIB</span><span class="p">);</span>

		<span class="cm">/*</span>
<span class="cm">		 * If left block is full enough so that removing one entry</span>
<span class="cm">		 * won&#39;t make it too empty, and right-shifting an entry out</span>
<span class="cm">		 * of left to us works, we&#39;re done.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">xfs_btree_get_numrecs</span><span class="p">(</span><span class="n">left</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">&gt;=</span>
		    <span class="n">cur</span><span class="o">-&gt;</span><span class="n">bc_ops</span><span class="o">-&gt;</span><span class="n">get_minrecs</span><span class="p">(</span><span class="n">tcur</span><span class="p">,</span> <span class="n">level</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">error</span> <span class="o">=</span> <span class="n">xfs_btree_rshift</span><span class="p">(</span><span class="n">tcur</span><span class="p">,</span> <span class="n">level</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">i</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">error0</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ASSERT</span><span class="p">(</span><span class="n">xfs_btree_get_numrecs</span><span class="p">(</span><span class="n">block</span><span class="p">)</span> <span class="o">&gt;=</span>
				       <span class="n">cur</span><span class="o">-&gt;</span><span class="n">bc_ops</span><span class="o">-&gt;</span><span class="n">get_minrecs</span><span class="p">(</span><span class="n">tcur</span><span class="p">,</span> <span class="n">level</span><span class="p">));</span>
				<span class="n">xfs_btree_del_cursor</span><span class="p">(</span><span class="n">tcur</span><span class="p">,</span> <span class="n">XFS_BTREE_NOERROR</span><span class="p">);</span>
				<span class="n">tcur</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">level</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
					<span class="n">cur</span><span class="o">-&gt;</span><span class="n">bc_ptrs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>
				<span class="n">XFS_BTREE_TRACE_CURSOR</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">XBT_EXIT</span><span class="p">);</span>
				<span class="o">*</span><span class="n">stat</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="cm">/*</span>
<span class="cm">		 * Otherwise, grab the number of records in right for</span>
<span class="cm">		 * future reference.</span>
<span class="cm">		 */</span>
		<span class="n">lrecs</span> <span class="o">=</span> <span class="n">xfs_btree_get_numrecs</span><span class="p">(</span><span class="n">left</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Delete the temp cursor, we&#39;re done with it. */</span>
	<span class="n">xfs_btree_del_cursor</span><span class="p">(</span><span class="n">tcur</span><span class="p">,</span> <span class="n">XFS_BTREE_NOERROR</span><span class="p">);</span>
	<span class="n">tcur</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="cm">/* If here, we need to do a join to keep the tree balanced. */</span>
	<span class="n">ASSERT</span><span class="p">(</span><span class="o">!</span><span class="n">xfs_btree_ptr_is_null</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cptr</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">xfs_btree_ptr_is_null</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">lptr</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">lrecs</span> <span class="o">+</span> <span class="n">xfs_btree_get_numrecs</span><span class="p">(</span><span class="n">block</span><span class="p">)</span> <span class="o">&lt;=</span>
			<span class="n">cur</span><span class="o">-&gt;</span><span class="n">bc_ops</span><span class="o">-&gt;</span><span class="n">get_maxrecs</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">level</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Set &quot;right&quot; to be the starting block,</span>
<span class="cm">		 * &quot;left&quot; to be the left neighbor.</span>
<span class="cm">		 */</span>
		<span class="n">rptr</span> <span class="o">=</span> <span class="n">cptr</span><span class="p">;</span>
		<span class="n">right</span> <span class="o">=</span> <span class="n">block</span><span class="p">;</span>
		<span class="n">rbp</span> <span class="o">=</span> <span class="n">bp</span><span class="p">;</span>
		<span class="n">error</span> <span class="o">=</span> <span class="n">xfs_btree_read_buf_block</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">lptr</span><span class="p">,</span> <span class="n">level</span><span class="p">,</span>
							<span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">left</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">lbp</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">error0</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * If that won&#39;t work, see if we can join with the right neighbor block.</span>
<span class="cm">	 */</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">xfs_btree_ptr_is_null</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rptr</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		   <span class="n">rrecs</span> <span class="o">+</span> <span class="n">xfs_btree_get_numrecs</span><span class="p">(</span><span class="n">block</span><span class="p">)</span> <span class="o">&lt;=</span>
			<span class="n">cur</span><span class="o">-&gt;</span><span class="n">bc_ops</span><span class="o">-&gt;</span><span class="n">get_maxrecs</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">level</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Set &quot;left&quot; to be the starting block,</span>
<span class="cm">		 * &quot;right&quot; to be the right neighbor.</span>
<span class="cm">		 */</span>
		<span class="n">lptr</span> <span class="o">=</span> <span class="n">cptr</span><span class="p">;</span>
		<span class="n">left</span> <span class="o">=</span> <span class="n">block</span><span class="p">;</span>
		<span class="n">lbp</span> <span class="o">=</span> <span class="n">bp</span><span class="p">;</span>
		<span class="n">error</span> <span class="o">=</span> <span class="n">xfs_btree_read_buf_block</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rptr</span><span class="p">,</span> <span class="n">level</span><span class="p">,</span>
							<span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">right</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rbp</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">error0</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Otherwise, we can&#39;t fix the imbalance.</span>
<span class="cm">	 * Just return.  This is probably a logic error, but it&#39;s not fatal.</span>
<span class="cm">	 */</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">error</span> <span class="o">=</span> <span class="n">xfs_btree_dec_cursor</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">level</span><span class="p">,</span> <span class="n">stat</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">error0</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rrecs</span> <span class="o">=</span> <span class="n">xfs_btree_get_numrecs</span><span class="p">(</span><span class="n">right</span><span class="p">);</span>
	<span class="n">lrecs</span> <span class="o">=</span> <span class="n">xfs_btree_get_numrecs</span><span class="p">(</span><span class="n">left</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * We&#39;re now going to join &quot;left&quot; and &quot;right&quot; by moving all the stuff</span>
<span class="cm">	 * in &quot;right&quot; to &quot;left&quot; and deleting &quot;right&quot;.</span>
<span class="cm">	 */</span>
	<span class="n">XFS_BTREE_STATS_ADD</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">moves</span><span class="p">,</span> <span class="n">rrecs</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">level</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* It&#39;s a non-leaf.  Move keys and pointers. */</span>
		<span class="k">union</span> <span class="n">xfs_btree_key</span>	<span class="o">*</span><span class="n">lkp</span><span class="p">;</span>	<span class="cm">/* left btree key */</span>
		<span class="k">union</span> <span class="n">xfs_btree_ptr</span>	<span class="o">*</span><span class="n">lpp</span><span class="p">;</span>	<span class="cm">/* left address pointer */</span>
		<span class="k">union</span> <span class="n">xfs_btree_key</span>	<span class="o">*</span><span class="n">rkp</span><span class="p">;</span>	<span class="cm">/* right btree key */</span>
		<span class="k">union</span> <span class="n">xfs_btree_ptr</span>	<span class="o">*</span><span class="n">rpp</span><span class="p">;</span>	<span class="cm">/* right address pointer */</span>

		<span class="n">lkp</span> <span class="o">=</span> <span class="n">xfs_btree_key_addr</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">lrecs</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">left</span><span class="p">);</span>
		<span class="n">lpp</span> <span class="o">=</span> <span class="n">xfs_btree_ptr_addr</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">lrecs</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">left</span><span class="p">);</span>
		<span class="n">rkp</span> <span class="o">=</span> <span class="n">xfs_btree_key_addr</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">right</span><span class="p">);</span>
		<span class="n">rpp</span> <span class="o">=</span> <span class="n">xfs_btree_ptr_addr</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">right</span><span class="p">);</span>
<span class="cp">#ifdef DEBUG</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">rrecs</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">error</span> <span class="o">=</span> <span class="n">xfs_btree_check_ptr</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">rpp</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">level</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">error0</span><span class="p">;</span>
		<span class="p">}</span>
<span class="cp">#endif</span>
		<span class="n">xfs_btree_copy_keys</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">lkp</span><span class="p">,</span> <span class="n">rkp</span><span class="p">,</span> <span class="n">rrecs</span><span class="p">);</span>
		<span class="n">xfs_btree_copy_ptrs</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">lpp</span><span class="p">,</span> <span class="n">rpp</span><span class="p">,</span> <span class="n">rrecs</span><span class="p">);</span>

		<span class="n">xfs_btree_log_keys</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">lbp</span><span class="p">,</span> <span class="n">lrecs</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">lrecs</span> <span class="o">+</span> <span class="n">rrecs</span><span class="p">);</span>
		<span class="n">xfs_btree_log_ptrs</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">lbp</span><span class="p">,</span> <span class="n">lrecs</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">lrecs</span> <span class="o">+</span> <span class="n">rrecs</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* It&#39;s a leaf.  Move records.  */</span>
		<span class="k">union</span> <span class="n">xfs_btree_rec</span>	<span class="o">*</span><span class="n">lrp</span><span class="p">;</span>	<span class="cm">/* left record pointer */</span>
		<span class="k">union</span> <span class="n">xfs_btree_rec</span>	<span class="o">*</span><span class="n">rrp</span><span class="p">;</span>	<span class="cm">/* right record pointer */</span>

		<span class="n">lrp</span> <span class="o">=</span> <span class="n">xfs_btree_rec_addr</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">lrecs</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">left</span><span class="p">);</span>
		<span class="n">rrp</span> <span class="o">=</span> <span class="n">xfs_btree_rec_addr</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">right</span><span class="p">);</span>

		<span class="n">xfs_btree_copy_recs</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">lrp</span><span class="p">,</span> <span class="n">rrp</span><span class="p">,</span> <span class="n">rrecs</span><span class="p">);</span>
		<span class="n">xfs_btree_log_recs</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">lbp</span><span class="p">,</span> <span class="n">lrecs</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">lrecs</span> <span class="o">+</span> <span class="n">rrecs</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">XFS_BTREE_STATS_INC</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">join</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Fix up the number of records and right block pointer in the</span>
<span class="cm">	 * surviving block, and log it.</span>
<span class="cm">	 */</span>
	<span class="n">xfs_btree_set_numrecs</span><span class="p">(</span><span class="n">left</span><span class="p">,</span> <span class="n">lrecs</span> <span class="o">+</span> <span class="n">rrecs</span><span class="p">);</span>
	<span class="n">xfs_btree_get_sibling</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">right</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cptr</span><span class="p">,</span> <span class="n">XFS_BB_RIGHTSIB</span><span class="p">),</span>
	<span class="n">xfs_btree_set_sibling</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">left</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cptr</span><span class="p">,</span> <span class="n">XFS_BB_RIGHTSIB</span><span class="p">);</span>
	<span class="n">xfs_btree_log_block</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">lbp</span><span class="p">,</span> <span class="n">XFS_BB_NUMRECS</span> <span class="o">|</span> <span class="n">XFS_BB_RIGHTSIB</span><span class="p">);</span>

	<span class="cm">/* If there is a right sibling, point it to the remaining block. */</span>
	<span class="n">xfs_btree_get_sibling</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">left</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cptr</span><span class="p">,</span> <span class="n">XFS_BB_RIGHTSIB</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">xfs_btree_ptr_is_null</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cptr</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">error</span> <span class="o">=</span> <span class="n">xfs_btree_read_buf_block</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cptr</span><span class="p">,</span> <span class="n">level</span><span class="p">,</span>
							<span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rrblock</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rrbp</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">error0</span><span class="p">;</span>
		<span class="n">xfs_btree_set_sibling</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">rrblock</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">lptr</span><span class="p">,</span> <span class="n">XFS_BB_LEFTSIB</span><span class="p">);</span>
		<span class="n">xfs_btree_log_block</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">rrbp</span><span class="p">,</span> <span class="n">XFS_BB_LEFTSIB</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Free the deleted block. */</span>
	<span class="n">error</span> <span class="o">=</span> <span class="n">cur</span><span class="o">-&gt;</span><span class="n">bc_ops</span><span class="o">-&gt;</span><span class="n">free_block</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">rbp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error0</span><span class="p">;</span>
	<span class="n">XFS_BTREE_STATS_INC</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">free</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * If we joined with the left neighbor, set the buffer in the</span>
<span class="cm">	 * cursor to the left block, and fix up the index.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bp</span> <span class="o">!=</span> <span class="n">lbp</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cur</span><span class="o">-&gt;</span><span class="n">bc_bufs</span><span class="p">[</span><span class="n">level</span><span class="p">]</span> <span class="o">=</span> <span class="n">lbp</span><span class="p">;</span>
		<span class="n">cur</span><span class="o">-&gt;</span><span class="n">bc_ptrs</span><span class="p">[</span><span class="n">level</span><span class="p">]</span> <span class="o">+=</span> <span class="n">lrecs</span><span class="p">;</span>
		<span class="n">cur</span><span class="o">-&gt;</span><span class="n">bc_ra</span><span class="p">[</span><span class="n">level</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/*</span>
<span class="cm">	 * If we joined with the right neighbor and there&#39;s a level above</span>
<span class="cm">	 * us, increment the cursor at that level.</span>
<span class="cm">	 */</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">bc_flags</span> <span class="o">&amp;</span> <span class="n">XFS_BTREE_ROOT_IN_INODE</span><span class="p">)</span> <span class="o">||</span>
		   <span class="p">(</span><span class="n">level</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">&lt;</span> <span class="n">cur</span><span class="o">-&gt;</span><span class="n">bc_nlevels</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">error</span> <span class="o">=</span> <span class="n">xfs_btree_increment</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">level</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">i</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">error0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Readjust the ptr at this level if it&#39;s not a leaf, since it&#39;s</span>
<span class="cm">	 * still pointing at the deletion point, which makes the cursor</span>
<span class="cm">	 * inconsistent.  If this makes the ptr 0, the caller fixes it up.</span>
<span class="cm">	 * We can&#39;t use decrement because it would change the next level up.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">level</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">cur</span><span class="o">-&gt;</span><span class="n">bc_ptrs</span><span class="p">[</span><span class="n">level</span><span class="p">]</span><span class="o">--</span><span class="p">;</span>

	<span class="n">XFS_BTREE_TRACE_CURSOR</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">XBT_EXIT</span><span class="p">);</span>
	<span class="cm">/* Return value means the next level up has something to do. */</span>
	<span class="o">*</span><span class="n">stat</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">error0:</span>
	<span class="n">XFS_BTREE_TRACE_CURSOR</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">XBT_ERROR</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tcur</span><span class="p">)</span>
		<span class="n">xfs_btree_del_cursor</span><span class="p">(</span><span class="n">tcur</span><span class="p">,</span> <span class="n">XFS_BTREE_ERROR</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Delete the record pointed to by cur.</span>
<span class="cm"> * The cursor refers to the place where the record was (could be inserted)</span>
<span class="cm"> * when the operation returns.</span>
<span class="cm"> */</span>
<span class="kt">int</span>					<span class="cm">/* error */</span>
<span class="n">xfs_btree_delete</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">xfs_btree_cur</span>	<span class="o">*</span><span class="n">cur</span><span class="p">,</span>
	<span class="kt">int</span>			<span class="o">*</span><span class="n">stat</span><span class="p">)</span>	<span class="cm">/* success/failure */</span>
<span class="p">{</span>
	<span class="kt">int</span>			<span class="n">error</span><span class="p">;</span>	<span class="cm">/* error return value */</span>
	<span class="kt">int</span>			<span class="n">level</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">i</span><span class="p">;</span>

	<span class="n">XFS_BTREE_TRACE_CURSOR</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">XBT_ENTRY</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Go up the tree, starting at leaf level.</span>
<span class="cm">	 *</span>
<span class="cm">	 * If 2 is returned then a join was done; go to the next level.</span>
<span class="cm">	 * Otherwise we are done.</span>
<span class="cm">	 */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">level</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">2</span><span class="p">;</span> <span class="n">level</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">error</span> <span class="o">=</span> <span class="n">xfs_btree_delrec</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">level</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">i</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">error0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">level</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">level</span> <span class="o">&lt;</span> <span class="n">cur</span><span class="o">-&gt;</span><span class="n">bc_nlevels</span><span class="p">;</span> <span class="n">level</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">bc_ptrs</span><span class="p">[</span><span class="n">level</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">error</span> <span class="o">=</span> <span class="n">xfs_btree_decrement</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">level</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">i</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
					<span class="k">goto</span> <span class="n">error0</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">XFS_BTREE_TRACE_CURSOR</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">XBT_EXIT</span><span class="p">);</span>
	<span class="o">*</span><span class="n">stat</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">error0:</span>
	<span class="n">XFS_BTREE_TRACE_CURSOR</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">XBT_ERROR</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Get the data from the pointed-to record.</span>
<span class="cm"> */</span>
<span class="kt">int</span>					<span class="cm">/* error */</span>
<span class="n">xfs_btree_get_rec</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">xfs_btree_cur</span>	<span class="o">*</span><span class="n">cur</span><span class="p">,</span>	<span class="cm">/* btree cursor */</span>
	<span class="k">union</span> <span class="n">xfs_btree_rec</span>	<span class="o">**</span><span class="n">recp</span><span class="p">,</span>	<span class="cm">/* output: btree record */</span>
	<span class="kt">int</span>			<span class="o">*</span><span class="n">stat</span><span class="p">)</span>	<span class="cm">/* output: success/failure */</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">xfs_btree_block</span>	<span class="o">*</span><span class="n">block</span><span class="p">;</span>	<span class="cm">/* btree block */</span>
	<span class="k">struct</span> <span class="n">xfs_buf</span>		<span class="o">*</span><span class="n">bp</span><span class="p">;</span>	<span class="cm">/* buffer pointer */</span>
	<span class="kt">int</span>			<span class="n">ptr</span><span class="p">;</span>	<span class="cm">/* record number */</span>
<span class="cp">#ifdef DEBUG</span>
	<span class="kt">int</span>			<span class="n">error</span><span class="p">;</span>	<span class="cm">/* error return value */</span>
<span class="cp">#endif</span>

	<span class="n">ptr</span> <span class="o">=</span> <span class="n">cur</span><span class="o">-&gt;</span><span class="n">bc_ptrs</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">block</span> <span class="o">=</span> <span class="n">xfs_btree_get_block</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bp</span><span class="p">);</span>

<span class="cp">#ifdef DEBUG</span>
	<span class="n">error</span> <span class="o">=</span> <span class="n">xfs_btree_check_block</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">block</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">bp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="cm">/*</span>
<span class="cm">	 * Off the right end or left end, return failure.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ptr</span> <span class="o">&gt;</span> <span class="n">xfs_btree_get_numrecs</span><span class="p">(</span><span class="n">block</span><span class="p">)</span> <span class="o">||</span> <span class="n">ptr</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">stat</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Point to the record and extract its data.</span>
<span class="cm">	 */</span>
	<span class="o">*</span><span class="n">recp</span> <span class="o">=</span> <span class="n">xfs_btree_rec_addr</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">ptr</span><span class="p">,</span> <span class="n">block</span><span class="p">);</span>
	<span class="o">*</span><span class="n">stat</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
