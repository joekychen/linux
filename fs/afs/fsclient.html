<!DOCTYPE html>
<html><head><title>joekychen/linux » fs › afs › fsclient.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>fsclient.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/* AFS File Server client stubs</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 2002, 2007 Red Hat, Inc. All Rights Reserved.</span>
<span class="cm"> * Written by David Howells (dhowells@redhat.com)</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or</span>
<span class="cm"> * modify it under the terms of the GNU General Public License</span>
<span class="cm"> * as published by the Free Software Foundation; either version</span>
<span class="cm"> * 2 of the License, or (at your option) any later version.</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/sched.h&gt;</span>
<span class="cp">#include &lt;linux/circ_buf.h&gt;</span>
<span class="cp">#include &quot;internal.h&quot;</span>
<span class="cp">#include &quot;afs_fs.h&quot;</span>

<span class="cm">/*</span>
<span class="cm"> * decode an AFSFid block</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">xdr_decode_AFSFid</span><span class="p">(</span><span class="k">const</span> <span class="n">__be32</span> <span class="o">**</span><span class="n">_bp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">afs_fid</span> <span class="o">*</span><span class="n">fid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="n">__be32</span> <span class="o">*</span><span class="n">bp</span> <span class="o">=</span> <span class="o">*</span><span class="n">_bp</span><span class="p">;</span>

	<span class="n">fid</span><span class="o">-&gt;</span><span class="n">vid</span>		<span class="o">=</span> <span class="n">ntohl</span><span class="p">(</span><span class="o">*</span><span class="n">bp</span><span class="o">++</span><span class="p">);</span>
	<span class="n">fid</span><span class="o">-&gt;</span><span class="n">vnode</span>		<span class="o">=</span> <span class="n">ntohl</span><span class="p">(</span><span class="o">*</span><span class="n">bp</span><span class="o">++</span><span class="p">);</span>
	<span class="n">fid</span><span class="o">-&gt;</span><span class="n">unique</span>		<span class="o">=</span> <span class="n">ntohl</span><span class="p">(</span><span class="o">*</span><span class="n">bp</span><span class="o">++</span><span class="p">);</span>
	<span class="o">*</span><span class="n">_bp</span> <span class="o">=</span> <span class="n">bp</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * decode an AFSFetchStatus block</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">xdr_decode_AFSFetchStatus</span><span class="p">(</span><span class="k">const</span> <span class="n">__be32</span> <span class="o">**</span><span class="n">_bp</span><span class="p">,</span>
				      <span class="k">struct</span> <span class="n">afs_file_status</span> <span class="o">*</span><span class="n">status</span><span class="p">,</span>
				      <span class="k">struct</span> <span class="n">afs_vnode</span> <span class="o">*</span><span class="n">vnode</span><span class="p">,</span>
				      <span class="n">afs_dataversion_t</span> <span class="o">*</span><span class="n">store_version</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">afs_dataversion_t</span> <span class="n">expected_version</span><span class="p">;</span>
	<span class="k">const</span> <span class="n">__be32</span> <span class="o">*</span><span class="n">bp</span> <span class="o">=</span> <span class="o">*</span><span class="n">_bp</span><span class="p">;</span>
	<span class="n">umode_t</span> <span class="n">mode</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">data_version</span><span class="p">,</span> <span class="n">size</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">changed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* becomes non-zero if ctime-type changes seen */</span>

<span class="cp">#define EXTRACT(DST)				\</span>
<span class="cp">	do {					\</span>
<span class="cp">		u32 x = ntohl(*bp++);		\</span>
<span class="cp">		changed |= DST - x;		\</span>
<span class="cp">		DST = x;			\</span>
<span class="cp">	} while (0)</span>

	<span class="n">status</span><span class="o">-&gt;</span><span class="n">if_version</span> <span class="o">=</span> <span class="n">ntohl</span><span class="p">(</span><span class="o">*</span><span class="n">bp</span><span class="o">++</span><span class="p">);</span>
	<span class="n">EXTRACT</span><span class="p">(</span><span class="n">status</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">);</span>
	<span class="n">EXTRACT</span><span class="p">(</span><span class="n">status</span><span class="o">-&gt;</span><span class="n">nlink</span><span class="p">);</span>
	<span class="n">size</span> <span class="o">=</span> <span class="n">ntohl</span><span class="p">(</span><span class="o">*</span><span class="n">bp</span><span class="o">++</span><span class="p">);</span>
	<span class="n">data_version</span> <span class="o">=</span> <span class="n">ntohl</span><span class="p">(</span><span class="o">*</span><span class="n">bp</span><span class="o">++</span><span class="p">);</span>
	<span class="n">EXTRACT</span><span class="p">(</span><span class="n">status</span><span class="o">-&gt;</span><span class="n">author</span><span class="p">);</span>
	<span class="n">EXTRACT</span><span class="p">(</span><span class="n">status</span><span class="o">-&gt;</span><span class="n">owner</span><span class="p">);</span>
	<span class="n">EXTRACT</span><span class="p">(</span><span class="n">status</span><span class="o">-&gt;</span><span class="n">caller_access</span><span class="p">);</span> <span class="cm">/* call ticket dependent */</span>
	<span class="n">EXTRACT</span><span class="p">(</span><span class="n">status</span><span class="o">-&gt;</span><span class="n">anon_access</span><span class="p">);</span>
	<span class="n">EXTRACT</span><span class="p">(</span><span class="n">status</span><span class="o">-&gt;</span><span class="n">mode</span><span class="p">);</span>
	<span class="n">EXTRACT</span><span class="p">(</span><span class="n">status</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">.</span><span class="n">vnode</span><span class="p">);</span>
	<span class="n">EXTRACT</span><span class="p">(</span><span class="n">status</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">.</span><span class="n">unique</span><span class="p">);</span>
	<span class="n">bp</span><span class="o">++</span><span class="p">;</span> <span class="cm">/* seg size */</span>
	<span class="n">status</span><span class="o">-&gt;</span><span class="n">mtime_client</span> <span class="o">=</span> <span class="n">ntohl</span><span class="p">(</span><span class="o">*</span><span class="n">bp</span><span class="o">++</span><span class="p">);</span>
	<span class="n">status</span><span class="o">-&gt;</span><span class="n">mtime_server</span> <span class="o">=</span> <span class="n">ntohl</span><span class="p">(</span><span class="o">*</span><span class="n">bp</span><span class="o">++</span><span class="p">);</span>
	<span class="n">EXTRACT</span><span class="p">(</span><span class="n">status</span><span class="o">-&gt;</span><span class="n">group</span><span class="p">);</span>
	<span class="n">bp</span><span class="o">++</span><span class="p">;</span> <span class="cm">/* sync counter */</span>
	<span class="n">data_version</span> <span class="o">|=</span> <span class="p">(</span><span class="n">u64</span><span class="p">)</span> <span class="n">ntohl</span><span class="p">(</span><span class="o">*</span><span class="n">bp</span><span class="o">++</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">32</span><span class="p">;</span>
	<span class="n">EXTRACT</span><span class="p">(</span><span class="n">status</span><span class="o">-&gt;</span><span class="n">lock_count</span><span class="p">);</span>
	<span class="n">size</span> <span class="o">|=</span> <span class="p">(</span><span class="n">u64</span><span class="p">)</span> <span class="n">ntohl</span><span class="p">(</span><span class="o">*</span><span class="n">bp</span><span class="o">++</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">32</span><span class="p">;</span>
	<span class="n">bp</span><span class="o">++</span><span class="p">;</span> <span class="cm">/* spare 4 */</span>
	<span class="o">*</span><span class="n">_bp</span> <span class="o">=</span> <span class="n">bp</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">!=</span> <span class="n">status</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">status</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">=</span> <span class="n">size</span><span class="p">;</span>
		<span class="n">changed</span> <span class="o">|=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">status</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">&amp;=</span> <span class="n">S_IALLUGO</span><span class="p">;</span>

	<span class="n">_debug</span><span class="p">(</span><span class="s">&quot;vnode time %lx, %lx&quot;</span><span class="p">,</span>
	       <span class="n">status</span><span class="o">-&gt;</span><span class="n">mtime_client</span><span class="p">,</span> <span class="n">status</span><span class="o">-&gt;</span><span class="n">mtime_server</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vnode</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">status</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">.</span><span class="n">vid</span> <span class="o">=</span> <span class="n">vnode</span><span class="o">-&gt;</span><span class="n">fid</span><span class="p">.</span><span class="n">vid</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">changed</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">AFS_VNODE_UNSET</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vnode</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">_debug</span><span class="p">(</span><span class="s">&quot;vnode changed&quot;</span><span class="p">);</span>
			<span class="n">i_size_write</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vnode</span><span class="o">-&gt;</span><span class="n">vfs_inode</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
			<span class="n">vnode</span><span class="o">-&gt;</span><span class="n">vfs_inode</span><span class="p">.</span><span class="n">i_uid</span> <span class="o">=</span> <span class="n">status</span><span class="o">-&gt;</span><span class="n">owner</span><span class="p">;</span>
			<span class="n">vnode</span><span class="o">-&gt;</span><span class="n">vfs_inode</span><span class="p">.</span><span class="n">i_gid</span> <span class="o">=</span> <span class="n">status</span><span class="o">-&gt;</span><span class="n">group</span><span class="p">;</span>
			<span class="n">vnode</span><span class="o">-&gt;</span><span class="n">vfs_inode</span><span class="p">.</span><span class="n">i_generation</span> <span class="o">=</span> <span class="n">vnode</span><span class="o">-&gt;</span><span class="n">fid</span><span class="p">.</span><span class="n">unique</span><span class="p">;</span>
			<span class="n">set_nlink</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vnode</span><span class="o">-&gt;</span><span class="n">vfs_inode</span><span class="p">,</span> <span class="n">status</span><span class="o">-&gt;</span><span class="n">nlink</span><span class="p">);</span>

			<span class="n">mode</span> <span class="o">=</span> <span class="n">vnode</span><span class="o">-&gt;</span><span class="n">vfs_inode</span><span class="p">.</span><span class="n">i_mode</span><span class="p">;</span>
			<span class="n">mode</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">S_IALLUGO</span><span class="p">;</span>
			<span class="n">mode</span> <span class="o">|=</span> <span class="n">status</span><span class="o">-&gt;</span><span class="n">mode</span><span class="p">;</span>
			<span class="n">barrier</span><span class="p">();</span>
			<span class="n">vnode</span><span class="o">-&gt;</span><span class="n">vfs_inode</span><span class="p">.</span><span class="n">i_mode</span> <span class="o">=</span> <span class="n">mode</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">vnode</span><span class="o">-&gt;</span><span class="n">vfs_inode</span><span class="p">.</span><span class="n">i_ctime</span><span class="p">.</span><span class="n">tv_sec</span>	<span class="o">=</span> <span class="n">status</span><span class="o">-&gt;</span><span class="n">mtime_server</span><span class="p">;</span>
		<span class="n">vnode</span><span class="o">-&gt;</span><span class="n">vfs_inode</span><span class="p">.</span><span class="n">i_mtime</span>	<span class="o">=</span> <span class="n">vnode</span><span class="o">-&gt;</span><span class="n">vfs_inode</span><span class="p">.</span><span class="n">i_ctime</span><span class="p">;</span>
		<span class="n">vnode</span><span class="o">-&gt;</span><span class="n">vfs_inode</span><span class="p">.</span><span class="n">i_atime</span>	<span class="o">=</span> <span class="n">vnode</span><span class="o">-&gt;</span><span class="n">vfs_inode</span><span class="p">.</span><span class="n">i_ctime</span><span class="p">;</span>
		<span class="n">vnode</span><span class="o">-&gt;</span><span class="n">vfs_inode</span><span class="p">.</span><span class="n">i_version</span>	<span class="o">=</span> <span class="n">data_version</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">expected_version</span> <span class="o">=</span> <span class="n">status</span><span class="o">-&gt;</span><span class="n">data_version</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">store_version</span><span class="p">)</span>
		<span class="n">expected_version</span> <span class="o">=</span> <span class="o">*</span><span class="n">store_version</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">expected_version</span> <span class="o">!=</span> <span class="n">data_version</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">status</span><span class="o">-&gt;</span><span class="n">data_version</span> <span class="o">=</span> <span class="n">data_version</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">vnode</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">AFS_VNODE_UNSET</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vnode</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">_debug</span><span class="p">(</span><span class="s">&quot;vnode modified %llx on {%x:%u}&quot;</span><span class="p">,</span>
			       <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span> <span class="n">data_version</span><span class="p">,</span>
			       <span class="n">vnode</span><span class="o">-&gt;</span><span class="n">fid</span><span class="p">.</span><span class="n">vid</span><span class="p">,</span> <span class="n">vnode</span><span class="o">-&gt;</span><span class="n">fid</span><span class="p">.</span><span class="n">vnode</span><span class="p">);</span>
			<span class="n">set_bit</span><span class="p">(</span><span class="n">AFS_VNODE_MODIFIED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vnode</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
			<span class="n">set_bit</span><span class="p">(</span><span class="n">AFS_VNODE_ZAP_DATA</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vnode</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">store_version</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">status</span><span class="o">-&gt;</span><span class="n">data_version</span> <span class="o">=</span> <span class="n">data_version</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * decode an AFSCallBack block</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">xdr_decode_AFSCallBack</span><span class="p">(</span><span class="k">const</span> <span class="n">__be32</span> <span class="o">**</span><span class="n">_bp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">afs_vnode</span> <span class="o">*</span><span class="n">vnode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="n">__be32</span> <span class="o">*</span><span class="n">bp</span> <span class="o">=</span> <span class="o">*</span><span class="n">_bp</span><span class="p">;</span>

	<span class="n">vnode</span><span class="o">-&gt;</span><span class="n">cb_version</span>	<span class="o">=</span> <span class="n">ntohl</span><span class="p">(</span><span class="o">*</span><span class="n">bp</span><span class="o">++</span><span class="p">);</span>
	<span class="n">vnode</span><span class="o">-&gt;</span><span class="n">cb_expiry</span>	<span class="o">=</span> <span class="n">ntohl</span><span class="p">(</span><span class="o">*</span><span class="n">bp</span><span class="o">++</span><span class="p">);</span>
	<span class="n">vnode</span><span class="o">-&gt;</span><span class="n">cb_type</span>		<span class="o">=</span> <span class="n">ntohl</span><span class="p">(</span><span class="o">*</span><span class="n">bp</span><span class="o">++</span><span class="p">);</span>
	<span class="n">vnode</span><span class="o">-&gt;</span><span class="n">cb_expires</span>	<span class="o">=</span> <span class="n">vnode</span><span class="o">-&gt;</span><span class="n">cb_expiry</span> <span class="o">+</span> <span class="n">get_seconds</span><span class="p">();</span>
	<span class="o">*</span><span class="n">_bp</span> <span class="o">=</span> <span class="n">bp</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">xdr_decode_AFSCallBack_raw</span><span class="p">(</span><span class="k">const</span> <span class="n">__be32</span> <span class="o">**</span><span class="n">_bp</span><span class="p">,</span>
				       <span class="k">struct</span> <span class="n">afs_callback</span> <span class="o">*</span><span class="n">cb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="n">__be32</span> <span class="o">*</span><span class="n">bp</span> <span class="o">=</span> <span class="o">*</span><span class="n">_bp</span><span class="p">;</span>

	<span class="n">cb</span><span class="o">-&gt;</span><span class="n">version</span>	<span class="o">=</span> <span class="n">ntohl</span><span class="p">(</span><span class="o">*</span><span class="n">bp</span><span class="o">++</span><span class="p">);</span>
	<span class="n">cb</span><span class="o">-&gt;</span><span class="n">expiry</span>	<span class="o">=</span> <span class="n">ntohl</span><span class="p">(</span><span class="o">*</span><span class="n">bp</span><span class="o">++</span><span class="p">);</span>
	<span class="n">cb</span><span class="o">-&gt;</span><span class="n">type</span>	<span class="o">=</span> <span class="n">ntohl</span><span class="p">(</span><span class="o">*</span><span class="n">bp</span><span class="o">++</span><span class="p">);</span>
	<span class="o">*</span><span class="n">_bp</span> <span class="o">=</span> <span class="n">bp</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * decode an AFSVolSync block</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">xdr_decode_AFSVolSync</span><span class="p">(</span><span class="k">const</span> <span class="n">__be32</span> <span class="o">**</span><span class="n">_bp</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">afs_volsync</span> <span class="o">*</span><span class="n">volsync</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="n">__be32</span> <span class="o">*</span><span class="n">bp</span> <span class="o">=</span> <span class="o">*</span><span class="n">_bp</span><span class="p">;</span>

	<span class="n">volsync</span><span class="o">-&gt;</span><span class="n">creation</span> <span class="o">=</span> <span class="n">ntohl</span><span class="p">(</span><span class="o">*</span><span class="n">bp</span><span class="o">++</span><span class="p">);</span>
	<span class="n">bp</span><span class="o">++</span><span class="p">;</span> <span class="cm">/* spare2 */</span>
	<span class="n">bp</span><span class="o">++</span><span class="p">;</span> <span class="cm">/* spare3 */</span>
	<span class="n">bp</span><span class="o">++</span><span class="p">;</span> <span class="cm">/* spare4 */</span>
	<span class="n">bp</span><span class="o">++</span><span class="p">;</span> <span class="cm">/* spare5 */</span>
	<span class="n">bp</span><span class="o">++</span><span class="p">;</span> <span class="cm">/* spare6 */</span>
	<span class="o">*</span><span class="n">_bp</span> <span class="o">=</span> <span class="n">bp</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * encode the requested attributes into an AFSStoreStatus block</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">xdr_encode_AFS_StoreStatus</span><span class="p">(</span><span class="n">__be32</span> <span class="o">**</span><span class="n">_bp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">iattr</span> <span class="o">*</span><span class="n">attr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">__be32</span> <span class="o">*</span><span class="n">bp</span> <span class="o">=</span> <span class="o">*</span><span class="n">_bp</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">mask</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">mtime</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">owner</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">group</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">mode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">mask</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">attr</span><span class="o">-&gt;</span><span class="n">ia_valid</span> <span class="o">&amp;</span> <span class="n">ATTR_MTIME</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mask</span> <span class="o">|=</span> <span class="n">AFS_SET_MTIME</span><span class="p">;</span>
		<span class="n">mtime</span> <span class="o">=</span> <span class="n">attr</span><span class="o">-&gt;</span><span class="n">ia_mtime</span><span class="p">.</span><span class="n">tv_sec</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">attr</span><span class="o">-&gt;</span><span class="n">ia_valid</span> <span class="o">&amp;</span> <span class="n">ATTR_UID</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mask</span> <span class="o">|=</span> <span class="n">AFS_SET_OWNER</span><span class="p">;</span>
		<span class="n">owner</span> <span class="o">=</span> <span class="n">attr</span><span class="o">-&gt;</span><span class="n">ia_uid</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">attr</span><span class="o">-&gt;</span><span class="n">ia_valid</span> <span class="o">&amp;</span> <span class="n">ATTR_GID</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mask</span> <span class="o">|=</span> <span class="n">AFS_SET_GROUP</span><span class="p">;</span>
		<span class="n">group</span> <span class="o">=</span> <span class="n">attr</span><span class="o">-&gt;</span><span class="n">ia_gid</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">attr</span><span class="o">-&gt;</span><span class="n">ia_valid</span> <span class="o">&amp;</span> <span class="n">ATTR_MODE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mask</span> <span class="o">|=</span> <span class="n">AFS_SET_MODE</span><span class="p">;</span>
		<span class="n">mode</span> <span class="o">=</span> <span class="n">attr</span><span class="o">-&gt;</span><span class="n">ia_mode</span> <span class="o">&amp;</span> <span class="n">S_IALLUGO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="o">*</span><span class="n">bp</span><span class="o">++</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">mask</span><span class="p">);</span>
	<span class="o">*</span><span class="n">bp</span><span class="o">++</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">mtime</span><span class="p">);</span>
	<span class="o">*</span><span class="n">bp</span><span class="o">++</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">owner</span><span class="p">);</span>
	<span class="o">*</span><span class="n">bp</span><span class="o">++</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">group</span><span class="p">);</span>
	<span class="o">*</span><span class="n">bp</span><span class="o">++</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">mode</span><span class="p">);</span>
	<span class="o">*</span><span class="n">bp</span><span class="o">++</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>		<span class="cm">/* segment size */</span>
	<span class="o">*</span><span class="n">_bp</span> <span class="o">=</span> <span class="n">bp</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * decode an AFSFetchVolumeStatus block</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">xdr_decode_AFSFetchVolumeStatus</span><span class="p">(</span><span class="k">const</span> <span class="n">__be32</span> <span class="o">**</span><span class="n">_bp</span><span class="p">,</span>
					    <span class="k">struct</span> <span class="n">afs_volume_status</span> <span class="o">*</span><span class="n">vs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="n">__be32</span> <span class="o">*</span><span class="n">bp</span> <span class="o">=</span> <span class="o">*</span><span class="n">_bp</span><span class="p">;</span>

	<span class="n">vs</span><span class="o">-&gt;</span><span class="n">vid</span>			<span class="o">=</span> <span class="n">ntohl</span><span class="p">(</span><span class="o">*</span><span class="n">bp</span><span class="o">++</span><span class="p">);</span>
	<span class="n">vs</span><span class="o">-&gt;</span><span class="n">parent_id</span>		<span class="o">=</span> <span class="n">ntohl</span><span class="p">(</span><span class="o">*</span><span class="n">bp</span><span class="o">++</span><span class="p">);</span>
	<span class="n">vs</span><span class="o">-&gt;</span><span class="n">online</span>		<span class="o">=</span> <span class="n">ntohl</span><span class="p">(</span><span class="o">*</span><span class="n">bp</span><span class="o">++</span><span class="p">);</span>
	<span class="n">vs</span><span class="o">-&gt;</span><span class="n">in_service</span>		<span class="o">=</span> <span class="n">ntohl</span><span class="p">(</span><span class="o">*</span><span class="n">bp</span><span class="o">++</span><span class="p">);</span>
	<span class="n">vs</span><span class="o">-&gt;</span><span class="n">blessed</span>		<span class="o">=</span> <span class="n">ntohl</span><span class="p">(</span><span class="o">*</span><span class="n">bp</span><span class="o">++</span><span class="p">);</span>
	<span class="n">vs</span><span class="o">-&gt;</span><span class="n">needs_salvage</span>	<span class="o">=</span> <span class="n">ntohl</span><span class="p">(</span><span class="o">*</span><span class="n">bp</span><span class="o">++</span><span class="p">);</span>
	<span class="n">vs</span><span class="o">-&gt;</span><span class="n">type</span>		<span class="o">=</span> <span class="n">ntohl</span><span class="p">(</span><span class="o">*</span><span class="n">bp</span><span class="o">++</span><span class="p">);</span>
	<span class="n">vs</span><span class="o">-&gt;</span><span class="n">min_quota</span>		<span class="o">=</span> <span class="n">ntohl</span><span class="p">(</span><span class="o">*</span><span class="n">bp</span><span class="o">++</span><span class="p">);</span>
	<span class="n">vs</span><span class="o">-&gt;</span><span class="n">max_quota</span>		<span class="o">=</span> <span class="n">ntohl</span><span class="p">(</span><span class="o">*</span><span class="n">bp</span><span class="o">++</span><span class="p">);</span>
	<span class="n">vs</span><span class="o">-&gt;</span><span class="n">blocks_in_use</span>	<span class="o">=</span> <span class="n">ntohl</span><span class="p">(</span><span class="o">*</span><span class="n">bp</span><span class="o">++</span><span class="p">);</span>
	<span class="n">vs</span><span class="o">-&gt;</span><span class="n">part_blocks_avail</span>	<span class="o">=</span> <span class="n">ntohl</span><span class="p">(</span><span class="o">*</span><span class="n">bp</span><span class="o">++</span><span class="p">);</span>
	<span class="n">vs</span><span class="o">-&gt;</span><span class="n">part_max_blocks</span>	<span class="o">=</span> <span class="n">ntohl</span><span class="p">(</span><span class="o">*</span><span class="n">bp</span><span class="o">++</span><span class="p">);</span>
	<span class="o">*</span><span class="n">_bp</span> <span class="o">=</span> <span class="n">bp</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * deliver reply data to an FS.FetchStatus</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">afs_deliver_fs_fetch_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">afs_call</span> <span class="o">*</span><span class="n">call</span><span class="p">,</span>
				       <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="n">bool</span> <span class="n">last</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">afs_vnode</span> <span class="o">*</span><span class="n">vnode</span> <span class="o">=</span> <span class="n">call</span><span class="o">-&gt;</span><span class="n">reply</span><span class="p">;</span>
	<span class="k">const</span> <span class="n">__be32</span> <span class="o">*</span><span class="n">bp</span><span class="p">;</span>

	<span class="n">_enter</span><span class="p">(</span><span class="s">&quot;,,%u&quot;</span><span class="p">,</span> <span class="n">last</span><span class="p">);</span>

	<span class="n">afs_transfer_reply</span><span class="p">(</span><span class="n">call</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">last</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">call</span><span class="o">-&gt;</span><span class="n">reply_size</span> <span class="o">!=</span> <span class="n">call</span><span class="o">-&gt;</span><span class="n">reply_max</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBADMSG</span><span class="p">;</span>

	<span class="cm">/* unmarshall the reply once we&#39;ve received all of it */</span>
	<span class="n">bp</span> <span class="o">=</span> <span class="n">call</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">;</span>
	<span class="n">xdr_decode_AFSFetchStatus</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vnode</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">,</span> <span class="n">vnode</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">xdr_decode_AFSCallBack</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bp</span><span class="p">,</span> <span class="n">vnode</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">call</span><span class="o">-&gt;</span><span class="n">reply2</span><span class="p">)</span>
		<span class="n">xdr_decode_AFSVolSync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bp</span><span class="p">,</span> <span class="n">call</span><span class="o">-&gt;</span><span class="n">reply2</span><span class="p">);</span>

	<span class="n">_leave</span><span class="p">(</span><span class="s">&quot; = 0 [done]&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * FS.FetchStatus operation type</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">afs_call_type</span> <span class="n">afs_RXFSFetchStatus</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;FS.FetchStatus&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">deliver</span>	<span class="o">=</span> <span class="n">afs_deliver_fs_fetch_status</span><span class="p">,</span>
	<span class="p">.</span><span class="n">abort_to_error</span>	<span class="o">=</span> <span class="n">afs_abort_to_error</span><span class="p">,</span>
	<span class="p">.</span><span class="n">destructor</span>	<span class="o">=</span> <span class="n">afs_flat_call_destructor</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * fetch the status information for a file</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">afs_fs_fetch_file_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">afs_server</span> <span class="o">*</span><span class="n">server</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">key</span> <span class="o">*</span><span class="n">key</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">afs_vnode</span> <span class="o">*</span><span class="n">vnode</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">afs_volsync</span> <span class="o">*</span><span class="n">volsync</span><span class="p">,</span>
			     <span class="k">const</span> <span class="k">struct</span> <span class="n">afs_wait_mode</span> <span class="o">*</span><span class="n">wait_mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">afs_call</span> <span class="o">*</span><span class="n">call</span><span class="p">;</span>
	<span class="n">__be32</span> <span class="o">*</span><span class="n">bp</span><span class="p">;</span>

	<span class="n">_enter</span><span class="p">(</span><span class="s">&quot;,%x,{%x:%u},,&quot;</span><span class="p">,</span>
	       <span class="n">key_serial</span><span class="p">(</span><span class="n">key</span><span class="p">),</span> <span class="n">vnode</span><span class="o">-&gt;</span><span class="n">fid</span><span class="p">.</span><span class="n">vid</span><span class="p">,</span> <span class="n">vnode</span><span class="o">-&gt;</span><span class="n">fid</span><span class="p">.</span><span class="n">vnode</span><span class="p">);</span>

	<span class="n">call</span> <span class="o">=</span> <span class="n">afs_alloc_flat_call</span><span class="p">(</span><span class="o">&amp;</span><span class="n">afs_RXFSFetchStatus</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="p">(</span><span class="mi">21</span> <span class="o">+</span> <span class="mi">3</span> <span class="o">+</span> <span class="mi">6</span><span class="p">)</span> <span class="o">*</span> <span class="mi">4</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">call</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">call</span><span class="o">-&gt;</span><span class="n">key</span> <span class="o">=</span> <span class="n">key</span><span class="p">;</span>
	<span class="n">call</span><span class="o">-&gt;</span><span class="n">reply</span> <span class="o">=</span> <span class="n">vnode</span><span class="p">;</span>
	<span class="n">call</span><span class="o">-&gt;</span><span class="n">reply2</span> <span class="o">=</span> <span class="n">volsync</span><span class="p">;</span>
	<span class="n">call</span><span class="o">-&gt;</span><span class="n">service_id</span> <span class="o">=</span> <span class="n">FS_SERVICE</span><span class="p">;</span>
	<span class="n">call</span><span class="o">-&gt;</span><span class="n">port</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="n">AFS_FS_PORT</span><span class="p">);</span>

	<span class="cm">/* marshall the parameters */</span>
	<span class="n">bp</span> <span class="o">=</span> <span class="n">call</span><span class="o">-&gt;</span><span class="n">request</span><span class="p">;</span>
	<span class="n">bp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">FSFETCHSTATUS</span><span class="p">);</span>
	<span class="n">bp</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">vnode</span><span class="o">-&gt;</span><span class="n">fid</span><span class="p">.</span><span class="n">vid</span><span class="p">);</span>
	<span class="n">bp</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">vnode</span><span class="o">-&gt;</span><span class="n">fid</span><span class="p">.</span><span class="n">vnode</span><span class="p">);</span>
	<span class="n">bp</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">vnode</span><span class="o">-&gt;</span><span class="n">fid</span><span class="p">.</span><span class="n">unique</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">afs_make_call</span><span class="p">(</span><span class="o">&amp;</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span> <span class="n">call</span><span class="p">,</span> <span class="n">GFP_NOFS</span><span class="p">,</span> <span class="n">wait_mode</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * deliver reply data to an FS.FetchData</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">afs_deliver_fs_fetch_data</span><span class="p">(</span><span class="k">struct</span> <span class="n">afs_call</span> <span class="o">*</span><span class="n">call</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="n">bool</span> <span class="n">last</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">afs_vnode</span> <span class="o">*</span><span class="n">vnode</span> <span class="o">=</span> <span class="n">call</span><span class="o">-&gt;</span><span class="n">reply</span><span class="p">;</span>
	<span class="k">const</span> <span class="n">__be32</span> <span class="o">*</span><span class="n">bp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="n">page</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">buffer</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">_enter</span><span class="p">(</span><span class="s">&quot;{%u},{%u},%d&quot;</span><span class="p">,</span> <span class="n">call</span><span class="o">-&gt;</span><span class="n">unmarshall</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span> <span class="n">last</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">call</span><span class="o">-&gt;</span><span class="n">unmarshall</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>:
		<span class="n">call</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">call</span><span class="o">-&gt;</span><span class="n">unmarshall</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">call</span><span class="o">-&gt;</span><span class="n">operation_ID</span> <span class="o">!=</span> <span class="n">FSFETCHDATA64</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">call</span><span class="o">-&gt;</span><span class="n">unmarshall</span><span class="o">++</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">no_msw</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* extract the upper part of the returned data length of an</span>
<span class="cm">		 * FSFETCHDATA64 op (which should always be 0 using this</span>
<span class="cm">		 * client) */</span>
	<span class="k">case</span> <span class="mi">1</span>:
		<span class="n">_debug</span><span class="p">(</span><span class="s">&quot;extract data length (MSW)&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">afs_extract_data</span><span class="p">(</span><span class="n">call</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">last</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">call</span><span class="o">-&gt;</span><span class="n">tmp</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">0</span>:		<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="o">-</span><span class="n">EAGAIN</span>:	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="nl">default:</span>	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">call</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">=</span> <span class="n">ntohl</span><span class="p">(</span><span class="n">call</span><span class="o">-&gt;</span><span class="n">tmp</span><span class="p">);</span>
		<span class="n">_debug</span><span class="p">(</span><span class="s">&quot;DATA length MSW: %u&quot;</span><span class="p">,</span> <span class="n">call</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">call</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EBADMSG</span><span class="p">;</span>
		<span class="n">call</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">call</span><span class="o">-&gt;</span><span class="n">unmarshall</span><span class="o">++</span><span class="p">;</span>

	<span class="nl">no_msw:</span>
		<span class="cm">/* extract the returned data length */</span>
	<span class="k">case</span> <span class="mi">2</span>:
		<span class="n">_debug</span><span class="p">(</span><span class="s">&quot;extract data length&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">afs_extract_data</span><span class="p">(</span><span class="n">call</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">last</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">call</span><span class="o">-&gt;</span><span class="n">tmp</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">0</span>:		<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="o">-</span><span class="n">EAGAIN</span>:	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="nl">default:</span>	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">call</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">=</span> <span class="n">ntohl</span><span class="p">(</span><span class="n">call</span><span class="o">-&gt;</span><span class="n">tmp</span><span class="p">);</span>
		<span class="n">_debug</span><span class="p">(</span><span class="s">&quot;DATA length: %u&quot;</span><span class="p">,</span> <span class="n">call</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">call</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">&gt;</span> <span class="n">PAGE_SIZE</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EBADMSG</span><span class="p">;</span>
		<span class="n">call</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">call</span><span class="o">-&gt;</span><span class="n">unmarshall</span><span class="o">++</span><span class="p">;</span>

		<span class="cm">/* extract the returned data */</span>
	<span class="k">case</span> <span class="mi">3</span>:
		<span class="n">_debug</span><span class="p">(</span><span class="s">&quot;extract data&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">call</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">page</span> <span class="o">=</span> <span class="n">call</span><span class="o">-&gt;</span><span class="n">reply3</span><span class="p">;</span>
			<span class="n">buffer</span> <span class="o">=</span> <span class="n">kmap_atomic</span><span class="p">(</span><span class="n">page</span><span class="p">);</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">afs_extract_data</span><span class="p">(</span><span class="n">call</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">last</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span>
					       <span class="n">call</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">);</span>
			<span class="n">kunmap_atomic</span><span class="p">(</span><span class="n">buffer</span><span class="p">);</span>
			<span class="k">switch</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="mi">0</span>:		<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="o">-</span><span class="n">EAGAIN</span>:	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
			<span class="nl">default:</span>	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="n">call</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">call</span><span class="o">-&gt;</span><span class="n">unmarshall</span><span class="o">++</span><span class="p">;</span>

		<span class="cm">/* extract the metadata */</span>
	<span class="k">case</span> <span class="mi">4</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">afs_extract_data</span><span class="p">(</span><span class="n">call</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">last</span><span class="p">,</span> <span class="n">call</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">,</span>
				       <span class="p">(</span><span class="mi">21</span> <span class="o">+</span> <span class="mi">3</span> <span class="o">+</span> <span class="mi">6</span><span class="p">)</span> <span class="o">*</span> <span class="mi">4</span><span class="p">);</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">0</span>:		<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="o">-</span><span class="n">EAGAIN</span>:	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="nl">default:</span>	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">bp</span> <span class="o">=</span> <span class="n">call</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">;</span>
		<span class="n">xdr_decode_AFSFetchStatus</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vnode</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">,</span> <span class="n">vnode</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="n">xdr_decode_AFSCallBack</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bp</span><span class="p">,</span> <span class="n">vnode</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">call</span><span class="o">-&gt;</span><span class="n">reply2</span><span class="p">)</span>
			<span class="n">xdr_decode_AFSVolSync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bp</span><span class="p">,</span> <span class="n">call</span><span class="o">-&gt;</span><span class="n">reply2</span><span class="p">);</span>

		<span class="n">call</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">call</span><span class="o">-&gt;</span><span class="n">unmarshall</span><span class="o">++</span><span class="p">;</span>

	<span class="k">case</span> <span class="mi">5</span>:
		<span class="n">_debug</span><span class="p">(</span><span class="s">&quot;trailer&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EBADMSG</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">last</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">call</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">&lt;</span> <span class="n">PAGE_SIZE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">_debug</span><span class="p">(</span><span class="s">&quot;clear&quot;</span><span class="p">);</span>
		<span class="n">page</span> <span class="o">=</span> <span class="n">call</span><span class="o">-&gt;</span><span class="n">reply3</span><span class="p">;</span>
		<span class="n">buffer</span> <span class="o">=</span> <span class="n">kmap_atomic</span><span class="p">(</span><span class="n">page</span><span class="p">);</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">buffer</span> <span class="o">+</span> <span class="n">call</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">PAGE_SIZE</span> <span class="o">-</span> <span class="n">call</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">);</span>
		<span class="n">kunmap_atomic</span><span class="p">(</span><span class="n">buffer</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">_leave</span><span class="p">(</span><span class="s">&quot; = 0 [done]&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * FS.FetchData operation type</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">afs_call_type</span> <span class="n">afs_RXFSFetchData</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;FS.FetchData&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">deliver</span>	<span class="o">=</span> <span class="n">afs_deliver_fs_fetch_data</span><span class="p">,</span>
	<span class="p">.</span><span class="n">abort_to_error</span>	<span class="o">=</span> <span class="n">afs_abort_to_error</span><span class="p">,</span>
	<span class="p">.</span><span class="n">destructor</span>	<span class="o">=</span> <span class="n">afs_flat_call_destructor</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">afs_call_type</span> <span class="n">afs_RXFSFetchData64</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;FS.FetchData64&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">deliver</span>	<span class="o">=</span> <span class="n">afs_deliver_fs_fetch_data</span><span class="p">,</span>
	<span class="p">.</span><span class="n">abort_to_error</span>	<span class="o">=</span> <span class="n">afs_abort_to_error</span><span class="p">,</span>
	<span class="p">.</span><span class="n">destructor</span>	<span class="o">=</span> <span class="n">afs_flat_call_destructor</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * fetch data from a very large file</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">afs_fs_fetch_data64</span><span class="p">(</span><span class="k">struct</span> <span class="n">afs_server</span> <span class="o">*</span><span class="n">server</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">key</span> <span class="o">*</span><span class="n">key</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">afs_vnode</span> <span class="o">*</span><span class="n">vnode</span><span class="p">,</span>
			       <span class="kt">off_t</span> <span class="n">offset</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">length</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="n">buffer</span><span class="p">,</span>
			       <span class="k">const</span> <span class="k">struct</span> <span class="n">afs_wait_mode</span> <span class="o">*</span><span class="n">wait_mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">afs_call</span> <span class="o">*</span><span class="n">call</span><span class="p">;</span>
	<span class="n">__be32</span> <span class="o">*</span><span class="n">bp</span><span class="p">;</span>

	<span class="n">_enter</span><span class="p">(</span><span class="s">&quot;&quot;</span><span class="p">);</span>

	<span class="n">ASSERTCMP</span><span class="p">(</span><span class="n">length</span><span class="p">,</span> <span class="o">&lt;</span><span class="p">,</span> <span class="n">ULONG_MAX</span><span class="p">);</span>

	<span class="n">call</span> <span class="o">=</span> <span class="n">afs_alloc_flat_call</span><span class="p">(</span><span class="o">&amp;</span><span class="n">afs_RXFSFetchData64</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="p">(</span><span class="mi">21</span> <span class="o">+</span> <span class="mi">3</span> <span class="o">+</span> <span class="mi">6</span><span class="p">)</span> <span class="o">*</span> <span class="mi">4</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">call</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">call</span><span class="o">-&gt;</span><span class="n">key</span> <span class="o">=</span> <span class="n">key</span><span class="p">;</span>
	<span class="n">call</span><span class="o">-&gt;</span><span class="n">reply</span> <span class="o">=</span> <span class="n">vnode</span><span class="p">;</span>
	<span class="n">call</span><span class="o">-&gt;</span><span class="n">reply2</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span> <span class="cm">/* volsync */</span>
	<span class="n">call</span><span class="o">-&gt;</span><span class="n">reply3</span> <span class="o">=</span> <span class="n">buffer</span><span class="p">;</span>
	<span class="n">call</span><span class="o">-&gt;</span><span class="n">service_id</span> <span class="o">=</span> <span class="n">FS_SERVICE</span><span class="p">;</span>
	<span class="n">call</span><span class="o">-&gt;</span><span class="n">port</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="n">AFS_FS_PORT</span><span class="p">);</span>
	<span class="n">call</span><span class="o">-&gt;</span><span class="n">operation_ID</span> <span class="o">=</span> <span class="n">FSFETCHDATA64</span><span class="p">;</span>

	<span class="cm">/* marshall the parameters */</span>
	<span class="n">bp</span> <span class="o">=</span> <span class="n">call</span><span class="o">-&gt;</span><span class="n">request</span><span class="p">;</span>
	<span class="n">bp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">FSFETCHDATA64</span><span class="p">);</span>
	<span class="n">bp</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">vnode</span><span class="o">-&gt;</span><span class="n">fid</span><span class="p">.</span><span class="n">vid</span><span class="p">);</span>
	<span class="n">bp</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">vnode</span><span class="o">-&gt;</span><span class="n">fid</span><span class="p">.</span><span class="n">vnode</span><span class="p">);</span>
	<span class="n">bp</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">vnode</span><span class="o">-&gt;</span><span class="n">fid</span><span class="p">.</span><span class="n">unique</span><span class="p">);</span>
	<span class="n">bp</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">upper_32_bits</span><span class="p">(</span><span class="n">offset</span><span class="p">));</span>
	<span class="n">bp</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">((</span><span class="n">u32</span><span class="p">)</span> <span class="n">offset</span><span class="p">);</span>
	<span class="n">bp</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">bp</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">((</span><span class="n">u32</span><span class="p">)</span> <span class="n">length</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">afs_make_call</span><span class="p">(</span><span class="o">&amp;</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span> <span class="n">call</span><span class="p">,</span> <span class="n">GFP_NOFS</span><span class="p">,</span> <span class="n">wait_mode</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * fetch data from a file</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">afs_fs_fetch_data</span><span class="p">(</span><span class="k">struct</span> <span class="n">afs_server</span> <span class="o">*</span><span class="n">server</span><span class="p">,</span>
		      <span class="k">struct</span> <span class="n">key</span> <span class="o">*</span><span class="n">key</span><span class="p">,</span>
		      <span class="k">struct</span> <span class="n">afs_vnode</span> <span class="o">*</span><span class="n">vnode</span><span class="p">,</span>
		      <span class="kt">off_t</span> <span class="n">offset</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">length</span><span class="p">,</span>
		      <span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="n">buffer</span><span class="p">,</span>
		      <span class="k">const</span> <span class="k">struct</span> <span class="n">afs_wait_mode</span> <span class="o">*</span><span class="n">wait_mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">afs_call</span> <span class="o">*</span><span class="n">call</span><span class="p">;</span>
	<span class="n">__be32</span> <span class="o">*</span><span class="n">bp</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">upper_32_bits</span><span class="p">(</span><span class="n">offset</span><span class="p">)</span> <span class="o">||</span> <span class="n">upper_32_bits</span><span class="p">(</span><span class="n">offset</span> <span class="o">+</span> <span class="n">length</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">afs_fs_fetch_data64</span><span class="p">(</span><span class="n">server</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">vnode</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">length</span><span class="p">,</span>
					   <span class="n">buffer</span><span class="p">,</span> <span class="n">wait_mode</span><span class="p">);</span>

	<span class="n">_enter</span><span class="p">(</span><span class="s">&quot;&quot;</span><span class="p">);</span>

	<span class="n">call</span> <span class="o">=</span> <span class="n">afs_alloc_flat_call</span><span class="p">(</span><span class="o">&amp;</span><span class="n">afs_RXFSFetchData</span><span class="p">,</span> <span class="mi">24</span><span class="p">,</span> <span class="p">(</span><span class="mi">21</span> <span class="o">+</span> <span class="mi">3</span> <span class="o">+</span> <span class="mi">6</span><span class="p">)</span> <span class="o">*</span> <span class="mi">4</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">call</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">call</span><span class="o">-&gt;</span><span class="n">key</span> <span class="o">=</span> <span class="n">key</span><span class="p">;</span>
	<span class="n">call</span><span class="o">-&gt;</span><span class="n">reply</span> <span class="o">=</span> <span class="n">vnode</span><span class="p">;</span>
	<span class="n">call</span><span class="o">-&gt;</span><span class="n">reply2</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span> <span class="cm">/* volsync */</span>
	<span class="n">call</span><span class="o">-&gt;</span><span class="n">reply3</span> <span class="o">=</span> <span class="n">buffer</span><span class="p">;</span>
	<span class="n">call</span><span class="o">-&gt;</span><span class="n">service_id</span> <span class="o">=</span> <span class="n">FS_SERVICE</span><span class="p">;</span>
	<span class="n">call</span><span class="o">-&gt;</span><span class="n">port</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="n">AFS_FS_PORT</span><span class="p">);</span>
	<span class="n">call</span><span class="o">-&gt;</span><span class="n">operation_ID</span> <span class="o">=</span> <span class="n">FSFETCHDATA</span><span class="p">;</span>

	<span class="cm">/* marshall the parameters */</span>
	<span class="n">bp</span> <span class="o">=</span> <span class="n">call</span><span class="o">-&gt;</span><span class="n">request</span><span class="p">;</span>
	<span class="n">bp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">FSFETCHDATA</span><span class="p">);</span>
	<span class="n">bp</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">vnode</span><span class="o">-&gt;</span><span class="n">fid</span><span class="p">.</span><span class="n">vid</span><span class="p">);</span>
	<span class="n">bp</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">vnode</span><span class="o">-&gt;</span><span class="n">fid</span><span class="p">.</span><span class="n">vnode</span><span class="p">);</span>
	<span class="n">bp</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">vnode</span><span class="o">-&gt;</span><span class="n">fid</span><span class="p">.</span><span class="n">unique</span><span class="p">);</span>
	<span class="n">bp</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">offset</span><span class="p">);</span>
	<span class="n">bp</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">length</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">afs_make_call</span><span class="p">(</span><span class="o">&amp;</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span> <span class="n">call</span><span class="p">,</span> <span class="n">GFP_NOFS</span><span class="p">,</span> <span class="n">wait_mode</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * deliver reply data to an FS.GiveUpCallBacks</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">afs_deliver_fs_give_up_callbacks</span><span class="p">(</span><span class="k">struct</span> <span class="n">afs_call</span> <span class="o">*</span><span class="n">call</span><span class="p">,</span>
					    <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="n">bool</span> <span class="n">last</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">_enter</span><span class="p">(</span><span class="s">&quot;,{%u},%d&quot;</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span> <span class="n">last</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBADMSG</span><span class="p">;</span> <span class="cm">/* shouldn&#39;t be any reply data */</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * FS.GiveUpCallBacks operation type</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">afs_call_type</span> <span class="n">afs_RXFSGiveUpCallBacks</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;FS.GiveUpCallBacks&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">deliver</span>	<span class="o">=</span> <span class="n">afs_deliver_fs_give_up_callbacks</span><span class="p">,</span>
	<span class="p">.</span><span class="n">abort_to_error</span>	<span class="o">=</span> <span class="n">afs_abort_to_error</span><span class="p">,</span>
	<span class="p">.</span><span class="n">destructor</span>	<span class="o">=</span> <span class="n">afs_flat_call_destructor</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * give up a set of callbacks</span>
<span class="cm"> * - the callbacks are held in the server-&gt;cb_break ring</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">afs_fs_give_up_callbacks</span><span class="p">(</span><span class="k">struct</span> <span class="n">afs_server</span> <span class="o">*</span><span class="n">server</span><span class="p">,</span>
			     <span class="k">const</span> <span class="k">struct</span> <span class="n">afs_wait_mode</span> <span class="o">*</span><span class="n">wait_mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">afs_call</span> <span class="o">*</span><span class="n">call</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">ncallbacks</span><span class="p">;</span>
	<span class="n">__be32</span> <span class="o">*</span><span class="n">bp</span><span class="p">,</span> <span class="o">*</span><span class="n">tp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">loop</span><span class="p">;</span>

	<span class="n">ncallbacks</span> <span class="o">=</span> <span class="n">CIRC_CNT</span><span class="p">(</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">cb_break_head</span><span class="p">,</span> <span class="n">server</span><span class="o">-&gt;</span><span class="n">cb_break_tail</span><span class="p">,</span>
			      <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">cb_break</span><span class="p">));</span>

	<span class="n">_enter</span><span class="p">(</span><span class="s">&quot;{%zu},&quot;</span><span class="p">,</span> <span class="n">ncallbacks</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ncallbacks</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ncallbacks</span> <span class="o">&gt;</span> <span class="n">AFSCBMAX</span><span class="p">)</span>
		<span class="n">ncallbacks</span> <span class="o">=</span> <span class="n">AFSCBMAX</span><span class="p">;</span>

	<span class="n">_debug</span><span class="p">(</span><span class="s">&quot;break %zu callbacks&quot;</span><span class="p">,</span> <span class="n">ncallbacks</span><span class="p">);</span>

	<span class="n">call</span> <span class="o">=</span> <span class="n">afs_alloc_flat_call</span><span class="p">(</span><span class="o">&amp;</span><span class="n">afs_RXFSGiveUpCallBacks</span><span class="p">,</span>
				   <span class="mi">12</span> <span class="o">+</span> <span class="n">ncallbacks</span> <span class="o">*</span> <span class="mi">6</span> <span class="o">*</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">call</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">call</span><span class="o">-&gt;</span><span class="n">service_id</span> <span class="o">=</span> <span class="n">FS_SERVICE</span><span class="p">;</span>
	<span class="n">call</span><span class="o">-&gt;</span><span class="n">port</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="n">AFS_FS_PORT</span><span class="p">);</span>

	<span class="cm">/* marshall the parameters */</span>
	<span class="n">bp</span> <span class="o">=</span> <span class="n">call</span><span class="o">-&gt;</span><span class="n">request</span><span class="p">;</span>
	<span class="n">tp</span> <span class="o">=</span> <span class="n">bp</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">ncallbacks</span> <span class="o">*</span> <span class="mi">3</span><span class="p">;</span>
	<span class="o">*</span><span class="n">bp</span><span class="o">++</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">FSGIVEUPCALLBACKS</span><span class="p">);</span>
	<span class="o">*</span><span class="n">bp</span><span class="o">++</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">ncallbacks</span><span class="p">);</span>
	<span class="o">*</span><span class="n">tp</span><span class="o">++</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">ncallbacks</span><span class="p">);</span>

	<span class="n">atomic_sub</span><span class="p">(</span><span class="n">ncallbacks</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">cb_break_n</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">loop</span> <span class="o">=</span> <span class="n">ncallbacks</span><span class="p">;</span> <span class="n">loop</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">;</span> <span class="n">loop</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">afs_callback</span> <span class="o">*</span><span class="n">cb</span> <span class="o">=</span>
			<span class="o">&amp;</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">cb_break</span><span class="p">[</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">cb_break_tail</span><span class="p">];</span>

		<span class="o">*</span><span class="n">bp</span><span class="o">++</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">cb</span><span class="o">-&gt;</span><span class="n">fid</span><span class="p">.</span><span class="n">vid</span><span class="p">);</span>
		<span class="o">*</span><span class="n">bp</span><span class="o">++</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">cb</span><span class="o">-&gt;</span><span class="n">fid</span><span class="p">.</span><span class="n">vnode</span><span class="p">);</span>
		<span class="o">*</span><span class="n">bp</span><span class="o">++</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">cb</span><span class="o">-&gt;</span><span class="n">fid</span><span class="p">.</span><span class="n">unique</span><span class="p">);</span>
		<span class="o">*</span><span class="n">tp</span><span class="o">++</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">cb</span><span class="o">-&gt;</span><span class="n">version</span><span class="p">);</span>
		<span class="o">*</span><span class="n">tp</span><span class="o">++</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">cb</span><span class="o">-&gt;</span><span class="n">expiry</span><span class="p">);</span>
		<span class="o">*</span><span class="n">tp</span><span class="o">++</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">cb</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">);</span>
		<span class="n">smp_mb</span><span class="p">();</span>
		<span class="n">server</span><span class="o">-&gt;</span><span class="n">cb_break_tail</span> <span class="o">=</span>
			<span class="p">(</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">cb_break_tail</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span>
			<span class="p">(</span><span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">cb_break</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">ASSERT</span><span class="p">(</span><span class="n">ncallbacks</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">wake_up_nr</span><span class="p">(</span><span class="o">&amp;</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">cb_break_waitq</span><span class="p">,</span> <span class="n">ncallbacks</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">afs_make_call</span><span class="p">(</span><span class="o">&amp;</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span> <span class="n">call</span><span class="p">,</span> <span class="n">GFP_NOFS</span><span class="p">,</span> <span class="n">wait_mode</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * deliver reply data to an FS.CreateFile or an FS.MakeDir</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">afs_deliver_fs_create_vnode</span><span class="p">(</span><span class="k">struct</span> <span class="n">afs_call</span> <span class="o">*</span><span class="n">call</span><span class="p">,</span>
				       <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="n">bool</span> <span class="n">last</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">afs_vnode</span> <span class="o">*</span><span class="n">vnode</span> <span class="o">=</span> <span class="n">call</span><span class="o">-&gt;</span><span class="n">reply</span><span class="p">;</span>
	<span class="k">const</span> <span class="n">__be32</span> <span class="o">*</span><span class="n">bp</span><span class="p">;</span>

	<span class="n">_enter</span><span class="p">(</span><span class="s">&quot;{%u},{%u},%d&quot;</span><span class="p">,</span> <span class="n">call</span><span class="o">-&gt;</span><span class="n">unmarshall</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span> <span class="n">last</span><span class="p">);</span>

	<span class="n">afs_transfer_reply</span><span class="p">(</span><span class="n">call</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">last</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">call</span><span class="o">-&gt;</span><span class="n">reply_size</span> <span class="o">!=</span> <span class="n">call</span><span class="o">-&gt;</span><span class="n">reply_max</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBADMSG</span><span class="p">;</span>

	<span class="cm">/* unmarshall the reply once we&#39;ve received all of it */</span>
	<span class="n">bp</span> <span class="o">=</span> <span class="n">call</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">;</span>
	<span class="n">xdr_decode_AFSFid</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bp</span><span class="p">,</span> <span class="n">call</span><span class="o">-&gt;</span><span class="n">reply2</span><span class="p">);</span>
	<span class="n">xdr_decode_AFSFetchStatus</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bp</span><span class="p">,</span> <span class="n">call</span><span class="o">-&gt;</span><span class="n">reply3</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">xdr_decode_AFSFetchStatus</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vnode</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">,</span> <span class="n">vnode</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">xdr_decode_AFSCallBack_raw</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bp</span><span class="p">,</span> <span class="n">call</span><span class="o">-&gt;</span><span class="n">reply4</span><span class="p">);</span>
	<span class="cm">/* xdr_decode_AFSVolSync(&amp;bp, call-&gt;replyX); */</span>

	<span class="n">_leave</span><span class="p">(</span><span class="s">&quot; = 0 [done]&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * FS.CreateFile and FS.MakeDir operation type</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">afs_call_type</span> <span class="n">afs_RXFSCreateXXXX</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;FS.CreateXXXX&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">deliver</span>	<span class="o">=</span> <span class="n">afs_deliver_fs_create_vnode</span><span class="p">,</span>
	<span class="p">.</span><span class="n">abort_to_error</span>	<span class="o">=</span> <span class="n">afs_abort_to_error</span><span class="p">,</span>
	<span class="p">.</span><span class="n">destructor</span>	<span class="o">=</span> <span class="n">afs_flat_call_destructor</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * create a file or make a directory</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">afs_fs_create</span><span class="p">(</span><span class="k">struct</span> <span class="n">afs_server</span> <span class="o">*</span><span class="n">server</span><span class="p">,</span>
		  <span class="k">struct</span> <span class="n">key</span> <span class="o">*</span><span class="n">key</span><span class="p">,</span>
		  <span class="k">struct</span> <span class="n">afs_vnode</span> <span class="o">*</span><span class="n">vnode</span><span class="p">,</span>
		  <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span>
		  <span class="n">umode_t</span> <span class="n">mode</span><span class="p">,</span>
		  <span class="k">struct</span> <span class="n">afs_fid</span> <span class="o">*</span><span class="n">newfid</span><span class="p">,</span>
		  <span class="k">struct</span> <span class="n">afs_file_status</span> <span class="o">*</span><span class="n">newstatus</span><span class="p">,</span>
		  <span class="k">struct</span> <span class="n">afs_callback</span> <span class="o">*</span><span class="n">newcb</span><span class="p">,</span>
		  <span class="k">const</span> <span class="k">struct</span> <span class="n">afs_wait_mode</span> <span class="o">*</span><span class="n">wait_mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">afs_call</span> <span class="o">*</span><span class="n">call</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">namesz</span><span class="p">,</span> <span class="n">reqsz</span><span class="p">,</span> <span class="n">padsz</span><span class="p">;</span>
	<span class="n">__be32</span> <span class="o">*</span><span class="n">bp</span><span class="p">;</span>

	<span class="n">_enter</span><span class="p">(</span><span class="s">&quot;&quot;</span><span class="p">);</span>

	<span class="n">namesz</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">name</span><span class="p">);</span>
	<span class="n">padsz</span> <span class="o">=</span> <span class="p">(</span><span class="mi">4</span> <span class="o">-</span> <span class="p">(</span><span class="n">namesz</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">))</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">;</span>
	<span class="n">reqsz</span> <span class="o">=</span> <span class="p">(</span><span class="mi">5</span> <span class="o">*</span> <span class="mi">4</span><span class="p">)</span> <span class="o">+</span> <span class="n">namesz</span> <span class="o">+</span> <span class="n">padsz</span> <span class="o">+</span> <span class="p">(</span><span class="mi">6</span> <span class="o">*</span> <span class="mi">4</span><span class="p">);</span>

	<span class="n">call</span> <span class="o">=</span> <span class="n">afs_alloc_flat_call</span><span class="p">(</span><span class="o">&amp;</span><span class="n">afs_RXFSCreateXXXX</span><span class="p">,</span> <span class="n">reqsz</span><span class="p">,</span>
				   <span class="p">(</span><span class="mi">3</span> <span class="o">+</span> <span class="mi">21</span> <span class="o">+</span> <span class="mi">21</span> <span class="o">+</span> <span class="mi">3</span> <span class="o">+</span> <span class="mi">6</span><span class="p">)</span> <span class="o">*</span> <span class="mi">4</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">call</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">call</span><span class="o">-&gt;</span><span class="n">key</span> <span class="o">=</span> <span class="n">key</span><span class="p">;</span>
	<span class="n">call</span><span class="o">-&gt;</span><span class="n">reply</span> <span class="o">=</span> <span class="n">vnode</span><span class="p">;</span>
	<span class="n">call</span><span class="o">-&gt;</span><span class="n">reply2</span> <span class="o">=</span> <span class="n">newfid</span><span class="p">;</span>
	<span class="n">call</span><span class="o">-&gt;</span><span class="n">reply3</span> <span class="o">=</span> <span class="n">newstatus</span><span class="p">;</span>
	<span class="n">call</span><span class="o">-&gt;</span><span class="n">reply4</span> <span class="o">=</span> <span class="n">newcb</span><span class="p">;</span>
	<span class="n">call</span><span class="o">-&gt;</span><span class="n">service_id</span> <span class="o">=</span> <span class="n">FS_SERVICE</span><span class="p">;</span>
	<span class="n">call</span><span class="o">-&gt;</span><span class="n">port</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="n">AFS_FS_PORT</span><span class="p">);</span>

	<span class="cm">/* marshall the parameters */</span>
	<span class="n">bp</span> <span class="o">=</span> <span class="n">call</span><span class="o">-&gt;</span><span class="n">request</span><span class="p">;</span>
	<span class="o">*</span><span class="n">bp</span><span class="o">++</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">S_ISDIR</span><span class="p">(</span><span class="n">mode</span><span class="p">)</span> <span class="o">?</span> <span class="n">FSMAKEDIR</span> <span class="o">:</span> <span class="n">FSCREATEFILE</span><span class="p">);</span>
	<span class="o">*</span><span class="n">bp</span><span class="o">++</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">vnode</span><span class="o">-&gt;</span><span class="n">fid</span><span class="p">.</span><span class="n">vid</span><span class="p">);</span>
	<span class="o">*</span><span class="n">bp</span><span class="o">++</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">vnode</span><span class="o">-&gt;</span><span class="n">fid</span><span class="p">.</span><span class="n">vnode</span><span class="p">);</span>
	<span class="o">*</span><span class="n">bp</span><span class="o">++</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">vnode</span><span class="o">-&gt;</span><span class="n">fid</span><span class="p">.</span><span class="n">unique</span><span class="p">);</span>
	<span class="o">*</span><span class="n">bp</span><span class="o">++</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">namesz</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">namesz</span><span class="p">);</span>
	<span class="n">bp</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">bp</span> <span class="o">+</span> <span class="n">namesz</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">padsz</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">padsz</span><span class="p">);</span>
		<span class="n">bp</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">bp</span> <span class="o">+</span> <span class="n">padsz</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="o">*</span><span class="n">bp</span><span class="o">++</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">AFS_SET_MODE</span><span class="p">);</span>
	<span class="o">*</span><span class="n">bp</span><span class="o">++</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* mtime */</span>
	<span class="o">*</span><span class="n">bp</span><span class="o">++</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* owner */</span>
	<span class="o">*</span><span class="n">bp</span><span class="o">++</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* group */</span>
	<span class="o">*</span><span class="n">bp</span><span class="o">++</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">mode</span> <span class="o">&amp;</span> <span class="n">S_IALLUGO</span><span class="p">);</span> <span class="cm">/* unix mode */</span>
	<span class="o">*</span><span class="n">bp</span><span class="o">++</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* segment size */</span>

	<span class="k">return</span> <span class="n">afs_make_call</span><span class="p">(</span><span class="o">&amp;</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span> <span class="n">call</span><span class="p">,</span> <span class="n">GFP_NOFS</span><span class="p">,</span> <span class="n">wait_mode</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * deliver reply data to an FS.RemoveFile or FS.RemoveDir</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">afs_deliver_fs_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">afs_call</span> <span class="o">*</span><span class="n">call</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="n">bool</span> <span class="n">last</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">afs_vnode</span> <span class="o">*</span><span class="n">vnode</span> <span class="o">=</span> <span class="n">call</span><span class="o">-&gt;</span><span class="n">reply</span><span class="p">;</span>
	<span class="k">const</span> <span class="n">__be32</span> <span class="o">*</span><span class="n">bp</span><span class="p">;</span>

	<span class="n">_enter</span><span class="p">(</span><span class="s">&quot;{%u},{%u},%d&quot;</span><span class="p">,</span> <span class="n">call</span><span class="o">-&gt;</span><span class="n">unmarshall</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span> <span class="n">last</span><span class="p">);</span>

	<span class="n">afs_transfer_reply</span><span class="p">(</span><span class="n">call</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">last</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">call</span><span class="o">-&gt;</span><span class="n">reply_size</span> <span class="o">!=</span> <span class="n">call</span><span class="o">-&gt;</span><span class="n">reply_max</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBADMSG</span><span class="p">;</span>

	<span class="cm">/* unmarshall the reply once we&#39;ve received all of it */</span>
	<span class="n">bp</span> <span class="o">=</span> <span class="n">call</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">;</span>
	<span class="n">xdr_decode_AFSFetchStatus</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vnode</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">,</span> <span class="n">vnode</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="cm">/* xdr_decode_AFSVolSync(&amp;bp, call-&gt;replyX); */</span>

	<span class="n">_leave</span><span class="p">(</span><span class="s">&quot; = 0 [done]&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * FS.RemoveDir/FS.RemoveFile operation type</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">afs_call_type</span> <span class="n">afs_RXFSRemoveXXXX</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;FS.RemoveXXXX&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">deliver</span>	<span class="o">=</span> <span class="n">afs_deliver_fs_remove</span><span class="p">,</span>
	<span class="p">.</span><span class="n">abort_to_error</span>	<span class="o">=</span> <span class="n">afs_abort_to_error</span><span class="p">,</span>
	<span class="p">.</span><span class="n">destructor</span>	<span class="o">=</span> <span class="n">afs_flat_call_destructor</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * remove a file or directory</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">afs_fs_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">afs_server</span> <span class="o">*</span><span class="n">server</span><span class="p">,</span>
		  <span class="k">struct</span> <span class="n">key</span> <span class="o">*</span><span class="n">key</span><span class="p">,</span>
		  <span class="k">struct</span> <span class="n">afs_vnode</span> <span class="o">*</span><span class="n">vnode</span><span class="p">,</span>
		  <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span>
		  <span class="n">bool</span> <span class="n">isdir</span><span class="p">,</span>
		  <span class="k">const</span> <span class="k">struct</span> <span class="n">afs_wait_mode</span> <span class="o">*</span><span class="n">wait_mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">afs_call</span> <span class="o">*</span><span class="n">call</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">namesz</span><span class="p">,</span> <span class="n">reqsz</span><span class="p">,</span> <span class="n">padsz</span><span class="p">;</span>
	<span class="n">__be32</span> <span class="o">*</span><span class="n">bp</span><span class="p">;</span>

	<span class="n">_enter</span><span class="p">(</span><span class="s">&quot;&quot;</span><span class="p">);</span>

	<span class="n">namesz</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">name</span><span class="p">);</span>
	<span class="n">padsz</span> <span class="o">=</span> <span class="p">(</span><span class="mi">4</span> <span class="o">-</span> <span class="p">(</span><span class="n">namesz</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">))</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">;</span>
	<span class="n">reqsz</span> <span class="o">=</span> <span class="p">(</span><span class="mi">5</span> <span class="o">*</span> <span class="mi">4</span><span class="p">)</span> <span class="o">+</span> <span class="n">namesz</span> <span class="o">+</span> <span class="n">padsz</span><span class="p">;</span>

	<span class="n">call</span> <span class="o">=</span> <span class="n">afs_alloc_flat_call</span><span class="p">(</span><span class="o">&amp;</span><span class="n">afs_RXFSRemoveXXXX</span><span class="p">,</span> <span class="n">reqsz</span><span class="p">,</span> <span class="p">(</span><span class="mi">21</span> <span class="o">+</span> <span class="mi">6</span><span class="p">)</span> <span class="o">*</span> <span class="mi">4</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">call</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">call</span><span class="o">-&gt;</span><span class="n">key</span> <span class="o">=</span> <span class="n">key</span><span class="p">;</span>
	<span class="n">call</span><span class="o">-&gt;</span><span class="n">reply</span> <span class="o">=</span> <span class="n">vnode</span><span class="p">;</span>
	<span class="n">call</span><span class="o">-&gt;</span><span class="n">service_id</span> <span class="o">=</span> <span class="n">FS_SERVICE</span><span class="p">;</span>
	<span class="n">call</span><span class="o">-&gt;</span><span class="n">port</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="n">AFS_FS_PORT</span><span class="p">);</span>

	<span class="cm">/* marshall the parameters */</span>
	<span class="n">bp</span> <span class="o">=</span> <span class="n">call</span><span class="o">-&gt;</span><span class="n">request</span><span class="p">;</span>
	<span class="o">*</span><span class="n">bp</span><span class="o">++</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">isdir</span> <span class="o">?</span> <span class="n">FSREMOVEDIR</span> <span class="o">:</span> <span class="n">FSREMOVEFILE</span><span class="p">);</span>
	<span class="o">*</span><span class="n">bp</span><span class="o">++</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">vnode</span><span class="o">-&gt;</span><span class="n">fid</span><span class="p">.</span><span class="n">vid</span><span class="p">);</span>
	<span class="o">*</span><span class="n">bp</span><span class="o">++</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">vnode</span><span class="o">-&gt;</span><span class="n">fid</span><span class="p">.</span><span class="n">vnode</span><span class="p">);</span>
	<span class="o">*</span><span class="n">bp</span><span class="o">++</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">vnode</span><span class="o">-&gt;</span><span class="n">fid</span><span class="p">.</span><span class="n">unique</span><span class="p">);</span>
	<span class="o">*</span><span class="n">bp</span><span class="o">++</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">namesz</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">namesz</span><span class="p">);</span>
	<span class="n">bp</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">bp</span> <span class="o">+</span> <span class="n">namesz</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">padsz</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">padsz</span><span class="p">);</span>
		<span class="n">bp</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">bp</span> <span class="o">+</span> <span class="n">padsz</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">afs_make_call</span><span class="p">(</span><span class="o">&amp;</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span> <span class="n">call</span><span class="p">,</span> <span class="n">GFP_NOFS</span><span class="p">,</span> <span class="n">wait_mode</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * deliver reply data to an FS.Link</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">afs_deliver_fs_link</span><span class="p">(</span><span class="k">struct</span> <span class="n">afs_call</span> <span class="o">*</span><span class="n">call</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="n">bool</span> <span class="n">last</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">afs_vnode</span> <span class="o">*</span><span class="n">dvnode</span> <span class="o">=</span> <span class="n">call</span><span class="o">-&gt;</span><span class="n">reply</span><span class="p">,</span> <span class="o">*</span><span class="n">vnode</span> <span class="o">=</span> <span class="n">call</span><span class="o">-&gt;</span><span class="n">reply2</span><span class="p">;</span>
	<span class="k">const</span> <span class="n">__be32</span> <span class="o">*</span><span class="n">bp</span><span class="p">;</span>

	<span class="n">_enter</span><span class="p">(</span><span class="s">&quot;{%u},{%u},%d&quot;</span><span class="p">,</span> <span class="n">call</span><span class="o">-&gt;</span><span class="n">unmarshall</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span> <span class="n">last</span><span class="p">);</span>

	<span class="n">afs_transfer_reply</span><span class="p">(</span><span class="n">call</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">last</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">call</span><span class="o">-&gt;</span><span class="n">reply_size</span> <span class="o">!=</span> <span class="n">call</span><span class="o">-&gt;</span><span class="n">reply_max</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBADMSG</span><span class="p">;</span>

	<span class="cm">/* unmarshall the reply once we&#39;ve received all of it */</span>
	<span class="n">bp</span> <span class="o">=</span> <span class="n">call</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">;</span>
	<span class="n">xdr_decode_AFSFetchStatus</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vnode</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">,</span> <span class="n">vnode</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">xdr_decode_AFSFetchStatus</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dvnode</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">,</span> <span class="n">dvnode</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="cm">/* xdr_decode_AFSVolSync(&amp;bp, call-&gt;replyX); */</span>

	<span class="n">_leave</span><span class="p">(</span><span class="s">&quot; = 0 [done]&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * FS.Link operation type</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">afs_call_type</span> <span class="n">afs_RXFSLink</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;FS.Link&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">deliver</span>	<span class="o">=</span> <span class="n">afs_deliver_fs_link</span><span class="p">,</span>
	<span class="p">.</span><span class="n">abort_to_error</span>	<span class="o">=</span> <span class="n">afs_abort_to_error</span><span class="p">,</span>
	<span class="p">.</span><span class="n">destructor</span>	<span class="o">=</span> <span class="n">afs_flat_call_destructor</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * make a hard link</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">afs_fs_link</span><span class="p">(</span><span class="k">struct</span> <span class="n">afs_server</span> <span class="o">*</span><span class="n">server</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">key</span> <span class="o">*</span><span class="n">key</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">afs_vnode</span> <span class="o">*</span><span class="n">dvnode</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">afs_vnode</span> <span class="o">*</span><span class="n">vnode</span><span class="p">,</span>
		<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span>
		<span class="k">const</span> <span class="k">struct</span> <span class="n">afs_wait_mode</span> <span class="o">*</span><span class="n">wait_mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">afs_call</span> <span class="o">*</span><span class="n">call</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">namesz</span><span class="p">,</span> <span class="n">reqsz</span><span class="p">,</span> <span class="n">padsz</span><span class="p">;</span>
	<span class="n">__be32</span> <span class="o">*</span><span class="n">bp</span><span class="p">;</span>

	<span class="n">_enter</span><span class="p">(</span><span class="s">&quot;&quot;</span><span class="p">);</span>

	<span class="n">namesz</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">name</span><span class="p">);</span>
	<span class="n">padsz</span> <span class="o">=</span> <span class="p">(</span><span class="mi">4</span> <span class="o">-</span> <span class="p">(</span><span class="n">namesz</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">))</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">;</span>
	<span class="n">reqsz</span> <span class="o">=</span> <span class="p">(</span><span class="mi">5</span> <span class="o">*</span> <span class="mi">4</span><span class="p">)</span> <span class="o">+</span> <span class="n">namesz</span> <span class="o">+</span> <span class="n">padsz</span> <span class="o">+</span> <span class="p">(</span><span class="mi">3</span> <span class="o">*</span> <span class="mi">4</span><span class="p">);</span>

	<span class="n">call</span> <span class="o">=</span> <span class="n">afs_alloc_flat_call</span><span class="p">(</span><span class="o">&amp;</span><span class="n">afs_RXFSLink</span><span class="p">,</span> <span class="n">reqsz</span><span class="p">,</span> <span class="p">(</span><span class="mi">21</span> <span class="o">+</span> <span class="mi">21</span> <span class="o">+</span> <span class="mi">6</span><span class="p">)</span> <span class="o">*</span> <span class="mi">4</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">call</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">call</span><span class="o">-&gt;</span><span class="n">key</span> <span class="o">=</span> <span class="n">key</span><span class="p">;</span>
	<span class="n">call</span><span class="o">-&gt;</span><span class="n">reply</span> <span class="o">=</span> <span class="n">dvnode</span><span class="p">;</span>
	<span class="n">call</span><span class="o">-&gt;</span><span class="n">reply2</span> <span class="o">=</span> <span class="n">vnode</span><span class="p">;</span>
	<span class="n">call</span><span class="o">-&gt;</span><span class="n">service_id</span> <span class="o">=</span> <span class="n">FS_SERVICE</span><span class="p">;</span>
	<span class="n">call</span><span class="o">-&gt;</span><span class="n">port</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="n">AFS_FS_PORT</span><span class="p">);</span>

	<span class="cm">/* marshall the parameters */</span>
	<span class="n">bp</span> <span class="o">=</span> <span class="n">call</span><span class="o">-&gt;</span><span class="n">request</span><span class="p">;</span>
	<span class="o">*</span><span class="n">bp</span><span class="o">++</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">FSLINK</span><span class="p">);</span>
	<span class="o">*</span><span class="n">bp</span><span class="o">++</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">dvnode</span><span class="o">-&gt;</span><span class="n">fid</span><span class="p">.</span><span class="n">vid</span><span class="p">);</span>
	<span class="o">*</span><span class="n">bp</span><span class="o">++</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">dvnode</span><span class="o">-&gt;</span><span class="n">fid</span><span class="p">.</span><span class="n">vnode</span><span class="p">);</span>
	<span class="o">*</span><span class="n">bp</span><span class="o">++</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">dvnode</span><span class="o">-&gt;</span><span class="n">fid</span><span class="p">.</span><span class="n">unique</span><span class="p">);</span>
	<span class="o">*</span><span class="n">bp</span><span class="o">++</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">namesz</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">namesz</span><span class="p">);</span>
	<span class="n">bp</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">bp</span> <span class="o">+</span> <span class="n">namesz</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">padsz</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">padsz</span><span class="p">);</span>
		<span class="n">bp</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">bp</span> <span class="o">+</span> <span class="n">padsz</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="o">*</span><span class="n">bp</span><span class="o">++</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">vnode</span><span class="o">-&gt;</span><span class="n">fid</span><span class="p">.</span><span class="n">vid</span><span class="p">);</span>
	<span class="o">*</span><span class="n">bp</span><span class="o">++</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">vnode</span><span class="o">-&gt;</span><span class="n">fid</span><span class="p">.</span><span class="n">vnode</span><span class="p">);</span>
	<span class="o">*</span><span class="n">bp</span><span class="o">++</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">vnode</span><span class="o">-&gt;</span><span class="n">fid</span><span class="p">.</span><span class="n">unique</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">afs_make_call</span><span class="p">(</span><span class="o">&amp;</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span> <span class="n">call</span><span class="p">,</span> <span class="n">GFP_NOFS</span><span class="p">,</span> <span class="n">wait_mode</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * deliver reply data to an FS.Symlink</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">afs_deliver_fs_symlink</span><span class="p">(</span><span class="k">struct</span> <span class="n">afs_call</span> <span class="o">*</span><span class="n">call</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="n">bool</span> <span class="n">last</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">afs_vnode</span> <span class="o">*</span><span class="n">vnode</span> <span class="o">=</span> <span class="n">call</span><span class="o">-&gt;</span><span class="n">reply</span><span class="p">;</span>
	<span class="k">const</span> <span class="n">__be32</span> <span class="o">*</span><span class="n">bp</span><span class="p">;</span>

	<span class="n">_enter</span><span class="p">(</span><span class="s">&quot;{%u},{%u},%d&quot;</span><span class="p">,</span> <span class="n">call</span><span class="o">-&gt;</span><span class="n">unmarshall</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span> <span class="n">last</span><span class="p">);</span>

	<span class="n">afs_transfer_reply</span><span class="p">(</span><span class="n">call</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">last</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">call</span><span class="o">-&gt;</span><span class="n">reply_size</span> <span class="o">!=</span> <span class="n">call</span><span class="o">-&gt;</span><span class="n">reply_max</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBADMSG</span><span class="p">;</span>

	<span class="cm">/* unmarshall the reply once we&#39;ve received all of it */</span>
	<span class="n">bp</span> <span class="o">=</span> <span class="n">call</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">;</span>
	<span class="n">xdr_decode_AFSFid</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bp</span><span class="p">,</span> <span class="n">call</span><span class="o">-&gt;</span><span class="n">reply2</span><span class="p">);</span>
	<span class="n">xdr_decode_AFSFetchStatus</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bp</span><span class="p">,</span> <span class="n">call</span><span class="o">-&gt;</span><span class="n">reply3</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">xdr_decode_AFSFetchStatus</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vnode</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">,</span> <span class="n">vnode</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="cm">/* xdr_decode_AFSVolSync(&amp;bp, call-&gt;replyX); */</span>

	<span class="n">_leave</span><span class="p">(</span><span class="s">&quot; = 0 [done]&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * FS.Symlink operation type</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">afs_call_type</span> <span class="n">afs_RXFSSymlink</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;FS.Symlink&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">deliver</span>	<span class="o">=</span> <span class="n">afs_deliver_fs_symlink</span><span class="p">,</span>
	<span class="p">.</span><span class="n">abort_to_error</span>	<span class="o">=</span> <span class="n">afs_abort_to_error</span><span class="p">,</span>
	<span class="p">.</span><span class="n">destructor</span>	<span class="o">=</span> <span class="n">afs_flat_call_destructor</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * create a symbolic link</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">afs_fs_symlink</span><span class="p">(</span><span class="k">struct</span> <span class="n">afs_server</span> <span class="o">*</span><span class="n">server</span><span class="p">,</span>
		   <span class="k">struct</span> <span class="n">key</span> <span class="o">*</span><span class="n">key</span><span class="p">,</span>
		   <span class="k">struct</span> <span class="n">afs_vnode</span> <span class="o">*</span><span class="n">vnode</span><span class="p">,</span>
		   <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span>
		   <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">contents</span><span class="p">,</span>
		   <span class="k">struct</span> <span class="n">afs_fid</span> <span class="o">*</span><span class="n">newfid</span><span class="p">,</span>
		   <span class="k">struct</span> <span class="n">afs_file_status</span> <span class="o">*</span><span class="n">newstatus</span><span class="p">,</span>
		   <span class="k">const</span> <span class="k">struct</span> <span class="n">afs_wait_mode</span> <span class="o">*</span><span class="n">wait_mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">afs_call</span> <span class="o">*</span><span class="n">call</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">namesz</span><span class="p">,</span> <span class="n">reqsz</span><span class="p">,</span> <span class="n">padsz</span><span class="p">,</span> <span class="n">c_namesz</span><span class="p">,</span> <span class="n">c_padsz</span><span class="p">;</span>
	<span class="n">__be32</span> <span class="o">*</span><span class="n">bp</span><span class="p">;</span>

	<span class="n">_enter</span><span class="p">(</span><span class="s">&quot;&quot;</span><span class="p">);</span>

	<span class="n">namesz</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">name</span><span class="p">);</span>
	<span class="n">padsz</span> <span class="o">=</span> <span class="p">(</span><span class="mi">4</span> <span class="o">-</span> <span class="p">(</span><span class="n">namesz</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">))</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">;</span>

	<span class="n">c_namesz</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">contents</span><span class="p">);</span>
	<span class="n">c_padsz</span> <span class="o">=</span> <span class="p">(</span><span class="mi">4</span> <span class="o">-</span> <span class="p">(</span><span class="n">c_namesz</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">))</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">;</span>

	<span class="n">reqsz</span> <span class="o">=</span> <span class="p">(</span><span class="mi">6</span> <span class="o">*</span> <span class="mi">4</span><span class="p">)</span> <span class="o">+</span> <span class="n">namesz</span> <span class="o">+</span> <span class="n">padsz</span> <span class="o">+</span> <span class="n">c_namesz</span> <span class="o">+</span> <span class="n">c_padsz</span> <span class="o">+</span> <span class="p">(</span><span class="mi">6</span> <span class="o">*</span> <span class="mi">4</span><span class="p">);</span>

	<span class="n">call</span> <span class="o">=</span> <span class="n">afs_alloc_flat_call</span><span class="p">(</span><span class="o">&amp;</span><span class="n">afs_RXFSSymlink</span><span class="p">,</span> <span class="n">reqsz</span><span class="p">,</span>
				   <span class="p">(</span><span class="mi">3</span> <span class="o">+</span> <span class="mi">21</span> <span class="o">+</span> <span class="mi">21</span> <span class="o">+</span> <span class="mi">6</span><span class="p">)</span> <span class="o">*</span> <span class="mi">4</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">call</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">call</span><span class="o">-&gt;</span><span class="n">key</span> <span class="o">=</span> <span class="n">key</span><span class="p">;</span>
	<span class="n">call</span><span class="o">-&gt;</span><span class="n">reply</span> <span class="o">=</span> <span class="n">vnode</span><span class="p">;</span>
	<span class="n">call</span><span class="o">-&gt;</span><span class="n">reply2</span> <span class="o">=</span> <span class="n">newfid</span><span class="p">;</span>
	<span class="n">call</span><span class="o">-&gt;</span><span class="n">reply3</span> <span class="o">=</span> <span class="n">newstatus</span><span class="p">;</span>
	<span class="n">call</span><span class="o">-&gt;</span><span class="n">service_id</span> <span class="o">=</span> <span class="n">FS_SERVICE</span><span class="p">;</span>
	<span class="n">call</span><span class="o">-&gt;</span><span class="n">port</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="n">AFS_FS_PORT</span><span class="p">);</span>

	<span class="cm">/* marshall the parameters */</span>
	<span class="n">bp</span> <span class="o">=</span> <span class="n">call</span><span class="o">-&gt;</span><span class="n">request</span><span class="p">;</span>
	<span class="o">*</span><span class="n">bp</span><span class="o">++</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">FSSYMLINK</span><span class="p">);</span>
	<span class="o">*</span><span class="n">bp</span><span class="o">++</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">vnode</span><span class="o">-&gt;</span><span class="n">fid</span><span class="p">.</span><span class="n">vid</span><span class="p">);</span>
	<span class="o">*</span><span class="n">bp</span><span class="o">++</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">vnode</span><span class="o">-&gt;</span><span class="n">fid</span><span class="p">.</span><span class="n">vnode</span><span class="p">);</span>
	<span class="o">*</span><span class="n">bp</span><span class="o">++</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">vnode</span><span class="o">-&gt;</span><span class="n">fid</span><span class="p">.</span><span class="n">unique</span><span class="p">);</span>
	<span class="o">*</span><span class="n">bp</span><span class="o">++</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">namesz</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">namesz</span><span class="p">);</span>
	<span class="n">bp</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">bp</span> <span class="o">+</span> <span class="n">namesz</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">padsz</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">padsz</span><span class="p">);</span>
		<span class="n">bp</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">bp</span> <span class="o">+</span> <span class="n">padsz</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="o">*</span><span class="n">bp</span><span class="o">++</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">c_namesz</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">contents</span><span class="p">,</span> <span class="n">c_namesz</span><span class="p">);</span>
	<span class="n">bp</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">bp</span> <span class="o">+</span> <span class="n">c_namesz</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">c_padsz</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">c_padsz</span><span class="p">);</span>
		<span class="n">bp</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">bp</span> <span class="o">+</span> <span class="n">c_padsz</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="o">*</span><span class="n">bp</span><span class="o">++</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">AFS_SET_MODE</span><span class="p">);</span>
	<span class="o">*</span><span class="n">bp</span><span class="o">++</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* mtime */</span>
	<span class="o">*</span><span class="n">bp</span><span class="o">++</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* owner */</span>
	<span class="o">*</span><span class="n">bp</span><span class="o">++</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* group */</span>
	<span class="o">*</span><span class="n">bp</span><span class="o">++</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">S_IRWXUGO</span><span class="p">);</span> <span class="cm">/* unix mode */</span>
	<span class="o">*</span><span class="n">bp</span><span class="o">++</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* segment size */</span>

	<span class="k">return</span> <span class="n">afs_make_call</span><span class="p">(</span><span class="o">&amp;</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span> <span class="n">call</span><span class="p">,</span> <span class="n">GFP_NOFS</span><span class="p">,</span> <span class="n">wait_mode</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * deliver reply data to an FS.Rename</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">afs_deliver_fs_rename</span><span class="p">(</span><span class="k">struct</span> <span class="n">afs_call</span> <span class="o">*</span><span class="n">call</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="n">bool</span> <span class="n">last</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">afs_vnode</span> <span class="o">*</span><span class="n">orig_dvnode</span> <span class="o">=</span> <span class="n">call</span><span class="o">-&gt;</span><span class="n">reply</span><span class="p">,</span> <span class="o">*</span><span class="n">new_dvnode</span> <span class="o">=</span> <span class="n">call</span><span class="o">-&gt;</span><span class="n">reply2</span><span class="p">;</span>
	<span class="k">const</span> <span class="n">__be32</span> <span class="o">*</span><span class="n">bp</span><span class="p">;</span>

	<span class="n">_enter</span><span class="p">(</span><span class="s">&quot;{%u},{%u},%d&quot;</span><span class="p">,</span> <span class="n">call</span><span class="o">-&gt;</span><span class="n">unmarshall</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span> <span class="n">last</span><span class="p">);</span>

	<span class="n">afs_transfer_reply</span><span class="p">(</span><span class="n">call</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">last</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">call</span><span class="o">-&gt;</span><span class="n">reply_size</span> <span class="o">!=</span> <span class="n">call</span><span class="o">-&gt;</span><span class="n">reply_max</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBADMSG</span><span class="p">;</span>

	<span class="cm">/* unmarshall the reply once we&#39;ve received all of it */</span>
	<span class="n">bp</span> <span class="o">=</span> <span class="n">call</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">;</span>
	<span class="n">xdr_decode_AFSFetchStatus</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">orig_dvnode</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">,</span> <span class="n">orig_dvnode</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">new_dvnode</span> <span class="o">!=</span> <span class="n">orig_dvnode</span><span class="p">)</span>
		<span class="n">xdr_decode_AFSFetchStatus</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">new_dvnode</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">,</span> <span class="n">new_dvnode</span><span class="p">,</span>
					  <span class="nb">NULL</span><span class="p">);</span>
	<span class="cm">/* xdr_decode_AFSVolSync(&amp;bp, call-&gt;replyX); */</span>

	<span class="n">_leave</span><span class="p">(</span><span class="s">&quot; = 0 [done]&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * FS.Rename operation type</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">afs_call_type</span> <span class="n">afs_RXFSRename</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;FS.Rename&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">deliver</span>	<span class="o">=</span> <span class="n">afs_deliver_fs_rename</span><span class="p">,</span>
	<span class="p">.</span><span class="n">abort_to_error</span>	<span class="o">=</span> <span class="n">afs_abort_to_error</span><span class="p">,</span>
	<span class="p">.</span><span class="n">destructor</span>	<span class="o">=</span> <span class="n">afs_flat_call_destructor</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * create a symbolic link</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">afs_fs_rename</span><span class="p">(</span><span class="k">struct</span> <span class="n">afs_server</span> <span class="o">*</span><span class="n">server</span><span class="p">,</span>
		  <span class="k">struct</span> <span class="n">key</span> <span class="o">*</span><span class="n">key</span><span class="p">,</span>
		  <span class="k">struct</span> <span class="n">afs_vnode</span> <span class="o">*</span><span class="n">orig_dvnode</span><span class="p">,</span>
		  <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">orig_name</span><span class="p">,</span>
		  <span class="k">struct</span> <span class="n">afs_vnode</span> <span class="o">*</span><span class="n">new_dvnode</span><span class="p">,</span>
		  <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">new_name</span><span class="p">,</span>
		  <span class="k">const</span> <span class="k">struct</span> <span class="n">afs_wait_mode</span> <span class="o">*</span><span class="n">wait_mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">afs_call</span> <span class="o">*</span><span class="n">call</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">reqsz</span><span class="p">,</span> <span class="n">o_namesz</span><span class="p">,</span> <span class="n">o_padsz</span><span class="p">,</span> <span class="n">n_namesz</span><span class="p">,</span> <span class="n">n_padsz</span><span class="p">;</span>
	<span class="n">__be32</span> <span class="o">*</span><span class="n">bp</span><span class="p">;</span>

	<span class="n">_enter</span><span class="p">(</span><span class="s">&quot;&quot;</span><span class="p">);</span>

	<span class="n">o_namesz</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">orig_name</span><span class="p">);</span>
	<span class="n">o_padsz</span> <span class="o">=</span> <span class="p">(</span><span class="mi">4</span> <span class="o">-</span> <span class="p">(</span><span class="n">o_namesz</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">))</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">;</span>

	<span class="n">n_namesz</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">new_name</span><span class="p">);</span>
	<span class="n">n_padsz</span> <span class="o">=</span> <span class="p">(</span><span class="mi">4</span> <span class="o">-</span> <span class="p">(</span><span class="n">n_namesz</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">))</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">;</span>

	<span class="n">reqsz</span> <span class="o">=</span> <span class="p">(</span><span class="mi">4</span> <span class="o">*</span> <span class="mi">4</span><span class="p">)</span> <span class="o">+</span>
		<span class="mi">4</span> <span class="o">+</span> <span class="n">o_namesz</span> <span class="o">+</span> <span class="n">o_padsz</span> <span class="o">+</span>
		<span class="p">(</span><span class="mi">3</span> <span class="o">*</span> <span class="mi">4</span><span class="p">)</span> <span class="o">+</span>
		<span class="mi">4</span> <span class="o">+</span> <span class="n">n_namesz</span> <span class="o">+</span> <span class="n">n_padsz</span><span class="p">;</span>

	<span class="n">call</span> <span class="o">=</span> <span class="n">afs_alloc_flat_call</span><span class="p">(</span><span class="o">&amp;</span><span class="n">afs_RXFSRename</span><span class="p">,</span> <span class="n">reqsz</span><span class="p">,</span> <span class="p">(</span><span class="mi">21</span> <span class="o">+</span> <span class="mi">21</span> <span class="o">+</span> <span class="mi">6</span><span class="p">)</span> <span class="o">*</span> <span class="mi">4</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">call</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">call</span><span class="o">-&gt;</span><span class="n">key</span> <span class="o">=</span> <span class="n">key</span><span class="p">;</span>
	<span class="n">call</span><span class="o">-&gt;</span><span class="n">reply</span> <span class="o">=</span> <span class="n">orig_dvnode</span><span class="p">;</span>
	<span class="n">call</span><span class="o">-&gt;</span><span class="n">reply2</span> <span class="o">=</span> <span class="n">new_dvnode</span><span class="p">;</span>
	<span class="n">call</span><span class="o">-&gt;</span><span class="n">service_id</span> <span class="o">=</span> <span class="n">FS_SERVICE</span><span class="p">;</span>
	<span class="n">call</span><span class="o">-&gt;</span><span class="n">port</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="n">AFS_FS_PORT</span><span class="p">);</span>

	<span class="cm">/* marshall the parameters */</span>
	<span class="n">bp</span> <span class="o">=</span> <span class="n">call</span><span class="o">-&gt;</span><span class="n">request</span><span class="p">;</span>
	<span class="o">*</span><span class="n">bp</span><span class="o">++</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">FSRENAME</span><span class="p">);</span>
	<span class="o">*</span><span class="n">bp</span><span class="o">++</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">orig_dvnode</span><span class="o">-&gt;</span><span class="n">fid</span><span class="p">.</span><span class="n">vid</span><span class="p">);</span>
	<span class="o">*</span><span class="n">bp</span><span class="o">++</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">orig_dvnode</span><span class="o">-&gt;</span><span class="n">fid</span><span class="p">.</span><span class="n">vnode</span><span class="p">);</span>
	<span class="o">*</span><span class="n">bp</span><span class="o">++</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">orig_dvnode</span><span class="o">-&gt;</span><span class="n">fid</span><span class="p">.</span><span class="n">unique</span><span class="p">);</span>
	<span class="o">*</span><span class="n">bp</span><span class="o">++</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">o_namesz</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">orig_name</span><span class="p">,</span> <span class="n">o_namesz</span><span class="p">);</span>
	<span class="n">bp</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">bp</span> <span class="o">+</span> <span class="n">o_namesz</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">o_padsz</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">o_padsz</span><span class="p">);</span>
		<span class="n">bp</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">bp</span> <span class="o">+</span> <span class="n">o_padsz</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="o">*</span><span class="n">bp</span><span class="o">++</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">new_dvnode</span><span class="o">-&gt;</span><span class="n">fid</span><span class="p">.</span><span class="n">vid</span><span class="p">);</span>
	<span class="o">*</span><span class="n">bp</span><span class="o">++</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">new_dvnode</span><span class="o">-&gt;</span><span class="n">fid</span><span class="p">.</span><span class="n">vnode</span><span class="p">);</span>
	<span class="o">*</span><span class="n">bp</span><span class="o">++</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">new_dvnode</span><span class="o">-&gt;</span><span class="n">fid</span><span class="p">.</span><span class="n">unique</span><span class="p">);</span>
	<span class="o">*</span><span class="n">bp</span><span class="o">++</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">n_namesz</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">new_name</span><span class="p">,</span> <span class="n">n_namesz</span><span class="p">);</span>
	<span class="n">bp</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">bp</span> <span class="o">+</span> <span class="n">n_namesz</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">n_padsz</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">n_padsz</span><span class="p">);</span>
		<span class="n">bp</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">bp</span> <span class="o">+</span> <span class="n">n_padsz</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">afs_make_call</span><span class="p">(</span><span class="o">&amp;</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span> <span class="n">call</span><span class="p">,</span> <span class="n">GFP_NOFS</span><span class="p">,</span> <span class="n">wait_mode</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * deliver reply data to an FS.StoreData</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">afs_deliver_fs_store_data</span><span class="p">(</span><span class="k">struct</span> <span class="n">afs_call</span> <span class="o">*</span><span class="n">call</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="n">bool</span> <span class="n">last</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">afs_vnode</span> <span class="o">*</span><span class="n">vnode</span> <span class="o">=</span> <span class="n">call</span><span class="o">-&gt;</span><span class="n">reply</span><span class="p">;</span>
	<span class="k">const</span> <span class="n">__be32</span> <span class="o">*</span><span class="n">bp</span><span class="p">;</span>

	<span class="n">_enter</span><span class="p">(</span><span class="s">&quot;,,%u&quot;</span><span class="p">,</span> <span class="n">last</span><span class="p">);</span>

	<span class="n">afs_transfer_reply</span><span class="p">(</span><span class="n">call</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">last</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">_leave</span><span class="p">(</span><span class="s">&quot; = 0 [more]&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">call</span><span class="o">-&gt;</span><span class="n">reply_size</span> <span class="o">!=</span> <span class="n">call</span><span class="o">-&gt;</span><span class="n">reply_max</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">_leave</span><span class="p">(</span><span class="s">&quot; = -EBADMSG [%u != %u]&quot;</span><span class="p">,</span>
		       <span class="n">call</span><span class="o">-&gt;</span><span class="n">reply_size</span><span class="p">,</span> <span class="n">call</span><span class="o">-&gt;</span><span class="n">reply_max</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBADMSG</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* unmarshall the reply once we&#39;ve received all of it */</span>
	<span class="n">bp</span> <span class="o">=</span> <span class="n">call</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">;</span>
	<span class="n">xdr_decode_AFSFetchStatus</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vnode</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">,</span> <span class="n">vnode</span><span class="p">,</span>
				  <span class="o">&amp;</span><span class="n">call</span><span class="o">-&gt;</span><span class="n">store_version</span><span class="p">);</span>
	<span class="cm">/* xdr_decode_AFSVolSync(&amp;bp, call-&gt;replyX); */</span>

	<span class="n">afs_pages_written_back</span><span class="p">(</span><span class="n">vnode</span><span class="p">,</span> <span class="n">call</span><span class="p">);</span>

	<span class="n">_leave</span><span class="p">(</span><span class="s">&quot; = 0 [done]&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * FS.StoreData operation type</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">afs_call_type</span> <span class="n">afs_RXFSStoreData</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;FS.StoreData&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">deliver</span>	<span class="o">=</span> <span class="n">afs_deliver_fs_store_data</span><span class="p">,</span>
	<span class="p">.</span><span class="n">abort_to_error</span>	<span class="o">=</span> <span class="n">afs_abort_to_error</span><span class="p">,</span>
	<span class="p">.</span><span class="n">destructor</span>	<span class="o">=</span> <span class="n">afs_flat_call_destructor</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">afs_call_type</span> <span class="n">afs_RXFSStoreData64</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;FS.StoreData64&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">deliver</span>	<span class="o">=</span> <span class="n">afs_deliver_fs_store_data</span><span class="p">,</span>
	<span class="p">.</span><span class="n">abort_to_error</span>	<span class="o">=</span> <span class="n">afs_abort_to_error</span><span class="p">,</span>
	<span class="p">.</span><span class="n">destructor</span>	<span class="o">=</span> <span class="n">afs_flat_call_destructor</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * store a set of pages to a very large file</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">afs_fs_store_data64</span><span class="p">(</span><span class="k">struct</span> <span class="n">afs_server</span> <span class="o">*</span><span class="n">server</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">afs_writeback</span> <span class="o">*</span><span class="n">wb</span><span class="p">,</span>
			       <span class="n">pgoff_t</span> <span class="n">first</span><span class="p">,</span> <span class="n">pgoff_t</span> <span class="n">last</span><span class="p">,</span>
			       <span class="kt">unsigned</span> <span class="n">offset</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">to</span><span class="p">,</span>
			       <span class="n">loff_t</span> <span class="n">size</span><span class="p">,</span> <span class="n">loff_t</span> <span class="n">pos</span><span class="p">,</span> <span class="n">loff_t</span> <span class="n">i_size</span><span class="p">,</span>
			       <span class="k">const</span> <span class="k">struct</span> <span class="n">afs_wait_mode</span> <span class="o">*</span><span class="n">wait_mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">afs_vnode</span> <span class="o">*</span><span class="n">vnode</span> <span class="o">=</span> <span class="n">wb</span><span class="o">-&gt;</span><span class="n">vnode</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">afs_call</span> <span class="o">*</span><span class="n">call</span><span class="p">;</span>
	<span class="n">__be32</span> <span class="o">*</span><span class="n">bp</span><span class="p">;</span>

	<span class="n">_enter</span><span class="p">(</span><span class="s">&quot;,%x,{%x:%u},,&quot;</span><span class="p">,</span>
	       <span class="n">key_serial</span><span class="p">(</span><span class="n">wb</span><span class="o">-&gt;</span><span class="n">key</span><span class="p">),</span> <span class="n">vnode</span><span class="o">-&gt;</span><span class="n">fid</span><span class="p">.</span><span class="n">vid</span><span class="p">,</span> <span class="n">vnode</span><span class="o">-&gt;</span><span class="n">fid</span><span class="p">.</span><span class="n">vnode</span><span class="p">);</span>

	<span class="n">call</span> <span class="o">=</span> <span class="n">afs_alloc_flat_call</span><span class="p">(</span><span class="o">&amp;</span><span class="n">afs_RXFSStoreData64</span><span class="p">,</span>
				   <span class="p">(</span><span class="mi">4</span> <span class="o">+</span> <span class="mi">6</span> <span class="o">+</span> <span class="mi">3</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="mi">4</span><span class="p">,</span>
				   <span class="p">(</span><span class="mi">21</span> <span class="o">+</span> <span class="mi">6</span><span class="p">)</span> <span class="o">*</span> <span class="mi">4</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">call</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">call</span><span class="o">-&gt;</span><span class="n">wb</span> <span class="o">=</span> <span class="n">wb</span><span class="p">;</span>
	<span class="n">call</span><span class="o">-&gt;</span><span class="n">key</span> <span class="o">=</span> <span class="n">wb</span><span class="o">-&gt;</span><span class="n">key</span><span class="p">;</span>
	<span class="n">call</span><span class="o">-&gt;</span><span class="n">reply</span> <span class="o">=</span> <span class="n">vnode</span><span class="p">;</span>
	<span class="n">call</span><span class="o">-&gt;</span><span class="n">service_id</span> <span class="o">=</span> <span class="n">FS_SERVICE</span><span class="p">;</span>
	<span class="n">call</span><span class="o">-&gt;</span><span class="n">port</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="n">AFS_FS_PORT</span><span class="p">);</span>
	<span class="n">call</span><span class="o">-&gt;</span><span class="n">mapping</span> <span class="o">=</span> <span class="n">vnode</span><span class="o">-&gt;</span><span class="n">vfs_inode</span><span class="p">.</span><span class="n">i_mapping</span><span class="p">;</span>
	<span class="n">call</span><span class="o">-&gt;</span><span class="n">first</span> <span class="o">=</span> <span class="n">first</span><span class="p">;</span>
	<span class="n">call</span><span class="o">-&gt;</span><span class="n">last</span> <span class="o">=</span> <span class="n">last</span><span class="p">;</span>
	<span class="n">call</span><span class="o">-&gt;</span><span class="n">first_offset</span> <span class="o">=</span> <span class="n">offset</span><span class="p">;</span>
	<span class="n">call</span><span class="o">-&gt;</span><span class="n">last_to</span> <span class="o">=</span> <span class="n">to</span><span class="p">;</span>
	<span class="n">call</span><span class="o">-&gt;</span><span class="n">send_pages</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="n">call</span><span class="o">-&gt;</span><span class="n">store_version</span> <span class="o">=</span> <span class="n">vnode</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">.</span><span class="n">data_version</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* marshall the parameters */</span>
	<span class="n">bp</span> <span class="o">=</span> <span class="n">call</span><span class="o">-&gt;</span><span class="n">request</span><span class="p">;</span>
	<span class="o">*</span><span class="n">bp</span><span class="o">++</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">FSSTOREDATA64</span><span class="p">);</span>
	<span class="o">*</span><span class="n">bp</span><span class="o">++</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">vnode</span><span class="o">-&gt;</span><span class="n">fid</span><span class="p">.</span><span class="n">vid</span><span class="p">);</span>
	<span class="o">*</span><span class="n">bp</span><span class="o">++</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">vnode</span><span class="o">-&gt;</span><span class="n">fid</span><span class="p">.</span><span class="n">vnode</span><span class="p">);</span>
	<span class="o">*</span><span class="n">bp</span><span class="o">++</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">vnode</span><span class="o">-&gt;</span><span class="n">fid</span><span class="p">.</span><span class="n">unique</span><span class="p">);</span>

	<span class="o">*</span><span class="n">bp</span><span class="o">++</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* mask */</span>
	<span class="o">*</span><span class="n">bp</span><span class="o">++</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* mtime */</span>
	<span class="o">*</span><span class="n">bp</span><span class="o">++</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* owner */</span>
	<span class="o">*</span><span class="n">bp</span><span class="o">++</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* group */</span>
	<span class="o">*</span><span class="n">bp</span><span class="o">++</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* unix mode */</span>
	<span class="o">*</span><span class="n">bp</span><span class="o">++</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* segment size */</span>

	<span class="o">*</span><span class="n">bp</span><span class="o">++</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">pos</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">);</span>
	<span class="o">*</span><span class="n">bp</span><span class="o">++</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">((</span><span class="n">u32</span><span class="p">)</span> <span class="n">pos</span><span class="p">);</span>
	<span class="o">*</span><span class="n">bp</span><span class="o">++</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">size</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">);</span>
	<span class="o">*</span><span class="n">bp</span><span class="o">++</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">((</span><span class="n">u32</span><span class="p">)</span> <span class="n">size</span><span class="p">);</span>
	<span class="o">*</span><span class="n">bp</span><span class="o">++</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">i_size</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">);</span>
	<span class="o">*</span><span class="n">bp</span><span class="o">++</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">((</span><span class="n">u32</span><span class="p">)</span> <span class="n">i_size</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">afs_make_call</span><span class="p">(</span><span class="o">&amp;</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span> <span class="n">call</span><span class="p">,</span> <span class="n">GFP_NOFS</span><span class="p">,</span> <span class="n">wait_mode</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * store a set of pages</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">afs_fs_store_data</span><span class="p">(</span><span class="k">struct</span> <span class="n">afs_server</span> <span class="o">*</span><span class="n">server</span><span class="p">,</span> <span class="k">struct</span> <span class="n">afs_writeback</span> <span class="o">*</span><span class="n">wb</span><span class="p">,</span>
		      <span class="n">pgoff_t</span> <span class="n">first</span><span class="p">,</span> <span class="n">pgoff_t</span> <span class="n">last</span><span class="p">,</span>
		      <span class="kt">unsigned</span> <span class="n">offset</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">to</span><span class="p">,</span>
		      <span class="k">const</span> <span class="k">struct</span> <span class="n">afs_wait_mode</span> <span class="o">*</span><span class="n">wait_mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">afs_vnode</span> <span class="o">*</span><span class="n">vnode</span> <span class="o">=</span> <span class="n">wb</span><span class="o">-&gt;</span><span class="n">vnode</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">afs_call</span> <span class="o">*</span><span class="n">call</span><span class="p">;</span>
	<span class="n">loff_t</span> <span class="n">size</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span> <span class="n">i_size</span><span class="p">;</span>
	<span class="n">__be32</span> <span class="o">*</span><span class="n">bp</span><span class="p">;</span>

	<span class="n">_enter</span><span class="p">(</span><span class="s">&quot;,%x,{%x:%u},,&quot;</span><span class="p">,</span>
	       <span class="n">key_serial</span><span class="p">(</span><span class="n">wb</span><span class="o">-&gt;</span><span class="n">key</span><span class="p">),</span> <span class="n">vnode</span><span class="o">-&gt;</span><span class="n">fid</span><span class="p">.</span><span class="n">vid</span><span class="p">,</span> <span class="n">vnode</span><span class="o">-&gt;</span><span class="n">fid</span><span class="p">.</span><span class="n">vnode</span><span class="p">);</span>

	<span class="n">size</span> <span class="o">=</span> <span class="n">to</span> <span class="o">-</span> <span class="n">offset</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">first</span> <span class="o">!=</span> <span class="n">last</span><span class="p">)</span>
		<span class="n">size</span> <span class="o">+=</span> <span class="p">(</span><span class="n">loff_t</span><span class="p">)(</span><span class="n">last</span> <span class="o">-</span> <span class="n">first</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">PAGE_SHIFT</span><span class="p">;</span>
	<span class="n">pos</span> <span class="o">=</span> <span class="p">(</span><span class="n">loff_t</span><span class="p">)</span><span class="n">first</span> <span class="o">&lt;&lt;</span> <span class="n">PAGE_SHIFT</span><span class="p">;</span>
	<span class="n">pos</span> <span class="o">+=</span> <span class="n">offset</span><span class="p">;</span>

	<span class="n">i_size</span> <span class="o">=</span> <span class="n">i_size_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vnode</span><span class="o">-&gt;</span><span class="n">vfs_inode</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pos</span> <span class="o">+</span> <span class="n">size</span> <span class="o">&gt;</span> <span class="n">i_size</span><span class="p">)</span>
		<span class="n">i_size</span> <span class="o">=</span> <span class="n">size</span> <span class="o">+</span> <span class="n">pos</span><span class="p">;</span>

	<span class="n">_debug</span><span class="p">(</span><span class="s">&quot;size %llx, at %llx, i_size %llx&quot;</span><span class="p">,</span>
	       <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span> <span class="n">size</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span> <span class="n">pos</span><span class="p">,</span>
	       <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span> <span class="n">i_size</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pos</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span> <span class="o">||</span> <span class="n">i_size</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span> <span class="o">||</span> <span class="n">size</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span> <span class="o">||</span> <span class="p">(</span><span class="n">pos</span> <span class="o">+</span> <span class="n">size</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">afs_fs_store_data64</span><span class="p">(</span><span class="n">server</span><span class="p">,</span> <span class="n">wb</span><span class="p">,</span> <span class="n">first</span><span class="p">,</span> <span class="n">last</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">to</span><span class="p">,</span>
					   <span class="n">size</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span> <span class="n">i_size</span><span class="p">,</span> <span class="n">wait_mode</span><span class="p">);</span>

	<span class="n">call</span> <span class="o">=</span> <span class="n">afs_alloc_flat_call</span><span class="p">(</span><span class="o">&amp;</span><span class="n">afs_RXFSStoreData</span><span class="p">,</span>
				   <span class="p">(</span><span class="mi">4</span> <span class="o">+</span> <span class="mi">6</span> <span class="o">+</span> <span class="mi">3</span><span class="p">)</span> <span class="o">*</span> <span class="mi">4</span><span class="p">,</span>
				   <span class="p">(</span><span class="mi">21</span> <span class="o">+</span> <span class="mi">6</span><span class="p">)</span> <span class="o">*</span> <span class="mi">4</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">call</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">call</span><span class="o">-&gt;</span><span class="n">wb</span> <span class="o">=</span> <span class="n">wb</span><span class="p">;</span>
	<span class="n">call</span><span class="o">-&gt;</span><span class="n">key</span> <span class="o">=</span> <span class="n">wb</span><span class="o">-&gt;</span><span class="n">key</span><span class="p">;</span>
	<span class="n">call</span><span class="o">-&gt;</span><span class="n">reply</span> <span class="o">=</span> <span class="n">vnode</span><span class="p">;</span>
	<span class="n">call</span><span class="o">-&gt;</span><span class="n">service_id</span> <span class="o">=</span> <span class="n">FS_SERVICE</span><span class="p">;</span>
	<span class="n">call</span><span class="o">-&gt;</span><span class="n">port</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="n">AFS_FS_PORT</span><span class="p">);</span>
	<span class="n">call</span><span class="o">-&gt;</span><span class="n">mapping</span> <span class="o">=</span> <span class="n">vnode</span><span class="o">-&gt;</span><span class="n">vfs_inode</span><span class="p">.</span><span class="n">i_mapping</span><span class="p">;</span>
	<span class="n">call</span><span class="o">-&gt;</span><span class="n">first</span> <span class="o">=</span> <span class="n">first</span><span class="p">;</span>
	<span class="n">call</span><span class="o">-&gt;</span><span class="n">last</span> <span class="o">=</span> <span class="n">last</span><span class="p">;</span>
	<span class="n">call</span><span class="o">-&gt;</span><span class="n">first_offset</span> <span class="o">=</span> <span class="n">offset</span><span class="p">;</span>
	<span class="n">call</span><span class="o">-&gt;</span><span class="n">last_to</span> <span class="o">=</span> <span class="n">to</span><span class="p">;</span>
	<span class="n">call</span><span class="o">-&gt;</span><span class="n">send_pages</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="n">call</span><span class="o">-&gt;</span><span class="n">store_version</span> <span class="o">=</span> <span class="n">vnode</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">.</span><span class="n">data_version</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* marshall the parameters */</span>
	<span class="n">bp</span> <span class="o">=</span> <span class="n">call</span><span class="o">-&gt;</span><span class="n">request</span><span class="p">;</span>
	<span class="o">*</span><span class="n">bp</span><span class="o">++</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">FSSTOREDATA</span><span class="p">);</span>
	<span class="o">*</span><span class="n">bp</span><span class="o">++</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">vnode</span><span class="o">-&gt;</span><span class="n">fid</span><span class="p">.</span><span class="n">vid</span><span class="p">);</span>
	<span class="o">*</span><span class="n">bp</span><span class="o">++</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">vnode</span><span class="o">-&gt;</span><span class="n">fid</span><span class="p">.</span><span class="n">vnode</span><span class="p">);</span>
	<span class="o">*</span><span class="n">bp</span><span class="o">++</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">vnode</span><span class="o">-&gt;</span><span class="n">fid</span><span class="p">.</span><span class="n">unique</span><span class="p">);</span>

	<span class="o">*</span><span class="n">bp</span><span class="o">++</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* mask */</span>
	<span class="o">*</span><span class="n">bp</span><span class="o">++</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* mtime */</span>
	<span class="o">*</span><span class="n">bp</span><span class="o">++</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* owner */</span>
	<span class="o">*</span><span class="n">bp</span><span class="o">++</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* group */</span>
	<span class="o">*</span><span class="n">bp</span><span class="o">++</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* unix mode */</span>
	<span class="o">*</span><span class="n">bp</span><span class="o">++</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* segment size */</span>

	<span class="o">*</span><span class="n">bp</span><span class="o">++</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">pos</span><span class="p">);</span>
	<span class="o">*</span><span class="n">bp</span><span class="o">++</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">size</span><span class="p">);</span>
	<span class="o">*</span><span class="n">bp</span><span class="o">++</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">i_size</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">afs_make_call</span><span class="p">(</span><span class="o">&amp;</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span> <span class="n">call</span><span class="p">,</span> <span class="n">GFP_NOFS</span><span class="p">,</span> <span class="n">wait_mode</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * deliver reply data to an FS.StoreStatus</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">afs_deliver_fs_store_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">afs_call</span> <span class="o">*</span><span class="n">call</span><span class="p">,</span>
				       <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="n">bool</span> <span class="n">last</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">afs_dataversion_t</span> <span class="o">*</span><span class="n">store_version</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">afs_vnode</span> <span class="o">*</span><span class="n">vnode</span> <span class="o">=</span> <span class="n">call</span><span class="o">-&gt;</span><span class="n">reply</span><span class="p">;</span>
	<span class="k">const</span> <span class="n">__be32</span> <span class="o">*</span><span class="n">bp</span><span class="p">;</span>

	<span class="n">_enter</span><span class="p">(</span><span class="s">&quot;,,%u&quot;</span><span class="p">,</span> <span class="n">last</span><span class="p">);</span>

	<span class="n">afs_transfer_reply</span><span class="p">(</span><span class="n">call</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">last</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">_leave</span><span class="p">(</span><span class="s">&quot; = 0 [more]&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">call</span><span class="o">-&gt;</span><span class="n">reply_size</span> <span class="o">!=</span> <span class="n">call</span><span class="o">-&gt;</span><span class="n">reply_max</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">_leave</span><span class="p">(</span><span class="s">&quot; = -EBADMSG [%u != %u]&quot;</span><span class="p">,</span>
		       <span class="n">call</span><span class="o">-&gt;</span><span class="n">reply_size</span><span class="p">,</span> <span class="n">call</span><span class="o">-&gt;</span><span class="n">reply_max</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBADMSG</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* unmarshall the reply once we&#39;ve received all of it */</span>
	<span class="n">store_version</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">call</span><span class="o">-&gt;</span><span class="n">operation_ID</span> <span class="o">==</span> <span class="n">FSSTOREDATA</span><span class="p">)</span>
		<span class="n">store_version</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">call</span><span class="o">-&gt;</span><span class="n">store_version</span><span class="p">;</span>

	<span class="n">bp</span> <span class="o">=</span> <span class="n">call</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">;</span>
	<span class="n">xdr_decode_AFSFetchStatus</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vnode</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">,</span> <span class="n">vnode</span><span class="p">,</span> <span class="n">store_version</span><span class="p">);</span>
	<span class="cm">/* xdr_decode_AFSVolSync(&amp;bp, call-&gt;replyX); */</span>

	<span class="n">_leave</span><span class="p">(</span><span class="s">&quot; = 0 [done]&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * FS.StoreStatus operation type</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">afs_call_type</span> <span class="n">afs_RXFSStoreStatus</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;FS.StoreStatus&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">deliver</span>	<span class="o">=</span> <span class="n">afs_deliver_fs_store_status</span><span class="p">,</span>
	<span class="p">.</span><span class="n">abort_to_error</span>	<span class="o">=</span> <span class="n">afs_abort_to_error</span><span class="p">,</span>
	<span class="p">.</span><span class="n">destructor</span>	<span class="o">=</span> <span class="n">afs_flat_call_destructor</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">afs_call_type</span> <span class="n">afs_RXFSStoreData_as_Status</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;FS.StoreData&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">deliver</span>	<span class="o">=</span> <span class="n">afs_deliver_fs_store_status</span><span class="p">,</span>
	<span class="p">.</span><span class="n">abort_to_error</span>	<span class="o">=</span> <span class="n">afs_abort_to_error</span><span class="p">,</span>
	<span class="p">.</span><span class="n">destructor</span>	<span class="o">=</span> <span class="n">afs_flat_call_destructor</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">afs_call_type</span> <span class="n">afs_RXFSStoreData64_as_Status</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;FS.StoreData64&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">deliver</span>	<span class="o">=</span> <span class="n">afs_deliver_fs_store_status</span><span class="p">,</span>
	<span class="p">.</span><span class="n">abort_to_error</span>	<span class="o">=</span> <span class="n">afs_abort_to_error</span><span class="p">,</span>
	<span class="p">.</span><span class="n">destructor</span>	<span class="o">=</span> <span class="n">afs_flat_call_destructor</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * set the attributes on a very large file, using FS.StoreData rather than</span>
<span class="cm"> * FS.StoreStatus so as to alter the file size also</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">afs_fs_setattr_size64</span><span class="p">(</span><span class="k">struct</span> <span class="n">afs_server</span> <span class="o">*</span><span class="n">server</span><span class="p">,</span> <span class="k">struct</span> <span class="n">key</span> <span class="o">*</span><span class="n">key</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">afs_vnode</span> <span class="o">*</span><span class="n">vnode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">iattr</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
				 <span class="k">const</span> <span class="k">struct</span> <span class="n">afs_wait_mode</span> <span class="o">*</span><span class="n">wait_mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">afs_call</span> <span class="o">*</span><span class="n">call</span><span class="p">;</span>
	<span class="n">__be32</span> <span class="o">*</span><span class="n">bp</span><span class="p">;</span>

	<span class="n">_enter</span><span class="p">(</span><span class="s">&quot;,%x,{%x:%u},,&quot;</span><span class="p">,</span>
	       <span class="n">key_serial</span><span class="p">(</span><span class="n">key</span><span class="p">),</span> <span class="n">vnode</span><span class="o">-&gt;</span><span class="n">fid</span><span class="p">.</span><span class="n">vid</span><span class="p">,</span> <span class="n">vnode</span><span class="o">-&gt;</span><span class="n">fid</span><span class="p">.</span><span class="n">vnode</span><span class="p">);</span>

	<span class="n">ASSERT</span><span class="p">(</span><span class="n">attr</span><span class="o">-&gt;</span><span class="n">ia_valid</span> <span class="o">&amp;</span> <span class="n">ATTR_SIZE</span><span class="p">);</span>

	<span class="n">call</span> <span class="o">=</span> <span class="n">afs_alloc_flat_call</span><span class="p">(</span><span class="o">&amp;</span><span class="n">afs_RXFSStoreData64_as_Status</span><span class="p">,</span>
				   <span class="p">(</span><span class="mi">4</span> <span class="o">+</span> <span class="mi">6</span> <span class="o">+</span> <span class="mi">3</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="mi">4</span><span class="p">,</span>
				   <span class="p">(</span><span class="mi">21</span> <span class="o">+</span> <span class="mi">6</span><span class="p">)</span> <span class="o">*</span> <span class="mi">4</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">call</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">call</span><span class="o">-&gt;</span><span class="n">key</span> <span class="o">=</span> <span class="n">key</span><span class="p">;</span>
	<span class="n">call</span><span class="o">-&gt;</span><span class="n">reply</span> <span class="o">=</span> <span class="n">vnode</span><span class="p">;</span>
	<span class="n">call</span><span class="o">-&gt;</span><span class="n">service_id</span> <span class="o">=</span> <span class="n">FS_SERVICE</span><span class="p">;</span>
	<span class="n">call</span><span class="o">-&gt;</span><span class="n">port</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="n">AFS_FS_PORT</span><span class="p">);</span>
	<span class="n">call</span><span class="o">-&gt;</span><span class="n">store_version</span> <span class="o">=</span> <span class="n">vnode</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">.</span><span class="n">data_version</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">call</span><span class="o">-&gt;</span><span class="n">operation_ID</span> <span class="o">=</span> <span class="n">FSSTOREDATA</span><span class="p">;</span>

	<span class="cm">/* marshall the parameters */</span>
	<span class="n">bp</span> <span class="o">=</span> <span class="n">call</span><span class="o">-&gt;</span><span class="n">request</span><span class="p">;</span>
	<span class="o">*</span><span class="n">bp</span><span class="o">++</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">FSSTOREDATA64</span><span class="p">);</span>
	<span class="o">*</span><span class="n">bp</span><span class="o">++</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">vnode</span><span class="o">-&gt;</span><span class="n">fid</span><span class="p">.</span><span class="n">vid</span><span class="p">);</span>
	<span class="o">*</span><span class="n">bp</span><span class="o">++</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">vnode</span><span class="o">-&gt;</span><span class="n">fid</span><span class="p">.</span><span class="n">vnode</span><span class="p">);</span>
	<span class="o">*</span><span class="n">bp</span><span class="o">++</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">vnode</span><span class="o">-&gt;</span><span class="n">fid</span><span class="p">.</span><span class="n">unique</span><span class="p">);</span>

	<span class="n">xdr_encode_AFS_StoreStatus</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bp</span><span class="p">,</span> <span class="n">attr</span><span class="p">);</span>

	<span class="o">*</span><span class="n">bp</span><span class="o">++</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>				<span class="cm">/* position of start of write */</span>
	<span class="o">*</span><span class="n">bp</span><span class="o">++</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="o">*</span><span class="n">bp</span><span class="o">++</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>				<span class="cm">/* size of write */</span>
	<span class="o">*</span><span class="n">bp</span><span class="o">++</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="o">*</span><span class="n">bp</span><span class="o">++</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">attr</span><span class="o">-&gt;</span><span class="n">ia_size</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">);</span>	<span class="cm">/* new file length */</span>
	<span class="o">*</span><span class="n">bp</span><span class="o">++</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">((</span><span class="n">u32</span><span class="p">)</span> <span class="n">attr</span><span class="o">-&gt;</span><span class="n">ia_size</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">afs_make_call</span><span class="p">(</span><span class="o">&amp;</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span> <span class="n">call</span><span class="p">,</span> <span class="n">GFP_NOFS</span><span class="p">,</span> <span class="n">wait_mode</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * set the attributes on a file, using FS.StoreData rather than FS.StoreStatus</span>
<span class="cm"> * so as to alter the file size also</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">afs_fs_setattr_size</span><span class="p">(</span><span class="k">struct</span> <span class="n">afs_server</span> <span class="o">*</span><span class="n">server</span><span class="p">,</span> <span class="k">struct</span> <span class="n">key</span> <span class="o">*</span><span class="n">key</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">afs_vnode</span> <span class="o">*</span><span class="n">vnode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">iattr</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
			       <span class="k">const</span> <span class="k">struct</span> <span class="n">afs_wait_mode</span> <span class="o">*</span><span class="n">wait_mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">afs_call</span> <span class="o">*</span><span class="n">call</span><span class="p">;</span>
	<span class="n">__be32</span> <span class="o">*</span><span class="n">bp</span><span class="p">;</span>

	<span class="n">_enter</span><span class="p">(</span><span class="s">&quot;,%x,{%x:%u},,&quot;</span><span class="p">,</span>
	       <span class="n">key_serial</span><span class="p">(</span><span class="n">key</span><span class="p">),</span> <span class="n">vnode</span><span class="o">-&gt;</span><span class="n">fid</span><span class="p">.</span><span class="n">vid</span><span class="p">,</span> <span class="n">vnode</span><span class="o">-&gt;</span><span class="n">fid</span><span class="p">.</span><span class="n">vnode</span><span class="p">);</span>

	<span class="n">ASSERT</span><span class="p">(</span><span class="n">attr</span><span class="o">-&gt;</span><span class="n">ia_valid</span> <span class="o">&amp;</span> <span class="n">ATTR_SIZE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">attr</span><span class="o">-&gt;</span><span class="n">ia_size</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">afs_fs_setattr_size64</span><span class="p">(</span><span class="n">server</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">vnode</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span>
					     <span class="n">wait_mode</span><span class="p">);</span>

	<span class="n">call</span> <span class="o">=</span> <span class="n">afs_alloc_flat_call</span><span class="p">(</span><span class="o">&amp;</span><span class="n">afs_RXFSStoreData_as_Status</span><span class="p">,</span>
				   <span class="p">(</span><span class="mi">4</span> <span class="o">+</span> <span class="mi">6</span> <span class="o">+</span> <span class="mi">3</span><span class="p">)</span> <span class="o">*</span> <span class="mi">4</span><span class="p">,</span>
				   <span class="p">(</span><span class="mi">21</span> <span class="o">+</span> <span class="mi">6</span><span class="p">)</span> <span class="o">*</span> <span class="mi">4</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">call</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">call</span><span class="o">-&gt;</span><span class="n">key</span> <span class="o">=</span> <span class="n">key</span><span class="p">;</span>
	<span class="n">call</span><span class="o">-&gt;</span><span class="n">reply</span> <span class="o">=</span> <span class="n">vnode</span><span class="p">;</span>
	<span class="n">call</span><span class="o">-&gt;</span><span class="n">service_id</span> <span class="o">=</span> <span class="n">FS_SERVICE</span><span class="p">;</span>
	<span class="n">call</span><span class="o">-&gt;</span><span class="n">port</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="n">AFS_FS_PORT</span><span class="p">);</span>
	<span class="n">call</span><span class="o">-&gt;</span><span class="n">store_version</span> <span class="o">=</span> <span class="n">vnode</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">.</span><span class="n">data_version</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">call</span><span class="o">-&gt;</span><span class="n">operation_ID</span> <span class="o">=</span> <span class="n">FSSTOREDATA</span><span class="p">;</span>

	<span class="cm">/* marshall the parameters */</span>
	<span class="n">bp</span> <span class="o">=</span> <span class="n">call</span><span class="o">-&gt;</span><span class="n">request</span><span class="p">;</span>
	<span class="o">*</span><span class="n">bp</span><span class="o">++</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">FSSTOREDATA</span><span class="p">);</span>
	<span class="o">*</span><span class="n">bp</span><span class="o">++</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">vnode</span><span class="o">-&gt;</span><span class="n">fid</span><span class="p">.</span><span class="n">vid</span><span class="p">);</span>
	<span class="o">*</span><span class="n">bp</span><span class="o">++</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">vnode</span><span class="o">-&gt;</span><span class="n">fid</span><span class="p">.</span><span class="n">vnode</span><span class="p">);</span>
	<span class="o">*</span><span class="n">bp</span><span class="o">++</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">vnode</span><span class="o">-&gt;</span><span class="n">fid</span><span class="p">.</span><span class="n">unique</span><span class="p">);</span>

	<span class="n">xdr_encode_AFS_StoreStatus</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bp</span><span class="p">,</span> <span class="n">attr</span><span class="p">);</span>

	<span class="o">*</span><span class="n">bp</span><span class="o">++</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>				<span class="cm">/* position of start of write */</span>
	<span class="o">*</span><span class="n">bp</span><span class="o">++</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>				<span class="cm">/* size of write */</span>
	<span class="o">*</span><span class="n">bp</span><span class="o">++</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">attr</span><span class="o">-&gt;</span><span class="n">ia_size</span><span class="p">);</span>		<span class="cm">/* new file length */</span>

	<span class="k">return</span> <span class="n">afs_make_call</span><span class="p">(</span><span class="o">&amp;</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span> <span class="n">call</span><span class="p">,</span> <span class="n">GFP_NOFS</span><span class="p">,</span> <span class="n">wait_mode</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * set the attributes on a file, using FS.StoreData if there&#39;s a change in file</span>
<span class="cm"> * size, and FS.StoreStatus otherwise</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">afs_fs_setattr</span><span class="p">(</span><span class="k">struct</span> <span class="n">afs_server</span> <span class="o">*</span><span class="n">server</span><span class="p">,</span> <span class="k">struct</span> <span class="n">key</span> <span class="o">*</span><span class="n">key</span><span class="p">,</span>
		   <span class="k">struct</span> <span class="n">afs_vnode</span> <span class="o">*</span><span class="n">vnode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">iattr</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
		   <span class="k">const</span> <span class="k">struct</span> <span class="n">afs_wait_mode</span> <span class="o">*</span><span class="n">wait_mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">afs_call</span> <span class="o">*</span><span class="n">call</span><span class="p">;</span>
	<span class="n">__be32</span> <span class="o">*</span><span class="n">bp</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">attr</span><span class="o">-&gt;</span><span class="n">ia_valid</span> <span class="o">&amp;</span> <span class="n">ATTR_SIZE</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">afs_fs_setattr_size</span><span class="p">(</span><span class="n">server</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">vnode</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span>
					   <span class="n">wait_mode</span><span class="p">);</span>

	<span class="n">_enter</span><span class="p">(</span><span class="s">&quot;,%x,{%x:%u},,&quot;</span><span class="p">,</span>
	       <span class="n">key_serial</span><span class="p">(</span><span class="n">key</span><span class="p">),</span> <span class="n">vnode</span><span class="o">-&gt;</span><span class="n">fid</span><span class="p">.</span><span class="n">vid</span><span class="p">,</span> <span class="n">vnode</span><span class="o">-&gt;</span><span class="n">fid</span><span class="p">.</span><span class="n">vnode</span><span class="p">);</span>

	<span class="n">call</span> <span class="o">=</span> <span class="n">afs_alloc_flat_call</span><span class="p">(</span><span class="o">&amp;</span><span class="n">afs_RXFSStoreStatus</span><span class="p">,</span>
				   <span class="p">(</span><span class="mi">4</span> <span class="o">+</span> <span class="mi">6</span><span class="p">)</span> <span class="o">*</span> <span class="mi">4</span><span class="p">,</span>
				   <span class="p">(</span><span class="mi">21</span> <span class="o">+</span> <span class="mi">6</span><span class="p">)</span> <span class="o">*</span> <span class="mi">4</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">call</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">call</span><span class="o">-&gt;</span><span class="n">key</span> <span class="o">=</span> <span class="n">key</span><span class="p">;</span>
	<span class="n">call</span><span class="o">-&gt;</span><span class="n">reply</span> <span class="o">=</span> <span class="n">vnode</span><span class="p">;</span>
	<span class="n">call</span><span class="o">-&gt;</span><span class="n">service_id</span> <span class="o">=</span> <span class="n">FS_SERVICE</span><span class="p">;</span>
	<span class="n">call</span><span class="o">-&gt;</span><span class="n">port</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="n">AFS_FS_PORT</span><span class="p">);</span>
	<span class="n">call</span><span class="o">-&gt;</span><span class="n">operation_ID</span> <span class="o">=</span> <span class="n">FSSTORESTATUS</span><span class="p">;</span>

	<span class="cm">/* marshall the parameters */</span>
	<span class="n">bp</span> <span class="o">=</span> <span class="n">call</span><span class="o">-&gt;</span><span class="n">request</span><span class="p">;</span>
	<span class="o">*</span><span class="n">bp</span><span class="o">++</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">FSSTORESTATUS</span><span class="p">);</span>
	<span class="o">*</span><span class="n">bp</span><span class="o">++</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">vnode</span><span class="o">-&gt;</span><span class="n">fid</span><span class="p">.</span><span class="n">vid</span><span class="p">);</span>
	<span class="o">*</span><span class="n">bp</span><span class="o">++</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">vnode</span><span class="o">-&gt;</span><span class="n">fid</span><span class="p">.</span><span class="n">vnode</span><span class="p">);</span>
	<span class="o">*</span><span class="n">bp</span><span class="o">++</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">vnode</span><span class="o">-&gt;</span><span class="n">fid</span><span class="p">.</span><span class="n">unique</span><span class="p">);</span>

	<span class="n">xdr_encode_AFS_StoreStatus</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bp</span><span class="p">,</span> <span class="n">attr</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">afs_make_call</span><span class="p">(</span><span class="o">&amp;</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span> <span class="n">call</span><span class="p">,</span> <span class="n">GFP_NOFS</span><span class="p">,</span> <span class="n">wait_mode</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * deliver reply data to an FS.GetVolumeStatus</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">afs_deliver_fs_get_volume_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">afs_call</span> <span class="o">*</span><span class="n">call</span><span class="p">,</span>
					    <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="n">bool</span> <span class="n">last</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="n">__be32</span> <span class="o">*</span><span class="n">bp</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">_enter</span><span class="p">(</span><span class="s">&quot;{%u},{%u},%d&quot;</span><span class="p">,</span> <span class="n">call</span><span class="o">-&gt;</span><span class="n">unmarshall</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span> <span class="n">last</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">call</span><span class="o">-&gt;</span><span class="n">unmarshall</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>:
		<span class="n">call</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">call</span><span class="o">-&gt;</span><span class="n">unmarshall</span><span class="o">++</span><span class="p">;</span>

		<span class="cm">/* extract the returned status record */</span>
	<span class="k">case</span> <span class="mi">1</span>:
		<span class="n">_debug</span><span class="p">(</span><span class="s">&quot;extract status&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">afs_extract_data</span><span class="p">(</span><span class="n">call</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">last</span><span class="p">,</span> <span class="n">call</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">,</span>
				       <span class="mi">12</span> <span class="o">*</span> <span class="mi">4</span><span class="p">);</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">0</span>:		<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="o">-</span><span class="n">EAGAIN</span>:	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="nl">default:</span>	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">bp</span> <span class="o">=</span> <span class="n">call</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">;</span>
		<span class="n">xdr_decode_AFSFetchVolumeStatus</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bp</span><span class="p">,</span> <span class="n">call</span><span class="o">-&gt;</span><span class="n">reply2</span><span class="p">);</span>
		<span class="n">call</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">call</span><span class="o">-&gt;</span><span class="n">unmarshall</span><span class="o">++</span><span class="p">;</span>

		<span class="cm">/* extract the volume name length */</span>
	<span class="k">case</span> <span class="mi">2</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">afs_extract_data</span><span class="p">(</span><span class="n">call</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">last</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">call</span><span class="o">-&gt;</span><span class="n">tmp</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">0</span>:		<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="o">-</span><span class="n">EAGAIN</span>:	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="nl">default:</span>	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">call</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">=</span> <span class="n">ntohl</span><span class="p">(</span><span class="n">call</span><span class="o">-&gt;</span><span class="n">tmp</span><span class="p">);</span>
		<span class="n">_debug</span><span class="p">(</span><span class="s">&quot;volname length: %u&quot;</span><span class="p">,</span> <span class="n">call</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">call</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">&gt;=</span> <span class="n">AFSNAMEMAX</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EBADMSG</span><span class="p">;</span>
		<span class="n">call</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">call</span><span class="o">-&gt;</span><span class="n">unmarshall</span><span class="o">++</span><span class="p">;</span>

		<span class="cm">/* extract the volume name */</span>
	<span class="k">case</span> <span class="mi">3</span>:
		<span class="n">_debug</span><span class="p">(</span><span class="s">&quot;extract volname&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">call</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">afs_extract_data</span><span class="p">(</span><span class="n">call</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">last</span><span class="p">,</span> <span class="n">call</span><span class="o">-&gt;</span><span class="n">reply3</span><span class="p">,</span>
					       <span class="n">call</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">);</span>
			<span class="k">switch</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="mi">0</span>:		<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="o">-</span><span class="n">EAGAIN</span>:	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
			<span class="nl">default:</span>	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="n">p</span> <span class="o">=</span> <span class="n">call</span><span class="o">-&gt;</span><span class="n">reply3</span><span class="p">;</span>
		<span class="n">p</span><span class="p">[</span><span class="n">call</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">_debug</span><span class="p">(</span><span class="s">&quot;volname &#39;%s&#39;&quot;</span><span class="p">,</span> <span class="n">p</span><span class="p">);</span>

		<span class="n">call</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">call</span><span class="o">-&gt;</span><span class="n">unmarshall</span><span class="o">++</span><span class="p">;</span>

		<span class="cm">/* extract the volume name padding */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">call</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">call</span><span class="o">-&gt;</span><span class="n">unmarshall</span><span class="o">++</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">no_volname_padding</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">call</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">=</span> <span class="mi">4</span> <span class="o">-</span> <span class="p">(</span><span class="n">call</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">);</span>

	<span class="k">case</span> <span class="mi">4</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">afs_extract_data</span><span class="p">(</span><span class="n">call</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">last</span><span class="p">,</span> <span class="n">call</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">,</span>
				       <span class="n">call</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">);</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">0</span>:		<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="o">-</span><span class="n">EAGAIN</span>:	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="nl">default:</span>	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">call</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">call</span><span class="o">-&gt;</span><span class="n">unmarshall</span><span class="o">++</span><span class="p">;</span>
	<span class="nl">no_volname_padding:</span>

		<span class="cm">/* extract the offline message length */</span>
	<span class="k">case</span> <span class="mi">5</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">afs_extract_data</span><span class="p">(</span><span class="n">call</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">last</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">call</span><span class="o">-&gt;</span><span class="n">tmp</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">0</span>:		<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="o">-</span><span class="n">EAGAIN</span>:	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="nl">default:</span>	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">call</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">=</span> <span class="n">ntohl</span><span class="p">(</span><span class="n">call</span><span class="o">-&gt;</span><span class="n">tmp</span><span class="p">);</span>
		<span class="n">_debug</span><span class="p">(</span><span class="s">&quot;offline msg length: %u&quot;</span><span class="p">,</span> <span class="n">call</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">call</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">&gt;=</span> <span class="n">AFSNAMEMAX</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EBADMSG</span><span class="p">;</span>
		<span class="n">call</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">call</span><span class="o">-&gt;</span><span class="n">unmarshall</span><span class="o">++</span><span class="p">;</span>

		<span class="cm">/* extract the offline message */</span>
	<span class="k">case</span> <span class="mi">6</span>:
		<span class="n">_debug</span><span class="p">(</span><span class="s">&quot;extract offline&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">call</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">afs_extract_data</span><span class="p">(</span><span class="n">call</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">last</span><span class="p">,</span> <span class="n">call</span><span class="o">-&gt;</span><span class="n">reply3</span><span class="p">,</span>
					       <span class="n">call</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">);</span>
			<span class="k">switch</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="mi">0</span>:		<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="o">-</span><span class="n">EAGAIN</span>:	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
			<span class="nl">default:</span>	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="n">p</span> <span class="o">=</span> <span class="n">call</span><span class="o">-&gt;</span><span class="n">reply3</span><span class="p">;</span>
		<span class="n">p</span><span class="p">[</span><span class="n">call</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">_debug</span><span class="p">(</span><span class="s">&quot;offline &#39;%s&#39;&quot;</span><span class="p">,</span> <span class="n">p</span><span class="p">);</span>

		<span class="n">call</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">call</span><span class="o">-&gt;</span><span class="n">unmarshall</span><span class="o">++</span><span class="p">;</span>

		<span class="cm">/* extract the offline message padding */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">call</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">call</span><span class="o">-&gt;</span><span class="n">unmarshall</span><span class="o">++</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">no_offline_padding</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">call</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">=</span> <span class="mi">4</span> <span class="o">-</span> <span class="p">(</span><span class="n">call</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">);</span>

	<span class="k">case</span> <span class="mi">7</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">afs_extract_data</span><span class="p">(</span><span class="n">call</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">last</span><span class="p">,</span> <span class="n">call</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">,</span>
				       <span class="n">call</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">);</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">0</span>:		<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="o">-</span><span class="n">EAGAIN</span>:	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="nl">default:</span>	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">call</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">call</span><span class="o">-&gt;</span><span class="n">unmarshall</span><span class="o">++</span><span class="p">;</span>
	<span class="nl">no_offline_padding:</span>

		<span class="cm">/* extract the message of the day length */</span>
	<span class="k">case</span> <span class="mi">8</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">afs_extract_data</span><span class="p">(</span><span class="n">call</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">last</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">call</span><span class="o">-&gt;</span><span class="n">tmp</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">0</span>:		<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="o">-</span><span class="n">EAGAIN</span>:	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="nl">default:</span>	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">call</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">=</span> <span class="n">ntohl</span><span class="p">(</span><span class="n">call</span><span class="o">-&gt;</span><span class="n">tmp</span><span class="p">);</span>
		<span class="n">_debug</span><span class="p">(</span><span class="s">&quot;motd length: %u&quot;</span><span class="p">,</span> <span class="n">call</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">call</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">&gt;=</span> <span class="n">AFSNAMEMAX</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EBADMSG</span><span class="p">;</span>
		<span class="n">call</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">call</span><span class="o">-&gt;</span><span class="n">unmarshall</span><span class="o">++</span><span class="p">;</span>

		<span class="cm">/* extract the message of the day */</span>
	<span class="k">case</span> <span class="mi">9</span>:
		<span class="n">_debug</span><span class="p">(</span><span class="s">&quot;extract motd&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">call</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">afs_extract_data</span><span class="p">(</span><span class="n">call</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">last</span><span class="p">,</span> <span class="n">call</span><span class="o">-&gt;</span><span class="n">reply3</span><span class="p">,</span>
					       <span class="n">call</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">);</span>
			<span class="k">switch</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="mi">0</span>:		<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="o">-</span><span class="n">EAGAIN</span>:	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
			<span class="nl">default:</span>	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="n">p</span> <span class="o">=</span> <span class="n">call</span><span class="o">-&gt;</span><span class="n">reply3</span><span class="p">;</span>
		<span class="n">p</span><span class="p">[</span><span class="n">call</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">_debug</span><span class="p">(</span><span class="s">&quot;motd &#39;%s&#39;&quot;</span><span class="p">,</span> <span class="n">p</span><span class="p">);</span>

		<span class="n">call</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">call</span><span class="o">-&gt;</span><span class="n">unmarshall</span><span class="o">++</span><span class="p">;</span>

		<span class="cm">/* extract the message of the day padding */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">call</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">call</span><span class="o">-&gt;</span><span class="n">unmarshall</span><span class="o">++</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">no_motd_padding</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">call</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">=</span> <span class="mi">4</span> <span class="o">-</span> <span class="p">(</span><span class="n">call</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">);</span>

	<span class="k">case</span> <span class="mi">10</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">afs_extract_data</span><span class="p">(</span><span class="n">call</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">last</span><span class="p">,</span> <span class="n">call</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">,</span>
				       <span class="n">call</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">);</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">0</span>:		<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="o">-</span><span class="n">EAGAIN</span>:	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="nl">default:</span>	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">call</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">call</span><span class="o">-&gt;</span><span class="n">unmarshall</span><span class="o">++</span><span class="p">;</span>
	<span class="nl">no_motd_padding:</span>

	<span class="k">case</span> <span class="mi">11</span>:
		<span class="n">_debug</span><span class="p">(</span><span class="s">&quot;trailer %d&quot;</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EBADMSG</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">last</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">_leave</span><span class="p">(</span><span class="s">&quot; = 0 [done]&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * destroy an FS.GetVolumeStatus call</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">afs_get_volume_status_call_destructor</span><span class="p">(</span><span class="k">struct</span> <span class="n">afs_call</span> <span class="o">*</span><span class="n">call</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">call</span><span class="o">-&gt;</span><span class="n">reply3</span><span class="p">);</span>
	<span class="n">call</span><span class="o">-&gt;</span><span class="n">reply3</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">afs_flat_call_destructor</span><span class="p">(</span><span class="n">call</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * FS.GetVolumeStatus operation type</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">afs_call_type</span> <span class="n">afs_RXFSGetVolumeStatus</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;FS.GetVolumeStatus&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">deliver</span>	<span class="o">=</span> <span class="n">afs_deliver_fs_get_volume_status</span><span class="p">,</span>
	<span class="p">.</span><span class="n">abort_to_error</span>	<span class="o">=</span> <span class="n">afs_abort_to_error</span><span class="p">,</span>
	<span class="p">.</span><span class="n">destructor</span>	<span class="o">=</span> <span class="n">afs_get_volume_status_call_destructor</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * fetch the status of a volume</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">afs_fs_get_volume_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">afs_server</span> <span class="o">*</span><span class="n">server</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">key</span> <span class="o">*</span><span class="n">key</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">afs_vnode</span> <span class="o">*</span><span class="n">vnode</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">afs_volume_status</span> <span class="o">*</span><span class="n">vs</span><span class="p">,</span>
			     <span class="k">const</span> <span class="k">struct</span> <span class="n">afs_wait_mode</span> <span class="o">*</span><span class="n">wait_mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">afs_call</span> <span class="o">*</span><span class="n">call</span><span class="p">;</span>
	<span class="n">__be32</span> <span class="o">*</span><span class="n">bp</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">tmpbuf</span><span class="p">;</span>

	<span class="n">_enter</span><span class="p">(</span><span class="s">&quot;&quot;</span><span class="p">);</span>

	<span class="n">tmpbuf</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">AFSOPAQUEMAX</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tmpbuf</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">call</span> <span class="o">=</span> <span class="n">afs_alloc_flat_call</span><span class="p">(</span><span class="o">&amp;</span><span class="n">afs_RXFSGetVolumeStatus</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">12</span> <span class="o">*</span> <span class="mi">4</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">call</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">tmpbuf</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">call</span><span class="o">-&gt;</span><span class="n">key</span> <span class="o">=</span> <span class="n">key</span><span class="p">;</span>
	<span class="n">call</span><span class="o">-&gt;</span><span class="n">reply</span> <span class="o">=</span> <span class="n">vnode</span><span class="p">;</span>
	<span class="n">call</span><span class="o">-&gt;</span><span class="n">reply2</span> <span class="o">=</span> <span class="n">vs</span><span class="p">;</span>
	<span class="n">call</span><span class="o">-&gt;</span><span class="n">reply3</span> <span class="o">=</span> <span class="n">tmpbuf</span><span class="p">;</span>
	<span class="n">call</span><span class="o">-&gt;</span><span class="n">service_id</span> <span class="o">=</span> <span class="n">FS_SERVICE</span><span class="p">;</span>
	<span class="n">call</span><span class="o">-&gt;</span><span class="n">port</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="n">AFS_FS_PORT</span><span class="p">);</span>

	<span class="cm">/* marshall the parameters */</span>
	<span class="n">bp</span> <span class="o">=</span> <span class="n">call</span><span class="o">-&gt;</span><span class="n">request</span><span class="p">;</span>
	<span class="n">bp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">FSGETVOLUMESTATUS</span><span class="p">);</span>
	<span class="n">bp</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">vnode</span><span class="o">-&gt;</span><span class="n">fid</span><span class="p">.</span><span class="n">vid</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">afs_make_call</span><span class="p">(</span><span class="o">&amp;</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span> <span class="n">call</span><span class="p">,</span> <span class="n">GFP_NOFS</span><span class="p">,</span> <span class="n">wait_mode</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * deliver reply data to an FS.SetLock, FS.ExtendLock or FS.ReleaseLock</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">afs_deliver_fs_xxxx_lock</span><span class="p">(</span><span class="k">struct</span> <span class="n">afs_call</span> <span class="o">*</span><span class="n">call</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="n">bool</span> <span class="n">last</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="n">__be32</span> <span class="o">*</span><span class="n">bp</span><span class="p">;</span>

	<span class="n">_enter</span><span class="p">(</span><span class="s">&quot;{%u},{%u},%d&quot;</span><span class="p">,</span> <span class="n">call</span><span class="o">-&gt;</span><span class="n">unmarshall</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span> <span class="n">last</span><span class="p">);</span>

	<span class="n">afs_transfer_reply</span><span class="p">(</span><span class="n">call</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">last</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">call</span><span class="o">-&gt;</span><span class="n">reply_size</span> <span class="o">!=</span> <span class="n">call</span><span class="o">-&gt;</span><span class="n">reply_max</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBADMSG</span><span class="p">;</span>

	<span class="cm">/* unmarshall the reply once we&#39;ve received all of it */</span>
	<span class="n">bp</span> <span class="o">=</span> <span class="n">call</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">;</span>
	<span class="cm">/* xdr_decode_AFSVolSync(&amp;bp, call-&gt;replyX); */</span>

	<span class="n">_leave</span><span class="p">(</span><span class="s">&quot; = 0 [done]&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * FS.SetLock operation type</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">afs_call_type</span> <span class="n">afs_RXFSSetLock</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;FS.SetLock&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">deliver</span>	<span class="o">=</span> <span class="n">afs_deliver_fs_xxxx_lock</span><span class="p">,</span>
	<span class="p">.</span><span class="n">abort_to_error</span>	<span class="o">=</span> <span class="n">afs_abort_to_error</span><span class="p">,</span>
	<span class="p">.</span><span class="n">destructor</span>	<span class="o">=</span> <span class="n">afs_flat_call_destructor</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * FS.ExtendLock operation type</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">afs_call_type</span> <span class="n">afs_RXFSExtendLock</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;FS.ExtendLock&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">deliver</span>	<span class="o">=</span> <span class="n">afs_deliver_fs_xxxx_lock</span><span class="p">,</span>
	<span class="p">.</span><span class="n">abort_to_error</span>	<span class="o">=</span> <span class="n">afs_abort_to_error</span><span class="p">,</span>
	<span class="p">.</span><span class="n">destructor</span>	<span class="o">=</span> <span class="n">afs_flat_call_destructor</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * FS.ReleaseLock operation type</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">afs_call_type</span> <span class="n">afs_RXFSReleaseLock</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;FS.ReleaseLock&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">deliver</span>	<span class="o">=</span> <span class="n">afs_deliver_fs_xxxx_lock</span><span class="p">,</span>
	<span class="p">.</span><span class="n">abort_to_error</span>	<span class="o">=</span> <span class="n">afs_abort_to_error</span><span class="p">,</span>
	<span class="p">.</span><span class="n">destructor</span>	<span class="o">=</span> <span class="n">afs_flat_call_destructor</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * get a lock on a file</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">afs_fs_set_lock</span><span class="p">(</span><span class="k">struct</span> <span class="n">afs_server</span> <span class="o">*</span><span class="n">server</span><span class="p">,</span>
		    <span class="k">struct</span> <span class="n">key</span> <span class="o">*</span><span class="n">key</span><span class="p">,</span>
		    <span class="k">struct</span> <span class="n">afs_vnode</span> <span class="o">*</span><span class="n">vnode</span><span class="p">,</span>
		    <span class="n">afs_lock_type_t</span> <span class="n">type</span><span class="p">,</span>
		    <span class="k">const</span> <span class="k">struct</span> <span class="n">afs_wait_mode</span> <span class="o">*</span><span class="n">wait_mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">afs_call</span> <span class="o">*</span><span class="n">call</span><span class="p">;</span>
	<span class="n">__be32</span> <span class="o">*</span><span class="n">bp</span><span class="p">;</span>

	<span class="n">_enter</span><span class="p">(</span><span class="s">&quot;&quot;</span><span class="p">);</span>

	<span class="n">call</span> <span class="o">=</span> <span class="n">afs_alloc_flat_call</span><span class="p">(</span><span class="o">&amp;</span><span class="n">afs_RXFSSetLock</span><span class="p">,</span> <span class="mi">5</span> <span class="o">*</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">6</span> <span class="o">*</span> <span class="mi">4</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">call</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">call</span><span class="o">-&gt;</span><span class="n">key</span> <span class="o">=</span> <span class="n">key</span><span class="p">;</span>
	<span class="n">call</span><span class="o">-&gt;</span><span class="n">reply</span> <span class="o">=</span> <span class="n">vnode</span><span class="p">;</span>
	<span class="n">call</span><span class="o">-&gt;</span><span class="n">service_id</span> <span class="o">=</span> <span class="n">FS_SERVICE</span><span class="p">;</span>
	<span class="n">call</span><span class="o">-&gt;</span><span class="n">port</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="n">AFS_FS_PORT</span><span class="p">);</span>

	<span class="cm">/* marshall the parameters */</span>
	<span class="n">bp</span> <span class="o">=</span> <span class="n">call</span><span class="o">-&gt;</span><span class="n">request</span><span class="p">;</span>
	<span class="o">*</span><span class="n">bp</span><span class="o">++</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">FSSETLOCK</span><span class="p">);</span>
	<span class="o">*</span><span class="n">bp</span><span class="o">++</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">vnode</span><span class="o">-&gt;</span><span class="n">fid</span><span class="p">.</span><span class="n">vid</span><span class="p">);</span>
	<span class="o">*</span><span class="n">bp</span><span class="o">++</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">vnode</span><span class="o">-&gt;</span><span class="n">fid</span><span class="p">.</span><span class="n">vnode</span><span class="p">);</span>
	<span class="o">*</span><span class="n">bp</span><span class="o">++</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">vnode</span><span class="o">-&gt;</span><span class="n">fid</span><span class="p">.</span><span class="n">unique</span><span class="p">);</span>
	<span class="o">*</span><span class="n">bp</span><span class="o">++</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">type</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">afs_make_call</span><span class="p">(</span><span class="o">&amp;</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span> <span class="n">call</span><span class="p">,</span> <span class="n">GFP_NOFS</span><span class="p">,</span> <span class="n">wait_mode</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * extend a lock on a file</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">afs_fs_extend_lock</span><span class="p">(</span><span class="k">struct</span> <span class="n">afs_server</span> <span class="o">*</span><span class="n">server</span><span class="p">,</span>
		       <span class="k">struct</span> <span class="n">key</span> <span class="o">*</span><span class="n">key</span><span class="p">,</span>
		       <span class="k">struct</span> <span class="n">afs_vnode</span> <span class="o">*</span><span class="n">vnode</span><span class="p">,</span>
		       <span class="k">const</span> <span class="k">struct</span> <span class="n">afs_wait_mode</span> <span class="o">*</span><span class="n">wait_mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">afs_call</span> <span class="o">*</span><span class="n">call</span><span class="p">;</span>
	<span class="n">__be32</span> <span class="o">*</span><span class="n">bp</span><span class="p">;</span>

	<span class="n">_enter</span><span class="p">(</span><span class="s">&quot;&quot;</span><span class="p">);</span>

	<span class="n">call</span> <span class="o">=</span> <span class="n">afs_alloc_flat_call</span><span class="p">(</span><span class="o">&amp;</span><span class="n">afs_RXFSExtendLock</span><span class="p">,</span> <span class="mi">4</span> <span class="o">*</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">6</span> <span class="o">*</span> <span class="mi">4</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">call</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">call</span><span class="o">-&gt;</span><span class="n">key</span> <span class="o">=</span> <span class="n">key</span><span class="p">;</span>
	<span class="n">call</span><span class="o">-&gt;</span><span class="n">reply</span> <span class="o">=</span> <span class="n">vnode</span><span class="p">;</span>
	<span class="n">call</span><span class="o">-&gt;</span><span class="n">service_id</span> <span class="o">=</span> <span class="n">FS_SERVICE</span><span class="p">;</span>
	<span class="n">call</span><span class="o">-&gt;</span><span class="n">port</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="n">AFS_FS_PORT</span><span class="p">);</span>

	<span class="cm">/* marshall the parameters */</span>
	<span class="n">bp</span> <span class="o">=</span> <span class="n">call</span><span class="o">-&gt;</span><span class="n">request</span><span class="p">;</span>
	<span class="o">*</span><span class="n">bp</span><span class="o">++</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">FSEXTENDLOCK</span><span class="p">);</span>
	<span class="o">*</span><span class="n">bp</span><span class="o">++</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">vnode</span><span class="o">-&gt;</span><span class="n">fid</span><span class="p">.</span><span class="n">vid</span><span class="p">);</span>
	<span class="o">*</span><span class="n">bp</span><span class="o">++</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">vnode</span><span class="o">-&gt;</span><span class="n">fid</span><span class="p">.</span><span class="n">vnode</span><span class="p">);</span>
	<span class="o">*</span><span class="n">bp</span><span class="o">++</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">vnode</span><span class="o">-&gt;</span><span class="n">fid</span><span class="p">.</span><span class="n">unique</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">afs_make_call</span><span class="p">(</span><span class="o">&amp;</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span> <span class="n">call</span><span class="p">,</span> <span class="n">GFP_NOFS</span><span class="p">,</span> <span class="n">wait_mode</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * release a lock on a file</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">afs_fs_release_lock</span><span class="p">(</span><span class="k">struct</span> <span class="n">afs_server</span> <span class="o">*</span><span class="n">server</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">key</span> <span class="o">*</span><span class="n">key</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">afs_vnode</span> <span class="o">*</span><span class="n">vnode</span><span class="p">,</span>
			<span class="k">const</span> <span class="k">struct</span> <span class="n">afs_wait_mode</span> <span class="o">*</span><span class="n">wait_mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">afs_call</span> <span class="o">*</span><span class="n">call</span><span class="p">;</span>
	<span class="n">__be32</span> <span class="o">*</span><span class="n">bp</span><span class="p">;</span>

	<span class="n">_enter</span><span class="p">(</span><span class="s">&quot;&quot;</span><span class="p">);</span>

	<span class="n">call</span> <span class="o">=</span> <span class="n">afs_alloc_flat_call</span><span class="p">(</span><span class="o">&amp;</span><span class="n">afs_RXFSReleaseLock</span><span class="p">,</span> <span class="mi">4</span> <span class="o">*</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">6</span> <span class="o">*</span> <span class="mi">4</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">call</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">call</span><span class="o">-&gt;</span><span class="n">key</span> <span class="o">=</span> <span class="n">key</span><span class="p">;</span>
	<span class="n">call</span><span class="o">-&gt;</span><span class="n">reply</span> <span class="o">=</span> <span class="n">vnode</span><span class="p">;</span>
	<span class="n">call</span><span class="o">-&gt;</span><span class="n">service_id</span> <span class="o">=</span> <span class="n">FS_SERVICE</span><span class="p">;</span>
	<span class="n">call</span><span class="o">-&gt;</span><span class="n">port</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="n">AFS_FS_PORT</span><span class="p">);</span>

	<span class="cm">/* marshall the parameters */</span>
	<span class="n">bp</span> <span class="o">=</span> <span class="n">call</span><span class="o">-&gt;</span><span class="n">request</span><span class="p">;</span>
	<span class="o">*</span><span class="n">bp</span><span class="o">++</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">FSRELEASELOCK</span><span class="p">);</span>
	<span class="o">*</span><span class="n">bp</span><span class="o">++</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">vnode</span><span class="o">-&gt;</span><span class="n">fid</span><span class="p">.</span><span class="n">vid</span><span class="p">);</span>
	<span class="o">*</span><span class="n">bp</span><span class="o">++</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">vnode</span><span class="o">-&gt;</span><span class="n">fid</span><span class="p">.</span><span class="n">vnode</span><span class="p">);</span>
	<span class="o">*</span><span class="n">bp</span><span class="o">++</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">vnode</span><span class="o">-&gt;</span><span class="n">fid</span><span class="p">.</span><span class="n">unique</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">afs_make_call</span><span class="p">(</span><span class="o">&amp;</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span> <span class="n">call</span><span class="p">,</span> <span class="n">GFP_NOFS</span><span class="p">,</span> <span class="n">wait_mode</span><span class="p">);</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
