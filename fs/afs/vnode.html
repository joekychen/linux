<!DOCTYPE html>
<html><head><title>joekychen/linux » fs › afs › vnode.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>vnode.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/* AFS vnode management</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 2002, 2007 Red Hat, Inc. All Rights Reserved.</span>
<span class="cm"> * Written by David Howells (dhowells@redhat.com)</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or</span>
<span class="cm"> * modify it under the terms of the GNU General Public License</span>
<span class="cm"> * as published by the Free Software Foundation; either version</span>
<span class="cm"> * 2 of the License, or (at your option) any later version.</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/fs.h&gt;</span>
<span class="cp">#include &lt;linux/sched.h&gt;</span>
<span class="cp">#include &quot;internal.h&quot;</span>

<span class="cp">#if 0</span><span class="c"></span>
<span class="c">static noinline bool dump_tree_aux(struct rb_node *node, struct rb_node *parent,</span>
<span class="c">				   int depth, char lr)</span>
<span class="c">{</span>
<span class="c">	struct afs_vnode *vnode;</span>
<span class="c">	bool bad = false;</span>

<span class="c">	if (!node)</span>
<span class="c">		return false;</span>

<span class="c">	if (node-&gt;rb_left)</span>
<span class="c">		bad = dump_tree_aux(node-&gt;rb_left, node, depth + 2, &#39;/&#39;);</span>

<span class="c">	vnode = rb_entry(node, struct afs_vnode, cb_promise);</span>
<span class="c">	_debug(&quot;%c %*.*s%c%p {%d}&quot;,</span>
<span class="c">	       rb_is_red(node) ? &#39;R&#39; : &#39;B&#39;,</span>
<span class="c">	       depth, depth, &quot;&quot;, lr,</span>
<span class="c">	       vnode, vnode-&gt;cb_expires_at);</span>
<span class="c">	if (rb_parent(node) != parent) {</span>
<span class="c">		printk(&quot;BAD: %p != %p\n&quot;, rb_parent(node), parent);</span>
<span class="c">		bad = true;</span>
<span class="c">	}</span>

<span class="c">	if (node-&gt;rb_right)</span>
<span class="c">		bad |= dump_tree_aux(node-&gt;rb_right, node, depth + 2, &#39;\\&#39;);</span>

<span class="c">	return bad;</span>
<span class="c">}</span>

<span class="c">static noinline void dump_tree(const char *name, struct afs_server *server)</span>
<span class="c">{</span>
<span class="c">	_enter(&quot;%s&quot;, name);</span>
<span class="c">	if (dump_tree_aux(server-&gt;cb_promises.rb_node, NULL, 0, &#39;-&#39;))</span>
<span class="c">		BUG();</span>
<span class="c">}</span>
<span class="cp">#endif</span>

<span class="cm">/*</span>
<span class="cm"> * insert a vnode into the backing server&#39;s vnode tree</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">afs_install_vnode</span><span class="p">(</span><span class="k">struct</span> <span class="n">afs_vnode</span> <span class="o">*</span><span class="n">vnode</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">afs_server</span> <span class="o">*</span><span class="n">server</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">afs_server</span> <span class="o">*</span><span class="n">old_server</span> <span class="o">=</span> <span class="n">vnode</span><span class="o">-&gt;</span><span class="n">server</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">afs_vnode</span> <span class="o">*</span><span class="n">xvnode</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rb_node</span> <span class="o">*</span><span class="n">parent</span><span class="p">,</span> <span class="o">**</span><span class="n">p</span><span class="p">;</span>

	<span class="n">_enter</span><span class="p">(</span><span class="s">&quot;%p,%p&quot;</span><span class="p">,</span> <span class="n">vnode</span><span class="p">,</span> <span class="n">server</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">old_server</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">old_server</span><span class="o">-&gt;</span><span class="n">fs_lock</span><span class="p">);</span>
		<span class="n">rb_erase</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vnode</span><span class="o">-&gt;</span><span class="n">server_rb</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">old_server</span><span class="o">-&gt;</span><span class="n">fs_vnodes</span><span class="p">);</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">old_server</span><span class="o">-&gt;</span><span class="n">fs_lock</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">afs_get_server</span><span class="p">(</span><span class="n">server</span><span class="p">);</span>
	<span class="n">vnode</span><span class="o">-&gt;</span><span class="n">server</span> <span class="o">=</span> <span class="n">server</span><span class="p">;</span>
	<span class="n">afs_put_server</span><span class="p">(</span><span class="n">old_server</span><span class="p">);</span>

	<span class="cm">/* insert into the server&#39;s vnode tree in FID order */</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">fs_lock</span><span class="p">);</span>

	<span class="n">parent</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">p</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">fs_vnodes</span><span class="p">.</span><span class="n">rb_node</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">*</span><span class="n">p</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">parent</span> <span class="o">=</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
		<span class="n">xvnode</span> <span class="o">=</span> <span class="n">rb_entry</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span> <span class="k">struct</span> <span class="n">afs_vnode</span><span class="p">,</span> <span class="n">server_rb</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">vnode</span><span class="o">-&gt;</span><span class="n">fid</span><span class="p">.</span><span class="n">vid</span> <span class="o">&lt;</span> <span class="n">xvnode</span><span class="o">-&gt;</span><span class="n">fid</span><span class="p">.</span><span class="n">vid</span><span class="p">)</span>
			<span class="n">p</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="o">*</span><span class="n">p</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">rb_left</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">vnode</span><span class="o">-&gt;</span><span class="n">fid</span><span class="p">.</span><span class="n">vid</span> <span class="o">&gt;</span> <span class="n">xvnode</span><span class="o">-&gt;</span><span class="n">fid</span><span class="p">.</span><span class="n">vid</span><span class="p">)</span>
			<span class="n">p</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="o">*</span><span class="n">p</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">rb_right</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">vnode</span><span class="o">-&gt;</span><span class="n">fid</span><span class="p">.</span><span class="n">vnode</span> <span class="o">&lt;</span> <span class="n">xvnode</span><span class="o">-&gt;</span><span class="n">fid</span><span class="p">.</span><span class="n">vnode</span><span class="p">)</span>
			<span class="n">p</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="o">*</span><span class="n">p</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">rb_left</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">vnode</span><span class="o">-&gt;</span><span class="n">fid</span><span class="p">.</span><span class="n">vnode</span> <span class="o">&gt;</span> <span class="n">xvnode</span><span class="o">-&gt;</span><span class="n">fid</span><span class="p">.</span><span class="n">vnode</span><span class="p">)</span>
			<span class="n">p</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="o">*</span><span class="n">p</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">rb_right</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">vnode</span><span class="o">-&gt;</span><span class="n">fid</span><span class="p">.</span><span class="n">unique</span> <span class="o">&lt;</span> <span class="n">xvnode</span><span class="o">-&gt;</span><span class="n">fid</span><span class="p">.</span><span class="n">unique</span><span class="p">)</span>
			<span class="n">p</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="o">*</span><span class="n">p</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">rb_left</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">vnode</span><span class="o">-&gt;</span><span class="n">fid</span><span class="p">.</span><span class="n">unique</span> <span class="o">&gt;</span> <span class="n">xvnode</span><span class="o">-&gt;</span><span class="n">fid</span><span class="p">.</span><span class="n">unique</span><span class="p">)</span>
			<span class="n">p</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="o">*</span><span class="n">p</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">rb_right</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">BUG</span><span class="p">();</span> <span class="cm">/* can&#39;t happen unless afs_iget() malfunctions */</span>
	<span class="p">}</span>

	<span class="n">rb_link_node</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vnode</span><span class="o">-&gt;</span><span class="n">server_rb</span><span class="p">,</span> <span class="n">parent</span><span class="p">,</span> <span class="n">p</span><span class="p">);</span>
	<span class="n">rb_insert_color</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vnode</span><span class="o">-&gt;</span><span class="n">server_rb</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">fs_vnodes</span><span class="p">);</span>

	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">fs_lock</span><span class="p">);</span>
	<span class="n">_leave</span><span class="p">(</span><span class="s">&quot;&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * insert a vnode into the promising server&#39;s update/expiration tree</span>
<span class="cm"> * - caller must hold vnode-&gt;lock</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">afs_vnode_note_promise</span><span class="p">(</span><span class="k">struct</span> <span class="n">afs_vnode</span> <span class="o">*</span><span class="n">vnode</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">afs_server</span> <span class="o">*</span><span class="n">server</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">afs_server</span> <span class="o">*</span><span class="n">old_server</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">afs_vnode</span> <span class="o">*</span><span class="n">xvnode</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rb_node</span> <span class="o">*</span><span class="n">parent</span><span class="p">,</span> <span class="o">**</span><span class="n">p</span><span class="p">;</span>

	<span class="n">_enter</span><span class="p">(</span><span class="s">&quot;%p,%p&quot;</span><span class="p">,</span> <span class="n">vnode</span><span class="p">,</span> <span class="n">server</span><span class="p">);</span>

	<span class="n">ASSERT</span><span class="p">(</span><span class="n">server</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="n">old_server</span> <span class="o">=</span> <span class="n">vnode</span><span class="o">-&gt;</span><span class="n">server</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vnode</span><span class="o">-&gt;</span><span class="n">cb_promised</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">server</span> <span class="o">==</span> <span class="n">old_server</span> <span class="o">&amp;&amp;</span>
		    <span class="n">vnode</span><span class="o">-&gt;</span><span class="n">cb_expires</span> <span class="o">==</span> <span class="n">vnode</span><span class="o">-&gt;</span><span class="n">cb_expires_at</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">_leave</span><span class="p">(</span><span class="s">&quot; [no change]&quot;</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">old_server</span><span class="o">-&gt;</span><span class="n">cb_lock</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">vnode</span><span class="o">-&gt;</span><span class="n">cb_promised</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">_debug</span><span class="p">(</span><span class="s">&quot;delete&quot;</span><span class="p">);</span>
			<span class="n">rb_erase</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vnode</span><span class="o">-&gt;</span><span class="n">cb_promise</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">old_server</span><span class="o">-&gt;</span><span class="n">cb_promises</span><span class="p">);</span>
			<span class="n">vnode</span><span class="o">-&gt;</span><span class="n">cb_promised</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">old_server</span><span class="o">-&gt;</span><span class="n">cb_lock</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vnode</span><span class="o">-&gt;</span><span class="n">server</span> <span class="o">!=</span> <span class="n">server</span><span class="p">)</span>
		<span class="n">afs_install_vnode</span><span class="p">(</span><span class="n">vnode</span><span class="p">,</span> <span class="n">server</span><span class="p">);</span>

	<span class="n">vnode</span><span class="o">-&gt;</span><span class="n">cb_expires_at</span> <span class="o">=</span> <span class="n">vnode</span><span class="o">-&gt;</span><span class="n">cb_expires</span><span class="p">;</span>
	<span class="n">_debug</span><span class="p">(</span><span class="s">&quot;PROMISE on %p {%lu}&quot;</span><span class="p">,</span>
	       <span class="n">vnode</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">vnode</span><span class="o">-&gt;</span><span class="n">cb_expires_at</span><span class="p">);</span>

	<span class="cm">/* abuse an RB-tree to hold the expiration order (we may have multiple</span>
<span class="cm">	 * items with the same expiration time) */</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">cb_lock</span><span class="p">);</span>

	<span class="n">parent</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">p</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">cb_promises</span><span class="p">.</span><span class="n">rb_node</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">*</span><span class="n">p</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">parent</span> <span class="o">=</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
		<span class="n">xvnode</span> <span class="o">=</span> <span class="n">rb_entry</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span> <span class="k">struct</span> <span class="n">afs_vnode</span><span class="p">,</span> <span class="n">cb_promise</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">vnode</span><span class="o">-&gt;</span><span class="n">cb_expires_at</span> <span class="o">&lt;</span> <span class="n">xvnode</span><span class="o">-&gt;</span><span class="n">cb_expires_at</span><span class="p">)</span>
			<span class="n">p</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="o">*</span><span class="n">p</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">rb_left</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">p</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="o">*</span><span class="n">p</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">rb_right</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rb_link_node</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vnode</span><span class="o">-&gt;</span><span class="n">cb_promise</span><span class="p">,</span> <span class="n">parent</span><span class="p">,</span> <span class="n">p</span><span class="p">);</span>
	<span class="n">rb_insert_color</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vnode</span><span class="o">-&gt;</span><span class="n">cb_promise</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">cb_promises</span><span class="p">);</span>
	<span class="n">vnode</span><span class="o">-&gt;</span><span class="n">cb_promised</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">cb_lock</span><span class="p">);</span>
	<span class="n">_leave</span><span class="p">(</span><span class="s">&quot;&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * handle remote file deletion by discarding the callback promise</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">afs_vnode_deleted_remotely</span><span class="p">(</span><span class="k">struct</span> <span class="n">afs_vnode</span> <span class="o">*</span><span class="n">vnode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">afs_server</span> <span class="o">*</span><span class="n">server</span><span class="p">;</span>

	<span class="n">_enter</span><span class="p">(</span><span class="s">&quot;{%p}&quot;</span><span class="p">,</span> <span class="n">vnode</span><span class="o">-&gt;</span><span class="n">server</span><span class="p">);</span>

	<span class="n">set_bit</span><span class="p">(</span><span class="n">AFS_VNODE_DELETED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vnode</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>

	<span class="n">server</span> <span class="o">=</span> <span class="n">vnode</span><span class="o">-&gt;</span><span class="n">server</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">server</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">vnode</span><span class="o">-&gt;</span><span class="n">cb_promised</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">cb_lock</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">vnode</span><span class="o">-&gt;</span><span class="n">cb_promised</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">rb_erase</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vnode</span><span class="o">-&gt;</span><span class="n">cb_promise</span><span class="p">,</span>
					 <span class="o">&amp;</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">cb_promises</span><span class="p">);</span>
				<span class="n">vnode</span><span class="o">-&gt;</span><span class="n">cb_promised</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">cb_lock</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">fs_lock</span><span class="p">);</span>
		<span class="n">rb_erase</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vnode</span><span class="o">-&gt;</span><span class="n">server_rb</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">fs_vnodes</span><span class="p">);</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">fs_lock</span><span class="p">);</span>

		<span class="n">vnode</span><span class="o">-&gt;</span><span class="n">server</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">afs_put_server</span><span class="p">(</span><span class="n">server</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ASSERT</span><span class="p">(</span><span class="o">!</span><span class="n">vnode</span><span class="o">-&gt;</span><span class="n">cb_promised</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">_leave</span><span class="p">(</span><span class="s">&quot;&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * finish off updating the recorded status of a file after a successful</span>
<span class="cm"> * operation completion</span>
<span class="cm"> * - starts callback expiry timer</span>
<span class="cm"> * - adds to server&#39;s callback list</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">afs_vnode_finalise_status_update</span><span class="p">(</span><span class="k">struct</span> <span class="n">afs_vnode</span> <span class="o">*</span><span class="n">vnode</span><span class="p">,</span>
				      <span class="k">struct</span> <span class="n">afs_server</span> <span class="o">*</span><span class="n">server</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">afs_server</span> <span class="o">*</span><span class="n">oldserver</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">_enter</span><span class="p">(</span><span class="s">&quot;%p,%p&quot;</span><span class="p">,</span> <span class="n">vnode</span><span class="p">,</span> <span class="n">server</span><span class="p">);</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vnode</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">clear_bit</span><span class="p">(</span><span class="n">AFS_VNODE_CB_BROKEN</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vnode</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">afs_vnode_note_promise</span><span class="p">(</span><span class="n">vnode</span><span class="p">,</span> <span class="n">server</span><span class="p">);</span>
	<span class="n">vnode</span><span class="o">-&gt;</span><span class="n">update_cnt</span><span class="o">--</span><span class="p">;</span>
	<span class="n">ASSERTCMP</span><span class="p">(</span><span class="n">vnode</span><span class="o">-&gt;</span><span class="n">update_cnt</span><span class="p">,</span> <span class="o">&gt;=</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vnode</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="n">wake_up_all</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vnode</span><span class="o">-&gt;</span><span class="n">update_waitq</span><span class="p">);</span>
	<span class="n">afs_put_server</span><span class="p">(</span><span class="n">oldserver</span><span class="p">);</span>
	<span class="n">_leave</span><span class="p">(</span><span class="s">&quot;&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * finish off updating the recorded status of a file after an operation failed</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">afs_vnode_status_update_failed</span><span class="p">(</span><span class="k">struct</span> <span class="n">afs_vnode</span> <span class="o">*</span><span class="n">vnode</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ret</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">_enter</span><span class="p">(</span><span class="s">&quot;{%x:%u},%d&quot;</span><span class="p">,</span> <span class="n">vnode</span><span class="o">-&gt;</span><span class="n">fid</span><span class="p">.</span><span class="n">vid</span><span class="p">,</span> <span class="n">vnode</span><span class="o">-&gt;</span><span class="n">fid</span><span class="p">.</span><span class="n">vnode</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vnode</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="n">clear_bit</span><span class="p">(</span><span class="n">AFS_VNODE_CB_BROKEN</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vnode</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* the file was deleted on the server */</span>
		<span class="n">_debug</span><span class="p">(</span><span class="s">&quot;got NOENT from server - marking file deleted&quot;</span><span class="p">);</span>
		<span class="n">afs_vnode_deleted_remotely</span><span class="p">(</span><span class="n">vnode</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">vnode</span><span class="o">-&gt;</span><span class="n">update_cnt</span><span class="o">--</span><span class="p">;</span>
	<span class="n">ASSERTCMP</span><span class="p">(</span><span class="n">vnode</span><span class="o">-&gt;</span><span class="n">update_cnt</span><span class="p">,</span> <span class="o">&gt;=</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vnode</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="n">wake_up_all</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vnode</span><span class="o">-&gt;</span><span class="n">update_waitq</span><span class="p">);</span>
	<span class="n">_leave</span><span class="p">(</span><span class="s">&quot;&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * fetch file status from the volume</span>
<span class="cm"> * - don&#39;t issue a fetch if:</span>
<span class="cm"> *   - the changed bit is not set and there&#39;s a valid callback</span>
<span class="cm"> *   - there are any outstanding ops that will fetch the status</span>
<span class="cm"> * - TODO implement local caching</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">afs_vnode_fetch_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">afs_vnode</span> <span class="o">*</span><span class="n">vnode</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">afs_vnode</span> <span class="o">*</span><span class="n">auth_vnode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">key</span> <span class="o">*</span><span class="n">key</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">afs_server</span> <span class="o">*</span><span class="n">server</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">acl_order</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">DECLARE_WAITQUEUE</span><span class="p">(</span><span class="n">myself</span><span class="p">,</span> <span class="n">current</span><span class="p">);</span>

	<span class="n">_enter</span><span class="p">(</span><span class="s">&quot;%s,{%x:%u.%u}&quot;</span><span class="p">,</span>
	       <span class="n">vnode</span><span class="o">-&gt;</span><span class="n">volume</span><span class="o">-&gt;</span><span class="n">vlocation</span><span class="o">-&gt;</span><span class="n">vldb</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
	       <span class="n">vnode</span><span class="o">-&gt;</span><span class="n">fid</span><span class="p">.</span><span class="n">vid</span><span class="p">,</span> <span class="n">vnode</span><span class="o">-&gt;</span><span class="n">fid</span><span class="p">.</span><span class="n">vnode</span><span class="p">,</span> <span class="n">vnode</span><span class="o">-&gt;</span><span class="n">fid</span><span class="p">.</span><span class="n">unique</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">AFS_VNODE_CB_BROKEN</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vnode</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">vnode</span><span class="o">-&gt;</span><span class="n">cb_promised</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">_leave</span><span class="p">(</span><span class="s">&quot; [unchanged]&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">AFS_VNODE_DELETED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vnode</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">_leave</span><span class="p">(</span><span class="s">&quot; [deleted]&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">acl_order</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">auth_vnode</span><span class="p">)</span>
		<span class="n">acl_order</span> <span class="o">=</span> <span class="n">auth_vnode</span><span class="o">-&gt;</span><span class="n">acl_order</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vnode</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">AFS_VNODE_CB_BROKEN</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vnode</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">vnode</span><span class="o">-&gt;</span><span class="n">cb_promised</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vnode</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="n">_leave</span><span class="p">(</span><span class="s">&quot; [unchanged]&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ASSERTCMP</span><span class="p">(</span><span class="n">vnode</span><span class="o">-&gt;</span><span class="n">update_cnt</span><span class="p">,</span> <span class="o">&gt;=</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vnode</span><span class="o">-&gt;</span><span class="n">update_cnt</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* someone else started a fetch */</span>
		<span class="n">_debug</span><span class="p">(</span><span class="s">&quot;wait on fetch %d&quot;</span><span class="p">,</span> <span class="n">vnode</span><span class="o">-&gt;</span><span class="n">update_cnt</span><span class="p">);</span>

		<span class="n">set_current_state</span><span class="p">(</span><span class="n">TASK_UNINTERRUPTIBLE</span><span class="p">);</span>
		<span class="n">ASSERT</span><span class="p">(</span><span class="n">myself</span><span class="p">.</span><span class="n">func</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="n">add_wait_queue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vnode</span><span class="o">-&gt;</span><span class="n">update_waitq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">myself</span><span class="p">);</span>

		<span class="cm">/* wait for the status to be updated */</span>
		<span class="k">for</span> <span class="p">(;;)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">AFS_VNODE_CB_BROKEN</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vnode</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">AFS_VNODE_DELETED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vnode</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
				<span class="k">break</span><span class="p">;</span>

			<span class="cm">/* check to see if it got updated and invalidated all</span>
<span class="cm">			 * before we saw it */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">vnode</span><span class="o">-&gt;</span><span class="n">update_cnt</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">remove_wait_queue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vnode</span><span class="o">-&gt;</span><span class="n">update_waitq</span><span class="p">,</span>
						  <span class="o">&amp;</span><span class="n">myself</span><span class="p">);</span>
				<span class="n">set_current_state</span><span class="p">(</span><span class="n">TASK_RUNNING</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">get_anyway</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vnode</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

			<span class="n">schedule</span><span class="p">();</span>
			<span class="n">set_current_state</span><span class="p">(</span><span class="n">TASK_UNINTERRUPTIBLE</span><span class="p">);</span>

			<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vnode</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">remove_wait_queue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vnode</span><span class="o">-&gt;</span><span class="n">update_waitq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">myself</span><span class="p">);</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vnode</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="n">set_current_state</span><span class="p">(</span><span class="n">TASK_RUNNING</span><span class="p">);</span>

		<span class="k">return</span> <span class="n">test_bit</span><span class="p">(</span><span class="n">AFS_VNODE_DELETED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vnode</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">)</span> <span class="o">?</span>
			<span class="o">-</span><span class="n">ENOENT</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">get_anyway:</span>
	<span class="cm">/* okay... we&#39;re going to have to initiate the op */</span>
	<span class="n">vnode</span><span class="o">-&gt;</span><span class="n">update_cnt</span><span class="o">++</span><span class="p">;</span>

	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vnode</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="cm">/* merge AFS status fetches and clear outstanding callback on this</span>
<span class="cm">	 * vnode */</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="cm">/* pick a server to query */</span>
		<span class="n">server</span> <span class="o">=</span> <span class="n">afs_volume_pick_fileserver</span><span class="p">(</span><span class="n">vnode</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">server</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">no_server</span><span class="p">;</span>

		<span class="n">_debug</span><span class="p">(</span><span class="s">&quot;USING SERVER: %p{%08x}&quot;</span><span class="p">,</span>
		       <span class="n">server</span><span class="p">,</span> <span class="n">ntohl</span><span class="p">(</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">.</span><span class="n">s_addr</span><span class="p">));</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">afs_fs_fetch_file_status</span><span class="p">(</span><span class="n">server</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">vnode</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span>
					       <span class="o">&amp;</span><span class="n">afs_sync_call</span><span class="p">);</span>

	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">afs_volume_release_fileserver</span><span class="p">(</span><span class="n">vnode</span><span class="p">,</span> <span class="n">server</span><span class="p">,</span> <span class="n">ret</span><span class="p">));</span>

	<span class="cm">/* adjust the flags */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">_debug</span><span class="p">(</span><span class="s">&quot;adjust&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">auth_vnode</span><span class="p">)</span>
			<span class="n">afs_cache_permit</span><span class="p">(</span><span class="n">vnode</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">acl_order</span><span class="p">);</span>
		<span class="n">afs_vnode_finalise_status_update</span><span class="p">(</span><span class="n">vnode</span><span class="p">,</span> <span class="n">server</span><span class="p">);</span>
		<span class="n">afs_put_server</span><span class="p">(</span><span class="n">server</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">_debug</span><span class="p">(</span><span class="s">&quot;failed [%d]&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="n">afs_vnode_status_update_failed</span><span class="p">(</span><span class="n">vnode</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">ASSERTCMP</span><span class="p">(</span><span class="n">vnode</span><span class="o">-&gt;</span><span class="n">update_cnt</span><span class="p">,</span> <span class="o">&gt;=</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">_leave</span><span class="p">(</span><span class="s">&quot; = %d [cnt %d]&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">,</span> <span class="n">vnode</span><span class="o">-&gt;</span><span class="n">update_cnt</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

<span class="nl">no_server:</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vnode</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">vnode</span><span class="o">-&gt;</span><span class="n">update_cnt</span><span class="o">--</span><span class="p">;</span>
	<span class="n">ASSERTCMP</span><span class="p">(</span><span class="n">vnode</span><span class="o">-&gt;</span><span class="n">update_cnt</span><span class="p">,</span> <span class="o">&gt;=</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vnode</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">_leave</span><span class="p">(</span><span class="s">&quot; = %ld [cnt %d]&quot;</span><span class="p">,</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">server</span><span class="p">),</span> <span class="n">vnode</span><span class="o">-&gt;</span><span class="n">update_cnt</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">server</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * fetch file data from the volume</span>
<span class="cm"> * - TODO implement caching</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">afs_vnode_fetch_data</span><span class="p">(</span><span class="k">struct</span> <span class="n">afs_vnode</span> <span class="o">*</span><span class="n">vnode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">key</span> <span class="o">*</span><span class="n">key</span><span class="p">,</span>
			 <span class="kt">off_t</span> <span class="n">offset</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">length</span><span class="p">,</span> <span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="n">page</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">afs_server</span> <span class="o">*</span><span class="n">server</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">_enter</span><span class="p">(</span><span class="s">&quot;%s{%x:%u.%u},%x,,,&quot;</span><span class="p">,</span>
	       <span class="n">vnode</span><span class="o">-&gt;</span><span class="n">volume</span><span class="o">-&gt;</span><span class="n">vlocation</span><span class="o">-&gt;</span><span class="n">vldb</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
	       <span class="n">vnode</span><span class="o">-&gt;</span><span class="n">fid</span><span class="p">.</span><span class="n">vid</span><span class="p">,</span>
	       <span class="n">vnode</span><span class="o">-&gt;</span><span class="n">fid</span><span class="p">.</span><span class="n">vnode</span><span class="p">,</span>
	       <span class="n">vnode</span><span class="o">-&gt;</span><span class="n">fid</span><span class="p">.</span><span class="n">unique</span><span class="p">,</span>
	       <span class="n">key_serial</span><span class="p">(</span><span class="n">key</span><span class="p">));</span>

	<span class="cm">/* this op will fetch the status */</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vnode</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">vnode</span><span class="o">-&gt;</span><span class="n">update_cnt</span><span class="o">++</span><span class="p">;</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vnode</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="cm">/* merge in AFS status fetches and clear outstanding callback on this</span>
<span class="cm">	 * vnode */</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="cm">/* pick a server to query */</span>
		<span class="n">server</span> <span class="o">=</span> <span class="n">afs_volume_pick_fileserver</span><span class="p">(</span><span class="n">vnode</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">server</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">no_server</span><span class="p">;</span>

		<span class="n">_debug</span><span class="p">(</span><span class="s">&quot;USING SERVER: %08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ntohl</span><span class="p">(</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">.</span><span class="n">s_addr</span><span class="p">));</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">afs_fs_fetch_data</span><span class="p">(</span><span class="n">server</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">vnode</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">length</span><span class="p">,</span>
					<span class="n">page</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">afs_sync_call</span><span class="p">);</span>

	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">afs_volume_release_fileserver</span><span class="p">(</span><span class="n">vnode</span><span class="p">,</span> <span class="n">server</span><span class="p">,</span> <span class="n">ret</span><span class="p">));</span>

	<span class="cm">/* adjust the flags */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">afs_vnode_finalise_status_update</span><span class="p">(</span><span class="n">vnode</span><span class="p">,</span> <span class="n">server</span><span class="p">);</span>
		<span class="n">afs_put_server</span><span class="p">(</span><span class="n">server</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">afs_vnode_status_update_failed</span><span class="p">(</span><span class="n">vnode</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">_leave</span><span class="p">(</span><span class="s">&quot; = %d&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

<span class="nl">no_server:</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vnode</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">vnode</span><span class="o">-&gt;</span><span class="n">update_cnt</span><span class="o">--</span><span class="p">;</span>
	<span class="n">ASSERTCMP</span><span class="p">(</span><span class="n">vnode</span><span class="o">-&gt;</span><span class="n">update_cnt</span><span class="p">,</span> <span class="o">&gt;=</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vnode</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">server</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * make a file or a directory</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">afs_vnode_create</span><span class="p">(</span><span class="k">struct</span> <span class="n">afs_vnode</span> <span class="o">*</span><span class="n">vnode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">key</span> <span class="o">*</span><span class="n">key</span><span class="p">,</span>
		     <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span> <span class="n">umode_t</span> <span class="n">mode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">afs_fid</span> <span class="o">*</span><span class="n">newfid</span><span class="p">,</span>
		     <span class="k">struct</span> <span class="n">afs_file_status</span> <span class="o">*</span><span class="n">newstatus</span><span class="p">,</span>
		     <span class="k">struct</span> <span class="n">afs_callback</span> <span class="o">*</span><span class="n">newcb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">afs_server</span> <span class="o">**</span><span class="n">_server</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">afs_server</span> <span class="o">*</span><span class="n">server</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">_enter</span><span class="p">(</span><span class="s">&quot;%s{%x:%u.%u},%x,%s,,&quot;</span><span class="p">,</span>
	       <span class="n">vnode</span><span class="o">-&gt;</span><span class="n">volume</span><span class="o">-&gt;</span><span class="n">vlocation</span><span class="o">-&gt;</span><span class="n">vldb</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
	       <span class="n">vnode</span><span class="o">-&gt;</span><span class="n">fid</span><span class="p">.</span><span class="n">vid</span><span class="p">,</span>
	       <span class="n">vnode</span><span class="o">-&gt;</span><span class="n">fid</span><span class="p">.</span><span class="n">vnode</span><span class="p">,</span>
	       <span class="n">vnode</span><span class="o">-&gt;</span><span class="n">fid</span><span class="p">.</span><span class="n">unique</span><span class="p">,</span>
	       <span class="n">key_serial</span><span class="p">(</span><span class="n">key</span><span class="p">),</span>
	       <span class="n">name</span><span class="p">);</span>

	<span class="cm">/* this op will fetch the status on the directory we&#39;re creating in */</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vnode</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">vnode</span><span class="o">-&gt;</span><span class="n">update_cnt</span><span class="o">++</span><span class="p">;</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vnode</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="cm">/* pick a server to query */</span>
		<span class="n">server</span> <span class="o">=</span> <span class="n">afs_volume_pick_fileserver</span><span class="p">(</span><span class="n">vnode</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">server</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">no_server</span><span class="p">;</span>

		<span class="n">_debug</span><span class="p">(</span><span class="s">&quot;USING SERVER: %08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ntohl</span><span class="p">(</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">.</span><span class="n">s_addr</span><span class="p">));</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">afs_fs_create</span><span class="p">(</span><span class="n">server</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">vnode</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">newfid</span><span class="p">,</span>
				    <span class="n">newstatus</span><span class="p">,</span> <span class="n">newcb</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">afs_sync_call</span><span class="p">);</span>

	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">afs_volume_release_fileserver</span><span class="p">(</span><span class="n">vnode</span><span class="p">,</span> <span class="n">server</span><span class="p">,</span> <span class="n">ret</span><span class="p">));</span>

	<span class="cm">/* adjust the flags */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">afs_vnode_finalise_status_update</span><span class="p">(</span><span class="n">vnode</span><span class="p">,</span> <span class="n">server</span><span class="p">);</span>
		<span class="o">*</span><span class="n">_server</span> <span class="o">=</span> <span class="n">server</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">afs_vnode_status_update_failed</span><span class="p">(</span><span class="n">vnode</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="o">*</span><span class="n">_server</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">_leave</span><span class="p">(</span><span class="s">&quot; = %d [cnt %d]&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">,</span> <span class="n">vnode</span><span class="o">-&gt;</span><span class="n">update_cnt</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

<span class="nl">no_server:</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vnode</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">vnode</span><span class="o">-&gt;</span><span class="n">update_cnt</span><span class="o">--</span><span class="p">;</span>
	<span class="n">ASSERTCMP</span><span class="p">(</span><span class="n">vnode</span><span class="o">-&gt;</span><span class="n">update_cnt</span><span class="p">,</span> <span class="o">&gt;=</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vnode</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">_leave</span><span class="p">(</span><span class="s">&quot; = %ld [cnt %d]&quot;</span><span class="p">,</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">server</span><span class="p">),</span> <span class="n">vnode</span><span class="o">-&gt;</span><span class="n">update_cnt</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">server</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * remove a file or directory</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">afs_vnode_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">afs_vnode</span> <span class="o">*</span><span class="n">vnode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">key</span> <span class="o">*</span><span class="n">key</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span>
		     <span class="n">bool</span> <span class="n">isdir</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">afs_server</span> <span class="o">*</span><span class="n">server</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">_enter</span><span class="p">(</span><span class="s">&quot;%s{%x:%u.%u},%x,%s&quot;</span><span class="p">,</span>
	       <span class="n">vnode</span><span class="o">-&gt;</span><span class="n">volume</span><span class="o">-&gt;</span><span class="n">vlocation</span><span class="o">-&gt;</span><span class="n">vldb</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
	       <span class="n">vnode</span><span class="o">-&gt;</span><span class="n">fid</span><span class="p">.</span><span class="n">vid</span><span class="p">,</span>
	       <span class="n">vnode</span><span class="o">-&gt;</span><span class="n">fid</span><span class="p">.</span><span class="n">vnode</span><span class="p">,</span>
	       <span class="n">vnode</span><span class="o">-&gt;</span><span class="n">fid</span><span class="p">.</span><span class="n">unique</span><span class="p">,</span>
	       <span class="n">key_serial</span><span class="p">(</span><span class="n">key</span><span class="p">),</span>
	       <span class="n">name</span><span class="p">);</span>

	<span class="cm">/* this op will fetch the status on the directory we&#39;re removing from */</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vnode</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">vnode</span><span class="o">-&gt;</span><span class="n">update_cnt</span><span class="o">++</span><span class="p">;</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vnode</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="cm">/* pick a server to query */</span>
		<span class="n">server</span> <span class="o">=</span> <span class="n">afs_volume_pick_fileserver</span><span class="p">(</span><span class="n">vnode</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">server</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">no_server</span><span class="p">;</span>

		<span class="n">_debug</span><span class="p">(</span><span class="s">&quot;USING SERVER: %08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ntohl</span><span class="p">(</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">.</span><span class="n">s_addr</span><span class="p">));</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">afs_fs_remove</span><span class="p">(</span><span class="n">server</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">vnode</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">isdir</span><span class="p">,</span>
				    <span class="o">&amp;</span><span class="n">afs_sync_call</span><span class="p">);</span>

	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">afs_volume_release_fileserver</span><span class="p">(</span><span class="n">vnode</span><span class="p">,</span> <span class="n">server</span><span class="p">,</span> <span class="n">ret</span><span class="p">));</span>

	<span class="cm">/* adjust the flags */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">afs_vnode_finalise_status_update</span><span class="p">(</span><span class="n">vnode</span><span class="p">,</span> <span class="n">server</span><span class="p">);</span>
		<span class="n">afs_put_server</span><span class="p">(</span><span class="n">server</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">afs_vnode_status_update_failed</span><span class="p">(</span><span class="n">vnode</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">_leave</span><span class="p">(</span><span class="s">&quot; = %d [cnt %d]&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">,</span> <span class="n">vnode</span><span class="o">-&gt;</span><span class="n">update_cnt</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

<span class="nl">no_server:</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vnode</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">vnode</span><span class="o">-&gt;</span><span class="n">update_cnt</span><span class="o">--</span><span class="p">;</span>
	<span class="n">ASSERTCMP</span><span class="p">(</span><span class="n">vnode</span><span class="o">-&gt;</span><span class="n">update_cnt</span><span class="p">,</span> <span class="o">&gt;=</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vnode</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">_leave</span><span class="p">(</span><span class="s">&quot; = %ld [cnt %d]&quot;</span><span class="p">,</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">server</span><span class="p">),</span> <span class="n">vnode</span><span class="o">-&gt;</span><span class="n">update_cnt</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">server</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * create a hard link</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">afs_vnode_link</span><span class="p">(</span><span class="k">struct</span> <span class="n">afs_vnode</span> <span class="o">*</span><span class="n">dvnode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">afs_vnode</span> <span class="o">*</span><span class="n">vnode</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">key</span> <span class="o">*</span><span class="n">key</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">afs_server</span> <span class="o">*</span><span class="n">server</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">_enter</span><span class="p">(</span><span class="s">&quot;%s{%x:%u.%u},%s{%x:%u.%u},%x,%s&quot;</span><span class="p">,</span>
	       <span class="n">dvnode</span><span class="o">-&gt;</span><span class="n">volume</span><span class="o">-&gt;</span><span class="n">vlocation</span><span class="o">-&gt;</span><span class="n">vldb</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
	       <span class="n">dvnode</span><span class="o">-&gt;</span><span class="n">fid</span><span class="p">.</span><span class="n">vid</span><span class="p">,</span>
	       <span class="n">dvnode</span><span class="o">-&gt;</span><span class="n">fid</span><span class="p">.</span><span class="n">vnode</span><span class="p">,</span>
	       <span class="n">dvnode</span><span class="o">-&gt;</span><span class="n">fid</span><span class="p">.</span><span class="n">unique</span><span class="p">,</span>
	       <span class="n">vnode</span><span class="o">-&gt;</span><span class="n">volume</span><span class="o">-&gt;</span><span class="n">vlocation</span><span class="o">-&gt;</span><span class="n">vldb</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
	       <span class="n">vnode</span><span class="o">-&gt;</span><span class="n">fid</span><span class="p">.</span><span class="n">vid</span><span class="p">,</span>
	       <span class="n">vnode</span><span class="o">-&gt;</span><span class="n">fid</span><span class="p">.</span><span class="n">vnode</span><span class="p">,</span>
	       <span class="n">vnode</span><span class="o">-&gt;</span><span class="n">fid</span><span class="p">.</span><span class="n">unique</span><span class="p">,</span>
	       <span class="n">key_serial</span><span class="p">(</span><span class="n">key</span><span class="p">),</span>
	       <span class="n">name</span><span class="p">);</span>

	<span class="cm">/* this op will fetch the status on the directory we&#39;re removing from */</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vnode</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">vnode</span><span class="o">-&gt;</span><span class="n">update_cnt</span><span class="o">++</span><span class="p">;</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vnode</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dvnode</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">dvnode</span><span class="o">-&gt;</span><span class="n">update_cnt</span><span class="o">++</span><span class="p">;</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dvnode</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="cm">/* pick a server to query */</span>
		<span class="n">server</span> <span class="o">=</span> <span class="n">afs_volume_pick_fileserver</span><span class="p">(</span><span class="n">dvnode</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">server</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">no_server</span><span class="p">;</span>

		<span class="n">_debug</span><span class="p">(</span><span class="s">&quot;USING SERVER: %08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ntohl</span><span class="p">(</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">.</span><span class="n">s_addr</span><span class="p">));</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">afs_fs_link</span><span class="p">(</span><span class="n">server</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">dvnode</span><span class="p">,</span> <span class="n">vnode</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span>
				  <span class="o">&amp;</span><span class="n">afs_sync_call</span><span class="p">);</span>

	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">afs_volume_release_fileserver</span><span class="p">(</span><span class="n">dvnode</span><span class="p">,</span> <span class="n">server</span><span class="p">,</span> <span class="n">ret</span><span class="p">));</span>

	<span class="cm">/* adjust the flags */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">afs_vnode_finalise_status_update</span><span class="p">(</span><span class="n">vnode</span><span class="p">,</span> <span class="n">server</span><span class="p">);</span>
		<span class="n">afs_vnode_finalise_status_update</span><span class="p">(</span><span class="n">dvnode</span><span class="p">,</span> <span class="n">server</span><span class="p">);</span>
		<span class="n">afs_put_server</span><span class="p">(</span><span class="n">server</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">afs_vnode_status_update_failed</span><span class="p">(</span><span class="n">vnode</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="n">afs_vnode_status_update_failed</span><span class="p">(</span><span class="n">dvnode</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">_leave</span><span class="p">(</span><span class="s">&quot; = %d [cnt %d]&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">,</span> <span class="n">vnode</span><span class="o">-&gt;</span><span class="n">update_cnt</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

<span class="nl">no_server:</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vnode</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">vnode</span><span class="o">-&gt;</span><span class="n">update_cnt</span><span class="o">--</span><span class="p">;</span>
	<span class="n">ASSERTCMP</span><span class="p">(</span><span class="n">vnode</span><span class="o">-&gt;</span><span class="n">update_cnt</span><span class="p">,</span> <span class="o">&gt;=</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vnode</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dvnode</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">dvnode</span><span class="o">-&gt;</span><span class="n">update_cnt</span><span class="o">--</span><span class="p">;</span>
	<span class="n">ASSERTCMP</span><span class="p">(</span><span class="n">dvnode</span><span class="o">-&gt;</span><span class="n">update_cnt</span><span class="p">,</span> <span class="o">&gt;=</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dvnode</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">_leave</span><span class="p">(</span><span class="s">&quot; = %ld [cnt %d]&quot;</span><span class="p">,</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">server</span><span class="p">),</span> <span class="n">vnode</span><span class="o">-&gt;</span><span class="n">update_cnt</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">server</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * create a symbolic link</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">afs_vnode_symlink</span><span class="p">(</span><span class="k">struct</span> <span class="n">afs_vnode</span> <span class="o">*</span><span class="n">vnode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">key</span> <span class="o">*</span><span class="n">key</span><span class="p">,</span>
		      <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">content</span><span class="p">,</span>
		      <span class="k">struct</span> <span class="n">afs_fid</span> <span class="o">*</span><span class="n">newfid</span><span class="p">,</span>
		      <span class="k">struct</span> <span class="n">afs_file_status</span> <span class="o">*</span><span class="n">newstatus</span><span class="p">,</span>
		      <span class="k">struct</span> <span class="n">afs_server</span> <span class="o">**</span><span class="n">_server</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">afs_server</span> <span class="o">*</span><span class="n">server</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">_enter</span><span class="p">(</span><span class="s">&quot;%s{%x:%u.%u},%x,%s,%s,,,&quot;</span><span class="p">,</span>
	       <span class="n">vnode</span><span class="o">-&gt;</span><span class="n">volume</span><span class="o">-&gt;</span><span class="n">vlocation</span><span class="o">-&gt;</span><span class="n">vldb</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
	       <span class="n">vnode</span><span class="o">-&gt;</span><span class="n">fid</span><span class="p">.</span><span class="n">vid</span><span class="p">,</span>
	       <span class="n">vnode</span><span class="o">-&gt;</span><span class="n">fid</span><span class="p">.</span><span class="n">vnode</span><span class="p">,</span>
	       <span class="n">vnode</span><span class="o">-&gt;</span><span class="n">fid</span><span class="p">.</span><span class="n">unique</span><span class="p">,</span>
	       <span class="n">key_serial</span><span class="p">(</span><span class="n">key</span><span class="p">),</span>
	       <span class="n">name</span><span class="p">,</span> <span class="n">content</span><span class="p">);</span>

	<span class="cm">/* this op will fetch the status on the directory we&#39;re creating in */</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vnode</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">vnode</span><span class="o">-&gt;</span><span class="n">update_cnt</span><span class="o">++</span><span class="p">;</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vnode</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="cm">/* pick a server to query */</span>
		<span class="n">server</span> <span class="o">=</span> <span class="n">afs_volume_pick_fileserver</span><span class="p">(</span><span class="n">vnode</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">server</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">no_server</span><span class="p">;</span>

		<span class="n">_debug</span><span class="p">(</span><span class="s">&quot;USING SERVER: %08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ntohl</span><span class="p">(</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">.</span><span class="n">s_addr</span><span class="p">));</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">afs_fs_symlink</span><span class="p">(</span><span class="n">server</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">vnode</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">content</span><span class="p">,</span>
				     <span class="n">newfid</span><span class="p">,</span> <span class="n">newstatus</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">afs_sync_call</span><span class="p">);</span>

	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">afs_volume_release_fileserver</span><span class="p">(</span><span class="n">vnode</span><span class="p">,</span> <span class="n">server</span><span class="p">,</span> <span class="n">ret</span><span class="p">));</span>

	<span class="cm">/* adjust the flags */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">afs_vnode_finalise_status_update</span><span class="p">(</span><span class="n">vnode</span><span class="p">,</span> <span class="n">server</span><span class="p">);</span>
		<span class="o">*</span><span class="n">_server</span> <span class="o">=</span> <span class="n">server</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">afs_vnode_status_update_failed</span><span class="p">(</span><span class="n">vnode</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="o">*</span><span class="n">_server</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">_leave</span><span class="p">(</span><span class="s">&quot; = %d [cnt %d]&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">,</span> <span class="n">vnode</span><span class="o">-&gt;</span><span class="n">update_cnt</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

<span class="nl">no_server:</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vnode</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">vnode</span><span class="o">-&gt;</span><span class="n">update_cnt</span><span class="o">--</span><span class="p">;</span>
	<span class="n">ASSERTCMP</span><span class="p">(</span><span class="n">vnode</span><span class="o">-&gt;</span><span class="n">update_cnt</span><span class="p">,</span> <span class="o">&gt;=</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vnode</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">_leave</span><span class="p">(</span><span class="s">&quot; = %ld [cnt %d]&quot;</span><span class="p">,</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">server</span><span class="p">),</span> <span class="n">vnode</span><span class="o">-&gt;</span><span class="n">update_cnt</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">server</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * rename a file</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">afs_vnode_rename</span><span class="p">(</span><span class="k">struct</span> <span class="n">afs_vnode</span> <span class="o">*</span><span class="n">orig_dvnode</span><span class="p">,</span>
		     <span class="k">struct</span> <span class="n">afs_vnode</span> <span class="o">*</span><span class="n">new_dvnode</span><span class="p">,</span>
		     <span class="k">struct</span> <span class="n">key</span> <span class="o">*</span><span class="n">key</span><span class="p">,</span>
		     <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">orig_name</span><span class="p">,</span>
		     <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">new_name</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">afs_server</span> <span class="o">*</span><span class="n">server</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">_enter</span><span class="p">(</span><span class="s">&quot;%s{%x:%u.%u},%s{%u,%u,%u},%x,%s,%s&quot;</span><span class="p">,</span>
	       <span class="n">orig_dvnode</span><span class="o">-&gt;</span><span class="n">volume</span><span class="o">-&gt;</span><span class="n">vlocation</span><span class="o">-&gt;</span><span class="n">vldb</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
	       <span class="n">orig_dvnode</span><span class="o">-&gt;</span><span class="n">fid</span><span class="p">.</span><span class="n">vid</span><span class="p">,</span>
	       <span class="n">orig_dvnode</span><span class="o">-&gt;</span><span class="n">fid</span><span class="p">.</span><span class="n">vnode</span><span class="p">,</span>
	       <span class="n">orig_dvnode</span><span class="o">-&gt;</span><span class="n">fid</span><span class="p">.</span><span class="n">unique</span><span class="p">,</span>
	       <span class="n">new_dvnode</span><span class="o">-&gt;</span><span class="n">volume</span><span class="o">-&gt;</span><span class="n">vlocation</span><span class="o">-&gt;</span><span class="n">vldb</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
	       <span class="n">new_dvnode</span><span class="o">-&gt;</span><span class="n">fid</span><span class="p">.</span><span class="n">vid</span><span class="p">,</span>
	       <span class="n">new_dvnode</span><span class="o">-&gt;</span><span class="n">fid</span><span class="p">.</span><span class="n">vnode</span><span class="p">,</span>
	       <span class="n">new_dvnode</span><span class="o">-&gt;</span><span class="n">fid</span><span class="p">.</span><span class="n">unique</span><span class="p">,</span>
	       <span class="n">key_serial</span><span class="p">(</span><span class="n">key</span><span class="p">),</span>
	       <span class="n">orig_name</span><span class="p">,</span>
	       <span class="n">new_name</span><span class="p">);</span>

	<span class="cm">/* this op will fetch the status on both the directories we&#39;re dealing</span>
<span class="cm">	 * with */</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">orig_dvnode</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">orig_dvnode</span><span class="o">-&gt;</span><span class="n">update_cnt</span><span class="o">++</span><span class="p">;</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">orig_dvnode</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">new_dvnode</span> <span class="o">!=</span> <span class="n">orig_dvnode</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">new_dvnode</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="n">new_dvnode</span><span class="o">-&gt;</span><span class="n">update_cnt</span><span class="o">++</span><span class="p">;</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">new_dvnode</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="cm">/* pick a server to query */</span>
		<span class="n">server</span> <span class="o">=</span> <span class="n">afs_volume_pick_fileserver</span><span class="p">(</span><span class="n">orig_dvnode</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">server</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">no_server</span><span class="p">;</span>

		<span class="n">_debug</span><span class="p">(</span><span class="s">&quot;USING SERVER: %08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ntohl</span><span class="p">(</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">.</span><span class="n">s_addr</span><span class="p">));</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">afs_fs_rename</span><span class="p">(</span><span class="n">server</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">orig_dvnode</span><span class="p">,</span> <span class="n">orig_name</span><span class="p">,</span>
				    <span class="n">new_dvnode</span><span class="p">,</span> <span class="n">new_name</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">afs_sync_call</span><span class="p">);</span>

	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">afs_volume_release_fileserver</span><span class="p">(</span><span class="n">orig_dvnode</span><span class="p">,</span> <span class="n">server</span><span class="p">,</span> <span class="n">ret</span><span class="p">));</span>

	<span class="cm">/* adjust the flags */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">afs_vnode_finalise_status_update</span><span class="p">(</span><span class="n">orig_dvnode</span><span class="p">,</span> <span class="n">server</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">new_dvnode</span> <span class="o">!=</span> <span class="n">orig_dvnode</span><span class="p">)</span>
			<span class="n">afs_vnode_finalise_status_update</span><span class="p">(</span><span class="n">new_dvnode</span><span class="p">,</span> <span class="n">server</span><span class="p">);</span>
		<span class="n">afs_put_server</span><span class="p">(</span><span class="n">server</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">afs_vnode_status_update_failed</span><span class="p">(</span><span class="n">orig_dvnode</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">new_dvnode</span> <span class="o">!=</span> <span class="n">orig_dvnode</span><span class="p">)</span>
			<span class="n">afs_vnode_status_update_failed</span><span class="p">(</span><span class="n">new_dvnode</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">_leave</span><span class="p">(</span><span class="s">&quot; = %d [cnt %d]&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">,</span> <span class="n">orig_dvnode</span><span class="o">-&gt;</span><span class="n">update_cnt</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

<span class="nl">no_server:</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">orig_dvnode</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">orig_dvnode</span><span class="o">-&gt;</span><span class="n">update_cnt</span><span class="o">--</span><span class="p">;</span>
	<span class="n">ASSERTCMP</span><span class="p">(</span><span class="n">orig_dvnode</span><span class="o">-&gt;</span><span class="n">update_cnt</span><span class="p">,</span> <span class="o">&gt;=</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">orig_dvnode</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">new_dvnode</span> <span class="o">!=</span> <span class="n">orig_dvnode</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">new_dvnode</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="n">new_dvnode</span><span class="o">-&gt;</span><span class="n">update_cnt</span><span class="o">--</span><span class="p">;</span>
		<span class="n">ASSERTCMP</span><span class="p">(</span><span class="n">new_dvnode</span><span class="o">-&gt;</span><span class="n">update_cnt</span><span class="p">,</span> <span class="o">&gt;=</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">new_dvnode</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">_leave</span><span class="p">(</span><span class="s">&quot; = %ld [cnt %d]&quot;</span><span class="p">,</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">server</span><span class="p">),</span> <span class="n">orig_dvnode</span><span class="o">-&gt;</span><span class="n">update_cnt</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">server</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * write to a file</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">afs_vnode_store_data</span><span class="p">(</span><span class="k">struct</span> <span class="n">afs_writeback</span> <span class="o">*</span><span class="n">wb</span><span class="p">,</span> <span class="n">pgoff_t</span> <span class="n">first</span><span class="p">,</span> <span class="n">pgoff_t</span> <span class="n">last</span><span class="p">,</span>
			 <span class="kt">unsigned</span> <span class="n">offset</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">to</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">afs_server</span> <span class="o">*</span><span class="n">server</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">afs_vnode</span> <span class="o">*</span><span class="n">vnode</span> <span class="o">=</span> <span class="n">wb</span><span class="o">-&gt;</span><span class="n">vnode</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">_enter</span><span class="p">(</span><span class="s">&quot;%s{%x:%u.%u},%x,%lx,%lx,%x,%x&quot;</span><span class="p">,</span>
	       <span class="n">vnode</span><span class="o">-&gt;</span><span class="n">volume</span><span class="o">-&gt;</span><span class="n">vlocation</span><span class="o">-&gt;</span><span class="n">vldb</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
	       <span class="n">vnode</span><span class="o">-&gt;</span><span class="n">fid</span><span class="p">.</span><span class="n">vid</span><span class="p">,</span>
	       <span class="n">vnode</span><span class="o">-&gt;</span><span class="n">fid</span><span class="p">.</span><span class="n">vnode</span><span class="p">,</span>
	       <span class="n">vnode</span><span class="o">-&gt;</span><span class="n">fid</span><span class="p">.</span><span class="n">unique</span><span class="p">,</span>
	       <span class="n">key_serial</span><span class="p">(</span><span class="n">wb</span><span class="o">-&gt;</span><span class="n">key</span><span class="p">),</span>
	       <span class="n">first</span><span class="p">,</span> <span class="n">last</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">to</span><span class="p">);</span>

	<span class="cm">/* this op will fetch the status */</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vnode</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">vnode</span><span class="o">-&gt;</span><span class="n">update_cnt</span><span class="o">++</span><span class="p">;</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vnode</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="cm">/* pick a server to query */</span>
		<span class="n">server</span> <span class="o">=</span> <span class="n">afs_volume_pick_fileserver</span><span class="p">(</span><span class="n">vnode</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">server</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">no_server</span><span class="p">;</span>

		<span class="n">_debug</span><span class="p">(</span><span class="s">&quot;USING SERVER: %08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ntohl</span><span class="p">(</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">.</span><span class="n">s_addr</span><span class="p">));</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">afs_fs_store_data</span><span class="p">(</span><span class="n">server</span><span class="p">,</span> <span class="n">wb</span><span class="p">,</span> <span class="n">first</span><span class="p">,</span> <span class="n">last</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">to</span><span class="p">,</span>
					<span class="o">&amp;</span><span class="n">afs_sync_call</span><span class="p">);</span>

	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">afs_volume_release_fileserver</span><span class="p">(</span><span class="n">vnode</span><span class="p">,</span> <span class="n">server</span><span class="p">,</span> <span class="n">ret</span><span class="p">));</span>

	<span class="cm">/* adjust the flags */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">afs_vnode_finalise_status_update</span><span class="p">(</span><span class="n">vnode</span><span class="p">,</span> <span class="n">server</span><span class="p">);</span>
		<span class="n">afs_put_server</span><span class="p">(</span><span class="n">server</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">afs_vnode_status_update_failed</span><span class="p">(</span><span class="n">vnode</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">_leave</span><span class="p">(</span><span class="s">&quot; = %d&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

<span class="nl">no_server:</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vnode</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">vnode</span><span class="o">-&gt;</span><span class="n">update_cnt</span><span class="o">--</span><span class="p">;</span>
	<span class="n">ASSERTCMP</span><span class="p">(</span><span class="n">vnode</span><span class="o">-&gt;</span><span class="n">update_cnt</span><span class="p">,</span> <span class="o">&gt;=</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vnode</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">server</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * set the attributes on a file</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">afs_vnode_setattr</span><span class="p">(</span><span class="k">struct</span> <span class="n">afs_vnode</span> <span class="o">*</span><span class="n">vnode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">key</span> <span class="o">*</span><span class="n">key</span><span class="p">,</span>
		      <span class="k">struct</span> <span class="n">iattr</span> <span class="o">*</span><span class="n">attr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">afs_server</span> <span class="o">*</span><span class="n">server</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">_enter</span><span class="p">(</span><span class="s">&quot;%s{%x:%u.%u},%x&quot;</span><span class="p">,</span>
	       <span class="n">vnode</span><span class="o">-&gt;</span><span class="n">volume</span><span class="o">-&gt;</span><span class="n">vlocation</span><span class="o">-&gt;</span><span class="n">vldb</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
	       <span class="n">vnode</span><span class="o">-&gt;</span><span class="n">fid</span><span class="p">.</span><span class="n">vid</span><span class="p">,</span>
	       <span class="n">vnode</span><span class="o">-&gt;</span><span class="n">fid</span><span class="p">.</span><span class="n">vnode</span><span class="p">,</span>
	       <span class="n">vnode</span><span class="o">-&gt;</span><span class="n">fid</span><span class="p">.</span><span class="n">unique</span><span class="p">,</span>
	       <span class="n">key_serial</span><span class="p">(</span><span class="n">key</span><span class="p">));</span>

	<span class="cm">/* this op will fetch the status */</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vnode</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">vnode</span><span class="o">-&gt;</span><span class="n">update_cnt</span><span class="o">++</span><span class="p">;</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vnode</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="cm">/* pick a server to query */</span>
		<span class="n">server</span> <span class="o">=</span> <span class="n">afs_volume_pick_fileserver</span><span class="p">(</span><span class="n">vnode</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">server</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">no_server</span><span class="p">;</span>

		<span class="n">_debug</span><span class="p">(</span><span class="s">&quot;USING SERVER: %08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ntohl</span><span class="p">(</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">.</span><span class="n">s_addr</span><span class="p">));</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">afs_fs_setattr</span><span class="p">(</span><span class="n">server</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">vnode</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">afs_sync_call</span><span class="p">);</span>

	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">afs_volume_release_fileserver</span><span class="p">(</span><span class="n">vnode</span><span class="p">,</span> <span class="n">server</span><span class="p">,</span> <span class="n">ret</span><span class="p">));</span>

	<span class="cm">/* adjust the flags */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">afs_vnode_finalise_status_update</span><span class="p">(</span><span class="n">vnode</span><span class="p">,</span> <span class="n">server</span><span class="p">);</span>
		<span class="n">afs_put_server</span><span class="p">(</span><span class="n">server</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">afs_vnode_status_update_failed</span><span class="p">(</span><span class="n">vnode</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">_leave</span><span class="p">(</span><span class="s">&quot; = %d&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

<span class="nl">no_server:</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vnode</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">vnode</span><span class="o">-&gt;</span><span class="n">update_cnt</span><span class="o">--</span><span class="p">;</span>
	<span class="n">ASSERTCMP</span><span class="p">(</span><span class="n">vnode</span><span class="o">-&gt;</span><span class="n">update_cnt</span><span class="p">,</span> <span class="o">&gt;=</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vnode</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">server</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * get the status of a volume</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">afs_vnode_get_volume_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">afs_vnode</span> <span class="o">*</span><span class="n">vnode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">key</span> <span class="o">*</span><span class="n">key</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">afs_volume_status</span> <span class="o">*</span><span class="n">vs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">afs_server</span> <span class="o">*</span><span class="n">server</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">_enter</span><span class="p">(</span><span class="s">&quot;%s{%x:%u.%u},%x,&quot;</span><span class="p">,</span>
	       <span class="n">vnode</span><span class="o">-&gt;</span><span class="n">volume</span><span class="o">-&gt;</span><span class="n">vlocation</span><span class="o">-&gt;</span><span class="n">vldb</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
	       <span class="n">vnode</span><span class="o">-&gt;</span><span class="n">fid</span><span class="p">.</span><span class="n">vid</span><span class="p">,</span>
	       <span class="n">vnode</span><span class="o">-&gt;</span><span class="n">fid</span><span class="p">.</span><span class="n">vnode</span><span class="p">,</span>
	       <span class="n">vnode</span><span class="o">-&gt;</span><span class="n">fid</span><span class="p">.</span><span class="n">unique</span><span class="p">,</span>
	       <span class="n">key_serial</span><span class="p">(</span><span class="n">key</span><span class="p">));</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="cm">/* pick a server to query */</span>
		<span class="n">server</span> <span class="o">=</span> <span class="n">afs_volume_pick_fileserver</span><span class="p">(</span><span class="n">vnode</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">server</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">no_server</span><span class="p">;</span>

		<span class="n">_debug</span><span class="p">(</span><span class="s">&quot;USING SERVER: %08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ntohl</span><span class="p">(</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">.</span><span class="n">s_addr</span><span class="p">));</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">afs_fs_get_volume_status</span><span class="p">(</span><span class="n">server</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">vnode</span><span class="p">,</span> <span class="n">vs</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">afs_sync_call</span><span class="p">);</span>

	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">afs_volume_release_fileserver</span><span class="p">(</span><span class="n">vnode</span><span class="p">,</span> <span class="n">server</span><span class="p">,</span> <span class="n">ret</span><span class="p">));</span>

	<span class="cm">/* adjust the flags */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">afs_put_server</span><span class="p">(</span><span class="n">server</span><span class="p">);</span>

	<span class="n">_leave</span><span class="p">(</span><span class="s">&quot; = %d&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

<span class="nl">no_server:</span>
	<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">server</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * get a lock on a file</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">afs_vnode_set_lock</span><span class="p">(</span><span class="k">struct</span> <span class="n">afs_vnode</span> <span class="o">*</span><span class="n">vnode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">key</span> <span class="o">*</span><span class="n">key</span><span class="p">,</span>
		       <span class="n">afs_lock_type_t</span> <span class="n">type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">afs_server</span> <span class="o">*</span><span class="n">server</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">_enter</span><span class="p">(</span><span class="s">&quot;%s{%x:%u.%u},%x,%u&quot;</span><span class="p">,</span>
	       <span class="n">vnode</span><span class="o">-&gt;</span><span class="n">volume</span><span class="o">-&gt;</span><span class="n">vlocation</span><span class="o">-&gt;</span><span class="n">vldb</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
	       <span class="n">vnode</span><span class="o">-&gt;</span><span class="n">fid</span><span class="p">.</span><span class="n">vid</span><span class="p">,</span>
	       <span class="n">vnode</span><span class="o">-&gt;</span><span class="n">fid</span><span class="p">.</span><span class="n">vnode</span><span class="p">,</span>
	       <span class="n">vnode</span><span class="o">-&gt;</span><span class="n">fid</span><span class="p">.</span><span class="n">unique</span><span class="p">,</span>
	       <span class="n">key_serial</span><span class="p">(</span><span class="n">key</span><span class="p">),</span> <span class="n">type</span><span class="p">);</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="cm">/* pick a server to query */</span>
		<span class="n">server</span> <span class="o">=</span> <span class="n">afs_volume_pick_fileserver</span><span class="p">(</span><span class="n">vnode</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">server</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">no_server</span><span class="p">;</span>

		<span class="n">_debug</span><span class="p">(</span><span class="s">&quot;USING SERVER: %08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ntohl</span><span class="p">(</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">.</span><span class="n">s_addr</span><span class="p">));</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">afs_fs_set_lock</span><span class="p">(</span><span class="n">server</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">vnode</span><span class="p">,</span> <span class="n">type</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">afs_sync_call</span><span class="p">);</span>

	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">afs_volume_release_fileserver</span><span class="p">(</span><span class="n">vnode</span><span class="p">,</span> <span class="n">server</span><span class="p">,</span> <span class="n">ret</span><span class="p">));</span>

	<span class="cm">/* adjust the flags */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">afs_put_server</span><span class="p">(</span><span class="n">server</span><span class="p">);</span>

	<span class="n">_leave</span><span class="p">(</span><span class="s">&quot; = %d&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

<span class="nl">no_server:</span>
	<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">server</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * extend a lock on a file</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">afs_vnode_extend_lock</span><span class="p">(</span><span class="k">struct</span> <span class="n">afs_vnode</span> <span class="o">*</span><span class="n">vnode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">key</span> <span class="o">*</span><span class="n">key</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">afs_server</span> <span class="o">*</span><span class="n">server</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">_enter</span><span class="p">(</span><span class="s">&quot;%s{%x:%u.%u},%x&quot;</span><span class="p">,</span>
	       <span class="n">vnode</span><span class="o">-&gt;</span><span class="n">volume</span><span class="o">-&gt;</span><span class="n">vlocation</span><span class="o">-&gt;</span><span class="n">vldb</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
	       <span class="n">vnode</span><span class="o">-&gt;</span><span class="n">fid</span><span class="p">.</span><span class="n">vid</span><span class="p">,</span>
	       <span class="n">vnode</span><span class="o">-&gt;</span><span class="n">fid</span><span class="p">.</span><span class="n">vnode</span><span class="p">,</span>
	       <span class="n">vnode</span><span class="o">-&gt;</span><span class="n">fid</span><span class="p">.</span><span class="n">unique</span><span class="p">,</span>
	       <span class="n">key_serial</span><span class="p">(</span><span class="n">key</span><span class="p">));</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="cm">/* pick a server to query */</span>
		<span class="n">server</span> <span class="o">=</span> <span class="n">afs_volume_pick_fileserver</span><span class="p">(</span><span class="n">vnode</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">server</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">no_server</span><span class="p">;</span>

		<span class="n">_debug</span><span class="p">(</span><span class="s">&quot;USING SERVER: %08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ntohl</span><span class="p">(</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">.</span><span class="n">s_addr</span><span class="p">));</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">afs_fs_extend_lock</span><span class="p">(</span><span class="n">server</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">vnode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">afs_sync_call</span><span class="p">);</span>

	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">afs_volume_release_fileserver</span><span class="p">(</span><span class="n">vnode</span><span class="p">,</span> <span class="n">server</span><span class="p">,</span> <span class="n">ret</span><span class="p">));</span>

	<span class="cm">/* adjust the flags */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">afs_put_server</span><span class="p">(</span><span class="n">server</span><span class="p">);</span>

	<span class="n">_leave</span><span class="p">(</span><span class="s">&quot; = %d&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

<span class="nl">no_server:</span>
	<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">server</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * release a lock on a file</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">afs_vnode_release_lock</span><span class="p">(</span><span class="k">struct</span> <span class="n">afs_vnode</span> <span class="o">*</span><span class="n">vnode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">key</span> <span class="o">*</span><span class="n">key</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">afs_server</span> <span class="o">*</span><span class="n">server</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">_enter</span><span class="p">(</span><span class="s">&quot;%s{%x:%u.%u},%x&quot;</span><span class="p">,</span>
	       <span class="n">vnode</span><span class="o">-&gt;</span><span class="n">volume</span><span class="o">-&gt;</span><span class="n">vlocation</span><span class="o">-&gt;</span><span class="n">vldb</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
	       <span class="n">vnode</span><span class="o">-&gt;</span><span class="n">fid</span><span class="p">.</span><span class="n">vid</span><span class="p">,</span>
	       <span class="n">vnode</span><span class="o">-&gt;</span><span class="n">fid</span><span class="p">.</span><span class="n">vnode</span><span class="p">,</span>
	       <span class="n">vnode</span><span class="o">-&gt;</span><span class="n">fid</span><span class="p">.</span><span class="n">unique</span><span class="p">,</span>
	       <span class="n">key_serial</span><span class="p">(</span><span class="n">key</span><span class="p">));</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="cm">/* pick a server to query */</span>
		<span class="n">server</span> <span class="o">=</span> <span class="n">afs_volume_pick_fileserver</span><span class="p">(</span><span class="n">vnode</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">server</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">no_server</span><span class="p">;</span>

		<span class="n">_debug</span><span class="p">(</span><span class="s">&quot;USING SERVER: %08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ntohl</span><span class="p">(</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">.</span><span class="n">s_addr</span><span class="p">));</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">afs_fs_release_lock</span><span class="p">(</span><span class="n">server</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">vnode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">afs_sync_call</span><span class="p">);</span>

	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">afs_volume_release_fileserver</span><span class="p">(</span><span class="n">vnode</span><span class="p">,</span> <span class="n">server</span><span class="p">,</span> <span class="n">ret</span><span class="p">));</span>

	<span class="cm">/* adjust the flags */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">afs_put_server</span><span class="p">(</span><span class="n">server</span><span class="p">);</span>

	<span class="n">_leave</span><span class="p">(</span><span class="s">&quot; = %d&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

<span class="nl">no_server:</span>
	<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">server</span><span class="p">);</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
