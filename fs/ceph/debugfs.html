<!DOCTYPE html>
<html><head><title>joekychen/linux » fs › ceph › debugfs.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>debugfs.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cp">#include &lt;linux/ceph/ceph_debug.h&gt;</span>

<span class="cp">#include &lt;linux/device.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/ctype.h&gt;</span>
<span class="cp">#include &lt;linux/debugfs.h&gt;</span>
<span class="cp">#include &lt;linux/seq_file.h&gt;</span>

<span class="cp">#include &lt;linux/ceph/libceph.h&gt;</span>
<span class="cp">#include &lt;linux/ceph/mon_client.h&gt;</span>
<span class="cp">#include &lt;linux/ceph/auth.h&gt;</span>
<span class="cp">#include &lt;linux/ceph/debugfs.h&gt;</span>

<span class="cp">#include &quot;super.h&quot;</span>

<span class="cp">#ifdef CONFIG_DEBUG_FS</span>

<span class="cp">#include &quot;mds_client.h&quot;</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mdsmap_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ceph_fs_client</span> <span class="o">*</span><span class="n">fsc</span> <span class="o">=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fsc</span><span class="o">-&gt;</span><span class="n">mdsc</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span> <span class="n">fsc</span><span class="o">-&gt;</span><span class="n">mdsc</span><span class="o">-&gt;</span><span class="n">mdsmap</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;epoch %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">fsc</span><span class="o">-&gt;</span><span class="n">mdsc</span><span class="o">-&gt;</span><span class="n">mdsmap</span><span class="o">-&gt;</span><span class="n">m_epoch</span><span class="p">);</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;root %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">fsc</span><span class="o">-&gt;</span><span class="n">mdsc</span><span class="o">-&gt;</span><span class="n">mdsmap</span><span class="o">-&gt;</span><span class="n">m_root</span><span class="p">);</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;session_timeout %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">fsc</span><span class="o">-&gt;</span><span class="n">mdsc</span><span class="o">-&gt;</span><span class="n">mdsmap</span><span class="o">-&gt;</span><span class="n">m_session_timeout</span><span class="p">);</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;session_autoclose %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">fsc</span><span class="o">-&gt;</span><span class="n">mdsc</span><span class="o">-&gt;</span><span class="n">mdsmap</span><span class="o">-&gt;</span><span class="n">m_session_autoclose</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">fsc</span><span class="o">-&gt;</span><span class="n">mdsc</span><span class="o">-&gt;</span><span class="n">mdsmap</span><span class="o">-&gt;</span><span class="n">m_max_mds</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">ceph_entity_addr</span> <span class="o">*</span><span class="n">addr</span> <span class="o">=</span>
			<span class="o">&amp;</span><span class="n">fsc</span><span class="o">-&gt;</span><span class="n">mdsc</span><span class="o">-&gt;</span><span class="n">mdsmap</span><span class="o">-&gt;</span><span class="n">m_info</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">addr</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">state</span> <span class="o">=</span> <span class="n">fsc</span><span class="o">-&gt;</span><span class="n">mdsc</span><span class="o">-&gt;</span><span class="n">mdsmap</span><span class="o">-&gt;</span><span class="n">m_info</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">state</span><span class="p">;</span>

		<span class="n">seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">mds%d</span><span class="se">\t</span><span class="s">%s</span><span class="se">\t</span><span class="s">(%s)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span>
			       <span class="n">ceph_pr_addr</span><span class="p">(</span><span class="o">&amp;</span><span class="n">addr</span><span class="o">-&gt;</span><span class="n">in_addr</span><span class="p">),</span>
			       <span class="n">ceph_mds_state_name</span><span class="p">(</span><span class="n">state</span><span class="p">));</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * mdsc debugfs</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">mdsc_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ceph_fs_client</span> <span class="o">*</span><span class="n">fsc</span> <span class="o">=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ceph_mds_client</span> <span class="o">*</span><span class="n">mdsc</span> <span class="o">=</span> <span class="n">fsc</span><span class="o">-&gt;</span><span class="n">mdsc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ceph_mds_request</span> <span class="o">*</span><span class="n">req</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rb_node</span> <span class="o">*</span><span class="n">rp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">pathlen</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">pathbase</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">path</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdsc</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">rp</span> <span class="o">=</span> <span class="n">rb_first</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdsc</span><span class="o">-&gt;</span><span class="n">request_tree</span><span class="p">);</span> <span class="n">rp</span><span class="p">;</span> <span class="n">rp</span> <span class="o">=</span> <span class="n">rb_next</span><span class="p">(</span><span class="n">rp</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">req</span> <span class="o">=</span> <span class="n">rb_entry</span><span class="p">(</span><span class="n">rp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ceph_mds_request</span><span class="p">,</span> <span class="n">r_node</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">r_request</span> <span class="o">&amp;&amp;</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">r_session</span><span class="p">)</span>
			<span class="n">seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;%lld</span><span class="se">\t</span><span class="s">mds%d</span><span class="se">\t</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">r_tid</span><span class="p">,</span>
				   <span class="n">req</span><span class="o">-&gt;</span><span class="n">r_session</span><span class="o">-&gt;</span><span class="n">s_mds</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">r_request</span><span class="p">)</span>
			<span class="n">seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;%lld</span><span class="se">\t</span><span class="s">(no request)</span><span class="se">\t</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">r_tid</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;%lld</span><span class="se">\t</span><span class="s">(no session)</span><span class="se">\t</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">r_tid</span><span class="p">);</span>

		<span class="n">seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">ceph_mds_op_name</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">r_op</span><span class="p">));</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">r_got_unsafe</span><span class="p">)</span>
			<span class="n">seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">(unsafe)&quot;</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">&quot;</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">r_inode</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot; #%llx&quot;</span><span class="p">,</span> <span class="n">ceph_ino</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">r_inode</span><span class="p">));</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">r_dentry</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">path</span> <span class="o">=</span> <span class="n">ceph_mdsc_build_path</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">r_dentry</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pathlen</span><span class="p">,</span>
						    <span class="o">&amp;</span><span class="n">pathbase</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">path</span><span class="p">))</span>
				<span class="n">path</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">r_dentry</span><span class="o">-&gt;</span><span class="n">d_lock</span><span class="p">);</span>
			<span class="n">seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot; #%llx/%.*s (%s)&quot;</span><span class="p">,</span>
				   <span class="n">ceph_ino</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">r_dentry</span><span class="o">-&gt;</span><span class="n">d_parent</span><span class="o">-&gt;</span><span class="n">d_inode</span><span class="p">),</span>
				   <span class="n">req</span><span class="o">-&gt;</span><span class="n">r_dentry</span><span class="o">-&gt;</span><span class="n">d_name</span><span class="p">.</span><span class="n">len</span><span class="p">,</span>
				   <span class="n">req</span><span class="o">-&gt;</span><span class="n">r_dentry</span><span class="o">-&gt;</span><span class="n">d_name</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
				   <span class="n">path</span> <span class="o">?</span> <span class="n">path</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">);</span>
			<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">r_dentry</span><span class="o">-&gt;</span><span class="n">d_lock</span><span class="p">);</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">path</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">r_path1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot; #%llx/%s&quot;</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">r_ino1</span><span class="p">.</span><span class="n">ino</span><span class="p">,</span>
				   <span class="n">req</span><span class="o">-&gt;</span><span class="n">r_path1</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">r_old_dentry</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">path</span> <span class="o">=</span> <span class="n">ceph_mdsc_build_path</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">r_old_dentry</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pathlen</span><span class="p">,</span>
						    <span class="o">&amp;</span><span class="n">pathbase</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">path</span><span class="p">))</span>
				<span class="n">path</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">r_old_dentry</span><span class="o">-&gt;</span><span class="n">d_lock</span><span class="p">);</span>
			<span class="n">seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot; #%llx/%.*s (%s)&quot;</span><span class="p">,</span>
			   <span class="n">ceph_ino</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">r_old_dentry_dir</span><span class="p">),</span>
				   <span class="n">req</span><span class="o">-&gt;</span><span class="n">r_old_dentry</span><span class="o">-&gt;</span><span class="n">d_name</span><span class="p">.</span><span class="n">len</span><span class="p">,</span>
				   <span class="n">req</span><span class="o">-&gt;</span><span class="n">r_old_dentry</span><span class="o">-&gt;</span><span class="n">d_name</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
				   <span class="n">path</span> <span class="o">?</span> <span class="n">path</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">);</span>
			<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">r_old_dentry</span><span class="o">-&gt;</span><span class="n">d_lock</span><span class="p">);</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">path</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">r_path2</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">r_ino2</span><span class="p">.</span><span class="n">ino</span><span class="p">)</span>
				<span class="n">seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot; #%llx/%s&quot;</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">r_ino2</span><span class="p">.</span><span class="n">ino</span><span class="p">,</span>
					   <span class="n">req</span><span class="o">-&gt;</span><span class="n">r_path2</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot; %s&quot;</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">r_path2</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdsc</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">caps_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ceph_fs_client</span> <span class="o">*</span><span class="n">fsc</span> <span class="o">=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">total</span><span class="p">,</span> <span class="n">avail</span><span class="p">,</span> <span class="n">used</span><span class="p">,</span> <span class="n">reserved</span><span class="p">,</span> <span class="n">min</span><span class="p">;</span>

	<span class="n">ceph_reservation_status</span><span class="p">(</span><span class="n">fsc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">total</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">avail</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">used</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reserved</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">min</span><span class="p">);</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;total</span><span class="se">\t\t</span><span class="s">%d</span><span class="se">\n</span><span class="s">&quot;</span>
		   <span class="s">&quot;avail</span><span class="se">\t\t</span><span class="s">%d</span><span class="se">\n</span><span class="s">&quot;</span>
		   <span class="s">&quot;used</span><span class="se">\t\t</span><span class="s">%d</span><span class="se">\n</span><span class="s">&quot;</span>
		   <span class="s">&quot;reserved</span><span class="se">\t</span><span class="s">%d</span><span class="se">\n</span><span class="s">&quot;</span>
		   <span class="s">&quot;min</span><span class="se">\t</span><span class="s">%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">total</span><span class="p">,</span> <span class="n">avail</span><span class="p">,</span> <span class="n">used</span><span class="p">,</span> <span class="n">reserved</span><span class="p">,</span> <span class="n">min</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dentry_lru_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">ptr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ceph_fs_client</span> <span class="o">*</span><span class="n">fsc</span> <span class="o">=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ceph_mds_client</span> <span class="o">*</span><span class="n">mdsc</span> <span class="o">=</span> <span class="n">fsc</span><span class="o">-&gt;</span><span class="n">mdsc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ceph_dentry_info</span> <span class="o">*</span><span class="n">di</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdsc</span><span class="o">-&gt;</span><span class="n">dentry_lru_lock</span><span class="p">);</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">di</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mdsc</span><span class="o">-&gt;</span><span class="n">dentry_lru</span><span class="p">,</span> <span class="n">lru</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="n">dentry</span> <span class="o">=</span> <span class="n">di</span><span class="o">-&gt;</span><span class="n">dentry</span><span class="p">;</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;%p %p</span><span class="se">\t</span><span class="s">%.*s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">di</span><span class="p">,</span> <span class="n">dentry</span><span class="p">,</span> <span class="n">dentry</span><span class="o">-&gt;</span><span class="n">d_name</span><span class="p">.</span><span class="n">len</span><span class="p">,</span> <span class="n">dentry</span><span class="o">-&gt;</span><span class="n">d_name</span><span class="p">.</span><span class="n">name</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdsc</span><span class="o">-&gt;</span><span class="n">dentry_lru_lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">CEPH_DEFINE_SHOW_FUNC</span><span class="p">(</span><span class="n">mdsmap_show</span><span class="p">)</span>
<span class="n">CEPH_DEFINE_SHOW_FUNC</span><span class="p">(</span><span class="n">mdsc_show</span><span class="p">)</span>
<span class="n">CEPH_DEFINE_SHOW_FUNC</span><span class="p">(</span><span class="n">caps_show</span><span class="p">)</span>
<span class="n">CEPH_DEFINE_SHOW_FUNC</span><span class="p">(</span><span class="n">dentry_lru_show</span><span class="p">)</span>


<span class="cm">/*</span>
<span class="cm"> * debugfs</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">congestion_kb_set</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="n">u64</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ceph_fs_client</span> <span class="o">*</span><span class="n">fsc</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ceph_fs_client</span> <span class="o">*</span><span class="p">)</span><span class="n">data</span><span class="p">;</span>

	<span class="n">fsc</span><span class="o">-&gt;</span><span class="n">mount_options</span><span class="o">-&gt;</span><span class="n">congestion_kb</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">val</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">congestion_kb_get</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="n">u64</span> <span class="o">*</span><span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ceph_fs_client</span> <span class="o">*</span><span class="n">fsc</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ceph_fs_client</span> <span class="o">*</span><span class="p">)</span><span class="n">data</span><span class="p">;</span>

	<span class="o">*</span><span class="n">val</span> <span class="o">=</span> <span class="p">(</span><span class="n">u64</span><span class="p">)</span><span class="n">fsc</span><span class="o">-&gt;</span><span class="n">mount_options</span><span class="o">-&gt;</span><span class="n">congestion_kb</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">DEFINE_SIMPLE_ATTRIBUTE</span><span class="p">(</span><span class="n">congestion_kb_fops</span><span class="p">,</span> <span class="n">congestion_kb_get</span><span class="p">,</span>
			<span class="n">congestion_kb_set</span><span class="p">,</span> <span class="s">&quot;%llu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>


<span class="kt">void</span> <span class="nf">ceph_fs_debugfs_cleanup</span><span class="p">(</span><span class="k">struct</span> <span class="n">ceph_fs_client</span> <span class="o">*</span><span class="n">fsc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dout</span><span class="p">(</span><span class="s">&quot;ceph_fs_debugfs_cleanup</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">debugfs_remove</span><span class="p">(</span><span class="n">fsc</span><span class="o">-&gt;</span><span class="n">debugfs_bdi</span><span class="p">);</span>
	<span class="n">debugfs_remove</span><span class="p">(</span><span class="n">fsc</span><span class="o">-&gt;</span><span class="n">debugfs_congestion_kb</span><span class="p">);</span>
	<span class="n">debugfs_remove</span><span class="p">(</span><span class="n">fsc</span><span class="o">-&gt;</span><span class="n">debugfs_mdsmap</span><span class="p">);</span>
	<span class="n">debugfs_remove</span><span class="p">(</span><span class="n">fsc</span><span class="o">-&gt;</span><span class="n">debugfs_caps</span><span class="p">);</span>
	<span class="n">debugfs_remove</span><span class="p">(</span><span class="n">fsc</span><span class="o">-&gt;</span><span class="n">debugfs_mdsc</span><span class="p">);</span>
	<span class="n">debugfs_remove</span><span class="p">(</span><span class="n">fsc</span><span class="o">-&gt;</span><span class="n">debugfs_dentry_lru</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">ceph_fs_debugfs_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">ceph_fs_client</span> <span class="o">*</span><span class="n">fsc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="n">name</span><span class="p">[</span><span class="mi">100</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">dout</span><span class="p">(</span><span class="s">&quot;ceph_fs_debugfs_init</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">fsc</span><span class="o">-&gt;</span><span class="n">debugfs_congestion_kb</span> <span class="o">=</span>
		<span class="n">debugfs_create_file</span><span class="p">(</span><span class="s">&quot;writeback_congestion_kb&quot;</span><span class="p">,</span>
				    <span class="mo">0600</span><span class="p">,</span>
				    <span class="n">fsc</span><span class="o">-&gt;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">debugfs_dir</span><span class="p">,</span>
				    <span class="n">fsc</span><span class="p">,</span>
				    <span class="o">&amp;</span><span class="n">congestion_kb_fops</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fsc</span><span class="o">-&gt;</span><span class="n">debugfs_congestion_kb</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">snprintf</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">name</span><span class="p">),</span> <span class="s">&quot;../../bdi/%s&quot;</span><span class="p">,</span>
		 <span class="n">dev_name</span><span class="p">(</span><span class="n">fsc</span><span class="o">-&gt;</span><span class="n">backing_dev_info</span><span class="p">.</span><span class="n">dev</span><span class="p">));</span>
	<span class="n">fsc</span><span class="o">-&gt;</span><span class="n">debugfs_bdi</span> <span class="o">=</span>
		<span class="n">debugfs_create_symlink</span><span class="p">(</span><span class="s">&quot;bdi&quot;</span><span class="p">,</span>
				       <span class="n">fsc</span><span class="o">-&gt;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">debugfs_dir</span><span class="p">,</span>
				       <span class="n">name</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fsc</span><span class="o">-&gt;</span><span class="n">debugfs_bdi</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">fsc</span><span class="o">-&gt;</span><span class="n">debugfs_mdsmap</span> <span class="o">=</span> <span class="n">debugfs_create_file</span><span class="p">(</span><span class="s">&quot;mdsmap&quot;</span><span class="p">,</span>
					<span class="mo">0600</span><span class="p">,</span>
					<span class="n">fsc</span><span class="o">-&gt;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">debugfs_dir</span><span class="p">,</span>
					<span class="n">fsc</span><span class="p">,</span>
					<span class="o">&amp;</span><span class="n">mdsmap_show_fops</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fsc</span><span class="o">-&gt;</span><span class="n">debugfs_mdsmap</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">fsc</span><span class="o">-&gt;</span><span class="n">debugfs_mdsc</span> <span class="o">=</span> <span class="n">debugfs_create_file</span><span class="p">(</span><span class="s">&quot;mdsc&quot;</span><span class="p">,</span>
						<span class="mo">0600</span><span class="p">,</span>
						<span class="n">fsc</span><span class="o">-&gt;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">debugfs_dir</span><span class="p">,</span>
						<span class="n">fsc</span><span class="p">,</span>
						<span class="o">&amp;</span><span class="n">mdsc_show_fops</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fsc</span><span class="o">-&gt;</span><span class="n">debugfs_mdsc</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">fsc</span><span class="o">-&gt;</span><span class="n">debugfs_caps</span> <span class="o">=</span> <span class="n">debugfs_create_file</span><span class="p">(</span><span class="s">&quot;caps&quot;</span><span class="p">,</span>
						   <span class="mo">0400</span><span class="p">,</span>
						   <span class="n">fsc</span><span class="o">-&gt;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">debugfs_dir</span><span class="p">,</span>
						   <span class="n">fsc</span><span class="p">,</span>
						   <span class="o">&amp;</span><span class="n">caps_show_fops</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fsc</span><span class="o">-&gt;</span><span class="n">debugfs_caps</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">fsc</span><span class="o">-&gt;</span><span class="n">debugfs_dentry_lru</span> <span class="o">=</span> <span class="n">debugfs_create_file</span><span class="p">(</span><span class="s">&quot;dentry_lru&quot;</span><span class="p">,</span>
					<span class="mo">0600</span><span class="p">,</span>
					<span class="n">fsc</span><span class="o">-&gt;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">debugfs_dir</span><span class="p">,</span>
					<span class="n">fsc</span><span class="p">,</span>
					<span class="o">&amp;</span><span class="n">dentry_lru_show_fops</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fsc</span><span class="o">-&gt;</span><span class="n">debugfs_dentry_lru</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">out:</span>
	<span class="n">ceph_fs_debugfs_cleanup</span><span class="p">(</span><span class="n">fsc</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>


<span class="cp">#else  </span><span class="cm">/* CONFIG_DEBUG_FS */</span><span class="cp"></span>

<span class="kt">int</span> <span class="nf">ceph_fs_debugfs_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">ceph_fs_client</span> <span class="o">*</span><span class="n">fsc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">ceph_fs_debugfs_cleanup</span><span class="p">(</span><span class="k">struct</span> <span class="n">ceph_fs_client</span> <span class="o">*</span><span class="n">fsc</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">}</span>

<span class="cp">#endif  </span><span class="cm">/* CONFIG_DEBUG_FS */</span><span class="cp"></span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
