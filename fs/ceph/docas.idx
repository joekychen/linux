f | snap.c | s | 25K | 819 | Xi Wang | xi.wang@gmail.com | 1338511766 |  | introduce SIZE_MAX  ULONG_MAX is often used to check for integer overflow when calculating allocation size.  While ULONG_MAX happens to work on most systems, there is no guarantee that `size_t' must be the same size as `long'.  This patch introduces SIZE_MAX, the maximum value of `size_t', to improve portability and readability for allocation size validation.  Signed-off-by: Xi Wang <xi.wang@gmail.com> Acked-by: Alex Elder <elder@dreamhost.com> Cc: David Airlie <airlied@linux.ie> Cc: Pekka Enberg <penberg@kernel.org> Signed-off-by: Andrew Morton <akpm@linux-foundation.org> Signed-off-by: Linus Torvalds <torvalds@linux-foundation.org>
f | dir.c | s | 36K | 1228 | Linus Torvalds | torvalds@linux-foundation.org | 1328226453 |  | Merge branch 'for-linus' of git://git.kernel.org/pub/scm/linux/kernel/git/sage/ceph-client  * 'for-linus' of git://git.kernel.org/pub/scm/linux/kernel/git/sage/ceph-client:   rbd: fix safety of rbd_put_client()   rbd: fix a memory leak in rbd_get_client()   ceph: create a new session lock to avoid lock inversion   ceph: fix length validation in parse_reply_info()   ceph: initialize client debugfs outside of monc->mutex   ceph: change "ceph.layout" xattr to be "ceph.file.layout"
f | mds_client.h | s | 11K | 317 | Alex Elder | elder@inktank.com | 1337260692 |  | ceph: define ceph_auth_handshake type  The definitions for the ceph_mds_session and ceph_osd both contain five fields related only to "authorizers."  Encapsulate those fields into their own struct type, allowing for better isolation in some upcoming patches.  Fix the #includes in "linux/ceph/osd_client.h" to lay out their more complete canonical path.  Signed-off-by: Alex Elder <elder@inktank.com> Reviewed-by: Sage Weil <sage@inktank.com>
f | Makefile | g | 227B |  | Tracey Dent | tdent48227@gmail.com | 1294874113 |  | ceph: Makefile: Remove unnessary code  Remove the if and else conditional because the code is in mainline and there is no need in it being there.  Also, Changed Makefile to use <modules>-y instead of <modules>-objs because -objs is deprecated and not mentioned in  Documentation/kbuild/makefiles.txt.  Signed-off-by: Tracey Dent <tdent48227@gmail.com> Signed-off-by: Sage Weil <sage@newdream.net>
f | xattr.c | s | 22K | 785 | Sage Weil | sage@inktank.com | 1336430016 |  | ceph: drop support for preferred_osd pgs  This was an ill-conceived feature that has been removed from Ceph.  Do this gracefully:   - reject attempts to specify a preferred_osd via the ioctl  - stop exposing this information via virtual xattrs  - always fill in -1 for requests, in case we talk to an older server  - don't calculate preferred_osd placements/pgids  Reviewed-by: Alex Elder <elder@inktank.com> Signed-off-by: Sage Weil <sage@inktank.com>
f | locks.c | s | 7.7K | 255 | Sage Weil | sage@newdream.net | 1307507805 |  | ceph: unwind canceled flock state  If we request a lock and then abort (e.g., ^C), we need to send a matching unlock request to the MDS to unwind our lock attempt to avoid indefinitely blocking other clients.  Reported-by: Brian Chrisman <brchrisman@gmail.com> Signed-off-by: Sage Weil <sage@newdream.net>
f | addr.c | s | 33K | 1093 | Yan, Zheng | zheng.z.yan@intel.com | 1340196228 |  | ceph: check PG_Private flag before accessing page->private  I got lots of NULL pointer dereference Oops when compiling kernel on ceph. The bug is because the kernel page migration routine replaces some pages in the page cache with new pages, these new pages' private can be non-zero.  Signed-off-by: Zheng Yan <zheng.z.yan@intel.com> Signed-off-by: Sage Weil <sage@inktank.com> (cherry picked from commit 28c0254ede13ab575d2df5c6585ed3d4817c3e6b)
f | strings.c | s | 3.7K | 110 | Yehuda Sadeh | yehuda@hq.newdream.net | 1287614248 |  | ceph: factor out libceph from Ceph file system  This factors out protocol and low-level storage parts of ceph into a separate libceph module living in net/ceph and include/linux/ceph.  This is mostly a matter of moving files around.  However, a few key pieces of the interface change as well:   - ceph_client becomes ceph_fs_client and ceph_client, where the latter    captures the mon and osd clients, and the fs_client gets the mds client    and file system specific pieces.  - Mount option parsing and debugfs setup is correspondingly broken into    two pieces.  - The mon client gets a generic handler callback for otherwise unknown    messages (mds map, in this case).  - The basic supported/required feature bits can be expanded (and are by    ceph_fs_client).  No functional change, aside from some subtle error handling cases that got cleaned up in the refactoring process.  Signed-off-by: Sage Weil <sage@newdream.net>
f | mds_client.c | s | 87K | 3031 | Alex Elder | elder@inktank.com | 1337260693 |  | ceph: use info returned by get_authorizer  Rather than passing a bunch of arguments to be filled in with the content of the ceph_auth_handshake buffer now returned by the get_authorizer method, just use the returned information in the caller, and drop the unnecessary arguments.  Signed-off-by: Alex Elder <elder@inktank.com> Reviewed-by: Sage Weil <sage@inktank.com>
f | caps.c | s | 84K | 2763 | Linus Torvalds | torvalds@linux-foundation.org | 1328226453 |  | Merge branch 'for-linus' of git://git.kernel.org/pub/scm/linux/kernel/git/sage/ceph-client  * 'for-linus' of git://git.kernel.org/pub/scm/linux/kernel/git/sage/ceph-client:   rbd: fix safety of rbd_put_client()   rbd: fix a memory leak in rbd_get_client()   ceph: create a new session lock to avoid lock inversion   ceph: fix length validation in parse_reply_info()   ceph: initialize client debugfs outside of monc->mutex   ceph: change "ceph.layout" xattr to be "ceph.file.layout"
f | super.c | s | 23K | 837 | Linus Torvalds | torvalds@linux-foundation.org | 1332954089 |  | Merge branch 'for-linus' of git://git.kernel.org/pub/scm/linux/kernel/git/sage/ceph-client  Pull Ceph updates for 3.4-rc1 from Sage Weil:  "Alex has been busy.  There are a range of rbd and libceph cleanups,   especially surrounding device setup and teardown, and a few critical   fixes in that code.  There are more cleanups in the messenger code,   virtual xattrs, a fix for CRC calculation/checks, and lots of other   miscellaneous stuff.    There's a patch from Amon Ott to make inos behave a bit better on   32-bit boxes, some decode check fixes from Xi Wang, and network   throttling fix from Jim Schutt, and a couple RBD fixes from Josh   Durgin.    No new functionality, just a lot of cleanup and bug fixing."  * 'for-linus' of git://git.kernel.org/pub/scm/linux/kernel/git/sage/ceph-client: (65 commits)   rbd: move snap_rwsem to the device, rename to header_rwsem   ceph: fix three bugs, two in ceph_vxattrcb_file_layout()   libceph: isolate kmap() call in write_partial_msg_pages()   libceph: rename "page_shift" variable to something sensible   libceph: get rid of zero_page_address   libceph: only call kernel_sendpage() via helper   libceph: use kernel_sendpage() for sending zeroes   libceph: fix inverted crc option logic   libceph: some simple changes   libceph: small refactor in write_partial_kvec()   libceph: do crc calculations outside loop   libceph: separate CRC calculation from byte swapping   libceph: use "do" in CRC-related Boolean variables   ceph: ensure Boolean options support both senses   libceph: a few small changes   libceph: make ceph_tcp_connect() return int   libceph: encapsulate some messenger cleanup code   libceph: make ceph_msgr_wq private   libceph: encapsulate connection kvec operations   libceph: move prepare_write_banner()   ...
f | inode.c | s | 48K | 1610 | Xi Wang | xi.wang@gmail.com | 1332431265 |  | ceph: avoid panic with mismatched symlink sizes in fill_inode()  Return -EINVAL rather than panic if iinfo->symlink_len and inode->i_size do not match.  Also use kstrndup rather than kmalloc/memcpy.  Signed-off-by: Xi Wang <xi.wang@gmail.com> Reviewed-by: Alex Elder <elder@dreamhost.com>
f | ioctl.c | s | 7.3K | 235 | Sage Weil | sage@inktank.com | 1337196508 |  | ceph: ignore preferred_osd field  Old users may not expect EINVAL, and there is no clear user-visibile behavior change now that we ignore it.  Signed-off-by: Sage Weil <sage@inktank.com> Reviewed-by: Alex Elder <elder@inktank.com>
f | export.c | s | 6.6K | 237 | Sage Weil | sage@newdream.net | 1338348513 |  | ceph: move encode_fh to new API  Use parent_inode has a flag for whether nfsd wants a connectable fh, but generate one opportunistically so that we can take advantage of the additional info in there.  Signed-off-by: Sage Weil <sage@newdream.net> Signed-off-by: Al Viro <viro@zeniv.linux.org.uk>
f | ioctl.h | s | 3.6K | 89 | Sage Weil | sage@inktank.com | 1337196507 |  | ceph: fully initialize new layout  When we are setting a new layout, fully initialize the structure:  - zero it out  - always set preferred_osd to -1  Signed-off-by: Sage Weil <sage@inktank.com> Reviewed-by: Alex Elder <elder@inktank.com>
f | ceph_frag.c | s | 365B | 21 | Yehuda Sadeh | yehuda@hq.newdream.net | 1287614248 |  | ceph: factor out libceph from Ceph file system  This factors out protocol and low-level storage parts of ceph into a separate libceph module living in net/ceph and include/linux/ceph.  This is mostly a matter of moving files around.  However, a few key pieces of the interface change as well:   - ceph_client becomes ceph_fs_client and ceph_client, where the latter    captures the mon and osd clients, and the fs_client gets the mds client    and file system specific pieces.  - Mount option parsing and debugfs setup is correspondingly broken into    two pieces.  - The mon client gets a generic handler callback for otherwise unknown    messages (mds map, in this case).  - The basic supported/required feature bits can be expanded (and are by    ceph_fs_client).  No functional change, aside from some subtle error handling cases that got cleaned up in the refactoring process.  Signed-off-by: Sage Weil <sage@newdream.net>
f | file.c | s | 23K | 780 | Sage Weil | sage@inktank.com | 1336430016 |  | ceph: drop support for preferred_osd pgs  This was an ill-conceived feature that has been removed from Ceph.  Do this gracefully:   - reject attempts to specify a preferred_osd via the ioctl  - stop exposing this information via virtual xattrs  - always fill in -1 for requests, in case we talk to an older server  - don't calculate preferred_osd placements/pgids  Reviewed-by: Alex Elder <elder@inktank.com> Signed-off-by: Sage Weil <sage@inktank.com>
f | debugfs.c | s | 6.4K | 228 | Sage Weil | sage@newdream.net | 1311705074 |  | ceph: explicitly reference rename old_dentry parent dir in request  We carry a pin on the parent directory for the rename source and dest dentries.  For the source it's r_locked_dir; we need to explicitly reference the old_dentry parent as well, since the dentry's d_parent may change between when the request was created and pinned and when it is freed.  Reviewed-by: Yehuda Sadeh <yehuda@hq.newdream.net> Signed-off-by: Sage Weil <sage@newdream.net>
f | Kconfig | g | 503B |  | Yehuda Sadeh | yehuda@hq.newdream.net | 1287614248 |  | ceph: factor out libceph from Ceph file system  This factors out protocol and low-level storage parts of ceph into a separate libceph module living in net/ceph and include/linux/ceph.  This is mostly a matter of moving files around.  However, a few key pieces of the interface change as well:   - ceph_client becomes ceph_fs_client and ceph_client, where the latter    captures the mon and osd clients, and the fs_client gets the mds client    and file system specific pieces.  - Mount option parsing and debugfs setup is correspondingly broken into    two pieces.  - The mon client gets a generic handler callback for otherwise unknown    messages (mds map, in this case).  - The basic supported/required feature bits can be expanded (and are by    ceph_fs_client).  No functional change, aside from some subtle error handling cases that got cleaned up in the refactoring process.  Signed-off-by: Sage Weil <sage@newdream.net>
f | mdsmap.c | s | 4.3K | 157 | Yehuda Sadeh | yehuda@hq.newdream.net | 1287614248 |  | ceph: factor out libceph from Ceph file system  This factors out protocol and low-level storage parts of ceph into a separate libceph module living in net/ceph and include/linux/ceph.  This is mostly a matter of moving files around.  However, a few key pieces of the interface change as well:   - ceph_client becomes ceph_fs_client and ceph_client, where the latter    captures the mon and osd clients, and the fs_client gets the mds client    and file system specific pieces.  - Mount option parsing and debugfs setup is correspondingly broken into    two pieces.  - The mon client gets a generic handler callback for otherwise unknown    messages (mds map, in this case).  - The basic supported/required feature bits can be expanded (and are by    ceph_fs_client).  No functional change, aside from some subtle error handling cases that got cleaned up in the refactoring process.  Signed-off-by: Sage Weil <sage@newdream.net>
f | super.h | s | 26K | 715 | Alex Elder | elder@dreamhost.com | 1332431266 |  | ceph: avoid repeatedly computing the size of constant vxattr names  All names defined in the directory and file virtual extended attribute tables are constant, and the size of each is known at compile time.  So there's no need to compute their length every time any file's attribute is listed.  Record the length of each string and use it when needed to determine the space need to represent them.  In addition, compute the aggregate size of strings in each table just once at initialization time.  Signed-off-by: Alex Elder <elder@dreamhost.com> Signed-off-by: Sage Weil <sage@newdream.net>
