<!DOCTYPE html>
<html><head><title>joekychen/linux » fs › ceph › dir.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>dir.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cp">#include &lt;linux/ceph/ceph_debug.h&gt;</span>

<span class="cp">#include &lt;linux/spinlock.h&gt;</span>
<span class="cp">#include &lt;linux/fs_struct.h&gt;</span>
<span class="cp">#include &lt;linux/namei.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/sched.h&gt;</span>

<span class="cp">#include &quot;super.h&quot;</span>
<span class="cp">#include &quot;mds_client.h&quot;</span>

<span class="cm">/*</span>
<span class="cm"> * Directory operations: readdir, lookup, create, link, unlink,</span>
<span class="cm"> * rename, etc.</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> * Ceph MDS operations are specified in terms of a base ino and</span>
<span class="cm"> * relative path.  Thus, the client can specify an operation on a</span>
<span class="cm"> * specific inode (e.g., a getattr due to fstat(2)), or as a path</span>
<span class="cm"> * relative to, say, the root directory.</span>
<span class="cm"> *</span>
<span class="cm"> * Normally, we limit ourselves to strict inode ops (no path component)</span>
<span class="cm"> * or dentry operations (a single path component relative to an ino).  The</span>
<span class="cm"> * exception to this is open_root_dentry(), which will open the mount</span>
<span class="cm"> * point by name.</span>
<span class="cm"> */</span>

<span class="k">const</span> <span class="k">struct</span> <span class="n">inode_operations</span> <span class="n">ceph_dir_iops</span><span class="p">;</span>
<span class="k">const</span> <span class="k">struct</span> <span class="n">file_operations</span> <span class="n">ceph_dir_fops</span><span class="p">;</span>
<span class="k">const</span> <span class="k">struct</span> <span class="n">dentry_operations</span> <span class="n">ceph_dentry_ops</span><span class="p">;</span>

<span class="cm">/*</span>
<span class="cm"> * Initialize ceph dentry state.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">ceph_init_dentry</span><span class="p">(</span><span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="n">dentry</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ceph_dentry_info</span> <span class="o">*</span><span class="n">di</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dentry</span><span class="o">-&gt;</span><span class="n">d_fsdata</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">di</span> <span class="o">=</span> <span class="n">kmem_cache_alloc</span><span class="p">(</span><span class="n">ceph_dentry_cachep</span><span class="p">,</span> <span class="n">GFP_NOFS</span> <span class="o">|</span> <span class="n">__GFP_ZERO</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">di</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>          <span class="cm">/* oh well */</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dentry</span><span class="o">-&gt;</span><span class="n">d_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dentry</span><span class="o">-&gt;</span><span class="n">d_fsdata</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* lost a race */</span>
		<span class="n">kmem_cache_free</span><span class="p">(</span><span class="n">ceph_dentry_cachep</span><span class="p">,</span> <span class="n">di</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_unlock</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dentry</span><span class="o">-&gt;</span><span class="n">d_parent</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span>   <span class="cm">/* nfs fh_to_dentry */</span>
	    <span class="n">ceph_snap</span><span class="p">(</span><span class="n">dentry</span><span class="o">-&gt;</span><span class="n">d_parent</span><span class="o">-&gt;</span><span class="n">d_inode</span><span class="p">)</span> <span class="o">==</span> <span class="n">CEPH_NOSNAP</span><span class="p">)</span>
		<span class="n">d_set_d_op</span><span class="p">(</span><span class="n">dentry</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ceph_dentry_ops</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ceph_snap</span><span class="p">(</span><span class="n">dentry</span><span class="o">-&gt;</span><span class="n">d_parent</span><span class="o">-&gt;</span><span class="n">d_inode</span><span class="p">)</span> <span class="o">==</span> <span class="n">CEPH_SNAPDIR</span><span class="p">)</span>
		<span class="n">d_set_d_op</span><span class="p">(</span><span class="n">dentry</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ceph_snapdir_dentry_ops</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">d_set_d_op</span><span class="p">(</span><span class="n">dentry</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ceph_snap_dentry_ops</span><span class="p">);</span>

	<span class="n">di</span><span class="o">-&gt;</span><span class="n">dentry</span> <span class="o">=</span> <span class="n">dentry</span><span class="p">;</span>
	<span class="n">di</span><span class="o">-&gt;</span><span class="n">lease_session</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">dentry</span><span class="o">-&gt;</span><span class="n">d_time</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
	<span class="cm">/* avoid reordering d_fsdata setup so that the check above is safe */</span>
	<span class="n">smp_mb</span><span class="p">();</span>
	<span class="n">dentry</span><span class="o">-&gt;</span><span class="n">d_fsdata</span> <span class="o">=</span> <span class="n">di</span><span class="p">;</span>
	<span class="n">ceph_dentry_lru_add</span><span class="p">(</span><span class="n">dentry</span><span class="p">);</span>
<span class="nl">out_unlock:</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dentry</span><span class="o">-&gt;</span><span class="n">d_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="nf">ceph_get_dentry_parent_inode</span><span class="p">(</span><span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="n">dentry</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dentry</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dentry</span><span class="o">-&gt;</span><span class="n">d_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dentry</span><span class="o">-&gt;</span><span class="n">d_parent</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">inode</span> <span class="o">=</span> <span class="n">dentry</span><span class="o">-&gt;</span><span class="n">d_parent</span><span class="o">-&gt;</span><span class="n">d_inode</span><span class="p">;</span>
		<span class="n">ihold</span><span class="p">(</span><span class="n">inode</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dentry</span><span class="o">-&gt;</span><span class="n">d_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">inode</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * for readdir, we encode the directory frag and offset within that</span>
<span class="cm"> * frag into f_pos.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="nf">fpos_frag</span><span class="p">(</span><span class="n">loff_t</span> <span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">p</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="nf">fpos_off</span><span class="p">(</span><span class="n">loff_t</span> <span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">p</span> <span class="o">&amp;</span> <span class="mh">0xffffffff</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * When possible, we try to satisfy a readdir by peeking at the</span>
<span class="cm"> * dcache.  We make this work by carefully ordering dentries on</span>
<span class="cm"> * d_u.d_child when we initially get results back from the MDS, and</span>
<span class="cm"> * falling back to a &quot;normal&quot; sync readdir if any dentries in the dir</span>
<span class="cm"> * are dropped.</span>
<span class="cm"> *</span>
<span class="cm"> * D_COMPLETE tells indicates we have all dentries in the dir.  It is</span>
<span class="cm"> * defined IFF we hold CEPH_CAP_FILE_SHARED (which will be revoked by</span>
<span class="cm"> * the MDS if/when the directory is modified).</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">__dcache_readdir</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">filp</span><span class="p">,</span>
			    <span class="kt">void</span> <span class="o">*</span><span class="n">dirent</span><span class="p">,</span> <span class="n">filldir_t</span> <span class="n">filldir</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ceph_file_info</span> <span class="o">*</span><span class="n">fi</span> <span class="o">=</span> <span class="n">filp</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="n">parent</span> <span class="o">=</span> <span class="n">filp</span><span class="o">-&gt;</span><span class="n">f_dentry</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">dir</span> <span class="o">=</span> <span class="n">parent</span><span class="o">-&gt;</span><span class="n">d_inode</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="n">dentry</span><span class="p">,</span> <span class="o">*</span><span class="n">last</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ceph_dentry_info</span> <span class="o">*</span><span class="n">di</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* claim ref on last dentry we returned */</span>
	<span class="n">last</span> <span class="o">=</span> <span class="n">fi</span><span class="o">-&gt;</span><span class="n">dentry</span><span class="p">;</span>
	<span class="n">fi</span><span class="o">-&gt;</span><span class="n">dentry</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">dout</span><span class="p">(</span><span class="s">&quot;__dcache_readdir %p at %llu (last %p)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dir</span><span class="p">,</span> <span class="n">filp</span><span class="o">-&gt;</span><span class="n">f_pos</span><span class="p">,</span>
	     <span class="n">last</span><span class="p">);</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">parent</span><span class="o">-&gt;</span><span class="n">d_lock</span><span class="p">);</span>

	<span class="cm">/* start at beginning? */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">filp</span><span class="o">-&gt;</span><span class="n">f_pos</span> <span class="o">==</span> <span class="mi">2</span> <span class="o">||</span> <span class="n">last</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span>
	    <span class="n">filp</span><span class="o">-&gt;</span><span class="n">f_pos</span> <span class="o">&lt;</span> <span class="n">ceph_dentry</span><span class="p">(</span><span class="n">last</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">parent</span><span class="o">-&gt;</span><span class="n">d_subdirs</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">out_unlock</span><span class="p">;</span>
		<span class="n">p</span> <span class="o">=</span> <span class="n">parent</span><span class="o">-&gt;</span><span class="n">d_subdirs</span><span class="p">.</span><span class="n">prev</span><span class="p">;</span>
		<span class="n">dout</span><span class="p">(</span><span class="s">&quot; initial p %p/%p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">prev</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">p</span> <span class="o">=</span> <span class="n">last</span><span class="o">-&gt;</span><span class="n">d_u</span><span class="p">.</span><span class="n">d_child</span><span class="p">.</span><span class="n">prev</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">more:</span>
	<span class="n">dentry</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="k">struct</span> <span class="n">dentry</span><span class="p">,</span> <span class="n">d_u</span><span class="p">.</span><span class="n">d_child</span><span class="p">);</span>
	<span class="n">di</span> <span class="o">=</span> <span class="n">ceph_dentry</span><span class="p">(</span><span class="n">dentry</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dout</span><span class="p">(</span><span class="s">&quot; p %p/%p %s d_subdirs %p/%p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">prev</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">,</span>
		     <span class="n">d_unhashed</span><span class="p">(</span><span class="n">dentry</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;!hashed&quot;</span> <span class="o">:</span> <span class="s">&quot;hashed&quot;</span><span class="p">,</span>
		     <span class="n">parent</span><span class="o">-&gt;</span><span class="n">d_subdirs</span><span class="p">.</span><span class="n">prev</span><span class="p">,</span> <span class="n">parent</span><span class="o">-&gt;</span><span class="n">d_subdirs</span><span class="p">.</span><span class="n">next</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">p</span> <span class="o">==</span> <span class="o">&amp;</span><span class="n">parent</span><span class="o">-&gt;</span><span class="n">d_subdirs</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">fi</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">CEPH_F_ATEND</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out_unlock</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">spin_lock_nested</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dentry</span><span class="o">-&gt;</span><span class="n">d_lock</span><span class="p">,</span> <span class="n">DENTRY_D_LOCK_NESTED</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">d_unhashed</span><span class="p">(</span><span class="n">dentry</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">dentry</span><span class="o">-&gt;</span><span class="n">d_inode</span> <span class="o">&amp;&amp;</span>
		    <span class="n">ceph_snap</span><span class="p">(</span><span class="n">dentry</span><span class="o">-&gt;</span><span class="n">d_inode</span><span class="p">)</span> <span class="o">!=</span> <span class="n">CEPH_SNAPDIR</span> <span class="o">&amp;&amp;</span>
		    <span class="n">ceph_ino</span><span class="p">(</span><span class="n">dentry</span><span class="o">-&gt;</span><span class="n">d_inode</span><span class="p">)</span> <span class="o">!=</span> <span class="n">CEPH_INO_CEPH</span> <span class="o">&amp;&amp;</span>
		    <span class="n">filp</span><span class="o">-&gt;</span><span class="n">f_pos</span> <span class="o">&lt;=</span> <span class="n">di</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">dout</span><span class="p">(</span><span class="s">&quot; skipping %p %.*s at %llu (%llu)%s%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dentry</span><span class="p">,</span>
		     <span class="n">dentry</span><span class="o">-&gt;</span><span class="n">d_name</span><span class="p">.</span><span class="n">len</span><span class="p">,</span> <span class="n">dentry</span><span class="o">-&gt;</span><span class="n">d_name</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">di</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">,</span>
		     <span class="n">filp</span><span class="o">-&gt;</span><span class="n">f_pos</span><span class="p">,</span> <span class="n">d_unhashed</span><span class="p">(</span><span class="n">dentry</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot; unhashed&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		     <span class="o">!</span><span class="n">dentry</span><span class="o">-&gt;</span><span class="n">d_inode</span> <span class="o">?</span> <span class="s">&quot; null&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">);</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dentry</span><span class="o">-&gt;</span><span class="n">d_lock</span><span class="p">);</span>
		<span class="n">p</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">prev</span><span class="p">;</span>
		<span class="n">dentry</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="k">struct</span> <span class="n">dentry</span><span class="p">,</span> <span class="n">d_u</span><span class="p">.</span><span class="n">d_child</span><span class="p">);</span>
		<span class="n">di</span> <span class="o">=</span> <span class="n">ceph_dentry</span><span class="p">(</span><span class="n">dentry</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">dget_dlock</span><span class="p">(</span><span class="n">dentry</span><span class="p">);</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dentry</span><span class="o">-&gt;</span><span class="n">d_lock</span><span class="p">);</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">parent</span><span class="o">-&gt;</span><span class="n">d_lock</span><span class="p">);</span>

	<span class="n">dout</span><span class="p">(</span><span class="s">&quot; %llu (%llu) dentry %p %.*s %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">di</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">,</span> <span class="n">filp</span><span class="o">-&gt;</span><span class="n">f_pos</span><span class="p">,</span>
	     <span class="n">dentry</span><span class="p">,</span> <span class="n">dentry</span><span class="o">-&gt;</span><span class="n">d_name</span><span class="p">.</span><span class="n">len</span><span class="p">,</span> <span class="n">dentry</span><span class="o">-&gt;</span><span class="n">d_name</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">dentry</span><span class="o">-&gt;</span><span class="n">d_inode</span><span class="p">);</span>
	<span class="n">filp</span><span class="o">-&gt;</span><span class="n">f_pos</span> <span class="o">=</span> <span class="n">di</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">;</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">filldir</span><span class="p">(</span><span class="n">dirent</span><span class="p">,</span> <span class="n">dentry</span><span class="o">-&gt;</span><span class="n">d_name</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
		      <span class="n">dentry</span><span class="o">-&gt;</span><span class="n">d_name</span><span class="p">.</span><span class="n">len</span><span class="p">,</span> <span class="n">di</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">,</span>
		      <span class="n">ceph_translate_ino</span><span class="p">(</span><span class="n">dentry</span><span class="o">-&gt;</span><span class="n">d_sb</span><span class="p">,</span> <span class="n">dentry</span><span class="o">-&gt;</span><span class="n">d_inode</span><span class="o">-&gt;</span><span class="n">i_ino</span><span class="p">),</span>
		      <span class="n">dentry</span><span class="o">-&gt;</span><span class="n">d_inode</span><span class="o">-&gt;</span><span class="n">i_mode</span> <span class="o">&gt;&gt;</span> <span class="mi">12</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">last</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* remember our position */</span>
			<span class="n">fi</span><span class="o">-&gt;</span><span class="n">dentry</span> <span class="o">=</span> <span class="n">last</span><span class="p">;</span>
			<span class="n">fi</span><span class="o">-&gt;</span><span class="n">next_offset</span> <span class="o">=</span> <span class="n">di</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">dput</span><span class="p">(</span><span class="n">last</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">last</span> <span class="o">=</span> <span class="n">dentry</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">filp</span><span class="o">-&gt;</span><span class="n">f_pos</span><span class="o">++</span><span class="p">;</span>

	<span class="cm">/* make sure a dentry wasn&#39;t dropped while we didn&#39;t have parent lock */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ceph_dir_test_complete</span><span class="p">(</span><span class="n">dir</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dout</span><span class="p">(</span><span class="s">&quot; lost D_COMPLETE on %p; falling back to mds</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dir</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">parent</span><span class="o">-&gt;</span><span class="n">d_lock</span><span class="p">);</span>
	<span class="n">p</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">prev</span><span class="p">;</span>	<span class="cm">/* advance to next dentry */</span>
	<span class="k">goto</span> <span class="n">more</span><span class="p">;</span>

<span class="nl">out_unlock:</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">parent</span><span class="o">-&gt;</span><span class="n">d_lock</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">last</span><span class="p">)</span>
		<span class="n">dput</span><span class="p">(</span><span class="n">last</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * make note of the last dentry we read, so we can</span>
<span class="cm"> * continue at the same lexicographical point,</span>
<span class="cm"> * regardless of what dir changes take place on the</span>
<span class="cm"> * server.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">note_last_dentry</span><span class="p">(</span><span class="k">struct</span> <span class="n">ceph_file_info</span> <span class="o">*</span><span class="n">fi</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span>
			    <span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">fi</span><span class="o">-&gt;</span><span class="n">last_name</span><span class="p">);</span>
	<span class="n">fi</span><span class="o">-&gt;</span><span class="n">last_name</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">len</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">GFP_NOFS</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fi</span><span class="o">-&gt;</span><span class="n">last_name</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">fi</span><span class="o">-&gt;</span><span class="n">last_name</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
	<span class="n">fi</span><span class="o">-&gt;</span><span class="n">last_name</span><span class="p">[</span><span class="n">len</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">dout</span><span class="p">(</span><span class="s">&quot;note_last_dentry &#39;%s&#39;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">fi</span><span class="o">-&gt;</span><span class="n">last_name</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ceph_readdir</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">filp</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dirent</span><span class="p">,</span> <span class="n">filldir_t</span> <span class="n">filldir</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ceph_file_info</span> <span class="o">*</span><span class="n">fi</span> <span class="o">=</span> <span class="n">filp</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span> <span class="o">=</span> <span class="n">filp</span><span class="o">-&gt;</span><span class="n">f_dentry</span><span class="o">-&gt;</span><span class="n">d_inode</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ceph_inode_info</span> <span class="o">*</span><span class="n">ci</span> <span class="o">=</span> <span class="n">ceph_inode</span><span class="p">(</span><span class="n">inode</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ceph_fs_client</span> <span class="o">*</span><span class="n">fsc</span> <span class="o">=</span> <span class="n">ceph_inode_to_client</span><span class="p">(</span><span class="n">inode</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ceph_mds_client</span> <span class="o">*</span><span class="n">mdsc</span> <span class="o">=</span> <span class="n">fsc</span><span class="o">-&gt;</span><span class="n">mdsc</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">frag</span> <span class="o">=</span> <span class="n">fpos_frag</span><span class="p">(</span><span class="n">filp</span><span class="o">-&gt;</span><span class="n">f_pos</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">off</span> <span class="o">=</span> <span class="n">fpos_off</span><span class="p">(</span><span class="n">filp</span><span class="o">-&gt;</span><span class="n">f_pos</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">ftype</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ceph_mds_reply_info_parsed</span> <span class="o">*</span><span class="n">rinfo</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">int</span> <span class="n">max_entries</span> <span class="o">=</span> <span class="n">fsc</span><span class="o">-&gt;</span><span class="n">mount_options</span><span class="o">-&gt;</span><span class="n">max_readdir</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">int</span> <span class="n">max_bytes</span> <span class="o">=</span> <span class="n">fsc</span><span class="o">-&gt;</span><span class="n">mount_options</span><span class="o">-&gt;</span><span class="n">max_readdir_bytes</span><span class="p">;</span>

	<span class="n">dout</span><span class="p">(</span><span class="s">&quot;readdir %p filp %p frag %u off %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">inode</span><span class="p">,</span> <span class="n">filp</span><span class="p">,</span> <span class="n">frag</span><span class="p">,</span> <span class="n">off</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fi</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">CEPH_F_ATEND</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* always start with . and .. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">filp</span><span class="o">-&gt;</span><span class="n">f_pos</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* note dir version at start of readdir so we can tell</span>
<span class="cm">		 * if any dentries get dropped */</span>
		<span class="n">fi</span><span class="o">-&gt;</span><span class="n">dir_release_count</span> <span class="o">=</span> <span class="n">ci</span><span class="o">-&gt;</span><span class="n">i_release_count</span><span class="p">;</span>

		<span class="n">dout</span><span class="p">(</span><span class="s">&quot;readdir off 0 -&gt; &#39;.&#39;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">filldir</span><span class="p">(</span><span class="n">dirent</span><span class="p">,</span> <span class="s">&quot;.&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ceph_make_fpos</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
			    <span class="n">ceph_translate_ino</span><span class="p">(</span><span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_sb</span><span class="p">,</span> <span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_ino</span><span class="p">),</span>
			    <span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_mode</span> <span class="o">&gt;&gt;</span> <span class="mi">12</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">filp</span><span class="o">-&gt;</span><span class="n">f_pos</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">off</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">filp</span><span class="o">-&gt;</span><span class="n">f_pos</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ino_t</span> <span class="n">ino</span> <span class="o">=</span> <span class="n">parent_ino</span><span class="p">(</span><span class="n">filp</span><span class="o">-&gt;</span><span class="n">f_dentry</span><span class="p">);</span>
		<span class="n">dout</span><span class="p">(</span><span class="s">&quot;readdir off 1 -&gt; &#39;..&#39;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">filldir</span><span class="p">(</span><span class="n">dirent</span><span class="p">,</span> <span class="s">&quot;..&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">ceph_make_fpos</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
			    <span class="n">ceph_translate_ino</span><span class="p">(</span><span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_sb</span><span class="p">,</span> <span class="n">ino</span><span class="p">),</span>
			    <span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_mode</span> <span class="o">&gt;&gt;</span> <span class="mi">12</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">filp</span><span class="o">-&gt;</span><span class="n">f_pos</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">off</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* can we use the dcache? */</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ci</span><span class="o">-&gt;</span><span class="n">i_ceph_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">filp</span><span class="o">-&gt;</span><span class="n">f_pos</span> <span class="o">==</span> <span class="mi">2</span> <span class="o">||</span> <span class="n">fi</span><span class="o">-&gt;</span><span class="n">dentry</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="n">ceph_test_mount_opt</span><span class="p">(</span><span class="n">fsc</span><span class="p">,</span> <span class="n">NOASYNCREADDIR</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">ceph_snap</span><span class="p">(</span><span class="n">inode</span><span class="p">)</span> <span class="o">!=</span> <span class="n">CEPH_SNAPDIR</span> <span class="o">&amp;&amp;</span>
	    <span class="n">ceph_dir_test_complete</span><span class="p">(</span><span class="n">inode</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">__ceph_caps_issued_mask</span><span class="p">(</span><span class="n">ci</span><span class="p">,</span> <span class="n">CEPH_CAP_FILE_SHARED</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ci</span><span class="o">-&gt;</span><span class="n">i_ceph_lock</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">__dcache_readdir</span><span class="p">(</span><span class="n">filp</span><span class="p">,</span> <span class="n">dirent</span><span class="p">,</span> <span class="n">filldir</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">!=</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ci</span><span class="o">-&gt;</span><span class="n">i_ceph_lock</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fi</span><span class="o">-&gt;</span><span class="n">dentry</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">note_last_dentry</span><span class="p">(</span><span class="n">fi</span><span class="p">,</span> <span class="n">fi</span><span class="o">-&gt;</span><span class="n">dentry</span><span class="o">-&gt;</span><span class="n">d_name</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
				       <span class="n">fi</span><span class="o">-&gt;</span><span class="n">dentry</span><span class="o">-&gt;</span><span class="n">d_name</span><span class="p">.</span><span class="n">len</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
		<span class="n">dput</span><span class="p">(</span><span class="n">fi</span><span class="o">-&gt;</span><span class="n">dentry</span><span class="p">);</span>
		<span class="n">fi</span><span class="o">-&gt;</span><span class="n">dentry</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* proceed with a normal readdir */</span>

<span class="nl">more:</span>
	<span class="cm">/* do we have the correct frag content buffered? */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fi</span><span class="o">-&gt;</span><span class="n">frag</span> <span class="o">!=</span> <span class="n">frag</span> <span class="o">||</span> <span class="n">fi</span><span class="o">-&gt;</span><span class="n">last_readdir</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">ceph_mds_request</span> <span class="o">*</span><span class="n">req</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">op</span> <span class="o">=</span> <span class="n">ceph_snap</span><span class="p">(</span><span class="n">inode</span><span class="p">)</span> <span class="o">==</span> <span class="n">CEPH_SNAPDIR</span> <span class="o">?</span>
			<span class="n">CEPH_MDS_OP_LSSNAP</span> <span class="o">:</span> <span class="n">CEPH_MDS_OP_READDIR</span><span class="p">;</span>

		<span class="cm">/* discard old result, if any */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">fi</span><span class="o">-&gt;</span><span class="n">last_readdir</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ceph_mdsc_put_request</span><span class="p">(</span><span class="n">fi</span><span class="o">-&gt;</span><span class="n">last_readdir</span><span class="p">);</span>
			<span class="n">fi</span><span class="o">-&gt;</span><span class="n">last_readdir</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* requery frag tree, as the frag topology may have changed */</span>
		<span class="n">frag</span> <span class="o">=</span> <span class="n">ceph_choose_frag</span><span class="p">(</span><span class="n">ceph_inode</span><span class="p">(</span><span class="n">inode</span><span class="p">),</span> <span class="n">frag</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

		<span class="n">dout</span><span class="p">(</span><span class="s">&quot;readdir fetching %llx.%llx frag %x offset &#39;%s&#39;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		     <span class="n">ceph_vinop</span><span class="p">(</span><span class="n">inode</span><span class="p">),</span> <span class="n">frag</span><span class="p">,</span> <span class="n">fi</span><span class="o">-&gt;</span><span class="n">last_name</span><span class="p">);</span>
		<span class="n">req</span> <span class="o">=</span> <span class="n">ceph_mdsc_create_request</span><span class="p">(</span><span class="n">mdsc</span><span class="p">,</span> <span class="n">op</span><span class="p">,</span> <span class="n">USE_AUTH_MDS</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">req</span><span class="p">))</span>
			<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>
		<span class="n">req</span><span class="o">-&gt;</span><span class="n">r_inode</span> <span class="o">=</span> <span class="n">inode</span><span class="p">;</span>
		<span class="n">ihold</span><span class="p">(</span><span class="n">inode</span><span class="p">);</span>
		<span class="n">req</span><span class="o">-&gt;</span><span class="n">r_dentry</span> <span class="o">=</span> <span class="n">dget</span><span class="p">(</span><span class="n">filp</span><span class="o">-&gt;</span><span class="n">f_dentry</span><span class="p">);</span>
		<span class="cm">/* hints to request -&gt; mds selection code */</span>
		<span class="n">req</span><span class="o">-&gt;</span><span class="n">r_direct_mode</span> <span class="o">=</span> <span class="n">USE_AUTH_MDS</span><span class="p">;</span>
		<span class="n">req</span><span class="o">-&gt;</span><span class="n">r_direct_hash</span> <span class="o">=</span> <span class="n">ceph_frag_value</span><span class="p">(</span><span class="n">frag</span><span class="p">);</span>
		<span class="n">req</span><span class="o">-&gt;</span><span class="n">r_direct_is_hash</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="n">req</span><span class="o">-&gt;</span><span class="n">r_path2</span> <span class="o">=</span> <span class="n">kstrdup</span><span class="p">(</span><span class="n">fi</span><span class="o">-&gt;</span><span class="n">last_name</span><span class="p">,</span> <span class="n">GFP_NOFS</span><span class="p">);</span>
		<span class="n">req</span><span class="o">-&gt;</span><span class="n">r_readdir_offset</span> <span class="o">=</span> <span class="n">fi</span><span class="o">-&gt;</span><span class="n">next_offset</span><span class="p">;</span>
		<span class="n">req</span><span class="o">-&gt;</span><span class="n">r_args</span><span class="p">.</span><span class="n">readdir</span><span class="p">.</span><span class="n">frag</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">frag</span><span class="p">);</span>
		<span class="n">req</span><span class="o">-&gt;</span><span class="n">r_args</span><span class="p">.</span><span class="n">readdir</span><span class="p">.</span><span class="n">max_entries</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">max_entries</span><span class="p">);</span>
		<span class="n">req</span><span class="o">-&gt;</span><span class="n">r_args</span><span class="p">.</span><span class="n">readdir</span><span class="p">.</span><span class="n">max_bytes</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">max_bytes</span><span class="p">);</span>
		<span class="n">req</span><span class="o">-&gt;</span><span class="n">r_num_caps</span> <span class="o">=</span> <span class="n">max_entries</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">ceph_mdsc_do_request</span><span class="p">(</span><span class="n">mdsc</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">req</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ceph_mdsc_put_request</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">dout</span><span class="p">(</span><span class="s">&quot;readdir got and parsed readdir result=%d&quot;</span>
		     <span class="s">&quot; on frag %x, end=%d, complete=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">err</span><span class="p">,</span> <span class="n">frag</span><span class="p">,</span>
		     <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">r_reply_info</span><span class="p">.</span><span class="n">dir_end</span><span class="p">,</span>
		     <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">r_reply_info</span><span class="p">.</span><span class="n">dir_complete</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">r_did_prepopulate</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dout</span><span class="p">(</span><span class="s">&quot;readdir !did_prepopulate&quot;</span><span class="p">);</span>
			<span class="n">fi</span><span class="o">-&gt;</span><span class="n">dir_release_count</span><span class="o">--</span><span class="p">;</span>    <span class="cm">/* preclude D_COMPLETE */</span>
		<span class="p">}</span>

		<span class="cm">/* note next offset and last dentry name */</span>
		<span class="n">fi</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">=</span> <span class="n">fi</span><span class="o">-&gt;</span><span class="n">next_offset</span><span class="p">;</span>
		<span class="n">fi</span><span class="o">-&gt;</span><span class="n">last_readdir</span> <span class="o">=</span> <span class="n">req</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">r_reply_info</span><span class="p">.</span><span class="n">dir_end</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">fi</span><span class="o">-&gt;</span><span class="n">last_name</span><span class="p">);</span>
			<span class="n">fi</span><span class="o">-&gt;</span><span class="n">last_name</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ceph_frag_is_rightmost</span><span class="p">(</span><span class="n">frag</span><span class="p">))</span>
				<span class="n">fi</span><span class="o">-&gt;</span><span class="n">next_offset</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">fi</span><span class="o">-&gt;</span><span class="n">next_offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">rinfo</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">r_reply_info</span><span class="p">;</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">note_last_dentry</span><span class="p">(</span><span class="n">fi</span><span class="p">,</span>
				       <span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">dir_dname</span><span class="p">[</span><span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">dir_nr</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
				       <span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">dir_dname_len</span><span class="p">[</span><span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">dir_nr</span><span class="o">-</span><span class="mi">1</span><span class="p">]);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
			<span class="n">fi</span><span class="o">-&gt;</span><span class="n">next_offset</span> <span class="o">+=</span> <span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">dir_nr</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">rinfo</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">fi</span><span class="o">-&gt;</span><span class="n">last_readdir</span><span class="o">-&gt;</span><span class="n">r_reply_info</span><span class="p">;</span>
	<span class="n">dout</span><span class="p">(</span><span class="s">&quot;readdir frag %x num %d off %d chunkoff %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">frag</span><span class="p">,</span>
	     <span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">dir_nr</span><span class="p">,</span> <span class="n">off</span><span class="p">,</span> <span class="n">fi</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">off</span> <span class="o">&gt;=</span> <span class="n">fi</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">&amp;&amp;</span> <span class="n">off</span> <span class="o">-</span> <span class="n">fi</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">&lt;</span> <span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">dir_nr</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u64</span> <span class="n">pos</span> <span class="o">=</span> <span class="n">ceph_make_fpos</span><span class="p">(</span><span class="n">frag</span><span class="p">,</span> <span class="n">off</span><span class="p">);</span>
		<span class="k">struct</span> <span class="n">ceph_mds_reply_inode</span> <span class="o">*</span><span class="n">in</span> <span class="o">=</span>
			<span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">dir_in</span><span class="p">[</span><span class="n">off</span> <span class="o">-</span> <span class="n">fi</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">].</span><span class="n">in</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">ceph_vino</span> <span class="n">vino</span><span class="p">;</span>
		<span class="n">ino_t</span> <span class="n">ino</span><span class="p">;</span>

		<span class="n">dout</span><span class="p">(</span><span class="s">&quot;readdir off %d (%d/%d) -&gt; %lld &#39;%.*s&#39; %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		     <span class="n">off</span><span class="p">,</span> <span class="n">off</span> <span class="o">-</span> <span class="n">fi</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">,</span> <span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">dir_nr</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span>
		     <span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">dir_dname_len</span><span class="p">[</span><span class="n">off</span> <span class="o">-</span> <span class="n">fi</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">],</span>
		     <span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">dir_dname</span><span class="p">[</span><span class="n">off</span> <span class="o">-</span> <span class="n">fi</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">],</span> <span class="n">in</span><span class="p">);</span>
		<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">in</span><span class="p">);</span>
		<span class="n">ftype</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">in</span><span class="o">-&gt;</span><span class="n">mode</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">12</span><span class="p">;</span>
		<span class="n">vino</span><span class="p">.</span><span class="n">ino</span> <span class="o">=</span> <span class="n">le64_to_cpu</span><span class="p">(</span><span class="n">in</span><span class="o">-&gt;</span><span class="n">ino</span><span class="p">);</span>
		<span class="n">vino</span><span class="p">.</span><span class="n">snap</span> <span class="o">=</span> <span class="n">le64_to_cpu</span><span class="p">(</span><span class="n">in</span><span class="o">-&gt;</span><span class="n">snapid</span><span class="p">);</span>
		<span class="n">ino</span> <span class="o">=</span> <span class="n">ceph_vino_to_ino</span><span class="p">(</span><span class="n">vino</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">filldir</span><span class="p">(</span><span class="n">dirent</span><span class="p">,</span>
			    <span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">dir_dname</span><span class="p">[</span><span class="n">off</span> <span class="o">-</span> <span class="n">fi</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">],</span>
			    <span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">dir_dname_len</span><span class="p">[</span><span class="n">off</span> <span class="o">-</span> <span class="n">fi</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">],</span>
			    <span class="n">pos</span><span class="p">,</span>
			    <span class="n">ceph_translate_ino</span><span class="p">(</span><span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_sb</span><span class="p">,</span> <span class="n">ino</span><span class="p">),</span> <span class="n">ftype</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dout</span><span class="p">(</span><span class="s">&quot;filldir stopping us...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">off</span><span class="o">++</span><span class="p">;</span>
		<span class="n">filp</span><span class="o">-&gt;</span><span class="n">f_pos</span> <span class="o">=</span> <span class="n">pos</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fi</span><span class="o">-&gt;</span><span class="n">last_name</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ceph_mdsc_put_request</span><span class="p">(</span><span class="n">fi</span><span class="o">-&gt;</span><span class="n">last_readdir</span><span class="p">);</span>
		<span class="n">fi</span><span class="o">-&gt;</span><span class="n">last_readdir</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">more</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* more frags? */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ceph_frag_is_rightmost</span><span class="p">(</span><span class="n">frag</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">frag</span> <span class="o">=</span> <span class="n">ceph_frag_next</span><span class="p">(</span><span class="n">frag</span><span class="p">);</span>
		<span class="n">off</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">filp</span><span class="o">-&gt;</span><span class="n">f_pos</span> <span class="o">=</span> <span class="n">ceph_make_fpos</span><span class="p">(</span><span class="n">frag</span><span class="p">,</span> <span class="n">off</span><span class="p">);</span>
		<span class="n">dout</span><span class="p">(</span><span class="s">&quot;readdir next frag is %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">frag</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">more</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">fi</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">CEPH_F_ATEND</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * if dir_release_count still matches the dir, no dentries</span>
<span class="cm">	 * were released during the whole readdir, and we should have</span>
<span class="cm">	 * the complete dir contents in our cache.</span>
<span class="cm">	 */</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ci</span><span class="o">-&gt;</span><span class="n">i_ceph_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ci</span><span class="o">-&gt;</span><span class="n">i_release_count</span> <span class="o">==</span> <span class="n">fi</span><span class="o">-&gt;</span><span class="n">dir_release_count</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ceph_dir_set_complete</span><span class="p">(</span><span class="n">inode</span><span class="p">);</span>
		<span class="n">ci</span><span class="o">-&gt;</span><span class="n">i_max_offset</span> <span class="o">=</span> <span class="n">filp</span><span class="o">-&gt;</span><span class="n">f_pos</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ci</span><span class="o">-&gt;</span><span class="n">i_ceph_lock</span><span class="p">);</span>

	<span class="n">dout</span><span class="p">(</span><span class="s">&quot;readdir %p filp %p done.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">inode</span><span class="p">,</span> <span class="n">filp</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">reset_readdir</span><span class="p">(</span><span class="k">struct</span> <span class="n">ceph_file_info</span> <span class="o">*</span><span class="n">fi</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fi</span><span class="o">-&gt;</span><span class="n">last_readdir</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ceph_mdsc_put_request</span><span class="p">(</span><span class="n">fi</span><span class="o">-&gt;</span><span class="n">last_readdir</span><span class="p">);</span>
		<span class="n">fi</span><span class="o">-&gt;</span><span class="n">last_readdir</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">fi</span><span class="o">-&gt;</span><span class="n">last_name</span><span class="p">);</span>
	<span class="n">fi</span><span class="o">-&gt;</span><span class="n">last_name</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">fi</span><span class="o">-&gt;</span><span class="n">next_offset</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>  <span class="cm">/* compensate for . and .. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fi</span><span class="o">-&gt;</span><span class="n">dentry</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dput</span><span class="p">(</span><span class="n">fi</span><span class="o">-&gt;</span><span class="n">dentry</span><span class="p">);</span>
		<span class="n">fi</span><span class="o">-&gt;</span><span class="n">dentry</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">fi</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">CEPH_F_ATEND</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">loff_t</span> <span class="nf">ceph_dir_llseek</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="n">loff_t</span> <span class="n">offset</span><span class="p">,</span> <span class="kt">int</span> <span class="n">origin</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ceph_file_info</span> <span class="o">*</span><span class="n">fi</span> <span class="o">=</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span> <span class="o">=</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">f_mapping</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">;</span>
	<span class="n">loff_t</span> <span class="n">old_offset</span> <span class="o">=</span> <span class="n">offset</span><span class="p">;</span>
	<span class="n">loff_t</span> <span class="n">retval</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_mutex</span><span class="p">);</span>
	<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">origin</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SEEK_END</span>:
		<span class="n">offset</span> <span class="o">+=</span> <span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_size</span> <span class="o">+</span> <span class="mi">2</span><span class="p">;</span>   <span class="cm">/* FIXME */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SEEK_CUR</span>:
		<span class="n">offset</span> <span class="o">+=</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">f_pos</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SEEK_SET</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">offset</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">offset</span> <span class="o">&lt;=</span> <span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_sb</span><span class="o">-&gt;</span><span class="n">s_maxbytes</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">offset</span> <span class="o">!=</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">f_pos</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">file</span><span class="o">-&gt;</span><span class="n">f_pos</span> <span class="o">=</span> <span class="n">offset</span><span class="p">;</span>
			<span class="n">file</span><span class="o">-&gt;</span><span class="n">f_version</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">fi</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">CEPH_F_ATEND</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">offset</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * discard buffered readdir content on seekdir(0), or</span>
<span class="cm">		 * seek to new frag, or seek prior to current chunk.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">offset</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span>
		    <span class="n">fpos_frag</span><span class="p">(</span><span class="n">offset</span><span class="p">)</span> <span class="o">!=</span> <span class="n">fpos_frag</span><span class="p">(</span><span class="n">old_offset</span><span class="p">)</span> <span class="o">||</span>
		    <span class="n">fpos_off</span><span class="p">(</span><span class="n">offset</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">fi</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dout</span><span class="p">(</span><span class="s">&quot;dir_llseek dropping %p content</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">file</span><span class="p">);</span>
			<span class="n">reset_readdir</span><span class="p">(</span><span class="n">fi</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="cm">/* bump dir_release_count if we did a forward seek */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">offset</span> <span class="o">&gt;</span> <span class="n">old_offset</span><span class="p">)</span>
			<span class="n">fi</span><span class="o">-&gt;</span><span class="n">dir_release_count</span><span class="o">--</span><span class="p">;</span>
	<span class="p">}</span>
<span class="nl">out:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Handle lookups for the hidden .snap directory.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">ceph_handle_snapdir</span><span class="p">(</span><span class="k">struct</span> <span class="n">ceph_mds_request</span> <span class="o">*</span><span class="n">req</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="n">dentry</span><span class="p">,</span> <span class="kt">int</span> <span class="n">err</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ceph_fs_client</span> <span class="o">*</span><span class="n">fsc</span> <span class="o">=</span> <span class="n">ceph_sb_to_client</span><span class="p">(</span><span class="n">dentry</span><span class="o">-&gt;</span><span class="n">d_sb</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">parent</span> <span class="o">=</span> <span class="n">dentry</span><span class="o">-&gt;</span><span class="n">d_parent</span><span class="o">-&gt;</span><span class="n">d_inode</span><span class="p">;</span> <span class="cm">/* we hold i_mutex */</span>

	<span class="cm">/* .snap dir? */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">==</span> <span class="o">-</span><span class="n">ENOENT</span> <span class="o">&amp;&amp;</span>
	    <span class="n">ceph_snap</span><span class="p">(</span><span class="n">parent</span><span class="p">)</span> <span class="o">==</span> <span class="n">CEPH_NOSNAP</span> <span class="o">&amp;&amp;</span>
	    <span class="n">strcmp</span><span class="p">(</span><span class="n">dentry</span><span class="o">-&gt;</span><span class="n">d_name</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
		   <span class="n">fsc</span><span class="o">-&gt;</span><span class="n">mount_options</span><span class="o">-&gt;</span><span class="n">snapdir_name</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span> <span class="o">=</span> <span class="n">ceph_get_snapdir</span><span class="p">(</span><span class="n">parent</span><span class="p">);</span>
		<span class="n">dout</span><span class="p">(</span><span class="s">&quot;ENOENT on snapdir %p &#39;%.*s&#39;, linking to snapdir %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		     <span class="n">dentry</span><span class="p">,</span> <span class="n">dentry</span><span class="o">-&gt;</span><span class="n">d_name</span><span class="p">.</span><span class="n">len</span><span class="p">,</span> <span class="n">dentry</span><span class="o">-&gt;</span><span class="n">d_name</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">inode</span><span class="p">);</span>
		<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">d_unhashed</span><span class="p">(</span><span class="n">dentry</span><span class="p">));</span>
		<span class="n">d_add</span><span class="p">(</span><span class="n">dentry</span><span class="p">,</span> <span class="n">inode</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Figure out final result of a lookup/open request.</span>
<span class="cm"> *</span>
<span class="cm"> * Mainly, make sure we return the final req-&gt;r_dentry (if it already</span>
<span class="cm"> * existed) in place of the original VFS-provided dentry when they</span>
<span class="cm"> * differ.</span>
<span class="cm"> *</span>
<span class="cm"> * Gracefully handle the case where the MDS replies with -ENOENT and</span>
<span class="cm"> * no trace (which it may do, at its discretion, e.g., if it doesn&#39;t</span>
<span class="cm"> * care to issue a lease on the negative dentry).</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="nf">ceph_finish_lookup</span><span class="p">(</span><span class="k">struct</span> <span class="n">ceph_mds_request</span> <span class="o">*</span><span class="n">req</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="n">dentry</span><span class="p">,</span> <span class="kt">int</span> <span class="n">err</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">==</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* no trace? */</span>
		<span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">r_reply_info</span><span class="p">.</span><span class="n">head</span><span class="o">-&gt;</span><span class="n">is_dentry</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dout</span><span class="p">(</span><span class="s">&quot;ENOENT and no trace, dentry %p inode %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			     <span class="n">dentry</span><span class="p">,</span> <span class="n">dentry</span><span class="o">-&gt;</span><span class="n">d_inode</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">dentry</span><span class="o">-&gt;</span><span class="n">d_inode</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">d_drop</span><span class="p">(</span><span class="n">dentry</span><span class="p">);</span>
				<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">d_add</span><span class="p">(</span><span class="n">dentry</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="n">dentry</span> <span class="o">=</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="n">err</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">dentry</span> <span class="o">!=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">r_dentry</span><span class="p">)</span>
		<span class="n">dentry</span> <span class="o">=</span> <span class="n">dget</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">r_dentry</span><span class="p">);</span>   <span class="cm">/* we got spliced */</span>
	<span class="k">else</span>
		<span class="n">dentry</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">dentry</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">is_root_ceph_dentry</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="n">dentry</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">ceph_ino</span><span class="p">(</span><span class="n">inode</span><span class="p">)</span> <span class="o">==</span> <span class="n">CEPH_INO_ROOT</span> <span class="o">&amp;&amp;</span>
		<span class="n">strncmp</span><span class="p">(</span><span class="n">dentry</span><span class="o">-&gt;</span><span class="n">d_name</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;.ceph&quot;</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Look up a single dir entry.  If there is a lookup intent, inform</span>
<span class="cm"> * the MDS so that it gets our &#39;caps wanted&#39; value in a single op.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="nf">ceph_lookup</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">dir</span><span class="p">,</span> <span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="n">dentry</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">nameidata</span> <span class="o">*</span><span class="n">nd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ceph_fs_client</span> <span class="o">*</span><span class="n">fsc</span> <span class="o">=</span> <span class="n">ceph_sb_to_client</span><span class="p">(</span><span class="n">dir</span><span class="o">-&gt;</span><span class="n">i_sb</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ceph_mds_client</span> <span class="o">*</span><span class="n">mdsc</span> <span class="o">=</span> <span class="n">fsc</span><span class="o">-&gt;</span><span class="n">mdsc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ceph_mds_request</span> <span class="o">*</span><span class="n">req</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">op</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">dout</span><span class="p">(</span><span class="s">&quot;lookup %p dentry %p &#39;%.*s&#39;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	     <span class="n">dir</span><span class="p">,</span> <span class="n">dentry</span><span class="p">,</span> <span class="n">dentry</span><span class="o">-&gt;</span><span class="n">d_name</span><span class="p">.</span><span class="n">len</span><span class="p">,</span> <span class="n">dentry</span><span class="o">-&gt;</span><span class="n">d_name</span><span class="p">.</span><span class="n">name</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dentry</span><span class="o">-&gt;</span><span class="n">d_name</span><span class="p">.</span><span class="n">len</span> <span class="o">&gt;</span> <span class="n">NAME_MAX</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">ENAMETOOLONG</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">ceph_init_dentry</span><span class="p">(</span><span class="n">dentry</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="n">err</span><span class="p">);</span>

	<span class="cm">/* open (but not create!) intent? */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nd</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">nd</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">LOOKUP_OPEN</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="p">(</span><span class="n">nd</span><span class="o">-&gt;</span><span class="n">intent</span><span class="p">.</span><span class="n">open</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">O_CREAT</span><span class="p">))</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">mode</span> <span class="o">=</span> <span class="n">nd</span><span class="o">-&gt;</span><span class="n">intent</span><span class="p">.</span><span class="n">open</span><span class="p">.</span><span class="n">create_mode</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">current</span><span class="o">-&gt;</span><span class="n">fs</span><span class="o">-&gt;</span><span class="n">umask</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">ceph_lookup_open</span><span class="p">(</span><span class="n">dir</span><span class="p">,</span> <span class="n">dentry</span><span class="p">,</span> <span class="n">nd</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* can we conclude ENOENT locally? */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dentry</span><span class="o">-&gt;</span><span class="n">d_inode</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">ceph_inode_info</span> <span class="o">*</span><span class="n">ci</span> <span class="o">=</span> <span class="n">ceph_inode</span><span class="p">(</span><span class="n">dir</span><span class="p">);</span>
		<span class="k">struct</span> <span class="n">ceph_dentry_info</span> <span class="o">*</span><span class="n">di</span> <span class="o">=</span> <span class="n">ceph_dentry</span><span class="p">(</span><span class="n">dentry</span><span class="p">);</span>

		<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ci</span><span class="o">-&gt;</span><span class="n">i_ceph_lock</span><span class="p">);</span>
		<span class="n">dout</span><span class="p">(</span><span class="s">&quot; dir %p flags are %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dir</span><span class="p">,</span> <span class="n">ci</span><span class="o">-&gt;</span><span class="n">i_ceph_flags</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">strncmp</span><span class="p">(</span><span class="n">dentry</span><span class="o">-&gt;</span><span class="n">d_name</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
			    <span class="n">fsc</span><span class="o">-&gt;</span><span class="n">mount_options</span><span class="o">-&gt;</span><span class="n">snapdir_name</span><span class="p">,</span>
			    <span class="n">dentry</span><span class="o">-&gt;</span><span class="n">d_name</span><span class="p">.</span><span class="n">len</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="o">!</span><span class="n">is_root_ceph_dentry</span><span class="p">(</span><span class="n">dir</span><span class="p">,</span> <span class="n">dentry</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="n">ceph_dir_test_complete</span><span class="p">(</span><span class="n">dir</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">__ceph_caps_issued_mask</span><span class="p">(</span><span class="n">ci</span><span class="p">,</span> <span class="n">CEPH_CAP_FILE_SHARED</span><span class="p">,</span> <span class="mi">1</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ci</span><span class="o">-&gt;</span><span class="n">i_ceph_lock</span><span class="p">);</span>
			<span class="n">dout</span><span class="p">(</span><span class="s">&quot; dir %p complete, -ENOENT</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dir</span><span class="p">);</span>
			<span class="n">d_add</span><span class="p">(</span><span class="n">dentry</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
			<span class="n">di</span><span class="o">-&gt;</span><span class="n">lease_shared_gen</span> <span class="o">=</span> <span class="n">ci</span><span class="o">-&gt;</span><span class="n">i_shared_gen</span><span class="p">;</span>
			<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ci</span><span class="o">-&gt;</span><span class="n">i_ceph_lock</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">op</span> <span class="o">=</span> <span class="n">ceph_snap</span><span class="p">(</span><span class="n">dir</span><span class="p">)</span> <span class="o">==</span> <span class="n">CEPH_SNAPDIR</span> <span class="o">?</span>
		<span class="n">CEPH_MDS_OP_LOOKUPSNAP</span> <span class="o">:</span> <span class="n">CEPH_MDS_OP_LOOKUP</span><span class="p">;</span>
	<span class="n">req</span> <span class="o">=</span> <span class="n">ceph_mdsc_create_request</span><span class="p">(</span><span class="n">mdsc</span><span class="p">,</span> <span class="n">op</span><span class="p">,</span> <span class="n">USE_ANY_MDS</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">req</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">ERR_CAST</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">r_dentry</span> <span class="o">=</span> <span class="n">dget</span><span class="p">(</span><span class="n">dentry</span><span class="p">);</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">r_num_caps</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="cm">/* we only need inode linkage */</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">r_args</span><span class="p">.</span><span class="n">getattr</span><span class="p">.</span><span class="n">mask</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">CEPH_STAT_CAP_INODE</span><span class="p">);</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">r_locked_dir</span> <span class="o">=</span> <span class="n">dir</span><span class="p">;</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">ceph_mdsc_do_request</span><span class="p">(</span><span class="n">mdsc</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">req</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">ceph_handle_snapdir</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="n">dentry</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
	<span class="n">dentry</span> <span class="o">=</span> <span class="n">ceph_finish_lookup</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="n">dentry</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
	<span class="n">ceph_mdsc_put_request</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>  <span class="cm">/* will dput(dentry) */</span>
	<span class="n">dout</span><span class="p">(</span><span class="s">&quot;lookup result=%p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dentry</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">dentry</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * If we do a create but get no trace back from the MDS, follow up with</span>
<span class="cm"> * a lookup (the VFS expects us to link up the provided dentry).</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">ceph_handle_notrace_create</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">dir</span><span class="p">,</span> <span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="n">dentry</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="n">result</span> <span class="o">=</span> <span class="n">ceph_lookup</span><span class="p">(</span><span class="n">dir</span><span class="p">,</span> <span class="n">dentry</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">result</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * We created the item, then did a lookup, and found</span>
<span class="cm">		 * it was already linked to another inode we already</span>
<span class="cm">		 * had in our cache (and thus got spliced).  Link our</span>
<span class="cm">		 * dentry to that inode, but don&#39;t hash it, just in</span>
<span class="cm">		 * case the VFS wants to dereference it.</span>
<span class="cm">		 */</span>
		<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">result</span><span class="o">-&gt;</span><span class="n">d_inode</span><span class="p">);</span>
		<span class="n">d_instantiate</span><span class="p">(</span><span class="n">dentry</span><span class="p">,</span> <span class="n">result</span><span class="o">-&gt;</span><span class="n">d_inode</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">result</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ceph_mknod</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">dir</span><span class="p">,</span> <span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="n">dentry</span><span class="p">,</span>
		      <span class="n">umode_t</span> <span class="n">mode</span><span class="p">,</span> <span class="n">dev_t</span> <span class="n">rdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ceph_fs_client</span> <span class="o">*</span><span class="n">fsc</span> <span class="o">=</span> <span class="n">ceph_sb_to_client</span><span class="p">(</span><span class="n">dir</span><span class="o">-&gt;</span><span class="n">i_sb</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ceph_mds_client</span> <span class="o">*</span><span class="n">mdsc</span> <span class="o">=</span> <span class="n">fsc</span><span class="o">-&gt;</span><span class="n">mdsc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ceph_mds_request</span> <span class="o">*</span><span class="n">req</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ceph_snap</span><span class="p">(</span><span class="n">dir</span><span class="p">)</span> <span class="o">!=</span> <span class="n">CEPH_NOSNAP</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EROFS</span><span class="p">;</span>

	<span class="n">dout</span><span class="p">(</span><span class="s">&quot;mknod in dir %p dentry %p mode 0%ho rdev %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	     <span class="n">dir</span><span class="p">,</span> <span class="n">dentry</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">rdev</span><span class="p">);</span>
	<span class="n">req</span> <span class="o">=</span> <span class="n">ceph_mdsc_create_request</span><span class="p">(</span><span class="n">mdsc</span><span class="p">,</span> <span class="n">CEPH_MDS_OP_MKNOD</span><span class="p">,</span> <span class="n">USE_AUTH_MDS</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">req</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">d_drop</span><span class="p">(</span><span class="n">dentry</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">r_dentry</span> <span class="o">=</span> <span class="n">dget</span><span class="p">(</span><span class="n">dentry</span><span class="p">);</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">r_num_caps</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">r_locked_dir</span> <span class="o">=</span> <span class="n">dir</span><span class="p">;</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">r_args</span><span class="p">.</span><span class="n">mknod</span><span class="p">.</span><span class="n">mode</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">mode</span><span class="p">);</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">r_args</span><span class="p">.</span><span class="n">mknod</span><span class="p">.</span><span class="n">rdev</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">rdev</span><span class="p">);</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">r_dentry_drop</span> <span class="o">=</span> <span class="n">CEPH_CAP_FILE_SHARED</span><span class="p">;</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">r_dentry_unless</span> <span class="o">=</span> <span class="n">CEPH_CAP_FILE_EXCL</span><span class="p">;</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">ceph_mdsc_do_request</span><span class="p">(</span><span class="n">mdsc</span><span class="p">,</span> <span class="n">dir</span><span class="p">,</span> <span class="n">req</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">r_reply_info</span><span class="p">.</span><span class="n">head</span><span class="o">-&gt;</span><span class="n">is_dentry</span><span class="p">)</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">ceph_handle_notrace_create</span><span class="p">(</span><span class="n">dir</span><span class="p">,</span> <span class="n">dentry</span><span class="p">);</span>
	<span class="n">ceph_mdsc_put_request</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="n">d_drop</span><span class="p">(</span><span class="n">dentry</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ceph_create</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">dir</span><span class="p">,</span> <span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="n">dentry</span><span class="p">,</span> <span class="n">umode_t</span> <span class="n">mode</span><span class="p">,</span>
		       <span class="k">struct</span> <span class="n">nameidata</span> <span class="o">*</span><span class="n">nd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dout</span><span class="p">(</span><span class="s">&quot;create in dir %p dentry %p name &#39;%.*s&#39;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	     <span class="n">dir</span><span class="p">,</span> <span class="n">dentry</span><span class="p">,</span> <span class="n">dentry</span><span class="o">-&gt;</span><span class="n">d_name</span><span class="p">.</span><span class="n">len</span><span class="p">,</span> <span class="n">dentry</span><span class="o">-&gt;</span><span class="n">d_name</span><span class="p">.</span><span class="n">name</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ceph_snap</span><span class="p">(</span><span class="n">dir</span><span class="p">)</span> <span class="o">!=</span> <span class="n">CEPH_NOSNAP</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EROFS</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nd</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">BUG_ON</span><span class="p">((</span><span class="n">nd</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">LOOKUP_OPEN</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">dentry</span> <span class="o">=</span> <span class="n">ceph_lookup_open</span><span class="p">(</span><span class="n">dir</span><span class="p">,</span> <span class="n">dentry</span><span class="p">,</span> <span class="n">nd</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="cm">/* hrm, what should i do here if we get aliased? */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">dentry</span><span class="p">))</span>
			<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">dentry</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* fall back to mknod */</span>
	<span class="k">return</span> <span class="n">ceph_mknod</span><span class="p">(</span><span class="n">dir</span><span class="p">,</span> <span class="n">dentry</span><span class="p">,</span> <span class="p">(</span><span class="n">mode</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">S_IFMT</span><span class="p">)</span> <span class="o">|</span> <span class="n">S_IFREG</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ceph_symlink</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">dir</span><span class="p">,</span> <span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="n">dentry</span><span class="p">,</span>
			    <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">dest</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ceph_fs_client</span> <span class="o">*</span><span class="n">fsc</span> <span class="o">=</span> <span class="n">ceph_sb_to_client</span><span class="p">(</span><span class="n">dir</span><span class="o">-&gt;</span><span class="n">i_sb</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ceph_mds_client</span> <span class="o">*</span><span class="n">mdsc</span> <span class="o">=</span> <span class="n">fsc</span><span class="o">-&gt;</span><span class="n">mdsc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ceph_mds_request</span> <span class="o">*</span><span class="n">req</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ceph_snap</span><span class="p">(</span><span class="n">dir</span><span class="p">)</span> <span class="o">!=</span> <span class="n">CEPH_NOSNAP</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EROFS</span><span class="p">;</span>

	<span class="n">dout</span><span class="p">(</span><span class="s">&quot;symlink in dir %p dentry %p to &#39;%s&#39;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dir</span><span class="p">,</span> <span class="n">dentry</span><span class="p">,</span> <span class="n">dest</span><span class="p">);</span>
	<span class="n">req</span> <span class="o">=</span> <span class="n">ceph_mdsc_create_request</span><span class="p">(</span><span class="n">mdsc</span><span class="p">,</span> <span class="n">CEPH_MDS_OP_SYMLINK</span><span class="p">,</span> <span class="n">USE_AUTH_MDS</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">req</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">d_drop</span><span class="p">(</span><span class="n">dentry</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">r_dentry</span> <span class="o">=</span> <span class="n">dget</span><span class="p">(</span><span class="n">dentry</span><span class="p">);</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">r_num_caps</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">r_path2</span> <span class="o">=</span> <span class="n">kstrdup</span><span class="p">(</span><span class="n">dest</span><span class="p">,</span> <span class="n">GFP_NOFS</span><span class="p">);</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">r_locked_dir</span> <span class="o">=</span> <span class="n">dir</span><span class="p">;</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">r_dentry_drop</span> <span class="o">=</span> <span class="n">CEPH_CAP_FILE_SHARED</span><span class="p">;</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">r_dentry_unless</span> <span class="o">=</span> <span class="n">CEPH_CAP_FILE_EXCL</span><span class="p">;</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">ceph_mdsc_do_request</span><span class="p">(</span><span class="n">mdsc</span><span class="p">,</span> <span class="n">dir</span><span class="p">,</span> <span class="n">req</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">r_reply_info</span><span class="p">.</span><span class="n">head</span><span class="o">-&gt;</span><span class="n">is_dentry</span><span class="p">)</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">ceph_handle_notrace_create</span><span class="p">(</span><span class="n">dir</span><span class="p">,</span> <span class="n">dentry</span><span class="p">);</span>
	<span class="n">ceph_mdsc_put_request</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="n">d_drop</span><span class="p">(</span><span class="n">dentry</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ceph_mkdir</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">dir</span><span class="p">,</span> <span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="n">dentry</span><span class="p">,</span> <span class="n">umode_t</span> <span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ceph_fs_client</span> <span class="o">*</span><span class="n">fsc</span> <span class="o">=</span> <span class="n">ceph_sb_to_client</span><span class="p">(</span><span class="n">dir</span><span class="o">-&gt;</span><span class="n">i_sb</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ceph_mds_client</span> <span class="o">*</span><span class="n">mdsc</span> <span class="o">=</span> <span class="n">fsc</span><span class="o">-&gt;</span><span class="n">mdsc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ceph_mds_request</span> <span class="o">*</span><span class="n">req</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EROFS</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">op</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ceph_snap</span><span class="p">(</span><span class="n">dir</span><span class="p">)</span> <span class="o">==</span> <span class="n">CEPH_SNAPDIR</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* mkdir .snap/foo is a MKSNAP */</span>
		<span class="n">op</span> <span class="o">=</span> <span class="n">CEPH_MDS_OP_MKSNAP</span><span class="p">;</span>
		<span class="n">dout</span><span class="p">(</span><span class="s">&quot;mksnap dir %p snap &#39;%.*s&#39; dn %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dir</span><span class="p">,</span>
		     <span class="n">dentry</span><span class="o">-&gt;</span><span class="n">d_name</span><span class="p">.</span><span class="n">len</span><span class="p">,</span> <span class="n">dentry</span><span class="o">-&gt;</span><span class="n">d_name</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">dentry</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ceph_snap</span><span class="p">(</span><span class="n">dir</span><span class="p">)</span> <span class="o">==</span> <span class="n">CEPH_NOSNAP</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dout</span><span class="p">(</span><span class="s">&quot;mkdir dir %p dn %p mode 0%ho</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dir</span><span class="p">,</span> <span class="n">dentry</span><span class="p">,</span> <span class="n">mode</span><span class="p">);</span>
		<span class="n">op</span> <span class="o">=</span> <span class="n">CEPH_MDS_OP_MKDIR</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">req</span> <span class="o">=</span> <span class="n">ceph_mdsc_create_request</span><span class="p">(</span><span class="n">mdsc</span><span class="p">,</span> <span class="n">op</span><span class="p">,</span> <span class="n">USE_AUTH_MDS</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">req</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">req</span><span class="o">-&gt;</span><span class="n">r_dentry</span> <span class="o">=</span> <span class="n">dget</span><span class="p">(</span><span class="n">dentry</span><span class="p">);</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">r_num_caps</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">r_locked_dir</span> <span class="o">=</span> <span class="n">dir</span><span class="p">;</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">r_args</span><span class="p">.</span><span class="n">mkdir</span><span class="p">.</span><span class="n">mode</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">mode</span><span class="p">);</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">r_dentry_drop</span> <span class="o">=</span> <span class="n">CEPH_CAP_FILE_SHARED</span><span class="p">;</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">r_dentry_unless</span> <span class="o">=</span> <span class="n">CEPH_CAP_FILE_EXCL</span><span class="p">;</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">ceph_mdsc_do_request</span><span class="p">(</span><span class="n">mdsc</span><span class="p">,</span> <span class="n">dir</span><span class="p">,</span> <span class="n">req</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">r_reply_info</span><span class="p">.</span><span class="n">head</span><span class="o">-&gt;</span><span class="n">is_dentry</span><span class="p">)</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">ceph_handle_notrace_create</span><span class="p">(</span><span class="n">dir</span><span class="p">,</span> <span class="n">dentry</span><span class="p">);</span>
	<span class="n">ceph_mdsc_put_request</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">d_drop</span><span class="p">(</span><span class="n">dentry</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ceph_link</span><span class="p">(</span><span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="n">old_dentry</span><span class="p">,</span> <span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">dir</span><span class="p">,</span>
		     <span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="n">dentry</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ceph_fs_client</span> <span class="o">*</span><span class="n">fsc</span> <span class="o">=</span> <span class="n">ceph_sb_to_client</span><span class="p">(</span><span class="n">dir</span><span class="o">-&gt;</span><span class="n">i_sb</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ceph_mds_client</span> <span class="o">*</span><span class="n">mdsc</span> <span class="o">=</span> <span class="n">fsc</span><span class="o">-&gt;</span><span class="n">mdsc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ceph_mds_request</span> <span class="o">*</span><span class="n">req</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ceph_snap</span><span class="p">(</span><span class="n">dir</span><span class="p">)</span> <span class="o">!=</span> <span class="n">CEPH_NOSNAP</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EROFS</span><span class="p">;</span>

	<span class="n">dout</span><span class="p">(</span><span class="s">&quot;link in dir %p old_dentry %p dentry %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dir</span><span class="p">,</span>
	     <span class="n">old_dentry</span><span class="p">,</span> <span class="n">dentry</span><span class="p">);</span>
	<span class="n">req</span> <span class="o">=</span> <span class="n">ceph_mdsc_create_request</span><span class="p">(</span><span class="n">mdsc</span><span class="p">,</span> <span class="n">CEPH_MDS_OP_LINK</span><span class="p">,</span> <span class="n">USE_AUTH_MDS</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">req</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">d_drop</span><span class="p">(</span><span class="n">dentry</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">r_dentry</span> <span class="o">=</span> <span class="n">dget</span><span class="p">(</span><span class="n">dentry</span><span class="p">);</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">r_num_caps</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">r_old_dentry</span> <span class="o">=</span> <span class="n">dget</span><span class="p">(</span><span class="n">old_dentry</span><span class="p">);</span> <span class="cm">/* or inode? hrm. */</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">r_old_dentry_dir</span> <span class="o">=</span> <span class="n">ceph_get_dentry_parent_inode</span><span class="p">(</span><span class="n">old_dentry</span><span class="p">);</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">r_locked_dir</span> <span class="o">=</span> <span class="n">dir</span><span class="p">;</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">r_dentry_drop</span> <span class="o">=</span> <span class="n">CEPH_CAP_FILE_SHARED</span><span class="p">;</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">r_dentry_unless</span> <span class="o">=</span> <span class="n">CEPH_CAP_FILE_EXCL</span><span class="p">;</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">ceph_mdsc_do_request</span><span class="p">(</span><span class="n">mdsc</span><span class="p">,</span> <span class="n">dir</span><span class="p">,</span> <span class="n">req</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">d_drop</span><span class="p">(</span><span class="n">dentry</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">r_reply_info</span><span class="p">.</span><span class="n">head</span><span class="o">-&gt;</span><span class="n">is_dentry</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ihold</span><span class="p">(</span><span class="n">old_dentry</span><span class="o">-&gt;</span><span class="n">d_inode</span><span class="p">);</span>
		<span class="n">d_instantiate</span><span class="p">(</span><span class="n">dentry</span><span class="p">,</span> <span class="n">old_dentry</span><span class="o">-&gt;</span><span class="n">d_inode</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">ceph_mdsc_put_request</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * For a soon-to-be unlinked file, drop the AUTH_RDCACHE caps.  If it</span>
<span class="cm"> * looks like the link count will hit 0, drop any other caps (other</span>
<span class="cm"> * than PIN) we don&#39;t specifically want (due to the file still being</span>
<span class="cm"> * open).</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">drop_caps_for_unlink</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ceph_inode_info</span> <span class="o">*</span><span class="n">ci</span> <span class="o">=</span> <span class="n">ceph_inode</span><span class="p">(</span><span class="n">inode</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">drop</span> <span class="o">=</span> <span class="n">CEPH_CAP_LINK_SHARED</span> <span class="o">|</span> <span class="n">CEPH_CAP_LINK_EXCL</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ci</span><span class="o">-&gt;</span><span class="n">i_ceph_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_nlink</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">drop</span> <span class="o">|=</span> <span class="o">~</span><span class="p">(</span><span class="n">__ceph_caps_wanted</span><span class="p">(</span><span class="n">ci</span><span class="p">)</span> <span class="o">|</span> <span class="n">CEPH_CAP_PIN</span><span class="p">);</span>
		<span class="n">ci</span><span class="o">-&gt;</span><span class="n">i_ceph_flags</span> <span class="o">|=</span> <span class="n">CEPH_I_NODELAY</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ci</span><span class="o">-&gt;</span><span class="n">i_ceph_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">drop</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * rmdir and unlink are differ only by the metadata op code</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ceph_unlink</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">dir</span><span class="p">,</span> <span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="n">dentry</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ceph_fs_client</span> <span class="o">*</span><span class="n">fsc</span> <span class="o">=</span> <span class="n">ceph_sb_to_client</span><span class="p">(</span><span class="n">dir</span><span class="o">-&gt;</span><span class="n">i_sb</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ceph_mds_client</span> <span class="o">*</span><span class="n">mdsc</span> <span class="o">=</span> <span class="n">fsc</span><span class="o">-&gt;</span><span class="n">mdsc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span> <span class="o">=</span> <span class="n">dentry</span><span class="o">-&gt;</span><span class="n">d_inode</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ceph_mds_request</span> <span class="o">*</span><span class="n">req</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EROFS</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">op</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ceph_snap</span><span class="p">(</span><span class="n">dir</span><span class="p">)</span> <span class="o">==</span> <span class="n">CEPH_SNAPDIR</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* rmdir .snap/foo is RMSNAP */</span>
		<span class="n">dout</span><span class="p">(</span><span class="s">&quot;rmsnap dir %p &#39;%.*s&#39; dn %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dir</span><span class="p">,</span> <span class="n">dentry</span><span class="o">-&gt;</span><span class="n">d_name</span><span class="p">.</span><span class="n">len</span><span class="p">,</span>
		     <span class="n">dentry</span><span class="o">-&gt;</span><span class="n">d_name</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">dentry</span><span class="p">);</span>
		<span class="n">op</span> <span class="o">=</span> <span class="n">CEPH_MDS_OP_RMSNAP</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ceph_snap</span><span class="p">(</span><span class="n">dir</span><span class="p">)</span> <span class="o">==</span> <span class="n">CEPH_NOSNAP</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dout</span><span class="p">(</span><span class="s">&quot;unlink/rmdir dir %p dn %p inode %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		     <span class="n">dir</span><span class="p">,</span> <span class="n">dentry</span><span class="p">,</span> <span class="n">inode</span><span class="p">);</span>
		<span class="n">op</span> <span class="o">=</span> <span class="n">S_ISDIR</span><span class="p">(</span><span class="n">dentry</span><span class="o">-&gt;</span><span class="n">d_inode</span><span class="o">-&gt;</span><span class="n">i_mode</span><span class="p">)</span> <span class="o">?</span>
			<span class="n">CEPH_MDS_OP_RMDIR</span> <span class="o">:</span> <span class="n">CEPH_MDS_OP_UNLINK</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="n">req</span> <span class="o">=</span> <span class="n">ceph_mdsc_create_request</span><span class="p">(</span><span class="n">mdsc</span><span class="p">,</span> <span class="n">op</span><span class="p">,</span> <span class="n">USE_AUTH_MDS</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">req</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">r_dentry</span> <span class="o">=</span> <span class="n">dget</span><span class="p">(</span><span class="n">dentry</span><span class="p">);</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">r_num_caps</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">r_locked_dir</span> <span class="o">=</span> <span class="n">dir</span><span class="p">;</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">r_dentry_drop</span> <span class="o">=</span> <span class="n">CEPH_CAP_FILE_SHARED</span><span class="p">;</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">r_dentry_unless</span> <span class="o">=</span> <span class="n">CEPH_CAP_FILE_EXCL</span><span class="p">;</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">r_inode_drop</span> <span class="o">=</span> <span class="n">drop_caps_for_unlink</span><span class="p">(</span><span class="n">inode</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">ceph_mdsc_do_request</span><span class="p">(</span><span class="n">mdsc</span><span class="p">,</span> <span class="n">dir</span><span class="p">,</span> <span class="n">req</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">r_reply_info</span><span class="p">.</span><span class="n">head</span><span class="o">-&gt;</span><span class="n">is_dentry</span><span class="p">)</span>
		<span class="n">d_delete</span><span class="p">(</span><span class="n">dentry</span><span class="p">);</span>
	<span class="n">ceph_mdsc_put_request</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ceph_rename</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">old_dir</span><span class="p">,</span> <span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="n">old_dentry</span><span class="p">,</span>
		       <span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">new_dir</span><span class="p">,</span> <span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="n">new_dentry</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ceph_fs_client</span> <span class="o">*</span><span class="n">fsc</span> <span class="o">=</span> <span class="n">ceph_sb_to_client</span><span class="p">(</span><span class="n">old_dir</span><span class="o">-&gt;</span><span class="n">i_sb</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ceph_mds_client</span> <span class="o">*</span><span class="n">mdsc</span> <span class="o">=</span> <span class="n">fsc</span><span class="o">-&gt;</span><span class="n">mdsc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ceph_mds_request</span> <span class="o">*</span><span class="n">req</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ceph_snap</span><span class="p">(</span><span class="n">old_dir</span><span class="p">)</span> <span class="o">!=</span> <span class="n">ceph_snap</span><span class="p">(</span><span class="n">new_dir</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EXDEV</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ceph_snap</span><span class="p">(</span><span class="n">old_dir</span><span class="p">)</span> <span class="o">!=</span> <span class="n">CEPH_NOSNAP</span> <span class="o">||</span>
	    <span class="n">ceph_snap</span><span class="p">(</span><span class="n">new_dir</span><span class="p">)</span> <span class="o">!=</span> <span class="n">CEPH_NOSNAP</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EROFS</span><span class="p">;</span>
	<span class="n">dout</span><span class="p">(</span><span class="s">&quot;rename dir %p dentry %p to dir %p dentry %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	     <span class="n">old_dir</span><span class="p">,</span> <span class="n">old_dentry</span><span class="p">,</span> <span class="n">new_dir</span><span class="p">,</span> <span class="n">new_dentry</span><span class="p">);</span>
	<span class="n">req</span> <span class="o">=</span> <span class="n">ceph_mdsc_create_request</span><span class="p">(</span><span class="n">mdsc</span><span class="p">,</span> <span class="n">CEPH_MDS_OP_RENAME</span><span class="p">,</span> <span class="n">USE_AUTH_MDS</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">req</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">r_dentry</span> <span class="o">=</span> <span class="n">dget</span><span class="p">(</span><span class="n">new_dentry</span><span class="p">);</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">r_num_caps</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">r_old_dentry</span> <span class="o">=</span> <span class="n">dget</span><span class="p">(</span><span class="n">old_dentry</span><span class="p">);</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">r_old_dentry_dir</span> <span class="o">=</span> <span class="n">ceph_get_dentry_parent_inode</span><span class="p">(</span><span class="n">old_dentry</span><span class="p">);</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">r_locked_dir</span> <span class="o">=</span> <span class="n">new_dir</span><span class="p">;</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">r_old_dentry_drop</span> <span class="o">=</span> <span class="n">CEPH_CAP_FILE_SHARED</span><span class="p">;</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">r_old_dentry_unless</span> <span class="o">=</span> <span class="n">CEPH_CAP_FILE_EXCL</span><span class="p">;</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">r_dentry_drop</span> <span class="o">=</span> <span class="n">CEPH_CAP_FILE_SHARED</span><span class="p">;</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">r_dentry_unless</span> <span class="o">=</span> <span class="n">CEPH_CAP_FILE_EXCL</span><span class="p">;</span>
	<span class="cm">/* release LINK_RDCACHE on source inode (mds will lock it) */</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">r_old_inode_drop</span> <span class="o">=</span> <span class="n">CEPH_CAP_LINK_SHARED</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">new_dentry</span><span class="o">-&gt;</span><span class="n">d_inode</span><span class="p">)</span>
		<span class="n">req</span><span class="o">-&gt;</span><span class="n">r_inode_drop</span> <span class="o">=</span> <span class="n">drop_caps_for_unlink</span><span class="p">(</span><span class="n">new_dentry</span><span class="o">-&gt;</span><span class="n">d_inode</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">ceph_mdsc_do_request</span><span class="p">(</span><span class="n">mdsc</span><span class="p">,</span> <span class="n">old_dir</span><span class="p">,</span> <span class="n">req</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">r_reply_info</span><span class="p">.</span><span class="n">head</span><span class="o">-&gt;</span><span class="n">is_dentry</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Normally d_move() is done by fill_trace (called by</span>
<span class="cm">		 * do_request, above).  If there is no trace, we need</span>
<span class="cm">		 * to do it here.</span>
<span class="cm">		 */</span>

		<span class="cm">/* d_move screws up d_subdirs order */</span>
		<span class="n">ceph_dir_clear_complete</span><span class="p">(</span><span class="n">new_dir</span><span class="p">);</span>

		<span class="n">d_move</span><span class="p">(</span><span class="n">old_dentry</span><span class="p">,</span> <span class="n">new_dentry</span><span class="p">);</span>

		<span class="cm">/* ensure target dentry is invalidated, despite</span>
<span class="cm">		   rehashing bug in vfs_rename_dir */</span>
		<span class="n">ceph_invalidate_dentry_lease</span><span class="p">(</span><span class="n">new_dentry</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">ceph_mdsc_put_request</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Ensure a dentry lease will no longer revalidate.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">ceph_invalidate_dentry_lease</span><span class="p">(</span><span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="n">dentry</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dentry</span><span class="o">-&gt;</span><span class="n">d_lock</span><span class="p">);</span>
	<span class="n">dentry</span><span class="o">-&gt;</span><span class="n">d_time</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
	<span class="n">ceph_dentry</span><span class="p">(</span><span class="n">dentry</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">lease_shared_gen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dentry</span><span class="o">-&gt;</span><span class="n">d_lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Check if dentry lease is valid.  If not, delete the lease.  Try to</span>
<span class="cm"> * renew if the least is more than half up.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">dentry_lease_is_valid</span><span class="p">(</span><span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="n">dentry</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ceph_dentry_info</span> <span class="o">*</span><span class="n">di</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ceph_mds_session</span> <span class="o">*</span><span class="n">s</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">valid</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">gen</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">ttl</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ceph_mds_session</span> <span class="o">*</span><span class="n">session</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">dir</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">seq</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dentry</span><span class="o">-&gt;</span><span class="n">d_lock</span><span class="p">);</span>
	<span class="n">di</span> <span class="o">=</span> <span class="n">ceph_dentry</span><span class="p">(</span><span class="n">dentry</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">lease_session</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">s</span> <span class="o">=</span> <span class="n">di</span><span class="o">-&gt;</span><span class="n">lease_session</span><span class="p">;</span>
		<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">s_gen_ttl_lock</span><span class="p">);</span>
		<span class="n">gen</span> <span class="o">=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">s_cap_gen</span><span class="p">;</span>
		<span class="n">ttl</span> <span class="o">=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">s_cap_ttl</span><span class="p">;</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">s_gen_ttl_lock</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">lease_gen</span> <span class="o">==</span> <span class="n">gen</span> <span class="o">&amp;&amp;</span>
		    <span class="n">time_before</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">dentry</span><span class="o">-&gt;</span><span class="n">d_time</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="n">time_before</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">ttl</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">valid</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">lease_renew_after</span> <span class="o">&amp;&amp;</span>
			    <span class="n">time_after</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">di</span><span class="o">-&gt;</span><span class="n">lease_renew_after</span><span class="p">))</span> <span class="p">{</span>
				<span class="cm">/* we should renew */</span>
				<span class="n">dir</span> <span class="o">=</span> <span class="n">dentry</span><span class="o">-&gt;</span><span class="n">d_parent</span><span class="o">-&gt;</span><span class="n">d_inode</span><span class="p">;</span>
				<span class="n">session</span> <span class="o">=</span> <span class="n">ceph_get_mds_session</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
				<span class="n">seq</span> <span class="o">=</span> <span class="n">di</span><span class="o">-&gt;</span><span class="n">lease_seq</span><span class="p">;</span>
				<span class="n">di</span><span class="o">-&gt;</span><span class="n">lease_renew_after</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">di</span><span class="o">-&gt;</span><span class="n">lease_renew_from</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dentry</span><span class="o">-&gt;</span><span class="n">d_lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">session</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ceph_mdsc_lease_send_msg</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">dir</span><span class="p">,</span> <span class="n">dentry</span><span class="p">,</span>
					 <span class="n">CEPH_MDS_LEASE_RENEW</span><span class="p">,</span> <span class="n">seq</span><span class="p">);</span>
		<span class="n">ceph_put_mds_session</span><span class="p">(</span><span class="n">session</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">dout</span><span class="p">(</span><span class="s">&quot;dentry_lease_is_valid - dentry %p = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dentry</span><span class="p">,</span> <span class="n">valid</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">valid</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Check if directory-wide content lease/cap is valid.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">dir_lease_is_valid</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">dir</span><span class="p">,</span> <span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="n">dentry</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ceph_inode_info</span> <span class="o">*</span><span class="n">ci</span> <span class="o">=</span> <span class="n">ceph_inode</span><span class="p">(</span><span class="n">dir</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ceph_dentry_info</span> <span class="o">*</span><span class="n">di</span> <span class="o">=</span> <span class="n">ceph_dentry</span><span class="p">(</span><span class="n">dentry</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">valid</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ci</span><span class="o">-&gt;</span><span class="n">i_ceph_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ci</span><span class="o">-&gt;</span><span class="n">i_shared_gen</span> <span class="o">==</span> <span class="n">di</span><span class="o">-&gt;</span><span class="n">lease_shared_gen</span><span class="p">)</span>
		<span class="n">valid</span> <span class="o">=</span> <span class="n">__ceph_caps_issued_mask</span><span class="p">(</span><span class="n">ci</span><span class="p">,</span> <span class="n">CEPH_CAP_FILE_SHARED</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ci</span><span class="o">-&gt;</span><span class="n">i_ceph_lock</span><span class="p">);</span>
	<span class="n">dout</span><span class="p">(</span><span class="s">&quot;dir_lease_is_valid dir %p v%u dentry %p v%u = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	     <span class="n">dir</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span><span class="p">)</span><span class="n">ci</span><span class="o">-&gt;</span><span class="n">i_shared_gen</span><span class="p">,</span> <span class="n">dentry</span><span class="p">,</span>
	     <span class="p">(</span><span class="kt">unsigned</span><span class="p">)</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">lease_shared_gen</span><span class="p">,</span> <span class="n">valid</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">valid</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Check if cached dentry can be trusted.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ceph_d_revalidate</span><span class="p">(</span><span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="n">dentry</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nameidata</span> <span class="o">*</span><span class="n">nd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">valid</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">dir</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nd</span> <span class="o">&amp;&amp;</span> <span class="n">nd</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">LOOKUP_RCU</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ECHILD</span><span class="p">;</span>

	<span class="n">dout</span><span class="p">(</span><span class="s">&quot;d_revalidate %p &#39;%.*s&#39; inode %p offset %lld</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dentry</span><span class="p">,</span>
	     <span class="n">dentry</span><span class="o">-&gt;</span><span class="n">d_name</span><span class="p">.</span><span class="n">len</span><span class="p">,</span> <span class="n">dentry</span><span class="o">-&gt;</span><span class="n">d_name</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">dentry</span><span class="o">-&gt;</span><span class="n">d_inode</span><span class="p">,</span>
	     <span class="n">ceph_dentry</span><span class="p">(</span><span class="n">dentry</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">);</span>

	<span class="n">dir</span> <span class="o">=</span> <span class="n">ceph_get_dentry_parent_inode</span><span class="p">(</span><span class="n">dentry</span><span class="p">);</span>

	<span class="cm">/* always trust cached snapped dentries, snapdir dentry */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ceph_snap</span><span class="p">(</span><span class="n">dir</span><span class="p">)</span> <span class="o">!=</span> <span class="n">CEPH_NOSNAP</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dout</span><span class="p">(</span><span class="s">&quot;d_revalidate %p &#39;%.*s&#39; inode %p is SNAPPED</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dentry</span><span class="p">,</span>
		     <span class="n">dentry</span><span class="o">-&gt;</span><span class="n">d_name</span><span class="p">.</span><span class="n">len</span><span class="p">,</span> <span class="n">dentry</span><span class="o">-&gt;</span><span class="n">d_name</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">dentry</span><span class="o">-&gt;</span><span class="n">d_inode</span><span class="p">);</span>
		<span class="n">valid</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">dentry</span><span class="o">-&gt;</span><span class="n">d_inode</span> <span class="o">&amp;&amp;</span>
		   <span class="n">ceph_snap</span><span class="p">(</span><span class="n">dentry</span><span class="o">-&gt;</span><span class="n">d_inode</span><span class="p">)</span> <span class="o">==</span> <span class="n">CEPH_SNAPDIR</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">valid</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">dentry_lease_is_valid</span><span class="p">(</span><span class="n">dentry</span><span class="p">)</span> <span class="o">||</span>
		   <span class="n">dir_lease_is_valid</span><span class="p">(</span><span class="n">dir</span><span class="p">,</span> <span class="n">dentry</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">valid</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dout</span><span class="p">(</span><span class="s">&quot;d_revalidate %p %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dentry</span><span class="p">,</span> <span class="n">valid</span> <span class="o">?</span> <span class="s">&quot;valid&quot;</span> <span class="o">:</span> <span class="s">&quot;invalid&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">valid</span><span class="p">)</span>
		<span class="n">ceph_dentry_lru_touch</span><span class="p">(</span><span class="n">dentry</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">d_drop</span><span class="p">(</span><span class="n">dentry</span><span class="p">);</span>
	<span class="n">iput</span><span class="p">(</span><span class="n">dir</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">valid</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Release our ceph_dentry_info.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ceph_d_release</span><span class="p">(</span><span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="n">dentry</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ceph_dentry_info</span> <span class="o">*</span><span class="n">di</span> <span class="o">=</span> <span class="n">ceph_dentry</span><span class="p">(</span><span class="n">dentry</span><span class="p">);</span>

	<span class="n">dout</span><span class="p">(</span><span class="s">&quot;d_release %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dentry</span><span class="p">);</span>
	<span class="n">ceph_dentry_lru_del</span><span class="p">(</span><span class="n">dentry</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">lease_session</span><span class="p">)</span>
		<span class="n">ceph_put_mds_session</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">lease_session</span><span class="p">);</span>
	<span class="n">kmem_cache_free</span><span class="p">(</span><span class="n">ceph_dentry_cachep</span><span class="p">,</span> <span class="n">di</span><span class="p">);</span>
	<span class="n">dentry</span><span class="o">-&gt;</span><span class="n">d_fsdata</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ceph_snapdir_d_revalidate</span><span class="p">(</span><span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="n">dentry</span><span class="p">,</span>
					  <span class="k">struct</span> <span class="n">nameidata</span> <span class="o">*</span><span class="n">nd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/*</span>
<span class="cm">	 * Eventually, we&#39;ll want to revalidate snapped metadata</span>
<span class="cm">	 * too... probably...</span>
<span class="cm">	 */</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Set/clear/test dir complete flag on the dir&#39;s dentry.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">ceph_dir_set_complete</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="n">dentry</span> <span class="o">=</span> <span class="n">d_find_any_alias</span><span class="p">(</span><span class="n">inode</span><span class="p">);</span>
	
	<span class="k">if</span> <span class="p">(</span><span class="n">dentry</span> <span class="o">&amp;&amp;</span> <span class="n">ceph_dentry</span><span class="p">(</span><span class="n">dentry</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">ceph_test_mount_opt</span><span class="p">(</span><span class="n">ceph_sb_to_client</span><span class="p">(</span><span class="n">dentry</span><span class="o">-&gt;</span><span class="n">d_sb</span><span class="p">),</span> <span class="n">DCACHE</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dout</span><span class="p">(</span><span class="s">&quot; marking %p (%p) complete</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">inode</span><span class="p">,</span> <span class="n">dentry</span><span class="p">);</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">CEPH_D_COMPLETE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ceph_dentry</span><span class="p">(</span><span class="n">dentry</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">dput</span><span class="p">(</span><span class="n">dentry</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">ceph_dir_clear_complete</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="n">dentry</span> <span class="o">=</span> <span class="n">d_find_any_alias</span><span class="p">(</span><span class="n">inode</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dentry</span> <span class="o">&amp;&amp;</span> <span class="n">ceph_dentry</span><span class="p">(</span><span class="n">dentry</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dout</span><span class="p">(</span><span class="s">&quot; marking %p (%p) complete</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">inode</span><span class="p">,</span> <span class="n">dentry</span><span class="p">);</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">CEPH_D_COMPLETE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ceph_dentry</span><span class="p">(</span><span class="n">dentry</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">dput</span><span class="p">(</span><span class="n">dentry</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">bool</span> <span class="nf">ceph_dir_test_complete</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="n">dentry</span> <span class="o">=</span> <span class="n">d_find_any_alias</span><span class="p">(</span><span class="n">inode</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dentry</span> <span class="o">&amp;&amp;</span> <span class="n">ceph_dentry</span><span class="p">(</span><span class="n">dentry</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dout</span><span class="p">(</span><span class="s">&quot; marking %p (%p) NOT complete</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">inode</span><span class="p">,</span> <span class="n">dentry</span><span class="p">);</span>
		<span class="n">clear_bit</span><span class="p">(</span><span class="n">CEPH_D_COMPLETE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ceph_dentry</span><span class="p">(</span><span class="n">dentry</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">dput</span><span class="p">(</span><span class="n">dentry</span><span class="p">);</span>
	<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * When the VFS prunes a dentry from the cache, we need to clear the</span>
<span class="cm"> * complete flag on the parent directory.</span>
<span class="cm"> *</span>
<span class="cm"> * Called under dentry-&gt;d_lock.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ceph_d_prune</span><span class="p">(</span><span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="n">dentry</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ceph_dentry_info</span> <span class="o">*</span><span class="n">di</span><span class="p">;</span>

	<span class="n">dout</span><span class="p">(</span><span class="s">&quot;ceph_d_prune %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dentry</span><span class="p">);</span>

	<span class="cm">/* do we have a valid parent? */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dentry</span><span class="o">-&gt;</span><span class="n">d_parent</span> <span class="o">||</span> <span class="n">IS_ROOT</span><span class="p">(</span><span class="n">dentry</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* if we are not hashed, we don&#39;t affect D_COMPLETE */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">d_unhashed</span><span class="p">(</span><span class="n">dentry</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * we hold d_lock, so d_parent is stable, and d_fsdata is never</span>
<span class="cm">	 * cleared until d_release</span>
<span class="cm">	 */</span>
	<span class="n">di</span> <span class="o">=</span> <span class="n">ceph_dentry</span><span class="p">(</span><span class="n">dentry</span><span class="o">-&gt;</span><span class="n">d_parent</span><span class="p">);</span>
	<span class="n">clear_bit</span><span class="p">(</span><span class="n">CEPH_D_COMPLETE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * read() on a dir.  This weird interface hack only works if mounted</span>
<span class="cm"> * with &#39;-o dirstat&#39;.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">ceph_read_dir</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">size</span><span class="p">,</span>
			     <span class="n">loff_t</span> <span class="o">*</span><span class="n">ppos</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ceph_file_info</span> <span class="o">*</span><span class="n">cf</span> <span class="o">=</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span> <span class="o">=</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">f_dentry</span><span class="o">-&gt;</span><span class="n">d_inode</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ceph_inode_info</span> <span class="o">*</span><span class="n">ci</span> <span class="o">=</span> <span class="n">ceph_inode</span><span class="p">(</span><span class="n">inode</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">left</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">int</span> <span class="n">bufsize</span> <span class="o">=</span> <span class="mi">1024</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ceph_test_mount_opt</span><span class="p">(</span><span class="n">ceph_sb_to_client</span><span class="p">(</span><span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_sb</span><span class="p">),</span> <span class="n">DIRSTAT</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EISDIR</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cf</span><span class="o">-&gt;</span><span class="n">dir_info</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cf</span><span class="o">-&gt;</span><span class="n">dir_info</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">bufsize</span><span class="p">,</span> <span class="n">GFP_NOFS</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cf</span><span class="o">-&gt;</span><span class="n">dir_info</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="n">cf</span><span class="o">-&gt;</span><span class="n">dir_info_len</span> <span class="o">=</span>
			<span class="n">snprintf</span><span class="p">(</span><span class="n">cf</span><span class="o">-&gt;</span><span class="n">dir_info</span><span class="p">,</span> <span class="n">bufsize</span><span class="p">,</span>
				<span class="s">&quot;entries:   %20lld</span><span class="se">\n</span><span class="s">&quot;</span>
				<span class="s">&quot; files:    %20lld</span><span class="se">\n</span><span class="s">&quot;</span>
				<span class="s">&quot; subdirs:  %20lld</span><span class="se">\n</span><span class="s">&quot;</span>
				<span class="s">&quot;rentries:  %20lld</span><span class="se">\n</span><span class="s">&quot;</span>
				<span class="s">&quot; rfiles:   %20lld</span><span class="se">\n</span><span class="s">&quot;</span>
				<span class="s">&quot; rsubdirs: %20lld</span><span class="se">\n</span><span class="s">&quot;</span>
				<span class="s">&quot;rbytes:    %20lld</span><span class="se">\n</span><span class="s">&quot;</span>
				<span class="s">&quot;rctime:    %10ld.%09ld</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">ci</span><span class="o">-&gt;</span><span class="n">i_files</span> <span class="o">+</span> <span class="n">ci</span><span class="o">-&gt;</span><span class="n">i_subdirs</span><span class="p">,</span>
				<span class="n">ci</span><span class="o">-&gt;</span><span class="n">i_files</span><span class="p">,</span>
				<span class="n">ci</span><span class="o">-&gt;</span><span class="n">i_subdirs</span><span class="p">,</span>
				<span class="n">ci</span><span class="o">-&gt;</span><span class="n">i_rfiles</span> <span class="o">+</span> <span class="n">ci</span><span class="o">-&gt;</span><span class="n">i_rsubdirs</span><span class="p">,</span>
				<span class="n">ci</span><span class="o">-&gt;</span><span class="n">i_rfiles</span><span class="p">,</span>
				<span class="n">ci</span><span class="o">-&gt;</span><span class="n">i_rsubdirs</span><span class="p">,</span>
				<span class="n">ci</span><span class="o">-&gt;</span><span class="n">i_rbytes</span><span class="p">,</span>
				<span class="p">(</span><span class="kt">long</span><span class="p">)</span><span class="n">ci</span><span class="o">-&gt;</span><span class="n">i_rctime</span><span class="p">.</span><span class="n">tv_sec</span><span class="p">,</span>
				<span class="p">(</span><span class="kt">long</span><span class="p">)</span><span class="n">ci</span><span class="o">-&gt;</span><span class="n">i_rctime</span><span class="p">.</span><span class="n">tv_nsec</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">ppos</span> <span class="o">&gt;=</span> <span class="n">cf</span><span class="o">-&gt;</span><span class="n">dir_info_len</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">size</span> <span class="o">=</span> <span class="n">min_t</span><span class="p">(</span><span class="kt">unsigned</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">cf</span><span class="o">-&gt;</span><span class="n">dir_info_len</span><span class="o">-*</span><span class="n">ppos</span><span class="p">);</span>
	<span class="n">left</span> <span class="o">=</span> <span class="n">copy_to_user</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">cf</span><span class="o">-&gt;</span><span class="n">dir_info</span> <span class="o">+</span> <span class="o">*</span><span class="n">ppos</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">left</span> <span class="o">==</span> <span class="n">size</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="o">*</span><span class="n">ppos</span> <span class="o">+=</span> <span class="p">(</span><span class="n">size</span> <span class="o">-</span> <span class="n">left</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">size</span> <span class="o">-</span> <span class="n">left</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * an fsync() on a dir will wait for any uncommitted directory</span>
<span class="cm"> * operations to commit.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ceph_dir_fsync</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="n">loff_t</span> <span class="n">start</span><span class="p">,</span> <span class="n">loff_t</span> <span class="n">end</span><span class="p">,</span>
			  <span class="kt">int</span> <span class="n">datasync</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span> <span class="o">=</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">f_path</span><span class="p">.</span><span class="n">dentry</span><span class="o">-&gt;</span><span class="n">d_inode</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ceph_inode_info</span> <span class="o">*</span><span class="n">ci</span> <span class="o">=</span> <span class="n">ceph_inode</span><span class="p">(</span><span class="n">inode</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">head</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ci</span><span class="o">-&gt;</span><span class="n">i_unsafe_dirops</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ceph_mds_request</span> <span class="o">*</span><span class="n">req</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">last_tid</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">dout</span><span class="p">(</span><span class="s">&quot;dir_fsync %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">inode</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">filemap_write_and_wait_range</span><span class="p">(</span><span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_mapping</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_mutex</span><span class="p">);</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ci</span><span class="o">-&gt;</span><span class="n">i_unsafe_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="n">head</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">req</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">head</span><span class="o">-&gt;</span><span class="n">prev</span><span class="p">,</span>
			 <span class="k">struct</span> <span class="n">ceph_mds_request</span><span class="p">,</span> <span class="n">r_unsafe_dir_item</span><span class="p">);</span>
	<span class="n">last_tid</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">r_tid</span><span class="p">;</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="n">ceph_mdsc_get_request</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ci</span><span class="o">-&gt;</span><span class="n">i_unsafe_lock</span><span class="p">);</span>

		<span class="n">dout</span><span class="p">(</span><span class="s">&quot;dir_fsync %p wait on tid %llu (until %llu)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		     <span class="n">inode</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">r_tid</span><span class="p">,</span> <span class="n">last_tid</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">r_timeout</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">wait_for_completion_timeout</span><span class="p">(</span>
				<span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">r_safe_completion</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">r_timeout</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>  <span class="cm">/* timed out */</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">wait_for_completion</span><span class="p">(</span><span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">r_safe_completion</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">ceph_mdsc_put_request</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>

		<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ci</span><span class="o">-&gt;</span><span class="n">i_unsafe_lock</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">||</span> <span class="n">list_empty</span><span class="p">(</span><span class="n">head</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">req</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">head</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">ceph_mds_request</span><span class="p">,</span> <span class="n">r_unsafe_dir_item</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">r_tid</span> <span class="o">&lt;</span> <span class="n">last_tid</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ci</span><span class="o">-&gt;</span><span class="n">i_unsafe_lock</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_mutex</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * We maintain a private dentry LRU.</span>
<span class="cm"> *</span>
<span class="cm"> * FIXME: this needs to be changed to a per-mds lru to be useful.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">ceph_dentry_lru_add</span><span class="p">(</span><span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="n">dn</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ceph_dentry_info</span> <span class="o">*</span><span class="n">di</span> <span class="o">=</span> <span class="n">ceph_dentry</span><span class="p">(</span><span class="n">dn</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ceph_mds_client</span> <span class="o">*</span><span class="n">mdsc</span><span class="p">;</span>

	<span class="n">dout</span><span class="p">(</span><span class="s">&quot;dentry_lru_add %p %p &#39;%.*s&#39;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">di</span><span class="p">,</span> <span class="n">dn</span><span class="p">,</span>
	     <span class="n">dn</span><span class="o">-&gt;</span><span class="n">d_name</span><span class="p">.</span><span class="n">len</span><span class="p">,</span> <span class="n">dn</span><span class="o">-&gt;</span><span class="n">d_name</span><span class="p">.</span><span class="n">name</span><span class="p">);</span>
	<span class="n">mdsc</span> <span class="o">=</span> <span class="n">ceph_sb_to_client</span><span class="p">(</span><span class="n">dn</span><span class="o">-&gt;</span><span class="n">d_sb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">mdsc</span><span class="p">;</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdsc</span><span class="o">-&gt;</span><span class="n">dentry_lru_lock</span><span class="p">);</span>
	<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">lru</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mdsc</span><span class="o">-&gt;</span><span class="n">dentry_lru</span><span class="p">);</span>
	<span class="n">mdsc</span><span class="o">-&gt;</span><span class="n">num_dentry</span><span class="o">++</span><span class="p">;</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdsc</span><span class="o">-&gt;</span><span class="n">dentry_lru_lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">ceph_dentry_lru_touch</span><span class="p">(</span><span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="n">dn</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ceph_dentry_info</span> <span class="o">*</span><span class="n">di</span> <span class="o">=</span> <span class="n">ceph_dentry</span><span class="p">(</span><span class="n">dn</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ceph_mds_client</span> <span class="o">*</span><span class="n">mdsc</span><span class="p">;</span>

	<span class="n">dout</span><span class="p">(</span><span class="s">&quot;dentry_lru_touch %p %p &#39;%.*s&#39; (offset %lld)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">di</span><span class="p">,</span> <span class="n">dn</span><span class="p">,</span>
	     <span class="n">dn</span><span class="o">-&gt;</span><span class="n">d_name</span><span class="p">.</span><span class="n">len</span><span class="p">,</span> <span class="n">dn</span><span class="o">-&gt;</span><span class="n">d_name</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">di</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">);</span>
	<span class="n">mdsc</span> <span class="o">=</span> <span class="n">ceph_sb_to_client</span><span class="p">(</span><span class="n">dn</span><span class="o">-&gt;</span><span class="n">d_sb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">mdsc</span><span class="p">;</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdsc</span><span class="o">-&gt;</span><span class="n">dentry_lru_lock</span><span class="p">);</span>
	<span class="n">list_move_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">lru</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mdsc</span><span class="o">-&gt;</span><span class="n">dentry_lru</span><span class="p">);</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdsc</span><span class="o">-&gt;</span><span class="n">dentry_lru_lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">ceph_dentry_lru_del</span><span class="p">(</span><span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="n">dn</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ceph_dentry_info</span> <span class="o">*</span><span class="n">di</span> <span class="o">=</span> <span class="n">ceph_dentry</span><span class="p">(</span><span class="n">dn</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ceph_mds_client</span> <span class="o">*</span><span class="n">mdsc</span><span class="p">;</span>

	<span class="n">dout</span><span class="p">(</span><span class="s">&quot;dentry_lru_del %p %p &#39;%.*s&#39;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">di</span><span class="p">,</span> <span class="n">dn</span><span class="p">,</span>
	     <span class="n">dn</span><span class="o">-&gt;</span><span class="n">d_name</span><span class="p">.</span><span class="n">len</span><span class="p">,</span> <span class="n">dn</span><span class="o">-&gt;</span><span class="n">d_name</span><span class="p">.</span><span class="n">name</span><span class="p">);</span>
	<span class="n">mdsc</span> <span class="o">=</span> <span class="n">ceph_sb_to_client</span><span class="p">(</span><span class="n">dn</span><span class="o">-&gt;</span><span class="n">d_sb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">mdsc</span><span class="p">;</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdsc</span><span class="o">-&gt;</span><span class="n">dentry_lru_lock</span><span class="p">);</span>
	<span class="n">list_del_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">lru</span><span class="p">);</span>
	<span class="n">mdsc</span><span class="o">-&gt;</span><span class="n">num_dentry</span><span class="o">--</span><span class="p">;</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdsc</span><span class="o">-&gt;</span><span class="n">dentry_lru_lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Return name hash for a given dentry.  This is dependent on</span>
<span class="cm"> * the parent directory&#39;s hash function.</span>
<span class="cm"> */</span>
<span class="kt">unsigned</span> <span class="nf">ceph_dentry_hash</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">dir</span><span class="p">,</span> <span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="n">dn</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ceph_inode_info</span> <span class="o">*</span><span class="n">dci</span> <span class="o">=</span> <span class="n">ceph_inode</span><span class="p">(</span><span class="n">dir</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">dci</span><span class="o">-&gt;</span><span class="n">i_dir_layout</span><span class="p">.</span><span class="n">dl_dir_hash</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>:	<span class="cm">/* for backward compat */</span>
	<span class="k">case</span> <span class="n">CEPH_STR_HASH_LINUX</span>:
		<span class="k">return</span> <span class="n">dn</span><span class="o">-&gt;</span><span class="n">d_name</span><span class="p">.</span><span class="n">hash</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="k">return</span> <span class="n">ceph_str_hash</span><span class="p">(</span><span class="n">dci</span><span class="o">-&gt;</span><span class="n">i_dir_layout</span><span class="p">.</span><span class="n">dl_dir_hash</span><span class="p">,</span>
				     <span class="n">dn</span><span class="o">-&gt;</span><span class="n">d_name</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">dn</span><span class="o">-&gt;</span><span class="n">d_name</span><span class="p">.</span><span class="n">len</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">const</span> <span class="k">struct</span> <span class="n">file_operations</span> <span class="n">ceph_dir_fops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">read</span> <span class="o">=</span> <span class="n">ceph_read_dir</span><span class="p">,</span>
	<span class="p">.</span><span class="n">readdir</span> <span class="o">=</span> <span class="n">ceph_readdir</span><span class="p">,</span>
	<span class="p">.</span><span class="n">llseek</span> <span class="o">=</span> <span class="n">ceph_dir_llseek</span><span class="p">,</span>
	<span class="p">.</span><span class="n">open</span> <span class="o">=</span> <span class="n">ceph_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">release</span> <span class="o">=</span> <span class="n">ceph_release</span><span class="p">,</span>
	<span class="p">.</span><span class="n">unlocked_ioctl</span> <span class="o">=</span> <span class="n">ceph_ioctl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fsync</span> <span class="o">=</span> <span class="n">ceph_dir_fsync</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">const</span> <span class="k">struct</span> <span class="n">inode_operations</span> <span class="n">ceph_dir_iops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">lookup</span> <span class="o">=</span> <span class="n">ceph_lookup</span><span class="p">,</span>
	<span class="p">.</span><span class="n">permission</span> <span class="o">=</span> <span class="n">ceph_permission</span><span class="p">,</span>
	<span class="p">.</span><span class="n">getattr</span> <span class="o">=</span> <span class="n">ceph_getattr</span><span class="p">,</span>
	<span class="p">.</span><span class="n">setattr</span> <span class="o">=</span> <span class="n">ceph_setattr</span><span class="p">,</span>
	<span class="p">.</span><span class="n">setxattr</span> <span class="o">=</span> <span class="n">ceph_setxattr</span><span class="p">,</span>
	<span class="p">.</span><span class="n">getxattr</span> <span class="o">=</span> <span class="n">ceph_getxattr</span><span class="p">,</span>
	<span class="p">.</span><span class="n">listxattr</span> <span class="o">=</span> <span class="n">ceph_listxattr</span><span class="p">,</span>
	<span class="p">.</span><span class="n">removexattr</span> <span class="o">=</span> <span class="n">ceph_removexattr</span><span class="p">,</span>
	<span class="p">.</span><span class="n">mknod</span> <span class="o">=</span> <span class="n">ceph_mknod</span><span class="p">,</span>
	<span class="p">.</span><span class="n">symlink</span> <span class="o">=</span> <span class="n">ceph_symlink</span><span class="p">,</span>
	<span class="p">.</span><span class="n">mkdir</span> <span class="o">=</span> <span class="n">ceph_mkdir</span><span class="p">,</span>
	<span class="p">.</span><span class="n">link</span> <span class="o">=</span> <span class="n">ceph_link</span><span class="p">,</span>
	<span class="p">.</span><span class="n">unlink</span> <span class="o">=</span> <span class="n">ceph_unlink</span><span class="p">,</span>
	<span class="p">.</span><span class="n">rmdir</span> <span class="o">=</span> <span class="n">ceph_unlink</span><span class="p">,</span>
	<span class="p">.</span><span class="n">rename</span> <span class="o">=</span> <span class="n">ceph_rename</span><span class="p">,</span>
	<span class="p">.</span><span class="n">create</span> <span class="o">=</span> <span class="n">ceph_create</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">const</span> <span class="k">struct</span> <span class="n">dentry_operations</span> <span class="n">ceph_dentry_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">d_revalidate</span> <span class="o">=</span> <span class="n">ceph_d_revalidate</span><span class="p">,</span>
	<span class="p">.</span><span class="n">d_release</span> <span class="o">=</span> <span class="n">ceph_d_release</span><span class="p">,</span>
	<span class="p">.</span><span class="n">d_prune</span> <span class="o">=</span> <span class="n">ceph_d_prune</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">const</span> <span class="k">struct</span> <span class="n">dentry_operations</span> <span class="n">ceph_snapdir_dentry_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">d_revalidate</span> <span class="o">=</span> <span class="n">ceph_snapdir_d_revalidate</span><span class="p">,</span>
	<span class="p">.</span><span class="n">d_release</span> <span class="o">=</span> <span class="n">ceph_d_release</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">const</span> <span class="k">struct</span> <span class="n">dentry_operations</span> <span class="n">ceph_snap_dentry_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">d_release</span> <span class="o">=</span> <span class="n">ceph_d_release</span><span class="p">,</span>
	<span class="p">.</span><span class="n">d_prune</span> <span class="o">=</span> <span class="n">ceph_d_prune</span><span class="p">,</span>
<span class="p">};</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
