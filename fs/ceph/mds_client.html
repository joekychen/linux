<!DOCTYPE html>
<html><head><title>joekychen/linux » fs › ceph › mds_client.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>mds_client.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cp">#include &lt;linux/ceph/ceph_debug.h&gt;</span>

<span class="cp">#include &lt;linux/fs.h&gt;</span>
<span class="cp">#include &lt;linux/wait.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/sched.h&gt;</span>
<span class="cp">#include &lt;linux/debugfs.h&gt;</span>
<span class="cp">#include &lt;linux/seq_file.h&gt;</span>

<span class="cp">#include &quot;super.h&quot;</span>
<span class="cp">#include &quot;mds_client.h&quot;</span>

<span class="cp">#include &lt;linux/ceph/messenger.h&gt;</span>
<span class="cp">#include &lt;linux/ceph/decode.h&gt;</span>
<span class="cp">#include &lt;linux/ceph/pagelist.h&gt;</span>
<span class="cp">#include &lt;linux/ceph/auth.h&gt;</span>
<span class="cp">#include &lt;linux/ceph/debugfs.h&gt;</span>

<span class="cm">/*</span>
<span class="cm"> * A cluster of MDS (metadata server) daemons is responsible for</span>
<span class="cm"> * managing the file system namespace (the directory hierarchy and</span>
<span class="cm"> * inodes) and for coordinating shared access to storage.  Metadata is</span>
<span class="cm"> * partitioning hierarchically across a number of servers, and that</span>
<span class="cm"> * partition varies over time as the cluster adjusts the distribution</span>
<span class="cm"> * in order to balance load.</span>
<span class="cm"> *</span>
<span class="cm"> * The MDS client is primarily responsible to managing synchronous</span>
<span class="cm"> * metadata requests for operations like open, unlink, and so forth.</span>
<span class="cm"> * If there is a MDS failure, we find out about it when we (possibly</span>
<span class="cm"> * request and) receive a new MDS map, and can resubmit affected</span>
<span class="cm"> * requests.</span>
<span class="cm"> *</span>
<span class="cm"> * For the most part, though, we take advantage of a lossless</span>
<span class="cm"> * communications channel to the MDS, and do not need to worry about</span>
<span class="cm"> * timing out or resubmitting requests.</span>
<span class="cm"> *</span>
<span class="cm"> * We maintain a stateful &quot;session&quot; with each MDS we interact with.</span>
<span class="cm"> * Within each session, we sent periodic heartbeat messages to ensure</span>
<span class="cm"> * any capabilities or leases we have been issues remain valid.  If</span>
<span class="cm"> * the session times out and goes stale, our leases and capabilities</span>
<span class="cm"> * are no longer valid.</span>
<span class="cm"> */</span>

<span class="k">struct</span> <span class="n">ceph_reconnect_state</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">ceph_pagelist</span> <span class="o">*</span><span class="n">pagelist</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">flock</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__wake_requests</span><span class="p">(</span><span class="k">struct</span> <span class="n">ceph_mds_client</span> <span class="o">*</span><span class="n">mdsc</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">head</span><span class="p">);</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">ceph_connection_operations</span> <span class="n">mds_con_ops</span><span class="p">;</span>


<span class="cm">/*</span>
<span class="cm"> * mds reply parsing</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> * parse individual inode info</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">parse_reply_info_in</span><span class="p">(</span><span class="kt">void</span> <span class="o">**</span><span class="n">p</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">end</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">ceph_mds_reply_info_in</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
			       <span class="kt">int</span> <span class="n">features</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="n">info</span><span class="o">-&gt;</span><span class="n">in</span> <span class="o">=</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
	<span class="o">*</span><span class="n">p</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ceph_mds_reply_inode</span><span class="p">)</span> <span class="o">+</span>
		<span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">in</span><span class="o">-&gt;</span><span class="n">fragtree</span><span class="p">.</span><span class="n">splits</span><span class="p">)</span> <span class="o">*</span>
		<span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">in</span><span class="o">-&gt;</span><span class="n">fragtree</span><span class="p">.</span><span class="n">nsplits</span><span class="p">);</span>

	<span class="n">ceph_decode_32_safe</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">symlink_len</span><span class="p">,</span> <span class="n">bad</span><span class="p">);</span>
	<span class="n">ceph_decode_need</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">symlink_len</span><span class="p">,</span> <span class="n">bad</span><span class="p">);</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">symlink</span> <span class="o">=</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
	<span class="o">*</span><span class="n">p</span> <span class="o">+=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">symlink_len</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">features</span> <span class="o">&amp;</span> <span class="n">CEPH_FEATURE_DIRLAYOUTHASH</span><span class="p">)</span>
		<span class="n">ceph_decode_copy_safe</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">dir_layout</span><span class="p">,</span>
				      <span class="k">sizeof</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">dir_layout</span><span class="p">),</span> <span class="n">bad</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">dir_layout</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">dir_layout</span><span class="p">));</span>

	<span class="n">ceph_decode_32_safe</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">xattr_len</span><span class="p">,</span> <span class="n">bad</span><span class="p">);</span>
	<span class="n">ceph_decode_need</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">xattr_len</span><span class="p">,</span> <span class="n">bad</span><span class="p">);</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">xattr_data</span> <span class="o">=</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
	<span class="o">*</span><span class="n">p</span> <span class="o">+=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">xattr_len</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">bad:</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * parse a normal reply, which may contain a (dir+)dentry and/or a</span>
<span class="cm"> * target inode.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">parse_reply_info_trace</span><span class="p">(</span><span class="kt">void</span> <span class="o">**</span><span class="n">p</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">end</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">ceph_mds_reply_info_parsed</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
				  <span class="kt">int</span> <span class="n">features</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">head</span><span class="o">-&gt;</span><span class="n">is_dentry</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">parse_reply_info_in</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">diri</span><span class="p">,</span> <span class="n">features</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out_bad</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">*</span><span class="n">p</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">dirfrag</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">end</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">bad</span><span class="p">;</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">dirfrag</span> <span class="o">=</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
		<span class="o">*</span><span class="n">p</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">dirfrag</span><span class="p">)</span> <span class="o">+</span>
			<span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="o">*</span><span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">dirfrag</span><span class="o">-&gt;</span><span class="n">ndist</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">*</span><span class="n">p</span> <span class="o">&gt;</span> <span class="n">end</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">bad</span><span class="p">;</span>

		<span class="n">ceph_decode_32_safe</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">dname_len</span><span class="p">,</span> <span class="n">bad</span><span class="p">);</span>
		<span class="n">ceph_decode_need</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">dname_len</span><span class="p">,</span> <span class="n">bad</span><span class="p">);</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">dname</span> <span class="o">=</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
		<span class="o">*</span><span class="n">p</span> <span class="o">+=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">dname_len</span><span class="p">;</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">dlease</span> <span class="o">=</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
		<span class="o">*</span><span class="n">p</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">dlease</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">head</span><span class="o">-&gt;</span><span class="n">is_target</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">parse_reply_info_in</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">targeti</span><span class="p">,</span> <span class="n">features</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out_bad</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">*</span><span class="n">p</span> <span class="o">!=</span> <span class="n">end</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">bad</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">bad:</span>
	<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
<span class="nl">out_bad:</span>
	<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;problem parsing mds trace %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * parse readdir results</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">parse_reply_info_dir</span><span class="p">(</span><span class="kt">void</span> <span class="o">**</span><span class="n">p</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">end</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">ceph_mds_reply_info_parsed</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
				<span class="kt">int</span> <span class="n">features</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">num</span><span class="p">,</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">info</span><span class="o">-&gt;</span><span class="n">dir_dir</span> <span class="o">=</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">p</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">dir_dir</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">end</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">bad</span><span class="p">;</span>
	<span class="o">*</span><span class="n">p</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">dir_dir</span><span class="p">)</span> <span class="o">+</span>
		<span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="o">*</span><span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">dir_dir</span><span class="o">-&gt;</span><span class="n">ndist</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">p</span> <span class="o">&gt;</span> <span class="n">end</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">bad</span><span class="p">;</span>

	<span class="n">ceph_decode_need</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">num</span><span class="p">)</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="n">bad</span><span class="p">);</span>
	<span class="n">num</span> <span class="o">=</span> <span class="n">ceph_decode_32</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">dir_end</span> <span class="o">=</span> <span class="n">ceph_decode_8</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">dir_complete</span> <span class="o">=</span> <span class="n">ceph_decode_8</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">num</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>

	<span class="cm">/* alloc large array */</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">dir_nr</span> <span class="o">=</span> <span class="n">num</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">dir_in</span> <span class="o">=</span> <span class="n">kcalloc</span><span class="p">(</span><span class="n">num</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">dir_in</span><span class="p">)</span> <span class="o">+</span>
			       <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">dir_dname</span><span class="p">)</span> <span class="o">+</span>
			       <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">dir_dname_len</span><span class="p">)</span> <span class="o">+</span>
			       <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">dir_dlease</span><span class="p">),</span>
			       <span class="n">GFP_NOFS</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">dir_in</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out_bad</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">dir_dname</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">dir_in</span> <span class="o">+</span> <span class="n">num</span><span class="p">);</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">dir_dname_len</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">dir_dname</span> <span class="o">+</span> <span class="n">num</span><span class="p">);</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">dir_dlease</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">dir_dname_len</span> <span class="o">+</span> <span class="n">num</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">num</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* dentry */</span>
		<span class="n">ceph_decode_need</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="o">*</span><span class="mi">2</span><span class="p">,</span> <span class="n">bad</span><span class="p">);</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">dir_dname_len</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">ceph_decode_32</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
		<span class="n">ceph_decode_need</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">dir_dname_len</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">bad</span><span class="p">);</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">dir_dname</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
		<span class="o">*</span><span class="n">p</span> <span class="o">+=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">dir_dname_len</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="n">dout</span><span class="p">(</span><span class="s">&quot;parsed dir dname &#39;%.*s&#39;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">dir_dname_len</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
		     <span class="n">info</span><span class="o">-&gt;</span><span class="n">dir_dname</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">dir_dlease</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
		<span class="o">*</span><span class="n">p</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ceph_mds_reply_lease</span><span class="p">);</span>

		<span class="cm">/* inode */</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">parse_reply_info_in</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">dir_in</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">features</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out_bad</span><span class="p">;</span>
		<span class="n">i</span><span class="o">++</span><span class="p">;</span>
		<span class="n">num</span><span class="o">--</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">done:</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">p</span> <span class="o">!=</span> <span class="n">end</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">bad</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">bad:</span>
	<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
<span class="nl">out_bad:</span>
	<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;problem parsing dir contents %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * parse fcntl F_GETLK results</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">parse_reply_info_filelock</span><span class="p">(</span><span class="kt">void</span> <span class="o">**</span><span class="n">p</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">end</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">ceph_mds_reply_info_parsed</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
				     <span class="kt">int</span> <span class="n">features</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">p</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">filelock_reply</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">end</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">bad</span><span class="p">;</span>

	<span class="n">info</span><span class="o">-&gt;</span><span class="n">filelock_reply</span> <span class="o">=</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
	<span class="o">*</span><span class="n">p</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">filelock_reply</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">*</span><span class="n">p</span> <span class="o">!=</span> <span class="n">end</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">bad</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">bad:</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * parse extra results</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">parse_reply_info_extra</span><span class="p">(</span><span class="kt">void</span> <span class="o">**</span><span class="n">p</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">end</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">ceph_mds_reply_info_parsed</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
				  <span class="kt">int</span> <span class="n">features</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">head</span><span class="o">-&gt;</span><span class="n">op</span> <span class="o">==</span> <span class="n">CEPH_MDS_OP_GETFILELOCK</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">parse_reply_info_filelock</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="n">features</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="n">parse_reply_info_dir</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="n">features</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * parse entire mds reply</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">parse_reply_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">ceph_msg</span> <span class="o">*</span><span class="n">msg</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">ceph_mds_reply_info_parsed</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
			    <span class="kt">int</span> <span class="n">features</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="o">*</span><span class="n">end</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">len</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">info</span><span class="o">-&gt;</span><span class="n">head</span> <span class="o">=</span> <span class="n">msg</span><span class="o">-&gt;</span><span class="n">front</span><span class="p">.</span><span class="n">iov_base</span><span class="p">;</span>
	<span class="n">p</span> <span class="o">=</span> <span class="n">msg</span><span class="o">-&gt;</span><span class="n">front</span><span class="p">.</span><span class="n">iov_base</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ceph_mds_reply_head</span><span class="p">);</span>
	<span class="n">end</span> <span class="o">=</span> <span class="n">p</span> <span class="o">+</span> <span class="n">msg</span><span class="o">-&gt;</span><span class="n">front</span><span class="p">.</span><span class="n">iov_len</span> <span class="o">-</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ceph_mds_reply_head</span><span class="p">);</span>

	<span class="cm">/* trace */</span>
	<span class="n">ceph_decode_32_safe</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">bad</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ceph_decode_need</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">bad</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">parse_reply_info_trace</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="p">,</span> <span class="n">p</span><span class="o">+</span><span class="n">len</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="n">features</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out_bad</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* extra */</span>
	<span class="n">ceph_decode_32_safe</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">bad</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ceph_decode_need</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">bad</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">parse_reply_info_extra</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="p">,</span> <span class="n">p</span><span class="o">+</span><span class="n">len</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="n">features</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out_bad</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* snap blob */</span>
	<span class="n">ceph_decode_32_safe</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">bad</span><span class="p">);</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">snapblob_len</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">snapblob</span> <span class="o">=</span> <span class="n">p</span><span class="p">;</span>
	<span class="n">p</span> <span class="o">+=</span> <span class="n">len</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">p</span> <span class="o">!=</span> <span class="n">end</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">bad</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">bad:</span>
	<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
<span class="nl">out_bad:</span>
	<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;mds parse_reply err %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">destroy_reply_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">ceph_mds_reply_info_parsed</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">dir_in</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * sessions</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="nf">session_state_name</span><span class="p">(</span><span class="kt">int</span> <span class="n">s</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">CEPH_MDS_SESSION_NEW</span>: <span class="k">return</span> <span class="s">&quot;new&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CEPH_MDS_SESSION_OPENING</span>: <span class="k">return</span> <span class="s">&quot;opening&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CEPH_MDS_SESSION_OPEN</span>: <span class="k">return</span> <span class="s">&quot;open&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CEPH_MDS_SESSION_HUNG</span>: <span class="k">return</span> <span class="s">&quot;hung&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CEPH_MDS_SESSION_CLOSING</span>: <span class="k">return</span> <span class="s">&quot;closing&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CEPH_MDS_SESSION_RESTARTING</span>: <span class="k">return</span> <span class="s">&quot;restarting&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CEPH_MDS_SESSION_RECONNECTING</span>: <span class="k">return</span> <span class="s">&quot;reconnecting&quot;</span><span class="p">;</span>
	<span class="nl">default:</span> <span class="k">return</span> <span class="s">&quot;???&quot;</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">ceph_mds_session</span> <span class="o">*</span><span class="nf">get_session</span><span class="p">(</span><span class="k">struct</span> <span class="n">ceph_mds_session</span> <span class="o">*</span><span class="n">s</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">atomic_inc_not_zero</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">s_ref</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dout</span><span class="p">(</span><span class="s">&quot;mdsc get_session %p %d -&gt; %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span>
		     <span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">s_ref</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">s_ref</span><span class="p">));</span>
		<span class="k">return</span> <span class="n">s</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">dout</span><span class="p">(</span><span class="s">&quot;mdsc get_session %p 0 -- FAIL&quot;</span><span class="p">,</span> <span class="n">s</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">ceph_put_mds_session</span><span class="p">(</span><span class="k">struct</span> <span class="n">ceph_mds_session</span> <span class="o">*</span><span class="n">s</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dout</span><span class="p">(</span><span class="s">&quot;mdsc put_session %p %d -&gt; %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span>
	     <span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">s_ref</span><span class="p">),</span> <span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">s_ref</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">atomic_dec_and_test</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">s_ref</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">s_auth</span><span class="p">.</span><span class="n">authorizer</span><span class="p">)</span>
		     <span class="n">s</span><span class="o">-&gt;</span><span class="n">s_mdsc</span><span class="o">-&gt;</span><span class="n">fsc</span><span class="o">-&gt;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">monc</span><span class="p">.</span><span class="n">auth</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">destroy_authorizer</span><span class="p">(</span>
			     <span class="n">s</span><span class="o">-&gt;</span><span class="n">s_mdsc</span><span class="o">-&gt;</span><span class="n">fsc</span><span class="o">-&gt;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">monc</span><span class="p">.</span><span class="n">auth</span><span class="p">,</span>
			     <span class="n">s</span><span class="o">-&gt;</span><span class="n">s_auth</span><span class="p">.</span><span class="n">authorizer</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * called under mdsc-&gt;mutex</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">ceph_mds_session</span> <span class="o">*</span><span class="nf">__ceph_lookup_mds_session</span><span class="p">(</span><span class="k">struct</span> <span class="n">ceph_mds_client</span> <span class="o">*</span><span class="n">mdsc</span><span class="p">,</span>
						   <span class="kt">int</span> <span class="n">mds</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ceph_mds_session</span> <span class="o">*</span><span class="n">session</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mds</span> <span class="o">&gt;=</span> <span class="n">mdsc</span><span class="o">-&gt;</span><span class="n">max_sessions</span> <span class="o">||</span> <span class="n">mdsc</span><span class="o">-&gt;</span><span class="n">sessions</span><span class="p">[</span><span class="n">mds</span><span class="p">]</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">session</span> <span class="o">=</span> <span class="n">mdsc</span><span class="o">-&gt;</span><span class="n">sessions</span><span class="p">[</span><span class="n">mds</span><span class="p">];</span>
	<span class="n">dout</span><span class="p">(</span><span class="s">&quot;lookup_mds_session %p %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">session</span><span class="p">,</span>
	     <span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">session</span><span class="o">-&gt;</span><span class="n">s_ref</span><span class="p">));</span>
	<span class="n">get_session</span><span class="p">(</span><span class="n">session</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">session</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">__have_session</span><span class="p">(</span><span class="k">struct</span> <span class="n">ceph_mds_client</span> <span class="o">*</span><span class="n">mdsc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mds</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mds</span> <span class="o">&gt;=</span> <span class="n">mdsc</span><span class="o">-&gt;</span><span class="n">max_sessions</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">mdsc</span><span class="o">-&gt;</span><span class="n">sessions</span><span class="p">[</span><span class="n">mds</span><span class="p">];</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">__verify_registered_session</span><span class="p">(</span><span class="k">struct</span> <span class="n">ceph_mds_client</span> <span class="o">*</span><span class="n">mdsc</span><span class="p">,</span>
				       <span class="k">struct</span> <span class="n">ceph_mds_session</span> <span class="o">*</span><span class="n">s</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">s_mds</span> <span class="o">&gt;=</span> <span class="n">mdsc</span><span class="o">-&gt;</span><span class="n">max_sessions</span> <span class="o">||</span>
	    <span class="n">mdsc</span><span class="o">-&gt;</span><span class="n">sessions</span><span class="p">[</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">s_mds</span><span class="p">]</span> <span class="o">!=</span> <span class="n">s</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * create+register a new session for given mds.</span>
<span class="cm"> * called under mdsc-&gt;mutex.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">ceph_mds_session</span> <span class="o">*</span><span class="nf">register_session</span><span class="p">(</span><span class="k">struct</span> <span class="n">ceph_mds_client</span> <span class="o">*</span><span class="n">mdsc</span><span class="p">,</span>
						 <span class="kt">int</span> <span class="n">mds</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ceph_mds_session</span> <span class="o">*</span><span class="n">s</span><span class="p">;</span>

	<span class="n">s</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">s</span><span class="p">),</span> <span class="n">GFP_NOFS</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">s</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">ENOMEM</span><span class="p">);</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">s_mdsc</span> <span class="o">=</span> <span class="n">mdsc</span><span class="p">;</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">s_mds</span> <span class="o">=</span> <span class="n">mds</span><span class="p">;</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">s_state</span> <span class="o">=</span> <span class="n">CEPH_MDS_SESSION_NEW</span><span class="p">;</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">s_ttl</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">s_seq</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">s_mutex</span><span class="p">);</span>

	<span class="n">ceph_con_init</span><span class="p">(</span><span class="n">mdsc</span><span class="o">-&gt;</span><span class="n">fsc</span><span class="o">-&gt;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">msgr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">s_con</span><span class="p">);</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">s_con</span><span class="p">.</span><span class="n">private</span> <span class="o">=</span> <span class="n">s</span><span class="p">;</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">s_con</span><span class="p">.</span><span class="n">ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">mds_con_ops</span><span class="p">;</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">s_con</span><span class="p">.</span><span class="n">peer_name</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">CEPH_ENTITY_TYPE_MDS</span><span class="p">;</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">s_con</span><span class="p">.</span><span class="n">peer_name</span><span class="p">.</span><span class="n">num</span> <span class="o">=</span> <span class="n">cpu_to_le64</span><span class="p">(</span><span class="n">mds</span><span class="p">);</span>

	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">s_gen_ttl_lock</span><span class="p">);</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">s_cap_gen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">s_cap_ttl</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">s_cap_lock</span><span class="p">);</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">s_renew_requested</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">s_renew_seq</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">s_caps</span><span class="p">);</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">s_nr_caps</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">s_trim_caps</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">s_ref</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">s_waiting</span><span class="p">);</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">s_unsafe</span><span class="p">);</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">s_num_cap_releases</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">s_cap_iterator</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">s_cap_releases</span><span class="p">);</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">s_cap_releases_done</span><span class="p">);</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">s_cap_flushing</span><span class="p">);</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">s_cap_snaps_flushing</span><span class="p">);</span>

	<span class="n">dout</span><span class="p">(</span><span class="s">&quot;register_session mds%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">mds</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mds</span> <span class="o">&gt;=</span> <span class="n">mdsc</span><span class="o">-&gt;</span><span class="n">max_sessions</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">newmax</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">get_count_order</span><span class="p">(</span><span class="n">mds</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span>
		<span class="k">struct</span> <span class="n">ceph_mds_session</span> <span class="o">**</span><span class="n">sa</span><span class="p">;</span>

		<span class="n">dout</span><span class="p">(</span><span class="s">&quot;register_session realloc to %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">newmax</span><span class="p">);</span>
		<span class="n">sa</span> <span class="o">=</span> <span class="n">kcalloc</span><span class="p">(</span><span class="n">newmax</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">),</span> <span class="n">GFP_NOFS</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sa</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">fail_realloc</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mdsc</span><span class="o">-&gt;</span><span class="n">sessions</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">sa</span><span class="p">,</span> <span class="n">mdsc</span><span class="o">-&gt;</span><span class="n">sessions</span><span class="p">,</span>
			       <span class="n">mdsc</span><span class="o">-&gt;</span><span class="n">max_sessions</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">));</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">mdsc</span><span class="o">-&gt;</span><span class="n">sessions</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">mdsc</span><span class="o">-&gt;</span><span class="n">sessions</span> <span class="o">=</span> <span class="n">sa</span><span class="p">;</span>
		<span class="n">mdsc</span><span class="o">-&gt;</span><span class="n">max_sessions</span> <span class="o">=</span> <span class="n">newmax</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">mdsc</span><span class="o">-&gt;</span><span class="n">sessions</span><span class="p">[</span><span class="n">mds</span><span class="p">]</span> <span class="o">=</span> <span class="n">s</span><span class="p">;</span>
	<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">s_ref</span><span class="p">);</span>  <span class="cm">/* one ref to sessions[], one to caller */</span>

	<span class="n">ceph_con_open</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">s_con</span><span class="p">,</span> <span class="n">ceph_mdsmap_get_addr</span><span class="p">(</span><span class="n">mdsc</span><span class="o">-&gt;</span><span class="n">mdsmap</span><span class="p">,</span> <span class="n">mds</span><span class="p">));</span>

	<span class="k">return</span> <span class="n">s</span><span class="p">;</span>

<span class="nl">fail_realloc:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">ENOMEM</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * called under mdsc-&gt;mutex</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">__unregister_session</span><span class="p">(</span><span class="k">struct</span> <span class="n">ceph_mds_client</span> <span class="o">*</span><span class="n">mdsc</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">ceph_mds_session</span> <span class="o">*</span><span class="n">s</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dout</span><span class="p">(</span><span class="s">&quot;__unregister_session mds%d %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">s_mds</span><span class="p">,</span> <span class="n">s</span><span class="p">);</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">mdsc</span><span class="o">-&gt;</span><span class="n">sessions</span><span class="p">[</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">s_mds</span><span class="p">]</span> <span class="o">!=</span> <span class="n">s</span><span class="p">);</span>
	<span class="n">mdsc</span><span class="o">-&gt;</span><span class="n">sessions</span><span class="p">[</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">s_mds</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">ceph_con_close</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">s_con</span><span class="p">);</span>
	<span class="n">ceph_put_mds_session</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * drop session refs in request.</span>
<span class="cm"> *</span>
<span class="cm"> * should be last request ref, or hold mdsc-&gt;mutex</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">put_request_session</span><span class="p">(</span><span class="k">struct</span> <span class="n">ceph_mds_request</span> <span class="o">*</span><span class="n">req</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">r_session</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ceph_put_mds_session</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">r_session</span><span class="p">);</span>
		<span class="n">req</span><span class="o">-&gt;</span><span class="n">r_session</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">ceph_mdsc_release_request</span><span class="p">(</span><span class="k">struct</span> <span class="n">kref</span> <span class="o">*</span><span class="n">kref</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ceph_mds_request</span> <span class="o">*</span><span class="n">req</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">kref</span><span class="p">,</span>
						    <span class="k">struct</span> <span class="n">ceph_mds_request</span><span class="p">,</span>
						    <span class="n">r_kref</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">r_request</span><span class="p">)</span>
		<span class="n">ceph_msg_put</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">r_request</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">r_reply</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ceph_msg_put</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">r_reply</span><span class="p">);</span>
		<span class="n">destroy_reply_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">r_reply_info</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">r_inode</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ceph_put_cap_refs</span><span class="p">(</span><span class="n">ceph_inode</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">r_inode</span><span class="p">),</span> <span class="n">CEPH_CAP_PIN</span><span class="p">);</span>
		<span class="n">iput</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">r_inode</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">r_locked_dir</span><span class="p">)</span>
		<span class="n">ceph_put_cap_refs</span><span class="p">(</span><span class="n">ceph_inode</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">r_locked_dir</span><span class="p">),</span> <span class="n">CEPH_CAP_PIN</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">r_target_inode</span><span class="p">)</span>
		<span class="n">iput</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">r_target_inode</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">r_dentry</span><span class="p">)</span>
		<span class="n">dput</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">r_dentry</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">r_old_dentry</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * track (and drop pins for) r_old_dentry_dir</span>
<span class="cm">		 * separately, since r_old_dentry&#39;s d_parent may have</span>
<span class="cm">		 * changed between the dir mutex being dropped and</span>
<span class="cm">		 * this request being freed.</span>
<span class="cm">		 */</span>
		<span class="n">ceph_put_cap_refs</span><span class="p">(</span><span class="n">ceph_inode</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">r_old_dentry_dir</span><span class="p">),</span>
				  <span class="n">CEPH_CAP_PIN</span><span class="p">);</span>
		<span class="n">dput</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">r_old_dentry</span><span class="p">);</span>
		<span class="n">iput</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">r_old_dentry_dir</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">r_path1</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">r_path2</span><span class="p">);</span>
	<span class="n">put_request_session</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>
	<span class="n">ceph_unreserve_caps</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">r_mdsc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">r_caps_reservation</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * lookup session, bump ref if found.</span>
<span class="cm"> *</span>
<span class="cm"> * called under mdsc-&gt;mutex.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">ceph_mds_request</span> <span class="o">*</span><span class="nf">__lookup_request</span><span class="p">(</span><span class="k">struct</span> <span class="n">ceph_mds_client</span> <span class="o">*</span><span class="n">mdsc</span><span class="p">,</span>
					     <span class="n">u64</span> <span class="n">tid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ceph_mds_request</span> <span class="o">*</span><span class="n">req</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rb_node</span> <span class="o">*</span><span class="n">n</span> <span class="o">=</span> <span class="n">mdsc</span><span class="o">-&gt;</span><span class="n">request_tree</span><span class="p">.</span><span class="n">rb_node</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">req</span> <span class="o">=</span> <span class="n">rb_entry</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ceph_mds_request</span><span class="p">,</span> <span class="n">r_node</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tid</span> <span class="o">&lt;</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">r_tid</span><span class="p">)</span>
			<span class="n">n</span> <span class="o">=</span> <span class="n">n</span><span class="o">-&gt;</span><span class="n">rb_left</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">tid</span> <span class="o">&gt;</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">r_tid</span><span class="p">)</span>
			<span class="n">n</span> <span class="o">=</span> <span class="n">n</span><span class="o">-&gt;</span><span class="n">rb_right</span><span class="p">;</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="n">ceph_mdsc_get_request</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">req</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">__insert_request</span><span class="p">(</span><span class="k">struct</span> <span class="n">ceph_mds_client</span> <span class="o">*</span><span class="n">mdsc</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">ceph_mds_request</span> <span class="o">*</span><span class="n">new</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rb_node</span> <span class="o">**</span><span class="n">p</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">mdsc</span><span class="o">-&gt;</span><span class="n">request_tree</span><span class="p">.</span><span class="n">rb_node</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rb_node</span> <span class="o">*</span><span class="n">parent</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ceph_mds_request</span> <span class="o">*</span><span class="n">req</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="o">*</span><span class="n">p</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">parent</span> <span class="o">=</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
		<span class="n">req</span> <span class="o">=</span> <span class="n">rb_entry</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ceph_mds_request</span><span class="p">,</span> <span class="n">r_node</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">new</span><span class="o">-&gt;</span><span class="n">r_tid</span> <span class="o">&lt;</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">r_tid</span><span class="p">)</span>
			<span class="n">p</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="o">*</span><span class="n">p</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">rb_left</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">new</span><span class="o">-&gt;</span><span class="n">r_tid</span> <span class="o">&gt;</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">r_tid</span><span class="p">)</span>
			<span class="n">p</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="o">*</span><span class="n">p</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">rb_right</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">BUG</span><span class="p">();</span>
	<span class="p">}</span>

	<span class="n">rb_link_node</span><span class="p">(</span><span class="o">&amp;</span><span class="n">new</span><span class="o">-&gt;</span><span class="n">r_node</span><span class="p">,</span> <span class="n">parent</span><span class="p">,</span> <span class="n">p</span><span class="p">);</span>
	<span class="n">rb_insert_color</span><span class="p">(</span><span class="o">&amp;</span><span class="n">new</span><span class="o">-&gt;</span><span class="n">r_node</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mdsc</span><span class="o">-&gt;</span><span class="n">request_tree</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Register an in-flight request, and assign a tid.  Link to directory</span>
<span class="cm"> * are modifying (if any).</span>
<span class="cm"> *</span>
<span class="cm"> * Called under mdsc-&gt;mutex.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">__register_request</span><span class="p">(</span><span class="k">struct</span> <span class="n">ceph_mds_client</span> <span class="o">*</span><span class="n">mdsc</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">ceph_mds_request</span> <span class="o">*</span><span class="n">req</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">dir</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">r_tid</span> <span class="o">=</span> <span class="o">++</span><span class="n">mdsc</span><span class="o">-&gt;</span><span class="n">last_tid</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">r_num_caps</span><span class="p">)</span>
		<span class="n">ceph_reserve_caps</span><span class="p">(</span><span class="n">mdsc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">r_caps_reservation</span><span class="p">,</span>
				  <span class="n">req</span><span class="o">-&gt;</span><span class="n">r_num_caps</span><span class="p">);</span>
	<span class="n">dout</span><span class="p">(</span><span class="s">&quot;__register_request %p tid %lld</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">r_tid</span><span class="p">);</span>
	<span class="n">ceph_mdsc_get_request</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>
	<span class="n">__insert_request</span><span class="p">(</span><span class="n">mdsc</span><span class="p">,</span> <span class="n">req</span><span class="p">);</span>

	<span class="n">req</span><span class="o">-&gt;</span><span class="n">r_uid</span> <span class="o">=</span> <span class="n">current_fsuid</span><span class="p">();</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">r_gid</span> <span class="o">=</span> <span class="n">current_fsgid</span><span class="p">();</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dir</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">ceph_inode_info</span> <span class="o">*</span><span class="n">ci</span> <span class="o">=</span> <span class="n">ceph_inode</span><span class="p">(</span><span class="n">dir</span><span class="p">);</span>

		<span class="n">ihold</span><span class="p">(</span><span class="n">dir</span><span class="p">);</span>
		<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ci</span><span class="o">-&gt;</span><span class="n">i_unsafe_lock</span><span class="p">);</span>
		<span class="n">req</span><span class="o">-&gt;</span><span class="n">r_unsafe_dir</span> <span class="o">=</span> <span class="n">dir</span><span class="p">;</span>
		<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">r_unsafe_dir_item</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ci</span><span class="o">-&gt;</span><span class="n">i_unsafe_dirops</span><span class="p">);</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ci</span><span class="o">-&gt;</span><span class="n">i_unsafe_lock</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">__unregister_request</span><span class="p">(</span><span class="k">struct</span> <span class="n">ceph_mds_client</span> <span class="o">*</span><span class="n">mdsc</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">ceph_mds_request</span> <span class="o">*</span><span class="n">req</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dout</span><span class="p">(</span><span class="s">&quot;__unregister_request %p tid %lld</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">r_tid</span><span class="p">);</span>
	<span class="n">rb_erase</span><span class="p">(</span><span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">r_node</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mdsc</span><span class="o">-&gt;</span><span class="n">request_tree</span><span class="p">);</span>
	<span class="n">RB_CLEAR_NODE</span><span class="p">(</span><span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">r_node</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">r_unsafe_dir</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">ceph_inode_info</span> <span class="o">*</span><span class="n">ci</span> <span class="o">=</span> <span class="n">ceph_inode</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">r_unsafe_dir</span><span class="p">);</span>

		<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ci</span><span class="o">-&gt;</span><span class="n">i_unsafe_lock</span><span class="p">);</span>
		<span class="n">list_del_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">r_unsafe_dir_item</span><span class="p">);</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ci</span><span class="o">-&gt;</span><span class="n">i_unsafe_lock</span><span class="p">);</span>

		<span class="n">iput</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">r_unsafe_dir</span><span class="p">);</span>
		<span class="n">req</span><span class="o">-&gt;</span><span class="n">r_unsafe_dir</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ceph_mdsc_put_request</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Choose mds to send request to next.  If there is a hint set in the</span>
<span class="cm"> * request (e.g., due to a prior forward hint from the mds), use that.</span>
<span class="cm"> * Otherwise, consult frag tree and/or caps to identify the</span>
<span class="cm"> * appropriate mds.  If all else fails, choose randomly.</span>
<span class="cm"> *</span>
<span class="cm"> * Called under mdsc-&gt;mutex.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="nf">get_nonsnap_parent</span><span class="p">(</span><span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="n">dentry</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/*</span>
<span class="cm">	 * we don&#39;t need to worry about protecting the d_parent access</span>
<span class="cm">	 * here because we never renaming inside the snapped namespace</span>
<span class="cm">	 * except to resplice to another snapdir, and either the old or new</span>
<span class="cm">	 * result is a valid result.</span>
<span class="cm">	 */</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">IS_ROOT</span><span class="p">(</span><span class="n">dentry</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">ceph_snap</span><span class="p">(</span><span class="n">dentry</span><span class="o">-&gt;</span><span class="n">d_inode</span><span class="p">)</span> <span class="o">!=</span> <span class="n">CEPH_NOSNAP</span><span class="p">)</span>
		<span class="n">dentry</span> <span class="o">=</span> <span class="n">dentry</span><span class="o">-&gt;</span><span class="n">d_parent</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">dentry</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">__choose_mds</span><span class="p">(</span><span class="k">struct</span> <span class="n">ceph_mds_client</span> <span class="o">*</span><span class="n">mdsc</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">ceph_mds_request</span> <span class="o">*</span><span class="n">req</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ceph_inode_info</span> <span class="o">*</span><span class="n">ci</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ceph_cap</span> <span class="o">*</span><span class="n">cap</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">mode</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">r_direct_mode</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">mds</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">hash</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">r_direct_hash</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">is_hash</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">r_direct_is_hash</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * is there a specific mds we should try?  ignore hint if we have</span>
<span class="cm">	 * no session and the mds is not up (active or recovering).</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">r_resend_mds</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">__have_session</span><span class="p">(</span><span class="n">mdsc</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">r_resend_mds</span><span class="p">)</span> <span class="o">||</span>
	     <span class="n">ceph_mdsmap_get_state</span><span class="p">(</span><span class="n">mdsc</span><span class="o">-&gt;</span><span class="n">mdsmap</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">r_resend_mds</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dout</span><span class="p">(</span><span class="s">&quot;choose_mds using resend_mds mds%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		     <span class="n">req</span><span class="o">-&gt;</span><span class="n">r_resend_mds</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">r_resend_mds</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mode</span> <span class="o">==</span> <span class="n">USE_RANDOM_MDS</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">random</span><span class="p">;</span>

	<span class="n">inode</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">r_inode</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">inode</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">r_inode</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">r_dentry</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* ignore race with rename; old or new d_parent is okay */</span>
		<span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="n">parent</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">r_dentry</span><span class="o">-&gt;</span><span class="n">d_parent</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">dir</span> <span class="o">=</span> <span class="n">parent</span><span class="o">-&gt;</span><span class="n">d_inode</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">dir</span><span class="o">-&gt;</span><span class="n">i_sb</span> <span class="o">!=</span> <span class="n">mdsc</span><span class="o">-&gt;</span><span class="n">fsc</span><span class="o">-&gt;</span><span class="n">sb</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* not this fs! */</span>
			<span class="n">inode</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">r_dentry</span><span class="o">-&gt;</span><span class="n">d_inode</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ceph_snap</span><span class="p">(</span><span class="n">dir</span><span class="p">)</span> <span class="o">!=</span> <span class="n">CEPH_NOSNAP</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* direct snapped/virtual snapdir requests</span>
<span class="cm">			 * based on parent dir inode */</span>
			<span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="n">dn</span> <span class="o">=</span> <span class="n">get_nonsnap_parent</span><span class="p">(</span><span class="n">parent</span><span class="p">);</span>
			<span class="n">inode</span> <span class="o">=</span> <span class="n">dn</span><span class="o">-&gt;</span><span class="n">d_inode</span><span class="p">;</span>
			<span class="n">dout</span><span class="p">(</span><span class="s">&quot;__choose_mds using nonsnap parent %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">inode</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">r_dentry</span><span class="o">-&gt;</span><span class="n">d_inode</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* dentry target */</span>
			<span class="n">inode</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">r_dentry</span><span class="o">-&gt;</span><span class="n">d_inode</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* dir + name */</span>
			<span class="n">inode</span> <span class="o">=</span> <span class="n">dir</span><span class="p">;</span>
			<span class="n">hash</span> <span class="o">=</span> <span class="n">ceph_dentry_hash</span><span class="p">(</span><span class="n">dir</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">r_dentry</span><span class="p">);</span>
			<span class="n">is_hash</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">dout</span><span class="p">(</span><span class="s">&quot;__choose_mds %p is_hash=%d (%d) mode %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">inode</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">is_hash</span><span class="p">,</span>
	     <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">hash</span><span class="p">,</span> <span class="n">mode</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">inode</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">random</span><span class="p">;</span>
	<span class="n">ci</span> <span class="o">=</span> <span class="n">ceph_inode</span><span class="p">(</span><span class="n">inode</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">is_hash</span> <span class="o">&amp;&amp;</span> <span class="n">S_ISDIR</span><span class="p">(</span><span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_mode</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">ceph_inode_frag</span> <span class="n">frag</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">found</span><span class="p">;</span>

		<span class="n">ceph_choose_frag</span><span class="p">(</span><span class="n">ci</span><span class="p">,</span> <span class="n">hash</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">frag</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">found</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">found</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">mode</span> <span class="o">==</span> <span class="n">USE_ANY_MDS</span> <span class="o">&amp;&amp;</span> <span class="n">frag</span><span class="p">.</span><span class="n">ndist</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">u8</span> <span class="n">r</span><span class="p">;</span>

				<span class="cm">/* choose a random replica */</span>
				<span class="n">get_random_bytes</span><span class="p">(</span><span class="o">&amp;</span><span class="n">r</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
				<span class="n">r</span> <span class="o">%=</span> <span class="n">frag</span><span class="p">.</span><span class="n">ndist</span><span class="p">;</span>
				<span class="n">mds</span> <span class="o">=</span> <span class="n">frag</span><span class="p">.</span><span class="n">dist</span><span class="p">[</span><span class="n">r</span><span class="p">];</span>
				<span class="n">dout</span><span class="p">(</span><span class="s">&quot;choose_mds %p %llx.%llx &quot;</span>
				     <span class="s">&quot;frag %u mds%d (%d/%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				     <span class="n">inode</span><span class="p">,</span> <span class="n">ceph_vinop</span><span class="p">(</span><span class="n">inode</span><span class="p">),</span>
				     <span class="n">frag</span><span class="p">.</span><span class="n">frag</span><span class="p">,</span> <span class="n">mds</span><span class="p">,</span>
				     <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">r</span><span class="p">,</span> <span class="n">frag</span><span class="p">.</span><span class="n">ndist</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">ceph_mdsmap_get_state</span><span class="p">(</span><span class="n">mdsc</span><span class="o">-&gt;</span><span class="n">mdsmap</span><span class="p">,</span> <span class="n">mds</span><span class="p">)</span> <span class="o">&gt;=</span>
				    <span class="n">CEPH_MDS_STATE_ACTIVE</span><span class="p">)</span>
					<span class="k">return</span> <span class="n">mds</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="cm">/* since this file/dir wasn&#39;t known to be</span>
<span class="cm">			 * replicated, then we want to look for the</span>
<span class="cm">			 * authoritative mds. */</span>
			<span class="n">mode</span> <span class="o">=</span> <span class="n">USE_AUTH_MDS</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">frag</span><span class="p">.</span><span class="n">mds</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* choose auth mds */</span>
				<span class="n">mds</span> <span class="o">=</span> <span class="n">frag</span><span class="p">.</span><span class="n">mds</span><span class="p">;</span>
				<span class="n">dout</span><span class="p">(</span><span class="s">&quot;choose_mds %p %llx.%llx &quot;</span>
				     <span class="s">&quot;frag %u mds%d (auth)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				     <span class="n">inode</span><span class="p">,</span> <span class="n">ceph_vinop</span><span class="p">(</span><span class="n">inode</span><span class="p">),</span> <span class="n">frag</span><span class="p">.</span><span class="n">frag</span><span class="p">,</span> <span class="n">mds</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">ceph_mdsmap_get_state</span><span class="p">(</span><span class="n">mdsc</span><span class="o">-&gt;</span><span class="n">mdsmap</span><span class="p">,</span> <span class="n">mds</span><span class="p">)</span> <span class="o">&gt;=</span>
				    <span class="n">CEPH_MDS_STATE_ACTIVE</span><span class="p">)</span>
					<span class="k">return</span> <span class="n">mds</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ci</span><span class="o">-&gt;</span><span class="n">i_ceph_lock</span><span class="p">);</span>
	<span class="n">cap</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mode</span> <span class="o">==</span> <span class="n">USE_AUTH_MDS</span><span class="p">)</span>
		<span class="n">cap</span> <span class="o">=</span> <span class="n">ci</span><span class="o">-&gt;</span><span class="n">i_auth_cap</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cap</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">RB_EMPTY_ROOT</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ci</span><span class="o">-&gt;</span><span class="n">i_caps</span><span class="p">))</span>
		<span class="n">cap</span> <span class="o">=</span> <span class="n">rb_entry</span><span class="p">(</span><span class="n">rb_first</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ci</span><span class="o">-&gt;</span><span class="n">i_caps</span><span class="p">),</span> <span class="k">struct</span> <span class="n">ceph_cap</span><span class="p">,</span> <span class="n">ci_node</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cap</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ci</span><span class="o">-&gt;</span><span class="n">i_ceph_lock</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">random</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">mds</span> <span class="o">=</span> <span class="n">cap</span><span class="o">-&gt;</span><span class="n">session</span><span class="o">-&gt;</span><span class="n">s_mds</span><span class="p">;</span>
	<span class="n">dout</span><span class="p">(</span><span class="s">&quot;choose_mds %p %llx.%llx mds%d (%scap %p)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	     <span class="n">inode</span><span class="p">,</span> <span class="n">ceph_vinop</span><span class="p">(</span><span class="n">inode</span><span class="p">),</span> <span class="n">mds</span><span class="p">,</span>
	     <span class="n">cap</span> <span class="o">==</span> <span class="n">ci</span><span class="o">-&gt;</span><span class="n">i_auth_cap</span> <span class="o">?</span> <span class="s">&quot;auth &quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span> <span class="n">cap</span><span class="p">);</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ci</span><span class="o">-&gt;</span><span class="n">i_ceph_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">mds</span><span class="p">;</span>

<span class="nl">random:</span>
	<span class="n">mds</span> <span class="o">=</span> <span class="n">ceph_mdsmap_get_random_mds</span><span class="p">(</span><span class="n">mdsc</span><span class="o">-&gt;</span><span class="n">mdsmap</span><span class="p">);</span>
	<span class="n">dout</span><span class="p">(</span><span class="s">&quot;choose_mds chose random mds%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">mds</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">mds</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * session messages</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">ceph_msg</span> <span class="o">*</span><span class="nf">create_session_msg</span><span class="p">(</span><span class="n">u32</span> <span class="n">op</span><span class="p">,</span> <span class="n">u64</span> <span class="n">seq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ceph_msg</span> <span class="o">*</span><span class="n">msg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ceph_mds_session_head</span> <span class="o">*</span><span class="n">h</span><span class="p">;</span>

	<span class="n">msg</span> <span class="o">=</span> <span class="n">ceph_msg_new</span><span class="p">(</span><span class="n">CEPH_MSG_CLIENT_SESSION</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">h</span><span class="p">),</span> <span class="n">GFP_NOFS</span><span class="p">,</span>
			   <span class="nb">false</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">msg</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;create_session_msg ENOMEM creating msg</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">h</span> <span class="o">=</span> <span class="n">msg</span><span class="o">-&gt;</span><span class="n">front</span><span class="p">.</span><span class="n">iov_base</span><span class="p">;</span>
	<span class="n">h</span><span class="o">-&gt;</span><span class="n">op</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">op</span><span class="p">);</span>
	<span class="n">h</span><span class="o">-&gt;</span><span class="n">seq</span> <span class="o">=</span> <span class="n">cpu_to_le64</span><span class="p">(</span><span class="n">seq</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">msg</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * send session open request.</span>
<span class="cm"> *</span>
<span class="cm"> * called under mdsc-&gt;mutex</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">__open_session</span><span class="p">(</span><span class="k">struct</span> <span class="n">ceph_mds_client</span> <span class="o">*</span><span class="n">mdsc</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">ceph_mds_session</span> <span class="o">*</span><span class="n">session</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ceph_msg</span> <span class="o">*</span><span class="n">msg</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">mstate</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">mds</span> <span class="o">=</span> <span class="n">session</span><span class="o">-&gt;</span><span class="n">s_mds</span><span class="p">;</span>

	<span class="cm">/* wait for mds to go active? */</span>
	<span class="n">mstate</span> <span class="o">=</span> <span class="n">ceph_mdsmap_get_state</span><span class="p">(</span><span class="n">mdsc</span><span class="o">-&gt;</span><span class="n">mdsmap</span><span class="p">,</span> <span class="n">mds</span><span class="p">);</span>
	<span class="n">dout</span><span class="p">(</span><span class="s">&quot;open_session to mds%d (%s)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">mds</span><span class="p">,</span>
	     <span class="n">ceph_mds_state_name</span><span class="p">(</span><span class="n">mstate</span><span class="p">));</span>
	<span class="n">session</span><span class="o">-&gt;</span><span class="n">s_state</span> <span class="o">=</span> <span class="n">CEPH_MDS_SESSION_OPENING</span><span class="p">;</span>
	<span class="n">session</span><span class="o">-&gt;</span><span class="n">s_renew_requested</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>

	<span class="cm">/* send connect message */</span>
	<span class="n">msg</span> <span class="o">=</span> <span class="n">create_session_msg</span><span class="p">(</span><span class="n">CEPH_SESSION_REQUEST_OPEN</span><span class="p">,</span> <span class="n">session</span><span class="o">-&gt;</span><span class="n">s_seq</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">msg</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">ceph_con_send</span><span class="p">(</span><span class="o">&amp;</span><span class="n">session</span><span class="o">-&gt;</span><span class="n">s_con</span><span class="p">,</span> <span class="n">msg</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * open sessions for any export targets for the given mds</span>
<span class="cm"> *</span>
<span class="cm"> * called under mdsc-&gt;mutex</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">__open_export_target_sessions</span><span class="p">(</span><span class="k">struct</span> <span class="n">ceph_mds_client</span> <span class="o">*</span><span class="n">mdsc</span><span class="p">,</span>
					  <span class="k">struct</span> <span class="n">ceph_mds_session</span> <span class="o">*</span><span class="n">session</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ceph_mds_info</span> <span class="o">*</span><span class="n">mi</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ceph_mds_session</span> <span class="o">*</span><span class="n">ts</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">mds</span> <span class="o">=</span> <span class="n">session</span><span class="o">-&gt;</span><span class="n">s_mds</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">target</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mds</span> <span class="o">&gt;=</span> <span class="n">mdsc</span><span class="o">-&gt;</span><span class="n">mdsmap</span><span class="o">-&gt;</span><span class="n">m_max_mds</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">mi</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">mdsc</span><span class="o">-&gt;</span><span class="n">mdsmap</span><span class="o">-&gt;</span><span class="n">m_info</span><span class="p">[</span><span class="n">mds</span><span class="p">];</span>
	<span class="n">dout</span><span class="p">(</span><span class="s">&quot;open_export_target_sessions for mds%d (%d targets)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	     <span class="n">session</span><span class="o">-&gt;</span><span class="n">s_mds</span><span class="p">,</span> <span class="n">mi</span><span class="o">-&gt;</span><span class="n">num_export_targets</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">mi</span><span class="o">-&gt;</span><span class="n">num_export_targets</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">target</span> <span class="o">=</span> <span class="n">mi</span><span class="o">-&gt;</span><span class="n">export_targets</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="n">ts</span> <span class="o">=</span> <span class="n">__ceph_lookup_mds_session</span><span class="p">(</span><span class="n">mdsc</span><span class="p">,</span> <span class="n">target</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ts</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ts</span> <span class="o">=</span> <span class="n">register_session</span><span class="p">(</span><span class="n">mdsc</span><span class="p">,</span> <span class="n">target</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">ts</span><span class="p">))</span>
				<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">session</span><span class="o">-&gt;</span><span class="n">s_state</span> <span class="o">==</span> <span class="n">CEPH_MDS_SESSION_NEW</span> <span class="o">||</span>
		    <span class="n">session</span><span class="o">-&gt;</span><span class="n">s_state</span> <span class="o">==</span> <span class="n">CEPH_MDS_SESSION_CLOSING</span><span class="p">)</span>
			<span class="n">__open_session</span><span class="p">(</span><span class="n">mdsc</span><span class="p">,</span> <span class="n">session</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">dout</span><span class="p">(</span><span class="s">&quot; mds%d target mds%d %p is %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">session</span><span class="o">-&gt;</span><span class="n">s_mds</span><span class="p">,</span>
			     <span class="n">i</span><span class="p">,</span> <span class="n">ts</span><span class="p">,</span> <span class="n">session_state_name</span><span class="p">(</span><span class="n">ts</span><span class="o">-&gt;</span><span class="n">s_state</span><span class="p">));</span>
		<span class="n">ceph_put_mds_session</span><span class="p">(</span><span class="n">ts</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">ceph_mdsc_open_export_target_sessions</span><span class="p">(</span><span class="k">struct</span> <span class="n">ceph_mds_client</span> <span class="o">*</span><span class="n">mdsc</span><span class="p">,</span>
					   <span class="k">struct</span> <span class="n">ceph_mds_session</span> <span class="o">*</span><span class="n">session</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdsc</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="n">__open_export_target_sessions</span><span class="p">(</span><span class="n">mdsc</span><span class="p">,</span> <span class="n">session</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdsc</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * session caps</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> * Free preallocated cap messages assigned to this session</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">cleanup_cap_releases</span><span class="p">(</span><span class="k">struct</span> <span class="n">ceph_mds_session</span> <span class="o">*</span><span class="n">session</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ceph_msg</span> <span class="o">*</span><span class="n">msg</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">session</span><span class="o">-&gt;</span><span class="n">s_cap_lock</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">session</span><span class="o">-&gt;</span><span class="n">s_cap_releases</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">msg</span> <span class="o">=</span> <span class="n">list_first_entry</span><span class="p">(</span><span class="o">&amp;</span><span class="n">session</span><span class="o">-&gt;</span><span class="n">s_cap_releases</span><span class="p">,</span>
				       <span class="k">struct</span> <span class="n">ceph_msg</span><span class="p">,</span> <span class="n">list_head</span><span class="p">);</span>
		<span class="n">list_del_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">list_head</span><span class="p">);</span>
		<span class="n">ceph_msg_put</span><span class="p">(</span><span class="n">msg</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">session</span><span class="o">-&gt;</span><span class="n">s_cap_releases_done</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">msg</span> <span class="o">=</span> <span class="n">list_first_entry</span><span class="p">(</span><span class="o">&amp;</span><span class="n">session</span><span class="o">-&gt;</span><span class="n">s_cap_releases_done</span><span class="p">,</span>
				       <span class="k">struct</span> <span class="n">ceph_msg</span><span class="p">,</span> <span class="n">list_head</span><span class="p">);</span>
		<span class="n">list_del_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">list_head</span><span class="p">);</span>
		<span class="n">ceph_msg_put</span><span class="p">(</span><span class="n">msg</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">session</span><span class="o">-&gt;</span><span class="n">s_cap_lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Helper to safely iterate over all caps associated with a session, with</span>
<span class="cm"> * special care taken to handle a racing __ceph_remove_cap().</span>
<span class="cm"> *</span>
<span class="cm"> * Caller must hold session s_mutex.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">iterate_session_caps</span><span class="p">(</span><span class="k">struct</span> <span class="n">ceph_mds_session</span> <span class="o">*</span><span class="n">session</span><span class="p">,</span>
				 <span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">cb</span><span class="p">)(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ceph_cap</span> <span class="o">*</span><span class="p">,</span>
					    <span class="kt">void</span> <span class="o">*</span><span class="p">),</span> <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ceph_cap</span> <span class="o">*</span><span class="n">cap</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="o">*</span><span class="n">last_inode</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ceph_cap</span> <span class="o">*</span><span class="n">old_cap</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">dout</span><span class="p">(</span><span class="s">&quot;iterate_session_caps %p mds%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">session</span><span class="p">,</span> <span class="n">session</span><span class="o">-&gt;</span><span class="n">s_mds</span><span class="p">);</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">session</span><span class="o">-&gt;</span><span class="n">s_cap_lock</span><span class="p">);</span>
	<span class="n">p</span> <span class="o">=</span> <span class="n">session</span><span class="o">-&gt;</span><span class="n">s_caps</span><span class="p">.</span><span class="n">next</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">p</span> <span class="o">!=</span> <span class="o">&amp;</span><span class="n">session</span><span class="o">-&gt;</span><span class="n">s_caps</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cap</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ceph_cap</span><span class="p">,</span> <span class="n">session_caps</span><span class="p">);</span>
		<span class="n">inode</span> <span class="o">=</span> <span class="n">igrab</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cap</span><span class="o">-&gt;</span><span class="n">ci</span><span class="o">-&gt;</span><span class="n">vfs_inode</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">inode</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">p</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">session</span><span class="o">-&gt;</span><span class="n">s_cap_iterator</span> <span class="o">=</span> <span class="n">cap</span><span class="p">;</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">session</span><span class="o">-&gt;</span><span class="n">s_cap_lock</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">last_inode</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">iput</span><span class="p">(</span><span class="n">last_inode</span><span class="p">);</span>
			<span class="n">last_inode</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">old_cap</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ceph_put_cap</span><span class="p">(</span><span class="n">session</span><span class="o">-&gt;</span><span class="n">s_mdsc</span><span class="p">,</span> <span class="n">old_cap</span><span class="p">);</span>
			<span class="n">old_cap</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">cb</span><span class="p">(</span><span class="n">inode</span><span class="p">,</span> <span class="n">cap</span><span class="p">,</span> <span class="n">arg</span><span class="p">);</span>
		<span class="n">last_inode</span> <span class="o">=</span> <span class="n">inode</span><span class="p">;</span>

		<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">session</span><span class="o">-&gt;</span><span class="n">s_cap_lock</span><span class="p">);</span>
		<span class="n">p</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cap</span><span class="o">-&gt;</span><span class="n">ci</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dout</span><span class="p">(</span><span class="s">&quot;iterate_session_caps  finishing cap %p removal</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			     <span class="n">cap</span><span class="p">);</span>
			<span class="n">BUG_ON</span><span class="p">(</span><span class="n">cap</span><span class="o">-&gt;</span><span class="n">session</span> <span class="o">!=</span> <span class="n">session</span><span class="p">);</span>
			<span class="n">list_del_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cap</span><span class="o">-&gt;</span><span class="n">session_caps</span><span class="p">);</span>
			<span class="n">session</span><span class="o">-&gt;</span><span class="n">s_nr_caps</span><span class="o">--</span><span class="p">;</span>
			<span class="n">cap</span><span class="o">-&gt;</span><span class="n">session</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="n">old_cap</span> <span class="o">=</span> <span class="n">cap</span><span class="p">;</span>  <span class="cm">/* put_cap it w/o locks held */</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">out:</span>
	<span class="n">session</span><span class="o">-&gt;</span><span class="n">s_cap_iterator</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">session</span><span class="o">-&gt;</span><span class="n">s_cap_lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">last_inode</span><span class="p">)</span>
		<span class="n">iput</span><span class="p">(</span><span class="n">last_inode</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">old_cap</span><span class="p">)</span>
		<span class="n">ceph_put_cap</span><span class="p">(</span><span class="n">session</span><span class="o">-&gt;</span><span class="n">s_mdsc</span><span class="p">,</span> <span class="n">old_cap</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">remove_session_caps_cb</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ceph_cap</span> <span class="o">*</span><span class="n">cap</span><span class="p">,</span>
				  <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ceph_inode_info</span> <span class="o">*</span><span class="n">ci</span> <span class="o">=</span> <span class="n">ceph_inode</span><span class="p">(</span><span class="n">inode</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">drop</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">dout</span><span class="p">(</span><span class="s">&quot;removing cap %p, ci is %p, inode is %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	     <span class="n">cap</span><span class="p">,</span> <span class="n">ci</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ci</span><span class="o">-&gt;</span><span class="n">vfs_inode</span><span class="p">);</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ci</span><span class="o">-&gt;</span><span class="n">i_ceph_lock</span><span class="p">);</span>
	<span class="n">__ceph_remove_cap</span><span class="p">(</span><span class="n">cap</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">__ceph_is_any_real_caps</span><span class="p">(</span><span class="n">ci</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">ceph_mds_client</span> <span class="o">*</span><span class="n">mdsc</span> <span class="o">=</span>
			<span class="n">ceph_sb_to_client</span><span class="p">(</span><span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_sb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">mdsc</span><span class="p">;</span>

		<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdsc</span><span class="o">-&gt;</span><span class="n">cap_dirty_lock</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ci</span><span class="o">-&gt;</span><span class="n">i_dirty_item</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot; dropping dirty %s state for %p %lld</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">ceph_cap_string</span><span class="p">(</span><span class="n">ci</span><span class="o">-&gt;</span><span class="n">i_dirty_caps</span><span class="p">),</span>
				<span class="n">inode</span><span class="p">,</span> <span class="n">ceph_ino</span><span class="p">(</span><span class="n">inode</span><span class="p">));</span>
			<span class="n">ci</span><span class="o">-&gt;</span><span class="n">i_dirty_caps</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">list_del_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ci</span><span class="o">-&gt;</span><span class="n">i_dirty_item</span><span class="p">);</span>
			<span class="n">drop</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ci</span><span class="o">-&gt;</span><span class="n">i_flushing_item</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot; dropping dirty+flushing %s state for %p %lld</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">ceph_cap_string</span><span class="p">(</span><span class="n">ci</span><span class="o">-&gt;</span><span class="n">i_flushing_caps</span><span class="p">),</span>
				<span class="n">inode</span><span class="p">,</span> <span class="n">ceph_ino</span><span class="p">(</span><span class="n">inode</span><span class="p">));</span>
			<span class="n">ci</span><span class="o">-&gt;</span><span class="n">i_flushing_caps</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">list_del_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ci</span><span class="o">-&gt;</span><span class="n">i_flushing_item</span><span class="p">);</span>
			<span class="n">mdsc</span><span class="o">-&gt;</span><span class="n">num_cap_flushing</span><span class="o">--</span><span class="p">;</span>
			<span class="n">drop</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">drop</span> <span class="o">&amp;&amp;</span> <span class="n">ci</span><span class="o">-&gt;</span><span class="n">i_wrbuffer_ref</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot; dropping dirty data for %p %lld</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">inode</span><span class="p">,</span> <span class="n">ceph_ino</span><span class="p">(</span><span class="n">inode</span><span class="p">));</span>
			<span class="n">ci</span><span class="o">-&gt;</span><span class="n">i_wrbuffer_ref</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">ci</span><span class="o">-&gt;</span><span class="n">i_wrbuffer_ref_head</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">drop</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdsc</span><span class="o">-&gt;</span><span class="n">cap_dirty_lock</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ci</span><span class="o">-&gt;</span><span class="n">i_ceph_lock</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">drop</span><span class="o">--</span><span class="p">)</span>
		<span class="n">iput</span><span class="p">(</span><span class="n">inode</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * caller must hold session s_mutex</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">remove_session_caps</span><span class="p">(</span><span class="k">struct</span> <span class="n">ceph_mds_session</span> <span class="o">*</span><span class="n">session</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dout</span><span class="p">(</span><span class="s">&quot;remove_session_caps on %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">session</span><span class="p">);</span>
	<span class="n">iterate_session_caps</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">remove_session_caps_cb</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">session</span><span class="o">-&gt;</span><span class="n">s_nr_caps</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">session</span><span class="o">-&gt;</span><span class="n">s_cap_flushing</span><span class="p">));</span>
	<span class="n">cleanup_cap_releases</span><span class="p">(</span><span class="n">session</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * wake up any threads waiting on this session&#39;s caps.  if the cap is</span>
<span class="cm"> * old (didn&#39;t get renewed on the client reconnect), remove it now.</span>
<span class="cm"> *</span>
<span class="cm"> * caller must hold s_mutex.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">wake_up_session_cb</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ceph_cap</span> <span class="o">*</span><span class="n">cap</span><span class="p">,</span>
			      <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ceph_inode_info</span> <span class="o">*</span><span class="n">ci</span> <span class="o">=</span> <span class="n">ceph_inode</span><span class="p">(</span><span class="n">inode</span><span class="p">);</span>

	<span class="n">wake_up_all</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ci</span><span class="o">-&gt;</span><span class="n">i_cap_wq</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">arg</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ci</span><span class="o">-&gt;</span><span class="n">i_ceph_lock</span><span class="p">);</span>
		<span class="n">ci</span><span class="o">-&gt;</span><span class="n">i_wanted_max_size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">ci</span><span class="o">-&gt;</span><span class="n">i_requested_max_size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ci</span><span class="o">-&gt;</span><span class="n">i_ceph_lock</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">wake_up_session_caps</span><span class="p">(</span><span class="k">struct</span> <span class="n">ceph_mds_session</span> <span class="o">*</span><span class="n">session</span><span class="p">,</span>
				 <span class="kt">int</span> <span class="n">reconnect</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dout</span><span class="p">(</span><span class="s">&quot;wake_up_session_caps %p mds%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">session</span><span class="p">,</span> <span class="n">session</span><span class="o">-&gt;</span><span class="n">s_mds</span><span class="p">);</span>
	<span class="n">iterate_session_caps</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">wake_up_session_cb</span><span class="p">,</span>
			     <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">reconnect</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Send periodic message to MDS renewing all currently held caps.  The</span>
<span class="cm"> * ack will reset the expiration for all caps from this session.</span>
<span class="cm"> *</span>
<span class="cm"> * caller holds s_mutex</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">send_renew_caps</span><span class="p">(</span><span class="k">struct</span> <span class="n">ceph_mds_client</span> <span class="o">*</span><span class="n">mdsc</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">ceph_mds_session</span> <span class="o">*</span><span class="n">session</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ceph_msg</span> <span class="o">*</span><span class="n">msg</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">state</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">time_after_eq</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">session</span><span class="o">-&gt;</span><span class="n">s_cap_ttl</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">time_after_eq</span><span class="p">(</span><span class="n">session</span><span class="o">-&gt;</span><span class="n">s_cap_ttl</span><span class="p">,</span> <span class="n">session</span><span class="o">-&gt;</span><span class="n">s_renew_requested</span><span class="p">))</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;mds%d caps stale</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">session</span><span class="o">-&gt;</span><span class="n">s_mds</span><span class="p">);</span>
	<span class="n">session</span><span class="o">-&gt;</span><span class="n">s_renew_requested</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>

	<span class="cm">/* do not try to renew caps until a recovering mds has reconnected</span>
<span class="cm">	 * with its clients. */</span>
	<span class="n">state</span> <span class="o">=</span> <span class="n">ceph_mdsmap_get_state</span><span class="p">(</span><span class="n">mdsc</span><span class="o">-&gt;</span><span class="n">mdsmap</span><span class="p">,</span> <span class="n">session</span><span class="o">-&gt;</span><span class="n">s_mds</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">state</span> <span class="o">&lt;</span> <span class="n">CEPH_MDS_STATE_RECONNECT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dout</span><span class="p">(</span><span class="s">&quot;send_renew_caps ignoring mds%d (%s)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		     <span class="n">session</span><span class="o">-&gt;</span><span class="n">s_mds</span><span class="p">,</span> <span class="n">ceph_mds_state_name</span><span class="p">(</span><span class="n">state</span><span class="p">));</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dout</span><span class="p">(</span><span class="s">&quot;send_renew_caps to mds%d (%s)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">session</span><span class="o">-&gt;</span><span class="n">s_mds</span><span class="p">,</span>
		<span class="n">ceph_mds_state_name</span><span class="p">(</span><span class="n">state</span><span class="p">));</span>
	<span class="n">msg</span> <span class="o">=</span> <span class="n">create_session_msg</span><span class="p">(</span><span class="n">CEPH_SESSION_REQUEST_RENEWCAPS</span><span class="p">,</span>
				 <span class="o">++</span><span class="n">session</span><span class="o">-&gt;</span><span class="n">s_renew_seq</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">msg</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">ceph_con_send</span><span class="p">(</span><span class="o">&amp;</span><span class="n">session</span><span class="o">-&gt;</span><span class="n">s_con</span><span class="p">,</span> <span class="n">msg</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Note new cap ttl, and any transition from stale -&gt; not stale (fresh?).</span>
<span class="cm"> *</span>
<span class="cm"> * Called under session-&gt;s_mutex</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">renewed_caps</span><span class="p">(</span><span class="k">struct</span> <span class="n">ceph_mds_client</span> <span class="o">*</span><span class="n">mdsc</span><span class="p">,</span>
			 <span class="k">struct</span> <span class="n">ceph_mds_session</span> <span class="o">*</span><span class="n">session</span><span class="p">,</span> <span class="kt">int</span> <span class="n">is_renew</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">was_stale</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">wake</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">session</span><span class="o">-&gt;</span><span class="n">s_cap_lock</span><span class="p">);</span>
	<span class="n">was_stale</span> <span class="o">=</span> <span class="n">is_renew</span> <span class="o">&amp;&amp;</span> <span class="n">time_after_eq</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">session</span><span class="o">-&gt;</span><span class="n">s_cap_ttl</span><span class="p">);</span>

	<span class="n">session</span><span class="o">-&gt;</span><span class="n">s_cap_ttl</span> <span class="o">=</span> <span class="n">session</span><span class="o">-&gt;</span><span class="n">s_renew_requested</span> <span class="o">+</span>
		<span class="n">mdsc</span><span class="o">-&gt;</span><span class="n">mdsmap</span><span class="o">-&gt;</span><span class="n">m_session_timeout</span><span class="o">*</span><span class="n">HZ</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">was_stale</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">time_before</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">session</span><span class="o">-&gt;</span><span class="n">s_cap_ttl</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;mds%d caps renewed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">session</span><span class="o">-&gt;</span><span class="n">s_mds</span><span class="p">);</span>
			<span class="n">wake</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;mds%d caps still stale</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">session</span><span class="o">-&gt;</span><span class="n">s_mds</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">dout</span><span class="p">(</span><span class="s">&quot;renewed_caps mds%d ttl now %lu, was %s, now %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	     <span class="n">session</span><span class="o">-&gt;</span><span class="n">s_mds</span><span class="p">,</span> <span class="n">session</span><span class="o">-&gt;</span><span class="n">s_cap_ttl</span><span class="p">,</span> <span class="n">was_stale</span> <span class="o">?</span> <span class="s">&quot;stale&quot;</span> <span class="o">:</span> <span class="s">&quot;fresh&quot;</span><span class="p">,</span>
	     <span class="n">time_before</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">session</span><span class="o">-&gt;</span><span class="n">s_cap_ttl</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;stale&quot;</span> <span class="o">:</span> <span class="s">&quot;fresh&quot;</span><span class="p">);</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">session</span><span class="o">-&gt;</span><span class="n">s_cap_lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">wake</span><span class="p">)</span>
		<span class="n">wake_up_session_caps</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * send a session close request</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">request_close_session</span><span class="p">(</span><span class="k">struct</span> <span class="n">ceph_mds_client</span> <span class="o">*</span><span class="n">mdsc</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">ceph_mds_session</span> <span class="o">*</span><span class="n">session</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ceph_msg</span> <span class="o">*</span><span class="n">msg</span><span class="p">;</span>

	<span class="n">dout</span><span class="p">(</span><span class="s">&quot;request_close_session mds%d state %s seq %lld</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	     <span class="n">session</span><span class="o">-&gt;</span><span class="n">s_mds</span><span class="p">,</span> <span class="n">session_state_name</span><span class="p">(</span><span class="n">session</span><span class="o">-&gt;</span><span class="n">s_state</span><span class="p">),</span>
	     <span class="n">session</span><span class="o">-&gt;</span><span class="n">s_seq</span><span class="p">);</span>
	<span class="n">msg</span> <span class="o">=</span> <span class="n">create_session_msg</span><span class="p">(</span><span class="n">CEPH_SESSION_REQUEST_CLOSE</span><span class="p">,</span> <span class="n">session</span><span class="o">-&gt;</span><span class="n">s_seq</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">msg</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">ceph_con_send</span><span class="p">(</span><span class="o">&amp;</span><span class="n">session</span><span class="o">-&gt;</span><span class="n">s_con</span><span class="p">,</span> <span class="n">msg</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Called with s_mutex held.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">__close_session</span><span class="p">(</span><span class="k">struct</span> <span class="n">ceph_mds_client</span> <span class="o">*</span><span class="n">mdsc</span><span class="p">,</span>
			 <span class="k">struct</span> <span class="n">ceph_mds_session</span> <span class="o">*</span><span class="n">session</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">session</span><span class="o">-&gt;</span><span class="n">s_state</span> <span class="o">&gt;=</span> <span class="n">CEPH_MDS_SESSION_CLOSING</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">session</span><span class="o">-&gt;</span><span class="n">s_state</span> <span class="o">=</span> <span class="n">CEPH_MDS_SESSION_CLOSING</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">request_close_session</span><span class="p">(</span><span class="n">mdsc</span><span class="p">,</span> <span class="n">session</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Trim old(er) caps.</span>
<span class="cm"> *</span>
<span class="cm"> * Because we can&#39;t cache an inode without one or more caps, we do</span>
<span class="cm"> * this indirectly: if a cap is unused, we prune its aliases, at which</span>
<span class="cm"> * point the inode will hopefully get dropped to.</span>
<span class="cm"> *</span>
<span class="cm"> * Yes, this is a bit sloppy.  Our only real goal here is to respond to</span>
<span class="cm"> * memory pressure from the MDS, though, so it needn&#39;t be perfect.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">trim_caps_cb</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ceph_cap</span> <span class="o">*</span><span class="n">cap</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ceph_mds_session</span> <span class="o">*</span><span class="n">session</span> <span class="o">=</span> <span class="n">arg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ceph_inode_info</span> <span class="o">*</span><span class="n">ci</span> <span class="o">=</span> <span class="n">ceph_inode</span><span class="p">(</span><span class="n">inode</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">used</span><span class="p">,</span> <span class="n">oissued</span><span class="p">,</span> <span class="n">mine</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">session</span><span class="o">-&gt;</span><span class="n">s_trim_caps</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ci</span><span class="o">-&gt;</span><span class="n">i_ceph_lock</span><span class="p">);</span>
	<span class="n">mine</span> <span class="o">=</span> <span class="n">cap</span><span class="o">-&gt;</span><span class="n">issued</span> <span class="o">|</span> <span class="n">cap</span><span class="o">-&gt;</span><span class="n">implemented</span><span class="p">;</span>
	<span class="n">used</span> <span class="o">=</span> <span class="n">__ceph_caps_used</span><span class="p">(</span><span class="n">ci</span><span class="p">);</span>
	<span class="n">oissued</span> <span class="o">=</span> <span class="n">__ceph_caps_issued_other</span><span class="p">(</span><span class="n">ci</span><span class="p">,</span> <span class="n">cap</span><span class="p">);</span>

	<span class="n">dout</span><span class="p">(</span><span class="s">&quot;trim_caps_cb %p cap %p mine %s oissued %s used %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	     <span class="n">inode</span><span class="p">,</span> <span class="n">cap</span><span class="p">,</span> <span class="n">ceph_cap_string</span><span class="p">(</span><span class="n">mine</span><span class="p">),</span> <span class="n">ceph_cap_string</span><span class="p">(</span><span class="n">oissued</span><span class="p">),</span>
	     <span class="n">ceph_cap_string</span><span class="p">(</span><span class="n">used</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ci</span><span class="o">-&gt;</span><span class="n">i_dirty_caps</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>   <span class="cm">/* dirty caps */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">used</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">oissued</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">mine</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>   <span class="cm">/* we need these caps */</span>

	<span class="n">session</span><span class="o">-&gt;</span><span class="n">s_trim_caps</span><span class="o">--</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">oissued</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* we aren&#39;t the only cap.. just remove us */</span>
		<span class="n">__ceph_remove_cap</span><span class="p">(</span><span class="n">cap</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* try to drop referring dentries */</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ci</span><span class="o">-&gt;</span><span class="n">i_ceph_lock</span><span class="p">);</span>
		<span class="n">d_prune_aliases</span><span class="p">(</span><span class="n">inode</span><span class="p">);</span>
		<span class="n">dout</span><span class="p">(</span><span class="s">&quot;trim_caps_cb %p cap %p  pruned, count now %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		     <span class="n">inode</span><span class="p">,</span> <span class="n">cap</span><span class="p">,</span> <span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_count</span><span class="p">));</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">out:</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ci</span><span class="o">-&gt;</span><span class="n">i_ceph_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Trim session cap count down to some max number.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">trim_caps</span><span class="p">(</span><span class="k">struct</span> <span class="n">ceph_mds_client</span> <span class="o">*</span><span class="n">mdsc</span><span class="p">,</span>
		     <span class="k">struct</span> <span class="n">ceph_mds_session</span> <span class="o">*</span><span class="n">session</span><span class="p">,</span>
		     <span class="kt">int</span> <span class="n">max_caps</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">trim_caps</span> <span class="o">=</span> <span class="n">session</span><span class="o">-&gt;</span><span class="n">s_nr_caps</span> <span class="o">-</span> <span class="n">max_caps</span><span class="p">;</span>

	<span class="n">dout</span><span class="p">(</span><span class="s">&quot;trim_caps mds%d start: %d / %d, trim %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	     <span class="n">session</span><span class="o">-&gt;</span><span class="n">s_mds</span><span class="p">,</span> <span class="n">session</span><span class="o">-&gt;</span><span class="n">s_nr_caps</span><span class="p">,</span> <span class="n">max_caps</span><span class="p">,</span> <span class="n">trim_caps</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">trim_caps</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">session</span><span class="o">-&gt;</span><span class="n">s_trim_caps</span> <span class="o">=</span> <span class="n">trim_caps</span><span class="p">;</span>
		<span class="n">iterate_session_caps</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">trim_caps_cb</span><span class="p">,</span> <span class="n">session</span><span class="p">);</span>
		<span class="n">dout</span><span class="p">(</span><span class="s">&quot;trim_caps mds%d done: %d / %d, trimmed %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		     <span class="n">session</span><span class="o">-&gt;</span><span class="n">s_mds</span><span class="p">,</span> <span class="n">session</span><span class="o">-&gt;</span><span class="n">s_nr_caps</span><span class="p">,</span> <span class="n">max_caps</span><span class="p">,</span>
			<span class="n">trim_caps</span> <span class="o">-</span> <span class="n">session</span><span class="o">-&gt;</span><span class="n">s_trim_caps</span><span class="p">);</span>
		<span class="n">session</span><span class="o">-&gt;</span><span class="n">s_trim_caps</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Allocate cap_release messages.  If there is a partially full message</span>
<span class="cm"> * in the queue, try to allocate enough to cover it&#39;s remainder, so that</span>
<span class="cm"> * we can send it immediately.</span>
<span class="cm"> *</span>
<span class="cm"> * Called under s_mutex.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">ceph_add_cap_releases</span><span class="p">(</span><span class="k">struct</span> <span class="n">ceph_mds_client</span> <span class="o">*</span><span class="n">mdsc</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">ceph_mds_session</span> <span class="o">*</span><span class="n">session</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ceph_msg</span> <span class="o">*</span><span class="n">msg</span><span class="p">,</span> <span class="o">*</span><span class="n">partial</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ceph_mds_cap_release</span> <span class="o">*</span><span class="n">head</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">extra</span> <span class="o">=</span> <span class="n">mdsc</span><span class="o">-&gt;</span><span class="n">fsc</span><span class="o">-&gt;</span><span class="n">mount_options</span><span class="o">-&gt;</span><span class="n">cap_release_safety</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">num</span><span class="p">;</span>

	<span class="n">dout</span><span class="p">(</span><span class="s">&quot;add_cap_releases %p mds%d extra %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">session</span><span class="p">,</span> <span class="n">session</span><span class="o">-&gt;</span><span class="n">s_mds</span><span class="p">,</span>
	     <span class="n">extra</span><span class="p">);</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">session</span><span class="o">-&gt;</span><span class="n">s_cap_lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">session</span><span class="o">-&gt;</span><span class="n">s_cap_releases</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">msg</span> <span class="o">=</span> <span class="n">list_first_entry</span><span class="p">(</span><span class="o">&amp;</span><span class="n">session</span><span class="o">-&gt;</span><span class="n">s_cap_releases</span><span class="p">,</span>
				       <span class="k">struct</span> <span class="n">ceph_msg</span><span class="p">,</span>
				 <span class="n">list_head</span><span class="p">);</span>
		<span class="n">head</span> <span class="o">=</span> <span class="n">msg</span><span class="o">-&gt;</span><span class="n">front</span><span class="p">.</span><span class="n">iov_base</span><span class="p">;</span>
		<span class="n">num</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">head</span><span class="o">-&gt;</span><span class="n">num</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">num</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dout</span><span class="p">(</span><span class="s">&quot; partial %p with (%d/%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">num</span><span class="p">,</span>
			     <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">CEPH_CAPS_PER_RELEASE</span><span class="p">);</span>
			<span class="n">extra</span> <span class="o">+=</span> <span class="n">CEPH_CAPS_PER_RELEASE</span> <span class="o">-</span> <span class="n">num</span><span class="p">;</span>
			<span class="n">partial</span> <span class="o">=</span> <span class="n">msg</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">session</span><span class="o">-&gt;</span><span class="n">s_num_cap_releases</span> <span class="o">&lt;</span> <span class="n">session</span><span class="o">-&gt;</span><span class="n">s_nr_caps</span> <span class="o">+</span> <span class="n">extra</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">session</span><span class="o">-&gt;</span><span class="n">s_cap_lock</span><span class="p">);</span>
		<span class="n">msg</span> <span class="o">=</span> <span class="n">ceph_msg_new</span><span class="p">(</span><span class="n">CEPH_MSG_CLIENT_CAPRELEASE</span><span class="p">,</span> <span class="n">PAGE_CACHE_SIZE</span><span class="p">,</span>
				   <span class="n">GFP_NOFS</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">msg</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out_unlocked</span><span class="p">;</span>
		<span class="n">dout</span><span class="p">(</span><span class="s">&quot;add_cap_releases %p msg %p now %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">session</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span>
		     <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">front</span><span class="p">.</span><span class="n">iov_len</span><span class="p">);</span>
		<span class="n">head</span> <span class="o">=</span> <span class="n">msg</span><span class="o">-&gt;</span><span class="n">front</span><span class="p">.</span><span class="n">iov_base</span><span class="p">;</span>
		<span class="n">head</span><span class="o">-&gt;</span><span class="n">num</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
		<span class="n">msg</span><span class="o">-&gt;</span><span class="n">front</span><span class="p">.</span><span class="n">iov_len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">head</span><span class="p">);</span>
		<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">session</span><span class="o">-&gt;</span><span class="n">s_cap_lock</span><span class="p">);</span>
		<span class="n">list_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">list_head</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">session</span><span class="o">-&gt;</span><span class="n">s_cap_releases</span><span class="p">);</span>
		<span class="n">session</span><span class="o">-&gt;</span><span class="n">s_num_cap_releases</span> <span class="o">+=</span> <span class="n">CEPH_CAPS_PER_RELEASE</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">partial</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">head</span> <span class="o">=</span> <span class="n">partial</span><span class="o">-&gt;</span><span class="n">front</span><span class="p">.</span><span class="n">iov_base</span><span class="p">;</span>
		<span class="n">num</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">head</span><span class="o">-&gt;</span><span class="n">num</span><span class="p">);</span>
		<span class="n">dout</span><span class="p">(</span><span class="s">&quot; queueing partial %p with %d/%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">partial</span><span class="p">,</span> <span class="n">num</span><span class="p">,</span>
		     <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">CEPH_CAPS_PER_RELEASE</span><span class="p">);</span>
		<span class="n">list_move_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">partial</span><span class="o">-&gt;</span><span class="n">list_head</span><span class="p">,</span>
			       <span class="o">&amp;</span><span class="n">session</span><span class="o">-&gt;</span><span class="n">s_cap_releases_done</span><span class="p">);</span>
		<span class="n">session</span><span class="o">-&gt;</span><span class="n">s_num_cap_releases</span> <span class="o">-=</span> <span class="n">CEPH_CAPS_PER_RELEASE</span> <span class="o">-</span> <span class="n">num</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">session</span><span class="o">-&gt;</span><span class="n">s_cap_lock</span><span class="p">);</span>
<span class="nl">out_unlocked:</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * flush all dirty inode data to disk.</span>
<span class="cm"> *</span>
<span class="cm"> * returns true if we&#39;ve flushed through want_flush_seq</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">check_cap_flush</span><span class="p">(</span><span class="k">struct</span> <span class="n">ceph_mds_client</span> <span class="o">*</span><span class="n">mdsc</span><span class="p">,</span> <span class="n">u64</span> <span class="n">want_flush_seq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">mds</span><span class="p">,</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">dout</span><span class="p">(</span><span class="s">&quot;check_cap_flush want %lld</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">want_flush_seq</span><span class="p">);</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdsc</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">mds</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">ret</span> <span class="o">&amp;&amp;</span> <span class="n">mds</span> <span class="o">&lt;</span> <span class="n">mdsc</span><span class="o">-&gt;</span><span class="n">max_sessions</span><span class="p">;</span> <span class="n">mds</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">ceph_mds_session</span> <span class="o">*</span><span class="n">session</span> <span class="o">=</span> <span class="n">mdsc</span><span class="o">-&gt;</span><span class="n">sessions</span><span class="p">[</span><span class="n">mds</span><span class="p">];</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">session</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">get_session</span><span class="p">(</span><span class="n">session</span><span class="p">);</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdsc</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

		<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">session</span><span class="o">-&gt;</span><span class="n">s_mutex</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">session</span><span class="o">-&gt;</span><span class="n">s_cap_flushing</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">ceph_inode_info</span> <span class="o">*</span><span class="n">ci</span> <span class="o">=</span>
				<span class="n">list_entry</span><span class="p">(</span><span class="n">session</span><span class="o">-&gt;</span><span class="n">s_cap_flushing</span><span class="p">.</span><span class="n">next</span><span class="p">,</span>
					   <span class="k">struct</span> <span class="n">ceph_inode_info</span><span class="p">,</span>
					   <span class="n">i_flushing_item</span><span class="p">);</span>
			<span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ci</span><span class="o">-&gt;</span><span class="n">vfs_inode</span><span class="p">;</span>

			<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ci</span><span class="o">-&gt;</span><span class="n">i_ceph_lock</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ci</span><span class="o">-&gt;</span><span class="n">i_cap_flush_seq</span> <span class="o">&lt;=</span> <span class="n">want_flush_seq</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">dout</span><span class="p">(</span><span class="s">&quot;check_cap_flush still flushing %p &quot;</span>
				     <span class="s">&quot;seq %lld &lt;= %lld to mds%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">inode</span><span class="p">,</span>
				     <span class="n">ci</span><span class="o">-&gt;</span><span class="n">i_cap_flush_seq</span><span class="p">,</span> <span class="n">want_flush_seq</span><span class="p">,</span>
				     <span class="n">session</span><span class="o">-&gt;</span><span class="n">s_mds</span><span class="p">);</span>
				<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ci</span><span class="o">-&gt;</span><span class="n">i_ceph_lock</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">session</span><span class="o">-&gt;</span><span class="n">s_mutex</span><span class="p">);</span>
		<span class="n">ceph_put_mds_session</span><span class="p">(</span><span class="n">session</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
		<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdsc</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdsc</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="n">dout</span><span class="p">(</span><span class="s">&quot;check_cap_flush ok, flushed thru %lld</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">want_flush_seq</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * called under s_mutex</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">ceph_send_cap_releases</span><span class="p">(</span><span class="k">struct</span> <span class="n">ceph_mds_client</span> <span class="o">*</span><span class="n">mdsc</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">ceph_mds_session</span> <span class="o">*</span><span class="n">session</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ceph_msg</span> <span class="o">*</span><span class="n">msg</span><span class="p">;</span>

	<span class="n">dout</span><span class="p">(</span><span class="s">&quot;send_cap_releases mds%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">session</span><span class="o">-&gt;</span><span class="n">s_mds</span><span class="p">);</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">session</span><span class="o">-&gt;</span><span class="n">s_cap_lock</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">session</span><span class="o">-&gt;</span><span class="n">s_cap_releases_done</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">msg</span> <span class="o">=</span> <span class="n">list_first_entry</span><span class="p">(</span><span class="o">&amp;</span><span class="n">session</span><span class="o">-&gt;</span><span class="n">s_cap_releases_done</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">ceph_msg</span><span class="p">,</span> <span class="n">list_head</span><span class="p">);</span>
		<span class="n">list_del_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">list_head</span><span class="p">);</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">session</span><span class="o">-&gt;</span><span class="n">s_cap_lock</span><span class="p">);</span>
		<span class="n">msg</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">front_len</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">front</span><span class="p">.</span><span class="n">iov_len</span><span class="p">);</span>
		<span class="n">dout</span><span class="p">(</span><span class="s">&quot;send_cap_releases mds%d %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">session</span><span class="o">-&gt;</span><span class="n">s_mds</span><span class="p">,</span> <span class="n">msg</span><span class="p">);</span>
		<span class="n">ceph_con_send</span><span class="p">(</span><span class="o">&amp;</span><span class="n">session</span><span class="o">-&gt;</span><span class="n">s_con</span><span class="p">,</span> <span class="n">msg</span><span class="p">);</span>
		<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">session</span><span class="o">-&gt;</span><span class="n">s_cap_lock</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">session</span><span class="o">-&gt;</span><span class="n">s_cap_lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">discard_cap_releases</span><span class="p">(</span><span class="k">struct</span> <span class="n">ceph_mds_client</span> <span class="o">*</span><span class="n">mdsc</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">ceph_mds_session</span> <span class="o">*</span><span class="n">session</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ceph_msg</span> <span class="o">*</span><span class="n">msg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ceph_mds_cap_release</span> <span class="o">*</span><span class="n">head</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">num</span><span class="p">;</span>

	<span class="n">dout</span><span class="p">(</span><span class="s">&quot;discard_cap_releases mds%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">session</span><span class="o">-&gt;</span><span class="n">s_mds</span><span class="p">);</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">session</span><span class="o">-&gt;</span><span class="n">s_cap_lock</span><span class="p">);</span>

	<span class="cm">/* zero out the in-progress message */</span>
	<span class="n">msg</span> <span class="o">=</span> <span class="n">list_first_entry</span><span class="p">(</span><span class="o">&amp;</span><span class="n">session</span><span class="o">-&gt;</span><span class="n">s_cap_releases</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">ceph_msg</span><span class="p">,</span> <span class="n">list_head</span><span class="p">);</span>
	<span class="n">head</span> <span class="o">=</span> <span class="n">msg</span><span class="o">-&gt;</span><span class="n">front</span><span class="p">.</span><span class="n">iov_base</span><span class="p">;</span>
	<span class="n">num</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">head</span><span class="o">-&gt;</span><span class="n">num</span><span class="p">);</span>
	<span class="n">dout</span><span class="p">(</span><span class="s">&quot;discard_cap_releases mds%d %p %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">session</span><span class="o">-&gt;</span><span class="n">s_mds</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">num</span><span class="p">);</span>
	<span class="n">head</span><span class="o">-&gt;</span><span class="n">num</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
	<span class="n">session</span><span class="o">-&gt;</span><span class="n">s_num_cap_releases</span> <span class="o">+=</span> <span class="n">num</span><span class="p">;</span>

	<span class="cm">/* requeue completed messages */</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">session</span><span class="o">-&gt;</span><span class="n">s_cap_releases_done</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">msg</span> <span class="o">=</span> <span class="n">list_first_entry</span><span class="p">(</span><span class="o">&amp;</span><span class="n">session</span><span class="o">-&gt;</span><span class="n">s_cap_releases_done</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">ceph_msg</span><span class="p">,</span> <span class="n">list_head</span><span class="p">);</span>
		<span class="n">list_del_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">list_head</span><span class="p">);</span>

		<span class="n">head</span> <span class="o">=</span> <span class="n">msg</span><span class="o">-&gt;</span><span class="n">front</span><span class="p">.</span><span class="n">iov_base</span><span class="p">;</span>
		<span class="n">num</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">head</span><span class="o">-&gt;</span><span class="n">num</span><span class="p">);</span>
		<span class="n">dout</span><span class="p">(</span><span class="s">&quot;discard_cap_releases mds%d %p %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">session</span><span class="o">-&gt;</span><span class="n">s_mds</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span>
		     <span class="n">num</span><span class="p">);</span>
		<span class="n">session</span><span class="o">-&gt;</span><span class="n">s_num_cap_releases</span> <span class="o">+=</span> <span class="n">num</span><span class="p">;</span>
		<span class="n">head</span><span class="o">-&gt;</span><span class="n">num</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
		<span class="n">msg</span><span class="o">-&gt;</span><span class="n">front</span><span class="p">.</span><span class="n">iov_len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">head</span><span class="p">);</span>
		<span class="n">list_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">list_head</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">session</span><span class="o">-&gt;</span><span class="n">s_cap_releases</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">session</span><span class="o">-&gt;</span><span class="n">s_cap_lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * requests</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> * Create an mds request.</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">ceph_mds_request</span> <span class="o">*</span>
<span class="nf">ceph_mdsc_create_request</span><span class="p">(</span><span class="k">struct</span> <span class="n">ceph_mds_client</span> <span class="o">*</span><span class="n">mdsc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">op</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ceph_mds_request</span> <span class="o">*</span><span class="n">req</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">req</span><span class="p">),</span> <span class="n">GFP_NOFS</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">req</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">ENOMEM</span><span class="p">);</span>

	<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">r_fill_mutex</span><span class="p">);</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">r_mdsc</span> <span class="o">=</span> <span class="n">mdsc</span><span class="p">;</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">r_started</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">r_resend_mds</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">r_unsafe_dir_item</span><span class="p">);</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">r_fmode</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">kref_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">r_kref</span><span class="p">);</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">r_wait</span><span class="p">);</span>
	<span class="n">init_completion</span><span class="p">(</span><span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">r_completion</span><span class="p">);</span>
	<span class="n">init_completion</span><span class="p">(</span><span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">r_safe_completion</span><span class="p">);</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">r_unsafe_item</span><span class="p">);</span>

	<span class="n">req</span><span class="o">-&gt;</span><span class="n">r_op</span> <span class="o">=</span> <span class="n">op</span><span class="p">;</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">r_direct_mode</span> <span class="o">=</span> <span class="n">mode</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">req</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * return oldest (lowest) request, tid in request tree, 0 if none.</span>
<span class="cm"> *</span>
<span class="cm"> * called under mdsc-&gt;mutex.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">ceph_mds_request</span> <span class="o">*</span><span class="nf">__get_oldest_req</span><span class="p">(</span><span class="k">struct</span> <span class="n">ceph_mds_client</span> <span class="o">*</span><span class="n">mdsc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">RB_EMPTY_ROOT</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdsc</span><span class="o">-&gt;</span><span class="n">request_tree</span><span class="p">))</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">rb_entry</span><span class="p">(</span><span class="n">rb_first</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdsc</span><span class="o">-&gt;</span><span class="n">request_tree</span><span class="p">),</span>
			<span class="k">struct</span> <span class="n">ceph_mds_request</span><span class="p">,</span> <span class="n">r_node</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u64</span> <span class="nf">__get_oldest_tid</span><span class="p">(</span><span class="k">struct</span> <span class="n">ceph_mds_client</span> <span class="o">*</span><span class="n">mdsc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ceph_mds_request</span> <span class="o">*</span><span class="n">req</span> <span class="o">=</span> <span class="n">__get_oldest_req</span><span class="p">(</span><span class="n">mdsc</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">r_tid</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Build a dentry&#39;s path.  Allocate on heap; caller must kfree.  Based</span>
<span class="cm"> * on build_path_from_dentry in fs/cifs/dir.c.</span>
<span class="cm"> *</span>
<span class="cm"> * If @stop_on_nosnap, generate path relative to the first non-snapped</span>
<span class="cm"> * inode.</span>
<span class="cm"> *</span>
<span class="cm"> * Encode hidden .snap dirs as a double /, i.e.</span>
<span class="cm"> *   foo/.snap/bar -&gt; foo//bar</span>
<span class="cm"> */</span>
<span class="kt">char</span> <span class="o">*</span><span class="nf">ceph_mdsc_build_path</span><span class="p">(</span><span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="n">dentry</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">plen</span><span class="p">,</span> <span class="n">u64</span> <span class="o">*</span><span class="n">base</span><span class="p">,</span>
			   <span class="kt">int</span> <span class="n">stop_on_nosnap</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="n">temp</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">path</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">len</span><span class="p">,</span> <span class="n">pos</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">seq</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dentry</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">EINVAL</span><span class="p">);</span>

<span class="nl">retry:</span>
	<span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">seq</span> <span class="o">=</span> <span class="n">read_seqbegin</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rename_lock</span><span class="p">);</span>
	<span class="n">rcu_read_lock</span><span class="p">();</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">temp</span> <span class="o">=</span> <span class="n">dentry</span><span class="p">;</span> <span class="o">!</span><span class="n">IS_ROOT</span><span class="p">(</span><span class="n">temp</span><span class="p">);)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span> <span class="o">=</span> <span class="n">temp</span><span class="o">-&gt;</span><span class="n">d_inode</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">inode</span> <span class="o">&amp;&amp;</span> <span class="n">ceph_snap</span><span class="p">(</span><span class="n">inode</span><span class="p">)</span> <span class="o">==</span> <span class="n">CEPH_SNAPDIR</span><span class="p">)</span>
			<span class="n">len</span><span class="o">++</span><span class="p">;</span>  <span class="cm">/* slash only */</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">stop_on_nosnap</span> <span class="o">&amp;&amp;</span> <span class="n">inode</span> <span class="o">&amp;&amp;</span>
			 <span class="n">ceph_snap</span><span class="p">(</span><span class="n">inode</span><span class="p">)</span> <span class="o">==</span> <span class="n">CEPH_NOSNAP</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">len</span> <span class="o">+=</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">temp</span><span class="o">-&gt;</span><span class="n">d_name</span><span class="p">.</span><span class="n">len</span><span class="p">;</span>
		<span class="n">temp</span> <span class="o">=</span> <span class="n">temp</span><span class="o">-&gt;</span><span class="n">d_parent</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">temp</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rcu_read_unlock</span><span class="p">();</span>
			<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;build_path corrupt dentry %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dentry</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">EINVAL</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">rcu_read_unlock</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">len</span><span class="p">)</span>
		<span class="n">len</span><span class="o">--</span><span class="p">;</span>  <span class="cm">/* no leading &#39;/&#39; */</span>

	<span class="n">path</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">len</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">GFP_NOFS</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">path</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">ENOMEM</span><span class="p">);</span>
	<span class="n">pos</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>
	<span class="n">path</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* trailing null */</span>
	<span class="n">rcu_read_lock</span><span class="p">();</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">temp</span> <span class="o">=</span> <span class="n">dentry</span><span class="p">;</span> <span class="o">!</span><span class="n">IS_ROOT</span><span class="p">(</span><span class="n">temp</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">pos</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">;</span> <span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">;</span>

		<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">temp</span><span class="o">-&gt;</span><span class="n">d_lock</span><span class="p">);</span>
		<span class="n">inode</span> <span class="o">=</span> <span class="n">temp</span><span class="o">-&gt;</span><span class="n">d_inode</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">inode</span> <span class="o">&amp;&amp;</span> <span class="n">ceph_snap</span><span class="p">(</span><span class="n">inode</span><span class="p">)</span> <span class="o">==</span> <span class="n">CEPH_SNAPDIR</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dout</span><span class="p">(</span><span class="s">&quot;build_path path+%d: %p SNAPDIR</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			     <span class="n">pos</span><span class="p">,</span> <span class="n">temp</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">stop_on_nosnap</span> <span class="o">&amp;&amp;</span> <span class="n">inode</span> <span class="o">&amp;&amp;</span>
			   <span class="n">ceph_snap</span><span class="p">(</span><span class="n">inode</span><span class="p">)</span> <span class="o">==</span> <span class="n">CEPH_NOSNAP</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">temp</span><span class="o">-&gt;</span><span class="n">d_lock</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">pos</span> <span class="o">-=</span> <span class="n">temp</span><span class="o">-&gt;</span><span class="n">d_name</span><span class="p">.</span><span class="n">len</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">pos</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">temp</span><span class="o">-&gt;</span><span class="n">d_lock</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">strncpy</span><span class="p">(</span><span class="n">path</span> <span class="o">+</span> <span class="n">pos</span><span class="p">,</span> <span class="n">temp</span><span class="o">-&gt;</span><span class="n">d_name</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
				<span class="n">temp</span><span class="o">-&gt;</span><span class="n">d_name</span><span class="p">.</span><span class="n">len</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">temp</span><span class="o">-&gt;</span><span class="n">d_lock</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pos</span><span class="p">)</span>
			<span class="n">path</span><span class="p">[</span><span class="o">--</span><span class="n">pos</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;/&#39;</span><span class="p">;</span>
		<span class="n">temp</span> <span class="o">=</span> <span class="n">temp</span><span class="o">-&gt;</span><span class="n">d_parent</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">temp</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rcu_read_unlock</span><span class="p">();</span>
			<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;build_path corrupt dentry</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">path</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">EINVAL</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">rcu_read_unlock</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pos</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">read_seqretry</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rename_lock</span><span class="p">,</span> <span class="n">seq</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;build_path did not end path lookup where &quot;</span>
		       <span class="s">&quot;expected, namelen is %d, pos is %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">pos</span><span class="p">);</span>
		<span class="cm">/* presumably this is only possible if racing with a</span>
<span class="cm">		   rename of one of the parent directories (we can not</span>
<span class="cm">		   lock the dentries above us to prevent this, but</span>
<span class="cm">		   retrying should be harmless) */</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">path</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">retry</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="o">*</span><span class="n">base</span> <span class="o">=</span> <span class="n">ceph_ino</span><span class="p">(</span><span class="n">temp</span><span class="o">-&gt;</span><span class="n">d_inode</span><span class="p">);</span>
	<span class="o">*</span><span class="n">plen</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>
	<span class="n">dout</span><span class="p">(</span><span class="s">&quot;build_path on %p %d built %llx &#39;%.*s&#39;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	     <span class="n">dentry</span><span class="p">,</span> <span class="n">dentry</span><span class="o">-&gt;</span><span class="n">d_count</span><span class="p">,</span> <span class="o">*</span><span class="n">base</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">path</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">path</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">build_dentry_path</span><span class="p">(</span><span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="n">dentry</span><span class="p">,</span>
			     <span class="k">const</span> <span class="kt">char</span> <span class="o">**</span><span class="n">ppath</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">ppathlen</span><span class="p">,</span> <span class="n">u64</span> <span class="o">*</span><span class="n">pino</span><span class="p">,</span>
			     <span class="kt">int</span> <span class="o">*</span><span class="n">pfreepath</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">path</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ceph_snap</span><span class="p">(</span><span class="n">dentry</span><span class="o">-&gt;</span><span class="n">d_parent</span><span class="o">-&gt;</span><span class="n">d_inode</span><span class="p">)</span> <span class="o">==</span> <span class="n">CEPH_NOSNAP</span><span class="p">)</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">pino</span> <span class="o">=</span> <span class="n">ceph_ino</span><span class="p">(</span><span class="n">dentry</span><span class="o">-&gt;</span><span class="n">d_parent</span><span class="o">-&gt;</span><span class="n">d_inode</span><span class="p">);</span>
		<span class="o">*</span><span class="n">ppath</span> <span class="o">=</span> <span class="n">dentry</span><span class="o">-&gt;</span><span class="n">d_name</span><span class="p">.</span><span class="n">name</span><span class="p">;</span>
		<span class="o">*</span><span class="n">ppathlen</span> <span class="o">=</span> <span class="n">dentry</span><span class="o">-&gt;</span><span class="n">d_name</span><span class="p">.</span><span class="n">len</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">path</span> <span class="o">=</span> <span class="n">ceph_mdsc_build_path</span><span class="p">(</span><span class="n">dentry</span><span class="p">,</span> <span class="n">ppathlen</span><span class="p">,</span> <span class="n">pino</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">path</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">path</span><span class="p">);</span>
	<span class="o">*</span><span class="n">ppath</span> <span class="o">=</span> <span class="n">path</span><span class="p">;</span>
	<span class="o">*</span><span class="n">pfreepath</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">build_inode_path</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span>
			    <span class="k">const</span> <span class="kt">char</span> <span class="o">**</span><span class="n">ppath</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">ppathlen</span><span class="p">,</span> <span class="n">u64</span> <span class="o">*</span><span class="n">pino</span><span class="p">,</span>
			    <span class="kt">int</span> <span class="o">*</span><span class="n">pfreepath</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="n">dentry</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">path</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ceph_snap</span><span class="p">(</span><span class="n">inode</span><span class="p">)</span> <span class="o">==</span> <span class="n">CEPH_NOSNAP</span><span class="p">)</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">pino</span> <span class="o">=</span> <span class="n">ceph_ino</span><span class="p">(</span><span class="n">inode</span><span class="p">);</span>
		<span class="o">*</span><span class="n">ppathlen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">dentry</span> <span class="o">=</span> <span class="n">d_find_alias</span><span class="p">(</span><span class="n">inode</span><span class="p">);</span>
	<span class="n">path</span> <span class="o">=</span> <span class="n">ceph_mdsc_build_path</span><span class="p">(</span><span class="n">dentry</span><span class="p">,</span> <span class="n">ppathlen</span><span class="p">,</span> <span class="n">pino</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">dput</span><span class="p">(</span><span class="n">dentry</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">path</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">path</span><span class="p">);</span>
	<span class="o">*</span><span class="n">ppath</span> <span class="o">=</span> <span class="n">path</span><span class="p">;</span>
	<span class="o">*</span><span class="n">pfreepath</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * request arguments may be specified via an inode *, a dentry *, or</span>
<span class="cm"> * an explicit ino+path.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">set_request_path_attr</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">rinode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="n">rdentry</span><span class="p">,</span>
				  <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">rpath</span><span class="p">,</span> <span class="n">u64</span> <span class="n">rino</span><span class="p">,</span>
				  <span class="k">const</span> <span class="kt">char</span> <span class="o">**</span><span class="n">ppath</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">pathlen</span><span class="p">,</span>
				  <span class="n">u64</span> <span class="o">*</span><span class="n">ino</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">freepath</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">r</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rinode</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">r</span> <span class="o">=</span> <span class="n">build_inode_path</span><span class="p">(</span><span class="n">rinode</span><span class="p">,</span> <span class="n">ppath</span><span class="p">,</span> <span class="n">pathlen</span><span class="p">,</span> <span class="n">ino</span><span class="p">,</span> <span class="n">freepath</span><span class="p">);</span>
		<span class="n">dout</span><span class="p">(</span><span class="s">&quot; inode %p %llx.%llx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rinode</span><span class="p">,</span> <span class="n">ceph_ino</span><span class="p">(</span><span class="n">rinode</span><span class="p">),</span>
		     <span class="n">ceph_snap</span><span class="p">(</span><span class="n">rinode</span><span class="p">));</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">rdentry</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">r</span> <span class="o">=</span> <span class="n">build_dentry_path</span><span class="p">(</span><span class="n">rdentry</span><span class="p">,</span> <span class="n">ppath</span><span class="p">,</span> <span class="n">pathlen</span><span class="p">,</span> <span class="n">ino</span><span class="p">,</span> <span class="n">freepath</span><span class="p">);</span>
		<span class="n">dout</span><span class="p">(</span><span class="s">&quot; dentry %p %llx/%.*s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rdentry</span><span class="p">,</span> <span class="o">*</span><span class="n">ino</span><span class="p">,</span> <span class="o">*</span><span class="n">pathlen</span><span class="p">,</span>
		     <span class="o">*</span><span class="n">ppath</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">rpath</span> <span class="o">||</span> <span class="n">rino</span><span class="p">)</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">ino</span> <span class="o">=</span> <span class="n">rino</span><span class="p">;</span>
		<span class="o">*</span><span class="n">ppath</span> <span class="o">=</span> <span class="n">rpath</span><span class="p">;</span>
		<span class="o">*</span><span class="n">pathlen</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">rpath</span><span class="p">);</span>
		<span class="n">dout</span><span class="p">(</span><span class="s">&quot; path %.*s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="o">*</span><span class="n">pathlen</span><span class="p">,</span> <span class="n">rpath</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * called under mdsc-&gt;mutex</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">ceph_msg</span> <span class="o">*</span><span class="nf">create_request_message</span><span class="p">(</span><span class="k">struct</span> <span class="n">ceph_mds_client</span> <span class="o">*</span><span class="n">mdsc</span><span class="p">,</span>
					       <span class="k">struct</span> <span class="n">ceph_mds_request</span> <span class="o">*</span><span class="n">req</span><span class="p">,</span>
					       <span class="kt">int</span> <span class="n">mds</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ceph_msg</span> <span class="o">*</span><span class="n">msg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ceph_mds_request_head</span> <span class="o">*</span><span class="n">head</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">path1</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">path2</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">ino1</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ino2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">pathlen1</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">pathlen2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">freepath1</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">freepath2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">len</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">releases</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="o">*</span><span class="n">end</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">set_request_path_attr</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">r_inode</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">r_dentry</span><span class="p">,</span>
			      <span class="n">req</span><span class="o">-&gt;</span><span class="n">r_path1</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">r_ino1</span><span class="p">.</span><span class="n">ino</span><span class="p">,</span>
			      <span class="o">&amp;</span><span class="n">path1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pathlen1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ino1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">freepath1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">msg</span> <span class="o">=</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="n">ret</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">set_request_path_attr</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">r_old_dentry</span><span class="p">,</span>
			      <span class="n">req</span><span class="o">-&gt;</span><span class="n">r_path2</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">r_ino2</span><span class="p">.</span><span class="n">ino</span><span class="p">,</span>
			      <span class="o">&amp;</span><span class="n">path2</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pathlen2</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ino2</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">freepath2</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">msg</span> <span class="o">=</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="n">ret</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_free1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">head</span><span class="p">)</span> <span class="o">+</span>
		<span class="n">pathlen1</span> <span class="o">+</span> <span class="n">pathlen2</span> <span class="o">+</span> <span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u64</span><span class="p">));</span>

	<span class="cm">/* calculate (max) length for cap releases */</span>
	<span class="n">len</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ceph_mds_request_release</span><span class="p">)</span> <span class="o">*</span>
		<span class="p">(</span><span class="o">!!</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">r_inode_drop</span> <span class="o">+</span> <span class="o">!!</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">r_dentry_drop</span> <span class="o">+</span>
		 <span class="o">!!</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">r_old_inode_drop</span> <span class="o">+</span> <span class="o">!!</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">r_old_dentry_drop</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">r_dentry_drop</span><span class="p">)</span>
		<span class="n">len</span> <span class="o">+=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">r_dentry</span><span class="o">-&gt;</span><span class="n">d_name</span><span class="p">.</span><span class="n">len</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">r_old_dentry_drop</span><span class="p">)</span>
		<span class="n">len</span> <span class="o">+=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">r_old_dentry</span><span class="o">-&gt;</span><span class="n">d_name</span><span class="p">.</span><span class="n">len</span><span class="p">;</span>

	<span class="n">msg</span> <span class="o">=</span> <span class="n">ceph_msg_new</span><span class="p">(</span><span class="n">CEPH_MSG_CLIENT_REQUEST</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">GFP_NOFS</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">msg</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">msg</span> <span class="o">=</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">ENOMEM</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_free2</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">msg</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">tid</span> <span class="o">=</span> <span class="n">cpu_to_le64</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">r_tid</span><span class="p">);</span>

	<span class="n">head</span> <span class="o">=</span> <span class="n">msg</span><span class="o">-&gt;</span><span class="n">front</span><span class="p">.</span><span class="n">iov_base</span><span class="p">;</span>
	<span class="n">p</span> <span class="o">=</span> <span class="n">msg</span><span class="o">-&gt;</span><span class="n">front</span><span class="p">.</span><span class="n">iov_base</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">head</span><span class="p">);</span>
	<span class="n">end</span> <span class="o">=</span> <span class="n">msg</span><span class="o">-&gt;</span><span class="n">front</span><span class="p">.</span><span class="n">iov_base</span> <span class="o">+</span> <span class="n">msg</span><span class="o">-&gt;</span><span class="n">front</span><span class="p">.</span><span class="n">iov_len</span><span class="p">;</span>

	<span class="n">head</span><span class="o">-&gt;</span><span class="n">mdsmap_epoch</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">mdsc</span><span class="o">-&gt;</span><span class="n">mdsmap</span><span class="o">-&gt;</span><span class="n">m_epoch</span><span class="p">);</span>
	<span class="n">head</span><span class="o">-&gt;</span><span class="n">op</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">r_op</span><span class="p">);</span>
	<span class="n">head</span><span class="o">-&gt;</span><span class="n">caller_uid</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">r_uid</span><span class="p">);</span>
	<span class="n">head</span><span class="o">-&gt;</span><span class="n">caller_gid</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">r_gid</span><span class="p">);</span>
	<span class="n">head</span><span class="o">-&gt;</span><span class="n">args</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">r_args</span><span class="p">;</span>

	<span class="n">ceph_encode_filepath</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">ino1</span><span class="p">,</span> <span class="n">path1</span><span class="p">);</span>
	<span class="n">ceph_encode_filepath</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">ino2</span><span class="p">,</span> <span class="n">path2</span><span class="p">);</span>

	<span class="cm">/* make note of release offset, in case we need to replay */</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">r_request_release_offset</span> <span class="o">=</span> <span class="n">p</span> <span class="o">-</span> <span class="n">msg</span><span class="o">-&gt;</span><span class="n">front</span><span class="p">.</span><span class="n">iov_base</span><span class="p">;</span>

	<span class="cm">/* cap releases */</span>
	<span class="n">releases</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">r_inode_drop</span><span class="p">)</span>
		<span class="n">releases</span> <span class="o">+=</span> <span class="n">ceph_encode_inode_release</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="p">,</span>
		      <span class="n">req</span><span class="o">-&gt;</span><span class="n">r_inode</span> <span class="o">?</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">r_inode</span> <span class="o">:</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">r_dentry</span><span class="o">-&gt;</span><span class="n">d_inode</span><span class="p">,</span>
		      <span class="n">mds</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">r_inode_drop</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">r_inode_unless</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">r_dentry_drop</span><span class="p">)</span>
		<span class="n">releases</span> <span class="o">+=</span> <span class="n">ceph_encode_dentry_release</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">r_dentry</span><span class="p">,</span>
		       <span class="n">mds</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">r_dentry_drop</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">r_dentry_unless</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">r_old_dentry_drop</span><span class="p">)</span>
		<span class="n">releases</span> <span class="o">+=</span> <span class="n">ceph_encode_dentry_release</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">r_old_dentry</span><span class="p">,</span>
		       <span class="n">mds</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">r_old_dentry_drop</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">r_old_dentry_unless</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">r_old_inode_drop</span><span class="p">)</span>
		<span class="n">releases</span> <span class="o">+=</span> <span class="n">ceph_encode_inode_release</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="p">,</span>
		      <span class="n">req</span><span class="o">-&gt;</span><span class="n">r_old_dentry</span><span class="o">-&gt;</span><span class="n">d_inode</span><span class="p">,</span>
		      <span class="n">mds</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">r_old_inode_drop</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">r_old_inode_unless</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">head</span><span class="o">-&gt;</span><span class="n">num_releases</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">releases</span><span class="p">);</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">p</span> <span class="o">&gt;</span> <span class="n">end</span><span class="p">);</span>
	<span class="n">msg</span><span class="o">-&gt;</span><span class="n">front</span><span class="p">.</span><span class="n">iov_len</span> <span class="o">=</span> <span class="n">p</span> <span class="o">-</span> <span class="n">msg</span><span class="o">-&gt;</span><span class="n">front</span><span class="p">.</span><span class="n">iov_base</span><span class="p">;</span>
	<span class="n">msg</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">front_len</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">front</span><span class="p">.</span><span class="n">iov_len</span><span class="p">);</span>

	<span class="n">msg</span><span class="o">-&gt;</span><span class="n">pages</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">r_pages</span><span class="p">;</span>
	<span class="n">msg</span><span class="o">-&gt;</span><span class="n">nr_pages</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">r_num_pages</span><span class="p">;</span>
	<span class="n">msg</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">data_len</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">r_data_len</span><span class="p">);</span>
	<span class="n">msg</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">data_off</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>

<span class="nl">out_free2:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">freepath2</span><span class="p">)</span>
		<span class="n">kfree</span><span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">path2</span><span class="p">);</span>
<span class="nl">out_free1:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">freepath1</span><span class="p">)</span>
		<span class="n">kfree</span><span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">path1</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">msg</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * called under mdsc-&gt;mutex if error, under no mutex if</span>
<span class="cm"> * success.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">complete_request</span><span class="p">(</span><span class="k">struct</span> <span class="n">ceph_mds_client</span> <span class="o">*</span><span class="n">mdsc</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">ceph_mds_request</span> <span class="o">*</span><span class="n">req</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">r_callback</span><span class="p">)</span>
		<span class="n">req</span><span class="o">-&gt;</span><span class="n">r_callback</span><span class="p">(</span><span class="n">mdsc</span><span class="p">,</span> <span class="n">req</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">complete_all</span><span class="p">(</span><span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">r_completion</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * called under mdsc-&gt;mutex</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">__prepare_send_request</span><span class="p">(</span><span class="k">struct</span> <span class="n">ceph_mds_client</span> <span class="o">*</span><span class="n">mdsc</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">ceph_mds_request</span> <span class="o">*</span><span class="n">req</span><span class="p">,</span>
				  <span class="kt">int</span> <span class="n">mds</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ceph_mds_request_head</span> <span class="o">*</span><span class="n">rhead</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ceph_msg</span> <span class="o">*</span><span class="n">msg</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">req</span><span class="o">-&gt;</span><span class="n">r_attempts</span><span class="o">++</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">r_inode</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">ceph_cap</span> <span class="o">*</span><span class="n">cap</span> <span class="o">=</span>
			<span class="n">ceph_get_cap_for_mds</span><span class="p">(</span><span class="n">ceph_inode</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">r_inode</span><span class="p">),</span> <span class="n">mds</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">cap</span><span class="p">)</span>
			<span class="n">req</span><span class="o">-&gt;</span><span class="n">r_sent_on_mseq</span> <span class="o">=</span> <span class="n">cap</span><span class="o">-&gt;</span><span class="n">mseq</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">req</span><span class="o">-&gt;</span><span class="n">r_sent_on_mseq</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">dout</span><span class="p">(</span><span class="s">&quot;prepare_send_request %p tid %lld %s (attempt %d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span>
	     <span class="n">req</span><span class="o">-&gt;</span><span class="n">r_tid</span><span class="p">,</span> <span class="n">ceph_mds_op_name</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">r_op</span><span class="p">),</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">r_attempts</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">r_got_unsafe</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Replay.  Do not regenerate message (and rebuild</span>
<span class="cm">		 * paths, etc.); just use the original message.</span>
<span class="cm">		 * Rebuilding paths will break for renames because</span>
<span class="cm">		 * d_move mangles the src name.</span>
<span class="cm">		 */</span>
		<span class="n">msg</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">r_request</span><span class="p">;</span>
		<span class="n">rhead</span> <span class="o">=</span> <span class="n">msg</span><span class="o">-&gt;</span><span class="n">front</span><span class="p">.</span><span class="n">iov_base</span><span class="p">;</span>

		<span class="n">flags</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">rhead</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
		<span class="n">flags</span> <span class="o">|=</span> <span class="n">CEPH_MDS_FLAG_REPLAY</span><span class="p">;</span>
		<span class="n">rhead</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">r_target_inode</span><span class="p">)</span>
			<span class="n">rhead</span><span class="o">-&gt;</span><span class="n">ino</span> <span class="o">=</span> <span class="n">cpu_to_le64</span><span class="p">(</span><span class="n">ceph_ino</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">r_target_inode</span><span class="p">));</span>

		<span class="n">rhead</span><span class="o">-&gt;</span><span class="n">num_retry</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">r_attempts</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>

		<span class="cm">/* remove cap/dentry releases from message */</span>
		<span class="n">rhead</span><span class="o">-&gt;</span><span class="n">num_releases</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">msg</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">front_len</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">r_request_release_offset</span><span class="p">);</span>
		<span class="n">msg</span><span class="o">-&gt;</span><span class="n">front</span><span class="p">.</span><span class="n">iov_len</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">r_request_release_offset</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">r_request</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ceph_msg_put</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">r_request</span><span class="p">);</span>
		<span class="n">req</span><span class="o">-&gt;</span><span class="n">r_request</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">msg</span> <span class="o">=</span> <span class="n">create_request_message</span><span class="p">(</span><span class="n">mdsc</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="n">mds</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">msg</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">req</span><span class="o">-&gt;</span><span class="n">r_err</span> <span class="o">=</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">msg</span><span class="p">);</span>
		<span class="n">complete_request</span><span class="p">(</span><span class="n">mdsc</span><span class="p">,</span> <span class="n">req</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">msg</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">r_request</span> <span class="o">=</span> <span class="n">msg</span><span class="p">;</span>

	<span class="n">rhead</span> <span class="o">=</span> <span class="n">msg</span><span class="o">-&gt;</span><span class="n">front</span><span class="p">.</span><span class="n">iov_base</span><span class="p">;</span>
	<span class="n">rhead</span><span class="o">-&gt;</span><span class="n">oldest_client_tid</span> <span class="o">=</span> <span class="n">cpu_to_le64</span><span class="p">(</span><span class="n">__get_oldest_tid</span><span class="p">(</span><span class="n">mdsc</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">r_got_unsafe</span><span class="p">)</span>
		<span class="n">flags</span> <span class="o">|=</span> <span class="n">CEPH_MDS_FLAG_REPLAY</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">r_locked_dir</span><span class="p">)</span>
		<span class="n">flags</span> <span class="o">|=</span> <span class="n">CEPH_MDS_FLAG_WANT_DENTRY</span><span class="p">;</span>
	<span class="n">rhead</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">rhead</span><span class="o">-&gt;</span><span class="n">num_fwd</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">r_num_fwd</span><span class="p">;</span>
	<span class="n">rhead</span><span class="o">-&gt;</span><span class="n">num_retry</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">r_attempts</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">rhead</span><span class="o">-&gt;</span><span class="n">ino</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">dout</span><span class="p">(</span><span class="s">&quot; r_locked_dir = %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">r_locked_dir</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * send request, or put it on the appropriate wait list.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">__do_request</span><span class="p">(</span><span class="k">struct</span> <span class="n">ceph_mds_client</span> <span class="o">*</span><span class="n">mdsc</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">ceph_mds_request</span> <span class="o">*</span><span class="n">req</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ceph_mds_session</span> <span class="o">*</span><span class="n">session</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">mds</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">r_err</span> <span class="o">||</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">r_got_result</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">r_timeout</span> <span class="o">&amp;&amp;</span>
	    <span class="n">time_after_eq</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">r_started</span> <span class="o">+</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">r_timeout</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dout</span><span class="p">(</span><span class="s">&quot;do_request timed out</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">finish</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">put_request_session</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>

	<span class="n">mds</span> <span class="o">=</span> <span class="n">__choose_mds</span><span class="p">(</span><span class="n">mdsc</span><span class="p">,</span> <span class="n">req</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mds</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span>
	    <span class="n">ceph_mdsmap_get_state</span><span class="p">(</span><span class="n">mdsc</span><span class="o">-&gt;</span><span class="n">mdsmap</span><span class="p">,</span> <span class="n">mds</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">CEPH_MDS_STATE_ACTIVE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dout</span><span class="p">(</span><span class="s">&quot;do_request no mds or not active, waiting for map</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">list_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">r_wait</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mdsc</span><span class="o">-&gt;</span><span class="n">waiting_for_map</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* get, open session */</span>
	<span class="n">session</span> <span class="o">=</span> <span class="n">__ceph_lookup_mds_session</span><span class="p">(</span><span class="n">mdsc</span><span class="p">,</span> <span class="n">mds</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">session</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">session</span> <span class="o">=</span> <span class="n">register_session</span><span class="p">(</span><span class="n">mdsc</span><span class="p">,</span> <span class="n">mds</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">session</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">session</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">finish</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">r_session</span> <span class="o">=</span> <span class="n">get_session</span><span class="p">(</span><span class="n">session</span><span class="p">);</span>

	<span class="n">dout</span><span class="p">(</span><span class="s">&quot;do_request mds%d session %p state %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">mds</span><span class="p">,</span> <span class="n">session</span><span class="p">,</span>
	     <span class="n">session_state_name</span><span class="p">(</span><span class="n">session</span><span class="o">-&gt;</span><span class="n">s_state</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">session</span><span class="o">-&gt;</span><span class="n">s_state</span> <span class="o">!=</span> <span class="n">CEPH_MDS_SESSION_OPEN</span> <span class="o">&amp;&amp;</span>
	    <span class="n">session</span><span class="o">-&gt;</span><span class="n">s_state</span> <span class="o">!=</span> <span class="n">CEPH_MDS_SESSION_HUNG</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">session</span><span class="o">-&gt;</span><span class="n">s_state</span> <span class="o">==</span> <span class="n">CEPH_MDS_SESSION_NEW</span> <span class="o">||</span>
		    <span class="n">session</span><span class="o">-&gt;</span><span class="n">s_state</span> <span class="o">==</span> <span class="n">CEPH_MDS_SESSION_CLOSING</span><span class="p">)</span>
			<span class="n">__open_session</span><span class="p">(</span><span class="n">mdsc</span><span class="p">,</span> <span class="n">session</span><span class="p">);</span>
		<span class="n">list_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">r_wait</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">session</span><span class="o">-&gt;</span><span class="n">s_waiting</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_session</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* send request */</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">r_resend_mds</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>   <span class="cm">/* forget any previous mds hint */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">r_request_started</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>   <span class="cm">/* note request start time */</span>
		<span class="n">req</span><span class="o">-&gt;</span><span class="n">r_request_started</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">__prepare_send_request</span><span class="p">(</span><span class="n">mdsc</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="n">mds</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ceph_msg_get</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">r_request</span><span class="p">);</span>
		<span class="n">ceph_con_send</span><span class="p">(</span><span class="o">&amp;</span><span class="n">session</span><span class="o">-&gt;</span><span class="n">s_con</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">r_request</span><span class="p">);</span>
	<span class="p">}</span>

<span class="nl">out_session:</span>
	<span class="n">ceph_put_mds_session</span><span class="p">(</span><span class="n">session</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

<span class="nl">finish:</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">r_err</span> <span class="o">=</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">complete_request</span><span class="p">(</span><span class="n">mdsc</span><span class="p">,</span> <span class="n">req</span><span class="p">);</span>
	<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * called under mdsc-&gt;mutex</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">__wake_requests</span><span class="p">(</span><span class="k">struct</span> <span class="n">ceph_mds_client</span> <span class="o">*</span><span class="n">mdsc</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">head</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ceph_mds_request</span> <span class="o">*</span><span class="n">req</span><span class="p">,</span> <span class="o">*</span><span class="n">nreq</span><span class="p">;</span>

	<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="n">nreq</span><span class="p">,</span> <span class="n">head</span><span class="p">,</span> <span class="n">r_wait</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">list_del_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">r_wait</span><span class="p">);</span>
		<span class="n">__do_request</span><span class="p">(</span><span class="n">mdsc</span><span class="p">,</span> <span class="n">req</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Wake up threads with requests pending for @mds, so that they can</span>
<span class="cm"> * resubmit their requests to a possibly different mds.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">kick_requests</span><span class="p">(</span><span class="k">struct</span> <span class="n">ceph_mds_client</span> <span class="o">*</span><span class="n">mdsc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mds</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ceph_mds_request</span> <span class="o">*</span><span class="n">req</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rb_node</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>

	<span class="n">dout</span><span class="p">(</span><span class="s">&quot;kick_requests mds%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">mds</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">p</span> <span class="o">=</span> <span class="n">rb_first</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdsc</span><span class="o">-&gt;</span><span class="n">request_tree</span><span class="p">);</span> <span class="n">p</span><span class="p">;</span> <span class="n">p</span> <span class="o">=</span> <span class="n">rb_next</span><span class="p">(</span><span class="n">p</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">req</span> <span class="o">=</span> <span class="n">rb_entry</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ceph_mds_request</span><span class="p">,</span> <span class="n">r_node</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">r_got_unsafe</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">r_session</span> <span class="o">&amp;&amp;</span>
		    <span class="n">req</span><span class="o">-&gt;</span><span class="n">r_session</span><span class="o">-&gt;</span><span class="n">s_mds</span> <span class="o">==</span> <span class="n">mds</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dout</span><span class="p">(</span><span class="s">&quot; kicking tid %llu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">r_tid</span><span class="p">);</span>
			<span class="n">__do_request</span><span class="p">(</span><span class="n">mdsc</span><span class="p">,</span> <span class="n">req</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">ceph_mdsc_submit_request</span><span class="p">(</span><span class="k">struct</span> <span class="n">ceph_mds_client</span> <span class="o">*</span><span class="n">mdsc</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">ceph_mds_request</span> <span class="o">*</span><span class="n">req</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dout</span><span class="p">(</span><span class="s">&quot;submit_request on %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">req</span><span class="p">);</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdsc</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="n">__register_request</span><span class="p">(</span><span class="n">mdsc</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">__do_request</span><span class="p">(</span><span class="n">mdsc</span><span class="p">,</span> <span class="n">req</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdsc</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Synchrously perform an mds request.  Take care of all of the</span>
<span class="cm"> * session setup, forwarding, retry details.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">ceph_mdsc_do_request</span><span class="p">(</span><span class="k">struct</span> <span class="n">ceph_mds_client</span> <span class="o">*</span><span class="n">mdsc</span><span class="p">,</span>
			 <span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">dir</span><span class="p">,</span>
			 <span class="k">struct</span> <span class="n">ceph_mds_request</span> <span class="o">*</span><span class="n">req</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">dout</span><span class="p">(</span><span class="s">&quot;do_request on %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">req</span><span class="p">);</span>

	<span class="cm">/* take CAP_PIN refs for r_inode, r_locked_dir, r_old_dentry */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">r_inode</span><span class="p">)</span>
		<span class="n">ceph_get_cap_refs</span><span class="p">(</span><span class="n">ceph_inode</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">r_inode</span><span class="p">),</span> <span class="n">CEPH_CAP_PIN</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">r_locked_dir</span><span class="p">)</span>
		<span class="n">ceph_get_cap_refs</span><span class="p">(</span><span class="n">ceph_inode</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">r_locked_dir</span><span class="p">),</span> <span class="n">CEPH_CAP_PIN</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">r_old_dentry</span><span class="p">)</span>
		<span class="n">ceph_get_cap_refs</span><span class="p">(</span><span class="n">ceph_inode</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">r_old_dentry_dir</span><span class="p">),</span>
				  <span class="n">CEPH_CAP_PIN</span><span class="p">);</span>

	<span class="cm">/* issue */</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdsc</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="n">__register_request</span><span class="p">(</span><span class="n">mdsc</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="n">dir</span><span class="p">);</span>
	<span class="n">__do_request</span><span class="p">(</span><span class="n">mdsc</span><span class="p">,</span> <span class="n">req</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">r_err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">r_err</span><span class="p">;</span>
		<span class="n">__unregister_request</span><span class="p">(</span><span class="n">mdsc</span><span class="p">,</span> <span class="n">req</span><span class="p">);</span>
		<span class="n">dout</span><span class="p">(</span><span class="s">&quot;do_request early error %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* wait */</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdsc</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="n">dout</span><span class="p">(</span><span class="s">&quot;do_request waiting</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">r_timeout</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="p">(</span><span class="kt">long</span><span class="p">)</span><span class="n">wait_for_completion_killable_timeout</span><span class="p">(</span>
			<span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">r_completion</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">r_timeout</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">wait_for_completion_killable</span><span class="p">(</span><span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">r_completion</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">dout</span><span class="p">(</span><span class="s">&quot;do_request waited, got %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdsc</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="cm">/* only abort if we didn&#39;t race with a real reply */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">r_got_result</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">r_reply_info</span><span class="p">.</span><span class="n">head</span><span class="o">-&gt;</span><span class="n">result</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dout</span><span class="p">(</span><span class="s">&quot;aborted request %lld with %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">r_tid</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>

		<span class="cm">/*</span>
<span class="cm">		 * ensure we aren&#39;t running concurrently with</span>
<span class="cm">		 * ceph_fill_trace or ceph_readdir_prepopulate, which</span>
<span class="cm">		 * rely on locks (dir mutex) held by our caller.</span>
<span class="cm">		 */</span>
		<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">r_fill_mutex</span><span class="p">);</span>
		<span class="n">req</span><span class="o">-&gt;</span><span class="n">r_err</span> <span class="o">=</span> <span class="n">err</span><span class="p">;</span>
		<span class="n">req</span><span class="o">-&gt;</span><span class="n">r_aborted</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">r_fill_mutex</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">r_locked_dir</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">r_op</span> <span class="o">&amp;</span> <span class="n">CEPH_MDS_OP_WRITE</span><span class="p">))</span>
			<span class="n">ceph_invalidate_dir_request</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">r_err</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">out:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdsc</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="n">dout</span><span class="p">(</span><span class="s">&quot;do_request %p done, result %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Invalidate dir D_COMPLETE, dentry lease state on an aborted MDS</span>
<span class="cm"> * namespace request.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">ceph_invalidate_dir_request</span><span class="p">(</span><span class="k">struct</span> <span class="n">ceph_mds_request</span> <span class="o">*</span><span class="n">req</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">r_locked_dir</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ceph_inode_info</span> <span class="o">*</span><span class="n">ci</span> <span class="o">=</span> <span class="n">ceph_inode</span><span class="p">(</span><span class="n">inode</span><span class="p">);</span>

	<span class="n">dout</span><span class="p">(</span><span class="s">&quot;invalidate_dir_request %p (D_COMPLETE, lease(s))</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">inode</span><span class="p">);</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ci</span><span class="o">-&gt;</span><span class="n">i_ceph_lock</span><span class="p">);</span>
	<span class="n">ceph_dir_clear_complete</span><span class="p">(</span><span class="n">inode</span><span class="p">);</span>
	<span class="n">ci</span><span class="o">-&gt;</span><span class="n">i_release_count</span><span class="o">++</span><span class="p">;</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ci</span><span class="o">-&gt;</span><span class="n">i_ceph_lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">r_dentry</span><span class="p">)</span>
		<span class="n">ceph_invalidate_dentry_lease</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">r_dentry</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">r_old_dentry</span><span class="p">)</span>
		<span class="n">ceph_invalidate_dentry_lease</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">r_old_dentry</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Handle mds reply.</span>
<span class="cm"> *</span>
<span class="cm"> * We take the session mutex and parse and process the reply immediately.</span>
<span class="cm"> * This preserves the logical ordering of replies, capabilities, etc., sent</span>
<span class="cm"> * by the MDS as they are applied to our local cache.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">handle_reply</span><span class="p">(</span><span class="k">struct</span> <span class="n">ceph_mds_session</span> <span class="o">*</span><span class="n">session</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ceph_msg</span> <span class="o">*</span><span class="n">msg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ceph_mds_client</span> <span class="o">*</span><span class="n">mdsc</span> <span class="o">=</span> <span class="n">session</span><span class="o">-&gt;</span><span class="n">s_mdsc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ceph_mds_request</span> <span class="o">*</span><span class="n">req</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ceph_mds_reply_head</span> <span class="o">*</span><span class="n">head</span> <span class="o">=</span> <span class="n">msg</span><span class="o">-&gt;</span><span class="n">front</span><span class="p">.</span><span class="n">iov_base</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ceph_mds_reply_info_parsed</span> <span class="o">*</span><span class="n">rinfo</span><span class="p">;</span>  <span class="cm">/* parsed reply info */</span>
	<span class="n">u64</span> <span class="n">tid</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">,</span> <span class="n">result</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">mds</span> <span class="o">=</span> <span class="n">session</span><span class="o">-&gt;</span><span class="n">s_mds</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">front</span><span class="p">.</span><span class="n">iov_len</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">head</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;mdsc_handle_reply got corrupt (short) reply</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ceph_msg_dump</span><span class="p">(</span><span class="n">msg</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* get request, session */</span>
	<span class="n">tid</span> <span class="o">=</span> <span class="n">le64_to_cpu</span><span class="p">(</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">tid</span><span class="p">);</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdsc</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="n">req</span> <span class="o">=</span> <span class="n">__lookup_request</span><span class="p">(</span><span class="n">mdsc</span><span class="p">,</span> <span class="n">tid</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">req</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dout</span><span class="p">(</span><span class="s">&quot;handle_reply on unknown tid %llu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tid</span><span class="p">);</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdsc</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">dout</span><span class="p">(</span><span class="s">&quot;handle_reply %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">req</span><span class="p">);</span>

	<span class="cm">/* correct session? */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">r_session</span> <span class="o">!=</span> <span class="n">session</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;mdsc_handle_reply got %llu on session mds%d&quot;</span>
		       <span class="s">&quot; not mds%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tid</span><span class="p">,</span> <span class="n">session</span><span class="o">-&gt;</span><span class="n">s_mds</span><span class="p">,</span>
		       <span class="n">req</span><span class="o">-&gt;</span><span class="n">r_session</span> <span class="o">?</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">r_session</span><span class="o">-&gt;</span><span class="n">s_mds</span> <span class="o">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdsc</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* dup? */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">r_got_unsafe</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">head</span><span class="o">-&gt;</span><span class="n">safe</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">r_got_safe</span> <span class="o">&amp;&amp;</span> <span class="n">head</span><span class="o">-&gt;</span><span class="n">safe</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pr_warning</span><span class="p">(</span><span class="s">&quot;got a dup %s reply on %llu from mds%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">head</span><span class="o">-&gt;</span><span class="n">safe</span> <span class="o">?</span> <span class="s">&quot;safe&quot;</span> <span class="o">:</span> <span class="s">&quot;unsafe&quot;</span><span class="p">,</span> <span class="n">tid</span><span class="p">,</span> <span class="n">mds</span><span class="p">);</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdsc</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">r_got_safe</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">head</span><span class="o">-&gt;</span><span class="n">safe</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_warning</span><span class="p">(</span><span class="s">&quot;got unsafe after safe on %llu from mds%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">tid</span><span class="p">,</span> <span class="n">mds</span><span class="p">);</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdsc</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">result</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">head</span><span class="o">-&gt;</span><span class="n">result</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Handle an ESTALE</span>
<span class="cm">	 * if we&#39;re not talking to the authority, send to them</span>
<span class="cm">	 * if the authority has changed while we weren&#39;t looking,</span>
<span class="cm">	 * send to new authority</span>
<span class="cm">	 * Otherwise we just have to return an ESTALE</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">==</span> <span class="o">-</span><span class="n">ESTALE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dout</span><span class="p">(</span><span class="s">&quot;got ESTALE on request %llu&quot;</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">r_tid</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">r_inode</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* do nothing; not an authority problem */</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">r_direct_mode</span> <span class="o">!=</span> <span class="n">USE_AUTH_MDS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dout</span><span class="p">(</span><span class="s">&quot;not using auth, setting for that now&quot;</span><span class="p">);</span>
			<span class="n">req</span><span class="o">-&gt;</span><span class="n">r_direct_mode</span> <span class="o">=</span> <span class="n">USE_AUTH_MDS</span><span class="p">;</span>
			<span class="n">__do_request</span><span class="p">(</span><span class="n">mdsc</span><span class="p">,</span> <span class="n">req</span><span class="p">);</span>
			<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdsc</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>  <span class="p">{</span>
			<span class="k">struct</span> <span class="n">ceph_inode_info</span> <span class="o">*</span><span class="n">ci</span> <span class="o">=</span> <span class="n">ceph_inode</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">r_inode</span><span class="p">);</span>
			<span class="k">struct</span> <span class="n">ceph_cap</span> <span class="o">*</span><span class="n">cap</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">r_session</span><span class="p">)</span>
				<span class="n">cap</span> <span class="o">=</span> <span class="n">ceph_get_cap_for_mds</span><span class="p">(</span><span class="n">ci</span><span class="p">,</span>
						   <span class="n">req</span><span class="o">-&gt;</span><span class="n">r_session</span><span class="o">-&gt;</span><span class="n">s_mds</span><span class="p">);</span>

			<span class="n">dout</span><span class="p">(</span><span class="s">&quot;already using auth&quot;</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">((</span><span class="o">!</span><span class="n">cap</span> <span class="o">||</span> <span class="n">cap</span> <span class="o">!=</span> <span class="n">ci</span><span class="o">-&gt;</span><span class="n">i_auth_cap</span><span class="p">)</span> <span class="o">||</span>
			    <span class="p">(</span><span class="n">cap</span><span class="o">-&gt;</span><span class="n">mseq</span> <span class="o">!=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">r_sent_on_mseq</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">dout</span><span class="p">(</span><span class="s">&quot;but cap changed, so resending&quot;</span><span class="p">);</span>
				<span class="n">__do_request</span><span class="p">(</span><span class="n">mdsc</span><span class="p">,</span> <span class="n">req</span><span class="p">);</span>
				<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdsc</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">dout</span><span class="p">(</span><span class="s">&quot;have to return ESTALE on request %llu&quot;</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">r_tid</span><span class="p">);</span>
	<span class="p">}</span>


	<span class="k">if</span> <span class="p">(</span><span class="n">head</span><span class="o">-&gt;</span><span class="n">safe</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">req</span><span class="o">-&gt;</span><span class="n">r_got_safe</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="n">__unregister_request</span><span class="p">(</span><span class="n">mdsc</span><span class="p">,</span> <span class="n">req</span><span class="p">);</span>
		<span class="n">complete_all</span><span class="p">(</span><span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">r_safe_completion</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">r_got_unsafe</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * We already handled the unsafe response, now do the</span>
<span class="cm">			 * cleanup.  No need to examine the response; the MDS</span>
<span class="cm">			 * doesn&#39;t include any result info in the safe</span>
<span class="cm">			 * response.  And even if it did, there is nothing</span>
<span class="cm">			 * useful we could do with a revised return value.</span>
<span class="cm">			 */</span>
			<span class="n">dout</span><span class="p">(</span><span class="s">&quot;got safe reply %llu, mds%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tid</span><span class="p">,</span> <span class="n">mds</span><span class="p">);</span>
			<span class="n">list_del_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">r_unsafe_item</span><span class="p">);</span>

			<span class="cm">/* last unsafe request during umount? */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">mdsc</span><span class="o">-&gt;</span><span class="n">stopping</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">__get_oldest_req</span><span class="p">(</span><span class="n">mdsc</span><span class="p">))</span>
				<span class="n">complete_all</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdsc</span><span class="o">-&gt;</span><span class="n">safe_umount_waiters</span><span class="p">);</span>
			<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdsc</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">req</span><span class="o">-&gt;</span><span class="n">r_got_unsafe</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">r_unsafe_item</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">r_session</span><span class="o">-&gt;</span><span class="n">s_unsafe</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">dout</span><span class="p">(</span><span class="s">&quot;handle_reply tid %lld result %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tid</span><span class="p">,</span> <span class="n">result</span><span class="p">);</span>
	<span class="n">rinfo</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">r_reply_info</span><span class="p">;</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">parse_reply_info</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">rinfo</span><span class="p">,</span> <span class="n">session</span><span class="o">-&gt;</span><span class="n">s_con</span><span class="p">.</span><span class="n">peer_features</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdsc</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">session</span><span class="o">-&gt;</span><span class="n">s_mutex</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;mdsc_handle_reply got corrupt reply mds%d(tid:%lld)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">mds</span><span class="p">,</span> <span class="n">tid</span><span class="p">);</span>
		<span class="n">ceph_msg_dump</span><span class="p">(</span><span class="n">msg</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* snap trace */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">snapblob_len</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">down_write</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdsc</span><span class="o">-&gt;</span><span class="n">snap_rwsem</span><span class="p">);</span>
		<span class="n">ceph_update_snap_trace</span><span class="p">(</span><span class="n">mdsc</span><span class="p">,</span> <span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">snapblob</span><span class="p">,</span>
			       <span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">snapblob</span> <span class="o">+</span> <span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">snapblob_len</span><span class="p">,</span>
			       <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">head</span><span class="o">-&gt;</span><span class="n">op</span><span class="p">)</span> <span class="o">==</span> <span class="n">CEPH_MDS_OP_RMSNAP</span><span class="p">);</span>
		<span class="n">downgrade_write</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdsc</span><span class="o">-&gt;</span><span class="n">snap_rwsem</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">down_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdsc</span><span class="o">-&gt;</span><span class="n">snap_rwsem</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* insert trace into our cache */</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">r_fill_mutex</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">ceph_fill_trace</span><span class="p">(</span><span class="n">mdsc</span><span class="o">-&gt;</span><span class="n">fsc</span><span class="o">-&gt;</span><span class="n">sb</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">r_session</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">r_op</span> <span class="o">!=</span> <span class="n">CEPH_MDS_OP_GETFILELOCK</span> <span class="o">&amp;&amp;</span>
		    <span class="n">rinfo</span><span class="o">-&gt;</span><span class="n">dir_nr</span><span class="p">)</span>
			<span class="n">ceph_readdir_prepopulate</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">r_session</span><span class="p">);</span>
		<span class="n">ceph_unreserve_caps</span><span class="p">(</span><span class="n">mdsc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">r_caps_reservation</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">r_fill_mutex</span><span class="p">);</span>

	<span class="n">up_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdsc</span><span class="o">-&gt;</span><span class="n">snap_rwsem</span><span class="p">);</span>
<span class="nl">out_err:</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdsc</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">r_aborted</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">req</span><span class="o">-&gt;</span><span class="n">r_err</span> <span class="o">=</span> <span class="n">err</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">req</span><span class="o">-&gt;</span><span class="n">r_reply</span> <span class="o">=</span> <span class="n">msg</span><span class="p">;</span>
			<span class="n">ceph_msg_get</span><span class="p">(</span><span class="n">msg</span><span class="p">);</span>
			<span class="n">req</span><span class="o">-&gt;</span><span class="n">r_got_result</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">dout</span><span class="p">(</span><span class="s">&quot;reply arrived after request %lld was aborted</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tid</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdsc</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="n">ceph_add_cap_releases</span><span class="p">(</span><span class="n">mdsc</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">r_session</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">session</span><span class="o">-&gt;</span><span class="n">s_mutex</span><span class="p">);</span>

	<span class="cm">/* kick calling process */</span>
	<span class="n">complete_request</span><span class="p">(</span><span class="n">mdsc</span><span class="p">,</span> <span class="n">req</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="n">ceph_mdsc_put_request</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>



<span class="cm">/*</span>
<span class="cm"> * handle mds notification that our request has been forwarded.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">handle_forward</span><span class="p">(</span><span class="k">struct</span> <span class="n">ceph_mds_client</span> <span class="o">*</span><span class="n">mdsc</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">ceph_mds_session</span> <span class="o">*</span><span class="n">session</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">ceph_msg</span> <span class="o">*</span><span class="n">msg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ceph_mds_request</span> <span class="o">*</span><span class="n">req</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">tid</span> <span class="o">=</span> <span class="n">le64_to_cpu</span><span class="p">(</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">tid</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">next_mds</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">fwd_seq</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">msg</span><span class="o">-&gt;</span><span class="n">front</span><span class="p">.</span><span class="n">iov_base</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">end</span> <span class="o">=</span> <span class="n">p</span> <span class="o">+</span> <span class="n">msg</span><span class="o">-&gt;</span><span class="n">front</span><span class="p">.</span><span class="n">iov_len</span><span class="p">;</span>

	<span class="n">ceph_decode_need</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">),</span> <span class="n">bad</span><span class="p">);</span>
	<span class="n">next_mds</span> <span class="o">=</span> <span class="n">ceph_decode_32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="p">);</span>
	<span class="n">fwd_seq</span> <span class="o">=</span> <span class="n">ceph_decode_32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="p">);</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdsc</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="n">req</span> <span class="o">=</span> <span class="n">__lookup_request</span><span class="p">(</span><span class="n">mdsc</span><span class="p">,</span> <span class="n">tid</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">req</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dout</span><span class="p">(</span><span class="s">&quot;forward tid %llu to mds%d - req dne</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tid</span><span class="p">,</span> <span class="n">next_mds</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>  <span class="cm">/* dup reply? */</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">r_aborted</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dout</span><span class="p">(</span><span class="s">&quot;forward tid %llu aborted, unregistering</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tid</span><span class="p">);</span>
		<span class="n">__unregister_request</span><span class="p">(</span><span class="n">mdsc</span><span class="p">,</span> <span class="n">req</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">fwd_seq</span> <span class="o">&lt;=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">r_num_fwd</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dout</span><span class="p">(</span><span class="s">&quot;forward tid %llu to mds%d - old seq %d &lt;= %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		     <span class="n">tid</span><span class="p">,</span> <span class="n">next_mds</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">r_num_fwd</span><span class="p">,</span> <span class="n">fwd_seq</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* resend. forward race not possible; mds would drop */</span>
		<span class="n">dout</span><span class="p">(</span><span class="s">&quot;forward tid %llu to mds%d (we resend)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tid</span><span class="p">,</span> <span class="n">next_mds</span><span class="p">);</span>
		<span class="n">BUG_ON</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">r_err</span><span class="p">);</span>
		<span class="n">BUG_ON</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">r_got_result</span><span class="p">);</span>
		<span class="n">req</span><span class="o">-&gt;</span><span class="n">r_num_fwd</span> <span class="o">=</span> <span class="n">fwd_seq</span><span class="p">;</span>
		<span class="n">req</span><span class="o">-&gt;</span><span class="n">r_resend_mds</span> <span class="o">=</span> <span class="n">next_mds</span><span class="p">;</span>
		<span class="n">put_request_session</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>
		<span class="n">__do_request</span><span class="p">(</span><span class="n">mdsc</span><span class="p">,</span> <span class="n">req</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">ceph_mdsc_put_request</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdsc</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="k">return</span><span class="p">;</span>

<span class="nl">bad:</span>
	<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;mdsc_handle_forward decode error err=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * handle a mds session control message</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">handle_session</span><span class="p">(</span><span class="k">struct</span> <span class="n">ceph_mds_session</span> <span class="o">*</span><span class="n">session</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">ceph_msg</span> <span class="o">*</span><span class="n">msg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ceph_mds_client</span> <span class="o">*</span><span class="n">mdsc</span> <span class="o">=</span> <span class="n">session</span><span class="o">-&gt;</span><span class="n">s_mdsc</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">op</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">seq</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">mds</span> <span class="o">=</span> <span class="n">session</span><span class="o">-&gt;</span><span class="n">s_mds</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ceph_mds_session_head</span> <span class="o">*</span><span class="n">h</span> <span class="o">=</span> <span class="n">msg</span><span class="o">-&gt;</span><span class="n">front</span><span class="p">.</span><span class="n">iov_base</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">wake</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* decode */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">front</span><span class="p">.</span><span class="n">iov_len</span> <span class="o">!=</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">h</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">bad</span><span class="p">;</span>
	<span class="n">op</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">op</span><span class="p">);</span>
	<span class="n">seq</span> <span class="o">=</span> <span class="n">le64_to_cpu</span><span class="p">(</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">seq</span><span class="p">);</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdsc</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">op</span> <span class="o">==</span> <span class="n">CEPH_SESSION_CLOSE</span><span class="p">)</span>
		<span class="n">__unregister_session</span><span class="p">(</span><span class="n">mdsc</span><span class="p">,</span> <span class="n">session</span><span class="p">);</span>
	<span class="cm">/* FIXME: this ttl calculation is generous */</span>
	<span class="n">session</span><span class="o">-&gt;</span><span class="n">s_ttl</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">HZ</span><span class="o">*</span><span class="n">mdsc</span><span class="o">-&gt;</span><span class="n">mdsmap</span><span class="o">-&gt;</span><span class="n">m_session_autoclose</span><span class="p">;</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdsc</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">session</span><span class="o">-&gt;</span><span class="n">s_mutex</span><span class="p">);</span>

	<span class="n">dout</span><span class="p">(</span><span class="s">&quot;handle_session mds%d %s %p state %s seq %llu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	     <span class="n">mds</span><span class="p">,</span> <span class="n">ceph_session_op_name</span><span class="p">(</span><span class="n">op</span><span class="p">),</span> <span class="n">session</span><span class="p">,</span>
	     <span class="n">session_state_name</span><span class="p">(</span><span class="n">session</span><span class="o">-&gt;</span><span class="n">s_state</span><span class="p">),</span> <span class="n">seq</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">session</span><span class="o">-&gt;</span><span class="n">s_state</span> <span class="o">==</span> <span class="n">CEPH_MDS_SESSION_HUNG</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">session</span><span class="o">-&gt;</span><span class="n">s_state</span> <span class="o">=</span> <span class="n">CEPH_MDS_SESSION_OPEN</span><span class="p">;</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;mds%d came back</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">session</span><span class="o">-&gt;</span><span class="n">s_mds</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">op</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">CEPH_SESSION_OPEN</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">session</span><span class="o">-&gt;</span><span class="n">s_state</span> <span class="o">==</span> <span class="n">CEPH_MDS_SESSION_RECONNECTING</span><span class="p">)</span>
			<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;mds%d reconnect success</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">session</span><span class="o">-&gt;</span><span class="n">s_mds</span><span class="p">);</span>
		<span class="n">session</span><span class="o">-&gt;</span><span class="n">s_state</span> <span class="o">=</span> <span class="n">CEPH_MDS_SESSION_OPEN</span><span class="p">;</span>
		<span class="n">renewed_caps</span><span class="p">(</span><span class="n">mdsc</span><span class="p">,</span> <span class="n">session</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">wake</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mdsc</span><span class="o">-&gt;</span><span class="n">stopping</span><span class="p">)</span>
			<span class="n">__close_session</span><span class="p">(</span><span class="n">mdsc</span><span class="p">,</span> <span class="n">session</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">CEPH_SESSION_RENEWCAPS</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">session</span><span class="o">-&gt;</span><span class="n">s_renew_seq</span> <span class="o">==</span> <span class="n">seq</span><span class="p">)</span>
			<span class="n">renewed_caps</span><span class="p">(</span><span class="n">mdsc</span><span class="p">,</span> <span class="n">session</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">CEPH_SESSION_CLOSE</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">session</span><span class="o">-&gt;</span><span class="n">s_state</span> <span class="o">==</span> <span class="n">CEPH_MDS_SESSION_RECONNECTING</span><span class="p">)</span>
			<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;mds%d reconnect denied</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">session</span><span class="o">-&gt;</span><span class="n">s_mds</span><span class="p">);</span>
		<span class="n">remove_session_caps</span><span class="p">(</span><span class="n">session</span><span class="p">);</span>
		<span class="n">wake</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="cm">/* for good measure */</span>
		<span class="n">wake_up_all</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdsc</span><span class="o">-&gt;</span><span class="n">session_close_wq</span><span class="p">);</span>
		<span class="n">kick_requests</span><span class="p">(</span><span class="n">mdsc</span><span class="p">,</span> <span class="n">mds</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">CEPH_SESSION_STALE</span>:
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;mds%d caps went stale, renewing</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">session</span><span class="o">-&gt;</span><span class="n">s_mds</span><span class="p">);</span>
		<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">session</span><span class="o">-&gt;</span><span class="n">s_gen_ttl_lock</span><span class="p">);</span>
		<span class="n">session</span><span class="o">-&gt;</span><span class="n">s_cap_gen</span><span class="o">++</span><span class="p">;</span>
		<span class="n">session</span><span class="o">-&gt;</span><span class="n">s_cap_ttl</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">session</span><span class="o">-&gt;</span><span class="n">s_gen_ttl_lock</span><span class="p">);</span>
		<span class="n">send_renew_caps</span><span class="p">(</span><span class="n">mdsc</span><span class="p">,</span> <span class="n">session</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">CEPH_SESSION_RECALL_STATE</span>:
		<span class="n">trim_caps</span><span class="p">(</span><span class="n">mdsc</span><span class="p">,</span> <span class="n">session</span><span class="p">,</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">max_caps</span><span class="p">));</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;mdsc_handle_session bad op %d mds%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">op</span><span class="p">,</span> <span class="n">mds</span><span class="p">);</span>
		<span class="n">WARN_ON</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">session</span><span class="o">-&gt;</span><span class="n">s_mutex</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wake</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdsc</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
		<span class="n">__wake_requests</span><span class="p">(</span><span class="n">mdsc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">session</span><span class="o">-&gt;</span><span class="n">s_waiting</span><span class="p">);</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdsc</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span><span class="p">;</span>

<span class="nl">bad:</span>
	<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;mdsc_handle_session corrupt message mds%d len %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">mds</span><span class="p">,</span>
	       <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">front</span><span class="p">.</span><span class="n">iov_len</span><span class="p">);</span>
	<span class="n">ceph_msg_dump</span><span class="p">(</span><span class="n">msg</span><span class="p">);</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * called under session-&gt;mutex.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">replay_unsafe_requests</span><span class="p">(</span><span class="k">struct</span> <span class="n">ceph_mds_client</span> <span class="o">*</span><span class="n">mdsc</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">ceph_mds_session</span> <span class="o">*</span><span class="n">session</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ceph_mds_request</span> <span class="o">*</span><span class="n">req</span><span class="p">,</span> <span class="o">*</span><span class="n">nreq</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">dout</span><span class="p">(</span><span class="s">&quot;replay_unsafe_requests mds%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">session</span><span class="o">-&gt;</span><span class="n">s_mds</span><span class="p">);</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdsc</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="n">nreq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">session</span><span class="o">-&gt;</span><span class="n">s_unsafe</span><span class="p">,</span> <span class="n">r_unsafe_item</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">__prepare_send_request</span><span class="p">(</span><span class="n">mdsc</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="n">session</span><span class="o">-&gt;</span><span class="n">s_mds</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ceph_msg_get</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">r_request</span><span class="p">);</span>
			<span class="n">ceph_con_send</span><span class="p">(</span><span class="o">&amp;</span><span class="n">session</span><span class="o">-&gt;</span><span class="n">s_con</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">r_request</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdsc</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Encode information about a cap for a reconnect with the MDS.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">encode_caps_cb</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ceph_cap</span> <span class="o">*</span><span class="n">cap</span><span class="p">,</span>
			  <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">union</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">ceph_mds_cap_reconnect</span> <span class="n">v2</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">ceph_mds_cap_reconnect_v1</span> <span class="n">v1</span><span class="p">;</span>
	<span class="p">}</span> <span class="n">rec</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">reclen</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ceph_inode_info</span> <span class="o">*</span><span class="n">ci</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ceph_reconnect_state</span> <span class="o">*</span><span class="n">recon_state</span> <span class="o">=</span> <span class="n">arg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ceph_pagelist</span> <span class="o">*</span><span class="n">pagelist</span> <span class="o">=</span> <span class="n">recon_state</span><span class="o">-&gt;</span><span class="n">pagelist</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">path</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">pathlen</span><span class="p">,</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">pathbase</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="n">dentry</span><span class="p">;</span>

	<span class="n">ci</span> <span class="o">=</span> <span class="n">cap</span><span class="o">-&gt;</span><span class="n">ci</span><span class="p">;</span>

	<span class="n">dout</span><span class="p">(</span><span class="s">&quot; adding %p ino %llx.%llx cap %p %lld %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	     <span class="n">inode</span><span class="p">,</span> <span class="n">ceph_vinop</span><span class="p">(</span><span class="n">inode</span><span class="p">),</span> <span class="n">cap</span><span class="p">,</span> <span class="n">cap</span><span class="o">-&gt;</span><span class="n">cap_id</span><span class="p">,</span>
	     <span class="n">ceph_cap_string</span><span class="p">(</span><span class="n">cap</span><span class="o">-&gt;</span><span class="n">issued</span><span class="p">));</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">ceph_pagelist_encode_64</span><span class="p">(</span><span class="n">pagelist</span><span class="p">,</span> <span class="n">ceph_ino</span><span class="p">(</span><span class="n">inode</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">dentry</span> <span class="o">=</span> <span class="n">d_find_alias</span><span class="p">(</span><span class="n">inode</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dentry</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">path</span> <span class="o">=</span> <span class="n">ceph_mdsc_build_path</span><span class="p">(</span><span class="n">dentry</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pathlen</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pathbase</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">path</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">path</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">out_dput</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">path</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">pathlen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">ceph_pagelist_encode_string</span><span class="p">(</span><span class="n">pagelist</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">pathlen</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_free</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ci</span><span class="o">-&gt;</span><span class="n">i_ceph_lock</span><span class="p">);</span>
	<span class="n">cap</span><span class="o">-&gt;</span><span class="n">seq</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>        <span class="cm">/* reset cap seq */</span>
	<span class="n">cap</span><span class="o">-&gt;</span><span class="n">issue_seq</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>  <span class="cm">/* and issue_seq */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">recon_state</span><span class="o">-&gt;</span><span class="n">flock</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rec</span><span class="p">.</span><span class="n">v2</span><span class="p">.</span><span class="n">cap_id</span> <span class="o">=</span> <span class="n">cpu_to_le64</span><span class="p">(</span><span class="n">cap</span><span class="o">-&gt;</span><span class="n">cap_id</span><span class="p">);</span>
		<span class="n">rec</span><span class="p">.</span><span class="n">v2</span><span class="p">.</span><span class="n">wanted</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">__ceph_caps_wanted</span><span class="p">(</span><span class="n">ci</span><span class="p">));</span>
		<span class="n">rec</span><span class="p">.</span><span class="n">v2</span><span class="p">.</span><span class="n">issued</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">cap</span><span class="o">-&gt;</span><span class="n">issued</span><span class="p">);</span>
		<span class="n">rec</span><span class="p">.</span><span class="n">v2</span><span class="p">.</span><span class="n">snaprealm</span> <span class="o">=</span> <span class="n">cpu_to_le64</span><span class="p">(</span><span class="n">ci</span><span class="o">-&gt;</span><span class="n">i_snap_realm</span><span class="o">-&gt;</span><span class="n">ino</span><span class="p">);</span>
		<span class="n">rec</span><span class="p">.</span><span class="n">v2</span><span class="p">.</span><span class="n">pathbase</span> <span class="o">=</span> <span class="n">cpu_to_le64</span><span class="p">(</span><span class="n">pathbase</span><span class="p">);</span>
		<span class="n">rec</span><span class="p">.</span><span class="n">v2</span><span class="p">.</span><span class="n">flock_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">reclen</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">rec</span><span class="p">.</span><span class="n">v2</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">rec</span><span class="p">.</span><span class="n">v1</span><span class="p">.</span><span class="n">cap_id</span> <span class="o">=</span> <span class="n">cpu_to_le64</span><span class="p">(</span><span class="n">cap</span><span class="o">-&gt;</span><span class="n">cap_id</span><span class="p">);</span>
		<span class="n">rec</span><span class="p">.</span><span class="n">v1</span><span class="p">.</span><span class="n">wanted</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">__ceph_caps_wanted</span><span class="p">(</span><span class="n">ci</span><span class="p">));</span>
		<span class="n">rec</span><span class="p">.</span><span class="n">v1</span><span class="p">.</span><span class="n">issued</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">cap</span><span class="o">-&gt;</span><span class="n">issued</span><span class="p">);</span>
		<span class="n">rec</span><span class="p">.</span><span class="n">v1</span><span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="n">cpu_to_le64</span><span class="p">(</span><span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_size</span><span class="p">);</span>
		<span class="n">ceph_encode_timespec</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rec</span><span class="p">.</span><span class="n">v1</span><span class="p">.</span><span class="n">mtime</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_mtime</span><span class="p">);</span>
		<span class="n">ceph_encode_timespec</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rec</span><span class="p">.</span><span class="n">v1</span><span class="p">.</span><span class="n">atime</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_atime</span><span class="p">);</span>
		<span class="n">rec</span><span class="p">.</span><span class="n">v1</span><span class="p">.</span><span class="n">snaprealm</span> <span class="o">=</span> <span class="n">cpu_to_le64</span><span class="p">(</span><span class="n">ci</span><span class="o">-&gt;</span><span class="n">i_snap_realm</span><span class="o">-&gt;</span><span class="n">ino</span><span class="p">);</span>
		<span class="n">rec</span><span class="p">.</span><span class="n">v1</span><span class="p">.</span><span class="n">pathbase</span> <span class="o">=</span> <span class="n">cpu_to_le64</span><span class="p">(</span><span class="n">pathbase</span><span class="p">);</span>
		<span class="n">reclen</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">rec</span><span class="p">.</span><span class="n">v1</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ci</span><span class="o">-&gt;</span><span class="n">i_ceph_lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">recon_state</span><span class="o">-&gt;</span><span class="n">flock</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">num_fcntl_locks</span><span class="p">,</span> <span class="n">num_flock_locks</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">ceph_pagelist_cursor</span> <span class="n">trunc_point</span><span class="p">;</span>

		<span class="n">ceph_pagelist_set_cursor</span><span class="p">(</span><span class="n">pagelist</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">trunc_point</span><span class="p">);</span>
		<span class="k">do</span> <span class="p">{</span>
			<span class="n">lock_flocks</span><span class="p">();</span>
			<span class="n">ceph_count_locks</span><span class="p">(</span><span class="n">inode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">num_fcntl_locks</span><span class="p">,</span>
					 <span class="o">&amp;</span><span class="n">num_flock_locks</span><span class="p">);</span>
			<span class="n">rec</span><span class="p">.</span><span class="n">v2</span><span class="p">.</span><span class="n">flock_len</span> <span class="o">=</span> <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="o">+</span>
					    <span class="p">(</span><span class="n">num_fcntl_locks</span><span class="o">+</span><span class="n">num_flock_locks</span><span class="p">)</span> <span class="o">*</span>
					    <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ceph_filelock</span><span class="p">));</span>
			<span class="n">unlock_flocks</span><span class="p">();</span>

			<span class="cm">/* pre-alloc pagelist */</span>
			<span class="n">ceph_pagelist_truncate</span><span class="p">(</span><span class="n">pagelist</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">trunc_point</span><span class="p">);</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">ceph_pagelist_append</span><span class="p">(</span><span class="n">pagelist</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rec</span><span class="p">,</span> <span class="n">reclen</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span><span class="p">)</span>
				<span class="n">err</span> <span class="o">=</span> <span class="n">ceph_pagelist_reserve</span><span class="p">(</span><span class="n">pagelist</span><span class="p">,</span>
							    <span class="n">rec</span><span class="p">.</span><span class="n">v2</span><span class="p">.</span><span class="n">flock_len</span><span class="p">);</span>

			<span class="cm">/* encode locks */</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">lock_flocks</span><span class="p">();</span>
				<span class="n">err</span> <span class="o">=</span> <span class="n">ceph_encode_locks</span><span class="p">(</span><span class="n">inode</span><span class="p">,</span>
							<span class="n">pagelist</span><span class="p">,</span>
							<span class="n">num_fcntl_locks</span><span class="p">,</span>
							<span class="n">num_flock_locks</span><span class="p">);</span>
				<span class="n">unlock_flocks</span><span class="p">();</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">err</span> <span class="o">==</span> <span class="o">-</span><span class="n">ENOSPC</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">ceph_pagelist_append</span><span class="p">(</span><span class="n">pagelist</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rec</span><span class="p">,</span> <span class="n">reclen</span><span class="p">);</span>
	<span class="p">}</span>

<span class="nl">out_free:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">path</span><span class="p">);</span>
<span class="nl">out_dput:</span>
	<span class="n">dput</span><span class="p">(</span><span class="n">dentry</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * If an MDS fails and recovers, clients need to reconnect in order to</span>
<span class="cm"> * reestablish shared state.  This includes all caps issued through</span>
<span class="cm"> * this session _and_ the snap_realm hierarchy.  Because it&#39;s not</span>
<span class="cm"> * clear which snap realms the mds cares about, we send everything we</span>
<span class="cm"> * know about.. that ensures we&#39;ll then get any new info the</span>
<span class="cm"> * recovering MDS might have.</span>
<span class="cm"> *</span>
<span class="cm"> * This is a relatively heavyweight operation, but it&#39;s rare.</span>
<span class="cm"> *</span>
<span class="cm"> * called with mdsc-&gt;mutex held.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">send_mds_reconnect</span><span class="p">(</span><span class="k">struct</span> <span class="n">ceph_mds_client</span> <span class="o">*</span><span class="n">mdsc</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">ceph_mds_session</span> <span class="o">*</span><span class="n">session</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ceph_msg</span> <span class="o">*</span><span class="n">reply</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rb_node</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">mds</span> <span class="o">=</span> <span class="n">session</span><span class="o">-&gt;</span><span class="n">s_mds</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ceph_pagelist</span> <span class="o">*</span><span class="n">pagelist</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ceph_reconnect_state</span> <span class="n">recon_state</span><span class="p">;</span>

	<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;mds%d reconnect start</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">mds</span><span class="p">);</span>

	<span class="n">pagelist</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">pagelist</span><span class="p">),</span> <span class="n">GFP_NOFS</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pagelist</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">fail_nopagelist</span><span class="p">;</span>
	<span class="n">ceph_pagelist_init</span><span class="p">(</span><span class="n">pagelist</span><span class="p">);</span>

	<span class="n">reply</span> <span class="o">=</span> <span class="n">ceph_msg_new</span><span class="p">(</span><span class="n">CEPH_MSG_CLIENT_RECONNECT</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">GFP_NOFS</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">reply</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">fail_nomsg</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">session</span><span class="o">-&gt;</span><span class="n">s_mutex</span><span class="p">);</span>
	<span class="n">session</span><span class="o">-&gt;</span><span class="n">s_state</span> <span class="o">=</span> <span class="n">CEPH_MDS_SESSION_RECONNECTING</span><span class="p">;</span>
	<span class="n">session</span><span class="o">-&gt;</span><span class="n">s_seq</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">ceph_con_open</span><span class="p">(</span><span class="o">&amp;</span><span class="n">session</span><span class="o">-&gt;</span><span class="n">s_con</span><span class="p">,</span>
		      <span class="n">ceph_mdsmap_get_addr</span><span class="p">(</span><span class="n">mdsc</span><span class="o">-&gt;</span><span class="n">mdsmap</span><span class="p">,</span> <span class="n">mds</span><span class="p">));</span>

	<span class="cm">/* replay unsafe requests */</span>
	<span class="n">replay_unsafe_requests</span><span class="p">(</span><span class="n">mdsc</span><span class="p">,</span> <span class="n">session</span><span class="p">);</span>

	<span class="n">down_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdsc</span><span class="o">-&gt;</span><span class="n">snap_rwsem</span><span class="p">);</span>

	<span class="n">dout</span><span class="p">(</span><span class="s">&quot;session %p state %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">session</span><span class="p">,</span>
	     <span class="n">session_state_name</span><span class="p">(</span><span class="n">session</span><span class="o">-&gt;</span><span class="n">s_state</span><span class="p">));</span>

	<span class="cm">/* drop old cap expires; we&#39;re about to reestablish that state */</span>
	<span class="n">discard_cap_releases</span><span class="p">(</span><span class="n">mdsc</span><span class="p">,</span> <span class="n">session</span><span class="p">);</span>

	<span class="cm">/* traverse this session&#39;s caps */</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">ceph_pagelist_encode_32</span><span class="p">(</span><span class="n">pagelist</span><span class="p">,</span> <span class="n">session</span><span class="o">-&gt;</span><span class="n">s_nr_caps</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>

	<span class="n">recon_state</span><span class="p">.</span><span class="n">pagelist</span> <span class="o">=</span> <span class="n">pagelist</span><span class="p">;</span>
	<span class="n">recon_state</span><span class="p">.</span><span class="n">flock</span> <span class="o">=</span> <span class="n">session</span><span class="o">-&gt;</span><span class="n">s_con</span><span class="p">.</span><span class="n">peer_features</span> <span class="o">&amp;</span> <span class="n">CEPH_FEATURE_FLOCK</span><span class="p">;</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">iterate_session_caps</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">encode_caps_cb</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">recon_state</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * snaprealms.  we provide mds with the ino, seq (version), and</span>
<span class="cm">	 * parent for all of our realms.  If the mds has any newer info,</span>
<span class="cm">	 * it will tell us.</span>
<span class="cm">	 */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">p</span> <span class="o">=</span> <span class="n">rb_first</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdsc</span><span class="o">-&gt;</span><span class="n">snap_realms</span><span class="p">);</span> <span class="n">p</span><span class="p">;</span> <span class="n">p</span> <span class="o">=</span> <span class="n">rb_next</span><span class="p">(</span><span class="n">p</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">ceph_snap_realm</span> <span class="o">*</span><span class="n">realm</span> <span class="o">=</span>
			<span class="n">rb_entry</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ceph_snap_realm</span><span class="p">,</span> <span class="n">node</span><span class="p">);</span>
		<span class="k">struct</span> <span class="n">ceph_mds_snaprealm_reconnect</span> <span class="n">sr_rec</span><span class="p">;</span>

		<span class="n">dout</span><span class="p">(</span><span class="s">&quot; adding snap realm %llx seq %lld parent %llx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		     <span class="n">realm</span><span class="o">-&gt;</span><span class="n">ino</span><span class="p">,</span> <span class="n">realm</span><span class="o">-&gt;</span><span class="n">seq</span><span class="p">,</span> <span class="n">realm</span><span class="o">-&gt;</span><span class="n">parent_ino</span><span class="p">);</span>
		<span class="n">sr_rec</span><span class="p">.</span><span class="n">ino</span> <span class="o">=</span> <span class="n">cpu_to_le64</span><span class="p">(</span><span class="n">realm</span><span class="o">-&gt;</span><span class="n">ino</span><span class="p">);</span>
		<span class="n">sr_rec</span><span class="p">.</span><span class="n">seq</span> <span class="o">=</span> <span class="n">cpu_to_le64</span><span class="p">(</span><span class="n">realm</span><span class="o">-&gt;</span><span class="n">seq</span><span class="p">);</span>
		<span class="n">sr_rec</span><span class="p">.</span><span class="n">parent</span> <span class="o">=</span> <span class="n">cpu_to_le64</span><span class="p">(</span><span class="n">realm</span><span class="o">-&gt;</span><span class="n">parent_ino</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">ceph_pagelist_append</span><span class="p">(</span><span class="n">pagelist</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sr_rec</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">sr_rec</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">reply</span><span class="o">-&gt;</span><span class="n">pagelist</span> <span class="o">=</span> <span class="n">pagelist</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">recon_state</span><span class="p">.</span><span class="n">flock</span><span class="p">)</span>
		<span class="n">reply</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">version</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
	<span class="n">reply</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">data_len</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">pagelist</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">);</span>
	<span class="n">reply</span><span class="o">-&gt;</span><span class="n">nr_pages</span> <span class="o">=</span> <span class="n">calc_pages_for</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">pagelist</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">);</span>
	<span class="n">ceph_con_send</span><span class="p">(</span><span class="o">&amp;</span><span class="n">session</span><span class="o">-&gt;</span><span class="n">s_con</span><span class="p">,</span> <span class="n">reply</span><span class="p">);</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">session</span><span class="o">-&gt;</span><span class="n">s_mutex</span><span class="p">);</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdsc</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="n">__wake_requests</span><span class="p">(</span><span class="n">mdsc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">session</span><span class="o">-&gt;</span><span class="n">s_waiting</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdsc</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="n">up_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdsc</span><span class="o">-&gt;</span><span class="n">snap_rwsem</span><span class="p">);</span>
	<span class="k">return</span><span class="p">;</span>

<span class="nl">fail:</span>
	<span class="n">ceph_msg_put</span><span class="p">(</span><span class="n">reply</span><span class="p">);</span>
	<span class="n">up_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdsc</span><span class="o">-&gt;</span><span class="n">snap_rwsem</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">session</span><span class="o">-&gt;</span><span class="n">s_mutex</span><span class="p">);</span>
<span class="nl">fail_nomsg:</span>
	<span class="n">ceph_pagelist_release</span><span class="p">(</span><span class="n">pagelist</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">pagelist</span><span class="p">);</span>
<span class="nl">fail_nopagelist:</span>
	<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;error %d preparing reconnect for mds%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">err</span><span class="p">,</span> <span class="n">mds</span><span class="p">);</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * compare old and new mdsmaps, kicking requests</span>
<span class="cm"> * and closing out old connections as necessary</span>
<span class="cm"> *</span>
<span class="cm"> * called under mdsc-&gt;mutex.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">check_new_map</span><span class="p">(</span><span class="k">struct</span> <span class="n">ceph_mds_client</span> <span class="o">*</span><span class="n">mdsc</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">ceph_mdsmap</span> <span class="o">*</span><span class="n">newmap</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">ceph_mdsmap</span> <span class="o">*</span><span class="n">oldmap</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">oldstate</span><span class="p">,</span> <span class="n">newstate</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ceph_mds_session</span> <span class="o">*</span><span class="n">s</span><span class="p">;</span>

	<span class="n">dout</span><span class="p">(</span><span class="s">&quot;check_new_map new %u old %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	     <span class="n">newmap</span><span class="o">-&gt;</span><span class="n">m_epoch</span><span class="p">,</span> <span class="n">oldmap</span><span class="o">-&gt;</span><span class="n">m_epoch</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">oldmap</span><span class="o">-&gt;</span><span class="n">m_max_mds</span> <span class="o">&amp;&amp;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">mdsc</span><span class="o">-&gt;</span><span class="n">max_sessions</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mdsc</span><span class="o">-&gt;</span><span class="n">sessions</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">s</span> <span class="o">=</span> <span class="n">mdsc</span><span class="o">-&gt;</span><span class="n">sessions</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="n">oldstate</span> <span class="o">=</span> <span class="n">ceph_mdsmap_get_state</span><span class="p">(</span><span class="n">oldmap</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
		<span class="n">newstate</span> <span class="o">=</span> <span class="n">ceph_mdsmap_get_state</span><span class="p">(</span><span class="n">newmap</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>

		<span class="n">dout</span><span class="p">(</span><span class="s">&quot;check_new_map mds%d state %s%s -&gt; %s%s (session %s)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		     <span class="n">i</span><span class="p">,</span> <span class="n">ceph_mds_state_name</span><span class="p">(</span><span class="n">oldstate</span><span class="p">),</span>
		     <span class="n">ceph_mdsmap_is_laggy</span><span class="p">(</span><span class="n">oldmap</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot; (laggy)&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		     <span class="n">ceph_mds_state_name</span><span class="p">(</span><span class="n">newstate</span><span class="p">),</span>
		     <span class="n">ceph_mdsmap_is_laggy</span><span class="p">(</span><span class="n">newmap</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot; (laggy)&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		     <span class="n">session_state_name</span><span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">s_state</span><span class="p">));</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">memcmp</span><span class="p">(</span><span class="n">ceph_mdsmap_get_addr</span><span class="p">(</span><span class="n">oldmap</span><span class="p">,</span> <span class="n">i</span><span class="p">),</span>
			   <span class="n">ceph_mdsmap_get_addr</span><span class="p">(</span><span class="n">newmap</span><span class="p">,</span> <span class="n">i</span><span class="p">),</span>
			   <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ceph_entity_addr</span><span class="p">)))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">s_state</span> <span class="o">==</span> <span class="n">CEPH_MDS_SESSION_OPENING</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* the session never opened, just close it</span>
<span class="cm">				 * out now */</span>
				<span class="n">__wake_requests</span><span class="p">(</span><span class="n">mdsc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">s_waiting</span><span class="p">);</span>
				<span class="n">__unregister_session</span><span class="p">(</span><span class="n">mdsc</span><span class="p">,</span> <span class="n">s</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="cm">/* just close it */</span>
				<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdsc</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
				<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">s_mutex</span><span class="p">);</span>
				<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdsc</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
				<span class="n">ceph_con_close</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">s_con</span><span class="p">);</span>
				<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">s_mutex</span><span class="p">);</span>
				<span class="n">s</span><span class="o">-&gt;</span><span class="n">s_state</span> <span class="o">=</span> <span class="n">CEPH_MDS_SESSION_RESTARTING</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="cm">/* kick any requests waiting on the recovering mds */</span>
			<span class="n">kick_requests</span><span class="p">(</span><span class="n">mdsc</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">oldstate</span> <span class="o">==</span> <span class="n">newstate</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">continue</span><span class="p">;</span>  <span class="cm">/* nothing new with this mds */</span>
		<span class="p">}</span>

		<span class="cm">/*</span>
<span class="cm">		 * send reconnect?</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">s_state</span> <span class="o">==</span> <span class="n">CEPH_MDS_SESSION_RESTARTING</span> <span class="o">&amp;&amp;</span>
		    <span class="n">newstate</span> <span class="o">&gt;=</span> <span class="n">CEPH_MDS_STATE_RECONNECT</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdsc</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
			<span class="n">send_mds_reconnect</span><span class="p">(</span><span class="n">mdsc</span><span class="p">,</span> <span class="n">s</span><span class="p">);</span>
			<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdsc</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="cm">/*</span>
<span class="cm">		 * kick request on any mds that has gone active.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">oldstate</span> <span class="o">&lt;</span> <span class="n">CEPH_MDS_STATE_ACTIVE</span> <span class="o">&amp;&amp;</span>
		    <span class="n">newstate</span> <span class="o">&gt;=</span> <span class="n">CEPH_MDS_STATE_ACTIVE</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">oldstate</span> <span class="o">!=</span> <span class="n">CEPH_MDS_STATE_CREATING</span> <span class="o">&amp;&amp;</span>
			    <span class="n">oldstate</span> <span class="o">!=</span> <span class="n">CEPH_MDS_STATE_STARTING</span><span class="p">)</span>
				<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;mds%d recovery completed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">s_mds</span><span class="p">);</span>
			<span class="n">kick_requests</span><span class="p">(</span><span class="n">mdsc</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
			<span class="n">ceph_kick_flushing_caps</span><span class="p">(</span><span class="n">mdsc</span><span class="p">,</span> <span class="n">s</span><span class="p">);</span>
			<span class="n">wake_up_session_caps</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">newmap</span><span class="o">-&gt;</span><span class="n">m_max_mds</span> <span class="o">&amp;&amp;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">mdsc</span><span class="o">-&gt;</span><span class="n">max_sessions</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">s</span> <span class="o">=</span> <span class="n">mdsc</span><span class="o">-&gt;</span><span class="n">sessions</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">s</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ceph_mdsmap_is_laggy</span><span class="p">(</span><span class="n">newmap</span><span class="p">,</span> <span class="n">i</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">s_state</span> <span class="o">==</span> <span class="n">CEPH_MDS_SESSION_OPEN</span> <span class="o">||</span>
		    <span class="n">s</span><span class="o">-&gt;</span><span class="n">s_state</span> <span class="o">==</span> <span class="n">CEPH_MDS_SESSION_HUNG</span> <span class="o">||</span>
		    <span class="n">s</span><span class="o">-&gt;</span><span class="n">s_state</span> <span class="o">==</span> <span class="n">CEPH_MDS_SESSION_CLOSING</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dout</span><span class="p">(</span><span class="s">&quot; connecting to export targets of laggy mds%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			     <span class="n">i</span><span class="p">);</span>
			<span class="n">__open_export_target_sessions</span><span class="p">(</span><span class="n">mdsc</span><span class="p">,</span> <span class="n">s</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>



<span class="cm">/*</span>
<span class="cm"> * leases</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> * caller must hold session s_mutex, dentry-&gt;d_lock</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">__ceph_mdsc_drop_dentry_lease</span><span class="p">(</span><span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="n">dentry</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ceph_dentry_info</span> <span class="o">*</span><span class="n">di</span> <span class="o">=</span> <span class="n">ceph_dentry</span><span class="p">(</span><span class="n">dentry</span><span class="p">);</span>

	<span class="n">ceph_put_mds_session</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">lease_session</span><span class="p">);</span>
	<span class="n">di</span><span class="o">-&gt;</span><span class="n">lease_session</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">handle_lease</span><span class="p">(</span><span class="k">struct</span> <span class="n">ceph_mds_client</span> <span class="o">*</span><span class="n">mdsc</span><span class="p">,</span>
			 <span class="k">struct</span> <span class="n">ceph_mds_session</span> <span class="o">*</span><span class="n">session</span><span class="p">,</span>
			 <span class="k">struct</span> <span class="n">ceph_msg</span> <span class="o">*</span><span class="n">msg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">sb</span> <span class="o">=</span> <span class="n">mdsc</span><span class="o">-&gt;</span><span class="n">fsc</span><span class="o">-&gt;</span><span class="n">sb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="n">parent</span><span class="p">,</span> <span class="o">*</span><span class="n">dentry</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ceph_dentry_info</span> <span class="o">*</span><span class="n">di</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">mds</span> <span class="o">=</span> <span class="n">session</span><span class="o">-&gt;</span><span class="n">s_mds</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ceph_mds_lease</span> <span class="o">*</span><span class="n">h</span> <span class="o">=</span> <span class="n">msg</span><span class="o">-&gt;</span><span class="n">front</span><span class="p">.</span><span class="n">iov_base</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">seq</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ceph_vino</span> <span class="n">vino</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qstr</span> <span class="n">dname</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">release</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">dout</span><span class="p">(</span><span class="s">&quot;handle_lease from mds%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">mds</span><span class="p">);</span>

	<span class="cm">/* decode */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">front</span><span class="p">.</span><span class="n">iov_len</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">h</span><span class="p">)</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">bad</span><span class="p">;</span>
	<span class="n">vino</span><span class="p">.</span><span class="n">ino</span> <span class="o">=</span> <span class="n">le64_to_cpu</span><span class="p">(</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">ino</span><span class="p">);</span>
	<span class="n">vino</span><span class="p">.</span><span class="n">snap</span> <span class="o">=</span> <span class="n">CEPH_NOSNAP</span><span class="p">;</span>
	<span class="n">seq</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">seq</span><span class="p">);</span>
	<span class="n">dname</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">h</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">h</span><span class="p">)</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">);</span>
	<span class="n">dname</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="n">msg</span><span class="o">-&gt;</span><span class="n">front</span><span class="p">.</span><span class="n">iov_len</span> <span class="o">-</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">h</span><span class="p">)</span> <span class="o">-</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dname</span><span class="p">.</span><span class="n">len</span> <span class="o">!=</span> <span class="n">get_unaligned_le32</span><span class="p">(</span><span class="n">h</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">bad</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">session</span><span class="o">-&gt;</span><span class="n">s_mutex</span><span class="p">);</span>
	<span class="n">session</span><span class="o">-&gt;</span><span class="n">s_seq</span><span class="o">++</span><span class="p">;</span>

	<span class="cm">/* lookup inode */</span>
	<span class="n">inode</span> <span class="o">=</span> <span class="n">ceph_find_inode</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">vino</span><span class="p">);</span>
	<span class="n">dout</span><span class="p">(</span><span class="s">&quot;handle_lease %s, ino %llx %p %.*s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	     <span class="n">ceph_lease_op_name</span><span class="p">(</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">action</span><span class="p">),</span> <span class="n">vino</span><span class="p">.</span><span class="n">ino</span><span class="p">,</span> <span class="n">inode</span><span class="p">,</span>
	     <span class="n">dname</span><span class="p">.</span><span class="n">len</span><span class="p">,</span> <span class="n">dname</span><span class="p">.</span><span class="n">name</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">inode</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dout</span><span class="p">(</span><span class="s">&quot;handle_lease no inode %llx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">vino</span><span class="p">.</span><span class="n">ino</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">release</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* dentry */</span>
	<span class="n">parent</span> <span class="o">=</span> <span class="n">d_find_alias</span><span class="p">(</span><span class="n">inode</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">parent</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dout</span><span class="p">(</span><span class="s">&quot;no parent dentry on inode %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">inode</span><span class="p">);</span>
		<span class="n">WARN_ON</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">release</span><span class="p">;</span>  <span class="cm">/* hrm... */</span>
	<span class="p">}</span>
	<span class="n">dname</span><span class="p">.</span><span class="n">hash</span> <span class="o">=</span> <span class="n">full_name_hash</span><span class="p">(</span><span class="n">dname</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">dname</span><span class="p">.</span><span class="n">len</span><span class="p">);</span>
	<span class="n">dentry</span> <span class="o">=</span> <span class="n">d_lookup</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dname</span><span class="p">);</span>
	<span class="n">dput</span><span class="p">(</span><span class="n">parent</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dentry</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">release</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dentry</span><span class="o">-&gt;</span><span class="n">d_lock</span><span class="p">);</span>
	<span class="n">di</span> <span class="o">=</span> <span class="n">ceph_dentry</span><span class="p">(</span><span class="n">dentry</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">action</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">CEPH_MDS_LEASE_REVOKE</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">lease_session</span> <span class="o">==</span> <span class="n">session</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ceph_seq_cmp</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">lease_seq</span><span class="p">,</span> <span class="n">seq</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">h</span><span class="o">-&gt;</span><span class="n">seq</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">lease_seq</span><span class="p">);</span>
			<span class="n">__ceph_mdsc_drop_dentry_lease</span><span class="p">(</span><span class="n">dentry</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">release</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">CEPH_MDS_LEASE_RENEW</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">lease_session</span> <span class="o">==</span> <span class="n">session</span> <span class="o">&amp;&amp;</span>
		    <span class="n">di</span><span class="o">-&gt;</span><span class="n">lease_gen</span> <span class="o">==</span> <span class="n">session</span><span class="o">-&gt;</span><span class="n">s_cap_gen</span> <span class="o">&amp;&amp;</span>
		    <span class="n">di</span><span class="o">-&gt;</span><span class="n">lease_renew_from</span> <span class="o">&amp;&amp;</span>
		    <span class="n">di</span><span class="o">-&gt;</span><span class="n">lease_renew_after</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">duration</span> <span class="o">=</span>
				<span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">duration_ms</span><span class="p">)</span> <span class="o">*</span> <span class="n">HZ</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">;</span>

			<span class="n">di</span><span class="o">-&gt;</span><span class="n">lease_seq</span> <span class="o">=</span> <span class="n">seq</span><span class="p">;</span>
			<span class="n">dentry</span><span class="o">-&gt;</span><span class="n">d_time</span> <span class="o">=</span> <span class="n">di</span><span class="o">-&gt;</span><span class="n">lease_renew_from</span> <span class="o">+</span> <span class="n">duration</span><span class="p">;</span>
			<span class="n">di</span><span class="o">-&gt;</span><span class="n">lease_renew_after</span> <span class="o">=</span> <span class="n">di</span><span class="o">-&gt;</span><span class="n">lease_renew_from</span> <span class="o">+</span>
				<span class="p">(</span><span class="n">duration</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">);</span>
			<span class="n">di</span><span class="o">-&gt;</span><span class="n">lease_renew_from</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dentry</span><span class="o">-&gt;</span><span class="n">d_lock</span><span class="p">);</span>
	<span class="n">dput</span><span class="p">(</span><span class="n">dentry</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">release</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

<span class="nl">release:</span>
	<span class="cm">/* let&#39;s just reuse the same message */</span>
	<span class="n">h</span><span class="o">-&gt;</span><span class="n">action</span> <span class="o">=</span> <span class="n">CEPH_MDS_LEASE_REVOKE_ACK</span><span class="p">;</span>
	<span class="n">ceph_msg_get</span><span class="p">(</span><span class="n">msg</span><span class="p">);</span>
	<span class="n">ceph_con_send</span><span class="p">(</span><span class="o">&amp;</span><span class="n">session</span><span class="o">-&gt;</span><span class="n">s_con</span><span class="p">,</span> <span class="n">msg</span><span class="p">);</span>

<span class="nl">out:</span>
	<span class="n">iput</span><span class="p">(</span><span class="n">inode</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">session</span><span class="o">-&gt;</span><span class="n">s_mutex</span><span class="p">);</span>
	<span class="k">return</span><span class="p">;</span>

<span class="nl">bad:</span>
	<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;corrupt lease message</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">ceph_msg_dump</span><span class="p">(</span><span class="n">msg</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">ceph_mdsc_lease_send_msg</span><span class="p">(</span><span class="k">struct</span> <span class="n">ceph_mds_session</span> <span class="o">*</span><span class="n">session</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="n">dentry</span><span class="p">,</span> <span class="kt">char</span> <span class="n">action</span><span class="p">,</span>
			      <span class="n">u32</span> <span class="n">seq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ceph_msg</span> <span class="o">*</span><span class="n">msg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ceph_mds_lease</span> <span class="o">*</span><span class="n">lease</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">lease</span><span class="p">)</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">dnamelen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">dout</span><span class="p">(</span><span class="s">&quot;lease_send_msg inode %p dentry %p %s to mds%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	     <span class="n">inode</span><span class="p">,</span> <span class="n">dentry</span><span class="p">,</span> <span class="n">ceph_lease_op_name</span><span class="p">(</span><span class="n">action</span><span class="p">),</span> <span class="n">session</span><span class="o">-&gt;</span><span class="n">s_mds</span><span class="p">);</span>
	<span class="n">dnamelen</span> <span class="o">=</span> <span class="n">dentry</span><span class="o">-&gt;</span><span class="n">d_name</span><span class="p">.</span><span class="n">len</span><span class="p">;</span>
	<span class="n">len</span> <span class="o">+=</span> <span class="n">dnamelen</span><span class="p">;</span>

	<span class="n">msg</span> <span class="o">=</span> <span class="n">ceph_msg_new</span><span class="p">(</span><span class="n">CEPH_MSG_CLIENT_LEASE</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">GFP_NOFS</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">msg</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">lease</span> <span class="o">=</span> <span class="n">msg</span><span class="o">-&gt;</span><span class="n">front</span><span class="p">.</span><span class="n">iov_base</span><span class="p">;</span>
	<span class="n">lease</span><span class="o">-&gt;</span><span class="n">action</span> <span class="o">=</span> <span class="n">action</span><span class="p">;</span>
	<span class="n">lease</span><span class="o">-&gt;</span><span class="n">ino</span> <span class="o">=</span> <span class="n">cpu_to_le64</span><span class="p">(</span><span class="n">ceph_vino</span><span class="p">(</span><span class="n">inode</span><span class="p">).</span><span class="n">ino</span><span class="p">);</span>
	<span class="n">lease</span><span class="o">-&gt;</span><span class="n">first</span> <span class="o">=</span> <span class="n">lease</span><span class="o">-&gt;</span><span class="n">last</span> <span class="o">=</span> <span class="n">cpu_to_le64</span><span class="p">(</span><span class="n">ceph_vino</span><span class="p">(</span><span class="n">inode</span><span class="p">).</span><span class="n">snap</span><span class="p">);</span>
	<span class="n">lease</span><span class="o">-&gt;</span><span class="n">seq</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">seq</span><span class="p">);</span>
	<span class="n">put_unaligned_le32</span><span class="p">(</span><span class="n">dnamelen</span><span class="p">,</span> <span class="n">lease</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)(</span><span class="n">lease</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="mi">4</span><span class="p">,</span> <span class="n">dentry</span><span class="o">-&gt;</span><span class="n">d_name</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">dnamelen</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * if this is a preemptive lease RELEASE, no need to</span>
<span class="cm">	 * flush request stream, since the actual request will</span>
<span class="cm">	 * soon follow.</span>
<span class="cm">	 */</span>
	<span class="n">msg</span><span class="o">-&gt;</span><span class="n">more_to_follow</span> <span class="o">=</span> <span class="p">(</span><span class="n">action</span> <span class="o">==</span> <span class="n">CEPH_MDS_LEASE_RELEASE</span><span class="p">);</span>

	<span class="n">ceph_con_send</span><span class="p">(</span><span class="o">&amp;</span><span class="n">session</span><span class="o">-&gt;</span><span class="n">s_con</span><span class="p">,</span> <span class="n">msg</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Preemptively release a lease we expect to invalidate anyway.</span>
<span class="cm"> * Pass @inode always, @dentry is optional.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">ceph_mdsc_lease_release</span><span class="p">(</span><span class="k">struct</span> <span class="n">ceph_mds_client</span> <span class="o">*</span><span class="n">mdsc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="n">dentry</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ceph_dentry_info</span> <span class="o">*</span><span class="n">di</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ceph_mds_session</span> <span class="o">*</span><span class="n">session</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">seq</span><span class="p">;</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">inode</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">dentry</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="cm">/* is dentry lease valid? */</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dentry</span><span class="o">-&gt;</span><span class="n">d_lock</span><span class="p">);</span>
	<span class="n">di</span> <span class="o">=</span> <span class="n">ceph_dentry</span><span class="p">(</span><span class="n">dentry</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">di</span> <span class="o">||</span> <span class="o">!</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">lease_session</span> <span class="o">||</span>
	    <span class="n">di</span><span class="o">-&gt;</span><span class="n">lease_session</span><span class="o">-&gt;</span><span class="n">s_mds</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span>
	    <span class="n">di</span><span class="o">-&gt;</span><span class="n">lease_gen</span> <span class="o">!=</span> <span class="n">di</span><span class="o">-&gt;</span><span class="n">lease_session</span><span class="o">-&gt;</span><span class="n">s_cap_gen</span> <span class="o">||</span>
	    <span class="o">!</span><span class="n">time_before</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">dentry</span><span class="o">-&gt;</span><span class="n">d_time</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dout</span><span class="p">(</span><span class="s">&quot;lease_release inode %p dentry %p -- &quot;</span>
		     <span class="s">&quot;no lease</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		     <span class="n">inode</span><span class="p">,</span> <span class="n">dentry</span><span class="p">);</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dentry</span><span class="o">-&gt;</span><span class="n">d_lock</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* we do have a lease on this dentry; note mds and seq */</span>
	<span class="n">session</span> <span class="o">=</span> <span class="n">ceph_get_mds_session</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">lease_session</span><span class="p">);</span>
	<span class="n">seq</span> <span class="o">=</span> <span class="n">di</span><span class="o">-&gt;</span><span class="n">lease_seq</span><span class="p">;</span>
	<span class="n">__ceph_mdsc_drop_dentry_lease</span><span class="p">(</span><span class="n">dentry</span><span class="p">);</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dentry</span><span class="o">-&gt;</span><span class="n">d_lock</span><span class="p">);</span>

	<span class="n">dout</span><span class="p">(</span><span class="s">&quot;lease_release inode %p dentry %p to mds%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	     <span class="n">inode</span><span class="p">,</span> <span class="n">dentry</span><span class="p">,</span> <span class="n">session</span><span class="o">-&gt;</span><span class="n">s_mds</span><span class="p">);</span>
	<span class="n">ceph_mdsc_lease_send_msg</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">inode</span><span class="p">,</span> <span class="n">dentry</span><span class="p">,</span>
				 <span class="n">CEPH_MDS_LEASE_RELEASE</span><span class="p">,</span> <span class="n">seq</span><span class="p">);</span>
	<span class="n">ceph_put_mds_session</span><span class="p">(</span><span class="n">session</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * drop all leases (and dentry refs) in preparation for umount</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">drop_leases</span><span class="p">(</span><span class="k">struct</span> <span class="n">ceph_mds_client</span> <span class="o">*</span><span class="n">mdsc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">dout</span><span class="p">(</span><span class="s">&quot;drop_leases</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdsc</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">mdsc</span><span class="o">-&gt;</span><span class="n">max_sessions</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">ceph_mds_session</span> <span class="o">*</span><span class="n">s</span> <span class="o">=</span> <span class="n">__ceph_lookup_mds_session</span><span class="p">(</span><span class="n">mdsc</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">s</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdsc</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
		<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">s_mutex</span><span class="p">);</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">s_mutex</span><span class="p">);</span>
		<span class="n">ceph_put_mds_session</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
		<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdsc</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdsc</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
<span class="p">}</span>



<span class="cm">/*</span>
<span class="cm"> * delayed work -- periodically trim expired leases, renew caps with mds</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">schedule_delayed</span><span class="p">(</span><span class="k">struct</span> <span class="n">ceph_mds_client</span> <span class="o">*</span><span class="n">mdsc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">delay</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">hz</span> <span class="o">=</span> <span class="n">round_jiffies_relative</span><span class="p">(</span><span class="n">HZ</span> <span class="o">*</span> <span class="n">delay</span><span class="p">);</span>
	<span class="n">schedule_delayed_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdsc</span><span class="o">-&gt;</span><span class="n">delayed_work</span><span class="p">,</span> <span class="n">hz</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">delayed_work</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ceph_mds_client</span> <span class="o">*</span><span class="n">mdsc</span> <span class="o">=</span>
		<span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ceph_mds_client</span><span class="p">,</span> <span class="n">delayed_work</span><span class="p">.</span><span class="n">work</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">renew_interval</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">renew_caps</span><span class="p">;</span>

	<span class="n">dout</span><span class="p">(</span><span class="s">&quot;mdsc delayed_work</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">ceph_check_delayed_caps</span><span class="p">(</span><span class="n">mdsc</span><span class="p">);</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdsc</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="n">renew_interval</span> <span class="o">=</span> <span class="n">mdsc</span><span class="o">-&gt;</span><span class="n">mdsmap</span><span class="o">-&gt;</span><span class="n">m_session_timeout</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">renew_caps</span> <span class="o">=</span> <span class="n">time_after_eq</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">HZ</span><span class="o">*</span><span class="n">renew_interval</span> <span class="o">+</span>
				   <span class="n">mdsc</span><span class="o">-&gt;</span><span class="n">last_renew_caps</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">renew_caps</span><span class="p">)</span>
		<span class="n">mdsc</span><span class="o">-&gt;</span><span class="n">last_renew_caps</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">mdsc</span><span class="o">-&gt;</span><span class="n">max_sessions</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">ceph_mds_session</span> <span class="o">*</span><span class="n">s</span> <span class="o">=</span> <span class="n">__ceph_lookup_mds_session</span><span class="p">(</span><span class="n">mdsc</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">s</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">s_state</span> <span class="o">==</span> <span class="n">CEPH_MDS_SESSION_CLOSING</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dout</span><span class="p">(</span><span class="s">&quot;resending session close request for mds%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			     <span class="n">s</span><span class="o">-&gt;</span><span class="n">s_mds</span><span class="p">);</span>
			<span class="n">request_close_session</span><span class="p">(</span><span class="n">mdsc</span><span class="p">,</span> <span class="n">s</span><span class="p">);</span>
			<span class="n">ceph_put_mds_session</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">s_ttl</span> <span class="o">&amp;&amp;</span> <span class="n">time_after</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">s_ttl</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">s_state</span> <span class="o">==</span> <span class="n">CEPH_MDS_SESSION_OPEN</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">s</span><span class="o">-&gt;</span><span class="n">s_state</span> <span class="o">=</span> <span class="n">CEPH_MDS_SESSION_HUNG</span><span class="p">;</span>
				<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;mds%d hung</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">s_mds</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">s_state</span> <span class="o">&lt;</span> <span class="n">CEPH_MDS_SESSION_OPEN</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* this mds is failed or recovering, just wait */</span>
			<span class="n">ceph_put_mds_session</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdsc</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

		<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">s_mutex</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">renew_caps</span><span class="p">)</span>
			<span class="n">send_renew_caps</span><span class="p">(</span><span class="n">mdsc</span><span class="p">,</span> <span class="n">s</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">ceph_con_keepalive</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">s_con</span><span class="p">);</span>
		<span class="n">ceph_add_cap_releases</span><span class="p">(</span><span class="n">mdsc</span><span class="p">,</span> <span class="n">s</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">s_state</span> <span class="o">==</span> <span class="n">CEPH_MDS_SESSION_OPEN</span> <span class="o">||</span>
		    <span class="n">s</span><span class="o">-&gt;</span><span class="n">s_state</span> <span class="o">==</span> <span class="n">CEPH_MDS_SESSION_HUNG</span><span class="p">)</span>
			<span class="n">ceph_send_cap_releases</span><span class="p">(</span><span class="n">mdsc</span><span class="p">,</span> <span class="n">s</span><span class="p">);</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">s_mutex</span><span class="p">);</span>
		<span class="n">ceph_put_mds_session</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>

		<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdsc</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdsc</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="n">schedule_delayed</span><span class="p">(</span><span class="n">mdsc</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">ceph_mdsc_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">ceph_fs_client</span> <span class="o">*</span><span class="n">fsc</span><span class="p">)</span>

<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ceph_mds_client</span> <span class="o">*</span><span class="n">mdsc</span><span class="p">;</span>

	<span class="n">mdsc</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ceph_mds_client</span><span class="p">),</span> <span class="n">GFP_NOFS</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mdsc</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">mdsc</span><span class="o">-&gt;</span><span class="n">fsc</span> <span class="o">=</span> <span class="n">fsc</span><span class="p">;</span>
	<span class="n">fsc</span><span class="o">-&gt;</span><span class="n">mdsc</span> <span class="o">=</span> <span class="n">mdsc</span><span class="p">;</span>
	<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdsc</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="n">mdsc</span><span class="o">-&gt;</span><span class="n">mdsmap</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">mdsc</span><span class="o">-&gt;</span><span class="n">mdsmap</span><span class="p">),</span> <span class="n">GFP_NOFS</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mdsc</span><span class="o">-&gt;</span><span class="n">mdsmap</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">init_completion</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdsc</span><span class="o">-&gt;</span><span class="n">safe_umount_waiters</span><span class="p">);</span>
	<span class="n">init_waitqueue_head</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdsc</span><span class="o">-&gt;</span><span class="n">session_close_wq</span><span class="p">);</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdsc</span><span class="o">-&gt;</span><span class="n">waiting_for_map</span><span class="p">);</span>
	<span class="n">mdsc</span><span class="o">-&gt;</span><span class="n">sessions</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">mdsc</span><span class="o">-&gt;</span><span class="n">max_sessions</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">mdsc</span><span class="o">-&gt;</span><span class="n">stopping</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">init_rwsem</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdsc</span><span class="o">-&gt;</span><span class="n">snap_rwsem</span><span class="p">);</span>
	<span class="n">mdsc</span><span class="o">-&gt;</span><span class="n">snap_realms</span> <span class="o">=</span> <span class="n">RB_ROOT</span><span class="p">;</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdsc</span><span class="o">-&gt;</span><span class="n">snap_empty</span><span class="p">);</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdsc</span><span class="o">-&gt;</span><span class="n">snap_empty_lock</span><span class="p">);</span>
	<span class="n">mdsc</span><span class="o">-&gt;</span><span class="n">last_tid</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">mdsc</span><span class="o">-&gt;</span><span class="n">request_tree</span> <span class="o">=</span> <span class="n">RB_ROOT</span><span class="p">;</span>
	<span class="n">INIT_DELAYED_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdsc</span><span class="o">-&gt;</span><span class="n">delayed_work</span><span class="p">,</span> <span class="n">delayed_work</span><span class="p">);</span>
	<span class="n">mdsc</span><span class="o">-&gt;</span><span class="n">last_renew_caps</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdsc</span><span class="o">-&gt;</span><span class="n">cap_delay_list</span><span class="p">);</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdsc</span><span class="o">-&gt;</span><span class="n">cap_delay_lock</span><span class="p">);</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdsc</span><span class="o">-&gt;</span><span class="n">snap_flush_list</span><span class="p">);</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdsc</span><span class="o">-&gt;</span><span class="n">snap_flush_lock</span><span class="p">);</span>
	<span class="n">mdsc</span><span class="o">-&gt;</span><span class="n">cap_flush_seq</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdsc</span><span class="o">-&gt;</span><span class="n">cap_dirty</span><span class="p">);</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdsc</span><span class="o">-&gt;</span><span class="n">cap_dirty_migrating</span><span class="p">);</span>
	<span class="n">mdsc</span><span class="o">-&gt;</span><span class="n">num_cap_flushing</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdsc</span><span class="o">-&gt;</span><span class="n">cap_dirty_lock</span><span class="p">);</span>
	<span class="n">init_waitqueue_head</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdsc</span><span class="o">-&gt;</span><span class="n">cap_flushing_wq</span><span class="p">);</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdsc</span><span class="o">-&gt;</span><span class="n">dentry_lru_lock</span><span class="p">);</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdsc</span><span class="o">-&gt;</span><span class="n">dentry_lru</span><span class="p">);</span>

	<span class="n">ceph_caps_init</span><span class="p">(</span><span class="n">mdsc</span><span class="p">);</span>
	<span class="n">ceph_adjust_min_caps</span><span class="p">(</span><span class="n">mdsc</span><span class="p">,</span> <span class="n">fsc</span><span class="o">-&gt;</span><span class="n">min_caps</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Wait for safe replies on open mds requests.  If we time out, drop</span>
<span class="cm"> * all requests from the tree to avoid dangling dentry refs.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">wait_requests</span><span class="p">(</span><span class="k">struct</span> <span class="n">ceph_mds_client</span> <span class="o">*</span><span class="n">mdsc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ceph_mds_request</span> <span class="o">*</span><span class="n">req</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ceph_fs_client</span> <span class="o">*</span><span class="n">fsc</span> <span class="o">=</span> <span class="n">mdsc</span><span class="o">-&gt;</span><span class="n">fsc</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdsc</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">__get_oldest_req</span><span class="p">(</span><span class="n">mdsc</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdsc</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

		<span class="n">dout</span><span class="p">(</span><span class="s">&quot;wait_requests waiting for requests</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">wait_for_completion_timeout</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdsc</span><span class="o">-&gt;</span><span class="n">safe_umount_waiters</span><span class="p">,</span>
				    <span class="n">fsc</span><span class="o">-&gt;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">options</span><span class="o">-&gt;</span><span class="n">mount_timeout</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">);</span>

		<span class="cm">/* tear down remaining requests */</span>
		<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdsc</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
		<span class="k">while</span> <span class="p">((</span><span class="n">req</span> <span class="o">=</span> <span class="n">__get_oldest_req</span><span class="p">(</span><span class="n">mdsc</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">dout</span><span class="p">(</span><span class="s">&quot;wait_requests timed out on tid %llu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			     <span class="n">req</span><span class="o">-&gt;</span><span class="n">r_tid</span><span class="p">);</span>
			<span class="n">__unregister_request</span><span class="p">(</span><span class="n">mdsc</span><span class="p">,</span> <span class="n">req</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdsc</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="n">dout</span><span class="p">(</span><span class="s">&quot;wait_requests done</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * called before mount is ro, and before dentries are torn down.</span>
<span class="cm"> * (hmm, does this still race with new lookups?)</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">ceph_mdsc_pre_umount</span><span class="p">(</span><span class="k">struct</span> <span class="n">ceph_mds_client</span> <span class="o">*</span><span class="n">mdsc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dout</span><span class="p">(</span><span class="s">&quot;pre_umount</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">mdsc</span><span class="o">-&gt;</span><span class="n">stopping</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">drop_leases</span><span class="p">(</span><span class="n">mdsc</span><span class="p">);</span>
	<span class="n">ceph_flush_dirty_caps</span><span class="p">(</span><span class="n">mdsc</span><span class="p">);</span>
	<span class="n">wait_requests</span><span class="p">(</span><span class="n">mdsc</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * wait for reply handlers to drop their request refs and</span>
<span class="cm">	 * their inode/dcache refs</span>
<span class="cm">	 */</span>
	<span class="n">ceph_msgr_flush</span><span class="p">();</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * wait for all write mds requests to flush.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">wait_unsafe_requests</span><span class="p">(</span><span class="k">struct</span> <span class="n">ceph_mds_client</span> <span class="o">*</span><span class="n">mdsc</span><span class="p">,</span> <span class="n">u64</span> <span class="n">want_tid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ceph_mds_request</span> <span class="o">*</span><span class="n">req</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">*</span><span class="n">nextreq</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rb_node</span> <span class="o">*</span><span class="n">n</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdsc</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="n">dout</span><span class="p">(</span><span class="s">&quot;wait_unsafe_requests want %lld</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">want_tid</span><span class="p">);</span>
<span class="nl">restart:</span>
	<span class="n">req</span> <span class="o">=</span> <span class="n">__get_oldest_req</span><span class="p">(</span><span class="n">mdsc</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">req</span> <span class="o">&amp;&amp;</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">r_tid</span> <span class="o">&lt;=</span> <span class="n">want_tid</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* find next request */</span>
		<span class="n">n</span> <span class="o">=</span> <span class="n">rb_next</span><span class="p">(</span><span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">r_node</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">n</span><span class="p">)</span>
			<span class="n">nextreq</span> <span class="o">=</span> <span class="n">rb_entry</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ceph_mds_request</span><span class="p">,</span> <span class="n">r_node</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">nextreq</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">r_op</span> <span class="o">&amp;</span> <span class="n">CEPH_MDS_OP_WRITE</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* write op */</span>
			<span class="n">ceph_mdsc_get_request</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">nextreq</span><span class="p">)</span>
				<span class="n">ceph_mdsc_get_request</span><span class="p">(</span><span class="n">nextreq</span><span class="p">);</span>
			<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdsc</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
			<span class="n">dout</span><span class="p">(</span><span class="s">&quot;wait_unsafe_requests  wait on %llu (want %llu)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			     <span class="n">req</span><span class="o">-&gt;</span><span class="n">r_tid</span><span class="p">,</span> <span class="n">want_tid</span><span class="p">);</span>
			<span class="n">wait_for_completion</span><span class="p">(</span><span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">r_safe_completion</span><span class="p">);</span>
			<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdsc</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
			<span class="n">ceph_mdsc_put_request</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">nextreq</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>  <span class="cm">/* next dne before, so we&#39;re done! */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">RB_EMPTY_NODE</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nextreq</span><span class="o">-&gt;</span><span class="n">r_node</span><span class="p">))</span> <span class="p">{</span>
				<span class="cm">/* next request was removed from tree */</span>
				<span class="n">ceph_mdsc_put_request</span><span class="p">(</span><span class="n">nextreq</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">restart</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">ceph_mdsc_put_request</span><span class="p">(</span><span class="n">nextreq</span><span class="p">);</span>  <span class="cm">/* won&#39;t go away */</span>
		<span class="p">}</span>
		<span class="n">req</span> <span class="o">=</span> <span class="n">nextreq</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdsc</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="n">dout</span><span class="p">(</span><span class="s">&quot;wait_unsafe_requests done</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">ceph_mdsc_sync</span><span class="p">(</span><span class="k">struct</span> <span class="n">ceph_mds_client</span> <span class="o">*</span><span class="n">mdsc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u64</span> <span class="n">want_tid</span><span class="p">,</span> <span class="n">want_flush</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mdsc</span><span class="o">-&gt;</span><span class="n">fsc</span><span class="o">-&gt;</span><span class="n">mount_state</span> <span class="o">==</span> <span class="n">CEPH_MOUNT_SHUTDOWN</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">dout</span><span class="p">(</span><span class="s">&quot;sync</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdsc</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="n">want_tid</span> <span class="o">=</span> <span class="n">mdsc</span><span class="o">-&gt;</span><span class="n">last_tid</span><span class="p">;</span>
	<span class="n">want_flush</span> <span class="o">=</span> <span class="n">mdsc</span><span class="o">-&gt;</span><span class="n">cap_flush_seq</span><span class="p">;</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdsc</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="n">dout</span><span class="p">(</span><span class="s">&quot;sync want tid %lld flush_seq %lld</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">want_tid</span><span class="p">,</span> <span class="n">want_flush</span><span class="p">);</span>

	<span class="n">ceph_flush_dirty_caps</span><span class="p">(</span><span class="n">mdsc</span><span class="p">);</span>

	<span class="n">wait_unsafe_requests</span><span class="p">(</span><span class="n">mdsc</span><span class="p">,</span> <span class="n">want_tid</span><span class="p">);</span>
	<span class="n">wait_event</span><span class="p">(</span><span class="n">mdsc</span><span class="o">-&gt;</span><span class="n">cap_flushing_wq</span><span class="p">,</span> <span class="n">check_cap_flush</span><span class="p">(</span><span class="n">mdsc</span><span class="p">,</span> <span class="n">want_flush</span><span class="p">));</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * true if all sessions are closed, or we force unmount</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">bool</span> <span class="nf">done_closing_sessions</span><span class="p">(</span><span class="k">struct</span> <span class="n">ceph_mds_client</span> <span class="o">*</span><span class="n">mdsc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">n</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mdsc</span><span class="o">-&gt;</span><span class="n">fsc</span><span class="o">-&gt;</span><span class="n">mount_state</span> <span class="o">==</span> <span class="n">CEPH_MOUNT_SHUTDOWN</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdsc</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">mdsc</span><span class="o">-&gt;</span><span class="n">max_sessions</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mdsc</span><span class="o">-&gt;</span><span class="n">sessions</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
			<span class="n">n</span><span class="o">++</span><span class="p">;</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdsc</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">n</span> <span class="o">==</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * called after sb is ro.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">ceph_mdsc_close_sessions</span><span class="p">(</span><span class="k">struct</span> <span class="n">ceph_mds_client</span> <span class="o">*</span><span class="n">mdsc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ceph_mds_session</span> <span class="o">*</span><span class="n">session</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ceph_fs_client</span> <span class="o">*</span><span class="n">fsc</span> <span class="o">=</span> <span class="n">mdsc</span><span class="o">-&gt;</span><span class="n">fsc</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">timeout</span> <span class="o">=</span> <span class="n">fsc</span><span class="o">-&gt;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">options</span><span class="o">-&gt;</span><span class="n">mount_timeout</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">;</span>

	<span class="n">dout</span><span class="p">(</span><span class="s">&quot;close_sessions</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/* close sessions */</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdsc</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">mdsc</span><span class="o">-&gt;</span><span class="n">max_sessions</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">session</span> <span class="o">=</span> <span class="n">__ceph_lookup_mds_session</span><span class="p">(</span><span class="n">mdsc</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">session</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdsc</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
		<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">session</span><span class="o">-&gt;</span><span class="n">s_mutex</span><span class="p">);</span>
		<span class="n">__close_session</span><span class="p">(</span><span class="n">mdsc</span><span class="p">,</span> <span class="n">session</span><span class="p">);</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">session</span><span class="o">-&gt;</span><span class="n">s_mutex</span><span class="p">);</span>
		<span class="n">ceph_put_mds_session</span><span class="p">(</span><span class="n">session</span><span class="p">);</span>
		<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdsc</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdsc</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="n">dout</span><span class="p">(</span><span class="s">&quot;waiting for sessions to close</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">wait_event_timeout</span><span class="p">(</span><span class="n">mdsc</span><span class="o">-&gt;</span><span class="n">session_close_wq</span><span class="p">,</span> <span class="n">done_closing_sessions</span><span class="p">(</span><span class="n">mdsc</span><span class="p">),</span>
			   <span class="n">timeout</span><span class="p">);</span>

	<span class="cm">/* tear down remaining sessions */</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdsc</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">mdsc</span><span class="o">-&gt;</span><span class="n">max_sessions</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mdsc</span><span class="o">-&gt;</span><span class="n">sessions</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="p">{</span>
			<span class="n">session</span> <span class="o">=</span> <span class="n">get_session</span><span class="p">(</span><span class="n">mdsc</span><span class="o">-&gt;</span><span class="n">sessions</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
			<span class="n">__unregister_session</span><span class="p">(</span><span class="n">mdsc</span><span class="p">,</span> <span class="n">session</span><span class="p">);</span>
			<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdsc</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
			<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">session</span><span class="o">-&gt;</span><span class="n">s_mutex</span><span class="p">);</span>
			<span class="n">remove_session_caps</span><span class="p">(</span><span class="n">session</span><span class="p">);</span>
			<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">session</span><span class="o">-&gt;</span><span class="n">s_mutex</span><span class="p">);</span>
			<span class="n">ceph_put_mds_session</span><span class="p">(</span><span class="n">session</span><span class="p">);</span>
			<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdsc</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">WARN_ON</span><span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdsc</span><span class="o">-&gt;</span><span class="n">cap_delay_list</span><span class="p">));</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdsc</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="n">ceph_cleanup_empty_realms</span><span class="p">(</span><span class="n">mdsc</span><span class="p">);</span>

	<span class="n">cancel_delayed_work_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdsc</span><span class="o">-&gt;</span><span class="n">delayed_work</span><span class="p">);</span> <span class="cm">/* cancel timer */</span>

	<span class="n">dout</span><span class="p">(</span><span class="s">&quot;stopped</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ceph_mdsc_stop</span><span class="p">(</span><span class="k">struct</span> <span class="n">ceph_mds_client</span> <span class="o">*</span><span class="n">mdsc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dout</span><span class="p">(</span><span class="s">&quot;stop</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">cancel_delayed_work_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdsc</span><span class="o">-&gt;</span><span class="n">delayed_work</span><span class="p">);</span> <span class="cm">/* cancel timer */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mdsc</span><span class="o">-&gt;</span><span class="n">mdsmap</span><span class="p">)</span>
		<span class="n">ceph_mdsmap_destroy</span><span class="p">(</span><span class="n">mdsc</span><span class="o">-&gt;</span><span class="n">mdsmap</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">mdsc</span><span class="o">-&gt;</span><span class="n">sessions</span><span class="p">);</span>
	<span class="n">ceph_caps_finalize</span><span class="p">(</span><span class="n">mdsc</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">ceph_mdsc_destroy</span><span class="p">(</span><span class="k">struct</span> <span class="n">ceph_fs_client</span> <span class="o">*</span><span class="n">fsc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ceph_mds_client</span> <span class="o">*</span><span class="n">mdsc</span> <span class="o">=</span> <span class="n">fsc</span><span class="o">-&gt;</span><span class="n">mdsc</span><span class="p">;</span>

	<span class="n">dout</span><span class="p">(</span><span class="s">&quot;mdsc_destroy %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">mdsc</span><span class="p">);</span>
	<span class="n">ceph_mdsc_stop</span><span class="p">(</span><span class="n">mdsc</span><span class="p">);</span>

	<span class="cm">/* flush out any connection work with references to us */</span>
	<span class="n">ceph_msgr_flush</span><span class="p">();</span>

	<span class="n">fsc</span><span class="o">-&gt;</span><span class="n">mdsc</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">mdsc</span><span class="p">);</span>
	<span class="n">dout</span><span class="p">(</span><span class="s">&quot;mdsc_destroy %p done</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">mdsc</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * handle mds map update.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">ceph_mdsc_handle_map</span><span class="p">(</span><span class="k">struct</span> <span class="n">ceph_mds_client</span> <span class="o">*</span><span class="n">mdsc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ceph_msg</span> <span class="o">*</span><span class="n">msg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">epoch</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">maplen</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">msg</span><span class="o">-&gt;</span><span class="n">front</span><span class="p">.</span><span class="n">iov_base</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">end</span> <span class="o">=</span> <span class="n">p</span> <span class="o">+</span> <span class="n">msg</span><span class="o">-&gt;</span><span class="n">front</span><span class="p">.</span><span class="n">iov_len</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ceph_mdsmap</span> <span class="o">*</span><span class="n">newmap</span><span class="p">,</span> <span class="o">*</span><span class="n">oldmap</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ceph_fsid</span> <span class="n">fsid</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">ceph_decode_need</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">fsid</span><span class="p">)</span><span class="o">+</span><span class="mi">2</span><span class="o">*</span><span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">),</span> <span class="n">bad</span><span class="p">);</span>
	<span class="n">ceph_decode_copy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fsid</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">fsid</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ceph_check_fsid</span><span class="p">(</span><span class="n">mdsc</span><span class="o">-&gt;</span><span class="n">fsc</span><span class="o">-&gt;</span><span class="n">client</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fsid</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">epoch</span> <span class="o">=</span> <span class="n">ceph_decode_32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="p">);</span>
	<span class="n">maplen</span> <span class="o">=</span> <span class="n">ceph_decode_32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="p">);</span>
	<span class="n">dout</span><span class="p">(</span><span class="s">&quot;handle_map epoch %u len %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">epoch</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">maplen</span><span class="p">);</span>

	<span class="cm">/* do we need it? */</span>
	<span class="n">ceph_monc_got_mdsmap</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdsc</span><span class="o">-&gt;</span><span class="n">fsc</span><span class="o">-&gt;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">monc</span><span class="p">,</span> <span class="n">epoch</span><span class="p">);</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdsc</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mdsc</span><span class="o">-&gt;</span><span class="n">mdsmap</span> <span class="o">&amp;&amp;</span> <span class="n">epoch</span> <span class="o">&lt;=</span> <span class="n">mdsc</span><span class="o">-&gt;</span><span class="n">mdsmap</span><span class="o">-&gt;</span><span class="n">m_epoch</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dout</span><span class="p">(</span><span class="s">&quot;handle_map epoch %u &lt;= our %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		     <span class="n">epoch</span><span class="p">,</span> <span class="n">mdsc</span><span class="o">-&gt;</span><span class="n">mdsmap</span><span class="o">-&gt;</span><span class="n">m_epoch</span><span class="p">);</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdsc</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">newmap</span> <span class="o">=</span> <span class="n">ceph_mdsmap_decode</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="p">,</span> <span class="n">end</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">newmap</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">newmap</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">bad_unlock</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* swap into place */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mdsc</span><span class="o">-&gt;</span><span class="n">mdsmap</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">oldmap</span> <span class="o">=</span> <span class="n">mdsc</span><span class="o">-&gt;</span><span class="n">mdsmap</span><span class="p">;</span>
		<span class="n">mdsc</span><span class="o">-&gt;</span><span class="n">mdsmap</span> <span class="o">=</span> <span class="n">newmap</span><span class="p">;</span>
		<span class="n">check_new_map</span><span class="p">(</span><span class="n">mdsc</span><span class="p">,</span> <span class="n">newmap</span><span class="p">,</span> <span class="n">oldmap</span><span class="p">);</span>
		<span class="n">ceph_mdsmap_destroy</span><span class="p">(</span><span class="n">oldmap</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">mdsc</span><span class="o">-&gt;</span><span class="n">mdsmap</span> <span class="o">=</span> <span class="n">newmap</span><span class="p">;</span>  <span class="cm">/* first mds map */</span>
	<span class="p">}</span>
	<span class="n">mdsc</span><span class="o">-&gt;</span><span class="n">fsc</span><span class="o">-&gt;</span><span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_maxbytes</span> <span class="o">=</span> <span class="n">mdsc</span><span class="o">-&gt;</span><span class="n">mdsmap</span><span class="o">-&gt;</span><span class="n">m_max_file_size</span><span class="p">;</span>

	<span class="n">__wake_requests</span><span class="p">(</span><span class="n">mdsc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mdsc</span><span class="o">-&gt;</span><span class="n">waiting_for_map</span><span class="p">);</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdsc</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="n">schedule_delayed</span><span class="p">(</span><span class="n">mdsc</span><span class="p">);</span>
	<span class="k">return</span><span class="p">;</span>

<span class="nl">bad_unlock:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdsc</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
<span class="nl">bad:</span>
	<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;error decoding mdsmap %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">ceph_connection</span> <span class="o">*</span><span class="nf">con_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">ceph_connection</span> <span class="o">*</span><span class="n">con</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ceph_mds_session</span> <span class="o">*</span><span class="n">s</span> <span class="o">=</span> <span class="n">con</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">get_session</span><span class="p">(</span><span class="n">s</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dout</span><span class="p">(</span><span class="s">&quot;mdsc con_get %p ok (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">s_ref</span><span class="p">));</span>
		<span class="k">return</span> <span class="n">con</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">dout</span><span class="p">(</span><span class="s">&quot;mdsc con_get %p FAIL</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">s</span><span class="p">);</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">con_put</span><span class="p">(</span><span class="k">struct</span> <span class="n">ceph_connection</span> <span class="o">*</span><span class="n">con</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ceph_mds_session</span> <span class="o">*</span><span class="n">s</span> <span class="o">=</span> <span class="n">con</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>

	<span class="n">dout</span><span class="p">(</span><span class="s">&quot;mdsc con_put %p (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">s_ref</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">ceph_put_mds_session</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * if the client is unresponsive for long enough, the mds will kill</span>
<span class="cm"> * the session entirely.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">peer_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">ceph_connection</span> <span class="o">*</span><span class="n">con</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ceph_mds_session</span> <span class="o">*</span><span class="n">s</span> <span class="o">=</span> <span class="n">con</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ceph_mds_client</span> <span class="o">*</span><span class="n">mdsc</span> <span class="o">=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">s_mdsc</span><span class="p">;</span>

	<span class="n">pr_warning</span><span class="p">(</span><span class="s">&quot;mds%d closed our session</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">s_mds</span><span class="p">);</span>
	<span class="n">send_mds_reconnect</span><span class="p">(</span><span class="n">mdsc</span><span class="p">,</span> <span class="n">s</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dispatch</span><span class="p">(</span><span class="k">struct</span> <span class="n">ceph_connection</span> <span class="o">*</span><span class="n">con</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ceph_msg</span> <span class="o">*</span><span class="n">msg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ceph_mds_session</span> <span class="o">*</span><span class="n">s</span> <span class="o">=</span> <span class="n">con</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ceph_mds_client</span> <span class="o">*</span><span class="n">mdsc</span> <span class="o">=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">s_mdsc</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">type</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">type</span><span class="p">);</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdsc</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">__verify_registered_session</span><span class="p">(</span><span class="n">mdsc</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdsc</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdsc</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">CEPH_MSG_MDS_MAP</span>:
		<span class="n">ceph_mdsc_handle_map</span><span class="p">(</span><span class="n">mdsc</span><span class="p">,</span> <span class="n">msg</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CEPH_MSG_CLIENT_SESSION</span>:
		<span class="n">handle_session</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">msg</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CEPH_MSG_CLIENT_REPLY</span>:
		<span class="n">handle_reply</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">msg</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CEPH_MSG_CLIENT_REQUEST_FORWARD</span>:
		<span class="n">handle_forward</span><span class="p">(</span><span class="n">mdsc</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">msg</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CEPH_MSG_CLIENT_CAPS</span>:
		<span class="n">ceph_handle_caps</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">msg</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CEPH_MSG_CLIENT_SNAP</span>:
		<span class="n">ceph_handle_snap</span><span class="p">(</span><span class="n">mdsc</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">msg</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CEPH_MSG_CLIENT_LEASE</span>:
		<span class="n">handle_lease</span><span class="p">(</span><span class="n">mdsc</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">msg</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;received unknown message type %d %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">type</span><span class="p">,</span>
		       <span class="n">ceph_msg_type_name</span><span class="p">(</span><span class="n">type</span><span class="p">));</span>
	<span class="p">}</span>
<span class="nl">out:</span>
	<span class="n">ceph_msg_put</span><span class="p">(</span><span class="n">msg</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * authentication</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> * Note: returned pointer is the address of a structure that&#39;s</span>
<span class="cm"> * managed separately.  Caller must *not* attempt to free it.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">ceph_auth_handshake</span> <span class="o">*</span><span class="nf">get_authorizer</span><span class="p">(</span><span class="k">struct</span> <span class="n">ceph_connection</span> <span class="o">*</span><span class="n">con</span><span class="p">,</span>
					<span class="kt">int</span> <span class="o">*</span><span class="n">proto</span><span class="p">,</span> <span class="kt">int</span> <span class="n">force_new</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ceph_mds_session</span> <span class="o">*</span><span class="n">s</span> <span class="o">=</span> <span class="n">con</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ceph_mds_client</span> <span class="o">*</span><span class="n">mdsc</span> <span class="o">=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">s_mdsc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ceph_auth_client</span> <span class="o">*</span><span class="n">ac</span> <span class="o">=</span> <span class="n">mdsc</span><span class="o">-&gt;</span><span class="n">fsc</span><span class="o">-&gt;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">monc</span><span class="p">.</span><span class="n">auth</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ceph_auth_handshake</span> <span class="o">*</span><span class="n">auth</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">s_auth</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">force_new</span> <span class="o">&amp;&amp;</span> <span class="n">auth</span><span class="o">-&gt;</span><span class="n">authorizer</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ac</span><span class="o">-&gt;</span><span class="n">ops</span> <span class="o">&amp;&amp;</span> <span class="n">ac</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">destroy_authorizer</span><span class="p">)</span>
			<span class="n">ac</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">destroy_authorizer</span><span class="p">(</span><span class="n">ac</span><span class="p">,</span> <span class="n">auth</span><span class="o">-&gt;</span><span class="n">authorizer</span><span class="p">);</span>
		<span class="n">auth</span><span class="o">-&gt;</span><span class="n">authorizer</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">auth</span><span class="o">-&gt;</span><span class="n">authorizer</span> <span class="o">&amp;&amp;</span> <span class="n">ac</span><span class="o">-&gt;</span><span class="n">ops</span> <span class="o">&amp;&amp;</span> <span class="n">ac</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">create_authorizer</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">ac</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">create_authorizer</span><span class="p">(</span><span class="n">ac</span><span class="p">,</span> <span class="n">CEPH_ENTITY_TYPE_MDS</span><span class="p">,</span>
							<span class="n">auth</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="n">ret</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="o">*</span><span class="n">proto</span> <span class="o">=</span> <span class="n">ac</span><span class="o">-&gt;</span><span class="n">protocol</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">auth</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">verify_authorizer_reply</span><span class="p">(</span><span class="k">struct</span> <span class="n">ceph_connection</span> <span class="o">*</span><span class="n">con</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ceph_mds_session</span> <span class="o">*</span><span class="n">s</span> <span class="o">=</span> <span class="n">con</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ceph_mds_client</span> <span class="o">*</span><span class="n">mdsc</span> <span class="o">=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">s_mdsc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ceph_auth_client</span> <span class="o">*</span><span class="n">ac</span> <span class="o">=</span> <span class="n">mdsc</span><span class="o">-&gt;</span><span class="n">fsc</span><span class="o">-&gt;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">monc</span><span class="p">.</span><span class="n">auth</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">ac</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">verify_authorizer_reply</span><span class="p">(</span><span class="n">ac</span><span class="p">,</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">s_auth</span><span class="p">.</span><span class="n">authorizer</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">invalidate_authorizer</span><span class="p">(</span><span class="k">struct</span> <span class="n">ceph_connection</span> <span class="o">*</span><span class="n">con</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ceph_mds_session</span> <span class="o">*</span><span class="n">s</span> <span class="o">=</span> <span class="n">con</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ceph_mds_client</span> <span class="o">*</span><span class="n">mdsc</span> <span class="o">=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">s_mdsc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ceph_auth_client</span> <span class="o">*</span><span class="n">ac</span> <span class="o">=</span> <span class="n">mdsc</span><span class="o">-&gt;</span><span class="n">fsc</span><span class="o">-&gt;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">monc</span><span class="p">.</span><span class="n">auth</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ac</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">invalidate_authorizer</span><span class="p">)</span>
		<span class="n">ac</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">invalidate_authorizer</span><span class="p">(</span><span class="n">ac</span><span class="p">,</span> <span class="n">CEPH_ENTITY_TYPE_MDS</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ceph_monc_validate_auth</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdsc</span><span class="o">-&gt;</span><span class="n">fsc</span><span class="o">-&gt;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">monc</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">ceph_connection_operations</span> <span class="n">mds_con_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">get</span> <span class="o">=</span> <span class="n">con_get</span><span class="p">,</span>
	<span class="p">.</span><span class="n">put</span> <span class="o">=</span> <span class="n">con_put</span><span class="p">,</span>
	<span class="p">.</span><span class="n">dispatch</span> <span class="o">=</span> <span class="n">dispatch</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_authorizer</span> <span class="o">=</span> <span class="n">get_authorizer</span><span class="p">,</span>
	<span class="p">.</span><span class="n">verify_authorizer_reply</span> <span class="o">=</span> <span class="n">verify_authorizer_reply</span><span class="p">,</span>
	<span class="p">.</span><span class="n">invalidate_authorizer</span> <span class="o">=</span> <span class="n">invalidate_authorizer</span><span class="p">,</span>
	<span class="p">.</span><span class="n">peer_reset</span> <span class="o">=</span> <span class="n">peer_reset</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* eof */</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
