<!DOCTYPE html>
<html><head><title>joekychen/linux » fs › ceph › xattr.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>xattr.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cp">#include &lt;linux/ceph/ceph_debug.h&gt;</span>

<span class="cp">#include &quot;super.h&quot;</span>
<span class="cp">#include &quot;mds_client.h&quot;</span>

<span class="cp">#include &lt;linux/ceph/decode.h&gt;</span>

<span class="cp">#include &lt;linux/xattr.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>

<span class="cp">#define XATTR_CEPH_PREFIX &quot;ceph.&quot;</span>
<span class="cp">#define XATTR_CEPH_PREFIX_LEN (sizeof (XATTR_CEPH_PREFIX) - 1)</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">ceph_is_valid_xattr</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">XATTR_CEPH_PREFIX</span><span class="p">,</span> <span class="n">XATTR_CEPH_PREFIX_LEN</span><span class="p">)</span> <span class="o">||</span>
	       <span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">XATTR_SECURITY_PREFIX</span><span class="p">,</span>
			<span class="n">XATTR_SECURITY_PREFIX_LEN</span><span class="p">)</span> <span class="o">||</span>
	       <span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">XATTR_TRUSTED_PREFIX</span><span class="p">,</span> <span class="n">XATTR_TRUSTED_PREFIX_LEN</span><span class="p">)</span> <span class="o">||</span>
	       <span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">XATTR_USER_PREFIX</span><span class="p">,</span> <span class="n">XATTR_USER_PREFIX_LEN</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * These define virtual xattrs exposing the recursive directory</span>
<span class="cm"> * statistics and layout metadata.</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">ceph_vxattr</span> <span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">name_size</span><span class="p">;</span>	<span class="cm">/* strlen(name) + 1 (for &#39;\0&#39;) */</span>
	<span class="kt">size_t</span> <span class="p">(</span><span class="o">*</span><span class="n">getxattr_cb</span><span class="p">)(</span><span class="k">struct</span> <span class="n">ceph_inode_info</span> <span class="o">*</span><span class="n">ci</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">val</span><span class="p">,</span>
			      <span class="kt">size_t</span> <span class="n">size</span><span class="p">);</span>
	<span class="n">bool</span> <span class="n">readonly</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/* directories */</span>

<span class="k">static</span> <span class="kt">size_t</span> <span class="nf">ceph_vxattrcb_dir_entries</span><span class="p">(</span><span class="k">struct</span> <span class="n">ceph_inode_info</span> <span class="o">*</span><span class="n">ci</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">val</span><span class="p">,</span>
					<span class="kt">size_t</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="s">&quot;%lld&quot;</span><span class="p">,</span> <span class="n">ci</span><span class="o">-&gt;</span><span class="n">i_files</span> <span class="o">+</span> <span class="n">ci</span><span class="o">-&gt;</span><span class="n">i_subdirs</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">size_t</span> <span class="nf">ceph_vxattrcb_dir_files</span><span class="p">(</span><span class="k">struct</span> <span class="n">ceph_inode_info</span> <span class="o">*</span><span class="n">ci</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">val</span><span class="p">,</span>
				      <span class="kt">size_t</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="s">&quot;%lld&quot;</span><span class="p">,</span> <span class="n">ci</span><span class="o">-&gt;</span><span class="n">i_files</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">size_t</span> <span class="nf">ceph_vxattrcb_dir_subdirs</span><span class="p">(</span><span class="k">struct</span> <span class="n">ceph_inode_info</span> <span class="o">*</span><span class="n">ci</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">val</span><span class="p">,</span>
					<span class="kt">size_t</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="s">&quot;%lld&quot;</span><span class="p">,</span> <span class="n">ci</span><span class="o">-&gt;</span><span class="n">i_subdirs</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">size_t</span> <span class="nf">ceph_vxattrcb_dir_rentries</span><span class="p">(</span><span class="k">struct</span> <span class="n">ceph_inode_info</span> <span class="o">*</span><span class="n">ci</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">val</span><span class="p">,</span>
					 <span class="kt">size_t</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="s">&quot;%lld&quot;</span><span class="p">,</span> <span class="n">ci</span><span class="o">-&gt;</span><span class="n">i_rfiles</span> <span class="o">+</span> <span class="n">ci</span><span class="o">-&gt;</span><span class="n">i_rsubdirs</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">size_t</span> <span class="nf">ceph_vxattrcb_dir_rfiles</span><span class="p">(</span><span class="k">struct</span> <span class="n">ceph_inode_info</span> <span class="o">*</span><span class="n">ci</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">val</span><span class="p">,</span>
				       <span class="kt">size_t</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="s">&quot;%lld&quot;</span><span class="p">,</span> <span class="n">ci</span><span class="o">-&gt;</span><span class="n">i_rfiles</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">size_t</span> <span class="nf">ceph_vxattrcb_dir_rsubdirs</span><span class="p">(</span><span class="k">struct</span> <span class="n">ceph_inode_info</span> <span class="o">*</span><span class="n">ci</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">val</span><span class="p">,</span>
					 <span class="kt">size_t</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="s">&quot;%lld&quot;</span><span class="p">,</span> <span class="n">ci</span><span class="o">-&gt;</span><span class="n">i_rsubdirs</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">size_t</span> <span class="nf">ceph_vxattrcb_dir_rbytes</span><span class="p">(</span><span class="k">struct</span> <span class="n">ceph_inode_info</span> <span class="o">*</span><span class="n">ci</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">val</span><span class="p">,</span>
				       <span class="kt">size_t</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="s">&quot;%lld&quot;</span><span class="p">,</span> <span class="n">ci</span><span class="o">-&gt;</span><span class="n">i_rbytes</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">size_t</span> <span class="nf">ceph_vxattrcb_dir_rctime</span><span class="p">(</span><span class="k">struct</span> <span class="n">ceph_inode_info</span> <span class="o">*</span><span class="n">ci</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">val</span><span class="p">,</span>
				       <span class="kt">size_t</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="s">&quot;%ld.09%ld&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">long</span><span class="p">)</span><span class="n">ci</span><span class="o">-&gt;</span><span class="n">i_rctime</span><span class="p">.</span><span class="n">tv_sec</span><span class="p">,</span>
			<span class="p">(</span><span class="kt">long</span><span class="p">)</span><span class="n">ci</span><span class="o">-&gt;</span><span class="n">i_rctime</span><span class="p">.</span><span class="n">tv_nsec</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#define CEPH_XATTR_NAME(_type, _name)	XATTR_CEPH_PREFIX #_type &quot;.&quot; #_name</span>

<span class="cp">#define XATTR_NAME_CEPH(_type, _name) \</span>
<span class="cp">		{ \</span>
<span class="cp">			.name = CEPH_XATTR_NAME(_type, _name), \</span>
<span class="cp">			.name_size = sizeof (CEPH_XATTR_NAME(_type, _name)), \</span>
<span class="cp">			.getxattr_cb = ceph_vxattrcb_ ## _type ## _ ## _name, \</span>
<span class="cp">			.readonly = true, \</span>
<span class="cp">		}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">ceph_vxattr</span> <span class="n">ceph_dir_vxattrs</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">XATTR_NAME_CEPH</span><span class="p">(</span><span class="n">dir</span><span class="p">,</span> <span class="n">entries</span><span class="p">),</span>
	<span class="n">XATTR_NAME_CEPH</span><span class="p">(</span><span class="n">dir</span><span class="p">,</span> <span class="n">files</span><span class="p">),</span>
	<span class="n">XATTR_NAME_CEPH</span><span class="p">(</span><span class="n">dir</span><span class="p">,</span> <span class="n">subdirs</span><span class="p">),</span>
	<span class="n">XATTR_NAME_CEPH</span><span class="p">(</span><span class="n">dir</span><span class="p">,</span> <span class="n">rentries</span><span class="p">),</span>
	<span class="n">XATTR_NAME_CEPH</span><span class="p">(</span><span class="n">dir</span><span class="p">,</span> <span class="n">rfiles</span><span class="p">),</span>
	<span class="n">XATTR_NAME_CEPH</span><span class="p">(</span><span class="n">dir</span><span class="p">,</span> <span class="n">rsubdirs</span><span class="p">),</span>
	<span class="n">XATTR_NAME_CEPH</span><span class="p">(</span><span class="n">dir</span><span class="p">,</span> <span class="n">rbytes</span><span class="p">),</span>
	<span class="n">XATTR_NAME_CEPH</span><span class="p">(</span><span class="n">dir</span><span class="p">,</span> <span class="n">rctime</span><span class="p">),</span>
	<span class="p">{</span> <span class="mi">0</span> <span class="p">}</span>	<span class="cm">/* Required table terminator */</span>
<span class="p">};</span>
<span class="k">static</span> <span class="kt">size_t</span> <span class="n">ceph_dir_vxattrs_name_size</span><span class="p">;</span>	<span class="cm">/* total size of all names */</span>

<span class="cm">/* files */</span>

<span class="k">static</span> <span class="kt">size_t</span> <span class="nf">ceph_vxattrcb_file_layout</span><span class="p">(</span><span class="k">struct</span> <span class="n">ceph_inode_info</span> <span class="o">*</span><span class="n">ci</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">val</span><span class="p">,</span>
				   <span class="kt">size_t</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span>
		<span class="s">&quot;chunk_bytes=%lld</span><span class="se">\n</span><span class="s">stripe_count=%lld</span><span class="se">\n</span><span class="s">object_size=%lld</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">ceph_file_layout_su</span><span class="p">(</span><span class="n">ci</span><span class="o">-&gt;</span><span class="n">i_layout</span><span class="p">),</span>
		<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">ceph_file_layout_stripe_count</span><span class="p">(</span><span class="n">ci</span><span class="o">-&gt;</span><span class="n">i_layout</span><span class="p">),</span>
		<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">ceph_file_layout_object_size</span><span class="p">(</span><span class="n">ci</span><span class="o">-&gt;</span><span class="n">i_layout</span><span class="p">));</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">ceph_vxattr</span> <span class="n">ceph_file_vxattrs</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">XATTR_NAME_CEPH</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">layout</span><span class="p">),</span>
	<span class="cm">/* The following extended attribute name is deprecated */</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">XATTR_CEPH_PREFIX</span> <span class="s">&quot;layout&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name_size</span> <span class="o">=</span> <span class="k">sizeof</span> <span class="p">(</span><span class="n">XATTR_CEPH_PREFIX</span> <span class="s">&quot;layout&quot;</span><span class="p">),</span>
		<span class="p">.</span><span class="n">getxattr_cb</span> <span class="o">=</span> <span class="n">ceph_vxattrcb_file_layout</span><span class="p">,</span>
		<span class="p">.</span><span class="n">readonly</span> <span class="o">=</span> <span class="nb">true</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span> <span class="mi">0</span> <span class="p">}</span>	<span class="cm">/* Required table terminator */</span>
<span class="p">};</span>
<span class="k">static</span> <span class="kt">size_t</span> <span class="n">ceph_file_vxattrs_name_size</span><span class="p">;</span>	<span class="cm">/* total size of all names */</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">ceph_vxattr</span> <span class="o">*</span><span class="nf">ceph_inode_vxattrs</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">S_ISDIR</span><span class="p">(</span><span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_mode</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">ceph_dir_vxattrs</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">S_ISREG</span><span class="p">(</span><span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_mode</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">ceph_file_vxattrs</span><span class="p">;</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">size_t</span> <span class="nf">ceph_vxattrs_name_size</span><span class="p">(</span><span class="k">struct</span> <span class="n">ceph_vxattr</span> <span class="o">*</span><span class="n">vxattrs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vxattrs</span> <span class="o">==</span> <span class="n">ceph_dir_vxattrs</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ceph_dir_vxattrs_name_size</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vxattrs</span> <span class="o">==</span> <span class="n">ceph_file_vxattrs</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ceph_file_vxattrs_name_size</span><span class="p">;</span>
	<span class="n">BUG</span><span class="p">();</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Compute the aggregate size (including terminating &#39;\0&#39;) of all</span>
<span class="cm"> * virtual extended attribute names in the given vxattr table.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">size_t</span> <span class="n">__init</span> <span class="nf">vxattrs_name_size</span><span class="p">(</span><span class="k">struct</span> <span class="n">ceph_vxattr</span> <span class="o">*</span><span class="n">vxattrs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ceph_vxattr</span> <span class="o">*</span><span class="n">vxattr</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">vxattr</span> <span class="o">=</span> <span class="n">vxattrs</span><span class="p">;</span> <span class="n">vxattr</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">;</span> <span class="n">vxattr</span><span class="o">++</span><span class="p">)</span>
		<span class="n">size</span> <span class="o">+=</span> <span class="n">vxattr</span><span class="o">-&gt;</span><span class="n">name_size</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">size</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Routines called at initialization and exit time */</span>

<span class="kt">void</span> <span class="n">__init</span> <span class="nf">ceph_xattr_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ceph_dir_vxattrs_name_size</span> <span class="o">=</span> <span class="n">vxattrs_name_size</span><span class="p">(</span><span class="n">ceph_dir_vxattrs</span><span class="p">);</span>
	<span class="n">ceph_file_vxattrs_name_size</span> <span class="o">=</span> <span class="n">vxattrs_name_size</span><span class="p">(</span><span class="n">ceph_file_vxattrs</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">ceph_xattr_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ceph_dir_vxattrs_name_size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ceph_file_vxattrs_name_size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">ceph_vxattr</span> <span class="o">*</span><span class="nf">ceph_match_vxattr</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span>
						<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ceph_vxattr</span> <span class="o">*</span><span class="n">vxattr</span> <span class="o">=</span> <span class="n">ceph_inode_vxattrs</span><span class="p">(</span><span class="n">inode</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vxattr</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">vxattr</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">vxattr</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">name</span><span class="p">))</span>
				<span class="k">return</span> <span class="n">vxattr</span><span class="p">;</span>
			<span class="n">vxattr</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">__set_xattr</span><span class="p">(</span><span class="k">struct</span> <span class="n">ceph_inode_info</span> <span class="o">*</span><span class="n">ci</span><span class="p">,</span>
			   <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span> <span class="kt">int</span> <span class="n">name_len</span><span class="p">,</span>
			   <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">val</span><span class="p">,</span> <span class="kt">int</span> <span class="n">val_len</span><span class="p">,</span>
			   <span class="kt">int</span> <span class="n">dirty</span><span class="p">,</span>
			   <span class="kt">int</span> <span class="n">should_free_name</span><span class="p">,</span> <span class="kt">int</span> <span class="n">should_free_val</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">ceph_inode_xattr</span> <span class="o">**</span><span class="n">newxattr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rb_node</span> <span class="o">**</span><span class="n">p</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rb_node</span> <span class="o">*</span><span class="n">parent</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ceph_inode_xattr</span> <span class="o">*</span><span class="n">xattr</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">c</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">new</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">p</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ci</span><span class="o">-&gt;</span><span class="n">i_xattrs</span><span class="p">.</span><span class="n">index</span><span class="p">.</span><span class="n">rb_node</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">*</span><span class="n">p</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">parent</span> <span class="o">=</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
		<span class="n">xattr</span> <span class="o">=</span> <span class="n">rb_entry</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ceph_inode_xattr</span><span class="p">,</span> <span class="n">node</span><span class="p">);</span>
		<span class="n">c</span> <span class="o">=</span> <span class="n">strncmp</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">xattr</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">min</span><span class="p">(</span><span class="n">name_len</span><span class="p">,</span> <span class="n">xattr</span><span class="o">-&gt;</span><span class="n">name_len</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">p</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="o">*</span><span class="n">p</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">rb_left</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">p</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="o">*</span><span class="n">p</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">rb_right</span><span class="p">;</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">name_len</span> <span class="o">==</span> <span class="n">xattr</span><span class="o">-&gt;</span><span class="n">name_len</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">name_len</span> <span class="o">&lt;</span> <span class="n">xattr</span><span class="o">-&gt;</span><span class="n">name_len</span><span class="p">)</span>
				<span class="n">p</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="o">*</span><span class="n">p</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">rb_left</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">p</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="o">*</span><span class="n">p</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">rb_right</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">xattr</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">xattr</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">new</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">xattr</span> <span class="o">=</span> <span class="o">*</span><span class="n">newxattr</span><span class="p">;</span>
		<span class="n">xattr</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span><span class="p">;</span>
		<span class="n">xattr</span><span class="o">-&gt;</span><span class="n">name_len</span> <span class="o">=</span> <span class="n">name_len</span><span class="p">;</span>
		<span class="n">xattr</span><span class="o">-&gt;</span><span class="n">should_free_name</span> <span class="o">=</span> <span class="n">should_free_name</span><span class="p">;</span>

		<span class="n">ci</span><span class="o">-&gt;</span><span class="n">i_xattrs</span><span class="p">.</span><span class="n">count</span><span class="o">++</span><span class="p">;</span>
		<span class="n">dout</span><span class="p">(</span><span class="s">&quot;__set_xattr count=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ci</span><span class="o">-&gt;</span><span class="n">i_xattrs</span><span class="p">.</span><span class="n">count</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="o">*</span><span class="n">newxattr</span><span class="p">);</span>
		<span class="o">*</span><span class="n">newxattr</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">xattr</span><span class="o">-&gt;</span><span class="n">should_free_val</span><span class="p">)</span>
			<span class="n">kfree</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">xattr</span><span class="o">-&gt;</span><span class="n">val</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">should_free_name</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">kfree</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">name</span><span class="p">);</span>
			<span class="n">name</span> <span class="o">=</span> <span class="n">xattr</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">ci</span><span class="o">-&gt;</span><span class="n">i_xattrs</span><span class="p">.</span><span class="n">names_size</span> <span class="o">-=</span> <span class="n">xattr</span><span class="o">-&gt;</span><span class="n">name_len</span><span class="p">;</span>
		<span class="n">ci</span><span class="o">-&gt;</span><span class="n">i_xattrs</span><span class="p">.</span><span class="n">vals_size</span> <span class="o">-=</span> <span class="n">xattr</span><span class="o">-&gt;</span><span class="n">val_len</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ci</span><span class="o">-&gt;</span><span class="n">i_xattrs</span><span class="p">.</span><span class="n">names_size</span> <span class="o">+=</span> <span class="n">name_len</span><span class="p">;</span>
	<span class="n">ci</span><span class="o">-&gt;</span><span class="n">i_xattrs</span><span class="p">.</span><span class="n">vals_size</span> <span class="o">+=</span> <span class="n">val_len</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">val</span><span class="p">)</span>
		<span class="n">xattr</span><span class="o">-&gt;</span><span class="n">val</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">xattr</span><span class="o">-&gt;</span><span class="n">val</span> <span class="o">=</span> <span class="s">&quot;&quot;</span><span class="p">;</span>

	<span class="n">xattr</span><span class="o">-&gt;</span><span class="n">val_len</span> <span class="o">=</span> <span class="n">val_len</span><span class="p">;</span>
	<span class="n">xattr</span><span class="o">-&gt;</span><span class="n">dirty</span> <span class="o">=</span> <span class="n">dirty</span><span class="p">;</span>
	<span class="n">xattr</span><span class="o">-&gt;</span><span class="n">should_free_val</span> <span class="o">=</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;&amp;</span> <span class="n">should_free_val</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">new</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rb_link_node</span><span class="p">(</span><span class="o">&amp;</span><span class="n">xattr</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">,</span> <span class="n">parent</span><span class="p">,</span> <span class="n">p</span><span class="p">);</span>
		<span class="n">rb_insert_color</span><span class="p">(</span><span class="o">&amp;</span><span class="n">xattr</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ci</span><span class="o">-&gt;</span><span class="n">i_xattrs</span><span class="p">.</span><span class="n">index</span><span class="p">);</span>
		<span class="n">dout</span><span class="p">(</span><span class="s">&quot;__set_xattr_val p=%p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">p</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">dout</span><span class="p">(</span><span class="s">&quot;__set_xattr_val added %llx.%llx xattr %p %s=%.*s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	     <span class="n">ceph_vinop</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ci</span><span class="o">-&gt;</span><span class="n">vfs_inode</span><span class="p">),</span> <span class="n">xattr</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">val_len</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">ceph_inode_xattr</span> <span class="o">*</span><span class="nf">__get_xattr</span><span class="p">(</span><span class="k">struct</span> <span class="n">ceph_inode_info</span> <span class="o">*</span><span class="n">ci</span><span class="p">,</span>
			   <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rb_node</span> <span class="o">**</span><span class="n">p</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rb_node</span> <span class="o">*</span><span class="n">parent</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ceph_inode_xattr</span> <span class="o">*</span><span class="n">xattr</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">name_len</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">name</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">c</span><span class="p">;</span>

	<span class="n">p</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ci</span><span class="o">-&gt;</span><span class="n">i_xattrs</span><span class="p">.</span><span class="n">index</span><span class="p">.</span><span class="n">rb_node</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">*</span><span class="n">p</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">parent</span> <span class="o">=</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
		<span class="n">xattr</span> <span class="o">=</span> <span class="n">rb_entry</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ceph_inode_xattr</span><span class="p">,</span> <span class="n">node</span><span class="p">);</span>
		<span class="n">c</span> <span class="o">=</span> <span class="n">strncmp</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">xattr</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">xattr</span><span class="o">-&gt;</span><span class="n">name_len</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">name_len</span> <span class="o">&gt;</span> <span class="n">xattr</span><span class="o">-&gt;</span><span class="n">name_len</span><span class="p">)</span>
			<span class="n">c</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">p</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="o">*</span><span class="n">p</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">rb_left</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">p</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="o">*</span><span class="n">p</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">rb_right</span><span class="p">;</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="n">dout</span><span class="p">(</span><span class="s">&quot;__get_xattr %s: found %.*s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span>
			     <span class="n">xattr</span><span class="o">-&gt;</span><span class="n">val_len</span><span class="p">,</span> <span class="n">xattr</span><span class="o">-&gt;</span><span class="n">val</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">xattr</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">dout</span><span class="p">(</span><span class="s">&quot;__get_xattr %s: not found</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>

	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">__free_xattr</span><span class="p">(</span><span class="k">struct</span> <span class="n">ceph_inode_xattr</span> <span class="o">*</span><span class="n">xattr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">xattr</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">xattr</span><span class="o">-&gt;</span><span class="n">should_free_name</span><span class="p">)</span>
		<span class="n">kfree</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">xattr</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">xattr</span><span class="o">-&gt;</span><span class="n">should_free_val</span><span class="p">)</span>
		<span class="n">kfree</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">xattr</span><span class="o">-&gt;</span><span class="n">val</span><span class="p">);</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">xattr</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">__remove_xattr</span><span class="p">(</span><span class="k">struct</span> <span class="n">ceph_inode_info</span> <span class="o">*</span><span class="n">ci</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">ceph_inode_xattr</span> <span class="o">*</span><span class="n">xattr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">xattr</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>

	<span class="n">rb_erase</span><span class="p">(</span><span class="o">&amp;</span><span class="n">xattr</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ci</span><span class="o">-&gt;</span><span class="n">i_xattrs</span><span class="p">.</span><span class="n">index</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">xattr</span><span class="o">-&gt;</span><span class="n">should_free_name</span><span class="p">)</span>
		<span class="n">kfree</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">xattr</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">xattr</span><span class="o">-&gt;</span><span class="n">should_free_val</span><span class="p">)</span>
		<span class="n">kfree</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">xattr</span><span class="o">-&gt;</span><span class="n">val</span><span class="p">);</span>

	<span class="n">ci</span><span class="o">-&gt;</span><span class="n">i_xattrs</span><span class="p">.</span><span class="n">names_size</span> <span class="o">-=</span> <span class="n">xattr</span><span class="o">-&gt;</span><span class="n">name_len</span><span class="p">;</span>
	<span class="n">ci</span><span class="o">-&gt;</span><span class="n">i_xattrs</span><span class="p">.</span><span class="n">vals_size</span> <span class="o">-=</span> <span class="n">xattr</span><span class="o">-&gt;</span><span class="n">val_len</span><span class="p">;</span>
	<span class="n">ci</span><span class="o">-&gt;</span><span class="n">i_xattrs</span><span class="p">.</span><span class="n">count</span><span class="o">--</span><span class="p">;</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">xattr</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">__remove_xattr_by_name</span><span class="p">(</span><span class="k">struct</span> <span class="n">ceph_inode_info</span> <span class="o">*</span><span class="n">ci</span><span class="p">,</span>
			   <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rb_node</span> <span class="o">**</span><span class="n">p</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ceph_inode_xattr</span> <span class="o">*</span><span class="n">xattr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">p</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ci</span><span class="o">-&gt;</span><span class="n">i_xattrs</span><span class="p">.</span><span class="n">index</span><span class="p">.</span><span class="n">rb_node</span><span class="p">;</span>
	<span class="n">xattr</span> <span class="o">=</span> <span class="n">__get_xattr</span><span class="p">(</span><span class="n">ci</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">__remove_xattr</span><span class="p">(</span><span class="n">ci</span><span class="p">,</span> <span class="n">xattr</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="nf">__copy_xattr_names</span><span class="p">(</span><span class="k">struct</span> <span class="n">ceph_inode_info</span> <span class="o">*</span><span class="n">ci</span><span class="p">,</span>
				<span class="kt">char</span> <span class="o">*</span><span class="n">dest</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rb_node</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ceph_inode_xattr</span> <span class="o">*</span><span class="n">xattr</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">p</span> <span class="o">=</span> <span class="n">rb_first</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ci</span><span class="o">-&gt;</span><span class="n">i_xattrs</span><span class="p">.</span><span class="n">index</span><span class="p">);</span>
	<span class="n">dout</span><span class="p">(</span><span class="s">&quot;__copy_xattr_names count=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ci</span><span class="o">-&gt;</span><span class="n">i_xattrs</span><span class="p">.</span><span class="n">count</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">xattr</span> <span class="o">=</span> <span class="n">rb_entry</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ceph_inode_xattr</span><span class="p">,</span> <span class="n">node</span><span class="p">);</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">dest</span><span class="p">,</span> <span class="n">xattr</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">xattr</span><span class="o">-&gt;</span><span class="n">name_len</span><span class="p">);</span>
		<span class="n">dest</span><span class="p">[</span><span class="n">xattr</span><span class="o">-&gt;</span><span class="n">name_len</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>

		<span class="n">dout</span><span class="p">(</span><span class="s">&quot;dest=%s %p (%s) (%d/%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dest</span><span class="p">,</span> <span class="n">xattr</span><span class="p">,</span> <span class="n">xattr</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
		     <span class="n">xattr</span><span class="o">-&gt;</span><span class="n">name_len</span><span class="p">,</span> <span class="n">ci</span><span class="o">-&gt;</span><span class="n">i_xattrs</span><span class="p">.</span><span class="n">names_size</span><span class="p">);</span>

		<span class="n">dest</span> <span class="o">+=</span> <span class="n">xattr</span><span class="o">-&gt;</span><span class="n">name_len</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">p</span> <span class="o">=</span> <span class="n">rb_next</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">dest</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">__ceph_destroy_xattrs</span><span class="p">(</span><span class="k">struct</span> <span class="n">ceph_inode_info</span> <span class="o">*</span><span class="n">ci</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rb_node</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="o">*</span><span class="n">tmp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ceph_inode_xattr</span> <span class="o">*</span><span class="n">xattr</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">p</span> <span class="o">=</span> <span class="n">rb_first</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ci</span><span class="o">-&gt;</span><span class="n">i_xattrs</span><span class="p">.</span><span class="n">index</span><span class="p">);</span>

	<span class="n">dout</span><span class="p">(</span><span class="s">&quot;__ceph_destroy_xattrs p=%p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">p</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">xattr</span> <span class="o">=</span> <span class="n">rb_entry</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ceph_inode_xattr</span><span class="p">,</span> <span class="n">node</span><span class="p">);</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="n">p</span><span class="p">;</span>
		<span class="n">p</span> <span class="o">=</span> <span class="n">rb_next</span><span class="p">(</span><span class="n">tmp</span><span class="p">);</span>
		<span class="n">dout</span><span class="p">(</span><span class="s">&quot;__ceph_destroy_xattrs next p=%p (%.*s)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span>
		     <span class="n">xattr</span><span class="o">-&gt;</span><span class="n">name_len</span><span class="p">,</span> <span class="n">xattr</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="n">rb_erase</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ci</span><span class="o">-&gt;</span><span class="n">i_xattrs</span><span class="p">.</span><span class="n">index</span><span class="p">);</span>

		<span class="n">__free_xattr</span><span class="p">(</span><span class="n">xattr</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">ci</span><span class="o">-&gt;</span><span class="n">i_xattrs</span><span class="p">.</span><span class="n">names_size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ci</span><span class="o">-&gt;</span><span class="n">i_xattrs</span><span class="p">.</span><span class="n">vals_size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ci</span><span class="o">-&gt;</span><span class="n">i_xattrs</span><span class="p">.</span><span class="n">index_version</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ci</span><span class="o">-&gt;</span><span class="n">i_xattrs</span><span class="p">.</span><span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ci</span><span class="o">-&gt;</span><span class="n">i_xattrs</span><span class="p">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">RB_ROOT</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">__build_xattrs</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">)</span>
	<span class="n">__releases</span><span class="p">(</span><span class="n">ci</span><span class="o">-&gt;</span><span class="n">i_ceph_lock</span><span class="p">)</span>
	<span class="n">__acquires</span><span class="p">(</span><span class="n">ci</span><span class="o">-&gt;</span><span class="n">i_ceph_lock</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">namelen</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">numattr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="o">*</span><span class="n">end</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">len</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span> <span class="o">*</span><span class="n">val</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ceph_inode_info</span> <span class="o">*</span><span class="n">ci</span> <span class="o">=</span> <span class="n">ceph_inode</span><span class="p">(</span><span class="n">inode</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">xattr_version</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ceph_inode_xattr</span> <span class="o">**</span><span class="n">xattrs</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">dout</span><span class="p">(</span><span class="s">&quot;__build_xattrs() len=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	     <span class="n">ci</span><span class="o">-&gt;</span><span class="n">i_xattrs</span><span class="p">.</span><span class="n">blob</span> <span class="o">?</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">ci</span><span class="o">-&gt;</span><span class="n">i_xattrs</span><span class="p">.</span><span class="n">blob</span><span class="o">-&gt;</span><span class="n">vec</span><span class="p">.</span><span class="n">iov_len</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ci</span><span class="o">-&gt;</span><span class="n">i_xattrs</span><span class="p">.</span><span class="n">index_version</span> <span class="o">&gt;=</span> <span class="n">ci</span><span class="o">-&gt;</span><span class="n">i_xattrs</span><span class="p">.</span><span class="n">version</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* already built */</span>

	<span class="n">__ceph_destroy_xattrs</span><span class="p">(</span><span class="n">ci</span><span class="p">);</span>

<span class="nl">start:</span>
	<span class="cm">/* updated internal xattr rb tree */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ci</span><span class="o">-&gt;</span><span class="n">i_xattrs</span><span class="p">.</span><span class="n">blob</span> <span class="o">&amp;&amp;</span> <span class="n">ci</span><span class="o">-&gt;</span><span class="n">i_xattrs</span><span class="p">.</span><span class="n">blob</span><span class="o">-&gt;</span><span class="n">vec</span><span class="p">.</span><span class="n">iov_len</span> <span class="o">&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">p</span> <span class="o">=</span> <span class="n">ci</span><span class="o">-&gt;</span><span class="n">i_xattrs</span><span class="p">.</span><span class="n">blob</span><span class="o">-&gt;</span><span class="n">vec</span><span class="p">.</span><span class="n">iov_base</span><span class="p">;</span>
		<span class="n">end</span> <span class="o">=</span> <span class="n">p</span> <span class="o">+</span> <span class="n">ci</span><span class="o">-&gt;</span><span class="n">i_xattrs</span><span class="p">.</span><span class="n">blob</span><span class="o">-&gt;</span><span class="n">vec</span><span class="p">.</span><span class="n">iov_len</span><span class="p">;</span>
		<span class="n">ceph_decode_32_safe</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">numattr</span><span class="p">,</span> <span class="n">bad</span><span class="p">);</span>
		<span class="n">xattr_version</span> <span class="o">=</span> <span class="n">ci</span><span class="o">-&gt;</span><span class="n">i_xattrs</span><span class="p">.</span><span class="n">version</span><span class="p">;</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ci</span><span class="o">-&gt;</span><span class="n">i_ceph_lock</span><span class="p">);</span>

		<span class="n">xattrs</span> <span class="o">=</span> <span class="n">kcalloc</span><span class="p">(</span><span class="n">numattr</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ceph_xattr</span> <span class="o">*</span><span class="p">),</span>
				 <span class="n">GFP_NOFS</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">xattrs</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">bad_lock</span><span class="p">;</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">xattrs</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">numattr</span><span class="o">*</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ceph_xattr</span> <span class="o">*</span><span class="p">));</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">numattr</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">xattrs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ceph_inode_xattr</span><span class="p">),</span>
					    <span class="n">GFP_NOFS</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">xattrs</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
				<span class="k">goto</span> <span class="n">bad_lock</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ci</span><span class="o">-&gt;</span><span class="n">i_ceph_lock</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ci</span><span class="o">-&gt;</span><span class="n">i_xattrs</span><span class="p">.</span><span class="n">version</span> <span class="o">!=</span> <span class="n">xattr_version</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* lost a race, retry */</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">numattr</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
				<span class="n">kfree</span><span class="p">(</span><span class="n">xattrs</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">xattrs</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">start</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">numattr</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ceph_decode_32_safe</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">bad</span><span class="p">);</span>
			<span class="n">namelen</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>
			<span class="n">name</span> <span class="o">=</span> <span class="n">p</span><span class="p">;</span>
			<span class="n">p</span> <span class="o">+=</span> <span class="n">len</span><span class="p">;</span>
			<span class="n">ceph_decode_32_safe</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">bad</span><span class="p">);</span>
			<span class="n">val</span> <span class="o">=</span> <span class="n">p</span><span class="p">;</span>
			<span class="n">p</span> <span class="o">+=</span> <span class="n">len</span><span class="p">;</span>

			<span class="n">err</span> <span class="o">=</span> <span class="n">__set_xattr</span><span class="p">(</span><span class="n">ci</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">namelen</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span>
					  <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">xattrs</span><span class="p">[</span><span class="n">numattr</span><span class="p">]);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">bad</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">xattrs</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">ci</span><span class="o">-&gt;</span><span class="n">i_xattrs</span><span class="p">.</span><span class="n">index_version</span> <span class="o">=</span> <span class="n">ci</span><span class="o">-&gt;</span><span class="n">i_xattrs</span><span class="p">.</span><span class="n">version</span><span class="p">;</span>
	<span class="n">ci</span><span class="o">-&gt;</span><span class="n">i_xattrs</span><span class="p">.</span><span class="n">dirty</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="nl">bad_lock:</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ci</span><span class="o">-&gt;</span><span class="n">i_ceph_lock</span><span class="p">);</span>
<span class="nl">bad:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">xattrs</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">numattr</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">xattrs</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">xattrs</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">ci</span><span class="o">-&gt;</span><span class="n">i_xattrs</span><span class="p">.</span><span class="n">names_size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">__get_required_blob_size</span><span class="p">(</span><span class="k">struct</span> <span class="n">ceph_inode_info</span> <span class="o">*</span><span class="n">ci</span><span class="p">,</span> <span class="kt">int</span> <span class="n">name_size</span><span class="p">,</span>
				    <span class="kt">int</span> <span class="n">val_size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/*</span>
<span class="cm">	 * 4 bytes for the length, and additional 4 bytes per each xattr name,</span>
<span class="cm">	 * 4 bytes per each value</span>
<span class="cm">	 */</span>
	<span class="kt">int</span> <span class="n">size</span> <span class="o">=</span> <span class="mi">4</span> <span class="o">+</span> <span class="n">ci</span><span class="o">-&gt;</span><span class="n">i_xattrs</span><span class="p">.</span><span class="n">count</span><span class="o">*</span><span class="p">(</span><span class="mi">4</span> <span class="o">+</span> <span class="mi">4</span><span class="p">)</span> <span class="o">+</span>
			     <span class="n">ci</span><span class="o">-&gt;</span><span class="n">i_xattrs</span><span class="p">.</span><span class="n">names_size</span> <span class="o">+</span>
			     <span class="n">ci</span><span class="o">-&gt;</span><span class="n">i_xattrs</span><span class="p">.</span><span class="n">vals_size</span><span class="p">;</span>
	<span class="n">dout</span><span class="p">(</span><span class="s">&quot;__get_required_blob_size c=%d names.size=%d vals.size=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	     <span class="n">ci</span><span class="o">-&gt;</span><span class="n">i_xattrs</span><span class="p">.</span><span class="n">count</span><span class="p">,</span> <span class="n">ci</span><span class="o">-&gt;</span><span class="n">i_xattrs</span><span class="p">.</span><span class="n">names_size</span><span class="p">,</span>
	     <span class="n">ci</span><span class="o">-&gt;</span><span class="n">i_xattrs</span><span class="p">.</span><span class="n">vals_size</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">name_size</span><span class="p">)</span>
		<span class="n">size</span> <span class="o">+=</span> <span class="mi">4</span> <span class="o">+</span> <span class="mi">4</span> <span class="o">+</span> <span class="n">name_size</span> <span class="o">+</span> <span class="n">val_size</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">size</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * If there are dirty xattrs, reencode xattrs into the prealloc_blob</span>
<span class="cm"> * and swap into place.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">__ceph_build_xattrs_blob</span><span class="p">(</span><span class="k">struct</span> <span class="n">ceph_inode_info</span> <span class="o">*</span><span class="n">ci</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rb_node</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ceph_inode_xattr</span> <span class="o">*</span><span class="n">xattr</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">dest</span><span class="p">;</span>

	<span class="n">dout</span><span class="p">(</span><span class="s">&quot;__build_xattrs_blob %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ci</span><span class="o">-&gt;</span><span class="n">vfs_inode</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ci</span><span class="o">-&gt;</span><span class="n">i_xattrs</span><span class="p">.</span><span class="n">dirty</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">need</span> <span class="o">=</span> <span class="n">__get_required_blob_size</span><span class="p">(</span><span class="n">ci</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

		<span class="n">BUG_ON</span><span class="p">(</span><span class="n">need</span> <span class="o">&gt;</span> <span class="n">ci</span><span class="o">-&gt;</span><span class="n">i_xattrs</span><span class="p">.</span><span class="n">prealloc_blob</span><span class="o">-&gt;</span><span class="n">alloc_len</span><span class="p">);</span>

		<span class="n">p</span> <span class="o">=</span> <span class="n">rb_first</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ci</span><span class="o">-&gt;</span><span class="n">i_xattrs</span><span class="p">.</span><span class="n">index</span><span class="p">);</span>
		<span class="n">dest</span> <span class="o">=</span> <span class="n">ci</span><span class="o">-&gt;</span><span class="n">i_xattrs</span><span class="p">.</span><span class="n">prealloc_blob</span><span class="o">-&gt;</span><span class="n">vec</span><span class="p">.</span><span class="n">iov_base</span><span class="p">;</span>

		<span class="n">ceph_encode_32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dest</span><span class="p">,</span> <span class="n">ci</span><span class="o">-&gt;</span><span class="n">i_xattrs</span><span class="p">.</span><span class="n">count</span><span class="p">);</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">xattr</span> <span class="o">=</span> <span class="n">rb_entry</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ceph_inode_xattr</span><span class="p">,</span> <span class="n">node</span><span class="p">);</span>

			<span class="n">ceph_encode_32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dest</span><span class="p">,</span> <span class="n">xattr</span><span class="o">-&gt;</span><span class="n">name_len</span><span class="p">);</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">dest</span><span class="p">,</span> <span class="n">xattr</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">xattr</span><span class="o">-&gt;</span><span class="n">name_len</span><span class="p">);</span>
			<span class="n">dest</span> <span class="o">+=</span> <span class="n">xattr</span><span class="o">-&gt;</span><span class="n">name_len</span><span class="p">;</span>
			<span class="n">ceph_encode_32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dest</span><span class="p">,</span> <span class="n">xattr</span><span class="o">-&gt;</span><span class="n">val_len</span><span class="p">);</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">dest</span><span class="p">,</span> <span class="n">xattr</span><span class="o">-&gt;</span><span class="n">val</span><span class="p">,</span> <span class="n">xattr</span><span class="o">-&gt;</span><span class="n">val_len</span><span class="p">);</span>
			<span class="n">dest</span> <span class="o">+=</span> <span class="n">xattr</span><span class="o">-&gt;</span><span class="n">val_len</span><span class="p">;</span>

			<span class="n">p</span> <span class="o">=</span> <span class="n">rb_next</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="cm">/* adjust buffer len; it may be larger than we need */</span>
		<span class="n">ci</span><span class="o">-&gt;</span><span class="n">i_xattrs</span><span class="p">.</span><span class="n">prealloc_blob</span><span class="o">-&gt;</span><span class="n">vec</span><span class="p">.</span><span class="n">iov_len</span> <span class="o">=</span>
			<span class="n">dest</span> <span class="o">-</span> <span class="n">ci</span><span class="o">-&gt;</span><span class="n">i_xattrs</span><span class="p">.</span><span class="n">prealloc_blob</span><span class="o">-&gt;</span><span class="n">vec</span><span class="p">.</span><span class="n">iov_base</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ci</span><span class="o">-&gt;</span><span class="n">i_xattrs</span><span class="p">.</span><span class="n">blob</span><span class="p">)</span>
			<span class="n">ceph_buffer_put</span><span class="p">(</span><span class="n">ci</span><span class="o">-&gt;</span><span class="n">i_xattrs</span><span class="p">.</span><span class="n">blob</span><span class="p">);</span>
		<span class="n">ci</span><span class="o">-&gt;</span><span class="n">i_xattrs</span><span class="p">.</span><span class="n">blob</span> <span class="o">=</span> <span class="n">ci</span><span class="o">-&gt;</span><span class="n">i_xattrs</span><span class="p">.</span><span class="n">prealloc_blob</span><span class="p">;</span>
		<span class="n">ci</span><span class="o">-&gt;</span><span class="n">i_xattrs</span><span class="p">.</span><span class="n">prealloc_blob</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">ci</span><span class="o">-&gt;</span><span class="n">i_xattrs</span><span class="p">.</span><span class="n">dirty</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="n">ci</span><span class="o">-&gt;</span><span class="n">i_xattrs</span><span class="p">.</span><span class="n">version</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">ssize_t</span> <span class="nf">ceph_getxattr</span><span class="p">(</span><span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="n">dentry</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">value</span><span class="p">,</span>
		      <span class="kt">size_t</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span> <span class="o">=</span> <span class="n">dentry</span><span class="o">-&gt;</span><span class="n">d_inode</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ceph_inode_info</span> <span class="o">*</span><span class="n">ci</span> <span class="o">=</span> <span class="n">ceph_inode</span><span class="p">(</span><span class="n">inode</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ceph_inode_xattr</span> <span class="o">*</span><span class="n">xattr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ceph_vxattr</span> <span class="o">*</span><span class="n">vxattr</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ceph_is_valid_xattr</span><span class="p">(</span><span class="n">name</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODATA</span><span class="p">;</span>

	<span class="cm">/* let&#39;s see if a virtual xattr was requested */</span>
	<span class="n">vxattr</span> <span class="o">=</span> <span class="n">ceph_match_vxattr</span><span class="p">(</span><span class="n">inode</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ci</span><span class="o">-&gt;</span><span class="n">i_ceph_lock</span><span class="p">);</span>
	<span class="n">dout</span><span class="p">(</span><span class="s">&quot;getxattr %p ver=%lld index_ver=%lld</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">inode</span><span class="p">,</span>
	     <span class="n">ci</span><span class="o">-&gt;</span><span class="n">i_xattrs</span><span class="p">.</span><span class="n">version</span><span class="p">,</span> <span class="n">ci</span><span class="o">-&gt;</span><span class="n">i_xattrs</span><span class="p">.</span><span class="n">index_version</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">__ceph_caps_issued_mask</span><span class="p">(</span><span class="n">ci</span><span class="p">,</span> <span class="n">CEPH_CAP_XATTR_SHARED</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">ci</span><span class="o">-&gt;</span><span class="n">i_xattrs</span><span class="p">.</span><span class="n">index_version</span> <span class="o">&gt;=</span> <span class="n">ci</span><span class="o">-&gt;</span><span class="n">i_xattrs</span><span class="p">.</span><span class="n">version</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">goto</span> <span class="n">get_xattr</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ci</span><span class="o">-&gt;</span><span class="n">i_ceph_lock</span><span class="p">);</span>
		<span class="cm">/* get xattrs from mds (if we don&#39;t already have them) */</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">ceph_do_getattr</span><span class="p">(</span><span class="n">inode</span><span class="p">,</span> <span class="n">CEPH_STAT_CAP_XATTR</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ci</span><span class="o">-&gt;</span><span class="n">i_ceph_lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vxattr</span> <span class="o">&amp;&amp;</span> <span class="n">vxattr</span><span class="o">-&gt;</span><span class="n">readonly</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">vxattr</span><span class="o">-&gt;</span><span class="n">getxattr_cb</span><span class="p">(</span><span class="n">ci</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">__build_xattrs</span><span class="p">(</span><span class="n">inode</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

<span class="nl">get_xattr:</span>
	<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODATA</span><span class="p">;</span>  <span class="cm">/* == ENOATTR */</span>
	<span class="n">xattr</span> <span class="o">=</span> <span class="n">__get_xattr</span><span class="p">(</span><span class="n">ci</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">xattr</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">vxattr</span><span class="p">)</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">vxattr</span><span class="o">-&gt;</span><span class="n">getxattr_cb</span><span class="p">(</span><span class="n">ci</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ERANGE</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">&amp;&amp;</span> <span class="n">size</span> <span class="o">&lt;</span> <span class="n">xattr</span><span class="o">-&gt;</span><span class="n">val_len</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">xattr</span><span class="o">-&gt;</span><span class="n">val_len</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">xattr</span><span class="o">-&gt;</span><span class="n">val</span><span class="p">,</span> <span class="n">xattr</span><span class="o">-&gt;</span><span class="n">val_len</span><span class="p">);</span>

<span class="nl">out:</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ci</span><span class="o">-&gt;</span><span class="n">i_ceph_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">ssize_t</span> <span class="nf">ceph_listxattr</span><span class="p">(</span><span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="n">dentry</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">names</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span> <span class="o">=</span> <span class="n">dentry</span><span class="o">-&gt;</span><span class="n">d_inode</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ceph_inode_info</span> <span class="o">*</span><span class="n">ci</span> <span class="o">=</span> <span class="n">ceph_inode</span><span class="p">(</span><span class="n">inode</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ceph_vxattr</span> <span class="o">*</span><span class="n">vxattrs</span> <span class="o">=</span> <span class="n">ceph_inode_vxattrs</span><span class="p">(</span><span class="n">inode</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">vir_namelen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">namelen</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">len</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ci</span><span class="o">-&gt;</span><span class="n">i_ceph_lock</span><span class="p">);</span>
	<span class="n">dout</span><span class="p">(</span><span class="s">&quot;listxattr %p ver=%lld index_ver=%lld</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">inode</span><span class="p">,</span>
	     <span class="n">ci</span><span class="o">-&gt;</span><span class="n">i_xattrs</span><span class="p">.</span><span class="n">version</span><span class="p">,</span> <span class="n">ci</span><span class="o">-&gt;</span><span class="n">i_xattrs</span><span class="p">.</span><span class="n">index_version</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">__ceph_caps_issued_mask</span><span class="p">(</span><span class="n">ci</span><span class="p">,</span> <span class="n">CEPH_CAP_XATTR_SHARED</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">ci</span><span class="o">-&gt;</span><span class="n">i_xattrs</span><span class="p">.</span><span class="n">index_version</span> <span class="o">&gt;=</span> <span class="n">ci</span><span class="o">-&gt;</span><span class="n">i_xattrs</span><span class="p">.</span><span class="n">version</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">goto</span> <span class="n">list_xattr</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ci</span><span class="o">-&gt;</span><span class="n">i_ceph_lock</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">ceph_do_getattr</span><span class="p">(</span><span class="n">inode</span><span class="p">,</span> <span class="n">CEPH_STAT_CAP_XATTR</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ci</span><span class="o">-&gt;</span><span class="n">i_ceph_lock</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">__build_xattrs</span><span class="p">(</span><span class="n">inode</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

<span class="nl">list_xattr:</span>
	<span class="cm">/*</span>
<span class="cm">	 * Start with virtual dir xattr names (if any) (including</span>
<span class="cm">	 * terminating &#39;\0&#39; characters for each).</span>
<span class="cm">	 */</span>
	<span class="n">vir_namelen</span> <span class="o">=</span> <span class="n">ceph_vxattrs_name_size</span><span class="p">(</span><span class="n">vxattrs</span><span class="p">);</span>

	<span class="cm">/* adding 1 byte per each variable due to the null termination */</span>
	<span class="n">namelen</span> <span class="o">=</span> <span class="n">vir_namelen</span> <span class="o">+</span> <span class="n">ci</span><span class="o">-&gt;</span><span class="n">i_xattrs</span><span class="p">.</span><span class="n">names_size</span> <span class="o">+</span> <span class="n">ci</span><span class="o">-&gt;</span><span class="n">i_xattrs</span><span class="p">.</span><span class="n">count</span><span class="p">;</span>
	<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ERANGE</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">&amp;&amp;</span> <span class="n">namelen</span> <span class="o">&gt;</span> <span class="n">size</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">namelen</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">names</span> <span class="o">=</span> <span class="n">__copy_xattr_names</span><span class="p">(</span><span class="n">ci</span><span class="p">,</span> <span class="n">names</span><span class="p">);</span>

	<span class="cm">/* virtual xattr names, too */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vxattrs</span><span class="p">)</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">vxattrs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">name</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">len</span> <span class="o">=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">names</span><span class="p">,</span> <span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">vxattrs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">name</span><span class="p">);</span>
			<span class="n">names</span> <span class="o">+=</span> <span class="n">len</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>

<span class="nl">out:</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ci</span><span class="o">-&gt;</span><span class="n">i_ceph_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ceph_sync_setxattr</span><span class="p">(</span><span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="n">dentry</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span>
			      <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">value</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">size</span><span class="p">,</span> <span class="kt">int</span> <span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ceph_fs_client</span> <span class="o">*</span><span class="n">fsc</span> <span class="o">=</span> <span class="n">ceph_sb_to_client</span><span class="p">(</span><span class="n">dentry</span><span class="o">-&gt;</span><span class="n">d_sb</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span> <span class="o">=</span> <span class="n">dentry</span><span class="o">-&gt;</span><span class="n">d_inode</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ceph_inode_info</span> <span class="o">*</span><span class="n">ci</span> <span class="o">=</span> <span class="n">ceph_inode</span><span class="p">(</span><span class="n">inode</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">parent_inode</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ceph_mds_request</span> <span class="o">*</span><span class="n">req</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ceph_mds_client</span> <span class="o">*</span><span class="n">mdsc</span> <span class="o">=</span> <span class="n">fsc</span><span class="o">-&gt;</span><span class="n">mdsc</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">nr_pages</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">page</span> <span class="o">**</span><span class="n">pages</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">kaddr</span><span class="p">;</span>

	<span class="cm">/* copy value into some pages */</span>
	<span class="n">nr_pages</span> <span class="o">=</span> <span class="n">calc_pages_for</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nr_pages</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pages</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">pages</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">*</span><span class="n">nr_pages</span><span class="p">,</span> <span class="n">GFP_NOFS</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pages</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">nr_pages</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pages</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">__page_cache_alloc</span><span class="p">(</span><span class="n">GFP_NOFS</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pages</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="p">{</span>
				<span class="n">nr_pages</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">kaddr</span> <span class="o">=</span> <span class="n">kmap</span><span class="p">(</span><span class="n">pages</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">kaddr</span><span class="p">,</span> <span class="n">value</span> <span class="o">+</span> <span class="n">i</span><span class="o">*</span><span class="n">PAGE_CACHE_SIZE</span><span class="p">,</span>
			       <span class="n">min</span><span class="p">(</span><span class="n">PAGE_CACHE_SIZE</span><span class="p">,</span> <span class="n">size</span><span class="o">-</span><span class="n">i</span><span class="o">*</span><span class="n">PAGE_CACHE_SIZE</span><span class="p">));</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">dout</span><span class="p">(</span><span class="s">&quot;setxattr value=%.*s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">size</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>

	<span class="cm">/* do request */</span>
	<span class="n">req</span> <span class="o">=</span> <span class="n">ceph_mdsc_create_request</span><span class="p">(</span><span class="n">mdsc</span><span class="p">,</span> <span class="n">CEPH_MDS_OP_SETXATTR</span><span class="p">,</span>
				       <span class="n">USE_AUTH_MDS</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">req</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">r_inode</span> <span class="o">=</span> <span class="n">inode</span><span class="p">;</span>
	<span class="n">ihold</span><span class="p">(</span><span class="n">inode</span><span class="p">);</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">r_inode_drop</span> <span class="o">=</span> <span class="n">CEPH_CAP_XATTR_SHARED</span><span class="p">;</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">r_num_caps</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">r_args</span><span class="p">.</span><span class="n">setxattr</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">r_path2</span> <span class="o">=</span> <span class="n">kstrdup</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">GFP_NOFS</span><span class="p">);</span>

	<span class="n">req</span><span class="o">-&gt;</span><span class="n">r_pages</span> <span class="o">=</span> <span class="n">pages</span><span class="p">;</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">r_num_pages</span> <span class="o">=</span> <span class="n">nr_pages</span><span class="p">;</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">r_data_len</span> <span class="o">=</span> <span class="n">size</span><span class="p">;</span>

	<span class="n">dout</span><span class="p">(</span><span class="s">&quot;xattr.ver (before): %lld</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ci</span><span class="o">-&gt;</span><span class="n">i_xattrs</span><span class="p">.</span><span class="n">version</span><span class="p">);</span>
	<span class="n">parent_inode</span> <span class="o">=</span> <span class="n">ceph_get_dentry_parent_inode</span><span class="p">(</span><span class="n">dentry</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">ceph_mdsc_do_request</span><span class="p">(</span><span class="n">mdsc</span><span class="p">,</span> <span class="n">parent_inode</span><span class="p">,</span> <span class="n">req</span><span class="p">);</span>
	<span class="n">iput</span><span class="p">(</span><span class="n">parent_inode</span><span class="p">);</span>
	<span class="n">ceph_mdsc_put_request</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>
	<span class="n">dout</span><span class="p">(</span><span class="s">&quot;xattr.ver (after): %lld</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ci</span><span class="o">-&gt;</span><span class="n">i_xattrs</span><span class="p">.</span><span class="n">version</span><span class="p">);</span>

<span class="nl">out:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pages</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">nr_pages</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">__free_page</span><span class="p">(</span><span class="n">pages</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">pages</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">ceph_setxattr</span><span class="p">(</span><span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="n">dentry</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span>
		  <span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">value</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">size</span><span class="p">,</span> <span class="kt">int</span> <span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span> <span class="o">=</span> <span class="n">dentry</span><span class="o">-&gt;</span><span class="n">d_inode</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ceph_vxattr</span> <span class="o">*</span><span class="n">vxattr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ceph_inode_info</span> <span class="o">*</span><span class="n">ci</span> <span class="o">=</span> <span class="n">ceph_inode</span><span class="p">(</span><span class="n">inode</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">issued</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">dirty</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">name_len</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">name</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">val_len</span> <span class="o">=</span> <span class="n">size</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">newname</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">newval</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ceph_inode_xattr</span> <span class="o">*</span><span class="n">xattr</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">required_blob_size</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ceph_snap</span><span class="p">(</span><span class="n">inode</span><span class="p">)</span> <span class="o">!=</span> <span class="n">CEPH_NOSNAP</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EROFS</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ceph_is_valid_xattr</span><span class="p">(</span><span class="n">name</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>

	<span class="n">vxattr</span> <span class="o">=</span> <span class="n">ceph_match_vxattr</span><span class="p">(</span><span class="n">inode</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vxattr</span> <span class="o">&amp;&amp;</span> <span class="n">vxattr</span><span class="o">-&gt;</span><span class="n">readonly</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>

	<span class="cm">/* preallocate memory for xattr name, value, index node */</span>
	<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">newname</span> <span class="o">=</span> <span class="n">kmemdup</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">name_len</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">GFP_NOFS</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">newname</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">val_len</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">newval</span> <span class="o">=</span> <span class="n">kmemdup</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">val_len</span><span class="p">,</span> <span class="n">GFP_NOFS</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">newval</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">xattr</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ceph_inode_xattr</span><span class="p">),</span> <span class="n">GFP_NOFS</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">xattr</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ci</span><span class="o">-&gt;</span><span class="n">i_ceph_lock</span><span class="p">);</span>
<span class="nl">retry:</span>
	<span class="n">issued</span> <span class="o">=</span> <span class="n">__ceph_caps_issued</span><span class="p">(</span><span class="n">ci</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">dout</span><span class="p">(</span><span class="s">&quot;setxattr %p issued %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">inode</span><span class="p">,</span> <span class="n">ceph_cap_string</span><span class="p">(</span><span class="n">issued</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">issued</span> <span class="o">&amp;</span> <span class="n">CEPH_CAP_XATTR_EXCL</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">do_sync</span><span class="p">;</span>
	<span class="n">__build_xattrs</span><span class="p">(</span><span class="n">inode</span><span class="p">);</span>

	<span class="n">required_blob_size</span> <span class="o">=</span> <span class="n">__get_required_blob_size</span><span class="p">(</span><span class="n">ci</span><span class="p">,</span> <span class="n">name_len</span><span class="p">,</span> <span class="n">val_len</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ci</span><span class="o">-&gt;</span><span class="n">i_xattrs</span><span class="p">.</span><span class="n">prealloc_blob</span> <span class="o">||</span>
	    <span class="n">required_blob_size</span> <span class="o">&gt;</span> <span class="n">ci</span><span class="o">-&gt;</span><span class="n">i_xattrs</span><span class="p">.</span><span class="n">prealloc_blob</span><span class="o">-&gt;</span><span class="n">alloc_len</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">ceph_buffer</span> <span class="o">*</span><span class="n">blob</span><span class="p">;</span>

		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ci</span><span class="o">-&gt;</span><span class="n">i_ceph_lock</span><span class="p">);</span>
		<span class="n">dout</span><span class="p">(</span><span class="s">&quot; preaallocating new blob size=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">required_blob_size</span><span class="p">);</span>
		<span class="n">blob</span> <span class="o">=</span> <span class="n">ceph_buffer_new</span><span class="p">(</span><span class="n">required_blob_size</span><span class="p">,</span> <span class="n">GFP_NOFS</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">blob</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ci</span><span class="o">-&gt;</span><span class="n">i_ceph_lock</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ci</span><span class="o">-&gt;</span><span class="n">i_xattrs</span><span class="p">.</span><span class="n">prealloc_blob</span><span class="p">)</span>
			<span class="n">ceph_buffer_put</span><span class="p">(</span><span class="n">ci</span><span class="o">-&gt;</span><span class="n">i_xattrs</span><span class="p">.</span><span class="n">prealloc_blob</span><span class="p">);</span>
		<span class="n">ci</span><span class="o">-&gt;</span><span class="n">i_xattrs</span><span class="p">.</span><span class="n">prealloc_blob</span> <span class="o">=</span> <span class="n">blob</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">retry</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">__set_xattr</span><span class="p">(</span><span class="n">ci</span><span class="p">,</span> <span class="n">newname</span><span class="p">,</span> <span class="n">name_len</span><span class="p">,</span> <span class="n">newval</span><span class="p">,</span>
			  <span class="n">val_len</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">xattr</span><span class="p">);</span>

	<span class="n">dirty</span> <span class="o">=</span> <span class="n">__ceph_mark_dirty_caps</span><span class="p">(</span><span class="n">ci</span><span class="p">,</span> <span class="n">CEPH_CAP_XATTR_EXCL</span><span class="p">);</span>
	<span class="n">ci</span><span class="o">-&gt;</span><span class="n">i_xattrs</span><span class="p">.</span><span class="n">dirty</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_ctime</span> <span class="o">=</span> <span class="n">CURRENT_TIME</span><span class="p">;</span>

	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ci</span><span class="o">-&gt;</span><span class="n">i_ceph_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dirty</span><span class="p">)</span>
		<span class="n">__mark_inode_dirty</span><span class="p">(</span><span class="n">inode</span><span class="p">,</span> <span class="n">dirty</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

<span class="nl">do_sync:</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ci</span><span class="o">-&gt;</span><span class="n">i_ceph_lock</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">ceph_sync_setxattr</span><span class="p">(</span><span class="n">dentry</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">newname</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">newval</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">xattr</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ceph_send_removexattr</span><span class="p">(</span><span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="n">dentry</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ceph_fs_client</span> <span class="o">*</span><span class="n">fsc</span> <span class="o">=</span> <span class="n">ceph_sb_to_client</span><span class="p">(</span><span class="n">dentry</span><span class="o">-&gt;</span><span class="n">d_sb</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ceph_mds_client</span> <span class="o">*</span><span class="n">mdsc</span> <span class="o">=</span> <span class="n">fsc</span><span class="o">-&gt;</span><span class="n">mdsc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span> <span class="o">=</span> <span class="n">dentry</span><span class="o">-&gt;</span><span class="n">d_inode</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">parent_inode</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ceph_mds_request</span> <span class="o">*</span><span class="n">req</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">req</span> <span class="o">=</span> <span class="n">ceph_mdsc_create_request</span><span class="p">(</span><span class="n">mdsc</span><span class="p">,</span> <span class="n">CEPH_MDS_OP_RMXATTR</span><span class="p">,</span>
				       <span class="n">USE_AUTH_MDS</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">req</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">r_inode</span> <span class="o">=</span> <span class="n">inode</span><span class="p">;</span>
	<span class="n">ihold</span><span class="p">(</span><span class="n">inode</span><span class="p">);</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">r_inode_drop</span> <span class="o">=</span> <span class="n">CEPH_CAP_XATTR_SHARED</span><span class="p">;</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">r_num_caps</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">r_path2</span> <span class="o">=</span> <span class="n">kstrdup</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">GFP_NOFS</span><span class="p">);</span>

	<span class="n">parent_inode</span> <span class="o">=</span> <span class="n">ceph_get_dentry_parent_inode</span><span class="p">(</span><span class="n">dentry</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">ceph_mdsc_do_request</span><span class="p">(</span><span class="n">mdsc</span><span class="p">,</span> <span class="n">parent_inode</span><span class="p">,</span> <span class="n">req</span><span class="p">);</span>
	<span class="n">iput</span><span class="p">(</span><span class="n">parent_inode</span><span class="p">);</span>
	<span class="n">ceph_mdsc_put_request</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">ceph_removexattr</span><span class="p">(</span><span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="n">dentry</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span> <span class="o">=</span> <span class="n">dentry</span><span class="o">-&gt;</span><span class="n">d_inode</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ceph_vxattr</span> <span class="o">*</span><span class="n">vxattr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ceph_inode_info</span> <span class="o">*</span><span class="n">ci</span> <span class="o">=</span> <span class="n">ceph_inode</span><span class="p">(</span><span class="n">inode</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">issued</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">required_blob_size</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">dirty</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ceph_snap</span><span class="p">(</span><span class="n">inode</span><span class="p">)</span> <span class="o">!=</span> <span class="n">CEPH_NOSNAP</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EROFS</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ceph_is_valid_xattr</span><span class="p">(</span><span class="n">name</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>

	<span class="n">vxattr</span> <span class="o">=</span> <span class="n">ceph_match_vxattr</span><span class="p">(</span><span class="n">inode</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vxattr</span> <span class="o">&amp;&amp;</span> <span class="n">vxattr</span><span class="o">-&gt;</span><span class="n">readonly</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ci</span><span class="o">-&gt;</span><span class="n">i_ceph_lock</span><span class="p">);</span>
<span class="nl">retry:</span>
	<span class="n">issued</span> <span class="o">=</span> <span class="n">__ceph_caps_issued</span><span class="p">(</span><span class="n">ci</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">dout</span><span class="p">(</span><span class="s">&quot;removexattr %p issued %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">inode</span><span class="p">,</span> <span class="n">ceph_cap_string</span><span class="p">(</span><span class="n">issued</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">issued</span> <span class="o">&amp;</span> <span class="n">CEPH_CAP_XATTR_EXCL</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">do_sync</span><span class="p">;</span>
	<span class="n">__build_xattrs</span><span class="p">(</span><span class="n">inode</span><span class="p">);</span>

	<span class="n">required_blob_size</span> <span class="o">=</span> <span class="n">__get_required_blob_size</span><span class="p">(</span><span class="n">ci</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ci</span><span class="o">-&gt;</span><span class="n">i_xattrs</span><span class="p">.</span><span class="n">prealloc_blob</span> <span class="o">||</span>
	    <span class="n">required_blob_size</span> <span class="o">&gt;</span> <span class="n">ci</span><span class="o">-&gt;</span><span class="n">i_xattrs</span><span class="p">.</span><span class="n">prealloc_blob</span><span class="o">-&gt;</span><span class="n">alloc_len</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">ceph_buffer</span> <span class="o">*</span><span class="n">blob</span><span class="p">;</span>

		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ci</span><span class="o">-&gt;</span><span class="n">i_ceph_lock</span><span class="p">);</span>
		<span class="n">dout</span><span class="p">(</span><span class="s">&quot; preaallocating new blob size=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">required_blob_size</span><span class="p">);</span>
		<span class="n">blob</span> <span class="o">=</span> <span class="n">ceph_buffer_new</span><span class="p">(</span><span class="n">required_blob_size</span><span class="p">,</span> <span class="n">GFP_NOFS</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">blob</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ci</span><span class="o">-&gt;</span><span class="n">i_ceph_lock</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ci</span><span class="o">-&gt;</span><span class="n">i_xattrs</span><span class="p">.</span><span class="n">prealloc_blob</span><span class="p">)</span>
			<span class="n">ceph_buffer_put</span><span class="p">(</span><span class="n">ci</span><span class="o">-&gt;</span><span class="n">i_xattrs</span><span class="p">.</span><span class="n">prealloc_blob</span><span class="p">);</span>
		<span class="n">ci</span><span class="o">-&gt;</span><span class="n">i_xattrs</span><span class="p">.</span><span class="n">prealloc_blob</span> <span class="o">=</span> <span class="n">blob</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">retry</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">__remove_xattr_by_name</span><span class="p">(</span><span class="n">ceph_inode</span><span class="p">(</span><span class="n">inode</span><span class="p">),</span> <span class="n">name</span><span class="p">);</span>

	<span class="n">dirty</span> <span class="o">=</span> <span class="n">__ceph_mark_dirty_caps</span><span class="p">(</span><span class="n">ci</span><span class="p">,</span> <span class="n">CEPH_CAP_XATTR_EXCL</span><span class="p">);</span>
	<span class="n">ci</span><span class="o">-&gt;</span><span class="n">i_xattrs</span><span class="p">.</span><span class="n">dirty</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_ctime</span> <span class="o">=</span> <span class="n">CURRENT_TIME</span><span class="p">;</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ci</span><span class="o">-&gt;</span><span class="n">i_ceph_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dirty</span><span class="p">)</span>
		<span class="n">__mark_inode_dirty</span><span class="p">(</span><span class="n">inode</span><span class="p">,</span> <span class="n">dirty</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="nl">do_sync:</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ci</span><span class="o">-&gt;</span><span class="n">i_ceph_lock</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">ceph_send_removexattr</span><span class="p">(</span><span class="n">dentry</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
