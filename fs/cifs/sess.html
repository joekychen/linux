<!DOCTYPE html>
<html><head><title>joekychen/linux » fs › cifs › sess.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>sess.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> *   fs/cifs/sess.c</span>
<span class="cm"> *</span>
<span class="cm"> *   SMB/CIFS session setup handling routines</span>
<span class="cm"> *</span>
<span class="cm"> *   Copyright (c) International Business Machines  Corp., 2006, 2009</span>
<span class="cm"> *   Author(s): Steve French (sfrench@us.ibm.com)</span>
<span class="cm"> *</span>
<span class="cm"> *   This library is free software; you can redistribute it and/or modify</span>
<span class="cm"> *   it under the terms of the GNU Lesser General Public License as published</span>
<span class="cm"> *   by the Free Software Foundation; either version 2.1 of the License, or</span>
<span class="cm"> *   (at your option) any later version.</span>
<span class="cm"> *</span>
<span class="cm"> *   This library is distributed in the hope that it will be useful,</span>
<span class="cm"> *   but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> *   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See</span>
<span class="cm"> *   the GNU Lesser General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> *   You should have received a copy of the GNU Lesser General Public License</span>
<span class="cm"> *   along with this library; if not, write to the Free Software</span>
<span class="cm"> *   Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA 02111-1307 USA</span>
<span class="cm"> */</span>

<span class="cp">#include &quot;cifspdu.h&quot;</span>
<span class="cp">#include &quot;cifsglob.h&quot;</span>
<span class="cp">#include &quot;cifsproto.h&quot;</span>
<span class="cp">#include &quot;cifs_unicode.h&quot;</span>
<span class="cp">#include &quot;cifs_debug.h&quot;</span>
<span class="cp">#include &quot;ntlmssp.h&quot;</span>
<span class="cp">#include &quot;nterr.h&quot;</span>
<span class="cp">#include &lt;linux/utsname.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &quot;cifs_spnego.h&quot;</span>

<span class="cm">/*</span>
<span class="cm"> * Checks if this is the first smb session to be reconnected after</span>
<span class="cm"> * the socket has been reestablished (so we know whether to use vc 0).</span>
<span class="cm"> * Called while holding the cifs_tcp_ses_lock, so do not block</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">bool</span> <span class="nf">is_first_ses_reconnect</span><span class="p">(</span><span class="k">struct</span> <span class="n">cifs_ses</span> <span class="o">*</span><span class="n">ses</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">tmp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cifs_ses</span> <span class="o">*</span><span class="n">tmp_ses</span><span class="p">;</span>

	<span class="n">list_for_each</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ses</span><span class="o">-&gt;</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">smb_ses_list</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tmp_ses</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">cifs_ses</span><span class="p">,</span>
				     <span class="n">smb_ses_list</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tmp_ses</span><span class="o">-&gt;</span><span class="n">need_reconnect</span> <span class="o">==</span> <span class="nb">false</span><span class="p">)</span>
			<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* could not find a session that was already connected,</span>
<span class="cm">	   this must be the first one we are reconnecting */</span>
	<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *	vc number 0 is treated specially by some servers, and should be the</span>
<span class="cm"> *      first one we request.  After that we can use vcnumbers up to maxvcs,</span>
<span class="cm"> *	one for each smb session (some Windows versions set maxvcs incorrectly</span>
<span class="cm"> *	so maxvc=1 can be ignored).  If we have too many vcs, we can reuse</span>
<span class="cm"> *	any vc but zero (some servers reset the connection on vcnum zero)</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">__le16</span> <span class="nf">get_next_vcnum</span><span class="p">(</span><span class="k">struct</span> <span class="n">cifs_ses</span> <span class="o">*</span><span class="n">ses</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">__u16</span> <span class="n">vcnum</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">tmp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cifs_ses</span> <span class="o">*</span><span class="n">tmp_ses</span><span class="p">;</span>
	<span class="n">__u16</span> <span class="n">max_vcs</span> <span class="o">=</span> <span class="n">ses</span><span class="o">-&gt;</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">max_vcs</span><span class="p">;</span>
	<span class="n">__u16</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">free_vc_found</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Quoting the MS-SMB specification: &quot;Windows-based SMB servers set this</span>
<span class="cm">	field to one but do not enforce this limit, which allows an SMB client</span>
<span class="cm">	to establish more virtual circuits than allowed by this value ... but</span>
<span class="cm">	other server implementations can enforce this limit.&quot; */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">max_vcs</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span>
		<span class="n">max_vcs</span> <span class="o">=</span> <span class="mh">0xFFFF</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cifs_tcp_ses_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">ses</span><span class="o">-&gt;</span><span class="n">need_reconnect</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">is_first_ses_reconnect</span><span class="p">(</span><span class="n">ses</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">get_vc_num_exit</span><span class="p">;</span>  <span class="cm">/* vcnum will be zero */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">ses</span><span class="o">-&gt;</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">srv_count</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">max_vcs</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="cm">/* this is the only connection, use vc 0 */</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">free_vc_found</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

		<span class="n">list_for_each</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ses</span><span class="o">-&gt;</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">smb_ses_list</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">tmp_ses</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">cifs_ses</span><span class="p">,</span>
					     <span class="n">smb_ses_list</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">tmp_ses</span><span class="o">-&gt;</span><span class="n">vcnum</span> <span class="o">==</span> <span class="n">i</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">free_vc_found</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span> <span class="cm">/* found duplicate, try next vcnum */</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">free_vc_found</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span> <span class="cm">/* we found a vcnumber that will work - use it */</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">vcnum</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* for most common case, ie if one smb session, use</span>
<span class="cm">			      vc zero.  Also for case when no free vcnum, zero</span>
<span class="cm">			      is safest to send (some clients only send zero) */</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">free_vc_found</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">vcnum</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>  <span class="cm">/* we can not reuse vc=0 safely, since some servers</span>
<span class="cm">				reset all uids on that, but 1 is ok. */</span>
	<span class="k">else</span>
		<span class="n">vcnum</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">ses</span><span class="o">-&gt;</span><span class="n">vcnum</span> <span class="o">=</span> <span class="n">vcnum</span><span class="p">;</span>
<span class="nl">get_vc_num_exit:</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cifs_tcp_ses_lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">vcnum</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">__u32</span> <span class="nf">cifs_ssetup_hdr</span><span class="p">(</span><span class="k">struct</span> <span class="n">cifs_ses</span> <span class="o">*</span><span class="n">ses</span><span class="p">,</span> <span class="n">SESSION_SETUP_ANDX</span> <span class="o">*</span><span class="n">pSMB</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">__u32</span> <span class="n">capabilities</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* init fields common to all four types of SessSetup */</span>
	<span class="cm">/* Note that offsets for first seven fields in req struct are same  */</span>
	<span class="cm">/*	in CIFS Specs so does not matter which of 3 forms of struct */</span>
	<span class="cm">/*	that we use in next few lines                               */</span>
	<span class="cm">/* Note that header is initialized to zero in header_assemble */</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">AndXCommand</span> <span class="o">=</span> <span class="mh">0xFF</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">MaxBufferSize</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">min_t</span><span class="p">(</span><span class="n">u32</span><span class="p">,</span>
					<span class="n">CIFSMaxBufSize</span> <span class="o">+</span> <span class="n">MAX_CIFS_HDR_SIZE</span> <span class="o">-</span> <span class="mi">4</span><span class="p">,</span>
					<span class="n">USHRT_MAX</span><span class="p">));</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">MaxMpxCount</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">ses</span><span class="o">-&gt;</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">maxReq</span><span class="p">);</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">VcNumber</span> <span class="o">=</span> <span class="n">get_next_vcnum</span><span class="p">(</span><span class="n">ses</span><span class="p">);</span>

	<span class="cm">/* Now no need to set SMBFLG_CASELESS or obsolete CANONICAL PATH */</span>

	<span class="cm">/* BB verify whether signing required on neg or just on auth frame</span>
<span class="cm">	   (and NTLM case) */</span>

	<span class="n">capabilities</span> <span class="o">=</span> <span class="n">CAP_LARGE_FILES</span> <span class="o">|</span> <span class="n">CAP_NT_SMBS</span> <span class="o">|</span> <span class="n">CAP_LEVEL_II_OPLOCKS</span> <span class="o">|</span>
			<span class="n">CAP_LARGE_WRITE_X</span> <span class="o">|</span> <span class="n">CAP_LARGE_READ_X</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ses</span><span class="o">-&gt;</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">sec_mode</span> <span class="o">&amp;</span>
	    <span class="p">(</span><span class="n">SECMODE_SIGN_REQUIRED</span> <span class="o">|</span> <span class="n">SECMODE_SIGN_ENABLED</span><span class="p">))</span>
		<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">hdr</span><span class="p">.</span><span class="n">Flags2</span> <span class="o">|=</span> <span class="n">SMBFLG2_SECURITY_SIGNATURE</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ses</span><span class="o">-&gt;</span><span class="n">capabilities</span> <span class="o">&amp;</span> <span class="n">CAP_UNICODE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">hdr</span><span class="p">.</span><span class="n">Flags2</span> <span class="o">|=</span> <span class="n">SMBFLG2_UNICODE</span><span class="p">;</span>
		<span class="n">capabilities</span> <span class="o">|=</span> <span class="n">CAP_UNICODE</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ses</span><span class="o">-&gt;</span><span class="n">capabilities</span> <span class="o">&amp;</span> <span class="n">CAP_STATUS32</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">hdr</span><span class="p">.</span><span class="n">Flags2</span> <span class="o">|=</span> <span class="n">SMBFLG2_ERR_STATUS</span><span class="p">;</span>
		<span class="n">capabilities</span> <span class="o">|=</span> <span class="n">CAP_STATUS32</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ses</span><span class="o">-&gt;</span><span class="n">capabilities</span> <span class="o">&amp;</span> <span class="n">CAP_DFS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">hdr</span><span class="p">.</span><span class="n">Flags2</span> <span class="o">|=</span> <span class="n">SMBFLG2_DFS</span><span class="p">;</span>
		<span class="n">capabilities</span> <span class="o">|=</span> <span class="n">CAP_DFS</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ses</span><span class="o">-&gt;</span><span class="n">capabilities</span> <span class="o">&amp;</span> <span class="n">CAP_UNIX</span><span class="p">)</span>
		<span class="n">capabilities</span> <span class="o">|=</span> <span class="n">CAP_UNIX</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">capabilities</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">unicode_oslm_strings</span><span class="p">(</span><span class="kt">char</span> <span class="o">**</span><span class="n">pbcc_area</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">nls_table</span> <span class="o">*</span><span class="n">nls_cp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">bcc_ptr</span> <span class="o">=</span> <span class="o">*</span><span class="n">pbcc_area</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">bytes_ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Copy OS version */</span>
	<span class="n">bytes_ret</span> <span class="o">=</span> <span class="n">cifs_strtoUTF16</span><span class="p">((</span><span class="n">__le16</span> <span class="o">*</span><span class="p">)</span><span class="n">bcc_ptr</span><span class="p">,</span> <span class="s">&quot;Linux version &quot;</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span>
				    <span class="n">nls_cp</span><span class="p">);</span>
	<span class="n">bcc_ptr</span> <span class="o">+=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">bytes_ret</span><span class="p">;</span>
	<span class="n">bytes_ret</span> <span class="o">=</span> <span class="n">cifs_strtoUTF16</span><span class="p">((</span><span class="n">__le16</span> <span class="o">*</span><span class="p">)</span> <span class="n">bcc_ptr</span><span class="p">,</span> <span class="n">init_utsname</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">release</span><span class="p">,</span>
				    <span class="mi">32</span><span class="p">,</span> <span class="n">nls_cp</span><span class="p">);</span>
	<span class="n">bcc_ptr</span> <span class="o">+=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">bytes_ret</span><span class="p">;</span>
	<span class="n">bcc_ptr</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span> <span class="cm">/* trailing null */</span>

	<span class="n">bytes_ret</span> <span class="o">=</span> <span class="n">cifs_strtoUTF16</span><span class="p">((</span><span class="n">__le16</span> <span class="o">*</span><span class="p">)</span> <span class="n">bcc_ptr</span><span class="p">,</span> <span class="n">CIFS_NETWORK_OPSYS</span><span class="p">,</span>
				    <span class="mi">32</span><span class="p">,</span> <span class="n">nls_cp</span><span class="p">);</span>
	<span class="n">bcc_ptr</span> <span class="o">+=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">bytes_ret</span><span class="p">;</span>
	<span class="n">bcc_ptr</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span> <span class="cm">/* trailing null */</span>

	<span class="o">*</span><span class="n">pbcc_area</span> <span class="o">=</span> <span class="n">bcc_ptr</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">unicode_domain_string</span><span class="p">(</span><span class="kt">char</span> <span class="o">**</span><span class="n">pbcc_area</span><span class="p">,</span> <span class="k">struct</span> <span class="n">cifs_ses</span> <span class="o">*</span><span class="n">ses</span><span class="p">,</span>
				   <span class="k">const</span> <span class="k">struct</span> <span class="n">nls_table</span> <span class="o">*</span><span class="n">nls_cp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">bcc_ptr</span> <span class="o">=</span> <span class="o">*</span><span class="n">pbcc_area</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">bytes_ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* copy domain */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ses</span><span class="o">-&gt;</span><span class="n">domainName</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Sending null domain better than using a bogus domain name (as</span>
<span class="cm">		we did briefly in 2.6.18) since server will use its default */</span>
		<span class="o">*</span><span class="n">bcc_ptr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="o">*</span><span class="p">(</span><span class="n">bcc_ptr</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">bytes_ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">bytes_ret</span> <span class="o">=</span> <span class="n">cifs_strtoUTF16</span><span class="p">((</span><span class="n">__le16</span> <span class="o">*</span><span class="p">)</span> <span class="n">bcc_ptr</span><span class="p">,</span> <span class="n">ses</span><span class="o">-&gt;</span><span class="n">domainName</span><span class="p">,</span>
					    <span class="mi">256</span><span class="p">,</span> <span class="n">nls_cp</span><span class="p">);</span>
	<span class="n">bcc_ptr</span> <span class="o">+=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">bytes_ret</span><span class="p">;</span>
	<span class="n">bcc_ptr</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>  <span class="cm">/* account for null terminator */</span>

	<span class="o">*</span><span class="n">pbcc_area</span> <span class="o">=</span> <span class="n">bcc_ptr</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">unicode_ssetup_strings</span><span class="p">(</span><span class="kt">char</span> <span class="o">**</span><span class="n">pbcc_area</span><span class="p">,</span> <span class="k">struct</span> <span class="n">cifs_ses</span> <span class="o">*</span><span class="n">ses</span><span class="p">,</span>
				   <span class="k">const</span> <span class="k">struct</span> <span class="n">nls_table</span> <span class="o">*</span><span class="n">nls_cp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">bcc_ptr</span> <span class="o">=</span> <span class="o">*</span><span class="n">pbcc_area</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">bytes_ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* BB FIXME add check that strings total less</span>
<span class="cm">	than 335 or will need to send them as arrays */</span>

	<span class="cm">/* unicode strings, must be word aligned before the call */</span>
<span class="cm">/*	if ((long) bcc_ptr % 2)	{</span>
<span class="cm">		*bcc_ptr = 0;</span>
<span class="cm">		bcc_ptr++;</span>
<span class="cm">	} */</span>
	<span class="cm">/* copy user */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ses</span><span class="o">-&gt;</span><span class="n">user_name</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* null user mount */</span>
		<span class="o">*</span><span class="n">bcc_ptr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="o">*</span><span class="p">(</span><span class="n">bcc_ptr</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">bytes_ret</span> <span class="o">=</span> <span class="n">cifs_strtoUTF16</span><span class="p">((</span><span class="n">__le16</span> <span class="o">*</span><span class="p">)</span> <span class="n">bcc_ptr</span><span class="p">,</span> <span class="n">ses</span><span class="o">-&gt;</span><span class="n">user_name</span><span class="p">,</span>
					    <span class="n">MAX_USERNAME_SIZE</span><span class="p">,</span> <span class="n">nls_cp</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">bcc_ptr</span> <span class="o">+=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">bytes_ret</span><span class="p">;</span>
	<span class="n">bcc_ptr</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span> <span class="cm">/* account for null termination */</span>

	<span class="n">unicode_domain_string</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bcc_ptr</span><span class="p">,</span> <span class="n">ses</span><span class="p">,</span> <span class="n">nls_cp</span><span class="p">);</span>
	<span class="n">unicode_oslm_strings</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bcc_ptr</span><span class="p">,</span> <span class="n">nls_cp</span><span class="p">);</span>

	<span class="o">*</span><span class="n">pbcc_area</span> <span class="o">=</span> <span class="n">bcc_ptr</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ascii_ssetup_strings</span><span class="p">(</span><span class="kt">char</span> <span class="o">**</span><span class="n">pbcc_area</span><span class="p">,</span> <span class="k">struct</span> <span class="n">cifs_ses</span> <span class="o">*</span><span class="n">ses</span><span class="p">,</span>
				 <span class="k">const</span> <span class="k">struct</span> <span class="n">nls_table</span> <span class="o">*</span><span class="n">nls_cp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">bcc_ptr</span> <span class="o">=</span> <span class="o">*</span><span class="n">pbcc_area</span><span class="p">;</span>

	<span class="cm">/* copy user */</span>
	<span class="cm">/* BB what about null user mounts - check that we do this BB */</span>
	<span class="cm">/* copy user */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ses</span><span class="o">-&gt;</span><span class="n">user_name</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">strncpy</span><span class="p">(</span><span class="n">bcc_ptr</span><span class="p">,</span> <span class="n">ses</span><span class="o">-&gt;</span><span class="n">user_name</span><span class="p">,</span> <span class="n">MAX_USERNAME_SIZE</span><span class="p">);</span>
		<span class="n">bcc_ptr</span> <span class="o">+=</span> <span class="n">strnlen</span><span class="p">(</span><span class="n">ses</span><span class="o">-&gt;</span><span class="n">user_name</span><span class="p">,</span> <span class="n">MAX_USERNAME_SIZE</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="cm">/* else null user mount */</span>
	<span class="o">*</span><span class="n">bcc_ptr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">bcc_ptr</span><span class="o">++</span><span class="p">;</span> <span class="cm">/* account for null termination */</span>

	<span class="cm">/* copy domain */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ses</span><span class="o">-&gt;</span><span class="n">domainName</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">strncpy</span><span class="p">(</span><span class="n">bcc_ptr</span><span class="p">,</span> <span class="n">ses</span><span class="o">-&gt;</span><span class="n">domainName</span><span class="p">,</span> <span class="mi">256</span><span class="p">);</span>
		<span class="n">bcc_ptr</span> <span class="o">+=</span> <span class="n">strnlen</span><span class="p">(</span><span class="n">ses</span><span class="o">-&gt;</span><span class="n">domainName</span><span class="p">,</span> <span class="mi">256</span><span class="p">);</span>
	<span class="p">}</span> <span class="cm">/* else we will send a null domain name</span>
<span class="cm">	     so the server will default to its own domain */</span>
	<span class="o">*</span><span class="n">bcc_ptr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">bcc_ptr</span><span class="o">++</span><span class="p">;</span>

	<span class="cm">/* BB check for overflow here */</span>

	<span class="n">strcpy</span><span class="p">(</span><span class="n">bcc_ptr</span><span class="p">,</span> <span class="s">&quot;Linux version &quot;</span><span class="p">);</span>
	<span class="n">bcc_ptr</span> <span class="o">+=</span> <span class="n">strlen</span><span class="p">(</span><span class="s">&quot;Linux version &quot;</span><span class="p">);</span>
	<span class="n">strcpy</span><span class="p">(</span><span class="n">bcc_ptr</span><span class="p">,</span> <span class="n">init_utsname</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">release</span><span class="p">);</span>
	<span class="n">bcc_ptr</span> <span class="o">+=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">init_utsname</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">release</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">strcpy</span><span class="p">(</span><span class="n">bcc_ptr</span><span class="p">,</span> <span class="n">CIFS_NETWORK_OPSYS</span><span class="p">);</span>
	<span class="n">bcc_ptr</span> <span class="o">+=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">CIFS_NETWORK_OPSYS</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>

	<span class="o">*</span><span class="n">pbcc_area</span> <span class="o">=</span> <span class="n">bcc_ptr</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">decode_unicode_ssetup</span><span class="p">(</span><span class="kt">char</span> <span class="o">**</span><span class="n">pbcc_area</span><span class="p">,</span> <span class="kt">int</span> <span class="n">bleft</span><span class="p">,</span> <span class="k">struct</span> <span class="n">cifs_ses</span> <span class="o">*</span><span class="n">ses</span><span class="p">,</span>
		      <span class="k">const</span> <span class="k">struct</span> <span class="n">nls_table</span> <span class="o">*</span><span class="n">nls_cp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">len</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="o">*</span><span class="n">pbcc_area</span><span class="p">;</span>

	<span class="n">cFYI</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;bleft %d&quot;</span><span class="p">,</span> <span class="n">bleft</span><span class="p">);</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">ses</span><span class="o">-&gt;</span><span class="n">serverOS</span><span class="p">);</span>
	<span class="n">ses</span><span class="o">-&gt;</span><span class="n">serverOS</span> <span class="o">=</span> <span class="n">cifs_strndup_from_utf16</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">bleft</span><span class="p">,</span> <span class="nb">true</span><span class="p">,</span> <span class="n">nls_cp</span><span class="p">);</span>
	<span class="n">cFYI</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;serverOS=%s&quot;</span><span class="p">,</span> <span class="n">ses</span><span class="o">-&gt;</span><span class="n">serverOS</span><span class="p">);</span>
	<span class="n">len</span> <span class="o">=</span> <span class="p">(</span><span class="n">UniStrnlen</span><span class="p">((</span><span class="kt">wchar_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">data</span><span class="p">,</span> <span class="n">bleft</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">data</span> <span class="o">+=</span> <span class="n">len</span><span class="p">;</span>
	<span class="n">bleft</span> <span class="o">-=</span> <span class="n">len</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bleft</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">ses</span><span class="o">-&gt;</span><span class="n">serverNOS</span><span class="p">);</span>
	<span class="n">ses</span><span class="o">-&gt;</span><span class="n">serverNOS</span> <span class="o">=</span> <span class="n">cifs_strndup_from_utf16</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">bleft</span><span class="p">,</span> <span class="nb">true</span><span class="p">,</span> <span class="n">nls_cp</span><span class="p">);</span>
	<span class="n">cFYI</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;serverNOS=%s&quot;</span><span class="p">,</span> <span class="n">ses</span><span class="o">-&gt;</span><span class="n">serverNOS</span><span class="p">);</span>
	<span class="n">len</span> <span class="o">=</span> <span class="p">(</span><span class="n">UniStrnlen</span><span class="p">((</span><span class="kt">wchar_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">data</span><span class="p">,</span> <span class="n">bleft</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">data</span> <span class="o">+=</span> <span class="n">len</span><span class="p">;</span>
	<span class="n">bleft</span> <span class="o">-=</span> <span class="n">len</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bleft</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">ses</span><span class="o">-&gt;</span><span class="n">serverDomain</span><span class="p">);</span>
	<span class="n">ses</span><span class="o">-&gt;</span><span class="n">serverDomain</span> <span class="o">=</span> <span class="n">cifs_strndup_from_utf16</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">bleft</span><span class="p">,</span> <span class="nb">true</span><span class="p">,</span> <span class="n">nls_cp</span><span class="p">);</span>
	<span class="n">cFYI</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;serverDomain=%s&quot;</span><span class="p">,</span> <span class="n">ses</span><span class="o">-&gt;</span><span class="n">serverDomain</span><span class="p">);</span>

	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">decode_ascii_ssetup</span><span class="p">(</span><span class="kt">char</span> <span class="o">**</span><span class="n">pbcc_area</span><span class="p">,</span> <span class="n">__u16</span> <span class="n">bleft</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">cifs_ses</span> <span class="o">*</span><span class="n">ses</span><span class="p">,</span>
			       <span class="k">const</span> <span class="k">struct</span> <span class="n">nls_table</span> <span class="o">*</span><span class="n">nls_cp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">len</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">bcc_ptr</span> <span class="o">=</span> <span class="o">*</span><span class="n">pbcc_area</span><span class="p">;</span>

	<span class="n">cFYI</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;decode sessetup ascii. bleft %d&quot;</span><span class="p">,</span> <span class="n">bleft</span><span class="p">);</span>

	<span class="n">len</span> <span class="o">=</span> <span class="n">strnlen</span><span class="p">(</span><span class="n">bcc_ptr</span><span class="p">,</span> <span class="n">bleft</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;=</span> <span class="n">bleft</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">ses</span><span class="o">-&gt;</span><span class="n">serverOS</span><span class="p">);</span>

	<span class="n">ses</span><span class="o">-&gt;</span><span class="n">serverOS</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="n">len</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ses</span><span class="o">-&gt;</span><span class="n">serverOS</span><span class="p">)</span>
		<span class="n">strncpy</span><span class="p">(</span><span class="n">ses</span><span class="o">-&gt;</span><span class="n">serverOS</span><span class="p">,</span> <span class="n">bcc_ptr</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">strncmp</span><span class="p">(</span><span class="n">ses</span><span class="o">-&gt;</span><span class="n">serverOS</span><span class="p">,</span> <span class="s">&quot;OS/2&quot;</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">cFYI</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;OS/2 server&quot;</span><span class="p">);</span>
			<span class="n">ses</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">CIFS_SES_OS2</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">bcc_ptr</span> <span class="o">+=</span> <span class="n">len</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">bleft</span> <span class="o">-=</span> <span class="n">len</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">len</span> <span class="o">=</span> <span class="n">strnlen</span><span class="p">(</span><span class="n">bcc_ptr</span><span class="p">,</span> <span class="n">bleft</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;=</span> <span class="n">bleft</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">ses</span><span class="o">-&gt;</span><span class="n">serverNOS</span><span class="p">);</span>

	<span class="n">ses</span><span class="o">-&gt;</span><span class="n">serverNOS</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="n">len</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ses</span><span class="o">-&gt;</span><span class="n">serverNOS</span><span class="p">)</span>
		<span class="n">strncpy</span><span class="p">(</span><span class="n">ses</span><span class="o">-&gt;</span><span class="n">serverNOS</span><span class="p">,</span> <span class="n">bcc_ptr</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>

	<span class="n">bcc_ptr</span> <span class="o">+=</span> <span class="n">len</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">bleft</span> <span class="o">-=</span> <span class="n">len</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">len</span> <span class="o">=</span> <span class="n">strnlen</span><span class="p">(</span><span class="n">bcc_ptr</span><span class="p">,</span> <span class="n">bleft</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;</span> <span class="n">bleft</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

	<span class="cm">/* No domain field in LANMAN case. Domain is</span>
<span class="cm">	   returned by old servers in the SMB negprot response */</span>
	<span class="cm">/* BB For newer servers which do not support Unicode,</span>
<span class="cm">	   but thus do return domain here we could add parsing</span>
<span class="cm">	   for it later, but it is not very important */</span>
	<span class="n">cFYI</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;ascii: bytes left %d&quot;</span><span class="p">,</span> <span class="n">bleft</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">decode_ntlmssp_challenge</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">bcc_ptr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">blob_len</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">cifs_ses</span> <span class="o">*</span><span class="n">ses</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">tioffset</span><span class="p">;</span> <span class="cm">/* challenge message target info area */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">tilen</span><span class="p">;</span> <span class="cm">/* challenge message target info area length  */</span>

	<span class="n">CHALLENGE_MESSAGE</span> <span class="o">*</span><span class="n">pblob</span> <span class="o">=</span> <span class="p">(</span><span class="n">CHALLENGE_MESSAGE</span> <span class="o">*</span><span class="p">)</span><span class="n">bcc_ptr</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">blob_len</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">CHALLENGE_MESSAGE</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">cERROR</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;challenge blob len %d too small&quot;</span><span class="p">,</span> <span class="n">blob_len</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">memcmp</span><span class="p">(</span><span class="n">pblob</span><span class="o">-&gt;</span><span class="n">Signature</span><span class="p">,</span> <span class="s">&quot;NTLMSSP&quot;</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">cERROR</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;blob signature incorrect %s&quot;</span><span class="p">,</span> <span class="n">pblob</span><span class="o">-&gt;</span><span class="n">Signature</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pblob</span><span class="o">-&gt;</span><span class="n">MessageType</span> <span class="o">!=</span> <span class="n">NtLmChallenge</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cERROR</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;Incorrect message type %d&quot;</span><span class="p">,</span> <span class="n">pblob</span><span class="o">-&gt;</span><span class="n">MessageType</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">ses</span><span class="o">-&gt;</span><span class="n">ntlmssp</span><span class="o">-&gt;</span><span class="n">cryptkey</span><span class="p">,</span> <span class="n">pblob</span><span class="o">-&gt;</span><span class="n">Challenge</span><span class="p">,</span> <span class="n">CIFS_CRYPTO_KEY_SIZE</span><span class="p">);</span>
	<span class="cm">/* BB we could decode pblob-&gt;NegotiateFlags; some may be useful */</span>
	<span class="cm">/* In particular we can examine sign flags */</span>
	<span class="cm">/* BB spec says that if AvId field of MsvAvTimestamp is populated then</span>
<span class="cm">		we must set the MIC field of the AUTHENTICATE_MESSAGE */</span>
	<span class="n">ses</span><span class="o">-&gt;</span><span class="n">ntlmssp</span><span class="o">-&gt;</span><span class="n">server_flags</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">pblob</span><span class="o">-&gt;</span><span class="n">NegotiateFlags</span><span class="p">);</span>
	<span class="n">tioffset</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">pblob</span><span class="o">-&gt;</span><span class="n">TargetInfoArray</span><span class="p">.</span><span class="n">BufferOffset</span><span class="p">);</span>
	<span class="n">tilen</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">pblob</span><span class="o">-&gt;</span><span class="n">TargetInfoArray</span><span class="p">.</span><span class="n">Length</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tioffset</span> <span class="o">&gt;</span> <span class="n">blob_len</span> <span class="o">||</span> <span class="n">tioffset</span> <span class="o">+</span> <span class="n">tilen</span> <span class="o">&gt;</span> <span class="n">blob_len</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cERROR</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;tioffset + tilen too high %u + %u&quot;</span><span class="p">,</span> <span class="n">tioffset</span><span class="p">,</span> <span class="n">tilen</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tilen</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ses</span><span class="o">-&gt;</span><span class="n">auth_key</span><span class="p">.</span><span class="n">response</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">tilen</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ses</span><span class="o">-&gt;</span><span class="n">auth_key</span><span class="p">.</span><span class="n">response</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">cERROR</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;Challenge target info allocation failure&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">ses</span><span class="o">-&gt;</span><span class="n">auth_key</span><span class="p">.</span><span class="n">response</span><span class="p">,</span> <span class="n">bcc_ptr</span> <span class="o">+</span> <span class="n">tioffset</span><span class="p">,</span> <span class="n">tilen</span><span class="p">);</span>
		<span class="n">ses</span><span class="o">-&gt;</span><span class="n">auth_key</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="n">tilen</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* BB Move to ntlmssp.c eventually */</span>

<span class="cm">/* We do not malloc the blob, it is passed in pbuffer, because</span>
<span class="cm">   it is fixed size, and small, making this approach cleaner */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">build_ntlmssp_negotiate_blob</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">pbuffer</span><span class="p">,</span>
					 <span class="k">struct</span> <span class="n">cifs_ses</span> <span class="o">*</span><span class="n">ses</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">NEGOTIATE_MESSAGE</span> <span class="o">*</span><span class="n">sec_blob</span> <span class="o">=</span> <span class="p">(</span><span class="n">NEGOTIATE_MESSAGE</span> <span class="o">*</span><span class="p">)</span><span class="n">pbuffer</span><span class="p">;</span>
	<span class="n">__u32</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">pbuffer</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">NEGOTIATE_MESSAGE</span><span class="p">));</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">sec_blob</span><span class="o">-&gt;</span><span class="n">Signature</span><span class="p">,</span> <span class="n">NTLMSSP_SIGNATURE</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
	<span class="n">sec_blob</span><span class="o">-&gt;</span><span class="n">MessageType</span> <span class="o">=</span> <span class="n">NtLmNegotiate</span><span class="p">;</span>

	<span class="cm">/* BB is NTLMV2 session security format easier to use here? */</span>
	<span class="n">flags</span> <span class="o">=</span> <span class="n">NTLMSSP_NEGOTIATE_56</span> <span class="o">|</span>	<span class="n">NTLMSSP_REQUEST_TARGET</span> <span class="o">|</span>
		<span class="n">NTLMSSP_NEGOTIATE_128</span> <span class="o">|</span> <span class="n">NTLMSSP_NEGOTIATE_UNICODE</span> <span class="o">|</span>
		<span class="n">NTLMSSP_NEGOTIATE_NTLM</span> <span class="o">|</span> <span class="n">NTLMSSP_NEGOTIATE_EXTENDED_SEC</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ses</span><span class="o">-&gt;</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">sec_mode</span> <span class="o">&amp;</span>
			<span class="p">(</span><span class="n">SECMODE_SIGN_REQUIRED</span> <span class="o">|</span> <span class="n">SECMODE_SIGN_ENABLED</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">flags</span> <span class="o">|=</span> <span class="n">NTLMSSP_NEGOTIATE_SIGN</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ses</span><span class="o">-&gt;</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">session_estab</span><span class="p">)</span>
			<span class="n">flags</span> <span class="o">|=</span> <span class="n">NTLMSSP_NEGOTIATE_KEY_XCH</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">sec_blob</span><span class="o">-&gt;</span><span class="n">NegotiateFlags</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>

	<span class="n">sec_blob</span><span class="o">-&gt;</span><span class="n">WorkstationName</span><span class="p">.</span><span class="n">BufferOffset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">sec_blob</span><span class="o">-&gt;</span><span class="n">WorkstationName</span><span class="p">.</span><span class="n">Length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">sec_blob</span><span class="o">-&gt;</span><span class="n">WorkstationName</span><span class="p">.</span><span class="n">MaximumLength</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Domain name is sent on the Challenge not Negotiate NTLMSSP request */</span>
	<span class="n">sec_blob</span><span class="o">-&gt;</span><span class="n">DomainName</span><span class="p">.</span><span class="n">BufferOffset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">sec_blob</span><span class="o">-&gt;</span><span class="n">DomainName</span><span class="p">.</span><span class="n">Length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">sec_blob</span><span class="o">-&gt;</span><span class="n">DomainName</span><span class="p">.</span><span class="n">MaximumLength</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* We do not malloc the blob, it is passed in pbuffer, because its</span>
<span class="cm">   maximum possible size is fixed and small, making this approach cleaner.</span>
<span class="cm">   This function returns the length of the data in the blob */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">build_ntlmssp_auth_blob</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">pbuffer</span><span class="p">,</span>
					<span class="n">u16</span> <span class="o">*</span><span class="n">buflen</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">cifs_ses</span> <span class="o">*</span><span class="n">ses</span><span class="p">,</span>
				   <span class="k">const</span> <span class="k">struct</span> <span class="n">nls_table</span> <span class="o">*</span><span class="n">nls_cp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>
	<span class="n">AUTHENTICATE_MESSAGE</span> <span class="o">*</span><span class="n">sec_blob</span> <span class="o">=</span> <span class="p">(</span><span class="n">AUTHENTICATE_MESSAGE</span> <span class="o">*</span><span class="p">)</span><span class="n">pbuffer</span><span class="p">;</span>
	<span class="n">__u32</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">tmp</span><span class="p">;</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">sec_blob</span><span class="o">-&gt;</span><span class="n">Signature</span><span class="p">,</span> <span class="n">NTLMSSP_SIGNATURE</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
	<span class="n">sec_blob</span><span class="o">-&gt;</span><span class="n">MessageType</span> <span class="o">=</span> <span class="n">NtLmAuthenticate</span><span class="p">;</span>

	<span class="n">flags</span> <span class="o">=</span> <span class="n">NTLMSSP_NEGOTIATE_56</span> <span class="o">|</span>
		<span class="n">NTLMSSP_REQUEST_TARGET</span> <span class="o">|</span> <span class="n">NTLMSSP_NEGOTIATE_TARGET_INFO</span> <span class="o">|</span>
		<span class="n">NTLMSSP_NEGOTIATE_128</span> <span class="o">|</span> <span class="n">NTLMSSP_NEGOTIATE_UNICODE</span> <span class="o">|</span>
		<span class="n">NTLMSSP_NEGOTIATE_NTLM</span> <span class="o">|</span> <span class="n">NTLMSSP_NEGOTIATE_EXTENDED_SEC</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ses</span><span class="o">-&gt;</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">sec_mode</span> <span class="o">&amp;</span>
	   <span class="p">(</span><span class="n">SECMODE_SIGN_REQUIRED</span> <span class="o">|</span> <span class="n">SECMODE_SIGN_ENABLED</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">flags</span> <span class="o">|=</span> <span class="n">NTLMSSP_NEGOTIATE_SIGN</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ses</span><span class="o">-&gt;</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">session_estab</span><span class="p">)</span>
			<span class="n">flags</span> <span class="o">|=</span> <span class="n">NTLMSSP_NEGOTIATE_KEY_XCH</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">tmp</span> <span class="o">=</span> <span class="n">pbuffer</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">AUTHENTICATE_MESSAGE</span><span class="p">);</span>
	<span class="n">sec_blob</span><span class="o">-&gt;</span><span class="n">NegotiateFlags</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>

	<span class="n">sec_blob</span><span class="o">-&gt;</span><span class="n">LmChallengeResponse</span><span class="p">.</span><span class="n">BufferOffset</span> <span class="o">=</span>
				<span class="n">cpu_to_le32</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">AUTHENTICATE_MESSAGE</span><span class="p">));</span>
	<span class="n">sec_blob</span><span class="o">-&gt;</span><span class="n">LmChallengeResponse</span><span class="p">.</span><span class="n">Length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">sec_blob</span><span class="o">-&gt;</span><span class="n">LmChallengeResponse</span><span class="p">.</span><span class="n">MaximumLength</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">sec_blob</span><span class="o">-&gt;</span><span class="n">NtChallengeResponse</span><span class="p">.</span><span class="n">BufferOffset</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">tmp</span> <span class="o">-</span> <span class="n">pbuffer</span><span class="p">);</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">setup_ntlmv2_rsp</span><span class="p">(</span><span class="n">ses</span><span class="p">,</span> <span class="n">nls_cp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cERROR</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;Error %d during NTLMSSP authentication&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">setup_ntlmv2_ret</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="n">ses</span><span class="o">-&gt;</span><span class="n">auth_key</span><span class="p">.</span><span class="n">response</span> <span class="o">+</span> <span class="n">CIFS_SESS_KEY_SIZE</span><span class="p">,</span>
			<span class="n">ses</span><span class="o">-&gt;</span><span class="n">auth_key</span><span class="p">.</span><span class="n">len</span> <span class="o">-</span> <span class="n">CIFS_SESS_KEY_SIZE</span><span class="p">);</span>
	<span class="n">tmp</span> <span class="o">+=</span> <span class="n">ses</span><span class="o">-&gt;</span><span class="n">auth_key</span><span class="p">.</span><span class="n">len</span> <span class="o">-</span> <span class="n">CIFS_SESS_KEY_SIZE</span><span class="p">;</span>

	<span class="n">sec_blob</span><span class="o">-&gt;</span><span class="n">NtChallengeResponse</span><span class="p">.</span><span class="n">Length</span> <span class="o">=</span>
			<span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">ses</span><span class="o">-&gt;</span><span class="n">auth_key</span><span class="p">.</span><span class="n">len</span> <span class="o">-</span> <span class="n">CIFS_SESS_KEY_SIZE</span><span class="p">);</span>
	<span class="n">sec_blob</span><span class="o">-&gt;</span><span class="n">NtChallengeResponse</span><span class="p">.</span><span class="n">MaximumLength</span> <span class="o">=</span>
			<span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">ses</span><span class="o">-&gt;</span><span class="n">auth_key</span><span class="p">.</span><span class="n">len</span> <span class="o">-</span> <span class="n">CIFS_SESS_KEY_SIZE</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ses</span><span class="o">-&gt;</span><span class="n">domainName</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sec_blob</span><span class="o">-&gt;</span><span class="n">DomainName</span><span class="p">.</span><span class="n">BufferOffset</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">tmp</span> <span class="o">-</span> <span class="n">pbuffer</span><span class="p">);</span>
		<span class="n">sec_blob</span><span class="o">-&gt;</span><span class="n">DomainName</span><span class="p">.</span><span class="n">Length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">sec_blob</span><span class="o">-&gt;</span><span class="n">DomainName</span><span class="p">.</span><span class="n">MaximumLength</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">tmp</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">len</span><span class="p">;</span>
		<span class="n">len</span> <span class="o">=</span> <span class="n">cifs_strtoUTF16</span><span class="p">((</span><span class="n">__le16</span> <span class="o">*</span><span class="p">)</span><span class="n">tmp</span><span class="p">,</span> <span class="n">ses</span><span class="o">-&gt;</span><span class="n">domainName</span><span class="p">,</span>
				      <span class="n">MAX_USERNAME_SIZE</span><span class="p">,</span> <span class="n">nls_cp</span><span class="p">);</span>
		<span class="n">len</span> <span class="o">*=</span> <span class="mi">2</span><span class="p">;</span> <span class="cm">/* unicode is 2 bytes each */</span>
		<span class="n">sec_blob</span><span class="o">-&gt;</span><span class="n">DomainName</span><span class="p">.</span><span class="n">BufferOffset</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">tmp</span> <span class="o">-</span> <span class="n">pbuffer</span><span class="p">);</span>
		<span class="n">sec_blob</span><span class="o">-&gt;</span><span class="n">DomainName</span><span class="p">.</span><span class="n">Length</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">len</span><span class="p">);</span>
		<span class="n">sec_blob</span><span class="o">-&gt;</span><span class="n">DomainName</span><span class="p">.</span><span class="n">MaximumLength</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">len</span><span class="p">);</span>
		<span class="n">tmp</span> <span class="o">+=</span> <span class="n">len</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ses</span><span class="o">-&gt;</span><span class="n">user_name</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sec_blob</span><span class="o">-&gt;</span><span class="n">UserName</span><span class="p">.</span><span class="n">BufferOffset</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">tmp</span> <span class="o">-</span> <span class="n">pbuffer</span><span class="p">);</span>
		<span class="n">sec_blob</span><span class="o">-&gt;</span><span class="n">UserName</span><span class="p">.</span><span class="n">Length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">sec_blob</span><span class="o">-&gt;</span><span class="n">UserName</span><span class="p">.</span><span class="n">MaximumLength</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">tmp</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">len</span><span class="p">;</span>
		<span class="n">len</span> <span class="o">=</span> <span class="n">cifs_strtoUTF16</span><span class="p">((</span><span class="n">__le16</span> <span class="o">*</span><span class="p">)</span><span class="n">tmp</span><span class="p">,</span> <span class="n">ses</span><span class="o">-&gt;</span><span class="n">user_name</span><span class="p">,</span>
				      <span class="n">MAX_USERNAME_SIZE</span><span class="p">,</span> <span class="n">nls_cp</span><span class="p">);</span>
		<span class="n">len</span> <span class="o">*=</span> <span class="mi">2</span><span class="p">;</span> <span class="cm">/* unicode is 2 bytes each */</span>
		<span class="n">sec_blob</span><span class="o">-&gt;</span><span class="n">UserName</span><span class="p">.</span><span class="n">BufferOffset</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">tmp</span> <span class="o">-</span> <span class="n">pbuffer</span><span class="p">);</span>
		<span class="n">sec_blob</span><span class="o">-&gt;</span><span class="n">UserName</span><span class="p">.</span><span class="n">Length</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">len</span><span class="p">);</span>
		<span class="n">sec_blob</span><span class="o">-&gt;</span><span class="n">UserName</span><span class="p">.</span><span class="n">MaximumLength</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">len</span><span class="p">);</span>
		<span class="n">tmp</span> <span class="o">+=</span> <span class="n">len</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">sec_blob</span><span class="o">-&gt;</span><span class="n">WorkstationName</span><span class="p">.</span><span class="n">BufferOffset</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">tmp</span> <span class="o">-</span> <span class="n">pbuffer</span><span class="p">);</span>
	<span class="n">sec_blob</span><span class="o">-&gt;</span><span class="n">WorkstationName</span><span class="p">.</span><span class="n">Length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">sec_blob</span><span class="o">-&gt;</span><span class="n">WorkstationName</span><span class="p">.</span><span class="n">MaximumLength</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">tmp</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(((</span><span class="n">ses</span><span class="o">-&gt;</span><span class="n">ntlmssp</span><span class="o">-&gt;</span><span class="n">server_flags</span> <span class="o">&amp;</span> <span class="n">NTLMSSP_NEGOTIATE_KEY_XCH</span><span class="p">)</span> <span class="o">||</span>
		<span class="p">(</span><span class="n">ses</span><span class="o">-&gt;</span><span class="n">ntlmssp</span><span class="o">-&gt;</span><span class="n">server_flags</span> <span class="o">&amp;</span> <span class="n">NTLMSSP_NEGOTIATE_EXTENDED_SEC</span><span class="p">))</span>
			<span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">calc_seckey</span><span class="p">(</span><span class="n">ses</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="n">ses</span><span class="o">-&gt;</span><span class="n">ntlmssp</span><span class="o">-&gt;</span><span class="n">ciphertext</span><span class="p">,</span> <span class="n">CIFS_CPHTXT_SIZE</span><span class="p">);</span>
		<span class="n">sec_blob</span><span class="o">-&gt;</span><span class="n">SessionKey</span><span class="p">.</span><span class="n">BufferOffset</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">tmp</span> <span class="o">-</span> <span class="n">pbuffer</span><span class="p">);</span>
		<span class="n">sec_blob</span><span class="o">-&gt;</span><span class="n">SessionKey</span><span class="p">.</span><span class="n">Length</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">CIFS_CPHTXT_SIZE</span><span class="p">);</span>
		<span class="n">sec_blob</span><span class="o">-&gt;</span><span class="n">SessionKey</span><span class="p">.</span><span class="n">MaximumLength</span> <span class="o">=</span>
				<span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">CIFS_CPHTXT_SIZE</span><span class="p">);</span>
		<span class="n">tmp</span> <span class="o">+=</span> <span class="n">CIFS_CPHTXT_SIZE</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">sec_blob</span><span class="o">-&gt;</span><span class="n">SessionKey</span><span class="p">.</span><span class="n">BufferOffset</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">tmp</span> <span class="o">-</span> <span class="n">pbuffer</span><span class="p">);</span>
		<span class="n">sec_blob</span><span class="o">-&gt;</span><span class="n">SessionKey</span><span class="p">.</span><span class="n">Length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">sec_blob</span><span class="o">-&gt;</span><span class="n">SessionKey</span><span class="p">.</span><span class="n">MaximumLength</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">setup_ntlmv2_ret:</span>
	<span class="o">*</span><span class="n">buflen</span> <span class="o">=</span> <span class="n">tmp</span> <span class="o">-</span> <span class="n">pbuffer</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="nf">CIFS_SessSetup</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">xid</span><span class="p">,</span> <span class="k">struct</span> <span class="n">cifs_ses</span> <span class="o">*</span><span class="n">ses</span><span class="p">,</span>
	       <span class="k">const</span> <span class="k">struct</span> <span class="n">nls_table</span> <span class="o">*</span><span class="n">nls_cp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">wct</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">smb_hdr</span> <span class="o">*</span><span class="n">smb_buf</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">bcc_ptr</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">str_area</span><span class="p">;</span>
	<span class="n">SESSION_SETUP_ANDX</span> <span class="o">*</span><span class="n">pSMB</span><span class="p">;</span>
	<span class="n">__u32</span> <span class="n">capabilities</span><span class="p">;</span>
	<span class="n">__u16</span> <span class="n">count</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">resp_buf_type</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">kvec</span> <span class="n">iov</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
	<span class="k">enum</span> <span class="n">securityEnum</span> <span class="n">type</span><span class="p">;</span>
	<span class="n">__u16</span> <span class="n">action</span><span class="p">,</span> <span class="n">bytes_remaining</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">key</span> <span class="o">*</span><span class="n">spnego_key</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">__le32</span> <span class="n">phase</span> <span class="o">=</span> <span class="n">NtLmNegotiate</span><span class="p">;</span> <span class="cm">/* NTLMSSP, if needed, is multistage */</span>
	<span class="n">u16</span> <span class="n">blob_len</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">ntlmsspblob</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ses</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">type</span> <span class="o">=</span> <span class="n">ses</span><span class="o">-&gt;</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">secType</span><span class="p">;</span>
	<span class="n">cFYI</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;sess setup type %d&quot;</span><span class="p">,</span> <span class="n">type</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="n">RawNTLMSSP</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* if memory allocation is successful, caller of this function</span>
<span class="cm">		 * frees it.</span>
<span class="cm">		 */</span>
		<span class="n">ses</span><span class="o">-&gt;</span><span class="n">ntlmssp</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ntlmssp_auth</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ses</span><span class="o">-&gt;</span><span class="n">ntlmssp</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">ssetup_ntlmssp_authenticate:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">phase</span> <span class="o">==</span> <span class="n">NtLmChallenge</span><span class="p">)</span>
		<span class="n">phase</span> <span class="o">=</span> <span class="n">NtLmAuthenticate</span><span class="p">;</span> <span class="cm">/* if ntlmssp, now final phase */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="n">LANMAN</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#ifndef CONFIG_CIFS_WEAK_PW_HASH</span>
		<span class="cm">/* LANMAN and plaintext are less secure and off by default.</span>
<span class="cm">		So we make this explicitly be turned on in kconfig (in the</span>
<span class="cm">		build) and turned on at runtime (changed from the default)</span>
<span class="cm">		in proc/fs/cifs or via mount parm.  Unfortunately this is</span>
<span class="cm">		needed for old Win (e.g. Win95), some obscure NAS and OS/2 */</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
<span class="cp">#endif</span>
		<span class="n">wct</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span> <span class="cm">/* lanman 2 style sessionsetup */</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">type</span> <span class="o">==</span> <span class="n">NTLM</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="n">NTLMv2</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* For NTLMv2 failures eventually may need to retry NTLM */</span>
		<span class="n">wct</span> <span class="o">=</span> <span class="mi">13</span><span class="p">;</span> <span class="cm">/* old style NTLM sessionsetup */</span>
	<span class="p">}</span> <span class="k">else</span> <span class="cm">/* same size: negotiate or auth, NTLMSSP or extended security */</span>
		<span class="n">wct</span> <span class="o">=</span> <span class="mi">12</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">small_smb_init_no_tc</span><span class="p">(</span><span class="n">SMB_COM_SESSION_SETUP_ANDX</span><span class="p">,</span> <span class="n">wct</span><span class="p">,</span> <span class="n">ses</span><span class="p">,</span>
			    <span class="p">(</span><span class="kt">void</span> <span class="o">**</span><span class="p">)</span><span class="o">&amp;</span><span class="n">smb_buf</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">pSMB</span> <span class="o">=</span> <span class="p">(</span><span class="n">SESSION_SETUP_ANDX</span> <span class="o">*</span><span class="p">)</span><span class="n">smb_buf</span><span class="p">;</span>

	<span class="n">capabilities</span> <span class="o">=</span> <span class="n">cifs_ssetup_hdr</span><span class="p">(</span><span class="n">ses</span><span class="p">,</span> <span class="n">pSMB</span><span class="p">);</span>

	<span class="cm">/* we will send the SMB in three pieces:</span>
<span class="cm">	a fixed length beginning part, an optional</span>
<span class="cm">	SPNEGO blob (which can be zero length), and a</span>
<span class="cm">	last part which will include the strings</span>
<span class="cm">	and rest of bcc area. This allows us to avoid</span>
<span class="cm">	a large buffer 17K allocation */</span>
	<span class="n">iov</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">iov_base</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">pSMB</span><span class="p">;</span>
	<span class="n">iov</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">iov_len</span> <span class="o">=</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">smb_buf</span><span class="o">-&gt;</span><span class="n">smb_buf_length</span><span class="p">)</span> <span class="o">+</span> <span class="mi">4</span><span class="p">;</span>

	<span class="cm">/* setting this here allows the code at the end of the function</span>
<span class="cm">	   to free the request buffer if there&#39;s an error */</span>
	<span class="n">resp_buf_type</span> <span class="o">=</span> <span class="n">CIFS_SMALL_BUFFER</span><span class="p">;</span>

	<span class="cm">/* 2000 big enough to fit max user, domain, NOS name etc. */</span>
	<span class="n">str_area</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="mi">2000</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">str_area</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">ssetup_exit</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">bcc_ptr</span> <span class="o">=</span> <span class="n">str_area</span><span class="p">;</span>

	<span class="n">ses</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">CIFS_SES_LANMAN</span><span class="p">;</span>

	<span class="n">iov</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">iov_base</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">iov</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">iov_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="n">LANMAN</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#ifdef CONFIG_CIFS_WEAK_PW_HASH</span>
		<span class="kt">char</span> <span class="n">lnm_session_key</span><span class="p">[</span><span class="n">CIFS_AUTH_RESP_SIZE</span><span class="p">];</span>

		<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">hdr</span><span class="p">.</span><span class="n">Flags2</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SMBFLG2_UNICODE</span><span class="p">;</span>

		<span class="cm">/* no capabilities flags in old lanman negotiation */</span>

		<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">old_req</span><span class="p">.</span><span class="n">PasswordLength</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">CIFS_AUTH_RESP_SIZE</span><span class="p">);</span>

		<span class="cm">/* Calculate hash with password and copy into bcc_ptr.</span>
<span class="cm">		 * Encryption Key (stored as in cryptkey) gets used if the</span>
<span class="cm">		 * security mode bit in Negottiate Protocol response states</span>
<span class="cm">		 * to use challenge/response method (i.e. Password bit is 1).</span>
<span class="cm">		 */</span>

		<span class="n">rc</span> <span class="o">=</span> <span class="n">calc_lanman_hash</span><span class="p">(</span><span class="n">ses</span><span class="o">-&gt;</span><span class="n">password</span><span class="p">,</span> <span class="n">ses</span><span class="o">-&gt;</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">cryptkey</span><span class="p">,</span>
				 <span class="n">ses</span><span class="o">-&gt;</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">sec_mode</span> <span class="o">&amp;</span> <span class="n">SECMODE_PW_ENCRYPT</span> <span class="o">?</span>
					<span class="nb">true</span> <span class="o">:</span> <span class="nb">false</span><span class="p">,</span> <span class="n">lnm_session_key</span><span class="p">);</span>

		<span class="n">ses</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">CIFS_SES_LANMAN</span><span class="p">;</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">bcc_ptr</span><span class="p">,</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">lnm_session_key</span><span class="p">,</span> <span class="n">CIFS_AUTH_RESP_SIZE</span><span class="p">);</span>
		<span class="n">bcc_ptr</span> <span class="o">+=</span> <span class="n">CIFS_AUTH_RESP_SIZE</span><span class="p">;</span>

		<span class="cm">/* can not sign if LANMAN negotiated so no need</span>
<span class="cm">		to calculate signing key? but what if server</span>
<span class="cm">		changed to do higher than lanman dialect and</span>
<span class="cm">		we reconnected would we ever calc signing_key? */</span>

		<span class="n">cFYI</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;Negotiating LANMAN setting up strings&quot;</span><span class="p">);</span>
		<span class="cm">/* Unicode not allowed for LANMAN dialects */</span>
		<span class="n">ascii_ssetup_strings</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bcc_ptr</span><span class="p">,</span> <span class="n">ses</span><span class="p">,</span> <span class="n">nls_cp</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="n">NTLM</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">req_no_secext</span><span class="p">.</span><span class="n">Capabilities</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">capabilities</span><span class="p">);</span>
		<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">req_no_secext</span><span class="p">.</span><span class="n">CaseInsensitivePasswordLength</span> <span class="o">=</span>
			<span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">CIFS_AUTH_RESP_SIZE</span><span class="p">);</span>
		<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">req_no_secext</span><span class="p">.</span><span class="n">CaseSensitivePasswordLength</span> <span class="o">=</span>
			<span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">CIFS_AUTH_RESP_SIZE</span><span class="p">);</span>

		<span class="cm">/* calculate ntlm response and session key */</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">setup_ntlm_response</span><span class="p">(</span><span class="n">ses</span><span class="p">,</span> <span class="n">nls_cp</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">cERROR</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;Error %d during NTLM authentication&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">ssetup_exit</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* copy ntlm response */</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">bcc_ptr</span><span class="p">,</span> <span class="n">ses</span><span class="o">-&gt;</span><span class="n">auth_key</span><span class="p">.</span><span class="n">response</span> <span class="o">+</span> <span class="n">CIFS_SESS_KEY_SIZE</span><span class="p">,</span>
				<span class="n">CIFS_AUTH_RESP_SIZE</span><span class="p">);</span>
		<span class="n">bcc_ptr</span> <span class="o">+=</span> <span class="n">CIFS_AUTH_RESP_SIZE</span><span class="p">;</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">bcc_ptr</span><span class="p">,</span> <span class="n">ses</span><span class="o">-&gt;</span><span class="n">auth_key</span><span class="p">.</span><span class="n">response</span> <span class="o">+</span> <span class="n">CIFS_SESS_KEY_SIZE</span><span class="p">,</span>
				<span class="n">CIFS_AUTH_RESP_SIZE</span><span class="p">);</span>
		<span class="n">bcc_ptr</span> <span class="o">+=</span> <span class="n">CIFS_AUTH_RESP_SIZE</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ses</span><span class="o">-&gt;</span><span class="n">capabilities</span> <span class="o">&amp;</span> <span class="n">CAP_UNICODE</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* unicode strings must be word aligned */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">iov</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">iov_len</span> <span class="o">%</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
				<span class="o">*</span><span class="n">bcc_ptr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">bcc_ptr</span><span class="o">++</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">unicode_ssetup_strings</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bcc_ptr</span><span class="p">,</span> <span class="n">ses</span><span class="p">,</span> <span class="n">nls_cp</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">ascii_ssetup_strings</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bcc_ptr</span><span class="p">,</span> <span class="n">ses</span><span class="p">,</span> <span class="n">nls_cp</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="n">NTLMv2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">req_no_secext</span><span class="p">.</span><span class="n">Capabilities</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">capabilities</span><span class="p">);</span>

		<span class="cm">/* LM2 password would be here if we supported it */</span>
		<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">req_no_secext</span><span class="p">.</span><span class="n">CaseInsensitivePasswordLength</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="cm">/* calculate nlmv2 response and session key */</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">setup_ntlmv2_rsp</span><span class="p">(</span><span class="n">ses</span><span class="p">,</span> <span class="n">nls_cp</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">cERROR</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;Error %d during NTLMv2 authentication&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">ssetup_exit</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">bcc_ptr</span><span class="p">,</span> <span class="n">ses</span><span class="o">-&gt;</span><span class="n">auth_key</span><span class="p">.</span><span class="n">response</span> <span class="o">+</span> <span class="n">CIFS_SESS_KEY_SIZE</span><span class="p">,</span>
				<span class="n">ses</span><span class="o">-&gt;</span><span class="n">auth_key</span><span class="p">.</span><span class="n">len</span> <span class="o">-</span> <span class="n">CIFS_SESS_KEY_SIZE</span><span class="p">);</span>
		<span class="n">bcc_ptr</span> <span class="o">+=</span> <span class="n">ses</span><span class="o">-&gt;</span><span class="n">auth_key</span><span class="p">.</span><span class="n">len</span> <span class="o">-</span> <span class="n">CIFS_SESS_KEY_SIZE</span><span class="p">;</span>

		<span class="cm">/* set case sensitive password length after tilen may get</span>
<span class="cm">		 * assigned, tilen is 0 otherwise.</span>
<span class="cm">		 */</span>
		<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">req_no_secext</span><span class="p">.</span><span class="n">CaseSensitivePasswordLength</span> <span class="o">=</span>
			<span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">ses</span><span class="o">-&gt;</span><span class="n">auth_key</span><span class="p">.</span><span class="n">len</span> <span class="o">-</span> <span class="n">CIFS_SESS_KEY_SIZE</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ses</span><span class="o">-&gt;</span><span class="n">capabilities</span> <span class="o">&amp;</span> <span class="n">CAP_UNICODE</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">iov</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">iov_len</span> <span class="o">%</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
				<span class="o">*</span><span class="n">bcc_ptr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">bcc_ptr</span><span class="o">++</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">unicode_ssetup_strings</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bcc_ptr</span><span class="p">,</span> <span class="n">ses</span><span class="p">,</span> <span class="n">nls_cp</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">ascii_ssetup_strings</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bcc_ptr</span><span class="p">,</span> <span class="n">ses</span><span class="p">,</span> <span class="n">nls_cp</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="n">Kerberos</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#ifdef CONFIG_CIFS_UPCALL</span>
		<span class="k">struct</span> <span class="n">cifs_spnego_msg</span> <span class="o">*</span><span class="n">msg</span><span class="p">;</span>

		<span class="n">spnego_key</span> <span class="o">=</span> <span class="n">cifs_get_spnego_key</span><span class="p">(</span><span class="n">ses</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">spnego_key</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">spnego_key</span><span class="p">);</span>
			<span class="n">spnego_key</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">ssetup_exit</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">msg</span> <span class="o">=</span> <span class="n">spnego_key</span><span class="o">-&gt;</span><span class="n">payload</span><span class="p">.</span><span class="n">data</span><span class="p">;</span>
		<span class="cm">/* check version field to make sure that cifs.upcall is</span>
<span class="cm">		   sending us a response in an expected form */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">version</span> <span class="o">!=</span> <span class="n">CIFS_SPNEGO_UPCALL_VERSION</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">cERROR</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;incorrect version of cifs.upcall (expected&quot;</span>
				   <span class="s">&quot; %d but got %d)&quot;</span><span class="p">,</span>
				   <span class="n">CIFS_SPNEGO_UPCALL_VERSION</span><span class="p">,</span> <span class="n">msg</span><span class="o">-&gt;</span><span class="n">version</span><span class="p">);</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EKEYREJECTED</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">ssetup_exit</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">ses</span><span class="o">-&gt;</span><span class="n">auth_key</span><span class="p">.</span><span class="n">response</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">sesskey_len</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ses</span><span class="o">-&gt;</span><span class="n">auth_key</span><span class="p">.</span><span class="n">response</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">cERROR</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;Kerberos can&#39;t allocate (%u bytes) memory&quot;</span><span class="p">,</span>
					<span class="n">msg</span><span class="o">-&gt;</span><span class="n">sesskey_len</span><span class="p">);</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">ssetup_exit</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">ses</span><span class="o">-&gt;</span><span class="n">auth_key</span><span class="p">.</span><span class="n">response</span><span class="p">,</span> <span class="n">msg</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">msg</span><span class="o">-&gt;</span><span class="n">sesskey_len</span><span class="p">);</span>
		<span class="n">ses</span><span class="o">-&gt;</span><span class="n">auth_key</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="n">msg</span><span class="o">-&gt;</span><span class="n">sesskey_len</span><span class="p">;</span>

		<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">hdr</span><span class="p">.</span><span class="n">Flags2</span> <span class="o">|=</span> <span class="n">SMBFLG2_EXT_SEC</span><span class="p">;</span>
		<span class="n">capabilities</span> <span class="o">|=</span> <span class="n">CAP_EXTENDED_SECURITY</span><span class="p">;</span>
		<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">Capabilities</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">capabilities</span><span class="p">);</span>
		<span class="n">iov</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">iov_base</span> <span class="o">=</span> <span class="n">msg</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">+</span> <span class="n">msg</span><span class="o">-&gt;</span><span class="n">sesskey_len</span><span class="p">;</span>
		<span class="n">iov</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">iov_len</span> <span class="o">=</span> <span class="n">msg</span><span class="o">-&gt;</span><span class="n">secblob_len</span><span class="p">;</span>
		<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">SecurityBlobLength</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">iov</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">iov_len</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ses</span><span class="o">-&gt;</span><span class="n">capabilities</span> <span class="o">&amp;</span> <span class="n">CAP_UNICODE</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* unicode strings must be word aligned */</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">iov</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">iov_len</span> <span class="o">+</span> <span class="n">iov</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">iov_len</span><span class="p">)</span> <span class="o">%</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
				<span class="o">*</span><span class="n">bcc_ptr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">bcc_ptr</span><span class="o">++</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">unicode_oslm_strings</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bcc_ptr</span><span class="p">,</span> <span class="n">nls_cp</span><span class="p">);</span>
			<span class="n">unicode_domain_string</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bcc_ptr</span><span class="p">,</span> <span class="n">ses</span><span class="p">,</span> <span class="n">nls_cp</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span>
		<span class="cm">/* BB: is this right? */</span>
			<span class="n">ascii_ssetup_strings</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bcc_ptr</span><span class="p">,</span> <span class="n">ses</span><span class="p">,</span> <span class="n">nls_cp</span><span class="p">);</span>
<span class="cp">#else </span><span class="cm">/* ! CONFIG_CIFS_UPCALL */</span><span class="cp"></span>
		<span class="n">cERROR</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;Kerberos negotiated but upcall support disabled!&quot;</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOSYS</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">ssetup_exit</span><span class="p">;</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_CIFS_UPCALL */</span><span class="cp"></span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="n">RawNTLMSSP</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">hdr</span><span class="p">.</span><span class="n">Flags2</span> <span class="o">&amp;</span> <span class="n">SMBFLG2_UNICODE</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">cERROR</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;NTLMSSP requires Unicode support&quot;</span><span class="p">);</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOSYS</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">ssetup_exit</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">cFYI</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;ntlmssp session setup phase %d&quot;</span><span class="p">,</span> <span class="n">phase</span><span class="p">);</span>
		<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">hdr</span><span class="p">.</span><span class="n">Flags2</span> <span class="o">|=</span> <span class="n">SMBFLG2_EXT_SEC</span><span class="p">;</span>
		<span class="n">capabilities</span> <span class="o">|=</span> <span class="n">CAP_EXTENDED_SECURITY</span><span class="p">;</span>
		<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">Capabilities</span> <span class="o">|=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">capabilities</span><span class="p">);</span>
		<span class="k">switch</span><span class="p">(</span><span class="n">phase</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">NtLmNegotiate</span>:
			<span class="n">build_ntlmssp_negotiate_blob</span><span class="p">(</span>
				<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">SecurityBlob</span><span class="p">,</span> <span class="n">ses</span><span class="p">);</span>
			<span class="n">iov</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">iov_len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">NEGOTIATE_MESSAGE</span><span class="p">);</span>
			<span class="n">iov</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">iov_base</span> <span class="o">=</span> <span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">SecurityBlob</span><span class="p">;</span>
			<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">SecurityBlobLength</span> <span class="o">=</span>
				<span class="n">cpu_to_le16</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">NEGOTIATE_MESSAGE</span><span class="p">));</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">NtLmAuthenticate</span>:
			<span class="cm">/*</span>
<span class="cm">			 * 5 is an empirical value, large enough to hold</span>
<span class="cm">			 * authenticate message plus max 10 of av paris,</span>
<span class="cm">			 * domain, user, workstation names, flags, etc.</span>
<span class="cm">			 */</span>
			<span class="n">ntlmsspblob</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span>
				<span class="mi">5</span><span class="o">*</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">_AUTHENTICATE_MESSAGE</span><span class="p">),</span>
				<span class="n">GFP_KERNEL</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ntlmsspblob</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">cERROR</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;Can&#39;t allocate NTLMSSP blob&quot;</span><span class="p">);</span>
				<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">ssetup_exit</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">rc</span> <span class="o">=</span> <span class="n">build_ntlmssp_auth_blob</span><span class="p">(</span><span class="n">ntlmsspblob</span><span class="p">,</span>
						<span class="o">&amp;</span><span class="n">blob_len</span><span class="p">,</span> <span class="n">ses</span><span class="p">,</span> <span class="n">nls_cp</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">ssetup_exit</span><span class="p">;</span>
			<span class="n">iov</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">iov_len</span> <span class="o">=</span> <span class="n">blob_len</span><span class="p">;</span>
			<span class="n">iov</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">iov_base</span> <span class="o">=</span> <span class="n">ntlmsspblob</span><span class="p">;</span>
			<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">SecurityBlobLength</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">blob_len</span><span class="p">);</span>
			<span class="cm">/*</span>
<span class="cm">			 * Make sure that we tell the server that we are using</span>
<span class="cm">			 * the uid that it just gave us back on the response</span>
<span class="cm">			 * (challenge)</span>
<span class="cm">			 */</span>
			<span class="n">smb_buf</span><span class="o">-&gt;</span><span class="n">Uid</span> <span class="o">=</span> <span class="n">ses</span><span class="o">-&gt;</span><span class="n">Suid</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">cERROR</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;invalid phase %d&quot;</span><span class="p">,</span> <span class="n">phase</span><span class="p">);</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOSYS</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">ssetup_exit</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* unicode strings must be word aligned */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">iov</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">iov_len</span> <span class="o">+</span> <span class="n">iov</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">iov_len</span><span class="p">)</span> <span class="o">%</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
			<span class="o">*</span><span class="n">bcc_ptr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">bcc_ptr</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">unicode_oslm_strings</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bcc_ptr</span><span class="p">,</span> <span class="n">nls_cp</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">cERROR</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;secType %d not supported!&quot;</span><span class="p">,</span> <span class="n">type</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOSYS</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">ssetup_exit</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">iov</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">iov_base</span> <span class="o">=</span> <span class="n">str_area</span><span class="p">;</span>
	<span class="n">iov</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">iov_len</span> <span class="o">=</span> <span class="p">(</span><span class="kt">long</span><span class="p">)</span> <span class="n">bcc_ptr</span> <span class="o">-</span> <span class="p">(</span><span class="kt">long</span><span class="p">)</span> <span class="n">str_area</span><span class="p">;</span>

	<span class="n">count</span> <span class="o">=</span> <span class="n">iov</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">iov_len</span> <span class="o">+</span> <span class="n">iov</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">iov_len</span><span class="p">;</span>
	<span class="n">smb_buf</span><span class="o">-&gt;</span><span class="n">smb_buf_length</span> <span class="o">=</span>
		<span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">smb_buf</span><span class="o">-&gt;</span><span class="n">smb_buf_length</span><span class="p">)</span> <span class="o">+</span> <span class="n">count</span><span class="p">);</span>

	<span class="n">put_bcc</span><span class="p">(</span><span class="n">count</span><span class="p">,</span> <span class="n">smb_buf</span><span class="p">);</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">SendReceive2</span><span class="p">(</span><span class="n">xid</span><span class="p">,</span> <span class="n">ses</span><span class="p">,</span> <span class="n">iov</span><span class="p">,</span> <span class="mi">3</span> <span class="cm">/* num_iovecs */</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">resp_buf_type</span><span class="p">,</span>
			  <span class="n">CIFS_LOG_ERROR</span><span class="p">);</span>
	<span class="cm">/* SMB request buf freed in SendReceive2 */</span>

	<span class="n">pSMB</span> <span class="o">=</span> <span class="p">(</span><span class="n">SESSION_SETUP_ANDX</span> <span class="o">*</span><span class="p">)</span><span class="n">iov</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">iov_base</span><span class="p">;</span>
	<span class="n">smb_buf</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">smb_hdr</span> <span class="o">*</span><span class="p">)</span><span class="n">iov</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">iov_base</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">type</span> <span class="o">==</span> <span class="n">RawNTLMSSP</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">smb_buf</span><span class="o">-&gt;</span><span class="n">Status</span><span class="p">.</span><span class="n">CifsError</span> <span class="o">==</span>
			<span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">NT_STATUS_MORE_PROCESSING_REQUIRED</span><span class="p">)))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">phase</span> <span class="o">!=</span> <span class="n">NtLmNegotiate</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">cERROR</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;Unexpected more processing error&quot;</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">ssetup_exit</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* NTLMSSP Negotiate sent now processing challenge (response) */</span>
		<span class="n">phase</span> <span class="o">=</span> <span class="n">NtLmChallenge</span><span class="p">;</span> <span class="cm">/* process ntlmssp challenge */</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* MORE_PROC rc is not an error here, but expected */</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">ssetup_exit</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">smb_buf</span><span class="o">-&gt;</span><span class="n">WordCount</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">smb_buf</span><span class="o">-&gt;</span><span class="n">WordCount</span> <span class="o">!=</span> <span class="mi">4</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="n">cERROR</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;bad word count %d&quot;</span><span class="p">,</span> <span class="n">smb_buf</span><span class="o">-&gt;</span><span class="n">WordCount</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">ssetup_exit</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">action</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">resp</span><span class="p">.</span><span class="n">Action</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">action</span> <span class="o">&amp;</span> <span class="n">GUEST_LOGIN</span><span class="p">)</span>
		<span class="n">cFYI</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;Guest login&quot;</span><span class="p">);</span> <span class="cm">/* BB mark SesInfo struct? */</span>
	<span class="n">ses</span><span class="o">-&gt;</span><span class="n">Suid</span> <span class="o">=</span> <span class="n">smb_buf</span><span class="o">-&gt;</span><span class="n">Uid</span><span class="p">;</span>   <span class="cm">/* UID left in wire format (le) */</span>
	<span class="n">cFYI</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;UID = %d &quot;</span><span class="p">,</span> <span class="n">ses</span><span class="o">-&gt;</span><span class="n">Suid</span><span class="p">);</span>
	<span class="cm">/* response can have either 3 or 4 word count - Samba sends 3 */</span>
	<span class="cm">/* and lanman response is 3 */</span>
	<span class="n">bytes_remaining</span> <span class="o">=</span> <span class="n">get_bcc</span><span class="p">(</span><span class="n">smb_buf</span><span class="p">);</span>
	<span class="n">bcc_ptr</span> <span class="o">=</span> <span class="n">pByteArea</span><span class="p">(</span><span class="n">smb_buf</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">smb_buf</span><span class="o">-&gt;</span><span class="n">WordCount</span> <span class="o">==</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">blob_len</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">resp</span><span class="p">.</span><span class="n">SecurityBlobLength</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">blob_len</span> <span class="o">&gt;</span> <span class="n">bytes_remaining</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">cERROR</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;bad security blob length %d&quot;</span><span class="p">,</span> <span class="n">blob_len</span><span class="p">);</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">ssetup_exit</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">phase</span> <span class="o">==</span> <span class="n">NtLmChallenge</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="n">decode_ntlmssp_challenge</span><span class="p">(</span><span class="n">bcc_ptr</span><span class="p">,</span> <span class="n">blob_len</span><span class="p">,</span> <span class="n">ses</span><span class="p">);</span>
			<span class="cm">/* now goto beginning for ntlmssp authenticate phase */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">ssetup_exit</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">bcc_ptr</span> <span class="o">+=</span> <span class="n">blob_len</span><span class="p">;</span>
		<span class="n">bytes_remaining</span> <span class="o">-=</span> <span class="n">blob_len</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* BB check if Unicode and decode strings */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bytes_remaining</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* no string area to decode, do nothing */</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">smb_buf</span><span class="o">-&gt;</span><span class="n">Flags2</span> <span class="o">&amp;</span> <span class="n">SMBFLG2_UNICODE</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* unicode string area must be word-aligned */</span>
		<span class="k">if</span> <span class="p">(((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">bcc_ptr</span> <span class="o">-</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">smb_buf</span><span class="p">)</span> <span class="o">%</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
			<span class="o">++</span><span class="n">bcc_ptr</span><span class="p">;</span>
			<span class="o">--</span><span class="n">bytes_remaining</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">decode_unicode_ssetup</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bcc_ptr</span><span class="p">,</span> <span class="n">bytes_remaining</span><span class="p">,</span> <span class="n">ses</span><span class="p">,</span> <span class="n">nls_cp</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">decode_ascii_ssetup</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bcc_ptr</span><span class="p">,</span> <span class="n">bytes_remaining</span><span class="p">,</span>
					 <span class="n">ses</span><span class="p">,</span> <span class="n">nls_cp</span><span class="p">);</span>
	<span class="p">}</span>

<span class="nl">ssetup_exit:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">spnego_key</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">key_revoke</span><span class="p">(</span><span class="n">spnego_key</span><span class="p">);</span>
		<span class="n">key_put</span><span class="p">(</span><span class="n">spnego_key</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">str_area</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">ntlmsspblob</span><span class="p">);</span>
	<span class="n">ntlmsspblob</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">resp_buf_type</span> <span class="o">==</span> <span class="n">CIFS_SMALL_BUFFER</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cFYI</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;ssetup freeing small buf %p&quot;</span><span class="p">,</span> <span class="n">iov</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">iov_base</span><span class="p">);</span>
		<span class="n">cifs_small_buf_release</span><span class="p">(</span><span class="n">iov</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">iov_base</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">resp_buf_type</span> <span class="o">==</span> <span class="n">CIFS_LARGE_BUFFER</span><span class="p">)</span>
		<span class="n">cifs_buf_release</span><span class="p">(</span><span class="n">iov</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">iov_base</span><span class="p">);</span>

	<span class="cm">/* if ntlmssp, and negotiate succeeded, proceed to authenticate phase */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">phase</span> <span class="o">==</span> <span class="n">NtLmChallenge</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">ssetup_ntlmssp_authenticate</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
