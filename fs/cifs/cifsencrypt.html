<!DOCTYPE html>
<html><head><title>joekychen/linux » fs › cifs › cifsencrypt.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>cifsencrypt.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> *   fs/cifs/cifsencrypt.c</span>
<span class="cm"> *</span>
<span class="cm"> *   Copyright (C) International Business Machines  Corp., 2005,2006</span>
<span class="cm"> *   Author(s): Steve French (sfrench@us.ibm.com)</span>
<span class="cm"> *</span>
<span class="cm"> *   This library is free software; you can redistribute it and/or modify</span>
<span class="cm"> *   it under the terms of the GNU Lesser General Public License as published</span>
<span class="cm"> *   by the Free Software Foundation; either version 2.1 of the License, or</span>
<span class="cm"> *   (at your option) any later version.</span>
<span class="cm"> *</span>
<span class="cm"> *   This library is distributed in the hope that it will be useful,</span>
<span class="cm"> *   but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> *   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See</span>
<span class="cm"> *   the GNU Lesser General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> *   You should have received a copy of the GNU Lesser General Public License</span>
<span class="cm"> *   along with this library; if not, write to the Free Software</span>
<span class="cm"> *   Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA 02111-1307 USA</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/fs.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &quot;cifspdu.h&quot;</span>
<span class="cp">#include &quot;cifsglob.h&quot;</span>
<span class="cp">#include &quot;cifs_debug.h&quot;</span>
<span class="cp">#include &quot;cifs_unicode.h&quot;</span>
<span class="cp">#include &quot;cifsproto.h&quot;</span>
<span class="cp">#include &quot;ntlmssp.h&quot;</span>
<span class="cp">#include &lt;linux/ctype.h&gt;</span>
<span class="cp">#include &lt;linux/random.h&gt;</span>

<span class="cm">/*</span>
<span class="cm"> * Calculate and return the CIFS signature based on the mac key and SMB PDU.</span>
<span class="cm"> * The 16 byte signature must be allocated by the caller. Note we only use the</span>
<span class="cm"> * 1st eight bytes and that the smb header signature field on input contains</span>
<span class="cm"> * the sequence number before this function is called. Also, this function</span>
<span class="cm"> * should be called with the server-&gt;srv_mutex held.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">cifs_calc_signature</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">kvec</span> <span class="o">*</span><span class="n">iov</span><span class="p">,</span> <span class="kt">int</span> <span class="n">n_vec</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">TCP_Server_Info</span> <span class="o">*</span><span class="n">server</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">signature</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">iov</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span> <span class="n">signature</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span> <span class="n">server</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">secmech</span><span class="p">.</span><span class="n">sdescmd5</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cERROR</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;%s: Can&#39;t generate signature</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">crypto_shash_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">secmech</span><span class="p">.</span><span class="n">sdescmd5</span><span class="o">-&gt;</span><span class="n">shash</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cERROR</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;%s: Could not init md5</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">crypto_shash_update</span><span class="p">(</span><span class="o">&amp;</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">secmech</span><span class="p">.</span><span class="n">sdescmd5</span><span class="o">-&gt;</span><span class="n">shash</span><span class="p">,</span>
		<span class="n">server</span><span class="o">-&gt;</span><span class="n">session_key</span><span class="p">.</span><span class="n">response</span><span class="p">,</span> <span class="n">server</span><span class="o">-&gt;</span><span class="n">session_key</span><span class="p">.</span><span class="n">len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cERROR</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;%s: Could not update with response</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">n_vec</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">iov</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">iov_len</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">iov</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">iov_base</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">cERROR</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;null iovec entry&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* The first entry includes a length field (which does not get</span>
<span class="cm">		   signed that occupies the first 4 bytes before the header */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">iov</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">iov_len</span> <span class="o">&lt;=</span> <span class="mi">8</span><span class="p">)</span> <span class="cm">/* cmd field at offset 9 */</span>
				<span class="k">break</span><span class="p">;</span> <span class="cm">/* nothing to sign or corrupt header */</span>
			<span class="n">rc</span> <span class="o">=</span>
			<span class="n">crypto_shash_update</span><span class="p">(</span><span class="o">&amp;</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">secmech</span><span class="p">.</span><span class="n">sdescmd5</span><span class="o">-&gt;</span><span class="n">shash</span><span class="p">,</span>
				<span class="n">iov</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">iov_base</span> <span class="o">+</span> <span class="mi">4</span><span class="p">,</span> <span class="n">iov</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">iov_len</span> <span class="o">-</span> <span class="mi">4</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">rc</span> <span class="o">=</span>
			<span class="n">crypto_shash_update</span><span class="p">(</span><span class="o">&amp;</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">secmech</span><span class="p">.</span><span class="n">sdescmd5</span><span class="o">-&gt;</span><span class="n">shash</span><span class="p">,</span>
				<span class="n">iov</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">iov_base</span><span class="p">,</span> <span class="n">iov</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">iov_len</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">cERROR</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;%s: Could not update with payload</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
							<span class="n">__func__</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">crypto_shash_final</span><span class="p">(</span><span class="o">&amp;</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">secmech</span><span class="p">.</span><span class="n">sdescmd5</span><span class="o">-&gt;</span><span class="n">shash</span><span class="p">,</span> <span class="n">signature</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="n">cERROR</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;%s: Could not generate md5 hash</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* must be called with server-&gt;srv_mutex held */</span>
<span class="kt">int</span> <span class="nf">cifs_sign_smb2</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvec</span> <span class="o">*</span><span class="n">iov</span><span class="p">,</span> <span class="kt">int</span> <span class="n">n_vec</span><span class="p">,</span> <span class="k">struct</span> <span class="n">TCP_Server_Info</span> <span class="o">*</span><span class="n">server</span><span class="p">,</span>
		   <span class="n">__u32</span> <span class="o">*</span><span class="n">pexpected_response_sequence_number</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">smb_signature</span><span class="p">[</span><span class="mi">20</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">smb_hdr</span> <span class="o">*</span><span class="n">cifs_pdu</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">smb_hdr</span> <span class="o">*</span><span class="p">)</span><span class="n">iov</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">iov_base</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">cifs_pdu</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">server</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">cifs_pdu</span><span class="o">-&gt;</span><span class="n">Flags2</span> <span class="o">&amp;</span> <span class="n">SMBFLG2_SECURITY_SIGNATURE</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">server</span><span class="o">-&gt;</span><span class="n">tcpStatus</span> <span class="o">==</span> <span class="n">CifsNeedNegotiate</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">session_estab</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">cifs_pdu</span><span class="o">-&gt;</span><span class="n">Signature</span><span class="p">.</span><span class="n">SecuritySignature</span><span class="p">,</span> <span class="s">&quot;BSRSPYL&quot;</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">cifs_pdu</span><span class="o">-&gt;</span><span class="n">Signature</span><span class="p">.</span><span class="n">Sequence</span><span class="p">.</span><span class="n">SequenceNumber</span> <span class="o">=</span>
				<span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">sequence_number</span><span class="p">);</span>
	<span class="n">cifs_pdu</span><span class="o">-&gt;</span><span class="n">Signature</span><span class="p">.</span><span class="n">Sequence</span><span class="p">.</span><span class="n">Reserved</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="o">*</span><span class="n">pexpected_response_sequence_number</span> <span class="o">=</span> <span class="n">server</span><span class="o">-&gt;</span><span class="n">sequence_number</span><span class="o">++</span><span class="p">;</span>
	<span class="n">server</span><span class="o">-&gt;</span><span class="n">sequence_number</span><span class="o">++</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">cifs_calc_signature</span><span class="p">(</span><span class="n">iov</span><span class="p">,</span> <span class="n">n_vec</span><span class="p">,</span> <span class="n">server</span><span class="p">,</span> <span class="n">smb_signature</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">cifs_pdu</span><span class="o">-&gt;</span><span class="n">Signature</span><span class="p">.</span><span class="n">SecuritySignature</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">cifs_pdu</span><span class="o">-&gt;</span><span class="n">Signature</span><span class="p">.</span><span class="n">SecuritySignature</span><span class="p">,</span> <span class="n">smb_signature</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* must be called with server-&gt;srv_mutex held */</span>
<span class="kt">int</span> <span class="nf">cifs_sign_smb</span><span class="p">(</span><span class="k">struct</span> <span class="n">smb_hdr</span> <span class="o">*</span><span class="n">cifs_pdu</span><span class="p">,</span> <span class="k">struct</span> <span class="n">TCP_Server_Info</span> <span class="o">*</span><span class="n">server</span><span class="p">,</span>
		  <span class="n">__u32</span> <span class="o">*</span><span class="n">pexpected_response_sequence_number</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">kvec</span> <span class="n">iov</span><span class="p">;</span>

	<span class="n">iov</span><span class="p">.</span><span class="n">iov_base</span> <span class="o">=</span> <span class="n">cifs_pdu</span><span class="p">;</span>
	<span class="n">iov</span><span class="p">.</span><span class="n">iov_len</span> <span class="o">=</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">cifs_pdu</span><span class="o">-&gt;</span><span class="n">smb_buf_length</span><span class="p">)</span> <span class="o">+</span> <span class="mi">4</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">cifs_sign_smb2</span><span class="p">(</span><span class="o">&amp;</span><span class="n">iov</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">server</span><span class="p">,</span>
			      <span class="n">pexpected_response_sequence_number</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">cifs_verify_signature</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvec</span> <span class="o">*</span><span class="n">iov</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">nr_iov</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">TCP_Server_Info</span> <span class="o">*</span><span class="n">server</span><span class="p">,</span>
			  <span class="n">__u32</span> <span class="n">expected_sequence_number</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">server_response_sig</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>
	<span class="kt">char</span> <span class="n">what_we_think_sig_should_be</span><span class="p">[</span><span class="mi">20</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">smb_hdr</span> <span class="o">*</span><span class="n">cifs_pdu</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">smb_hdr</span> <span class="o">*</span><span class="p">)</span><span class="n">iov</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">iov_base</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cifs_pdu</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span> <span class="n">server</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">session_estab</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cifs_pdu</span><span class="o">-&gt;</span><span class="n">Command</span> <span class="o">==</span> <span class="n">SMB_COM_LOCKING_ANDX</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">smb_com_lock_req</span> <span class="o">*</span><span class="n">pSMB</span> <span class="o">=</span>
			<span class="p">(</span><span class="k">struct</span> <span class="n">smb_com_lock_req</span> <span class="o">*</span><span class="p">)</span><span class="n">cifs_pdu</span><span class="p">;</span>
	    <span class="k">if</span> <span class="p">(</span><span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">LockType</span> <span class="o">&amp;</span> <span class="n">LOCKING_ANDX_OPLOCK_RELEASE</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* BB what if signatures are supposed to be on for session but</span>
<span class="cm">	   server does not send one? BB */</span>

	<span class="cm">/* Do not need to verify session setups with signature &quot;BSRSPYL &quot;  */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">memcmp</span><span class="p">(</span><span class="n">cifs_pdu</span><span class="o">-&gt;</span><span class="n">Signature</span><span class="p">.</span><span class="n">SecuritySignature</span><span class="p">,</span> <span class="s">&quot;BSRSPYL &quot;</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">cFYI</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;dummy signature received for smb command 0x%x&quot;</span><span class="p">,</span>
			<span class="n">cifs_pdu</span><span class="o">-&gt;</span><span class="n">Command</span><span class="p">);</span>

	<span class="cm">/* save off the origiginal signature so we can modify the smb and check</span>
<span class="cm">		its signature against what the server sent */</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">server_response_sig</span><span class="p">,</span> <span class="n">cifs_pdu</span><span class="o">-&gt;</span><span class="n">Signature</span><span class="p">.</span><span class="n">SecuritySignature</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>

	<span class="n">cifs_pdu</span><span class="o">-&gt;</span><span class="n">Signature</span><span class="p">.</span><span class="n">Sequence</span><span class="p">.</span><span class="n">SequenceNumber</span> <span class="o">=</span>
					<span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">expected_sequence_number</span><span class="p">);</span>
	<span class="n">cifs_pdu</span><span class="o">-&gt;</span><span class="n">Signature</span><span class="p">.</span><span class="n">Sequence</span><span class="p">.</span><span class="n">Reserved</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">srv_mutex</span><span class="p">);</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">cifs_calc_signature</span><span class="p">(</span><span class="n">iov</span><span class="p">,</span> <span class="n">nr_iov</span><span class="p">,</span> <span class="n">server</span><span class="p">,</span>
				 <span class="n">what_we_think_sig_should_be</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">srv_mutex</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

<span class="cm">/*	cifs_dump_mem(&quot;what we think it should be: &quot;,</span>
<span class="cm">		      what_we_think_sig_should_be, 16); */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">memcmp</span><span class="p">(</span><span class="n">server_response_sig</span><span class="p">,</span> <span class="n">what_we_think_sig_should_be</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EACCES</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="p">}</span>

<span class="cm">/* first calculate 24 bytes ntlm response and then 16 byte session key */</span>
<span class="kt">int</span> <span class="nf">setup_ntlm_response</span><span class="p">(</span><span class="k">struct</span> <span class="n">cifs_ses</span> <span class="o">*</span><span class="n">ses</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">nls_table</span> <span class="o">*</span><span class="n">nls_cp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">temp_len</span> <span class="o">=</span> <span class="n">CIFS_SESS_KEY_SIZE</span> <span class="o">+</span> <span class="n">CIFS_AUTH_RESP_SIZE</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">temp_key</span><span class="p">[</span><span class="n">CIFS_SESS_KEY_SIZE</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ses</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">ses</span><span class="o">-&gt;</span><span class="n">auth_key</span><span class="p">.</span><span class="n">response</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">temp_len</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ses</span><span class="o">-&gt;</span><span class="n">auth_key</span><span class="p">.</span><span class="n">response</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cERROR</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;NTLM can&#39;t allocate (%u bytes) memory&quot;</span><span class="p">,</span> <span class="n">temp_len</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ses</span><span class="o">-&gt;</span><span class="n">auth_key</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="n">temp_len</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">SMBNTencrypt</span><span class="p">(</span><span class="n">ses</span><span class="o">-&gt;</span><span class="n">password</span><span class="p">,</span> <span class="n">ses</span><span class="o">-&gt;</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">cryptkey</span><span class="p">,</span>
			<span class="n">ses</span><span class="o">-&gt;</span><span class="n">auth_key</span><span class="p">.</span><span class="n">response</span> <span class="o">+</span> <span class="n">CIFS_SESS_KEY_SIZE</span><span class="p">,</span> <span class="n">nls_cp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cFYI</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;%s Can&#39;t generate NTLM response, error: %d&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">E_md4hash</span><span class="p">(</span><span class="n">ses</span><span class="o">-&gt;</span><span class="n">password</span><span class="p">,</span> <span class="n">temp_key</span><span class="p">,</span> <span class="n">nls_cp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cFYI</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;%s Can&#39;t generate NT hash, error: %d&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">mdfour</span><span class="p">(</span><span class="n">ses</span><span class="o">-&gt;</span><span class="n">auth_key</span><span class="p">.</span><span class="n">response</span><span class="p">,</span> <span class="n">temp_key</span><span class="p">,</span> <span class="n">CIFS_SESS_KEY_SIZE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="n">cFYI</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;%s Can&#39;t generate NTLM session key, error: %d&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_CIFS_WEAK_PW_HASH</span>
<span class="kt">int</span> <span class="nf">calc_lanman_hash</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">password</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">cryptkey</span><span class="p">,</span> <span class="n">bool</span> <span class="n">encrypt</span><span class="p">,</span>
			<span class="kt">char</span> <span class="o">*</span><span class="n">lnm_session_key</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">password_with_pad</span><span class="p">[</span><span class="n">CIFS_ENCPWD_SIZE</span><span class="p">];</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">password_with_pad</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">CIFS_ENCPWD_SIZE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">password</span><span class="p">)</span>
		<span class="n">strncpy</span><span class="p">(</span><span class="n">password_with_pad</span><span class="p">,</span> <span class="n">password</span><span class="p">,</span> <span class="n">CIFS_ENCPWD_SIZE</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">encrypt</span> <span class="o">&amp;&amp;</span> <span class="n">global_secflags</span> <span class="o">&amp;</span> <span class="n">CIFSSEC_MAY_PLNTXT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">lnm_session_key</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">CIFS_SESS_KEY_SIZE</span><span class="p">);</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">lnm_session_key</span><span class="p">,</span> <span class="n">password_with_pad</span><span class="p">,</span>
			<span class="n">CIFS_ENCPWD_SIZE</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* calculate old style session key */</span>
	<span class="cm">/* calling toupper is less broken than repeatedly</span>
<span class="cm">	calling nls_toupper would be since that will never</span>
<span class="cm">	work for UTF8, but neither handles multibyte code pages</span>
<span class="cm">	but the only alternative would be converting to UCS-16 (Unicode)</span>
<span class="cm">	(using a routine something like UniStrupr) then</span>
<span class="cm">	uppercasing and then converting back from Unicode - which</span>
<span class="cm">	would only worth doing it if we knew it were utf8. Basically</span>
<span class="cm">	utf8 and other multibyte codepages each need their own strupper</span>
<span class="cm">	function since a byte at a time will ont work. */</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">CIFS_ENCPWD_SIZE</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">password_with_pad</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">toupper</span><span class="p">(</span><span class="n">password_with_pad</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">SMBencrypt</span><span class="p">(</span><span class="n">password_with_pad</span><span class="p">,</span> <span class="n">cryptkey</span><span class="p">,</span> <span class="n">lnm_session_key</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* CIFS_WEAK_PW_HASH */</span><span class="cp"></span>

<span class="cm">/* Build a proper attribute value/target info pairs blob.</span>
<span class="cm"> * Fill in netbios and dns domain name and workstation name</span>
<span class="cm"> * and client time (total five av pairs and + one end of fields indicator.</span>
<span class="cm"> * Allocate domain name which gets freed when session struct is deallocated.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">build_avpair_blob</span><span class="p">(</span><span class="k">struct</span> <span class="n">cifs_ses</span> <span class="o">*</span><span class="n">ses</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">nls_table</span> <span class="o">*</span><span class="n">nls_cp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">dlen</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">size</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ntlmssp2_name</span><span class="p">);</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">defdmname</span> <span class="o">=</span> <span class="s">&quot;WORKGROUP&quot;</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">blobptr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ntlmssp2_name</span> <span class="o">*</span><span class="n">attrptr</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ses</span><span class="o">-&gt;</span><span class="n">domainName</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ses</span><span class="o">-&gt;</span><span class="n">domainName</span> <span class="o">=</span> <span class="n">kstrdup</span><span class="p">(</span><span class="n">defdmname</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ses</span><span class="o">-&gt;</span><span class="n">domainName</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dlen</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">ses</span><span class="o">-&gt;</span><span class="n">domainName</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * The length of this blob is two times the size of a</span>
<span class="cm">	 * structure (av pair) which holds name/size</span>
<span class="cm">	 * ( for NTLMSSP_AV_NB_DOMAIN_NAME followed by NTLMSSP_AV_EOL ) +</span>
<span class="cm">	 * unicode length of a netbios domain name</span>
<span class="cm">	 */</span>
	<span class="n">ses</span><span class="o">-&gt;</span><span class="n">auth_key</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="n">size</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">dlen</span><span class="p">;</span>
	<span class="n">ses</span><span class="o">-&gt;</span><span class="n">auth_key</span><span class="p">.</span><span class="n">response</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="n">ses</span><span class="o">-&gt;</span><span class="n">auth_key</span><span class="p">.</span><span class="n">len</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ses</span><span class="o">-&gt;</span><span class="n">auth_key</span><span class="p">.</span><span class="n">response</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ses</span><span class="o">-&gt;</span><span class="n">auth_key</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">cERROR</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;Challenge target info allocation failure&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">blobptr</span> <span class="o">=</span> <span class="n">ses</span><span class="o">-&gt;</span><span class="n">auth_key</span><span class="p">.</span><span class="n">response</span><span class="p">;</span>
	<span class="n">attrptr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ntlmssp2_name</span> <span class="o">*</span><span class="p">)</span> <span class="n">blobptr</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * As defined in MS-NTLM 3.3.2, just this av pair field</span>
<span class="cm">	 * is sufficient as part of the temp</span>
<span class="cm">	 */</span>
	<span class="n">attrptr</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">NTLMSSP_AV_NB_DOMAIN_NAME</span><span class="p">);</span>
	<span class="n">attrptr</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">dlen</span><span class="p">);</span>
	<span class="n">blobptr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">attrptr</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ntlmssp2_name</span><span class="p">);</span>
	<span class="n">cifs_strtoUTF16</span><span class="p">((</span><span class="n">__le16</span> <span class="o">*</span><span class="p">)</span><span class="n">blobptr</span><span class="p">,</span> <span class="n">ses</span><span class="o">-&gt;</span><span class="n">domainName</span><span class="p">,</span> <span class="n">dlen</span><span class="p">,</span> <span class="n">nls_cp</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Server has provided av pairs/target info in the type 2 challenge</span>
<span class="cm"> * packet and we have plucked it and stored within smb session.</span>
<span class="cm"> * We parse that blob here to find netbios domain name to be used</span>
<span class="cm"> * as part of ntlmv2 authentication (in Target String), if not already</span>
<span class="cm"> * specified on the command line.</span>
<span class="cm"> * If this function returns without any error but without fetching</span>
<span class="cm"> * domain name, authentication may fail against some server but</span>
<span class="cm"> * may not fail against other (those who are not very particular</span>
<span class="cm"> * about target string i.e. for some, just user name might suffice.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">find_domain_name</span><span class="p">(</span><span class="k">struct</span> <span class="n">cifs_ses</span> <span class="o">*</span><span class="n">ses</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">nls_table</span> <span class="o">*</span><span class="n">nls_cp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">attrsize</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">type</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">onesize</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ntlmssp2_name</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">blobptr</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">blobend</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ntlmssp2_name</span> <span class="o">*</span><span class="n">attrptr</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ses</span><span class="o">-&gt;</span><span class="n">auth_key</span><span class="p">.</span><span class="n">len</span> <span class="o">||</span> <span class="o">!</span><span class="n">ses</span><span class="o">-&gt;</span><span class="n">auth_key</span><span class="p">.</span><span class="n">response</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">blobptr</span> <span class="o">=</span> <span class="n">ses</span><span class="o">-&gt;</span><span class="n">auth_key</span><span class="p">.</span><span class="n">response</span><span class="p">;</span>
	<span class="n">blobend</span> <span class="o">=</span> <span class="n">blobptr</span> <span class="o">+</span> <span class="n">ses</span><span class="o">-&gt;</span><span class="n">auth_key</span><span class="p">.</span><span class="n">len</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">blobptr</span> <span class="o">+</span> <span class="n">onesize</span> <span class="o">&lt;</span> <span class="n">blobend</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">attrptr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ntlmssp2_name</span> <span class="o">*</span><span class="p">)</span> <span class="n">blobptr</span><span class="p">;</span>
		<span class="n">type</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">attrptr</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="n">NTLMSSP_AV_EOL</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">blobptr</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span> <span class="cm">/* advance attr type */</span>
		<span class="n">attrsize</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">attrptr</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">);</span>
		<span class="n">blobptr</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span> <span class="cm">/* advance attr size */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">blobptr</span> <span class="o">+</span> <span class="n">attrsize</span> <span class="o">&gt;</span> <span class="n">blobend</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="n">NTLMSSP_AV_NB_DOMAIN_NAME</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">attrsize</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ses</span><span class="o">-&gt;</span><span class="n">domainName</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ses</span><span class="o">-&gt;</span><span class="n">domainName</span> <span class="o">=</span>
					<span class="n">kmalloc</span><span class="p">(</span><span class="n">attrsize</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ses</span><span class="o">-&gt;</span><span class="n">domainName</span><span class="p">)</span>
						<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
				<span class="n">cifs_from_utf16</span><span class="p">(</span><span class="n">ses</span><span class="o">-&gt;</span><span class="n">domainName</span><span class="p">,</span>
					<span class="p">(</span><span class="n">__le16</span> <span class="o">*</span><span class="p">)</span><span class="n">blobptr</span><span class="p">,</span> <span class="n">attrsize</span><span class="p">,</span> <span class="n">attrsize</span><span class="p">,</span>
					<span class="n">nls_cp</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">blobptr</span> <span class="o">+=</span> <span class="n">attrsize</span><span class="p">;</span> <span class="cm">/* advance attr  value */</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">calc_ntlmv2_hash</span><span class="p">(</span><span class="k">struct</span> <span class="n">cifs_ses</span> <span class="o">*</span><span class="n">ses</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">ntlmv2_hash</span><span class="p">,</span>
			    <span class="k">const</span> <span class="k">struct</span> <span class="n">nls_table</span> <span class="o">*</span><span class="n">nls_cp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">len</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">nt_hash</span><span class="p">[</span><span class="n">CIFS_NTHASH_SIZE</span><span class="p">];</span>
	<span class="kt">wchar_t</span> <span class="o">*</span><span class="n">user</span><span class="p">;</span>
	<span class="kt">wchar_t</span> <span class="o">*</span><span class="n">domain</span><span class="p">;</span>
	<span class="kt">wchar_t</span> <span class="o">*</span><span class="n">server</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ses</span><span class="o">-&gt;</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">secmech</span><span class="p">.</span><span class="n">sdeschmacmd5</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cERROR</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;calc_ntlmv2_hash: can&#39;t generate ntlmv2 hash</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* calculate md4 hash of password */</span>
	<span class="n">E_md4hash</span><span class="p">(</span><span class="n">ses</span><span class="o">-&gt;</span><span class="n">password</span><span class="p">,</span> <span class="n">nt_hash</span><span class="p">,</span> <span class="n">nls_cp</span><span class="p">);</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">crypto_shash_setkey</span><span class="p">(</span><span class="n">ses</span><span class="o">-&gt;</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">secmech</span><span class="p">.</span><span class="n">hmacmd5</span><span class="p">,</span> <span class="n">nt_hash</span><span class="p">,</span>
				<span class="n">CIFS_NTHASH_SIZE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cERROR</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;%s: Could not set NT Hash as a key&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">crypto_shash_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ses</span><span class="o">-&gt;</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">secmech</span><span class="p">.</span><span class="n">sdeschmacmd5</span><span class="o">-&gt;</span><span class="n">shash</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cERROR</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;calc_ntlmv2_hash: could not init hmacmd5</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* convert ses-&gt;user_name to unicode and uppercase */</span>
	<span class="n">len</span> <span class="o">=</span> <span class="n">ses</span><span class="o">-&gt;</span><span class="n">user_name</span> <span class="o">?</span> <span class="n">strlen</span><span class="p">(</span><span class="n">ses</span><span class="o">-&gt;</span><span class="n">user_name</span><span class="p">)</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">user</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">len</span> <span class="o">*</span> <span class="mi">2</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">user</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cERROR</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;calc_ntlmv2_hash: user mem alloc failure</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">len</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">len</span> <span class="o">=</span> <span class="n">cifs_strtoUTF16</span><span class="p">((</span><span class="n">__le16</span> <span class="o">*</span><span class="p">)</span><span class="n">user</span><span class="p">,</span> <span class="n">ses</span><span class="o">-&gt;</span><span class="n">user_name</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">nls_cp</span><span class="p">);</span>
		<span class="n">UniStrupr</span><span class="p">(</span><span class="n">user</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="sc">&#39;\0&#39;</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">crypto_shash_update</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ses</span><span class="o">-&gt;</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">secmech</span><span class="p">.</span><span class="n">sdeschmacmd5</span><span class="o">-&gt;</span><span class="n">shash</span><span class="p">,</span>
				<span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">user</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">len</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">user</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cERROR</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;%s: Could not update with user</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* convert ses-&gt;domainName to unicode and uppercase */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ses</span><span class="o">-&gt;</span><span class="n">domainName</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">len</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">ses</span><span class="o">-&gt;</span><span class="n">domainName</span><span class="p">);</span>

		<span class="n">domain</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">len</span> <span class="o">*</span> <span class="mi">2</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">domain</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">cERROR</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;calc_ntlmv2_hash: domain mem alloc failure&quot;</span><span class="p">);</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
			<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">len</span> <span class="o">=</span> <span class="n">cifs_strtoUTF16</span><span class="p">((</span><span class="n">__le16</span> <span class="o">*</span><span class="p">)</span><span class="n">domain</span><span class="p">,</span> <span class="n">ses</span><span class="o">-&gt;</span><span class="n">domainName</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span>
				      <span class="n">nls_cp</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span>
		<span class="n">crypto_shash_update</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ses</span><span class="o">-&gt;</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">secmech</span><span class="p">.</span><span class="n">sdeschmacmd5</span><span class="o">-&gt;</span><span class="n">shash</span><span class="p">,</span>
					<span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">domain</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">len</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">domain</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">cERROR</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;%s: Could not update with domain</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
								<span class="n">__func__</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ses</span><span class="o">-&gt;</span><span class="n">serverName</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">len</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">ses</span><span class="o">-&gt;</span><span class="n">serverName</span><span class="p">);</span>

		<span class="n">server</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">len</span> <span class="o">*</span> <span class="mi">2</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">server</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">cERROR</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;calc_ntlmv2_hash: server mem alloc failure&quot;</span><span class="p">);</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
			<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">len</span> <span class="o">=</span> <span class="n">cifs_strtoUTF16</span><span class="p">((</span><span class="n">__le16</span> <span class="o">*</span><span class="p">)</span><span class="n">server</span><span class="p">,</span> <span class="n">ses</span><span class="o">-&gt;</span><span class="n">serverName</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span>
					<span class="n">nls_cp</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span>
		<span class="n">crypto_shash_update</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ses</span><span class="o">-&gt;</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">secmech</span><span class="p">.</span><span class="n">sdeschmacmd5</span><span class="o">-&gt;</span><span class="n">shash</span><span class="p">,</span>
					<span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">server</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">len</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">server</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">cERROR</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;%s: Could not update with server</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
								<span class="n">__func__</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">crypto_shash_final</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ses</span><span class="o">-&gt;</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">secmech</span><span class="p">.</span><span class="n">sdeschmacmd5</span><span class="o">-&gt;</span><span class="n">shash</span><span class="p">,</span>
					<span class="n">ntlmv2_hash</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="n">cERROR</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;%s: Could not generate md5 hash</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">CalcNTLMv2_response</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">cifs_ses</span> <span class="o">*</span><span class="n">ses</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">ntlmv2_hash</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">offset</span> <span class="o">=</span> <span class="n">CIFS_SESS_KEY_SIZE</span> <span class="o">+</span> <span class="mi">8</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ses</span><span class="o">-&gt;</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">secmech</span><span class="p">.</span><span class="n">sdeschmacmd5</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cERROR</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;calc_ntlmv2_hash: can&#39;t generate ntlmv2 hash</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">crypto_shash_setkey</span><span class="p">(</span><span class="n">ses</span><span class="o">-&gt;</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">secmech</span><span class="p">.</span><span class="n">hmacmd5</span><span class="p">,</span>
				<span class="n">ntlmv2_hash</span><span class="p">,</span> <span class="n">CIFS_HMAC_MD5_HASH_SIZE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cERROR</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;%s: Could not set NTLMV2 Hash as a key&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">crypto_shash_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ses</span><span class="o">-&gt;</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">secmech</span><span class="p">.</span><span class="n">sdeschmacmd5</span><span class="o">-&gt;</span><span class="n">shash</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cERROR</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;CalcNTLMv2_response: could not init hmacmd5&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ses</span><span class="o">-&gt;</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">secType</span> <span class="o">==</span> <span class="n">RawNTLMSSP</span><span class="p">)</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">ses</span><span class="o">-&gt;</span><span class="n">auth_key</span><span class="p">.</span><span class="n">response</span> <span class="o">+</span> <span class="n">offset</span><span class="p">,</span>
			<span class="n">ses</span><span class="o">-&gt;</span><span class="n">ntlmssp</span><span class="o">-&gt;</span><span class="n">cryptkey</span><span class="p">,</span> <span class="n">CIFS_SERVER_CHALLENGE_SIZE</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">ses</span><span class="o">-&gt;</span><span class="n">auth_key</span><span class="p">.</span><span class="n">response</span> <span class="o">+</span> <span class="n">offset</span><span class="p">,</span>
			<span class="n">ses</span><span class="o">-&gt;</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">cryptkey</span><span class="p">,</span> <span class="n">CIFS_SERVER_CHALLENGE_SIZE</span><span class="p">);</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">crypto_shash_update</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ses</span><span class="o">-&gt;</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">secmech</span><span class="p">.</span><span class="n">sdeschmacmd5</span><span class="o">-&gt;</span><span class="n">shash</span><span class="p">,</span>
		<span class="n">ses</span><span class="o">-&gt;</span><span class="n">auth_key</span><span class="p">.</span><span class="n">response</span> <span class="o">+</span> <span class="n">offset</span><span class="p">,</span> <span class="n">ses</span><span class="o">-&gt;</span><span class="n">auth_key</span><span class="p">.</span><span class="n">len</span> <span class="o">-</span> <span class="n">offset</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cERROR</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;%s: Could not update with response</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">crypto_shash_final</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ses</span><span class="o">-&gt;</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">secmech</span><span class="p">.</span><span class="n">sdeschmacmd5</span><span class="o">-&gt;</span><span class="n">shash</span><span class="p">,</span>
		<span class="n">ses</span><span class="o">-&gt;</span><span class="n">auth_key</span><span class="p">.</span><span class="n">response</span> <span class="o">+</span> <span class="n">CIFS_SESS_KEY_SIZE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="n">cERROR</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;%s: Could not generate md5 hash</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>


<span class="kt">int</span>
<span class="nf">setup_ntlmv2_rsp</span><span class="p">(</span><span class="k">struct</span> <span class="n">cifs_ses</span> <span class="o">*</span><span class="n">ses</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">nls_table</span> <span class="o">*</span><span class="n">nls_cp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">baselen</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">tilen</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ntlmv2_resp</span> <span class="o">*</span><span class="n">buf</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">ntlmv2_hash</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">tiblob</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span> <span class="cm">/* target info blob */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ses</span><span class="o">-&gt;</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">secType</span> <span class="o">==</span> <span class="n">RawNTLMSSP</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ses</span><span class="o">-&gt;</span><span class="n">domainName</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="n">find_domain_name</span><span class="p">(</span><span class="n">ses</span><span class="p">,</span> <span class="n">nls_cp</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">cERROR</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;error %d finding domain name&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">setup_ntlmv2_rsp_ret</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">build_avpair_blob</span><span class="p">(</span><span class="n">ses</span><span class="p">,</span> <span class="n">nls_cp</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">cERROR</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;error %d building av pair blob&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">setup_ntlmv2_rsp_ret</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">baselen</span> <span class="o">=</span> <span class="n">CIFS_SESS_KEY_SIZE</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ntlmv2_resp</span><span class="p">);</span>
	<span class="n">tilen</span> <span class="o">=</span> <span class="n">ses</span><span class="o">-&gt;</span><span class="n">auth_key</span><span class="p">.</span><span class="n">len</span><span class="p">;</span>
	<span class="n">tiblob</span> <span class="o">=</span> <span class="n">ses</span><span class="o">-&gt;</span><span class="n">auth_key</span><span class="p">.</span><span class="n">response</span><span class="p">;</span>

	<span class="n">ses</span><span class="o">-&gt;</span><span class="n">auth_key</span><span class="p">.</span><span class="n">response</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">baselen</span> <span class="o">+</span> <span class="n">tilen</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ses</span><span class="o">-&gt;</span><span class="n">auth_key</span><span class="p">.</span><span class="n">response</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">ENOMEM</span><span class="p">;</span>
		<span class="n">ses</span><span class="o">-&gt;</span><span class="n">auth_key</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">cERROR</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;%s: Can&#39;t allocate auth blob&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">setup_ntlmv2_rsp_ret</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ses</span><span class="o">-&gt;</span><span class="n">auth_key</span><span class="p">.</span><span class="n">len</span> <span class="o">+=</span> <span class="n">baselen</span><span class="p">;</span>

	<span class="n">buf</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ntlmv2_resp</span> <span class="o">*</span><span class="p">)</span>
			<span class="p">(</span><span class="n">ses</span><span class="o">-&gt;</span><span class="n">auth_key</span><span class="p">.</span><span class="n">response</span> <span class="o">+</span> <span class="n">CIFS_SESS_KEY_SIZE</span><span class="p">);</span>
	<span class="n">buf</span><span class="o">-&gt;</span><span class="n">blob_signature</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="mh">0x00000101</span><span class="p">);</span>
	<span class="n">buf</span><span class="o">-&gt;</span><span class="n">reserved</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">buf</span><span class="o">-&gt;</span><span class="n">time</span> <span class="o">=</span> <span class="n">cpu_to_le64</span><span class="p">(</span><span class="n">cifs_UnixTimeToNT</span><span class="p">(</span><span class="n">CURRENT_TIME</span><span class="p">));</span>
	<span class="n">get_random_bytes</span><span class="p">(</span><span class="o">&amp;</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">client_chal</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">client_chal</span><span class="p">));</span>
	<span class="n">buf</span><span class="o">-&gt;</span><span class="n">reserved2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">ses</span><span class="o">-&gt;</span><span class="n">auth_key</span><span class="p">.</span><span class="n">response</span> <span class="o">+</span> <span class="n">baselen</span><span class="p">,</span> <span class="n">tiblob</span><span class="p">,</span> <span class="n">tilen</span><span class="p">);</span>

	<span class="cm">/* calculate ntlmv2_hash */</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">calc_ntlmv2_hash</span><span class="p">(</span><span class="n">ses</span><span class="p">,</span> <span class="n">ntlmv2_hash</span><span class="p">,</span> <span class="n">nls_cp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cERROR</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;could not get v2 hash rc %d&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">setup_ntlmv2_rsp_ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* calculate first part of the client response (CR1) */</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">CalcNTLMv2_response</span><span class="p">(</span><span class="n">ses</span><span class="p">,</span> <span class="n">ntlmv2_hash</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cERROR</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;Could not calculate CR1  rc: %d&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">setup_ntlmv2_rsp_ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* now calculate the session key for NTLMv2 */</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">crypto_shash_setkey</span><span class="p">(</span><span class="n">ses</span><span class="o">-&gt;</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">secmech</span><span class="p">.</span><span class="n">hmacmd5</span><span class="p">,</span>
		<span class="n">ntlmv2_hash</span><span class="p">,</span> <span class="n">CIFS_HMAC_MD5_HASH_SIZE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cERROR</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;%s: Could not set NTLMV2 Hash as a key&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">setup_ntlmv2_rsp_ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">crypto_shash_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ses</span><span class="o">-&gt;</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">secmech</span><span class="p">.</span><span class="n">sdeschmacmd5</span><span class="o">-&gt;</span><span class="n">shash</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cERROR</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;%s: Could not init hmacmd5</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">setup_ntlmv2_rsp_ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">crypto_shash_update</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ses</span><span class="o">-&gt;</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">secmech</span><span class="p">.</span><span class="n">sdeschmacmd5</span><span class="o">-&gt;</span><span class="n">shash</span><span class="p">,</span>
		<span class="n">ses</span><span class="o">-&gt;</span><span class="n">auth_key</span><span class="p">.</span><span class="n">response</span> <span class="o">+</span> <span class="n">CIFS_SESS_KEY_SIZE</span><span class="p">,</span>
		<span class="n">CIFS_HMAC_MD5_HASH_SIZE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cERROR</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;%s: Could not update with response</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">setup_ntlmv2_rsp_ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">crypto_shash_final</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ses</span><span class="o">-&gt;</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">secmech</span><span class="p">.</span><span class="n">sdeschmacmd5</span><span class="o">-&gt;</span><span class="n">shash</span><span class="p">,</span>
		<span class="n">ses</span><span class="o">-&gt;</span><span class="n">auth_key</span><span class="p">.</span><span class="n">response</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="n">cERROR</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;%s: Could not generate md5 hash</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

<span class="nl">setup_ntlmv2_rsp_ret:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">tiblob</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="nf">calc_seckey</span><span class="p">(</span><span class="k">struct</span> <span class="n">cifs_ses</span> <span class="o">*</span><span class="n">ses</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">crypto_blkcipher</span> <span class="o">*</span><span class="n">tfm_arc4</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scatterlist</span> <span class="n">sgin</span><span class="p">,</span> <span class="n">sgout</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">blkcipher_desc</span> <span class="n">desc</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">sec_key</span><span class="p">[</span><span class="n">CIFS_SESS_KEY_SIZE</span><span class="p">];</span> <span class="cm">/* a nonce */</span>

	<span class="n">get_random_bytes</span><span class="p">(</span><span class="n">sec_key</span><span class="p">,</span> <span class="n">CIFS_SESS_KEY_SIZE</span><span class="p">);</span>

	<span class="n">tfm_arc4</span> <span class="o">=</span> <span class="n">crypto_alloc_blkcipher</span><span class="p">(</span><span class="s">&quot;ecb(arc4)&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">CRYPTO_ALG_ASYNC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">tfm_arc4</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">tfm_arc4</span><span class="p">);</span>
		<span class="n">cERROR</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;could not allocate crypto API arc4</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">desc</span><span class="p">.</span><span class="n">tfm</span> <span class="o">=</span> <span class="n">tfm_arc4</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">crypto_blkcipher_setkey</span><span class="p">(</span><span class="n">tfm_arc4</span><span class="p">,</span> <span class="n">ses</span><span class="o">-&gt;</span><span class="n">auth_key</span><span class="p">.</span><span class="n">response</span><span class="p">,</span>
					<span class="n">CIFS_SESS_KEY_SIZE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cERROR</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;%s: Could not set response as a key&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">sg_init_one</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sgin</span><span class="p">,</span> <span class="n">sec_key</span><span class="p">,</span> <span class="n">CIFS_SESS_KEY_SIZE</span><span class="p">);</span>
	<span class="n">sg_init_one</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sgout</span><span class="p">,</span> <span class="n">ses</span><span class="o">-&gt;</span><span class="n">ntlmssp</span><span class="o">-&gt;</span><span class="n">ciphertext</span><span class="p">,</span> <span class="n">CIFS_CPHTXT_SIZE</span><span class="p">);</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">crypto_blkcipher_encrypt</span><span class="p">(</span><span class="o">&amp;</span><span class="n">desc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sgout</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sgin</span><span class="p">,</span> <span class="n">CIFS_CPHTXT_SIZE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cERROR</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;could not encrypt session key rc: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
		<span class="n">crypto_free_blkcipher</span><span class="p">(</span><span class="n">tfm_arc4</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* make secondary_key/nonce as session key */</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">ses</span><span class="o">-&gt;</span><span class="n">auth_key</span><span class="p">.</span><span class="n">response</span><span class="p">,</span> <span class="n">sec_key</span><span class="p">,</span> <span class="n">CIFS_SESS_KEY_SIZE</span><span class="p">);</span>
	<span class="cm">/* and make len as that of session key only */</span>
	<span class="n">ses</span><span class="o">-&gt;</span><span class="n">auth_key</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="n">CIFS_SESS_KEY_SIZE</span><span class="p">;</span>

	<span class="n">crypto_free_blkcipher</span><span class="p">(</span><span class="n">tfm_arc4</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">cifs_crypto_shash_release</span><span class="p">(</span><span class="k">struct</span> <span class="n">TCP_Server_Info</span> <span class="o">*</span><span class="n">server</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">secmech</span><span class="p">.</span><span class="n">md5</span><span class="p">)</span>
		<span class="n">crypto_free_shash</span><span class="p">(</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">secmech</span><span class="p">.</span><span class="n">md5</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">secmech</span><span class="p">.</span><span class="n">hmacmd5</span><span class="p">)</span>
		<span class="n">crypto_free_shash</span><span class="p">(</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">secmech</span><span class="p">.</span><span class="n">hmacmd5</span><span class="p">);</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">secmech</span><span class="p">.</span><span class="n">sdeschmacmd5</span><span class="p">);</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">secmech</span><span class="p">.</span><span class="n">sdescmd5</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="nf">cifs_crypto_shash_allocate</span><span class="p">(</span><span class="k">struct</span> <span class="n">TCP_Server_Info</span> <span class="o">*</span><span class="n">server</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">size</span><span class="p">;</span>

	<span class="n">server</span><span class="o">-&gt;</span><span class="n">secmech</span><span class="p">.</span><span class="n">hmacmd5</span> <span class="o">=</span> <span class="n">crypto_alloc_shash</span><span class="p">(</span><span class="s">&quot;hmac(md5)&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">secmech</span><span class="p">.</span><span class="n">hmacmd5</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">cERROR</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;could not allocate crypto hmacmd5</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">secmech</span><span class="p">.</span><span class="n">hmacmd5</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">server</span><span class="o">-&gt;</span><span class="n">secmech</span><span class="p">.</span><span class="n">md5</span> <span class="o">=</span> <span class="n">crypto_alloc_shash</span><span class="p">(</span><span class="s">&quot;md5&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">secmech</span><span class="p">.</span><span class="n">md5</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">cERROR</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;could not allocate crypto md5</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">secmech</span><span class="p">.</span><span class="n">md5</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">crypto_allocate_md5_fail</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">shash_desc</span><span class="p">)</span> <span class="o">+</span>
			<span class="n">crypto_shash_descsize</span><span class="p">(</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">secmech</span><span class="p">.</span><span class="n">hmacmd5</span><span class="p">);</span>
	<span class="n">server</span><span class="o">-&gt;</span><span class="n">secmech</span><span class="p">.</span><span class="n">sdeschmacmd5</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">secmech</span><span class="p">.</span><span class="n">sdeschmacmd5</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cERROR</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;cifs_crypto_shash_allocate: can&#39;t alloc hmacmd5</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">crypto_allocate_hmacmd5_sdesc_fail</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">server</span><span class="o">-&gt;</span><span class="n">secmech</span><span class="p">.</span><span class="n">sdeschmacmd5</span><span class="o">-&gt;</span><span class="n">shash</span><span class="p">.</span><span class="n">tfm</span> <span class="o">=</span> <span class="n">server</span><span class="o">-&gt;</span><span class="n">secmech</span><span class="p">.</span><span class="n">hmacmd5</span><span class="p">;</span>
	<span class="n">server</span><span class="o">-&gt;</span><span class="n">secmech</span><span class="p">.</span><span class="n">sdeschmacmd5</span><span class="o">-&gt;</span><span class="n">shash</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">;</span>


	<span class="n">size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">shash_desc</span><span class="p">)</span> <span class="o">+</span>
			<span class="n">crypto_shash_descsize</span><span class="p">(</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">secmech</span><span class="p">.</span><span class="n">md5</span><span class="p">);</span>
	<span class="n">server</span><span class="o">-&gt;</span><span class="n">secmech</span><span class="p">.</span><span class="n">sdescmd5</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">secmech</span><span class="p">.</span><span class="n">sdescmd5</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cERROR</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;cifs_crypto_shash_allocate: can&#39;t alloc md5</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">crypto_allocate_md5_sdesc_fail</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">server</span><span class="o">-&gt;</span><span class="n">secmech</span><span class="p">.</span><span class="n">sdescmd5</span><span class="o">-&gt;</span><span class="n">shash</span><span class="p">.</span><span class="n">tfm</span> <span class="o">=</span> <span class="n">server</span><span class="o">-&gt;</span><span class="n">secmech</span><span class="p">.</span><span class="n">md5</span><span class="p">;</span>
	<span class="n">server</span><span class="o">-&gt;</span><span class="n">secmech</span><span class="p">.</span><span class="n">sdescmd5</span><span class="o">-&gt;</span><span class="n">shash</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">crypto_allocate_md5_sdesc_fail:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">secmech</span><span class="p">.</span><span class="n">sdeschmacmd5</span><span class="p">);</span>

<span class="nl">crypto_allocate_hmacmd5_sdesc_fail:</span>
	<span class="n">crypto_free_shash</span><span class="p">(</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">secmech</span><span class="p">.</span><span class="n">md5</span><span class="p">);</span>

<span class="nl">crypto_allocate_md5_fail:</span>
	<span class="n">crypto_free_shash</span><span class="p">(</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">secmech</span><span class="p">.</span><span class="n">hmacmd5</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
