<!DOCTYPE html>
<html><head><title>joekychen/linux » fs › cifs › connect.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>connect.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> *   fs/cifs/connect.c</span>
<span class="cm"> *</span>
<span class="cm"> *   Copyright (C) International Business Machines  Corp., 2002,2011</span>
<span class="cm"> *   Author(s): Steve French (sfrench@us.ibm.com)</span>
<span class="cm"> *</span>
<span class="cm"> *   This library is free software; you can redistribute it and/or modify</span>
<span class="cm"> *   it under the terms of the GNU Lesser General Public License as published</span>
<span class="cm"> *   by the Free Software Foundation; either version 2.1 of the License, or</span>
<span class="cm"> *   (at your option) any later version.</span>
<span class="cm"> *</span>
<span class="cm"> *   This library is distributed in the hope that it will be useful,</span>
<span class="cm"> *   but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> *   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See</span>
<span class="cm"> *   the GNU Lesser General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> *   You should have received a copy of the GNU Lesser General Public License</span>
<span class="cm"> *   along with this library; if not, write to the Free Software</span>
<span class="cm"> *   Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA 02111-1307 USA</span>
<span class="cm"> */</span>
<span class="cp">#include &lt;linux/fs.h&gt;</span>
<span class="cp">#include &lt;linux/net.h&gt;</span>
<span class="cp">#include &lt;linux/string.h&gt;</span>
<span class="cp">#include &lt;linux/list.h&gt;</span>
<span class="cp">#include &lt;linux/wait.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/pagemap.h&gt;</span>
<span class="cp">#include &lt;linux/ctype.h&gt;</span>
<span class="cp">#include &lt;linux/utsname.h&gt;</span>
<span class="cp">#include &lt;linux/mempool.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/completion.h&gt;</span>
<span class="cp">#include &lt;linux/kthread.h&gt;</span>
<span class="cp">#include &lt;linux/pagevec.h&gt;</span>
<span class="cp">#include &lt;linux/freezer.h&gt;</span>
<span class="cp">#include &lt;linux/namei.h&gt;</span>
<span class="cp">#include &lt;asm/uaccess.h&gt;</span>
<span class="cp">#include &lt;asm/processor.h&gt;</span>
<span class="cp">#include &lt;linux/inet.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;keys/user-type.h&gt;</span>
<span class="cp">#include &lt;net/ipv6.h&gt;</span>
<span class="cp">#include &lt;linux/parser.h&gt;</span>

<span class="cp">#include &quot;cifspdu.h&quot;</span>
<span class="cp">#include &quot;cifsglob.h&quot;</span>
<span class="cp">#include &quot;cifsproto.h&quot;</span>
<span class="cp">#include &quot;cifs_unicode.h&quot;</span>
<span class="cp">#include &quot;cifs_debug.h&quot;</span>
<span class="cp">#include &quot;cifs_fs_sb.h&quot;</span>
<span class="cp">#include &quot;ntlmssp.h&quot;</span>
<span class="cp">#include &quot;nterr.h&quot;</span>
<span class="cp">#include &quot;rfc1002pdu.h&quot;</span>
<span class="cp">#include &quot;fscache.h&quot;</span>

<span class="cp">#define CIFS_PORT 445</span>
<span class="cp">#define RFC1001_PORT 139</span>

<span class="cm">/* SMB echo &quot;timeout&quot; -- FIXME: tunable? */</span>
<span class="cp">#define SMB_ECHO_INTERVAL (60 * HZ)</span>

<span class="k">extern</span> <span class="n">mempool_t</span> <span class="o">*</span><span class="n">cifs_req_poolp</span><span class="p">;</span>

<span class="cm">/* FIXME: should these be tunable? */</span>
<span class="cp">#define TLINK_ERROR_EXPIRE	(1 * HZ)</span>
<span class="cp">#define TLINK_IDLE_EXPIRE	(600 * HZ)</span>

<span class="k">enum</span> <span class="p">{</span>

	<span class="cm">/* Mount options that take no arguments */</span>
	<span class="n">Opt_user_xattr</span><span class="p">,</span> <span class="n">Opt_nouser_xattr</span><span class="p">,</span>
	<span class="n">Opt_forceuid</span><span class="p">,</span> <span class="n">Opt_noforceuid</span><span class="p">,</span>
	<span class="n">Opt_noblocksend</span><span class="p">,</span> <span class="n">Opt_noautotune</span><span class="p">,</span>
	<span class="n">Opt_hard</span><span class="p">,</span> <span class="n">Opt_soft</span><span class="p">,</span> <span class="n">Opt_perm</span><span class="p">,</span> <span class="n">Opt_noperm</span><span class="p">,</span>
	<span class="n">Opt_mapchars</span><span class="p">,</span> <span class="n">Opt_nomapchars</span><span class="p">,</span> <span class="n">Opt_sfu</span><span class="p">,</span>
	<span class="n">Opt_nosfu</span><span class="p">,</span> <span class="n">Opt_nodfs</span><span class="p">,</span> <span class="n">Opt_posixpaths</span><span class="p">,</span>
	<span class="n">Opt_noposixpaths</span><span class="p">,</span> <span class="n">Opt_nounix</span><span class="p">,</span>
	<span class="n">Opt_nocase</span><span class="p">,</span>
	<span class="n">Opt_brl</span><span class="p">,</span> <span class="n">Opt_nobrl</span><span class="p">,</span>
	<span class="n">Opt_forcemandatorylock</span><span class="p">,</span> <span class="n">Opt_setuids</span><span class="p">,</span>
	<span class="n">Opt_nosetuids</span><span class="p">,</span> <span class="n">Opt_dynperm</span><span class="p">,</span> <span class="n">Opt_nodynperm</span><span class="p">,</span>
	<span class="n">Opt_nohard</span><span class="p">,</span> <span class="n">Opt_nosoft</span><span class="p">,</span>
	<span class="n">Opt_nointr</span><span class="p">,</span> <span class="n">Opt_intr</span><span class="p">,</span>
	<span class="n">Opt_nostrictsync</span><span class="p">,</span> <span class="n">Opt_strictsync</span><span class="p">,</span>
	<span class="n">Opt_serverino</span><span class="p">,</span> <span class="n">Opt_noserverino</span><span class="p">,</span>
	<span class="n">Opt_rwpidforward</span><span class="p">,</span> <span class="n">Opt_cifsacl</span><span class="p">,</span> <span class="n">Opt_nocifsacl</span><span class="p">,</span>
	<span class="n">Opt_acl</span><span class="p">,</span> <span class="n">Opt_noacl</span><span class="p">,</span> <span class="n">Opt_locallease</span><span class="p">,</span>
	<span class="n">Opt_sign</span><span class="p">,</span> <span class="n">Opt_seal</span><span class="p">,</span> <span class="n">Opt_direct</span><span class="p">,</span>
	<span class="n">Opt_strictcache</span><span class="p">,</span> <span class="n">Opt_noac</span><span class="p">,</span>
	<span class="n">Opt_fsc</span><span class="p">,</span> <span class="n">Opt_mfsymlinks</span><span class="p">,</span>
	<span class="n">Opt_multiuser</span><span class="p">,</span> <span class="n">Opt_sloppy</span><span class="p">,</span>

	<span class="cm">/* Mount options which take numeric value */</span>
	<span class="n">Opt_backupuid</span><span class="p">,</span> <span class="n">Opt_backupgid</span><span class="p">,</span> <span class="n">Opt_uid</span><span class="p">,</span>
	<span class="n">Opt_cruid</span><span class="p">,</span> <span class="n">Opt_gid</span><span class="p">,</span> <span class="n">Opt_file_mode</span><span class="p">,</span>
	<span class="n">Opt_dirmode</span><span class="p">,</span> <span class="n">Opt_port</span><span class="p">,</span>
	<span class="n">Opt_rsize</span><span class="p">,</span> <span class="n">Opt_wsize</span><span class="p">,</span> <span class="n">Opt_actimeo</span><span class="p">,</span>

	<span class="cm">/* Mount options which take string value */</span>
	<span class="n">Opt_user</span><span class="p">,</span> <span class="n">Opt_pass</span><span class="p">,</span> <span class="n">Opt_ip</span><span class="p">,</span>
	<span class="n">Opt_unc</span><span class="p">,</span> <span class="n">Opt_domain</span><span class="p">,</span>
	<span class="n">Opt_srcaddr</span><span class="p">,</span> <span class="n">Opt_prefixpath</span><span class="p">,</span>
	<span class="n">Opt_iocharset</span><span class="p">,</span> <span class="n">Opt_sockopt</span><span class="p">,</span>
	<span class="n">Opt_netbiosname</span><span class="p">,</span> <span class="n">Opt_servern</span><span class="p">,</span>
	<span class="n">Opt_ver</span><span class="p">,</span> <span class="n">Opt_vers</span><span class="p">,</span> <span class="n">Opt_sec</span><span class="p">,</span> <span class="n">Opt_cache</span><span class="p">,</span>

	<span class="cm">/* Mount options to be ignored */</span>
	<span class="n">Opt_ignore</span><span class="p">,</span>

	<span class="cm">/* Options which could be blank */</span>
	<span class="n">Opt_blank_pass</span><span class="p">,</span>
	<span class="n">Opt_blank_user</span><span class="p">,</span>
	<span class="n">Opt_blank_ip</span><span class="p">,</span>

	<span class="n">Opt_err</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="n">match_table_t</span> <span class="n">cifs_mount_option_tokens</span> <span class="o">=</span> <span class="p">{</span>

	<span class="p">{</span> <span class="n">Opt_user_xattr</span><span class="p">,</span> <span class="s">&quot;user_xattr&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">Opt_nouser_xattr</span><span class="p">,</span> <span class="s">&quot;nouser_xattr&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">Opt_forceuid</span><span class="p">,</span> <span class="s">&quot;forceuid&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">Opt_noforceuid</span><span class="p">,</span> <span class="s">&quot;noforceuid&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">Opt_noblocksend</span><span class="p">,</span> <span class="s">&quot;noblocksend&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">Opt_noautotune</span><span class="p">,</span> <span class="s">&quot;noautotune&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">Opt_hard</span><span class="p">,</span> <span class="s">&quot;hard&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">Opt_soft</span><span class="p">,</span> <span class="s">&quot;soft&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">Opt_perm</span><span class="p">,</span> <span class="s">&quot;perm&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">Opt_noperm</span><span class="p">,</span> <span class="s">&quot;noperm&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">Opt_mapchars</span><span class="p">,</span> <span class="s">&quot;mapchars&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">Opt_nomapchars</span><span class="p">,</span> <span class="s">&quot;nomapchars&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">Opt_sfu</span><span class="p">,</span> <span class="s">&quot;sfu&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">Opt_nosfu</span><span class="p">,</span> <span class="s">&quot;nosfu&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">Opt_nodfs</span><span class="p">,</span> <span class="s">&quot;nodfs&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">Opt_posixpaths</span><span class="p">,</span> <span class="s">&quot;posixpaths&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">Opt_noposixpaths</span><span class="p">,</span> <span class="s">&quot;noposixpaths&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">Opt_nounix</span><span class="p">,</span> <span class="s">&quot;nounix&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">Opt_nounix</span><span class="p">,</span> <span class="s">&quot;nolinux&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">Opt_nocase</span><span class="p">,</span> <span class="s">&quot;nocase&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">Opt_nocase</span><span class="p">,</span> <span class="s">&quot;ignorecase&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">Opt_brl</span><span class="p">,</span> <span class="s">&quot;brl&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">Opt_nobrl</span><span class="p">,</span> <span class="s">&quot;nobrl&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">Opt_nobrl</span><span class="p">,</span> <span class="s">&quot;nolock&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">Opt_forcemandatorylock</span><span class="p">,</span> <span class="s">&quot;forcemandatorylock&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">Opt_forcemandatorylock</span><span class="p">,</span> <span class="s">&quot;forcemand&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">Opt_setuids</span><span class="p">,</span> <span class="s">&quot;setuids&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">Opt_nosetuids</span><span class="p">,</span> <span class="s">&quot;nosetuids&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">Opt_dynperm</span><span class="p">,</span> <span class="s">&quot;dynperm&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">Opt_nodynperm</span><span class="p">,</span> <span class="s">&quot;nodynperm&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">Opt_nohard</span><span class="p">,</span> <span class="s">&quot;nohard&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">Opt_nosoft</span><span class="p">,</span> <span class="s">&quot;nosoft&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">Opt_nointr</span><span class="p">,</span> <span class="s">&quot;nointr&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">Opt_intr</span><span class="p">,</span> <span class="s">&quot;intr&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">Opt_nostrictsync</span><span class="p">,</span> <span class="s">&quot;nostrictsync&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">Opt_strictsync</span><span class="p">,</span> <span class="s">&quot;strictsync&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">Opt_serverino</span><span class="p">,</span> <span class="s">&quot;serverino&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">Opt_noserverino</span><span class="p">,</span> <span class="s">&quot;noserverino&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">Opt_rwpidforward</span><span class="p">,</span> <span class="s">&quot;rwpidforward&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">Opt_cifsacl</span><span class="p">,</span> <span class="s">&quot;cifsacl&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">Opt_nocifsacl</span><span class="p">,</span> <span class="s">&quot;nocifsacl&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">Opt_acl</span><span class="p">,</span> <span class="s">&quot;acl&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">Opt_noacl</span><span class="p">,</span> <span class="s">&quot;noacl&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">Opt_locallease</span><span class="p">,</span> <span class="s">&quot;locallease&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">Opt_sign</span><span class="p">,</span> <span class="s">&quot;sign&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">Opt_seal</span><span class="p">,</span> <span class="s">&quot;seal&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">Opt_direct</span><span class="p">,</span> <span class="s">&quot;direct&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">Opt_direct</span><span class="p">,</span> <span class="s">&quot;directio&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">Opt_direct</span><span class="p">,</span> <span class="s">&quot;forcedirectio&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">Opt_strictcache</span><span class="p">,</span> <span class="s">&quot;strictcache&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">Opt_noac</span><span class="p">,</span> <span class="s">&quot;noac&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">Opt_fsc</span><span class="p">,</span> <span class="s">&quot;fsc&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">Opt_mfsymlinks</span><span class="p">,</span> <span class="s">&quot;mfsymlinks&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">Opt_multiuser</span><span class="p">,</span> <span class="s">&quot;multiuser&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">Opt_sloppy</span><span class="p">,</span> <span class="s">&quot;sloppy&quot;</span> <span class="p">},</span>

	<span class="p">{</span> <span class="n">Opt_backupuid</span><span class="p">,</span> <span class="s">&quot;backupuid=%s&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">Opt_backupgid</span><span class="p">,</span> <span class="s">&quot;backupgid=%s&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">Opt_uid</span><span class="p">,</span> <span class="s">&quot;uid=%s&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">Opt_cruid</span><span class="p">,</span> <span class="s">&quot;cruid=%s&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">Opt_gid</span><span class="p">,</span> <span class="s">&quot;gid=%s&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">Opt_file_mode</span><span class="p">,</span> <span class="s">&quot;file_mode=%s&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">Opt_dirmode</span><span class="p">,</span> <span class="s">&quot;dirmode=%s&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">Opt_dirmode</span><span class="p">,</span> <span class="s">&quot;dir_mode=%s&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">Opt_port</span><span class="p">,</span> <span class="s">&quot;port=%s&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">Opt_rsize</span><span class="p">,</span> <span class="s">&quot;rsize=%s&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">Opt_wsize</span><span class="p">,</span> <span class="s">&quot;wsize=%s&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">Opt_actimeo</span><span class="p">,</span> <span class="s">&quot;actimeo=%s&quot;</span> <span class="p">},</span>

	<span class="p">{</span> <span class="n">Opt_blank_user</span><span class="p">,</span> <span class="s">&quot;user=&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">Opt_blank_user</span><span class="p">,</span> <span class="s">&quot;username=&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">Opt_user</span><span class="p">,</span> <span class="s">&quot;user=%s&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">Opt_user</span><span class="p">,</span> <span class="s">&quot;username=%s&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">Opt_blank_pass</span><span class="p">,</span> <span class="s">&quot;pass=&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">Opt_pass</span><span class="p">,</span> <span class="s">&quot;pass=%s&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">Opt_pass</span><span class="p">,</span> <span class="s">&quot;password=%s&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">Opt_blank_ip</span><span class="p">,</span> <span class="s">&quot;ip=&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">Opt_blank_ip</span><span class="p">,</span> <span class="s">&quot;addr=&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">Opt_ip</span><span class="p">,</span> <span class="s">&quot;ip=%s&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">Opt_ip</span><span class="p">,</span> <span class="s">&quot;addr=%s&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">Opt_unc</span><span class="p">,</span> <span class="s">&quot;unc=%s&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">Opt_unc</span><span class="p">,</span> <span class="s">&quot;target=%s&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">Opt_unc</span><span class="p">,</span> <span class="s">&quot;path=%s&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">Opt_domain</span><span class="p">,</span> <span class="s">&quot;dom=%s&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">Opt_domain</span><span class="p">,</span> <span class="s">&quot;domain=%s&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">Opt_domain</span><span class="p">,</span> <span class="s">&quot;workgroup=%s&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">Opt_srcaddr</span><span class="p">,</span> <span class="s">&quot;srcaddr=%s&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">Opt_prefixpath</span><span class="p">,</span> <span class="s">&quot;prefixpath=%s&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">Opt_iocharset</span><span class="p">,</span> <span class="s">&quot;iocharset=%s&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">Opt_sockopt</span><span class="p">,</span> <span class="s">&quot;sockopt=%s&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">Opt_netbiosname</span><span class="p">,</span> <span class="s">&quot;netbiosname=%s&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">Opt_servern</span><span class="p">,</span> <span class="s">&quot;servern=%s&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">Opt_ver</span><span class="p">,</span> <span class="s">&quot;ver=%s&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">Opt_vers</span><span class="p">,</span> <span class="s">&quot;vers=%s&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">Opt_sec</span><span class="p">,</span> <span class="s">&quot;sec=%s&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">Opt_cache</span><span class="p">,</span> <span class="s">&quot;cache=%s&quot;</span> <span class="p">},</span>

	<span class="p">{</span> <span class="n">Opt_ignore</span><span class="p">,</span> <span class="s">&quot;cred&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">Opt_ignore</span><span class="p">,</span> <span class="s">&quot;credentials&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">Opt_ignore</span><span class="p">,</span> <span class="s">&quot;cred=%s&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">Opt_ignore</span><span class="p">,</span> <span class="s">&quot;credentials=%s&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">Opt_ignore</span><span class="p">,</span> <span class="s">&quot;guest&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">Opt_ignore</span><span class="p">,</span> <span class="s">&quot;rw&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">Opt_ignore</span><span class="p">,</span> <span class="s">&quot;ro&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">Opt_ignore</span><span class="p">,</span> <span class="s">&quot;suid&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">Opt_ignore</span><span class="p">,</span> <span class="s">&quot;nosuid&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">Opt_ignore</span><span class="p">,</span> <span class="s">&quot;exec&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">Opt_ignore</span><span class="p">,</span> <span class="s">&quot;noexec&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">Opt_ignore</span><span class="p">,</span> <span class="s">&quot;nodev&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">Opt_ignore</span><span class="p">,</span> <span class="s">&quot;noauto&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">Opt_ignore</span><span class="p">,</span> <span class="s">&quot;dev&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">Opt_ignore</span><span class="p">,</span> <span class="s">&quot;mand&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">Opt_ignore</span><span class="p">,</span> <span class="s">&quot;nomand&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">Opt_ignore</span><span class="p">,</span> <span class="s">&quot;_netdev&quot;</span> <span class="p">},</span>

	<span class="p">{</span> <span class="n">Opt_err</span><span class="p">,</span> <span class="nb">NULL</span> <span class="p">}</span>
<span class="p">};</span>

<span class="k">enum</span> <span class="p">{</span>
	<span class="n">Opt_sec_krb5</span><span class="p">,</span> <span class="n">Opt_sec_krb5i</span><span class="p">,</span> <span class="n">Opt_sec_krb5p</span><span class="p">,</span>
	<span class="n">Opt_sec_ntlmsspi</span><span class="p">,</span> <span class="n">Opt_sec_ntlmssp</span><span class="p">,</span>
	<span class="n">Opt_ntlm</span><span class="p">,</span> <span class="n">Opt_sec_ntlmi</span><span class="p">,</span> <span class="n">Opt_sec_ntlmv2i</span><span class="p">,</span>
	<span class="n">Opt_sec_nontlm</span><span class="p">,</span> <span class="n">Opt_sec_lanman</span><span class="p">,</span>
	<span class="n">Opt_sec_none</span><span class="p">,</span>

	<span class="n">Opt_sec_err</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="n">match_table_t</span> <span class="n">cifs_secflavor_tokens</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="n">Opt_sec_krb5</span><span class="p">,</span> <span class="s">&quot;krb5&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">Opt_sec_krb5i</span><span class="p">,</span> <span class="s">&quot;krb5i&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">Opt_sec_krb5p</span><span class="p">,</span> <span class="s">&quot;krb5p&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">Opt_sec_ntlmsspi</span><span class="p">,</span> <span class="s">&quot;ntlmsspi&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">Opt_sec_ntlmssp</span><span class="p">,</span> <span class="s">&quot;ntlmssp&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">Opt_ntlm</span><span class="p">,</span> <span class="s">&quot;ntlm&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">Opt_sec_ntlmi</span><span class="p">,</span> <span class="s">&quot;ntlmi&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">Opt_sec_ntlmv2i</span><span class="p">,</span> <span class="s">&quot;ntlmv2i&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">Opt_sec_nontlm</span><span class="p">,</span> <span class="s">&quot;nontlm&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">Opt_sec_lanman</span><span class="p">,</span> <span class="s">&quot;lanman&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">Opt_sec_none</span><span class="p">,</span> <span class="s">&quot;none&quot;</span> <span class="p">},</span>

	<span class="p">{</span> <span class="n">Opt_sec_err</span><span class="p">,</span> <span class="nb">NULL</span> <span class="p">}</span>
<span class="p">};</span>

<span class="cm">/* cache flavors */</span>
<span class="k">enum</span> <span class="p">{</span>
	<span class="n">Opt_cache_loose</span><span class="p">,</span>
	<span class="n">Opt_cache_strict</span><span class="p">,</span>
	<span class="n">Opt_cache_none</span><span class="p">,</span>
	<span class="n">Opt_cache_err</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="n">match_table_t</span> <span class="n">cifs_cacheflavor_tokens</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="n">Opt_cache_loose</span><span class="p">,</span> <span class="s">&quot;loose&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">Opt_cache_strict</span><span class="p">,</span> <span class="s">&quot;strict&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">Opt_cache_none</span><span class="p">,</span> <span class="s">&quot;none&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">Opt_cache_err</span><span class="p">,</span> <span class="nb">NULL</span> <span class="p">}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="n">match_table_t</span> <span class="n">cifs_smb_version_tokens</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="n">Smb_1</span><span class="p">,</span> <span class="n">SMB1_VERSION_STRING</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">Smb_21</span><span class="p">,</span> <span class="n">SMB21_VERSION_STRING</span> <span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">ip_connect</span><span class="p">(</span><span class="k">struct</span> <span class="n">TCP_Server_Info</span> <span class="o">*</span><span class="n">server</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">generic_ip_connect</span><span class="p">(</span><span class="k">struct</span> <span class="n">TCP_Server_Info</span> <span class="o">*</span><span class="n">server</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">tlink_rb_insert</span><span class="p">(</span><span class="k">struct</span> <span class="n">rb_root</span> <span class="o">*</span><span class="n">root</span><span class="p">,</span> <span class="k">struct</span> <span class="n">tcon_link</span> <span class="o">*</span><span class="n">new_tlink</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">cifs_prune_tlinks</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">cifs_setup_volume_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">smb_vol</span> <span class="o">*</span><span class="n">volume_info</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">mount_data</span><span class="p">,</span>
					<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">devname</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * cifs tcp session reconnection</span>
<span class="cm"> *</span>
<span class="cm"> * mark tcp session as reconnecting so temporarily locked</span>
<span class="cm"> * mark all smb sessions as reconnecting for tcp session</span>
<span class="cm"> * reconnect tcp session</span>
<span class="cm"> * wake up waiters on reconnection? - (not needed currently)</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">cifs_reconnect</span><span class="p">(</span><span class="k">struct</span> <span class="n">TCP_Server_Info</span> <span class="o">*</span><span class="n">server</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">tmp</span><span class="p">,</span> <span class="o">*</span><span class="n">tmp2</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cifs_ses</span> <span class="o">*</span><span class="n">ses</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cifs_tcon</span> <span class="o">*</span><span class="n">tcon</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mid_q_entry</span> <span class="o">*</span><span class="n">mid_entry</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="n">retry_list</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">GlobalMid_Lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">tcpStatus</span> <span class="o">==</span> <span class="n">CifsExiting</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* the demux thread will exit normally</span>
<span class="cm">		next time through the loop */</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">GlobalMid_Lock</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">server</span><span class="o">-&gt;</span><span class="n">tcpStatus</span> <span class="o">=</span> <span class="n">CifsNeedReconnect</span><span class="p">;</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">GlobalMid_Lock</span><span class="p">);</span>
	<span class="n">server</span><span class="o">-&gt;</span><span class="n">maxBuf</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">cFYI</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;Reconnecting tcp session&quot;</span><span class="p">);</span>

	<span class="cm">/* before reconnecting the tcp session, mark the smb session (uid)</span>
<span class="cm">		and the tid bad so they are not used until reconnected */</span>
	<span class="n">cFYI</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;%s: marking sessions and tcons for reconnect&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cifs_tcp_ses_lock</span><span class="p">);</span>
	<span class="n">list_for_each</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">smb_ses_list</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ses</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">cifs_ses</span><span class="p">,</span> <span class="n">smb_ses_list</span><span class="p">);</span>
		<span class="n">ses</span><span class="o">-&gt;</span><span class="n">need_reconnect</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="n">ses</span><span class="o">-&gt;</span><span class="n">ipc_tid</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">list_for_each</span><span class="p">(</span><span class="n">tmp2</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ses</span><span class="o">-&gt;</span><span class="n">tcon_list</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">tcon</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">tmp2</span><span class="p">,</span> <span class="k">struct</span> <span class="n">cifs_tcon</span><span class="p">,</span> <span class="n">tcon_list</span><span class="p">);</span>
			<span class="n">tcon</span><span class="o">-&gt;</span><span class="n">need_reconnect</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cifs_tcp_ses_lock</span><span class="p">);</span>

	<span class="cm">/* do not want to be sending data on a socket we are freeing */</span>
	<span class="n">cFYI</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;%s: tearing down socket&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">srv_mutex</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">ssocket</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cFYI</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;State: 0x%x Flags: 0x%lx&quot;</span><span class="p">,</span> <span class="n">server</span><span class="o">-&gt;</span><span class="n">ssocket</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">,</span>
			<span class="n">server</span><span class="o">-&gt;</span><span class="n">ssocket</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
		<span class="n">kernel_sock_shutdown</span><span class="p">(</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">ssocket</span><span class="p">,</span> <span class="n">SHUT_WR</span><span class="p">);</span>
		<span class="n">cFYI</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;Post shutdown state: 0x%x Flags: 0x%lx&quot;</span><span class="p">,</span>
			<span class="n">server</span><span class="o">-&gt;</span><span class="n">ssocket</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">,</span>
			<span class="n">server</span><span class="o">-&gt;</span><span class="n">ssocket</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
		<span class="n">sock_release</span><span class="p">(</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">ssocket</span><span class="p">);</span>
		<span class="n">server</span><span class="o">-&gt;</span><span class="n">ssocket</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">server</span><span class="o">-&gt;</span><span class="n">sequence_number</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">server</span><span class="o">-&gt;</span><span class="n">session_estab</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">session_key</span><span class="p">.</span><span class="n">response</span><span class="p">);</span>
	<span class="n">server</span><span class="o">-&gt;</span><span class="n">session_key</span><span class="p">.</span><span class="n">response</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">server</span><span class="o">-&gt;</span><span class="n">session_key</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">server</span><span class="o">-&gt;</span><span class="n">lstrp</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">srv_mutex</span><span class="p">);</span>

	<span class="cm">/* mark submitted MIDs for retry and issue callback */</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">retry_list</span><span class="p">);</span>
	<span class="n">cFYI</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;%s: moving mids to private list&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">GlobalMid_Lock</span><span class="p">);</span>
	<span class="n">list_for_each_safe</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="n">tmp2</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">pending_mid_q</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mid_entry</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">mid_q_entry</span><span class="p">,</span> <span class="n">qhead</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mid_entry</span><span class="o">-&gt;</span><span class="n">mid_state</span> <span class="o">==</span> <span class="n">MID_REQUEST_SUBMITTED</span><span class="p">)</span>
			<span class="n">mid_entry</span><span class="o">-&gt;</span><span class="n">mid_state</span> <span class="o">=</span> <span class="n">MID_RETRY_NEEDED</span><span class="p">;</span>
		<span class="n">list_move</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mid_entry</span><span class="o">-&gt;</span><span class="n">qhead</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">retry_list</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">GlobalMid_Lock</span><span class="p">);</span>

	<span class="n">cFYI</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;%s: issuing mid callbacks&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="n">list_for_each_safe</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="n">tmp2</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">retry_list</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mid_entry</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">mid_q_entry</span><span class="p">,</span> <span class="n">qhead</span><span class="p">);</span>
		<span class="n">list_del_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mid_entry</span><span class="o">-&gt;</span><span class="n">qhead</span><span class="p">);</span>
		<span class="n">mid_entry</span><span class="o">-&gt;</span><span class="n">callback</span><span class="p">(</span><span class="n">mid_entry</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="n">try_to_freeze</span><span class="p">();</span>

		<span class="cm">/* we should try only the port we connected to before */</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">generic_ip_connect</span><span class="p">(</span><span class="n">server</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">cFYI</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;reconnect error %d&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
			<span class="n">msleep</span><span class="p">(</span><span class="mi">3000</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tcpSesReconnectCount</span><span class="p">);</span>
			<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">GlobalMid_Lock</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">tcpStatus</span> <span class="o">!=</span> <span class="n">CifsExiting</span><span class="p">)</span>
				<span class="n">server</span><span class="o">-&gt;</span><span class="n">tcpStatus</span> <span class="o">=</span> <span class="n">CifsNeedNegotiate</span><span class="p">;</span>
			<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">GlobalMid_Lock</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">tcpStatus</span> <span class="o">==</span> <span class="n">CifsNeedReconnect</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">	return codes:</span>
<span class="cm">		0 	not a transact2, or all data present</span>
<span class="cm">		&gt;0 	transact2 with that much data missing</span>
<span class="cm">		-EINVAL = invalid transact2</span>

<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">check2ndT2</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">smb_hdr</span> <span class="o">*</span><span class="n">pSMB</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">smb_hdr</span> <span class="o">*</span><span class="p">)</span><span class="n">buf</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">smb_t2_rsp</span> <span class="o">*</span><span class="n">pSMBt</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">remaining</span><span class="p">;</span>
	<span class="n">__u16</span> <span class="n">total_data_size</span><span class="p">,</span> <span class="n">data_in_this_rsp</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">Command</span> <span class="o">!=</span> <span class="n">SMB_COM_TRANSACTION2</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* check for plausible wct, bcc and t2 data and parm sizes */</span>
	<span class="cm">/* check for parm and data offset going beyond end of smb */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">WordCount</span> <span class="o">!=</span> <span class="mi">10</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* coalesce_t2 depends on this */</span>
		<span class="n">cFYI</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;invalid transact2 word count&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pSMBt</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">smb_t2_rsp</span> <span class="o">*</span><span class="p">)</span><span class="n">pSMB</span><span class="p">;</span>

	<span class="n">total_data_size</span> <span class="o">=</span> <span class="n">get_unaligned_le16</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pSMBt</span><span class="o">-&gt;</span><span class="n">t2_rsp</span><span class="p">.</span><span class="n">TotalDataCount</span><span class="p">);</span>
	<span class="n">data_in_this_rsp</span> <span class="o">=</span> <span class="n">get_unaligned_le16</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pSMBt</span><span class="o">-&gt;</span><span class="n">t2_rsp</span><span class="p">.</span><span class="n">DataCount</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">total_data_size</span> <span class="o">==</span> <span class="n">data_in_this_rsp</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">total_data_size</span> <span class="o">&lt;</span> <span class="n">data_in_this_rsp</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cFYI</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;total data %d smaller than data in frame %d&quot;</span><span class="p">,</span>
			<span class="n">total_data_size</span><span class="p">,</span> <span class="n">data_in_this_rsp</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">remaining</span> <span class="o">=</span> <span class="n">total_data_size</span> <span class="o">-</span> <span class="n">data_in_this_rsp</span><span class="p">;</span>

	<span class="n">cFYI</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;missing %d bytes from transact2, check next response&quot;</span><span class="p">,</span>
		<span class="n">remaining</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">total_data_size</span> <span class="o">&gt;</span> <span class="n">CIFSMaxBufSize</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cERROR</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;TotalDataSize %d is over maximum buffer %d&quot;</span><span class="p">,</span>
			<span class="n">total_data_size</span><span class="p">,</span> <span class="n">CIFSMaxBufSize</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">remaining</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">coalesce_t2</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">second_buf</span><span class="p">,</span> <span class="k">struct</span> <span class="n">smb_hdr</span> <span class="o">*</span><span class="n">target_hdr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">smb_t2_rsp</span> <span class="o">*</span><span class="n">pSMBs</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">smb_t2_rsp</span> <span class="o">*</span><span class="p">)</span><span class="n">second_buf</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">smb_t2_rsp</span> <span class="o">*</span><span class="n">pSMBt</span>  <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">smb_t2_rsp</span> <span class="o">*</span><span class="p">)</span><span class="n">target_hdr</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">data_area_of_tgt</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">data_area_of_src</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">remaining</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">byte_count</span><span class="p">,</span> <span class="n">total_in_tgt</span><span class="p">;</span>
	<span class="n">__u16</span> <span class="n">tgt_total_cnt</span><span class="p">,</span> <span class="n">src_total_cnt</span><span class="p">,</span> <span class="n">total_in_src</span><span class="p">;</span>

	<span class="n">src_total_cnt</span> <span class="o">=</span> <span class="n">get_unaligned_le16</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pSMBs</span><span class="o">-&gt;</span><span class="n">t2_rsp</span><span class="p">.</span><span class="n">TotalDataCount</span><span class="p">);</span>
	<span class="n">tgt_total_cnt</span> <span class="o">=</span> <span class="n">get_unaligned_le16</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pSMBt</span><span class="o">-&gt;</span><span class="n">t2_rsp</span><span class="p">.</span><span class="n">TotalDataCount</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tgt_total_cnt</span> <span class="o">!=</span> <span class="n">src_total_cnt</span><span class="p">)</span>
		<span class="n">cFYI</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;total data count of primary and secondary t2 differ &quot;</span>
			<span class="s">&quot;source=%hu target=%hu&quot;</span><span class="p">,</span> <span class="n">src_total_cnt</span><span class="p">,</span> <span class="n">tgt_total_cnt</span><span class="p">);</span>

	<span class="n">total_in_tgt</span> <span class="o">=</span> <span class="n">get_unaligned_le16</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pSMBt</span><span class="o">-&gt;</span><span class="n">t2_rsp</span><span class="p">.</span><span class="n">DataCount</span><span class="p">);</span>

	<span class="n">remaining</span> <span class="o">=</span> <span class="n">tgt_total_cnt</span> <span class="o">-</span> <span class="n">total_in_tgt</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">remaining</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cFYI</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;Server sent too much data. tgt_total_cnt=%hu &quot;</span>
			<span class="s">&quot;total_in_tgt=%hu&quot;</span><span class="p">,</span> <span class="n">tgt_total_cnt</span><span class="p">,</span> <span class="n">total_in_tgt</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EPROTO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">remaining</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* nothing to do, ignore */</span>
		<span class="n">cFYI</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;no more data remains&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">total_in_src</span> <span class="o">=</span> <span class="n">get_unaligned_le16</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pSMBs</span><span class="o">-&gt;</span><span class="n">t2_rsp</span><span class="p">.</span><span class="n">DataCount</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">remaining</span> <span class="o">&lt;</span> <span class="n">total_in_src</span><span class="p">)</span>
		<span class="n">cFYI</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;transact2 2nd response contains too much data&quot;</span><span class="p">);</span>

	<span class="cm">/* find end of first SMB data area */</span>
	<span class="n">data_area_of_tgt</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">pSMBt</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">Protocol</span> <span class="o">+</span>
				<span class="n">get_unaligned_le16</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pSMBt</span><span class="o">-&gt;</span><span class="n">t2_rsp</span><span class="p">.</span><span class="n">DataOffset</span><span class="p">);</span>

	<span class="cm">/* validate target area */</span>
	<span class="n">data_area_of_src</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">pSMBs</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">Protocol</span> <span class="o">+</span>
				<span class="n">get_unaligned_le16</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pSMBs</span><span class="o">-&gt;</span><span class="n">t2_rsp</span><span class="p">.</span><span class="n">DataOffset</span><span class="p">);</span>

	<span class="n">data_area_of_tgt</span> <span class="o">+=</span> <span class="n">total_in_tgt</span><span class="p">;</span>

	<span class="n">total_in_tgt</span> <span class="o">+=</span> <span class="n">total_in_src</span><span class="p">;</span>
	<span class="cm">/* is the result too big for the field? */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">total_in_tgt</span> <span class="o">&gt;</span> <span class="n">USHRT_MAX</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cFYI</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;coalesced DataCount too large (%u)&quot;</span><span class="p">,</span> <span class="n">total_in_tgt</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EPROTO</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">put_unaligned_le16</span><span class="p">(</span><span class="n">total_in_tgt</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pSMBt</span><span class="o">-&gt;</span><span class="n">t2_rsp</span><span class="p">.</span><span class="n">DataCount</span><span class="p">);</span>

	<span class="cm">/* fix up the BCC */</span>
	<span class="n">byte_count</span> <span class="o">=</span> <span class="n">get_bcc</span><span class="p">(</span><span class="n">target_hdr</span><span class="p">);</span>
	<span class="n">byte_count</span> <span class="o">+=</span> <span class="n">total_in_src</span><span class="p">;</span>
	<span class="cm">/* is the result too big for the field? */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">byte_count</span> <span class="o">&gt;</span> <span class="n">USHRT_MAX</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cFYI</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;coalesced BCC too large (%u)&quot;</span><span class="p">,</span> <span class="n">byte_count</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EPROTO</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">put_bcc</span><span class="p">(</span><span class="n">byte_count</span><span class="p">,</span> <span class="n">target_hdr</span><span class="p">);</span>

	<span class="n">byte_count</span> <span class="o">=</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">target_hdr</span><span class="o">-&gt;</span><span class="n">smb_buf_length</span><span class="p">);</span>
	<span class="n">byte_count</span> <span class="o">+=</span> <span class="n">total_in_src</span><span class="p">;</span>
	<span class="cm">/* don&#39;t allow buffer to overflow */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">byte_count</span> <span class="o">&gt;</span> <span class="n">CIFSMaxBufSize</span> <span class="o">+</span> <span class="n">MAX_CIFS_HDR_SIZE</span> <span class="o">-</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cFYI</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;coalesced BCC exceeds buffer size (%u)&quot;</span><span class="p">,</span> <span class="n">byte_count</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOBUFS</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">target_hdr</span><span class="o">-&gt;</span><span class="n">smb_buf_length</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">byte_count</span><span class="p">);</span>

	<span class="cm">/* copy second buffer into end of first buffer */</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">data_area_of_tgt</span><span class="p">,</span> <span class="n">data_area_of_src</span><span class="p">,</span> <span class="n">total_in_src</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">remaining</span> <span class="o">!=</span> <span class="n">total_in_src</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* more responses to go */</span>
		<span class="n">cFYI</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;waiting for more secondary responses&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* we are done */</span>
	<span class="n">cFYI</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;found the last secondary response&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">cifs_echo_request</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">TCP_Server_Info</span> <span class="o">*</span><span class="n">server</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">TCP_Server_Info</span><span class="p">,</span> <span class="n">echo</span><span class="p">.</span><span class="n">work</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * We cannot send an echo until the NEGOTIATE_PROTOCOL request is</span>
<span class="cm">	 * done, which is indicated by maxBuf != 0. Also, no need to ping if</span>
<span class="cm">	 * we got a response recently</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">maxBuf</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span>
	    <span class="n">time_before</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">server</span><span class="o">-&gt;</span><span class="n">lstrp</span> <span class="o">+</span> <span class="n">SMB_ECHO_INTERVAL</span> <span class="o">-</span> <span class="n">HZ</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">requeue_echo</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">CIFSSMBEcho</span><span class="p">(</span><span class="n">server</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="n">cFYI</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;Unable to send echo request to server: %s&quot;</span><span class="p">,</span>
			<span class="n">server</span><span class="o">-&gt;</span><span class="n">hostname</span><span class="p">);</span>

<span class="nl">requeue_echo:</span>
	<span class="n">queue_delayed_work</span><span class="p">(</span><span class="n">cifsiod_wq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">echo</span><span class="p">,</span> <span class="n">SMB_ECHO_INTERVAL</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span>
<span class="nf">allocate_buffers</span><span class="p">(</span><span class="k">struct</span> <span class="n">TCP_Server_Info</span> <span class="o">*</span><span class="n">server</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">bigbuf</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">server</span><span class="o">-&gt;</span><span class="n">bigbuf</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">cifs_buf_get</span><span class="p">();</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">bigbuf</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">cERROR</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;No memory for large SMB response&quot;</span><span class="p">);</span>
			<span class="n">msleep</span><span class="p">(</span><span class="mi">3000</span><span class="p">);</span>
			<span class="cm">/* retry will check if exiting */</span>
			<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">large_buf</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* we are reusing a dirty large buf, clear its start */</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">bigbuf</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">HEADER_SIZE</span><span class="p">(</span><span class="n">server</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">smallbuf</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">server</span><span class="o">-&gt;</span><span class="n">smallbuf</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">cifs_small_buf_get</span><span class="p">();</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">smallbuf</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">cERROR</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;No memory for SMB response&quot;</span><span class="p">);</span>
			<span class="n">msleep</span><span class="p">(</span><span class="mi">1000</span><span class="p">);</span>
			<span class="cm">/* retry will check if exiting */</span>
			<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* beginning of smb buffer is cleared in our buf_get */</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* if existing small buf clear beginning */</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">smallbuf</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">HEADER_SIZE</span><span class="p">(</span><span class="n">server</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span>
<span class="nf">server_unresponsive</span><span class="p">(</span><span class="k">struct</span> <span class="n">TCP_Server_Info</span> <span class="o">*</span><span class="n">server</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/*</span>
<span class="cm">	 * We need to wait 2 echo intervals to make sure we handle such</span>
<span class="cm">	 * situations right:</span>
<span class="cm">	 * 1s  client sends a normal SMB request</span>
<span class="cm">	 * 2s  client gets a response</span>
<span class="cm">	 * 30s echo workqueue job pops, and decides we got a response recently</span>
<span class="cm">	 *     and don&#39;t need to send another</span>
<span class="cm">	 * ...</span>
<span class="cm">	 * 65s kernel_recvmsg times out, and we see that we haven&#39;t gotten</span>
<span class="cm">	 *     a response in &gt;60s.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">tcpStatus</span> <span class="o">==</span> <span class="n">CifsGood</span> <span class="o">&amp;&amp;</span>
	    <span class="n">time_after</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">server</span><span class="o">-&gt;</span><span class="n">lstrp</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">SMB_ECHO_INTERVAL</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">cERROR</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;Server %s has not responded in %d seconds. &quot;</span>
			  <span class="s">&quot;Reconnecting...&quot;</span><span class="p">,</span> <span class="n">server</span><span class="o">-&gt;</span><span class="n">hostname</span><span class="p">,</span>
			  <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">SMB_ECHO_INTERVAL</span><span class="p">)</span> <span class="o">/</span> <span class="n">HZ</span><span class="p">);</span>
		<span class="n">cifs_reconnect</span><span class="p">(</span><span class="n">server</span><span class="p">);</span>
		<span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">response_q</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * kvec_array_init - clone a kvec array, and advance into it</span>
<span class="cm"> * @new:	pointer to memory for cloned array</span>
<span class="cm"> * @iov:	pointer to original array</span>
<span class="cm"> * @nr_segs:	number of members in original array</span>
<span class="cm"> * @bytes:	number of bytes to advance into the cloned array</span>
<span class="cm"> *</span>
<span class="cm"> * This function will copy the array provided in iov to a section of memory</span>
<span class="cm"> * and advance the specified number of bytes into the new array. It returns</span>
<span class="cm"> * the number of segments in the new array. &quot;new&quot; must be at least as big as</span>
<span class="cm"> * the original iov array.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span>
<span class="nf">kvec_array_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvec</span> <span class="o">*</span><span class="n">new</span><span class="p">,</span> <span class="k">struct</span> <span class="n">kvec</span> <span class="o">*</span><span class="n">iov</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">nr_segs</span><span class="p">,</span>
		<span class="kt">size_t</span> <span class="n">bytes</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">size_t</span> <span class="n">base</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">bytes</span> <span class="o">||</span> <span class="o">!</span><span class="n">iov</span><span class="o">-&gt;</span><span class="n">iov_len</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">copy</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">bytes</span><span class="p">,</span> <span class="n">iov</span><span class="o">-&gt;</span><span class="n">iov_len</span><span class="p">);</span>

		<span class="n">bytes</span> <span class="o">-=</span> <span class="n">copy</span><span class="p">;</span>
		<span class="n">base</span> <span class="o">+=</span> <span class="n">copy</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">iov</span><span class="o">-&gt;</span><span class="n">iov_len</span> <span class="o">==</span> <span class="n">base</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">iov</span><span class="o">++</span><span class="p">;</span>
			<span class="n">nr_segs</span><span class="o">--</span><span class="p">;</span>
			<span class="n">base</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">new</span><span class="p">,</span> <span class="n">iov</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">iov</span><span class="p">)</span> <span class="o">*</span> <span class="n">nr_segs</span><span class="p">);</span>
	<span class="n">new</span><span class="o">-&gt;</span><span class="n">iov_base</span> <span class="o">+=</span> <span class="n">base</span><span class="p">;</span>
	<span class="n">new</span><span class="o">-&gt;</span><span class="n">iov_len</span> <span class="o">-=</span> <span class="n">base</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">nr_segs</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">kvec</span> <span class="o">*</span>
<span class="nf">get_server_iovec</span><span class="p">(</span><span class="k">struct</span> <span class="n">TCP_Server_Info</span> <span class="o">*</span><span class="n">server</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">nr_segs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">kvec</span> <span class="o">*</span><span class="n">new_iov</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">iov</span> <span class="o">&amp;&amp;</span> <span class="n">nr_segs</span> <span class="o">&lt;=</span> <span class="n">server</span><span class="o">-&gt;</span><span class="n">nr_iov</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">server</span><span class="o">-&gt;</span><span class="n">iov</span><span class="p">;</span>

	<span class="cm">/* not big enough -- allocate a new one and release the old */</span>
	<span class="n">new_iov</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">new_iov</span><span class="p">)</span> <span class="o">*</span> <span class="n">nr_segs</span><span class="p">,</span> <span class="n">GFP_NOFS</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">new_iov</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">iov</span><span class="p">);</span>
		<span class="n">server</span><span class="o">-&gt;</span><span class="n">iov</span> <span class="o">=</span> <span class="n">new_iov</span><span class="p">;</span>
		<span class="n">server</span><span class="o">-&gt;</span><span class="n">nr_iov</span> <span class="o">=</span> <span class="n">nr_segs</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">new_iov</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="nf">cifs_readv_from_socket</span><span class="p">(</span><span class="k">struct</span> <span class="n">TCP_Server_Info</span> <span class="o">*</span><span class="n">server</span><span class="p">,</span> <span class="k">struct</span> <span class="n">kvec</span> <span class="o">*</span><span class="n">iov_orig</span><span class="p">,</span>
		       <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">nr_segs</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">to_read</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">total_read</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">segs</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">msghdr</span> <span class="n">smb_msg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">kvec</span> <span class="o">*</span><span class="n">iov</span><span class="p">;</span>

	<span class="n">iov</span> <span class="o">=</span> <span class="n">get_server_iovec</span><span class="p">(</span><span class="n">server</span><span class="p">,</span> <span class="n">nr_segs</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">iov</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">smb_msg</span><span class="p">.</span><span class="n">msg_control</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">smb_msg</span><span class="p">.</span><span class="n">msg_controllen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">total_read</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">to_read</span><span class="p">;</span> <span class="n">total_read</span> <span class="o">+=</span> <span class="n">length</span><span class="p">,</span> <span class="n">to_read</span> <span class="o">-=</span> <span class="n">length</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">try_to_freeze</span><span class="p">();</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">server_unresponsive</span><span class="p">(</span><span class="n">server</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">total_read</span> <span class="o">=</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">segs</span> <span class="o">=</span> <span class="n">kvec_array_init</span><span class="p">(</span><span class="n">iov</span><span class="p">,</span> <span class="n">iov_orig</span><span class="p">,</span> <span class="n">nr_segs</span><span class="p">,</span> <span class="n">total_read</span><span class="p">);</span>

		<span class="n">length</span> <span class="o">=</span> <span class="n">kernel_recvmsg</span><span class="p">(</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">ssocket</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">smb_msg</span><span class="p">,</span>
					<span class="n">iov</span><span class="p">,</span> <span class="n">segs</span><span class="p">,</span> <span class="n">to_read</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">tcpStatus</span> <span class="o">==</span> <span class="n">CifsExiting</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">total_read</span> <span class="o">=</span> <span class="o">-</span><span class="n">ESHUTDOWN</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">tcpStatus</span> <span class="o">==</span> <span class="n">CifsNeedReconnect</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">cifs_reconnect</span><span class="p">(</span><span class="n">server</span><span class="p">);</span>
			<span class="n">total_read</span> <span class="o">=</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">length</span> <span class="o">==</span> <span class="o">-</span><span class="n">ERESTARTSYS</span> <span class="o">||</span>
			   <span class="n">length</span> <span class="o">==</span> <span class="o">-</span><span class="n">EAGAIN</span> <span class="o">||</span>
			   <span class="n">length</span> <span class="o">==</span> <span class="o">-</span><span class="n">EINTR</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * Minimum sleep to prevent looping, allowing socket</span>
<span class="cm">			 * to clear and app threads to set tcpStatus</span>
<span class="cm">			 * CifsNeedReconnect if server hung.</span>
<span class="cm">			 */</span>
			<span class="n">usleep_range</span><span class="p">(</span><span class="mi">1000</span><span class="p">,</span> <span class="mi">2000</span><span class="p">);</span>
			<span class="n">length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">length</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">cFYI</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;Received no data or error: expecting %d &quot;</span>
				<span class="s">&quot;got %d&quot;</span><span class="p">,</span> <span class="n">to_read</span><span class="p">,</span> <span class="n">length</span><span class="p">);</span>
			<span class="n">cifs_reconnect</span><span class="p">(</span><span class="n">server</span><span class="p">);</span>
			<span class="n">total_read</span> <span class="o">=</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">total_read</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="nf">cifs_read_from_socket</span><span class="p">(</span><span class="k">struct</span> <span class="n">TCP_Server_Info</span> <span class="o">*</span><span class="n">server</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span>
		      <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">to_read</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">kvec</span> <span class="n">iov</span><span class="p">;</span>

	<span class="n">iov</span><span class="p">.</span><span class="n">iov_base</span> <span class="o">=</span> <span class="n">buf</span><span class="p">;</span>
	<span class="n">iov</span><span class="p">.</span><span class="n">iov_len</span> <span class="o">=</span> <span class="n">to_read</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">cifs_readv_from_socket</span><span class="p">(</span><span class="n">server</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">iov</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">to_read</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span>
<span class="nf">is_smb_response</span><span class="p">(</span><span class="k">struct</span> <span class="n">TCP_Server_Info</span> <span class="o">*</span><span class="n">server</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/*</span>
<span class="cm">	 * The first byte big endian of the length field,</span>
<span class="cm">	 * is actually not part of the length but the type</span>
<span class="cm">	 * with the most common, zero, as regular data.</span>
<span class="cm">	 */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">RFC1002_SESSION_MESSAGE</span>:
		<span class="cm">/* Regular SMB response */</span>
		<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">RFC1002_SESSION_KEEP_ALIVE</span>:
		<span class="n">cFYI</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;RFC 1002 session keep alive&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">RFC1002_POSITIVE_SESSION_RESPONSE</span>:
		<span class="n">cFYI</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;RFC 1002 positive session response&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">RFC1002_NEGATIVE_SESSION_RESPONSE</span>:
		<span class="cm">/*</span>
<span class="cm">		 * We get this from Windows 98 instead of an error on</span>
<span class="cm">		 * SMB negprot response.</span>
<span class="cm">		 */</span>
		<span class="n">cFYI</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;RFC 1002 negative session response&quot;</span><span class="p">);</span>
		<span class="cm">/* give server a second to clean up */</span>
		<span class="n">msleep</span><span class="p">(</span><span class="mi">1000</span><span class="p">);</span>
		<span class="cm">/*</span>
<span class="cm">		 * Always try 445 first on reconnect since we get NACK</span>
<span class="cm">		 * on some if we ever connected to port 139 (the NACK</span>
<span class="cm">		 * is since we do not begin with RFC1001 session</span>
<span class="cm">		 * initialize frame).</span>
<span class="cm">		 */</span>
		<span class="n">cifs_set_port</span><span class="p">((</span><span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">dstaddr</span><span class="p">,</span> <span class="n">CIFS_PORT</span><span class="p">);</span>
		<span class="n">cifs_reconnect</span><span class="p">(</span><span class="n">server</span><span class="p">);</span>
		<span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">response_q</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">cERROR</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;RFC 1002 unknown response type 0x%x&quot;</span><span class="p">,</span> <span class="n">type</span><span class="p">);</span>
		<span class="n">cifs_reconnect</span><span class="p">(</span><span class="n">server</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">dequeue_mid</span><span class="p">(</span><span class="k">struct</span> <span class="n">mid_q_entry</span> <span class="o">*</span><span class="n">mid</span><span class="p">,</span> <span class="n">bool</span> <span class="n">malformed</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifdef CONFIG_CIFS_STATS2</span>
	<span class="n">mid</span><span class="o">-&gt;</span><span class="n">when_received</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">GlobalMid_Lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">malformed</span><span class="p">)</span>
		<span class="n">mid</span><span class="o">-&gt;</span><span class="n">mid_state</span> <span class="o">=</span> <span class="n">MID_RESPONSE_RECEIVED</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">mid</span><span class="o">-&gt;</span><span class="n">mid_state</span> <span class="o">=</span> <span class="n">MID_RESPONSE_MALFORMED</span><span class="p">;</span>
	<span class="n">list_del_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mid</span><span class="o">-&gt;</span><span class="n">qhead</span><span class="p">);</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">GlobalMid_Lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">handle_mid</span><span class="p">(</span><span class="k">struct</span> <span class="n">mid_q_entry</span> <span class="o">*</span><span class="n">mid</span><span class="p">,</span> <span class="k">struct</span> <span class="n">TCP_Server_Info</span> <span class="o">*</span><span class="n">server</span><span class="p">,</span>
	   <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">malformed</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">malformed</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">check2ndT2</span><span class="p">(</span><span class="n">buf</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mid</span><span class="o">-&gt;</span><span class="n">multiRsp</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mid</span><span class="o">-&gt;</span><span class="n">resp_buf</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* merge response - fix up 1st*/</span>
			<span class="n">malformed</span> <span class="o">=</span> <span class="n">coalesce_t2</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">mid</span><span class="o">-&gt;</span><span class="n">resp_buf</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">malformed</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">return</span><span class="p">;</span>

			<span class="cm">/* All parts received or packet is malformed. */</span>
			<span class="n">mid</span><span class="o">-&gt;</span><span class="n">multiEnd</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="k">return</span> <span class="n">dequeue_mid</span><span class="p">(</span><span class="n">mid</span><span class="p">,</span> <span class="n">malformed</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">large_buf</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/*FIXME: switch to already allocated largebuf?*/</span>
			<span class="n">cERROR</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;1st trans2 resp needs bigbuf&quot;</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* Have first buffer */</span>
			<span class="n">mid</span><span class="o">-&gt;</span><span class="n">resp_buf</span> <span class="o">=</span> <span class="n">buf</span><span class="p">;</span>
			<span class="n">mid</span><span class="o">-&gt;</span><span class="n">large_buf</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="n">server</span><span class="o">-&gt;</span><span class="n">bigbuf</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">mid</span><span class="o">-&gt;</span><span class="n">resp_buf</span> <span class="o">=</span> <span class="n">buf</span><span class="p">;</span>
	<span class="n">mid</span><span class="o">-&gt;</span><span class="n">large_buf</span> <span class="o">=</span> <span class="n">server</span><span class="o">-&gt;</span><span class="n">large_buf</span><span class="p">;</span>
	<span class="cm">/* Was previous buf put in mpx struct for multi-rsp? */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mid</span><span class="o">-&gt;</span><span class="n">multiRsp</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* smb buffer will be freed by user thread */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">large_buf</span><span class="p">)</span>
			<span class="n">server</span><span class="o">-&gt;</span><span class="n">bigbuf</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">server</span><span class="o">-&gt;</span><span class="n">smallbuf</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">dequeue_mid</span><span class="p">(</span><span class="n">mid</span><span class="p">,</span> <span class="n">malformed</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">clean_demultiplex_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">TCP_Server_Info</span> <span class="o">*</span><span class="n">server</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">length</span><span class="p">;</span>

	<span class="cm">/* take it off the list, if it&#39;s not already */</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cifs_tcp_ses_lock</span><span class="p">);</span>
	<span class="n">list_del_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">tcp_ses_list</span><span class="p">);</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cifs_tcp_ses_lock</span><span class="p">);</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">GlobalMid_Lock</span><span class="p">);</span>
	<span class="n">server</span><span class="o">-&gt;</span><span class="n">tcpStatus</span> <span class="o">=</span> <span class="n">CifsExiting</span><span class="p">;</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">GlobalMid_Lock</span><span class="p">);</span>
	<span class="n">wake_up_all</span><span class="p">(</span><span class="o">&amp;</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">response_q</span><span class="p">);</span>

	<span class="cm">/* check if we have blocked requests that need to free */</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">req_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">credits</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">server</span><span class="o">-&gt;</span><span class="n">credits</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">req_lock</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 * Although there should not be any requests blocked on this queue it</span>
<span class="cm">	 * can not hurt to be paranoid and try to wake up requests that may</span>
<span class="cm">	 * haven been blocked when more than 50 at time were on the wire to the</span>
<span class="cm">	 * same server - they now will see the session is in exit state and get</span>
<span class="cm">	 * out of SendReceive.</span>
<span class="cm">	 */</span>
	<span class="n">wake_up_all</span><span class="p">(</span><span class="o">&amp;</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">request_q</span><span class="p">);</span>
	<span class="cm">/* give those requests time to exit */</span>
	<span class="n">msleep</span><span class="p">(</span><span class="mi">125</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">ssocket</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sock_release</span><span class="p">(</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">ssocket</span><span class="p">);</span>
		<span class="n">server</span><span class="o">-&gt;</span><span class="n">ssocket</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">pending_mid_q</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">list_head</span> <span class="n">dispose_list</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">mid_q_entry</span> <span class="o">*</span><span class="n">mid_entry</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">tmp</span><span class="p">,</span> <span class="o">*</span><span class="n">tmp2</span><span class="p">;</span>

		<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dispose_list</span><span class="p">);</span>
		<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">GlobalMid_Lock</span><span class="p">);</span>
		<span class="n">list_for_each_safe</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="n">tmp2</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">pending_mid_q</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">mid_entry</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">mid_q_entry</span><span class="p">,</span> <span class="n">qhead</span><span class="p">);</span>
			<span class="n">cFYI</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;Clearing mid 0x%llx&quot;</span><span class="p">,</span> <span class="n">mid_entry</span><span class="o">-&gt;</span><span class="n">mid</span><span class="p">);</span>
			<span class="n">mid_entry</span><span class="o">-&gt;</span><span class="n">mid_state</span> <span class="o">=</span> <span class="n">MID_SHUTDOWN</span><span class="p">;</span>
			<span class="n">list_move</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mid_entry</span><span class="o">-&gt;</span><span class="n">qhead</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dispose_list</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">GlobalMid_Lock</span><span class="p">);</span>

		<span class="cm">/* now walk dispose list and issue callbacks */</span>
		<span class="n">list_for_each_safe</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="n">tmp2</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dispose_list</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">mid_entry</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">mid_q_entry</span><span class="p">,</span> <span class="n">qhead</span><span class="p">);</span>
			<span class="n">cFYI</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;Callback mid 0x%llx&quot;</span><span class="p">,</span> <span class="n">mid_entry</span><span class="o">-&gt;</span><span class="n">mid</span><span class="p">);</span>
			<span class="n">list_del_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mid_entry</span><span class="o">-&gt;</span><span class="n">qhead</span><span class="p">);</span>
			<span class="n">mid_entry</span><span class="o">-&gt;</span><span class="n">callback</span><span class="p">(</span><span class="n">mid_entry</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="cm">/* 1/8th of sec is more than enough time for them to exit */</span>
		<span class="n">msleep</span><span class="p">(</span><span class="mi">125</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">pending_mid_q</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * mpx threads have not exited yet give them at least the smb</span>
<span class="cm">		 * send timeout time for long ops.</span>
<span class="cm">		 *</span>
<span class="cm">		 * Due to delays on oplock break requests, we need to wait at</span>
<span class="cm">		 * least 45 seconds before giving up on a request getting a</span>
<span class="cm">		 * response and going ahead and killing cifsd.</span>
<span class="cm">		 */</span>
		<span class="n">cFYI</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;Wait for exit from demultiplex thread&quot;</span><span class="p">);</span>
		<span class="n">msleep</span><span class="p">(</span><span class="mi">46000</span><span class="p">);</span>
		<span class="cm">/*</span>
<span class="cm">		 * If threads still have not exited they are probably never</span>
<span class="cm">		 * coming home not much else we can do but free the memory.</span>
<span class="cm">		 */</span>
	<span class="p">}</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">hostname</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">iov</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">server</span><span class="p">);</span>

	<span class="n">length</span> <span class="o">=</span> <span class="n">atomic_dec_return</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tcpSesAllocCount</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">mempool_resize</span><span class="p">(</span><span class="n">cifs_req_poolp</span><span class="p">,</span> <span class="n">length</span> <span class="o">+</span> <span class="n">cifs_min_rcv</span><span class="p">,</span>
				<span class="n">GFP_KERNEL</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">standard_receive3</span><span class="p">(</span><span class="k">struct</span> <span class="n">TCP_Server_Info</span> <span class="o">*</span><span class="n">server</span><span class="p">,</span> <span class="k">struct</span> <span class="n">mid_q_entry</span> <span class="o">*</span><span class="n">mid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">length</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">buf</span> <span class="o">=</span> <span class="n">server</span><span class="o">-&gt;</span><span class="n">smallbuf</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">pdu_length</span> <span class="o">=</span> <span class="n">get_rfc1002_length</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>

	<span class="cm">/* make sure this will fit in a large buffer */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pdu_length</span> <span class="o">&gt;</span> <span class="n">CIFSMaxBufSize</span> <span class="o">+</span> <span class="n">MAX_HEADER_SIZE</span><span class="p">(</span><span class="n">server</span><span class="p">)</span> <span class="o">-</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cERROR</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;SMB response too long (%u bytes)&quot;</span><span class="p">,</span>
			<span class="n">pdu_length</span><span class="p">);</span>
		<span class="n">cifs_reconnect</span><span class="p">(</span><span class="n">server</span><span class="p">);</span>
		<span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">response_q</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* switch to large buffer if too big for a small one */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pdu_length</span> <span class="o">&gt;</span> <span class="n">MAX_CIFS_SMALL_BUFFER_SIZE</span> <span class="o">-</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">server</span><span class="o">-&gt;</span><span class="n">large_buf</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">bigbuf</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">server</span><span class="o">-&gt;</span><span class="n">total_read</span><span class="p">);</span>
		<span class="n">buf</span> <span class="o">=</span> <span class="n">server</span><span class="o">-&gt;</span><span class="n">bigbuf</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* now read the rest */</span>
	<span class="n">length</span> <span class="o">=</span> <span class="n">cifs_read_from_socket</span><span class="p">(</span><span class="n">server</span><span class="p">,</span> <span class="n">buf</span> <span class="o">+</span> <span class="n">HEADER_SIZE</span><span class="p">(</span><span class="n">server</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
				<span class="n">pdu_length</span> <span class="o">-</span> <span class="n">HEADER_SIZE</span><span class="p">(</span><span class="n">server</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">+</span> <span class="mi">4</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">length</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">length</span><span class="p">;</span>
	<span class="n">server</span><span class="o">-&gt;</span><span class="n">total_read</span> <span class="o">+=</span> <span class="n">length</span><span class="p">;</span>

	<span class="n">dump_smb</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">server</span><span class="o">-&gt;</span><span class="n">total_read</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * We know that we received enough to get to the MID as we</span>
<span class="cm">	 * checked the pdu_length earlier. Now check to see</span>
<span class="cm">	 * if the rest of the header is OK. We borrow the length</span>
<span class="cm">	 * var for the rest of the loop to avoid a new stack var.</span>
<span class="cm">	 *</span>
<span class="cm">	 * 48 bytes is enough to display the header and a little bit</span>
<span class="cm">	 * into the payload for debugging purposes.</span>
<span class="cm">	 */</span>
	<span class="n">length</span> <span class="o">=</span> <span class="n">server</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">check_message</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">server</span><span class="o">-&gt;</span><span class="n">total_read</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">length</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">cifs_dump_mem</span><span class="p">(</span><span class="s">&quot;Bad SMB: &quot;</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span>
			<span class="n">min_t</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">,</span> <span class="n">server</span><span class="o">-&gt;</span><span class="n">total_read</span><span class="p">,</span> <span class="mi">48</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mid</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">length</span><span class="p">;</span>

	<span class="n">handle_mid</span><span class="p">(</span><span class="n">mid</span><span class="p">,</span> <span class="n">server</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">length</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">cifs_demultiplex_thread</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">length</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">TCP_Server_Info</span> <span class="o">*</span><span class="n">server</span> <span class="o">=</span> <span class="n">p</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">pdu_length</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">buf</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">task_struct</span> <span class="o">*</span><span class="n">task_to_wake</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mid_q_entry</span> <span class="o">*</span><span class="n">mid_entry</span><span class="p">;</span>

	<span class="n">current</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">PF_MEMALLOC</span><span class="p">;</span>
	<span class="n">cFYI</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;Demultiplex PID: %d&quot;</span><span class="p">,</span> <span class="n">task_pid_nr</span><span class="p">(</span><span class="n">current</span><span class="p">));</span>

	<span class="n">length</span> <span class="o">=</span> <span class="n">atomic_inc_return</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tcpSesAllocCount</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">length</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">mempool_resize</span><span class="p">(</span><span class="n">cifs_req_poolp</span><span class="p">,</span> <span class="n">length</span> <span class="o">+</span> <span class="n">cifs_min_rcv</span><span class="p">,</span>
				<span class="n">GFP_KERNEL</span><span class="p">);</span>

	<span class="n">set_freezable</span><span class="p">();</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">tcpStatus</span> <span class="o">!=</span> <span class="n">CifsExiting</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">try_to_freeze</span><span class="p">())</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">allocate_buffers</span><span class="p">(</span><span class="n">server</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">server</span><span class="o">-&gt;</span><span class="n">large_buf</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="n">buf</span> <span class="o">=</span> <span class="n">server</span><span class="o">-&gt;</span><span class="n">smallbuf</span><span class="p">;</span>
		<span class="n">pdu_length</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span> <span class="cm">/* enough to get RFC1001 header */</span>

		<span class="n">length</span> <span class="o">=</span> <span class="n">cifs_read_from_socket</span><span class="p">(</span><span class="n">server</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">pdu_length</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">length</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">server</span><span class="o">-&gt;</span><span class="n">total_read</span> <span class="o">=</span> <span class="n">length</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * The right amount was read from socket - 4 bytes,</span>
<span class="cm">		 * so we can now interpret the length field.</span>
<span class="cm">		 */</span>
		<span class="n">pdu_length</span> <span class="o">=</span> <span class="n">get_rfc1002_length</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>

		<span class="n">cFYI</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;RFC1002 header 0x%x&quot;</span><span class="p">,</span> <span class="n">pdu_length</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_smb_response</span><span class="p">(</span><span class="n">server</span><span class="p">,</span> <span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="cm">/* make sure we have enough to get to the MID */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pdu_length</span> <span class="o">&lt;</span> <span class="n">HEADER_SIZE</span><span class="p">(</span><span class="n">server</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">-</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">cERROR</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;SMB response too short (%u bytes)&quot;</span><span class="p">,</span>
				<span class="n">pdu_length</span><span class="p">);</span>
			<span class="n">cifs_reconnect</span><span class="p">(</span><span class="n">server</span><span class="p">);</span>
			<span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">response_q</span><span class="p">);</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* read down to the MID */</span>
		<span class="n">length</span> <span class="o">=</span> <span class="n">cifs_read_from_socket</span><span class="p">(</span><span class="n">server</span><span class="p">,</span> <span class="n">buf</span> <span class="o">+</span> <span class="mi">4</span><span class="p">,</span>
					       <span class="n">HEADER_SIZE</span><span class="p">(</span><span class="n">server</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">-</span> <span class="mi">4</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">length</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">server</span><span class="o">-&gt;</span><span class="n">total_read</span> <span class="o">+=</span> <span class="n">length</span><span class="p">;</span>

		<span class="n">mid_entry</span> <span class="o">=</span> <span class="n">server</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">find_mid</span><span class="p">(</span><span class="n">server</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mid_entry</span> <span class="o">||</span> <span class="o">!</span><span class="n">mid_entry</span><span class="o">-&gt;</span><span class="n">receive</span><span class="p">)</span>
			<span class="n">length</span> <span class="o">=</span> <span class="n">standard_receive3</span><span class="p">(</span><span class="n">server</span><span class="p">,</span> <span class="n">mid_entry</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">length</span> <span class="o">=</span> <span class="n">mid_entry</span><span class="o">-&gt;</span><span class="n">receive</span><span class="p">(</span><span class="n">server</span><span class="p">,</span> <span class="n">mid_entry</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">length</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">large_buf</span><span class="p">)</span>
			<span class="n">buf</span> <span class="o">=</span> <span class="n">server</span><span class="o">-&gt;</span><span class="n">bigbuf</span><span class="p">;</span>

		<span class="n">server</span><span class="o">-&gt;</span><span class="n">lstrp</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mid_entry</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mid_entry</span><span class="o">-&gt;</span><span class="n">multiRsp</span> <span class="o">||</span> <span class="n">mid_entry</span><span class="o">-&gt;</span><span class="n">multiEnd</span><span class="p">)</span>
				<span class="n">mid_entry</span><span class="o">-&gt;</span><span class="n">callback</span><span class="p">(</span><span class="n">mid_entry</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">is_oplock_break</span> <span class="o">||</span>
			   <span class="o">!</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">is_oplock_break</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">server</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">cERROR</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;No task to wake, unknown frame received! &quot;</span>
				   <span class="s">&quot;NumMids %d&quot;</span><span class="p">,</span> <span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">midCount</span><span class="p">));</span>
			<span class="n">cifs_dump_mem</span><span class="p">(</span><span class="s">&quot;Received Data is: &quot;</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span>
				      <span class="n">HEADER_SIZE</span><span class="p">(</span><span class="n">server</span><span class="p">));</span>
<span class="cp">#ifdef CONFIG_CIFS_DEBUG2</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">dump_detail</span><span class="p">)</span>
				<span class="n">server</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">dump_detail</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
			<span class="n">cifs_dump_mids</span><span class="p">(</span><span class="n">server</span><span class="p">);</span>
<span class="cp">#endif </span><span class="cm">/* CIFS_DEBUG2 */</span><span class="cp"></span>

		<span class="p">}</span>
	<span class="p">}</span> <span class="cm">/* end while !EXITING */</span>

	<span class="cm">/* buffer usually freed in free_mid - need to free it here on exit */</span>
	<span class="n">cifs_buf_release</span><span class="p">(</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">bigbuf</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">smallbuf</span><span class="p">)</span> <span class="cm">/* no sense logging a debug message if NULL */</span>
		<span class="n">cifs_small_buf_release</span><span class="p">(</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">smallbuf</span><span class="p">);</span>

	<span class="n">task_to_wake</span> <span class="o">=</span> <span class="n">xchg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">tsk</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">clean_demultiplex_info</span><span class="p">(</span><span class="n">server</span><span class="p">);</span>

	<span class="cm">/* if server-&gt;tsk was NULL then wait for a signal before exiting */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">task_to_wake</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">set_current_state</span><span class="p">(</span><span class="n">TASK_INTERRUPTIBLE</span><span class="p">);</span>
		<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">signal_pending</span><span class="p">(</span><span class="n">current</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">schedule</span><span class="p">();</span>
			<span class="n">set_current_state</span><span class="p">(</span><span class="n">TASK_INTERRUPTIBLE</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">set_current_state</span><span class="p">(</span><span class="n">TASK_RUNNING</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">module_put_and_exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* extract the host portion of the UNC string */</span>
<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span>
<span class="nf">extract_hostname</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">unc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">src</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">dst</span><span class="p">,</span> <span class="o">*</span><span class="n">delim</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">len</span><span class="p">;</span>

	<span class="cm">/* skip double chars at beginning of string */</span>
	<span class="cm">/* BB: check validity of these bytes? */</span>
	<span class="n">src</span> <span class="o">=</span> <span class="n">unc</span> <span class="o">+</span> <span class="mi">2</span><span class="p">;</span>

	<span class="cm">/* delimiter between hostname and sharename is always &#39;\\&#39; now */</span>
	<span class="n">delim</span> <span class="o">=</span> <span class="n">strchr</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="sc">&#39;\\&#39;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">delim</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">EINVAL</span><span class="p">);</span>

	<span class="n">len</span> <span class="o">=</span> <span class="n">delim</span> <span class="o">-</span> <span class="n">src</span><span class="p">;</span>
	<span class="n">dst</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">((</span><span class="n">len</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dst</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">ENOMEM</span><span class="p">);</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="n">src</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
	<span class="n">dst</span><span class="p">[</span><span class="n">len</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">dst</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">get_option_ul</span><span class="p">(</span><span class="n">substring_t</span> <span class="n">args</span><span class="p">[],</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">option</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">string</span><span class="p">;</span>

	<span class="n">string</span> <span class="o">=</span> <span class="n">match_strdup</span><span class="p">(</span><span class="n">args</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">string</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">kstrtoul</span><span class="p">(</span><span class="n">string</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">option</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">string</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">cifs_parse_security_flavors</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">value</span><span class="p">,</span>
				       <span class="k">struct</span> <span class="n">smb_vol</span> <span class="o">*</span><span class="n">vol</span><span class="p">)</span>
<span class="p">{</span>

	<span class="n">substring_t</span> <span class="n">args</span><span class="p">[</span><span class="n">MAX_OPT_ARGS</span><span class="p">];</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">match_token</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">cifs_secflavor_tokens</span><span class="p">,</span> <span class="n">args</span><span class="p">))</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">Opt_sec_krb5</span>:
		<span class="n">vol</span><span class="o">-&gt;</span><span class="n">secFlg</span> <span class="o">|=</span> <span class="n">CIFSSEC_MAY_KRB5</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">Opt_sec_krb5i</span>:
		<span class="n">vol</span><span class="o">-&gt;</span><span class="n">secFlg</span> <span class="o">|=</span> <span class="n">CIFSSEC_MAY_KRB5</span> <span class="o">|</span> <span class="n">CIFSSEC_MUST_SIGN</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">Opt_sec_krb5p</span>:
		<span class="cm">/* vol-&gt;secFlg |= CIFSSEC_MUST_SEAL | CIFSSEC_MAY_KRB5; */</span>
		<span class="n">cERROR</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;Krb5 cifs privacy not supported&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">Opt_sec_ntlmssp</span>:
		<span class="n">vol</span><span class="o">-&gt;</span><span class="n">secFlg</span> <span class="o">|=</span> <span class="n">CIFSSEC_MAY_NTLMSSP</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">Opt_sec_ntlmsspi</span>:
		<span class="n">vol</span><span class="o">-&gt;</span><span class="n">secFlg</span> <span class="o">|=</span> <span class="n">CIFSSEC_MAY_NTLMSSP</span> <span class="o">|</span> <span class="n">CIFSSEC_MUST_SIGN</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">Opt_ntlm</span>:
		<span class="cm">/* ntlm is default so can be turned off too */</span>
		<span class="n">vol</span><span class="o">-&gt;</span><span class="n">secFlg</span> <span class="o">|=</span> <span class="n">CIFSSEC_MAY_NTLM</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">Opt_sec_ntlmi</span>:
		<span class="n">vol</span><span class="o">-&gt;</span><span class="n">secFlg</span> <span class="o">|=</span> <span class="n">CIFSSEC_MAY_NTLM</span> <span class="o">|</span> <span class="n">CIFSSEC_MUST_SIGN</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">Opt_sec_nontlm</span>:
		<span class="n">vol</span><span class="o">-&gt;</span><span class="n">secFlg</span> <span class="o">|=</span> <span class="n">CIFSSEC_MAY_NTLMV2</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">Opt_sec_ntlmv2i</span>:
		<span class="n">vol</span><span class="o">-&gt;</span><span class="n">secFlg</span> <span class="o">|=</span> <span class="n">CIFSSEC_MAY_NTLMV2</span> <span class="o">|</span> <span class="n">CIFSSEC_MUST_SIGN</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
<span class="cp">#ifdef CONFIG_CIFS_WEAK_PW_HASH</span>
	<span class="k">case</span> <span class="n">Opt_sec_lanman</span>:
		<span class="n">vol</span><span class="o">-&gt;</span><span class="n">secFlg</span> <span class="o">|=</span> <span class="n">CIFSSEC_MAY_LANMAN</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="k">case</span> <span class="n">Opt_sec_none</span>:
		<span class="n">vol</span><span class="o">-&gt;</span><span class="n">nullauth</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">cERROR</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;bad security option: %s&quot;</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">cifs_parse_cache_flavor</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">value</span><span class="p">,</span> <span class="k">struct</span> <span class="n">smb_vol</span> <span class="o">*</span><span class="n">vol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">substring_t</span> <span class="n">args</span><span class="p">[</span><span class="n">MAX_OPT_ARGS</span><span class="p">];</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">match_token</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">cifs_cacheflavor_tokens</span><span class="p">,</span> <span class="n">args</span><span class="p">))</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">Opt_cache_loose</span>:
		<span class="n">vol</span><span class="o">-&gt;</span><span class="n">direct_io</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="n">vol</span><span class="o">-&gt;</span><span class="n">strict_io</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">Opt_cache_strict</span>:
		<span class="n">vol</span><span class="o">-&gt;</span><span class="n">direct_io</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="n">vol</span><span class="o">-&gt;</span><span class="n">strict_io</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">Opt_cache_none</span>:
		<span class="n">vol</span><span class="o">-&gt;</span><span class="n">direct_io</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="n">vol</span><span class="o">-&gt;</span><span class="n">strict_io</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">cERROR</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;bad cache= option: %s&quot;</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">cifs_parse_smb_version</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">value</span><span class="p">,</span> <span class="k">struct</span> <span class="n">smb_vol</span> <span class="o">*</span><span class="n">vol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">substring_t</span> <span class="n">args</span><span class="p">[</span><span class="n">MAX_OPT_ARGS</span><span class="p">];</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">match_token</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">cifs_smb_version_tokens</span><span class="p">,</span> <span class="n">args</span><span class="p">))</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">Smb_1</span>:
		<span class="n">vol</span><span class="o">-&gt;</span><span class="n">ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">smb1_operations</span><span class="p">;</span>
		<span class="n">vol</span><span class="o">-&gt;</span><span class="n">vals</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">smb1_values</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
<span class="cp">#ifdef CONFIG_CIFS_SMB2</span>
	<span class="k">case</span> <span class="n">Smb_21</span>:
		<span class="n">vol</span><span class="o">-&gt;</span><span class="n">ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">smb21_operations</span><span class="p">;</span>
		<span class="n">vol</span><span class="o">-&gt;</span><span class="n">vals</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">smb21_values</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="nl">default:</span>
		<span class="n">cERROR</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;Unknown vers= option specified: %s&quot;</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">cifs_parse_mount_options</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">mountdata</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">devname</span><span class="p">,</span>
			 <span class="k">struct</span> <span class="n">smb_vol</span> <span class="o">*</span><span class="n">vol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="o">*</span><span class="n">end</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">mountdata_copy</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">*</span><span class="n">options</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>  <span class="n">temp_len</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">separator</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="kt">short</span> <span class="kt">int</span> <span class="n">override_uid</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="kt">short</span> <span class="kt">int</span> <span class="n">override_gid</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">uid_specified</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">gid_specified</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">sloppy</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">invalid</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">nodename</span> <span class="o">=</span> <span class="n">utsname</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">nodename</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">string</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">tmp_end</span><span class="p">,</span> <span class="o">*</span><span class="n">value</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">delim</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">cache_specified</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="k">static</span> <span class="n">bool</span> <span class="n">cache_warned</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="n">separator</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;,&#39;</span><span class="p">;</span>
	<span class="n">separator</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">delim</span> <span class="o">=</span> <span class="n">separator</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>

	<span class="cm">/*</span>
<span class="cm">	 * does not have to be perfect mapping since field is</span>
<span class="cm">	 * informational, only used for servers that do not support</span>
<span class="cm">	 * port 445 and it can be overridden at mount time</span>
<span class="cm">	 */</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">vol</span><span class="o">-&gt;</span><span class="n">source_rfc1001_name</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">,</span> <span class="n">RFC1001_NAME_LEN</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">strnlen</span><span class="p">(</span><span class="n">nodename</span><span class="p">,</span> <span class="n">RFC1001_NAME_LEN</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">vol</span><span class="o">-&gt;</span><span class="n">source_rfc1001_name</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">toupper</span><span class="p">(</span><span class="n">nodename</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

	<span class="n">vol</span><span class="o">-&gt;</span><span class="n">source_rfc1001_name</span><span class="p">[</span><span class="n">RFC1001_NAME_LEN</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="cm">/* null target name indicates to use *SMBSERVR default called name</span>
<span class="cm">	   if we end up sending RFC1001 session initialize */</span>
	<span class="n">vol</span><span class="o">-&gt;</span><span class="n">target_rfc1001_name</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">vol</span><span class="o">-&gt;</span><span class="n">cred_uid</span> <span class="o">=</span> <span class="n">current_uid</span><span class="p">();</span>
	<span class="n">vol</span><span class="o">-&gt;</span><span class="n">linux_uid</span> <span class="o">=</span> <span class="n">current_uid</span><span class="p">();</span>
	<span class="n">vol</span><span class="o">-&gt;</span><span class="n">linux_gid</span> <span class="o">=</span> <span class="n">current_gid</span><span class="p">();</span>

	<span class="cm">/* default to only allowing write access to owner of the mount */</span>
	<span class="n">vol</span><span class="o">-&gt;</span><span class="n">dir_mode</span> <span class="o">=</span> <span class="n">vol</span><span class="o">-&gt;</span><span class="n">file_mode</span> <span class="o">=</span> <span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IXUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">;</span>

	<span class="cm">/* vol-&gt;retry default is 0 (i.e. &quot;soft&quot; limited retry not hard retry) */</span>
	<span class="cm">/* default is always to request posix paths. */</span>
	<span class="n">vol</span><span class="o">-&gt;</span><span class="n">posix_paths</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="cm">/* default to using server inode numbers where available */</span>
	<span class="n">vol</span><span class="o">-&gt;</span><span class="n">server_ino</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">vol</span><span class="o">-&gt;</span><span class="n">actimeo</span> <span class="o">=</span> <span class="n">CIFS_DEF_ACTIMEO</span><span class="p">;</span>

	<span class="cm">/* FIXME: add autonegotiation -- for now, SMB1 is default */</span>
	<span class="n">vol</span><span class="o">-&gt;</span><span class="n">ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">smb1_operations</span><span class="p">;</span>
	<span class="n">vol</span><span class="o">-&gt;</span><span class="n">vals</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">smb1_values</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mountdata</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">cifs_parse_mount_err</span><span class="p">;</span>

	<span class="n">mountdata_copy</span> <span class="o">=</span> <span class="n">kstrndup</span><span class="p">(</span><span class="n">mountdata</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mountdata_copy</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">cifs_parse_mount_err</span><span class="p">;</span>

	<span class="n">options</span> <span class="o">=</span> <span class="n">mountdata_copy</span><span class="p">;</span>
	<span class="n">end</span> <span class="o">=</span> <span class="n">options</span> <span class="o">+</span> <span class="n">strlen</span><span class="p">(</span><span class="n">options</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">strncmp</span><span class="p">(</span><span class="n">options</span><span class="p">,</span> <span class="s">&quot;sep=&quot;</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">options</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">separator</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">options</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
			<span class="n">options</span> <span class="o">+=</span> <span class="mi">5</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">cFYI</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;Null separator not allowed&quot;</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">vol</span><span class="o">-&gt;</span><span class="n">backupuid_specified</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span> <span class="cm">/* no backup intent for a user */</span>
	<span class="n">vol</span><span class="o">-&gt;</span><span class="n">backupgid_specified</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span> <span class="cm">/* no backup intent for a group */</span>

	<span class="k">while</span> <span class="p">((</span><span class="n">data</span> <span class="o">=</span> <span class="n">strsep</span><span class="p">(</span><span class="o">&amp;</span><span class="n">options</span><span class="p">,</span> <span class="n">separator</span><span class="p">))</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">substring_t</span> <span class="n">args</span><span class="p">[</span><span class="n">MAX_OPT_ARGS</span><span class="p">];</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">option</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">token</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!*</span><span class="n">data</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">token</span> <span class="o">=</span> <span class="n">match_token</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">cifs_mount_option_tokens</span><span class="p">,</span> <span class="n">args</span><span class="p">);</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">token</span><span class="p">)</span> <span class="p">{</span>

		<span class="cm">/* Ingnore the following */</span>
		<span class="k">case</span> <span class="n">Opt_ignore</span>:
			<span class="k">break</span><span class="p">;</span>

		<span class="cm">/* Boolean values */</span>
		<span class="k">case</span> <span class="n">Opt_user_xattr</span>:
			<span class="n">vol</span><span class="o">-&gt;</span><span class="n">no_xattr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">Opt_nouser_xattr</span>:
			<span class="n">vol</span><span class="o">-&gt;</span><span class="n">no_xattr</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">Opt_forceuid</span>:
			<span class="n">override_uid</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">Opt_noforceuid</span>:
			<span class="n">override_uid</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">Opt_noblocksend</span>:
			<span class="n">vol</span><span class="o">-&gt;</span><span class="n">noblocksnd</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">Opt_noautotune</span>:
			<span class="n">vol</span><span class="o">-&gt;</span><span class="n">noautotune</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">Opt_hard</span>:
			<span class="n">vol</span><span class="o">-&gt;</span><span class="n">retry</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">Opt_soft</span>:
			<span class="n">vol</span><span class="o">-&gt;</span><span class="n">retry</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">Opt_perm</span>:
			<span class="n">vol</span><span class="o">-&gt;</span><span class="n">noperm</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">Opt_noperm</span>:
			<span class="n">vol</span><span class="o">-&gt;</span><span class="n">noperm</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">Opt_mapchars</span>:
			<span class="n">vol</span><span class="o">-&gt;</span><span class="n">remap</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">Opt_nomapchars</span>:
			<span class="n">vol</span><span class="o">-&gt;</span><span class="n">remap</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">Opt_sfu</span>:
			<span class="n">vol</span><span class="o">-&gt;</span><span class="n">sfu_emul</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">Opt_nosfu</span>:
			<span class="n">vol</span><span class="o">-&gt;</span><span class="n">sfu_emul</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">Opt_nodfs</span>:
			<span class="n">vol</span><span class="o">-&gt;</span><span class="n">nodfs</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">Opt_posixpaths</span>:
			<span class="n">vol</span><span class="o">-&gt;</span><span class="n">posix_paths</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">Opt_noposixpaths</span>:
			<span class="n">vol</span><span class="o">-&gt;</span><span class="n">posix_paths</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">Opt_nounix</span>:
			<span class="n">vol</span><span class="o">-&gt;</span><span class="n">no_linux_ext</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">Opt_nocase</span>:
			<span class="n">vol</span><span class="o">-&gt;</span><span class="n">nocase</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">Opt_brl</span>:
			<span class="n">vol</span><span class="o">-&gt;</span><span class="n">nobrl</span> <span class="o">=</span>  <span class="mi">0</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">Opt_nobrl</span>:
			<span class="n">vol</span><span class="o">-&gt;</span><span class="n">nobrl</span> <span class="o">=</span>  <span class="mi">1</span><span class="p">;</span>
			<span class="cm">/*</span>
<span class="cm">			 * turn off mandatory locking in mode</span>
<span class="cm">			 * if remote locking is turned off since the</span>
<span class="cm">			 * local vfs will do advisory</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">vol</span><span class="o">-&gt;</span><span class="n">file_mode</span> <span class="o">==</span>
				<span class="p">(</span><span class="n">S_IALLUGO</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">S_ISUID</span> <span class="o">|</span> <span class="n">S_IXGRP</span><span class="p">)))</span>
				<span class="n">vol</span><span class="o">-&gt;</span><span class="n">file_mode</span> <span class="o">=</span> <span class="n">S_IALLUGO</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">Opt_forcemandatorylock</span>:
			<span class="n">vol</span><span class="o">-&gt;</span><span class="n">mand_lock</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">Opt_setuids</span>:
			<span class="n">vol</span><span class="o">-&gt;</span><span class="n">setuids</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">Opt_nosetuids</span>:
			<span class="n">vol</span><span class="o">-&gt;</span><span class="n">setuids</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">Opt_dynperm</span>:
			<span class="n">vol</span><span class="o">-&gt;</span><span class="n">dynperm</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">Opt_nodynperm</span>:
			<span class="n">vol</span><span class="o">-&gt;</span><span class="n">dynperm</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">Opt_nohard</span>:
			<span class="n">vol</span><span class="o">-&gt;</span><span class="n">retry</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">Opt_nosoft</span>:
			<span class="n">vol</span><span class="o">-&gt;</span><span class="n">retry</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">Opt_nointr</span>:
			<span class="n">vol</span><span class="o">-&gt;</span><span class="n">intr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">Opt_intr</span>:
			<span class="n">vol</span><span class="o">-&gt;</span><span class="n">intr</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">Opt_nostrictsync</span>:
			<span class="n">vol</span><span class="o">-&gt;</span><span class="n">nostrictsync</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">Opt_strictsync</span>:
			<span class="n">vol</span><span class="o">-&gt;</span><span class="n">nostrictsync</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">Opt_serverino</span>:
			<span class="n">vol</span><span class="o">-&gt;</span><span class="n">server_ino</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">Opt_noserverino</span>:
			<span class="n">vol</span><span class="o">-&gt;</span><span class="n">server_ino</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">Opt_rwpidforward</span>:
			<span class="n">vol</span><span class="o">-&gt;</span><span class="n">rwpidforward</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">Opt_cifsacl</span>:
			<span class="n">vol</span><span class="o">-&gt;</span><span class="n">cifs_acl</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">Opt_nocifsacl</span>:
			<span class="n">vol</span><span class="o">-&gt;</span><span class="n">cifs_acl</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">Opt_acl</span>:
			<span class="n">vol</span><span class="o">-&gt;</span><span class="n">no_psx_acl</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">Opt_noacl</span>:
			<span class="n">vol</span><span class="o">-&gt;</span><span class="n">no_psx_acl</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">Opt_locallease</span>:
			<span class="n">vol</span><span class="o">-&gt;</span><span class="n">local_lease</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">Opt_sign</span>:
			<span class="n">vol</span><span class="o">-&gt;</span><span class="n">secFlg</span> <span class="o">|=</span> <span class="n">CIFSSEC_MUST_SIGN</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">Opt_seal</span>:
			<span class="cm">/* we do not do the following in secFlags because seal</span>
<span class="cm">			 * is a per tree connection (mount) not a per socket</span>
<span class="cm">			 * or per-smb connection option in the protocol</span>
<span class="cm">			 * vol-&gt;secFlg |= CIFSSEC_MUST_SEAL;</span>
<span class="cm">			 */</span>
			<span class="n">vol</span><span class="o">-&gt;</span><span class="n">seal</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">Opt_direct</span>:
			<span class="n">cache_specified</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="n">vol</span><span class="o">-&gt;</span><span class="n">direct_io</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="n">vol</span><span class="o">-&gt;</span><span class="n">strict_io</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
			<span class="n">cERROR</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;The </span><span class="se">\&quot;</span><span class="s">directio</span><span class="se">\&quot;</span><span class="s"> option will be removed in &quot;</span>
				  <span class="s">&quot;3.7. Please switch to the </span><span class="se">\&quot;</span><span class="s">cache=none</span><span class="se">\&quot;</span><span class="s"> &quot;</span>
				  <span class="s">&quot;option.&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">Opt_strictcache</span>:
			<span class="n">cache_specified</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="n">vol</span><span class="o">-&gt;</span><span class="n">direct_io</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
			<span class="n">vol</span><span class="o">-&gt;</span><span class="n">strict_io</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="n">cERROR</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;The </span><span class="se">\&quot;</span><span class="s">strictcache</span><span class="se">\&quot;</span><span class="s"> option will be removed &quot;</span>
				<span class="s">&quot;in 3.7. Please switch to the </span><span class="se">\&quot;</span><span class="s">cache=strict</span><span class="se">\&quot;</span><span class="s"> &quot;</span>
				<span class="s">&quot;option.&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">Opt_noac</span>:
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;CIFS: Mount option noac not &quot;</span>
				<span class="s">&quot;supported. Instead set &quot;</span>
				<span class="s">&quot;/proc/fs/cifs/LookupCacheEnabled to 0</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">Opt_fsc</span>:
<span class="cp">#ifndef CONFIG_CIFS_FSCACHE</span>
			<span class="n">cERROR</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;FS-Cache support needs CONFIG_CIFS_FSCACHE &quot;</span>
				  <span class="s">&quot;kernel config option set&quot;</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">cifs_parse_mount_err</span><span class="p">;</span>
<span class="cp">#endif</span>
			<span class="n">vol</span><span class="o">-&gt;</span><span class="n">fsc</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">Opt_mfsymlinks</span>:
			<span class="n">vol</span><span class="o">-&gt;</span><span class="n">mfsymlinks</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">Opt_multiuser</span>:
			<span class="n">vol</span><span class="o">-&gt;</span><span class="n">multiuser</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">Opt_sloppy</span>:
			<span class="n">sloppy</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="cm">/* Numeric Values */</span>
		<span class="k">case</span> <span class="n">Opt_backupuid</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">get_option_ul</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">option</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">cERROR</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;%s: Invalid backupuid value&quot;</span><span class="p">,</span>
					<span class="n">__func__</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">cifs_parse_mount_err</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">vol</span><span class="o">-&gt;</span><span class="n">backupuid</span> <span class="o">=</span> <span class="n">option</span><span class="p">;</span>
			<span class="n">vol</span><span class="o">-&gt;</span><span class="n">backupuid_specified</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">Opt_backupgid</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">get_option_ul</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">option</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">cERROR</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;%s: Invalid backupgid value&quot;</span><span class="p">,</span>
					<span class="n">__func__</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">cifs_parse_mount_err</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">vol</span><span class="o">-&gt;</span><span class="n">backupgid</span> <span class="o">=</span> <span class="n">option</span><span class="p">;</span>
			<span class="n">vol</span><span class="o">-&gt;</span><span class="n">backupgid_specified</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">Opt_uid</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">get_option_ul</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">option</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">cERROR</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;%s: Invalid uid value&quot;</span><span class="p">,</span>
					<span class="n">__func__</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">cifs_parse_mount_err</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">vol</span><span class="o">-&gt;</span><span class="n">linux_uid</span> <span class="o">=</span> <span class="n">option</span><span class="p">;</span>
			<span class="n">uid_specified</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">Opt_cruid</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">get_option_ul</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">option</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">cERROR</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;%s: Invalid cruid value&quot;</span><span class="p">,</span>
					<span class="n">__func__</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">cifs_parse_mount_err</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">vol</span><span class="o">-&gt;</span><span class="n">cred_uid</span> <span class="o">=</span> <span class="n">option</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">Opt_gid</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">get_option_ul</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">option</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">cERROR</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;%s: Invalid gid value&quot;</span><span class="p">,</span>
						<span class="n">__func__</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">cifs_parse_mount_err</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">vol</span><span class="o">-&gt;</span><span class="n">linux_gid</span> <span class="o">=</span> <span class="n">option</span><span class="p">;</span>
			<span class="n">gid_specified</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">Opt_file_mode</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">get_option_ul</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">option</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">cERROR</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;%s: Invalid file_mode value&quot;</span><span class="p">,</span>
					<span class="n">__func__</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">cifs_parse_mount_err</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">vol</span><span class="o">-&gt;</span><span class="n">file_mode</span> <span class="o">=</span> <span class="n">option</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">Opt_dirmode</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">get_option_ul</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">option</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">cERROR</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;%s: Invalid dir_mode value&quot;</span><span class="p">,</span>
					<span class="n">__func__</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">cifs_parse_mount_err</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">vol</span><span class="o">-&gt;</span><span class="n">dir_mode</span> <span class="o">=</span> <span class="n">option</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">Opt_port</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">get_option_ul</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">option</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">cERROR</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;%s: Invalid port value&quot;</span><span class="p">,</span>
					<span class="n">__func__</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">cifs_parse_mount_err</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">vol</span><span class="o">-&gt;</span><span class="n">port</span> <span class="o">=</span> <span class="n">option</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">Opt_rsize</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">get_option_ul</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">option</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">cERROR</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;%s: Invalid rsize value&quot;</span><span class="p">,</span>
					<span class="n">__func__</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">cifs_parse_mount_err</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">vol</span><span class="o">-&gt;</span><span class="n">rsize</span> <span class="o">=</span> <span class="n">option</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">Opt_wsize</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">get_option_ul</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">option</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">cERROR</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;%s: Invalid wsize value&quot;</span><span class="p">,</span>
					<span class="n">__func__</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">cifs_parse_mount_err</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">vol</span><span class="o">-&gt;</span><span class="n">wsize</span> <span class="o">=</span> <span class="n">option</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">Opt_actimeo</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">get_option_ul</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">option</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">cERROR</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;%s: Invalid actimeo value&quot;</span><span class="p">,</span>
					<span class="n">__func__</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">cifs_parse_mount_err</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">vol</span><span class="o">-&gt;</span><span class="n">actimeo</span> <span class="o">=</span> <span class="n">HZ</span> <span class="o">*</span> <span class="n">option</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">vol</span><span class="o">-&gt;</span><span class="n">actimeo</span> <span class="o">&gt;</span> <span class="n">CIFS_MAX_ACTIMEO</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">cERROR</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;CIFS: attribute cache&quot;</span>
					  <span class="s">&quot;timeout too large&quot;</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">cifs_parse_mount_err</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="cm">/* String Arguments */</span>

		<span class="k">case</span> <span class="n">Opt_blank_user</span>:
			<span class="cm">/* null user, ie. anonymous authentication */</span>
			<span class="n">vol</span><span class="o">-&gt;</span><span class="n">nullauth</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">vol</span><span class="o">-&gt;</span><span class="n">username</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">Opt_user</span>:
			<span class="n">string</span> <span class="o">=</span> <span class="n">match_strdup</span><span class="p">(</span><span class="n">args</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">string</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">out_nomem</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">strnlen</span><span class="p">(</span><span class="n">string</span><span class="p">,</span> <span class="n">MAX_USERNAME_SIZE</span><span class="p">)</span> <span class="o">&gt;</span>
							<span class="n">MAX_USERNAME_SIZE</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;CIFS: username too long</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">cifs_parse_mount_err</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">vol</span><span class="o">-&gt;</span><span class="n">username</span> <span class="o">=</span> <span class="n">kstrdup</span><span class="p">(</span><span class="n">string</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">vol</span><span class="o">-&gt;</span><span class="n">username</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;CIFS: no memory &quot;</span>
						    <span class="s">&quot;for username</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">cifs_parse_mount_err</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">Opt_blank_pass</span>:
			<span class="n">vol</span><span class="o">-&gt;</span><span class="n">password</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">Opt_pass</span>:
			<span class="cm">/* passwords have to be handled differently</span>
<span class="cm">			 * to allow the character used for deliminator</span>
<span class="cm">			 * to be passed within them</span>
<span class="cm">			 */</span>

			<span class="cm">/* Obtain the value string */</span>
			<span class="n">value</span> <span class="o">=</span> <span class="n">strchr</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="sc">&#39;=&#39;</span><span class="p">);</span>
			<span class="n">value</span><span class="o">++</span><span class="p">;</span>

			<span class="cm">/* Set tmp_end to end of the string */</span>
			<span class="n">tmp_end</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">value</span> <span class="o">+</span> <span class="n">strlen</span><span class="p">(</span><span class="n">value</span><span class="p">);</span>

			<span class="cm">/* Check if following character is the deliminator</span>
<span class="cm">			 * If yes, we have encountered a double deliminator</span>
<span class="cm">			 * reset the NULL character to the deliminator</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">tmp_end</span> <span class="o">&lt;</span> <span class="n">end</span> <span class="o">&amp;&amp;</span> <span class="n">tmp_end</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">delim</span><span class="p">)</span>
				<span class="n">tmp_end</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">delim</span><span class="p">;</span>

			<span class="cm">/* Keep iterating until we get to a single deliminator</span>
<span class="cm">			 * OR the end</span>
<span class="cm">			 */</span>
			<span class="k">while</span> <span class="p">((</span><span class="n">tmp_end</span> <span class="o">=</span> <span class="n">strchr</span><span class="p">(</span><span class="n">tmp_end</span><span class="p">,</span> <span class="n">delim</span><span class="p">))</span> <span class="o">!=</span> <span class="nb">NULL</span> <span class="o">&amp;&amp;</span>
			       <span class="p">(</span><span class="n">tmp_end</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">delim</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">tmp_end</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">tmp_end</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
			<span class="p">}</span>

			<span class="cm">/* Reset var options to point to next element */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">tmp_end</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">tmp_end</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
				<span class="n">options</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">tmp_end</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
			<span class="p">}</span> <span class="k">else</span>
				<span class="cm">/* Reached the end of the mount option string */</span>
				<span class="n">options</span> <span class="o">=</span> <span class="n">end</span><span class="p">;</span>

			<span class="cm">/* Now build new password string */</span>
			<span class="n">temp_len</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">value</span><span class="p">);</span>
			<span class="n">vol</span><span class="o">-&gt;</span><span class="n">password</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="n">temp_len</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">vol</span><span class="o">-&gt;</span><span class="n">password</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;CIFS: no memory &quot;</span>
						    <span class="s">&quot;for password</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">cifs_parse_mount_err</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">temp_len</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">vol</span><span class="o">-&gt;</span><span class="n">password</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
				<span class="k">if</span> <span class="p">((</span><span class="n">value</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">delim</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
				     <span class="n">value</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">delim</span><span class="p">)</span>
					<span class="cm">/* skip the second deliminator */</span>
					<span class="n">i</span><span class="o">++</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">vol</span><span class="o">-&gt;</span><span class="n">password</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">Opt_blank_ip</span>:
			<span class="n">vol</span><span class="o">-&gt;</span><span class="n">UNCip</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">Opt_ip</span>:
			<span class="n">string</span> <span class="o">=</span> <span class="n">match_strdup</span><span class="p">(</span><span class="n">args</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">string</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">out_nomem</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">strnlen</span><span class="p">(</span><span class="n">string</span><span class="p">,</span> <span class="n">INET6_ADDRSTRLEN</span><span class="p">)</span> <span class="o">&gt;</span>
						<span class="n">INET6_ADDRSTRLEN</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;CIFS: ip address &quot;</span>
						    <span class="s">&quot;too long</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">cifs_parse_mount_err</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">vol</span><span class="o">-&gt;</span><span class="n">UNCip</span> <span class="o">=</span> <span class="n">kstrdup</span><span class="p">(</span><span class="n">string</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">vol</span><span class="o">-&gt;</span><span class="n">UNCip</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;CIFS: no memory &quot;</span>
						    <span class="s">&quot;for UNC IP</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">cifs_parse_mount_err</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">Opt_unc</span>:
			<span class="n">string</span> <span class="o">=</span> <span class="n">match_strdup</span><span class="p">(</span><span class="n">args</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">string</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">out_nomem</span><span class="p">;</span>

			<span class="n">temp_len</span> <span class="o">=</span> <span class="n">strnlen</span><span class="p">(</span><span class="n">string</span><span class="p">,</span> <span class="mi">300</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">temp_len</span>  <span class="o">==</span> <span class="mi">300</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;CIFS: UNC name too long</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">cifs_parse_mount_err</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">vol</span><span class="o">-&gt;</span><span class="n">UNC</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">temp_len</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">vol</span><span class="o">-&gt;</span><span class="n">UNC</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;CIFS: no memory for UNC</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">cifs_parse_mount_err</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">strcpy</span><span class="p">(</span><span class="n">vol</span><span class="o">-&gt;</span><span class="n">UNC</span><span class="p">,</span> <span class="n">string</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">strncmp</span><span class="p">(</span><span class="n">string</span><span class="p">,</span> <span class="s">&quot;//&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">vol</span><span class="o">-&gt;</span><span class="n">UNC</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\\&#39;</span><span class="p">;</span>
				<span class="n">vol</span><span class="o">-&gt;</span><span class="n">UNC</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\\&#39;</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">strncmp</span><span class="p">(</span><span class="n">string</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\\\\</span><span class="s">&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;CIFS: UNC Path does not &quot;</span>
						    <span class="s">&quot;begin with // or </span><span class="se">\\\\\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">cifs_parse_mount_err</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">Opt_domain</span>:
			<span class="n">string</span> <span class="o">=</span> <span class="n">match_strdup</span><span class="p">(</span><span class="n">args</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">string</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">out_nomem</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">strnlen</span><span class="p">(</span><span class="n">string</span><span class="p">,</span> <span class="mi">256</span><span class="p">)</span> <span class="o">==</span> <span class="mi">256</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;CIFS: domain name too&quot;</span>
						    <span class="s">&quot; long</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">cifs_parse_mount_err</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">vol</span><span class="o">-&gt;</span><span class="n">domainname</span> <span class="o">=</span> <span class="n">kstrdup</span><span class="p">(</span><span class="n">string</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">vol</span><span class="o">-&gt;</span><span class="n">domainname</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;CIFS: no memory &quot;</span>
						    <span class="s">&quot;for domainname</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">cifs_parse_mount_err</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">cFYI</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;Domain name set&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">Opt_srcaddr</span>:
			<span class="n">string</span> <span class="o">=</span> <span class="n">match_strdup</span><span class="p">(</span><span class="n">args</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">string</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">out_nomem</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cifs_convert_address</span><span class="p">(</span>
					<span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">vol</span><span class="o">-&gt;</span><span class="n">srcaddr</span><span class="p">,</span>
					<span class="n">string</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="n">string</span><span class="p">)))</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;CIFS:  Could not parse&quot;</span>
						    <span class="s">&quot; srcaddr: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">string</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">cifs_parse_mount_err</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">Opt_prefixpath</span>:
			<span class="n">string</span> <span class="o">=</span> <span class="n">match_strdup</span><span class="p">(</span><span class="n">args</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">string</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">out_nomem</span><span class="p">;</span>

			<span class="n">temp_len</span> <span class="o">=</span> <span class="n">strnlen</span><span class="p">(</span><span class="n">string</span><span class="p">,</span> <span class="mi">1024</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">string</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="sc">&#39;/&#39;</span><span class="p">)</span>
				<span class="n">temp_len</span><span class="o">++</span><span class="p">;</span> <span class="cm">/* missing leading slash */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">temp_len</span> <span class="o">&gt;</span> <span class="mi">1024</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;CIFS: prefix too long</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">cifs_parse_mount_err</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">vol</span><span class="o">-&gt;</span><span class="n">prepath</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">temp_len</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">vol</span><span class="o">-&gt;</span><span class="n">prepath</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;CIFS: no memory &quot;</span>
						    <span class="s">&quot;for path prefix</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">cifs_parse_mount_err</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">string</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="sc">&#39;/&#39;</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">vol</span><span class="o">-&gt;</span><span class="n">prepath</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;/&#39;</span><span class="p">;</span>
				<span class="n">strcpy</span><span class="p">(</span><span class="n">vol</span><span class="o">-&gt;</span><span class="n">prepath</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">string</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span>
				<span class="n">strcpy</span><span class="p">(</span><span class="n">vol</span><span class="o">-&gt;</span><span class="n">prepath</span><span class="p">,</span> <span class="n">string</span><span class="p">);</span>

			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">Opt_iocharset</span>:
			<span class="n">string</span> <span class="o">=</span> <span class="n">match_strdup</span><span class="p">(</span><span class="n">args</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">string</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">out_nomem</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">strnlen</span><span class="p">(</span><span class="n">string</span><span class="p">,</span> <span class="mi">1024</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">65</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;CIFS: iocharset name &quot;</span>
						    <span class="s">&quot;too long.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">cifs_parse_mount_err</span><span class="p">;</span>
			<span class="p">}</span>

			 <span class="k">if</span> <span class="p">(</span><span class="n">strnicmp</span><span class="p">(</span><span class="n">string</span><span class="p">,</span> <span class="s">&quot;default&quot;</span><span class="p">,</span> <span class="mi">7</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">vol</span><span class="o">-&gt;</span><span class="n">iocharset</span> <span class="o">=</span> <span class="n">kstrdup</span><span class="p">(</span><span class="n">string</span><span class="p">,</span>
							 <span class="n">GFP_KERNEL</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">vol</span><span class="o">-&gt;</span><span class="n">iocharset</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;CIFS: no memory&quot;</span>
							    <span class="s">&quot;for charset</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
					<span class="k">goto</span> <span class="n">cifs_parse_mount_err</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="cm">/* if iocharset not set then load_nls_default</span>
<span class="cm">			 * is used by caller</span>
<span class="cm">			 */</span>
			<span class="n">cFYI</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;iocharset set to %s&quot;</span><span class="p">,</span> <span class="n">string</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">Opt_sockopt</span>:
			<span class="n">string</span> <span class="o">=</span> <span class="n">match_strdup</span><span class="p">(</span><span class="n">args</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">string</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">out_nomem</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">strnicmp</span><span class="p">(</span><span class="n">string</span><span class="p">,</span> <span class="s">&quot;TCP_NODELAY&quot;</span><span class="p">,</span> <span class="mi">11</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">vol</span><span class="o">-&gt;</span><span class="n">sockopt_tcp_nodelay</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">Opt_netbiosname</span>:
			<span class="n">string</span> <span class="o">=</span> <span class="n">match_strdup</span><span class="p">(</span><span class="n">args</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">string</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">out_nomem</span><span class="p">;</span>

			<span class="n">memset</span><span class="p">(</span><span class="n">vol</span><span class="o">-&gt;</span><span class="n">source_rfc1001_name</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">,</span>
				<span class="n">RFC1001_NAME_LEN</span><span class="p">);</span>
			<span class="cm">/*</span>
<span class="cm">			 * FIXME: are there cases in which a comma can</span>
<span class="cm">			 * be valid in workstation netbios name (and</span>
<span class="cm">			 * need special handling)?</span>
<span class="cm">			 */</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">RFC1001_NAME_LEN</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* don&#39;t ucase netbiosname for user */</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">string</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="n">vol</span><span class="o">-&gt;</span><span class="n">source_rfc1001_name</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">string</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
			<span class="p">}</span>
			<span class="cm">/* The string has 16th byte zero still from</span>
<span class="cm">			 * set at top of the function</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">RFC1001_NAME_LEN</span> <span class="o">&amp;&amp;</span> <span class="n">string</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;CIFS: netbiosname&quot;</span>
				       <span class="s">&quot; longer than 15 truncated.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">Opt_servern</span>:
			<span class="cm">/* servernetbiosname specified override *SMBSERVER */</span>
			<span class="n">string</span> <span class="o">=</span> <span class="n">match_strdup</span><span class="p">(</span><span class="n">args</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">string</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">out_nomem</span><span class="p">;</span>

			<span class="cm">/* last byte, type, is 0x20 for servr type */</span>
			<span class="n">memset</span><span class="p">(</span><span class="n">vol</span><span class="o">-&gt;</span><span class="n">target_rfc1001_name</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">,</span>
				<span class="n">RFC1001_NAME_LEN_WITH_NULL</span><span class="p">);</span>

			<span class="cm">/* BB are there cases in which a comma can be</span>
<span class="cm">			   valid in this workstation netbios name</span>
<span class="cm">			   (and need special handling)? */</span>

			<span class="cm">/* user or mount helper must uppercase the</span>
<span class="cm">			   netbios name */</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">15</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">string</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="n">vol</span><span class="o">-&gt;</span><span class="n">target_rfc1001_name</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">string</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
			<span class="p">}</span>
			<span class="cm">/* The string has 16th byte zero still from</span>
<span class="cm">			   set at top of the function  */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">RFC1001_NAME_LEN</span> <span class="o">&amp;&amp;</span> <span class="n">string</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;CIFS: server net&quot;</span>
				       <span class="s">&quot;biosname longer than 15 truncated.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">Opt_ver</span>:
			<span class="n">string</span> <span class="o">=</span> <span class="n">match_strdup</span><span class="p">(</span><span class="n">args</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">string</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">out_nomem</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">strnicmp</span><span class="p">(</span><span class="n">string</span><span class="p">,</span> <span class="s">&quot;1&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* This is the default */</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="cm">/* For all other value, error */</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;CIFS: Invalid version&quot;</span>
					    <span class="s">&quot; specified</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">cifs_parse_mount_err</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">Opt_vers</span>:
			<span class="n">string</span> <span class="o">=</span> <span class="n">match_strdup</span><span class="p">(</span><span class="n">args</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">string</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">out_nomem</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">cifs_parse_smb_version</span><span class="p">(</span><span class="n">string</span><span class="p">,</span> <span class="n">vol</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">cifs_parse_mount_err</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">Opt_sec</span>:
			<span class="n">string</span> <span class="o">=</span> <span class="n">match_strdup</span><span class="p">(</span><span class="n">args</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">string</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">out_nomem</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">cifs_parse_security_flavors</span><span class="p">(</span><span class="n">string</span><span class="p">,</span> <span class="n">vol</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">cifs_parse_mount_err</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">Opt_cache</span>:
			<span class="n">cache_specified</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="n">string</span> <span class="o">=</span> <span class="n">match_strdup</span><span class="p">(</span><span class="n">args</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">string</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">out_nomem</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">cifs_parse_cache_flavor</span><span class="p">(</span><span class="n">string</span><span class="p">,</span> <span class="n">vol</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">cifs_parse_mount_err</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="cm">/*</span>
<span class="cm">			 * An option we don&#39;t recognize. Save it off for later</span>
<span class="cm">			 * if we haven&#39;t already found one</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">invalid</span><span class="p">)</span>
				<span class="n">invalid</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* Free up any allocated string */</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">string</span><span class="p">);</span>
		<span class="n">string</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sloppy</span> <span class="o">&amp;&amp;</span> <span class="n">invalid</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;CIFS: Unknown mount option </span><span class="se">\&quot;</span><span class="s">%s</span><span class="se">\&quot;\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">invalid</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">cifs_parse_mount_err</span><span class="p">;</span>
	<span class="p">}</span>

<span class="cp">#ifndef CONFIG_KEYS</span>
	<span class="cm">/* Muliuser mounts require CONFIG_KEYS support */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vol</span><span class="o">-&gt;</span><span class="n">multiuser</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cERROR</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;Multiuser mounts require kernels with &quot;</span>
			  <span class="s">&quot;CONFIG_KEYS enabled.&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">cifs_parse_mount_err</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#endif</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vol</span><span class="o">-&gt;</span><span class="n">UNCip</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">vol</span><span class="o">-&gt;</span><span class="n">UNCip</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">vol</span><span class="o">-&gt;</span><span class="n">UNC</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">uid_specified</span><span class="p">)</span>
		<span class="n">vol</span><span class="o">-&gt;</span><span class="n">override_uid</span> <span class="o">=</span> <span class="n">override_uid</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">override_uid</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_NOTICE</span> <span class="s">&quot;CIFS: ignoring forceuid mount option &quot;</span>
				   <span class="s">&quot;specified with no uid= option.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">gid_specified</span><span class="p">)</span>
		<span class="n">vol</span><span class="o">-&gt;</span><span class="n">override_gid</span> <span class="o">=</span> <span class="n">override_gid</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">override_gid</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_NOTICE</span> <span class="s">&quot;CIFS: ignoring forcegid mount option &quot;</span>
				   <span class="s">&quot;specified with no gid= option.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/* FIXME: remove this block in 3.7 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cache_specified</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">cache_warned</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cache_warned</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_NOTICE</span> <span class="s">&quot;CIFS: no cache= option specified, using &quot;</span>
				   <span class="s">&quot;</span><span class="se">\&quot;</span><span class="s">cache=loose</span><span class="se">\&quot;</span><span class="s">. This default will change &quot;</span>
				   <span class="s">&quot;to </span><span class="se">\&quot;</span><span class="s">cache=strict</span><span class="se">\&quot;</span><span class="s"> in 3.7.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">mountdata_copy</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">out_nomem:</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;Could not allocate temporary buffer</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="nl">cifs_parse_mount_err:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">string</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">mountdata_copy</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/** Returns true if srcaddr isn&#39;t specified and rhs isn&#39;t</span>
<span class="cm"> * specified, or if srcaddr is specified and</span>
<span class="cm"> * matches the IP address of the rhs argument.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">bool</span>
<span class="nf">srcip_matches</span><span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="n">srcaddr</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="n">rhs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">srcaddr</span><span class="o">-&gt;</span><span class="n">sa_family</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">AF_UNSPEC</span>:
		<span class="k">return</span> <span class="p">(</span><span class="n">rhs</span><span class="o">-&gt;</span><span class="n">sa_family</span> <span class="o">==</span> <span class="n">AF_UNSPEC</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">AF_INET</span>: <span class="p">{</span>
		<span class="k">struct</span> <span class="n">sockaddr_in</span> <span class="o">*</span><span class="n">saddr4</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr_in</span> <span class="o">*</span><span class="p">)</span><span class="n">srcaddr</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">sockaddr_in</span> <span class="o">*</span><span class="n">vaddr4</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr_in</span> <span class="o">*</span><span class="p">)</span><span class="n">rhs</span><span class="p">;</span>
		<span class="k">return</span> <span class="p">(</span><span class="n">saddr4</span><span class="o">-&gt;</span><span class="n">sin_addr</span><span class="p">.</span><span class="n">s_addr</span> <span class="o">==</span> <span class="n">vaddr4</span><span class="o">-&gt;</span><span class="n">sin_addr</span><span class="p">.</span><span class="n">s_addr</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">case</span> <span class="n">AF_INET6</span>: <span class="p">{</span>
		<span class="k">struct</span> <span class="n">sockaddr_in6</span> <span class="o">*</span><span class="n">saddr6</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr_in6</span> <span class="o">*</span><span class="p">)</span><span class="n">srcaddr</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">sockaddr_in6</span> <span class="o">*</span><span class="n">vaddr6</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr_in6</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">rhs</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">ipv6_addr_equal</span><span class="p">(</span><span class="o">&amp;</span><span class="n">saddr6</span><span class="o">-&gt;</span><span class="n">sin6_addr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vaddr6</span><span class="o">-&gt;</span><span class="n">sin6_addr</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="nl">default:</span>
		<span class="n">WARN_ON</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span> <span class="cm">/* don&#39;t expect to be here */</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * If no port is specified in addr structure, we try to match with 445 port</span>
<span class="cm"> * and if it fails - with 139 ports. It should be called only if address</span>
<span class="cm"> * families of server and addr are equal.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">bool</span>
<span class="nf">match_port</span><span class="p">(</span><span class="k">struct</span> <span class="n">TCP_Server_Info</span> <span class="o">*</span><span class="n">server</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">__be16</span> <span class="n">port</span><span class="p">,</span> <span class="o">*</span><span class="n">sport</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">addr</span><span class="o">-&gt;</span><span class="n">sa_family</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">AF_INET</span>:
		<span class="n">sport</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">((</span><span class="k">struct</span> <span class="n">sockaddr_in</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">dstaddr</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">sin_port</span><span class="p">;</span>
		<span class="n">port</span> <span class="o">=</span> <span class="p">((</span><span class="k">struct</span> <span class="n">sockaddr_in</span> <span class="o">*</span><span class="p">)</span> <span class="n">addr</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">sin_port</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">AF_INET6</span>:
		<span class="n">sport</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">((</span><span class="k">struct</span> <span class="n">sockaddr_in6</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">dstaddr</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">sin6_port</span><span class="p">;</span>
		<span class="n">port</span> <span class="o">=</span> <span class="p">((</span><span class="k">struct</span> <span class="n">sockaddr_in6</span> <span class="o">*</span><span class="p">)</span> <span class="n">addr</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">sin6_port</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">WARN_ON</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">port</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">port</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="n">CIFS_PORT</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">port</span> <span class="o">==</span> <span class="o">*</span><span class="n">sport</span><span class="p">)</span>
			<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>

		<span class="n">port</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="n">RFC1001_PORT</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">port</span> <span class="o">==</span> <span class="o">*</span><span class="n">sport</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span>
<span class="nf">match_address</span><span class="p">(</span><span class="k">struct</span> <span class="n">TCP_Server_Info</span> <span class="o">*</span><span class="n">server</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="n">addr</span><span class="p">,</span>
	      <span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="n">srcaddr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">addr</span><span class="o">-&gt;</span><span class="n">sa_family</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">AF_INET</span>: <span class="p">{</span>
		<span class="k">struct</span> <span class="n">sockaddr_in</span> <span class="o">*</span><span class="n">addr4</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr_in</span> <span class="o">*</span><span class="p">)</span><span class="n">addr</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">sockaddr_in</span> <span class="o">*</span><span class="n">srv_addr4</span> <span class="o">=</span>
					<span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr_in</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">dstaddr</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">addr4</span><span class="o">-&gt;</span><span class="n">sin_addr</span><span class="p">.</span><span class="n">s_addr</span> <span class="o">!=</span> <span class="n">srv_addr4</span><span class="o">-&gt;</span><span class="n">sin_addr</span><span class="p">.</span><span class="n">s_addr</span><span class="p">)</span>
			<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">case</span> <span class="n">AF_INET6</span>: <span class="p">{</span>
		<span class="k">struct</span> <span class="n">sockaddr_in6</span> <span class="o">*</span><span class="n">addr6</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr_in6</span> <span class="o">*</span><span class="p">)</span><span class="n">addr</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">sockaddr_in6</span> <span class="o">*</span><span class="n">srv_addr6</span> <span class="o">=</span>
					<span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr_in6</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">dstaddr</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ipv6_addr_equal</span><span class="p">(</span><span class="o">&amp;</span><span class="n">addr6</span><span class="o">-&gt;</span><span class="n">sin6_addr</span><span class="p">,</span>
				     <span class="o">&amp;</span><span class="n">srv_addr6</span><span class="o">-&gt;</span><span class="n">sin6_addr</span><span class="p">))</span>
			<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">addr6</span><span class="o">-&gt;</span><span class="n">sin6_scope_id</span> <span class="o">!=</span> <span class="n">srv_addr6</span><span class="o">-&gt;</span><span class="n">sin6_scope_id</span><span class="p">)</span>
			<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="nl">default:</span>
		<span class="n">WARN_ON</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span> <span class="cm">/* don&#39;t expect to be here */</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">srcip_matches</span><span class="p">(</span><span class="n">srcaddr</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">srcaddr</span><span class="p">))</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>

	<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span>
<span class="nf">match_security</span><span class="p">(</span><span class="k">struct</span> <span class="n">TCP_Server_Info</span> <span class="o">*</span><span class="n">server</span><span class="p">,</span> <span class="k">struct</span> <span class="n">smb_vol</span> <span class="o">*</span><span class="n">vol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">secFlags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vol</span><span class="o">-&gt;</span><span class="n">secFlg</span> <span class="o">&amp;</span> <span class="p">(</span><span class="o">~</span><span class="p">(</span><span class="n">CIFSSEC_MUST_SIGN</span> <span class="o">|</span> <span class="n">CIFSSEC_MUST_SEAL</span><span class="p">)))</span>
		<span class="n">secFlags</span> <span class="o">=</span> <span class="n">vol</span><span class="o">-&gt;</span><span class="n">secFlg</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">secFlags</span> <span class="o">=</span> <span class="n">global_secflags</span> <span class="o">|</span> <span class="n">vol</span><span class="o">-&gt;</span><span class="n">secFlg</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">secType</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">LANMAN</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">secFlags</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">CIFSSEC_MAY_LANMAN</span><span class="o">|</span><span class="n">CIFSSEC_MAY_PLNTXT</span><span class="p">)))</span>
			<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">NTLMv2</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">secFlags</span> <span class="o">&amp;</span> <span class="n">CIFSSEC_MAY_NTLMV2</span><span class="p">))</span>
			<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">NTLM</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">secFlags</span> <span class="o">&amp;</span> <span class="n">CIFSSEC_MAY_NTLM</span><span class="p">))</span>
			<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">Kerberos</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">secFlags</span> <span class="o">&amp;</span> <span class="n">CIFSSEC_MAY_KRB5</span><span class="p">))</span>
			<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">RawNTLMSSP</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">secFlags</span> <span class="o">&amp;</span> <span class="n">CIFSSEC_MAY_NTLMSSP</span><span class="p">))</span>
			<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="cm">/* shouldn&#39;t happen */</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* now check if signing mode is acceptable */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">secFlags</span> <span class="o">&amp;</span> <span class="n">CIFSSEC_MAY_SIGN</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">sec_mode</span> <span class="o">&amp;</span> <span class="n">SECMODE_SIGN_REQUIRED</span><span class="p">))</span>
			<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(((</span><span class="n">secFlags</span> <span class="o">&amp;</span> <span class="n">CIFSSEC_MUST_SIGN</span><span class="p">)</span> <span class="o">==</span> <span class="n">CIFSSEC_MUST_SIGN</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		 <span class="p">(</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">sec_mode</span> <span class="o">&amp;</span>
		  <span class="p">(</span><span class="n">SECMODE_SIGN_ENABLED</span><span class="o">|</span><span class="n">SECMODE_SIGN_REQUIRED</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>

	<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">match_server</span><span class="p">(</span><span class="k">struct</span> <span class="n">TCP_Server_Info</span> <span class="o">*</span><span class="n">server</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="n">addr</span><span class="p">,</span>
			 <span class="k">struct</span> <span class="n">smb_vol</span> <span class="o">*</span><span class="n">vol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">vals</span> <span class="o">!=</span> <span class="n">vol</span><span class="o">-&gt;</span><span class="n">vals</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">ops</span> <span class="o">!=</span> <span class="n">vol</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">net_eq</span><span class="p">(</span><span class="n">cifs_net_ns</span><span class="p">(</span><span class="n">server</span><span class="p">),</span> <span class="n">current</span><span class="o">-&gt;</span><span class="n">nsproxy</span><span class="o">-&gt;</span><span class="n">net_ns</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">match_address</span><span class="p">(</span><span class="n">server</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span>
			   <span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">vol</span><span class="o">-&gt;</span><span class="n">srcaddr</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">match_port</span><span class="p">(</span><span class="n">server</span><span class="p">,</span> <span class="n">addr</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">match_security</span><span class="p">(</span><span class="n">server</span><span class="p">,</span> <span class="n">vol</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">TCP_Server_Info</span> <span class="o">*</span>
<span class="nf">cifs_find_tcp_session</span><span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="n">addr</span><span class="p">,</span> <span class="k">struct</span> <span class="n">smb_vol</span> <span class="o">*</span><span class="n">vol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">TCP_Server_Info</span> <span class="o">*</span><span class="n">server</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cifs_tcp_ses_lock</span><span class="p">);</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">server</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cifs_tcp_ses_list</span><span class="p">,</span> <span class="n">tcp_ses_list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">match_server</span><span class="p">(</span><span class="n">server</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">vol</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="o">++</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">srv_count</span><span class="p">;</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cifs_tcp_ses_lock</span><span class="p">);</span>
		<span class="n">cFYI</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;Existing tcp session with server found&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">server</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cifs_tcp_ses_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">cifs_put_tcp_session</span><span class="p">(</span><span class="k">struct</span> <span class="n">TCP_Server_Info</span> <span class="o">*</span><span class="n">server</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">task_struct</span> <span class="o">*</span><span class="n">task</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cifs_tcp_ses_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">--</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">srv_count</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cifs_tcp_ses_lock</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">put_net</span><span class="p">(</span><span class="n">cifs_net_ns</span><span class="p">(</span><span class="n">server</span><span class="p">));</span>

	<span class="n">list_del_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">tcp_ses_list</span><span class="p">);</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cifs_tcp_ses_lock</span><span class="p">);</span>

	<span class="n">cancel_delayed_work_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">echo</span><span class="p">);</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">GlobalMid_Lock</span><span class="p">);</span>
	<span class="n">server</span><span class="o">-&gt;</span><span class="n">tcpStatus</span> <span class="o">=</span> <span class="n">CifsExiting</span><span class="p">;</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">GlobalMid_Lock</span><span class="p">);</span>

	<span class="n">cifs_crypto_shash_release</span><span class="p">(</span><span class="n">server</span><span class="p">);</span>
	<span class="n">cifs_fscache_release_client_cookie</span><span class="p">(</span><span class="n">server</span><span class="p">);</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">session_key</span><span class="p">.</span><span class="n">response</span><span class="p">);</span>
	<span class="n">server</span><span class="o">-&gt;</span><span class="n">session_key</span><span class="p">.</span><span class="n">response</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">server</span><span class="o">-&gt;</span><span class="n">session_key</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">task</span> <span class="o">=</span> <span class="n">xchg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">tsk</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">task</span><span class="p">)</span>
		<span class="n">force_sig</span><span class="p">(</span><span class="n">SIGKILL</span><span class="p">,</span> <span class="n">task</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">TCP_Server_Info</span> <span class="o">*</span>
<span class="nf">cifs_get_tcp_session</span><span class="p">(</span><span class="k">struct</span> <span class="n">smb_vol</span> <span class="o">*</span><span class="n">volume_info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">TCP_Server_Info</span> <span class="o">*</span><span class="n">tcp_ses</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sockaddr_storage</span> <span class="n">addr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sockaddr_in</span> <span class="o">*</span><span class="n">sin_server</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr_in</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">addr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sockaddr_in6</span> <span class="o">*</span><span class="n">sin_server6</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr_in6</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">addr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">addr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr_storage</span><span class="p">));</span>

	<span class="n">cFYI</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;UNC: %s ip: %s&quot;</span><span class="p">,</span> <span class="n">volume_info</span><span class="o">-&gt;</span><span class="n">UNC</span><span class="p">,</span> <span class="n">volume_info</span><span class="o">-&gt;</span><span class="n">UNCip</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">volume_info</span><span class="o">-&gt;</span><span class="n">UNCip</span> <span class="o">&amp;&amp;</span> <span class="n">volume_info</span><span class="o">-&gt;</span><span class="n">UNC</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">cifs_fill_sockaddr</span><span class="p">((</span><span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">addr</span><span class="p">,</span>
					<span class="n">volume_info</span><span class="o">-&gt;</span><span class="n">UNCip</span><span class="p">,</span>
					<span class="n">strlen</span><span class="p">(</span><span class="n">volume_info</span><span class="o">-&gt;</span><span class="n">UNCip</span><span class="p">),</span>
					<span class="n">volume_info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* we failed translating address */</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out_err</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">volume_info</span><span class="o">-&gt;</span><span class="n">UNCip</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* BB using ip addr as tcp_ses name to connect to the</span>
<span class="cm">		   DFS root below */</span>
		<span class="n">cERROR</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;Connecting to DFS root not implemented yet&quot;</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out_err</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="cm">/* which tcp_sess DFS root would we conect to */</span> <span class="p">{</span>
		<span class="n">cERROR</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;CIFS mount error: No UNC path (e.g. -o &quot;</span>
			<span class="s">&quot;unc=//192.168.1.100/public) specified&quot;</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out_err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* see if we already have a matching tcp_ses */</span>
	<span class="n">tcp_ses</span> <span class="o">=</span> <span class="n">cifs_find_tcp_session</span><span class="p">((</span><span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">addr</span><span class="p">,</span> <span class="n">volume_info</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tcp_ses</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">tcp_ses</span><span class="p">;</span>

	<span class="n">tcp_ses</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">TCP_Server_Info</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tcp_ses</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out_err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">cifs_crypto_shash_allocate</span><span class="p">(</span><span class="n">tcp_ses</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cERROR</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;could not setup hash structures rc %d&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">tcp_ses</span><span class="o">-&gt;</span><span class="n">ops</span> <span class="o">=</span> <span class="n">volume_info</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">;</span>
	<span class="n">tcp_ses</span><span class="o">-&gt;</span><span class="n">vals</span> <span class="o">=</span> <span class="n">volume_info</span><span class="o">-&gt;</span><span class="n">vals</span><span class="p">;</span>
	<span class="n">cifs_set_net_ns</span><span class="p">(</span><span class="n">tcp_ses</span><span class="p">,</span> <span class="n">get_net</span><span class="p">(</span><span class="n">current</span><span class="o">-&gt;</span><span class="n">nsproxy</span><span class="o">-&gt;</span><span class="n">net_ns</span><span class="p">));</span>
	<span class="n">tcp_ses</span><span class="o">-&gt;</span><span class="n">hostname</span> <span class="o">=</span> <span class="n">extract_hostname</span><span class="p">(</span><span class="n">volume_info</span><span class="o">-&gt;</span><span class="n">UNC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">tcp_ses</span><span class="o">-&gt;</span><span class="n">hostname</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">tcp_ses</span><span class="o">-&gt;</span><span class="n">hostname</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_err_crypto_release</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">tcp_ses</span><span class="o">-&gt;</span><span class="n">noblocksnd</span> <span class="o">=</span> <span class="n">volume_info</span><span class="o">-&gt;</span><span class="n">noblocksnd</span><span class="p">;</span>
	<span class="n">tcp_ses</span><span class="o">-&gt;</span><span class="n">noautotune</span> <span class="o">=</span> <span class="n">volume_info</span><span class="o">-&gt;</span><span class="n">noautotune</span><span class="p">;</span>
	<span class="n">tcp_ses</span><span class="o">-&gt;</span><span class="n">tcp_nodelay</span> <span class="o">=</span> <span class="n">volume_info</span><span class="o">-&gt;</span><span class="n">sockopt_tcp_nodelay</span><span class="p">;</span>
	<span class="n">tcp_ses</span><span class="o">-&gt;</span><span class="n">in_flight</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">tcp_ses</span><span class="o">-&gt;</span><span class="n">credits</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">init_waitqueue_head</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tcp_ses</span><span class="o">-&gt;</span><span class="n">response_q</span><span class="p">);</span>
	<span class="n">init_waitqueue_head</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tcp_ses</span><span class="o">-&gt;</span><span class="n">request_q</span><span class="p">);</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tcp_ses</span><span class="o">-&gt;</span><span class="n">pending_mid_q</span><span class="p">);</span>
	<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tcp_ses</span><span class="o">-&gt;</span><span class="n">srv_mutex</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">tcp_ses</span><span class="o">-&gt;</span><span class="n">workstation_RFC1001_name</span><span class="p">,</span>
		<span class="n">volume_info</span><span class="o">-&gt;</span><span class="n">source_rfc1001_name</span><span class="p">,</span> <span class="n">RFC1001_NAME_LEN_WITH_NULL</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">tcp_ses</span><span class="o">-&gt;</span><span class="n">server_RFC1001_name</span><span class="p">,</span>
		<span class="n">volume_info</span><span class="o">-&gt;</span><span class="n">target_rfc1001_name</span><span class="p">,</span> <span class="n">RFC1001_NAME_LEN_WITH_NULL</span><span class="p">);</span>
	<span class="n">tcp_ses</span><span class="o">-&gt;</span><span class="n">session_estab</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">tcp_ses</span><span class="o">-&gt;</span><span class="n">sequence_number</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">tcp_ses</span><span class="o">-&gt;</span><span class="n">lstrp</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tcp_ses</span><span class="o">-&gt;</span><span class="n">req_lock</span><span class="p">);</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tcp_ses</span><span class="o">-&gt;</span><span class="n">tcp_ses_list</span><span class="p">);</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tcp_ses</span><span class="o">-&gt;</span><span class="n">smb_ses_list</span><span class="p">);</span>
	<span class="n">INIT_DELAYED_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tcp_ses</span><span class="o">-&gt;</span><span class="n">echo</span><span class="p">,</span> <span class="n">cifs_echo_request</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * at this point we are the only ones with the pointer</span>
<span class="cm">	 * to the struct since the kernel thread not created yet</span>
<span class="cm">	 * no need to spinlock this init of tcpStatus or srv_count</span>
<span class="cm">	 */</span>
	<span class="n">tcp_ses</span><span class="o">-&gt;</span><span class="n">tcpStatus</span> <span class="o">=</span> <span class="n">CifsNew</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tcp_ses</span><span class="o">-&gt;</span><span class="n">srcaddr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">volume_info</span><span class="o">-&gt;</span><span class="n">srcaddr</span><span class="p">,</span>
	       <span class="k">sizeof</span><span class="p">(</span><span class="n">tcp_ses</span><span class="o">-&gt;</span><span class="n">srcaddr</span><span class="p">));</span>
	<span class="o">++</span><span class="n">tcp_ses</span><span class="o">-&gt;</span><span class="n">srv_count</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">addr</span><span class="p">.</span><span class="n">ss_family</span> <span class="o">==</span> <span class="n">AF_INET6</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cFYI</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;attempting ipv6 connect&quot;</span><span class="p">);</span>
		<span class="cm">/* BB should we allow ipv6 on port 139? */</span>
		<span class="cm">/* other OS never observed in Wild doing 139 with v6 */</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tcp_ses</span><span class="o">-&gt;</span><span class="n">dstaddr</span><span class="p">,</span> <span class="n">sin_server6</span><span class="p">,</span>
		       <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr_in6</span><span class="p">));</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tcp_ses</span><span class="o">-&gt;</span><span class="n">dstaddr</span><span class="p">,</span> <span class="n">sin_server</span><span class="p">,</span>
		       <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr_in</span><span class="p">));</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">ip_connect</span><span class="p">(</span><span class="n">tcp_ses</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cERROR</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;Error connecting to socket. Aborting operation&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_err_crypto_release</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * since we&#39;re in a cifs function already, we know that</span>
<span class="cm">	 * this will succeed. No need for try_module_get().</span>
<span class="cm">	 */</span>
	<span class="n">__module_get</span><span class="p">(</span><span class="n">THIS_MODULE</span><span class="p">);</span>
	<span class="n">tcp_ses</span><span class="o">-&gt;</span><span class="n">tsk</span> <span class="o">=</span> <span class="n">kthread_run</span><span class="p">(</span><span class="n">cifs_demultiplex_thread</span><span class="p">,</span>
				  <span class="n">tcp_ses</span><span class="p">,</span> <span class="s">&quot;cifsd&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">tcp_ses</span><span class="o">-&gt;</span><span class="n">tsk</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">tcp_ses</span><span class="o">-&gt;</span><span class="n">tsk</span><span class="p">);</span>
		<span class="n">cERROR</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;error %d create cifsd thread&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
		<span class="n">module_put</span><span class="p">(</span><span class="n">THIS_MODULE</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_err_crypto_release</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">tcp_ses</span><span class="o">-&gt;</span><span class="n">tcpStatus</span> <span class="o">=</span> <span class="n">CifsNeedNegotiate</span><span class="p">;</span>

	<span class="cm">/* thread spawned, put it on the list */</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cifs_tcp_ses_lock</span><span class="p">);</span>
	<span class="n">list_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tcp_ses</span><span class="o">-&gt;</span><span class="n">tcp_ses_list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cifs_tcp_ses_list</span><span class="p">);</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cifs_tcp_ses_lock</span><span class="p">);</span>

	<span class="n">cifs_fscache_get_client_cookie</span><span class="p">(</span><span class="n">tcp_ses</span><span class="p">);</span>

	<span class="cm">/* queue echo request delayed work */</span>
	<span class="n">queue_delayed_work</span><span class="p">(</span><span class="n">cifsiod_wq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tcp_ses</span><span class="o">-&gt;</span><span class="n">echo</span><span class="p">,</span> <span class="n">SMB_ECHO_INTERVAL</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">tcp_ses</span><span class="p">;</span>

<span class="nl">out_err_crypto_release:</span>
	<span class="n">cifs_crypto_shash_release</span><span class="p">(</span><span class="n">tcp_ses</span><span class="p">);</span>

	<span class="n">put_net</span><span class="p">(</span><span class="n">cifs_net_ns</span><span class="p">(</span><span class="n">tcp_ses</span><span class="p">));</span>

<span class="nl">out_err:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tcp_ses</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">tcp_ses</span><span class="o">-&gt;</span><span class="n">hostname</span><span class="p">))</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">tcp_ses</span><span class="o">-&gt;</span><span class="n">hostname</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tcp_ses</span><span class="o">-&gt;</span><span class="n">ssocket</span><span class="p">)</span>
			<span class="n">sock_release</span><span class="p">(</span><span class="n">tcp_ses</span><span class="o">-&gt;</span><span class="n">ssocket</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">tcp_ses</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="n">rc</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">match_session</span><span class="p">(</span><span class="k">struct</span> <span class="n">cifs_ses</span> <span class="o">*</span><span class="n">ses</span><span class="p">,</span> <span class="k">struct</span> <span class="n">smb_vol</span> <span class="o">*</span><span class="n">vol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">ses</span><span class="o">-&gt;</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">secType</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">Kerberos</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">vol</span><span class="o">-&gt;</span><span class="n">cred_uid</span> <span class="o">!=</span> <span class="n">ses</span><span class="o">-&gt;</span><span class="n">cred_uid</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="cm">/* NULL username means anonymous session */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ses</span><span class="o">-&gt;</span><span class="n">user_name</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">vol</span><span class="o">-&gt;</span><span class="n">nullauth</span><span class="p">)</span>
				<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* anything else takes username/password */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">strncmp</span><span class="p">(</span><span class="n">ses</span><span class="o">-&gt;</span><span class="n">user_name</span><span class="p">,</span>
			    <span class="n">vol</span><span class="o">-&gt;</span><span class="n">username</span> <span class="o">?</span> <span class="n">vol</span><span class="o">-&gt;</span><span class="n">username</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
			    <span class="n">MAX_USERNAME_SIZE</span><span class="p">))</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">strlen</span><span class="p">(</span><span class="n">vol</span><span class="o">-&gt;</span><span class="n">username</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
		    <span class="n">ses</span><span class="o">-&gt;</span><span class="n">password</span> <span class="o">!=</span> <span class="nb">NULL</span> <span class="o">&amp;&amp;</span>
		    <span class="n">strncmp</span><span class="p">(</span><span class="n">ses</span><span class="o">-&gt;</span><span class="n">password</span><span class="p">,</span>
			    <span class="n">vol</span><span class="o">-&gt;</span><span class="n">password</span> <span class="o">?</span> <span class="n">vol</span><span class="o">-&gt;</span><span class="n">password</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
			    <span class="n">MAX_PASSWORD_SIZE</span><span class="p">))</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">cifs_ses</span> <span class="o">*</span>
<span class="nf">cifs_find_smb_ses</span><span class="p">(</span><span class="k">struct</span> <span class="n">TCP_Server_Info</span> <span class="o">*</span><span class="n">server</span><span class="p">,</span> <span class="k">struct</span> <span class="n">smb_vol</span> <span class="o">*</span><span class="n">vol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cifs_ses</span> <span class="o">*</span><span class="n">ses</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cifs_tcp_ses_lock</span><span class="p">);</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">ses</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">smb_ses_list</span><span class="p">,</span> <span class="n">smb_ses_list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">match_session</span><span class="p">(</span><span class="n">ses</span><span class="p">,</span> <span class="n">vol</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="o">++</span><span class="n">ses</span><span class="o">-&gt;</span><span class="n">ses_count</span><span class="p">;</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cifs_tcp_ses_lock</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ses</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cifs_tcp_ses_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">cifs_put_smb_ses</span><span class="p">(</span><span class="k">struct</span> <span class="n">cifs_ses</span> <span class="o">*</span><span class="n">ses</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">xid</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">TCP_Server_Info</span> <span class="o">*</span><span class="n">server</span> <span class="o">=</span> <span class="n">ses</span><span class="o">-&gt;</span><span class="n">server</span><span class="p">;</span>

	<span class="n">cFYI</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;%s: ses_count=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">ses</span><span class="o">-&gt;</span><span class="n">ses_count</span><span class="p">);</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cifs_tcp_ses_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">--</span><span class="n">ses</span><span class="o">-&gt;</span><span class="n">ses_count</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cifs_tcp_ses_lock</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">list_del_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ses</span><span class="o">-&gt;</span><span class="n">smb_ses_list</span><span class="p">);</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cifs_tcp_ses_lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ses</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">==</span> <span class="n">CifsGood</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">xid</span> <span class="o">=</span> <span class="n">GetXid</span><span class="p">();</span>
		<span class="n">CIFSSMBLogoff</span><span class="p">(</span><span class="n">xid</span><span class="p">,</span> <span class="n">ses</span><span class="p">);</span>
		<span class="n">_FreeXid</span><span class="p">(</span><span class="n">xid</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">sesInfoFree</span><span class="p">(</span><span class="n">ses</span><span class="p">);</span>
	<span class="n">cifs_put_tcp_session</span><span class="p">(</span><span class="n">server</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_KEYS</span>

<span class="cm">/* strlen(&quot;cifs:a:&quot;) + INET6_ADDRSTRLEN + 1 */</span>
<span class="cp">#define CIFSCREDS_DESC_SIZE (7 + INET6_ADDRSTRLEN + 1)</span>

<span class="cm">/* Populate username and pw fields from keyring if possible */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">cifs_set_cifscreds</span><span class="p">(</span><span class="k">struct</span> <span class="n">smb_vol</span> <span class="o">*</span><span class="n">vol</span><span class="p">,</span> <span class="k">struct</span> <span class="n">cifs_ses</span> <span class="o">*</span><span class="n">ses</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">desc</span><span class="p">,</span> <span class="o">*</span><span class="n">delim</span><span class="p">,</span> <span class="o">*</span><span class="n">payload</span><span class="p">;</span>
	<span class="kt">ssize_t</span> <span class="n">len</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">key</span> <span class="o">*</span><span class="n">key</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">TCP_Server_Info</span> <span class="o">*</span><span class="n">server</span> <span class="o">=</span> <span class="n">ses</span><span class="o">-&gt;</span><span class="n">server</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sockaddr_in</span> <span class="o">*</span><span class="n">sa</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sockaddr_in6</span> <span class="o">*</span><span class="n">sa6</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">user_key_payload</span> <span class="o">*</span><span class="n">upayload</span><span class="p">;</span>

	<span class="n">desc</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">CIFSCREDS_DESC_SIZE</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">desc</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="cm">/* try to find an address key first */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">dstaddr</span><span class="p">.</span><span class="n">ss_family</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">AF_INET</span>:
		<span class="n">sa</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr_in</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">dstaddr</span><span class="p">;</span>
		<span class="n">sprintf</span><span class="p">(</span><span class="n">desc</span><span class="p">,</span> <span class="s">&quot;cifs:a:%pI4&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sa</span><span class="o">-&gt;</span><span class="n">sin_addr</span><span class="p">.</span><span class="n">s_addr</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">AF_INET6</span>:
		<span class="n">sa6</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr_in6</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">dstaddr</span><span class="p">;</span>
		<span class="n">sprintf</span><span class="p">(</span><span class="n">desc</span><span class="p">,</span> <span class="s">&quot;cifs:a:%pI6c&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sa6</span><span class="o">-&gt;</span><span class="n">sin6_addr</span><span class="p">.</span><span class="n">s6_addr</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">cFYI</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;Bad ss_family (%hu)&quot;</span><span class="p">,</span> <span class="n">server</span><span class="o">-&gt;</span><span class="n">dstaddr</span><span class="p">.</span><span class="n">ss_family</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out_err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">cFYI</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;%s: desc=%s&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">desc</span><span class="p">);</span>
	<span class="n">key</span> <span class="o">=</span> <span class="n">request_key</span><span class="p">(</span><span class="o">&amp;</span><span class="n">key_type_logon</span><span class="p">,</span> <span class="n">desc</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">key</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ses</span><span class="o">-&gt;</span><span class="n">domainName</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">cFYI</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;domainName is NULL&quot;</span><span class="p">);</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">key</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">out_err</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* didn&#39;t work, try to find a domain key */</span>
		<span class="n">sprintf</span><span class="p">(</span><span class="n">desc</span><span class="p">,</span> <span class="s">&quot;cifs:d:%s&quot;</span><span class="p">,</span> <span class="n">ses</span><span class="o">-&gt;</span><span class="n">domainName</span><span class="p">);</span>
		<span class="n">cFYI</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;%s: desc=%s&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">desc</span><span class="p">);</span>
		<span class="n">key</span> <span class="o">=</span> <span class="n">request_key</span><span class="p">(</span><span class="o">&amp;</span><span class="n">key_type_logon</span><span class="p">,</span> <span class="n">desc</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">key</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">key</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">out_err</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">down_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">key</span><span class="o">-&gt;</span><span class="n">sem</span><span class="p">);</span>
	<span class="n">upayload</span> <span class="o">=</span> <span class="n">key</span><span class="o">-&gt;</span><span class="n">payload</span><span class="p">.</span><span class="n">data</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR_OR_NULL</span><span class="p">(</span><span class="n">upayload</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">upayload</span> <span class="o">?</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">upayload</span><span class="p">)</span> <span class="o">:</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out_key_put</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* find first : in payload */</span>
	<span class="n">payload</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">upayload</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="n">delim</span> <span class="o">=</span> <span class="n">strnchr</span><span class="p">(</span><span class="n">payload</span><span class="p">,</span> <span class="n">upayload</span><span class="o">-&gt;</span><span class="n">datalen</span><span class="p">,</span> <span class="sc">&#39;:&#39;</span><span class="p">);</span>
	<span class="n">cFYI</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;payload=%s&quot;</span><span class="p">,</span> <span class="n">payload</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">delim</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cFYI</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;Unable to find &#39;:&#39; in payload (datalen=%d)&quot;</span><span class="p">,</span>
				<span class="n">upayload</span><span class="o">-&gt;</span><span class="n">datalen</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out_key_put</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">len</span> <span class="o">=</span> <span class="n">delim</span> <span class="o">-</span> <span class="n">payload</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;</span> <span class="n">MAX_USERNAME_SIZE</span> <span class="o">||</span> <span class="n">len</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cFYI</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;Bad value from username search (len=%zd)&quot;</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out_key_put</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">vol</span><span class="o">-&gt;</span><span class="n">username</span> <span class="o">=</span> <span class="n">kstrndup</span><span class="p">(</span><span class="n">payload</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">vol</span><span class="o">-&gt;</span><span class="n">username</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cFYI</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;Unable to allocate %zd bytes for username&quot;</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out_key_put</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">cFYI</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;%s: username=%s&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">vol</span><span class="o">-&gt;</span><span class="n">username</span><span class="p">);</span>

	<span class="n">len</span> <span class="o">=</span> <span class="n">key</span><span class="o">-&gt;</span><span class="n">datalen</span> <span class="o">-</span> <span class="p">(</span><span class="n">len</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;</span> <span class="n">MAX_PASSWORD_SIZE</span> <span class="o">||</span> <span class="n">len</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cFYI</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;Bad len for password search (len=%zd)&quot;</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">vol</span><span class="o">-&gt;</span><span class="n">username</span><span class="p">);</span>
		<span class="n">vol</span><span class="o">-&gt;</span><span class="n">username</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out_key_put</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="o">++</span><span class="n">delim</span><span class="p">;</span>
	<span class="n">vol</span><span class="o">-&gt;</span><span class="n">password</span> <span class="o">=</span> <span class="n">kstrndup</span><span class="p">(</span><span class="n">delim</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">vol</span><span class="o">-&gt;</span><span class="n">password</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cFYI</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;Unable to allocate %zd bytes for password&quot;</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">vol</span><span class="o">-&gt;</span><span class="n">username</span><span class="p">);</span>
		<span class="n">vol</span><span class="o">-&gt;</span><span class="n">username</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out_key_put</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">out_key_put:</span>
	<span class="n">up_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">key</span><span class="o">-&gt;</span><span class="n">sem</span><span class="p">);</span>
	<span class="n">key_put</span><span class="p">(</span><span class="n">key</span><span class="p">);</span>
<span class="nl">out_err:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">desc</span><span class="p">);</span>
	<span class="n">cFYI</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;%s: returning %d&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#else </span><span class="cm">/* ! CONFIG_KEYS */</span><span class="cp"></span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span>
<span class="nf">cifs_set_cifscreds</span><span class="p">(</span><span class="k">struct</span> <span class="n">smb_vol</span> <span class="o">*</span><span class="n">vol</span> <span class="n">__attribute__</span><span class="p">((</span><span class="n">unused</span><span class="p">)),</span>
		   <span class="k">struct</span> <span class="n">cifs_ses</span> <span class="o">*</span><span class="n">ses</span> <span class="n">__attribute__</span><span class="p">((</span><span class="n">unused</span><span class="p">)))</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENOSYS</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_KEYS */</span><span class="cp"></span>

<span class="k">static</span> <span class="n">bool</span> <span class="n">warned_on_ntlm</span><span class="p">;</span>  <span class="cm">/* globals init to false automatically */</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">cifs_ses</span> <span class="o">*</span>
<span class="nf">cifs_get_smb_ses</span><span class="p">(</span><span class="k">struct</span> <span class="n">TCP_Server_Info</span> <span class="o">*</span><span class="n">server</span><span class="p">,</span> <span class="k">struct</span> <span class="n">smb_vol</span> <span class="o">*</span><span class="n">volume_info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">,</span> <span class="n">xid</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cifs_ses</span> <span class="o">*</span><span class="n">ses</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sockaddr_in</span> <span class="o">*</span><span class="n">addr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr_in</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">dstaddr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sockaddr_in6</span> <span class="o">*</span><span class="n">addr6</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr_in6</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">dstaddr</span><span class="p">;</span>

	<span class="n">xid</span> <span class="o">=</span> <span class="n">GetXid</span><span class="p">();</span>

	<span class="n">ses</span> <span class="o">=</span> <span class="n">cifs_find_smb_ses</span><span class="p">(</span><span class="n">server</span><span class="p">,</span> <span class="n">volume_info</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ses</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cFYI</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;Existing smb sess found (status=%d)&quot;</span><span class="p">,</span> <span class="n">ses</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>

		<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ses</span><span class="o">-&gt;</span><span class="n">session_mutex</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">cifs_negotiate_protocol</span><span class="p">(</span><span class="n">xid</span><span class="p">,</span> <span class="n">ses</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ses</span><span class="o">-&gt;</span><span class="n">session_mutex</span><span class="p">);</span>
			<span class="cm">/* problem -- put our ses reference */</span>
			<span class="n">cifs_put_smb_ses</span><span class="p">(</span><span class="n">ses</span><span class="p">);</span>
			<span class="n">FreeXid</span><span class="p">(</span><span class="n">xid</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="n">rc</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ses</span><span class="o">-&gt;</span><span class="n">need_reconnect</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">cFYI</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;Session needs reconnect&quot;</span><span class="p">);</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="n">cifs_setup_session</span><span class="p">(</span><span class="n">xid</span><span class="p">,</span> <span class="n">ses</span><span class="p">,</span>
						<span class="n">volume_info</span><span class="o">-&gt;</span><span class="n">local_nls</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ses</span><span class="o">-&gt;</span><span class="n">session_mutex</span><span class="p">);</span>
				<span class="cm">/* problem -- put our reference */</span>
				<span class="n">cifs_put_smb_ses</span><span class="p">(</span><span class="n">ses</span><span class="p">);</span>
				<span class="n">FreeXid</span><span class="p">(</span><span class="n">xid</span><span class="p">);</span>
				<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="n">rc</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ses</span><span class="o">-&gt;</span><span class="n">session_mutex</span><span class="p">);</span>

		<span class="cm">/* existing SMB ses has a server reference already */</span>
		<span class="n">cifs_put_tcp_session</span><span class="p">(</span><span class="n">server</span><span class="p">);</span>
		<span class="n">FreeXid</span><span class="p">(</span><span class="n">xid</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ses</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">cFYI</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;Existing smb sess not found&quot;</span><span class="p">);</span>
	<span class="n">ses</span> <span class="o">=</span> <span class="n">sesInfoAlloc</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ses</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">get_ses_fail</span><span class="p">;</span>

	<span class="cm">/* new SMB session uses our server ref */</span>
	<span class="n">ses</span><span class="o">-&gt;</span><span class="n">server</span> <span class="o">=</span> <span class="n">server</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">dstaddr</span><span class="p">.</span><span class="n">ss_family</span> <span class="o">==</span> <span class="n">AF_INET6</span><span class="p">)</span>
		<span class="n">sprintf</span><span class="p">(</span><span class="n">ses</span><span class="o">-&gt;</span><span class="n">serverName</span><span class="p">,</span> <span class="s">&quot;%pI6&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">addr6</span><span class="o">-&gt;</span><span class="n">sin6_addr</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">sprintf</span><span class="p">(</span><span class="n">ses</span><span class="o">-&gt;</span><span class="n">serverName</span><span class="p">,</span> <span class="s">&quot;%pI4&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">addr</span><span class="o">-&gt;</span><span class="n">sin_addr</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">volume_info</span><span class="o">-&gt;</span><span class="n">username</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ses</span><span class="o">-&gt;</span><span class="n">user_name</span> <span class="o">=</span> <span class="n">kstrdup</span><span class="p">(</span><span class="n">volume_info</span><span class="o">-&gt;</span><span class="n">username</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ses</span><span class="o">-&gt;</span><span class="n">user_name</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">get_ses_fail</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* volume_info-&gt;password freed at unmount */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">volume_info</span><span class="o">-&gt;</span><span class="n">password</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ses</span><span class="o">-&gt;</span><span class="n">password</span> <span class="o">=</span> <span class="n">kstrdup</span><span class="p">(</span><span class="n">volume_info</span><span class="o">-&gt;</span><span class="n">password</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ses</span><span class="o">-&gt;</span><span class="n">password</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">get_ses_fail</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">volume_info</span><span class="o">-&gt;</span><span class="n">domainname</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ses</span><span class="o">-&gt;</span><span class="n">domainName</span> <span class="o">=</span> <span class="n">kstrdup</span><span class="p">(</span><span class="n">volume_info</span><span class="o">-&gt;</span><span class="n">domainname</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ses</span><span class="o">-&gt;</span><span class="n">domainName</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">get_ses_fail</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ses</span><span class="o">-&gt;</span><span class="n">cred_uid</span> <span class="o">=</span> <span class="n">volume_info</span><span class="o">-&gt;</span><span class="n">cred_uid</span><span class="p">;</span>
	<span class="n">ses</span><span class="o">-&gt;</span><span class="n">linux_uid</span> <span class="o">=</span> <span class="n">volume_info</span><span class="o">-&gt;</span><span class="n">linux_uid</span><span class="p">;</span>

	<span class="cm">/* ntlmv2 is much stronger than ntlm security, and has been broadly</span>
<span class="cm">	supported for many years, time to update default security mechanism */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">volume_info</span><span class="o">-&gt;</span><span class="n">secFlg</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">warned_on_ntlm</span> <span class="o">==</span> <span class="nb">false</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">warned_on_ntlm</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="n">cERROR</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;default security mechanism requested.  The default &quot;</span>
			<span class="s">&quot;security mechanism will be upgraded from ntlm to &quot;</span>
			<span class="s">&quot;ntlmv2 in kernel release 3.3&quot;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">ses</span><span class="o">-&gt;</span><span class="n">overrideSecFlg</span> <span class="o">=</span> <span class="n">volume_info</span><span class="o">-&gt;</span><span class="n">secFlg</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ses</span><span class="o">-&gt;</span><span class="n">session_mutex</span><span class="p">);</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">cifs_negotiate_protocol</span><span class="p">(</span><span class="n">xid</span><span class="p">,</span> <span class="n">ses</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rc</span><span class="p">)</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">cifs_setup_session</span><span class="p">(</span><span class="n">xid</span><span class="p">,</span> <span class="n">ses</span><span class="p">,</span> <span class="n">volume_info</span><span class="o">-&gt;</span><span class="n">local_nls</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ses</span><span class="o">-&gt;</span><span class="n">session_mutex</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">get_ses_fail</span><span class="p">;</span>

	<span class="cm">/* success, put it on the list */</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cifs_tcp_ses_lock</span><span class="p">);</span>
	<span class="n">list_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ses</span><span class="o">-&gt;</span><span class="n">smb_ses_list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">smb_ses_list</span><span class="p">);</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cifs_tcp_ses_lock</span><span class="p">);</span>

	<span class="n">FreeXid</span><span class="p">(</span><span class="n">xid</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ses</span><span class="p">;</span>

<span class="nl">get_ses_fail:</span>
	<span class="n">sesInfoFree</span><span class="p">(</span><span class="n">ses</span><span class="p">);</span>
	<span class="n">FreeXid</span><span class="p">(</span><span class="n">xid</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="n">rc</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">match_tcon</span><span class="p">(</span><span class="k">struct</span> <span class="n">cifs_tcon</span> <span class="o">*</span><span class="n">tcon</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">unc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tcon</span><span class="o">-&gt;</span><span class="n">tidStatus</span> <span class="o">==</span> <span class="n">CifsExiting</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">strncmp</span><span class="p">(</span><span class="n">tcon</span><span class="o">-&gt;</span><span class="n">treeName</span><span class="p">,</span> <span class="n">unc</span><span class="p">,</span> <span class="n">MAX_TREE_SIZE</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">cifs_tcon</span> <span class="o">*</span>
<span class="nf">cifs_find_tcon</span><span class="p">(</span><span class="k">struct</span> <span class="n">cifs_ses</span> <span class="o">*</span><span class="n">ses</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">unc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">tmp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cifs_tcon</span> <span class="o">*</span><span class="n">tcon</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cifs_tcp_ses_lock</span><span class="p">);</span>
	<span class="n">list_for_each</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ses</span><span class="o">-&gt;</span><span class="n">tcon_list</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tcon</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">cifs_tcon</span><span class="p">,</span> <span class="n">tcon_list</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">match_tcon</span><span class="p">(</span><span class="n">tcon</span><span class="p">,</span> <span class="n">unc</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="o">++</span><span class="n">tcon</span><span class="o">-&gt;</span><span class="n">tc_count</span><span class="p">;</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cifs_tcp_ses_lock</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">tcon</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cifs_tcp_ses_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">cifs_put_tcon</span><span class="p">(</span><span class="k">struct</span> <span class="n">cifs_tcon</span> <span class="o">*</span><span class="n">tcon</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">xid</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cifs_ses</span> <span class="o">*</span><span class="n">ses</span> <span class="o">=</span> <span class="n">tcon</span><span class="o">-&gt;</span><span class="n">ses</span><span class="p">;</span>

	<span class="n">cFYI</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;%s: tc_count=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">tcon</span><span class="o">-&gt;</span><span class="n">tc_count</span><span class="p">);</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cifs_tcp_ses_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">--</span><span class="n">tcon</span><span class="o">-&gt;</span><span class="n">tc_count</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cifs_tcp_ses_lock</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">list_del_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tcon</span><span class="o">-&gt;</span><span class="n">tcon_list</span><span class="p">);</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cifs_tcp_ses_lock</span><span class="p">);</span>

	<span class="n">xid</span> <span class="o">=</span> <span class="n">GetXid</span><span class="p">();</span>
	<span class="n">CIFSSMBTDis</span><span class="p">(</span><span class="n">xid</span><span class="p">,</span> <span class="n">tcon</span><span class="p">);</span>
	<span class="n">_FreeXid</span><span class="p">(</span><span class="n">xid</span><span class="p">);</span>

	<span class="n">cifs_fscache_release_super_cookie</span><span class="p">(</span><span class="n">tcon</span><span class="p">);</span>
	<span class="n">tconInfoFree</span><span class="p">(</span><span class="n">tcon</span><span class="p">);</span>
	<span class="n">cifs_put_smb_ses</span><span class="p">(</span><span class="n">ses</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">cifs_tcon</span> <span class="o">*</span>
<span class="nf">cifs_get_tcon</span><span class="p">(</span><span class="k">struct</span> <span class="n">cifs_ses</span> <span class="o">*</span><span class="n">ses</span><span class="p">,</span> <span class="k">struct</span> <span class="n">smb_vol</span> <span class="o">*</span><span class="n">volume_info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">,</span> <span class="n">xid</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cifs_tcon</span> <span class="o">*</span><span class="n">tcon</span><span class="p">;</span>

	<span class="n">tcon</span> <span class="o">=</span> <span class="n">cifs_find_tcon</span><span class="p">(</span><span class="n">ses</span><span class="p">,</span> <span class="n">volume_info</span><span class="o">-&gt;</span><span class="n">UNC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tcon</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cFYI</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;Found match on UNC path&quot;</span><span class="p">);</span>
		<span class="cm">/* existing tcon already has a reference */</span>
		<span class="n">cifs_put_smb_ses</span><span class="p">(</span><span class="n">ses</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tcon</span><span class="o">-&gt;</span><span class="n">seal</span> <span class="o">!=</span> <span class="n">volume_info</span><span class="o">-&gt;</span><span class="n">seal</span><span class="p">)</span>
			<span class="n">cERROR</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;transport encryption setting &quot;</span>
				   <span class="s">&quot;conflicts with existing tid&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">tcon</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">tcon</span> <span class="o">=</span> <span class="n">tconInfoAlloc</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tcon</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out_fail</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">tcon</span><span class="o">-&gt;</span><span class="n">ses</span> <span class="o">=</span> <span class="n">ses</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">volume_info</span><span class="o">-&gt;</span><span class="n">password</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tcon</span><span class="o">-&gt;</span><span class="n">password</span> <span class="o">=</span> <span class="n">kstrdup</span><span class="p">(</span><span class="n">volume_info</span><span class="o">-&gt;</span><span class="n">password</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tcon</span><span class="o">-&gt;</span><span class="n">password</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out_fail</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">strchr</span><span class="p">(</span><span class="n">volume_info</span><span class="o">-&gt;</span><span class="n">UNC</span> <span class="o">+</span> <span class="mi">3</span><span class="p">,</span> <span class="sc">&#39;\\&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="nb">NULL</span>
	    <span class="o">&amp;&amp;</span> <span class="n">strchr</span><span class="p">(</span><span class="n">volume_info</span><span class="o">-&gt;</span><span class="n">UNC</span> <span class="o">+</span> <span class="mi">3</span><span class="p">,</span> <span class="sc">&#39;/&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cERROR</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;Missing share name&quot;</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out_fail</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* BB Do we need to wrap session_mutex around</span>
<span class="cm">	 * this TCon call and Unix SetFS as</span>
<span class="cm">	 * we do on SessSetup and reconnect? */</span>
	<span class="n">xid</span> <span class="o">=</span> <span class="n">GetXid</span><span class="p">();</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">CIFSTCon</span><span class="p">(</span><span class="n">xid</span><span class="p">,</span> <span class="n">ses</span><span class="p">,</span> <span class="n">volume_info</span><span class="o">-&gt;</span><span class="n">UNC</span><span class="p">,</span> <span class="n">tcon</span><span class="p">,</span> <span class="n">volume_info</span><span class="o">-&gt;</span><span class="n">local_nls</span><span class="p">);</span>
	<span class="n">FreeXid</span><span class="p">(</span><span class="n">xid</span><span class="p">);</span>
	<span class="n">cFYI</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;CIFS Tcon rc = %d&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_fail</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">volume_info</span><span class="o">-&gt;</span><span class="n">nodfs</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tcon</span><span class="o">-&gt;</span><span class="n">Flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SMB_SHARE_IS_IN_DFS</span><span class="p">;</span>
		<span class="n">cFYI</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;DFS disabled (%d)&quot;</span><span class="p">,</span> <span class="n">tcon</span><span class="o">-&gt;</span><span class="n">Flags</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">tcon</span><span class="o">-&gt;</span><span class="n">seal</span> <span class="o">=</span> <span class="n">volume_info</span><span class="o">-&gt;</span><span class="n">seal</span><span class="p">;</span>
	<span class="cm">/* we can have only one retry value for a connection</span>
<span class="cm">	   to a share so for resources mounted more than once</span>
<span class="cm">	   to the same server share the last value passed in</span>
<span class="cm">	   for the retry flag is used */</span>
	<span class="n">tcon</span><span class="o">-&gt;</span><span class="n">retry</span> <span class="o">=</span> <span class="n">volume_info</span><span class="o">-&gt;</span><span class="n">retry</span><span class="p">;</span>
	<span class="n">tcon</span><span class="o">-&gt;</span><span class="n">nocase</span> <span class="o">=</span> <span class="n">volume_info</span><span class="o">-&gt;</span><span class="n">nocase</span><span class="p">;</span>
	<span class="n">tcon</span><span class="o">-&gt;</span><span class="n">local_lease</span> <span class="o">=</span> <span class="n">volume_info</span><span class="o">-&gt;</span><span class="n">local_lease</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cifs_tcp_ses_lock</span><span class="p">);</span>
	<span class="n">list_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tcon</span><span class="o">-&gt;</span><span class="n">tcon_list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ses</span><span class="o">-&gt;</span><span class="n">tcon_list</span><span class="p">);</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cifs_tcp_ses_lock</span><span class="p">);</span>

	<span class="n">cifs_fscache_get_super_cookie</span><span class="p">(</span><span class="n">tcon</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">tcon</span><span class="p">;</span>

<span class="nl">out_fail:</span>
	<span class="n">tconInfoFree</span><span class="p">(</span><span class="n">tcon</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="n">rc</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">cifs_put_tlink</span><span class="p">(</span><span class="k">struct</span> <span class="n">tcon_link</span> <span class="o">*</span><span class="n">tlink</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tlink</span> <span class="o">||</span> <span class="n">IS_ERR</span><span class="p">(</span><span class="n">tlink</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">atomic_dec_and_test</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tlink</span><span class="o">-&gt;</span><span class="n">tl_count</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">test_bit</span><span class="p">(</span><span class="n">TCON_LINK_IN_TREE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tlink</span><span class="o">-&gt;</span><span class="n">tl_flags</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">tlink</span><span class="o">-&gt;</span><span class="n">tl_time</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">tlink_tcon</span><span class="p">(</span><span class="n">tlink</span><span class="p">)))</span>
		<span class="n">cifs_put_tcon</span><span class="p">(</span><span class="n">tlink_tcon</span><span class="p">(</span><span class="n">tlink</span><span class="p">));</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">tlink</span><span class="p">);</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="k">struct</span> <span class="n">tcon_link</span> <span class="o">*</span>
<span class="nf">cifs_sb_master_tlink</span><span class="p">(</span><span class="k">struct</span> <span class="n">cifs_sb_info</span> <span class="o">*</span><span class="n">cifs_sb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">cifs_sb</span><span class="o">-&gt;</span><span class="n">master_tlink</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">compare_mount_options</span><span class="p">(</span><span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">sb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">cifs_mnt_data</span> <span class="o">*</span><span class="n">mnt_data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cifs_sb_info</span> <span class="o">*</span><span class="n">old</span> <span class="o">=</span> <span class="n">CIFS_SB</span><span class="p">(</span><span class="n">sb</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">cifs_sb_info</span> <span class="o">*</span><span class="n">new</span> <span class="o">=</span> <span class="n">mnt_data</span><span class="o">-&gt;</span><span class="n">cifs_sb</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_flags</span> <span class="o">&amp;</span> <span class="n">CIFS_MS_MASK</span><span class="p">)</span> <span class="o">!=</span> <span class="p">(</span><span class="n">mnt_data</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">CIFS_MS_MASK</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">old</span><span class="o">-&gt;</span><span class="n">mnt_cifs_flags</span> <span class="o">&amp;</span> <span class="n">CIFS_MOUNT_MASK</span><span class="p">)</span> <span class="o">!=</span>
	    <span class="p">(</span><span class="n">new</span><span class="o">-&gt;</span><span class="n">mnt_cifs_flags</span> <span class="o">&amp;</span> <span class="n">CIFS_MOUNT_MASK</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * We want to share sb only if we don&#39;t specify an r/wsize or</span>
<span class="cm">	 * specified r/wsize is greater than or equal to existing one.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">new</span><span class="o">-&gt;</span><span class="n">wsize</span> <span class="o">&amp;&amp;</span> <span class="n">new</span><span class="o">-&gt;</span><span class="n">wsize</span> <span class="o">&lt;</span> <span class="n">old</span><span class="o">-&gt;</span><span class="n">wsize</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">new</span><span class="o">-&gt;</span><span class="n">rsize</span> <span class="o">&amp;&amp;</span> <span class="n">new</span><span class="o">-&gt;</span><span class="n">rsize</span> <span class="o">&lt;</span> <span class="n">old</span><span class="o">-&gt;</span><span class="n">rsize</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">old</span><span class="o">-&gt;</span><span class="n">mnt_uid</span> <span class="o">!=</span> <span class="n">new</span><span class="o">-&gt;</span><span class="n">mnt_uid</span> <span class="o">||</span> <span class="n">old</span><span class="o">-&gt;</span><span class="n">mnt_gid</span> <span class="o">!=</span> <span class="n">new</span><span class="o">-&gt;</span><span class="n">mnt_gid</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">old</span><span class="o">-&gt;</span><span class="n">mnt_file_mode</span> <span class="o">!=</span> <span class="n">new</span><span class="o">-&gt;</span><span class="n">mnt_file_mode</span> <span class="o">||</span>
	    <span class="n">old</span><span class="o">-&gt;</span><span class="n">mnt_dir_mode</span> <span class="o">!=</span> <span class="n">new</span><span class="o">-&gt;</span><span class="n">mnt_dir_mode</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">old</span><span class="o">-&gt;</span><span class="n">local_nls</span><span class="o">-&gt;</span><span class="n">charset</span><span class="p">,</span> <span class="n">new</span><span class="o">-&gt;</span><span class="n">local_nls</span><span class="o">-&gt;</span><span class="n">charset</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">old</span><span class="o">-&gt;</span><span class="n">actimeo</span> <span class="o">!=</span> <span class="n">new</span><span class="o">-&gt;</span><span class="n">actimeo</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="nf">cifs_match_super</span><span class="p">(</span><span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">sb</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cifs_mnt_data</span> <span class="o">*</span><span class="n">mnt_data</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">cifs_mnt_data</span> <span class="o">*</span><span class="p">)</span><span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">smb_vol</span> <span class="o">*</span><span class="n">volume_info</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cifs_sb_info</span> <span class="o">*</span><span class="n">cifs_sb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">TCP_Server_Info</span> <span class="o">*</span><span class="n">tcp_srv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cifs_ses</span> <span class="o">*</span><span class="n">ses</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cifs_tcon</span> <span class="o">*</span><span class="n">tcon</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tcon_link</span> <span class="o">*</span><span class="n">tlink</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sockaddr_storage</span> <span class="n">addr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">addr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr_storage</span><span class="p">));</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cifs_tcp_ses_lock</span><span class="p">);</span>
	<span class="n">cifs_sb</span> <span class="o">=</span> <span class="n">CIFS_SB</span><span class="p">(</span><span class="n">sb</span><span class="p">);</span>
	<span class="n">tlink</span> <span class="o">=</span> <span class="n">cifs_get_tlink</span><span class="p">(</span><span class="n">cifs_sb_master_tlink</span><span class="p">(</span><span class="n">cifs_sb</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">tlink</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cifs_tcp_ses_lock</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">tcon</span> <span class="o">=</span> <span class="n">tlink_tcon</span><span class="p">(</span><span class="n">tlink</span><span class="p">);</span>
	<span class="n">ses</span> <span class="o">=</span> <span class="n">tcon</span><span class="o">-&gt;</span><span class="n">ses</span><span class="p">;</span>
	<span class="n">tcp_srv</span> <span class="o">=</span> <span class="n">ses</span><span class="o">-&gt;</span><span class="n">server</span><span class="p">;</span>

	<span class="n">volume_info</span> <span class="o">=</span> <span class="n">mnt_data</span><span class="o">-&gt;</span><span class="n">vol</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">volume_info</span><span class="o">-&gt;</span><span class="n">UNCip</span> <span class="o">||</span> <span class="o">!</span><span class="n">volume_info</span><span class="o">-&gt;</span><span class="n">UNC</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">cifs_fill_sockaddr</span><span class="p">((</span><span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">addr</span><span class="p">,</span>
				<span class="n">volume_info</span><span class="o">-&gt;</span><span class="n">UNCip</span><span class="p">,</span>
				<span class="n">strlen</span><span class="p">(</span><span class="n">volume_info</span><span class="o">-&gt;</span><span class="n">UNCip</span><span class="p">),</span>
				<span class="n">volume_info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">match_server</span><span class="p">(</span><span class="n">tcp_srv</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">addr</span><span class="p">,</span> <span class="n">volume_info</span><span class="p">)</span> <span class="o">||</span>
	    <span class="o">!</span><span class="n">match_session</span><span class="p">(</span><span class="n">ses</span><span class="p">,</span> <span class="n">volume_info</span><span class="p">)</span> <span class="o">||</span>
	    <span class="o">!</span><span class="n">match_tcon</span><span class="p">(</span><span class="n">tcon</span><span class="p">,</span> <span class="n">volume_info</span><span class="o">-&gt;</span><span class="n">UNC</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">compare_mount_options</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">mnt_data</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cifs_tcp_ses_lock</span><span class="p">);</span>
	<span class="n">cifs_put_tlink</span><span class="p">(</span><span class="n">tlink</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="nf">get_dfs_path</span><span class="p">(</span><span class="kt">int</span> <span class="n">xid</span><span class="p">,</span> <span class="k">struct</span> <span class="n">cifs_ses</span> <span class="o">*</span><span class="n">pSesInfo</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">old_path</span><span class="p">,</span>
	     <span class="k">const</span> <span class="k">struct</span> <span class="n">nls_table</span> <span class="o">*</span><span class="n">nls_codepage</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">pnum_referrals</span><span class="p">,</span>
	     <span class="k">struct</span> <span class="n">dfs_info3_param</span> <span class="o">**</span><span class="n">preferrals</span><span class="p">,</span> <span class="kt">int</span> <span class="n">remap</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">temp_unc</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="o">*</span><span class="n">pnum_referrals</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="o">*</span><span class="n">preferrals</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pSesInfo</span><span class="o">-&gt;</span><span class="n">ipc_tid</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">temp_unc</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="mi">2</span> <span class="cm">/* for slashes */</span> <span class="o">+</span>
			<span class="n">strnlen</span><span class="p">(</span><span class="n">pSesInfo</span><span class="o">-&gt;</span><span class="n">serverName</span><span class="p">,</span>
				<span class="n">SERVER_NAME_LEN_WITH_NULL</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span>
				 <span class="o">+</span> <span class="mi">1</span> <span class="o">+</span> <span class="mi">4</span> <span class="cm">/* slash IPC$ */</span>  <span class="o">+</span> <span class="mi">2</span><span class="p">,</span>
				<span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">temp_unc</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="n">temp_unc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\\&#39;</span><span class="p">;</span>
		<span class="n">temp_unc</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\\&#39;</span><span class="p">;</span>
		<span class="n">strcpy</span><span class="p">(</span><span class="n">temp_unc</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="n">pSesInfo</span><span class="o">-&gt;</span><span class="n">serverName</span><span class="p">);</span>
		<span class="n">strcpy</span><span class="p">(</span><span class="n">temp_unc</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">strlen</span><span class="p">(</span><span class="n">pSesInfo</span><span class="o">-&gt;</span><span class="n">serverName</span><span class="p">),</span> <span class="s">&quot;</span><span class="se">\\</span><span class="s">IPC$&quot;</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">CIFSTCon</span><span class="p">(</span><span class="n">xid</span><span class="p">,</span> <span class="n">pSesInfo</span><span class="p">,</span> <span class="n">temp_unc</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">nls_codepage</span><span class="p">);</span>
		<span class="n">cFYI</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;CIFS Tcon rc = %d ipc_tid = %d&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="p">,</span> <span class="n">pSesInfo</span><span class="o">-&gt;</span><span class="n">ipc_tid</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">temp_unc</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">CIFSGetDFSRefer</span><span class="p">(</span><span class="n">xid</span><span class="p">,</span> <span class="n">pSesInfo</span><span class="p">,</span> <span class="n">old_path</span><span class="p">,</span> <span class="n">preferrals</span><span class="p">,</span>
				     <span class="n">pnum_referrals</span><span class="p">,</span> <span class="n">nls_codepage</span><span class="p">,</span> <span class="n">remap</span><span class="p">);</span>
	<span class="cm">/* BB map targetUNCs to dfs_info3 structures, here or</span>
<span class="cm">		in CIFSGetDFSRefer BB */</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_DEBUG_LOCK_ALLOC</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">lock_class_key</span> <span class="n">cifs_key</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">lock_class_key</span> <span class="n">cifs_slock_key</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span>
<span class="nf">cifs_reclassify_socket4</span><span class="p">(</span><span class="k">struct</span> <span class="n">socket</span> <span class="o">*</span><span class="n">sock</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span> <span class="o">=</span> <span class="n">sock</span><span class="o">-&gt;</span><span class="n">sk</span><span class="p">;</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">sock_owned_by_user</span><span class="p">(</span><span class="n">sk</span><span class="p">));</span>
	<span class="n">sock_lock_init_class_and_name</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="s">&quot;slock-AF_INET-CIFS&quot;</span><span class="p">,</span>
		<span class="o">&amp;</span><span class="n">cifs_slock_key</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s">&quot;sk_lock-AF_INET-CIFS&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cifs_key</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span>
<span class="nf">cifs_reclassify_socket6</span><span class="p">(</span><span class="k">struct</span> <span class="n">socket</span> <span class="o">*</span><span class="n">sock</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span> <span class="o">=</span> <span class="n">sock</span><span class="o">-&gt;</span><span class="n">sk</span><span class="p">;</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">sock_owned_by_user</span><span class="p">(</span><span class="n">sk</span><span class="p">));</span>
	<span class="n">sock_lock_init_class_and_name</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="s">&quot;slock-AF_INET6-CIFS&quot;</span><span class="p">,</span>
		<span class="o">&amp;</span><span class="n">cifs_slock_key</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="s">&quot;sk_lock-AF_INET6-CIFS&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cifs_key</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
<span class="p">}</span>
<span class="cp">#else</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span>
<span class="nf">cifs_reclassify_socket4</span><span class="p">(</span><span class="k">struct</span> <span class="n">socket</span> <span class="o">*</span><span class="n">sock</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span>
<span class="nf">cifs_reclassify_socket6</span><span class="p">(</span><span class="k">struct</span> <span class="n">socket</span> <span class="o">*</span><span class="n">sock</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="cm">/* See RFC1001 section 14 on representation of Netbios names */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">rfc1002mangle</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">target</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">source</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">length</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">length</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* mask a nibble at a time and encode */</span>
		<span class="n">target</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;A&#39;</span> <span class="o">+</span> <span class="p">(</span><span class="mh">0x0F</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">source</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">));</span>
		<span class="n">target</span><span class="p">[</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;A&#39;</span> <span class="o">+</span> <span class="p">(</span><span class="mh">0x0F</span> <span class="o">&amp;</span> <span class="n">source</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="n">j</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span>

<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">bind_socket</span><span class="p">(</span><span class="k">struct</span> <span class="n">TCP_Server_Info</span> <span class="o">*</span><span class="n">server</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">srcaddr</span><span class="p">.</span><span class="n">ss_family</span> <span class="o">!=</span> <span class="n">AF_UNSPEC</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Bind to the specified local IP address */</span>
		<span class="k">struct</span> <span class="n">socket</span> <span class="o">*</span><span class="n">socket</span> <span class="o">=</span> <span class="n">server</span><span class="o">-&gt;</span><span class="n">ssocket</span><span class="p">;</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">socket</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">bind</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span>
				       <span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">srcaddr</span><span class="p">,</span>
				       <span class="k">sizeof</span><span class="p">(</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">srcaddr</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">sockaddr_in</span> <span class="o">*</span><span class="n">saddr4</span><span class="p">;</span>
			<span class="k">struct</span> <span class="n">sockaddr_in6</span> <span class="o">*</span><span class="n">saddr6</span><span class="p">;</span>
			<span class="n">saddr4</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr_in</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">srcaddr</span><span class="p">;</span>
			<span class="n">saddr6</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr_in6</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">srcaddr</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">saddr6</span><span class="o">-&gt;</span><span class="n">sin6_family</span> <span class="o">==</span> <span class="n">AF_INET6</span><span class="p">)</span>
				<span class="n">cERROR</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;cifs: &quot;</span>
				       <span class="s">&quot;Failed to bind to: %pI6c, error: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				       <span class="o">&amp;</span><span class="n">saddr6</span><span class="o">-&gt;</span><span class="n">sin6_addr</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">cERROR</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;cifs: &quot;</span>
				       <span class="s">&quot;Failed to bind to: %pI4, error: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				       <span class="o">&amp;</span><span class="n">saddr4</span><span class="o">-&gt;</span><span class="n">sin_addr</span><span class="p">.</span><span class="n">s_addr</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">ip_rfc1001_connect</span><span class="p">(</span><span class="k">struct</span> <span class="n">TCP_Server_Info</span> <span class="o">*</span><span class="n">server</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * some servers require RFC1001 sessinit before sending</span>
<span class="cm">	 * negprot - BB check reconnection in case where second</span>
<span class="cm">	 * sessinit is sent but no second negprot</span>
<span class="cm">	 */</span>
	<span class="k">struct</span> <span class="n">rfc1002_session_packet</span> <span class="o">*</span><span class="n">ses_init_buf</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">smb_hdr</span> <span class="o">*</span><span class="n">smb_buf</span><span class="p">;</span>
	<span class="n">ses_init_buf</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">rfc1002_session_packet</span><span class="p">),</span>
			       <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ses_init_buf</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ses_init_buf</span><span class="o">-&gt;</span><span class="n">trailer</span><span class="p">.</span><span class="n">session_req</span><span class="p">.</span><span class="n">called_len</span> <span class="o">=</span> <span class="mi">32</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">server_RFC1001_name</span> <span class="o">&amp;&amp;</span>
		    <span class="n">server</span><span class="o">-&gt;</span><span class="n">server_RFC1001_name</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">rfc1002mangle</span><span class="p">(</span><span class="n">ses_init_buf</span><span class="o">-&gt;</span><span class="n">trailer</span><span class="p">.</span>
				      <span class="n">session_req</span><span class="p">.</span><span class="n">called_name</span><span class="p">,</span>
				      <span class="n">server</span><span class="o">-&gt;</span><span class="n">server_RFC1001_name</span><span class="p">,</span>
				      <span class="n">RFC1001_NAME_LEN_WITH_NULL</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">rfc1002mangle</span><span class="p">(</span><span class="n">ses_init_buf</span><span class="o">-&gt;</span><span class="n">trailer</span><span class="p">.</span>
				      <span class="n">session_req</span><span class="p">.</span><span class="n">called_name</span><span class="p">,</span>
				      <span class="n">DEFAULT_CIFS_CALLED_NAME</span><span class="p">,</span>
				      <span class="n">RFC1001_NAME_LEN_WITH_NULL</span><span class="p">);</span>

		<span class="n">ses_init_buf</span><span class="o">-&gt;</span><span class="n">trailer</span><span class="p">.</span><span class="n">session_req</span><span class="p">.</span><span class="n">calling_len</span> <span class="o">=</span> <span class="mi">32</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * calling name ends in null (byte 16) from old smb</span>
<span class="cm">		 * convention.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">workstation_RFC1001_name</span> <span class="o">&amp;&amp;</span>
		    <span class="n">server</span><span class="o">-&gt;</span><span class="n">workstation_RFC1001_name</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">rfc1002mangle</span><span class="p">(</span><span class="n">ses_init_buf</span><span class="o">-&gt;</span><span class="n">trailer</span><span class="p">.</span>
				      <span class="n">session_req</span><span class="p">.</span><span class="n">calling_name</span><span class="p">,</span>
				      <span class="n">server</span><span class="o">-&gt;</span><span class="n">workstation_RFC1001_name</span><span class="p">,</span>
				      <span class="n">RFC1001_NAME_LEN_WITH_NULL</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">rfc1002mangle</span><span class="p">(</span><span class="n">ses_init_buf</span><span class="o">-&gt;</span><span class="n">trailer</span><span class="p">.</span>
				      <span class="n">session_req</span><span class="p">.</span><span class="n">calling_name</span><span class="p">,</span>
				      <span class="s">&quot;LINUX_CIFS_CLNT&quot;</span><span class="p">,</span>
				      <span class="n">RFC1001_NAME_LEN_WITH_NULL</span><span class="p">);</span>

		<span class="n">ses_init_buf</span><span class="o">-&gt;</span><span class="n">trailer</span><span class="p">.</span><span class="n">session_req</span><span class="p">.</span><span class="n">scope1</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">ses_init_buf</span><span class="o">-&gt;</span><span class="n">trailer</span><span class="p">.</span><span class="n">session_req</span><span class="p">.</span><span class="n">scope2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">smb_buf</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">smb_hdr</span> <span class="o">*</span><span class="p">)</span><span class="n">ses_init_buf</span><span class="p">;</span>

		<span class="cm">/* sizeof RFC1002_SESSION_REQUEST with no scope */</span>
		<span class="n">smb_buf</span><span class="o">-&gt;</span><span class="n">smb_buf_length</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="mh">0x81000044</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">smb_send</span><span class="p">(</span><span class="n">server</span><span class="p">,</span> <span class="n">smb_buf</span><span class="p">,</span> <span class="mh">0x44</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">ses_init_buf</span><span class="p">);</span>
		<span class="cm">/*</span>
<span class="cm">		 * RFC1001 layer in at least one server</span>
<span class="cm">		 * requires very short break before negprot</span>
<span class="cm">		 * presumably because not expecting negprot</span>
<span class="cm">		 * to follow so fast.  This is a simple</span>
<span class="cm">		 * solution that works without</span>
<span class="cm">		 * complicating the code and causes no</span>
<span class="cm">		 * significant slowing down on mount</span>
<span class="cm">		 * for everyone else</span>
<span class="cm">		 */</span>
		<span class="n">usleep_range</span><span class="p">(</span><span class="mi">1000</span><span class="p">,</span> <span class="mi">2000</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="cm">/*</span>
<span class="cm">	 * else the negprot may still work without this</span>
<span class="cm">	 * even though malloc failed</span>
<span class="cm">	 */</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">generic_ip_connect</span><span class="p">(</span><span class="k">struct</span> <span class="n">TCP_Server_Info</span> <span class="o">*</span><span class="n">server</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">__be16</span> <span class="n">sport</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">slen</span><span class="p">,</span> <span class="n">sfamily</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">socket</span> <span class="o">*</span><span class="n">socket</span> <span class="o">=</span> <span class="n">server</span><span class="o">-&gt;</span><span class="n">ssocket</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="n">saddr</span><span class="p">;</span>

	<span class="n">saddr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">dstaddr</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">dstaddr</span><span class="p">.</span><span class="n">ss_family</span> <span class="o">==</span> <span class="n">AF_INET6</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sport</span> <span class="o">=</span> <span class="p">((</span><span class="k">struct</span> <span class="n">sockaddr_in6</span> <span class="o">*</span><span class="p">)</span> <span class="n">saddr</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">sin6_port</span><span class="p">;</span>
		<span class="n">slen</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr_in6</span><span class="p">);</span>
		<span class="n">sfamily</span> <span class="o">=</span> <span class="n">AF_INET6</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">sport</span> <span class="o">=</span> <span class="p">((</span><span class="k">struct</span> <span class="n">sockaddr_in</span> <span class="o">*</span><span class="p">)</span> <span class="n">saddr</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">sin_port</span><span class="p">;</span>
		<span class="n">slen</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr_in</span><span class="p">);</span>
		<span class="n">sfamily</span> <span class="o">=</span> <span class="n">AF_INET</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">socket</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">__sock_create</span><span class="p">(</span><span class="n">cifs_net_ns</span><span class="p">(</span><span class="n">server</span><span class="p">),</span> <span class="n">sfamily</span><span class="p">,</span> <span class="n">SOCK_STREAM</span><span class="p">,</span>
				   <span class="n">IPPROTO_TCP</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">socket</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">cERROR</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;Error %d creating socket&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
			<span class="n">server</span><span class="o">-&gt;</span><span class="n">ssocket</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* BB other socket options to set KEEPALIVE, NODELAY? */</span>
		<span class="n">cFYI</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;Socket created&quot;</span><span class="p">);</span>
		<span class="n">server</span><span class="o">-&gt;</span><span class="n">ssocket</span> <span class="o">=</span> <span class="n">socket</span><span class="p">;</span>
		<span class="n">socket</span><span class="o">-&gt;</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_allocation</span> <span class="o">=</span> <span class="n">GFP_NOFS</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sfamily</span> <span class="o">==</span> <span class="n">AF_INET6</span><span class="p">)</span>
			<span class="n">cifs_reclassify_socket6</span><span class="p">(</span><span class="n">socket</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">cifs_reclassify_socket4</span><span class="p">(</span><span class="n">socket</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">bind_socket</span><span class="p">(</span><span class="n">server</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Eventually check for other socket options to change from</span>
<span class="cm">	 * the default. sock_setsockopt not used because it expects</span>
<span class="cm">	 * user space buffer</span>
<span class="cm">	 */</span>
	<span class="n">socket</span><span class="o">-&gt;</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_rcvtimeo</span> <span class="o">=</span> <span class="mi">7</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">;</span>
	<span class="n">socket</span><span class="o">-&gt;</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_sndtimeo</span> <span class="o">=</span> <span class="mi">5</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">;</span>

	<span class="cm">/* make the bufsizes depend on wsize/rsize and max requests */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">noautotune</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">socket</span><span class="o">-&gt;</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_sndbuf</span> <span class="o">&lt;</span> <span class="p">(</span><span class="mi">200</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">))</span>
			<span class="n">socket</span><span class="o">-&gt;</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_sndbuf</span> <span class="o">=</span> <span class="mi">200</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">socket</span><span class="o">-&gt;</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_rcvbuf</span> <span class="o">&lt;</span> <span class="p">(</span><span class="mi">140</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">))</span>
			<span class="n">socket</span><span class="o">-&gt;</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_rcvbuf</span> <span class="o">=</span> <span class="mi">140</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">tcp_nodelay</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">val</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">kernel_setsockopt</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span> <span class="n">SOL_TCP</span><span class="p">,</span> <span class="n">TCP_NODELAY</span><span class="p">,</span>
				<span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">val</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">val</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
			<span class="n">cFYI</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;set TCP_NODELAY socket option error %d&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
	<span class="p">}</span>

	 <span class="n">cFYI</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;sndbuf %d rcvbuf %d rcvtimeo 0x%lx&quot;</span><span class="p">,</span>
		 <span class="n">socket</span><span class="o">-&gt;</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_sndbuf</span><span class="p">,</span>
		 <span class="n">socket</span><span class="o">-&gt;</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_rcvbuf</span><span class="p">,</span> <span class="n">socket</span><span class="o">-&gt;</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_rcvtimeo</span><span class="p">);</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">socket</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">connect</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span> <span class="n">saddr</span><span class="p">,</span> <span class="n">slen</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cFYI</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;Error %d connecting to server&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
		<span class="n">sock_release</span><span class="p">(</span><span class="n">socket</span><span class="p">);</span>
		<span class="n">server</span><span class="o">-&gt;</span><span class="n">ssocket</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sport</span> <span class="o">==</span> <span class="n">htons</span><span class="p">(</span><span class="n">RFC1001_PORT</span><span class="p">))</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">ip_rfc1001_connect</span><span class="p">(</span><span class="n">server</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">ip_connect</span><span class="p">(</span><span class="k">struct</span> <span class="n">TCP_Server_Info</span> <span class="o">*</span><span class="n">server</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">__be16</span> <span class="o">*</span><span class="n">sport</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sockaddr_in6</span> <span class="o">*</span><span class="n">addr6</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr_in6</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">dstaddr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sockaddr_in</span> <span class="o">*</span><span class="n">addr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr_in</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">dstaddr</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">dstaddr</span><span class="p">.</span><span class="n">ss_family</span> <span class="o">==</span> <span class="n">AF_INET6</span><span class="p">)</span>
		<span class="n">sport</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">addr6</span><span class="o">-&gt;</span><span class="n">sin6_port</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">sport</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">addr</span><span class="o">-&gt;</span><span class="n">sin_port</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">sport</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

		<span class="cm">/* try with 445 port at first */</span>
		<span class="o">*</span><span class="n">sport</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="n">CIFS_PORT</span><span class="p">);</span>

		<span class="n">rc</span> <span class="o">=</span> <span class="n">generic_ip_connect</span><span class="p">(</span><span class="n">server</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

		<span class="cm">/* if it failed, try with 139 port */</span>
		<span class="o">*</span><span class="n">sport</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="n">RFC1001_PORT</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">generic_ip_connect</span><span class="p">(</span><span class="n">server</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">reset_cifs_unix_caps</span><span class="p">(</span><span class="kt">int</span> <span class="n">xid</span><span class="p">,</span> <span class="k">struct</span> <span class="n">cifs_tcon</span> <span class="o">*</span><span class="n">tcon</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">cifs_sb_info</span> <span class="o">*</span><span class="n">cifs_sb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">smb_vol</span> <span class="o">*</span><span class="n">vol_info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* if we are reconnecting then should we check to see if</span>
<span class="cm">	 * any requested capabilities changed locally e.g. via</span>
<span class="cm">	 * remount but we can not do much about it here</span>
<span class="cm">	 * if they have (even if we could detect it by the following)</span>
<span class="cm">	 * Perhaps we could add a backpointer to array of sb from tcon</span>
<span class="cm">	 * or if we change to make all sb to same share the same</span>
<span class="cm">	 * sb as NFS - then we only have one backpointer to sb.</span>
<span class="cm">	 * What if we wanted to mount the server share twice once with</span>
<span class="cm">	 * and once without posixacls or posix paths? */</span>
	<span class="n">__u64</span> <span class="n">saved_cap</span> <span class="o">=</span> <span class="n">le64_to_cpu</span><span class="p">(</span><span class="n">tcon</span><span class="o">-&gt;</span><span class="n">fsUnixInfo</span><span class="p">.</span><span class="n">Capability</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vol_info</span> <span class="o">&amp;&amp;</span> <span class="n">vol_info</span><span class="o">-&gt;</span><span class="n">no_linux_ext</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tcon</span><span class="o">-&gt;</span><span class="n">fsUnixInfo</span><span class="p">.</span><span class="n">Capability</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">tcon</span><span class="o">-&gt;</span><span class="n">unix_ext</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* Unix Extensions disabled */</span>
		<span class="n">cFYI</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;Linux protocol extensions disabled&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">vol_info</span><span class="p">)</span>
		<span class="n">tcon</span><span class="o">-&gt;</span><span class="n">unix_ext</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="cm">/* Unix Extensions supported */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tcon</span><span class="o">-&gt;</span><span class="n">unix_ext</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cFYI</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;Unix extensions disabled so not set on reconnect&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">CIFSSMBQFSUnixInfo</span><span class="p">(</span><span class="n">xid</span><span class="p">,</span> <span class="n">tcon</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">__u64</span> <span class="n">cap</span> <span class="o">=</span> <span class="n">le64_to_cpu</span><span class="p">(</span><span class="n">tcon</span><span class="o">-&gt;</span><span class="n">fsUnixInfo</span><span class="p">.</span><span class="n">Capability</span><span class="p">);</span>
		<span class="n">cFYI</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;unix caps which server supports %lld&quot;</span><span class="p">,</span> <span class="n">cap</span><span class="p">);</span>
		<span class="cm">/* check for reconnect case in which we do not</span>
<span class="cm">		   want to change the mount behavior if we can avoid it */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">vol_info</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* turn off POSIX ACL and PATHNAMES if not set</span>
<span class="cm">			   originally at mount time */</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">saved_cap</span> <span class="o">&amp;</span> <span class="n">CIFS_UNIX_POSIX_ACL_CAP</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">cap</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">CIFS_UNIX_POSIX_ACL_CAP</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">saved_cap</span> <span class="o">&amp;</span> <span class="n">CIFS_UNIX_POSIX_PATHNAMES_CAP</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">cap</span> <span class="o">&amp;</span> <span class="n">CIFS_UNIX_POSIX_PATHNAMES_CAP</span><span class="p">)</span>
					<span class="n">cERROR</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;POSIXPATH support change&quot;</span><span class="p">);</span>
				<span class="n">cap</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">CIFS_UNIX_POSIX_PATHNAMES_CAP</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">cap</span> <span class="o">&amp;</span> <span class="n">CIFS_UNIX_POSIX_PATHNAMES_CAP</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">cERROR</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;possible reconnect error&quot;</span><span class="p">);</span>
				<span class="n">cERROR</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;server disabled POSIX path support&quot;</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">cap</span> <span class="o">&amp;</span> <span class="n">CIFS_UNIX_TRANSPORT_ENCRYPTION_MANDATORY_CAP</span><span class="p">)</span>
			<span class="n">cERROR</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;per-share encryption not supported yet&quot;</span><span class="p">);</span>

		<span class="n">cap</span> <span class="o">&amp;=</span> <span class="n">CIFS_UNIX_CAP_MASK</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">vol_info</span> <span class="o">&amp;&amp;</span> <span class="n">vol_info</span><span class="o">-&gt;</span><span class="n">no_psx_acl</span><span class="p">)</span>
			<span class="n">cap</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">CIFS_UNIX_POSIX_ACL_CAP</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">CIFS_UNIX_POSIX_ACL_CAP</span> <span class="o">&amp;</span> <span class="n">cap</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">cFYI</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;negotiated posix acl support&quot;</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">cifs_sb</span><span class="p">)</span>
				<span class="n">cifs_sb</span><span class="o">-&gt;</span><span class="n">mnt_cifs_flags</span> <span class="o">|=</span>
					<span class="n">CIFS_MOUNT_POSIXACL</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">vol_info</span> <span class="o">&amp;&amp;</span> <span class="n">vol_info</span><span class="o">-&gt;</span><span class="n">posix_paths</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">cap</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">CIFS_UNIX_POSIX_PATHNAMES_CAP</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">cap</span> <span class="o">&amp;</span> <span class="n">CIFS_UNIX_POSIX_PATHNAMES_CAP</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">cFYI</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;negotiate posix pathnames&quot;</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">cifs_sb</span><span class="p">)</span>
				<span class="n">cifs_sb</span><span class="o">-&gt;</span><span class="n">mnt_cifs_flags</span> <span class="o">|=</span>
					<span class="n">CIFS_MOUNT_POSIX_PATHS</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">cFYI</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;Negotiate caps 0x%x&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">cap</span><span class="p">);</span>
<span class="cp">#ifdef CONFIG_CIFS_DEBUG2</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cap</span> <span class="o">&amp;</span> <span class="n">CIFS_UNIX_FCNTL_CAP</span><span class="p">)</span>
			<span class="n">cFYI</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;FCNTL cap&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cap</span> <span class="o">&amp;</span> <span class="n">CIFS_UNIX_EXTATTR_CAP</span><span class="p">)</span>
			<span class="n">cFYI</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;EXTATTR cap&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cap</span> <span class="o">&amp;</span> <span class="n">CIFS_UNIX_POSIX_PATHNAMES_CAP</span><span class="p">)</span>
			<span class="n">cFYI</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;POSIX path cap&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cap</span> <span class="o">&amp;</span> <span class="n">CIFS_UNIX_XATTR_CAP</span><span class="p">)</span>
			<span class="n">cFYI</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;XATTR cap&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cap</span> <span class="o">&amp;</span> <span class="n">CIFS_UNIX_POSIX_ACL_CAP</span><span class="p">)</span>
			<span class="n">cFYI</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;POSIX ACL cap&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cap</span> <span class="o">&amp;</span> <span class="n">CIFS_UNIX_LARGE_READ_CAP</span><span class="p">)</span>
			<span class="n">cFYI</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;very large read cap&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cap</span> <span class="o">&amp;</span> <span class="n">CIFS_UNIX_LARGE_WRITE_CAP</span><span class="p">)</span>
			<span class="n">cFYI</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;very large write cap&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cap</span> <span class="o">&amp;</span> <span class="n">CIFS_UNIX_TRANSPORT_ENCRYPTION_CAP</span><span class="p">)</span>
			<span class="n">cFYI</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;transport encryption cap&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cap</span> <span class="o">&amp;</span> <span class="n">CIFS_UNIX_TRANSPORT_ENCRYPTION_MANDATORY_CAP</span><span class="p">)</span>
			<span class="n">cFYI</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;mandatory transport encryption cap&quot;</span><span class="p">);</span>
<span class="cp">#endif </span><span class="cm">/* CIFS_DEBUG2 */</span><span class="cp"></span>
		<span class="k">if</span> <span class="p">(</span><span class="n">CIFSSMBSetFSUnixInfo</span><span class="p">(</span><span class="n">xid</span><span class="p">,</span> <span class="n">tcon</span><span class="p">,</span> <span class="n">cap</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">vol_info</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">cFYI</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;resetting capabilities failed&quot;</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span>
				<span class="n">cERROR</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;Negotiating Unix capabilities &quot;</span>
					   <span class="s">&quot;with the server failed.  Consider &quot;</span>
					   <span class="s">&quot;mounting with the Unix Extensions</span><span class="se">\n</span><span class="s">&quot;</span>
					   <span class="s">&quot;disabled, if problems are found, &quot;</span>
					   <span class="s">&quot;by specifying the nounix mount &quot;</span>
					   <span class="s">&quot;option.&quot;</span><span class="p">);</span>

		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">cifs_setup_cifs_sb</span><span class="p">(</span><span class="k">struct</span> <span class="n">smb_vol</span> <span class="o">*</span><span class="n">pvolume_info</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">cifs_sb_info</span> <span class="o">*</span><span class="n">cifs_sb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">INIT_DELAYED_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cifs_sb</span><span class="o">-&gt;</span><span class="n">prune_tlinks</span><span class="p">,</span> <span class="n">cifs_prune_tlinks</span><span class="p">);</span>

	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cifs_sb</span><span class="o">-&gt;</span><span class="n">tlink_tree_lock</span><span class="p">);</span>
	<span class="n">cifs_sb</span><span class="o">-&gt;</span><span class="n">tlink_tree</span> <span class="o">=</span> <span class="n">RB_ROOT</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Temporarily set r/wsize for matching superblock. If we end up using</span>
<span class="cm">	 * new sb then client will later negotiate it downward if needed.</span>
<span class="cm">	 */</span>
	<span class="n">cifs_sb</span><span class="o">-&gt;</span><span class="n">rsize</span> <span class="o">=</span> <span class="n">pvolume_info</span><span class="o">-&gt;</span><span class="n">rsize</span><span class="p">;</span>
	<span class="n">cifs_sb</span><span class="o">-&gt;</span><span class="n">wsize</span> <span class="o">=</span> <span class="n">pvolume_info</span><span class="o">-&gt;</span><span class="n">wsize</span><span class="p">;</span>

	<span class="n">cifs_sb</span><span class="o">-&gt;</span><span class="n">mnt_uid</span> <span class="o">=</span> <span class="n">pvolume_info</span><span class="o">-&gt;</span><span class="n">linux_uid</span><span class="p">;</span>
	<span class="n">cifs_sb</span><span class="o">-&gt;</span><span class="n">mnt_gid</span> <span class="o">=</span> <span class="n">pvolume_info</span><span class="o">-&gt;</span><span class="n">linux_gid</span><span class="p">;</span>
	<span class="n">cifs_sb</span><span class="o">-&gt;</span><span class="n">mnt_file_mode</span> <span class="o">=</span> <span class="n">pvolume_info</span><span class="o">-&gt;</span><span class="n">file_mode</span><span class="p">;</span>
	<span class="n">cifs_sb</span><span class="o">-&gt;</span><span class="n">mnt_dir_mode</span> <span class="o">=</span> <span class="n">pvolume_info</span><span class="o">-&gt;</span><span class="n">dir_mode</span><span class="p">;</span>
	<span class="n">cFYI</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;file mode: 0x%hx  dir mode: 0x%hx&quot;</span><span class="p">,</span>
		<span class="n">cifs_sb</span><span class="o">-&gt;</span><span class="n">mnt_file_mode</span><span class="p">,</span> <span class="n">cifs_sb</span><span class="o">-&gt;</span><span class="n">mnt_dir_mode</span><span class="p">);</span>

	<span class="n">cifs_sb</span><span class="o">-&gt;</span><span class="n">actimeo</span> <span class="o">=</span> <span class="n">pvolume_info</span><span class="o">-&gt;</span><span class="n">actimeo</span><span class="p">;</span>
	<span class="n">cifs_sb</span><span class="o">-&gt;</span><span class="n">local_nls</span> <span class="o">=</span> <span class="n">pvolume_info</span><span class="o">-&gt;</span><span class="n">local_nls</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pvolume_info</span><span class="o">-&gt;</span><span class="n">noperm</span><span class="p">)</span>
		<span class="n">cifs_sb</span><span class="o">-&gt;</span><span class="n">mnt_cifs_flags</span> <span class="o">|=</span> <span class="n">CIFS_MOUNT_NO_PERM</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pvolume_info</span><span class="o">-&gt;</span><span class="n">setuids</span><span class="p">)</span>
		<span class="n">cifs_sb</span><span class="o">-&gt;</span><span class="n">mnt_cifs_flags</span> <span class="o">|=</span> <span class="n">CIFS_MOUNT_SET_UID</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pvolume_info</span><span class="o">-&gt;</span><span class="n">server_ino</span><span class="p">)</span>
		<span class="n">cifs_sb</span><span class="o">-&gt;</span><span class="n">mnt_cifs_flags</span> <span class="o">|=</span> <span class="n">CIFS_MOUNT_SERVER_INUM</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pvolume_info</span><span class="o">-&gt;</span><span class="n">remap</span><span class="p">)</span>
		<span class="n">cifs_sb</span><span class="o">-&gt;</span><span class="n">mnt_cifs_flags</span> <span class="o">|=</span> <span class="n">CIFS_MOUNT_MAP_SPECIAL_CHR</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pvolume_info</span><span class="o">-&gt;</span><span class="n">no_xattr</span><span class="p">)</span>
		<span class="n">cifs_sb</span><span class="o">-&gt;</span><span class="n">mnt_cifs_flags</span> <span class="o">|=</span> <span class="n">CIFS_MOUNT_NO_XATTR</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pvolume_info</span><span class="o">-&gt;</span><span class="n">sfu_emul</span><span class="p">)</span>
		<span class="n">cifs_sb</span><span class="o">-&gt;</span><span class="n">mnt_cifs_flags</span> <span class="o">|=</span> <span class="n">CIFS_MOUNT_UNX_EMUL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pvolume_info</span><span class="o">-&gt;</span><span class="n">nobrl</span><span class="p">)</span>
		<span class="n">cifs_sb</span><span class="o">-&gt;</span><span class="n">mnt_cifs_flags</span> <span class="o">|=</span> <span class="n">CIFS_MOUNT_NO_BRL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pvolume_info</span><span class="o">-&gt;</span><span class="n">nostrictsync</span><span class="p">)</span>
		<span class="n">cifs_sb</span><span class="o">-&gt;</span><span class="n">mnt_cifs_flags</span> <span class="o">|=</span> <span class="n">CIFS_MOUNT_NOSSYNC</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pvolume_info</span><span class="o">-&gt;</span><span class="n">mand_lock</span><span class="p">)</span>
		<span class="n">cifs_sb</span><span class="o">-&gt;</span><span class="n">mnt_cifs_flags</span> <span class="o">|=</span> <span class="n">CIFS_MOUNT_NOPOSIXBRL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pvolume_info</span><span class="o">-&gt;</span><span class="n">rwpidforward</span><span class="p">)</span>
		<span class="n">cifs_sb</span><span class="o">-&gt;</span><span class="n">mnt_cifs_flags</span> <span class="o">|=</span> <span class="n">CIFS_MOUNT_RWPIDFORWARD</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pvolume_info</span><span class="o">-&gt;</span><span class="n">cifs_acl</span><span class="p">)</span>
		<span class="n">cifs_sb</span><span class="o">-&gt;</span><span class="n">mnt_cifs_flags</span> <span class="o">|=</span> <span class="n">CIFS_MOUNT_CIFS_ACL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pvolume_info</span><span class="o">-&gt;</span><span class="n">backupuid_specified</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cifs_sb</span><span class="o">-&gt;</span><span class="n">mnt_cifs_flags</span> <span class="o">|=</span> <span class="n">CIFS_MOUNT_CIFS_BACKUPUID</span><span class="p">;</span>
		<span class="n">cifs_sb</span><span class="o">-&gt;</span><span class="n">mnt_backupuid</span> <span class="o">=</span> <span class="n">pvolume_info</span><span class="o">-&gt;</span><span class="n">backupuid</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pvolume_info</span><span class="o">-&gt;</span><span class="n">backupgid_specified</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cifs_sb</span><span class="o">-&gt;</span><span class="n">mnt_cifs_flags</span> <span class="o">|=</span> <span class="n">CIFS_MOUNT_CIFS_BACKUPGID</span><span class="p">;</span>
		<span class="n">cifs_sb</span><span class="o">-&gt;</span><span class="n">mnt_backupgid</span> <span class="o">=</span> <span class="n">pvolume_info</span><span class="o">-&gt;</span><span class="n">backupgid</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pvolume_info</span><span class="o">-&gt;</span><span class="n">override_uid</span><span class="p">)</span>
		<span class="n">cifs_sb</span><span class="o">-&gt;</span><span class="n">mnt_cifs_flags</span> <span class="o">|=</span> <span class="n">CIFS_MOUNT_OVERR_UID</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pvolume_info</span><span class="o">-&gt;</span><span class="n">override_gid</span><span class="p">)</span>
		<span class="n">cifs_sb</span><span class="o">-&gt;</span><span class="n">mnt_cifs_flags</span> <span class="o">|=</span> <span class="n">CIFS_MOUNT_OVERR_GID</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pvolume_info</span><span class="o">-&gt;</span><span class="n">dynperm</span><span class="p">)</span>
		<span class="n">cifs_sb</span><span class="o">-&gt;</span><span class="n">mnt_cifs_flags</span> <span class="o">|=</span> <span class="n">CIFS_MOUNT_DYNPERM</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pvolume_info</span><span class="o">-&gt;</span><span class="n">fsc</span><span class="p">)</span>
		<span class="n">cifs_sb</span><span class="o">-&gt;</span><span class="n">mnt_cifs_flags</span> <span class="o">|=</span> <span class="n">CIFS_MOUNT_FSCACHE</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pvolume_info</span><span class="o">-&gt;</span><span class="n">multiuser</span><span class="p">)</span>
		<span class="n">cifs_sb</span><span class="o">-&gt;</span><span class="n">mnt_cifs_flags</span> <span class="o">|=</span> <span class="p">(</span><span class="n">CIFS_MOUNT_MULTIUSER</span> <span class="o">|</span>
					    <span class="n">CIFS_MOUNT_NO_PERM</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pvolume_info</span><span class="o">-&gt;</span><span class="n">strict_io</span><span class="p">)</span>
		<span class="n">cifs_sb</span><span class="o">-&gt;</span><span class="n">mnt_cifs_flags</span> <span class="o">|=</span> <span class="n">CIFS_MOUNT_STRICT_IO</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pvolume_info</span><span class="o">-&gt;</span><span class="n">direct_io</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cFYI</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;mounting share using direct i/o&quot;</span><span class="p">);</span>
		<span class="n">cifs_sb</span><span class="o">-&gt;</span><span class="n">mnt_cifs_flags</span> <span class="o">|=</span> <span class="n">CIFS_MOUNT_DIRECT_IO</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pvolume_info</span><span class="o">-&gt;</span><span class="n">mfsymlinks</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pvolume_info</span><span class="o">-&gt;</span><span class="n">sfu_emul</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">cERROR</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span>  <span class="s">&quot;mount option mfsymlinks ignored if sfu &quot;</span>
				   <span class="s">&quot;mount option is used&quot;</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">cifs_sb</span><span class="o">-&gt;</span><span class="n">mnt_cifs_flags</span> <span class="o">|=</span> <span class="n">CIFS_MOUNT_MF_SYMLINKS</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">pvolume_info</span><span class="o">-&gt;</span><span class="n">cifs_acl</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">pvolume_info</span><span class="o">-&gt;</span><span class="n">dynperm</span><span class="p">))</span>
		<span class="n">cERROR</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;mount option dynperm ignored if cifsacl &quot;</span>
			   <span class="s">&quot;mount option supported&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * When the server supports very large reads and writes via POSIX extensions,</span>
<span class="cm"> * we can allow up to 2^24-1, minus the size of a READ/WRITE_AND_X header, not</span>
<span class="cm"> * including the RFC1001 length.</span>
<span class="cm"> *</span>
<span class="cm"> * Note that this might make for &quot;interesting&quot; allocation problems during</span>
<span class="cm"> * writeback however as we have to allocate an array of pointers for the</span>
<span class="cm"> * pages. A 16M write means ~32kb page array with PAGE_CACHE_SIZE == 4096.</span>
<span class="cm"> *</span>
<span class="cm"> * For reads, there is a similar problem as we need to allocate an array</span>
<span class="cm"> * of kvecs to handle the receive, though that should only need to be done</span>
<span class="cm"> * once.</span>
<span class="cm"> */</span>
<span class="cp">#define CIFS_MAX_WSIZE ((1&lt;&lt;24) - 1 - sizeof(WRITE_REQ) + 4)</span>
<span class="cp">#define CIFS_MAX_RSIZE ((1&lt;&lt;24) - sizeof(READ_RSP) + 4)</span>

<span class="cm">/*</span>
<span class="cm"> * When the server doesn&#39;t allow large posix writes, only allow a rsize/wsize</span>
<span class="cm"> * of 2^17-1 minus the size of the call header. That allows for a read or</span>
<span class="cm"> * write up to the maximum size described by RFC1002.</span>
<span class="cm"> */</span>
<span class="cp">#define CIFS_MAX_RFC1002_WSIZE ((1&lt;&lt;17) - 1 - sizeof(WRITE_REQ) + 4)</span>
<span class="cp">#define CIFS_MAX_RFC1002_RSIZE ((1&lt;&lt;17) - 1 - sizeof(READ_RSP) + 4)</span>

<span class="cm">/*</span>
<span class="cm"> * The default wsize is 1M. find_get_pages seems to return a maximum of 256</span>
<span class="cm"> * pages in a single call. With PAGE_CACHE_SIZE == 4k, this means we can fill</span>
<span class="cm"> * a single wsize request with a single call.</span>
<span class="cm"> */</span>
<span class="cp">#define CIFS_DEFAULT_IOSIZE (1024 * 1024)</span>

<span class="cm">/*</span>
<span class="cm"> * Windows only supports a max of 60kb reads and 65535 byte writes. Default to</span>
<span class="cm"> * those values when posix extensions aren&#39;t in force. In actuality here, we</span>
<span class="cm"> * use 65536 to allow for a write that is a multiple of 4k. Most servers seem</span>
<span class="cm"> * to be ok with the extra byte even though Windows doesn&#39;t send writes that</span>
<span class="cm"> * are that large.</span>
<span class="cm"> *</span>
<span class="cm"> * Citation:</span>
<span class="cm"> *</span>
<span class="cm"> * http://blogs.msdn.com/b/openspecification/archive/2009/04/10/smb-maximum-transmit-buffer-size-and-performance-tuning.aspx</span>
<span class="cm"> */</span>
<span class="cp">#define CIFS_DEFAULT_NON_POSIX_RSIZE (60 * 1024)</span>
<span class="cp">#define CIFS_DEFAULT_NON_POSIX_WSIZE (65536)</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span>
<span class="nf">cifs_negotiate_wsize</span><span class="p">(</span><span class="k">struct</span> <span class="n">cifs_tcon</span> <span class="o">*</span><span class="n">tcon</span><span class="p">,</span> <span class="k">struct</span> <span class="n">smb_vol</span> <span class="o">*</span><span class="n">pvolume_info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">__u64</span> <span class="n">unix_cap</span> <span class="o">=</span> <span class="n">le64_to_cpu</span><span class="p">(</span><span class="n">tcon</span><span class="o">-&gt;</span><span class="n">fsUnixInfo</span><span class="p">.</span><span class="n">Capability</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">TCP_Server_Info</span> <span class="o">*</span><span class="n">server</span> <span class="o">=</span> <span class="n">tcon</span><span class="o">-&gt;</span><span class="n">ses</span><span class="o">-&gt;</span><span class="n">server</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">wsize</span><span class="p">;</span>

	<span class="cm">/* start with specified wsize, or default */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pvolume_info</span><span class="o">-&gt;</span><span class="n">wsize</span><span class="p">)</span>
		<span class="n">wsize</span> <span class="o">=</span> <span class="n">pvolume_info</span><span class="o">-&gt;</span><span class="n">wsize</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">tcon</span><span class="o">-&gt;</span><span class="n">unix_ext</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">unix_cap</span> <span class="o">&amp;</span> <span class="n">CIFS_UNIX_LARGE_WRITE_CAP</span><span class="p">))</span>
		<span class="n">wsize</span> <span class="o">=</span> <span class="n">CIFS_DEFAULT_IOSIZE</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">wsize</span> <span class="o">=</span> <span class="n">CIFS_DEFAULT_NON_POSIX_WSIZE</span><span class="p">;</span>

	<span class="cm">/* can server support 24-bit write sizes? (via UNIX extensions) */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tcon</span><span class="o">-&gt;</span><span class="n">unix_ext</span> <span class="o">||</span> <span class="o">!</span><span class="p">(</span><span class="n">unix_cap</span> <span class="o">&amp;</span> <span class="n">CIFS_UNIX_LARGE_WRITE_CAP</span><span class="p">))</span>
		<span class="n">wsize</span> <span class="o">=</span> <span class="n">min_t</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">,</span> <span class="n">wsize</span><span class="p">,</span> <span class="n">CIFS_MAX_RFC1002_WSIZE</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * no CAP_LARGE_WRITE_X or is signing enabled without CAP_UNIX set?</span>
<span class="cm">	 * Limit it to max buffer offered by the server, minus the size of the</span>
<span class="cm">	 * WRITEX header, not including the 4 byte RFC1001 length.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">capabilities</span> <span class="o">&amp;</span> <span class="n">CAP_LARGE_WRITE_X</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">capabilities</span> <span class="o">&amp;</span> <span class="n">CAP_UNIX</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	     <span class="p">(</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">sec_mode</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">SECMODE_SIGN_ENABLED</span><span class="o">|</span><span class="n">SECMODE_SIGN_REQUIRED</span><span class="p">))))</span>
		<span class="n">wsize</span> <span class="o">=</span> <span class="n">min_t</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">,</span> <span class="n">wsize</span><span class="p">,</span>
				<span class="n">server</span><span class="o">-&gt;</span><span class="n">maxBuf</span> <span class="o">-</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">WRITE_REQ</span><span class="p">)</span> <span class="o">+</span> <span class="mi">4</span><span class="p">);</span>

	<span class="cm">/* hard limit of CIFS_MAX_WSIZE */</span>
	<span class="n">wsize</span> <span class="o">=</span> <span class="n">min_t</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">,</span> <span class="n">wsize</span><span class="p">,</span> <span class="n">CIFS_MAX_WSIZE</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">wsize</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span>
<span class="nf">cifs_negotiate_rsize</span><span class="p">(</span><span class="k">struct</span> <span class="n">cifs_tcon</span> <span class="o">*</span><span class="n">tcon</span><span class="p">,</span> <span class="k">struct</span> <span class="n">smb_vol</span> <span class="o">*</span><span class="n">pvolume_info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">__u64</span> <span class="n">unix_cap</span> <span class="o">=</span> <span class="n">le64_to_cpu</span><span class="p">(</span><span class="n">tcon</span><span class="o">-&gt;</span><span class="n">fsUnixInfo</span><span class="p">.</span><span class="n">Capability</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">TCP_Server_Info</span> <span class="o">*</span><span class="n">server</span> <span class="o">=</span> <span class="n">tcon</span><span class="o">-&gt;</span><span class="n">ses</span><span class="o">-&gt;</span><span class="n">server</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">rsize</span><span class="p">,</span> <span class="n">defsize</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Set default value...</span>
<span class="cm">	 *</span>
<span class="cm">	 * HACK alert! Ancient servers have very small buffers. Even though</span>
<span class="cm">	 * MS-CIFS indicates that servers are only limited by the client&#39;s</span>
<span class="cm">	 * bufsize for reads, testing against win98se shows that it throws</span>
<span class="cm">	 * INVALID_PARAMETER errors if you try to request too large a read.</span>
<span class="cm">	 *</span>
<span class="cm">	 * If the server advertises a MaxBufferSize of less than one page,</span>
<span class="cm">	 * assume that it also can&#39;t satisfy reads larger than that either.</span>
<span class="cm">	 *</span>
<span class="cm">	 * FIXME: Is there a better heuristic for this?</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tcon</span><span class="o">-&gt;</span><span class="n">unix_ext</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">unix_cap</span> <span class="o">&amp;</span> <span class="n">CIFS_UNIX_LARGE_READ_CAP</span><span class="p">))</span>
		<span class="n">defsize</span> <span class="o">=</span> <span class="n">CIFS_DEFAULT_IOSIZE</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">capabilities</span> <span class="o">&amp;</span> <span class="n">CAP_LARGE_READ_X</span><span class="p">)</span>
		<span class="n">defsize</span> <span class="o">=</span> <span class="n">CIFS_DEFAULT_NON_POSIX_RSIZE</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">maxBuf</span> <span class="o">&gt;=</span> <span class="n">PAGE_CACHE_SIZE</span><span class="p">)</span>
		<span class="n">defsize</span> <span class="o">=</span> <span class="n">CIFSMaxBufSize</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">defsize</span> <span class="o">=</span> <span class="n">server</span><span class="o">-&gt;</span><span class="n">maxBuf</span> <span class="o">-</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">READ_RSP</span><span class="p">);</span>

	<span class="n">rsize</span> <span class="o">=</span> <span class="n">pvolume_info</span><span class="o">-&gt;</span><span class="n">rsize</span> <span class="o">?</span> <span class="n">pvolume_info</span><span class="o">-&gt;</span><span class="n">rsize</span> <span class="o">:</span> <span class="n">defsize</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * no CAP_LARGE_READ_X? Then MS-CIFS states that we must limit this to</span>
<span class="cm">	 * the client&#39;s MaxBufferSize.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">capabilities</span> <span class="o">&amp;</span> <span class="n">CAP_LARGE_READ_X</span><span class="p">))</span>
		<span class="n">rsize</span> <span class="o">=</span> <span class="n">min_t</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">,</span> <span class="n">CIFSMaxBufSize</span><span class="p">,</span> <span class="n">rsize</span><span class="p">);</span>

	<span class="cm">/* hard limit of CIFS_MAX_RSIZE */</span>
	<span class="n">rsize</span> <span class="o">=</span> <span class="n">min_t</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">,</span> <span class="n">rsize</span><span class="p">,</span> <span class="n">CIFS_MAX_RSIZE</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">rsize</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">is_path_accessible</span><span class="p">(</span><span class="kt">int</span> <span class="n">xid</span><span class="p">,</span> <span class="k">struct</span> <span class="n">cifs_tcon</span> <span class="o">*</span><span class="n">tcon</span><span class="p">,</span>
		   <span class="k">struct</span> <span class="n">cifs_sb_info</span> <span class="o">*</span><span class="n">cifs_sb</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">full_path</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>
	<span class="n">FILE_ALL_INFO</span> <span class="o">*</span><span class="n">pfile_info</span><span class="p">;</span>

	<span class="n">pfile_info</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">FILE_ALL_INFO</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pfile_info</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">CIFSSMBQPathInfo</span><span class="p">(</span><span class="n">xid</span><span class="p">,</span> <span class="n">tcon</span><span class="p">,</span> <span class="n">full_path</span><span class="p">,</span> <span class="n">pfile_info</span><span class="p">,</span>
			      <span class="mi">0</span> <span class="cm">/* not legacy */</span><span class="p">,</span> <span class="n">cifs_sb</span><span class="o">-&gt;</span><span class="n">local_nls</span><span class="p">,</span>
			      <span class="n">cifs_sb</span><span class="o">-&gt;</span><span class="n">mnt_cifs_flags</span> <span class="o">&amp;</span>
				<span class="n">CIFS_MOUNT_MAP_SPECIAL_CHR</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span> <span class="o">||</span> <span class="n">rc</span> <span class="o">==</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">)</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">SMBQueryInformation</span><span class="p">(</span><span class="n">xid</span><span class="p">,</span> <span class="n">tcon</span><span class="p">,</span> <span class="n">full_path</span><span class="p">,</span> <span class="n">pfile_info</span><span class="p">,</span>
				<span class="n">cifs_sb</span><span class="o">-&gt;</span><span class="n">local_nls</span><span class="p">,</span> <span class="n">cifs_sb</span><span class="o">-&gt;</span><span class="n">mnt_cifs_flags</span> <span class="o">&amp;</span>
				  <span class="n">CIFS_MOUNT_MAP_SPECIAL_CHR</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">pfile_info</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">cleanup_volume_info_contents</span><span class="p">(</span><span class="k">struct</span> <span class="n">smb_vol</span> <span class="o">*</span><span class="n">volume_info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">volume_info</span><span class="o">-&gt;</span><span class="n">username</span><span class="p">);</span>
	<span class="n">kzfree</span><span class="p">(</span><span class="n">volume_info</span><span class="o">-&gt;</span><span class="n">password</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">volume_info</span><span class="o">-&gt;</span><span class="n">UNCip</span> <span class="o">!=</span> <span class="n">volume_info</span><span class="o">-&gt;</span><span class="n">UNC</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">volume_info</span><span class="o">-&gt;</span><span class="n">UNCip</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">volume_info</span><span class="o">-&gt;</span><span class="n">UNC</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">volume_info</span><span class="o">-&gt;</span><span class="n">domainname</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">volume_info</span><span class="o">-&gt;</span><span class="n">iocharset</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">volume_info</span><span class="o">-&gt;</span><span class="n">prepath</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">cifs_cleanup_volume_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">smb_vol</span> <span class="o">*</span><span class="n">volume_info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">volume_info</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">cleanup_volume_info_contents</span><span class="p">(</span><span class="n">volume_info</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">volume_info</span><span class="p">);</span>
<span class="p">}</span>


<span class="cp">#ifdef CONFIG_CIFS_DFS_UPCALL</span>
<span class="cm">/* build_path_to_root returns full path to root when</span>
<span class="cm"> * we do not have an exiting connection (tcon) */</span>
<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span>
<span class="nf">build_unc_path_to_root</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">smb_vol</span> <span class="o">*</span><span class="n">vol</span><span class="p">,</span>
		<span class="k">const</span> <span class="k">struct</span> <span class="n">cifs_sb_info</span> <span class="o">*</span><span class="n">cifs_sb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">full_path</span><span class="p">,</span> <span class="o">*</span><span class="n">pos</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">pplen</span> <span class="o">=</span> <span class="n">vol</span><span class="o">-&gt;</span><span class="n">prepath</span> <span class="o">?</span> <span class="n">strlen</span><span class="p">(</span><span class="n">vol</span><span class="o">-&gt;</span><span class="n">prepath</span><span class="p">)</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">unc_len</span> <span class="o">=</span> <span class="n">strnlen</span><span class="p">(</span><span class="n">vol</span><span class="o">-&gt;</span><span class="n">UNC</span><span class="p">,</span> <span class="n">MAX_TREE_SIZE</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">full_path</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">unc_len</span> <span class="o">+</span> <span class="n">pplen</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">full_path</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">ENOMEM</span><span class="p">);</span>

	<span class="n">strncpy</span><span class="p">(</span><span class="n">full_path</span><span class="p">,</span> <span class="n">vol</span><span class="o">-&gt;</span><span class="n">UNC</span><span class="p">,</span> <span class="n">unc_len</span><span class="p">);</span>
	<span class="n">pos</span> <span class="o">=</span> <span class="n">full_path</span> <span class="o">+</span> <span class="n">unc_len</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pplen</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">strncpy</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="n">vol</span><span class="o">-&gt;</span><span class="n">prepath</span><span class="p">,</span> <span class="n">pplen</span><span class="p">);</span>
		<span class="n">pos</span> <span class="o">+=</span> <span class="n">pplen</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="o">*</span><span class="n">pos</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span> <span class="cm">/* add trailing null */</span>
	<span class="n">convert_delimiter</span><span class="p">(</span><span class="n">full_path</span><span class="p">,</span> <span class="n">CIFS_DIR_SEP</span><span class="p">(</span><span class="n">cifs_sb</span><span class="p">));</span>
	<span class="n">cFYI</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;%s: full_path=%s&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">full_path</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">full_path</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Perform a dfs referral query for a share and (optionally) prefix</span>
<span class="cm"> *</span>
<span class="cm"> * If a referral is found, cifs_sb-&gt;mountdata will be (re-)allocated</span>
<span class="cm"> * to a string containing updated options for the submount.  Otherwise it</span>
<span class="cm"> * will be left untouched.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns the rc from get_dfs_path to the caller, which can be used to</span>
<span class="cm"> * determine whether there were referrals.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">expand_dfs_referral</span><span class="p">(</span><span class="kt">int</span> <span class="n">xid</span><span class="p">,</span> <span class="k">struct</span> <span class="n">cifs_ses</span> <span class="o">*</span><span class="n">pSesInfo</span><span class="p">,</span>
		    <span class="k">struct</span> <span class="n">smb_vol</span> <span class="o">*</span><span class="n">volume_info</span><span class="p">,</span> <span class="k">struct</span> <span class="n">cifs_sb_info</span> <span class="o">*</span><span class="n">cifs_sb</span><span class="p">,</span>
		    <span class="kt">int</span> <span class="n">check_prefix</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">num_referrals</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dfs_info3_param</span> <span class="o">*</span><span class="n">referrals</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">full_path</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">*</span><span class="n">ref_path</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">*</span><span class="n">mdata</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">full_path</span> <span class="o">=</span> <span class="n">build_unc_path_to_root</span><span class="p">(</span><span class="n">volume_info</span><span class="p">,</span> <span class="n">cifs_sb</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">full_path</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">full_path</span><span class="p">);</span>

	<span class="cm">/* For DFS paths, skip the first &#39;\&#39; of the UNC */</span>
	<span class="n">ref_path</span> <span class="o">=</span> <span class="n">check_prefix</span> <span class="o">?</span> <span class="n">full_path</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">:</span> <span class="n">volume_info</span><span class="o">-&gt;</span><span class="n">UNC</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">get_dfs_path</span><span class="p">(</span><span class="n">xid</span><span class="p">,</span> <span class="n">pSesInfo</span> <span class="p">,</span> <span class="n">ref_path</span><span class="p">,</span> <span class="n">cifs_sb</span><span class="o">-&gt;</span><span class="n">local_nls</span><span class="p">,</span>
			  <span class="o">&amp;</span><span class="n">num_referrals</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">referrals</span><span class="p">,</span>
			  <span class="n">cifs_sb</span><span class="o">-&gt;</span><span class="n">mnt_cifs_flags</span> <span class="o">&amp;</span> <span class="n">CIFS_MOUNT_MAP_SPECIAL_CHR</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rc</span> <span class="o">&amp;&amp;</span> <span class="n">num_referrals</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">char</span> <span class="o">*</span><span class="n">fake_devname</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

		<span class="n">mdata</span> <span class="o">=</span> <span class="n">cifs_compose_mount_options</span><span class="p">(</span><span class="n">cifs_sb</span><span class="o">-&gt;</span><span class="n">mountdata</span><span class="p">,</span>
						   <span class="n">full_path</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">referrals</span><span class="p">,</span>
						   <span class="o">&amp;</span><span class="n">fake_devname</span><span class="p">);</span>

		<span class="n">free_dfs_info_array</span><span class="p">(</span><span class="n">referrals</span><span class="p">,</span> <span class="n">num_referrals</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">mdata</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">mdata</span><span class="p">);</span>
			<span class="n">mdata</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">cleanup_volume_info_contents</span><span class="p">(</span><span class="n">volume_info</span><span class="p">);</span>
			<span class="n">memset</span><span class="p">(</span><span class="n">volume_info</span><span class="p">,</span> <span class="sc">&#39;\0&#39;</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">volume_info</span><span class="p">));</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="n">cifs_setup_volume_info</span><span class="p">(</span><span class="n">volume_info</span><span class="p">,</span> <span class="n">mdata</span><span class="p">,</span>
							<span class="n">fake_devname</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">fake_devname</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">cifs_sb</span><span class="o">-&gt;</span><span class="n">mountdata</span><span class="p">);</span>
		<span class="n">cifs_sb</span><span class="o">-&gt;</span><span class="n">mountdata</span> <span class="o">=</span> <span class="n">mdata</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">full_path</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">cifs_setup_volume_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">smb_vol</span> <span class="o">*</span><span class="n">volume_info</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">mount_data</span><span class="p">,</span>
			<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">devname</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cifs_parse_mount_options</span><span class="p">(</span><span class="n">mount_data</span><span class="p">,</span> <span class="n">devname</span><span class="p">,</span> <span class="n">volume_info</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>


	<span class="k">if</span> <span class="p">(</span><span class="n">volume_info</span><span class="o">-&gt;</span><span class="n">nullauth</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cFYI</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;Anonymous login&quot;</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">volume_info</span><span class="o">-&gt;</span><span class="n">username</span><span class="p">);</span>
		<span class="n">volume_info</span><span class="o">-&gt;</span><span class="n">username</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">volume_info</span><span class="o">-&gt;</span><span class="n">username</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* BB fixme parse for domain name here */</span>
		<span class="n">cFYI</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;Username: %s&quot;</span><span class="p">,</span> <span class="n">volume_info</span><span class="o">-&gt;</span><span class="n">username</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">cifserror</span><span class="p">(</span><span class="s">&quot;No username specified&quot;</span><span class="p">);</span>
	<span class="cm">/* In userspace mount helper we can get user name from alternate</span>
<span class="cm">	   locations such as env variables and files on disk */</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* this is needed for ASCII cp to Unicode converts */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">volume_info</span><span class="o">-&gt;</span><span class="n">iocharset</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* load_nls_default cannot return null */</span>
		<span class="n">volume_info</span><span class="o">-&gt;</span><span class="n">local_nls</span> <span class="o">=</span> <span class="n">load_nls_default</span><span class="p">();</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">volume_info</span><span class="o">-&gt;</span><span class="n">local_nls</span> <span class="o">=</span> <span class="n">load_nls</span><span class="p">(</span><span class="n">volume_info</span><span class="o">-&gt;</span><span class="n">iocharset</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">volume_info</span><span class="o">-&gt;</span><span class="n">local_nls</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">cERROR</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;CIFS mount error: iocharset %s not found&quot;</span><span class="p">,</span>
				 <span class="n">volume_info</span><span class="o">-&gt;</span><span class="n">iocharset</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ELIBACC</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">smb_vol</span> <span class="o">*</span>
<span class="nf">cifs_get_volume_info</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">mount_data</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">devname</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">smb_vol</span> <span class="o">*</span><span class="n">volume_info</span><span class="p">;</span>

	<span class="n">volume_info</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">smb_vol</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">volume_info</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">ENOMEM</span><span class="p">);</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">cifs_setup_volume_info</span><span class="p">(</span><span class="n">volume_info</span><span class="p">,</span> <span class="n">mount_data</span><span class="p">,</span> <span class="n">devname</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cifs_cleanup_volume_info</span><span class="p">(</span><span class="n">volume_info</span><span class="p">);</span>
		<span class="n">volume_info</span> <span class="o">=</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="n">rc</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">volume_info</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="nf">cifs_mount</span><span class="p">(</span><span class="k">struct</span> <span class="n">cifs_sb_info</span> <span class="o">*</span><span class="n">cifs_sb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">smb_vol</span> <span class="o">*</span><span class="n">volume_info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">xid</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cifs_ses</span> <span class="o">*</span><span class="n">pSesInfo</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cifs_tcon</span> <span class="o">*</span><span class="n">tcon</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">TCP_Server_Info</span> <span class="o">*</span><span class="n">srvTcp</span><span class="p">;</span>
	<span class="kt">char</span>   <span class="o">*</span><span class="n">full_path</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tcon_link</span> <span class="o">*</span><span class="n">tlink</span><span class="p">;</span>
<span class="cp">#ifdef CONFIG_CIFS_DFS_UPCALL</span>
	<span class="kt">int</span> <span class="n">referral_walks_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">bdi_setup_and_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cifs_sb</span><span class="o">-&gt;</span><span class="n">bdi</span><span class="p">,</span> <span class="s">&quot;cifs&quot;</span><span class="p">,</span> <span class="n">BDI_CAP_MAP_COPY</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_CIFS_DFS_UPCALL</span>
<span class="nl">try_mount_again:</span>
	<span class="cm">/* cleanup activities if we&#39;re chasing a referral */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">referral_walks_count</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tcon</span><span class="p">)</span>
			<span class="n">cifs_put_tcon</span><span class="p">(</span><span class="n">tcon</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">pSesInfo</span><span class="p">)</span>
			<span class="n">cifs_put_smb_ses</span><span class="p">(</span><span class="n">pSesInfo</span><span class="p">);</span>

		<span class="n">FreeXid</span><span class="p">(</span><span class="n">xid</span><span class="p">);</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">tcon</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">pSesInfo</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">srvTcp</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">full_path</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">tlink</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">xid</span> <span class="o">=</span> <span class="n">GetXid</span><span class="p">();</span>

	<span class="cm">/* get a reference to a tcp session */</span>
	<span class="n">srvTcp</span> <span class="o">=</span> <span class="n">cifs_get_tcp_session</span><span class="p">(</span><span class="n">volume_info</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">srvTcp</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">srvTcp</span><span class="p">);</span>
		<span class="n">bdi_destroy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cifs_sb</span><span class="o">-&gt;</span><span class="n">bdi</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* get a reference to a SMB session */</span>
	<span class="n">pSesInfo</span> <span class="o">=</span> <span class="n">cifs_get_smb_ses</span><span class="p">(</span><span class="n">srvTcp</span><span class="p">,</span> <span class="n">volume_info</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">pSesInfo</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">pSesInfo</span><span class="p">);</span>
		<span class="n">pSesInfo</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">mount_fail_check</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* search for existing tcon to this server share */</span>
	<span class="n">tcon</span> <span class="o">=</span> <span class="n">cifs_get_tcon</span><span class="p">(</span><span class="n">pSesInfo</span><span class="p">,</span> <span class="n">volume_info</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">tcon</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">tcon</span><span class="p">);</span>
		<span class="n">tcon</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">remote_path_check</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* tell server which Unix caps we support */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tcon</span><span class="o">-&gt;</span><span class="n">ses</span><span class="o">-&gt;</span><span class="n">capabilities</span> <span class="o">&amp;</span> <span class="n">CAP_UNIX</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* reset of caps checks mount to see if unix extensions</span>
<span class="cm">		   disabled for just this mount */</span>
		<span class="n">reset_cifs_unix_caps</span><span class="p">(</span><span class="n">xid</span><span class="p">,</span> <span class="n">tcon</span><span class="p">,</span> <span class="n">cifs_sb</span><span class="p">,</span> <span class="n">volume_info</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">tcon</span><span class="o">-&gt;</span><span class="n">ses</span><span class="o">-&gt;</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">tcpStatus</span> <span class="o">==</span> <span class="n">CifsNeedReconnect</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">le64_to_cpu</span><span class="p">(</span><span class="n">tcon</span><span class="o">-&gt;</span><span class="n">fsUnixInfo</span><span class="p">.</span><span class="n">Capability</span><span class="p">)</span> <span class="o">&amp;</span>
		     <span class="n">CIFS_UNIX_TRANSPORT_ENCRYPTION_MANDATORY_CAP</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EACCES</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">mount_fail_check</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">tcon</span><span class="o">-&gt;</span><span class="n">unix_ext</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* server does not support them */</span>

	<span class="cm">/* do not care if following two calls succeed - informational */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tcon</span><span class="o">-&gt;</span><span class="n">ipc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">CIFSSMBQFSDeviceInfo</span><span class="p">(</span><span class="n">xid</span><span class="p">,</span> <span class="n">tcon</span><span class="p">);</span>
		<span class="n">CIFSSMBQFSAttributeInfo</span><span class="p">(</span><span class="n">xid</span><span class="p">,</span> <span class="n">tcon</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">cifs_sb</span><span class="o">-&gt;</span><span class="n">wsize</span> <span class="o">=</span> <span class="n">cifs_negotiate_wsize</span><span class="p">(</span><span class="n">tcon</span><span class="p">,</span> <span class="n">volume_info</span><span class="p">);</span>
	<span class="n">cifs_sb</span><span class="o">-&gt;</span><span class="n">rsize</span> <span class="o">=</span> <span class="n">cifs_negotiate_rsize</span><span class="p">(</span><span class="n">tcon</span><span class="p">,</span> <span class="n">volume_info</span><span class="p">);</span>

	<span class="cm">/* tune readahead according to rsize */</span>
	<span class="n">cifs_sb</span><span class="o">-&gt;</span><span class="n">bdi</span><span class="p">.</span><span class="n">ra_pages</span> <span class="o">=</span> <span class="n">cifs_sb</span><span class="o">-&gt;</span><span class="n">rsize</span> <span class="o">/</span> <span class="n">PAGE_CACHE_SIZE</span><span class="p">;</span>

<span class="nl">remote_path_check:</span>
<span class="cp">#ifdef CONFIG_CIFS_DFS_UPCALL</span>
	<span class="cm">/*</span>
<span class="cm">	 * Perform an unconditional check for whether there are DFS</span>
<span class="cm">	 * referrals for this path without prefix, to provide support</span>
<span class="cm">	 * for DFS referrals from w2k8 servers which don&#39;t seem to respond</span>
<span class="cm">	 * with PATH_NOT_COVERED to requests that include the prefix.</span>
<span class="cm">	 * Chase the referral if found, otherwise continue normally.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">referral_walks_count</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">refrc</span> <span class="o">=</span> <span class="n">expand_dfs_referral</span><span class="p">(</span><span class="n">xid</span><span class="p">,</span> <span class="n">pSesInfo</span><span class="p">,</span> <span class="n">volume_info</span><span class="p">,</span>
						<span class="n">cifs_sb</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">refrc</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">referral_walks_count</span><span class="o">++</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">try_mount_again</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="cp">#endif</span>

	<span class="cm">/* check if a whole path is not remote */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rc</span> <span class="o">&amp;&amp;</span> <span class="n">tcon</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* build_path_to_root works only when we have a valid tcon */</span>
		<span class="n">full_path</span> <span class="o">=</span> <span class="n">cifs_build_path_to_root</span><span class="p">(</span><span class="n">volume_info</span><span class="p">,</span> <span class="n">cifs_sb</span><span class="p">,</span> <span class="n">tcon</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">full_path</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">mount_fail_check</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">is_path_accessible</span><span class="p">(</span><span class="n">xid</span><span class="p">,</span> <span class="n">tcon</span><span class="p">,</span> <span class="n">cifs_sb</span><span class="p">,</span> <span class="n">full_path</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">rc</span> <span class="o">!=</span> <span class="o">-</span><span class="n">EREMOTE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">full_path</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">mount_fail_check</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">full_path</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* get referral if needed */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="o">-</span><span class="n">EREMOTE</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#ifdef CONFIG_CIFS_DFS_UPCALL</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">referral_walks_count</span> <span class="o">&gt;</span> <span class="n">MAX_NESTED_LINKS</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * BB: when we implement proper loop detection,</span>
<span class="cm">			 *     we will remove this check. But now we need it</span>
<span class="cm">			 *     to prevent an indefinite loop if &#39;DFS tree&#39; is</span>
<span class="cm">			 *     misconfigured (i.e. has loops).</span>
<span class="cm">			 */</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ELOOP</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">mount_fail_check</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">rc</span> <span class="o">=</span> <span class="n">expand_dfs_referral</span><span class="p">(</span><span class="n">xid</span><span class="p">,</span> <span class="n">pSesInfo</span><span class="p">,</span> <span class="n">volume_info</span><span class="p">,</span> <span class="n">cifs_sb</span><span class="p">,</span>
					 <span class="nb">true</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">referral_walks_count</span><span class="o">++</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">try_mount_again</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">goto</span> <span class="n">mount_fail_check</span><span class="p">;</span>
<span class="cp">#else </span><span class="cm">/* No DFS support, return error on mount */</span><span class="cp"></span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">mount_fail_check</span><span class="p">;</span>

	<span class="cm">/* now, hang the tcon off of the superblock */</span>
	<span class="n">tlink</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span> <span class="o">*</span><span class="n">tlink</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tlink</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">mount_fail_check</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">tlink</span><span class="o">-&gt;</span><span class="n">tl_uid</span> <span class="o">=</span> <span class="n">pSesInfo</span><span class="o">-&gt;</span><span class="n">linux_uid</span><span class="p">;</span>
	<span class="n">tlink</span><span class="o">-&gt;</span><span class="n">tl_tcon</span> <span class="o">=</span> <span class="n">tcon</span><span class="p">;</span>
	<span class="n">tlink</span><span class="o">-&gt;</span><span class="n">tl_time</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
	<span class="n">set_bit</span><span class="p">(</span><span class="n">TCON_LINK_MASTER</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tlink</span><span class="o">-&gt;</span><span class="n">tl_flags</span><span class="p">);</span>
	<span class="n">set_bit</span><span class="p">(</span><span class="n">TCON_LINK_IN_TREE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tlink</span><span class="o">-&gt;</span><span class="n">tl_flags</span><span class="p">);</span>

	<span class="n">cifs_sb</span><span class="o">-&gt;</span><span class="n">master_tlink</span> <span class="o">=</span> <span class="n">tlink</span><span class="p">;</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cifs_sb</span><span class="o">-&gt;</span><span class="n">tlink_tree_lock</span><span class="p">);</span>
	<span class="n">tlink_rb_insert</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cifs_sb</span><span class="o">-&gt;</span><span class="n">tlink_tree</span><span class="p">,</span> <span class="n">tlink</span><span class="p">);</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cifs_sb</span><span class="o">-&gt;</span><span class="n">tlink_tree_lock</span><span class="p">);</span>

	<span class="n">queue_delayed_work</span><span class="p">(</span><span class="n">cifsiod_wq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cifs_sb</span><span class="o">-&gt;</span><span class="n">prune_tlinks</span><span class="p">,</span>
				<span class="n">TLINK_IDLE_EXPIRE</span><span class="p">);</span>

<span class="nl">mount_fail_check:</span>
	<span class="cm">/* on error free sesinfo and tcon struct if needed */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* If find_unc succeeded then rc == 0 so we can not end */</span>
		<span class="cm">/* up accidentally freeing someone elses tcon struct */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tcon</span><span class="p">)</span>
			<span class="n">cifs_put_tcon</span><span class="p">(</span><span class="n">tcon</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">pSesInfo</span><span class="p">)</span>
			<span class="n">cifs_put_smb_ses</span><span class="p">(</span><span class="n">pSesInfo</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">cifs_put_tcp_session</span><span class="p">(</span><span class="n">srvTcp</span><span class="p">);</span>
		<span class="n">bdi_destroy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cifs_sb</span><span class="o">-&gt;</span><span class="n">bdi</span><span class="p">);</span>
	<span class="p">}</span>

<span class="nl">out:</span>
	<span class="n">FreeXid</span><span class="p">(</span><span class="n">xid</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Issue a TREE_CONNECT request. Note that for IPC$ shares, that the tcon</span>
<span class="cm"> * pointer may be NULL.</span>
<span class="cm"> */</span>
<span class="kt">int</span>
<span class="nf">CIFSTCon</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">xid</span><span class="p">,</span> <span class="k">struct</span> <span class="n">cifs_ses</span> <span class="o">*</span><span class="n">ses</span><span class="p">,</span>
	 <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">tree</span><span class="p">,</span> <span class="k">struct</span> <span class="n">cifs_tcon</span> <span class="o">*</span><span class="n">tcon</span><span class="p">,</span>
	 <span class="k">const</span> <span class="k">struct</span> <span class="n">nls_table</span> <span class="o">*</span><span class="n">nls_codepage</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">smb_hdr</span> <span class="o">*</span><span class="n">smb_buffer</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">smb_hdr</span> <span class="o">*</span><span class="n">smb_buffer_response</span><span class="p">;</span>
	<span class="n">TCONX_REQ</span> <span class="o">*</span><span class="n">pSMB</span><span class="p">;</span>
	<span class="n">TCONX_RSP</span> <span class="o">*</span><span class="n">pSMBr</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">bcc_ptr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">length</span><span class="p">;</span>
	<span class="n">__u16</span> <span class="n">bytes_left</span><span class="p">,</span> <span class="n">count</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ses</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="n">smb_buffer</span> <span class="o">=</span> <span class="n">cifs_buf_get</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">smb_buffer</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">smb_buffer_response</span> <span class="o">=</span> <span class="n">smb_buffer</span><span class="p">;</span>

	<span class="n">header_assemble</span><span class="p">(</span><span class="n">smb_buffer</span><span class="p">,</span> <span class="n">SMB_COM_TREE_CONNECT_ANDX</span><span class="p">,</span>
			<span class="nb">NULL</span> <span class="cm">/*no tid */</span> <span class="p">,</span> <span class="mi">4</span> <span class="cm">/*wct */</span> <span class="p">);</span>

	<span class="n">smb_buffer</span><span class="o">-&gt;</span><span class="n">Mid</span> <span class="o">=</span> <span class="n">get_next_mid</span><span class="p">(</span><span class="n">ses</span><span class="o">-&gt;</span><span class="n">server</span><span class="p">);</span>
	<span class="n">smb_buffer</span><span class="o">-&gt;</span><span class="n">Uid</span> <span class="o">=</span> <span class="n">ses</span><span class="o">-&gt;</span><span class="n">Suid</span><span class="p">;</span>
	<span class="n">pSMB</span> <span class="o">=</span> <span class="p">(</span><span class="n">TCONX_REQ</span> <span class="o">*</span><span class="p">)</span> <span class="n">smb_buffer</span><span class="p">;</span>
	<span class="n">pSMBr</span> <span class="o">=</span> <span class="p">(</span><span class="n">TCONX_RSP</span> <span class="o">*</span><span class="p">)</span> <span class="n">smb_buffer_response</span><span class="p">;</span>

	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">AndXCommand</span> <span class="o">=</span> <span class="mh">0xFF</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">Flags</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">TCON_EXTENDED_SECINFO</span><span class="p">);</span>
	<span class="n">bcc_ptr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">Password</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tcon</span> <span class="o">||</span> <span class="p">(</span><span class="n">ses</span><span class="o">-&gt;</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">sec_mode</span> <span class="o">&amp;</span> <span class="n">SECMODE_USER</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">PasswordLength</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>	<span class="cm">/* minimum */</span>
		<span class="o">*</span><span class="n">bcc_ptr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* password is null byte */</span>
		<span class="n">bcc_ptr</span><span class="o">++</span><span class="p">;</span>              <span class="cm">/* skip password */</span>
		<span class="cm">/* already aligned so no need to do it below */</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">PasswordLength</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">CIFS_AUTH_RESP_SIZE</span><span class="p">);</span>
		<span class="cm">/* BB FIXME add code to fail this if NTLMv2 or Kerberos</span>
<span class="cm">		   specified as required (when that support is added to</span>
<span class="cm">		   the vfs in the future) as only NTLM or the much</span>
<span class="cm">		   weaker LANMAN (which we do not send by default) is accepted</span>
<span class="cm">		   by Samba (not sure whether other servers allow</span>
<span class="cm">		   NTLMv2 password here) */</span>
<span class="cp">#ifdef CONFIG_CIFS_WEAK_PW_HASH</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">global_secflags</span> <span class="o">&amp;</span> <span class="n">CIFSSEC_MAY_LANMAN</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">ses</span><span class="o">-&gt;</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">secType</span> <span class="o">==</span> <span class="n">LANMAN</span><span class="p">))</span>
			<span class="n">calc_lanman_hash</span><span class="p">(</span><span class="n">tcon</span><span class="o">-&gt;</span><span class="n">password</span><span class="p">,</span> <span class="n">ses</span><span class="o">-&gt;</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">cryptkey</span><span class="p">,</span>
					 <span class="n">ses</span><span class="o">-&gt;</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">sec_mode</span> <span class="o">&amp;</span>
					    <span class="n">SECMODE_PW_ENCRYPT</span> <span class="o">?</span> <span class="nb">true</span> <span class="o">:</span> <span class="nb">false</span><span class="p">,</span>
					 <span class="n">bcc_ptr</span><span class="p">);</span>
		<span class="k">else</span>
<span class="cp">#endif </span><span class="cm">/* CIFS_WEAK_PW_HASH */</span><span class="cp"></span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">SMBNTencrypt</span><span class="p">(</span><span class="n">tcon</span><span class="o">-&gt;</span><span class="n">password</span><span class="p">,</span> <span class="n">ses</span><span class="o">-&gt;</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">cryptkey</span><span class="p">,</span>
					<span class="n">bcc_ptr</span><span class="p">,</span> <span class="n">nls_codepage</span><span class="p">);</span>

		<span class="n">bcc_ptr</span> <span class="o">+=</span> <span class="n">CIFS_AUTH_RESP_SIZE</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ses</span><span class="o">-&gt;</span><span class="n">capabilities</span> <span class="o">&amp;</span> <span class="n">CAP_UNICODE</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* must align unicode strings */</span>
			<span class="o">*</span><span class="n">bcc_ptr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* null byte password */</span>
			<span class="n">bcc_ptr</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ses</span><span class="o">-&gt;</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">sec_mode</span> <span class="o">&amp;</span>
			<span class="p">(</span><span class="n">SECMODE_SIGN_REQUIRED</span> <span class="o">|</span> <span class="n">SECMODE_SIGN_ENABLED</span><span class="p">))</span>
		<span class="n">smb_buffer</span><span class="o">-&gt;</span><span class="n">Flags2</span> <span class="o">|=</span> <span class="n">SMBFLG2_SECURITY_SIGNATURE</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ses</span><span class="o">-&gt;</span><span class="n">capabilities</span> <span class="o">&amp;</span> <span class="n">CAP_STATUS32</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">smb_buffer</span><span class="o">-&gt;</span><span class="n">Flags2</span> <span class="o">|=</span> <span class="n">SMBFLG2_ERR_STATUS</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ses</span><span class="o">-&gt;</span><span class="n">capabilities</span> <span class="o">&amp;</span> <span class="n">CAP_DFS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">smb_buffer</span><span class="o">-&gt;</span><span class="n">Flags2</span> <span class="o">|=</span> <span class="n">SMBFLG2_DFS</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ses</span><span class="o">-&gt;</span><span class="n">capabilities</span> <span class="o">&amp;</span> <span class="n">CAP_UNICODE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">smb_buffer</span><span class="o">-&gt;</span><span class="n">Flags2</span> <span class="o">|=</span> <span class="n">SMBFLG2_UNICODE</span><span class="p">;</span>
		<span class="n">length</span> <span class="o">=</span>
		    <span class="n">cifs_strtoUTF16</span><span class="p">((</span><span class="n">__le16</span> <span class="o">*</span><span class="p">)</span> <span class="n">bcc_ptr</span><span class="p">,</span> <span class="n">tree</span><span class="p">,</span>
			<span class="mi">6</span> <span class="cm">/* max utf8 char length in bytes */</span> <span class="o">*</span>
			<span class="p">(</span><span class="cm">/* server len*/</span> <span class="o">+</span> <span class="mi">256</span> <span class="cm">/* share len */</span><span class="p">),</span> <span class="n">nls_codepage</span><span class="p">);</span>
		<span class="n">bcc_ptr</span> <span class="o">+=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">length</span><span class="p">;</span>	<span class="cm">/* convert num 16 bit words to bytes */</span>
		<span class="n">bcc_ptr</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>	<span class="cm">/* skip trailing null */</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>		<span class="cm">/* ASCII */</span>
		<span class="n">strcpy</span><span class="p">(</span><span class="n">bcc_ptr</span><span class="p">,</span> <span class="n">tree</span><span class="p">);</span>
		<span class="n">bcc_ptr</span> <span class="o">+=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">tree</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">strcpy</span><span class="p">(</span><span class="n">bcc_ptr</span><span class="p">,</span> <span class="s">&quot;?????&quot;</span><span class="p">);</span>
	<span class="n">bcc_ptr</span> <span class="o">+=</span> <span class="n">strlen</span><span class="p">(</span><span class="s">&quot;?????&quot;</span><span class="p">);</span>
	<span class="n">bcc_ptr</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">count</span> <span class="o">=</span> <span class="n">bcc_ptr</span> <span class="o">-</span> <span class="o">&amp;</span><span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">Password</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">smb_buf_length</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">be32_to_cpu</span><span class="p">(</span>
					<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">smb_buf_length</span><span class="p">)</span> <span class="o">+</span> <span class="n">count</span><span class="p">);</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">ByteCount</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">count</span><span class="p">);</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">SendReceive</span><span class="p">(</span><span class="n">xid</span><span class="p">,</span> <span class="n">ses</span><span class="p">,</span> <span class="n">smb_buffer</span><span class="p">,</span> <span class="n">smb_buffer_response</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">length</span><span class="p">,</span>
			 <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* above now done in SendReceive */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">rc</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">tcon</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">bool</span> <span class="n">is_unicode</span><span class="p">;</span>

		<span class="n">tcon</span><span class="o">-&gt;</span><span class="n">tidStatus</span> <span class="o">=</span> <span class="n">CifsGood</span><span class="p">;</span>
		<span class="n">tcon</span><span class="o">-&gt;</span><span class="n">need_reconnect</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="n">tcon</span><span class="o">-&gt;</span><span class="n">tid</span> <span class="o">=</span> <span class="n">smb_buffer_response</span><span class="o">-&gt;</span><span class="n">Tid</span><span class="p">;</span>
		<span class="n">bcc_ptr</span> <span class="o">=</span> <span class="n">pByteArea</span><span class="p">(</span><span class="n">smb_buffer_response</span><span class="p">);</span>
		<span class="n">bytes_left</span> <span class="o">=</span> <span class="n">get_bcc</span><span class="p">(</span><span class="n">smb_buffer_response</span><span class="p">);</span>
		<span class="n">length</span> <span class="o">=</span> <span class="n">strnlen</span><span class="p">(</span><span class="n">bcc_ptr</span><span class="p">,</span> <span class="n">bytes_left</span> <span class="o">-</span> <span class="mi">2</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">smb_buffer</span><span class="o">-&gt;</span><span class="n">Flags2</span> <span class="o">&amp;</span> <span class="n">SMBFLG2_UNICODE</span><span class="p">)</span>
			<span class="n">is_unicode</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">is_unicode</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>


		<span class="cm">/* skip service field (NB: this field is always ASCII) */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">length</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">bcc_ptr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;I&#39;</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">bcc_ptr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;P&#39;</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			    <span class="p">(</span><span class="n">bcc_ptr</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;C&#39;</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">cFYI</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;IPC connection&quot;</span><span class="p">);</span>
				<span class="n">tcon</span><span class="o">-&gt;</span><span class="n">ipc</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">length</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">bcc_ptr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;A&#39;</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">bcc_ptr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;:&#39;</span><span class="p">))</span> <span class="p">{</span>
				<span class="cm">/* the most common case */</span>
				<span class="n">cFYI</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;disk share connection&quot;</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">bcc_ptr</span> <span class="o">+=</span> <span class="n">length</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">bytes_left</span> <span class="o">-=</span> <span class="p">(</span><span class="n">length</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">strncpy</span><span class="p">(</span><span class="n">tcon</span><span class="o">-&gt;</span><span class="n">treeName</span><span class="p">,</span> <span class="n">tree</span><span class="p">,</span> <span class="n">MAX_TREE_SIZE</span><span class="p">);</span>

		<span class="cm">/* mostly informational -- no need to fail on error here */</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">tcon</span><span class="o">-&gt;</span><span class="n">nativeFileSystem</span><span class="p">);</span>
		<span class="n">tcon</span><span class="o">-&gt;</span><span class="n">nativeFileSystem</span> <span class="o">=</span> <span class="n">cifs_strndup_from_utf16</span><span class="p">(</span><span class="n">bcc_ptr</span><span class="p">,</span>
						      <span class="n">bytes_left</span><span class="p">,</span> <span class="n">is_unicode</span><span class="p">,</span>
						      <span class="n">nls_codepage</span><span class="p">);</span>

		<span class="n">cFYI</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;nativeFileSystem=%s&quot;</span><span class="p">,</span> <span class="n">tcon</span><span class="o">-&gt;</span><span class="n">nativeFileSystem</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">smb_buffer_response</span><span class="o">-&gt;</span><span class="n">WordCount</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span> <span class="o">||</span>
			 <span class="p">(</span><span class="n">smb_buffer_response</span><span class="o">-&gt;</span><span class="n">WordCount</span> <span class="o">==</span> <span class="mi">7</span><span class="p">))</span>
			<span class="cm">/* field is in same location */</span>
			<span class="n">tcon</span><span class="o">-&gt;</span><span class="n">Flags</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">pSMBr</span><span class="o">-&gt;</span><span class="n">OptionalSupport</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">tcon</span><span class="o">-&gt;</span><span class="n">Flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">cFYI</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;Tcon flags: 0x%x &quot;</span><span class="p">,</span> <span class="n">tcon</span><span class="o">-&gt;</span><span class="n">Flags</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">rc</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">tcon</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* all we need to save for IPC$ connection */</span>
		<span class="n">ses</span><span class="o">-&gt;</span><span class="n">ipc_tid</span> <span class="o">=</span> <span class="n">smb_buffer_response</span><span class="o">-&gt;</span><span class="n">Tid</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">cifs_buf_release</span><span class="p">(</span><span class="n">smb_buffer</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">cifs_umount</span><span class="p">(</span><span class="k">struct</span> <span class="n">cifs_sb_info</span> <span class="o">*</span><span class="n">cifs_sb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rb_root</span> <span class="o">*</span><span class="n">root</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">cifs_sb</span><span class="o">-&gt;</span><span class="n">tlink_tree</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rb_node</span> <span class="o">*</span><span class="n">node</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tcon_link</span> <span class="o">*</span><span class="n">tlink</span><span class="p">;</span>

	<span class="n">cancel_delayed_work_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cifs_sb</span><span class="o">-&gt;</span><span class="n">prune_tlinks</span><span class="p">);</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cifs_sb</span><span class="o">-&gt;</span><span class="n">tlink_tree_lock</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">((</span><span class="n">node</span> <span class="o">=</span> <span class="n">rb_first</span><span class="p">(</span><span class="n">root</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">tlink</span> <span class="o">=</span> <span class="n">rb_entry</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="k">struct</span> <span class="n">tcon_link</span><span class="p">,</span> <span class="n">tl_rbnode</span><span class="p">);</span>
		<span class="n">cifs_get_tlink</span><span class="p">(</span><span class="n">tlink</span><span class="p">);</span>
		<span class="n">clear_bit</span><span class="p">(</span><span class="n">TCON_LINK_IN_TREE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tlink</span><span class="o">-&gt;</span><span class="n">tl_flags</span><span class="p">);</span>
		<span class="n">rb_erase</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">root</span><span class="p">);</span>

		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cifs_sb</span><span class="o">-&gt;</span><span class="n">tlink_tree_lock</span><span class="p">);</span>
		<span class="n">cifs_put_tlink</span><span class="p">(</span><span class="n">tlink</span><span class="p">);</span>
		<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cifs_sb</span><span class="o">-&gt;</span><span class="n">tlink_tree_lock</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cifs_sb</span><span class="o">-&gt;</span><span class="n">tlink_tree_lock</span><span class="p">);</span>

	<span class="n">bdi_destroy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cifs_sb</span><span class="o">-&gt;</span><span class="n">bdi</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">cifs_sb</span><span class="o">-&gt;</span><span class="n">mountdata</span><span class="p">);</span>
	<span class="n">unload_nls</span><span class="p">(</span><span class="n">cifs_sb</span><span class="o">-&gt;</span><span class="n">local_nls</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">cifs_sb</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">cifs_negotiate_protocol</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">xid</span><span class="p">,</span> <span class="k">struct</span> <span class="n">cifs_ses</span> <span class="o">*</span><span class="n">ses</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">TCP_Server_Info</span> <span class="o">*</span><span class="n">server</span> <span class="o">=</span> <span class="n">ses</span><span class="o">-&gt;</span><span class="n">server</span><span class="p">;</span>

	<span class="cm">/* only send once per connect */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">maxBuf</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">set_credits</span><span class="p">(</span><span class="n">server</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">CIFSSMBNegotiate</span><span class="p">(</span><span class="n">xid</span><span class="p">,</span> <span class="n">ses</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* retry only once on 1st time connection */</span>
		<span class="n">set_credits</span><span class="p">(</span><span class="n">server</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">CIFSSMBNegotiate</span><span class="p">(</span><span class="n">xid</span><span class="p">,</span> <span class="n">ses</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">)</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EHOSTDOWN</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">GlobalMid_Lock</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">tcpStatus</span> <span class="o">==</span> <span class="n">CifsNeedNegotiate</span><span class="p">)</span>
			<span class="n">server</span><span class="o">-&gt;</span><span class="n">tcpStatus</span> <span class="o">=</span> <span class="n">CifsGood</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EHOSTDOWN</span><span class="p">;</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">GlobalMid_Lock</span><span class="p">);</span>

	<span class="p">}</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>


<span class="kt">int</span> <span class="nf">cifs_setup_session</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">xid</span><span class="p">,</span> <span class="k">struct</span> <span class="n">cifs_ses</span> <span class="o">*</span><span class="n">ses</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">nls_table</span> <span class="o">*</span><span class="n">nls_info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">TCP_Server_Info</span> <span class="o">*</span><span class="n">server</span> <span class="o">=</span> <span class="n">ses</span><span class="o">-&gt;</span><span class="n">server</span><span class="p">;</span>

	<span class="n">ses</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ses</span><span class="o">-&gt;</span><span class="n">capabilities</span> <span class="o">=</span> <span class="n">server</span><span class="o">-&gt;</span><span class="n">capabilities</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">linuxExtEnabled</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">ses</span><span class="o">-&gt;</span><span class="n">capabilities</span> <span class="o">&amp;=</span> <span class="p">(</span><span class="o">~</span><span class="n">CAP_UNIX</span><span class="p">);</span>

	<span class="n">cFYI</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;Security Mode: 0x%x Capabilities: 0x%x TimeAdjust: %d&quot;</span><span class="p">,</span>
		 <span class="n">server</span><span class="o">-&gt;</span><span class="n">sec_mode</span><span class="p">,</span> <span class="n">server</span><span class="o">-&gt;</span><span class="n">capabilities</span><span class="p">,</span> <span class="n">server</span><span class="o">-&gt;</span><span class="n">timeAdj</span><span class="p">);</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">CIFS_SessSetup</span><span class="p">(</span><span class="n">xid</span><span class="p">,</span> <span class="n">ses</span><span class="p">,</span> <span class="n">nls_info</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cERROR</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;Send error in SessSetup = %d&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ses</span><span class="o">-&gt;</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">srv_mutex</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">session_estab</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">server</span><span class="o">-&gt;</span><span class="n">session_key</span><span class="p">.</span><span class="n">response</span> <span class="o">=</span> <span class="n">ses</span><span class="o">-&gt;</span><span class="n">auth_key</span><span class="p">.</span><span class="n">response</span><span class="p">;</span>
			<span class="n">server</span><span class="o">-&gt;</span><span class="n">session_key</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="n">ses</span><span class="o">-&gt;</span><span class="n">auth_key</span><span class="p">.</span><span class="n">len</span><span class="p">;</span>
			<span class="n">server</span><span class="o">-&gt;</span><span class="n">sequence_number</span> <span class="o">=</span> <span class="mh">0x2</span><span class="p">;</span>
			<span class="n">server</span><span class="o">-&gt;</span><span class="n">session_estab</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="n">ses</span><span class="o">-&gt;</span><span class="n">auth_key</span><span class="p">.</span><span class="n">response</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">srv_mutex</span><span class="p">);</span>

		<span class="n">cFYI</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;CIFS Session Established successfully&quot;</span><span class="p">);</span>
		<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">GlobalMid_Lock</span><span class="p">);</span>
		<span class="n">ses</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">CifsGood</span><span class="p">;</span>
		<span class="n">ses</span><span class="o">-&gt;</span><span class="n">need_reconnect</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">GlobalMid_Lock</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">ses</span><span class="o">-&gt;</span><span class="n">auth_key</span><span class="p">.</span><span class="n">response</span><span class="p">);</span>
	<span class="n">ses</span><span class="o">-&gt;</span><span class="n">auth_key</span><span class="p">.</span><span class="n">response</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">ses</span><span class="o">-&gt;</span><span class="n">auth_key</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">ses</span><span class="o">-&gt;</span><span class="n">ntlmssp</span><span class="p">);</span>
	<span class="n">ses</span><span class="o">-&gt;</span><span class="n">ntlmssp</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">cifs_set_vol_auth</span><span class="p">(</span><span class="k">struct</span> <span class="n">smb_vol</span> <span class="o">*</span><span class="n">vol</span><span class="p">,</span> <span class="k">struct</span> <span class="n">cifs_ses</span> <span class="o">*</span><span class="n">ses</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">ses</span><span class="o">-&gt;</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">secType</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">Kerberos</span>:
		<span class="n">vol</span><span class="o">-&gt;</span><span class="n">secFlg</span> <span class="o">=</span> <span class="n">CIFSSEC_MUST_KRB5</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">NTLMv2</span>:
		<span class="n">vol</span><span class="o">-&gt;</span><span class="n">secFlg</span> <span class="o">=</span> <span class="n">CIFSSEC_MUST_NTLMV2</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">NTLM</span>:
		<span class="n">vol</span><span class="o">-&gt;</span><span class="n">secFlg</span> <span class="o">=</span> <span class="n">CIFSSEC_MUST_NTLM</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">RawNTLMSSP</span>:
		<span class="n">vol</span><span class="o">-&gt;</span><span class="n">secFlg</span> <span class="o">=</span> <span class="n">CIFSSEC_MUST_NTLMSSP</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">LANMAN</span>:
		<span class="n">vol</span><span class="o">-&gt;</span><span class="n">secFlg</span> <span class="o">=</span> <span class="n">CIFSSEC_MUST_LANMAN</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">cifs_set_cifscreds</span><span class="p">(</span><span class="n">vol</span><span class="p">,</span> <span class="n">ses</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">cifs_tcon</span> <span class="o">*</span>
<span class="nf">cifs_construct_tcon</span><span class="p">(</span><span class="k">struct</span> <span class="n">cifs_sb_info</span> <span class="o">*</span><span class="n">cifs_sb</span><span class="p">,</span> <span class="n">uid_t</span> <span class="n">fsuid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cifs_tcon</span> <span class="o">*</span><span class="n">master_tcon</span> <span class="o">=</span> <span class="n">cifs_sb_master_tcon</span><span class="p">(</span><span class="n">cifs_sb</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">cifs_ses</span> <span class="o">*</span><span class="n">ses</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cifs_tcon</span> <span class="o">*</span><span class="n">tcon</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">smb_vol</span> <span class="o">*</span><span class="n">vol_info</span><span class="p">;</span>

	<span class="n">vol_info</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">vol_info</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vol_info</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">ENOMEM</span><span class="p">);</span>

	<span class="n">vol_info</span><span class="o">-&gt;</span><span class="n">local_nls</span> <span class="o">=</span> <span class="n">cifs_sb</span><span class="o">-&gt;</span><span class="n">local_nls</span><span class="p">;</span>
	<span class="n">vol_info</span><span class="o">-&gt;</span><span class="n">linux_uid</span> <span class="o">=</span> <span class="n">fsuid</span><span class="p">;</span>
	<span class="n">vol_info</span><span class="o">-&gt;</span><span class="n">cred_uid</span> <span class="o">=</span> <span class="n">fsuid</span><span class="p">;</span>
	<span class="n">vol_info</span><span class="o">-&gt;</span><span class="n">UNC</span> <span class="o">=</span> <span class="n">master_tcon</span><span class="o">-&gt;</span><span class="n">treeName</span><span class="p">;</span>
	<span class="n">vol_info</span><span class="o">-&gt;</span><span class="n">retry</span> <span class="o">=</span> <span class="n">master_tcon</span><span class="o">-&gt;</span><span class="n">retry</span><span class="p">;</span>
	<span class="n">vol_info</span><span class="o">-&gt;</span><span class="n">nocase</span> <span class="o">=</span> <span class="n">master_tcon</span><span class="o">-&gt;</span><span class="n">nocase</span><span class="p">;</span>
	<span class="n">vol_info</span><span class="o">-&gt;</span><span class="n">local_lease</span> <span class="o">=</span> <span class="n">master_tcon</span><span class="o">-&gt;</span><span class="n">local_lease</span><span class="p">;</span>
	<span class="n">vol_info</span><span class="o">-&gt;</span><span class="n">no_linux_ext</span> <span class="o">=</span> <span class="o">!</span><span class="n">master_tcon</span><span class="o">-&gt;</span><span class="n">unix_ext</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">cifs_set_vol_auth</span><span class="p">(</span><span class="n">vol_info</span><span class="p">,</span> <span class="n">master_tcon</span><span class="o">-&gt;</span><span class="n">ses</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tcon</span> <span class="o">=</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="n">rc</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* get a reference for the same TCP session */</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cifs_tcp_ses_lock</span><span class="p">);</span>
	<span class="o">++</span><span class="n">master_tcon</span><span class="o">-&gt;</span><span class="n">ses</span><span class="o">-&gt;</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">srv_count</span><span class="p">;</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cifs_tcp_ses_lock</span><span class="p">);</span>

	<span class="n">ses</span> <span class="o">=</span> <span class="n">cifs_get_smb_ses</span><span class="p">(</span><span class="n">master_tcon</span><span class="o">-&gt;</span><span class="n">ses</span><span class="o">-&gt;</span><span class="n">server</span><span class="p">,</span> <span class="n">vol_info</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">ses</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">tcon</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">cifs_tcon</span> <span class="o">*</span><span class="p">)</span><span class="n">ses</span><span class="p">;</span>
		<span class="n">cifs_put_tcp_session</span><span class="p">(</span><span class="n">master_tcon</span><span class="o">-&gt;</span><span class="n">ses</span><span class="o">-&gt;</span><span class="n">server</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">tcon</span> <span class="o">=</span> <span class="n">cifs_get_tcon</span><span class="p">(</span><span class="n">ses</span><span class="p">,</span> <span class="n">vol_info</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">tcon</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">cifs_put_smb_ses</span><span class="p">(</span><span class="n">ses</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ses</span><span class="o">-&gt;</span><span class="n">capabilities</span> <span class="o">&amp;</span> <span class="n">CAP_UNIX</span><span class="p">)</span>
		<span class="n">reset_cifs_unix_caps</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">tcon</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">vol_info</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">vol_info</span><span class="o">-&gt;</span><span class="n">username</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">vol_info</span><span class="o">-&gt;</span><span class="n">password</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">vol_info</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">tcon</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">cifs_tcon</span> <span class="o">*</span>
<span class="nf">cifs_sb_master_tcon</span><span class="p">(</span><span class="k">struct</span> <span class="n">cifs_sb_info</span> <span class="o">*</span><span class="n">cifs_sb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">tlink_tcon</span><span class="p">(</span><span class="n">cifs_sb_master_tlink</span><span class="p">(</span><span class="n">cifs_sb</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">cifs_sb_tcon_pending_wait</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">unused</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">schedule</span><span class="p">();</span>
	<span class="k">return</span> <span class="n">signal_pending</span><span class="p">(</span><span class="n">current</span><span class="p">)</span> <span class="o">?</span> <span class="o">-</span><span class="n">ERESTARTSYS</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* find and return a tlink with given uid */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">tcon_link</span> <span class="o">*</span>
<span class="nf">tlink_rb_search</span><span class="p">(</span><span class="k">struct</span> <span class="n">rb_root</span> <span class="o">*</span><span class="n">root</span><span class="p">,</span> <span class="n">uid_t</span> <span class="n">uid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rb_node</span> <span class="o">*</span><span class="n">node</span> <span class="o">=</span> <span class="n">root</span><span class="o">-&gt;</span><span class="n">rb_node</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tcon_link</span> <span class="o">*</span><span class="n">tlink</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">node</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tlink</span> <span class="o">=</span> <span class="n">rb_entry</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="k">struct</span> <span class="n">tcon_link</span><span class="p">,</span> <span class="n">tl_rbnode</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">tlink</span><span class="o">-&gt;</span><span class="n">tl_uid</span> <span class="o">&gt;</span> <span class="n">uid</span><span class="p">)</span>
			<span class="n">node</span> <span class="o">=</span> <span class="n">node</span><span class="o">-&gt;</span><span class="n">rb_left</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">tlink</span><span class="o">-&gt;</span><span class="n">tl_uid</span> <span class="o">&lt;</span> <span class="n">uid</span><span class="p">)</span>
			<span class="n">node</span> <span class="o">=</span> <span class="n">node</span><span class="o">-&gt;</span><span class="n">rb_right</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="k">return</span> <span class="n">tlink</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* insert a tcon_link into the tree */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">tlink_rb_insert</span><span class="p">(</span><span class="k">struct</span> <span class="n">rb_root</span> <span class="o">*</span><span class="n">root</span><span class="p">,</span> <span class="k">struct</span> <span class="n">tcon_link</span> <span class="o">*</span><span class="n">new_tlink</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rb_node</span> <span class="o">**</span><span class="n">new</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">root</span><span class="o">-&gt;</span><span class="n">rb_node</span><span class="p">),</span> <span class="o">*</span><span class="n">parent</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tcon_link</span> <span class="o">*</span><span class="n">tlink</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="o">*</span><span class="n">new</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tlink</span> <span class="o">=</span> <span class="n">rb_entry</span><span class="p">(</span><span class="o">*</span><span class="n">new</span><span class="p">,</span> <span class="k">struct</span> <span class="n">tcon_link</span><span class="p">,</span> <span class="n">tl_rbnode</span><span class="p">);</span>
		<span class="n">parent</span> <span class="o">=</span> <span class="o">*</span><span class="n">new</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">tlink</span><span class="o">-&gt;</span><span class="n">tl_uid</span> <span class="o">&gt;</span> <span class="n">new_tlink</span><span class="o">-&gt;</span><span class="n">tl_uid</span><span class="p">)</span>
			<span class="n">new</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">((</span><span class="o">*</span><span class="n">new</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">rb_left</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">new</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">((</span><span class="o">*</span><span class="n">new</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">rb_right</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">rb_link_node</span><span class="p">(</span><span class="o">&amp;</span><span class="n">new_tlink</span><span class="o">-&gt;</span><span class="n">tl_rbnode</span><span class="p">,</span> <span class="n">parent</span><span class="p">,</span> <span class="n">new</span><span class="p">);</span>
	<span class="n">rb_insert_color</span><span class="p">(</span><span class="o">&amp;</span><span class="n">new_tlink</span><span class="o">-&gt;</span><span class="n">tl_rbnode</span><span class="p">,</span> <span class="n">root</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Find or construct an appropriate tcon given a cifs_sb and the fsuid of the</span>
<span class="cm"> * current task.</span>
<span class="cm"> *</span>
<span class="cm"> * If the superblock doesn&#39;t refer to a multiuser mount, then just return</span>
<span class="cm"> * the master tcon for the mount.</span>
<span class="cm"> *</span>
<span class="cm"> * First, search the rbtree for an existing tcon for this fsuid. If one</span>
<span class="cm"> * exists, then check to see if it&#39;s pending construction. If it is then wait</span>
<span class="cm"> * for construction to complete. Once it&#39;s no longer pending, check to see if</span>
<span class="cm"> * it failed and either return an error or retry construction, depending on</span>
<span class="cm"> * the timeout.</span>
<span class="cm"> *</span>
<span class="cm"> * If one doesn&#39;t exist then insert a new tcon_link struct into the tree and</span>
<span class="cm"> * try to construct a new one.</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">tcon_link</span> <span class="o">*</span>
<span class="nf">cifs_sb_tlink</span><span class="p">(</span><span class="k">struct</span> <span class="n">cifs_sb_info</span> <span class="o">*</span><span class="n">cifs_sb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">uid_t</span> <span class="n">fsuid</span> <span class="o">=</span> <span class="n">current_fsuid</span><span class="p">();</span>
	<span class="k">struct</span> <span class="n">tcon_link</span> <span class="o">*</span><span class="n">tlink</span><span class="p">,</span> <span class="o">*</span><span class="n">newtlink</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">cifs_sb</span><span class="o">-&gt;</span><span class="n">mnt_cifs_flags</span> <span class="o">&amp;</span> <span class="n">CIFS_MOUNT_MULTIUSER</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">cifs_get_tlink</span><span class="p">(</span><span class="n">cifs_sb_master_tlink</span><span class="p">(</span><span class="n">cifs_sb</span><span class="p">));</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cifs_sb</span><span class="o">-&gt;</span><span class="n">tlink_tree_lock</span><span class="p">);</span>
	<span class="n">tlink</span> <span class="o">=</span> <span class="n">tlink_rb_search</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cifs_sb</span><span class="o">-&gt;</span><span class="n">tlink_tree</span><span class="p">,</span> <span class="n">fsuid</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tlink</span><span class="p">)</span>
		<span class="n">cifs_get_tlink</span><span class="p">(</span><span class="n">tlink</span><span class="p">);</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cifs_sb</span><span class="o">-&gt;</span><span class="n">tlink_tree_lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tlink</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">newtlink</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">tlink</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">newtlink</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">ENOMEM</span><span class="p">);</span>
		<span class="n">newtlink</span><span class="o">-&gt;</span><span class="n">tl_uid</span> <span class="o">=</span> <span class="n">fsuid</span><span class="p">;</span>
		<span class="n">newtlink</span><span class="o">-&gt;</span><span class="n">tl_tcon</span> <span class="o">=</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">EACCES</span><span class="p">);</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">TCON_LINK_PENDING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">newtlink</span><span class="o">-&gt;</span><span class="n">tl_flags</span><span class="p">);</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">TCON_LINK_IN_TREE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">newtlink</span><span class="o">-&gt;</span><span class="n">tl_flags</span><span class="p">);</span>
		<span class="n">cifs_get_tlink</span><span class="p">(</span><span class="n">newtlink</span><span class="p">);</span>

		<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cifs_sb</span><span class="o">-&gt;</span><span class="n">tlink_tree_lock</span><span class="p">);</span>
		<span class="cm">/* was one inserted after previous search? */</span>
		<span class="n">tlink</span> <span class="o">=</span> <span class="n">tlink_rb_search</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cifs_sb</span><span class="o">-&gt;</span><span class="n">tlink_tree</span><span class="p">,</span> <span class="n">fsuid</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tlink</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">cifs_get_tlink</span><span class="p">(</span><span class="n">tlink</span><span class="p">);</span>
			<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cifs_sb</span><span class="o">-&gt;</span><span class="n">tlink_tree_lock</span><span class="p">);</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">newtlink</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">wait_for_construction</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">tlink</span> <span class="o">=</span> <span class="n">newtlink</span><span class="p">;</span>
		<span class="n">tlink_rb_insert</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cifs_sb</span><span class="o">-&gt;</span><span class="n">tlink_tree</span><span class="p">,</span> <span class="n">tlink</span><span class="p">);</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cifs_sb</span><span class="o">-&gt;</span><span class="n">tlink_tree_lock</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
<span class="nl">wait_for_construction:</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">wait_on_bit</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tlink</span><span class="o">-&gt;</span><span class="n">tl_flags</span><span class="p">,</span> <span class="n">TCON_LINK_PENDING</span><span class="p">,</span>
				  <span class="n">cifs_sb_tcon_pending_wait</span><span class="p">,</span>
				  <span class="n">TASK_INTERRUPTIBLE</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">cifs_put_tlink</span><span class="p">(</span><span class="n">tlink</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="n">ret</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="cm">/* if it&#39;s good, return it */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">tlink</span><span class="o">-&gt;</span><span class="n">tl_tcon</span><span class="p">))</span>
			<span class="k">return</span> <span class="n">tlink</span><span class="p">;</span>

		<span class="cm">/* return error if we tried this already recently */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">time_before</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">tlink</span><span class="o">-&gt;</span><span class="n">tl_time</span> <span class="o">+</span> <span class="n">TLINK_ERROR_EXPIRE</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">cifs_put_tlink</span><span class="p">(</span><span class="n">tlink</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">EACCES</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">test_and_set_bit</span><span class="p">(</span><span class="n">TCON_LINK_PENDING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tlink</span><span class="o">-&gt;</span><span class="n">tl_flags</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">wait_for_construction</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">tlink</span><span class="o">-&gt;</span><span class="n">tl_tcon</span> <span class="o">=</span> <span class="n">cifs_construct_tcon</span><span class="p">(</span><span class="n">cifs_sb</span><span class="p">,</span> <span class="n">fsuid</span><span class="p">);</span>
	<span class="n">clear_bit</span><span class="p">(</span><span class="n">TCON_LINK_PENDING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tlink</span><span class="o">-&gt;</span><span class="n">tl_flags</span><span class="p">);</span>
	<span class="n">wake_up_bit</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tlink</span><span class="o">-&gt;</span><span class="n">tl_flags</span><span class="p">,</span> <span class="n">TCON_LINK_PENDING</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">tlink</span><span class="o">-&gt;</span><span class="n">tl_tcon</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">cifs_put_tlink</span><span class="p">(</span><span class="n">tlink</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">EACCES</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">tlink</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * periodic workqueue job that scans tcon_tree for a superblock and closes</span>
<span class="cm"> * out tcons.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">cifs_prune_tlinks</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cifs_sb_info</span> <span class="o">*</span><span class="n">cifs_sb</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="k">struct</span> <span class="n">cifs_sb_info</span><span class="p">,</span>
						    <span class="n">prune_tlinks</span><span class="p">.</span><span class="n">work</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">rb_root</span> <span class="o">*</span><span class="n">root</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">cifs_sb</span><span class="o">-&gt;</span><span class="n">tlink_tree</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rb_node</span> <span class="o">*</span><span class="n">node</span> <span class="o">=</span> <span class="n">rb_first</span><span class="p">(</span><span class="n">root</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">rb_node</span> <span class="o">*</span><span class="n">tmp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tcon_link</span> <span class="o">*</span><span class="n">tlink</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Because we drop the spinlock in the loop in order to put the tlink</span>
<span class="cm">	 * it&#39;s not guarded against removal of links from the tree. The only</span>
<span class="cm">	 * places that remove entries from the tree are this function and</span>
<span class="cm">	 * umounts. Because this function is non-reentrant and is canceled</span>
<span class="cm">	 * before umount can proceed, this is safe.</span>
<span class="cm">	 */</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cifs_sb</span><span class="o">-&gt;</span><span class="n">tlink_tree_lock</span><span class="p">);</span>
	<span class="n">node</span> <span class="o">=</span> <span class="n">rb_first</span><span class="p">(</span><span class="n">root</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">node</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="n">node</span><span class="p">;</span>
		<span class="n">node</span> <span class="o">=</span> <span class="n">rb_next</span><span class="p">(</span><span class="n">tmp</span><span class="p">);</span>
		<span class="n">tlink</span> <span class="o">=</span> <span class="n">rb_entry</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">tcon_link</span><span class="p">,</span> <span class="n">tl_rbnode</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">TCON_LINK_MASTER</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tlink</span><span class="o">-&gt;</span><span class="n">tl_flags</span><span class="p">)</span> <span class="o">||</span>
		    <span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tlink</span><span class="o">-&gt;</span><span class="n">tl_count</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">||</span>
		    <span class="n">time_after</span><span class="p">(</span><span class="n">tlink</span><span class="o">-&gt;</span><span class="n">tl_time</span> <span class="o">+</span> <span class="n">TLINK_IDLE_EXPIRE</span><span class="p">,</span> <span class="n">jiffies</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">cifs_get_tlink</span><span class="p">(</span><span class="n">tlink</span><span class="p">);</span>
		<span class="n">clear_bit</span><span class="p">(</span><span class="n">TCON_LINK_IN_TREE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tlink</span><span class="o">-&gt;</span><span class="n">tl_flags</span><span class="p">);</span>
		<span class="n">rb_erase</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="n">root</span><span class="p">);</span>

		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cifs_sb</span><span class="o">-&gt;</span><span class="n">tlink_tree_lock</span><span class="p">);</span>
		<span class="n">cifs_put_tlink</span><span class="p">(</span><span class="n">tlink</span><span class="p">);</span>
		<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cifs_sb</span><span class="o">-&gt;</span><span class="n">tlink_tree_lock</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cifs_sb</span><span class="o">-&gt;</span><span class="n">tlink_tree_lock</span><span class="p">);</span>

	<span class="n">queue_delayed_work</span><span class="p">(</span><span class="n">cifsiod_wq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cifs_sb</span><span class="o">-&gt;</span><span class="n">prune_tlinks</span><span class="p">,</span>
				<span class="n">TLINK_IDLE_EXPIRE</span><span class="p">);</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
