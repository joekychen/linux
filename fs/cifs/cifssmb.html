<!DOCTYPE html>
<html><head><title>joekychen/linux » fs › cifs › cifssmb.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>cifssmb.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> *   fs/cifs/cifssmb.c</span>
<span class="cm"> *</span>
<span class="cm"> *   Copyright (C) International Business Machines  Corp., 2002,2010</span>
<span class="cm"> *   Author(s): Steve French (sfrench@us.ibm.com)</span>
<span class="cm"> *</span>
<span class="cm"> *   Contains the routines for constructing the SMB PDUs themselves</span>
<span class="cm"> *</span>
<span class="cm"> *   This library is free software; you can redistribute it and/or modify</span>
<span class="cm"> *   it under the terms of the GNU Lesser General Public License as published</span>
<span class="cm"> *   by the Free Software Foundation; either version 2.1 of the License, or</span>
<span class="cm"> *   (at your option) any later version.</span>
<span class="cm"> *</span>
<span class="cm"> *   This library is distributed in the hope that it will be useful,</span>
<span class="cm"> *   but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> *   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See</span>
<span class="cm"> *   the GNU Lesser General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> *   You should have received a copy of the GNU Lesser General Public License</span>
<span class="cm"> *   along with this library; if not, write to the Free Software</span>
<span class="cm"> *   Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA 02111-1307 USA</span>
<span class="cm"> */</span>

 <span class="cm">/* SMB/CIFS PDU handling routines here - except for leftovers in connect.c   */</span>
 <span class="cm">/* These are mostly routines that operate on a pathname, or on a tree id     */</span>
 <span class="cm">/* (mounted volume), but there are eight handle based routines which must be */</span>
 <span class="cm">/* treated slightly differently for reconnection purposes since we never     */</span>
 <span class="cm">/* want to reuse a stale file handle and only the caller knows the file info */</span>

<span class="cp">#include &lt;linux/fs.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/vfs.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/posix_acl_xattr.h&gt;</span>
<span class="cp">#include &lt;linux/pagemap.h&gt;</span>
<span class="cp">#include &lt;linux/swap.h&gt;</span>
<span class="cp">#include &lt;linux/task_io_accounting_ops.h&gt;</span>
<span class="cp">#include &lt;asm/uaccess.h&gt;</span>
<span class="cp">#include &quot;cifspdu.h&quot;</span>
<span class="cp">#include &quot;cifsglob.h&quot;</span>
<span class="cp">#include &quot;cifsacl.h&quot;</span>
<span class="cp">#include &quot;cifsproto.h&quot;</span>
<span class="cp">#include &quot;cifs_unicode.h&quot;</span>
<span class="cp">#include &quot;cifs_debug.h&quot;</span>
<span class="cp">#include &quot;fscache.h&quot;</span>

<span class="cp">#ifdef CONFIG_CIFS_POSIX</span>
<span class="k">static</span> <span class="k">struct</span> <span class="p">{</span>
	<span class="kt">int</span> <span class="n">index</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">;</span>
<span class="p">}</span> <span class="n">protocols</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
<span class="cp">#ifdef CONFIG_CIFS_WEAK_PW_HASH</span>
	<span class="p">{</span><span class="n">LANMAN_PROT</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\2</span><span class="s">LM1.2X002&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">LANMAN2_PROT</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\2</span><span class="s">LANMAN2.1&quot;</span><span class="p">},</span>
<span class="cp">#endif </span><span class="cm">/* weak password hashing for legacy clients */</span><span class="cp"></span>
	<span class="p">{</span><span class="n">CIFS_PROT</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\2</span><span class="s">NT LM 0.12&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">POSIX_PROT</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\2</span><span class="s">POSIX 2&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">BAD_PROT</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\2</span><span class="s">&quot;</span><span class="p">}</span>
<span class="p">};</span>
<span class="cp">#else</span>
<span class="k">static</span> <span class="k">struct</span> <span class="p">{</span>
	<span class="kt">int</span> <span class="n">index</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">;</span>
<span class="p">}</span> <span class="n">protocols</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
<span class="cp">#ifdef CONFIG_CIFS_WEAK_PW_HASH</span>
	<span class="p">{</span><span class="n">LANMAN_PROT</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\2</span><span class="s">LM1.2X002&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">LANMAN2_PROT</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\2</span><span class="s">LANMAN2.1&quot;</span><span class="p">},</span>
<span class="cp">#endif </span><span class="cm">/* weak password hashing for legacy clients */</span><span class="cp"></span>
	<span class="p">{</span><span class="n">CIFS_PROT</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\2</span><span class="s">NT LM 0.12&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">BAD_PROT</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\2</span><span class="s">&quot;</span><span class="p">}</span>
<span class="p">};</span>
<span class="cp">#endif</span>

<span class="cm">/* define the number of elements in the cifs dialect array */</span>
<span class="cp">#ifdef CONFIG_CIFS_POSIX</span>
<span class="cp">#ifdef CONFIG_CIFS_WEAK_PW_HASH</span>
<span class="cp">#define CIFS_NUM_PROT 4</span>
<span class="cp">#else</span>
<span class="cp">#define CIFS_NUM_PROT 2</span>
<span class="cp">#endif </span><span class="cm">/* CIFS_WEAK_PW_HASH */</span><span class="cp"></span>
<span class="cp">#else </span><span class="cm">/* not posix */</span><span class="cp"></span>
<span class="cp">#ifdef CONFIG_CIFS_WEAK_PW_HASH</span>
<span class="cp">#define CIFS_NUM_PROT 3</span>
<span class="cp">#else</span>
<span class="cp">#define CIFS_NUM_PROT 1</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_CIFS_WEAK_PW_HASH */</span><span class="cp"></span>
<span class="cp">#endif </span><span class="cm">/* CIFS_POSIX */</span><span class="cp"></span>

<span class="cm">/* Forward declarations */</span>

<span class="cm">/* Mark as invalid, all open files on tree connections since they</span>
<span class="cm">   were closed when session to server was lost */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">mark_open_files_invalid</span><span class="p">(</span><span class="k">struct</span> <span class="n">cifs_tcon</span> <span class="o">*</span><span class="n">pTcon</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cifsFileInfo</span> <span class="o">*</span><span class="n">open_file</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">tmp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">tmp1</span><span class="p">;</span>

<span class="cm">/* list all files open on tree connection and mark them invalid */</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cifs_file_list_lock</span><span class="p">);</span>
	<span class="n">list_for_each_safe</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="n">tmp1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pTcon</span><span class="o">-&gt;</span><span class="n">openFileList</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">open_file</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">cifsFileInfo</span><span class="p">,</span> <span class="n">tlist</span><span class="p">);</span>
		<span class="n">open_file</span><span class="o">-&gt;</span><span class="n">invalidHandle</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="n">open_file</span><span class="o">-&gt;</span><span class="n">oplock_break_cancelled</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cifs_file_list_lock</span><span class="p">);</span>
	<span class="cm">/* BB Add call to invalidate_inodes(sb) for all superblocks mounted</span>
<span class="cm">	   to this tcon */</span>
<span class="p">}</span>

<span class="cm">/* reconnect the socket, tcon, and smb session if needed */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">cifs_reconnect_tcon</span><span class="p">(</span><span class="k">struct</span> <span class="n">cifs_tcon</span> <span class="o">*</span><span class="n">tcon</span><span class="p">,</span> <span class="kt">int</span> <span class="n">smb_command</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cifs_ses</span> <span class="o">*</span><span class="n">ses</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">TCP_Server_Info</span> <span class="o">*</span><span class="n">server</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nls_table</span> <span class="o">*</span><span class="n">nls_codepage</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * SMBs NegProt, SessSetup, uLogoff do not have tcon yet so check for</span>
<span class="cm">	 * tcp and smb session status done differently for those three - in the</span>
<span class="cm">	 * calling routine</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tcon</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">ses</span> <span class="o">=</span> <span class="n">tcon</span><span class="o">-&gt;</span><span class="n">ses</span><span class="p">;</span>
	<span class="n">server</span> <span class="o">=</span> <span class="n">ses</span><span class="o">-&gt;</span><span class="n">server</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * only tree disconnect, open, and write, (and ulogoff which does not</span>
<span class="cm">	 * have tcon) are allowed as we start force umount</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tcon</span><span class="o">-&gt;</span><span class="n">tidStatus</span> <span class="o">==</span> <span class="n">CifsExiting</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">smb_command</span> <span class="o">!=</span> <span class="n">SMB_COM_WRITE_ANDX</span> <span class="o">&amp;&amp;</span>
		    <span class="n">smb_command</span> <span class="o">!=</span> <span class="n">SMB_COM_OPEN_ANDX</span> <span class="o">&amp;&amp;</span>
		    <span class="n">smb_command</span> <span class="o">!=</span> <span class="n">SMB_COM_TREE_DISCONNECT</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">cFYI</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;can not send cmd %d while umounting&quot;</span><span class="p">,</span>
				<span class="n">smb_command</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Give demultiplex thread up to 10 seconds to reconnect, should be</span>
<span class="cm">	 * greater than cifs socket timeout which is 7 seconds</span>
<span class="cm">	 */</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">tcpStatus</span> <span class="o">==</span> <span class="n">CifsNeedReconnect</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wait_event_interruptible_timeout</span><span class="p">(</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">response_q</span><span class="p">,</span>
			<span class="p">(</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">tcpStatus</span> <span class="o">!=</span> <span class="n">CifsNeedReconnect</span><span class="p">),</span> <span class="mi">10</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">);</span>

		<span class="cm">/* are we still trying to reconnect? */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">tcpStatus</span> <span class="o">!=</span> <span class="n">CifsNeedReconnect</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * on &quot;soft&quot; mounts we wait once. Hard mounts keep</span>
<span class="cm">		 * retrying until process is killed or server comes</span>
<span class="cm">		 * back on-line</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tcon</span><span class="o">-&gt;</span><span class="n">retry</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">cFYI</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;gave up waiting on reconnect in smb_init&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EHOSTDOWN</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ses</span><span class="o">-&gt;</span><span class="n">need_reconnect</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">tcon</span><span class="o">-&gt;</span><span class="n">need_reconnect</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">nls_codepage</span> <span class="o">=</span> <span class="n">load_nls_default</span><span class="p">();</span>

	<span class="cm">/*</span>
<span class="cm">	 * need to prevent multiple threads trying to simultaneously</span>
<span class="cm">	 * reconnect the same SMB session</span>
<span class="cm">	 */</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ses</span><span class="o">-&gt;</span><span class="n">session_mutex</span><span class="p">);</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">cifs_negotiate_protocol</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">ses</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">ses</span><span class="o">-&gt;</span><span class="n">need_reconnect</span><span class="p">)</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">cifs_setup_session</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">ses</span><span class="p">,</span> <span class="n">nls_codepage</span><span class="p">);</span>

	<span class="cm">/* do we need to reconnect tcon? */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">||</span> <span class="o">!</span><span class="n">tcon</span><span class="o">-&gt;</span><span class="n">need_reconnect</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ses</span><span class="o">-&gt;</span><span class="n">session_mutex</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mark_open_files_invalid</span><span class="p">(</span><span class="n">tcon</span><span class="p">);</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">CIFSTCon</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">ses</span><span class="p">,</span> <span class="n">tcon</span><span class="o">-&gt;</span><span class="n">treeName</span><span class="p">,</span> <span class="n">tcon</span><span class="p">,</span> <span class="n">nls_codepage</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ses</span><span class="o">-&gt;</span><span class="n">session_mutex</span><span class="p">);</span>
	<span class="n">cFYI</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;reconnect tcon rc = %d&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * FIXME: check if wsize needs updated due to negotiated smb buffer</span>
<span class="cm">	 * 	  size shrinking</span>
<span class="cm">	 */</span>
	<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tconInfoReconnectCount</span><span class="p">);</span>

	<span class="cm">/* tell server Unix caps we support */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ses</span><span class="o">-&gt;</span><span class="n">capabilities</span> <span class="o">&amp;</span> <span class="n">CAP_UNIX</span><span class="p">)</span>
		<span class="n">reset_cifs_unix_caps</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">tcon</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Removed call to reopen open files here. It is safer (and faster) to</span>
<span class="cm">	 * reopen files one at a time as needed in read and write.</span>
<span class="cm">	 *</span>
<span class="cm">	 * FIXME: what about file locks? don&#39;t we need to reclaim them ASAP?</span>
<span class="cm">	 */</span>

<span class="nl">out:</span>
	<span class="cm">/*</span>
<span class="cm">	 * Check if handle based operation so we know whether we can continue</span>
<span class="cm">	 * or not without returning to caller to reset file handle</span>
<span class="cm">	 */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">smb_command</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SMB_COM_READ_ANDX</span>:
	<span class="k">case</span> <span class="n">SMB_COM_WRITE_ANDX</span>:
	<span class="k">case</span> <span class="n">SMB_COM_CLOSE</span>:
	<span class="k">case</span> <span class="n">SMB_COM_FIND_CLOSE2</span>:
	<span class="k">case</span> <span class="n">SMB_COM_LOCKING_ANDX</span>:
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">unload_nls</span><span class="p">(</span><span class="n">nls_codepage</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Allocate and return pointer to an SMB request buffer, and set basic</span>
<span class="cm">   SMB information in the SMB header.  If the return code is zero, this</span>
<span class="cm">   function must have filled in request_buf pointer */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">small_smb_init</span><span class="p">(</span><span class="kt">int</span> <span class="n">smb_command</span><span class="p">,</span> <span class="kt">int</span> <span class="n">wct</span><span class="p">,</span> <span class="k">struct</span> <span class="n">cifs_tcon</span> <span class="o">*</span><span class="n">tcon</span><span class="p">,</span>
		<span class="kt">void</span> <span class="o">**</span><span class="n">request_buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">cifs_reconnect_tcon</span><span class="p">(</span><span class="n">tcon</span><span class="p">,</span> <span class="n">smb_command</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

	<span class="o">*</span><span class="n">request_buf</span> <span class="o">=</span> <span class="n">cifs_small_buf_get</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">request_buf</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* BB should we add a retry in here if not a writepage? */</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">header_assemble</span><span class="p">((</span><span class="k">struct</span> <span class="n">smb_hdr</span> <span class="o">*</span><span class="p">)</span> <span class="o">*</span><span class="n">request_buf</span><span class="p">,</span> <span class="n">smb_command</span><span class="p">,</span>
			<span class="n">tcon</span><span class="p">,</span> <span class="n">wct</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tcon</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">cifs_stats_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tcon</span><span class="o">-&gt;</span><span class="n">num_smbs_sent</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="nf">small_smb_init_no_tc</span><span class="p">(</span><span class="k">const</span> <span class="kt">int</span> <span class="n">smb_command</span><span class="p">,</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">wct</span><span class="p">,</span>
		     <span class="k">struct</span> <span class="n">cifs_ses</span> <span class="o">*</span><span class="n">ses</span><span class="p">,</span> <span class="kt">void</span> <span class="o">**</span><span class="n">request_buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">smb_hdr</span> <span class="o">*</span><span class="n">buffer</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">small_smb_init</span><span class="p">(</span><span class="n">smb_command</span><span class="p">,</span> <span class="n">wct</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">request_buf</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">buffer</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">smb_hdr</span> <span class="o">*</span><span class="p">)</span><span class="o">*</span><span class="n">request_buf</span><span class="p">;</span>
	<span class="n">buffer</span><span class="o">-&gt;</span><span class="n">Mid</span> <span class="o">=</span> <span class="n">get_next_mid</span><span class="p">(</span><span class="n">ses</span><span class="o">-&gt;</span><span class="n">server</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ses</span><span class="o">-&gt;</span><span class="n">capabilities</span> <span class="o">&amp;</span> <span class="n">CAP_UNICODE</span><span class="p">)</span>
		<span class="n">buffer</span><span class="o">-&gt;</span><span class="n">Flags2</span> <span class="o">|=</span> <span class="n">SMBFLG2_UNICODE</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ses</span><span class="o">-&gt;</span><span class="n">capabilities</span> <span class="o">&amp;</span> <span class="n">CAP_STATUS32</span><span class="p">)</span>
		<span class="n">buffer</span><span class="o">-&gt;</span><span class="n">Flags2</span> <span class="o">|=</span> <span class="n">SMBFLG2_ERR_STATUS</span><span class="p">;</span>

	<span class="cm">/* uid, tid can stay at zero as set in header assemble */</span>

	<span class="cm">/* BB add support for turning on the signing when</span>
<span class="cm">	this function is used after 1st of session setup requests */</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* If the return code is zero, this function must fill in request_buf pointer */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">__smb_init</span><span class="p">(</span><span class="kt">int</span> <span class="n">smb_command</span><span class="p">,</span> <span class="kt">int</span> <span class="n">wct</span><span class="p">,</span> <span class="k">struct</span> <span class="n">cifs_tcon</span> <span class="o">*</span><span class="n">tcon</span><span class="p">,</span>
			<span class="kt">void</span> <span class="o">**</span><span class="n">request_buf</span><span class="p">,</span> <span class="kt">void</span> <span class="o">**</span><span class="n">response_buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="o">*</span><span class="n">request_buf</span> <span class="o">=</span> <span class="n">cifs_buf_get</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">request_buf</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* BB should we add a retry in here if not a writepage? */</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>
    <span class="cm">/* Although the original thought was we needed the response buf for  */</span>
    <span class="cm">/* potential retries of smb operations it turns out we can determine */</span>
    <span class="cm">/* from the mid flags when the request buffer can be resent without  */</span>
    <span class="cm">/* having to use a second distinct buffer for the response */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">response_buf</span><span class="p">)</span>
		<span class="o">*</span><span class="n">response_buf</span> <span class="o">=</span> <span class="o">*</span><span class="n">request_buf</span><span class="p">;</span>

	<span class="n">header_assemble</span><span class="p">((</span><span class="k">struct</span> <span class="n">smb_hdr</span> <span class="o">*</span><span class="p">)</span> <span class="o">*</span><span class="n">request_buf</span><span class="p">,</span> <span class="n">smb_command</span><span class="p">,</span> <span class="n">tcon</span><span class="p">,</span>
			<span class="n">wct</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tcon</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">cifs_stats_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tcon</span><span class="o">-&gt;</span><span class="n">num_smbs_sent</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* If the return code is zero, this function must fill in request_buf pointer */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">smb_init</span><span class="p">(</span><span class="kt">int</span> <span class="n">smb_command</span><span class="p">,</span> <span class="kt">int</span> <span class="n">wct</span><span class="p">,</span> <span class="k">struct</span> <span class="n">cifs_tcon</span> <span class="o">*</span><span class="n">tcon</span><span class="p">,</span>
	 <span class="kt">void</span> <span class="o">**</span><span class="n">request_buf</span><span class="p">,</span> <span class="kt">void</span> <span class="o">**</span><span class="n">response_buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">cifs_reconnect_tcon</span><span class="p">(</span><span class="n">tcon</span><span class="p">,</span> <span class="n">smb_command</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">__smb_init</span><span class="p">(</span><span class="n">smb_command</span><span class="p">,</span> <span class="n">wct</span><span class="p">,</span> <span class="n">tcon</span><span class="p">,</span> <span class="n">request_buf</span><span class="p">,</span> <span class="n">response_buf</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">smb_init_no_reconnect</span><span class="p">(</span><span class="kt">int</span> <span class="n">smb_command</span><span class="p">,</span> <span class="kt">int</span> <span class="n">wct</span><span class="p">,</span> <span class="k">struct</span> <span class="n">cifs_tcon</span> <span class="o">*</span><span class="n">tcon</span><span class="p">,</span>
			<span class="kt">void</span> <span class="o">**</span><span class="n">request_buf</span><span class="p">,</span> <span class="kt">void</span> <span class="o">**</span><span class="n">response_buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tcon</span><span class="o">-&gt;</span><span class="n">ses</span><span class="o">-&gt;</span><span class="n">need_reconnect</span> <span class="o">||</span> <span class="n">tcon</span><span class="o">-&gt;</span><span class="n">need_reconnect</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EHOSTDOWN</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">__smb_init</span><span class="p">(</span><span class="n">smb_command</span><span class="p">,</span> <span class="n">wct</span><span class="p">,</span> <span class="n">tcon</span><span class="p">,</span> <span class="n">request_buf</span><span class="p">,</span> <span class="n">response_buf</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">validate_t2</span><span class="p">(</span><span class="k">struct</span> <span class="n">smb_t2_rsp</span> <span class="o">*</span><span class="n">pSMB</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">total_size</span><span class="p">;</span>

	<span class="cm">/* check for plausible wct */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">WordCount</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">vt2_err</span><span class="p">;</span>

	<span class="cm">/* check for parm and data offset going beyond end of smb */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">get_unaligned_le16</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">t2_rsp</span><span class="p">.</span><span class="n">ParameterOffset</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1024</span> <span class="o">||</span>
	    <span class="n">get_unaligned_le16</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">t2_rsp</span><span class="p">.</span><span class="n">DataOffset</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1024</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">vt2_err</span><span class="p">;</span>

	<span class="n">total_size</span> <span class="o">=</span> <span class="n">get_unaligned_le16</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">t2_rsp</span><span class="p">.</span><span class="n">ParameterCount</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">total_size</span> <span class="o">&gt;=</span> <span class="mi">512</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">vt2_err</span><span class="p">;</span>

	<span class="cm">/* check that bcc is at least as big as parms + data, and that it is</span>
<span class="cm">	 * less than negotiated smb buffer</span>
<span class="cm">	 */</span>
	<span class="n">total_size</span> <span class="o">+=</span> <span class="n">get_unaligned_le16</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">t2_rsp</span><span class="p">.</span><span class="n">DataCount</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">total_size</span> <span class="o">&gt;</span> <span class="n">get_bcc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">total_size</span> <span class="o">&gt;=</span> <span class="n">CIFSMaxBufSize</span> <span class="o">+</span> <span class="n">MAX_CIFS_HDR_SIZE</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">vt2_err</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">vt2_err:</span>
	<span class="n">cifs_dump_mem</span><span class="p">(</span><span class="s">&quot;Invalid transact2 SMB: &quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">pSMB</span><span class="p">,</span>
		<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">smb_t2_rsp</span><span class="p">)</span> <span class="o">+</span> <span class="mi">16</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">inc_rfc1001_len</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">pSMB</span><span class="p">,</span> <span class="kt">int</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">smb_hdr</span> <span class="o">*</span><span class="n">hdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">smb_hdr</span> <span class="o">*</span><span class="p">)</span><span class="n">pSMB</span><span class="p">;</span>

	<span class="n">be32_add_cpu</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">smb_buf_length</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="nf">CIFSSMBNegotiate</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">xid</span><span class="p">,</span> <span class="k">struct</span> <span class="n">cifs_ses</span> <span class="o">*</span><span class="n">ses</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">NEGOTIATE_REQ</span> <span class="o">*</span><span class="n">pSMB</span><span class="p">;</span>
	<span class="n">NEGOTIATE_RSP</span> <span class="o">*</span><span class="n">pSMBr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">bytes_returned</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">TCP_Server_Info</span> <span class="o">*</span><span class="n">server</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">count</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">secFlags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ses</span><span class="o">-&gt;</span><span class="n">server</span><span class="p">)</span>
		<span class="n">server</span> <span class="o">=</span> <span class="n">ses</span><span class="o">-&gt;</span><span class="n">server</span><span class="p">;</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">smb_init</span><span class="p">(</span><span class="n">SMB_COM_NEGOTIATE</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span> <span class="cm">/* no tcon yet */</span> <span class="p">,</span>
		      <span class="p">(</span><span class="kt">void</span> <span class="o">**</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">pSMB</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">**</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">pSMBr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

	<span class="cm">/* if any of auth flags (ie not sign or seal) are overriden use them */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ses</span><span class="o">-&gt;</span><span class="n">overrideSecFlg</span> <span class="o">&amp;</span> <span class="p">(</span><span class="o">~</span><span class="p">(</span><span class="n">CIFSSEC_MUST_SIGN</span> <span class="o">|</span> <span class="n">CIFSSEC_MUST_SEAL</span><span class="p">)))</span>
		<span class="n">secFlags</span> <span class="o">=</span> <span class="n">ses</span><span class="o">-&gt;</span><span class="n">overrideSecFlg</span><span class="p">;</span>  <span class="cm">/* BB FIXME fix sign flags? */</span>
	<span class="k">else</span> <span class="cm">/* if override flags set only sign/seal OR them with global auth */</span>
		<span class="n">secFlags</span> <span class="o">=</span> <span class="n">global_secflags</span> <span class="o">|</span> <span class="n">ses</span><span class="o">-&gt;</span><span class="n">overrideSecFlg</span><span class="p">;</span>

	<span class="n">cFYI</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;secFlags 0x%x&quot;</span><span class="p">,</span> <span class="n">secFlags</span><span class="p">);</span>

	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">Mid</span> <span class="o">=</span> <span class="n">get_next_mid</span><span class="p">(</span><span class="n">server</span><span class="p">);</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">Flags2</span> <span class="o">|=</span> <span class="p">(</span><span class="n">SMBFLG2_UNICODE</span> <span class="o">|</span> <span class="n">SMBFLG2_ERR_STATUS</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">secFlags</span> <span class="o">&amp;</span> <span class="n">CIFSSEC_MUST_KRB5</span><span class="p">)</span> <span class="o">==</span> <span class="n">CIFSSEC_MUST_KRB5</span><span class="p">)</span>
		<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">Flags2</span> <span class="o">|=</span> <span class="n">SMBFLG2_EXT_SEC</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">secFlags</span> <span class="o">&amp;</span> <span class="n">CIFSSEC_AUTH_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="n">CIFSSEC_MAY_KRB5</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cFYI</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;Kerberos only mechanism, enable extended security&quot;</span><span class="p">);</span>
		<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">Flags2</span> <span class="o">|=</span> <span class="n">SMBFLG2_EXT_SEC</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">secFlags</span> <span class="o">&amp;</span> <span class="n">CIFSSEC_MUST_NTLMSSP</span><span class="p">)</span> <span class="o">==</span> <span class="n">CIFSSEC_MUST_NTLMSSP</span><span class="p">)</span>
		<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">Flags2</span> <span class="o">|=</span> <span class="n">SMBFLG2_EXT_SEC</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">secFlags</span> <span class="o">&amp;</span> <span class="n">CIFSSEC_AUTH_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="n">CIFSSEC_MAY_NTLMSSP</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cFYI</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;NTLMSSP only mechanism, enable extended security&quot;</span><span class="p">);</span>
		<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">Flags2</span> <span class="o">|=</span> <span class="n">SMBFLG2_EXT_SEC</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">CIFS_NUM_PROT</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">strncpy</span><span class="p">(</span><span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">DialectsArray</span><span class="o">+</span><span class="n">count</span><span class="p">,</span> <span class="n">protocols</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">name</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>
		<span class="n">count</span> <span class="o">+=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">protocols</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">name</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
		<span class="cm">/* null at end of source and target buffers anyway */</span>
	<span class="p">}</span>
	<span class="n">inc_rfc1001_len</span><span class="p">(</span><span class="n">pSMB</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">ByteCount</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">count</span><span class="p">);</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">SendReceive</span><span class="p">(</span><span class="n">xid</span><span class="p">,</span> <span class="n">ses</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">smb_hdr</span> <span class="o">*</span><span class="p">)</span> <span class="n">pSMB</span><span class="p">,</span>
			 <span class="p">(</span><span class="k">struct</span> <span class="n">smb_hdr</span> <span class="o">*</span><span class="p">)</span> <span class="n">pSMBr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bytes_returned</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">neg_err_exit</span><span class="p">;</span>

	<span class="n">server</span><span class="o">-&gt;</span><span class="n">dialect</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">pSMBr</span><span class="o">-&gt;</span><span class="n">DialectIndex</span><span class="p">);</span>
	<span class="n">cFYI</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;Dialect: %d&quot;</span><span class="p">,</span> <span class="n">server</span><span class="o">-&gt;</span><span class="n">dialect</span><span class="p">);</span>
	<span class="cm">/* Check wct = 1 error case */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">pSMBr</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">WordCount</span> <span class="o">&lt;</span> <span class="mi">13</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">dialect</span> <span class="o">==</span> <span class="n">BAD_PROT</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* core returns wct = 1, but we do not ask for core - otherwise</span>
<span class="cm">		small wct just comes when dialect index is -1 indicating we</span>
<span class="cm">		could not negotiate a common dialect */</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">neg_err_exit</span><span class="p">;</span>
<span class="cp">#ifdef CONFIG_CIFS_WEAK_PW_HASH</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">pSMBr</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">WordCount</span> <span class="o">==</span> <span class="mi">13</span><span class="p">)</span>
			<span class="o">&amp;&amp;</span> <span class="p">((</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">dialect</span> <span class="o">==</span> <span class="n">LANMAN_PROT</span><span class="p">)</span>
				<span class="o">||</span> <span class="p">(</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">dialect</span> <span class="o">==</span> <span class="n">LANMAN2_PROT</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">__s16</span> <span class="n">tmp</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">lanman_neg_rsp</span> <span class="o">*</span><span class="n">rsp</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">lanman_neg_rsp</span> <span class="o">*</span><span class="p">)</span><span class="n">pSMBr</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">secFlags</span> <span class="o">&amp;</span> <span class="n">CIFSSEC_MAY_LANMAN</span><span class="p">)</span> <span class="o">||</span>
			<span class="p">(</span><span class="n">secFlags</span> <span class="o">&amp;</span> <span class="n">CIFSSEC_MAY_PLNTXT</span><span class="p">))</span>
			<span class="n">server</span><span class="o">-&gt;</span><span class="n">secType</span> <span class="o">=</span> <span class="n">LANMAN</span><span class="p">;</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="n">cERROR</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;mount failed weak security disabled&quot;</span>
				   <span class="s">&quot; in /proc/fs/cifs/SecurityFlags&quot;</span><span class="p">);</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">neg_err_exit</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">server</span><span class="o">-&gt;</span><span class="n">sec_mode</span> <span class="o">=</span> <span class="p">(</span><span class="n">__u8</span><span class="p">)</span><span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">rsp</span><span class="o">-&gt;</span><span class="n">SecurityMode</span><span class="p">);</span>
		<span class="n">server</span><span class="o">-&gt;</span><span class="n">maxReq</span> <span class="o">=</span> <span class="n">min_t</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">,</span>
				       <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">rsp</span><span class="o">-&gt;</span><span class="n">MaxMpxCount</span><span class="p">),</span>
				       <span class="n">cifs_max_pending</span><span class="p">);</span>
		<span class="n">set_credits</span><span class="p">(</span><span class="n">server</span><span class="p">,</span> <span class="n">server</span><span class="o">-&gt;</span><span class="n">maxReq</span><span class="p">);</span>
		<span class="n">server</span><span class="o">-&gt;</span><span class="n">maxBuf</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">rsp</span><span class="o">-&gt;</span><span class="n">MaxBufSize</span><span class="p">);</span>
		<span class="n">server</span><span class="o">-&gt;</span><span class="n">max_vcs</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">rsp</span><span class="o">-&gt;</span><span class="n">MaxNumberVcs</span><span class="p">);</span>
		<span class="cm">/* even though we do not use raw we might as well set this</span>
<span class="cm">		accurately, in case we ever find a need for it */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">rsp</span><span class="o">-&gt;</span><span class="n">RawMode</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">RAW_ENABLE</span><span class="p">)</span> <span class="o">==</span> <span class="n">RAW_ENABLE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">server</span><span class="o">-&gt;</span><span class="n">max_rw</span> <span class="o">=</span> <span class="mh">0xFF00</span><span class="p">;</span>
			<span class="n">server</span><span class="o">-&gt;</span><span class="n">capabilities</span> <span class="o">=</span> <span class="n">CAP_MPX_MODE</span> <span class="o">|</span> <span class="n">CAP_RAW_MODE</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">server</span><span class="o">-&gt;</span><span class="n">max_rw</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span><span class="cm">/* do not need to use raw anyway */</span>
			<span class="n">server</span><span class="o">-&gt;</span><span class="n">capabilities</span> <span class="o">=</span> <span class="n">CAP_MPX_MODE</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="p">(</span><span class="n">__s16</span><span class="p">)</span><span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">rsp</span><span class="o">-&gt;</span><span class="n">ServerTimeZone</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* OS/2 often does not set timezone therefore</span>
<span class="cm">			 * we must use server time to calc time zone.</span>
<span class="cm">			 * Could deviate slightly from the right zone.</span>
<span class="cm">			 * Smallest defined timezone difference is 15 minutes</span>
<span class="cm">			 * (i.e. Nepal).  Rounding up/down is done to match</span>
<span class="cm">			 * this requirement.</span>
<span class="cm">			 */</span>
			<span class="kt">int</span> <span class="n">val</span><span class="p">,</span> <span class="n">seconds</span><span class="p">,</span> <span class="n">remain</span><span class="p">,</span> <span class="n">result</span><span class="p">;</span>
			<span class="k">struct</span> <span class="n">timespec</span> <span class="n">ts</span><span class="p">,</span> <span class="n">utc</span><span class="p">;</span>
			<span class="n">utc</span> <span class="o">=</span> <span class="n">CURRENT_TIME</span><span class="p">;</span>
			<span class="n">ts</span> <span class="o">=</span> <span class="n">cnvrtDosUnixTm</span><span class="p">(</span><span class="n">rsp</span><span class="o">-&gt;</span><span class="n">SrvTime</span><span class="p">.</span><span class="n">Date</span><span class="p">,</span>
					    <span class="n">rsp</span><span class="o">-&gt;</span><span class="n">SrvTime</span><span class="p">.</span><span class="n">Time</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">cFYI</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;SrvTime %d sec since 1970 (utc: %d) diff: %d&quot;</span><span class="p">,</span>
				<span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">ts</span><span class="p">.</span><span class="n">tv_sec</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">utc</span><span class="p">.</span><span class="n">tv_sec</span><span class="p">,</span>
				<span class="p">(</span><span class="kt">int</span><span class="p">)(</span><span class="n">utc</span><span class="p">.</span><span class="n">tv_sec</span> <span class="o">-</span> <span class="n">ts</span><span class="p">.</span><span class="n">tv_sec</span><span class="p">));</span>
			<span class="n">val</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)(</span><span class="n">utc</span><span class="p">.</span><span class="n">tv_sec</span> <span class="o">-</span> <span class="n">ts</span><span class="p">.</span><span class="n">tv_sec</span><span class="p">);</span>
			<span class="n">seconds</span> <span class="o">=</span> <span class="n">abs</span><span class="p">(</span><span class="n">val</span><span class="p">);</span>
			<span class="n">result</span> <span class="o">=</span> <span class="p">(</span><span class="n">seconds</span> <span class="o">/</span> <span class="n">MIN_TZ_ADJ</span><span class="p">)</span> <span class="o">*</span> <span class="n">MIN_TZ_ADJ</span><span class="p">;</span>
			<span class="n">remain</span> <span class="o">=</span> <span class="n">seconds</span> <span class="o">%</span> <span class="n">MIN_TZ_ADJ</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">remain</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="n">MIN_TZ_ADJ</span> <span class="o">/</span> <span class="mi">2</span><span class="p">))</span>
				<span class="n">result</span> <span class="o">+=</span> <span class="n">MIN_TZ_ADJ</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">result</span> <span class="o">=</span> <span class="o">-</span><span class="n">result</span><span class="p">;</span>
			<span class="n">server</span><span class="o">-&gt;</span><span class="n">timeAdj</span> <span class="o">=</span> <span class="n">result</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">server</span><span class="o">-&gt;</span><span class="n">timeAdj</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">tmp</span><span class="p">;</span>
			<span class="n">server</span><span class="o">-&gt;</span><span class="n">timeAdj</span> <span class="o">*=</span> <span class="mi">60</span><span class="p">;</span> <span class="cm">/* also in seconds */</span>
		<span class="p">}</span>
		<span class="n">cFYI</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;server-&gt;timeAdj: %d seconds&quot;</span><span class="p">,</span> <span class="n">server</span><span class="o">-&gt;</span><span class="n">timeAdj</span><span class="p">);</span>


		<span class="cm">/* BB get server time for time conversions and add</span>
<span class="cm">		code to use it and timezone since this is not UTC */</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">rsp</span><span class="o">-&gt;</span><span class="n">EncryptionKeyLength</span> <span class="o">==</span>
				<span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">CIFS_CRYPTO_KEY_SIZE</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">ses</span><span class="o">-&gt;</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">cryptkey</span><span class="p">,</span> <span class="n">rsp</span><span class="o">-&gt;</span><span class="n">EncryptionKey</span><span class="p">,</span>
				<span class="n">CIFS_CRYPTO_KEY_SIZE</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">sec_mode</span> <span class="o">&amp;</span> <span class="n">SECMODE_PW_ENCRYPT</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span> <span class="cm">/* need cryptkey unless plain text */</span>
			<span class="k">goto</span> <span class="n">neg_err_exit</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">cFYI</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;LANMAN negotiated&quot;</span><span class="p">);</span>
		<span class="cm">/* we will not end up setting signing flags - as no signing</span>
<span class="cm">		was in LANMAN and server did not return the flags on */</span>
		<span class="k">goto</span> <span class="n">signing_check</span><span class="p">;</span>
<span class="cp">#else </span><span class="cm">/* weak security disabled */</span><span class="cp"></span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">pSMBr</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">WordCount</span> <span class="o">==</span> <span class="mi">13</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cERROR</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;mount failed, cifs module not built &quot;</span>
			  <span class="s">&quot;with CIFS_WEAK_PW_HASH support&quot;</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
<span class="cp">#endif </span><span class="cm">/* WEAK_PW_HASH */</span><span class="cp"></span>
		<span class="k">goto</span> <span class="n">neg_err_exit</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">pSMBr</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">WordCount</span> <span class="o">!=</span> <span class="mi">17</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* unknown wct */</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">neg_err_exit</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* else wct == 17 NTLM */</span>
	<span class="n">server</span><span class="o">-&gt;</span><span class="n">sec_mode</span> <span class="o">=</span> <span class="n">pSMBr</span><span class="o">-&gt;</span><span class="n">SecurityMode</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">sec_mode</span> <span class="o">&amp;</span> <span class="n">SECMODE_USER</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">cFYI</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;share mode security&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">sec_mode</span> <span class="o">&amp;</span> <span class="n">SECMODE_PW_ENCRYPT</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
<span class="cp">#ifdef CONFIG_CIFS_WEAK_PW_HASH</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">secFlags</span> <span class="o">&amp;</span> <span class="n">CIFSSEC_MAY_PLNTXT</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
<span class="cp">#endif </span><span class="cm">/* CIFS_WEAK_PW_HASH */</span><span class="cp"></span>
			<span class="n">cERROR</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;Server requests plain text password&quot;</span>
				  <span class="s">&quot; but client support disabled&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">secFlags</span> <span class="o">&amp;</span> <span class="n">CIFSSEC_MUST_NTLMV2</span><span class="p">)</span> <span class="o">==</span> <span class="n">CIFSSEC_MUST_NTLMV2</span><span class="p">)</span>
		<span class="n">server</span><span class="o">-&gt;</span><span class="n">secType</span> <span class="o">=</span> <span class="n">NTLMv2</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">secFlags</span> <span class="o">&amp;</span> <span class="n">CIFSSEC_MAY_NTLM</span><span class="p">)</span>
		<span class="n">server</span><span class="o">-&gt;</span><span class="n">secType</span> <span class="o">=</span> <span class="n">NTLM</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">secFlags</span> <span class="o">&amp;</span> <span class="n">CIFSSEC_MAY_NTLMV2</span><span class="p">)</span>
		<span class="n">server</span><span class="o">-&gt;</span><span class="n">secType</span> <span class="o">=</span> <span class="n">NTLMv2</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">secFlags</span> <span class="o">&amp;</span> <span class="n">CIFSSEC_MAY_KRB5</span><span class="p">)</span>
		<span class="n">server</span><span class="o">-&gt;</span><span class="n">secType</span> <span class="o">=</span> <span class="n">Kerberos</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">secFlags</span> <span class="o">&amp;</span> <span class="n">CIFSSEC_MAY_NTLMSSP</span><span class="p">)</span>
		<span class="n">server</span><span class="o">-&gt;</span><span class="n">secType</span> <span class="o">=</span> <span class="n">RawNTLMSSP</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">secFlags</span> <span class="o">&amp;</span> <span class="n">CIFSSEC_MAY_LANMAN</span><span class="p">)</span>
		<span class="n">server</span><span class="o">-&gt;</span><span class="n">secType</span> <span class="o">=</span> <span class="n">LANMAN</span><span class="p">;</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
		<span class="n">cERROR</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;Invalid security type&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">neg_err_exit</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* else ... any others ...? */</span>

	<span class="cm">/* one byte, so no need to convert this or EncryptionKeyLen from</span>
<span class="cm">	   little endian */</span>
	<span class="n">server</span><span class="o">-&gt;</span><span class="n">maxReq</span> <span class="o">=</span> <span class="n">min_t</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">,</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">pSMBr</span><span class="o">-&gt;</span><span class="n">MaxMpxCount</span><span class="p">),</span>
			       <span class="n">cifs_max_pending</span><span class="p">);</span>
	<span class="n">set_credits</span><span class="p">(</span><span class="n">server</span><span class="p">,</span> <span class="n">server</span><span class="o">-&gt;</span><span class="n">maxReq</span><span class="p">);</span>
	<span class="cm">/* probably no need to store and check maxvcs */</span>
	<span class="n">server</span><span class="o">-&gt;</span><span class="n">maxBuf</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">pSMBr</span><span class="o">-&gt;</span><span class="n">MaxBufferSize</span><span class="p">);</span>
	<span class="n">server</span><span class="o">-&gt;</span><span class="n">max_rw</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">pSMBr</span><span class="o">-&gt;</span><span class="n">MaxRawSize</span><span class="p">);</span>
	<span class="n">cFYI</span><span class="p">(</span><span class="n">DBG2</span><span class="p">,</span> <span class="s">&quot;Max buf = %d&quot;</span><span class="p">,</span> <span class="n">ses</span><span class="o">-&gt;</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">maxBuf</span><span class="p">);</span>
	<span class="n">server</span><span class="o">-&gt;</span><span class="n">capabilities</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">pSMBr</span><span class="o">-&gt;</span><span class="n">Capabilities</span><span class="p">);</span>
	<span class="n">server</span><span class="o">-&gt;</span><span class="n">timeAdj</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)(</span><span class="n">__s16</span><span class="p">)</span><span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">pSMBr</span><span class="o">-&gt;</span><span class="n">ServerTimeZone</span><span class="p">);</span>
	<span class="n">server</span><span class="o">-&gt;</span><span class="n">timeAdj</span> <span class="o">*=</span> <span class="mi">60</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pSMBr</span><span class="o">-&gt;</span><span class="n">EncryptionKeyLength</span> <span class="o">==</span> <span class="n">CIFS_CRYPTO_KEY_SIZE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">ses</span><span class="o">-&gt;</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">cryptkey</span><span class="p">,</span> <span class="n">pSMBr</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">EncryptionKey</span><span class="p">,</span>
		       <span class="n">CIFS_CRYPTO_KEY_SIZE</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">pSMBr</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">Flags2</span> <span class="o">&amp;</span> <span class="n">SMBFLG2_EXT_SEC</span> <span class="o">||</span>
			<span class="n">server</span><span class="o">-&gt;</span><span class="n">capabilities</span> <span class="o">&amp;</span> <span class="n">CAP_EXTENDED_SECURITY</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
				<span class="p">(</span><span class="n">pSMBr</span><span class="o">-&gt;</span><span class="n">EncryptionKeyLength</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* decode security blob */</span>
		<span class="n">count</span> <span class="o">=</span> <span class="n">get_bcc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pSMBr</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">neg_err_exit</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cifs_tcp_ses_lock</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">srv_count</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cifs_tcp_ses_lock</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">memcmp</span><span class="p">(</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">server_GUID</span><span class="p">,</span>
				   <span class="n">pSMBr</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">extended_response</span><span class="p">.</span>
				   <span class="n">GUID</span><span class="p">,</span> <span class="mi">16</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">cFYI</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;server UID changed&quot;</span><span class="p">);</span>
				<span class="n">memcpy</span><span class="p">(</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">server_GUID</span><span class="p">,</span>
					<span class="n">pSMBr</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">extended_response</span><span class="p">.</span><span class="n">GUID</span><span class="p">,</span>
					<span class="mi">16</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cifs_tcp_ses_lock</span><span class="p">);</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">server_GUID</span><span class="p">,</span>
			       <span class="n">pSMBr</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">extended_response</span><span class="p">.</span><span class="n">GUID</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">==</span> <span class="mi">16</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">server</span><span class="o">-&gt;</span><span class="n">secType</span> <span class="o">=</span> <span class="n">RawNTLMSSP</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="n">decode_negTokenInit</span><span class="p">(</span><span class="n">pSMBr</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">extended_response</span><span class="p">.</span>
						 <span class="n">SecurityBlob</span><span class="p">,</span> <span class="n">count</span> <span class="o">-</span> <span class="mi">16</span><span class="p">,</span>
						 <span class="n">server</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
				<span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">secType</span> <span class="o">==</span> <span class="n">Kerberos</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">sec_kerberos</span> <span class="o">&amp;&amp;</span>
						<span class="o">!</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">sec_mskerberos</span><span class="p">)</span>
					<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">secType</span> <span class="o">==</span> <span class="n">RawNTLMSSP</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">sec_ntlmssp</span><span class="p">)</span>
					<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span>
					<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">sec_mode</span> <span class="o">&amp;</span> <span class="n">SECMODE_PW_ENCRYPT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span> <span class="cm">/* no crypt key only if plain text pwd */</span>
		<span class="k">goto</span> <span class="n">neg_err_exit</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">server</span><span class="o">-&gt;</span><span class="n">capabilities</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">CAP_EXTENDED_SECURITY</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_CIFS_WEAK_PW_HASH</span>
<span class="nl">signing_check:</span>
<span class="cp">#endif</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">secFlags</span> <span class="o">&amp;</span> <span class="n">CIFSSEC_MAY_SIGN</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* MUST_SIGN already includes the MAY_SIGN FLAG</span>
<span class="cm">		   so if this is zero it means that signing is disabled */</span>
		<span class="n">cFYI</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;Signing disabled&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">sec_mode</span> <span class="o">&amp;</span> <span class="n">SECMODE_SIGN_REQUIRED</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">cERROR</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;Server requires &quot;</span>
				   <span class="s">&quot;packet signing to be enabled in &quot;</span>
				   <span class="s">&quot;/proc/fs/cifs/SecurityFlags.&quot;</span><span class="p">);</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">server</span><span class="o">-&gt;</span><span class="n">sec_mode</span> <span class="o">&amp;=</span>
			<span class="o">~</span><span class="p">(</span><span class="n">SECMODE_SIGN_ENABLED</span> <span class="o">|</span> <span class="n">SECMODE_SIGN_REQUIRED</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">secFlags</span> <span class="o">&amp;</span> <span class="n">CIFSSEC_MUST_SIGN</span><span class="p">)</span> <span class="o">==</span> <span class="n">CIFSSEC_MUST_SIGN</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* signing required */</span>
		<span class="n">cFYI</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;Must sign - secFlags 0x%x&quot;</span><span class="p">,</span> <span class="n">secFlags</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">sec_mode</span> <span class="o">&amp;</span>
			<span class="p">(</span><span class="n">SECMODE_SIGN_ENABLED</span> <span class="o">|</span> <span class="n">SECMODE_SIGN_REQUIRED</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">cERROR</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;signing required but server lacks support&quot;</span><span class="p">);</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">server</span><span class="o">-&gt;</span><span class="n">sec_mode</span> <span class="o">|=</span> <span class="n">SECMODE_SIGN_REQUIRED</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* signing optional ie CIFSSEC_MAY_SIGN */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">sec_mode</span> <span class="o">&amp;</span> <span class="n">SECMODE_SIGN_REQUIRED</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">server</span><span class="o">-&gt;</span><span class="n">sec_mode</span> <span class="o">&amp;=</span>
				<span class="o">~</span><span class="p">(</span><span class="n">SECMODE_SIGN_ENABLED</span> <span class="o">|</span> <span class="n">SECMODE_SIGN_REQUIRED</span><span class="p">);</span>
	<span class="p">}</span>

<span class="nl">neg_err_exit:</span>
	<span class="n">cifs_buf_release</span><span class="p">(</span><span class="n">pSMB</span><span class="p">);</span>

	<span class="n">cFYI</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;negprot rc %d&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="nf">CIFSSMBTDis</span><span class="p">(</span><span class="k">const</span> <span class="kt">int</span> <span class="n">xid</span><span class="p">,</span> <span class="k">struct</span> <span class="n">cifs_tcon</span> <span class="o">*</span><span class="n">tcon</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">smb_hdr</span> <span class="o">*</span><span class="n">smb_buffer</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">cFYI</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;In tree disconnect&quot;</span><span class="p">);</span>

	<span class="cm">/* BB: do we need to check this? These should never be NULL. */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">tcon</span><span class="o">-&gt;</span><span class="n">ses</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">tcon</span><span class="o">-&gt;</span><span class="n">ses</span><span class="o">-&gt;</span><span class="n">server</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * No need to return error on this operation if tid invalidated and</span>
<span class="cm">	 * closed on server already e.g. due to tcp session crashing. Also,</span>
<span class="cm">	 * the tcon is no longer on the list, so no need to take lock before</span>
<span class="cm">	 * checking this.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">tcon</span><span class="o">-&gt;</span><span class="n">need_reconnect</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">tcon</span><span class="o">-&gt;</span><span class="n">ses</span><span class="o">-&gt;</span><span class="n">need_reconnect</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">small_smb_init</span><span class="p">(</span><span class="n">SMB_COM_TREE_DISCONNECT</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">tcon</span><span class="p">,</span>
			    <span class="p">(</span><span class="kt">void</span> <span class="o">**</span><span class="p">)</span><span class="o">&amp;</span><span class="n">smb_buffer</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">SendReceiveNoRsp</span><span class="p">(</span><span class="n">xid</span><span class="p">,</span> <span class="n">tcon</span><span class="o">-&gt;</span><span class="n">ses</span><span class="p">,</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">smb_buffer</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="n">cFYI</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;Tree disconnect failed %d&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>

	<span class="cm">/* No need to return error on this operation if tid invalidated and</span>
<span class="cm">	   closed on server already e.g. due to tcp session crashing */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">)</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * This is a no-op for now. We&#39;re not really interested in the reply, but</span>
<span class="cm"> * rather in the fact that the server sent one and that server-&gt;lstrp</span>
<span class="cm"> * gets updated.</span>
<span class="cm"> *</span>
<span class="cm"> * FIXME: maybe we should consider checking that the reply matches request?</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">cifs_echo_callback</span><span class="p">(</span><span class="k">struct</span> <span class="n">mid_q_entry</span> <span class="o">*</span><span class="n">mid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">TCP_Server_Info</span> <span class="o">*</span><span class="n">server</span> <span class="o">=</span> <span class="n">mid</span><span class="o">-&gt;</span><span class="n">callback_data</span><span class="p">;</span>

	<span class="n">DeleteMidQEntry</span><span class="p">(</span><span class="n">mid</span><span class="p">);</span>
	<span class="n">add_credits</span><span class="p">(</span><span class="n">server</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="nf">CIFSSMBEcho</span><span class="p">(</span><span class="k">struct</span> <span class="n">TCP_Server_Info</span> <span class="o">*</span><span class="n">server</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ECHO_REQ</span> <span class="o">*</span><span class="n">smb</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">kvec</span> <span class="n">iov</span><span class="p">;</span>

	<span class="n">cFYI</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;In echo request&quot;</span><span class="p">);</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">small_smb_init</span><span class="p">(</span><span class="n">SMB_COM_ECHO</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">**</span><span class="p">)</span><span class="o">&amp;</span><span class="n">smb</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

	<span class="cm">/* set up echo request */</span>
	<span class="n">smb</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">Tid</span> <span class="o">=</span> <span class="mh">0xffff</span><span class="p">;</span>
	<span class="n">smb</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">WordCount</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">put_unaligned_le16</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">smb</span><span class="o">-&gt;</span><span class="n">EchoCount</span><span class="p">);</span>
	<span class="n">put_bcc</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">smb</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">);</span>
	<span class="n">smb</span><span class="o">-&gt;</span><span class="n">Data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;a&#39;</span><span class="p">;</span>
	<span class="n">inc_rfc1001_len</span><span class="p">(</span><span class="n">smb</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
	<span class="n">iov</span><span class="p">.</span><span class="n">iov_base</span> <span class="o">=</span> <span class="n">smb</span><span class="p">;</span>
	<span class="n">iov</span><span class="p">.</span><span class="n">iov_len</span> <span class="o">=</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">smb</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">smb_buf_length</span><span class="p">)</span> <span class="o">+</span> <span class="mi">4</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">cifs_call_async</span><span class="p">(</span><span class="n">server</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">iov</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">cifs_echo_callback</span><span class="p">,</span>
			     <span class="n">server</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="n">cFYI</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;Echo request failed: %d&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>

	<span class="n">cifs_small_buf_release</span><span class="p">(</span><span class="n">smb</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="nf">CIFSSMBLogoff</span><span class="p">(</span><span class="k">const</span> <span class="kt">int</span> <span class="n">xid</span><span class="p">,</span> <span class="k">struct</span> <span class="n">cifs_ses</span> <span class="o">*</span><span class="n">ses</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">LOGOFF_ANDX_REQ</span> <span class="o">*</span><span class="n">pSMB</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">cFYI</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;In SMBLogoff for session disconnect&quot;</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * BB: do we need to check validity of ses and server? They should</span>
<span class="cm">	 * always be valid since we have an active reference. If not, that</span>
<span class="cm">	 * should probably be a BUG()</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ses</span> <span class="o">||</span> <span class="o">!</span><span class="n">ses</span><span class="o">-&gt;</span><span class="n">server</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ses</span><span class="o">-&gt;</span><span class="n">session_mutex</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ses</span><span class="o">-&gt;</span><span class="n">need_reconnect</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">session_already_dead</span><span class="p">;</span> <span class="cm">/* no need to send SMBlogoff if uid</span>
<span class="cm">					      already closed due to reconnect */</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">small_smb_init</span><span class="p">(</span><span class="n">SMB_COM_LOGOFF_ANDX</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">**</span><span class="p">)</span><span class="o">&amp;</span><span class="n">pSMB</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ses</span><span class="o">-&gt;</span><span class="n">session_mutex</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">Mid</span> <span class="o">=</span> <span class="n">get_next_mid</span><span class="p">(</span><span class="n">ses</span><span class="o">-&gt;</span><span class="n">server</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ses</span><span class="o">-&gt;</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">sec_mode</span> <span class="o">&amp;</span>
		   <span class="p">(</span><span class="n">SECMODE_SIGN_REQUIRED</span> <span class="o">|</span> <span class="n">SECMODE_SIGN_ENABLED</span><span class="p">))</span>
			<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">Flags2</span> <span class="o">|=</span> <span class="n">SMBFLG2_SECURITY_SIGNATURE</span><span class="p">;</span>

	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">Uid</span> <span class="o">=</span> <span class="n">ses</span><span class="o">-&gt;</span><span class="n">Suid</span><span class="p">;</span>

	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">AndXCommand</span> <span class="o">=</span> <span class="mh">0xFF</span><span class="p">;</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">SendReceiveNoRsp</span><span class="p">(</span><span class="n">xid</span><span class="p">,</span> <span class="n">ses</span><span class="p">,</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">pSMB</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="nl">session_already_dead:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ses</span><span class="o">-&gt;</span><span class="n">session_mutex</span><span class="p">);</span>

	<span class="cm">/* if session dead then we do not need to do ulogoff,</span>
<span class="cm">		since server closed smb session, no sense reporting</span>
<span class="cm">		error */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">)</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="nf">CIFSPOSIXDelFile</span><span class="p">(</span><span class="k">const</span> <span class="kt">int</span> <span class="n">xid</span><span class="p">,</span> <span class="k">struct</span> <span class="n">cifs_tcon</span> <span class="o">*</span><span class="n">tcon</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">fileName</span><span class="p">,</span>
		 <span class="n">__u16</span> <span class="n">type</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">nls_table</span> <span class="o">*</span><span class="n">nls_codepage</span><span class="p">,</span> <span class="kt">int</span> <span class="n">remap</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">TRANSACTION2_SPI_REQ</span> <span class="o">*</span><span class="n">pSMB</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">TRANSACTION2_SPI_RSP</span> <span class="o">*</span><span class="n">pSMBr</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">unlink_psx_rq</span> <span class="o">*</span><span class="n">pRqD</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">name_len</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">bytes_returned</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">__u16</span> <span class="n">params</span><span class="p">,</span> <span class="n">param_offset</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">byte_count</span><span class="p">;</span>

	<span class="n">cFYI</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;In POSIX delete&quot;</span><span class="p">);</span>
<span class="nl">PsxDelete:</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">smb_init</span><span class="p">(</span><span class="n">SMB_COM_TRANSACTION2</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="n">tcon</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">**</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">pSMB</span><span class="p">,</span>
		      <span class="p">(</span><span class="kt">void</span> <span class="o">**</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">pSMBr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">Flags2</span> <span class="o">&amp;</span> <span class="n">SMBFLG2_UNICODE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">name_len</span> <span class="o">=</span>
		    <span class="n">cifsConvertToUTF16</span><span class="p">((</span><span class="n">__le16</span> <span class="o">*</span><span class="p">)</span> <span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">FileName</span><span class="p">,</span> <span class="n">fileName</span><span class="p">,</span>
				       <span class="n">PATH_MAX</span><span class="p">,</span> <span class="n">nls_codepage</span><span class="p">,</span> <span class="n">remap</span><span class="p">);</span>
		<span class="n">name_len</span><span class="o">++</span><span class="p">;</span>	<span class="cm">/* trailing null */</span>
		<span class="n">name_len</span> <span class="o">*=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span> <span class="cm">/* BB add path length overrun check */</span>
		<span class="n">name_len</span> <span class="o">=</span> <span class="n">strnlen</span><span class="p">(</span><span class="n">fileName</span><span class="p">,</span> <span class="n">PATH_MAX</span><span class="p">);</span>
		<span class="n">name_len</span><span class="o">++</span><span class="p">;</span>	<span class="cm">/* trailing null */</span>
		<span class="n">strncpy</span><span class="p">(</span><span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">FileName</span><span class="p">,</span> <span class="n">fileName</span><span class="p">,</span> <span class="n">name_len</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">params</span> <span class="o">=</span> <span class="mi">6</span> <span class="o">+</span> <span class="n">name_len</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">MaxParameterCount</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">MaxDataCount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* BB double check this with jra */</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">MaxSetupCount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">Reserved</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">Flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">Timeout</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">Reserved2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">param_offset</span> <span class="o">=</span> <span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">smb_com_transaction2_spi_req</span><span class="p">,</span>
				<span class="n">InformationLevel</span><span class="p">)</span> <span class="o">-</span> <span class="mi">4</span><span class="p">;</span>
	<span class="n">offset</span> <span class="o">=</span> <span class="n">param_offset</span> <span class="o">+</span> <span class="n">params</span><span class="p">;</span>

	<span class="cm">/* Setup pointer to Request Data (inode type) */</span>
	<span class="n">pRqD</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">unlink_psx_rq</span> <span class="o">*</span><span class="p">)(((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">Protocol</span><span class="p">)</span> <span class="o">+</span> <span class="n">offset</span><span class="p">);</span>
	<span class="n">pRqD</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">type</span><span class="p">);</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">ParameterOffset</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">param_offset</span><span class="p">);</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">DataOffset</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">offset</span><span class="p">);</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">SetupCount</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">Reserved3</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">SubCommand</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">TRANS2_SET_PATH_INFORMATION</span><span class="p">);</span>
	<span class="n">byte_count</span> <span class="o">=</span> <span class="mi">3</span> <span class="cm">/* pad */</span>  <span class="o">+</span> <span class="n">params</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">unlink_psx_rq</span><span class="p">);</span>

	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">DataCount</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">unlink_psx_rq</span><span class="p">));</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">TotalDataCount</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">unlink_psx_rq</span><span class="p">));</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">ParameterCount</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">params</span><span class="p">);</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">TotalParameterCount</span> <span class="o">=</span> <span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">ParameterCount</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">InformationLevel</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">SMB_POSIX_UNLINK</span><span class="p">);</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">Reserved4</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">inc_rfc1001_len</span><span class="p">(</span><span class="n">pSMB</span><span class="p">,</span> <span class="n">byte_count</span><span class="p">);</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">ByteCount</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">byte_count</span><span class="p">);</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">SendReceive</span><span class="p">(</span><span class="n">xid</span><span class="p">,</span> <span class="n">tcon</span><span class="o">-&gt;</span><span class="n">ses</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">smb_hdr</span> <span class="o">*</span><span class="p">)</span> <span class="n">pSMB</span><span class="p">,</span>
			 <span class="p">(</span><span class="k">struct</span> <span class="n">smb_hdr</span> <span class="o">*</span><span class="p">)</span> <span class="n">pSMBr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bytes_returned</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="n">cFYI</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;Posix delete returned %d&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
	<span class="n">cifs_buf_release</span><span class="p">(</span><span class="n">pSMB</span><span class="p">);</span>

	<span class="n">cifs_stats_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tcon</span><span class="o">-&gt;</span><span class="n">num_deletes</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">PsxDelete</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="nf">CIFSSMBDelFile</span><span class="p">(</span><span class="k">const</span> <span class="kt">int</span> <span class="n">xid</span><span class="p">,</span> <span class="k">struct</span> <span class="n">cifs_tcon</span> <span class="o">*</span><span class="n">tcon</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">fileName</span><span class="p">,</span>
	       <span class="k">const</span> <span class="k">struct</span> <span class="n">nls_table</span> <span class="o">*</span><span class="n">nls_codepage</span><span class="p">,</span> <span class="kt">int</span> <span class="n">remap</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">DELETE_FILE_REQ</span> <span class="o">*</span><span class="n">pSMB</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">DELETE_FILE_RSP</span> <span class="o">*</span><span class="n">pSMBr</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">bytes_returned</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">name_len</span><span class="p">;</span>

<span class="nl">DelFileRetry:</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">smb_init</span><span class="p">(</span><span class="n">SMB_COM_DELETE</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">tcon</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">**</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">pSMB</span><span class="p">,</span>
		      <span class="p">(</span><span class="kt">void</span> <span class="o">**</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">pSMBr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">Flags2</span> <span class="o">&amp;</span> <span class="n">SMBFLG2_UNICODE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">name_len</span> <span class="o">=</span>
		    <span class="n">cifsConvertToUTF16</span><span class="p">((</span><span class="n">__le16</span> <span class="o">*</span><span class="p">)</span> <span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">fileName</span><span class="p">,</span> <span class="n">fileName</span><span class="p">,</span>
				       <span class="n">PATH_MAX</span><span class="p">,</span> <span class="n">nls_codepage</span><span class="p">,</span> <span class="n">remap</span><span class="p">);</span>
		<span class="n">name_len</span><span class="o">++</span><span class="p">;</span>	<span class="cm">/* trailing null */</span>
		<span class="n">name_len</span> <span class="o">*=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>		<span class="cm">/* BB improve check for buffer overruns BB */</span>
		<span class="n">name_len</span> <span class="o">=</span> <span class="n">strnlen</span><span class="p">(</span><span class="n">fileName</span><span class="p">,</span> <span class="n">PATH_MAX</span><span class="p">);</span>
		<span class="n">name_len</span><span class="o">++</span><span class="p">;</span>	<span class="cm">/* trailing null */</span>
		<span class="n">strncpy</span><span class="p">(</span><span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">fileName</span><span class="p">,</span> <span class="n">fileName</span><span class="p">,</span> <span class="n">name_len</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">SearchAttributes</span> <span class="o">=</span>
	    <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">ATTR_READONLY</span> <span class="o">|</span> <span class="n">ATTR_HIDDEN</span> <span class="o">|</span> <span class="n">ATTR_SYSTEM</span><span class="p">);</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">BufferFormat</span> <span class="o">=</span> <span class="mh">0x04</span><span class="p">;</span>
	<span class="n">inc_rfc1001_len</span><span class="p">(</span><span class="n">pSMB</span><span class="p">,</span> <span class="n">name_len</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">ByteCount</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">name_len</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">SendReceive</span><span class="p">(</span><span class="n">xid</span><span class="p">,</span> <span class="n">tcon</span><span class="o">-&gt;</span><span class="n">ses</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">smb_hdr</span> <span class="o">*</span><span class="p">)</span> <span class="n">pSMB</span><span class="p">,</span>
			 <span class="p">(</span><span class="k">struct</span> <span class="n">smb_hdr</span> <span class="o">*</span><span class="p">)</span> <span class="n">pSMBr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bytes_returned</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">cifs_stats_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tcon</span><span class="o">-&gt;</span><span class="n">num_deletes</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="n">cFYI</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;Error in RMFile = %d&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>

	<span class="n">cifs_buf_release</span><span class="p">(</span><span class="n">pSMB</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">DelFileRetry</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="nf">CIFSSMBRmDir</span><span class="p">(</span><span class="k">const</span> <span class="kt">int</span> <span class="n">xid</span><span class="p">,</span> <span class="k">struct</span> <span class="n">cifs_tcon</span> <span class="o">*</span><span class="n">tcon</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">dirName</span><span class="p">,</span>
	     <span class="k">const</span> <span class="k">struct</span> <span class="n">nls_table</span> <span class="o">*</span><span class="n">nls_codepage</span><span class="p">,</span> <span class="kt">int</span> <span class="n">remap</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">DELETE_DIRECTORY_REQ</span> <span class="o">*</span><span class="n">pSMB</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">DELETE_DIRECTORY_RSP</span> <span class="o">*</span><span class="n">pSMBr</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">bytes_returned</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">name_len</span><span class="p">;</span>

	<span class="n">cFYI</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;In CIFSSMBRmDir&quot;</span><span class="p">);</span>
<span class="nl">RmDirRetry:</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">smb_init</span><span class="p">(</span><span class="n">SMB_COM_DELETE_DIRECTORY</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">tcon</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">**</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">pSMB</span><span class="p">,</span>
		      <span class="p">(</span><span class="kt">void</span> <span class="o">**</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">pSMBr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">Flags2</span> <span class="o">&amp;</span> <span class="n">SMBFLG2_UNICODE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">name_len</span> <span class="o">=</span> <span class="n">cifsConvertToUTF16</span><span class="p">((</span><span class="n">__le16</span> <span class="o">*</span><span class="p">)</span> <span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">DirName</span><span class="p">,</span> <span class="n">dirName</span><span class="p">,</span>
					      <span class="n">PATH_MAX</span><span class="p">,</span> <span class="n">nls_codepage</span><span class="p">,</span> <span class="n">remap</span><span class="p">);</span>
		<span class="n">name_len</span><span class="o">++</span><span class="p">;</span>	<span class="cm">/* trailing null */</span>
		<span class="n">name_len</span> <span class="o">*=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>		<span class="cm">/* BB improve check for buffer overruns BB */</span>
		<span class="n">name_len</span> <span class="o">=</span> <span class="n">strnlen</span><span class="p">(</span><span class="n">dirName</span><span class="p">,</span> <span class="n">PATH_MAX</span><span class="p">);</span>
		<span class="n">name_len</span><span class="o">++</span><span class="p">;</span>	<span class="cm">/* trailing null */</span>
		<span class="n">strncpy</span><span class="p">(</span><span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">DirName</span><span class="p">,</span> <span class="n">dirName</span><span class="p">,</span> <span class="n">name_len</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">BufferFormat</span> <span class="o">=</span> <span class="mh">0x04</span><span class="p">;</span>
	<span class="n">inc_rfc1001_len</span><span class="p">(</span><span class="n">pSMB</span><span class="p">,</span> <span class="n">name_len</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">ByteCount</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">name_len</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">SendReceive</span><span class="p">(</span><span class="n">xid</span><span class="p">,</span> <span class="n">tcon</span><span class="o">-&gt;</span><span class="n">ses</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">smb_hdr</span> <span class="o">*</span><span class="p">)</span> <span class="n">pSMB</span><span class="p">,</span>
			 <span class="p">(</span><span class="k">struct</span> <span class="n">smb_hdr</span> <span class="o">*</span><span class="p">)</span> <span class="n">pSMBr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bytes_returned</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">cifs_stats_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tcon</span><span class="o">-&gt;</span><span class="n">num_rmdirs</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="n">cFYI</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;Error in RMDir = %d&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>

	<span class="n">cifs_buf_release</span><span class="p">(</span><span class="n">pSMB</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">RmDirRetry</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="nf">CIFSSMBMkDir</span><span class="p">(</span><span class="k">const</span> <span class="kt">int</span> <span class="n">xid</span><span class="p">,</span> <span class="k">struct</span> <span class="n">cifs_tcon</span> <span class="o">*</span><span class="n">tcon</span><span class="p">,</span>
	     <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">nls_table</span> <span class="o">*</span><span class="n">nls_codepage</span><span class="p">,</span> <span class="kt">int</span> <span class="n">remap</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">CREATE_DIRECTORY_REQ</span> <span class="o">*</span><span class="n">pSMB</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">CREATE_DIRECTORY_RSP</span> <span class="o">*</span><span class="n">pSMBr</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">bytes_returned</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">name_len</span><span class="p">;</span>

	<span class="n">cFYI</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;In CIFSSMBMkDir&quot;</span><span class="p">);</span>
<span class="nl">MkDirRetry:</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">smb_init</span><span class="p">(</span><span class="n">SMB_COM_CREATE_DIRECTORY</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">tcon</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">**</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">pSMB</span><span class="p">,</span>
		      <span class="p">(</span><span class="kt">void</span> <span class="o">**</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">pSMBr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">Flags2</span> <span class="o">&amp;</span> <span class="n">SMBFLG2_UNICODE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">name_len</span> <span class="o">=</span> <span class="n">cifsConvertToUTF16</span><span class="p">((</span><span class="n">__le16</span> <span class="o">*</span><span class="p">)</span> <span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">DirName</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span>
					      <span class="n">PATH_MAX</span><span class="p">,</span> <span class="n">nls_codepage</span><span class="p">,</span> <span class="n">remap</span><span class="p">);</span>
		<span class="n">name_len</span><span class="o">++</span><span class="p">;</span>	<span class="cm">/* trailing null */</span>
		<span class="n">name_len</span> <span class="o">*=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>		<span class="cm">/* BB improve check for buffer overruns BB */</span>
		<span class="n">name_len</span> <span class="o">=</span> <span class="n">strnlen</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">PATH_MAX</span><span class="p">);</span>
		<span class="n">name_len</span><span class="o">++</span><span class="p">;</span>	<span class="cm">/* trailing null */</span>
		<span class="n">strncpy</span><span class="p">(</span><span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">DirName</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">name_len</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">BufferFormat</span> <span class="o">=</span> <span class="mh">0x04</span><span class="p">;</span>
	<span class="n">inc_rfc1001_len</span><span class="p">(</span><span class="n">pSMB</span><span class="p">,</span> <span class="n">name_len</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">ByteCount</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">name_len</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">SendReceive</span><span class="p">(</span><span class="n">xid</span><span class="p">,</span> <span class="n">tcon</span><span class="o">-&gt;</span><span class="n">ses</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">smb_hdr</span> <span class="o">*</span><span class="p">)</span> <span class="n">pSMB</span><span class="p">,</span>
			 <span class="p">(</span><span class="k">struct</span> <span class="n">smb_hdr</span> <span class="o">*</span><span class="p">)</span> <span class="n">pSMBr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bytes_returned</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">cifs_stats_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tcon</span><span class="o">-&gt;</span><span class="n">num_mkdirs</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="n">cFYI</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;Error in Mkdir = %d&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>

	<span class="n">cifs_buf_release</span><span class="p">(</span><span class="n">pSMB</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">MkDirRetry</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="nf">CIFSPOSIXCreate</span><span class="p">(</span><span class="k">const</span> <span class="kt">int</span> <span class="n">xid</span><span class="p">,</span> <span class="k">struct</span> <span class="n">cifs_tcon</span> <span class="o">*</span><span class="n">tcon</span><span class="p">,</span> <span class="n">__u32</span> <span class="n">posix_flags</span><span class="p">,</span>
		<span class="n">__u64</span> <span class="n">mode</span><span class="p">,</span> <span class="n">__u16</span> <span class="o">*</span><span class="n">netfid</span><span class="p">,</span> <span class="n">FILE_UNIX_BASIC_INFO</span> <span class="o">*</span><span class="n">pRetData</span><span class="p">,</span>
		<span class="n">__u32</span> <span class="o">*</span><span class="n">pOplock</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span>
		<span class="k">const</span> <span class="k">struct</span> <span class="n">nls_table</span> <span class="o">*</span><span class="n">nls_codepage</span><span class="p">,</span> <span class="kt">int</span> <span class="n">remap</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">TRANSACTION2_SPI_REQ</span> <span class="o">*</span><span class="n">pSMB</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">TRANSACTION2_SPI_RSP</span> <span class="o">*</span><span class="n">pSMBr</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">name_len</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">bytes_returned</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">__u16</span> <span class="n">params</span><span class="p">,</span> <span class="n">param_offset</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">byte_count</span><span class="p">,</span> <span class="n">count</span><span class="p">;</span>
	<span class="n">OPEN_PSX_REQ</span> <span class="o">*</span><span class="n">pdata</span><span class="p">;</span>
	<span class="n">OPEN_PSX_RSP</span> <span class="o">*</span><span class="n">psx_rsp</span><span class="p">;</span>

	<span class="n">cFYI</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;In POSIX Create&quot;</span><span class="p">);</span>
<span class="nl">PsxCreat:</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">smb_init</span><span class="p">(</span><span class="n">SMB_COM_TRANSACTION2</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="n">tcon</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">**</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">pSMB</span><span class="p">,</span>
		      <span class="p">(</span><span class="kt">void</span> <span class="o">**</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">pSMBr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">Flags2</span> <span class="o">&amp;</span> <span class="n">SMBFLG2_UNICODE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">name_len</span> <span class="o">=</span>
		    <span class="n">cifsConvertToUTF16</span><span class="p">((</span><span class="n">__le16</span> <span class="o">*</span><span class="p">)</span> <span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">FileName</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span>
				       <span class="n">PATH_MAX</span><span class="p">,</span> <span class="n">nls_codepage</span><span class="p">,</span> <span class="n">remap</span><span class="p">);</span>
		<span class="n">name_len</span><span class="o">++</span><span class="p">;</span>	<span class="cm">/* trailing null */</span>
		<span class="n">name_len</span> <span class="o">*=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>	<span class="cm">/* BB improve the check for buffer overruns BB */</span>
		<span class="n">name_len</span> <span class="o">=</span> <span class="n">strnlen</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">PATH_MAX</span><span class="p">);</span>
		<span class="n">name_len</span><span class="o">++</span><span class="p">;</span>	<span class="cm">/* trailing null */</span>
		<span class="n">strncpy</span><span class="p">(</span><span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">FileName</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">name_len</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">params</span> <span class="o">=</span> <span class="mi">6</span> <span class="o">+</span> <span class="n">name_len</span><span class="p">;</span>
	<span class="n">count</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">OPEN_PSX_REQ</span><span class="p">);</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">MaxParameterCount</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">MaxDataCount</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="mi">1000</span><span class="p">);</span>	<span class="cm">/* large enough */</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">MaxSetupCount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">Reserved</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">Flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">Timeout</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">Reserved2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">param_offset</span> <span class="o">=</span> <span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">smb_com_transaction2_spi_req</span><span class="p">,</span>
				<span class="n">InformationLevel</span><span class="p">)</span> <span class="o">-</span> <span class="mi">4</span><span class="p">;</span>
	<span class="n">offset</span> <span class="o">=</span> <span class="n">param_offset</span> <span class="o">+</span> <span class="n">params</span><span class="p">;</span>
	<span class="n">pdata</span> <span class="o">=</span> <span class="p">(</span><span class="n">OPEN_PSX_REQ</span> <span class="o">*</span><span class="p">)(((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">Protocol</span><span class="p">)</span> <span class="o">+</span> <span class="n">offset</span><span class="p">);</span>
	<span class="n">pdata</span><span class="o">-&gt;</span><span class="n">Level</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">SMB_QUERY_FILE_UNIX_BASIC</span><span class="p">);</span>
	<span class="n">pdata</span><span class="o">-&gt;</span><span class="n">Permissions</span> <span class="o">=</span> <span class="n">cpu_to_le64</span><span class="p">(</span><span class="n">mode</span><span class="p">);</span>
	<span class="n">pdata</span><span class="o">-&gt;</span><span class="n">PosixOpenFlags</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">posix_flags</span><span class="p">);</span>
	<span class="n">pdata</span><span class="o">-&gt;</span><span class="n">OpenFlags</span> <span class="o">=</span>  <span class="n">cpu_to_le32</span><span class="p">(</span><span class="o">*</span><span class="n">pOplock</span><span class="p">);</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">ParameterOffset</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">param_offset</span><span class="p">);</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">DataOffset</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">offset</span><span class="p">);</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">SetupCount</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">Reserved3</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">SubCommand</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">TRANS2_SET_PATH_INFORMATION</span><span class="p">);</span>
	<span class="n">byte_count</span> <span class="o">=</span> <span class="mi">3</span> <span class="cm">/* pad */</span>  <span class="o">+</span> <span class="n">params</span> <span class="o">+</span> <span class="n">count</span><span class="p">;</span>

	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">DataCount</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">count</span><span class="p">);</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">ParameterCount</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">params</span><span class="p">);</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">TotalDataCount</span> <span class="o">=</span> <span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">DataCount</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">TotalParameterCount</span> <span class="o">=</span> <span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">ParameterCount</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">InformationLevel</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">SMB_POSIX_OPEN</span><span class="p">);</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">Reserved4</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">inc_rfc1001_len</span><span class="p">(</span><span class="n">pSMB</span><span class="p">,</span> <span class="n">byte_count</span><span class="p">);</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">ByteCount</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">byte_count</span><span class="p">);</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">SendReceive</span><span class="p">(</span><span class="n">xid</span><span class="p">,</span> <span class="n">tcon</span><span class="o">-&gt;</span><span class="n">ses</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">smb_hdr</span> <span class="o">*</span><span class="p">)</span> <span class="n">pSMB</span><span class="p">,</span>
			 <span class="p">(</span><span class="k">struct</span> <span class="n">smb_hdr</span> <span class="o">*</span><span class="p">)</span> <span class="n">pSMBr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bytes_returned</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cFYI</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;Posix create returned %d&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">psx_create_err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">cFYI</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;copying inode info&quot;</span><span class="p">);</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">validate_t2</span><span class="p">((</span><span class="k">struct</span> <span class="n">smb_t2_rsp</span> <span class="o">*</span><span class="p">)</span><span class="n">pSMBr</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">||</span> <span class="n">get_bcc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pSMBr</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">)</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">OPEN_PSX_RSP</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>	<span class="cm">/* bad smb */</span>
		<span class="k">goto</span> <span class="n">psx_create_err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* copy return information to pRetData */</span>
	<span class="n">psx_rsp</span> <span class="o">=</span> <span class="p">(</span><span class="n">OPEN_PSX_RSP</span> <span class="o">*</span><span class="p">)((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">pSMBr</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">Protocol</span>
			<span class="o">+</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">pSMBr</span><span class="o">-&gt;</span><span class="n">t2</span><span class="p">.</span><span class="n">DataOffset</span><span class="p">));</span>

	<span class="o">*</span><span class="n">pOplock</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">psx_rsp</span><span class="o">-&gt;</span><span class="n">OplockFlags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">netfid</span><span class="p">)</span>
		<span class="o">*</span><span class="n">netfid</span> <span class="o">=</span> <span class="n">psx_rsp</span><span class="o">-&gt;</span><span class="n">Fid</span><span class="p">;</span>   <span class="cm">/* cifs fid stays in le */</span>
	<span class="cm">/* Let caller know file was created so we can set the mode. */</span>
	<span class="cm">/* Do we care about the CreateAction in any other cases? */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">FILE_CREATE</span><span class="p">)</span> <span class="o">==</span> <span class="n">psx_rsp</span><span class="o">-&gt;</span><span class="n">CreateAction</span><span class="p">)</span>
		<span class="o">*</span><span class="n">pOplock</span> <span class="o">|=</span> <span class="n">CIFS_CREATE_ACTION</span><span class="p">;</span>
	<span class="cm">/* check to make sure response data is there */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">psx_rsp</span><span class="o">-&gt;</span><span class="n">ReturnedLevel</span> <span class="o">!=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">SMB_QUERY_FILE_UNIX_BASIC</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pRetData</span><span class="o">-&gt;</span><span class="n">Type</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span> <span class="cm">/* unknown */</span>
		<span class="n">cFYI</span><span class="p">(</span><span class="n">DBG2</span><span class="p">,</span> <span class="s">&quot;unknown type&quot;</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">get_bcc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pSMBr</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">)</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">OPEN_PSX_RSP</span><span class="p">)</span>
					<span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">FILE_UNIX_BASIC_INFO</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">cERROR</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;Open response data too small&quot;</span><span class="p">);</span>
			<span class="n">pRetData</span><span class="o">-&gt;</span><span class="n">Type</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">psx_create_err</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">memcpy</span><span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">pRetData</span><span class="p">,</span>
			<span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">psx_rsp</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">OPEN_PSX_RSP</span><span class="p">),</span>
			<span class="k">sizeof</span><span class="p">(</span><span class="n">FILE_UNIX_BASIC_INFO</span><span class="p">));</span>
	<span class="p">}</span>

<span class="nl">psx_create_err:</span>
	<span class="n">cifs_buf_release</span><span class="p">(</span><span class="n">pSMB</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">posix_flags</span> <span class="o">&amp;</span> <span class="n">SMB_O_DIRECTORY</span><span class="p">)</span>
		<span class="n">cifs_stats_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tcon</span><span class="o">-&gt;</span><span class="n">num_posixmkdirs</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">cifs_stats_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tcon</span><span class="o">-&gt;</span><span class="n">num_posixopens</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">PsxCreat</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">__u16</span> <span class="nf">convert_disposition</span><span class="p">(</span><span class="kt">int</span> <span class="n">disposition</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">__u16</span> <span class="n">ofun</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">disposition</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">FILE_SUPERSEDE</span>:
			<span class="n">ofun</span> <span class="o">=</span> <span class="n">SMBOPEN_OCREATE</span> <span class="o">|</span> <span class="n">SMBOPEN_OTRUNC</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">FILE_OPEN</span>:
			<span class="n">ofun</span> <span class="o">=</span> <span class="n">SMBOPEN_OAPPEND</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">FILE_CREATE</span>:
			<span class="n">ofun</span> <span class="o">=</span> <span class="n">SMBOPEN_OCREATE</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">FILE_OPEN_IF</span>:
			<span class="n">ofun</span> <span class="o">=</span> <span class="n">SMBOPEN_OCREATE</span> <span class="o">|</span> <span class="n">SMBOPEN_OAPPEND</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">FILE_OVERWRITE</span>:
			<span class="n">ofun</span> <span class="o">=</span> <span class="n">SMBOPEN_OTRUNC</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">FILE_OVERWRITE_IF</span>:
			<span class="n">ofun</span> <span class="o">=</span> <span class="n">SMBOPEN_OCREATE</span> <span class="o">|</span> <span class="n">SMBOPEN_OTRUNC</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">cFYI</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;unknown disposition %d&quot;</span><span class="p">,</span> <span class="n">disposition</span><span class="p">);</span>
			<span class="n">ofun</span> <span class="o">=</span>  <span class="n">SMBOPEN_OAPPEND</span><span class="p">;</span> <span class="cm">/* regular open */</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">ofun</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">access_flags_to_smbopen_mode</span><span class="p">(</span><span class="k">const</span> <span class="kt">int</span> <span class="n">access_flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">masked_flags</span> <span class="o">=</span> <span class="n">access_flags</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">GENERIC_READ</span> <span class="o">|</span> <span class="n">GENERIC_WRITE</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">masked_flags</span> <span class="o">==</span> <span class="n">GENERIC_READ</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">SMBOPEN_READ</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">masked_flags</span> <span class="o">==</span> <span class="n">GENERIC_WRITE</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">SMBOPEN_WRITE</span><span class="p">;</span>

	<span class="cm">/* just go for read/write */</span>
	<span class="k">return</span> <span class="n">SMBOPEN_READWRITE</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="nf">SMBLegacyOpen</span><span class="p">(</span><span class="k">const</span> <span class="kt">int</span> <span class="n">xid</span><span class="p">,</span> <span class="k">struct</span> <span class="n">cifs_tcon</span> <span class="o">*</span><span class="n">tcon</span><span class="p">,</span>
	    <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">fileName</span><span class="p">,</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">openDisposition</span><span class="p">,</span>
	    <span class="k">const</span> <span class="kt">int</span> <span class="n">access_flags</span><span class="p">,</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">create_options</span><span class="p">,</span> <span class="n">__u16</span> <span class="o">*</span><span class="n">netfid</span><span class="p">,</span>
	    <span class="kt">int</span> <span class="o">*</span><span class="n">pOplock</span><span class="p">,</span> <span class="n">FILE_ALL_INFO</span> <span class="o">*</span><span class="n">pfile_info</span><span class="p">,</span>
	    <span class="k">const</span> <span class="k">struct</span> <span class="n">nls_table</span> <span class="o">*</span><span class="n">nls_codepage</span><span class="p">,</span> <span class="kt">int</span> <span class="n">remap</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EACCES</span><span class="p">;</span>
	<span class="n">OPENX_REQ</span> <span class="o">*</span><span class="n">pSMB</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">OPENX_RSP</span> <span class="o">*</span><span class="n">pSMBr</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">bytes_returned</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">name_len</span><span class="p">;</span>
	<span class="n">__u16</span> <span class="n">count</span><span class="p">;</span>

<span class="nl">OldOpenRetry:</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">smb_init</span><span class="p">(</span><span class="n">SMB_COM_OPEN_ANDX</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="n">tcon</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">**</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">pSMB</span><span class="p">,</span>
		      <span class="p">(</span><span class="kt">void</span> <span class="o">**</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">pSMBr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">AndXCommand</span> <span class="o">=</span> <span class="mh">0xFF</span><span class="p">;</span>       <span class="cm">/* none */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">Flags2</span> <span class="o">&amp;</span> <span class="n">SMBFLG2_UNICODE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">count</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>      <span class="cm">/* account for one byte pad to word boundary */</span>
		<span class="n">name_len</span> <span class="o">=</span>
		   <span class="n">cifsConvertToUTF16</span><span class="p">((</span><span class="n">__le16</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">fileName</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span>
				      <span class="n">fileName</span><span class="p">,</span> <span class="n">PATH_MAX</span><span class="p">,</span> <span class="n">nls_codepage</span><span class="p">,</span> <span class="n">remap</span><span class="p">);</span>
		<span class="n">name_len</span><span class="o">++</span><span class="p">;</span>     <span class="cm">/* trailing null */</span>
		<span class="n">name_len</span> <span class="o">*=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>                <span class="cm">/* BB improve check for buffer overruns BB */</span>
		<span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>      <span class="cm">/* no pad */</span>
		<span class="n">name_len</span> <span class="o">=</span> <span class="n">strnlen</span><span class="p">(</span><span class="n">fileName</span><span class="p">,</span> <span class="n">PATH_MAX</span><span class="p">);</span>
		<span class="n">name_len</span><span class="o">++</span><span class="p">;</span>     <span class="cm">/* trailing null */</span>
		<span class="n">strncpy</span><span class="p">(</span><span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">fileName</span><span class="p">,</span> <span class="n">fileName</span><span class="p">,</span> <span class="n">name_len</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">pOplock</span> <span class="o">&amp;</span> <span class="n">REQ_OPLOCK</span><span class="p">)</span>
		<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">OpenFlags</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">REQ_OPLOCK</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">pOplock</span> <span class="o">&amp;</span> <span class="n">REQ_BATCHOPLOCK</span><span class="p">)</span>
		<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">OpenFlags</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">REQ_BATCHOPLOCK</span><span class="p">);</span>

	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">OpenFlags</span> <span class="o">|=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">REQ_MORE_INFO</span><span class="p">);</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">Mode</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">access_flags_to_smbopen_mode</span><span class="p">(</span><span class="n">access_flags</span><span class="p">));</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">Mode</span> <span class="o">|=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="mh">0x40</span><span class="p">);</span> <span class="cm">/* deny none */</span>
	<span class="cm">/* set file as system file if special file such</span>
<span class="cm">	   as fifo and server expecting SFU style and</span>
<span class="cm">	   no Unix extensions */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">create_options</span> <span class="o">&amp;</span> <span class="n">CREATE_OPTION_SPECIAL</span><span class="p">)</span>
		<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">FileAttributes</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">ATTR_SYSTEM</span><span class="p">);</span>
	<span class="k">else</span> <span class="cm">/* BB FIXME BB */</span>
		<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">FileAttributes</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="mi">0</span><span class="cm">/*ATTR_NORMAL*/</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">create_options</span> <span class="o">&amp;</span> <span class="n">CREATE_OPTION_READONLY</span><span class="p">)</span>
		<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">FileAttributes</span> <span class="o">|=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">ATTR_READONLY</span><span class="p">);</span>

	<span class="cm">/* BB FIXME BB */</span>
<span class="cm">/*	pSMB-&gt;CreateOptions = cpu_to_le32(create_options &amp;</span>
<span class="cm">						 CREATE_OPTIONS_MASK); */</span>
	<span class="cm">/* BB FIXME END BB */</span>

	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">Sattr</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">ATTR_HIDDEN</span> <span class="o">|</span> <span class="n">ATTR_SYSTEM</span> <span class="o">|</span> <span class="n">ATTR_DIRECTORY</span><span class="p">);</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">OpenFunction</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">convert_disposition</span><span class="p">(</span><span class="n">openDisposition</span><span class="p">));</span>
	<span class="n">count</span> <span class="o">+=</span> <span class="n">name_len</span><span class="p">;</span>
	<span class="n">inc_rfc1001_len</span><span class="p">(</span><span class="n">pSMB</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>

	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">ByteCount</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">count</span><span class="p">);</span>
	<span class="cm">/* long_op set to 1 to allow for oplock break timeouts */</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">SendReceive</span><span class="p">(</span><span class="n">xid</span><span class="p">,</span> <span class="n">tcon</span><span class="o">-&gt;</span><span class="n">ses</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">smb_hdr</span> <span class="o">*</span><span class="p">)</span> <span class="n">pSMB</span><span class="p">,</span>
			<span class="p">(</span><span class="k">struct</span> <span class="n">smb_hdr</span> <span class="o">*</span><span class="p">)</span><span class="n">pSMBr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bytes_returned</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">cifs_stats_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tcon</span><span class="o">-&gt;</span><span class="n">num_opens</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cFYI</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;Error in Open = %d&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
	<span class="cm">/* BB verify if wct == 15 */</span>

<span class="cm">/*		*pOplock = pSMBr-&gt;OplockLevel; */</span> <span class="cm">/* BB take from action field*/</span>

		<span class="o">*</span><span class="n">netfid</span> <span class="o">=</span> <span class="n">pSMBr</span><span class="o">-&gt;</span><span class="n">Fid</span><span class="p">;</span>   <span class="cm">/* cifs fid stays in le */</span>
		<span class="cm">/* Let caller know file was created so we can set the mode. */</span>
		<span class="cm">/* Do we care about the CreateAction in any other cases? */</span>
	<span class="cm">/* BB FIXME BB */</span>
<span class="cm">/*		if (cpu_to_le32(FILE_CREATE) == pSMBr-&gt;CreateAction)</span>
<span class="cm">			*pOplock |= CIFS_CREATE_ACTION; */</span>
	<span class="cm">/* BB FIXME END */</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">pfile_info</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pfile_info</span><span class="o">-&gt;</span><span class="n">CreationTime</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* BB convert CreateTime*/</span>
			<span class="n">pfile_info</span><span class="o">-&gt;</span><span class="n">LastAccessTime</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* BB fixme */</span>
			<span class="n">pfile_info</span><span class="o">-&gt;</span><span class="n">LastWriteTime</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* BB fixme */</span>
			<span class="n">pfile_info</span><span class="o">-&gt;</span><span class="n">ChangeTime</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>  <span class="cm">/* BB fixme */</span>
			<span class="n">pfile_info</span><span class="o">-&gt;</span><span class="n">Attributes</span> <span class="o">=</span>
				<span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">pSMBr</span><span class="o">-&gt;</span><span class="n">FileAttributes</span><span class="p">));</span>
			<span class="cm">/* the file_info buf is endian converted by caller */</span>
			<span class="n">pfile_info</span><span class="o">-&gt;</span><span class="n">AllocationSize</span> <span class="o">=</span>
				<span class="n">cpu_to_le64</span><span class="p">(</span><span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">pSMBr</span><span class="o">-&gt;</span><span class="n">EndOfFile</span><span class="p">));</span>
			<span class="n">pfile_info</span><span class="o">-&gt;</span><span class="n">EndOfFile</span> <span class="o">=</span> <span class="n">pfile_info</span><span class="o">-&gt;</span><span class="n">AllocationSize</span><span class="p">;</span>
			<span class="n">pfile_info</span><span class="o">-&gt;</span><span class="n">NumberOfLinks</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
			<span class="n">pfile_info</span><span class="o">-&gt;</span><span class="n">DeletePending</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">cifs_buf_release</span><span class="p">(</span><span class="n">pSMB</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">OldOpenRetry</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="nf">CIFSSMBOpen</span><span class="p">(</span><span class="k">const</span> <span class="kt">int</span> <span class="n">xid</span><span class="p">,</span> <span class="k">struct</span> <span class="n">cifs_tcon</span> <span class="o">*</span><span class="n">tcon</span><span class="p">,</span>
	    <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">fileName</span><span class="p">,</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">openDisposition</span><span class="p">,</span>
	    <span class="k">const</span> <span class="kt">int</span> <span class="n">access_flags</span><span class="p">,</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">create_options</span><span class="p">,</span> <span class="n">__u16</span> <span class="o">*</span><span class="n">netfid</span><span class="p">,</span>
	    <span class="kt">int</span> <span class="o">*</span><span class="n">pOplock</span><span class="p">,</span> <span class="n">FILE_ALL_INFO</span> <span class="o">*</span><span class="n">pfile_info</span><span class="p">,</span>
	    <span class="k">const</span> <span class="k">struct</span> <span class="n">nls_table</span> <span class="o">*</span><span class="n">nls_codepage</span><span class="p">,</span> <span class="kt">int</span> <span class="n">remap</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EACCES</span><span class="p">;</span>
	<span class="n">OPEN_REQ</span> <span class="o">*</span><span class="n">pSMB</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">OPEN_RSP</span> <span class="o">*</span><span class="n">pSMBr</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">bytes_returned</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">name_len</span><span class="p">;</span>
	<span class="n">__u16</span> <span class="n">count</span><span class="p">;</span>

<span class="nl">openRetry:</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">smb_init</span><span class="p">(</span><span class="n">SMB_COM_NT_CREATE_ANDX</span><span class="p">,</span> <span class="mi">24</span><span class="p">,</span> <span class="n">tcon</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">**</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">pSMB</span><span class="p">,</span>
		      <span class="p">(</span><span class="kt">void</span> <span class="o">**</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">pSMBr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">AndXCommand</span> <span class="o">=</span> <span class="mh">0xFF</span><span class="p">;</span>	<span class="cm">/* none */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">Flags2</span> <span class="o">&amp;</span> <span class="n">SMBFLG2_UNICODE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">count</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>	<span class="cm">/* account for one byte pad to word boundary */</span>
		<span class="n">name_len</span> <span class="o">=</span>
		    <span class="n">cifsConvertToUTF16</span><span class="p">((</span><span class="n">__le16</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">fileName</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span>
				       <span class="n">fileName</span><span class="p">,</span> <span class="n">PATH_MAX</span><span class="p">,</span> <span class="n">nls_codepage</span><span class="p">,</span> <span class="n">remap</span><span class="p">);</span>
		<span class="n">name_len</span><span class="o">++</span><span class="p">;</span>	<span class="cm">/* trailing null */</span>
		<span class="n">name_len</span> <span class="o">*=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">NameLength</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">name_len</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>		<span class="cm">/* BB improve check for buffer overruns BB */</span>
		<span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* no pad */</span>
		<span class="n">name_len</span> <span class="o">=</span> <span class="n">strnlen</span><span class="p">(</span><span class="n">fileName</span><span class="p">,</span> <span class="n">PATH_MAX</span><span class="p">);</span>
		<span class="n">name_len</span><span class="o">++</span><span class="p">;</span>	<span class="cm">/* trailing null */</span>
		<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">NameLength</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">name_len</span><span class="p">);</span>
		<span class="n">strncpy</span><span class="p">(</span><span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">fileName</span><span class="p">,</span> <span class="n">fileName</span><span class="p">,</span> <span class="n">name_len</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">pOplock</span> <span class="o">&amp;</span> <span class="n">REQ_OPLOCK</span><span class="p">)</span>
		<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">OpenFlags</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">REQ_OPLOCK</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">pOplock</span> <span class="o">&amp;</span> <span class="n">REQ_BATCHOPLOCK</span><span class="p">)</span>
		<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">OpenFlags</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">REQ_BATCHOPLOCK</span><span class="p">);</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">DesiredAccess</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">access_flags</span><span class="p">);</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">AllocationSize</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="cm">/* set file as system file if special file such</span>
<span class="cm">	   as fifo and server expecting SFU style and</span>
<span class="cm">	   no Unix extensions */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">create_options</span> <span class="o">&amp;</span> <span class="n">CREATE_OPTION_SPECIAL</span><span class="p">)</span>
		<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">FileAttributes</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">ATTR_SYSTEM</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">FileAttributes</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">ATTR_NORMAL</span><span class="p">);</span>

	<span class="cm">/* XP does not handle ATTR_POSIX_SEMANTICS */</span>
	<span class="cm">/* but it helps speed up case sensitive checks for other</span>
<span class="cm">	servers such as Samba */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tcon</span><span class="o">-&gt;</span><span class="n">ses</span><span class="o">-&gt;</span><span class="n">capabilities</span> <span class="o">&amp;</span> <span class="n">CAP_UNIX</span><span class="p">)</span>
		<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">FileAttributes</span> <span class="o">|=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">ATTR_POSIX_SEMANTICS</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">create_options</span> <span class="o">&amp;</span> <span class="n">CREATE_OPTION_READONLY</span><span class="p">)</span>
		<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">FileAttributes</span> <span class="o">|=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">ATTR_READONLY</span><span class="p">);</span>

	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">ShareAccess</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">FILE_SHARE_ALL</span><span class="p">);</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">CreateDisposition</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">openDisposition</span><span class="p">);</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">CreateOptions</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">create_options</span> <span class="o">&amp;</span> <span class="n">CREATE_OPTIONS_MASK</span><span class="p">);</span>
	<span class="cm">/* BB Expirement with various impersonation levels and verify */</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">ImpersonationLevel</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">SECURITY_IMPERSONATION</span><span class="p">);</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">SecurityFlags</span> <span class="o">=</span>
	    <span class="n">SECURITY_CONTEXT_TRACKING</span> <span class="o">|</span> <span class="n">SECURITY_EFFECTIVE_ONLY</span><span class="p">;</span>

	<span class="n">count</span> <span class="o">+=</span> <span class="n">name_len</span><span class="p">;</span>
	<span class="n">inc_rfc1001_len</span><span class="p">(</span><span class="n">pSMB</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>

	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">ByteCount</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">count</span><span class="p">);</span>
	<span class="cm">/* long_op set to 1 to allow for oplock break timeouts */</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">SendReceive</span><span class="p">(</span><span class="n">xid</span><span class="p">,</span> <span class="n">tcon</span><span class="o">-&gt;</span><span class="n">ses</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">smb_hdr</span> <span class="o">*</span><span class="p">)</span> <span class="n">pSMB</span><span class="p">,</span>
			<span class="p">(</span><span class="k">struct</span> <span class="n">smb_hdr</span> <span class="o">*</span><span class="p">)</span><span class="n">pSMBr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bytes_returned</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">cifs_stats_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tcon</span><span class="o">-&gt;</span><span class="n">num_opens</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cFYI</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;Error in Open = %d&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">pOplock</span> <span class="o">=</span> <span class="n">pSMBr</span><span class="o">-&gt;</span><span class="n">OplockLevel</span><span class="p">;</span> <span class="cm">/* 1 byte no need to le_to_cpu */</span>
		<span class="o">*</span><span class="n">netfid</span> <span class="o">=</span> <span class="n">pSMBr</span><span class="o">-&gt;</span><span class="n">Fid</span><span class="p">;</span>	<span class="cm">/* cifs fid stays in le */</span>
		<span class="cm">/* Let caller know file was created so we can set the mode. */</span>
		<span class="cm">/* Do we care about the CreateAction in any other cases? */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">FILE_CREATE</span><span class="p">)</span> <span class="o">==</span> <span class="n">pSMBr</span><span class="o">-&gt;</span><span class="n">CreateAction</span><span class="p">)</span>
			<span class="o">*</span><span class="n">pOplock</span> <span class="o">|=</span> <span class="n">CIFS_CREATE_ACTION</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pfile_info</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">memcpy</span><span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">pfile_info</span><span class="p">,</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">pSMBr</span><span class="o">-&gt;</span><span class="n">CreationTime</span><span class="p">,</span>
				<span class="mi">36</span> <span class="cm">/* CreationTime to Attributes */</span><span class="p">);</span>
			<span class="cm">/* the file_info buf is endian converted by caller */</span>
			<span class="n">pfile_info</span><span class="o">-&gt;</span><span class="n">AllocationSize</span> <span class="o">=</span> <span class="n">pSMBr</span><span class="o">-&gt;</span><span class="n">AllocationSize</span><span class="p">;</span>
			<span class="n">pfile_info</span><span class="o">-&gt;</span><span class="n">EndOfFile</span> <span class="o">=</span> <span class="n">pSMBr</span><span class="o">-&gt;</span><span class="n">EndOfFile</span><span class="p">;</span>
			<span class="n">pfile_info</span><span class="o">-&gt;</span><span class="n">NumberOfLinks</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
			<span class="n">pfile_info</span><span class="o">-&gt;</span><span class="n">DeletePending</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">cifs_buf_release</span><span class="p">(</span><span class="n">pSMB</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">openRetry</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Discard any remaining data in the current SMB. To do this, we borrow the</span>
<span class="cm"> * current bigbuf.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">cifs_readv_discard</span><span class="p">(</span><span class="k">struct</span> <span class="n">TCP_Server_Info</span> <span class="o">*</span><span class="n">server</span><span class="p">,</span> <span class="k">struct</span> <span class="n">mid_q_entry</span> <span class="o">*</span><span class="n">mid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">rfclen</span> <span class="o">=</span> <span class="n">get_rfc1002_length</span><span class="p">(</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">smallbuf</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">remaining</span> <span class="o">=</span> <span class="n">rfclen</span> <span class="o">+</span> <span class="mi">4</span> <span class="o">-</span> <span class="n">server</span><span class="o">-&gt;</span><span class="n">total_read</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cifs_readdata</span> <span class="o">*</span><span class="n">rdata</span> <span class="o">=</span> <span class="n">mid</span><span class="o">-&gt;</span><span class="n">callback_data</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">remaining</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">length</span><span class="p">;</span>

		<span class="n">length</span> <span class="o">=</span> <span class="n">cifs_read_from_socket</span><span class="p">(</span><span class="n">server</span><span class="p">,</span> <span class="n">server</span><span class="o">-&gt;</span><span class="n">bigbuf</span><span class="p">,</span>
				<span class="n">min_t</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">,</span> <span class="n">remaining</span><span class="p">,</span>
				    <span class="n">CIFSMaxBufSize</span> <span class="o">+</span> <span class="n">MAX_HEADER_SIZE</span><span class="p">(</span><span class="n">server</span><span class="p">)));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">length</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">length</span><span class="p">;</span>
		<span class="n">server</span><span class="o">-&gt;</span><span class="n">total_read</span> <span class="o">+=</span> <span class="n">length</span><span class="p">;</span>
		<span class="n">remaining</span> <span class="o">-=</span> <span class="n">length</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dequeue_mid</span><span class="p">(</span><span class="n">mid</span><span class="p">,</span> <span class="n">rdata</span><span class="o">-&gt;</span><span class="n">result</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">cifs_readv_receive</span><span class="p">(</span><span class="k">struct</span> <span class="n">TCP_Server_Info</span> <span class="o">*</span><span class="n">server</span><span class="p">,</span> <span class="k">struct</span> <span class="n">mid_q_entry</span> <span class="o">*</span><span class="n">mid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">length</span><span class="p">,</span> <span class="n">len</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">data_offset</span><span class="p">,</span> <span class="n">data_len</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cifs_readdata</span> <span class="o">*</span><span class="n">rdata</span> <span class="o">=</span> <span class="n">mid</span><span class="o">-&gt;</span><span class="n">callback_data</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">buf</span> <span class="o">=</span> <span class="n">server</span><span class="o">-&gt;</span><span class="n">smallbuf</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">buflen</span> <span class="o">=</span> <span class="n">get_rfc1002_length</span><span class="p">(</span><span class="n">buf</span><span class="p">)</span> <span class="o">+</span> <span class="mi">4</span><span class="p">;</span>

	<span class="n">cFYI</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;%s: mid=%llu offset=%llu bytes=%u&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
		<span class="n">mid</span><span class="o">-&gt;</span><span class="n">mid</span><span class="p">,</span> <span class="n">rdata</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">,</span> <span class="n">rdata</span><span class="o">-&gt;</span><span class="n">bytes</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * read the rest of READ_RSP header (sans Data array), or whatever we</span>
<span class="cm">	 * can if there&#39;s not enough data. At this point, we&#39;ve read down to</span>
<span class="cm">	 * the Mid.</span>
<span class="cm">	 */</span>
	<span class="n">len</span> <span class="o">=</span> <span class="n">min_t</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">,</span> <span class="n">buflen</span><span class="p">,</span> <span class="n">server</span><span class="o">-&gt;</span><span class="n">vals</span><span class="o">-&gt;</span><span class="n">read_rsp_size</span><span class="p">)</span> <span class="o">-</span>
							<span class="n">HEADER_SIZE</span><span class="p">(</span><span class="n">server</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">rdata</span><span class="o">-&gt;</span><span class="n">iov</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">iov_base</span> <span class="o">=</span> <span class="n">buf</span> <span class="o">+</span> <span class="n">HEADER_SIZE</span><span class="p">(</span><span class="n">server</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">rdata</span><span class="o">-&gt;</span><span class="n">iov</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">iov_len</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>

	<span class="n">length</span> <span class="o">=</span> <span class="n">cifs_readv_from_socket</span><span class="p">(</span><span class="n">server</span><span class="p">,</span> <span class="n">rdata</span><span class="o">-&gt;</span><span class="n">iov</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">length</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">length</span><span class="p">;</span>
	<span class="n">server</span><span class="o">-&gt;</span><span class="n">total_read</span> <span class="o">+=</span> <span class="n">length</span><span class="p">;</span>

	<span class="cm">/* Was the SMB read successful? */</span>
	<span class="n">rdata</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="n">server</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">map_error</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rdata</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cFYI</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;%s: server returned error %d&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
			<span class="n">rdata</span><span class="o">-&gt;</span><span class="n">result</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">cifs_readv_discard</span><span class="p">(</span><span class="n">server</span><span class="p">,</span> <span class="n">mid</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Is there enough to get to the rest of the READ_RSP header? */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">total_read</span> <span class="o">&lt;</span> <span class="n">server</span><span class="o">-&gt;</span><span class="n">vals</span><span class="o">-&gt;</span><span class="n">read_rsp_size</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cFYI</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;%s: server returned short header. got=%u expected=%zu&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span> <span class="n">server</span><span class="o">-&gt;</span><span class="n">total_read</span><span class="p">,</span>
			<span class="n">server</span><span class="o">-&gt;</span><span class="n">vals</span><span class="o">-&gt;</span><span class="n">read_rsp_size</span><span class="p">);</span>
		<span class="n">rdata</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">cifs_readv_discard</span><span class="p">(</span><span class="n">server</span><span class="p">,</span> <span class="n">mid</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">data_offset</span> <span class="o">=</span> <span class="n">server</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">read_data_offset</span><span class="p">(</span><span class="n">buf</span><span class="p">)</span> <span class="o">+</span> <span class="mi">4</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">data_offset</span> <span class="o">&lt;</span> <span class="n">server</span><span class="o">-&gt;</span><span class="n">total_read</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * win2k8 sometimes sends an offset of 0 when the read</span>
<span class="cm">		 * is beyond the EOF. Treat it as if the data starts just after</span>
<span class="cm">		 * the header.</span>
<span class="cm">		 */</span>
		<span class="n">cFYI</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;%s: data offset (%u) inside read response header&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span> <span class="n">data_offset</span><span class="p">);</span>
		<span class="n">data_offset</span> <span class="o">=</span> <span class="n">server</span><span class="o">-&gt;</span><span class="n">total_read</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">data_offset</span> <span class="o">&gt;</span> <span class="n">MAX_CIFS_SMALL_BUFFER_SIZE</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* data_offset is beyond the end of smallbuf */</span>
		<span class="n">cFYI</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;%s: data offset (%u) beyond end of smallbuf&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span> <span class="n">data_offset</span><span class="p">);</span>
		<span class="n">rdata</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">cifs_readv_discard</span><span class="p">(</span><span class="n">server</span><span class="p">,</span> <span class="n">mid</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">cFYI</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;%s: total_read=%u data_offset=%u&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
		<span class="n">server</span><span class="o">-&gt;</span><span class="n">total_read</span><span class="p">,</span> <span class="n">data_offset</span><span class="p">);</span>

	<span class="n">len</span> <span class="o">=</span> <span class="n">data_offset</span> <span class="o">-</span> <span class="n">server</span><span class="o">-&gt;</span><span class="n">total_read</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* read any junk before data into the rest of smallbuf */</span>
		<span class="n">rdata</span><span class="o">-&gt;</span><span class="n">iov</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">iov_base</span> <span class="o">=</span> <span class="n">buf</span> <span class="o">+</span> <span class="n">server</span><span class="o">-&gt;</span><span class="n">total_read</span><span class="p">;</span>
		<span class="n">rdata</span><span class="o">-&gt;</span><span class="n">iov</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">iov_len</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>
		<span class="n">length</span> <span class="o">=</span> <span class="n">cifs_readv_from_socket</span><span class="p">(</span><span class="n">server</span><span class="p">,</span> <span class="n">rdata</span><span class="o">-&gt;</span><span class="n">iov</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">length</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">length</span><span class="p">;</span>
		<span class="n">server</span><span class="o">-&gt;</span><span class="n">total_read</span> <span class="o">+=</span> <span class="n">length</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* set up first iov for signature check */</span>
	<span class="n">rdata</span><span class="o">-&gt;</span><span class="n">iov</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">iov_base</span> <span class="o">=</span> <span class="n">buf</span><span class="p">;</span>
	<span class="n">rdata</span><span class="o">-&gt;</span><span class="n">iov</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">iov_len</span> <span class="o">=</span> <span class="n">server</span><span class="o">-&gt;</span><span class="n">total_read</span><span class="p">;</span>
	<span class="n">cFYI</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;0: iov_base=%p iov_len=%zu&quot;</span><span class="p">,</span>
		<span class="n">rdata</span><span class="o">-&gt;</span><span class="n">iov</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">iov_base</span><span class="p">,</span> <span class="n">rdata</span><span class="o">-&gt;</span><span class="n">iov</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">iov_len</span><span class="p">);</span>

	<span class="cm">/* how much data is in the response? */</span>
	<span class="n">data_len</span> <span class="o">=</span> <span class="n">server</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">read_data_length</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">data_offset</span> <span class="o">+</span> <span class="n">data_len</span> <span class="o">&gt;</span> <span class="n">buflen</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* data_len is corrupt -- discard frame */</span>
		<span class="n">rdata</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">cifs_readv_discard</span><span class="p">(</span><span class="n">server</span><span class="p">,</span> <span class="n">mid</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* marshal up the page array */</span>
	<span class="n">len</span> <span class="o">=</span> <span class="n">rdata</span><span class="o">-&gt;</span><span class="n">marshal_iov</span><span class="p">(</span><span class="n">rdata</span><span class="p">,</span> <span class="n">data_len</span><span class="p">);</span>
	<span class="n">data_len</span> <span class="o">-=</span> <span class="n">len</span><span class="p">;</span>

	<span class="cm">/* issue the read if we have any iovecs left to fill */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rdata</span><span class="o">-&gt;</span><span class="n">nr_iov</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">length</span> <span class="o">=</span> <span class="n">cifs_readv_from_socket</span><span class="p">(</span><span class="n">server</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rdata</span><span class="o">-&gt;</span><span class="n">iov</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
						<span class="n">rdata</span><span class="o">-&gt;</span><span class="n">nr_iov</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">length</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">length</span><span class="p">;</span>
		<span class="n">server</span><span class="o">-&gt;</span><span class="n">total_read</span> <span class="o">+=</span> <span class="n">length</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rdata</span><span class="o">-&gt;</span><span class="n">bytes</span> <span class="o">=</span> <span class="n">length</span><span class="p">;</span>

	<span class="n">cFYI</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;total_read=%u buflen=%u remaining=%u&quot;</span><span class="p">,</span> <span class="n">server</span><span class="o">-&gt;</span><span class="n">total_read</span><span class="p">,</span>
		<span class="n">buflen</span><span class="p">,</span> <span class="n">data_len</span><span class="p">);</span>

	<span class="cm">/* discard anything left over */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">total_read</span> <span class="o">&lt;</span> <span class="n">buflen</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">cifs_readv_discard</span><span class="p">(</span><span class="n">server</span><span class="p">,</span> <span class="n">mid</span><span class="p">);</span>

	<span class="n">dequeue_mid</span><span class="p">(</span><span class="n">mid</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">length</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">cifs_readv_callback</span><span class="p">(</span><span class="k">struct</span> <span class="n">mid_q_entry</span> <span class="o">*</span><span class="n">mid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cifs_readdata</span> <span class="o">*</span><span class="n">rdata</span> <span class="o">=</span> <span class="n">mid</span><span class="o">-&gt;</span><span class="n">callback_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cifs_tcon</span> <span class="o">*</span><span class="n">tcon</span> <span class="o">=</span> <span class="n">tlink_tcon</span><span class="p">(</span><span class="n">rdata</span><span class="o">-&gt;</span><span class="n">cfile</span><span class="o">-&gt;</span><span class="n">tlink</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">TCP_Server_Info</span> <span class="o">*</span><span class="n">server</span> <span class="o">=</span> <span class="n">tcon</span><span class="o">-&gt;</span><span class="n">ses</span><span class="o">-&gt;</span><span class="n">server</span><span class="p">;</span>

	<span class="n">cFYI</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;%s: mid=%llu state=%d result=%d bytes=%u&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
		<span class="n">mid</span><span class="o">-&gt;</span><span class="n">mid</span><span class="p">,</span> <span class="n">mid</span><span class="o">-&gt;</span><span class="n">mid_state</span><span class="p">,</span> <span class="n">rdata</span><span class="o">-&gt;</span><span class="n">result</span><span class="p">,</span> <span class="n">rdata</span><span class="o">-&gt;</span><span class="n">bytes</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">mid</span><span class="o">-&gt;</span><span class="n">mid_state</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">MID_RESPONSE_RECEIVED</span>:
		<span class="cm">/* result already set, check signature */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">sec_mode</span> <span class="o">&amp;</span>
		    <span class="p">(</span><span class="n">SECMODE_SIGN_REQUIRED</span> <span class="o">|</span> <span class="n">SECMODE_SIGN_ENABLED</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">cifs_verify_signature</span><span class="p">(</span><span class="n">rdata</span><span class="o">-&gt;</span><span class="n">iov</span><span class="p">,</span> <span class="n">rdata</span><span class="o">-&gt;</span><span class="n">nr_iov</span><span class="p">,</span>
					  <span class="n">server</span><span class="p">,</span> <span class="n">mid</span><span class="o">-&gt;</span><span class="n">sequence_number</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
				<span class="n">cERROR</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;Unexpected SMB signature&quot;</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="cm">/* FIXME: should this be counted toward the initiating task? */</span>
		<span class="n">task_io_account_read</span><span class="p">(</span><span class="n">rdata</span><span class="o">-&gt;</span><span class="n">bytes</span><span class="p">);</span>
		<span class="n">cifs_stats_bytes_read</span><span class="p">(</span><span class="n">tcon</span><span class="p">,</span> <span class="n">rdata</span><span class="o">-&gt;</span><span class="n">bytes</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MID_REQUEST_SUBMITTED</span>:
	<span class="k">case</span> <span class="n">MID_RETRY_NEEDED</span>:
		<span class="n">rdata</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">rdata</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">queue_work</span><span class="p">(</span><span class="n">cifsiod_wq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rdata</span><span class="o">-&gt;</span><span class="n">work</span><span class="p">);</span>
	<span class="n">DeleteMidQEntry</span><span class="p">(</span><span class="n">mid</span><span class="p">);</span>
	<span class="n">add_credits</span><span class="p">(</span><span class="n">server</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* cifs_async_readv - send an async write, and set up mid to handle result */</span>
<span class="kt">int</span>
<span class="nf">cifs_async_readv</span><span class="p">(</span><span class="k">struct</span> <span class="n">cifs_readdata</span> <span class="o">*</span><span class="n">rdata</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>
	<span class="n">READ_REQ</span> <span class="o">*</span><span class="n">smb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">wct</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cifs_tcon</span> <span class="o">*</span><span class="n">tcon</span> <span class="o">=</span> <span class="n">tlink_tcon</span><span class="p">(</span><span class="n">rdata</span><span class="o">-&gt;</span><span class="n">cfile</span><span class="o">-&gt;</span><span class="n">tlink</span><span class="p">);</span>

	<span class="n">cFYI</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;%s: offset=%llu bytes=%u&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
		<span class="n">rdata</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">,</span> <span class="n">rdata</span><span class="o">-&gt;</span><span class="n">bytes</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tcon</span><span class="o">-&gt;</span><span class="n">ses</span><span class="o">-&gt;</span><span class="n">capabilities</span> <span class="o">&amp;</span> <span class="n">CAP_LARGE_FILES</span><span class="p">)</span>
		<span class="n">wct</span> <span class="o">=</span> <span class="mi">12</span><span class="p">;</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">wct</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span> <span class="cm">/* old style read */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">rdata</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>  <span class="p">{</span>
			<span class="cm">/* can not handle this big offset for old */</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">small_smb_init</span><span class="p">(</span><span class="n">SMB_COM_READ_ANDX</span><span class="p">,</span> <span class="n">wct</span><span class="p">,</span> <span class="n">tcon</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">**</span><span class="p">)</span><span class="o">&amp;</span><span class="n">smb</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">smb</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">Pid</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">((</span><span class="n">__u16</span><span class="p">)</span><span class="n">rdata</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">);</span>
	<span class="n">smb</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">PidHigh</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">((</span><span class="n">__u16</span><span class="p">)(</span><span class="n">rdata</span><span class="o">-&gt;</span><span class="n">pid</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">));</span>

	<span class="n">smb</span><span class="o">-&gt;</span><span class="n">AndXCommand</span> <span class="o">=</span> <span class="mh">0xFF</span><span class="p">;</span>	<span class="cm">/* none */</span>
	<span class="n">smb</span><span class="o">-&gt;</span><span class="n">Fid</span> <span class="o">=</span> <span class="n">rdata</span><span class="o">-&gt;</span><span class="n">cfile</span><span class="o">-&gt;</span><span class="n">netfid</span><span class="p">;</span>
	<span class="n">smb</span><span class="o">-&gt;</span><span class="n">OffsetLow</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">rdata</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">&amp;</span> <span class="mh">0xFFFFFFFF</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wct</span> <span class="o">==</span> <span class="mi">12</span><span class="p">)</span>
		<span class="n">smb</span><span class="o">-&gt;</span><span class="n">OffsetHigh</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">rdata</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">);</span>
	<span class="n">smb</span><span class="o">-&gt;</span><span class="n">Remaining</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">smb</span><span class="o">-&gt;</span><span class="n">MaxCount</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">rdata</span><span class="o">-&gt;</span><span class="n">bytes</span> <span class="o">&amp;</span> <span class="mh">0xFFFF</span><span class="p">);</span>
	<span class="n">smb</span><span class="o">-&gt;</span><span class="n">MaxCountHigh</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">rdata</span><span class="o">-&gt;</span><span class="n">bytes</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wct</span> <span class="o">==</span> <span class="mi">12</span><span class="p">)</span>
		<span class="n">smb</span><span class="o">-&gt;</span><span class="n">ByteCount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* old style read */</span>
		<span class="k">struct</span> <span class="n">smb_com_readx_req</span> <span class="o">*</span><span class="n">smbr</span> <span class="o">=</span>
			<span class="p">(</span><span class="k">struct</span> <span class="n">smb_com_readx_req</span> <span class="o">*</span><span class="p">)</span><span class="n">smb</span><span class="p">;</span>
		<span class="n">smbr</span><span class="o">-&gt;</span><span class="n">ByteCount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* 4 for RFC1001 length + 1 for BCC */</span>
	<span class="n">rdata</span><span class="o">-&gt;</span><span class="n">iov</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">iov_base</span> <span class="o">=</span> <span class="n">smb</span><span class="p">;</span>
	<span class="n">rdata</span><span class="o">-&gt;</span><span class="n">iov</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">iov_len</span> <span class="o">=</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">smb</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">smb_buf_length</span><span class="p">)</span> <span class="o">+</span> <span class="mi">4</span><span class="p">;</span>

	<span class="n">kref_get</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdata</span><span class="o">-&gt;</span><span class="n">refcount</span><span class="p">);</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">cifs_call_async</span><span class="p">(</span><span class="n">tcon</span><span class="o">-&gt;</span><span class="n">ses</span><span class="o">-&gt;</span><span class="n">server</span><span class="p">,</span> <span class="n">rdata</span><span class="o">-&gt;</span><span class="n">iov</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
			     <span class="n">cifs_readv_receive</span><span class="p">,</span> <span class="n">cifs_readv_callback</span><span class="p">,</span>
			     <span class="n">rdata</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">cifs_stats_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tcon</span><span class="o">-&gt;</span><span class="n">num_reads</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">kref_put</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdata</span><span class="o">-&gt;</span><span class="n">refcount</span><span class="p">,</span> <span class="n">cifs_readdata_release</span><span class="p">);</span>

	<span class="n">cifs_small_buf_release</span><span class="p">(</span><span class="n">smb</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="nf">CIFSSMBRead</span><span class="p">(</span><span class="k">const</span> <span class="kt">int</span> <span class="n">xid</span><span class="p">,</span> <span class="k">struct</span> <span class="n">cifs_io_parms</span> <span class="o">*</span><span class="n">io_parms</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">nbytes</span><span class="p">,</span>
	    <span class="kt">char</span> <span class="o">**</span><span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">pbuf_type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EACCES</span><span class="p">;</span>
	<span class="n">READ_REQ</span> <span class="o">*</span><span class="n">pSMB</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">READ_RSP</span> <span class="o">*</span><span class="n">pSMBr</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">pReadData</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">wct</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">resp_buf_type</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">kvec</span> <span class="n">iov</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="n">__u32</span> <span class="n">pid</span> <span class="o">=</span> <span class="n">io_parms</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">;</span>
	<span class="n">__u16</span> <span class="n">netfid</span> <span class="o">=</span> <span class="n">io_parms</span><span class="o">-&gt;</span><span class="n">netfid</span><span class="p">;</span>
	<span class="n">__u64</span> <span class="n">offset</span> <span class="o">=</span> <span class="n">io_parms</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cifs_tcon</span> <span class="o">*</span><span class="n">tcon</span> <span class="o">=</span> <span class="n">io_parms</span><span class="o">-&gt;</span><span class="n">tcon</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">count</span> <span class="o">=</span> <span class="n">io_parms</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">;</span>

	<span class="n">cFYI</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;Reading %d bytes on fid %d&quot;</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">netfid</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tcon</span><span class="o">-&gt;</span><span class="n">ses</span><span class="o">-&gt;</span><span class="n">capabilities</span> <span class="o">&amp;</span> <span class="n">CAP_LARGE_FILES</span><span class="p">)</span>
		<span class="n">wct</span> <span class="o">=</span> <span class="mi">12</span><span class="p">;</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">wct</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span> <span class="cm">/* old style read */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">offset</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>  <span class="p">{</span>
			<span class="cm">/* can not handle this big offset for old */</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="o">*</span><span class="n">nbytes</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">small_smb_init</span><span class="p">(</span><span class="n">SMB_COM_READ_ANDX</span><span class="p">,</span> <span class="n">wct</span><span class="p">,</span> <span class="n">tcon</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">**</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">pSMB</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">Pid</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">((</span><span class="n">__u16</span><span class="p">)</span><span class="n">pid</span><span class="p">);</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">PidHigh</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">((</span><span class="n">__u16</span><span class="p">)(</span><span class="n">pid</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">));</span>

	<span class="cm">/* tcon and ses pointer are checked in smb_init */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tcon</span><span class="o">-&gt;</span><span class="n">ses</span><span class="o">-&gt;</span><span class="n">server</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ECONNABORTED</span><span class="p">;</span>

	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">AndXCommand</span> <span class="o">=</span> <span class="mh">0xFF</span><span class="p">;</span>       <span class="cm">/* none */</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">Fid</span> <span class="o">=</span> <span class="n">netfid</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">OffsetLow</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">offset</span> <span class="o">&amp;</span> <span class="mh">0xFFFFFFFF</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wct</span> <span class="o">==</span> <span class="mi">12</span><span class="p">)</span>
		<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">OffsetHigh</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">offset</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">);</span>

	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">Remaining</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">MaxCount</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">count</span> <span class="o">&amp;</span> <span class="mh">0xFFFF</span><span class="p">);</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">MaxCountHigh</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">count</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wct</span> <span class="o">==</span> <span class="mi">12</span><span class="p">)</span>
		<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">ByteCount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>  <span class="cm">/* no need to do le conversion since 0 */</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* old style read */</span>
		<span class="k">struct</span> <span class="n">smb_com_readx_req</span> <span class="o">*</span><span class="n">pSMBW</span> <span class="o">=</span>
			<span class="p">(</span><span class="k">struct</span> <span class="n">smb_com_readx_req</span> <span class="o">*</span><span class="p">)</span><span class="n">pSMB</span><span class="p">;</span>
		<span class="n">pSMBW</span><span class="o">-&gt;</span><span class="n">ByteCount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">iov</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">iov_base</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">pSMB</span><span class="p">;</span>
	<span class="n">iov</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">iov_len</span> <span class="o">=</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">smb_buf_length</span><span class="p">)</span> <span class="o">+</span> <span class="mi">4</span><span class="p">;</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">SendReceive2</span><span class="p">(</span><span class="n">xid</span><span class="p">,</span> <span class="n">tcon</span><span class="o">-&gt;</span><span class="n">ses</span><span class="p">,</span> <span class="n">iov</span><span class="p">,</span> <span class="mi">1</span> <span class="cm">/* num iovecs */</span><span class="p">,</span>
			 <span class="o">&amp;</span><span class="n">resp_buf_type</span><span class="p">,</span> <span class="n">CIFS_LOG_ERROR</span><span class="p">);</span>
	<span class="n">cifs_stats_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tcon</span><span class="o">-&gt;</span><span class="n">num_reads</span><span class="p">);</span>
	<span class="n">pSMBr</span> <span class="o">=</span> <span class="p">(</span><span class="n">READ_RSP</span> <span class="o">*</span><span class="p">)</span><span class="n">iov</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">iov_base</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cERROR</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;Send error in read = %d&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">data_length</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">pSMBr</span><span class="o">-&gt;</span><span class="n">DataLengthHigh</span><span class="p">);</span>
		<span class="n">data_length</span> <span class="o">=</span> <span class="n">data_length</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
		<span class="n">data_length</span> <span class="o">+=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">pSMBr</span><span class="o">-&gt;</span><span class="n">DataLength</span><span class="p">);</span>
		<span class="o">*</span><span class="n">nbytes</span> <span class="o">=</span> <span class="n">data_length</span><span class="p">;</span>

		<span class="cm">/*check that DataLength would not go beyond end of SMB */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">data_length</span> <span class="o">&gt;</span> <span class="n">CIFSMaxBufSize</span><span class="p">)</span>
				<span class="o">||</span> <span class="p">(</span><span class="n">data_length</span> <span class="o">&gt;</span> <span class="n">count</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">cFYI</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;bad length %d for count %d&quot;</span><span class="p">,</span>
				 <span class="n">data_length</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
			<span class="o">*</span><span class="n">nbytes</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">pReadData</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">pSMBr</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">Protocol</span><span class="p">)</span> <span class="o">+</span>
					<span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">pSMBr</span><span class="o">-&gt;</span><span class="n">DataOffset</span><span class="p">);</span>
<span class="cm">/*			if (rc = copy_to_user(buf, pReadData, data_length)) {</span>
<span class="cm">				cERROR(1, &quot;Faulting on read rc = %d&quot;,rc);</span>
<span class="cm">				rc = -EFAULT;</span>
<span class="cm">			}*/</span> <span class="cm">/* can not use copy_to_user when using page cache*/</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">buf</span><span class="p">)</span>
				<span class="n">memcpy</span><span class="p">(</span><span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="n">pReadData</span><span class="p">,</span> <span class="n">data_length</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

<span class="cm">/*	cifs_small_buf_release(pSMB); */</span> <span class="cm">/* Freed earlier now in SendReceive2 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">buf</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">resp_buf_type</span> <span class="o">==</span> <span class="n">CIFS_SMALL_BUFFER</span><span class="p">)</span>
			<span class="n">cifs_small_buf_release</span><span class="p">(</span><span class="n">iov</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">iov_base</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">resp_buf_type</span> <span class="o">==</span> <span class="n">CIFS_LARGE_BUFFER</span><span class="p">)</span>
			<span class="n">cifs_buf_release</span><span class="p">(</span><span class="n">iov</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">iov_base</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">resp_buf_type</span> <span class="o">!=</span> <span class="n">CIFS_NO_BUFFER</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* return buffer to caller to free */</span>
		<span class="o">*</span><span class="n">buf</span> <span class="o">=</span> <span class="n">iov</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">iov_base</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">resp_buf_type</span> <span class="o">==</span> <span class="n">CIFS_SMALL_BUFFER</span><span class="p">)</span>
			<span class="o">*</span><span class="n">pbuf_type</span> <span class="o">=</span> <span class="n">CIFS_SMALL_BUFFER</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">resp_buf_type</span> <span class="o">==</span> <span class="n">CIFS_LARGE_BUFFER</span><span class="p">)</span>
			<span class="o">*</span><span class="n">pbuf_type</span> <span class="o">=</span> <span class="n">CIFS_LARGE_BUFFER</span><span class="p">;</span>
	<span class="p">}</span> <span class="cm">/* else no valid buffer on return - leave as null */</span>

	<span class="cm">/* Note: On -EAGAIN error only caller can retry on handle based calls</span>
<span class="cm">		since file handle passed in no longer valid */</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>


<span class="kt">int</span>
<span class="nf">CIFSSMBWrite</span><span class="p">(</span><span class="k">const</span> <span class="kt">int</span> <span class="n">xid</span><span class="p">,</span> <span class="k">struct</span> <span class="n">cifs_io_parms</span> <span class="o">*</span><span class="n">io_parms</span><span class="p">,</span>
	     <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">nbytes</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span>
	     <span class="k">const</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">ubuf</span><span class="p">,</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">long_op</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EACCES</span><span class="p">;</span>
	<span class="n">WRITE_REQ</span> <span class="o">*</span><span class="n">pSMB</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">WRITE_RSP</span> <span class="o">*</span><span class="n">pSMBr</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">bytes_returned</span><span class="p">,</span> <span class="n">wct</span><span class="p">;</span>
	<span class="n">__u32</span> <span class="n">bytes_sent</span><span class="p">;</span>
	<span class="n">__u16</span> <span class="n">byte_count</span><span class="p">;</span>
	<span class="n">__u32</span> <span class="n">pid</span> <span class="o">=</span> <span class="n">io_parms</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">;</span>
	<span class="n">__u16</span> <span class="n">netfid</span> <span class="o">=</span> <span class="n">io_parms</span><span class="o">-&gt;</span><span class="n">netfid</span><span class="p">;</span>
	<span class="n">__u64</span> <span class="n">offset</span> <span class="o">=</span> <span class="n">io_parms</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cifs_tcon</span> <span class="o">*</span><span class="n">tcon</span> <span class="o">=</span> <span class="n">io_parms</span><span class="o">-&gt;</span><span class="n">tcon</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">count</span> <span class="o">=</span> <span class="n">io_parms</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">;</span>

	<span class="o">*</span><span class="n">nbytes</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* cFYI(1, &quot;write at %lld %d bytes&quot;, offset, count);*/</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tcon</span><span class="o">-&gt;</span><span class="n">ses</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ECONNABORTED</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tcon</span><span class="o">-&gt;</span><span class="n">ses</span><span class="o">-&gt;</span><span class="n">capabilities</span> <span class="o">&amp;</span> <span class="n">CAP_LARGE_FILES</span><span class="p">)</span>
		<span class="n">wct</span> <span class="o">=</span> <span class="mi">14</span><span class="p">;</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">wct</span> <span class="o">=</span> <span class="mi">12</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">offset</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* can not handle big offset for old srv */</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">smb_init</span><span class="p">(</span><span class="n">SMB_COM_WRITE_ANDX</span><span class="p">,</span> <span class="n">wct</span><span class="p">,</span> <span class="n">tcon</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">**</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">pSMB</span><span class="p">,</span>
		      <span class="p">(</span><span class="kt">void</span> <span class="o">**</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">pSMBr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">Pid</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">((</span><span class="n">__u16</span><span class="p">)</span><span class="n">pid</span><span class="p">);</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">PidHigh</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">((</span><span class="n">__u16</span><span class="p">)(</span><span class="n">pid</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">));</span>

	<span class="cm">/* tcon and ses pointer are checked in smb_init */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tcon</span><span class="o">-&gt;</span><span class="n">ses</span><span class="o">-&gt;</span><span class="n">server</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ECONNABORTED</span><span class="p">;</span>

	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">AndXCommand</span> <span class="o">=</span> <span class="mh">0xFF</span><span class="p">;</span>	<span class="cm">/* none */</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">Fid</span> <span class="o">=</span> <span class="n">netfid</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">OffsetLow</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">offset</span> <span class="o">&amp;</span> <span class="mh">0xFFFFFFFF</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wct</span> <span class="o">==</span> <span class="mi">14</span><span class="p">)</span>
		<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">OffsetHigh</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">offset</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">);</span>

	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">Reserved</span> <span class="o">=</span> <span class="mh">0xFFFFFFFF</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">WriteMode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">Remaining</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Can increase buffer size if buffer is big enough in some cases ie we</span>
<span class="cm">	can send more if LARGE_WRITE_X capability returned by the server and if</span>
<span class="cm">	our buffer is big enough or if we convert to iovecs on socket writes</span>
<span class="cm">	and eliminate the copy to the CIFS buffer */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tcon</span><span class="o">-&gt;</span><span class="n">ses</span><span class="o">-&gt;</span><span class="n">capabilities</span> <span class="o">&amp;</span> <span class="n">CAP_LARGE_WRITE_X</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bytes_sent</span> <span class="o">=</span> <span class="n">min_t</span><span class="p">(</span><span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">int</span><span class="p">,</span> <span class="n">CIFSMaxBufSize</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">bytes_sent</span> <span class="o">=</span> <span class="p">(</span><span class="n">tcon</span><span class="o">-&gt;</span><span class="n">ses</span><span class="o">-&gt;</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">maxBuf</span> <span class="o">-</span> <span class="n">MAX_CIFS_HDR_SIZE</span><span class="p">)</span>
			 <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0xFF</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bytes_sent</span> <span class="o">&gt;</span> <span class="n">count</span><span class="p">)</span>
		<span class="n">bytes_sent</span> <span class="o">=</span> <span class="n">count</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">DataOffset</span> <span class="o">=</span>
		<span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">smb_com_write_req</span><span class="p">,</span> <span class="n">Data</span><span class="p">)</span> <span class="o">-</span> <span class="mi">4</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">buf</span><span class="p">)</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">Data</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">bytes_sent</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ubuf</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">Data</span><span class="p">,</span> <span class="n">ubuf</span><span class="p">,</span> <span class="n">bytes_sent</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">cifs_buf_release</span><span class="p">(</span><span class="n">pSMB</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* No buffer */</span>
		<span class="n">cifs_buf_release</span><span class="p">(</span><span class="n">pSMB</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span> <span class="cm">/* else setting file size with write of zero bytes */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wct</span> <span class="o">==</span> <span class="mi">14</span><span class="p">)</span>
		<span class="n">byte_count</span> <span class="o">=</span> <span class="n">bytes_sent</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span> <span class="cm">/* pad */</span>
	<span class="k">else</span> <span class="cm">/* wct == 12 */</span>
		<span class="n">byte_count</span> <span class="o">=</span> <span class="n">bytes_sent</span> <span class="o">+</span> <span class="mi">5</span><span class="p">;</span> <span class="cm">/* bigger pad, smaller smb hdr */</span>

	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">DataLengthLow</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">bytes_sent</span> <span class="o">&amp;</span> <span class="mh">0xFFFF</span><span class="p">);</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">DataLengthHigh</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">bytes_sent</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">);</span>
	<span class="n">inc_rfc1001_len</span><span class="p">(</span><span class="n">pSMB</span><span class="p">,</span> <span class="n">byte_count</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">wct</span> <span class="o">==</span> <span class="mi">14</span><span class="p">)</span>
		<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">ByteCount</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">byte_count</span><span class="p">);</span>
	<span class="k">else</span> <span class="p">{</span> <span class="cm">/* old style write has byte count 4 bytes earlier</span>
<span class="cm">		  so 4 bytes pad  */</span>
		<span class="k">struct</span> <span class="n">smb_com_writex_req</span> <span class="o">*</span><span class="n">pSMBW</span> <span class="o">=</span>
			<span class="p">(</span><span class="k">struct</span> <span class="n">smb_com_writex_req</span> <span class="o">*</span><span class="p">)</span><span class="n">pSMB</span><span class="p">;</span>
		<span class="n">pSMBW</span><span class="o">-&gt;</span><span class="n">ByteCount</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">byte_count</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">SendReceive</span><span class="p">(</span><span class="n">xid</span><span class="p">,</span> <span class="n">tcon</span><span class="o">-&gt;</span><span class="n">ses</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">smb_hdr</span> <span class="o">*</span><span class="p">)</span> <span class="n">pSMB</span><span class="p">,</span>
			 <span class="p">(</span><span class="k">struct</span> <span class="n">smb_hdr</span> <span class="o">*</span><span class="p">)</span> <span class="n">pSMBr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bytes_returned</span><span class="p">,</span> <span class="n">long_op</span><span class="p">);</span>
	<span class="n">cifs_stats_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tcon</span><span class="o">-&gt;</span><span class="n">num_writes</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cFYI</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;Send error in write = %d&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">nbytes</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">pSMBr</span><span class="o">-&gt;</span><span class="n">CountHigh</span><span class="p">);</span>
		<span class="o">*</span><span class="n">nbytes</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="n">nbytes</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
		<span class="o">*</span><span class="n">nbytes</span> <span class="o">+=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">pSMBr</span><span class="o">-&gt;</span><span class="n">Count</span><span class="p">);</span>

		<span class="cm">/*</span>
<span class="cm">		 * Mask off high 16 bits when bytes written as returned by the</span>
<span class="cm">		 * server is greater than bytes requested by the client. Some</span>
<span class="cm">		 * OS/2 servers are known to set incorrect CountHigh values.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">nbytes</span> <span class="o">&gt;</span> <span class="n">count</span><span class="p">)</span>
			<span class="o">*</span><span class="n">nbytes</span> <span class="o">&amp;=</span> <span class="mh">0xFFFF</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">cifs_buf_release</span><span class="p">(</span><span class="n">pSMB</span><span class="p">);</span>

	<span class="cm">/* Note: On -EAGAIN error only caller can retry on handle based calls</span>
<span class="cm">		since file handle passed in no longer valid */</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">cifs_writedata_release</span><span class="p">(</span><span class="k">struct</span> <span class="n">kref</span> <span class="o">*</span><span class="n">refcount</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cifs_writedata</span> <span class="o">*</span><span class="n">wdata</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">refcount</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">cifs_writedata</span><span class="p">,</span> <span class="n">refcount</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">wdata</span><span class="o">-&gt;</span><span class="n">cfile</span><span class="p">)</span>
		<span class="n">cifsFileInfo_put</span><span class="p">(</span><span class="n">wdata</span><span class="o">-&gt;</span><span class="n">cfile</span><span class="p">);</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">wdata</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Write failed with a retryable error. Resend the write request. It&#39;s also</span>
<span class="cm"> * possible that the page was redirtied so re-clean the page.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">cifs_writev_requeue</span><span class="p">(</span><span class="k">struct</span> <span class="n">cifs_writedata</span> <span class="o">*</span><span class="n">wdata</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">rc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span> <span class="o">=</span> <span class="n">wdata</span><span class="o">-&gt;</span><span class="n">cfile</span><span class="o">-&gt;</span><span class="n">dentry</span><span class="o">-&gt;</span><span class="n">d_inode</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">wdata</span><span class="o">-&gt;</span><span class="n">nr_pages</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">lock_page</span><span class="p">(</span><span class="n">wdata</span><span class="o">-&gt;</span><span class="n">pages</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="n">clear_page_dirty_for_io</span><span class="p">(</span><span class="n">wdata</span><span class="o">-&gt;</span><span class="n">pages</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="p">}</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">cifs_async_writev</span><span class="p">(</span><span class="n">wdata</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">wdata</span><span class="o">-&gt;</span><span class="n">nr_pages</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">SetPageError</span><span class="p">(</span><span class="n">wdata</span><span class="o">-&gt;</span><span class="n">pages</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="n">unlock_page</span><span class="p">(</span><span class="n">wdata</span><span class="o">-&gt;</span><span class="n">pages</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="p">}</span>

	<span class="n">mapping_set_error</span><span class="p">(</span><span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_mapping</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
	<span class="n">kref_put</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wdata</span><span class="o">-&gt;</span><span class="n">refcount</span><span class="p">,</span> <span class="n">cifs_writedata_release</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">cifs_writev_complete</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cifs_writedata</span> <span class="o">*</span><span class="n">wdata</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span>
						<span class="k">struct</span> <span class="n">cifs_writedata</span><span class="p">,</span> <span class="n">work</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span> <span class="o">=</span> <span class="n">wdata</span><span class="o">-&gt;</span><span class="n">cfile</span><span class="o">-&gt;</span><span class="n">dentry</span><span class="o">-&gt;</span><span class="n">d_inode</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">wdata</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_lock</span><span class="p">);</span>
		<span class="n">cifs_update_eof</span><span class="p">(</span><span class="n">CIFS_I</span><span class="p">(</span><span class="n">inode</span><span class="p">),</span> <span class="n">wdata</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">,</span> <span class="n">wdata</span><span class="o">-&gt;</span><span class="n">bytes</span><span class="p">);</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_lock</span><span class="p">);</span>
		<span class="n">cifs_stats_bytes_written</span><span class="p">(</span><span class="n">tlink_tcon</span><span class="p">(</span><span class="n">wdata</span><span class="o">-&gt;</span><span class="n">cfile</span><span class="o">-&gt;</span><span class="n">tlink</span><span class="p">),</span>
					 <span class="n">wdata</span><span class="o">-&gt;</span><span class="n">bytes</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">wdata</span><span class="o">-&gt;</span><span class="n">sync_mode</span> <span class="o">==</span> <span class="n">WB_SYNC_ALL</span> <span class="o">&amp;&amp;</span> <span class="n">wdata</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">==</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">cifs_writev_requeue</span><span class="p">(</span><span class="n">wdata</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">wdata</span><span class="o">-&gt;</span><span class="n">nr_pages</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="n">page</span> <span class="o">=</span> <span class="n">wdata</span><span class="o">-&gt;</span><span class="n">pages</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">wdata</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">==</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">)</span>
			<span class="n">__set_page_dirty_nobuffers</span><span class="p">(</span><span class="n">page</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">wdata</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">SetPageError</span><span class="p">(</span><span class="n">page</span><span class="p">);</span>
		<span class="n">end_page_writeback</span><span class="p">(</span><span class="n">page</span><span class="p">);</span>
		<span class="n">page_cache_release</span><span class="p">(</span><span class="n">page</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wdata</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">!=</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">)</span>
		<span class="n">mapping_set_error</span><span class="p">(</span><span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_mapping</span><span class="p">,</span> <span class="n">wdata</span><span class="o">-&gt;</span><span class="n">result</span><span class="p">);</span>
	<span class="n">kref_put</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wdata</span><span class="o">-&gt;</span><span class="n">refcount</span><span class="p">,</span> <span class="n">cifs_writedata_release</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">cifs_writedata</span> <span class="o">*</span>
<span class="nf">cifs_writedata_alloc</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">nr_pages</span><span class="p">,</span> <span class="n">work_func_t</span> <span class="n">complete</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cifs_writedata</span> <span class="o">*</span><span class="n">wdata</span><span class="p">;</span>

	<span class="cm">/* this would overflow */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nr_pages</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cERROR</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;%s: called with nr_pages == 0!&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* writedata + number of page pointers */</span>
	<span class="n">wdata</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">wdata</span><span class="p">)</span> <span class="o">+</span>
			<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">nr_pages</span> <span class="o">-</span> <span class="mi">1</span><span class="p">),</span> <span class="n">GFP_NOFS</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wdata</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kref_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wdata</span><span class="o">-&gt;</span><span class="n">refcount</span><span class="p">);</span>
		<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wdata</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
		<span class="n">init_completion</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wdata</span><span class="o">-&gt;</span><span class="n">done</span><span class="p">);</span>
		<span class="n">INIT_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wdata</span><span class="o">-&gt;</span><span class="n">work</span><span class="p">,</span> <span class="n">complete</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">wdata</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Check the mid_state and signature on received buffer (if any), and queue the</span>
<span class="cm"> * workqueue completion task.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">cifs_writev_callback</span><span class="p">(</span><span class="k">struct</span> <span class="n">mid_q_entry</span> <span class="o">*</span><span class="n">mid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cifs_writedata</span> <span class="o">*</span><span class="n">wdata</span> <span class="o">=</span> <span class="n">mid</span><span class="o">-&gt;</span><span class="n">callback_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cifs_tcon</span> <span class="o">*</span><span class="n">tcon</span> <span class="o">=</span> <span class="n">tlink_tcon</span><span class="p">(</span><span class="n">wdata</span><span class="o">-&gt;</span><span class="n">cfile</span><span class="o">-&gt;</span><span class="n">tlink</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">written</span><span class="p">;</span>
	<span class="n">WRITE_RSP</span> <span class="o">*</span><span class="n">smb</span> <span class="o">=</span> <span class="p">(</span><span class="n">WRITE_RSP</span> <span class="o">*</span><span class="p">)</span><span class="n">mid</span><span class="o">-&gt;</span><span class="n">resp_buf</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">mid</span><span class="o">-&gt;</span><span class="n">mid_state</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">MID_RESPONSE_RECEIVED</span>:
		<span class="n">wdata</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="n">cifs_check_receive</span><span class="p">(</span><span class="n">mid</span><span class="p">,</span> <span class="n">tcon</span><span class="o">-&gt;</span><span class="n">ses</span><span class="o">-&gt;</span><span class="n">server</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">wdata</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">written</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">smb</span><span class="o">-&gt;</span><span class="n">CountHigh</span><span class="p">);</span>
		<span class="n">written</span> <span class="o">&lt;&lt;=</span> <span class="mi">16</span><span class="p">;</span>
		<span class="n">written</span> <span class="o">+=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">smb</span><span class="o">-&gt;</span><span class="n">Count</span><span class="p">);</span>
		<span class="cm">/*</span>
<span class="cm">		 * Mask off high 16 bits when bytes written as returned</span>
<span class="cm">		 * by the server is greater than bytes requested by the</span>
<span class="cm">		 * client. OS/2 servers are known to set incorrect</span>
<span class="cm">		 * CountHigh values.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">written</span> <span class="o">&gt;</span> <span class="n">wdata</span><span class="o">-&gt;</span><span class="n">bytes</span><span class="p">)</span>
			<span class="n">written</span> <span class="o">&amp;=</span> <span class="mh">0xFFFF</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">written</span> <span class="o">&lt;</span> <span class="n">wdata</span><span class="o">-&gt;</span><span class="n">bytes</span><span class="p">)</span>
			<span class="n">wdata</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOSPC</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">wdata</span><span class="o">-&gt;</span><span class="n">bytes</span> <span class="o">=</span> <span class="n">written</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MID_REQUEST_SUBMITTED</span>:
	<span class="k">case</span> <span class="n">MID_RETRY_NEEDED</span>:
		<span class="n">wdata</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">wdata</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">queue_work</span><span class="p">(</span><span class="n">cifsiod_wq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wdata</span><span class="o">-&gt;</span><span class="n">work</span><span class="p">);</span>
	<span class="n">DeleteMidQEntry</span><span class="p">(</span><span class="n">mid</span><span class="p">);</span>
	<span class="n">add_credits</span><span class="p">(</span><span class="n">tcon</span><span class="o">-&gt;</span><span class="n">ses</span><span class="o">-&gt;</span><span class="n">server</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* cifs_async_writev - send an async write, and set up mid to handle result */</span>
<span class="kt">int</span>
<span class="nf">cifs_async_writev</span><span class="p">(</span><span class="k">struct</span> <span class="n">cifs_writedata</span> <span class="o">*</span><span class="n">wdata</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EACCES</span><span class="p">;</span>
	<span class="n">WRITE_REQ</span> <span class="o">*</span><span class="n">smb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">wct</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cifs_tcon</span> <span class="o">*</span><span class="n">tcon</span> <span class="o">=</span> <span class="n">tlink_tcon</span><span class="p">(</span><span class="n">wdata</span><span class="o">-&gt;</span><span class="n">cfile</span><span class="o">-&gt;</span><span class="n">tlink</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">kvec</span> <span class="o">*</span><span class="n">iov</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tcon</span><span class="o">-&gt;</span><span class="n">ses</span><span class="o">-&gt;</span><span class="n">capabilities</span> <span class="o">&amp;</span> <span class="n">CAP_LARGE_FILES</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wct</span> <span class="o">=</span> <span class="mi">14</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">wct</span> <span class="o">=</span> <span class="mi">12</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">wdata</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* can not handle big offset for old srv */</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">small_smb_init</span><span class="p">(</span><span class="n">SMB_COM_WRITE_ANDX</span><span class="p">,</span> <span class="n">wct</span><span class="p">,</span> <span class="n">tcon</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">**</span><span class="p">)</span><span class="o">&amp;</span><span class="n">smb</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">async_writev_out</span><span class="p">;</span>

	<span class="cm">/* 1 iov per page + 1 for header */</span>
	<span class="n">iov</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">((</span><span class="n">wdata</span><span class="o">-&gt;</span><span class="n">nr_pages</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">iov</span><span class="p">),</span> <span class="n">GFP_NOFS</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">iov</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">async_writev_out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">smb</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">Pid</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">((</span><span class="n">__u16</span><span class="p">)</span><span class="n">wdata</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">);</span>
	<span class="n">smb</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">PidHigh</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">((</span><span class="n">__u16</span><span class="p">)(</span><span class="n">wdata</span><span class="o">-&gt;</span><span class="n">pid</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">));</span>

	<span class="n">smb</span><span class="o">-&gt;</span><span class="n">AndXCommand</span> <span class="o">=</span> <span class="mh">0xFF</span><span class="p">;</span>	<span class="cm">/* none */</span>
	<span class="n">smb</span><span class="o">-&gt;</span><span class="n">Fid</span> <span class="o">=</span> <span class="n">wdata</span><span class="o">-&gt;</span><span class="n">cfile</span><span class="o">-&gt;</span><span class="n">netfid</span><span class="p">;</span>
	<span class="n">smb</span><span class="o">-&gt;</span><span class="n">OffsetLow</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">wdata</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">&amp;</span> <span class="mh">0xFFFFFFFF</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wct</span> <span class="o">==</span> <span class="mi">14</span><span class="p">)</span>
		<span class="n">smb</span><span class="o">-&gt;</span><span class="n">OffsetHigh</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">wdata</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">);</span>
	<span class="n">smb</span><span class="o">-&gt;</span><span class="n">Reserved</span> <span class="o">=</span> <span class="mh">0xFFFFFFFF</span><span class="p">;</span>
	<span class="n">smb</span><span class="o">-&gt;</span><span class="n">WriteMode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">smb</span><span class="o">-&gt;</span><span class="n">Remaining</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">smb</span><span class="o">-&gt;</span><span class="n">DataOffset</span> <span class="o">=</span>
	    <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">smb_com_write_req</span><span class="p">,</span> <span class="n">Data</span><span class="p">)</span> <span class="o">-</span> <span class="mi">4</span><span class="p">);</span>

	<span class="cm">/* 4 for RFC1001 length + 1 for BCC */</span>
	<span class="n">iov</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">iov_len</span> <span class="o">=</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">smb</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">smb_buf_length</span><span class="p">)</span> <span class="o">+</span> <span class="mi">4</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">iov</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">iov_base</span> <span class="o">=</span> <span class="n">smb</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * This function should marshal up the page array into the kvec</span>
<span class="cm">	 * array, reserving [0] for the header. It should kmap the pages</span>
<span class="cm">	 * and set the iov_len properly for each one. It may also set</span>
<span class="cm">	 * wdata-&gt;bytes too.</span>
<span class="cm">	 */</span>
	<span class="n">wdata</span><span class="o">-&gt;</span><span class="n">marshal_iov</span><span class="p">(</span><span class="n">iov</span><span class="p">,</span> <span class="n">wdata</span><span class="p">);</span>

	<span class="n">cFYI</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;async write at %llu %u bytes&quot;</span><span class="p">,</span> <span class="n">wdata</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">,</span> <span class="n">wdata</span><span class="o">-&gt;</span><span class="n">bytes</span><span class="p">);</span>

	<span class="n">smb</span><span class="o">-&gt;</span><span class="n">DataLengthLow</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">wdata</span><span class="o">-&gt;</span><span class="n">bytes</span> <span class="o">&amp;</span> <span class="mh">0xFFFF</span><span class="p">);</span>
	<span class="n">smb</span><span class="o">-&gt;</span><span class="n">DataLengthHigh</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">wdata</span><span class="o">-&gt;</span><span class="n">bytes</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">wct</span> <span class="o">==</span> <span class="mi">14</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">inc_rfc1001_len</span><span class="p">(</span><span class="o">&amp;</span><span class="n">smb</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">,</span> <span class="n">wdata</span><span class="o">-&gt;</span><span class="n">bytes</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">put_bcc</span><span class="p">(</span><span class="n">wdata</span><span class="o">-&gt;</span><span class="n">bytes</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">smb</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* wct == 12 */</span>
		<span class="k">struct</span> <span class="n">smb_com_writex_req</span> <span class="o">*</span><span class="n">smbw</span> <span class="o">=</span>
				<span class="p">(</span><span class="k">struct</span> <span class="n">smb_com_writex_req</span> <span class="o">*</span><span class="p">)</span><span class="n">smb</span><span class="p">;</span>
		<span class="n">inc_rfc1001_len</span><span class="p">(</span><span class="o">&amp;</span><span class="n">smbw</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">,</span> <span class="n">wdata</span><span class="o">-&gt;</span><span class="n">bytes</span> <span class="o">+</span> <span class="mi">5</span><span class="p">);</span>
		<span class="n">put_bcc</span><span class="p">(</span><span class="n">wdata</span><span class="o">-&gt;</span><span class="n">bytes</span> <span class="o">+</span> <span class="mi">5</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">smbw</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">);</span>
		<span class="n">iov</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">iov_len</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span> <span class="cm">/* pad bigger by four bytes */</span>
	<span class="p">}</span>

	<span class="n">kref_get</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wdata</span><span class="o">-&gt;</span><span class="n">refcount</span><span class="p">);</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">cifs_call_async</span><span class="p">(</span><span class="n">tcon</span><span class="o">-&gt;</span><span class="n">ses</span><span class="o">-&gt;</span><span class="n">server</span><span class="p">,</span> <span class="n">iov</span><span class="p">,</span> <span class="n">wdata</span><span class="o">-&gt;</span><span class="n">nr_pages</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
			     <span class="nb">NULL</span><span class="p">,</span> <span class="n">cifs_writev_callback</span><span class="p">,</span> <span class="n">wdata</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">cifs_stats_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tcon</span><span class="o">-&gt;</span><span class="n">num_writes</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">kref_put</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wdata</span><span class="o">-&gt;</span><span class="n">refcount</span><span class="p">,</span> <span class="n">cifs_writedata_release</span><span class="p">);</span>

	<span class="cm">/* send is done, unmap pages */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">wdata</span><span class="o">-&gt;</span><span class="n">nr_pages</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">kunmap</span><span class="p">(</span><span class="n">wdata</span><span class="o">-&gt;</span><span class="n">pages</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

<span class="nl">async_writev_out:</span>
	<span class="n">cifs_small_buf_release</span><span class="p">(</span><span class="n">smb</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">iov</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="nf">CIFSSMBWrite2</span><span class="p">(</span><span class="k">const</span> <span class="kt">int</span> <span class="n">xid</span><span class="p">,</span> <span class="k">struct</span> <span class="n">cifs_io_parms</span> <span class="o">*</span><span class="n">io_parms</span><span class="p">,</span>
	      <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">nbytes</span><span class="p">,</span> <span class="k">struct</span> <span class="n">kvec</span> <span class="o">*</span><span class="n">iov</span><span class="p">,</span> <span class="kt">int</span> <span class="n">n_vec</span><span class="p">,</span>
	      <span class="k">const</span> <span class="kt">int</span> <span class="n">long_op</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EACCES</span><span class="p">;</span>
	<span class="n">WRITE_REQ</span> <span class="o">*</span><span class="n">pSMB</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">wct</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">smb_hdr_len</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">resp_buf_type</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">__u32</span> <span class="n">pid</span> <span class="o">=</span> <span class="n">io_parms</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">;</span>
	<span class="n">__u16</span> <span class="n">netfid</span> <span class="o">=</span> <span class="n">io_parms</span><span class="o">-&gt;</span><span class="n">netfid</span><span class="p">;</span>
	<span class="n">__u64</span> <span class="n">offset</span> <span class="o">=</span> <span class="n">io_parms</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cifs_tcon</span> <span class="o">*</span><span class="n">tcon</span> <span class="o">=</span> <span class="n">io_parms</span><span class="o">-&gt;</span><span class="n">tcon</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">count</span> <span class="o">=</span> <span class="n">io_parms</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">;</span>

	<span class="o">*</span><span class="n">nbytes</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">cFYI</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;write2 at %lld %d bytes&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">offset</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tcon</span><span class="o">-&gt;</span><span class="n">ses</span><span class="o">-&gt;</span><span class="n">capabilities</span> <span class="o">&amp;</span> <span class="n">CAP_LARGE_FILES</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wct</span> <span class="o">=</span> <span class="mi">14</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">wct</span> <span class="o">=</span> <span class="mi">12</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">offset</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* can not handle big offset for old srv */</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">small_smb_init</span><span class="p">(</span><span class="n">SMB_COM_WRITE_ANDX</span><span class="p">,</span> <span class="n">wct</span><span class="p">,</span> <span class="n">tcon</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">**</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">pSMB</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">Pid</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">((</span><span class="n">__u16</span><span class="p">)</span><span class="n">pid</span><span class="p">);</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">PidHigh</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">((</span><span class="n">__u16</span><span class="p">)(</span><span class="n">pid</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">));</span>

	<span class="cm">/* tcon and ses pointer are checked in smb_init */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tcon</span><span class="o">-&gt;</span><span class="n">ses</span><span class="o">-&gt;</span><span class="n">server</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ECONNABORTED</span><span class="p">;</span>

	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">AndXCommand</span> <span class="o">=</span> <span class="mh">0xFF</span><span class="p">;</span>	<span class="cm">/* none */</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">Fid</span> <span class="o">=</span> <span class="n">netfid</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">OffsetLow</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">offset</span> <span class="o">&amp;</span> <span class="mh">0xFFFFFFFF</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wct</span> <span class="o">==</span> <span class="mi">14</span><span class="p">)</span>
		<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">OffsetHigh</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">offset</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">);</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">Reserved</span> <span class="o">=</span> <span class="mh">0xFFFFFFFF</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">WriteMode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">Remaining</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">DataOffset</span> <span class="o">=</span>
	    <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">smb_com_write_req</span><span class="p">,</span> <span class="n">Data</span><span class="p">)</span> <span class="o">-</span> <span class="mi">4</span><span class="p">);</span>

	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">DataLengthLow</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">count</span> <span class="o">&amp;</span> <span class="mh">0xFFFF</span><span class="p">);</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">DataLengthHigh</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">count</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">);</span>
	<span class="cm">/* header + 1 byte pad */</span>
	<span class="n">smb_hdr_len</span> <span class="o">=</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">smb_buf_length</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wct</span> <span class="o">==</span> <span class="mi">14</span><span class="p">)</span>
		<span class="n">inc_rfc1001_len</span><span class="p">(</span><span class="n">pSMB</span><span class="p">,</span> <span class="n">count</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">else</span> <span class="cm">/* wct == 12 */</span>
		<span class="n">inc_rfc1001_len</span><span class="p">(</span><span class="n">pSMB</span><span class="p">,</span> <span class="n">count</span> <span class="o">+</span> <span class="mi">5</span><span class="p">);</span> <span class="cm">/* smb data starts later */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wct</span> <span class="o">==</span> <span class="mi">14</span><span class="p">)</span>
		<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">ByteCount</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">count</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">else</span> <span class="cm">/* wct == 12 */</span> <span class="cm">/* bigger pad, smaller smb hdr, keep offset ok */</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">smb_com_writex_req</span> <span class="o">*</span><span class="n">pSMBW</span> <span class="o">=</span>
				<span class="p">(</span><span class="k">struct</span> <span class="n">smb_com_writex_req</span> <span class="o">*</span><span class="p">)</span><span class="n">pSMB</span><span class="p">;</span>
		<span class="n">pSMBW</span><span class="o">-&gt;</span><span class="n">ByteCount</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">count</span> <span class="o">+</span> <span class="mi">5</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">iov</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">iov_base</span> <span class="o">=</span> <span class="n">pSMB</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wct</span> <span class="o">==</span> <span class="mi">14</span><span class="p">)</span>
		<span class="n">iov</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">iov_len</span> <span class="o">=</span> <span class="n">smb_hdr_len</span> <span class="o">+</span> <span class="mi">4</span><span class="p">;</span>
	<span class="k">else</span> <span class="cm">/* wct == 12 pad bigger by four bytes */</span>
		<span class="n">iov</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">iov_len</span> <span class="o">=</span> <span class="n">smb_hdr_len</span> <span class="o">+</span> <span class="mi">8</span><span class="p">;</span>


	<span class="n">rc</span> <span class="o">=</span> <span class="n">SendReceive2</span><span class="p">(</span><span class="n">xid</span><span class="p">,</span> <span class="n">tcon</span><span class="o">-&gt;</span><span class="n">ses</span><span class="p">,</span> <span class="n">iov</span><span class="p">,</span> <span class="n">n_vec</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">resp_buf_type</span><span class="p">,</span>
			  <span class="n">long_op</span><span class="p">);</span>
	<span class="n">cifs_stats_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tcon</span><span class="o">-&gt;</span><span class="n">num_writes</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cFYI</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;Send error Write2 = %d&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">resp_buf_type</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* presumably this can not happen, but best to be safe */</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">WRITE_RSP</span> <span class="o">*</span><span class="n">pSMBr</span> <span class="o">=</span> <span class="p">(</span><span class="n">WRITE_RSP</span> <span class="o">*</span><span class="p">)</span><span class="n">iov</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">iov_base</span><span class="p">;</span>
		<span class="o">*</span><span class="n">nbytes</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">pSMBr</span><span class="o">-&gt;</span><span class="n">CountHigh</span><span class="p">);</span>
		<span class="o">*</span><span class="n">nbytes</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="n">nbytes</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
		<span class="o">*</span><span class="n">nbytes</span> <span class="o">+=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">pSMBr</span><span class="o">-&gt;</span><span class="n">Count</span><span class="p">);</span>

		<span class="cm">/*</span>
<span class="cm">		 * Mask off high 16 bits when bytes written as returned by the</span>
<span class="cm">		 * server is greater than bytes requested by the client. OS/2</span>
<span class="cm">		 * servers are known to set incorrect CountHigh values.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">nbytes</span> <span class="o">&gt;</span> <span class="n">count</span><span class="p">)</span>
			<span class="o">*</span><span class="n">nbytes</span> <span class="o">&amp;=</span> <span class="mh">0xFFFF</span><span class="p">;</span>
	<span class="p">}</span>

<span class="cm">/*	cifs_small_buf_release(pSMB); */</span> <span class="cm">/* Freed earlier now in SendReceive2 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">resp_buf_type</span> <span class="o">==</span> <span class="n">CIFS_SMALL_BUFFER</span><span class="p">)</span>
		<span class="n">cifs_small_buf_release</span><span class="p">(</span><span class="n">iov</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">iov_base</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">resp_buf_type</span> <span class="o">==</span> <span class="n">CIFS_LARGE_BUFFER</span><span class="p">)</span>
		<span class="n">cifs_buf_release</span><span class="p">(</span><span class="n">iov</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">iov_base</span><span class="p">);</span>

	<span class="cm">/* Note: On -EAGAIN error only caller can retry on handle based calls</span>
<span class="cm">		since file handle passed in no longer valid */</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">cifs_lockv</span><span class="p">(</span><span class="k">const</span> <span class="kt">int</span> <span class="n">xid</span><span class="p">,</span> <span class="k">struct</span> <span class="n">cifs_tcon</span> <span class="o">*</span><span class="n">tcon</span><span class="p">,</span> <span class="k">const</span> <span class="n">__u16</span> <span class="n">netfid</span><span class="p">,</span>
	       <span class="k">const</span> <span class="n">__u8</span> <span class="n">lock_type</span><span class="p">,</span> <span class="k">const</span> <span class="n">__u32</span> <span class="n">num_unlock</span><span class="p">,</span>
	       <span class="k">const</span> <span class="n">__u32</span> <span class="n">num_lock</span><span class="p">,</span> <span class="n">LOCKING_ANDX_RANGE</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">LOCK_REQ</span> <span class="o">*</span><span class="n">pSMB</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">kvec</span> <span class="n">iov</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">resp_buf_type</span><span class="p">;</span>
	<span class="n">__u16</span> <span class="n">count</span><span class="p">;</span>

	<span class="n">cFYI</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;cifs_lockv num lock %d num unlock %d&quot;</span><span class="p">,</span> <span class="n">num_lock</span><span class="p">,</span> <span class="n">num_unlock</span><span class="p">);</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">small_smb_init</span><span class="p">(</span><span class="n">SMB_COM_LOCKING_ANDX</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="n">tcon</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">**</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">pSMB</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">Timeout</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">NumberOfLocks</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">num_lock</span><span class="p">);</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">NumberOfUnlocks</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">num_unlock</span><span class="p">);</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">LockType</span> <span class="o">=</span> <span class="n">lock_type</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">AndXCommand</span> <span class="o">=</span> <span class="mh">0xFF</span><span class="p">;</span> <span class="cm">/* none */</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">Fid</span> <span class="o">=</span> <span class="n">netfid</span><span class="p">;</span> <span class="cm">/* netfid stays le */</span>

	<span class="n">count</span> <span class="o">=</span> <span class="p">(</span><span class="n">num_unlock</span> <span class="o">+</span> <span class="n">num_lock</span><span class="p">)</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">LOCKING_ANDX_RANGE</span><span class="p">);</span>
	<span class="n">inc_rfc1001_len</span><span class="p">(</span><span class="n">pSMB</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">ByteCount</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">count</span><span class="p">);</span>

	<span class="n">iov</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">iov_base</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">pSMB</span><span class="p">;</span>
	<span class="n">iov</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">iov_len</span> <span class="o">=</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">smb_buf_length</span><span class="p">)</span> <span class="o">+</span> <span class="mi">4</span> <span class="o">-</span>
			 <span class="p">(</span><span class="n">num_unlock</span> <span class="o">+</span> <span class="n">num_lock</span><span class="p">)</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">LOCKING_ANDX_RANGE</span><span class="p">);</span>
	<span class="n">iov</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">iov_base</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">buf</span><span class="p">;</span>
	<span class="n">iov</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">iov_len</span> <span class="o">=</span> <span class="p">(</span><span class="n">num_unlock</span> <span class="o">+</span> <span class="n">num_lock</span><span class="p">)</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">LOCKING_ANDX_RANGE</span><span class="p">);</span>

	<span class="n">cifs_stats_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tcon</span><span class="o">-&gt;</span><span class="n">num_locks</span><span class="p">);</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">SendReceive2</span><span class="p">(</span><span class="n">xid</span><span class="p">,</span> <span class="n">tcon</span><span class="o">-&gt;</span><span class="n">ses</span><span class="p">,</span> <span class="n">iov</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">resp_buf_type</span><span class="p">,</span> <span class="n">CIFS_NO_RESP</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="n">cFYI</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;Send error in cifs_lockv = %d&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="nf">CIFSSMBLock</span><span class="p">(</span><span class="k">const</span> <span class="kt">int</span> <span class="n">xid</span><span class="p">,</span> <span class="k">struct</span> <span class="n">cifs_tcon</span> <span class="o">*</span><span class="n">tcon</span><span class="p">,</span>
	    <span class="k">const</span> <span class="n">__u16</span> <span class="n">smb_file_id</span><span class="p">,</span> <span class="k">const</span> <span class="n">__u32</span> <span class="n">netpid</span><span class="p">,</span> <span class="k">const</span> <span class="n">__u64</span> <span class="n">len</span><span class="p">,</span>
	    <span class="k">const</span> <span class="n">__u64</span> <span class="n">offset</span><span class="p">,</span> <span class="k">const</span> <span class="n">__u32</span> <span class="n">numUnlock</span><span class="p">,</span>
	    <span class="k">const</span> <span class="n">__u32</span> <span class="n">numLock</span><span class="p">,</span> <span class="k">const</span> <span class="n">__u8</span> <span class="n">lockType</span><span class="p">,</span>
	    <span class="k">const</span> <span class="n">bool</span> <span class="n">waitFlag</span><span class="p">,</span> <span class="k">const</span> <span class="n">__u8</span> <span class="n">oplock_level</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">LOCK_REQ</span> <span class="o">*</span><span class="n">pSMB</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="cm">/*	LOCK_RSP *pSMBr = NULL; */</span> <span class="cm">/* No response data other than rc to parse */</span>
	<span class="kt">int</span> <span class="n">bytes_returned</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">timeout</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">__u16</span> <span class="n">count</span><span class="p">;</span>

	<span class="n">cFYI</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;CIFSSMBLock timeout %d numLock %d&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">waitFlag</span><span class="p">,</span> <span class="n">numLock</span><span class="p">);</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">small_smb_init</span><span class="p">(</span><span class="n">SMB_COM_LOCKING_ANDX</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="n">tcon</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">**</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">pSMB</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">lockType</span> <span class="o">==</span> <span class="n">LOCKING_ANDX_OPLOCK_RELEASE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">timeout</span> <span class="o">=</span> <span class="n">CIFS_ASYNC_OP</span><span class="p">;</span> <span class="cm">/* no response expected */</span>
		<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">Timeout</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">waitFlag</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">timeout</span> <span class="o">=</span> <span class="n">CIFS_BLOCKING_OP</span><span class="p">;</span> <span class="cm">/* blocking operation, no timeout */</span>
		<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">Timeout</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span><span class="cm">/* blocking - do not time out */</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">Timeout</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">NumberOfLocks</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">numLock</span><span class="p">);</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">NumberOfUnlocks</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">numUnlock</span><span class="p">);</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">LockType</span> <span class="o">=</span> <span class="n">lockType</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">OplockLevel</span> <span class="o">=</span> <span class="n">oplock_level</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">AndXCommand</span> <span class="o">=</span> <span class="mh">0xFF</span><span class="p">;</span>	<span class="cm">/* none */</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">Fid</span> <span class="o">=</span> <span class="n">smb_file_id</span><span class="p">;</span> <span class="cm">/* netfid stays le */</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">numLock</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">numUnlock</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">Locks</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">Pid</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">netpid</span><span class="p">);</span>
		<span class="cm">/* BB where to store pid high? */</span>
		<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">Locks</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">LengthLow</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">((</span><span class="n">u32</span><span class="p">)</span><span class="n">len</span><span class="p">);</span>
		<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">Locks</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">LengthHigh</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">((</span><span class="n">u32</span><span class="p">)(</span><span class="n">len</span><span class="o">&gt;&gt;</span><span class="mi">32</span><span class="p">));</span>
		<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">Locks</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">OffsetLow</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">((</span><span class="n">u32</span><span class="p">)</span><span class="n">offset</span><span class="p">);</span>
		<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">Locks</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">OffsetHigh</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">((</span><span class="n">u32</span><span class="p">)(</span><span class="n">offset</span><span class="o">&gt;&gt;</span><span class="mi">32</span><span class="p">));</span>
		<span class="n">count</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">LOCKING_ANDX_RANGE</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* oplock break */</span>
		<span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">inc_rfc1001_len</span><span class="p">(</span><span class="n">pSMB</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">ByteCount</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">count</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">waitFlag</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">SendReceiveBlockingLock</span><span class="p">(</span><span class="n">xid</span><span class="p">,</span> <span class="n">tcon</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">smb_hdr</span> <span class="o">*</span><span class="p">)</span> <span class="n">pSMB</span><span class="p">,</span>
			<span class="p">(</span><span class="k">struct</span> <span class="n">smb_hdr</span> <span class="o">*</span><span class="p">)</span> <span class="n">pSMB</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bytes_returned</span><span class="p">);</span>
		<span class="n">cifs_small_buf_release</span><span class="p">(</span><span class="n">pSMB</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">SendReceiveNoRsp</span><span class="p">(</span><span class="n">xid</span><span class="p">,</span> <span class="n">tcon</span><span class="o">-&gt;</span><span class="n">ses</span><span class="p">,</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">pSMB</span><span class="p">,</span> <span class="n">timeout</span><span class="p">);</span>
		<span class="cm">/* SMB buffer freed by function above */</span>
	<span class="p">}</span>
	<span class="n">cifs_stats_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tcon</span><span class="o">-&gt;</span><span class="n">num_locks</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="n">cFYI</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;Send error in Lock = %d&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>

	<span class="cm">/* Note: On -EAGAIN error only caller can retry on handle based calls</span>
<span class="cm">	since file handle passed in no longer valid */</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="nf">CIFSSMBPosixLock</span><span class="p">(</span><span class="k">const</span> <span class="kt">int</span> <span class="n">xid</span><span class="p">,</span> <span class="k">struct</span> <span class="n">cifs_tcon</span> <span class="o">*</span><span class="n">tcon</span><span class="p">,</span>
		<span class="k">const</span> <span class="n">__u16</span> <span class="n">smb_file_id</span><span class="p">,</span> <span class="k">const</span> <span class="n">__u32</span> <span class="n">netpid</span><span class="p">,</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">get_flag</span><span class="p">,</span>
		<span class="k">const</span> <span class="n">__u64</span> <span class="n">len</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file_lock</span> <span class="o">*</span><span class="n">pLockData</span><span class="p">,</span>
		<span class="k">const</span> <span class="n">__u16</span> <span class="n">lock_type</span><span class="p">,</span> <span class="k">const</span> <span class="n">bool</span> <span class="n">waitFlag</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">smb_com_transaction2_sfi_req</span> <span class="o">*</span><span class="n">pSMB</span>  <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">smb_com_transaction2_sfi_rsp</span> <span class="o">*</span><span class="n">pSMBr</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cifs_posix_lock</span> <span class="o">*</span><span class="n">parm_data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">timeout</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">bytes_returned</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">resp_buf_type</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">__u16</span> <span class="n">params</span><span class="p">,</span> <span class="n">param_offset</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">byte_count</span><span class="p">,</span> <span class="n">count</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">kvec</span> <span class="n">iov</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>

	<span class="n">cFYI</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;Posix Lock&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pLockData</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">small_smb_init</span><span class="p">(</span><span class="n">SMB_COM_TRANSACTION2</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="n">tcon</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">**</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">pSMB</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">pSMBr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">smb_com_transaction2_sfi_rsp</span> <span class="o">*</span><span class="p">)</span><span class="n">pSMB</span><span class="p">;</span>

	<span class="n">params</span> <span class="o">=</span> <span class="mi">6</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">MaxSetupCount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">Reserved</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">Flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">Reserved2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">param_offset</span> <span class="o">=</span> <span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">smb_com_transaction2_sfi_req</span><span class="p">,</span> <span class="n">Fid</span><span class="p">)</span> <span class="o">-</span> <span class="mi">4</span><span class="p">;</span>
	<span class="n">offset</span> <span class="o">=</span> <span class="n">param_offset</span> <span class="o">+</span> <span class="n">params</span><span class="p">;</span>

	<span class="n">count</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">cifs_posix_lock</span><span class="p">);</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">MaxParameterCount</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">MaxDataCount</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="mi">1000</span><span class="p">);</span> <span class="cm">/* BB find max SMB from sess */</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">SetupCount</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">Reserved3</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">get_flag</span><span class="p">)</span>
		<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">SubCommand</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">TRANS2_QUERY_FILE_INFORMATION</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">SubCommand</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">TRANS2_SET_FILE_INFORMATION</span><span class="p">);</span>
	<span class="n">byte_count</span> <span class="o">=</span> <span class="mi">3</span> <span class="cm">/* pad */</span>  <span class="o">+</span> <span class="n">params</span> <span class="o">+</span> <span class="n">count</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">DataCount</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">count</span><span class="p">);</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">ParameterCount</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">params</span><span class="p">);</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">TotalDataCount</span> <span class="o">=</span> <span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">DataCount</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">TotalParameterCount</span> <span class="o">=</span> <span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">ParameterCount</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">ParameterOffset</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">param_offset</span><span class="p">);</span>
	<span class="n">parm_data</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">cifs_posix_lock</span> <span class="o">*</span><span class="p">)</span>
			<span class="p">(((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">Protocol</span><span class="p">)</span> <span class="o">+</span> <span class="n">offset</span><span class="p">);</span>

	<span class="n">parm_data</span><span class="o">-&gt;</span><span class="n">lock_type</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">lock_type</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">waitFlag</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">timeout</span> <span class="o">=</span> <span class="n">CIFS_BLOCKING_OP</span><span class="p">;</span> <span class="cm">/* blocking operation, no timeout */</span>
		<span class="n">parm_data</span><span class="o">-&gt;</span><span class="n">lock_flags</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">Timeout</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">Timeout</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">parm_data</span><span class="o">-&gt;</span><span class="n">pid</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">netpid</span><span class="p">);</span>
	<span class="n">parm_data</span><span class="o">-&gt;</span><span class="n">start</span> <span class="o">=</span> <span class="n">cpu_to_le64</span><span class="p">(</span><span class="n">pLockData</span><span class="o">-&gt;</span><span class="n">fl_start</span><span class="p">);</span>
	<span class="n">parm_data</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">=</span> <span class="n">cpu_to_le64</span><span class="p">(</span><span class="n">len</span><span class="p">);</span>  <span class="cm">/* normalize negative numbers */</span>

	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">DataOffset</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">offset</span><span class="p">);</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">Fid</span> <span class="o">=</span> <span class="n">smb_file_id</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">InformationLevel</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">SMB_SET_POSIX_LOCK</span><span class="p">);</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">Reserved4</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">inc_rfc1001_len</span><span class="p">(</span><span class="n">pSMB</span><span class="p">,</span> <span class="n">byte_count</span><span class="p">);</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">ByteCount</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">byte_count</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">waitFlag</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">SendReceiveBlockingLock</span><span class="p">(</span><span class="n">xid</span><span class="p">,</span> <span class="n">tcon</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">smb_hdr</span> <span class="o">*</span><span class="p">)</span> <span class="n">pSMB</span><span class="p">,</span>
			<span class="p">(</span><span class="k">struct</span> <span class="n">smb_hdr</span> <span class="o">*</span><span class="p">)</span> <span class="n">pSMBr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bytes_returned</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">iov</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">iov_base</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">pSMB</span><span class="p">;</span>
		<span class="n">iov</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">iov_len</span> <span class="o">=</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">smb_buf_length</span><span class="p">)</span> <span class="o">+</span> <span class="mi">4</span><span class="p">;</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">SendReceive2</span><span class="p">(</span><span class="n">xid</span><span class="p">,</span> <span class="n">tcon</span><span class="o">-&gt;</span><span class="n">ses</span><span class="p">,</span> <span class="n">iov</span><span class="p">,</span> <span class="mi">1</span> <span class="cm">/* num iovecs */</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="n">resp_buf_type</span><span class="p">,</span> <span class="n">timeout</span><span class="p">);</span>
		<span class="n">pSMB</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span> <span class="cm">/* request buf already freed by SendReceive2. Do</span>
<span class="cm">				not try to free it twice below on exit */</span>
		<span class="n">pSMBr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">smb_com_transaction2_sfi_rsp</span> <span class="o">*</span><span class="p">)</span><span class="n">iov</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">iov_base</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cFYI</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;Send error in Posix Lock = %d&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">get_flag</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* lock structure can be returned on get */</span>
		<span class="n">__u16</span> <span class="n">data_offset</span><span class="p">;</span>
		<span class="n">__u16</span> <span class="n">data_count</span><span class="p">;</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">validate_t2</span><span class="p">((</span><span class="k">struct</span> <span class="n">smb_t2_rsp</span> <span class="o">*</span><span class="p">)</span><span class="n">pSMBr</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">||</span> <span class="n">get_bcc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pSMBr</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">)</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">parm_data</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>      <span class="cm">/* bad smb */</span>
			<span class="k">goto</span> <span class="n">plk_err_exit</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">data_offset</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">pSMBr</span><span class="o">-&gt;</span><span class="n">t2</span><span class="p">.</span><span class="n">DataOffset</span><span class="p">);</span>
		<span class="n">data_count</span>  <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">pSMBr</span><span class="o">-&gt;</span><span class="n">t2</span><span class="p">.</span><span class="n">DataCount</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">data_count</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">cifs_posix_lock</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">plk_err_exit</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">parm_data</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">cifs_posix_lock</span> <span class="o">*</span><span class="p">)</span>
			<span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">pSMBr</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">Protocol</span> <span class="o">+</span> <span class="n">data_offset</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">parm_data</span><span class="o">-&gt;</span><span class="n">lock_type</span> <span class="o">==</span> <span class="n">__constant_cpu_to_le16</span><span class="p">(</span><span class="n">CIFS_UNLCK</span><span class="p">))</span>
			<span class="n">pLockData</span><span class="o">-&gt;</span><span class="n">fl_type</span> <span class="o">=</span> <span class="n">F_UNLCK</span><span class="p">;</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">parm_data</span><span class="o">-&gt;</span><span class="n">lock_type</span> <span class="o">==</span>
					<span class="n">__constant_cpu_to_le16</span><span class="p">(</span><span class="n">CIFS_RDLCK</span><span class="p">))</span>
				<span class="n">pLockData</span><span class="o">-&gt;</span><span class="n">fl_type</span> <span class="o">=</span> <span class="n">F_RDLCK</span><span class="p">;</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">parm_data</span><span class="o">-&gt;</span><span class="n">lock_type</span> <span class="o">==</span>
					<span class="n">__constant_cpu_to_le16</span><span class="p">(</span><span class="n">CIFS_WRLCK</span><span class="p">))</span>
				<span class="n">pLockData</span><span class="o">-&gt;</span><span class="n">fl_type</span> <span class="o">=</span> <span class="n">F_WRLCK</span><span class="p">;</span>

			<span class="n">pLockData</span><span class="o">-&gt;</span><span class="n">fl_start</span> <span class="o">=</span> <span class="n">le64_to_cpu</span><span class="p">(</span><span class="n">parm_data</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">);</span>
			<span class="n">pLockData</span><span class="o">-&gt;</span><span class="n">fl_end</span> <span class="o">=</span> <span class="n">pLockData</span><span class="o">-&gt;</span><span class="n">fl_start</span> <span class="o">+</span>
					<span class="n">le64_to_cpu</span><span class="p">(</span><span class="n">parm_data</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">pLockData</span><span class="o">-&gt;</span><span class="n">fl_pid</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">parm_data</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

<span class="nl">plk_err_exit:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pSMB</span><span class="p">)</span>
		<span class="n">cifs_small_buf_release</span><span class="p">(</span><span class="n">pSMB</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">resp_buf_type</span> <span class="o">==</span> <span class="n">CIFS_SMALL_BUFFER</span><span class="p">)</span>
		<span class="n">cifs_small_buf_release</span><span class="p">(</span><span class="n">iov</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">iov_base</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">resp_buf_type</span> <span class="o">==</span> <span class="n">CIFS_LARGE_BUFFER</span><span class="p">)</span>
		<span class="n">cifs_buf_release</span><span class="p">(</span><span class="n">iov</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">iov_base</span><span class="p">);</span>

	<span class="cm">/* Note: On -EAGAIN error only caller can retry on handle based calls</span>
<span class="cm">	   since file handle passed in no longer valid */</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>


<span class="kt">int</span>
<span class="nf">CIFSSMBClose</span><span class="p">(</span><span class="k">const</span> <span class="kt">int</span> <span class="n">xid</span><span class="p">,</span> <span class="k">struct</span> <span class="n">cifs_tcon</span> <span class="o">*</span><span class="n">tcon</span><span class="p">,</span> <span class="kt">int</span> <span class="n">smb_file_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">CLOSE_REQ</span> <span class="o">*</span><span class="n">pSMB</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">cFYI</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;In CIFSSMBClose&quot;</span><span class="p">);</span>

<span class="cm">/* do not retry on dead session on close */</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">small_smb_init</span><span class="p">(</span><span class="n">SMB_COM_CLOSE</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">tcon</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">**</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">pSMB</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">FileID</span> <span class="o">=</span> <span class="p">(</span><span class="n">__u16</span><span class="p">)</span> <span class="n">smb_file_id</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">LastWriteTime</span> <span class="o">=</span> <span class="mh">0xFFFFFFFF</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">ByteCount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">SendReceiveNoRsp</span><span class="p">(</span><span class="n">xid</span><span class="p">,</span> <span class="n">tcon</span><span class="o">-&gt;</span><span class="n">ses</span><span class="p">,</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">pSMB</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">cifs_stats_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tcon</span><span class="o">-&gt;</span><span class="n">num_closes</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">!=</span> <span class="o">-</span><span class="n">EINTR</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* EINTR is expected when user ctl-c to kill app */</span>
			<span class="n">cERROR</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;Send error in Close = %d&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* Since session is dead, file will be closed on server already */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">)</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="nf">CIFSSMBFlush</span><span class="p">(</span><span class="k">const</span> <span class="kt">int</span> <span class="n">xid</span><span class="p">,</span> <span class="k">struct</span> <span class="n">cifs_tcon</span> <span class="o">*</span><span class="n">tcon</span><span class="p">,</span> <span class="kt">int</span> <span class="n">smb_file_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">FLUSH_REQ</span> <span class="o">*</span><span class="n">pSMB</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">cFYI</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;In CIFSSMBFlush&quot;</span><span class="p">);</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">small_smb_init</span><span class="p">(</span><span class="n">SMB_COM_FLUSH</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">tcon</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">**</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">pSMB</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">FileID</span> <span class="o">=</span> <span class="p">(</span><span class="n">__u16</span><span class="p">)</span> <span class="n">smb_file_id</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">ByteCount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">SendReceiveNoRsp</span><span class="p">(</span><span class="n">xid</span><span class="p">,</span> <span class="n">tcon</span><span class="o">-&gt;</span><span class="n">ses</span><span class="p">,</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">pSMB</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">cifs_stats_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tcon</span><span class="o">-&gt;</span><span class="n">num_flushes</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="n">cERROR</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;Send error in Flush = %d&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="nf">CIFSSMBRename</span><span class="p">(</span><span class="k">const</span> <span class="kt">int</span> <span class="n">xid</span><span class="p">,</span> <span class="k">struct</span> <span class="n">cifs_tcon</span> <span class="o">*</span><span class="n">tcon</span><span class="p">,</span>
	      <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">fromName</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">toName</span><span class="p">,</span>
	      <span class="k">const</span> <span class="k">struct</span> <span class="n">nls_table</span> <span class="o">*</span><span class="n">nls_codepage</span><span class="p">,</span> <span class="kt">int</span> <span class="n">remap</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">RENAME_REQ</span> <span class="o">*</span><span class="n">pSMB</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">RENAME_RSP</span> <span class="o">*</span><span class="n">pSMBr</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">bytes_returned</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">name_len</span><span class="p">,</span> <span class="n">name_len2</span><span class="p">;</span>
	<span class="n">__u16</span> <span class="n">count</span><span class="p">;</span>

	<span class="n">cFYI</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;In CIFSSMBRename&quot;</span><span class="p">);</span>
<span class="nl">renameRetry:</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">smb_init</span><span class="p">(</span><span class="n">SMB_COM_RENAME</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">tcon</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">**</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">pSMB</span><span class="p">,</span>
		      <span class="p">(</span><span class="kt">void</span> <span class="o">**</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">pSMBr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">BufferFormat</span> <span class="o">=</span> <span class="mh">0x04</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">SearchAttributes</span> <span class="o">=</span>
	    <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">ATTR_READONLY</span> <span class="o">|</span> <span class="n">ATTR_HIDDEN</span> <span class="o">|</span> <span class="n">ATTR_SYSTEM</span> <span class="o">|</span>
			<span class="n">ATTR_DIRECTORY</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">Flags2</span> <span class="o">&amp;</span> <span class="n">SMBFLG2_UNICODE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">name_len</span> <span class="o">=</span>
		    <span class="n">cifsConvertToUTF16</span><span class="p">((</span><span class="n">__le16</span> <span class="o">*</span><span class="p">)</span> <span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">OldFileName</span><span class="p">,</span> <span class="n">fromName</span><span class="p">,</span>
				       <span class="n">PATH_MAX</span><span class="p">,</span> <span class="n">nls_codepage</span><span class="p">,</span> <span class="n">remap</span><span class="p">);</span>
		<span class="n">name_len</span><span class="o">++</span><span class="p">;</span>	<span class="cm">/* trailing null */</span>
		<span class="n">name_len</span> <span class="o">*=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">OldFileName</span><span class="p">[</span><span class="n">name_len</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x04</span><span class="p">;</span>	<span class="cm">/* pad */</span>
	<span class="cm">/* protocol requires ASCII signature byte on Unicode string */</span>
		<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">OldFileName</span><span class="p">[</span><span class="n">name_len</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
		<span class="n">name_len2</span> <span class="o">=</span>
		    <span class="n">cifsConvertToUTF16</span><span class="p">((</span><span class="n">__le16</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">OldFileName</span><span class="p">[</span><span class="n">name_len</span><span class="o">+</span><span class="mi">2</span><span class="p">],</span>
				       <span class="n">toName</span><span class="p">,</span> <span class="n">PATH_MAX</span><span class="p">,</span> <span class="n">nls_codepage</span><span class="p">,</span> <span class="n">remap</span><span class="p">);</span>
		<span class="n">name_len2</span> <span class="o">+=</span> <span class="mi">1</span> <span class="cm">/* trailing null */</span>  <span class="o">+</span> <span class="mi">1</span> <span class="cm">/* Signature word */</span> <span class="p">;</span>
		<span class="n">name_len2</span> <span class="o">*=</span> <span class="mi">2</span><span class="p">;</span>	<span class="cm">/* convert to bytes */</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>	<span class="cm">/* BB improve the check for buffer overruns BB */</span>
		<span class="n">name_len</span> <span class="o">=</span> <span class="n">strnlen</span><span class="p">(</span><span class="n">fromName</span><span class="p">,</span> <span class="n">PATH_MAX</span><span class="p">);</span>
		<span class="n">name_len</span><span class="o">++</span><span class="p">;</span>	<span class="cm">/* trailing null */</span>
		<span class="n">strncpy</span><span class="p">(</span><span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">OldFileName</span><span class="p">,</span> <span class="n">fromName</span><span class="p">,</span> <span class="n">name_len</span><span class="p">);</span>
		<span class="n">name_len2</span> <span class="o">=</span> <span class="n">strnlen</span><span class="p">(</span><span class="n">toName</span><span class="p">,</span> <span class="n">PATH_MAX</span><span class="p">);</span>
		<span class="n">name_len2</span><span class="o">++</span><span class="p">;</span>	<span class="cm">/* trailing null */</span>
		<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">OldFileName</span><span class="p">[</span><span class="n">name_len</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x04</span><span class="p">;</span>  <span class="cm">/* 2nd buffer format */</span>
		<span class="n">strncpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">OldFileName</span><span class="p">[</span><span class="n">name_len</span> <span class="o">+</span> <span class="mi">1</span><span class="p">],</span> <span class="n">toName</span><span class="p">,</span> <span class="n">name_len2</span><span class="p">);</span>
		<span class="n">name_len2</span><span class="o">++</span><span class="p">;</span>	<span class="cm">/* trailing null */</span>
		<span class="n">name_len2</span><span class="o">++</span><span class="p">;</span>	<span class="cm">/* signature byte */</span>
	<span class="p">}</span>

	<span class="n">count</span> <span class="o">=</span> <span class="mi">1</span> <span class="cm">/* 1st signature byte */</span>  <span class="o">+</span> <span class="n">name_len</span> <span class="o">+</span> <span class="n">name_len2</span><span class="p">;</span>
	<span class="n">inc_rfc1001_len</span><span class="p">(</span><span class="n">pSMB</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">ByteCount</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">count</span><span class="p">);</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">SendReceive</span><span class="p">(</span><span class="n">xid</span><span class="p">,</span> <span class="n">tcon</span><span class="o">-&gt;</span><span class="n">ses</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">smb_hdr</span> <span class="o">*</span><span class="p">)</span> <span class="n">pSMB</span><span class="p">,</span>
			 <span class="p">(</span><span class="k">struct</span> <span class="n">smb_hdr</span> <span class="o">*</span><span class="p">)</span> <span class="n">pSMBr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bytes_returned</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">cifs_stats_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tcon</span><span class="o">-&gt;</span><span class="n">num_renames</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="n">cFYI</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;Send error in rename = %d&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>

	<span class="n">cifs_buf_release</span><span class="p">(</span><span class="n">pSMB</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">renameRetry</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">CIFSSMBRenameOpenFile</span><span class="p">(</span><span class="k">const</span> <span class="kt">int</span> <span class="n">xid</span><span class="p">,</span> <span class="k">struct</span> <span class="n">cifs_tcon</span> <span class="o">*</span><span class="n">pTcon</span><span class="p">,</span>
		<span class="kt">int</span> <span class="n">netfid</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">target_name</span><span class="p">,</span>
		<span class="k">const</span> <span class="k">struct</span> <span class="n">nls_table</span> <span class="o">*</span><span class="n">nls_codepage</span><span class="p">,</span> <span class="kt">int</span> <span class="n">remap</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">smb_com_transaction2_sfi_req</span> <span class="o">*</span><span class="n">pSMB</span>  <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">smb_com_transaction2_sfi_rsp</span> <span class="o">*</span><span class="n">pSMBr</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">set_file_rename</span> <span class="o">*</span><span class="n">rename_info</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">data_offset</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">dummy_string</span><span class="p">[</span><span class="mi">30</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">bytes_returned</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">len_of_str</span><span class="p">;</span>
	<span class="n">__u16</span> <span class="n">params</span><span class="p">,</span> <span class="n">param_offset</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">byte_count</span><span class="p">;</span>

	<span class="n">cFYI</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;Rename to File by handle&quot;</span><span class="p">);</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">smb_init</span><span class="p">(</span><span class="n">SMB_COM_TRANSACTION2</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="n">pTcon</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">**</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">pSMB</span><span class="p">,</span>
			<span class="p">(</span><span class="kt">void</span> <span class="o">**</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">pSMBr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">params</span> <span class="o">=</span> <span class="mi">6</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">MaxSetupCount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">Reserved</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">Flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">Timeout</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">Reserved2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">param_offset</span> <span class="o">=</span> <span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">smb_com_transaction2_sfi_req</span><span class="p">,</span> <span class="n">Fid</span><span class="p">)</span> <span class="o">-</span> <span class="mi">4</span><span class="p">;</span>
	<span class="n">offset</span> <span class="o">=</span> <span class="n">param_offset</span> <span class="o">+</span> <span class="n">params</span><span class="p">;</span>

	<span class="n">data_offset</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">Protocol</span><span class="p">)</span> <span class="o">+</span> <span class="n">offset</span><span class="p">;</span>
	<span class="n">rename_info</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">set_file_rename</span> <span class="o">*</span><span class="p">)</span> <span class="n">data_offset</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">MaxParameterCount</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">MaxDataCount</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="mi">1000</span><span class="p">);</span> <span class="cm">/* BB find max SMB from sess */</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">SetupCount</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">Reserved3</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">SubCommand</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">TRANS2_SET_FILE_INFORMATION</span><span class="p">);</span>
	<span class="n">byte_count</span> <span class="o">=</span> <span class="mi">3</span> <span class="cm">/* pad */</span>  <span class="o">+</span> <span class="n">params</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">ParameterCount</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">params</span><span class="p">);</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">TotalParameterCount</span> <span class="o">=</span> <span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">ParameterCount</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">ParameterOffset</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">param_offset</span><span class="p">);</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">DataOffset</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">offset</span><span class="p">);</span>
	<span class="cm">/* construct random name &quot;.cifs_tmp&lt;inodenum&gt;&lt;mid&gt;&quot; */</span>
	<span class="n">rename_info</span><span class="o">-&gt;</span><span class="n">overwrite</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">rename_info</span><span class="o">-&gt;</span><span class="n">root_fid</span>  <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="cm">/* unicode only call */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">target_name</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sprintf</span><span class="p">(</span><span class="n">dummy_string</span><span class="p">,</span> <span class="s">&quot;cifs%x&quot;</span><span class="p">,</span> <span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">Mid</span><span class="p">);</span>
		<span class="n">len_of_str</span> <span class="o">=</span>
			<span class="n">cifsConvertToUTF16</span><span class="p">((</span><span class="n">__le16</span> <span class="o">*</span><span class="p">)</span><span class="n">rename_info</span><span class="o">-&gt;</span><span class="n">target_name</span><span class="p">,</span>
					<span class="n">dummy_string</span><span class="p">,</span> <span class="mi">24</span><span class="p">,</span> <span class="n">nls_codepage</span><span class="p">,</span> <span class="n">remap</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">len_of_str</span> <span class="o">=</span>
			<span class="n">cifsConvertToUTF16</span><span class="p">((</span><span class="n">__le16</span> <span class="o">*</span><span class="p">)</span><span class="n">rename_info</span><span class="o">-&gt;</span><span class="n">target_name</span><span class="p">,</span>
					<span class="n">target_name</span><span class="p">,</span> <span class="n">PATH_MAX</span><span class="p">,</span> <span class="n">nls_codepage</span><span class="p">,</span>
					<span class="n">remap</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">rename_info</span><span class="o">-&gt;</span><span class="n">target_name_len</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">len_of_str</span><span class="p">);</span>
	<span class="n">count</span> <span class="o">=</span> <span class="mi">12</span> <span class="cm">/* sizeof(struct set_file_rename) */</span> <span class="o">+</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">len_of_str</span><span class="p">);</span>
	<span class="n">byte_count</span> <span class="o">+=</span> <span class="n">count</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">DataCount</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">count</span><span class="p">);</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">TotalDataCount</span> <span class="o">=</span> <span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">DataCount</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">Fid</span> <span class="o">=</span> <span class="n">netfid</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">InformationLevel</span> <span class="o">=</span>
		<span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">SMB_SET_FILE_RENAME_INFORMATION</span><span class="p">);</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">Reserved4</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">inc_rfc1001_len</span><span class="p">(</span><span class="n">pSMB</span><span class="p">,</span> <span class="n">byte_count</span><span class="p">);</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">ByteCount</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">byte_count</span><span class="p">);</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">SendReceive</span><span class="p">(</span><span class="n">xid</span><span class="p">,</span> <span class="n">pTcon</span><span class="o">-&gt;</span><span class="n">ses</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">smb_hdr</span> <span class="o">*</span><span class="p">)</span> <span class="n">pSMB</span><span class="p">,</span>
			 <span class="p">(</span><span class="k">struct</span> <span class="n">smb_hdr</span> <span class="o">*</span><span class="p">)</span> <span class="n">pSMBr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bytes_returned</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">cifs_stats_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pTcon</span><span class="o">-&gt;</span><span class="n">num_t2renames</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="n">cFYI</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;Send error in Rename (by file handle) = %d&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>

	<span class="n">cifs_buf_release</span><span class="p">(</span><span class="n">pSMB</span><span class="p">);</span>

	<span class="cm">/* Note: On -EAGAIN error only caller can retry on handle based calls</span>
<span class="cm">		since file handle passed in no longer valid */</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="nf">CIFSSMBCopy</span><span class="p">(</span><span class="k">const</span> <span class="kt">int</span> <span class="n">xid</span><span class="p">,</span> <span class="k">struct</span> <span class="n">cifs_tcon</span> <span class="o">*</span><span class="n">tcon</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">fromName</span><span class="p">,</span>
	    <span class="k">const</span> <span class="n">__u16</span> <span class="n">target_tid</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">toName</span><span class="p">,</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">flags</span><span class="p">,</span>
	    <span class="k">const</span> <span class="k">struct</span> <span class="n">nls_table</span> <span class="o">*</span><span class="n">nls_codepage</span><span class="p">,</span> <span class="kt">int</span> <span class="n">remap</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">COPY_REQ</span> <span class="o">*</span><span class="n">pSMB</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">COPY_RSP</span> <span class="o">*</span><span class="n">pSMBr</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">bytes_returned</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">name_len</span><span class="p">,</span> <span class="n">name_len2</span><span class="p">;</span>
	<span class="n">__u16</span> <span class="n">count</span><span class="p">;</span>

	<span class="n">cFYI</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;In CIFSSMBCopy&quot;</span><span class="p">);</span>
<span class="nl">copyRetry:</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">smb_init</span><span class="p">(</span><span class="n">SMB_COM_COPY</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">tcon</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">**</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">pSMB</span><span class="p">,</span>
			<span class="p">(</span><span class="kt">void</span> <span class="o">**</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">pSMBr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">BufferFormat</span> <span class="o">=</span> <span class="mh">0x04</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">Tid2</span> <span class="o">=</span> <span class="n">target_tid</span><span class="p">;</span>

	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">Flags</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">COPY_TREE</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">Flags2</span> <span class="o">&amp;</span> <span class="n">SMBFLG2_UNICODE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">name_len</span> <span class="o">=</span> <span class="n">cifsConvertToUTF16</span><span class="p">((</span><span class="n">__le16</span> <span class="o">*</span><span class="p">)</span> <span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">OldFileName</span><span class="p">,</span>
					      <span class="n">fromName</span><span class="p">,</span> <span class="n">PATH_MAX</span><span class="p">,</span> <span class="n">nls_codepage</span><span class="p">,</span>
					      <span class="n">remap</span><span class="p">);</span>
		<span class="n">name_len</span><span class="o">++</span><span class="p">;</span>     <span class="cm">/* trailing null */</span>
		<span class="n">name_len</span> <span class="o">*=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">OldFileName</span><span class="p">[</span><span class="n">name_len</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x04</span><span class="p">;</span>     <span class="cm">/* pad */</span>
		<span class="cm">/* protocol requires ASCII signature byte on Unicode string */</span>
		<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">OldFileName</span><span class="p">[</span><span class="n">name_len</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
		<span class="n">name_len2</span> <span class="o">=</span>
		    <span class="n">cifsConvertToUTF16</span><span class="p">((</span><span class="n">__le16</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">OldFileName</span><span class="p">[</span><span class="n">name_len</span><span class="o">+</span><span class="mi">2</span><span class="p">],</span>
				       <span class="n">toName</span><span class="p">,</span> <span class="n">PATH_MAX</span><span class="p">,</span> <span class="n">nls_codepage</span><span class="p">,</span> <span class="n">remap</span><span class="p">);</span>
		<span class="n">name_len2</span> <span class="o">+=</span> <span class="mi">1</span> <span class="cm">/* trailing null */</span>  <span class="o">+</span> <span class="mi">1</span> <span class="cm">/* Signature word */</span> <span class="p">;</span>
		<span class="n">name_len2</span> <span class="o">*=</span> <span class="mi">2</span><span class="p">;</span> <span class="cm">/* convert to bytes */</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span> 	<span class="cm">/* BB improve the check for buffer overruns BB */</span>
		<span class="n">name_len</span> <span class="o">=</span> <span class="n">strnlen</span><span class="p">(</span><span class="n">fromName</span><span class="p">,</span> <span class="n">PATH_MAX</span><span class="p">);</span>
		<span class="n">name_len</span><span class="o">++</span><span class="p">;</span>     <span class="cm">/* trailing null */</span>
		<span class="n">strncpy</span><span class="p">(</span><span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">OldFileName</span><span class="p">,</span> <span class="n">fromName</span><span class="p">,</span> <span class="n">name_len</span><span class="p">);</span>
		<span class="n">name_len2</span> <span class="o">=</span> <span class="n">strnlen</span><span class="p">(</span><span class="n">toName</span><span class="p">,</span> <span class="n">PATH_MAX</span><span class="p">);</span>
		<span class="n">name_len2</span><span class="o">++</span><span class="p">;</span>    <span class="cm">/* trailing null */</span>
		<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">OldFileName</span><span class="p">[</span><span class="n">name_len</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x04</span><span class="p">;</span>  <span class="cm">/* 2nd buffer format */</span>
		<span class="n">strncpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">OldFileName</span><span class="p">[</span><span class="n">name_len</span> <span class="o">+</span> <span class="mi">1</span><span class="p">],</span> <span class="n">toName</span><span class="p">,</span> <span class="n">name_len2</span><span class="p">);</span>
		<span class="n">name_len2</span><span class="o">++</span><span class="p">;</span>    <span class="cm">/* trailing null */</span>
		<span class="n">name_len2</span><span class="o">++</span><span class="p">;</span>    <span class="cm">/* signature byte */</span>
	<span class="p">}</span>

	<span class="n">count</span> <span class="o">=</span> <span class="mi">1</span> <span class="cm">/* 1st signature byte */</span>  <span class="o">+</span> <span class="n">name_len</span> <span class="o">+</span> <span class="n">name_len2</span><span class="p">;</span>
	<span class="n">inc_rfc1001_len</span><span class="p">(</span><span class="n">pSMB</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">ByteCount</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">count</span><span class="p">);</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">SendReceive</span><span class="p">(</span><span class="n">xid</span><span class="p">,</span> <span class="n">tcon</span><span class="o">-&gt;</span><span class="n">ses</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">smb_hdr</span> <span class="o">*</span><span class="p">)</span> <span class="n">pSMB</span><span class="p">,</span>
		<span class="p">(</span><span class="k">struct</span> <span class="n">smb_hdr</span> <span class="o">*</span><span class="p">)</span> <span class="n">pSMBr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bytes_returned</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cFYI</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;Send error in copy = %d with %d files copied&quot;</span><span class="p">,</span>
			<span class="n">rc</span><span class="p">,</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">pSMBr</span><span class="o">-&gt;</span><span class="n">CopyCount</span><span class="p">));</span>
	<span class="p">}</span>
	<span class="n">cifs_buf_release</span><span class="p">(</span><span class="n">pSMB</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">copyRetry</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="nf">CIFSUnixCreateSymLink</span><span class="p">(</span><span class="k">const</span> <span class="kt">int</span> <span class="n">xid</span><span class="p">,</span> <span class="k">struct</span> <span class="n">cifs_tcon</span> <span class="o">*</span><span class="n">tcon</span><span class="p">,</span>
		      <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">fromName</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">toName</span><span class="p">,</span>
		      <span class="k">const</span> <span class="k">struct</span> <span class="n">nls_table</span> <span class="o">*</span><span class="n">nls_codepage</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">TRANSACTION2_SPI_REQ</span> <span class="o">*</span><span class="n">pSMB</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">TRANSACTION2_SPI_RSP</span> <span class="o">*</span><span class="n">pSMBr</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">data_offset</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">name_len</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">name_len_target</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">bytes_returned</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">__u16</span> <span class="n">params</span><span class="p">,</span> <span class="n">param_offset</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">byte_count</span><span class="p">;</span>

	<span class="n">cFYI</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;In Symlink Unix style&quot;</span><span class="p">);</span>
<span class="nl">createSymLinkRetry:</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">smb_init</span><span class="p">(</span><span class="n">SMB_COM_TRANSACTION2</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="n">tcon</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">**</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">pSMB</span><span class="p">,</span>
		      <span class="p">(</span><span class="kt">void</span> <span class="o">**</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">pSMBr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">Flags2</span> <span class="o">&amp;</span> <span class="n">SMBFLG2_UNICODE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">name_len</span> <span class="o">=</span>
		    <span class="n">cifs_strtoUTF16</span><span class="p">((</span><span class="n">__le16</span> <span class="o">*</span><span class="p">)</span> <span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">FileName</span><span class="p">,</span> <span class="n">fromName</span><span class="p">,</span>
				    <span class="cm">/* find define for this maxpathcomponent */</span>
				    <span class="n">PATH_MAX</span><span class="p">,</span> <span class="n">nls_codepage</span><span class="p">);</span>
		<span class="n">name_len</span><span class="o">++</span><span class="p">;</span>	<span class="cm">/* trailing null */</span>
		<span class="n">name_len</span> <span class="o">*=</span> <span class="mi">2</span><span class="p">;</span>

	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>	<span class="cm">/* BB improve the check for buffer overruns BB */</span>
		<span class="n">name_len</span> <span class="o">=</span> <span class="n">strnlen</span><span class="p">(</span><span class="n">fromName</span><span class="p">,</span> <span class="n">PATH_MAX</span><span class="p">);</span>
		<span class="n">name_len</span><span class="o">++</span><span class="p">;</span>	<span class="cm">/* trailing null */</span>
		<span class="n">strncpy</span><span class="p">(</span><span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">FileName</span><span class="p">,</span> <span class="n">fromName</span><span class="p">,</span> <span class="n">name_len</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">params</span> <span class="o">=</span> <span class="mi">6</span> <span class="o">+</span> <span class="n">name_len</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">MaxSetupCount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">Reserved</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">Flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">Timeout</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">Reserved2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">param_offset</span> <span class="o">=</span> <span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">smb_com_transaction2_spi_req</span><span class="p">,</span>
				<span class="n">InformationLevel</span><span class="p">)</span> <span class="o">-</span> <span class="mi">4</span><span class="p">;</span>
	<span class="n">offset</span> <span class="o">=</span> <span class="n">param_offset</span> <span class="o">+</span> <span class="n">params</span><span class="p">;</span>

	<span class="n">data_offset</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">Protocol</span><span class="p">)</span> <span class="o">+</span> <span class="n">offset</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">Flags2</span> <span class="o">&amp;</span> <span class="n">SMBFLG2_UNICODE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">name_len_target</span> <span class="o">=</span>
		    <span class="n">cifs_strtoUTF16</span><span class="p">((</span><span class="n">__le16</span> <span class="o">*</span><span class="p">)</span> <span class="n">data_offset</span><span class="p">,</span> <span class="n">toName</span><span class="p">,</span> <span class="n">PATH_MAX</span>
				    <span class="cm">/* find define for this maxpathcomponent */</span>
				    <span class="p">,</span> <span class="n">nls_codepage</span><span class="p">);</span>
		<span class="n">name_len_target</span><span class="o">++</span><span class="p">;</span>	<span class="cm">/* trailing null */</span>
		<span class="n">name_len_target</span> <span class="o">*=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>	<span class="cm">/* BB improve the check for buffer overruns BB */</span>
		<span class="n">name_len_target</span> <span class="o">=</span> <span class="n">strnlen</span><span class="p">(</span><span class="n">toName</span><span class="p">,</span> <span class="n">PATH_MAX</span><span class="p">);</span>
		<span class="n">name_len_target</span><span class="o">++</span><span class="p">;</span>	<span class="cm">/* trailing null */</span>
		<span class="n">strncpy</span><span class="p">(</span><span class="n">data_offset</span><span class="p">,</span> <span class="n">toName</span><span class="p">,</span> <span class="n">name_len_target</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">MaxParameterCount</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
	<span class="cm">/* BB find exact max on data count below from sess */</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">MaxDataCount</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="mi">1000</span><span class="p">);</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">SetupCount</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">Reserved3</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">SubCommand</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">TRANS2_SET_PATH_INFORMATION</span><span class="p">);</span>
	<span class="n">byte_count</span> <span class="o">=</span> <span class="mi">3</span> <span class="cm">/* pad */</span>  <span class="o">+</span> <span class="n">params</span> <span class="o">+</span> <span class="n">name_len_target</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">DataCount</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">name_len_target</span><span class="p">);</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">ParameterCount</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">params</span><span class="p">);</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">TotalDataCount</span> <span class="o">=</span> <span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">DataCount</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">TotalParameterCount</span> <span class="o">=</span> <span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">ParameterCount</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">ParameterOffset</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">param_offset</span><span class="p">);</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">DataOffset</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">offset</span><span class="p">);</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">InformationLevel</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">SMB_SET_FILE_UNIX_LINK</span><span class="p">);</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">Reserved4</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">inc_rfc1001_len</span><span class="p">(</span><span class="n">pSMB</span><span class="p">,</span> <span class="n">byte_count</span><span class="p">);</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">ByteCount</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">byte_count</span><span class="p">);</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">SendReceive</span><span class="p">(</span><span class="n">xid</span><span class="p">,</span> <span class="n">tcon</span><span class="o">-&gt;</span><span class="n">ses</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">smb_hdr</span> <span class="o">*</span><span class="p">)</span> <span class="n">pSMB</span><span class="p">,</span>
			 <span class="p">(</span><span class="k">struct</span> <span class="n">smb_hdr</span> <span class="o">*</span><span class="p">)</span> <span class="n">pSMBr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bytes_returned</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">cifs_stats_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tcon</span><span class="o">-&gt;</span><span class="n">num_symlinks</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="n">cFYI</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;Send error in SetPathInfo create symlink = %d&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>

	<span class="n">cifs_buf_release</span><span class="p">(</span><span class="n">pSMB</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">createSymLinkRetry</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="nf">CIFSUnixCreateHardLink</span><span class="p">(</span><span class="k">const</span> <span class="kt">int</span> <span class="n">xid</span><span class="p">,</span> <span class="k">struct</span> <span class="n">cifs_tcon</span> <span class="o">*</span><span class="n">tcon</span><span class="p">,</span>
		       <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">fromName</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">toName</span><span class="p">,</span>
		       <span class="k">const</span> <span class="k">struct</span> <span class="n">nls_table</span> <span class="o">*</span><span class="n">nls_codepage</span><span class="p">,</span> <span class="kt">int</span> <span class="n">remap</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">TRANSACTION2_SPI_REQ</span> <span class="o">*</span><span class="n">pSMB</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">TRANSACTION2_SPI_RSP</span> <span class="o">*</span><span class="n">pSMBr</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">data_offset</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">name_len</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">name_len_target</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">bytes_returned</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">__u16</span> <span class="n">params</span><span class="p">,</span> <span class="n">param_offset</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">byte_count</span><span class="p">;</span>

	<span class="n">cFYI</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;In Create Hard link Unix style&quot;</span><span class="p">);</span>
<span class="nl">createHardLinkRetry:</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">smb_init</span><span class="p">(</span><span class="n">SMB_COM_TRANSACTION2</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="n">tcon</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">**</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">pSMB</span><span class="p">,</span>
		      <span class="p">(</span><span class="kt">void</span> <span class="o">**</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">pSMBr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">Flags2</span> <span class="o">&amp;</span> <span class="n">SMBFLG2_UNICODE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">name_len</span> <span class="o">=</span> <span class="n">cifsConvertToUTF16</span><span class="p">((</span><span class="n">__le16</span> <span class="o">*</span><span class="p">)</span> <span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">FileName</span><span class="p">,</span> <span class="n">toName</span><span class="p">,</span>
					      <span class="n">PATH_MAX</span><span class="p">,</span> <span class="n">nls_codepage</span><span class="p">,</span> <span class="n">remap</span><span class="p">);</span>
		<span class="n">name_len</span><span class="o">++</span><span class="p">;</span>	<span class="cm">/* trailing null */</span>
		<span class="n">name_len</span> <span class="o">*=</span> <span class="mi">2</span><span class="p">;</span>

	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>	<span class="cm">/* BB improve the check for buffer overruns BB */</span>
		<span class="n">name_len</span> <span class="o">=</span> <span class="n">strnlen</span><span class="p">(</span><span class="n">toName</span><span class="p">,</span> <span class="n">PATH_MAX</span><span class="p">);</span>
		<span class="n">name_len</span><span class="o">++</span><span class="p">;</span>	<span class="cm">/* trailing null */</span>
		<span class="n">strncpy</span><span class="p">(</span><span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">FileName</span><span class="p">,</span> <span class="n">toName</span><span class="p">,</span> <span class="n">name_len</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">params</span> <span class="o">=</span> <span class="mi">6</span> <span class="o">+</span> <span class="n">name_len</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">MaxSetupCount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">Reserved</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">Flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">Timeout</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">Reserved2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">param_offset</span> <span class="o">=</span> <span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">smb_com_transaction2_spi_req</span><span class="p">,</span>
				<span class="n">InformationLevel</span><span class="p">)</span> <span class="o">-</span> <span class="mi">4</span><span class="p">;</span>
	<span class="n">offset</span> <span class="o">=</span> <span class="n">param_offset</span> <span class="o">+</span> <span class="n">params</span><span class="p">;</span>

	<span class="n">data_offset</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">Protocol</span><span class="p">)</span> <span class="o">+</span> <span class="n">offset</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">Flags2</span> <span class="o">&amp;</span> <span class="n">SMBFLG2_UNICODE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">name_len_target</span> <span class="o">=</span>
		    <span class="n">cifsConvertToUTF16</span><span class="p">((</span><span class="n">__le16</span> <span class="o">*</span><span class="p">)</span> <span class="n">data_offset</span><span class="p">,</span> <span class="n">fromName</span><span class="p">,</span>
				       <span class="n">PATH_MAX</span><span class="p">,</span> <span class="n">nls_codepage</span><span class="p">,</span> <span class="n">remap</span><span class="p">);</span>
		<span class="n">name_len_target</span><span class="o">++</span><span class="p">;</span>	<span class="cm">/* trailing null */</span>
		<span class="n">name_len_target</span> <span class="o">*=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>	<span class="cm">/* BB improve the check for buffer overruns BB */</span>
		<span class="n">name_len_target</span> <span class="o">=</span> <span class="n">strnlen</span><span class="p">(</span><span class="n">fromName</span><span class="p">,</span> <span class="n">PATH_MAX</span><span class="p">);</span>
		<span class="n">name_len_target</span><span class="o">++</span><span class="p">;</span>	<span class="cm">/* trailing null */</span>
		<span class="n">strncpy</span><span class="p">(</span><span class="n">data_offset</span><span class="p">,</span> <span class="n">fromName</span><span class="p">,</span> <span class="n">name_len_target</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">MaxParameterCount</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
	<span class="cm">/* BB find exact max on data count below from sess*/</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">MaxDataCount</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="mi">1000</span><span class="p">);</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">SetupCount</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">Reserved3</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">SubCommand</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">TRANS2_SET_PATH_INFORMATION</span><span class="p">);</span>
	<span class="n">byte_count</span> <span class="o">=</span> <span class="mi">3</span> <span class="cm">/* pad */</span>  <span class="o">+</span> <span class="n">params</span> <span class="o">+</span> <span class="n">name_len_target</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">ParameterCount</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">params</span><span class="p">);</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">TotalParameterCount</span> <span class="o">=</span> <span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">ParameterCount</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">DataCount</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">name_len_target</span><span class="p">);</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">TotalDataCount</span> <span class="o">=</span> <span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">DataCount</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">ParameterOffset</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">param_offset</span><span class="p">);</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">DataOffset</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">offset</span><span class="p">);</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">InformationLevel</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">SMB_SET_FILE_UNIX_HLINK</span><span class="p">);</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">Reserved4</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">inc_rfc1001_len</span><span class="p">(</span><span class="n">pSMB</span><span class="p">,</span> <span class="n">byte_count</span><span class="p">);</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">ByteCount</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">byte_count</span><span class="p">);</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">SendReceive</span><span class="p">(</span><span class="n">xid</span><span class="p">,</span> <span class="n">tcon</span><span class="o">-&gt;</span><span class="n">ses</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">smb_hdr</span> <span class="o">*</span><span class="p">)</span> <span class="n">pSMB</span><span class="p">,</span>
			 <span class="p">(</span><span class="k">struct</span> <span class="n">smb_hdr</span> <span class="o">*</span><span class="p">)</span> <span class="n">pSMBr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bytes_returned</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">cifs_stats_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tcon</span><span class="o">-&gt;</span><span class="n">num_hardlinks</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="n">cFYI</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;Send error in SetPathInfo (hard link) = %d&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>

	<span class="n">cifs_buf_release</span><span class="p">(</span><span class="n">pSMB</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">createHardLinkRetry</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="nf">CIFSCreateHardLink</span><span class="p">(</span><span class="k">const</span> <span class="kt">int</span> <span class="n">xid</span><span class="p">,</span> <span class="k">struct</span> <span class="n">cifs_tcon</span> <span class="o">*</span><span class="n">tcon</span><span class="p">,</span>
		   <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">fromName</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">toName</span><span class="p">,</span>
		   <span class="k">const</span> <span class="k">struct</span> <span class="n">nls_table</span> <span class="o">*</span><span class="n">nls_codepage</span><span class="p">,</span> <span class="kt">int</span> <span class="n">remap</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">NT_RENAME_REQ</span> <span class="o">*</span><span class="n">pSMB</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">RENAME_RSP</span> <span class="o">*</span><span class="n">pSMBr</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">bytes_returned</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">name_len</span><span class="p">,</span> <span class="n">name_len2</span><span class="p">;</span>
	<span class="n">__u16</span> <span class="n">count</span><span class="p">;</span>

	<span class="n">cFYI</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;In CIFSCreateHardLink&quot;</span><span class="p">);</span>
<span class="nl">winCreateHardLinkRetry:</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">smb_init</span><span class="p">(</span><span class="n">SMB_COM_NT_RENAME</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">tcon</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">**</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">pSMB</span><span class="p">,</span>
		      <span class="p">(</span><span class="kt">void</span> <span class="o">**</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">pSMBr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">SearchAttributes</span> <span class="o">=</span>
	    <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">ATTR_READONLY</span> <span class="o">|</span> <span class="n">ATTR_HIDDEN</span> <span class="o">|</span> <span class="n">ATTR_SYSTEM</span> <span class="o">|</span>
			<span class="n">ATTR_DIRECTORY</span><span class="p">);</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">Flags</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">CREATE_HARD_LINK</span><span class="p">);</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">ClusterCount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">BufferFormat</span> <span class="o">=</span> <span class="mh">0x04</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">Flags2</span> <span class="o">&amp;</span> <span class="n">SMBFLG2_UNICODE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">name_len</span> <span class="o">=</span>
		    <span class="n">cifsConvertToUTF16</span><span class="p">((</span><span class="n">__le16</span> <span class="o">*</span><span class="p">)</span> <span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">OldFileName</span><span class="p">,</span> <span class="n">fromName</span><span class="p">,</span>
				       <span class="n">PATH_MAX</span><span class="p">,</span> <span class="n">nls_codepage</span><span class="p">,</span> <span class="n">remap</span><span class="p">);</span>
		<span class="n">name_len</span><span class="o">++</span><span class="p">;</span>	<span class="cm">/* trailing null */</span>
		<span class="n">name_len</span> <span class="o">*=</span> <span class="mi">2</span><span class="p">;</span>

		<span class="cm">/* protocol specifies ASCII buffer format (0x04) for unicode */</span>
		<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">OldFileName</span><span class="p">[</span><span class="n">name_len</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x04</span><span class="p">;</span>
		<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">OldFileName</span><span class="p">[</span><span class="n">name_len</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span> <span class="cm">/* pad */</span>
		<span class="n">name_len2</span> <span class="o">=</span>
		    <span class="n">cifsConvertToUTF16</span><span class="p">((</span><span class="n">__le16</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">OldFileName</span><span class="p">[</span><span class="n">name_len</span><span class="o">+</span><span class="mi">2</span><span class="p">],</span>
				       <span class="n">toName</span><span class="p">,</span> <span class="n">PATH_MAX</span><span class="p">,</span> <span class="n">nls_codepage</span><span class="p">,</span> <span class="n">remap</span><span class="p">);</span>
		<span class="n">name_len2</span> <span class="o">+=</span> <span class="mi">1</span> <span class="cm">/* trailing null */</span>  <span class="o">+</span> <span class="mi">1</span> <span class="cm">/* Signature word */</span> <span class="p">;</span>
		<span class="n">name_len2</span> <span class="o">*=</span> <span class="mi">2</span><span class="p">;</span>	<span class="cm">/* convert to bytes */</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>	<span class="cm">/* BB improve the check for buffer overruns BB */</span>
		<span class="n">name_len</span> <span class="o">=</span> <span class="n">strnlen</span><span class="p">(</span><span class="n">fromName</span><span class="p">,</span> <span class="n">PATH_MAX</span><span class="p">);</span>
		<span class="n">name_len</span><span class="o">++</span><span class="p">;</span>	<span class="cm">/* trailing null */</span>
		<span class="n">strncpy</span><span class="p">(</span><span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">OldFileName</span><span class="p">,</span> <span class="n">fromName</span><span class="p">,</span> <span class="n">name_len</span><span class="p">);</span>
		<span class="n">name_len2</span> <span class="o">=</span> <span class="n">strnlen</span><span class="p">(</span><span class="n">toName</span><span class="p">,</span> <span class="n">PATH_MAX</span><span class="p">);</span>
		<span class="n">name_len2</span><span class="o">++</span><span class="p">;</span>	<span class="cm">/* trailing null */</span>
		<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">OldFileName</span><span class="p">[</span><span class="n">name_len</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x04</span><span class="p">;</span>	<span class="cm">/* 2nd buffer format */</span>
		<span class="n">strncpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">OldFileName</span><span class="p">[</span><span class="n">name_len</span> <span class="o">+</span> <span class="mi">1</span><span class="p">],</span> <span class="n">toName</span><span class="p">,</span> <span class="n">name_len2</span><span class="p">);</span>
		<span class="n">name_len2</span><span class="o">++</span><span class="p">;</span>	<span class="cm">/* trailing null */</span>
		<span class="n">name_len2</span><span class="o">++</span><span class="p">;</span>	<span class="cm">/* signature byte */</span>
	<span class="p">}</span>

	<span class="n">count</span> <span class="o">=</span> <span class="mi">1</span> <span class="cm">/* string type byte */</span>  <span class="o">+</span> <span class="n">name_len</span> <span class="o">+</span> <span class="n">name_len2</span><span class="p">;</span>
	<span class="n">inc_rfc1001_len</span><span class="p">(</span><span class="n">pSMB</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">ByteCount</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">count</span><span class="p">);</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">SendReceive</span><span class="p">(</span><span class="n">xid</span><span class="p">,</span> <span class="n">tcon</span><span class="o">-&gt;</span><span class="n">ses</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">smb_hdr</span> <span class="o">*</span><span class="p">)</span> <span class="n">pSMB</span><span class="p">,</span>
			 <span class="p">(</span><span class="k">struct</span> <span class="n">smb_hdr</span> <span class="o">*</span><span class="p">)</span> <span class="n">pSMBr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bytes_returned</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">cifs_stats_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tcon</span><span class="o">-&gt;</span><span class="n">num_hardlinks</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="n">cFYI</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;Send error in hard link (NT rename) = %d&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>

	<span class="n">cifs_buf_release</span><span class="p">(</span><span class="n">pSMB</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">winCreateHardLinkRetry</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="nf">CIFSSMBUnixQuerySymLink</span><span class="p">(</span><span class="k">const</span> <span class="kt">int</span> <span class="n">xid</span><span class="p">,</span> <span class="k">struct</span> <span class="n">cifs_tcon</span> <span class="o">*</span><span class="n">tcon</span><span class="p">,</span>
			<span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">searchName</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">symlinkinfo</span><span class="p">,</span>
			<span class="k">const</span> <span class="k">struct</span> <span class="n">nls_table</span> <span class="o">*</span><span class="n">nls_codepage</span><span class="p">)</span>
<span class="p">{</span>
<span class="cm">/* SMB_QUERY_FILE_UNIX_LINK */</span>
	<span class="n">TRANSACTION2_QPI_REQ</span> <span class="o">*</span><span class="n">pSMB</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">TRANSACTION2_QPI_RSP</span> <span class="o">*</span><span class="n">pSMBr</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">bytes_returned</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">name_len</span><span class="p">;</span>
	<span class="n">__u16</span> <span class="n">params</span><span class="p">,</span> <span class="n">byte_count</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">data_start</span><span class="p">;</span>

	<span class="n">cFYI</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;In QPathSymLinkInfo (Unix) for path %s&quot;</span><span class="p">,</span> <span class="n">searchName</span><span class="p">);</span>

<span class="nl">querySymLinkRetry:</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">smb_init</span><span class="p">(</span><span class="n">SMB_COM_TRANSACTION2</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="n">tcon</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">**</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">pSMB</span><span class="p">,</span>
		      <span class="p">(</span><span class="kt">void</span> <span class="o">**</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">pSMBr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">Flags2</span> <span class="o">&amp;</span> <span class="n">SMBFLG2_UNICODE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">name_len</span> <span class="o">=</span>
			<span class="n">cifs_strtoUTF16</span><span class="p">((</span><span class="n">__le16</span> <span class="o">*</span><span class="p">)</span> <span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">FileName</span><span class="p">,</span> <span class="n">searchName</span><span class="p">,</span>
					<span class="n">PATH_MAX</span><span class="p">,</span> <span class="n">nls_codepage</span><span class="p">);</span>
		<span class="n">name_len</span><span class="o">++</span><span class="p">;</span>	<span class="cm">/* trailing null */</span>
		<span class="n">name_len</span> <span class="o">*=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>	<span class="cm">/* BB improve the check for buffer overruns BB */</span>
		<span class="n">name_len</span> <span class="o">=</span> <span class="n">strnlen</span><span class="p">(</span><span class="n">searchName</span><span class="p">,</span> <span class="n">PATH_MAX</span><span class="p">);</span>
		<span class="n">name_len</span><span class="o">++</span><span class="p">;</span>	<span class="cm">/* trailing null */</span>
		<span class="n">strncpy</span><span class="p">(</span><span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">FileName</span><span class="p">,</span> <span class="n">searchName</span><span class="p">,</span> <span class="n">name_len</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">params</span> <span class="o">=</span> <span class="mi">2</span> <span class="cm">/* level */</span>  <span class="o">+</span> <span class="mi">4</span> <span class="cm">/* rsrvd */</span>  <span class="o">+</span> <span class="n">name_len</span> <span class="cm">/* incl null */</span> <span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">TotalDataCount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">MaxParameterCount</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">MaxDataCount</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">CIFSMaxBufSize</span><span class="p">);</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">MaxSetupCount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">Reserved</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">Flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">Timeout</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">Reserved2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">ParameterOffset</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">offsetof</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">smb_com_transaction2_qpi_req</span><span class="p">,</span> <span class="n">InformationLevel</span><span class="p">)</span> <span class="o">-</span> <span class="mi">4</span><span class="p">);</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">DataCount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">DataOffset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">SetupCount</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">Reserved3</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">SubCommand</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">TRANS2_QUERY_PATH_INFORMATION</span><span class="p">);</span>
	<span class="n">byte_count</span> <span class="o">=</span> <span class="n">params</span> <span class="o">+</span> <span class="mi">1</span> <span class="cm">/* pad */</span> <span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">TotalParameterCount</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">params</span><span class="p">);</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">ParameterCount</span> <span class="o">=</span> <span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">TotalParameterCount</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">InformationLevel</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">SMB_QUERY_FILE_UNIX_LINK</span><span class="p">);</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">Reserved4</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">inc_rfc1001_len</span><span class="p">(</span><span class="n">pSMB</span><span class="p">,</span> <span class="n">byte_count</span><span class="p">);</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">ByteCount</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">byte_count</span><span class="p">);</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">SendReceive</span><span class="p">(</span><span class="n">xid</span><span class="p">,</span> <span class="n">tcon</span><span class="o">-&gt;</span><span class="n">ses</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">smb_hdr</span> <span class="o">*</span><span class="p">)</span> <span class="n">pSMB</span><span class="p">,</span>
			 <span class="p">(</span><span class="k">struct</span> <span class="n">smb_hdr</span> <span class="o">*</span><span class="p">)</span> <span class="n">pSMBr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bytes_returned</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cFYI</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;Send error in QuerySymLinkInfo = %d&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* decode response */</span>

		<span class="n">rc</span> <span class="o">=</span> <span class="n">validate_t2</span><span class="p">((</span><span class="k">struct</span> <span class="n">smb_t2_rsp</span> <span class="o">*</span><span class="p">)</span><span class="n">pSMBr</span><span class="p">);</span>
		<span class="cm">/* BB also check enough total bytes returned */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">||</span> <span class="n">get_bcc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pSMBr</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="n">bool</span> <span class="n">is_unicode</span><span class="p">;</span>
			<span class="n">u16</span> <span class="n">count</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">pSMBr</span><span class="o">-&gt;</span><span class="n">t2</span><span class="p">.</span><span class="n">DataCount</span><span class="p">);</span>

			<span class="n">data_start</span> <span class="o">=</span> <span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">pSMBr</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">Protocol</span><span class="p">)</span> <span class="o">+</span>
					   <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">pSMBr</span><span class="o">-&gt;</span><span class="n">t2</span><span class="p">.</span><span class="n">DataOffset</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">pSMBr</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">Flags2</span> <span class="o">&amp;</span> <span class="n">SMBFLG2_UNICODE</span><span class="p">)</span>
				<span class="n">is_unicode</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">is_unicode</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

			<span class="cm">/* BB FIXME investigate remapping reserved chars here */</span>
			<span class="o">*</span><span class="n">symlinkinfo</span> <span class="o">=</span> <span class="n">cifs_strndup_from_utf16</span><span class="p">(</span><span class="n">data_start</span><span class="p">,</span>
					<span class="n">count</span><span class="p">,</span> <span class="n">is_unicode</span><span class="p">,</span> <span class="n">nls_codepage</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!*</span><span class="n">symlinkinfo</span><span class="p">)</span>
				<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">cifs_buf_release</span><span class="p">(</span><span class="n">pSMB</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">querySymLinkRetry</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_CIFS_SYMLINK_EXPERIMENTAL</span>
<span class="cm">/*</span>
<span class="cm"> *	Recent Windows versions now create symlinks more frequently</span>
<span class="cm"> *	and they use the &quot;reparse point&quot; mechanism below.  We can of course</span>
<span class="cm"> *	do symlinks nicely to Samba and other servers which support the</span>
<span class="cm"> *	CIFS Unix Extensions and we can also do SFU symlinks and &quot;client only&quot;</span>
<span class="cm"> *	&quot;MF&quot; symlinks optionally, but for recent Windows we really need to</span>
<span class="cm"> *	reenable the code below and fix the cifs_symlink callers to handle this.</span>
<span class="cm"> *	In the interim this code has been moved to its own config option so</span>
<span class="cm"> *	it is not compiled in by default until callers fixed up and more tested.</span>
<span class="cm"> */</span>
<span class="kt">int</span>
<span class="nf">CIFSSMBQueryReparseLinkInfo</span><span class="p">(</span><span class="k">const</span> <span class="kt">int</span> <span class="n">xid</span><span class="p">,</span> <span class="k">struct</span> <span class="n">cifs_tcon</span> <span class="o">*</span><span class="n">tcon</span><span class="p">,</span>
			<span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">searchName</span><span class="p">,</span>
			<span class="kt">char</span> <span class="o">*</span><span class="n">symlinkinfo</span><span class="p">,</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">buflen</span><span class="p">,</span> <span class="n">__u16</span> <span class="n">fid</span><span class="p">,</span>
			<span class="k">const</span> <span class="k">struct</span> <span class="n">nls_table</span> <span class="o">*</span><span class="n">nls_codepage</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">bytes_returned</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">smb_com_transaction_ioctl_req</span> <span class="o">*</span><span class="n">pSMB</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">smb_com_transaction_ioctl_rsp</span> <span class="o">*</span><span class="n">pSMBr</span><span class="p">;</span>

	<span class="n">cFYI</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;In Windows reparse style QueryLink for path %s&quot;</span><span class="p">,</span> <span class="n">searchName</span><span class="p">);</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">smb_init</span><span class="p">(</span><span class="n">SMB_COM_NT_TRANSACT</span><span class="p">,</span> <span class="mi">23</span><span class="p">,</span> <span class="n">tcon</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">**</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">pSMB</span><span class="p">,</span>
		      <span class="p">(</span><span class="kt">void</span> <span class="o">**</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">pSMBr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">TotalParameterCount</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">TotalDataCount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">MaxParameterCount</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
	<span class="cm">/* BB find exact data count max from sess structure BB */</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">MaxDataCount</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">CIFSMaxBufSize</span> <span class="o">&amp;</span> <span class="mh">0xFFFFFF00</span><span class="p">);</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">MaxSetupCount</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">Reserved</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">ParameterOffset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">DataCount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">DataOffset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">SetupCount</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">SubCommand</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">NT_TRANSACT_IOCTL</span><span class="p">);</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">ParameterCount</span> <span class="o">=</span> <span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">TotalParameterCount</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">FunctionCode</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">FSCTL_GET_REPARSE_POINT</span><span class="p">);</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">IsFsctl</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="cm">/* FSCTL */</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">IsRootFlag</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">Fid</span> <span class="o">=</span> <span class="n">fid</span><span class="p">;</span> <span class="cm">/* file handle always le */</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">ByteCount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">SendReceive</span><span class="p">(</span><span class="n">xid</span><span class="p">,</span> <span class="n">tcon</span><span class="o">-&gt;</span><span class="n">ses</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">smb_hdr</span> <span class="o">*</span><span class="p">)</span> <span class="n">pSMB</span><span class="p">,</span>
			 <span class="p">(</span><span class="k">struct</span> <span class="n">smb_hdr</span> <span class="o">*</span><span class="p">)</span> <span class="n">pSMBr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bytes_returned</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cFYI</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;Send error in QueryReparseLinkInfo = %d&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>		<span class="cm">/* decode response */</span>
		<span class="n">__u32</span> <span class="n">data_offset</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">pSMBr</span><span class="o">-&gt;</span><span class="n">DataOffset</span><span class="p">);</span>
		<span class="n">__u32</span> <span class="n">data_count</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">pSMBr</span><span class="o">-&gt;</span><span class="n">DataCount</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">get_bcc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pSMBr</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span> <span class="o">||</span> <span class="n">data_offset</span> <span class="o">&gt;</span> <span class="mi">512</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* BB also check enough total bytes returned */</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>	<span class="cm">/* bad smb */</span>
			<span class="k">goto</span> <span class="n">qreparse_out</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">data_count</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">data_count</span> <span class="o">&lt;</span> <span class="mi">2048</span><span class="p">))</span> <span class="p">{</span>
			<span class="kt">char</span> <span class="o">*</span><span class="n">end_of_smb</span> <span class="o">=</span> <span class="mi">2</span> <span class="cm">/* sizeof byte count */</span> <span class="o">+</span>
			       <span class="n">get_bcc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pSMBr</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">pSMBr</span><span class="o">-&gt;</span><span class="n">ByteCount</span><span class="p">;</span>

			<span class="k">struct</span> <span class="n">reparse_data</span> <span class="o">*</span><span class="n">reparse_buf</span> <span class="o">=</span>
						<span class="p">(</span><span class="k">struct</span> <span class="n">reparse_data</span> <span class="o">*</span><span class="p">)</span>
						<span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">pSMBr</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">Protocol</span>
								 <span class="o">+</span> <span class="n">data_offset</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">reparse_buf</span> <span class="o">&gt;=</span> <span class="n">end_of_smb</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">qreparse_out</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">reparse_buf</span><span class="o">-&gt;</span><span class="n">LinkNamesBuf</span> <span class="o">+</span>
				<span class="n">reparse_buf</span><span class="o">-&gt;</span><span class="n">TargetNameOffset</span> <span class="o">+</span>
				<span class="n">reparse_buf</span><span class="o">-&gt;</span><span class="n">TargetNameLen</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">end_of_smb</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">cFYI</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;reparse buf beyond SMB&quot;</span><span class="p">);</span>
				<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">qreparse_out</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">pSMBr</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">Flags2</span> <span class="o">&amp;</span> <span class="n">SMBFLG2_UNICODE</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">cifs_from_ucs2</span><span class="p">(</span><span class="n">symlinkinfo</span><span class="p">,</span> <span class="p">(</span><span class="n">__le16</span> <span class="o">*</span><span class="p">)</span>
						<span class="p">(</span><span class="n">reparse_buf</span><span class="o">-&gt;</span><span class="n">LinkNamesBuf</span> <span class="o">+</span>
						<span class="n">reparse_buf</span><span class="o">-&gt;</span><span class="n">TargetNameOffset</span><span class="p">),</span>
						<span class="n">buflen</span><span class="p">,</span>
						<span class="n">reparse_buf</span><span class="o">-&gt;</span><span class="n">TargetNameLen</span><span class="p">,</span>
						<span class="n">nls_codepage</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span> <span class="cm">/* ASCII names */</span>
				<span class="n">strncpy</span><span class="p">(</span><span class="n">symlinkinfo</span><span class="p">,</span>
					<span class="n">reparse_buf</span><span class="o">-&gt;</span><span class="n">LinkNamesBuf</span> <span class="o">+</span>
					<span class="n">reparse_buf</span><span class="o">-&gt;</span><span class="n">TargetNameOffset</span><span class="p">,</span>
					<span class="n">min_t</span><span class="p">(</span><span class="k">const</span> <span class="kt">int</span><span class="p">,</span> <span class="n">buflen</span><span class="p">,</span>
					   <span class="n">reparse_buf</span><span class="o">-&gt;</span><span class="n">TargetNameLen</span><span class="p">));</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
			<span class="n">cFYI</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;Invalid return data count on &quot;</span>
				 <span class="s">&quot;get reparse info ioctl&quot;</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">symlinkinfo</span><span class="p">[</span><span class="n">buflen</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* just in case so the caller</span>
<span class="cm">					does not go off the end of the buffer */</span>
		<span class="n">cFYI</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;readlink result - %s&quot;</span><span class="p">,</span> <span class="n">symlinkinfo</span><span class="p">);</span>
	<span class="p">}</span>

<span class="nl">qreparse_out:</span>
	<span class="n">cifs_buf_release</span><span class="p">(</span><span class="n">pSMB</span><span class="p">);</span>

	<span class="cm">/* Note: On -EAGAIN error only caller can retry on handle based calls</span>
<span class="cm">		since file handle passed in no longer valid */</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* CIFS_SYMLINK_EXPERIMENTAL */</span><span class="cp"> </span><span class="cm">/* BB temporarily unused */</span><span class="cp"></span>

<span class="cp">#ifdef CONFIG_CIFS_POSIX</span>

<span class="cm">/*Convert an Access Control Entry from wire format to local POSIX xattr format*/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">cifs_convert_ace</span><span class="p">(</span><span class="n">posix_acl_xattr_entry</span> <span class="o">*</span><span class="n">ace</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">cifs_posix_ace</span> <span class="o">*</span><span class="n">cifs_ace</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* u8 cifs fields do not need le conversion */</span>
	<span class="n">ace</span><span class="o">-&gt;</span><span class="n">e_perm</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">cifs_ace</span><span class="o">-&gt;</span><span class="n">cifs_e_perm</span><span class="p">);</span>
	<span class="n">ace</span><span class="o">-&gt;</span><span class="n">e_tag</span>  <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">cifs_ace</span><span class="o">-&gt;</span><span class="n">cifs_e_tag</span><span class="p">);</span>
	<span class="n">ace</span><span class="o">-&gt;</span><span class="n">e_id</span>   <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">le64_to_cpu</span><span class="p">(</span><span class="n">cifs_ace</span><span class="o">-&gt;</span><span class="n">cifs_uid</span><span class="p">));</span>
	<span class="cm">/* cFYI(1, &quot;perm %d tag %d id %d&quot;,ace-&gt;e_perm,ace-&gt;e_tag,ace-&gt;e_id); */</span>

	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Convert ACL from CIFS POSIX wire format to local Linux POSIX ACL xattr */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">cifs_copy_posix_acl</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">trgt</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">src</span><span class="p">,</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">buflen</span><span class="p">,</span>
			       <span class="k">const</span> <span class="kt">int</span> <span class="n">acl_type</span><span class="p">,</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">size_of_data_area</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">size</span> <span class="o">=</span>  <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">__u16</span> <span class="n">count</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cifs_posix_ace</span> <span class="o">*</span><span class="n">pACE</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cifs_posix_acl</span> <span class="o">*</span><span class="n">cifs_acl</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">cifs_posix_acl</span> <span class="o">*</span><span class="p">)</span><span class="n">src</span><span class="p">;</span>
	<span class="n">posix_acl_xattr_header</span> <span class="o">*</span><span class="n">local_acl</span> <span class="o">=</span> <span class="p">(</span><span class="n">posix_acl_xattr_header</span> <span class="o">*</span><span class="p">)</span><span class="n">trgt</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">cifs_acl</span><span class="o">-&gt;</span><span class="n">version</span><span class="p">)</span> <span class="o">!=</span> <span class="n">CIFS_ACL_VERSION</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">acl_type</span> <span class="o">&amp;</span> <span class="n">ACL_TYPE_ACCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">count</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">cifs_acl</span><span class="o">-&gt;</span><span class="n">access_entry_count</span><span class="p">);</span>
		<span class="n">pACE</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">cifs_acl</span><span class="o">-&gt;</span><span class="n">ace_array</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
		<span class="n">size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">cifs_posix_acl</span><span class="p">);</span>
		<span class="n">size</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">cifs_posix_ace</span><span class="p">)</span> <span class="o">*</span> <span class="n">count</span><span class="p">;</span>
		<span class="cm">/* check if we would go beyond end of SMB */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">size_of_data_area</span> <span class="o">&lt;</span> <span class="n">size</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">cFYI</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;bad CIFS POSIX ACL size %d vs. %d&quot;</span><span class="p">,</span>
				<span class="n">size_of_data_area</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">acl_type</span> <span class="o">&amp;</span> <span class="n">ACL_TYPE_DEFAULT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">count</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">cifs_acl</span><span class="o">-&gt;</span><span class="n">access_entry_count</span><span class="p">);</span>
		<span class="n">size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">cifs_posix_acl</span><span class="p">);</span>
		<span class="n">size</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">cifs_posix_ace</span><span class="p">)</span> <span class="o">*</span> <span class="n">count</span><span class="p">;</span>
<span class="cm">/* skip past access ACEs to get to default ACEs */</span>
		<span class="n">pACE</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">cifs_acl</span><span class="o">-&gt;</span><span class="n">ace_array</span><span class="p">[</span><span class="n">count</span><span class="p">];</span>
		<span class="n">count</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">cifs_acl</span><span class="o">-&gt;</span><span class="n">default_entry_count</span><span class="p">);</span>
		<span class="n">size</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">cifs_posix_ace</span><span class="p">)</span> <span class="o">*</span> <span class="n">count</span><span class="p">;</span>
		<span class="cm">/* check if we would go beyond end of SMB */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">size_of_data_area</span> <span class="o">&lt;</span> <span class="n">size</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* illegal type */</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">size</span> <span class="o">=</span> <span class="n">posix_acl_xattr_size</span><span class="p">(</span><span class="n">count</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">buflen</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">local_acl</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* used to query ACL EA size */</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">&gt;</span> <span class="n">buflen</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ERANGE</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="cm">/* buffer big enough */</span> <span class="p">{</span>
		<span class="n">local_acl</span><span class="o">-&gt;</span><span class="n">a_version</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">POSIX_ACL_XATTR_VERSION</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">count</span> <span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">cifs_convert_ace</span><span class="p">(</span><span class="o">&amp;</span><span class="n">local_acl</span><span class="o">-&gt;</span><span class="n">a_entries</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">pACE</span><span class="p">);</span>
			<span class="n">pACE</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">size</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">__u16</span> <span class="nf">convert_ace_to_cifs_ace</span><span class="p">(</span><span class="k">struct</span> <span class="n">cifs_posix_ace</span> <span class="o">*</span><span class="n">cifs_ace</span><span class="p">,</span>
				     <span class="k">const</span> <span class="n">posix_acl_xattr_entry</span> <span class="o">*</span><span class="n">local_ace</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">__u16</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* 0 = ACL converted ok */</span>

	<span class="n">cifs_ace</span><span class="o">-&gt;</span><span class="n">cifs_e_perm</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">local_ace</span><span class="o">-&gt;</span><span class="n">e_perm</span><span class="p">);</span>
	<span class="n">cifs_ace</span><span class="o">-&gt;</span><span class="n">cifs_e_tag</span> <span class="o">=</span>  <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">local_ace</span><span class="o">-&gt;</span><span class="n">e_tag</span><span class="p">);</span>
	<span class="cm">/* BB is there a better way to handle the large uid? */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">local_ace</span><span class="o">-&gt;</span><span class="n">e_id</span> <span class="o">==</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
	<span class="cm">/* Probably no need to le convert -1 on any arch but can not hurt */</span>
		<span class="n">cifs_ace</span><span class="o">-&gt;</span><span class="n">cifs_uid</span> <span class="o">=</span> <span class="n">cpu_to_le64</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">cifs_ace</span><span class="o">-&gt;</span><span class="n">cifs_uid</span> <span class="o">=</span> <span class="n">cpu_to_le64</span><span class="p">(</span><span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">local_ace</span><span class="o">-&gt;</span><span class="n">e_id</span><span class="p">));</span>
	<span class="cm">/*cFYI(1, &quot;perm %d tag %d id %d&quot;,ace-&gt;e_perm,ace-&gt;e_tag,ace-&gt;e_id);*/</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Convert ACL from local Linux POSIX xattr to CIFS POSIX ACL wire format */</span>
<span class="k">static</span> <span class="n">__u16</span> <span class="nf">ACL_to_cifs_posix</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">parm_data</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">pACL</span><span class="p">,</span>
			       <span class="k">const</span> <span class="kt">int</span> <span class="n">buflen</span><span class="p">,</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">acl_type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">__u16</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cifs_posix_acl</span> <span class="o">*</span><span class="n">cifs_acl</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">cifs_posix_acl</span> <span class="o">*</span><span class="p">)</span><span class="n">parm_data</span><span class="p">;</span>
	<span class="n">posix_acl_xattr_header</span> <span class="o">*</span><span class="n">local_acl</span> <span class="o">=</span> <span class="p">(</span><span class="n">posix_acl_xattr_header</span> <span class="o">*</span><span class="p">)</span><span class="n">pACL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">count</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">buflen</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">pACL</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">cifs_acl</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">count</span> <span class="o">=</span> <span class="n">posix_acl_xattr_count</span><span class="p">((</span><span class="kt">size_t</span><span class="p">)</span><span class="n">buflen</span><span class="p">);</span>
	<span class="n">cFYI</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;setting acl with %d entries from buf of length %d and &quot;</span>
		<span class="s">&quot;version of %d&quot;</span><span class="p">,</span>
		<span class="n">count</span><span class="p">,</span> <span class="n">buflen</span><span class="p">,</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">local_acl</span><span class="o">-&gt;</span><span class="n">a_version</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">local_acl</span><span class="o">-&gt;</span><span class="n">a_version</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cFYI</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;unknown POSIX ACL version %d&quot;</span><span class="p">,</span>
		     <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">local_acl</span><span class="o">-&gt;</span><span class="n">a_version</span><span class="p">));</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">cifs_acl</span><span class="o">-&gt;</span><span class="n">version</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">acl_type</span> <span class="o">==</span> <span class="n">ACL_TYPE_ACCESS</span><span class="p">)</span>
		<span class="n">cifs_acl</span><span class="o">-&gt;</span><span class="n">access_entry_count</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">count</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">acl_type</span> <span class="o">==</span> <span class="n">ACL_TYPE_DEFAULT</span><span class="p">)</span>
		<span class="n">cifs_acl</span><span class="o">-&gt;</span><span class="n">default_entry_count</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">count</span><span class="p">);</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">cFYI</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;unknown ACL type %d&quot;</span><span class="p">,</span> <span class="n">acl_type</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">convert_ace_to_cifs_ace</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cifs_acl</span><span class="o">-&gt;</span><span class="n">ace_array</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
					<span class="o">&amp;</span><span class="n">local_acl</span><span class="o">-&gt;</span><span class="n">a_entries</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* ACE not converted */</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="p">(</span><span class="n">__u16</span><span class="p">)(</span><span class="n">count</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">cifs_posix_ace</span><span class="p">));</span>
		<span class="n">rc</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">cifs_posix_acl</span><span class="p">);</span>
		<span class="cm">/* BB add check to make sure ACL does not overflow SMB */</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="nf">CIFSSMBGetPosixACL</span><span class="p">(</span><span class="k">const</span> <span class="kt">int</span> <span class="n">xid</span><span class="p">,</span> <span class="k">struct</span> <span class="n">cifs_tcon</span> <span class="o">*</span><span class="n">tcon</span><span class="p">,</span>
		   <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">searchName</span><span class="p">,</span>
		   <span class="kt">char</span> <span class="o">*</span><span class="n">acl_inf</span><span class="p">,</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">buflen</span><span class="p">,</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">acl_type</span><span class="p">,</span>
		   <span class="k">const</span> <span class="k">struct</span> <span class="n">nls_table</span> <span class="o">*</span><span class="n">nls_codepage</span><span class="p">,</span> <span class="kt">int</span> <span class="n">remap</span><span class="p">)</span>
<span class="p">{</span>
<span class="cm">/* SMB_QUERY_POSIX_ACL */</span>
	<span class="n">TRANSACTION2_QPI_REQ</span> <span class="o">*</span><span class="n">pSMB</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">TRANSACTION2_QPI_RSP</span> <span class="o">*</span><span class="n">pSMBr</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">bytes_returned</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">name_len</span><span class="p">;</span>
	<span class="n">__u16</span> <span class="n">params</span><span class="p">,</span> <span class="n">byte_count</span><span class="p">;</span>

	<span class="n">cFYI</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;In GetPosixACL (Unix) for path %s&quot;</span><span class="p">,</span> <span class="n">searchName</span><span class="p">);</span>

<span class="nl">queryAclRetry:</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">smb_init</span><span class="p">(</span><span class="n">SMB_COM_TRANSACTION2</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="n">tcon</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">**</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">pSMB</span><span class="p">,</span>
		<span class="p">(</span><span class="kt">void</span> <span class="o">**</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">pSMBr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">Flags2</span> <span class="o">&amp;</span> <span class="n">SMBFLG2_UNICODE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">name_len</span> <span class="o">=</span>
			<span class="n">cifsConvertToUTF16</span><span class="p">((</span><span class="n">__le16</span> <span class="o">*</span><span class="p">)</span> <span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">FileName</span><span class="p">,</span>
					   <span class="n">searchName</span><span class="p">,</span> <span class="n">PATH_MAX</span><span class="p">,</span> <span class="n">nls_codepage</span><span class="p">,</span>
					   <span class="n">remap</span><span class="p">);</span>
		<span class="n">name_len</span><span class="o">++</span><span class="p">;</span>     <span class="cm">/* trailing null */</span>
		<span class="n">name_len</span> <span class="o">*=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">FileName</span><span class="p">[</span><span class="n">name_len</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">FileName</span><span class="p">[</span><span class="n">name_len</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>	<span class="cm">/* BB improve the check for buffer overruns BB */</span>
		<span class="n">name_len</span> <span class="o">=</span> <span class="n">strnlen</span><span class="p">(</span><span class="n">searchName</span><span class="p">,</span> <span class="n">PATH_MAX</span><span class="p">);</span>
		<span class="n">name_len</span><span class="o">++</span><span class="p">;</span>     <span class="cm">/* trailing null */</span>
		<span class="n">strncpy</span><span class="p">(</span><span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">FileName</span><span class="p">,</span> <span class="n">searchName</span><span class="p">,</span> <span class="n">name_len</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">params</span> <span class="o">=</span> <span class="mi">2</span> <span class="cm">/* level */</span>  <span class="o">+</span> <span class="mi">4</span> <span class="cm">/* rsrvd */</span>  <span class="o">+</span> <span class="n">name_len</span> <span class="cm">/* incl null */</span> <span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">TotalDataCount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">MaxParameterCount</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
	<span class="cm">/* BB find exact max data count below from sess structure BB */</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">MaxDataCount</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="mi">4000</span><span class="p">);</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">MaxSetupCount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">Reserved</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">Flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">Timeout</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">Reserved2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">ParameterOffset</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span>
		<span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">smb_com_transaction2_qpi_req</span><span class="p">,</span>
			 <span class="n">InformationLevel</span><span class="p">)</span> <span class="o">-</span> <span class="mi">4</span><span class="p">);</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">DataCount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">DataOffset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">SetupCount</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">Reserved3</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">SubCommand</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">TRANS2_QUERY_PATH_INFORMATION</span><span class="p">);</span>
	<span class="n">byte_count</span> <span class="o">=</span> <span class="n">params</span> <span class="o">+</span> <span class="mi">1</span> <span class="cm">/* pad */</span> <span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">TotalParameterCount</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">params</span><span class="p">);</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">ParameterCount</span> <span class="o">=</span> <span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">TotalParameterCount</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">InformationLevel</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">SMB_QUERY_POSIX_ACL</span><span class="p">);</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">Reserved4</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">inc_rfc1001_len</span><span class="p">(</span><span class="n">pSMB</span><span class="p">,</span> <span class="n">byte_count</span><span class="p">);</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">ByteCount</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">byte_count</span><span class="p">);</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">SendReceive</span><span class="p">(</span><span class="n">xid</span><span class="p">,</span> <span class="n">tcon</span><span class="o">-&gt;</span><span class="n">ses</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">smb_hdr</span> <span class="o">*</span><span class="p">)</span> <span class="n">pSMB</span><span class="p">,</span>
		<span class="p">(</span><span class="k">struct</span> <span class="n">smb_hdr</span> <span class="o">*</span><span class="p">)</span> <span class="n">pSMBr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bytes_returned</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">cifs_stats_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tcon</span><span class="o">-&gt;</span><span class="n">num_acl_get</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cFYI</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;Send error in Query POSIX ACL = %d&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* decode response */</span>

		<span class="n">rc</span> <span class="o">=</span> <span class="n">validate_t2</span><span class="p">((</span><span class="k">struct</span> <span class="n">smb_t2_rsp</span> <span class="o">*</span><span class="p">)</span><span class="n">pSMBr</span><span class="p">);</span>
		<span class="cm">/* BB also check enough total bytes returned */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">||</span> <span class="n">get_bcc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pSMBr</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>      <span class="cm">/* bad smb */</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="n">__u16</span> <span class="n">data_offset</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">pSMBr</span><span class="o">-&gt;</span><span class="n">t2</span><span class="p">.</span><span class="n">DataOffset</span><span class="p">);</span>
			<span class="n">__u16</span> <span class="n">count</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">pSMBr</span><span class="o">-&gt;</span><span class="n">t2</span><span class="p">.</span><span class="n">DataCount</span><span class="p">);</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="n">cifs_copy_posix_acl</span><span class="p">(</span><span class="n">acl_inf</span><span class="p">,</span>
				<span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">pSMBr</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">Protocol</span><span class="o">+</span><span class="n">data_offset</span><span class="p">,</span>
				<span class="n">buflen</span><span class="p">,</span> <span class="n">acl_type</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">cifs_buf_release</span><span class="p">(</span><span class="n">pSMB</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">queryAclRetry</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="nf">CIFSSMBSetPosixACL</span><span class="p">(</span><span class="k">const</span> <span class="kt">int</span> <span class="n">xid</span><span class="p">,</span> <span class="k">struct</span> <span class="n">cifs_tcon</span> <span class="o">*</span><span class="n">tcon</span><span class="p">,</span>
		   <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">fileName</span><span class="p">,</span>
		   <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">local_acl</span><span class="p">,</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">buflen</span><span class="p">,</span>
		   <span class="k">const</span> <span class="kt">int</span> <span class="n">acl_type</span><span class="p">,</span>
		   <span class="k">const</span> <span class="k">struct</span> <span class="n">nls_table</span> <span class="o">*</span><span class="n">nls_codepage</span><span class="p">,</span> <span class="kt">int</span> <span class="n">remap</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">smb_com_transaction2_spi_req</span> <span class="o">*</span><span class="n">pSMB</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">smb_com_transaction2_spi_rsp</span> <span class="o">*</span><span class="n">pSMBr</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">parm_data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">name_len</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">bytes_returned</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">__u16</span> <span class="n">params</span><span class="p">,</span> <span class="n">byte_count</span><span class="p">,</span> <span class="n">data_count</span><span class="p">,</span> <span class="n">param_offset</span><span class="p">,</span> <span class="n">offset</span><span class="p">;</span>

	<span class="n">cFYI</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;In SetPosixACL (Unix) for path %s&quot;</span><span class="p">,</span> <span class="n">fileName</span><span class="p">);</span>
<span class="nl">setAclRetry:</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">smb_init</span><span class="p">(</span><span class="n">SMB_COM_TRANSACTION2</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="n">tcon</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">**</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">pSMB</span><span class="p">,</span>
		      <span class="p">(</span><span class="kt">void</span> <span class="o">**</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">pSMBr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">Flags2</span> <span class="o">&amp;</span> <span class="n">SMBFLG2_UNICODE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">name_len</span> <span class="o">=</span>
			<span class="n">cifsConvertToUTF16</span><span class="p">((</span><span class="n">__le16</span> <span class="o">*</span><span class="p">)</span> <span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">FileName</span><span class="p">,</span> <span class="n">fileName</span><span class="p">,</span>
					   <span class="n">PATH_MAX</span><span class="p">,</span> <span class="n">nls_codepage</span><span class="p">,</span> <span class="n">remap</span><span class="p">);</span>
		<span class="n">name_len</span><span class="o">++</span><span class="p">;</span>     <span class="cm">/* trailing null */</span>
		<span class="n">name_len</span> <span class="o">*=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>	<span class="cm">/* BB improve the check for buffer overruns BB */</span>
		<span class="n">name_len</span> <span class="o">=</span> <span class="n">strnlen</span><span class="p">(</span><span class="n">fileName</span><span class="p">,</span> <span class="n">PATH_MAX</span><span class="p">);</span>
		<span class="n">name_len</span><span class="o">++</span><span class="p">;</span>     <span class="cm">/* trailing null */</span>
		<span class="n">strncpy</span><span class="p">(</span><span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">FileName</span><span class="p">,</span> <span class="n">fileName</span><span class="p">,</span> <span class="n">name_len</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">params</span> <span class="o">=</span> <span class="mi">6</span> <span class="o">+</span> <span class="n">name_len</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">MaxParameterCount</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
	<span class="cm">/* BB find max SMB size from sess */</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">MaxDataCount</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="mi">1000</span><span class="p">);</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">MaxSetupCount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">Reserved</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">Flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">Timeout</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">Reserved2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">param_offset</span> <span class="o">=</span> <span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">smb_com_transaction2_spi_req</span><span class="p">,</span>
				<span class="n">InformationLevel</span><span class="p">)</span> <span class="o">-</span> <span class="mi">4</span><span class="p">;</span>
	<span class="n">offset</span> <span class="o">=</span> <span class="n">param_offset</span> <span class="o">+</span> <span class="n">params</span><span class="p">;</span>
	<span class="n">parm_data</span> <span class="o">=</span> <span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">Protocol</span><span class="p">)</span> <span class="o">+</span> <span class="n">offset</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">ParameterOffset</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">param_offset</span><span class="p">);</span>

	<span class="cm">/* convert to on the wire format for POSIX ACL */</span>
	<span class="n">data_count</span> <span class="o">=</span> <span class="n">ACL_to_cifs_posix</span><span class="p">(</span><span class="n">parm_data</span><span class="p">,</span> <span class="n">local_acl</span><span class="p">,</span> <span class="n">buflen</span><span class="p">,</span> <span class="n">acl_type</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">data_count</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">setACLerrorExit</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">DataOffset</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">offset</span><span class="p">);</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">SetupCount</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">Reserved3</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">SubCommand</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">TRANS2_SET_PATH_INFORMATION</span><span class="p">);</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">InformationLevel</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">SMB_SET_POSIX_ACL</span><span class="p">);</span>
	<span class="n">byte_count</span> <span class="o">=</span> <span class="mi">3</span> <span class="cm">/* pad */</span>  <span class="o">+</span> <span class="n">params</span> <span class="o">+</span> <span class="n">data_count</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">DataCount</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">data_count</span><span class="p">);</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">TotalDataCount</span> <span class="o">=</span> <span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">DataCount</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">ParameterCount</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">params</span><span class="p">);</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">TotalParameterCount</span> <span class="o">=</span> <span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">ParameterCount</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">Reserved4</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">inc_rfc1001_len</span><span class="p">(</span><span class="n">pSMB</span><span class="p">,</span> <span class="n">byte_count</span><span class="p">);</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">ByteCount</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">byte_count</span><span class="p">);</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">SendReceive</span><span class="p">(</span><span class="n">xid</span><span class="p">,</span> <span class="n">tcon</span><span class="o">-&gt;</span><span class="n">ses</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">smb_hdr</span> <span class="o">*</span><span class="p">)</span> <span class="n">pSMB</span><span class="p">,</span>
			 <span class="p">(</span><span class="k">struct</span> <span class="n">smb_hdr</span> <span class="o">*</span><span class="p">)</span> <span class="n">pSMBr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bytes_returned</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="n">cFYI</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;Set POSIX ACL returned %d&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>

<span class="nl">setACLerrorExit:</span>
	<span class="n">cifs_buf_release</span><span class="p">(</span><span class="n">pSMB</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">setAclRetry</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* BB fix tabs in this function FIXME BB */</span>
<span class="kt">int</span>
<span class="nf">CIFSGetExtAttr</span><span class="p">(</span><span class="k">const</span> <span class="kt">int</span> <span class="n">xid</span><span class="p">,</span> <span class="k">struct</span> <span class="n">cifs_tcon</span> <span class="o">*</span><span class="n">tcon</span><span class="p">,</span>
	       <span class="k">const</span> <span class="kt">int</span> <span class="n">netfid</span><span class="p">,</span> <span class="n">__u64</span> <span class="o">*</span><span class="n">pExtAttrBits</span><span class="p">,</span> <span class="n">__u64</span> <span class="o">*</span><span class="n">pMask</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">smb_t2_qfi_req</span> <span class="o">*</span><span class="n">pSMB</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">smb_t2_qfi_rsp</span> <span class="o">*</span><span class="n">pSMBr</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">bytes_returned</span><span class="p">;</span>
	<span class="n">__u16</span> <span class="n">params</span><span class="p">,</span> <span class="n">byte_count</span><span class="p">;</span>

	<span class="n">cFYI</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;In GetExtAttr&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tcon</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

<span class="nl">GetExtAttrRetry:</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">smb_init</span><span class="p">(</span><span class="n">SMB_COM_TRANSACTION2</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="n">tcon</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">**</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">pSMB</span><span class="p">,</span>
			<span class="p">(</span><span class="kt">void</span> <span class="o">**</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">pSMBr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">params</span> <span class="o">=</span> <span class="mi">2</span> <span class="cm">/* level */</span> <span class="o">+</span> <span class="mi">2</span> <span class="cm">/* fid */</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">t2</span><span class="p">.</span><span class="n">TotalDataCount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">t2</span><span class="p">.</span><span class="n">MaxParameterCount</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="mi">4</span><span class="p">);</span>
	<span class="cm">/* BB find exact max data count below from sess structure BB */</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">t2</span><span class="p">.</span><span class="n">MaxDataCount</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="mi">4000</span><span class="p">);</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">t2</span><span class="p">.</span><span class="n">MaxSetupCount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">t2</span><span class="p">.</span><span class="n">Reserved</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">t2</span><span class="p">.</span><span class="n">Flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">t2</span><span class="p">.</span><span class="n">Timeout</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">t2</span><span class="p">.</span><span class="n">Reserved2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">t2</span><span class="p">.</span><span class="n">ParameterOffset</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">smb_t2_qfi_req</span><span class="p">,</span>
					       <span class="n">Fid</span><span class="p">)</span> <span class="o">-</span> <span class="mi">4</span><span class="p">);</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">t2</span><span class="p">.</span><span class="n">DataCount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">t2</span><span class="p">.</span><span class="n">DataOffset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">t2</span><span class="p">.</span><span class="n">SetupCount</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">t2</span><span class="p">.</span><span class="n">Reserved3</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">t2</span><span class="p">.</span><span class="n">SubCommand</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">TRANS2_QUERY_FILE_INFORMATION</span><span class="p">);</span>
	<span class="n">byte_count</span> <span class="o">=</span> <span class="n">params</span> <span class="o">+</span> <span class="mi">1</span> <span class="cm">/* pad */</span> <span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">t2</span><span class="p">.</span><span class="n">TotalParameterCount</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">params</span><span class="p">);</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">t2</span><span class="p">.</span><span class="n">ParameterCount</span> <span class="o">=</span> <span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">t2</span><span class="p">.</span><span class="n">TotalParameterCount</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">InformationLevel</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">SMB_QUERY_ATTR_FLAGS</span><span class="p">);</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">Pad</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">Fid</span> <span class="o">=</span> <span class="n">netfid</span><span class="p">;</span>
	<span class="n">inc_rfc1001_len</span><span class="p">(</span><span class="n">pSMB</span><span class="p">,</span> <span class="n">byte_count</span><span class="p">);</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">t2</span><span class="p">.</span><span class="n">ByteCount</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">byte_count</span><span class="p">);</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">SendReceive</span><span class="p">(</span><span class="n">xid</span><span class="p">,</span> <span class="n">tcon</span><span class="o">-&gt;</span><span class="n">ses</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">smb_hdr</span> <span class="o">*</span><span class="p">)</span> <span class="n">pSMB</span><span class="p">,</span>
			 <span class="p">(</span><span class="k">struct</span> <span class="n">smb_hdr</span> <span class="o">*</span><span class="p">)</span> <span class="n">pSMBr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bytes_returned</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cFYI</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;error %d in GetExtAttr&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* decode response */</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">validate_t2</span><span class="p">((</span><span class="k">struct</span> <span class="n">smb_t2_rsp</span> <span class="o">*</span><span class="p">)</span><span class="n">pSMBr</span><span class="p">);</span>
		<span class="cm">/* BB also check enough total bytes returned */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">||</span> <span class="n">get_bcc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pSMBr</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span>
			<span class="cm">/* If rc should we check for EOPNOSUPP and</span>
<span class="cm">			   disable the srvino flag? or in caller? */</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>      <span class="cm">/* bad smb */</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="n">__u16</span> <span class="n">data_offset</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">pSMBr</span><span class="o">-&gt;</span><span class="n">t2</span><span class="p">.</span><span class="n">DataOffset</span><span class="p">);</span>
			<span class="n">__u16</span> <span class="n">count</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">pSMBr</span><span class="o">-&gt;</span><span class="n">t2</span><span class="p">.</span><span class="n">DataCount</span><span class="p">);</span>
			<span class="k">struct</span> <span class="n">file_chattr_info</span> <span class="o">*</span><span class="n">pfinfo</span><span class="p">;</span>
			<span class="cm">/* BB Do we need a cast or hash here ? */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">!=</span> <span class="mi">16</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">cFYI</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;Illegal size ret in GetExtAttr&quot;</span><span class="p">);</span>
				<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">GetExtAttrOut</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">pfinfo</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">file_chattr_info</span> <span class="o">*</span><span class="p">)</span>
				 <span class="p">(</span><span class="n">data_offset</span> <span class="o">+</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">pSMBr</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">Protocol</span><span class="p">);</span>
			<span class="o">*</span><span class="n">pExtAttrBits</span> <span class="o">=</span> <span class="n">le64_to_cpu</span><span class="p">(</span><span class="n">pfinfo</span><span class="o">-&gt;</span><span class="n">mode</span><span class="p">);</span>
			<span class="o">*</span><span class="n">pMask</span> <span class="o">=</span> <span class="n">le64_to_cpu</span><span class="p">(</span><span class="n">pfinfo</span><span class="o">-&gt;</span><span class="n">mask</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="nl">GetExtAttrOut:</span>
	<span class="n">cifs_buf_release</span><span class="p">(</span><span class="n">pSMB</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">GetExtAttrRetry</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#endif </span><span class="cm">/* CONFIG_POSIX */</span><span class="cp"></span>

<span class="cp">#ifdef CONFIG_CIFS_ACL</span>
<span class="cm">/*</span>
<span class="cm"> * Initialize NT TRANSACT SMB into small smb request buffer.  This assumes that</span>
<span class="cm"> * all NT TRANSACTS that we init here have total parm and data under about 400</span>
<span class="cm"> * bytes (to fit in small cifs buffer size), which is the case so far, it</span>
<span class="cm"> * easily fits. NB: Setup words themselves and ByteCount MaxSetupCount (size of</span>
<span class="cm"> * returned setup area) and MaxParameterCount (returned parms size) must be set</span>
<span class="cm"> * by caller</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">smb_init_nttransact</span><span class="p">(</span><span class="k">const</span> <span class="n">__u16</span> <span class="n">sub_command</span><span class="p">,</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">setup_count</span><span class="p">,</span>
		   <span class="k">const</span> <span class="kt">int</span> <span class="n">parm_len</span><span class="p">,</span> <span class="k">struct</span> <span class="n">cifs_tcon</span> <span class="o">*</span><span class="n">tcon</span><span class="p">,</span>
		   <span class="kt">void</span> <span class="o">**</span><span class="n">ret_buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>
	<span class="n">__u32</span> <span class="n">temp_offset</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">smb_com_ntransact_req</span> <span class="o">*</span><span class="n">pSMB</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">small_smb_init</span><span class="p">(</span><span class="n">SMB_COM_NT_TRANSACT</span><span class="p">,</span> <span class="mi">19</span> <span class="o">+</span> <span class="n">setup_count</span><span class="p">,</span> <span class="n">tcon</span><span class="p">,</span>
				<span class="p">(</span><span class="kt">void</span> <span class="o">**</span><span class="p">)</span><span class="o">&amp;</span><span class="n">pSMB</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
	<span class="o">*</span><span class="n">ret_buf</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">pSMB</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">Reserved</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">TotalParameterCount</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">parm_len</span><span class="p">);</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">TotalDataCount</span>  <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">MaxDataCount</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">CIFSMaxBufSize</span> <span class="o">&amp;</span> <span class="mh">0xFFFFFF00</span><span class="p">);</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">ParameterCount</span> <span class="o">=</span> <span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">TotalParameterCount</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">DataCount</span>  <span class="o">=</span> <span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">TotalDataCount</span><span class="p">;</span>
	<span class="n">temp_offset</span> <span class="o">=</span> <span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">smb_com_ntransact_req</span><span class="p">,</span> <span class="n">Parms</span><span class="p">)</span> <span class="o">+</span>
			<span class="p">(</span><span class="n">setup_count</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span> <span class="o">-</span> <span class="mi">4</span> <span class="cm">/* for rfc1001 length itself */</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">ParameterOffset</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">temp_offset</span><span class="p">);</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">DataOffset</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">temp_offset</span> <span class="o">+</span> <span class="n">parm_len</span><span class="p">);</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">SetupCount</span> <span class="o">=</span> <span class="n">setup_count</span><span class="p">;</span> <span class="cm">/* no need to le convert byte fields */</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">SubCommand</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">sub_command</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">validate_ntransact</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">ppparm</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">ppdata</span><span class="p">,</span>
		   <span class="n">__u32</span> <span class="o">*</span><span class="n">pparmlen</span><span class="p">,</span> <span class="n">__u32</span> <span class="o">*</span><span class="n">pdatalen</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">end_of_smb</span><span class="p">;</span>
	<span class="n">__u32</span> <span class="n">data_count</span><span class="p">,</span> <span class="n">data_offset</span><span class="p">,</span> <span class="n">parm_count</span><span class="p">,</span> <span class="n">parm_offset</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">smb_com_ntransact_rsp</span> <span class="o">*</span><span class="n">pSMBr</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">bcc</span><span class="p">;</span>

	<span class="o">*</span><span class="n">pdatalen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="o">*</span><span class="n">pparmlen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">buf</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">pSMBr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">smb_com_ntransact_rsp</span> <span class="o">*</span><span class="p">)</span><span class="n">buf</span><span class="p">;</span>

	<span class="n">bcc</span> <span class="o">=</span> <span class="n">get_bcc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pSMBr</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">);</span>
	<span class="n">end_of_smb</span> <span class="o">=</span> <span class="mi">2</span> <span class="cm">/* sizeof byte count */</span> <span class="o">+</span> <span class="n">bcc</span> <span class="o">+</span>
			<span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">pSMBr</span><span class="o">-&gt;</span><span class="n">ByteCount</span><span class="p">;</span>

	<span class="n">data_offset</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">pSMBr</span><span class="o">-&gt;</span><span class="n">DataOffset</span><span class="p">);</span>
	<span class="n">data_count</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">pSMBr</span><span class="o">-&gt;</span><span class="n">DataCount</span><span class="p">);</span>
	<span class="n">parm_offset</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">pSMBr</span><span class="o">-&gt;</span><span class="n">ParameterOffset</span><span class="p">);</span>
	<span class="n">parm_count</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">pSMBr</span><span class="o">-&gt;</span><span class="n">ParameterCount</span><span class="p">);</span>

	<span class="o">*</span><span class="n">ppparm</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">pSMBr</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">Protocol</span> <span class="o">+</span> <span class="n">parm_offset</span><span class="p">;</span>
	<span class="o">*</span><span class="n">ppdata</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">pSMBr</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">Protocol</span> <span class="o">+</span> <span class="n">data_offset</span><span class="p">;</span>

	<span class="cm">/* should we also check that parm and data areas do not overlap? */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">ppparm</span> <span class="o">&gt;</span> <span class="n">end_of_smb</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cFYI</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;parms start after end of smb&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">parm_count</span> <span class="o">+</span> <span class="o">*</span><span class="n">ppparm</span> <span class="o">&gt;</span> <span class="n">end_of_smb</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cFYI</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;parm end after end of smb&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">ppdata</span> <span class="o">&gt;</span> <span class="n">end_of_smb</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cFYI</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;data starts after end of smb&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">data_count</span> <span class="o">+</span> <span class="o">*</span><span class="n">ppdata</span> <span class="o">&gt;</span> <span class="n">end_of_smb</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cFYI</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;data %p + count %d (%p) past smb end %p start %p&quot;</span><span class="p">,</span>
			<span class="o">*</span><span class="n">ppdata</span><span class="p">,</span> <span class="n">data_count</span><span class="p">,</span> <span class="p">(</span><span class="n">data_count</span> <span class="o">+</span> <span class="o">*</span><span class="n">ppdata</span><span class="p">),</span>
			<span class="n">end_of_smb</span><span class="p">,</span> <span class="n">pSMBr</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">parm_count</span> <span class="o">+</span> <span class="n">data_count</span> <span class="o">&gt;</span> <span class="n">bcc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cFYI</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;parm count and data count larger than SMB&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="o">*</span><span class="n">pdatalen</span> <span class="o">=</span> <span class="n">data_count</span><span class="p">;</span>
	<span class="o">*</span><span class="n">pparmlen</span> <span class="o">=</span> <span class="n">parm_count</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Get Security Descriptor (by handle) from remote server for a file or dir */</span>
<span class="kt">int</span>
<span class="nf">CIFSSMBGetCIFSACL</span><span class="p">(</span><span class="k">const</span> <span class="kt">int</span> <span class="n">xid</span><span class="p">,</span> <span class="k">struct</span> <span class="n">cifs_tcon</span> <span class="o">*</span><span class="n">tcon</span><span class="p">,</span> <span class="n">__u16</span> <span class="n">fid</span><span class="p">,</span>
		  <span class="k">struct</span> <span class="n">cifs_ntsd</span> <span class="o">**</span><span class="n">acl_inf</span><span class="p">,</span> <span class="n">__u32</span> <span class="o">*</span><span class="n">pbuflen</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">buf_type</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">QUERY_SEC_DESC_REQ</span> <span class="o">*</span><span class="n">pSMB</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">kvec</span> <span class="n">iov</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>

	<span class="n">cFYI</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;GetCifsACL&quot;</span><span class="p">);</span>

	<span class="o">*</span><span class="n">pbuflen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="o">*</span><span class="n">acl_inf</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">smb_init_nttransact</span><span class="p">(</span><span class="n">NT_TRANSACT_QUERY_SECURITY_DESC</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
			<span class="mi">8</span> <span class="cm">/* parm len */</span><span class="p">,</span> <span class="n">tcon</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">**</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">pSMB</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">MaxParameterCount</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="mi">4</span><span class="p">);</span>
	<span class="cm">/* BB TEST with big acls that might need to be e.g. larger than 16K */</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">MaxSetupCount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">Fid</span> <span class="o">=</span> <span class="n">fid</span><span class="p">;</span> <span class="cm">/* file handle always le */</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">AclFlags</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">CIFS_ACL_OWNER</span> <span class="o">|</span> <span class="n">CIFS_ACL_GROUP</span> <span class="o">|</span>
				     <span class="n">CIFS_ACL_DACL</span><span class="p">);</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">ByteCount</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="mi">11</span><span class="p">);</span> <span class="cm">/* 3 bytes pad + 8 bytes parm */</span>
	<span class="n">inc_rfc1001_len</span><span class="p">(</span><span class="n">pSMB</span><span class="p">,</span> <span class="mi">11</span><span class="p">);</span>
	<span class="n">iov</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">iov_base</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">pSMB</span><span class="p">;</span>
	<span class="n">iov</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">iov_len</span> <span class="o">=</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">smb_buf_length</span><span class="p">)</span> <span class="o">+</span> <span class="mi">4</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">SendReceive2</span><span class="p">(</span><span class="n">xid</span><span class="p">,</span> <span class="n">tcon</span><span class="o">-&gt;</span><span class="n">ses</span><span class="p">,</span> <span class="n">iov</span><span class="p">,</span> <span class="mi">1</span> <span class="cm">/* num iovec */</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">buf_type</span><span class="p">,</span>
			 <span class="mi">0</span><span class="p">);</span>
	<span class="n">cifs_stats_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tcon</span><span class="o">-&gt;</span><span class="n">num_acl_get</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cFYI</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;Send error in QuerySecDesc = %d&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>                <span class="cm">/* decode response */</span>
		<span class="n">__le32</span> <span class="o">*</span><span class="n">parm</span><span class="p">;</span>
		<span class="n">__u32</span> <span class="n">parm_len</span><span class="p">;</span>
		<span class="n">__u32</span> <span class="n">acl_len</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">smb_com_ntransact_rsp</span> <span class="o">*</span><span class="n">pSMBr</span><span class="p">;</span>
		<span class="kt">char</span> <span class="o">*</span><span class="n">pdata</span><span class="p">;</span>

<span class="cm">/* validate_nttransact */</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">validate_ntransact</span><span class="p">(</span><span class="n">iov</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">iov_base</span><span class="p">,</span> <span class="p">(</span><span class="kt">char</span> <span class="o">**</span><span class="p">)</span><span class="o">&amp;</span><span class="n">parm</span><span class="p">,</span>
					<span class="o">&amp;</span><span class="n">pdata</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">parm_len</span><span class="p">,</span> <span class="n">pbuflen</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">qsec_out</span><span class="p">;</span>
		<span class="n">pSMBr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">smb_com_ntransact_rsp</span> <span class="o">*</span><span class="p">)</span><span class="n">iov</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">iov_base</span><span class="p">;</span>

		<span class="n">cFYI</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;smb %p parm %p data %p&quot;</span><span class="p">,</span> <span class="n">pSMBr</span><span class="p">,</span> <span class="n">parm</span><span class="p">,</span> <span class="o">*</span><span class="n">acl_inf</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">pSMBr</span><span class="o">-&gt;</span><span class="n">ParameterCount</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>      <span class="cm">/* bad smb */</span>
			<span class="o">*</span><span class="n">pbuflen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">qsec_out</span><span class="p">;</span>
		<span class="p">}</span>

<span class="cm">/* BB check that data area is minimum length and as big as acl_len */</span>

		<span class="n">acl_len</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="o">*</span><span class="n">parm</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">acl_len</span> <span class="o">!=</span> <span class="o">*</span><span class="n">pbuflen</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">cERROR</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;acl length %d does not match %d&quot;</span><span class="p">,</span>
				   <span class="n">acl_len</span><span class="p">,</span> <span class="o">*</span><span class="n">pbuflen</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">pbuflen</span> <span class="o">&gt;</span> <span class="n">acl_len</span><span class="p">)</span>
				<span class="o">*</span><span class="n">pbuflen</span> <span class="o">=</span> <span class="n">acl_len</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* check if buffer is big enough for the acl</span>
<span class="cm">		   header followed by the smallest SID */</span>
		<span class="k">if</span> <span class="p">((</span><span class="o">*</span><span class="n">pbuflen</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">cifs_ntsd</span><span class="p">)</span> <span class="o">+</span> <span class="mi">8</span><span class="p">)</span> <span class="o">||</span>
		    <span class="p">(</span><span class="o">*</span><span class="n">pbuflen</span> <span class="o">&gt;=</span> <span class="mi">64</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">cERROR</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;bad acl length %d&quot;</span><span class="p">,</span> <span class="o">*</span><span class="n">pbuflen</span><span class="p">);</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="o">*</span><span class="n">pbuflen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="o">*</span><span class="n">acl_inf</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="o">*</span><span class="n">pbuflen</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">acl_inf</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
				<span class="o">*</span><span class="n">pbuflen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="o">*</span><span class="n">acl_inf</span><span class="p">,</span> <span class="n">pdata</span><span class="p">,</span> <span class="o">*</span><span class="n">pbuflen</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="nl">qsec_out:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">buf_type</span> <span class="o">==</span> <span class="n">CIFS_SMALL_BUFFER</span><span class="p">)</span>
		<span class="n">cifs_small_buf_release</span><span class="p">(</span><span class="n">iov</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">iov_base</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">buf_type</span> <span class="o">==</span> <span class="n">CIFS_LARGE_BUFFER</span><span class="p">)</span>
		<span class="n">cifs_buf_release</span><span class="p">(</span><span class="n">iov</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">iov_base</span><span class="p">);</span>
<span class="cm">/*	cifs_small_buf_release(pSMB); */</span> <span class="cm">/* Freed earlier now in SendReceive2 */</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="nf">CIFSSMBSetCIFSACL</span><span class="p">(</span><span class="k">const</span> <span class="kt">int</span> <span class="n">xid</span><span class="p">,</span> <span class="k">struct</span> <span class="n">cifs_tcon</span> <span class="o">*</span><span class="n">tcon</span><span class="p">,</span> <span class="n">__u16</span> <span class="n">fid</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">cifs_ntsd</span> <span class="o">*</span><span class="n">pntsd</span><span class="p">,</span> <span class="n">__u32</span> <span class="n">acllen</span><span class="p">,</span> <span class="kt">int</span> <span class="n">aclflag</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">__u16</span> <span class="n">byte_count</span><span class="p">,</span> <span class="n">param_count</span><span class="p">,</span> <span class="n">data_count</span><span class="p">,</span> <span class="n">param_offset</span><span class="p">,</span> <span class="n">data_offset</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">bytes_returned</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">SET_SEC_DESC_REQ</span> <span class="o">*</span><span class="n">pSMB</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">pSMBr</span><span class="p">;</span>

<span class="nl">setCifsAclRetry:</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">smb_init</span><span class="p">(</span><span class="n">SMB_COM_NT_TRANSACT</span><span class="p">,</span> <span class="mi">19</span><span class="p">,</span> <span class="n">tcon</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">**</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">pSMB</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pSMBr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">MaxSetupCount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">Reserved</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">param_count</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">param_offset</span> <span class="o">=</span> <span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">smb_com_transaction_ssec_req</span><span class="p">,</span> <span class="n">Fid</span><span class="p">)</span> <span class="o">-</span> <span class="mi">4</span><span class="p">;</span>
	<span class="n">data_count</span> <span class="o">=</span> <span class="n">acllen</span><span class="p">;</span>
	<span class="n">data_offset</span> <span class="o">=</span> <span class="n">param_offset</span> <span class="o">+</span> <span class="n">param_count</span><span class="p">;</span>
	<span class="n">byte_count</span> <span class="o">=</span> <span class="mi">3</span> <span class="cm">/* pad */</span>  <span class="o">+</span> <span class="n">param_count</span><span class="p">;</span>

	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">DataCount</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">data_count</span><span class="p">);</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">TotalDataCount</span> <span class="o">=</span> <span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">DataCount</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">MaxParameterCount</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="mi">4</span><span class="p">);</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">MaxDataCount</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="mi">16384</span><span class="p">);</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">ParameterCount</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">param_count</span><span class="p">);</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">ParameterOffset</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">param_offset</span><span class="p">);</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">TotalParameterCount</span> <span class="o">=</span> <span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">ParameterCount</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">DataOffset</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">data_offset</span><span class="p">);</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">SetupCount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">SubCommand</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">NT_TRANSACT_SET_SECURITY_DESC</span><span class="p">);</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">ByteCount</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">byte_count</span><span class="o">+</span><span class="n">data_count</span><span class="p">);</span>

	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">Fid</span> <span class="o">=</span> <span class="n">fid</span><span class="p">;</span> <span class="cm">/* file handle always le */</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">Reserved2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">AclFlags</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">aclflag</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pntsd</span> <span class="o">&amp;&amp;</span> <span class="n">acllen</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">memcpy</span><span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">pSMBr</span> <span class="o">+</span> <span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">smb_hdr</span><span class="p">,</span> <span class="n">Protocol</span><span class="p">)</span> <span class="o">+</span>
				<span class="n">data_offset</span><span class="p">,</span> <span class="n">pntsd</span><span class="p">,</span> <span class="n">acllen</span><span class="p">);</span>
		<span class="n">inc_rfc1001_len</span><span class="p">(</span><span class="n">pSMB</span><span class="p">,</span> <span class="n">byte_count</span> <span class="o">+</span> <span class="n">data_count</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">inc_rfc1001_len</span><span class="p">(</span><span class="n">pSMB</span><span class="p">,</span> <span class="n">byte_count</span><span class="p">);</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">SendReceive</span><span class="p">(</span><span class="n">xid</span><span class="p">,</span> <span class="n">tcon</span><span class="o">-&gt;</span><span class="n">ses</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">smb_hdr</span> <span class="o">*</span><span class="p">)</span> <span class="n">pSMB</span><span class="p">,</span>
		<span class="p">(</span><span class="k">struct</span> <span class="n">smb_hdr</span> <span class="o">*</span><span class="p">)</span> <span class="n">pSMBr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bytes_returned</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">cFYI</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;SetCIFSACL bytes_returned: %d, rc: %d&quot;</span><span class="p">,</span> <span class="n">bytes_returned</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="n">cFYI</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;Set CIFS ACL returned %d&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
	<span class="n">cifs_buf_release</span><span class="p">(</span><span class="n">pSMB</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">setCifsAclRetry</span><span class="p">;</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">rc</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#endif </span><span class="cm">/* CONFIG_CIFS_ACL */</span><span class="cp"></span>

<span class="cm">/* Legacy Query Path Information call for lookup to old servers such</span>
<span class="cm">   as Win9x/WinME */</span>
<span class="kt">int</span> <span class="nf">SMBQueryInformation</span><span class="p">(</span><span class="k">const</span> <span class="kt">int</span> <span class="n">xid</span><span class="p">,</span> <span class="k">struct</span> <span class="n">cifs_tcon</span> <span class="o">*</span><span class="n">tcon</span><span class="p">,</span>
			<span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">searchName</span><span class="p">,</span>
			<span class="n">FILE_ALL_INFO</span> <span class="o">*</span><span class="n">pFinfo</span><span class="p">,</span>
			<span class="k">const</span> <span class="k">struct</span> <span class="n">nls_table</span> <span class="o">*</span><span class="n">nls_codepage</span><span class="p">,</span> <span class="kt">int</span> <span class="n">remap</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">QUERY_INFORMATION_REQ</span> <span class="o">*</span><span class="n">pSMB</span><span class="p">;</span>
	<span class="n">QUERY_INFORMATION_RSP</span> <span class="o">*</span><span class="n">pSMBr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">bytes_returned</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">name_len</span><span class="p">;</span>

	<span class="n">cFYI</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;In SMBQPath path %s&quot;</span><span class="p">,</span> <span class="n">searchName</span><span class="p">);</span>
<span class="nl">QInfRetry:</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">smb_init</span><span class="p">(</span><span class="n">SMB_COM_QUERY_INFORMATION</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">tcon</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">**</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">pSMB</span><span class="p">,</span>
		      <span class="p">(</span><span class="kt">void</span> <span class="o">**</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">pSMBr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">Flags2</span> <span class="o">&amp;</span> <span class="n">SMBFLG2_UNICODE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">name_len</span> <span class="o">=</span>
			<span class="n">cifsConvertToUTF16</span><span class="p">((</span><span class="n">__le16</span> <span class="o">*</span><span class="p">)</span> <span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">FileName</span><span class="p">,</span>
					   <span class="n">searchName</span><span class="p">,</span> <span class="n">PATH_MAX</span><span class="p">,</span> <span class="n">nls_codepage</span><span class="p">,</span>
					   <span class="n">remap</span><span class="p">);</span>
		<span class="n">name_len</span><span class="o">++</span><span class="p">;</span>     <span class="cm">/* trailing null */</span>
		<span class="n">name_len</span> <span class="o">*=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">name_len</span> <span class="o">=</span> <span class="n">strnlen</span><span class="p">(</span><span class="n">searchName</span><span class="p">,</span> <span class="n">PATH_MAX</span><span class="p">);</span>
		<span class="n">name_len</span><span class="o">++</span><span class="p">;</span>     <span class="cm">/* trailing null */</span>
		<span class="n">strncpy</span><span class="p">(</span><span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">FileName</span><span class="p">,</span> <span class="n">searchName</span><span class="p">,</span> <span class="n">name_len</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">BufferFormat</span> <span class="o">=</span> <span class="mh">0x04</span><span class="p">;</span>
	<span class="n">name_len</span><span class="o">++</span><span class="p">;</span> <span class="cm">/* account for buffer type byte */</span>
	<span class="n">inc_rfc1001_len</span><span class="p">(</span><span class="n">pSMB</span><span class="p">,</span> <span class="p">(</span><span class="n">__u16</span><span class="p">)</span><span class="n">name_len</span><span class="p">);</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">ByteCount</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">name_len</span><span class="p">);</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">SendReceive</span><span class="p">(</span><span class="n">xid</span><span class="p">,</span> <span class="n">tcon</span><span class="o">-&gt;</span><span class="n">ses</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">smb_hdr</span> <span class="o">*</span><span class="p">)</span> <span class="n">pSMB</span><span class="p">,</span>
			 <span class="p">(</span><span class="k">struct</span> <span class="n">smb_hdr</span> <span class="o">*</span><span class="p">)</span> <span class="n">pSMBr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bytes_returned</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cFYI</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;Send error in QueryInfo = %d&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">pFinfo</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">timespec</span> <span class="n">ts</span><span class="p">;</span>
		<span class="n">__u32</span> <span class="n">time</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">pSMBr</span><span class="o">-&gt;</span><span class="n">last_write_time</span><span class="p">);</span>

		<span class="cm">/* decode response */</span>
		<span class="cm">/* BB FIXME - add time zone adjustment BB */</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">pFinfo</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">FILE_ALL_INFO</span><span class="p">));</span>
		<span class="n">ts</span><span class="p">.</span><span class="n">tv_nsec</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">ts</span><span class="p">.</span><span class="n">tv_sec</span> <span class="o">=</span> <span class="n">time</span><span class="p">;</span>
		<span class="cm">/* decode time fields */</span>
		<span class="n">pFinfo</span><span class="o">-&gt;</span><span class="n">ChangeTime</span> <span class="o">=</span> <span class="n">cpu_to_le64</span><span class="p">(</span><span class="n">cifs_UnixTimeToNT</span><span class="p">(</span><span class="n">ts</span><span class="p">));</span>
		<span class="n">pFinfo</span><span class="o">-&gt;</span><span class="n">LastWriteTime</span> <span class="o">=</span> <span class="n">pFinfo</span><span class="o">-&gt;</span><span class="n">ChangeTime</span><span class="p">;</span>
		<span class="n">pFinfo</span><span class="o">-&gt;</span><span class="n">LastAccessTime</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">pFinfo</span><span class="o">-&gt;</span><span class="n">AllocationSize</span> <span class="o">=</span>
			<span class="n">cpu_to_le64</span><span class="p">(</span><span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">pSMBr</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">));</span>
		<span class="n">pFinfo</span><span class="o">-&gt;</span><span class="n">EndOfFile</span> <span class="o">=</span> <span class="n">pFinfo</span><span class="o">-&gt;</span><span class="n">AllocationSize</span><span class="p">;</span>
		<span class="n">pFinfo</span><span class="o">-&gt;</span><span class="n">Attributes</span> <span class="o">=</span>
			<span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">pSMBr</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">));</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span> <span class="cm">/* bad buffer passed in */</span>

	<span class="n">cifs_buf_release</span><span class="p">(</span><span class="n">pSMB</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">QInfRetry</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="nf">CIFSSMBQFileInfo</span><span class="p">(</span><span class="k">const</span> <span class="kt">int</span> <span class="n">xid</span><span class="p">,</span> <span class="k">struct</span> <span class="n">cifs_tcon</span> <span class="o">*</span><span class="n">tcon</span><span class="p">,</span>
		 <span class="n">u16</span> <span class="n">netfid</span><span class="p">,</span> <span class="n">FILE_ALL_INFO</span> <span class="o">*</span><span class="n">pFindData</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">smb_t2_qfi_req</span> <span class="o">*</span><span class="n">pSMB</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">smb_t2_qfi_rsp</span> <span class="o">*</span><span class="n">pSMBr</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">bytes_returned</span><span class="p">;</span>
	<span class="n">__u16</span> <span class="n">params</span><span class="p">,</span> <span class="n">byte_count</span><span class="p">;</span>

<span class="nl">QFileInfoRetry:</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">smb_init</span><span class="p">(</span><span class="n">SMB_COM_TRANSACTION2</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="n">tcon</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">**</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">pSMB</span><span class="p">,</span>
		      <span class="p">(</span><span class="kt">void</span> <span class="o">**</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">pSMBr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">params</span> <span class="o">=</span> <span class="mi">2</span> <span class="cm">/* level */</span> <span class="o">+</span> <span class="mi">2</span> <span class="cm">/* fid */</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">t2</span><span class="p">.</span><span class="n">TotalDataCount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">t2</span><span class="p">.</span><span class="n">MaxParameterCount</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="mi">4</span><span class="p">);</span>
	<span class="cm">/* BB find exact max data count below from sess structure BB */</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">t2</span><span class="p">.</span><span class="n">MaxDataCount</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">CIFSMaxBufSize</span><span class="p">);</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">t2</span><span class="p">.</span><span class="n">MaxSetupCount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">t2</span><span class="p">.</span><span class="n">Reserved</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">t2</span><span class="p">.</span><span class="n">Flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">t2</span><span class="p">.</span><span class="n">Timeout</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">t2</span><span class="p">.</span><span class="n">Reserved2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">t2</span><span class="p">.</span><span class="n">ParameterOffset</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">smb_t2_qfi_req</span><span class="p">,</span>
					       <span class="n">Fid</span><span class="p">)</span> <span class="o">-</span> <span class="mi">4</span><span class="p">);</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">t2</span><span class="p">.</span><span class="n">DataCount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">t2</span><span class="p">.</span><span class="n">DataOffset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">t2</span><span class="p">.</span><span class="n">SetupCount</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">t2</span><span class="p">.</span><span class="n">Reserved3</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">t2</span><span class="p">.</span><span class="n">SubCommand</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">TRANS2_QUERY_FILE_INFORMATION</span><span class="p">);</span>
	<span class="n">byte_count</span> <span class="o">=</span> <span class="n">params</span> <span class="o">+</span> <span class="mi">1</span> <span class="cm">/* pad */</span> <span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">t2</span><span class="p">.</span><span class="n">TotalParameterCount</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">params</span><span class="p">);</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">t2</span><span class="p">.</span><span class="n">ParameterCount</span> <span class="o">=</span> <span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">t2</span><span class="p">.</span><span class="n">TotalParameterCount</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">InformationLevel</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">SMB_QUERY_FILE_ALL_INFO</span><span class="p">);</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">Pad</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">Fid</span> <span class="o">=</span> <span class="n">netfid</span><span class="p">;</span>
	<span class="n">inc_rfc1001_len</span><span class="p">(</span><span class="n">pSMB</span><span class="p">,</span> <span class="n">byte_count</span><span class="p">);</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">SendReceive</span><span class="p">(</span><span class="n">xid</span><span class="p">,</span> <span class="n">tcon</span><span class="o">-&gt;</span><span class="n">ses</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">smb_hdr</span> <span class="o">*</span><span class="p">)</span> <span class="n">pSMB</span><span class="p">,</span>
			 <span class="p">(</span><span class="k">struct</span> <span class="n">smb_hdr</span> <span class="o">*</span><span class="p">)</span> <span class="n">pSMBr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bytes_returned</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cFYI</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;Send error in QPathInfo = %d&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>		<span class="cm">/* decode response */</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">validate_t2</span><span class="p">((</span><span class="k">struct</span> <span class="n">smb_t2_rsp</span> <span class="o">*</span><span class="p">)</span><span class="n">pSMBr</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="cm">/* BB add auto retry on EOPNOTSUPP? */</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">get_bcc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pSMBr</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">40</span><span class="p">)</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>	<span class="cm">/* bad smb */</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">pFindData</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">__u16</span> <span class="n">data_offset</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">pSMBr</span><span class="o">-&gt;</span><span class="n">t2</span><span class="p">.</span><span class="n">DataOffset</span><span class="p">);</span>
			<span class="n">memcpy</span><span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">pFindData</span><span class="p">,</span>
			       <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">pSMBr</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">Protocol</span> <span class="o">+</span>
			       <span class="n">data_offset</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">FILE_ALL_INFO</span><span class="p">));</span>
		<span class="p">}</span> <span class="k">else</span>
		    <span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">cifs_buf_release</span><span class="p">(</span><span class="n">pSMB</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">QFileInfoRetry</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="nf">CIFSSMBQPathInfo</span><span class="p">(</span><span class="k">const</span> <span class="kt">int</span> <span class="n">xid</span><span class="p">,</span> <span class="k">struct</span> <span class="n">cifs_tcon</span> <span class="o">*</span><span class="n">tcon</span><span class="p">,</span>
		 <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">searchName</span><span class="p">,</span>
		 <span class="n">FILE_ALL_INFO</span> <span class="o">*</span><span class="n">pFindData</span><span class="p">,</span>
		 <span class="kt">int</span> <span class="n">legacy</span> <span class="cm">/* old style infolevel */</span><span class="p">,</span>
		 <span class="k">const</span> <span class="k">struct</span> <span class="n">nls_table</span> <span class="o">*</span><span class="n">nls_codepage</span><span class="p">,</span> <span class="kt">int</span> <span class="n">remap</span><span class="p">)</span>
<span class="p">{</span>
<span class="cm">/* level 263 SMB_QUERY_FILE_ALL_INFO */</span>
	<span class="n">TRANSACTION2_QPI_REQ</span> <span class="o">*</span><span class="n">pSMB</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">TRANSACTION2_QPI_RSP</span> <span class="o">*</span><span class="n">pSMBr</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">bytes_returned</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">name_len</span><span class="p">;</span>
	<span class="n">__u16</span> <span class="n">params</span><span class="p">,</span> <span class="n">byte_count</span><span class="p">;</span>

<span class="cm">/* cFYI(1, &quot;In QPathInfo path %s&quot;, searchName); */</span>
<span class="nl">QPathInfoRetry:</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">smb_init</span><span class="p">(</span><span class="n">SMB_COM_TRANSACTION2</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="n">tcon</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">**</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">pSMB</span><span class="p">,</span>
		      <span class="p">(</span><span class="kt">void</span> <span class="o">**</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">pSMBr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">Flags2</span> <span class="o">&amp;</span> <span class="n">SMBFLG2_UNICODE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">name_len</span> <span class="o">=</span>
		    <span class="n">cifsConvertToUTF16</span><span class="p">((</span><span class="n">__le16</span> <span class="o">*</span><span class="p">)</span> <span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">FileName</span><span class="p">,</span> <span class="n">searchName</span><span class="p">,</span>
				       <span class="n">PATH_MAX</span><span class="p">,</span> <span class="n">nls_codepage</span><span class="p">,</span> <span class="n">remap</span><span class="p">);</span>
		<span class="n">name_len</span><span class="o">++</span><span class="p">;</span>	<span class="cm">/* trailing null */</span>
		<span class="n">name_len</span> <span class="o">*=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>	<span class="cm">/* BB improve the check for buffer overruns BB */</span>
		<span class="n">name_len</span> <span class="o">=</span> <span class="n">strnlen</span><span class="p">(</span><span class="n">searchName</span><span class="p">,</span> <span class="n">PATH_MAX</span><span class="p">);</span>
		<span class="n">name_len</span><span class="o">++</span><span class="p">;</span>	<span class="cm">/* trailing null */</span>
		<span class="n">strncpy</span><span class="p">(</span><span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">FileName</span><span class="p">,</span> <span class="n">searchName</span><span class="p">,</span> <span class="n">name_len</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">params</span> <span class="o">=</span> <span class="mi">2</span> <span class="cm">/* level */</span> <span class="o">+</span> <span class="mi">4</span> <span class="cm">/* reserved */</span> <span class="o">+</span> <span class="n">name_len</span> <span class="cm">/* includes NUL */</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">TotalDataCount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">MaxParameterCount</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
	<span class="cm">/* BB find exact max SMB PDU from sess structure BB */</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">MaxDataCount</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="mi">4000</span><span class="p">);</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">MaxSetupCount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">Reserved</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">Flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">Timeout</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">Reserved2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">ParameterOffset</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">offsetof</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">smb_com_transaction2_qpi_req</span><span class="p">,</span> <span class="n">InformationLevel</span><span class="p">)</span> <span class="o">-</span> <span class="mi">4</span><span class="p">);</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">DataCount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">DataOffset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">SetupCount</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">Reserved3</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">SubCommand</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">TRANS2_QUERY_PATH_INFORMATION</span><span class="p">);</span>
	<span class="n">byte_count</span> <span class="o">=</span> <span class="n">params</span> <span class="o">+</span> <span class="mi">1</span> <span class="cm">/* pad */</span> <span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">TotalParameterCount</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">params</span><span class="p">);</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">ParameterCount</span> <span class="o">=</span> <span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">TotalParameterCount</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">legacy</span><span class="p">)</span>
		<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">InformationLevel</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">SMB_INFO_STANDARD</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">InformationLevel</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">SMB_QUERY_FILE_ALL_INFO</span><span class="p">);</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">Reserved4</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">inc_rfc1001_len</span><span class="p">(</span><span class="n">pSMB</span><span class="p">,</span> <span class="n">byte_count</span><span class="p">);</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">ByteCount</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">byte_count</span><span class="p">);</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">SendReceive</span><span class="p">(</span><span class="n">xid</span><span class="p">,</span> <span class="n">tcon</span><span class="o">-&gt;</span><span class="n">ses</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">smb_hdr</span> <span class="o">*</span><span class="p">)</span> <span class="n">pSMB</span><span class="p">,</span>
			 <span class="p">(</span><span class="k">struct</span> <span class="n">smb_hdr</span> <span class="o">*</span><span class="p">)</span> <span class="n">pSMBr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bytes_returned</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cFYI</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;Send error in QPathInfo = %d&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>		<span class="cm">/* decode response */</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">validate_t2</span><span class="p">((</span><span class="k">struct</span> <span class="n">smb_t2_rsp</span> <span class="o">*</span><span class="p">)</span><span class="n">pSMBr</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="cm">/* BB add auto retry on EOPNOTSUPP? */</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">legacy</span> <span class="o">&amp;&amp;</span> <span class="n">get_bcc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pSMBr</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">40</span><span class="p">)</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>	<span class="cm">/* bad smb */</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">legacy</span> <span class="o">&amp;&amp;</span> <span class="n">get_bcc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pSMBr</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">24</span><span class="p">)</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>  <span class="cm">/* 24 or 26 expected but we do not read</span>
<span class="cm">					last field */</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">pFindData</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">int</span> <span class="n">size</span><span class="p">;</span>
			<span class="n">__u16</span> <span class="n">data_offset</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">pSMBr</span><span class="o">-&gt;</span><span class="n">t2</span><span class="p">.</span><span class="n">DataOffset</span><span class="p">);</span>

			<span class="cm">/* On legacy responses we do not read the last field,</span>
<span class="cm">			EAsize, fortunately since it varies by subdialect and</span>
<span class="cm">			also note it differs on Set vs. Get, ie two bytes or 4</span>
<span class="cm">			bytes depending but we don&#39;t care here */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">legacy</span><span class="p">)</span>
				<span class="n">size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">FILE_INFO_STANDARD</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">FILE_ALL_INFO</span><span class="p">);</span>
			<span class="n">memcpy</span><span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">pFindData</span><span class="p">,</span>
			       <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">pSMBr</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">Protocol</span> <span class="o">+</span>
			       <span class="n">data_offset</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span>
		    <span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">cifs_buf_release</span><span class="p">(</span><span class="n">pSMB</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">QPathInfoRetry</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="nf">CIFSSMBUnixQFileInfo</span><span class="p">(</span><span class="k">const</span> <span class="kt">int</span> <span class="n">xid</span><span class="p">,</span> <span class="k">struct</span> <span class="n">cifs_tcon</span> <span class="o">*</span><span class="n">tcon</span><span class="p">,</span>
		 <span class="n">u16</span> <span class="n">netfid</span><span class="p">,</span> <span class="n">FILE_UNIX_BASIC_INFO</span> <span class="o">*</span><span class="n">pFindData</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">smb_t2_qfi_req</span> <span class="o">*</span><span class="n">pSMB</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">smb_t2_qfi_rsp</span> <span class="o">*</span><span class="n">pSMBr</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">bytes_returned</span><span class="p">;</span>
	<span class="n">__u16</span> <span class="n">params</span><span class="p">,</span> <span class="n">byte_count</span><span class="p">;</span>

<span class="nl">UnixQFileInfoRetry:</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">smb_init</span><span class="p">(</span><span class="n">SMB_COM_TRANSACTION2</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="n">tcon</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">**</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">pSMB</span><span class="p">,</span>
		      <span class="p">(</span><span class="kt">void</span> <span class="o">**</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">pSMBr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">params</span> <span class="o">=</span> <span class="mi">2</span> <span class="cm">/* level */</span> <span class="o">+</span> <span class="mi">2</span> <span class="cm">/* fid */</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">t2</span><span class="p">.</span><span class="n">TotalDataCount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">t2</span><span class="p">.</span><span class="n">MaxParameterCount</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="mi">4</span><span class="p">);</span>
	<span class="cm">/* BB find exact max data count below from sess structure BB */</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">t2</span><span class="p">.</span><span class="n">MaxDataCount</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">CIFSMaxBufSize</span><span class="p">);</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">t2</span><span class="p">.</span><span class="n">MaxSetupCount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">t2</span><span class="p">.</span><span class="n">Reserved</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">t2</span><span class="p">.</span><span class="n">Flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">t2</span><span class="p">.</span><span class="n">Timeout</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">t2</span><span class="p">.</span><span class="n">Reserved2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">t2</span><span class="p">.</span><span class="n">ParameterOffset</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">smb_t2_qfi_req</span><span class="p">,</span>
					       <span class="n">Fid</span><span class="p">)</span> <span class="o">-</span> <span class="mi">4</span><span class="p">);</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">t2</span><span class="p">.</span><span class="n">DataCount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">t2</span><span class="p">.</span><span class="n">DataOffset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">t2</span><span class="p">.</span><span class="n">SetupCount</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">t2</span><span class="p">.</span><span class="n">Reserved3</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">t2</span><span class="p">.</span><span class="n">SubCommand</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">TRANS2_QUERY_FILE_INFORMATION</span><span class="p">);</span>
	<span class="n">byte_count</span> <span class="o">=</span> <span class="n">params</span> <span class="o">+</span> <span class="mi">1</span> <span class="cm">/* pad */</span> <span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">t2</span><span class="p">.</span><span class="n">TotalParameterCount</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">params</span><span class="p">);</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">t2</span><span class="p">.</span><span class="n">ParameterCount</span> <span class="o">=</span> <span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">t2</span><span class="p">.</span><span class="n">TotalParameterCount</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">InformationLevel</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">SMB_QUERY_FILE_UNIX_BASIC</span><span class="p">);</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">Pad</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">Fid</span> <span class="o">=</span> <span class="n">netfid</span><span class="p">;</span>
	<span class="n">inc_rfc1001_len</span><span class="p">(</span><span class="n">pSMB</span><span class="p">,</span> <span class="n">byte_count</span><span class="p">);</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">SendReceive</span><span class="p">(</span><span class="n">xid</span><span class="p">,</span> <span class="n">tcon</span><span class="o">-&gt;</span><span class="n">ses</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">smb_hdr</span> <span class="o">*</span><span class="p">)</span> <span class="n">pSMB</span><span class="p">,</span>
			 <span class="p">(</span><span class="k">struct</span> <span class="n">smb_hdr</span> <span class="o">*</span><span class="p">)</span> <span class="n">pSMBr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bytes_returned</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cFYI</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;Send error in QPathInfo = %d&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>		<span class="cm">/* decode response */</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">validate_t2</span><span class="p">((</span><span class="k">struct</span> <span class="n">smb_t2_rsp</span> <span class="o">*</span><span class="p">)</span><span class="n">pSMBr</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">||</span> <span class="n">get_bcc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pSMBr</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">)</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">FILE_UNIX_BASIC_INFO</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">cERROR</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;Malformed FILE_UNIX_BASIC_INFO response.</span><span class="se">\n</span><span class="s">&quot;</span>
				   <span class="s">&quot;Unix Extensions can be disabled on mount &quot;</span>
				   <span class="s">&quot;by specifying the nosfu mount option.&quot;</span><span class="p">);</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>	<span class="cm">/* bad smb */</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">__u16</span> <span class="n">data_offset</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">pSMBr</span><span class="o">-&gt;</span><span class="n">t2</span><span class="p">.</span><span class="n">DataOffset</span><span class="p">);</span>
			<span class="n">memcpy</span><span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">pFindData</span><span class="p">,</span>
			       <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">pSMBr</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">Protocol</span> <span class="o">+</span>
			       <span class="n">data_offset</span><span class="p">,</span>
			       <span class="k">sizeof</span><span class="p">(</span><span class="n">FILE_UNIX_BASIC_INFO</span><span class="p">));</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">cifs_buf_release</span><span class="p">(</span><span class="n">pSMB</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">UnixQFileInfoRetry</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="nf">CIFSSMBUnixQPathInfo</span><span class="p">(</span><span class="k">const</span> <span class="kt">int</span> <span class="n">xid</span><span class="p">,</span> <span class="k">struct</span> <span class="n">cifs_tcon</span> <span class="o">*</span><span class="n">tcon</span><span class="p">,</span>
		     <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">searchName</span><span class="p">,</span>
		     <span class="n">FILE_UNIX_BASIC_INFO</span> <span class="o">*</span><span class="n">pFindData</span><span class="p">,</span>
		     <span class="k">const</span> <span class="k">struct</span> <span class="n">nls_table</span> <span class="o">*</span><span class="n">nls_codepage</span><span class="p">,</span> <span class="kt">int</span> <span class="n">remap</span><span class="p">)</span>
<span class="p">{</span>
<span class="cm">/* SMB_QUERY_FILE_UNIX_BASIC */</span>
	<span class="n">TRANSACTION2_QPI_REQ</span> <span class="o">*</span><span class="n">pSMB</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">TRANSACTION2_QPI_RSP</span> <span class="o">*</span><span class="n">pSMBr</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">bytes_returned</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">name_len</span><span class="p">;</span>
	<span class="n">__u16</span> <span class="n">params</span><span class="p">,</span> <span class="n">byte_count</span><span class="p">;</span>

	<span class="n">cFYI</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;In QPathInfo (Unix) the path %s&quot;</span><span class="p">,</span> <span class="n">searchName</span><span class="p">);</span>
<span class="nl">UnixQPathInfoRetry:</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">smb_init</span><span class="p">(</span><span class="n">SMB_COM_TRANSACTION2</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="n">tcon</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">**</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">pSMB</span><span class="p">,</span>
		      <span class="p">(</span><span class="kt">void</span> <span class="o">**</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">pSMBr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">Flags2</span> <span class="o">&amp;</span> <span class="n">SMBFLG2_UNICODE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">name_len</span> <span class="o">=</span>
		    <span class="n">cifsConvertToUTF16</span><span class="p">((</span><span class="n">__le16</span> <span class="o">*</span><span class="p">)</span> <span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">FileName</span><span class="p">,</span> <span class="n">searchName</span><span class="p">,</span>
				       <span class="n">PATH_MAX</span><span class="p">,</span> <span class="n">nls_codepage</span><span class="p">,</span> <span class="n">remap</span><span class="p">);</span>
		<span class="n">name_len</span><span class="o">++</span><span class="p">;</span>	<span class="cm">/* trailing null */</span>
		<span class="n">name_len</span> <span class="o">*=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>	<span class="cm">/* BB improve the check for buffer overruns BB */</span>
		<span class="n">name_len</span> <span class="o">=</span> <span class="n">strnlen</span><span class="p">(</span><span class="n">searchName</span><span class="p">,</span> <span class="n">PATH_MAX</span><span class="p">);</span>
		<span class="n">name_len</span><span class="o">++</span><span class="p">;</span>	<span class="cm">/* trailing null */</span>
		<span class="n">strncpy</span><span class="p">(</span><span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">FileName</span><span class="p">,</span> <span class="n">searchName</span><span class="p">,</span> <span class="n">name_len</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">params</span> <span class="o">=</span> <span class="mi">2</span> <span class="cm">/* level */</span> <span class="o">+</span> <span class="mi">4</span> <span class="cm">/* reserved */</span> <span class="o">+</span> <span class="n">name_len</span> <span class="cm">/* includes NUL */</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">TotalDataCount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">MaxParameterCount</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
	<span class="cm">/* BB find exact max SMB PDU from sess structure BB */</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">MaxDataCount</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="mi">4000</span><span class="p">);</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">MaxSetupCount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">Reserved</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">Flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">Timeout</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">Reserved2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">ParameterOffset</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">offsetof</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">smb_com_transaction2_qpi_req</span><span class="p">,</span> <span class="n">InformationLevel</span><span class="p">)</span> <span class="o">-</span> <span class="mi">4</span><span class="p">);</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">DataCount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">DataOffset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">SetupCount</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">Reserved3</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">SubCommand</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">TRANS2_QUERY_PATH_INFORMATION</span><span class="p">);</span>
	<span class="n">byte_count</span> <span class="o">=</span> <span class="n">params</span> <span class="o">+</span> <span class="mi">1</span> <span class="cm">/* pad */</span> <span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">TotalParameterCount</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">params</span><span class="p">);</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">ParameterCount</span> <span class="o">=</span> <span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">TotalParameterCount</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">InformationLevel</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">SMB_QUERY_FILE_UNIX_BASIC</span><span class="p">);</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">Reserved4</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">inc_rfc1001_len</span><span class="p">(</span><span class="n">pSMB</span><span class="p">,</span> <span class="n">byte_count</span><span class="p">);</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">ByteCount</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">byte_count</span><span class="p">);</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">SendReceive</span><span class="p">(</span><span class="n">xid</span><span class="p">,</span> <span class="n">tcon</span><span class="o">-&gt;</span><span class="n">ses</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">smb_hdr</span> <span class="o">*</span><span class="p">)</span> <span class="n">pSMB</span><span class="p">,</span>
			 <span class="p">(</span><span class="k">struct</span> <span class="n">smb_hdr</span> <span class="o">*</span><span class="p">)</span> <span class="n">pSMBr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bytes_returned</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cFYI</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;Send error in QPathInfo = %d&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>		<span class="cm">/* decode response */</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">validate_t2</span><span class="p">((</span><span class="k">struct</span> <span class="n">smb_t2_rsp</span> <span class="o">*</span><span class="p">)</span><span class="n">pSMBr</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">||</span> <span class="n">get_bcc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pSMBr</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">)</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">FILE_UNIX_BASIC_INFO</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">cERROR</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;Malformed FILE_UNIX_BASIC_INFO response.</span><span class="se">\n</span><span class="s">&quot;</span>
				   <span class="s">&quot;Unix Extensions can be disabled on mount &quot;</span>
				   <span class="s">&quot;by specifying the nosfu mount option.&quot;</span><span class="p">);</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>	<span class="cm">/* bad smb */</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">__u16</span> <span class="n">data_offset</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">pSMBr</span><span class="o">-&gt;</span><span class="n">t2</span><span class="p">.</span><span class="n">DataOffset</span><span class="p">);</span>
			<span class="n">memcpy</span><span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">pFindData</span><span class="p">,</span>
			       <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">pSMBr</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">Protocol</span> <span class="o">+</span>
			       <span class="n">data_offset</span><span class="p">,</span>
			       <span class="k">sizeof</span><span class="p">(</span><span class="n">FILE_UNIX_BASIC_INFO</span><span class="p">));</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">cifs_buf_release</span><span class="p">(</span><span class="n">pSMB</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">UnixQPathInfoRetry</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* xid, tcon, searchName and codepage are input parms, rest are returned */</span>
<span class="kt">int</span>
<span class="nf">CIFSFindFirst</span><span class="p">(</span><span class="k">const</span> <span class="kt">int</span> <span class="n">xid</span><span class="p">,</span> <span class="k">struct</span> <span class="n">cifs_tcon</span> <span class="o">*</span><span class="n">tcon</span><span class="p">,</span>
	      <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">searchName</span><span class="p">,</span>
	      <span class="k">const</span> <span class="k">struct</span> <span class="n">nls_table</span> <span class="o">*</span><span class="n">nls_codepage</span><span class="p">,</span>
	      <span class="n">__u16</span> <span class="o">*</span><span class="n">pnetfid</span><span class="p">,</span> <span class="n">__u16</span> <span class="n">search_flags</span><span class="p">,</span>
	      <span class="k">struct</span> <span class="n">cifs_search_info</span> <span class="o">*</span><span class="n">psrch_inf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">remap</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">dirsep</span><span class="p">)</span>
<span class="p">{</span>
<span class="cm">/* level 257 SMB_ */</span>
	<span class="n">TRANSACTION2_FFIRST_REQ</span> <span class="o">*</span><span class="n">pSMB</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">TRANSACTION2_FFIRST_RSP</span> <span class="o">*</span><span class="n">pSMBr</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">T2_FFIRST_RSP_PARMS</span> <span class="o">*</span><span class="n">parms</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">bytes_returned</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">name_len</span><span class="p">;</span>
	<span class="n">__u16</span> <span class="n">params</span><span class="p">,</span> <span class="n">byte_count</span><span class="p">;</span>

	<span class="n">cFYI</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;In FindFirst for %s&quot;</span><span class="p">,</span> <span class="n">searchName</span><span class="p">);</span>

<span class="nl">findFirstRetry:</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">smb_init</span><span class="p">(</span><span class="n">SMB_COM_TRANSACTION2</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="n">tcon</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">**</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">pSMB</span><span class="p">,</span>
		      <span class="p">(</span><span class="kt">void</span> <span class="o">**</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">pSMBr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">Flags2</span> <span class="o">&amp;</span> <span class="n">SMBFLG2_UNICODE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">name_len</span> <span class="o">=</span>
		    <span class="n">cifsConvertToUTF16</span><span class="p">((</span><span class="n">__le16</span> <span class="o">*</span><span class="p">)</span> <span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">FileName</span><span class="p">,</span> <span class="n">searchName</span><span class="p">,</span>
				       <span class="n">PATH_MAX</span><span class="p">,</span> <span class="n">nls_codepage</span><span class="p">,</span> <span class="n">remap</span><span class="p">);</span>
		<span class="cm">/* We can not add the asterik earlier in case</span>
<span class="cm">		it got remapped to 0xF03A as if it were part of the</span>
<span class="cm">		directory name instead of a wildcard */</span>
		<span class="n">name_len</span> <span class="o">*=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">FileName</span><span class="p">[</span><span class="n">name_len</span><span class="p">]</span> <span class="o">=</span> <span class="n">dirsep</span><span class="p">;</span>
		<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">FileName</span><span class="p">[</span><span class="n">name_len</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">FileName</span><span class="p">[</span><span class="n">name_len</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;*&#39;</span><span class="p">;</span>
		<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">FileName</span><span class="p">[</span><span class="n">name_len</span><span class="o">+</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">name_len</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span> <span class="cm">/* now the trailing null */</span>
		<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">FileName</span><span class="p">[</span><span class="n">name_len</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* null terminate just in case */</span>
		<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">FileName</span><span class="p">[</span><span class="n">name_len</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">name_len</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>	<span class="cm">/* BB add check for overrun of SMB buf BB */</span>
		<span class="n">name_len</span> <span class="o">=</span> <span class="n">strnlen</span><span class="p">(</span><span class="n">searchName</span><span class="p">,</span> <span class="n">PATH_MAX</span><span class="p">);</span>
<span class="cm">/* BB fix here and in unicode clause above ie</span>
<span class="cm">		if (name_len &gt; buffersize-header)</span>
<span class="cm">			free buffer exit; BB */</span>
		<span class="n">strncpy</span><span class="p">(</span><span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">FileName</span><span class="p">,</span> <span class="n">searchName</span><span class="p">,</span> <span class="n">name_len</span><span class="p">);</span>
		<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">FileName</span><span class="p">[</span><span class="n">name_len</span><span class="p">]</span> <span class="o">=</span> <span class="n">dirsep</span><span class="p">;</span>
		<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">FileName</span><span class="p">[</span><span class="n">name_len</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;*&#39;</span><span class="p">;</span>
		<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">FileName</span><span class="p">[</span><span class="n">name_len</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">name_len</span> <span class="o">+=</span> <span class="mi">3</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">params</span> <span class="o">=</span> <span class="mi">12</span> <span class="o">+</span> <span class="n">name_len</span> <span class="cm">/* includes null */</span> <span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">TotalDataCount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* no EAs */</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">MaxParameterCount</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">MaxDataCount</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">CIFSMaxBufSize</span> <span class="o">&amp;</span> <span class="mh">0xFFFFFF00</span><span class="p">);</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">MaxSetupCount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">Reserved</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">Flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">Timeout</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">Reserved2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">byte_count</span> <span class="o">=</span> <span class="n">params</span> <span class="o">+</span> <span class="mi">1</span> <span class="cm">/* pad */</span> <span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">TotalParameterCount</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">params</span><span class="p">);</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">ParameterCount</span> <span class="o">=</span> <span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">TotalParameterCount</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">ParameterOffset</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span>
	      <span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">smb_com_transaction2_ffirst_req</span><span class="p">,</span> <span class="n">SearchAttributes</span><span class="p">)</span>
		<span class="o">-</span> <span class="mi">4</span><span class="p">);</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">DataCount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">DataOffset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">SetupCount</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>	<span class="cm">/* one byte, no need to make endian neutral */</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">Reserved3</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">SubCommand</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">TRANS2_FIND_FIRST</span><span class="p">);</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">SearchAttributes</span> <span class="o">=</span>
	    <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">ATTR_READONLY</span> <span class="o">|</span> <span class="n">ATTR_HIDDEN</span> <span class="o">|</span> <span class="n">ATTR_SYSTEM</span> <span class="o">|</span>
			<span class="n">ATTR_DIRECTORY</span><span class="p">);</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">SearchCount</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">CIFSMaxBufSize</span><span class="o">/</span><span class="k">sizeof</span><span class="p">(</span><span class="n">FILE_UNIX_INFO</span><span class="p">));</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">SearchFlags</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">search_flags</span><span class="p">);</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">InformationLevel</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">psrch_inf</span><span class="o">-&gt;</span><span class="n">info_level</span><span class="p">);</span>

	<span class="cm">/* BB what should we set StorageType to? Does it matter? BB */</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">SearchStorageType</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">inc_rfc1001_len</span><span class="p">(</span><span class="n">pSMB</span><span class="p">,</span> <span class="n">byte_count</span><span class="p">);</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">ByteCount</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">byte_count</span><span class="p">);</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">SendReceive</span><span class="p">(</span><span class="n">xid</span><span class="p">,</span> <span class="n">tcon</span><span class="o">-&gt;</span><span class="n">ses</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">smb_hdr</span> <span class="o">*</span><span class="p">)</span> <span class="n">pSMB</span><span class="p">,</span>
			 <span class="p">(</span><span class="k">struct</span> <span class="n">smb_hdr</span> <span class="o">*</span><span class="p">)</span> <span class="n">pSMBr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bytes_returned</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">cifs_stats_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tcon</span><span class="o">-&gt;</span><span class="n">num_ffirst</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span><span class="cm">/* BB add logic to retry regular search if Unix search</span>
<span class="cm">			rejected unexpectedly by server */</span>
		<span class="cm">/* BB Add code to handle unsupported level rc */</span>
		<span class="n">cFYI</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;Error in FindFirst = %d&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>

		<span class="n">cifs_buf_release</span><span class="p">(</span><span class="n">pSMB</span><span class="p">);</span>

		<span class="cm">/* BB eventually could optimize out free and realloc of buf */</span>
		<span class="cm">/*    for this case */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">findFirstRetry</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span> <span class="cm">/* decode response */</span>
		<span class="cm">/* BB remember to free buffer if error BB */</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">validate_t2</span><span class="p">((</span><span class="k">struct</span> <span class="n">smb_t2_rsp</span> <span class="o">*</span><span class="p">)</span><span class="n">pSMBr</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">lnoff</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">pSMBr</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">Flags2</span> <span class="o">&amp;</span> <span class="n">SMBFLG2_UNICODE</span><span class="p">)</span>
				<span class="n">psrch_inf</span><span class="o">-&gt;</span><span class="n">unicode</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">psrch_inf</span><span class="o">-&gt;</span><span class="n">unicode</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

			<span class="n">psrch_inf</span><span class="o">-&gt;</span><span class="n">ntwrk_buf_start</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">pSMBr</span><span class="p">;</span>
			<span class="n">psrch_inf</span><span class="o">-&gt;</span><span class="n">smallBuf</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">psrch_inf</span><span class="o">-&gt;</span><span class="n">srch_entries_start</span> <span class="o">=</span>
				<span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">pSMBr</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">Protocol</span> <span class="o">+</span>
					<span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">pSMBr</span><span class="o">-&gt;</span><span class="n">t2</span><span class="p">.</span><span class="n">DataOffset</span><span class="p">);</span>
			<span class="n">parms</span> <span class="o">=</span> <span class="p">(</span><span class="n">T2_FFIRST_RSP_PARMS</span> <span class="o">*</span><span class="p">)((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">pSMBr</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">Protocol</span> <span class="o">+</span>
			       <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">pSMBr</span><span class="o">-&gt;</span><span class="n">t2</span><span class="p">.</span><span class="n">ParameterOffset</span><span class="p">));</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">parms</span><span class="o">-&gt;</span><span class="n">EndofSearch</span><span class="p">)</span>
				<span class="n">psrch_inf</span><span class="o">-&gt;</span><span class="n">endOfSearch</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">psrch_inf</span><span class="o">-&gt;</span><span class="n">endOfSearch</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

			<span class="n">psrch_inf</span><span class="o">-&gt;</span><span class="n">entries_in_buffer</span> <span class="o">=</span>
					<span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">parms</span><span class="o">-&gt;</span><span class="n">SearchCount</span><span class="p">);</span>
			<span class="n">psrch_inf</span><span class="o">-&gt;</span><span class="n">index_of_last_entry</span> <span class="o">=</span> <span class="mi">2</span> <span class="cm">/* skip . and .. */</span> <span class="o">+</span>
				<span class="n">psrch_inf</span><span class="o">-&gt;</span><span class="n">entries_in_buffer</span><span class="p">;</span>
			<span class="n">lnoff</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">parms</span><span class="o">-&gt;</span><span class="n">LastNameOffset</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">CIFSMaxBufSize</span> <span class="o">&lt;</span> <span class="n">lnoff</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">cERROR</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;ignoring corrupt resume name&quot;</span><span class="p">);</span>
				<span class="n">psrch_inf</span><span class="o">-&gt;</span><span class="n">last_entry</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
				<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">psrch_inf</span><span class="o">-&gt;</span><span class="n">last_entry</span> <span class="o">=</span> <span class="n">psrch_inf</span><span class="o">-&gt;</span><span class="n">srch_entries_start</span> <span class="o">+</span>
							<span class="n">lnoff</span><span class="p">;</span>

			<span class="o">*</span><span class="n">pnetfid</span> <span class="o">=</span> <span class="n">parms</span><span class="o">-&gt;</span><span class="n">SearchHandle</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">cifs_buf_release</span><span class="p">(</span><span class="n">pSMB</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">CIFSFindNext</span><span class="p">(</span><span class="k">const</span> <span class="kt">int</span> <span class="n">xid</span><span class="p">,</span> <span class="k">struct</span> <span class="n">cifs_tcon</span> <span class="o">*</span><span class="n">tcon</span><span class="p">,</span> <span class="n">__u16</span> <span class="n">searchHandle</span><span class="p">,</span>
		 <span class="n">__u16</span> <span class="n">search_flags</span><span class="p">,</span> <span class="k">struct</span> <span class="n">cifs_search_info</span> <span class="o">*</span><span class="n">psrch_inf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">TRANSACTION2_FNEXT_REQ</span> <span class="o">*</span><span class="n">pSMB</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">TRANSACTION2_FNEXT_RSP</span> <span class="o">*</span><span class="n">pSMBr</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">T2_FNEXT_RSP_PARMS</span> <span class="o">*</span><span class="n">parms</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">response_data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">bytes_returned</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">name_len</span><span class="p">;</span>
	<span class="n">__u16</span> <span class="n">params</span><span class="p">,</span> <span class="n">byte_count</span><span class="p">;</span>

	<span class="n">cFYI</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;In FindNext&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">psrch_inf</span><span class="o">-&gt;</span><span class="n">endOfSearch</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">smb_init</span><span class="p">(</span><span class="n">SMB_COM_TRANSACTION2</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="n">tcon</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">**</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">pSMB</span><span class="p">,</span>
		<span class="p">(</span><span class="kt">void</span> <span class="o">**</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">pSMBr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">params</span> <span class="o">=</span> <span class="mi">14</span><span class="p">;</span> <span class="cm">/* includes 2 bytes of null string, converted to LE below*/</span>
	<span class="n">byte_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">TotalDataCount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>       <span class="cm">/* no EAs */</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">MaxParameterCount</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="mi">8</span><span class="p">);</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">MaxDataCount</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">CIFSMaxBufSize</span> <span class="o">&amp;</span> <span class="mh">0xFFFFFF00</span><span class="p">);</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">MaxSetupCount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">Reserved</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">Flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">Timeout</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">Reserved2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">ParameterOffset</span> <span class="o">=</span>  <span class="n">cpu_to_le16</span><span class="p">(</span>
	      <span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">smb_com_transaction2_fnext_req</span><span class="p">,</span><span class="n">SearchHandle</span><span class="p">)</span> <span class="o">-</span> <span class="mi">4</span><span class="p">);</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">DataCount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">DataOffset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">SetupCount</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">Reserved3</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">SubCommand</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">TRANS2_FIND_NEXT</span><span class="p">);</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">SearchHandle</span> <span class="o">=</span> <span class="n">searchHandle</span><span class="p">;</span>      <span class="cm">/* always kept as le */</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">SearchCount</span> <span class="o">=</span>
		<span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">CIFSMaxBufSize</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">FILE_UNIX_INFO</span><span class="p">));</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">InformationLevel</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">psrch_inf</span><span class="o">-&gt;</span><span class="n">info_level</span><span class="p">);</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">ResumeKey</span> <span class="o">=</span> <span class="n">psrch_inf</span><span class="o">-&gt;</span><span class="n">resume_key</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">SearchFlags</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">search_flags</span><span class="p">);</span>

	<span class="n">name_len</span> <span class="o">=</span> <span class="n">psrch_inf</span><span class="o">-&gt;</span><span class="n">resume_name_len</span><span class="p">;</span>
	<span class="n">params</span> <span class="o">+=</span> <span class="n">name_len</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">name_len</span> <span class="o">&lt;</span> <span class="n">PATH_MAX</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">ResumeFileName</span><span class="p">,</span> <span class="n">psrch_inf</span><span class="o">-&gt;</span><span class="n">presume_name</span><span class="p">,</span> <span class="n">name_len</span><span class="p">);</span>
		<span class="n">byte_count</span> <span class="o">+=</span> <span class="n">name_len</span><span class="p">;</span>
		<span class="cm">/* 14 byte parm len above enough for 2 byte null terminator */</span>
		<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">ResumeFileName</span><span class="p">[</span><span class="n">name_len</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">ResumeFileName</span><span class="p">[</span><span class="n">name_len</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">FNext2_err_exit</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">byte_count</span> <span class="o">=</span> <span class="n">params</span> <span class="o">+</span> <span class="mi">1</span> <span class="cm">/* pad */</span> <span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">TotalParameterCount</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">params</span><span class="p">);</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">ParameterCount</span> <span class="o">=</span> <span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">TotalParameterCount</span><span class="p">;</span>
	<span class="n">inc_rfc1001_len</span><span class="p">(</span><span class="n">pSMB</span><span class="p">,</span> <span class="n">byte_count</span><span class="p">);</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">ByteCount</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">byte_count</span><span class="p">);</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">SendReceive</span><span class="p">(</span><span class="n">xid</span><span class="p">,</span> <span class="n">tcon</span><span class="o">-&gt;</span><span class="n">ses</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">smb_hdr</span> <span class="o">*</span><span class="p">)</span> <span class="n">pSMB</span><span class="p">,</span>
			<span class="p">(</span><span class="k">struct</span> <span class="n">smb_hdr</span> <span class="o">*</span><span class="p">)</span> <span class="n">pSMBr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bytes_returned</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">cifs_stats_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tcon</span><span class="o">-&gt;</span><span class="n">num_fnext</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="o">-</span><span class="n">EBADF</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">psrch_inf</span><span class="o">-&gt;</span><span class="n">endOfSearch</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="n">cifs_buf_release</span><span class="p">(</span><span class="n">pSMB</span><span class="p">);</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* search probably was closed at end of search*/</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">cFYI</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;FindNext returned = %d&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>                <span class="cm">/* decode response */</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">validate_t2</span><span class="p">((</span><span class="k">struct</span> <span class="n">smb_t2_rsp</span> <span class="o">*</span><span class="p">)</span><span class="n">pSMBr</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">lnoff</span><span class="p">;</span>

			<span class="cm">/* BB fixme add lock for file (srch_info) struct here */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">pSMBr</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">Flags2</span> <span class="o">&amp;</span> <span class="n">SMBFLG2_UNICODE</span><span class="p">)</span>
				<span class="n">psrch_inf</span><span class="o">-&gt;</span><span class="n">unicode</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">psrch_inf</span><span class="o">-&gt;</span><span class="n">unicode</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
			<span class="n">response_data</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">pSMBr</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">Protocol</span> <span class="o">+</span>
			       <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">pSMBr</span><span class="o">-&gt;</span><span class="n">t2</span><span class="p">.</span><span class="n">ParameterOffset</span><span class="p">);</span>
			<span class="n">parms</span> <span class="o">=</span> <span class="p">(</span><span class="n">T2_FNEXT_RSP_PARMS</span> <span class="o">*</span><span class="p">)</span><span class="n">response_data</span><span class="p">;</span>
			<span class="n">response_data</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">pSMBr</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">Protocol</span> <span class="o">+</span>
				<span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">pSMBr</span><span class="o">-&gt;</span><span class="n">t2</span><span class="p">.</span><span class="n">DataOffset</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">psrch_inf</span><span class="o">-&gt;</span><span class="n">smallBuf</span><span class="p">)</span>
				<span class="n">cifs_small_buf_release</span><span class="p">(</span>
					<span class="n">psrch_inf</span><span class="o">-&gt;</span><span class="n">ntwrk_buf_start</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">cifs_buf_release</span><span class="p">(</span><span class="n">psrch_inf</span><span class="o">-&gt;</span><span class="n">ntwrk_buf_start</span><span class="p">);</span>
			<span class="n">psrch_inf</span><span class="o">-&gt;</span><span class="n">srch_entries_start</span> <span class="o">=</span> <span class="n">response_data</span><span class="p">;</span>
			<span class="n">psrch_inf</span><span class="o">-&gt;</span><span class="n">ntwrk_buf_start</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">pSMB</span><span class="p">;</span>
			<span class="n">psrch_inf</span><span class="o">-&gt;</span><span class="n">smallBuf</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">parms</span><span class="o">-&gt;</span><span class="n">EndofSearch</span><span class="p">)</span>
				<span class="n">psrch_inf</span><span class="o">-&gt;</span><span class="n">endOfSearch</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">psrch_inf</span><span class="o">-&gt;</span><span class="n">endOfSearch</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
			<span class="n">psrch_inf</span><span class="o">-&gt;</span><span class="n">entries_in_buffer</span> <span class="o">=</span>
						<span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">parms</span><span class="o">-&gt;</span><span class="n">SearchCount</span><span class="p">);</span>
			<span class="n">psrch_inf</span><span class="o">-&gt;</span><span class="n">index_of_last_entry</span> <span class="o">+=</span>
				<span class="n">psrch_inf</span><span class="o">-&gt;</span><span class="n">entries_in_buffer</span><span class="p">;</span>
			<span class="n">lnoff</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">parms</span><span class="o">-&gt;</span><span class="n">LastNameOffset</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">CIFSMaxBufSize</span> <span class="o">&lt;</span> <span class="n">lnoff</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">cERROR</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;ignoring corrupt resume name&quot;</span><span class="p">);</span>
				<span class="n">psrch_inf</span><span class="o">-&gt;</span><span class="n">last_entry</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
				<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span>
				<span class="n">psrch_inf</span><span class="o">-&gt;</span><span class="n">last_entry</span> <span class="o">=</span>
					<span class="n">psrch_inf</span><span class="o">-&gt;</span><span class="n">srch_entries_start</span> <span class="o">+</span> <span class="n">lnoff</span><span class="p">;</span>

<span class="cm">/*  cFYI(1, &quot;fnxt2 entries in buf %d index_of_last %d&quot;,</span>
<span class="cm">	    psrch_inf-&gt;entries_in_buffer, psrch_inf-&gt;index_of_last_entry); */</span>

			<span class="cm">/* BB fixme add unlock here */</span>
		<span class="p">}</span>

	<span class="p">}</span>

	<span class="cm">/* BB On error, should we leave previous search buf (and count and</span>
<span class="cm">	last entry fields) intact or free the previous one? */</span>

	<span class="cm">/* Note: On -EAGAIN error only caller can retry on handle based calls</span>
<span class="cm">	since file handle passed in no longer valid */</span>
<span class="nl">FNext2_err_exit:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">cifs_buf_release</span><span class="p">(</span><span class="n">pSMB</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="nf">CIFSFindClose</span><span class="p">(</span><span class="k">const</span> <span class="kt">int</span> <span class="n">xid</span><span class="p">,</span> <span class="k">struct</span> <span class="n">cifs_tcon</span> <span class="o">*</span><span class="n">tcon</span><span class="p">,</span>
	      <span class="k">const</span> <span class="n">__u16</span> <span class="n">searchHandle</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">FINDCLOSE_REQ</span> <span class="o">*</span><span class="n">pSMB</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">cFYI</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;In CIFSSMBFindClose&quot;</span><span class="p">);</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">small_smb_init</span><span class="p">(</span><span class="n">SMB_COM_FIND_CLOSE2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">tcon</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">**</span><span class="p">)</span><span class="o">&amp;</span><span class="n">pSMB</span><span class="p">);</span>

	<span class="cm">/* no sense returning error if session restarted</span>
<span class="cm">		as file handle has been closed */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">FileID</span> <span class="o">=</span> <span class="n">searchHandle</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">ByteCount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">SendReceiveNoRsp</span><span class="p">(</span><span class="n">xid</span><span class="p">,</span> <span class="n">tcon</span><span class="o">-&gt;</span><span class="n">ses</span><span class="p">,</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">pSMB</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="n">cERROR</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;Send error in FindClose = %d&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>

	<span class="n">cifs_stats_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tcon</span><span class="o">-&gt;</span><span class="n">num_fclose</span><span class="p">);</span>

	<span class="cm">/* Since session is dead, search handle closed on server already */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">)</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="nf">CIFSGetSrvInodeNumber</span><span class="p">(</span><span class="k">const</span> <span class="kt">int</span> <span class="n">xid</span><span class="p">,</span> <span class="k">struct</span> <span class="n">cifs_tcon</span> <span class="o">*</span><span class="n">tcon</span><span class="p">,</span>
		      <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">searchName</span><span class="p">,</span>
		      <span class="n">__u64</span> <span class="o">*</span><span class="n">inode_number</span><span class="p">,</span>
		      <span class="k">const</span> <span class="k">struct</span> <span class="n">nls_table</span> <span class="o">*</span><span class="n">nls_codepage</span><span class="p">,</span> <span class="kt">int</span> <span class="n">remap</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">TRANSACTION2_QPI_REQ</span> <span class="o">*</span><span class="n">pSMB</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">TRANSACTION2_QPI_RSP</span> <span class="o">*</span><span class="n">pSMBr</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">name_len</span><span class="p">,</span> <span class="n">bytes_returned</span><span class="p">;</span>
	<span class="n">__u16</span> <span class="n">params</span><span class="p">,</span> <span class="n">byte_count</span><span class="p">;</span>

	<span class="n">cFYI</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;In GetSrvInodeNum for %s&quot;</span><span class="p">,</span> <span class="n">searchName</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tcon</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

<span class="nl">GetInodeNumberRetry:</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">smb_init</span><span class="p">(</span><span class="n">SMB_COM_TRANSACTION2</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="n">tcon</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">**</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">pSMB</span><span class="p">,</span>
		      <span class="p">(</span><span class="kt">void</span> <span class="o">**</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">pSMBr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">Flags2</span> <span class="o">&amp;</span> <span class="n">SMBFLG2_UNICODE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">name_len</span> <span class="o">=</span>
			<span class="n">cifsConvertToUTF16</span><span class="p">((</span><span class="n">__le16</span> <span class="o">*</span><span class="p">)</span> <span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">FileName</span><span class="p">,</span>
					   <span class="n">searchName</span><span class="p">,</span> <span class="n">PATH_MAX</span><span class="p">,</span> <span class="n">nls_codepage</span><span class="p">,</span>
					   <span class="n">remap</span><span class="p">);</span>
		<span class="n">name_len</span><span class="o">++</span><span class="p">;</span>     <span class="cm">/* trailing null */</span>
		<span class="n">name_len</span> <span class="o">*=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>	<span class="cm">/* BB improve the check for buffer overruns BB */</span>
		<span class="n">name_len</span> <span class="o">=</span> <span class="n">strnlen</span><span class="p">(</span><span class="n">searchName</span><span class="p">,</span> <span class="n">PATH_MAX</span><span class="p">);</span>
		<span class="n">name_len</span><span class="o">++</span><span class="p">;</span>     <span class="cm">/* trailing null */</span>
		<span class="n">strncpy</span><span class="p">(</span><span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">FileName</span><span class="p">,</span> <span class="n">searchName</span><span class="p">,</span> <span class="n">name_len</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">params</span> <span class="o">=</span> <span class="mi">2</span> <span class="cm">/* level */</span>  <span class="o">+</span> <span class="mi">4</span> <span class="cm">/* rsrvd */</span>  <span class="o">+</span> <span class="n">name_len</span> <span class="cm">/* incl null */</span> <span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">TotalDataCount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">MaxParameterCount</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
	<span class="cm">/* BB find exact max data count below from sess structure BB */</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">MaxDataCount</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="mi">4000</span><span class="p">);</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">MaxSetupCount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">Reserved</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">Flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">Timeout</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">Reserved2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">ParameterOffset</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">offsetof</span><span class="p">(</span>
		<span class="k">struct</span> <span class="n">smb_com_transaction2_qpi_req</span><span class="p">,</span> <span class="n">InformationLevel</span><span class="p">)</span> <span class="o">-</span> <span class="mi">4</span><span class="p">);</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">DataCount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">DataOffset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">SetupCount</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">Reserved3</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">SubCommand</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">TRANS2_QUERY_PATH_INFORMATION</span><span class="p">);</span>
	<span class="n">byte_count</span> <span class="o">=</span> <span class="n">params</span> <span class="o">+</span> <span class="mi">1</span> <span class="cm">/* pad */</span> <span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">TotalParameterCount</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">params</span><span class="p">);</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">ParameterCount</span> <span class="o">=</span> <span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">TotalParameterCount</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">InformationLevel</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">SMB_QUERY_FILE_INTERNAL_INFO</span><span class="p">);</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">Reserved4</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">inc_rfc1001_len</span><span class="p">(</span><span class="n">pSMB</span><span class="p">,</span> <span class="n">byte_count</span><span class="p">);</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">ByteCount</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">byte_count</span><span class="p">);</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">SendReceive</span><span class="p">(</span><span class="n">xid</span><span class="p">,</span> <span class="n">tcon</span><span class="o">-&gt;</span><span class="n">ses</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">smb_hdr</span> <span class="o">*</span><span class="p">)</span> <span class="n">pSMB</span><span class="p">,</span>
		<span class="p">(</span><span class="k">struct</span> <span class="n">smb_hdr</span> <span class="o">*</span><span class="p">)</span> <span class="n">pSMBr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bytes_returned</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cFYI</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;error %d in QueryInternalInfo&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* decode response */</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">validate_t2</span><span class="p">((</span><span class="k">struct</span> <span class="n">smb_t2_rsp</span> <span class="o">*</span><span class="p">)</span><span class="n">pSMBr</span><span class="p">);</span>
		<span class="cm">/* BB also check enough total bytes returned */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">||</span> <span class="n">get_bcc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pSMBr</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span>
			<span class="cm">/* If rc should we check for EOPNOSUPP and</span>
<span class="cm">			disable the srvino flag? or in caller? */</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>      <span class="cm">/* bad smb */</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="n">__u16</span> <span class="n">data_offset</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">pSMBr</span><span class="o">-&gt;</span><span class="n">t2</span><span class="p">.</span><span class="n">DataOffset</span><span class="p">);</span>
			<span class="n">__u16</span> <span class="n">count</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">pSMBr</span><span class="o">-&gt;</span><span class="n">t2</span><span class="p">.</span><span class="n">DataCount</span><span class="p">);</span>
			<span class="k">struct</span> <span class="n">file_internal_info</span> <span class="o">*</span><span class="n">pfinfo</span><span class="p">;</span>
			<span class="cm">/* BB Do we need a cast or hash here ? */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">cFYI</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;Illegal size ret in QryIntrnlInf&quot;</span><span class="p">);</span>
				<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">GetInodeNumOut</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">pfinfo</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">file_internal_info</span> <span class="o">*</span><span class="p">)</span>
				<span class="p">(</span><span class="n">data_offset</span> <span class="o">+</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">pSMBr</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">Protocol</span><span class="p">);</span>
			<span class="o">*</span><span class="n">inode_number</span> <span class="o">=</span> <span class="n">le64_to_cpu</span><span class="p">(</span><span class="n">pfinfo</span><span class="o">-&gt;</span><span class="n">UniqueId</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="nl">GetInodeNumOut:</span>
	<span class="n">cifs_buf_release</span><span class="p">(</span><span class="n">pSMB</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">GetInodeNumberRetry</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* parses DFS refferal V3 structure</span>
<span class="cm"> * caller is responsible for freeing target_nodes</span>
<span class="cm"> * returns:</span>
<span class="cm"> * 	on success - 0</span>
<span class="cm"> *	on failure - errno</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">parse_DFS_referrals</span><span class="p">(</span><span class="n">TRANSACTION2_GET_DFS_REFER_RSP</span> <span class="o">*</span><span class="n">pSMBr</span><span class="p">,</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">num_of_nodes</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">dfs_info3_param</span> <span class="o">**</span><span class="n">target_nodes</span><span class="p">,</span>
		<span class="k">const</span> <span class="k">struct</span> <span class="n">nls_table</span> <span class="o">*</span><span class="n">nls_codepage</span><span class="p">,</span> <span class="kt">int</span> <span class="n">remap</span><span class="p">,</span>
		<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">searchName</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">data_end</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">is_unicode</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dfs_referral_level_3</span> <span class="o">*</span><span class="n">ref</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pSMBr</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">Flags2</span> <span class="o">&amp;</span> <span class="n">SMBFLG2_UNICODE</span><span class="p">)</span>
		<span class="n">is_unicode</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">is_unicode</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="o">*</span><span class="n">num_of_nodes</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">pSMBr</span><span class="o">-&gt;</span><span class="n">NumberOfReferrals</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">num_of_nodes</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cERROR</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;num_referrals: must be at least &gt; 0,&quot;</span>
			<span class="s">&quot;but we get num_referrals = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="o">*</span><span class="n">num_of_nodes</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">parse_DFS_referrals_exit</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ref</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">dfs_referral_level_3</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">pSMBr</span><span class="o">-&gt;</span><span class="n">referrals</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ref</span><span class="o">-&gt;</span><span class="n">VersionNumber</span> <span class="o">!=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">cERROR</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;Referrals of V%d version are not supported,&quot;</span>
			<span class="s">&quot;should be V3&quot;</span><span class="p">,</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">ref</span><span class="o">-&gt;</span><span class="n">VersionNumber</span><span class="p">));</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">parse_DFS_referrals_exit</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* get the upper boundary of the resp buffer */</span>
	<span class="n">data_end</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">pSMBr</span><span class="o">-&gt;</span><span class="n">PathConsumed</span><span class="p">))</span> <span class="o">+</span>
				<span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">pSMBr</span><span class="o">-&gt;</span><span class="n">t2</span><span class="p">.</span><span class="n">DataCount</span><span class="p">);</span>

	<span class="n">cFYI</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;num_referrals: %d dfs flags: 0x%x ...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="o">*</span><span class="n">num_of_nodes</span><span class="p">,</span>
			<span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">pSMBr</span><span class="o">-&gt;</span><span class="n">DFSFlags</span><span class="p">));</span>

	<span class="o">*</span><span class="n">target_nodes</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">dfs_info3_param</span><span class="p">)</span> <span class="o">*</span>
			<span class="o">*</span><span class="n">num_of_nodes</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">target_nodes</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cERROR</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;Failed to allocate buffer for target_nodes</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">parse_DFS_referrals_exit</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* collect necessary data from referrals */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="o">*</span><span class="n">num_of_nodes</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">char</span> <span class="o">*</span><span class="n">temp</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">max_len</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">dfs_info3_param</span> <span class="o">*</span><span class="n">node</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="n">target_nodes</span><span class="p">)</span><span class="o">+</span><span class="n">i</span><span class="p">;</span>

		<span class="n">node</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">pSMBr</span><span class="o">-&gt;</span><span class="n">DFSFlags</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">is_unicode</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">__le16</span> <span class="o">*</span><span class="n">tmp</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">strlen</span><span class="p">(</span><span class="n">searchName</span><span class="p">)</span><span class="o">*</span><span class="mi">2</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span>
						<span class="n">GFP_KERNEL</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">parse_DFS_referrals_exit</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">cifsConvertToUTF16</span><span class="p">((</span><span class="n">__le16</span> <span class="o">*</span><span class="p">)</span> <span class="n">tmp</span><span class="p">,</span> <span class="n">searchName</span><span class="p">,</span>
					   <span class="n">PATH_MAX</span><span class="p">,</span> <span class="n">nls_codepage</span><span class="p">,</span> <span class="n">remap</span><span class="p">);</span>
			<span class="n">node</span><span class="o">-&gt;</span><span class="n">path_consumed</span> <span class="o">=</span> <span class="n">cifs_utf16_bytes</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span>
					<span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">pSMBr</span><span class="o">-&gt;</span><span class="n">PathConsumed</span><span class="p">),</span>
					<span class="n">nls_codepage</span><span class="p">);</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">tmp</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">node</span><span class="o">-&gt;</span><span class="n">path_consumed</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">pSMBr</span><span class="o">-&gt;</span><span class="n">PathConsumed</span><span class="p">);</span>

		<span class="n">node</span><span class="o">-&gt;</span><span class="n">server_type</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">ref</span><span class="o">-&gt;</span><span class="n">ServerType</span><span class="p">);</span>
		<span class="n">node</span><span class="o">-&gt;</span><span class="n">ref_flag</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">ref</span><span class="o">-&gt;</span><span class="n">ReferralEntryFlags</span><span class="p">);</span>

		<span class="cm">/* copy DfsPath */</span>
		<span class="n">temp</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">ref</span> <span class="o">+</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">ref</span><span class="o">-&gt;</span><span class="n">DfsPathOffset</span><span class="p">);</span>
		<span class="n">max_len</span> <span class="o">=</span> <span class="n">data_end</span> <span class="o">-</span> <span class="n">temp</span><span class="p">;</span>
		<span class="n">node</span><span class="o">-&gt;</span><span class="n">path_name</span> <span class="o">=</span> <span class="n">cifs_strndup_from_utf16</span><span class="p">(</span><span class="n">temp</span><span class="p">,</span> <span class="n">max_len</span><span class="p">,</span>
						<span class="n">is_unicode</span><span class="p">,</span> <span class="n">nls_codepage</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">node</span><span class="o">-&gt;</span><span class="n">path_name</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">parse_DFS_referrals_exit</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* copy link target UNC */</span>
		<span class="n">temp</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">ref</span> <span class="o">+</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">ref</span><span class="o">-&gt;</span><span class="n">NetworkAddressOffset</span><span class="p">);</span>
		<span class="n">max_len</span> <span class="o">=</span> <span class="n">data_end</span> <span class="o">-</span> <span class="n">temp</span><span class="p">;</span>
		<span class="n">node</span><span class="o">-&gt;</span><span class="n">node_name</span> <span class="o">=</span> <span class="n">cifs_strndup_from_utf16</span><span class="p">(</span><span class="n">temp</span><span class="p">,</span> <span class="n">max_len</span><span class="p">,</span>
						<span class="n">is_unicode</span><span class="p">,</span> <span class="n">nls_codepage</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">node</span><span class="o">-&gt;</span><span class="n">node_name</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">parse_DFS_referrals_exit</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">ref</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">parse_DFS_referrals_exit:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">free_dfs_info_array</span><span class="p">(</span><span class="o">*</span><span class="n">target_nodes</span><span class="p">,</span> <span class="o">*</span><span class="n">num_of_nodes</span><span class="p">);</span>
		<span class="o">*</span><span class="n">target_nodes</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="o">*</span><span class="n">num_of_nodes</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="nf">CIFSGetDFSRefer</span><span class="p">(</span><span class="k">const</span> <span class="kt">int</span> <span class="n">xid</span><span class="p">,</span> <span class="k">struct</span> <span class="n">cifs_ses</span> <span class="o">*</span><span class="n">ses</span><span class="p">,</span>
		<span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">searchName</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">dfs_info3_param</span> <span class="o">**</span><span class="n">target_nodes</span><span class="p">,</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">num_of_nodes</span><span class="p">,</span>
		<span class="k">const</span> <span class="k">struct</span> <span class="n">nls_table</span> <span class="o">*</span><span class="n">nls_codepage</span><span class="p">,</span> <span class="kt">int</span> <span class="n">remap</span><span class="p">)</span>
<span class="p">{</span>
<span class="cm">/* TRANS2_GET_DFS_REFERRAL */</span>
	<span class="n">TRANSACTION2_GET_DFS_REFER_REQ</span> <span class="o">*</span><span class="n">pSMB</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">TRANSACTION2_GET_DFS_REFER_RSP</span> <span class="o">*</span><span class="n">pSMBr</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">bytes_returned</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">name_len</span><span class="p">;</span>
	<span class="n">__u16</span> <span class="n">params</span><span class="p">,</span> <span class="n">byte_count</span><span class="p">;</span>
	<span class="o">*</span><span class="n">num_of_nodes</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="o">*</span><span class="n">target_nodes</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">cFYI</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;In GetDFSRefer the path %s&quot;</span><span class="p">,</span> <span class="n">searchName</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ses</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
<span class="nl">getDFSRetry:</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">smb_init</span><span class="p">(</span><span class="n">SMB_COM_TRANSACTION2</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">**</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">pSMB</span><span class="p">,</span>
		      <span class="p">(</span><span class="kt">void</span> <span class="o">**</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">pSMBr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

	<span class="cm">/* server pointer checked in called function,</span>
<span class="cm">	but should never be null here anyway */</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">Mid</span> <span class="o">=</span> <span class="n">get_next_mid</span><span class="p">(</span><span class="n">ses</span><span class="o">-&gt;</span><span class="n">server</span><span class="p">);</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">Tid</span> <span class="o">=</span> <span class="n">ses</span><span class="o">-&gt;</span><span class="n">ipc_tid</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">Uid</span> <span class="o">=</span> <span class="n">ses</span><span class="o">-&gt;</span><span class="n">Suid</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ses</span><span class="o">-&gt;</span><span class="n">capabilities</span> <span class="o">&amp;</span> <span class="n">CAP_STATUS32</span><span class="p">)</span>
		<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">Flags2</span> <span class="o">|=</span> <span class="n">SMBFLG2_ERR_STATUS</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ses</span><span class="o">-&gt;</span><span class="n">capabilities</span> <span class="o">&amp;</span> <span class="n">CAP_DFS</span><span class="p">)</span>
		<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">Flags2</span> <span class="o">|=</span> <span class="n">SMBFLG2_DFS</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ses</span><span class="o">-&gt;</span><span class="n">capabilities</span> <span class="o">&amp;</span> <span class="n">CAP_UNICODE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">Flags2</span> <span class="o">|=</span> <span class="n">SMBFLG2_UNICODE</span><span class="p">;</span>
		<span class="n">name_len</span> <span class="o">=</span>
		    <span class="n">cifsConvertToUTF16</span><span class="p">((</span><span class="n">__le16</span> <span class="o">*</span><span class="p">)</span> <span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">RequestFileName</span><span class="p">,</span>
				       <span class="n">searchName</span><span class="p">,</span> <span class="n">PATH_MAX</span><span class="p">,</span> <span class="n">nls_codepage</span><span class="p">,</span>
				       <span class="n">remap</span><span class="p">);</span>
		<span class="n">name_len</span><span class="o">++</span><span class="p">;</span>	<span class="cm">/* trailing null */</span>
		<span class="n">name_len</span> <span class="o">*=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>	<span class="cm">/* BB improve the check for buffer overruns BB */</span>
		<span class="n">name_len</span> <span class="o">=</span> <span class="n">strnlen</span><span class="p">(</span><span class="n">searchName</span><span class="p">,</span> <span class="n">PATH_MAX</span><span class="p">);</span>
		<span class="n">name_len</span><span class="o">++</span><span class="p">;</span>	<span class="cm">/* trailing null */</span>
		<span class="n">strncpy</span><span class="p">(</span><span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">RequestFileName</span><span class="p">,</span> <span class="n">searchName</span><span class="p">,</span> <span class="n">name_len</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ses</span><span class="o">-&gt;</span><span class="n">server</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ses</span><span class="o">-&gt;</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">sec_mode</span> <span class="o">&amp;</span>
		   <span class="p">(</span><span class="n">SECMODE_SIGN_REQUIRED</span> <span class="o">|</span> <span class="n">SECMODE_SIGN_ENABLED</span><span class="p">))</span>
			<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">Flags2</span> <span class="o">|=</span> <span class="n">SMBFLG2_SECURITY_SIGNATURE</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">Uid</span> <span class="o">=</span> <span class="n">ses</span><span class="o">-&gt;</span><span class="n">Suid</span><span class="p">;</span>

	<span class="n">params</span> <span class="o">=</span> <span class="mi">2</span> <span class="cm">/* level */</span>  <span class="o">+</span> <span class="n">name_len</span> <span class="cm">/*includes null */</span> <span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">TotalDataCount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">DataCount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">DataOffset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">MaxParameterCount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="cm">/* BB find exact max SMB PDU from sess structure BB */</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">MaxDataCount</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="mi">4000</span><span class="p">);</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">MaxSetupCount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">Reserved</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">Flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">Timeout</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">Reserved2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">ParameterOffset</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">offsetof</span><span class="p">(</span>
	  <span class="k">struct</span> <span class="n">smb_com_transaction2_get_dfs_refer_req</span><span class="p">,</span> <span class="n">MaxReferralLevel</span><span class="p">)</span> <span class="o">-</span> <span class="mi">4</span><span class="p">);</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">SetupCount</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">Reserved3</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">SubCommand</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">TRANS2_GET_DFS_REFERRAL</span><span class="p">);</span>
	<span class="n">byte_count</span> <span class="o">=</span> <span class="n">params</span> <span class="o">+</span> <span class="mi">3</span> <span class="cm">/* pad */</span> <span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">ParameterCount</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">params</span><span class="p">);</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">TotalParameterCount</span> <span class="o">=</span> <span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">ParameterCount</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">MaxReferralLevel</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="mi">3</span><span class="p">);</span>
	<span class="n">inc_rfc1001_len</span><span class="p">(</span><span class="n">pSMB</span><span class="p">,</span> <span class="n">byte_count</span><span class="p">);</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">ByteCount</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">byte_count</span><span class="p">);</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">SendReceive</span><span class="p">(</span><span class="n">xid</span><span class="p">,</span> <span class="n">ses</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">smb_hdr</span> <span class="o">*</span><span class="p">)</span> <span class="n">pSMB</span><span class="p">,</span>
			 <span class="p">(</span><span class="k">struct</span> <span class="n">smb_hdr</span> <span class="o">*</span><span class="p">)</span> <span class="n">pSMBr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bytes_returned</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cFYI</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;Send error in GetDFSRefer = %d&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">GetDFSRefExit</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">validate_t2</span><span class="p">((</span><span class="k">struct</span> <span class="n">smb_t2_rsp</span> <span class="o">*</span><span class="p">)</span><span class="n">pSMBr</span><span class="p">);</span>

	<span class="cm">/* BB Also check if enough total bytes returned? */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">||</span> <span class="n">get_bcc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pSMBr</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">17</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>      <span class="cm">/* bad smb */</span>
		<span class="k">goto</span> <span class="n">GetDFSRefExit</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">cFYI</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;Decoding GetDFSRefer response BCC: %d  Offset %d&quot;</span><span class="p">,</span>
				<span class="n">get_bcc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pSMBr</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">),</span>
				<span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">pSMBr</span><span class="o">-&gt;</span><span class="n">t2</span><span class="p">.</span><span class="n">DataOffset</span><span class="p">));</span>

	<span class="cm">/* parse returned result into more usable form */</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">parse_DFS_referrals</span><span class="p">(</span><span class="n">pSMBr</span><span class="p">,</span> <span class="n">num_of_nodes</span><span class="p">,</span>
				 <span class="n">target_nodes</span><span class="p">,</span> <span class="n">nls_codepage</span><span class="p">,</span> <span class="n">remap</span><span class="p">,</span>
				 <span class="n">searchName</span><span class="p">);</span>

<span class="nl">GetDFSRefExit:</span>
	<span class="n">cifs_buf_release</span><span class="p">(</span><span class="n">pSMB</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">getDFSRetry</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Query File System Info such as free space to old servers such as Win 9x */</span>
<span class="kt">int</span>
<span class="nf">SMBOldQFSInfo</span><span class="p">(</span><span class="k">const</span> <span class="kt">int</span> <span class="n">xid</span><span class="p">,</span> <span class="k">struct</span> <span class="n">cifs_tcon</span> <span class="o">*</span><span class="n">tcon</span><span class="p">,</span> <span class="k">struct</span> <span class="n">kstatfs</span> <span class="o">*</span><span class="n">FSData</span><span class="p">)</span>
<span class="p">{</span>
<span class="cm">/* level 0x01 SMB_QUERY_FILE_SYSTEM_INFO */</span>
	<span class="n">TRANSACTION2_QFSI_REQ</span> <span class="o">*</span><span class="n">pSMB</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">TRANSACTION2_QFSI_RSP</span> <span class="o">*</span><span class="n">pSMBr</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">FILE_SYSTEM_ALLOC_INFO</span> <span class="o">*</span><span class="n">response_data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">bytes_returned</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">__u16</span> <span class="n">params</span><span class="p">,</span> <span class="n">byte_count</span><span class="p">;</span>

	<span class="n">cFYI</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;OldQFSInfo&quot;</span><span class="p">);</span>
<span class="nl">oldQFSInfoRetry:</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">smb_init</span><span class="p">(</span><span class="n">SMB_COM_TRANSACTION2</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="n">tcon</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">**</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">pSMB</span><span class="p">,</span>
		<span class="p">(</span><span class="kt">void</span> <span class="o">**</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">pSMBr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">params</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>     <span class="cm">/* level */</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">TotalDataCount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">MaxParameterCount</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">MaxDataCount</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="mi">1000</span><span class="p">);</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">MaxSetupCount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">Reserved</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">Flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">Timeout</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">Reserved2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">byte_count</span> <span class="o">=</span> <span class="n">params</span> <span class="o">+</span> <span class="mi">1</span> <span class="cm">/* pad */</span> <span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">TotalParameterCount</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">params</span><span class="p">);</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">ParameterCount</span> <span class="o">=</span> <span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">TotalParameterCount</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">ParameterOffset</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">offsetof</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">smb_com_transaction2_qfsi_req</span><span class="p">,</span> <span class="n">InformationLevel</span><span class="p">)</span> <span class="o">-</span> <span class="mi">4</span><span class="p">);</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">DataCount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">DataOffset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">SetupCount</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">Reserved3</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">SubCommand</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">TRANS2_QUERY_FS_INFORMATION</span><span class="p">);</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">InformationLevel</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">SMB_INFO_ALLOCATION</span><span class="p">);</span>
	<span class="n">inc_rfc1001_len</span><span class="p">(</span><span class="n">pSMB</span><span class="p">,</span> <span class="n">byte_count</span><span class="p">);</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">ByteCount</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">byte_count</span><span class="p">);</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">SendReceive</span><span class="p">(</span><span class="n">xid</span><span class="p">,</span> <span class="n">tcon</span><span class="o">-&gt;</span><span class="n">ses</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">smb_hdr</span> <span class="o">*</span><span class="p">)</span> <span class="n">pSMB</span><span class="p">,</span>
		<span class="p">(</span><span class="k">struct</span> <span class="n">smb_hdr</span> <span class="o">*</span><span class="p">)</span> <span class="n">pSMBr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bytes_returned</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cFYI</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;Send error in QFSInfo = %d&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>                <span class="cm">/* decode response */</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">validate_t2</span><span class="p">((</span><span class="k">struct</span> <span class="n">smb_t2_rsp</span> <span class="o">*</span><span class="p">)</span><span class="n">pSMBr</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">||</span> <span class="n">get_bcc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pSMBr</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">18</span><span class="p">)</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>      <span class="cm">/* bad smb */</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="n">__u16</span> <span class="n">data_offset</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">pSMBr</span><span class="o">-&gt;</span><span class="n">t2</span><span class="p">.</span><span class="n">DataOffset</span><span class="p">);</span>
			<span class="n">cFYI</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;qfsinf resp BCC: %d  Offset %d&quot;</span><span class="p">,</span>
				 <span class="n">get_bcc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pSMBr</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">),</span> <span class="n">data_offset</span><span class="p">);</span>

			<span class="n">response_data</span> <span class="o">=</span> <span class="p">(</span><span class="n">FILE_SYSTEM_ALLOC_INFO</span> <span class="o">*</span><span class="p">)</span>
				<span class="p">(((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">pSMBr</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">Protocol</span><span class="p">)</span> <span class="o">+</span> <span class="n">data_offset</span><span class="p">);</span>
			<span class="n">FSData</span><span class="o">-&gt;</span><span class="n">f_bsize</span> <span class="o">=</span>
				<span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">response_data</span><span class="o">-&gt;</span><span class="n">BytesPerSector</span><span class="p">)</span> <span class="o">*</span>
				<span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">response_data</span><span class="o">-&gt;</span>
					<span class="n">SectorsPerAllocationUnit</span><span class="p">);</span>
			<span class="n">FSData</span><span class="o">-&gt;</span><span class="n">f_blocks</span> <span class="o">=</span>
			       <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">response_data</span><span class="o">-&gt;</span><span class="n">TotalAllocationUnits</span><span class="p">);</span>
			<span class="n">FSData</span><span class="o">-&gt;</span><span class="n">f_bfree</span> <span class="o">=</span> <span class="n">FSData</span><span class="o">-&gt;</span><span class="n">f_bavail</span> <span class="o">=</span>
				<span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">response_data</span><span class="o">-&gt;</span><span class="n">FreeAllocationUnits</span><span class="p">);</span>
			<span class="n">cFYI</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;Blocks: %lld  Free: %lld Block size %ld&quot;</span><span class="p">,</span>
			     <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">FSData</span><span class="o">-&gt;</span><span class="n">f_blocks</span><span class="p">,</span>
			     <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">FSData</span><span class="o">-&gt;</span><span class="n">f_bfree</span><span class="p">,</span>
			     <span class="n">FSData</span><span class="o">-&gt;</span><span class="n">f_bsize</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">cifs_buf_release</span><span class="p">(</span><span class="n">pSMB</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">oldQFSInfoRetry</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="nf">CIFSSMBQFSInfo</span><span class="p">(</span><span class="k">const</span> <span class="kt">int</span> <span class="n">xid</span><span class="p">,</span> <span class="k">struct</span> <span class="n">cifs_tcon</span> <span class="o">*</span><span class="n">tcon</span><span class="p">,</span> <span class="k">struct</span> <span class="n">kstatfs</span> <span class="o">*</span><span class="n">FSData</span><span class="p">)</span>
<span class="p">{</span>
<span class="cm">/* level 0x103 SMB_QUERY_FILE_SYSTEM_INFO */</span>
	<span class="n">TRANSACTION2_QFSI_REQ</span> <span class="o">*</span><span class="n">pSMB</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">TRANSACTION2_QFSI_RSP</span> <span class="o">*</span><span class="n">pSMBr</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">FILE_SYSTEM_INFO</span> <span class="o">*</span><span class="n">response_data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">bytes_returned</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">__u16</span> <span class="n">params</span><span class="p">,</span> <span class="n">byte_count</span><span class="p">;</span>

	<span class="n">cFYI</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;In QFSInfo&quot;</span><span class="p">);</span>
<span class="nl">QFSInfoRetry:</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">smb_init</span><span class="p">(</span><span class="n">SMB_COM_TRANSACTION2</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="n">tcon</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">**</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">pSMB</span><span class="p">,</span>
		      <span class="p">(</span><span class="kt">void</span> <span class="o">**</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">pSMBr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">params</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>	<span class="cm">/* level */</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">TotalDataCount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">MaxParameterCount</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">MaxDataCount</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="mi">1000</span><span class="p">);</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">MaxSetupCount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">Reserved</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">Flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">Timeout</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">Reserved2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">byte_count</span> <span class="o">=</span> <span class="n">params</span> <span class="o">+</span> <span class="mi">1</span> <span class="cm">/* pad */</span> <span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">TotalParameterCount</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">params</span><span class="p">);</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">ParameterCount</span> <span class="o">=</span> <span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">TotalParameterCount</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">ParameterOffset</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">offsetof</span><span class="p">(</span>
		<span class="k">struct</span> <span class="n">smb_com_transaction2_qfsi_req</span><span class="p">,</span> <span class="n">InformationLevel</span><span class="p">)</span> <span class="o">-</span> <span class="mi">4</span><span class="p">);</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">DataCount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">DataOffset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">SetupCount</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">Reserved3</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">SubCommand</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">TRANS2_QUERY_FS_INFORMATION</span><span class="p">);</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">InformationLevel</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">SMB_QUERY_FS_SIZE_INFO</span><span class="p">);</span>
	<span class="n">inc_rfc1001_len</span><span class="p">(</span><span class="n">pSMB</span><span class="p">,</span> <span class="n">byte_count</span><span class="p">);</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">ByteCount</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">byte_count</span><span class="p">);</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">SendReceive</span><span class="p">(</span><span class="n">xid</span><span class="p">,</span> <span class="n">tcon</span><span class="o">-&gt;</span><span class="n">ses</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">smb_hdr</span> <span class="o">*</span><span class="p">)</span> <span class="n">pSMB</span><span class="p">,</span>
			 <span class="p">(</span><span class="k">struct</span> <span class="n">smb_hdr</span> <span class="o">*</span><span class="p">)</span> <span class="n">pSMBr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bytes_returned</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cFYI</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;Send error in QFSInfo = %d&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>		<span class="cm">/* decode response */</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">validate_t2</span><span class="p">((</span><span class="k">struct</span> <span class="n">smb_t2_rsp</span> <span class="o">*</span><span class="p">)</span><span class="n">pSMBr</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">||</span> <span class="n">get_bcc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pSMBr</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">24</span><span class="p">)</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>	<span class="cm">/* bad smb */</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="n">__u16</span> <span class="n">data_offset</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">pSMBr</span><span class="o">-&gt;</span><span class="n">t2</span><span class="p">.</span><span class="n">DataOffset</span><span class="p">);</span>

			<span class="n">response_data</span> <span class="o">=</span>
			    <span class="p">(</span><span class="n">FILE_SYSTEM_INFO</span>
			     <span class="o">*</span><span class="p">)</span> <span class="p">(((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">pSMBr</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">Protocol</span><span class="p">)</span> <span class="o">+</span>
				 <span class="n">data_offset</span><span class="p">);</span>
			<span class="n">FSData</span><span class="o">-&gt;</span><span class="n">f_bsize</span> <span class="o">=</span>
			    <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">response_data</span><span class="o">-&gt;</span><span class="n">BytesPerSector</span><span class="p">)</span> <span class="o">*</span>
			    <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">response_data</span><span class="o">-&gt;</span>
					<span class="n">SectorsPerAllocationUnit</span><span class="p">);</span>
			<span class="n">FSData</span><span class="o">-&gt;</span><span class="n">f_blocks</span> <span class="o">=</span>
			    <span class="n">le64_to_cpu</span><span class="p">(</span><span class="n">response_data</span><span class="o">-&gt;</span><span class="n">TotalAllocationUnits</span><span class="p">);</span>
			<span class="n">FSData</span><span class="o">-&gt;</span><span class="n">f_bfree</span> <span class="o">=</span> <span class="n">FSData</span><span class="o">-&gt;</span><span class="n">f_bavail</span> <span class="o">=</span>
			    <span class="n">le64_to_cpu</span><span class="p">(</span><span class="n">response_data</span><span class="o">-&gt;</span><span class="n">FreeAllocationUnits</span><span class="p">);</span>
			<span class="n">cFYI</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;Blocks: %lld  Free: %lld Block size %ld&quot;</span><span class="p">,</span>
			     <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">FSData</span><span class="o">-&gt;</span><span class="n">f_blocks</span><span class="p">,</span>
			     <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">FSData</span><span class="o">-&gt;</span><span class="n">f_bfree</span><span class="p">,</span>
			     <span class="n">FSData</span><span class="o">-&gt;</span><span class="n">f_bsize</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">cifs_buf_release</span><span class="p">(</span><span class="n">pSMB</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">QFSInfoRetry</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="nf">CIFSSMBQFSAttributeInfo</span><span class="p">(</span><span class="k">const</span> <span class="kt">int</span> <span class="n">xid</span><span class="p">,</span> <span class="k">struct</span> <span class="n">cifs_tcon</span> <span class="o">*</span><span class="n">tcon</span><span class="p">)</span>
<span class="p">{</span>
<span class="cm">/* level 0x105  SMB_QUERY_FILE_SYSTEM_INFO */</span>
	<span class="n">TRANSACTION2_QFSI_REQ</span> <span class="o">*</span><span class="n">pSMB</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">TRANSACTION2_QFSI_RSP</span> <span class="o">*</span><span class="n">pSMBr</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">FILE_SYSTEM_ATTRIBUTE_INFO</span> <span class="o">*</span><span class="n">response_data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">bytes_returned</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">__u16</span> <span class="n">params</span><span class="p">,</span> <span class="n">byte_count</span><span class="p">;</span>

	<span class="n">cFYI</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;In QFSAttributeInfo&quot;</span><span class="p">);</span>
<span class="nl">QFSAttributeRetry:</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">smb_init</span><span class="p">(</span><span class="n">SMB_COM_TRANSACTION2</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="n">tcon</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">**</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">pSMB</span><span class="p">,</span>
		      <span class="p">(</span><span class="kt">void</span> <span class="o">**</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">pSMBr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">params</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>	<span class="cm">/* level */</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">TotalDataCount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">MaxParameterCount</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
	<span class="cm">/* BB find exact max SMB PDU from sess structure BB */</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">MaxDataCount</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="mi">1000</span><span class="p">);</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">MaxSetupCount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">Reserved</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">Flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">Timeout</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">Reserved2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">byte_count</span> <span class="o">=</span> <span class="n">params</span> <span class="o">+</span> <span class="mi">1</span> <span class="cm">/* pad */</span> <span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">TotalParameterCount</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">params</span><span class="p">);</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">ParameterCount</span> <span class="o">=</span> <span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">TotalParameterCount</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">ParameterOffset</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">offsetof</span><span class="p">(</span>
		<span class="k">struct</span> <span class="n">smb_com_transaction2_qfsi_req</span><span class="p">,</span> <span class="n">InformationLevel</span><span class="p">)</span> <span class="o">-</span> <span class="mi">4</span><span class="p">);</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">DataCount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">DataOffset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">SetupCount</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">Reserved3</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">SubCommand</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">TRANS2_QUERY_FS_INFORMATION</span><span class="p">);</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">InformationLevel</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">SMB_QUERY_FS_ATTRIBUTE_INFO</span><span class="p">);</span>
	<span class="n">inc_rfc1001_len</span><span class="p">(</span><span class="n">pSMB</span><span class="p">,</span> <span class="n">byte_count</span><span class="p">);</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">ByteCount</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">byte_count</span><span class="p">);</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">SendReceive</span><span class="p">(</span><span class="n">xid</span><span class="p">,</span> <span class="n">tcon</span><span class="o">-&gt;</span><span class="n">ses</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">smb_hdr</span> <span class="o">*</span><span class="p">)</span> <span class="n">pSMB</span><span class="p">,</span>
			 <span class="p">(</span><span class="k">struct</span> <span class="n">smb_hdr</span> <span class="o">*</span><span class="p">)</span> <span class="n">pSMBr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bytes_returned</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cERROR</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;Send error in QFSAttributeInfo = %d&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>		<span class="cm">/* decode response */</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">validate_t2</span><span class="p">((</span><span class="k">struct</span> <span class="n">smb_t2_rsp</span> <span class="o">*</span><span class="p">)</span><span class="n">pSMBr</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">||</span> <span class="n">get_bcc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pSMBr</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">13</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* BB also check if enough bytes returned */</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>	<span class="cm">/* bad smb */</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">__u16</span> <span class="n">data_offset</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">pSMBr</span><span class="o">-&gt;</span><span class="n">t2</span><span class="p">.</span><span class="n">DataOffset</span><span class="p">);</span>
			<span class="n">response_data</span> <span class="o">=</span>
			    <span class="p">(</span><span class="n">FILE_SYSTEM_ATTRIBUTE_INFO</span>
			     <span class="o">*</span><span class="p">)</span> <span class="p">(((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">pSMBr</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">Protocol</span><span class="p">)</span> <span class="o">+</span>
				 <span class="n">data_offset</span><span class="p">);</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tcon</span><span class="o">-&gt;</span><span class="n">fsAttrInfo</span><span class="p">,</span> <span class="n">response_data</span><span class="p">,</span>
			       <span class="k">sizeof</span><span class="p">(</span><span class="n">FILE_SYSTEM_ATTRIBUTE_INFO</span><span class="p">));</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">cifs_buf_release</span><span class="p">(</span><span class="n">pSMB</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">QFSAttributeRetry</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="nf">CIFSSMBQFSDeviceInfo</span><span class="p">(</span><span class="k">const</span> <span class="kt">int</span> <span class="n">xid</span><span class="p">,</span> <span class="k">struct</span> <span class="n">cifs_tcon</span> <span class="o">*</span><span class="n">tcon</span><span class="p">)</span>
<span class="p">{</span>
<span class="cm">/* level 0x104 SMB_QUERY_FILE_SYSTEM_INFO */</span>
	<span class="n">TRANSACTION2_QFSI_REQ</span> <span class="o">*</span><span class="n">pSMB</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">TRANSACTION2_QFSI_RSP</span> <span class="o">*</span><span class="n">pSMBr</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">FILE_SYSTEM_DEVICE_INFO</span> <span class="o">*</span><span class="n">response_data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">bytes_returned</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">__u16</span> <span class="n">params</span><span class="p">,</span> <span class="n">byte_count</span><span class="p">;</span>

	<span class="n">cFYI</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;In QFSDeviceInfo&quot;</span><span class="p">);</span>
<span class="nl">QFSDeviceRetry:</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">smb_init</span><span class="p">(</span><span class="n">SMB_COM_TRANSACTION2</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="n">tcon</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">**</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">pSMB</span><span class="p">,</span>
		      <span class="p">(</span><span class="kt">void</span> <span class="o">**</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">pSMBr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">params</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>	<span class="cm">/* level */</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">TotalDataCount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">MaxParameterCount</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
	<span class="cm">/* BB find exact max SMB PDU from sess structure BB */</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">MaxDataCount</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="mi">1000</span><span class="p">);</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">MaxSetupCount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">Reserved</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">Flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">Timeout</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">Reserved2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">byte_count</span> <span class="o">=</span> <span class="n">params</span> <span class="o">+</span> <span class="mi">1</span> <span class="cm">/* pad */</span> <span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">TotalParameterCount</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">params</span><span class="p">);</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">ParameterCount</span> <span class="o">=</span> <span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">TotalParameterCount</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">ParameterOffset</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">offsetof</span><span class="p">(</span>
		<span class="k">struct</span> <span class="n">smb_com_transaction2_qfsi_req</span><span class="p">,</span> <span class="n">InformationLevel</span><span class="p">)</span> <span class="o">-</span> <span class="mi">4</span><span class="p">);</span>

	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">DataCount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">DataOffset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">SetupCount</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">Reserved3</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">SubCommand</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">TRANS2_QUERY_FS_INFORMATION</span><span class="p">);</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">InformationLevel</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">SMB_QUERY_FS_DEVICE_INFO</span><span class="p">);</span>
	<span class="n">inc_rfc1001_len</span><span class="p">(</span><span class="n">pSMB</span><span class="p">,</span> <span class="n">byte_count</span><span class="p">);</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">ByteCount</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">byte_count</span><span class="p">);</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">SendReceive</span><span class="p">(</span><span class="n">xid</span><span class="p">,</span> <span class="n">tcon</span><span class="o">-&gt;</span><span class="n">ses</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">smb_hdr</span> <span class="o">*</span><span class="p">)</span> <span class="n">pSMB</span><span class="p">,</span>
			 <span class="p">(</span><span class="k">struct</span> <span class="n">smb_hdr</span> <span class="o">*</span><span class="p">)</span> <span class="n">pSMBr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bytes_returned</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cFYI</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;Send error in QFSDeviceInfo = %d&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>		<span class="cm">/* decode response */</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">validate_t2</span><span class="p">((</span><span class="k">struct</span> <span class="n">smb_t2_rsp</span> <span class="o">*</span><span class="p">)</span><span class="n">pSMBr</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">||</span> <span class="n">get_bcc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pSMBr</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">)</span> <span class="o">&lt;</span>
			  <span class="k">sizeof</span><span class="p">(</span><span class="n">FILE_SYSTEM_DEVICE_INFO</span><span class="p">))</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>	<span class="cm">/* bad smb */</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="n">__u16</span> <span class="n">data_offset</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">pSMBr</span><span class="o">-&gt;</span><span class="n">t2</span><span class="p">.</span><span class="n">DataOffset</span><span class="p">);</span>
			<span class="n">response_data</span> <span class="o">=</span>
			    <span class="p">(</span><span class="n">FILE_SYSTEM_DEVICE_INFO</span> <span class="o">*</span><span class="p">)</span>
				<span class="p">(((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">pSMBr</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">Protocol</span><span class="p">)</span> <span class="o">+</span>
				 <span class="n">data_offset</span><span class="p">);</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tcon</span><span class="o">-&gt;</span><span class="n">fsDevInfo</span><span class="p">,</span> <span class="n">response_data</span><span class="p">,</span>
			       <span class="k">sizeof</span><span class="p">(</span><span class="n">FILE_SYSTEM_DEVICE_INFO</span><span class="p">));</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">cifs_buf_release</span><span class="p">(</span><span class="n">pSMB</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">QFSDeviceRetry</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="nf">CIFSSMBQFSUnixInfo</span><span class="p">(</span><span class="k">const</span> <span class="kt">int</span> <span class="n">xid</span><span class="p">,</span> <span class="k">struct</span> <span class="n">cifs_tcon</span> <span class="o">*</span><span class="n">tcon</span><span class="p">)</span>
<span class="p">{</span>
<span class="cm">/* level 0x200  SMB_QUERY_CIFS_UNIX_INFO */</span>
	<span class="n">TRANSACTION2_QFSI_REQ</span> <span class="o">*</span><span class="n">pSMB</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">TRANSACTION2_QFSI_RSP</span> <span class="o">*</span><span class="n">pSMBr</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">FILE_SYSTEM_UNIX_INFO</span> <span class="o">*</span><span class="n">response_data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">bytes_returned</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">__u16</span> <span class="n">params</span><span class="p">,</span> <span class="n">byte_count</span><span class="p">;</span>

	<span class="n">cFYI</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;In QFSUnixInfo&quot;</span><span class="p">);</span>
<span class="nl">QFSUnixRetry:</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">smb_init_no_reconnect</span><span class="p">(</span><span class="n">SMB_COM_TRANSACTION2</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="n">tcon</span><span class="p">,</span>
				   <span class="p">(</span><span class="kt">void</span> <span class="o">**</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">pSMB</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">**</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">pSMBr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">params</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>	<span class="cm">/* level */</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">TotalDataCount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">DataCount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">DataOffset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">MaxParameterCount</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
	<span class="cm">/* BB find exact max SMB PDU from sess structure BB */</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">MaxDataCount</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">MaxSetupCount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">Reserved</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">Flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">Timeout</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">Reserved2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">byte_count</span> <span class="o">=</span> <span class="n">params</span> <span class="o">+</span> <span class="mi">1</span> <span class="cm">/* pad */</span> <span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">ParameterCount</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">params</span><span class="p">);</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">TotalParameterCount</span> <span class="o">=</span> <span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">ParameterCount</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">ParameterOffset</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span>
			<span class="n">smb_com_transaction2_qfsi_req</span><span class="p">,</span> <span class="n">InformationLevel</span><span class="p">)</span> <span class="o">-</span> <span class="mi">4</span><span class="p">);</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">SetupCount</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">Reserved3</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">SubCommand</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">TRANS2_QUERY_FS_INFORMATION</span><span class="p">);</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">InformationLevel</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">SMB_QUERY_CIFS_UNIX_INFO</span><span class="p">);</span>
	<span class="n">inc_rfc1001_len</span><span class="p">(</span><span class="n">pSMB</span><span class="p">,</span> <span class="n">byte_count</span><span class="p">);</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">ByteCount</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">byte_count</span><span class="p">);</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">SendReceive</span><span class="p">(</span><span class="n">xid</span><span class="p">,</span> <span class="n">tcon</span><span class="o">-&gt;</span><span class="n">ses</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">smb_hdr</span> <span class="o">*</span><span class="p">)</span> <span class="n">pSMB</span><span class="p">,</span>
			 <span class="p">(</span><span class="k">struct</span> <span class="n">smb_hdr</span> <span class="o">*</span><span class="p">)</span> <span class="n">pSMBr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bytes_returned</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cERROR</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;Send error in QFSUnixInfo = %d&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>		<span class="cm">/* decode response */</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">validate_t2</span><span class="p">((</span><span class="k">struct</span> <span class="n">smb_t2_rsp</span> <span class="o">*</span><span class="p">)</span><span class="n">pSMBr</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">||</span> <span class="n">get_bcc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pSMBr</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">13</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>	<span class="cm">/* bad smb */</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">__u16</span> <span class="n">data_offset</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">pSMBr</span><span class="o">-&gt;</span><span class="n">t2</span><span class="p">.</span><span class="n">DataOffset</span><span class="p">);</span>
			<span class="n">response_data</span> <span class="o">=</span>
			    <span class="p">(</span><span class="n">FILE_SYSTEM_UNIX_INFO</span>
			     <span class="o">*</span><span class="p">)</span> <span class="p">(((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">pSMBr</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">Protocol</span><span class="p">)</span> <span class="o">+</span>
				 <span class="n">data_offset</span><span class="p">);</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tcon</span><span class="o">-&gt;</span><span class="n">fsUnixInfo</span><span class="p">,</span> <span class="n">response_data</span><span class="p">,</span>
			       <span class="k">sizeof</span><span class="p">(</span><span class="n">FILE_SYSTEM_UNIX_INFO</span><span class="p">));</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">cifs_buf_release</span><span class="p">(</span><span class="n">pSMB</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">QFSUnixRetry</span><span class="p">;</span>


	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="nf">CIFSSMBSetFSUnixInfo</span><span class="p">(</span><span class="k">const</span> <span class="kt">int</span> <span class="n">xid</span><span class="p">,</span> <span class="k">struct</span> <span class="n">cifs_tcon</span> <span class="o">*</span><span class="n">tcon</span><span class="p">,</span> <span class="n">__u64</span> <span class="n">cap</span><span class="p">)</span>
<span class="p">{</span>
<span class="cm">/* level 0x200  SMB_SET_CIFS_UNIX_INFO */</span>
	<span class="n">TRANSACTION2_SETFSI_REQ</span> <span class="o">*</span><span class="n">pSMB</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">TRANSACTION2_SETFSI_RSP</span> <span class="o">*</span><span class="n">pSMBr</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">bytes_returned</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">__u16</span> <span class="n">params</span><span class="p">,</span> <span class="n">param_offset</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">byte_count</span><span class="p">;</span>

	<span class="n">cFYI</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;In SETFSUnixInfo&quot;</span><span class="p">);</span>
<span class="nl">SETFSUnixRetry:</span>
	<span class="cm">/* BB switch to small buf init to save memory */</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">smb_init_no_reconnect</span><span class="p">(</span><span class="n">SMB_COM_TRANSACTION2</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="n">tcon</span><span class="p">,</span>
					<span class="p">(</span><span class="kt">void</span> <span class="o">**</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">pSMB</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">**</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">pSMBr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">params</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>	<span class="cm">/* 2 bytes zero followed by info level. */</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">MaxSetupCount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">Reserved</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">Flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">Timeout</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">Reserved2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">param_offset</span> <span class="o">=</span> <span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">smb_com_transaction2_setfsi_req</span><span class="p">,</span> <span class="n">FileNum</span><span class="p">)</span>
				<span class="o">-</span> <span class="mi">4</span><span class="p">;</span>
	<span class="n">offset</span> <span class="o">=</span> <span class="n">param_offset</span> <span class="o">+</span> <span class="n">params</span><span class="p">;</span>

	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">MaxParameterCount</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="mi">4</span><span class="p">);</span>
	<span class="cm">/* BB find exact max SMB PDU from sess structure BB */</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">MaxDataCount</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">SetupCount</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">Reserved3</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">SubCommand</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">TRANS2_SET_FS_INFORMATION</span><span class="p">);</span>
	<span class="n">byte_count</span> <span class="o">=</span> <span class="mi">1</span> <span class="cm">/* pad */</span> <span class="o">+</span> <span class="n">params</span> <span class="o">+</span> <span class="mi">12</span><span class="p">;</span>

	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">DataCount</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="mi">12</span><span class="p">);</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">ParameterCount</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">params</span><span class="p">);</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">TotalDataCount</span> <span class="o">=</span> <span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">DataCount</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">TotalParameterCount</span> <span class="o">=</span> <span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">ParameterCount</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">ParameterOffset</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">param_offset</span><span class="p">);</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">DataOffset</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">offset</span><span class="p">);</span>

	<span class="cm">/* Params. */</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">FileNum</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">InformationLevel</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">SMB_SET_CIFS_UNIX_INFO</span><span class="p">);</span>

	<span class="cm">/* Data. */</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">ClientUnixMajor</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">CIFS_UNIX_MAJOR_VERSION</span><span class="p">);</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">ClientUnixMinor</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">CIFS_UNIX_MINOR_VERSION</span><span class="p">);</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">ClientUnixCap</span> <span class="o">=</span> <span class="n">cpu_to_le64</span><span class="p">(</span><span class="n">cap</span><span class="p">);</span>

	<span class="n">inc_rfc1001_len</span><span class="p">(</span><span class="n">pSMB</span><span class="p">,</span> <span class="n">byte_count</span><span class="p">);</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">ByteCount</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">byte_count</span><span class="p">);</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">SendReceive</span><span class="p">(</span><span class="n">xid</span><span class="p">,</span> <span class="n">tcon</span><span class="o">-&gt;</span><span class="n">ses</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">smb_hdr</span> <span class="o">*</span><span class="p">)</span> <span class="n">pSMB</span><span class="p">,</span>
			 <span class="p">(</span><span class="k">struct</span> <span class="n">smb_hdr</span> <span class="o">*</span><span class="p">)</span> <span class="n">pSMBr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bytes_returned</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cERROR</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;Send error in SETFSUnixInfo = %d&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>		<span class="cm">/* decode response */</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">validate_t2</span><span class="p">((</span><span class="k">struct</span> <span class="n">smb_t2_rsp</span> <span class="o">*</span><span class="p">)</span><span class="n">pSMBr</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>	<span class="cm">/* bad smb */</span>
	<span class="p">}</span>
	<span class="n">cifs_buf_release</span><span class="p">(</span><span class="n">pSMB</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">SETFSUnixRetry</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>



<span class="kt">int</span>
<span class="nf">CIFSSMBQFSPosixInfo</span><span class="p">(</span><span class="k">const</span> <span class="kt">int</span> <span class="n">xid</span><span class="p">,</span> <span class="k">struct</span> <span class="n">cifs_tcon</span> <span class="o">*</span><span class="n">tcon</span><span class="p">,</span>
		   <span class="k">struct</span> <span class="n">kstatfs</span> <span class="o">*</span><span class="n">FSData</span><span class="p">)</span>
<span class="p">{</span>
<span class="cm">/* level 0x201  SMB_QUERY_CIFS_POSIX_INFO */</span>
	<span class="n">TRANSACTION2_QFSI_REQ</span> <span class="o">*</span><span class="n">pSMB</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">TRANSACTION2_QFSI_RSP</span> <span class="o">*</span><span class="n">pSMBr</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">FILE_SYSTEM_POSIX_INFO</span> <span class="o">*</span><span class="n">response_data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">bytes_returned</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">__u16</span> <span class="n">params</span><span class="p">,</span> <span class="n">byte_count</span><span class="p">;</span>

	<span class="n">cFYI</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;In QFSPosixInfo&quot;</span><span class="p">);</span>
<span class="nl">QFSPosixRetry:</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">smb_init</span><span class="p">(</span><span class="n">SMB_COM_TRANSACTION2</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="n">tcon</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">**</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">pSMB</span><span class="p">,</span>
		      <span class="p">(</span><span class="kt">void</span> <span class="o">**</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">pSMBr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">params</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>	<span class="cm">/* level */</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">TotalDataCount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">DataCount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">DataOffset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">MaxParameterCount</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
	<span class="cm">/* BB find exact max SMB PDU from sess structure BB */</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">MaxDataCount</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">MaxSetupCount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">Reserved</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">Flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">Timeout</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">Reserved2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">byte_count</span> <span class="o">=</span> <span class="n">params</span> <span class="o">+</span> <span class="mi">1</span> <span class="cm">/* pad */</span> <span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">ParameterCount</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">params</span><span class="p">);</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">TotalParameterCount</span> <span class="o">=</span> <span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">ParameterCount</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">ParameterOffset</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span>
			<span class="n">smb_com_transaction2_qfsi_req</span><span class="p">,</span> <span class="n">InformationLevel</span><span class="p">)</span> <span class="o">-</span> <span class="mi">4</span><span class="p">);</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">SetupCount</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">Reserved3</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">SubCommand</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">TRANS2_QUERY_FS_INFORMATION</span><span class="p">);</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">InformationLevel</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">SMB_QUERY_POSIX_FS_INFO</span><span class="p">);</span>
	<span class="n">inc_rfc1001_len</span><span class="p">(</span><span class="n">pSMB</span><span class="p">,</span> <span class="n">byte_count</span><span class="p">);</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">ByteCount</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">byte_count</span><span class="p">);</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">SendReceive</span><span class="p">(</span><span class="n">xid</span><span class="p">,</span> <span class="n">tcon</span><span class="o">-&gt;</span><span class="n">ses</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">smb_hdr</span> <span class="o">*</span><span class="p">)</span> <span class="n">pSMB</span><span class="p">,</span>
			 <span class="p">(</span><span class="k">struct</span> <span class="n">smb_hdr</span> <span class="o">*</span><span class="p">)</span> <span class="n">pSMBr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bytes_returned</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cFYI</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;Send error in QFSUnixInfo = %d&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>		<span class="cm">/* decode response */</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">validate_t2</span><span class="p">((</span><span class="k">struct</span> <span class="n">smb_t2_rsp</span> <span class="o">*</span><span class="p">)</span><span class="n">pSMBr</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">||</span> <span class="n">get_bcc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pSMBr</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">13</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>	<span class="cm">/* bad smb */</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">__u16</span> <span class="n">data_offset</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">pSMBr</span><span class="o">-&gt;</span><span class="n">t2</span><span class="p">.</span><span class="n">DataOffset</span><span class="p">);</span>
			<span class="n">response_data</span> <span class="o">=</span>
			    <span class="p">(</span><span class="n">FILE_SYSTEM_POSIX_INFO</span>
			     <span class="o">*</span><span class="p">)</span> <span class="p">(((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">pSMBr</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">Protocol</span><span class="p">)</span> <span class="o">+</span>
				 <span class="n">data_offset</span><span class="p">);</span>
			<span class="n">FSData</span><span class="o">-&gt;</span><span class="n">f_bsize</span> <span class="o">=</span>
					<span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">response_data</span><span class="o">-&gt;</span><span class="n">BlockSize</span><span class="p">);</span>
			<span class="n">FSData</span><span class="o">-&gt;</span><span class="n">f_blocks</span> <span class="o">=</span>
					<span class="n">le64_to_cpu</span><span class="p">(</span><span class="n">response_data</span><span class="o">-&gt;</span><span class="n">TotalBlocks</span><span class="p">);</span>
			<span class="n">FSData</span><span class="o">-&gt;</span><span class="n">f_bfree</span> <span class="o">=</span>
			    <span class="n">le64_to_cpu</span><span class="p">(</span><span class="n">response_data</span><span class="o">-&gt;</span><span class="n">BlocksAvail</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">response_data</span><span class="o">-&gt;</span><span class="n">UserBlocksAvail</span> <span class="o">==</span> <span class="n">cpu_to_le64</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">FSData</span><span class="o">-&gt;</span><span class="n">f_bavail</span> <span class="o">=</span> <span class="n">FSData</span><span class="o">-&gt;</span><span class="n">f_bfree</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">FSData</span><span class="o">-&gt;</span><span class="n">f_bavail</span> <span class="o">=</span>
				    <span class="n">le64_to_cpu</span><span class="p">(</span><span class="n">response_data</span><span class="o">-&gt;</span><span class="n">UserBlocksAvail</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">response_data</span><span class="o">-&gt;</span><span class="n">TotalFileNodes</span> <span class="o">!=</span> <span class="n">cpu_to_le64</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>
				<span class="n">FSData</span><span class="o">-&gt;</span><span class="n">f_files</span> <span class="o">=</span>
				     <span class="n">le64_to_cpu</span><span class="p">(</span><span class="n">response_data</span><span class="o">-&gt;</span><span class="n">TotalFileNodes</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">response_data</span><span class="o">-&gt;</span><span class="n">FreeFileNodes</span> <span class="o">!=</span> <span class="n">cpu_to_le64</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>
				<span class="n">FSData</span><span class="o">-&gt;</span><span class="n">f_ffree</span> <span class="o">=</span>
				      <span class="n">le64_to_cpu</span><span class="p">(</span><span class="n">response_data</span><span class="o">-&gt;</span><span class="n">FreeFileNodes</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">cifs_buf_release</span><span class="p">(</span><span class="n">pSMB</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">QFSPosixRetry</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/* We can not use write of zero bytes trick to</span>
<span class="cm">   set file size due to need for large file support.  Also note that</span>
<span class="cm">   this SetPathInfo is preferred to SetFileInfo based method in next</span>
<span class="cm">   routine which is only needed to work around a sharing violation bug</span>
<span class="cm">   in Samba which this routine can run into */</span>

<span class="kt">int</span>
<span class="nf">CIFSSMBSetEOF</span><span class="p">(</span><span class="k">const</span> <span class="kt">int</span> <span class="n">xid</span><span class="p">,</span> <span class="k">struct</span> <span class="n">cifs_tcon</span> <span class="o">*</span><span class="n">tcon</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">fileName</span><span class="p">,</span>
	      <span class="n">__u64</span> <span class="n">size</span><span class="p">,</span> <span class="n">bool</span> <span class="n">SetAllocation</span><span class="p">,</span>
	      <span class="k">const</span> <span class="k">struct</span> <span class="n">nls_table</span> <span class="o">*</span><span class="n">nls_codepage</span><span class="p">,</span> <span class="kt">int</span> <span class="n">remap</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">smb_com_transaction2_spi_req</span> <span class="o">*</span><span class="n">pSMB</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">smb_com_transaction2_spi_rsp</span> <span class="o">*</span><span class="n">pSMBr</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">file_end_of_file_info</span> <span class="o">*</span><span class="n">parm_data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">name_len</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">bytes_returned</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">__u16</span> <span class="n">params</span><span class="p">,</span> <span class="n">byte_count</span><span class="p">,</span> <span class="n">data_count</span><span class="p">,</span> <span class="n">param_offset</span><span class="p">,</span> <span class="n">offset</span><span class="p">;</span>

	<span class="n">cFYI</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;In SetEOF&quot;</span><span class="p">);</span>
<span class="nl">SetEOFRetry:</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">smb_init</span><span class="p">(</span><span class="n">SMB_COM_TRANSACTION2</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="n">tcon</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">**</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">pSMB</span><span class="p">,</span>
		      <span class="p">(</span><span class="kt">void</span> <span class="o">**</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">pSMBr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">Flags2</span> <span class="o">&amp;</span> <span class="n">SMBFLG2_UNICODE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">name_len</span> <span class="o">=</span>
		    <span class="n">cifsConvertToUTF16</span><span class="p">((</span><span class="n">__le16</span> <span class="o">*</span><span class="p">)</span> <span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">FileName</span><span class="p">,</span> <span class="n">fileName</span><span class="p">,</span>
				       <span class="n">PATH_MAX</span><span class="p">,</span> <span class="n">nls_codepage</span><span class="p">,</span> <span class="n">remap</span><span class="p">);</span>
		<span class="n">name_len</span><span class="o">++</span><span class="p">;</span>	<span class="cm">/* trailing null */</span>
		<span class="n">name_len</span> <span class="o">*=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>	<span class="cm">/* BB improve the check for buffer overruns BB */</span>
		<span class="n">name_len</span> <span class="o">=</span> <span class="n">strnlen</span><span class="p">(</span><span class="n">fileName</span><span class="p">,</span> <span class="n">PATH_MAX</span><span class="p">);</span>
		<span class="n">name_len</span><span class="o">++</span><span class="p">;</span>	<span class="cm">/* trailing null */</span>
		<span class="n">strncpy</span><span class="p">(</span><span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">FileName</span><span class="p">,</span> <span class="n">fileName</span><span class="p">,</span> <span class="n">name_len</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">params</span> <span class="o">=</span> <span class="mi">6</span> <span class="o">+</span> <span class="n">name_len</span><span class="p">;</span>
	<span class="n">data_count</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">file_end_of_file_info</span><span class="p">);</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">MaxParameterCount</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">MaxDataCount</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="mi">4100</span><span class="p">);</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">MaxSetupCount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">Reserved</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">Flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">Timeout</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">Reserved2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">param_offset</span> <span class="o">=</span> <span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">smb_com_transaction2_spi_req</span><span class="p">,</span>
				<span class="n">InformationLevel</span><span class="p">)</span> <span class="o">-</span> <span class="mi">4</span><span class="p">;</span>
	<span class="n">offset</span> <span class="o">=</span> <span class="n">param_offset</span> <span class="o">+</span> <span class="n">params</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">SetAllocation</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tcon</span><span class="o">-&gt;</span><span class="n">ses</span><span class="o">-&gt;</span><span class="n">capabilities</span> <span class="o">&amp;</span> <span class="n">CAP_INFOLEVEL_PASSTHRU</span><span class="p">)</span>
			<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">InformationLevel</span> <span class="o">=</span>
				<span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">SMB_SET_FILE_ALLOCATION_INFO2</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">InformationLevel</span> <span class="o">=</span>
				<span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">SMB_SET_FILE_ALLOCATION_INFO</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="cm">/* Set File Size */</span>  <span class="p">{</span>
	    <span class="k">if</span> <span class="p">(</span><span class="n">tcon</span><span class="o">-&gt;</span><span class="n">ses</span><span class="o">-&gt;</span><span class="n">capabilities</span> <span class="o">&amp;</span> <span class="n">CAP_INFOLEVEL_PASSTHRU</span><span class="p">)</span>
		    <span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">InformationLevel</span> <span class="o">=</span>
				<span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">SMB_SET_FILE_END_OF_FILE_INFO2</span><span class="p">);</span>
	    <span class="k">else</span>
		    <span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">InformationLevel</span> <span class="o">=</span>
				<span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">SMB_SET_FILE_END_OF_FILE_INFO</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">parm_data</span> <span class="o">=</span>
	    <span class="p">(</span><span class="k">struct</span> <span class="n">file_end_of_file_info</span> <span class="o">*</span><span class="p">)</span> <span class="p">(((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">Protocol</span><span class="p">)</span> <span class="o">+</span>
				       <span class="n">offset</span><span class="p">);</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">ParameterOffset</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">param_offset</span><span class="p">);</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">DataOffset</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">offset</span><span class="p">);</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">SetupCount</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">Reserved3</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">SubCommand</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">TRANS2_SET_PATH_INFORMATION</span><span class="p">);</span>
	<span class="n">byte_count</span> <span class="o">=</span> <span class="mi">3</span> <span class="cm">/* pad */</span>  <span class="o">+</span> <span class="n">params</span> <span class="o">+</span> <span class="n">data_count</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">DataCount</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">data_count</span><span class="p">);</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">TotalDataCount</span> <span class="o">=</span> <span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">DataCount</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">ParameterCount</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">params</span><span class="p">);</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">TotalParameterCount</span> <span class="o">=</span> <span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">ParameterCount</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">Reserved4</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">inc_rfc1001_len</span><span class="p">(</span><span class="n">pSMB</span><span class="p">,</span> <span class="n">byte_count</span><span class="p">);</span>
	<span class="n">parm_data</span><span class="o">-&gt;</span><span class="n">FileSize</span> <span class="o">=</span> <span class="n">cpu_to_le64</span><span class="p">(</span><span class="n">size</span><span class="p">);</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">ByteCount</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">byte_count</span><span class="p">);</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">SendReceive</span><span class="p">(</span><span class="n">xid</span><span class="p">,</span> <span class="n">tcon</span><span class="o">-&gt;</span><span class="n">ses</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">smb_hdr</span> <span class="o">*</span><span class="p">)</span> <span class="n">pSMB</span><span class="p">,</span>
			 <span class="p">(</span><span class="k">struct</span> <span class="n">smb_hdr</span> <span class="o">*</span><span class="p">)</span> <span class="n">pSMBr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bytes_returned</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="n">cFYI</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;SetPathInfo (file size) returned %d&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>

	<span class="n">cifs_buf_release</span><span class="p">(</span><span class="n">pSMB</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">SetEOFRetry</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="nf">CIFSSMBSetFileSize</span><span class="p">(</span><span class="k">const</span> <span class="kt">int</span> <span class="n">xid</span><span class="p">,</span> <span class="k">struct</span> <span class="n">cifs_tcon</span> <span class="o">*</span><span class="n">tcon</span><span class="p">,</span> <span class="n">__u64</span> <span class="n">size</span><span class="p">,</span>
		   <span class="n">__u16</span> <span class="n">fid</span><span class="p">,</span> <span class="n">__u32</span> <span class="n">pid_of_opener</span><span class="p">,</span> <span class="n">bool</span> <span class="n">SetAllocation</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">smb_com_transaction2_sfi_req</span> <span class="o">*</span><span class="n">pSMB</span>  <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">file_end_of_file_info</span> <span class="o">*</span><span class="n">parm_data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">__u16</span> <span class="n">params</span><span class="p">,</span> <span class="n">param_offset</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">byte_count</span><span class="p">,</span> <span class="n">count</span><span class="p">;</span>

	<span class="n">cFYI</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;SetFileSize (via SetFileInfo) %lld&quot;</span><span class="p">,</span>
			<span class="p">(</span><span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">size</span><span class="p">);</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">small_smb_init</span><span class="p">(</span><span class="n">SMB_COM_TRANSACTION2</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="n">tcon</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">**</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">pSMB</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">Pid</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">((</span><span class="n">__u16</span><span class="p">)</span><span class="n">pid_of_opener</span><span class="p">);</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">PidHigh</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">((</span><span class="n">__u16</span><span class="p">)(</span><span class="n">pid_of_opener</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">));</span>

	<span class="n">params</span> <span class="o">=</span> <span class="mi">6</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">MaxSetupCount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">Reserved</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">Flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">Timeout</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">Reserved2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">param_offset</span> <span class="o">=</span> <span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">smb_com_transaction2_sfi_req</span><span class="p">,</span> <span class="n">Fid</span><span class="p">)</span> <span class="o">-</span> <span class="mi">4</span><span class="p">;</span>
	<span class="n">offset</span> <span class="o">=</span> <span class="n">param_offset</span> <span class="o">+</span> <span class="n">params</span><span class="p">;</span>

	<span class="n">count</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">file_end_of_file_info</span><span class="p">);</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">MaxParameterCount</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
	<span class="cm">/* BB find exact max SMB PDU from sess structure BB */</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">MaxDataCount</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="mi">1000</span><span class="p">);</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">SetupCount</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">Reserved3</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">SubCommand</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">TRANS2_SET_FILE_INFORMATION</span><span class="p">);</span>
	<span class="n">byte_count</span> <span class="o">=</span> <span class="mi">3</span> <span class="cm">/* pad */</span>  <span class="o">+</span> <span class="n">params</span> <span class="o">+</span> <span class="n">count</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">DataCount</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">count</span><span class="p">);</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">ParameterCount</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">params</span><span class="p">);</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">TotalDataCount</span> <span class="o">=</span> <span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">DataCount</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">TotalParameterCount</span> <span class="o">=</span> <span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">ParameterCount</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">ParameterOffset</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">param_offset</span><span class="p">);</span>
	<span class="n">parm_data</span> <span class="o">=</span>
		<span class="p">(</span><span class="k">struct</span> <span class="n">file_end_of_file_info</span> <span class="o">*</span><span class="p">)</span> <span class="p">(((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">Protocol</span><span class="p">)</span>
				<span class="o">+</span> <span class="n">offset</span><span class="p">);</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">DataOffset</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">offset</span><span class="p">);</span>
	<span class="n">parm_data</span><span class="o">-&gt;</span><span class="n">FileSize</span> <span class="o">=</span> <span class="n">cpu_to_le64</span><span class="p">(</span><span class="n">size</span><span class="p">);</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">Fid</span> <span class="o">=</span> <span class="n">fid</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">SetAllocation</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tcon</span><span class="o">-&gt;</span><span class="n">ses</span><span class="o">-&gt;</span><span class="n">capabilities</span> <span class="o">&amp;</span> <span class="n">CAP_INFOLEVEL_PASSTHRU</span><span class="p">)</span>
			<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">InformationLevel</span> <span class="o">=</span>
				<span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">SMB_SET_FILE_ALLOCATION_INFO2</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">InformationLevel</span> <span class="o">=</span>
				<span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">SMB_SET_FILE_ALLOCATION_INFO</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="cm">/* Set File Size */</span>  <span class="p">{</span>
	    <span class="k">if</span> <span class="p">(</span><span class="n">tcon</span><span class="o">-&gt;</span><span class="n">ses</span><span class="o">-&gt;</span><span class="n">capabilities</span> <span class="o">&amp;</span> <span class="n">CAP_INFOLEVEL_PASSTHRU</span><span class="p">)</span>
		    <span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">InformationLevel</span> <span class="o">=</span>
				<span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">SMB_SET_FILE_END_OF_FILE_INFO2</span><span class="p">);</span>
	    <span class="k">else</span>
		    <span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">InformationLevel</span> <span class="o">=</span>
				<span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">SMB_SET_FILE_END_OF_FILE_INFO</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">Reserved4</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">inc_rfc1001_len</span><span class="p">(</span><span class="n">pSMB</span><span class="p">,</span> <span class="n">byte_count</span><span class="p">);</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">ByteCount</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">byte_count</span><span class="p">);</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">SendReceiveNoRsp</span><span class="p">(</span><span class="n">xid</span><span class="p">,</span> <span class="n">tcon</span><span class="o">-&gt;</span><span class="n">ses</span><span class="p">,</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">pSMB</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cFYI</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;Send error in SetFileInfo (SetFileSize) = %d&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Note: On -EAGAIN error only caller can retry on handle based calls</span>
<span class="cm">		since file handle passed in no longer valid */</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Some legacy servers such as NT4 require that the file times be set on</span>
<span class="cm">   an open handle, rather than by pathname - this is awkward due to</span>
<span class="cm">   potential access conflicts on the open, but it is unavoidable for these</span>
<span class="cm">   old servers since the only other choice is to go from 100 nanosecond DCE</span>
<span class="cm">   time and resort to the original setpathinfo level which takes the ancient</span>
<span class="cm">   DOS time format with 2 second granularity */</span>
<span class="kt">int</span>
<span class="nf">CIFSSMBSetFileInfo</span><span class="p">(</span><span class="k">const</span> <span class="kt">int</span> <span class="n">xid</span><span class="p">,</span> <span class="k">struct</span> <span class="n">cifs_tcon</span> <span class="o">*</span><span class="n">tcon</span><span class="p">,</span>
		    <span class="k">const</span> <span class="n">FILE_BASIC_INFO</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="n">__u16</span> <span class="n">fid</span><span class="p">,</span> <span class="n">__u32</span> <span class="n">pid_of_opener</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">smb_com_transaction2_sfi_req</span> <span class="o">*</span><span class="n">pSMB</span>  <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">data_offset</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">__u16</span> <span class="n">params</span><span class="p">,</span> <span class="n">param_offset</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">byte_count</span><span class="p">,</span> <span class="n">count</span><span class="p">;</span>

	<span class="n">cFYI</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;Set Times (via SetFileInfo)&quot;</span><span class="p">);</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">small_smb_init</span><span class="p">(</span><span class="n">SMB_COM_TRANSACTION2</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="n">tcon</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">**</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">pSMB</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">Pid</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">((</span><span class="n">__u16</span><span class="p">)</span><span class="n">pid_of_opener</span><span class="p">);</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">PidHigh</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">((</span><span class="n">__u16</span><span class="p">)(</span><span class="n">pid_of_opener</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">));</span>

	<span class="n">params</span> <span class="o">=</span> <span class="mi">6</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">MaxSetupCount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">Reserved</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">Flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">Timeout</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">Reserved2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">param_offset</span> <span class="o">=</span> <span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">smb_com_transaction2_sfi_req</span><span class="p">,</span> <span class="n">Fid</span><span class="p">)</span> <span class="o">-</span> <span class="mi">4</span><span class="p">;</span>
	<span class="n">offset</span> <span class="o">=</span> <span class="n">param_offset</span> <span class="o">+</span> <span class="n">params</span><span class="p">;</span>

	<span class="n">data_offset</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">pSMB</span> <span class="o">+</span>
			<span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">smb_hdr</span><span class="p">,</span> <span class="n">Protocol</span><span class="p">)</span> <span class="o">+</span> <span class="n">offset</span><span class="p">;</span>

	<span class="n">count</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">FILE_BASIC_INFO</span><span class="p">);</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">MaxParameterCount</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
	<span class="cm">/* BB find max SMB PDU from sess */</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">MaxDataCount</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="mi">1000</span><span class="p">);</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">SetupCount</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">Reserved3</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">SubCommand</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">TRANS2_SET_FILE_INFORMATION</span><span class="p">);</span>
	<span class="n">byte_count</span> <span class="o">=</span> <span class="mi">3</span> <span class="cm">/* pad */</span>  <span class="o">+</span> <span class="n">params</span> <span class="o">+</span> <span class="n">count</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">DataCount</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">count</span><span class="p">);</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">ParameterCount</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">params</span><span class="p">);</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">TotalDataCount</span> <span class="o">=</span> <span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">DataCount</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">TotalParameterCount</span> <span class="o">=</span> <span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">ParameterCount</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">ParameterOffset</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">param_offset</span><span class="p">);</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">DataOffset</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">offset</span><span class="p">);</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">Fid</span> <span class="o">=</span> <span class="n">fid</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tcon</span><span class="o">-&gt;</span><span class="n">ses</span><span class="o">-&gt;</span><span class="n">capabilities</span> <span class="o">&amp;</span> <span class="n">CAP_INFOLEVEL_PASSTHRU</span><span class="p">)</span>
		<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">InformationLevel</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">SMB_SET_FILE_BASIC_INFO2</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">InformationLevel</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">SMB_SET_FILE_BASIC_INFO</span><span class="p">);</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">Reserved4</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">inc_rfc1001_len</span><span class="p">(</span><span class="n">pSMB</span><span class="p">,</span> <span class="n">byte_count</span><span class="p">);</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">ByteCount</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">byte_count</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">data_offset</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">FILE_BASIC_INFO</span><span class="p">));</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">SendReceiveNoRsp</span><span class="p">(</span><span class="n">xid</span><span class="p">,</span> <span class="n">tcon</span><span class="o">-&gt;</span><span class="n">ses</span><span class="p">,</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">pSMB</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="n">cFYI</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;Send error in Set Time (SetFileInfo) = %d&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>

	<span class="cm">/* Note: On -EAGAIN error only caller can retry on handle based calls</span>
<span class="cm">		since file handle passed in no longer valid */</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="nf">CIFSSMBSetFileDisposition</span><span class="p">(</span><span class="k">const</span> <span class="kt">int</span> <span class="n">xid</span><span class="p">,</span> <span class="k">struct</span> <span class="n">cifs_tcon</span> <span class="o">*</span><span class="n">tcon</span><span class="p">,</span>
			  <span class="n">bool</span> <span class="n">delete_file</span><span class="p">,</span> <span class="n">__u16</span> <span class="n">fid</span><span class="p">,</span> <span class="n">__u32</span> <span class="n">pid_of_opener</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">smb_com_transaction2_sfi_req</span> <span class="o">*</span><span class="n">pSMB</span>  <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">data_offset</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">__u16</span> <span class="n">params</span><span class="p">,</span> <span class="n">param_offset</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">byte_count</span><span class="p">,</span> <span class="n">count</span><span class="p">;</span>

	<span class="n">cFYI</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;Set File Disposition (via SetFileInfo)&quot;</span><span class="p">);</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">small_smb_init</span><span class="p">(</span><span class="n">SMB_COM_TRANSACTION2</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="n">tcon</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">**</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">pSMB</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">Pid</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">((</span><span class="n">__u16</span><span class="p">)</span><span class="n">pid_of_opener</span><span class="p">);</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">PidHigh</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">((</span><span class="n">__u16</span><span class="p">)(</span><span class="n">pid_of_opener</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">));</span>

	<span class="n">params</span> <span class="o">=</span> <span class="mi">6</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">MaxSetupCount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">Reserved</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">Flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">Timeout</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">Reserved2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">param_offset</span> <span class="o">=</span> <span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">smb_com_transaction2_sfi_req</span><span class="p">,</span> <span class="n">Fid</span><span class="p">)</span> <span class="o">-</span> <span class="mi">4</span><span class="p">;</span>
	<span class="n">offset</span> <span class="o">=</span> <span class="n">param_offset</span> <span class="o">+</span> <span class="n">params</span><span class="p">;</span>

	<span class="n">data_offset</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">Protocol</span><span class="p">)</span> <span class="o">+</span> <span class="n">offset</span><span class="p">;</span>

	<span class="n">count</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">MaxParameterCount</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
	<span class="cm">/* BB find max SMB PDU from sess */</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">MaxDataCount</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="mi">1000</span><span class="p">);</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">SetupCount</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">Reserved3</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">SubCommand</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">TRANS2_SET_FILE_INFORMATION</span><span class="p">);</span>
	<span class="n">byte_count</span> <span class="o">=</span> <span class="mi">3</span> <span class="cm">/* pad */</span>  <span class="o">+</span> <span class="n">params</span> <span class="o">+</span> <span class="n">count</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">DataCount</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">count</span><span class="p">);</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">ParameterCount</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">params</span><span class="p">);</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">TotalDataCount</span> <span class="o">=</span> <span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">DataCount</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">TotalParameterCount</span> <span class="o">=</span> <span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">ParameterCount</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">ParameterOffset</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">param_offset</span><span class="p">);</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">DataOffset</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">offset</span><span class="p">);</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">Fid</span> <span class="o">=</span> <span class="n">fid</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">InformationLevel</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">SMB_SET_FILE_DISPOSITION_INFO</span><span class="p">);</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">Reserved4</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">inc_rfc1001_len</span><span class="p">(</span><span class="n">pSMB</span><span class="p">,</span> <span class="n">byte_count</span><span class="p">);</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">ByteCount</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">byte_count</span><span class="p">);</span>
	<span class="o">*</span><span class="n">data_offset</span> <span class="o">=</span> <span class="n">delete_file</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">SendReceiveNoRsp</span><span class="p">(</span><span class="n">xid</span><span class="p">,</span> <span class="n">tcon</span><span class="o">-&gt;</span><span class="n">ses</span><span class="p">,</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">pSMB</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="n">cFYI</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;Send error in SetFileDisposition = %d&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="nf">CIFSSMBSetPathInfo</span><span class="p">(</span><span class="k">const</span> <span class="kt">int</span> <span class="n">xid</span><span class="p">,</span> <span class="k">struct</span> <span class="n">cifs_tcon</span> <span class="o">*</span><span class="n">tcon</span><span class="p">,</span>
		   <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">fileName</span><span class="p">,</span> <span class="k">const</span> <span class="n">FILE_BASIC_INFO</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span>
		   <span class="k">const</span> <span class="k">struct</span> <span class="n">nls_table</span> <span class="o">*</span><span class="n">nls_codepage</span><span class="p">,</span> <span class="kt">int</span> <span class="n">remap</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">TRANSACTION2_SPI_REQ</span> <span class="o">*</span><span class="n">pSMB</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">TRANSACTION2_SPI_RSP</span> <span class="o">*</span><span class="n">pSMBr</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">name_len</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">bytes_returned</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">data_offset</span><span class="p">;</span>
	<span class="n">__u16</span> <span class="n">params</span><span class="p">,</span> <span class="n">param_offset</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">byte_count</span><span class="p">,</span> <span class="n">count</span><span class="p">;</span>

	<span class="n">cFYI</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;In SetTimes&quot;</span><span class="p">);</span>

<span class="nl">SetTimesRetry:</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">smb_init</span><span class="p">(</span><span class="n">SMB_COM_TRANSACTION2</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="n">tcon</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">**</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">pSMB</span><span class="p">,</span>
		      <span class="p">(</span><span class="kt">void</span> <span class="o">**</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">pSMBr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">Flags2</span> <span class="o">&amp;</span> <span class="n">SMBFLG2_UNICODE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">name_len</span> <span class="o">=</span>
		    <span class="n">cifsConvertToUTF16</span><span class="p">((</span><span class="n">__le16</span> <span class="o">*</span><span class="p">)</span> <span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">FileName</span><span class="p">,</span> <span class="n">fileName</span><span class="p">,</span>
				       <span class="n">PATH_MAX</span><span class="p">,</span> <span class="n">nls_codepage</span><span class="p">,</span> <span class="n">remap</span><span class="p">);</span>
		<span class="n">name_len</span><span class="o">++</span><span class="p">;</span>	<span class="cm">/* trailing null */</span>
		<span class="n">name_len</span> <span class="o">*=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>	<span class="cm">/* BB improve the check for buffer overruns BB */</span>
		<span class="n">name_len</span> <span class="o">=</span> <span class="n">strnlen</span><span class="p">(</span><span class="n">fileName</span><span class="p">,</span> <span class="n">PATH_MAX</span><span class="p">);</span>
		<span class="n">name_len</span><span class="o">++</span><span class="p">;</span>	<span class="cm">/* trailing null */</span>
		<span class="n">strncpy</span><span class="p">(</span><span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">FileName</span><span class="p">,</span> <span class="n">fileName</span><span class="p">,</span> <span class="n">name_len</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">params</span> <span class="o">=</span> <span class="mi">6</span> <span class="o">+</span> <span class="n">name_len</span><span class="p">;</span>
	<span class="n">count</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">FILE_BASIC_INFO</span><span class="p">);</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">MaxParameterCount</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
	<span class="cm">/* BB find max SMB PDU from sess structure BB */</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">MaxDataCount</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="mi">1000</span><span class="p">);</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">MaxSetupCount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">Reserved</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">Flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">Timeout</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">Reserved2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">param_offset</span> <span class="o">=</span> <span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">smb_com_transaction2_spi_req</span><span class="p">,</span>
				<span class="n">InformationLevel</span><span class="p">)</span> <span class="o">-</span> <span class="mi">4</span><span class="p">;</span>
	<span class="n">offset</span> <span class="o">=</span> <span class="n">param_offset</span> <span class="o">+</span> <span class="n">params</span><span class="p">;</span>
	<span class="n">data_offset</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">Protocol</span><span class="p">)</span> <span class="o">+</span> <span class="n">offset</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">ParameterOffset</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">param_offset</span><span class="p">);</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">DataOffset</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">offset</span><span class="p">);</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">SetupCount</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">Reserved3</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">SubCommand</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">TRANS2_SET_PATH_INFORMATION</span><span class="p">);</span>
	<span class="n">byte_count</span> <span class="o">=</span> <span class="mi">3</span> <span class="cm">/* pad */</span>  <span class="o">+</span> <span class="n">params</span> <span class="o">+</span> <span class="n">count</span><span class="p">;</span>

	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">DataCount</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">count</span><span class="p">);</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">ParameterCount</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">params</span><span class="p">);</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">TotalDataCount</span> <span class="o">=</span> <span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">DataCount</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">TotalParameterCount</span> <span class="o">=</span> <span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">ParameterCount</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tcon</span><span class="o">-&gt;</span><span class="n">ses</span><span class="o">-&gt;</span><span class="n">capabilities</span> <span class="o">&amp;</span> <span class="n">CAP_INFOLEVEL_PASSTHRU</span><span class="p">)</span>
		<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">InformationLevel</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">SMB_SET_FILE_BASIC_INFO2</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">InformationLevel</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">SMB_SET_FILE_BASIC_INFO</span><span class="p">);</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">Reserved4</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">inc_rfc1001_len</span><span class="p">(</span><span class="n">pSMB</span><span class="p">,</span> <span class="n">byte_count</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">data_offset</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">FILE_BASIC_INFO</span><span class="p">));</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">ByteCount</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">byte_count</span><span class="p">);</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">SendReceive</span><span class="p">(</span><span class="n">xid</span><span class="p">,</span> <span class="n">tcon</span><span class="o">-&gt;</span><span class="n">ses</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">smb_hdr</span> <span class="o">*</span><span class="p">)</span> <span class="n">pSMB</span><span class="p">,</span>
			 <span class="p">(</span><span class="k">struct</span> <span class="n">smb_hdr</span> <span class="o">*</span><span class="p">)</span> <span class="n">pSMBr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bytes_returned</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="n">cFYI</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;SetPathInfo (times) returned %d&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>

	<span class="n">cifs_buf_release</span><span class="p">(</span><span class="n">pSMB</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">SetTimesRetry</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Can not be used to set time stamps yet (due to old DOS time format) */</span>
<span class="cm">/* Can be used to set attributes */</span>
<span class="cp">#if 0</span><span class="c">  /* Possibly not needed - since it turns out that strangely NT4 has a bug</span>
<span class="c">	  handling it anyway and NT4 was what we thought it would be needed for</span>
<span class="c">	  Do not delete it until we prove whether needed for Win9x though */</span>
<span class="c">int</span>
<span class="c">CIFSSMBSetAttrLegacy(int xid, struct cifs_tcon *tcon, char *fileName,</span>
<span class="c">		__u16 dos_attrs, const struct nls_table *nls_codepage)</span>
<span class="c">{</span>
<span class="c">	SETATTR_REQ *pSMB = NULL;</span>
<span class="c">	SETATTR_RSP *pSMBr = NULL;</span>
<span class="c">	int rc = 0;</span>
<span class="c">	int bytes_returned;</span>
<span class="c">	int name_len;</span>

<span class="c">	cFYI(1, &quot;In SetAttrLegacy&quot;);</span>

<span class="c">SetAttrLgcyRetry:</span>
<span class="c">	rc = smb_init(SMB_COM_SETATTR, 8, tcon, (void **) &amp;pSMB,</span>
<span class="c">		      (void **) &amp;pSMBr);</span>
<span class="c">	if (rc)</span>
<span class="c">		return rc;</span>

<span class="c">	if (pSMB-&gt;hdr.Flags2 &amp; SMBFLG2_UNICODE) {</span>
<span class="c">		name_len =</span>
<span class="c">			ConvertToUTF16((__le16 *) pSMB-&gt;fileName, fileName,</span>
<span class="c">				       PATH_MAX, nls_codepage);</span>
<span class="c">		name_len++;     /* trailing null */</span>
<span class="c">		name_len *= 2;</span>
<span class="c">	} else {	/* BB improve the check for buffer overruns BB */</span>
<span class="c">		name_len = strnlen(fileName, PATH_MAX);</span>
<span class="c">		name_len++;     /* trailing null */</span>
<span class="c">		strncpy(pSMB-&gt;fileName, fileName, name_len);</span>
<span class="c">	}</span>
<span class="c">	pSMB-&gt;attr = cpu_to_le16(dos_attrs);</span>
<span class="c">	pSMB-&gt;BufferFormat = 0x04;</span>
<span class="c">	inc_rfc1001_len(pSMB, name_len + 1);</span>
<span class="c">	pSMB-&gt;ByteCount = cpu_to_le16(name_len + 1);</span>
<span class="c">	rc = SendReceive(xid, tcon-&gt;ses, (struct smb_hdr *) pSMB,</span>
<span class="c">			 (struct smb_hdr *) pSMBr, &amp;bytes_returned, 0);</span>
<span class="c">	if (rc)</span>
<span class="c">		cFYI(1, &quot;Error in LegacySetAttr = %d&quot;, rc);</span>

<span class="c">	cifs_buf_release(pSMB);</span>

<span class="c">	if (rc == -EAGAIN)</span>
<span class="c">		goto SetAttrLgcyRetry;</span>

<span class="c">	return rc;</span>
<span class="c">}</span>
<span class="cp">#endif /* temporarily unneeded SetAttr legacy function */</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">cifs_fill_unix_set_info</span><span class="p">(</span><span class="n">FILE_UNIX_BASIC_INFO</span> <span class="o">*</span><span class="n">data_offset</span><span class="p">,</span>
			<span class="k">const</span> <span class="k">struct</span> <span class="n">cifs_unix_set_info_args</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u64</span> <span class="n">mode</span> <span class="o">=</span> <span class="n">args</span><span class="o">-&gt;</span><span class="n">mode</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Samba server ignores set of file size to zero due to bugs in some</span>
<span class="cm">	 * older clients, but we should be precise - we use SetFileSize to</span>
<span class="cm">	 * set file size and do not want to truncate file size to zero</span>
<span class="cm">	 * accidentally as happened on one Samba server beta by putting</span>
<span class="cm">	 * zero instead of -1 here</span>
<span class="cm">	 */</span>
	<span class="n">data_offset</span><span class="o">-&gt;</span><span class="n">EndOfFile</span> <span class="o">=</span> <span class="n">cpu_to_le64</span><span class="p">(</span><span class="n">NO_CHANGE_64</span><span class="p">);</span>
	<span class="n">data_offset</span><span class="o">-&gt;</span><span class="n">NumOfBytes</span> <span class="o">=</span> <span class="n">cpu_to_le64</span><span class="p">(</span><span class="n">NO_CHANGE_64</span><span class="p">);</span>
	<span class="n">data_offset</span><span class="o">-&gt;</span><span class="n">LastStatusChange</span> <span class="o">=</span> <span class="n">cpu_to_le64</span><span class="p">(</span><span class="n">args</span><span class="o">-&gt;</span><span class="n">ctime</span><span class="p">);</span>
	<span class="n">data_offset</span><span class="o">-&gt;</span><span class="n">LastAccessTime</span> <span class="o">=</span> <span class="n">cpu_to_le64</span><span class="p">(</span><span class="n">args</span><span class="o">-&gt;</span><span class="n">atime</span><span class="p">);</span>
	<span class="n">data_offset</span><span class="o">-&gt;</span><span class="n">LastModificationTime</span> <span class="o">=</span> <span class="n">cpu_to_le64</span><span class="p">(</span><span class="n">args</span><span class="o">-&gt;</span><span class="n">mtime</span><span class="p">);</span>
	<span class="n">data_offset</span><span class="o">-&gt;</span><span class="n">Uid</span> <span class="o">=</span> <span class="n">cpu_to_le64</span><span class="p">(</span><span class="n">args</span><span class="o">-&gt;</span><span class="n">uid</span><span class="p">);</span>
	<span class="n">data_offset</span><span class="o">-&gt;</span><span class="n">Gid</span> <span class="o">=</span> <span class="n">cpu_to_le64</span><span class="p">(</span><span class="n">args</span><span class="o">-&gt;</span><span class="n">gid</span><span class="p">);</span>
	<span class="cm">/* better to leave device as zero when it is  */</span>
	<span class="n">data_offset</span><span class="o">-&gt;</span><span class="n">DevMajor</span> <span class="o">=</span> <span class="n">cpu_to_le64</span><span class="p">(</span><span class="n">MAJOR</span><span class="p">(</span><span class="n">args</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">));</span>
	<span class="n">data_offset</span><span class="o">-&gt;</span><span class="n">DevMinor</span> <span class="o">=</span> <span class="n">cpu_to_le64</span><span class="p">(</span><span class="n">MINOR</span><span class="p">(</span><span class="n">args</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">));</span>
	<span class="n">data_offset</span><span class="o">-&gt;</span><span class="n">Permissions</span> <span class="o">=</span> <span class="n">cpu_to_le64</span><span class="p">(</span><span class="n">mode</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">S_ISREG</span><span class="p">(</span><span class="n">mode</span><span class="p">))</span>
		<span class="n">data_offset</span><span class="o">-&gt;</span><span class="n">Type</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">UNIX_FILE</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">S_ISDIR</span><span class="p">(</span><span class="n">mode</span><span class="p">))</span>
		<span class="n">data_offset</span><span class="o">-&gt;</span><span class="n">Type</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">UNIX_DIR</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">S_ISLNK</span><span class="p">(</span><span class="n">mode</span><span class="p">))</span>
		<span class="n">data_offset</span><span class="o">-&gt;</span><span class="n">Type</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">UNIX_SYMLINK</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">S_ISCHR</span><span class="p">(</span><span class="n">mode</span><span class="p">))</span>
		<span class="n">data_offset</span><span class="o">-&gt;</span><span class="n">Type</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">UNIX_CHARDEV</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">S_ISBLK</span><span class="p">(</span><span class="n">mode</span><span class="p">))</span>
		<span class="n">data_offset</span><span class="o">-&gt;</span><span class="n">Type</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">UNIX_BLOCKDEV</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">S_ISFIFO</span><span class="p">(</span><span class="n">mode</span><span class="p">))</span>
		<span class="n">data_offset</span><span class="o">-&gt;</span><span class="n">Type</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">UNIX_FIFO</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">S_ISSOCK</span><span class="p">(</span><span class="n">mode</span><span class="p">))</span>
		<span class="n">data_offset</span><span class="o">-&gt;</span><span class="n">Type</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">UNIX_SOCKET</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="nf">CIFSSMBUnixSetFileInfo</span><span class="p">(</span><span class="k">const</span> <span class="kt">int</span> <span class="n">xid</span><span class="p">,</span> <span class="k">struct</span> <span class="n">cifs_tcon</span> <span class="o">*</span><span class="n">tcon</span><span class="p">,</span>
		       <span class="k">const</span> <span class="k">struct</span> <span class="n">cifs_unix_set_info_args</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span>
		       <span class="n">u16</span> <span class="n">fid</span><span class="p">,</span> <span class="n">u32</span> <span class="n">pid_of_opener</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">smb_com_transaction2_sfi_req</span> <span class="o">*</span><span class="n">pSMB</span>  <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">data_offset</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">params</span><span class="p">,</span> <span class="n">param_offset</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">byte_count</span><span class="p">,</span> <span class="n">count</span><span class="p">;</span>

	<span class="n">cFYI</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;Set Unix Info (via SetFileInfo)&quot;</span><span class="p">);</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">small_smb_init</span><span class="p">(</span><span class="n">SMB_COM_TRANSACTION2</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="n">tcon</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">**</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">pSMB</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">Pid</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">((</span><span class="n">__u16</span><span class="p">)</span><span class="n">pid_of_opener</span><span class="p">);</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">PidHigh</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">((</span><span class="n">__u16</span><span class="p">)(</span><span class="n">pid_of_opener</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">));</span>

	<span class="n">params</span> <span class="o">=</span> <span class="mi">6</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">MaxSetupCount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">Reserved</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">Flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">Timeout</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">Reserved2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">param_offset</span> <span class="o">=</span> <span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">smb_com_transaction2_sfi_req</span><span class="p">,</span> <span class="n">Fid</span><span class="p">)</span> <span class="o">-</span> <span class="mi">4</span><span class="p">;</span>
	<span class="n">offset</span> <span class="o">=</span> <span class="n">param_offset</span> <span class="o">+</span> <span class="n">params</span><span class="p">;</span>

	<span class="n">data_offset</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">pSMB</span> <span class="o">+</span>
			<span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">smb_hdr</span><span class="p">,</span> <span class="n">Protocol</span><span class="p">)</span> <span class="o">+</span> <span class="n">offset</span><span class="p">;</span>

	<span class="n">count</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">FILE_UNIX_BASIC_INFO</span><span class="p">);</span>

	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">MaxParameterCount</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
	<span class="cm">/* BB find max SMB PDU from sess */</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">MaxDataCount</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="mi">1000</span><span class="p">);</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">SetupCount</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">Reserved3</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">SubCommand</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">TRANS2_SET_FILE_INFORMATION</span><span class="p">);</span>
	<span class="n">byte_count</span> <span class="o">=</span> <span class="mi">3</span> <span class="cm">/* pad */</span>  <span class="o">+</span> <span class="n">params</span> <span class="o">+</span> <span class="n">count</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">DataCount</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">count</span><span class="p">);</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">ParameterCount</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">params</span><span class="p">);</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">TotalDataCount</span> <span class="o">=</span> <span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">DataCount</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">TotalParameterCount</span> <span class="o">=</span> <span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">ParameterCount</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">ParameterOffset</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">param_offset</span><span class="p">);</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">DataOffset</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">offset</span><span class="p">);</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">Fid</span> <span class="o">=</span> <span class="n">fid</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">InformationLevel</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">SMB_SET_FILE_UNIX_BASIC</span><span class="p">);</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">Reserved4</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">inc_rfc1001_len</span><span class="p">(</span><span class="n">pSMB</span><span class="p">,</span> <span class="n">byte_count</span><span class="p">);</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">ByteCount</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">byte_count</span><span class="p">);</span>

	<span class="n">cifs_fill_unix_set_info</span><span class="p">((</span><span class="n">FILE_UNIX_BASIC_INFO</span> <span class="o">*</span><span class="p">)</span><span class="n">data_offset</span><span class="p">,</span> <span class="n">args</span><span class="p">);</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">SendReceiveNoRsp</span><span class="p">(</span><span class="n">xid</span><span class="p">,</span> <span class="n">tcon</span><span class="o">-&gt;</span><span class="n">ses</span><span class="p">,</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">pSMB</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="n">cFYI</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;Send error in Set Time (SetFileInfo) = %d&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>

	<span class="cm">/* Note: On -EAGAIN error only caller can retry on handle based calls</span>
<span class="cm">		since file handle passed in no longer valid */</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="nf">CIFSSMBUnixSetPathInfo</span><span class="p">(</span><span class="k">const</span> <span class="kt">int</span> <span class="n">xid</span><span class="p">,</span> <span class="k">struct</span> <span class="n">cifs_tcon</span> <span class="o">*</span><span class="n">tcon</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">fileName</span><span class="p">,</span>
		       <span class="k">const</span> <span class="k">struct</span> <span class="n">cifs_unix_set_info_args</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span>
		       <span class="k">const</span> <span class="k">struct</span> <span class="n">nls_table</span> <span class="o">*</span><span class="n">nls_codepage</span><span class="p">,</span> <span class="kt">int</span> <span class="n">remap</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">TRANSACTION2_SPI_REQ</span> <span class="o">*</span><span class="n">pSMB</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">TRANSACTION2_SPI_RSP</span> <span class="o">*</span><span class="n">pSMBr</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">name_len</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">bytes_returned</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">FILE_UNIX_BASIC_INFO</span> <span class="o">*</span><span class="n">data_offset</span><span class="p">;</span>
	<span class="n">__u16</span> <span class="n">params</span><span class="p">,</span> <span class="n">param_offset</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">byte_count</span><span class="p">;</span>

	<span class="n">cFYI</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;In SetUID/GID/Mode&quot;</span><span class="p">);</span>
<span class="nl">setPermsRetry:</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">smb_init</span><span class="p">(</span><span class="n">SMB_COM_TRANSACTION2</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="n">tcon</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">**</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">pSMB</span><span class="p">,</span>
		      <span class="p">(</span><span class="kt">void</span> <span class="o">**</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">pSMBr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">Flags2</span> <span class="o">&amp;</span> <span class="n">SMBFLG2_UNICODE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">name_len</span> <span class="o">=</span>
		    <span class="n">cifsConvertToUTF16</span><span class="p">((</span><span class="n">__le16</span> <span class="o">*</span><span class="p">)</span> <span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">FileName</span><span class="p">,</span> <span class="n">fileName</span><span class="p">,</span>
				       <span class="n">PATH_MAX</span><span class="p">,</span> <span class="n">nls_codepage</span><span class="p">,</span> <span class="n">remap</span><span class="p">);</span>
		<span class="n">name_len</span><span class="o">++</span><span class="p">;</span>	<span class="cm">/* trailing null */</span>
		<span class="n">name_len</span> <span class="o">*=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>	<span class="cm">/* BB improve the check for buffer overruns BB */</span>
		<span class="n">name_len</span> <span class="o">=</span> <span class="n">strnlen</span><span class="p">(</span><span class="n">fileName</span><span class="p">,</span> <span class="n">PATH_MAX</span><span class="p">);</span>
		<span class="n">name_len</span><span class="o">++</span><span class="p">;</span>	<span class="cm">/* trailing null */</span>
		<span class="n">strncpy</span><span class="p">(</span><span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">FileName</span><span class="p">,</span> <span class="n">fileName</span><span class="p">,</span> <span class="n">name_len</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">params</span> <span class="o">=</span> <span class="mi">6</span> <span class="o">+</span> <span class="n">name_len</span><span class="p">;</span>
	<span class="n">count</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">FILE_UNIX_BASIC_INFO</span><span class="p">);</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">MaxParameterCount</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
	<span class="cm">/* BB find max SMB PDU from sess structure BB */</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">MaxDataCount</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="mi">1000</span><span class="p">);</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">MaxSetupCount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">Reserved</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">Flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">Timeout</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">Reserved2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">param_offset</span> <span class="o">=</span> <span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">smb_com_transaction2_spi_req</span><span class="p">,</span>
				<span class="n">InformationLevel</span><span class="p">)</span> <span class="o">-</span> <span class="mi">4</span><span class="p">;</span>
	<span class="n">offset</span> <span class="o">=</span> <span class="n">param_offset</span> <span class="o">+</span> <span class="n">params</span><span class="p">;</span>
	<span class="n">data_offset</span> <span class="o">=</span>
	    <span class="p">(</span><span class="n">FILE_UNIX_BASIC_INFO</span> <span class="o">*</span><span class="p">)</span> <span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">Protocol</span> <span class="o">+</span>
				      <span class="n">offset</span><span class="p">);</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">data_offset</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">DataOffset</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">offset</span><span class="p">);</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">ParameterOffset</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">param_offset</span><span class="p">);</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">SetupCount</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">Reserved3</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">SubCommand</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">TRANS2_SET_PATH_INFORMATION</span><span class="p">);</span>
	<span class="n">byte_count</span> <span class="o">=</span> <span class="mi">3</span> <span class="cm">/* pad */</span>  <span class="o">+</span> <span class="n">params</span> <span class="o">+</span> <span class="n">count</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">ParameterCount</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">params</span><span class="p">);</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">DataCount</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">count</span><span class="p">);</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">TotalParameterCount</span> <span class="o">=</span> <span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">ParameterCount</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">TotalDataCount</span> <span class="o">=</span> <span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">DataCount</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">InformationLevel</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">SMB_SET_FILE_UNIX_BASIC</span><span class="p">);</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">Reserved4</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">inc_rfc1001_len</span><span class="p">(</span><span class="n">pSMB</span><span class="p">,</span> <span class="n">byte_count</span><span class="p">);</span>

	<span class="n">cifs_fill_unix_set_info</span><span class="p">(</span><span class="n">data_offset</span><span class="p">,</span> <span class="n">args</span><span class="p">);</span>

	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">ByteCount</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">byte_count</span><span class="p">);</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">SendReceive</span><span class="p">(</span><span class="n">xid</span><span class="p">,</span> <span class="n">tcon</span><span class="o">-&gt;</span><span class="n">ses</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">smb_hdr</span> <span class="o">*</span><span class="p">)</span> <span class="n">pSMB</span><span class="p">,</span>
			 <span class="p">(</span><span class="k">struct</span> <span class="n">smb_hdr</span> <span class="o">*</span><span class="p">)</span> <span class="n">pSMBr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bytes_returned</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="n">cFYI</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;SetPathInfo (perms) returned %d&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>

	<span class="n">cifs_buf_release</span><span class="p">(</span><span class="n">pSMB</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">setPermsRetry</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_CIFS_XATTR</span>
<span class="cm">/*</span>
<span class="cm"> * Do a path-based QUERY_ALL_EAS call and parse the result. This is a common</span>
<span class="cm"> * function used by listxattr and getxattr type calls. When ea_name is set,</span>
<span class="cm"> * it looks for that attribute name and stuffs that value into the EAData</span>
<span class="cm"> * buffer. When ea_name is NULL, it stuffs a list of attribute names into the</span>
<span class="cm"> * buffer. In both cases, the return value is either the length of the</span>
<span class="cm"> * resulting data or a negative error code. If EAData is a NULL pointer then</span>
<span class="cm"> * the data isn&#39;t copied to it, but the length is returned.</span>
<span class="cm"> */</span>
<span class="kt">ssize_t</span>
<span class="nf">CIFSSMBQAllEAs</span><span class="p">(</span><span class="k">const</span> <span class="kt">int</span> <span class="n">xid</span><span class="p">,</span> <span class="k">struct</span> <span class="n">cifs_tcon</span> <span class="o">*</span><span class="n">tcon</span><span class="p">,</span>
		<span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">searchName</span><span class="p">,</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">ea_name</span><span class="p">,</span>
		<span class="kt">char</span> <span class="o">*</span><span class="n">EAData</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">buf_size</span><span class="p">,</span>
		<span class="k">const</span> <span class="k">struct</span> <span class="n">nls_table</span> <span class="o">*</span><span class="n">nls_codepage</span><span class="p">,</span> <span class="kt">int</span> <span class="n">remap</span><span class="p">)</span>
<span class="p">{</span>
		<span class="cm">/* BB assumes one setup word */</span>
	<span class="n">TRANSACTION2_QPI_REQ</span> <span class="o">*</span><span class="n">pSMB</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">TRANSACTION2_QPI_RSP</span> <span class="o">*</span><span class="n">pSMBr</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">bytes_returned</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">list_len</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fealist</span> <span class="o">*</span><span class="n">ea_response_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fea</span> <span class="o">*</span><span class="n">temp_fea</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">temp_ptr</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">end_of_smb</span><span class="p">;</span>
	<span class="n">__u16</span> <span class="n">params</span><span class="p">,</span> <span class="n">byte_count</span><span class="p">,</span> <span class="n">data_offset</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ea_name_len</span> <span class="o">=</span> <span class="n">ea_name</span> <span class="o">?</span> <span class="n">strlen</span><span class="p">(</span><span class="n">ea_name</span><span class="p">)</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">cFYI</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;In Query All EAs path %s&quot;</span><span class="p">,</span> <span class="n">searchName</span><span class="p">);</span>
<span class="nl">QAllEAsRetry:</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">smb_init</span><span class="p">(</span><span class="n">SMB_COM_TRANSACTION2</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="n">tcon</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">**</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">pSMB</span><span class="p">,</span>
		      <span class="p">(</span><span class="kt">void</span> <span class="o">**</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">pSMBr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">Flags2</span> <span class="o">&amp;</span> <span class="n">SMBFLG2_UNICODE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">list_len</span> <span class="o">=</span>
		    <span class="n">cifsConvertToUTF16</span><span class="p">((</span><span class="n">__le16</span> <span class="o">*</span><span class="p">)</span> <span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">FileName</span><span class="p">,</span> <span class="n">searchName</span><span class="p">,</span>
				       <span class="n">PATH_MAX</span><span class="p">,</span> <span class="n">nls_codepage</span><span class="p">,</span> <span class="n">remap</span><span class="p">);</span>
		<span class="n">list_len</span><span class="o">++</span><span class="p">;</span>	<span class="cm">/* trailing null */</span>
		<span class="n">list_len</span> <span class="o">*=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>	<span class="cm">/* BB improve the check for buffer overruns BB */</span>
		<span class="n">list_len</span> <span class="o">=</span> <span class="n">strnlen</span><span class="p">(</span><span class="n">searchName</span><span class="p">,</span> <span class="n">PATH_MAX</span><span class="p">);</span>
		<span class="n">list_len</span><span class="o">++</span><span class="p">;</span>	<span class="cm">/* trailing null */</span>
		<span class="n">strncpy</span><span class="p">(</span><span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">FileName</span><span class="p">,</span> <span class="n">searchName</span><span class="p">,</span> <span class="n">list_len</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">params</span> <span class="o">=</span> <span class="mi">2</span> <span class="cm">/* level */</span> <span class="o">+</span> <span class="mi">4</span> <span class="cm">/* reserved */</span> <span class="o">+</span> <span class="n">list_len</span> <span class="cm">/* includes NUL */</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">TotalDataCount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">MaxParameterCount</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
	<span class="cm">/* BB find exact max SMB PDU from sess structure BB */</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">MaxDataCount</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">CIFSMaxBufSize</span><span class="p">);</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">MaxSetupCount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">Reserved</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">Flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">Timeout</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">Reserved2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">ParameterOffset</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">offsetof</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">smb_com_transaction2_qpi_req</span><span class="p">,</span> <span class="n">InformationLevel</span><span class="p">)</span> <span class="o">-</span> <span class="mi">4</span><span class="p">);</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">DataCount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">DataOffset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">SetupCount</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">Reserved3</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">SubCommand</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">TRANS2_QUERY_PATH_INFORMATION</span><span class="p">);</span>
	<span class="n">byte_count</span> <span class="o">=</span> <span class="n">params</span> <span class="o">+</span> <span class="mi">1</span> <span class="cm">/* pad */</span> <span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">TotalParameterCount</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">params</span><span class="p">);</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">ParameterCount</span> <span class="o">=</span> <span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">TotalParameterCount</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">InformationLevel</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">SMB_INFO_QUERY_ALL_EAS</span><span class="p">);</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">Reserved4</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">inc_rfc1001_len</span><span class="p">(</span><span class="n">pSMB</span><span class="p">,</span> <span class="n">byte_count</span><span class="p">);</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">ByteCount</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">byte_count</span><span class="p">);</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">SendReceive</span><span class="p">(</span><span class="n">xid</span><span class="p">,</span> <span class="n">tcon</span><span class="o">-&gt;</span><span class="n">ses</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">smb_hdr</span> <span class="o">*</span><span class="p">)</span> <span class="n">pSMB</span><span class="p">,</span>
			 <span class="p">(</span><span class="k">struct</span> <span class="n">smb_hdr</span> <span class="o">*</span><span class="p">)</span> <span class="n">pSMBr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bytes_returned</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cFYI</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;Send error in QueryAllEAs = %d&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">QAllEAsOut</span><span class="p">;</span>
	<span class="p">}</span>


	<span class="cm">/* BB also check enough total bytes returned */</span>
	<span class="cm">/* BB we need to improve the validity checking</span>
<span class="cm">	of these trans2 responses */</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">validate_t2</span><span class="p">((</span><span class="k">struct</span> <span class="n">smb_t2_rsp</span> <span class="o">*</span><span class="p">)</span><span class="n">pSMBr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">||</span> <span class="n">get_bcc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pSMBr</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>	<span class="cm">/* bad smb */</span>
		<span class="k">goto</span> <span class="n">QAllEAsOut</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* check that length of list is not more than bcc */</span>
	<span class="cm">/* check that each entry does not go beyond length</span>
<span class="cm">	   of list */</span>
	<span class="cm">/* check that each element of each entry does not</span>
<span class="cm">	   go beyond end of list */</span>
	<span class="cm">/* validate_trans2_offsets() */</span>
	<span class="cm">/* BB check if start of smb + data_offset &gt; &amp;bcc+ bcc */</span>

	<span class="n">data_offset</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">pSMBr</span><span class="o">-&gt;</span><span class="n">t2</span><span class="p">.</span><span class="n">DataOffset</span><span class="p">);</span>
	<span class="n">ea_response_data</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">fealist</span> <span class="o">*</span><span class="p">)</span>
				<span class="p">(((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">pSMBr</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">Protocol</span><span class="p">)</span> <span class="o">+</span> <span class="n">data_offset</span><span class="p">);</span>

	<span class="n">list_len</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">ea_response_data</span><span class="o">-&gt;</span><span class="n">list_len</span><span class="p">);</span>
	<span class="n">cFYI</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;ea length %d&quot;</span><span class="p">,</span> <span class="n">list_len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">list_len</span> <span class="o">&lt;=</span> <span class="mi">8</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cFYI</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;empty EA list returned from server&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">QAllEAsOut</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* make sure list_len doesn&#39;t go past end of SMB */</span>
	<span class="n">end_of_smb</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">pByteArea</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pSMBr</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">)</span> <span class="o">+</span> <span class="n">get_bcc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pSMBr</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">ea_response_data</span> <span class="o">+</span> <span class="n">list_len</span> <span class="o">&gt;</span> <span class="n">end_of_smb</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cFYI</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;EA list appears to go beyond SMB&quot;</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">QAllEAsOut</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* account for ea list len */</span>
	<span class="n">list_len</span> <span class="o">-=</span> <span class="mi">4</span><span class="p">;</span>
	<span class="n">temp_fea</span> <span class="o">=</span> <span class="n">ea_response_data</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">;</span>
	<span class="n">temp_ptr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">temp_fea</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">list_len</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">name_len</span><span class="p">;</span>
		<span class="n">__u16</span> <span class="n">value_len</span><span class="p">;</span>

		<span class="n">list_len</span> <span class="o">-=</span> <span class="mi">4</span><span class="p">;</span>
		<span class="n">temp_ptr</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>
		<span class="cm">/* make sure we can read name_len and value_len */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">list_len</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">cFYI</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;EA entry goes beyond length of list&quot;</span><span class="p">);</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">QAllEAsOut</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">name_len</span> <span class="o">=</span> <span class="n">temp_fea</span><span class="o">-&gt;</span><span class="n">name_len</span><span class="p">;</span>
		<span class="n">value_len</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">temp_fea</span><span class="o">-&gt;</span><span class="n">value_len</span><span class="p">);</span>
		<span class="n">list_len</span> <span class="o">-=</span> <span class="n">name_len</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">value_len</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">list_len</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">cFYI</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;EA entry goes beyond length of list&quot;</span><span class="p">);</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">QAllEAsOut</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ea_name</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ea_name_len</span> <span class="o">==</span> <span class="n">name_len</span> <span class="o">&amp;&amp;</span>
			    <span class="n">memcmp</span><span class="p">(</span><span class="n">ea_name</span><span class="p">,</span> <span class="n">temp_ptr</span><span class="p">,</span> <span class="n">name_len</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">temp_ptr</span> <span class="o">+=</span> <span class="n">name_len</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
				<span class="n">rc</span> <span class="o">=</span> <span class="n">value_len</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">buf_size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
					<span class="k">goto</span> <span class="n">QAllEAsOut</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">((</span><span class="kt">size_t</span><span class="p">)</span><span class="n">value_len</span> <span class="o">&gt;</span> <span class="n">buf_size</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ERANGE</span><span class="p">;</span>
					<span class="k">goto</span> <span class="n">QAllEAsOut</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="n">memcpy</span><span class="p">(</span><span class="n">EAData</span><span class="p">,</span> <span class="n">temp_ptr</span><span class="p">,</span> <span class="n">value_len</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">QAllEAsOut</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* account for prefix user. and trailing null */</span>
			<span class="n">rc</span> <span class="o">+=</span> <span class="p">(</span><span class="mi">5</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">name_len</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">&lt;</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="n">buf_size</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">memcpy</span><span class="p">(</span><span class="n">EAData</span><span class="p">,</span> <span class="s">&quot;user.&quot;</span><span class="p">,</span> <span class="mi">5</span><span class="p">);</span>
				<span class="n">EAData</span> <span class="o">+=</span> <span class="mi">5</span><span class="p">;</span>
				<span class="n">memcpy</span><span class="p">(</span><span class="n">EAData</span><span class="p">,</span> <span class="n">temp_ptr</span><span class="p">,</span> <span class="n">name_len</span><span class="p">);</span>
				<span class="n">EAData</span> <span class="o">+=</span> <span class="n">name_len</span><span class="p">;</span>
				<span class="cm">/* null terminate name */</span>
				<span class="o">*</span><span class="n">EAData</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="o">++</span><span class="n">EAData</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">buf_size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* skip copy - calc size only */</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="cm">/* stop before overrun buffer */</span>
				<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ERANGE</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">temp_ptr</span> <span class="o">+=</span> <span class="n">name_len</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">value_len</span><span class="p">;</span>
		<span class="n">temp_fea</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">fea</span> <span class="o">*</span><span class="p">)</span><span class="n">temp_ptr</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* didn&#39;t find the named attribute */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ea_name</span><span class="p">)</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODATA</span><span class="p">;</span>

<span class="nl">QAllEAsOut:</span>
	<span class="n">cifs_buf_release</span><span class="p">(</span><span class="n">pSMB</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">QAllEAsRetry</span><span class="p">;</span>

	<span class="k">return</span> <span class="p">(</span><span class="kt">ssize_t</span><span class="p">)</span><span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="nf">CIFSSMBSetEA</span><span class="p">(</span><span class="k">const</span> <span class="kt">int</span> <span class="n">xid</span><span class="p">,</span> <span class="k">struct</span> <span class="n">cifs_tcon</span> <span class="o">*</span><span class="n">tcon</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">fileName</span><span class="p">,</span>
	     <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">ea_name</span><span class="p">,</span> <span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">ea_value</span><span class="p">,</span>
	     <span class="k">const</span> <span class="n">__u16</span> <span class="n">ea_value_len</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">nls_table</span> <span class="o">*</span><span class="n">nls_codepage</span><span class="p">,</span>
	     <span class="kt">int</span> <span class="n">remap</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">smb_com_transaction2_spi_req</span> <span class="o">*</span><span class="n">pSMB</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">smb_com_transaction2_spi_rsp</span> <span class="o">*</span><span class="n">pSMBr</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fealist</span> <span class="o">*</span><span class="n">parm_data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">name_len</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">bytes_returned</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">__u16</span> <span class="n">params</span><span class="p">,</span> <span class="n">param_offset</span><span class="p">,</span> <span class="n">byte_count</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">count</span><span class="p">;</span>

	<span class="n">cFYI</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;In SetEA&quot;</span><span class="p">);</span>
<span class="nl">SetEARetry:</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">smb_init</span><span class="p">(</span><span class="n">SMB_COM_TRANSACTION2</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="n">tcon</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">**</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">pSMB</span><span class="p">,</span>
		      <span class="p">(</span><span class="kt">void</span> <span class="o">**</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">pSMBr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">Flags2</span> <span class="o">&amp;</span> <span class="n">SMBFLG2_UNICODE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">name_len</span> <span class="o">=</span>
		    <span class="n">cifsConvertToUTF16</span><span class="p">((</span><span class="n">__le16</span> <span class="o">*</span><span class="p">)</span> <span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">FileName</span><span class="p">,</span> <span class="n">fileName</span><span class="p">,</span>
				       <span class="n">PATH_MAX</span><span class="p">,</span> <span class="n">nls_codepage</span><span class="p">,</span> <span class="n">remap</span><span class="p">);</span>
		<span class="n">name_len</span><span class="o">++</span><span class="p">;</span>	<span class="cm">/* trailing null */</span>
		<span class="n">name_len</span> <span class="o">*=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>	<span class="cm">/* BB improve the check for buffer overruns BB */</span>
		<span class="n">name_len</span> <span class="o">=</span> <span class="n">strnlen</span><span class="p">(</span><span class="n">fileName</span><span class="p">,</span> <span class="n">PATH_MAX</span><span class="p">);</span>
		<span class="n">name_len</span><span class="o">++</span><span class="p">;</span>	<span class="cm">/* trailing null */</span>
		<span class="n">strncpy</span><span class="p">(</span><span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">FileName</span><span class="p">,</span> <span class="n">fileName</span><span class="p">,</span> <span class="n">name_len</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">params</span> <span class="o">=</span> <span class="mi">6</span> <span class="o">+</span> <span class="n">name_len</span><span class="p">;</span>

	<span class="cm">/* done calculating parms using name_len of file name,</span>
<span class="cm">	now use name_len to calculate length of ea name</span>
<span class="cm">	we are going to create in the inode xattrs */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ea_name</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">name_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">name_len</span> <span class="o">=</span> <span class="n">strnlen</span><span class="p">(</span><span class="n">ea_name</span><span class="p">,</span> <span class="mi">255</span><span class="p">);</span>

	<span class="n">count</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">parm_data</span><span class="p">)</span> <span class="o">+</span> <span class="n">ea_value_len</span> <span class="o">+</span> <span class="n">name_len</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">MaxParameterCount</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
	<span class="cm">/* BB find max SMB PDU from sess */</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">MaxDataCount</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="mi">1000</span><span class="p">);</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">MaxSetupCount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">Reserved</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">Flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">Timeout</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">Reserved2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">param_offset</span> <span class="o">=</span> <span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">smb_com_transaction2_spi_req</span><span class="p">,</span>
				<span class="n">InformationLevel</span><span class="p">)</span> <span class="o">-</span> <span class="mi">4</span><span class="p">;</span>
	<span class="n">offset</span> <span class="o">=</span> <span class="n">param_offset</span> <span class="o">+</span> <span class="n">params</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">InformationLevel</span> <span class="o">=</span>
		<span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">SMB_SET_FILE_EA</span><span class="p">);</span>

	<span class="n">parm_data</span> <span class="o">=</span>
		<span class="p">(</span><span class="k">struct</span> <span class="n">fealist</span> <span class="o">*</span><span class="p">)</span> <span class="p">(((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">Protocol</span><span class="p">)</span> <span class="o">+</span>
				       <span class="n">offset</span><span class="p">);</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">ParameterOffset</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">param_offset</span><span class="p">);</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">DataOffset</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">offset</span><span class="p">);</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">SetupCount</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">Reserved3</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">SubCommand</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">TRANS2_SET_PATH_INFORMATION</span><span class="p">);</span>
	<span class="n">byte_count</span> <span class="o">=</span> <span class="mi">3</span> <span class="cm">/* pad */</span>  <span class="o">+</span> <span class="n">params</span> <span class="o">+</span> <span class="n">count</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">DataCount</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">count</span><span class="p">);</span>
	<span class="n">parm_data</span><span class="o">-&gt;</span><span class="n">list_len</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">count</span><span class="p">);</span>
	<span class="n">parm_data</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">EA_flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="cm">/* we checked above that name len is less than 255 */</span>
	<span class="n">parm_data</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">name_len</span> <span class="o">=</span> <span class="p">(</span><span class="n">__u8</span><span class="p">)</span><span class="n">name_len</span><span class="p">;</span>
	<span class="cm">/* EA names are always ASCII */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ea_name</span><span class="p">)</span>
		<span class="n">strncpy</span><span class="p">(</span><span class="n">parm_data</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">name</span><span class="p">,</span> <span class="n">ea_name</span><span class="p">,</span> <span class="n">name_len</span><span class="p">);</span>
	<span class="n">parm_data</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">name</span><span class="p">[</span><span class="n">name_len</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">parm_data</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">value_len</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">ea_value_len</span><span class="p">);</span>
	<span class="cm">/* caller ensures that ea_value_len is less than 64K but</span>
<span class="cm">	we need to ensure that it fits within the smb */</span>

	<span class="cm">/*BB add length check to see if it would fit in</span>
<span class="cm">	     negotiated SMB buffer size BB */</span>
	<span class="cm">/* if (ea_value_len &gt; buffer_size - 512 (enough for header)) */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ea_value_len</span><span class="p">)</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">parm_data</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">name</span><span class="o">+</span><span class="n">name_len</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span>
		       <span class="n">ea_value</span><span class="p">,</span> <span class="n">ea_value_len</span><span class="p">);</span>

	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">TotalDataCount</span> <span class="o">=</span> <span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">DataCount</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">ParameterCount</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">params</span><span class="p">);</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">TotalParameterCount</span> <span class="o">=</span> <span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">ParameterCount</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">Reserved4</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">inc_rfc1001_len</span><span class="p">(</span><span class="n">pSMB</span><span class="p">,</span> <span class="n">byte_count</span><span class="p">);</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">ByteCount</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">byte_count</span><span class="p">);</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">SendReceive</span><span class="p">(</span><span class="n">xid</span><span class="p">,</span> <span class="n">tcon</span><span class="o">-&gt;</span><span class="n">ses</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">smb_hdr</span> <span class="o">*</span><span class="p">)</span> <span class="n">pSMB</span><span class="p">,</span>
			 <span class="p">(</span><span class="k">struct</span> <span class="n">smb_hdr</span> <span class="o">*</span><span class="p">)</span> <span class="n">pSMBr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bytes_returned</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="n">cFYI</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;SetPathInfo (EA) returned %d&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>

	<span class="n">cifs_buf_release</span><span class="p">(</span><span class="n">pSMB</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">SetEARetry</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef CONFIG_CIFS_DNOTIFY_EXPERIMENTAL </span><span class="cm">/* BB unused temporarily */</span><span class="cp"></span>
<span class="cm">/*</span>
<span class="cm"> *	Years ago the kernel added a &quot;dnotify&quot; function for Samba server,</span>
<span class="cm"> *	to allow network clients (such as Windows) to display updated</span>
<span class="cm"> *	lists of files in directory listings automatically when</span>
<span class="cm"> *	files are added by one user when another user has the</span>
<span class="cm"> *	same directory open on their desktop.  The Linux cifs kernel</span>
<span class="cm"> *	client hooked into the kernel side of this interface for</span>
<span class="cm"> *	the same reason, but ironically when the VFS moved from</span>
<span class="cm"> *	&quot;dnotify&quot; to &quot;inotify&quot; it became harder to plug in Linux</span>
<span class="cm"> *	network file system clients (the most obvious use case</span>
<span class="cm"> *	for notify interfaces is when multiple users can update</span>
<span class="cm"> *	the contents of the same directory - exactly what network</span>
<span class="cm"> *	file systems can do) although the server (Samba) could</span>
<span class="cm"> *	still use it.  For the short term we leave the worker</span>
<span class="cm"> *	function ifdeffed out (below) until inotify is fixed</span>
<span class="cm"> *	in the VFS to make it easier to plug in network file</span>
<span class="cm"> *	system clients.  If inotify turns out to be permanently</span>
<span class="cm"> *	incompatible for network fs clients, we could instead simply</span>
<span class="cm"> *	expose this config flag by adding a future cifs (and smb2) notify ioctl.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">CIFSSMBNotify</span><span class="p">(</span><span class="k">const</span> <span class="kt">int</span> <span class="n">xid</span><span class="p">,</span> <span class="k">struct</span> <span class="n">cifs_tcon</span> <span class="o">*</span><span class="n">tcon</span><span class="p">,</span>
		  <span class="k">const</span> <span class="kt">int</span> <span class="n">notify_subdirs</span><span class="p">,</span> <span class="k">const</span> <span class="n">__u16</span> <span class="n">netfid</span><span class="p">,</span>
		  <span class="n">__u32</span> <span class="n">filter</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">pfile</span><span class="p">,</span> <span class="kt">int</span> <span class="n">multishot</span><span class="p">,</span>
		  <span class="k">const</span> <span class="k">struct</span> <span class="n">nls_table</span> <span class="o">*</span><span class="n">nls_codepage</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">smb_com_transaction_change_notify_req</span> <span class="o">*</span><span class="n">pSMB</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">smb_com_ntransaction_change_notify_rsp</span> <span class="o">*</span><span class="n">pSMBr</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dir_notify_req</span> <span class="o">*</span><span class="n">dnotify_req</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">bytes_returned</span><span class="p">;</span>

	<span class="n">cFYI</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;In CIFSSMBNotify for file handle %d&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">netfid</span><span class="p">);</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">smb_init</span><span class="p">(</span><span class="n">SMB_COM_NT_TRANSACT</span><span class="p">,</span> <span class="mi">23</span><span class="p">,</span> <span class="n">tcon</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">**</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">pSMB</span><span class="p">,</span>
		      <span class="p">(</span><span class="kt">void</span> <span class="o">**</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">pSMBr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">TotalParameterCount</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">TotalDataCount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">MaxParameterCount</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">MaxDataCount</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">CIFSMaxBufSize</span> <span class="o">&amp;</span> <span class="mh">0xFFFFFF00</span><span class="p">);</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">MaxSetupCount</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">Reserved</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">ParameterOffset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">DataCount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">DataOffset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">SetupCount</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span> <span class="cm">/* single byte does not need le conversion */</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">SubCommand</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">NT_TRANSACT_NOTIFY_CHANGE</span><span class="p">);</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">ParameterCount</span> <span class="o">=</span> <span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">TotalParameterCount</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">notify_subdirs</span><span class="p">)</span>
		<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">WatchTree</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="cm">/* one byte - no le conversion needed */</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">Reserved2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">CompletionFilter</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">filter</span><span class="p">);</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">Fid</span> <span class="o">=</span> <span class="n">netfid</span><span class="p">;</span> <span class="cm">/* file handle always le */</span>
	<span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">ByteCount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">SendReceive</span><span class="p">(</span><span class="n">xid</span><span class="p">,</span> <span class="n">tcon</span><span class="o">-&gt;</span><span class="n">ses</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">smb_hdr</span> <span class="o">*</span><span class="p">)</span> <span class="n">pSMB</span><span class="p">,</span>
			 <span class="p">(</span><span class="k">struct</span> <span class="n">smb_hdr</span> <span class="o">*</span><span class="p">)</span><span class="n">pSMBr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bytes_returned</span><span class="p">,</span>
			 <span class="n">CIFS_ASYNC_OP</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cFYI</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;Error in Notify = %d&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* Add file to outstanding requests */</span>
		<span class="cm">/* BB change to kmem cache alloc */</span>
		<span class="n">dnotify_req</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span>
						<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">dir_notify_req</span><span class="p">),</span>
						 <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dnotify_req</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dnotify_req</span><span class="o">-&gt;</span><span class="n">Pid</span> <span class="o">=</span> <span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">Pid</span><span class="p">;</span>
			<span class="n">dnotify_req</span><span class="o">-&gt;</span><span class="n">PidHigh</span> <span class="o">=</span> <span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">PidHigh</span><span class="p">;</span>
			<span class="n">dnotify_req</span><span class="o">-&gt;</span><span class="n">Mid</span> <span class="o">=</span> <span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">Mid</span><span class="p">;</span>
			<span class="n">dnotify_req</span><span class="o">-&gt;</span><span class="n">Tid</span> <span class="o">=</span> <span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">Tid</span><span class="p">;</span>
			<span class="n">dnotify_req</span><span class="o">-&gt;</span><span class="n">Uid</span> <span class="o">=</span> <span class="n">pSMB</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">Uid</span><span class="p">;</span>
			<span class="n">dnotify_req</span><span class="o">-&gt;</span><span class="n">netfid</span> <span class="o">=</span> <span class="n">netfid</span><span class="p">;</span>
			<span class="n">dnotify_req</span><span class="o">-&gt;</span><span class="n">pfile</span> <span class="o">=</span> <span class="n">pfile</span><span class="p">;</span>
			<span class="n">dnotify_req</span><span class="o">-&gt;</span><span class="n">filter</span> <span class="o">=</span> <span class="n">filter</span><span class="p">;</span>
			<span class="n">dnotify_req</span><span class="o">-&gt;</span><span class="n">multishot</span> <span class="o">=</span> <span class="n">multishot</span><span class="p">;</span>
			<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">GlobalMid_Lock</span><span class="p">);</span>
			<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dnotify_req</span><span class="o">-&gt;</span><span class="n">lhead</span><span class="p">,</span>
					<span class="o">&amp;</span><span class="n">GlobalDnotifyReqList</span><span class="p">);</span>
			<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">GlobalMid_Lock</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">cifs_buf_release</span><span class="p">(</span><span class="n">pSMB</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* was needed for dnotify, and will be needed for inotify when VFS fix */</span><span class="cp"></span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
