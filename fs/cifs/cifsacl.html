<!DOCTYPE html>
<html><head><title>joekychen/linux » fs › cifs › cifsacl.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>cifsacl.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> *   fs/cifs/cifsacl.c</span>
<span class="cm"> *</span>
<span class="cm"> *   Copyright (C) International Business Machines  Corp., 2007,2008</span>
<span class="cm"> *   Author(s): Steve French (sfrench@us.ibm.com)</span>
<span class="cm"> *</span>
<span class="cm"> *   Contains the routines for mapping CIFS/NTFS ACLs</span>
<span class="cm"> *</span>
<span class="cm"> *   This library is free software; you can redistribute it and/or modify</span>
<span class="cm"> *   it under the terms of the GNU Lesser General Public License as published</span>
<span class="cm"> *   by the Free Software Foundation; either version 2.1 of the License, or</span>
<span class="cm"> *   (at your option) any later version.</span>
<span class="cm"> *</span>
<span class="cm"> *   This library is distributed in the hope that it will be useful,</span>
<span class="cm"> *   but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> *   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See</span>
<span class="cm"> *   the GNU Lesser General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> *   You should have received a copy of the GNU Lesser General Public License</span>
<span class="cm"> *   along with this library; if not, write to the Free Software</span>
<span class="cm"> *   Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA 02111-1307 USA</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/fs.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/string.h&gt;</span>
<span class="cp">#include &lt;linux/keyctl.h&gt;</span>
<span class="cp">#include &lt;linux/key-type.h&gt;</span>
<span class="cp">#include &lt;keys/user-type.h&gt;</span>
<span class="cp">#include &quot;cifspdu.h&quot;</span>
<span class="cp">#include &quot;cifsglob.h&quot;</span>
<span class="cp">#include &quot;cifsacl.h&quot;</span>
<span class="cp">#include &quot;cifsproto.h&quot;</span>
<span class="cp">#include &quot;cifs_debug.h&quot;</span>

<span class="cm">/* security id for everyone/world system group */</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">cifs_sid</span> <span class="n">sid_everyone</span> <span class="o">=</span> <span class="p">{</span>
	<span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">},</span> <span class="p">{</span><span class="mi">0</span><span class="p">}</span> <span class="p">};</span>
<span class="cm">/* security id for Authenticated Users system group */</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">cifs_sid</span> <span class="n">sid_authusers</span> <span class="o">=</span> <span class="p">{</span>
	<span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">5</span><span class="p">},</span> <span class="p">{</span><span class="n">__constant_cpu_to_le32</span><span class="p">(</span><span class="mi">11</span><span class="p">)}</span> <span class="p">};</span>
<span class="cm">/* group users */</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">cifs_sid</span> <span class="n">sid_user</span> <span class="o">=</span> <span class="p">{</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span> <span class="p">,</span> <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">5</span><span class="p">},</span> <span class="p">{}</span> <span class="p">};</span>

<span class="k">const</span> <span class="k">struct</span> <span class="n">cred</span> <span class="o">*</span><span class="n">root_cred</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">shrink_idmap_tree</span><span class="p">(</span><span class="k">struct</span> <span class="n">rb_root</span> <span class="o">*</span><span class="n">root</span><span class="p">,</span> <span class="kt">int</span> <span class="n">nr_to_scan</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">nr_rem</span><span class="p">,</span>
			<span class="kt">int</span> <span class="o">*</span><span class="n">nr_del</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rb_node</span> <span class="o">*</span><span class="n">node</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rb_node</span> <span class="o">*</span><span class="n">tmp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cifs_sid_id</span> <span class="o">*</span><span class="n">psidid</span><span class="p">;</span>

	<span class="n">node</span> <span class="o">=</span> <span class="n">rb_first</span><span class="p">(</span><span class="n">root</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">node</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="n">node</span><span class="p">;</span>
		<span class="n">node</span> <span class="o">=</span> <span class="n">rb_next</span><span class="p">(</span><span class="n">tmp</span><span class="p">);</span>
		<span class="n">psidid</span> <span class="o">=</span> <span class="n">rb_entry</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">cifs_sid_id</span><span class="p">,</span> <span class="n">rbnode</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">nr_to_scan</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="o">*</span><span class="n">nr_del</span> <span class="o">==</span> <span class="n">nr_to_scan</span><span class="p">)</span>
			<span class="o">++</span><span class="p">(</span><span class="o">*</span><span class="n">nr_rem</span><span class="p">);</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">time_after</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">psidid</span><span class="o">-&gt;</span><span class="n">time</span> <span class="o">+</span> <span class="n">SID_MAP_EXPIRE</span><span class="p">)</span>
						<span class="o">&amp;&amp;</span> <span class="n">psidid</span><span class="o">-&gt;</span><span class="n">refcount</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">rb_erase</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="n">root</span><span class="p">);</span>
				<span class="o">++</span><span class="p">(</span><span class="o">*</span><span class="n">nr_del</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span>
				<span class="o">++</span><span class="p">(</span><span class="o">*</span><span class="n">nr_rem</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Run idmap cache shrinker.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">cifs_idmap_shrinker</span><span class="p">(</span><span class="k">struct</span> <span class="n">shrinker</span> <span class="o">*</span><span class="n">shrink</span><span class="p">,</span> <span class="k">struct</span> <span class="n">shrink_control</span> <span class="o">*</span><span class="n">sc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">nr_to_scan</span> <span class="o">=</span> <span class="n">sc</span><span class="o">-&gt;</span><span class="n">nr_to_scan</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">nr_del</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">nr_rem</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rb_root</span> <span class="o">*</span><span class="n">root</span><span class="p">;</span>

	<span class="n">root</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">uidtree</span><span class="p">;</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">siduidlock</span><span class="p">);</span>
	<span class="n">shrink_idmap_tree</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">nr_to_scan</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">nr_rem</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">nr_del</span><span class="p">);</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">siduidlock</span><span class="p">);</span>

	<span class="n">root</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">gidtree</span><span class="p">;</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sidgidlock</span><span class="p">);</span>
	<span class="n">shrink_idmap_tree</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">nr_to_scan</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">nr_rem</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">nr_del</span><span class="p">);</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sidgidlock</span><span class="p">);</span>

	<span class="n">root</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">siduidtree</span><span class="p">;</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">uidsidlock</span><span class="p">);</span>
	<span class="n">shrink_idmap_tree</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">nr_to_scan</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">nr_rem</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">nr_del</span><span class="p">);</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">uidsidlock</span><span class="p">);</span>

	<span class="n">root</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sidgidtree</span><span class="p">;</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gidsidlock</span><span class="p">);</span>
	<span class="n">shrink_idmap_tree</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">nr_to_scan</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">nr_rem</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">nr_del</span><span class="p">);</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gidsidlock</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">nr_rem</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">sid_rb_insert</span><span class="p">(</span><span class="k">struct</span> <span class="n">rb_root</span> <span class="o">*</span><span class="n">root</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">cid</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">cifs_sid_id</span> <span class="o">**</span><span class="n">psidid</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">typestr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">strptr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rb_node</span> <span class="o">*</span><span class="n">node</span> <span class="o">=</span> <span class="n">root</span><span class="o">-&gt;</span><span class="n">rb_node</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rb_node</span> <span class="o">*</span><span class="n">parent</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rb_node</span> <span class="o">**</span><span class="n">linkto</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">root</span><span class="o">-&gt;</span><span class="n">rb_node</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">cifs_sid_id</span> <span class="o">*</span><span class="n">lsidid</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">node</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">lsidid</span> <span class="o">=</span> <span class="n">rb_entry</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="k">struct</span> <span class="n">cifs_sid_id</span><span class="p">,</span> <span class="n">rbnode</span><span class="p">);</span>
		<span class="n">parent</span> <span class="o">=</span> <span class="n">node</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cid</span> <span class="o">&gt;</span> <span class="n">lsidid</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">linkto</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">node</span><span class="o">-&gt;</span><span class="n">rb_left</span><span class="p">);</span>
			<span class="n">node</span> <span class="o">=</span> <span class="n">node</span><span class="o">-&gt;</span><span class="n">rb_left</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cid</span> <span class="o">&lt;</span> <span class="n">lsidid</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">linkto</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">node</span><span class="o">-&gt;</span><span class="n">rb_right</span><span class="p">);</span>
			<span class="n">node</span> <span class="o">=</span> <span class="n">node</span><span class="o">-&gt;</span><span class="n">rb_right</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="p">(</span><span class="o">*</span><span class="n">psidid</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">=</span> <span class="n">cid</span><span class="p">;</span>
	<span class="p">(</span><span class="o">*</span><span class="n">psidid</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">time</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">-</span> <span class="p">(</span><span class="n">SID_MAP_RETRY</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">(</span><span class="o">*</span><span class="n">psidid</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">refcount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">sprintf</span><span class="p">((</span><span class="o">*</span><span class="n">psidid</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">sidstr</span><span class="p">,</span> <span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">typestr</span><span class="p">);</span>
	<span class="n">strptr</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="n">psidid</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">sidstr</span> <span class="o">+</span> <span class="n">strlen</span><span class="p">((</span><span class="o">*</span><span class="n">psidid</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">sidstr</span><span class="p">);</span>
	<span class="n">sprintf</span><span class="p">(</span><span class="n">strptr</span><span class="p">,</span> <span class="s">&quot;%ld&quot;</span><span class="p">,</span> <span class="n">cid</span><span class="p">);</span>

	<span class="n">clear_bit</span><span class="p">(</span><span class="n">SID_ID_PENDING</span><span class="p">,</span> <span class="o">&amp;</span><span class="p">(</span><span class="o">*</span><span class="n">psidid</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">);</span>
	<span class="n">clear_bit</span><span class="p">(</span><span class="n">SID_ID_MAPPED</span><span class="p">,</span> <span class="o">&amp;</span><span class="p">(</span><span class="o">*</span><span class="n">psidid</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">);</span>

	<span class="n">rb_link_node</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="o">*</span><span class="n">psidid</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">rbnode</span><span class="p">,</span> <span class="n">parent</span><span class="p">,</span> <span class="n">linkto</span><span class="p">);</span>
	<span class="n">rb_insert_color</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="o">*</span><span class="n">psidid</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">rbnode</span><span class="p">,</span> <span class="n">root</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">cifs_sid_id</span> <span class="o">*</span>
<span class="nf">sid_rb_search</span><span class="p">(</span><span class="k">struct</span> <span class="n">rb_root</span> <span class="o">*</span><span class="n">root</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">cid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rb_node</span> <span class="o">*</span><span class="n">node</span> <span class="o">=</span> <span class="n">root</span><span class="o">-&gt;</span><span class="n">rb_node</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cifs_sid_id</span> <span class="o">*</span><span class="n">lsidid</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">node</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">lsidid</span> <span class="o">=</span> <span class="n">rb_entry</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="k">struct</span> <span class="n">cifs_sid_id</span><span class="p">,</span> <span class="n">rbnode</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cid</span> <span class="o">&gt;</span> <span class="n">lsidid</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">)</span>
			<span class="n">node</span> <span class="o">=</span> <span class="n">node</span><span class="o">-&gt;</span><span class="n">rb_left</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">cid</span> <span class="o">&lt;</span> <span class="n">lsidid</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">)</span>
			<span class="n">node</span> <span class="o">=</span> <span class="n">node</span><span class="o">-&gt;</span><span class="n">rb_right</span><span class="p">;</span>
		<span class="k">else</span> <span class="cm">/* node found */</span>
			<span class="k">return</span> <span class="n">lsidid</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">shrinker</span> <span class="n">cifs_shrinker</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">shrink</span> <span class="o">=</span> <span class="n">cifs_idmap_shrinker</span><span class="p">,</span>
	<span class="p">.</span><span class="n">seeks</span> <span class="o">=</span> <span class="n">DEFAULT_SEEKS</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">cifs_idmap_key_instantiate</span><span class="p">(</span><span class="k">struct</span> <span class="n">key</span> <span class="o">*</span><span class="n">key</span><span class="p">,</span> <span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">datalen</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">payload</span><span class="p">;</span>

	<span class="n">payload</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">datalen</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">payload</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">payload</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">datalen</span><span class="p">);</span>
	<span class="n">key</span><span class="o">-&gt;</span><span class="n">payload</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">payload</span><span class="p">;</span>
	<span class="n">key</span><span class="o">-&gt;</span><span class="n">datalen</span> <span class="o">=</span> <span class="n">datalen</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span>
<span class="nf">cifs_idmap_key_destroy</span><span class="p">(</span><span class="k">struct</span> <span class="n">key</span> <span class="o">*</span><span class="n">key</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">key</span><span class="o">-&gt;</span><span class="n">payload</span><span class="p">.</span><span class="n">data</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">key_type</span> <span class="n">cifs_idmap_key_type</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>        <span class="o">=</span> <span class="s">&quot;cifs.idmap&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">instantiate</span> <span class="o">=</span> <span class="n">cifs_idmap_key_instantiate</span><span class="p">,</span>
	<span class="p">.</span><span class="n">destroy</span>     <span class="o">=</span> <span class="n">cifs_idmap_key_destroy</span><span class="p">,</span>
	<span class="p">.</span><span class="n">describe</span>    <span class="o">=</span> <span class="n">user_describe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">match</span>       <span class="o">=</span> <span class="n">user_match</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">sid_to_str</span><span class="p">(</span><span class="k">struct</span> <span class="n">cifs_sid</span> <span class="o">*</span><span class="n">sidptr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">sidstr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">saval</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">strptr</span><span class="p">;</span>

	<span class="n">strptr</span> <span class="o">=</span> <span class="n">sidstr</span><span class="p">;</span>

	<span class="n">sprintf</span><span class="p">(</span><span class="n">strptr</span><span class="p">,</span> <span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="s">&quot;S&quot;</span><span class="p">);</span>
	<span class="n">strptr</span> <span class="o">=</span> <span class="n">sidstr</span> <span class="o">+</span> <span class="n">strlen</span><span class="p">(</span><span class="n">sidstr</span><span class="p">);</span>

	<span class="n">sprintf</span><span class="p">(</span><span class="n">strptr</span><span class="p">,</span> <span class="s">&quot;-%d&quot;</span><span class="p">,</span> <span class="n">sidptr</span><span class="o">-&gt;</span><span class="n">revision</span><span class="p">);</span>
	<span class="n">strptr</span> <span class="o">=</span> <span class="n">sidstr</span> <span class="o">+</span> <span class="n">strlen</span><span class="p">(</span><span class="n">sidstr</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">6</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sidptr</span><span class="o">-&gt;</span><span class="n">authority</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="p">{</span>
			<span class="n">sprintf</span><span class="p">(</span><span class="n">strptr</span><span class="p">,</span> <span class="s">&quot;-%d&quot;</span><span class="p">,</span> <span class="n">sidptr</span><span class="o">-&gt;</span><span class="n">authority</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
			<span class="n">strptr</span> <span class="o">=</span> <span class="n">sidstr</span> <span class="o">+</span> <span class="n">strlen</span><span class="p">(</span><span class="n">sidstr</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">sidptr</span><span class="o">-&gt;</span><span class="n">num_subauth</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">saval</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">sidptr</span><span class="o">-&gt;</span><span class="n">sub_auth</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="n">sprintf</span><span class="p">(</span><span class="n">strptr</span><span class="p">,</span> <span class="s">&quot;-%ld&quot;</span><span class="p">,</span> <span class="n">saval</span><span class="p">);</span>
		<span class="n">strptr</span> <span class="o">=</span> <span class="n">sidstr</span> <span class="o">+</span> <span class="n">strlen</span><span class="p">(</span><span class="n">sidstr</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">id_rb_insert</span><span class="p">(</span><span class="k">struct</span> <span class="n">rb_root</span> <span class="o">*</span><span class="n">root</span><span class="p">,</span> <span class="k">struct</span> <span class="n">cifs_sid</span> <span class="o">*</span><span class="n">sidptr</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">cifs_sid_id</span> <span class="o">**</span><span class="n">psidid</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">typestr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">strptr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rb_node</span> <span class="o">*</span><span class="n">node</span> <span class="o">=</span> <span class="n">root</span><span class="o">-&gt;</span><span class="n">rb_node</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rb_node</span> <span class="o">*</span><span class="n">parent</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rb_node</span> <span class="o">**</span><span class="n">linkto</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">root</span><span class="o">-&gt;</span><span class="n">rb_node</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">cifs_sid_id</span> <span class="o">*</span><span class="n">lsidid</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">node</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">lsidid</span> <span class="o">=</span> <span class="n">rb_entry</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="k">struct</span> <span class="n">cifs_sid_id</span><span class="p">,</span> <span class="n">rbnode</span><span class="p">);</span>
		<span class="n">parent</span> <span class="o">=</span> <span class="n">node</span><span class="p">;</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">compare_sids</span><span class="p">(</span><span class="n">sidptr</span><span class="p">,</span> <span class="o">&amp;</span><span class="p">((</span><span class="n">lsidid</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">sid</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">linkto</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">node</span><span class="o">-&gt;</span><span class="n">rb_left</span><span class="p">);</span>
			<span class="n">node</span> <span class="o">=</span> <span class="n">node</span><span class="o">-&gt;</span><span class="n">rb_left</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">linkto</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">node</span><span class="o">-&gt;</span><span class="n">rb_right</span><span class="p">);</span>
			<span class="n">node</span> <span class="o">=</span> <span class="n">node</span><span class="o">-&gt;</span><span class="n">rb_right</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="o">*</span><span class="n">psidid</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">sid</span><span class="p">,</span> <span class="n">sidptr</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">cifs_sid</span><span class="p">));</span>
	<span class="p">(</span><span class="o">*</span><span class="n">psidid</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">time</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">-</span> <span class="p">(</span><span class="n">SID_MAP_RETRY</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">(</span><span class="o">*</span><span class="n">psidid</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">refcount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">sprintf</span><span class="p">((</span><span class="o">*</span><span class="n">psidid</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">sidstr</span><span class="p">,</span> <span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">typestr</span><span class="p">);</span>
	<span class="n">strptr</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="n">psidid</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">sidstr</span> <span class="o">+</span> <span class="n">strlen</span><span class="p">((</span><span class="o">*</span><span class="n">psidid</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">sidstr</span><span class="p">);</span>
	<span class="n">sid_to_str</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="o">*</span><span class="n">psidid</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">sid</span><span class="p">,</span> <span class="n">strptr</span><span class="p">);</span>

	<span class="n">clear_bit</span><span class="p">(</span><span class="n">SID_ID_PENDING</span><span class="p">,</span> <span class="o">&amp;</span><span class="p">(</span><span class="o">*</span><span class="n">psidid</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">);</span>
	<span class="n">clear_bit</span><span class="p">(</span><span class="n">SID_ID_MAPPED</span><span class="p">,</span> <span class="o">&amp;</span><span class="p">(</span><span class="o">*</span><span class="n">psidid</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">);</span>

	<span class="n">rb_link_node</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="o">*</span><span class="n">psidid</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">rbnode</span><span class="p">,</span> <span class="n">parent</span><span class="p">,</span> <span class="n">linkto</span><span class="p">);</span>
	<span class="n">rb_insert_color</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="o">*</span><span class="n">psidid</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">rbnode</span><span class="p">,</span> <span class="n">root</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">cifs_sid_id</span> <span class="o">*</span>
<span class="nf">id_rb_search</span><span class="p">(</span><span class="k">struct</span> <span class="n">rb_root</span> <span class="o">*</span><span class="n">root</span><span class="p">,</span> <span class="k">struct</span> <span class="n">cifs_sid</span> <span class="o">*</span><span class="n">sidptr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rb_node</span> <span class="o">*</span><span class="n">node</span> <span class="o">=</span> <span class="n">root</span><span class="o">-&gt;</span><span class="n">rb_node</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cifs_sid_id</span> <span class="o">*</span><span class="n">lsidid</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">node</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">lsidid</span> <span class="o">=</span> <span class="n">rb_entry</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="k">struct</span> <span class="n">cifs_sid_id</span><span class="p">,</span> <span class="n">rbnode</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">compare_sids</span><span class="p">(</span><span class="n">sidptr</span><span class="p">,</span> <span class="o">&amp;</span><span class="p">((</span><span class="n">lsidid</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">sid</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">node</span> <span class="o">=</span> <span class="n">node</span><span class="o">-&gt;</span><span class="n">rb_left</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">node</span> <span class="o">=</span> <span class="n">node</span><span class="o">-&gt;</span><span class="n">rb_right</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="cm">/* node found */</span>
			<span class="k">return</span> <span class="n">lsidid</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">sidid_pending_wait</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">unused</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">schedule</span><span class="p">();</span>
	<span class="k">return</span> <span class="n">signal_pending</span><span class="p">(</span><span class="n">current</span><span class="p">)</span> <span class="o">?</span> <span class="o">-</span><span class="n">ERESTARTSYS</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">id_to_sid</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">cid</span><span class="p">,</span> <span class="n">uint</span> <span class="n">sidtype</span><span class="p">,</span> <span class="k">struct</span> <span class="n">cifs_sid</span> <span class="o">*</span><span class="n">ssid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">key</span> <span class="o">*</span><span class="n">sidkey</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">cred</span> <span class="o">*</span><span class="n">saved_cred</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cifs_sid</span> <span class="o">*</span><span class="n">lsid</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cifs_sid_id</span> <span class="o">*</span><span class="n">psidid</span><span class="p">,</span> <span class="o">*</span><span class="n">npsidid</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rb_root</span> <span class="o">*</span><span class="n">cidtree</span><span class="p">;</span>
	<span class="n">spinlock_t</span> <span class="o">*</span><span class="n">cidlock</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sidtype</span> <span class="o">==</span> <span class="n">SIDOWNER</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cidlock</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">siduidlock</span><span class="p">;</span>
		<span class="n">cidtree</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">uidtree</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">sidtype</span> <span class="o">==</span> <span class="n">SIDGROUP</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cidlock</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sidgidlock</span><span class="p">;</span>
		<span class="n">cidtree</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">gidtree</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="n">cidlock</span><span class="p">);</span>
	<span class="n">psidid</span> <span class="o">=</span> <span class="n">sid_rb_search</span><span class="p">(</span><span class="n">cidtree</span><span class="p">,</span> <span class="n">cid</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">psidid</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* node does not exist, allocate one &amp; attempt adding */</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="n">cidlock</span><span class="p">);</span>
		<span class="n">npsidid</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">cifs_sid_id</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">npsidid</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

		<span class="n">npsidid</span><span class="o">-&gt;</span><span class="n">sidstr</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">SIDLEN</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">npsidid</span><span class="o">-&gt;</span><span class="n">sidstr</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">npsidid</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">spin_lock</span><span class="p">(</span><span class="n">cidlock</span><span class="p">);</span>
		<span class="n">psidid</span> <span class="o">=</span> <span class="n">sid_rb_search</span><span class="p">(</span><span class="n">cidtree</span><span class="p">,</span> <span class="n">cid</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">psidid</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* node happened to get inserted meanwhile */</span>
			<span class="o">++</span><span class="n">psidid</span><span class="o">-&gt;</span><span class="n">refcount</span><span class="p">;</span>
			<span class="n">spin_unlock</span><span class="p">(</span><span class="n">cidlock</span><span class="p">);</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">npsidid</span><span class="o">-&gt;</span><span class="n">sidstr</span><span class="p">);</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">npsidid</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">psidid</span> <span class="o">=</span> <span class="n">npsidid</span><span class="p">;</span>
			<span class="n">sid_rb_insert</span><span class="p">(</span><span class="n">cidtree</span><span class="p">,</span> <span class="n">cid</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">psidid</span><span class="p">,</span>
					<span class="n">sidtype</span> <span class="o">==</span> <span class="n">SIDOWNER</span> <span class="o">?</span> <span class="s">&quot;oi:&quot;</span> <span class="o">:</span> <span class="s">&quot;gi:&quot;</span><span class="p">);</span>
			<span class="o">++</span><span class="n">psidid</span><span class="o">-&gt;</span><span class="n">refcount</span><span class="p">;</span>
			<span class="n">spin_unlock</span><span class="p">(</span><span class="n">cidlock</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="o">++</span><span class="n">psidid</span><span class="o">-&gt;</span><span class="n">refcount</span><span class="p">;</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="n">cidlock</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * If we are here, it is safe to access psidid and its fields</span>
<span class="cm">	 * since a reference was taken earlier while holding the spinlock.</span>
<span class="cm">	 * A reference on the node is put without holding the spinlock</span>
<span class="cm">	 * and it is OK to do so in this case, shrinker will not erase</span>
<span class="cm">	 * this node until all references are put and we do not access</span>
<span class="cm">	 * any fields of the node after a reference is put .</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">SID_ID_MAPPED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">psidid</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">ssid</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">psidid</span><span class="o">-&gt;</span><span class="n">sid</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">cifs_sid</span><span class="p">));</span>
		<span class="n">psidid</span><span class="o">-&gt;</span><span class="n">time</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span> <span class="cm">/* update ts for accessing */</span>
		<span class="k">goto</span> <span class="n">id_sid_out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">time_after</span><span class="p">(</span><span class="n">psidid</span><span class="o">-&gt;</span><span class="n">time</span> <span class="o">+</span> <span class="n">SID_MAP_RETRY</span><span class="p">,</span> <span class="n">jiffies</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">id_sid_out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_and_set_bit</span><span class="p">(</span><span class="n">SID_ID_PENDING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">psidid</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">saved_cred</span> <span class="o">=</span> <span class="n">override_creds</span><span class="p">(</span><span class="n">root_cred</span><span class="p">);</span>
		<span class="n">sidkey</span> <span class="o">=</span> <span class="n">request_key</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cifs_idmap_key_type</span><span class="p">,</span> <span class="n">psidid</span><span class="o">-&gt;</span><span class="n">sidstr</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">sidkey</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="n">cFYI</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;%s: Can&#39;t map and id to a SID&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">lsid</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">cifs_sid</span> <span class="o">*</span><span class="p">)</span><span class="n">sidkey</span><span class="o">-&gt;</span><span class="n">payload</span><span class="p">.</span><span class="n">data</span><span class="p">;</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">psidid</span><span class="o">-&gt;</span><span class="n">sid</span><span class="p">,</span> <span class="n">lsid</span><span class="p">,</span>
				<span class="n">sidkey</span><span class="o">-&gt;</span><span class="n">datalen</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">cifs_sid</span><span class="p">)</span> <span class="o">?</span>
				<span class="n">sidkey</span><span class="o">-&gt;</span><span class="n">datalen</span> <span class="o">:</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">cifs_sid</span><span class="p">));</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">ssid</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">psidid</span><span class="o">-&gt;</span><span class="n">sid</span><span class="p">,</span>
				<span class="n">sidkey</span><span class="o">-&gt;</span><span class="n">datalen</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">cifs_sid</span><span class="p">)</span> <span class="o">?</span>
				<span class="n">sidkey</span><span class="o">-&gt;</span><span class="n">datalen</span> <span class="o">:</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">cifs_sid</span><span class="p">));</span>
			<span class="n">set_bit</span><span class="p">(</span><span class="n">SID_ID_MAPPED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">psidid</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">);</span>
			<span class="n">key_put</span><span class="p">(</span><span class="n">sidkey</span><span class="p">);</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">psidid</span><span class="o">-&gt;</span><span class="n">sidstr</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">psidid</span><span class="o">-&gt;</span><span class="n">time</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span> <span class="cm">/* update ts for accessing */</span>
		<span class="n">revert_creds</span><span class="p">(</span><span class="n">saved_cred</span><span class="p">);</span>
		<span class="n">clear_bit</span><span class="p">(</span><span class="n">SID_ID_PENDING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">psidid</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">);</span>
		<span class="n">wake_up_bit</span><span class="p">(</span><span class="o">&amp;</span><span class="n">psidid</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">,</span> <span class="n">SID_ID_PENDING</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">wait_on_bit</span><span class="p">(</span><span class="o">&amp;</span><span class="n">psidid</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">,</span> <span class="n">SID_ID_PENDING</span><span class="p">,</span>
				<span class="n">sidid_pending_wait</span><span class="p">,</span> <span class="n">TASK_INTERRUPTIBLE</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">cFYI</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;%s: sidid_pending_wait interrupted %d&quot;</span><span class="p">,</span>
					<span class="n">__func__</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
			<span class="o">--</span><span class="n">psidid</span><span class="o">-&gt;</span><span class="n">refcount</span><span class="p">;</span>
			<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">SID_ID_MAPPED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">psidid</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">))</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">ssid</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">psidid</span><span class="o">-&gt;</span><span class="n">sid</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">cifs_sid</span><span class="p">));</span>
		<span class="k">else</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
<span class="nl">id_sid_out:</span>
	<span class="o">--</span><span class="n">psidid</span><span class="o">-&gt;</span><span class="n">refcount</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">sid_to_id</span><span class="p">(</span><span class="k">struct</span> <span class="n">cifs_sb_info</span> <span class="o">*</span><span class="n">cifs_sb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">cifs_sid</span> <span class="o">*</span><span class="n">psid</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">cifs_fattr</span> <span class="o">*</span><span class="n">fattr</span><span class="p">,</span> <span class="n">uint</span> <span class="n">sidtype</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">cid</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">key</span> <span class="o">*</span><span class="n">idkey</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">cred</span> <span class="o">*</span><span class="n">saved_cred</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cifs_sid_id</span> <span class="o">*</span><span class="n">psidid</span><span class="p">,</span> <span class="o">*</span><span class="n">npsidid</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rb_root</span> <span class="o">*</span><span class="n">cidtree</span><span class="p">;</span>
	<span class="n">spinlock_t</span> <span class="o">*</span><span class="n">cidlock</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sidtype</span> <span class="o">==</span> <span class="n">SIDOWNER</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cid</span> <span class="o">=</span> <span class="n">cifs_sb</span><span class="o">-&gt;</span><span class="n">mnt_uid</span><span class="p">;</span> <span class="cm">/* default uid, in case upcall fails */</span>
		<span class="n">cidlock</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">siduidlock</span><span class="p">;</span>
		<span class="n">cidtree</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">uidtree</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">sidtype</span> <span class="o">==</span> <span class="n">SIDGROUP</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cid</span> <span class="o">=</span> <span class="n">cifs_sb</span><span class="o">-&gt;</span><span class="n">mnt_gid</span><span class="p">;</span> <span class="cm">/* default gid, in case upcall fails */</span>
		<span class="n">cidlock</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sidgidlock</span><span class="p">;</span>
		<span class="n">cidtree</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">gidtree</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="n">cidlock</span><span class="p">);</span>
	<span class="n">psidid</span> <span class="o">=</span> <span class="n">id_rb_search</span><span class="p">(</span><span class="n">cidtree</span><span class="p">,</span> <span class="n">psid</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">psidid</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* node does not exist, allocate one &amp; attempt adding */</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="n">cidlock</span><span class="p">);</span>
		<span class="n">npsidid</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">cifs_sid_id</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">npsidid</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

		<span class="n">npsidid</span><span class="o">-&gt;</span><span class="n">sidstr</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">SIDLEN</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">npsidid</span><span class="o">-&gt;</span><span class="n">sidstr</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">npsidid</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">spin_lock</span><span class="p">(</span><span class="n">cidlock</span><span class="p">);</span>
		<span class="n">psidid</span> <span class="o">=</span> <span class="n">id_rb_search</span><span class="p">(</span><span class="n">cidtree</span><span class="p">,</span> <span class="n">psid</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">psidid</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* node happened to get inserted meanwhile */</span>
			<span class="o">++</span><span class="n">psidid</span><span class="o">-&gt;</span><span class="n">refcount</span><span class="p">;</span>
			<span class="n">spin_unlock</span><span class="p">(</span><span class="n">cidlock</span><span class="p">);</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">npsidid</span><span class="o">-&gt;</span><span class="n">sidstr</span><span class="p">);</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">npsidid</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">psidid</span> <span class="o">=</span> <span class="n">npsidid</span><span class="p">;</span>
			<span class="n">id_rb_insert</span><span class="p">(</span><span class="n">cidtree</span><span class="p">,</span> <span class="n">psid</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">psidid</span><span class="p">,</span>
					<span class="n">sidtype</span> <span class="o">==</span> <span class="n">SIDOWNER</span> <span class="o">?</span> <span class="s">&quot;os:&quot;</span> <span class="o">:</span> <span class="s">&quot;gs:&quot;</span><span class="p">);</span>
			<span class="o">++</span><span class="n">psidid</span><span class="o">-&gt;</span><span class="n">refcount</span><span class="p">;</span>
			<span class="n">spin_unlock</span><span class="p">(</span><span class="n">cidlock</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="o">++</span><span class="n">psidid</span><span class="o">-&gt;</span><span class="n">refcount</span><span class="p">;</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="n">cidlock</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * If we are here, it is safe to access psidid and its fields</span>
<span class="cm">	 * since a reference was taken earlier while holding the spinlock.</span>
<span class="cm">	 * A reference on the node is put without holding the spinlock</span>
<span class="cm">	 * and it is OK to do so in this case, shrinker will not erase</span>
<span class="cm">	 * this node until all references are put and we do not access</span>
<span class="cm">	 * any fields of the node after a reference is put .</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">SID_ID_MAPPED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">psidid</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">cid</span> <span class="o">=</span> <span class="n">psidid</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">;</span>
		<span class="n">psidid</span><span class="o">-&gt;</span><span class="n">time</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span> <span class="cm">/* update ts for accessing */</span>
		<span class="k">goto</span> <span class="n">sid_to_id_out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">time_after</span><span class="p">(</span><span class="n">psidid</span><span class="o">-&gt;</span><span class="n">time</span> <span class="o">+</span> <span class="n">SID_MAP_RETRY</span><span class="p">,</span> <span class="n">jiffies</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">sid_to_id_out</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_and_set_bit</span><span class="p">(</span><span class="n">SID_ID_PENDING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">psidid</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">saved_cred</span> <span class="o">=</span> <span class="n">override_creds</span><span class="p">(</span><span class="n">root_cred</span><span class="p">);</span>
		<span class="n">idkey</span> <span class="o">=</span> <span class="n">request_key</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cifs_idmap_key_type</span><span class="p">,</span> <span class="n">psidid</span><span class="o">-&gt;</span><span class="n">sidstr</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">idkey</span><span class="p">))</span>
			<span class="n">cFYI</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;%s: Can&#39;t map SID to an id&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="n">cid</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="p">)</span><span class="n">idkey</span><span class="o">-&gt;</span><span class="n">payload</span><span class="p">.</span><span class="n">value</span><span class="p">;</span>
			<span class="n">psidid</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">=</span> <span class="n">cid</span><span class="p">;</span>
			<span class="n">set_bit</span><span class="p">(</span><span class="n">SID_ID_MAPPED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">psidid</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">);</span>
			<span class="n">key_put</span><span class="p">(</span><span class="n">idkey</span><span class="p">);</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">psidid</span><span class="o">-&gt;</span><span class="n">sidstr</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">revert_creds</span><span class="p">(</span><span class="n">saved_cred</span><span class="p">);</span>
		<span class="n">psidid</span><span class="o">-&gt;</span><span class="n">time</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span> <span class="cm">/* update ts for accessing */</span>
		<span class="n">clear_bit</span><span class="p">(</span><span class="n">SID_ID_PENDING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">psidid</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">);</span>
		<span class="n">wake_up_bit</span><span class="p">(</span><span class="o">&amp;</span><span class="n">psidid</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">,</span> <span class="n">SID_ID_PENDING</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">wait_on_bit</span><span class="p">(</span><span class="o">&amp;</span><span class="n">psidid</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">,</span> <span class="n">SID_ID_PENDING</span><span class="p">,</span>
				<span class="n">sidid_pending_wait</span><span class="p">,</span> <span class="n">TASK_INTERRUPTIBLE</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">cFYI</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;%s: sidid_pending_wait interrupted %d&quot;</span><span class="p">,</span>
					<span class="n">__func__</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
			<span class="o">--</span><span class="n">psidid</span><span class="o">-&gt;</span><span class="n">refcount</span><span class="p">;</span> <span class="cm">/* decremented without spinlock */</span>
			<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">SID_ID_MAPPED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">psidid</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">))</span>
			<span class="n">cid</span> <span class="o">=</span> <span class="n">psidid</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">sid_to_id_out:</span>
	<span class="o">--</span><span class="n">psidid</span><span class="o">-&gt;</span><span class="n">refcount</span><span class="p">;</span> <span class="cm">/* decremented without spinlock */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sidtype</span> <span class="o">==</span> <span class="n">SIDOWNER</span><span class="p">)</span>
		<span class="n">fattr</span><span class="o">-&gt;</span><span class="n">cf_uid</span> <span class="o">=</span> <span class="n">cid</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">fattr</span><span class="o">-&gt;</span><span class="n">cf_gid</span> <span class="o">=</span> <span class="n">cid</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="nf">init_cifs_idmap</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cred</span> <span class="o">*</span><span class="n">cred</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">key</span> <span class="o">*</span><span class="n">keyring</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">cFYI</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;Registering the %s key type</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cifs_idmap_key_type</span><span class="p">.</span><span class="n">name</span><span class="p">);</span>

	<span class="cm">/* create an override credential set with a special thread keyring in</span>
<span class="cm">	 * which requests are cached</span>
<span class="cm">	 *</span>
<span class="cm">	 * this is used to prevent malicious redirections from being installed</span>
<span class="cm">	 * with add_key().</span>
<span class="cm">	 */</span>
	<span class="n">cred</span> <span class="o">=</span> <span class="n">prepare_kernel_cred</span><span class="p">(</span><span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cred</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">keyring</span> <span class="o">=</span> <span class="n">key_alloc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">key_type_keyring</span><span class="p">,</span> <span class="s">&quot;.cifs_idmap&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">cred</span><span class="p">,</span>
			    <span class="p">(</span><span class="n">KEY_POS_ALL</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">KEY_POS_SETATTR</span><span class="p">)</span> <span class="o">|</span>
			    <span class="n">KEY_USR_VIEW</span> <span class="o">|</span> <span class="n">KEY_USR_READ</span><span class="p">,</span>
			    <span class="n">KEY_ALLOC_NOT_IN_QUOTA</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">keyring</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">keyring</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">failed_put_cred</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">key_instantiate_and_link</span><span class="p">(</span><span class="n">keyring</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">failed_put_key</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">register_key_type</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cifs_idmap_key_type</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">failed_put_key</span><span class="p">;</span>

	<span class="cm">/* instruct request_key() to use this special keyring as a cache for</span>
<span class="cm">	 * the results it looks up */</span>
	<span class="n">set_bit</span><span class="p">(</span><span class="n">KEY_FLAG_ROOT_CAN_CLEAR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">keyring</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">cred</span><span class="o">-&gt;</span><span class="n">thread_keyring</span> <span class="o">=</span> <span class="n">keyring</span><span class="p">;</span>
	<span class="n">cred</span><span class="o">-&gt;</span><span class="n">jit_keyring</span> <span class="o">=</span> <span class="n">KEY_REQKEY_DEFL_THREAD_KEYRING</span><span class="p">;</span>
	<span class="n">root_cred</span> <span class="o">=</span> <span class="n">cred</span><span class="p">;</span>

	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">siduidlock</span><span class="p">);</span>
	<span class="n">uidtree</span> <span class="o">=</span> <span class="n">RB_ROOT</span><span class="p">;</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sidgidlock</span><span class="p">);</span>
	<span class="n">gidtree</span> <span class="o">=</span> <span class="n">RB_ROOT</span><span class="p">;</span>

	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">uidsidlock</span><span class="p">);</span>
	<span class="n">siduidtree</span> <span class="o">=</span> <span class="n">RB_ROOT</span><span class="p">;</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gidsidlock</span><span class="p">);</span>
	<span class="n">sidgidtree</span> <span class="o">=</span> <span class="n">RB_ROOT</span><span class="p">;</span>
	<span class="n">register_shrinker</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cifs_shrinker</span><span class="p">);</span>

	<span class="n">cFYI</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;cifs idmap keyring: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">key_serial</span><span class="p">(</span><span class="n">keyring</span><span class="p">));</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">failed_put_key:</span>
	<span class="n">key_put</span><span class="p">(</span><span class="n">keyring</span><span class="p">);</span>
<span class="nl">failed_put_cred:</span>
	<span class="n">put_cred</span><span class="p">(</span><span class="n">cred</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">exit_cifs_idmap</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">key_revoke</span><span class="p">(</span><span class="n">root_cred</span><span class="o">-&gt;</span><span class="n">thread_keyring</span><span class="p">);</span>
	<span class="n">unregister_key_type</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cifs_idmap_key_type</span><span class="p">);</span>
	<span class="n">put_cred</span><span class="p">(</span><span class="n">root_cred</span><span class="p">);</span>
	<span class="n">unregister_shrinker</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cifs_shrinker</span><span class="p">);</span>
	<span class="n">cFYI</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;Unregistered %s key type</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cifs_idmap_key_type</span><span class="p">.</span><span class="n">name</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">cifs_destroy_idmaptrees</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rb_root</span> <span class="o">*</span><span class="n">root</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rb_node</span> <span class="o">*</span><span class="n">node</span><span class="p">;</span>

	<span class="n">root</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">uidtree</span><span class="p">;</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">siduidlock</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">((</span><span class="n">node</span> <span class="o">=</span> <span class="n">rb_first</span><span class="p">(</span><span class="n">root</span><span class="p">)))</span>
		<span class="n">rb_erase</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">root</span><span class="p">);</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">siduidlock</span><span class="p">);</span>

	<span class="n">root</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">gidtree</span><span class="p">;</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sidgidlock</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">((</span><span class="n">node</span> <span class="o">=</span> <span class="n">rb_first</span><span class="p">(</span><span class="n">root</span><span class="p">)))</span>
		<span class="n">rb_erase</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">root</span><span class="p">);</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sidgidlock</span><span class="p">);</span>

	<span class="n">root</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">siduidtree</span><span class="p">;</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">uidsidlock</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">((</span><span class="n">node</span> <span class="o">=</span> <span class="n">rb_first</span><span class="p">(</span><span class="n">root</span><span class="p">)))</span>
		<span class="n">rb_erase</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">root</span><span class="p">);</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">uidsidlock</span><span class="p">);</span>

	<span class="n">root</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sidgidtree</span><span class="p">;</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gidsidlock</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">((</span><span class="n">node</span> <span class="o">=</span> <span class="n">rb_first</span><span class="p">(</span><span class="n">root</span><span class="p">)))</span>
		<span class="n">rb_erase</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">root</span><span class="p">);</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gidsidlock</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* if the two SIDs (roughly equivalent to a UUID for a user or group) are</span>
<span class="cm">   the same returns 1, if they do not match returns 0 */</span>
<span class="kt">int</span> <span class="nf">compare_sids</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">cifs_sid</span> <span class="o">*</span><span class="n">ctsid</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">cifs_sid</span> <span class="o">*</span><span class="n">cwsid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">num_subauth</span><span class="p">,</span> <span class="n">num_sat</span><span class="p">,</span> <span class="n">num_saw</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="o">!</span><span class="n">ctsid</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="o">!</span><span class="n">cwsid</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* compare the revision */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ctsid</span><span class="o">-&gt;</span><span class="n">revision</span> <span class="o">!=</span> <span class="n">cwsid</span><span class="o">-&gt;</span><span class="n">revision</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ctsid</span><span class="o">-&gt;</span><span class="n">revision</span> <span class="o">&gt;</span> <span class="n">cwsid</span><span class="o">-&gt;</span><span class="n">revision</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* compare all of the six auth values */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">6</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ctsid</span><span class="o">-&gt;</span><span class="n">authority</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="n">cwsid</span><span class="o">-&gt;</span><span class="n">authority</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ctsid</span><span class="o">-&gt;</span><span class="n">authority</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">cwsid</span><span class="o">-&gt;</span><span class="n">authority</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
				<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* compare all of the subauth values if any */</span>
	<span class="n">num_sat</span> <span class="o">=</span> <span class="n">ctsid</span><span class="o">-&gt;</span><span class="n">num_subauth</span><span class="p">;</span>
	<span class="n">num_saw</span> <span class="o">=</span> <span class="n">cwsid</span><span class="o">-&gt;</span><span class="n">num_subauth</span><span class="p">;</span>
	<span class="n">num_subauth</span> <span class="o">=</span> <span class="n">num_sat</span> <span class="o">&lt;</span> <span class="n">num_saw</span> <span class="o">?</span> <span class="n">num_sat</span> <span class="o">:</span> <span class="n">num_saw</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">num_subauth</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">num_subauth</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ctsid</span><span class="o">-&gt;</span><span class="n">sub_auth</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="n">cwsid</span><span class="o">-&gt;</span><span class="n">sub_auth</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">ctsid</span><span class="o">-&gt;</span><span class="n">sub_auth</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">&gt;</span>
					<span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">cwsid</span><span class="o">-&gt;</span><span class="n">sub_auth</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
					<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
				<span class="k">else</span>
					<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* sids compare/match */</span>
<span class="p">}</span>


<span class="cm">/* copy ntsd, owner sid, and group sid from a security descriptor to another */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">copy_sec_desc</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">cifs_ntsd</span> <span class="o">*</span><span class="n">pntsd</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">cifs_ntsd</span> <span class="o">*</span><span class="n">pnntsd</span><span class="p">,</span> <span class="n">__u32</span> <span class="n">sidsoffset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">cifs_sid</span> <span class="o">*</span><span class="n">owner_sid_ptr</span><span class="p">,</span> <span class="o">*</span><span class="n">group_sid_ptr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cifs_sid</span> <span class="o">*</span><span class="n">nowner_sid_ptr</span><span class="p">,</span> <span class="o">*</span><span class="n">ngroup_sid_ptr</span><span class="p">;</span>

	<span class="cm">/* copy security descriptor control portion */</span>
	<span class="n">pnntsd</span><span class="o">-&gt;</span><span class="n">revision</span> <span class="o">=</span> <span class="n">pntsd</span><span class="o">-&gt;</span><span class="n">revision</span><span class="p">;</span>
	<span class="n">pnntsd</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">pntsd</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">;</span>
	<span class="n">pnntsd</span><span class="o">-&gt;</span><span class="n">dacloffset</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">cifs_ntsd</span><span class="p">));</span>
	<span class="n">pnntsd</span><span class="o">-&gt;</span><span class="n">sacloffset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pnntsd</span><span class="o">-&gt;</span><span class="n">osidoffset</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">sidsoffset</span><span class="p">);</span>
	<span class="n">pnntsd</span><span class="o">-&gt;</span><span class="n">gsidoffset</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">sidsoffset</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">cifs_sid</span><span class="p">));</span>

	<span class="cm">/* copy owner sid */</span>
	<span class="n">owner_sid_ptr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">cifs_sid</span> <span class="o">*</span><span class="p">)((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">pntsd</span> <span class="o">+</span>
				<span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">pntsd</span><span class="o">-&gt;</span><span class="n">osidoffset</span><span class="p">));</span>
	<span class="n">nowner_sid_ptr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">cifs_sid</span> <span class="o">*</span><span class="p">)((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">pnntsd</span> <span class="o">+</span> <span class="n">sidsoffset</span><span class="p">);</span>

	<span class="n">nowner_sid_ptr</span><span class="o">-&gt;</span><span class="n">revision</span> <span class="o">=</span> <span class="n">owner_sid_ptr</span><span class="o">-&gt;</span><span class="n">revision</span><span class="p">;</span>
	<span class="n">nowner_sid_ptr</span><span class="o">-&gt;</span><span class="n">num_subauth</span> <span class="o">=</span> <span class="n">owner_sid_ptr</span><span class="o">-&gt;</span><span class="n">num_subauth</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">6</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">nowner_sid_ptr</span><span class="o">-&gt;</span><span class="n">authority</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">owner_sid_ptr</span><span class="o">-&gt;</span><span class="n">authority</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">nowner_sid_ptr</span><span class="o">-&gt;</span><span class="n">sub_auth</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">owner_sid_ptr</span><span class="o">-&gt;</span><span class="n">sub_auth</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

	<span class="cm">/* copy group sid */</span>
	<span class="n">group_sid_ptr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">cifs_sid</span> <span class="o">*</span><span class="p">)((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">pntsd</span> <span class="o">+</span>
				<span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">pntsd</span><span class="o">-&gt;</span><span class="n">gsidoffset</span><span class="p">));</span>
	<span class="n">ngroup_sid_ptr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">cifs_sid</span> <span class="o">*</span><span class="p">)((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">pnntsd</span> <span class="o">+</span> <span class="n">sidsoffset</span> <span class="o">+</span>
					<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">cifs_sid</span><span class="p">));</span>

	<span class="n">ngroup_sid_ptr</span><span class="o">-&gt;</span><span class="n">revision</span> <span class="o">=</span> <span class="n">group_sid_ptr</span><span class="o">-&gt;</span><span class="n">revision</span><span class="p">;</span>
	<span class="n">ngroup_sid_ptr</span><span class="o">-&gt;</span><span class="n">num_subauth</span> <span class="o">=</span> <span class="n">group_sid_ptr</span><span class="o">-&gt;</span><span class="n">num_subauth</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">6</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">ngroup_sid_ptr</span><span class="o">-&gt;</span><span class="n">authority</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">group_sid_ptr</span><span class="o">-&gt;</span><span class="n">authority</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">ngroup_sid_ptr</span><span class="o">-&gt;</span><span class="n">sub_auth</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">group_sid_ptr</span><span class="o">-&gt;</span><span class="n">sub_auth</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm">   change posix mode to reflect permissions</span>
<span class="cm">   pmode is the existing mode (we only want to overwrite part of this</span>
<span class="cm">   bits to set can be: S_IRWXU, S_IRWXG or S_IRWXO ie 00700 or 00070 or 00007</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">access_flags_to_mode</span><span class="p">(</span><span class="n">__le32</span> <span class="n">ace_flags</span><span class="p">,</span> <span class="kt">int</span> <span class="n">type</span><span class="p">,</span> <span class="n">umode_t</span> <span class="o">*</span><span class="n">pmode</span><span class="p">,</span>
				 <span class="n">umode_t</span> <span class="o">*</span><span class="n">pbits_to_set</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">__u32</span> <span class="n">flags</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">ace_flags</span><span class="p">);</span>
	<span class="cm">/* the order of ACEs is important.  The canonical order is to begin with</span>
<span class="cm">	   DENY entries followed by ALLOW, otherwise an allow entry could be</span>
<span class="cm">	   encountered first, making the subsequent deny entry like &quot;dead code&quot;</span>
<span class="cm">	   which would be superflous since Windows stops when a match is made</span>
<span class="cm">	   for the operation you are trying to perform for your user */</span>

	<span class="cm">/* For deny ACEs we change the mask so that subsequent allow access</span>
<span class="cm">	   control entries do not turn on the bits we are denying */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="n">ACCESS_DENIED</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">GENERIC_ALL</span><span class="p">)</span>
			<span class="o">*</span><span class="n">pbits_to_set</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">S_IRWXUGO</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">GENERIC_WRITE</span><span class="p">)</span> <span class="o">||</span>
			<span class="p">((</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">FILE_WRITE_RIGHTS</span><span class="p">)</span> <span class="o">==</span> <span class="n">FILE_WRITE_RIGHTS</span><span class="p">))</span>
			<span class="o">*</span><span class="n">pbits_to_set</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">S_IWUGO</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">GENERIC_READ</span><span class="p">)</span> <span class="o">||</span>
			<span class="p">((</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">FILE_READ_RIGHTS</span><span class="p">)</span> <span class="o">==</span> <span class="n">FILE_READ_RIGHTS</span><span class="p">))</span>
			<span class="o">*</span><span class="n">pbits_to_set</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">S_IRUGO</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">GENERIC_EXECUTE</span><span class="p">)</span> <span class="o">||</span>
			<span class="p">((</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">FILE_EXEC_RIGHTS</span><span class="p">)</span> <span class="o">==</span> <span class="n">FILE_EXEC_RIGHTS</span><span class="p">))</span>
			<span class="o">*</span><span class="n">pbits_to_set</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">S_IXUGO</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">!=</span> <span class="n">ACCESS_ALLOWED</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cERROR</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;unknown access control type %d&quot;</span><span class="p">,</span> <span class="n">type</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* else ACCESS_ALLOWED type */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">GENERIC_ALL</span><span class="p">)</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">pmode</span> <span class="o">|=</span> <span class="p">(</span><span class="n">S_IRWXUGO</span> <span class="o">&amp;</span> <span class="p">(</span><span class="o">*</span><span class="n">pbits_to_set</span><span class="p">));</span>
		<span class="n">cFYI</span><span class="p">(</span><span class="n">DBG2</span><span class="p">,</span> <span class="s">&quot;all perms&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">GENERIC_WRITE</span><span class="p">)</span> <span class="o">||</span>
			<span class="p">((</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">FILE_WRITE_RIGHTS</span><span class="p">)</span> <span class="o">==</span> <span class="n">FILE_WRITE_RIGHTS</span><span class="p">))</span>
		<span class="o">*</span><span class="n">pmode</span> <span class="o">|=</span> <span class="p">(</span><span class="n">S_IWUGO</span> <span class="o">&amp;</span> <span class="p">(</span><span class="o">*</span><span class="n">pbits_to_set</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">GENERIC_READ</span><span class="p">)</span> <span class="o">||</span>
			<span class="p">((</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">FILE_READ_RIGHTS</span><span class="p">)</span> <span class="o">==</span> <span class="n">FILE_READ_RIGHTS</span><span class="p">))</span>
		<span class="o">*</span><span class="n">pmode</span> <span class="o">|=</span> <span class="p">(</span><span class="n">S_IRUGO</span> <span class="o">&amp;</span> <span class="p">(</span><span class="o">*</span><span class="n">pbits_to_set</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">GENERIC_EXECUTE</span><span class="p">)</span> <span class="o">||</span>
			<span class="p">((</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">FILE_EXEC_RIGHTS</span><span class="p">)</span> <span class="o">==</span> <span class="n">FILE_EXEC_RIGHTS</span><span class="p">))</span>
		<span class="o">*</span><span class="n">pmode</span> <span class="o">|=</span> <span class="p">(</span><span class="n">S_IXUGO</span> <span class="o">&amp;</span> <span class="p">(</span><span class="o">*</span><span class="n">pbits_to_set</span><span class="p">));</span>

	<span class="n">cFYI</span><span class="p">(</span><span class="n">DBG2</span><span class="p">,</span> <span class="s">&quot;access flags 0x%x mode now 0x%x&quot;</span><span class="p">,</span> <span class="n">flags</span><span class="p">,</span> <span class="o">*</span><span class="n">pmode</span><span class="p">);</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">   Generate access flags to reflect permissions mode is the existing mode.</span>
<span class="cm">   This function is called for every ACE in the DACL whose SID matches</span>
<span class="cm">   with either owner or group or everyone.</span>
<span class="cm">*/</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">mode_to_access_flags</span><span class="p">(</span><span class="n">umode_t</span> <span class="n">mode</span><span class="p">,</span> <span class="n">umode_t</span> <span class="n">bits_to_use</span><span class="p">,</span>
				<span class="n">__u32</span> <span class="o">*</span><span class="n">pace_flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* reset access mask */</span>
	<span class="o">*</span><span class="n">pace_flags</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">;</span>

	<span class="cm">/* bits to use are either S_IRWXU or S_IRWXG or S_IRWXO */</span>
	<span class="n">mode</span> <span class="o">&amp;=</span> <span class="n">bits_to_use</span><span class="p">;</span>

	<span class="cm">/* check for R/W/X UGO since we do not know whose flags</span>
<span class="cm">	   is this but we have cleared all the bits sans RWX for</span>
<span class="cm">	   either user or group or other as per bits_to_use */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mode</span> <span class="o">&amp;</span> <span class="n">S_IRUGO</span><span class="p">)</span>
		<span class="o">*</span><span class="n">pace_flags</span> <span class="o">|=</span> <span class="n">SET_FILE_READ_RIGHTS</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mode</span> <span class="o">&amp;</span> <span class="n">S_IWUGO</span><span class="p">)</span>
		<span class="o">*</span><span class="n">pace_flags</span> <span class="o">|=</span> <span class="n">SET_FILE_WRITE_RIGHTS</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mode</span> <span class="o">&amp;</span> <span class="n">S_IXUGO</span><span class="p">)</span>
		<span class="o">*</span><span class="n">pace_flags</span> <span class="o">|=</span> <span class="n">SET_FILE_EXEC_RIGHTS</span><span class="p">;</span>

	<span class="n">cFYI</span><span class="p">(</span><span class="n">DBG2</span><span class="p">,</span> <span class="s">&quot;mode: 0x%x, access flags now 0x%x&quot;</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="o">*</span><span class="n">pace_flags</span><span class="p">);</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">__u16</span> <span class="nf">fill_ace_for_sid</span><span class="p">(</span><span class="k">struct</span> <span class="n">cifs_ace</span> <span class="o">*</span><span class="n">pntace</span><span class="p">,</span>
			<span class="k">const</span> <span class="k">struct</span> <span class="n">cifs_sid</span> <span class="o">*</span><span class="n">psid</span><span class="p">,</span> <span class="n">__u64</span> <span class="n">nmode</span><span class="p">,</span> <span class="n">umode_t</span> <span class="n">bits</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">__u16</span> <span class="n">size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">__u32</span> <span class="n">access_req</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">pntace</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">ACCESS_ALLOWED</span><span class="p">;</span>
	<span class="n">pntace</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">;</span>
	<span class="n">mode_to_access_flags</span><span class="p">(</span><span class="n">nmode</span><span class="p">,</span> <span class="n">bits</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">access_req</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">access_req</span><span class="p">)</span>
		<span class="n">access_req</span> <span class="o">=</span> <span class="n">SET_MINIMUM_RIGHTS</span><span class="p">;</span>
	<span class="n">pntace</span><span class="o">-&gt;</span><span class="n">access_req</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">access_req</span><span class="p">);</span>

	<span class="n">pntace</span><span class="o">-&gt;</span><span class="n">sid</span><span class="p">.</span><span class="n">revision</span> <span class="o">=</span> <span class="n">psid</span><span class="o">-&gt;</span><span class="n">revision</span><span class="p">;</span>
	<span class="n">pntace</span><span class="o">-&gt;</span><span class="n">sid</span><span class="p">.</span><span class="n">num_subauth</span> <span class="o">=</span> <span class="n">psid</span><span class="o">-&gt;</span><span class="n">num_subauth</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">6</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">pntace</span><span class="o">-&gt;</span><span class="n">sid</span><span class="p">.</span><span class="n">authority</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">psid</span><span class="o">-&gt;</span><span class="n">authority</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">psid</span><span class="o">-&gt;</span><span class="n">num_subauth</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">pntace</span><span class="o">-&gt;</span><span class="n">sid</span><span class="p">.</span><span class="n">sub_auth</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">psid</span><span class="o">-&gt;</span><span class="n">sub_auth</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

	<span class="n">size</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">4</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">+</span> <span class="mi">6</span> <span class="o">+</span> <span class="p">(</span><span class="n">psid</span><span class="o">-&gt;</span><span class="n">num_subauth</span> <span class="o">*</span> <span class="mi">4</span><span class="p">);</span>
	<span class="n">pntace</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">size</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">size</span><span class="p">;</span>
<span class="p">}</span>


<span class="cp">#ifdef CONFIG_CIFS_DEBUG2</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">dump_ace</span><span class="p">(</span><span class="k">struct</span> <span class="n">cifs_ace</span> <span class="o">*</span><span class="n">pace</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">end_of_acl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">num_subauth</span><span class="p">;</span>

	<span class="cm">/* validate that we do not go past end of acl */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">pace</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cERROR</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;ACE too small %d&quot;</span><span class="p">,</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">pace</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">));</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">end_of_acl</span> <span class="o">&lt;</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">pace</span> <span class="o">+</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">pace</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">cERROR</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;ACL too small to parse ACE&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">num_subauth</span> <span class="o">=</span> <span class="n">pace</span><span class="o">-&gt;</span><span class="n">sid</span><span class="p">.</span><span class="n">num_subauth</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">num_subauth</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
		<span class="n">cFYI</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;ACE revision %d num_auth %d type %d flags %d size %d&quot;</span><span class="p">,</span>
			<span class="n">pace</span><span class="o">-&gt;</span><span class="n">sid</span><span class="p">.</span><span class="n">revision</span><span class="p">,</span> <span class="n">pace</span><span class="o">-&gt;</span><span class="n">sid</span><span class="p">.</span><span class="n">num_subauth</span><span class="p">,</span> <span class="n">pace</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">,</span>
			<span class="n">pace</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">,</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">pace</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">));</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">num_subauth</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">cFYI</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;ACE sub_auth[%d]: 0x%x&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span>
				<span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">pace</span><span class="o">-&gt;</span><span class="n">sid</span><span class="p">.</span><span class="n">sub_auth</span><span class="p">[</span><span class="n">i</span><span class="p">]));</span>
		<span class="p">}</span>

		<span class="cm">/* BB add length check to make sure that we do not have huge</span>
<span class="cm">			num auths and therefore go off the end */</span>
	<span class="p">}</span>

	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">parse_dacl</span><span class="p">(</span><span class="k">struct</span> <span class="n">cifs_acl</span> <span class="o">*</span><span class="n">pdacl</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">end_of_acl</span><span class="p">,</span>
		       <span class="k">struct</span> <span class="n">cifs_sid</span> <span class="o">*</span><span class="n">pownersid</span><span class="p">,</span> <span class="k">struct</span> <span class="n">cifs_sid</span> <span class="o">*</span><span class="n">pgrpsid</span><span class="p">,</span>
		       <span class="k">struct</span> <span class="n">cifs_fattr</span> <span class="o">*</span><span class="n">fattr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">num_aces</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">acl_size</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">acl_base</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cifs_ace</span> <span class="o">**</span><span class="n">ppace</span><span class="p">;</span>

	<span class="cm">/* BB need to add parm so we can store the SID BB */</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pdacl</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* no DACL in the security descriptor, set</span>
<span class="cm">		   all the permissions for user/group/other */</span>
		<span class="n">fattr</span><span class="o">-&gt;</span><span class="n">cf_mode</span> <span class="o">|=</span> <span class="n">S_IRWXUGO</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* validate that we do not go past end of acl */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">end_of_acl</span> <span class="o">&lt;</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">pdacl</span> <span class="o">+</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">pdacl</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">cERROR</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;ACL too small to parse DACL&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">cFYI</span><span class="p">(</span><span class="n">DBG2</span><span class="p">,</span> <span class="s">&quot;DACL revision %d size %d num aces %d&quot;</span><span class="p">,</span>
		<span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">pdacl</span><span class="o">-&gt;</span><span class="n">revision</span><span class="p">),</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">pdacl</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">),</span>
		<span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">pdacl</span><span class="o">-&gt;</span><span class="n">num_aces</span><span class="p">));</span>

	<span class="cm">/* reset rwx permissions for user/group/other.</span>
<span class="cm">	   Also, if num_aces is 0 i.e. DACL has no ACEs,</span>
<span class="cm">	   user/group/other have no permissions */</span>
	<span class="n">fattr</span><span class="o">-&gt;</span><span class="n">cf_mode</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">S_IRWXUGO</span><span class="p">);</span>

	<span class="n">acl_base</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">pdacl</span><span class="p">;</span>
	<span class="n">acl_size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">cifs_acl</span><span class="p">);</span>

	<span class="n">num_aces</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">pdacl</span><span class="o">-&gt;</span><span class="n">num_aces</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">num_aces</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">umode_t</span> <span class="n">user_mask</span> <span class="o">=</span> <span class="n">S_IRWXU</span><span class="p">;</span>
		<span class="n">umode_t</span> <span class="n">group_mask</span> <span class="o">=</span> <span class="n">S_IRWXG</span><span class="p">;</span>
		<span class="n">umode_t</span> <span class="n">other_mask</span> <span class="o">=</span> <span class="n">S_IRWXU</span> <span class="o">|</span> <span class="n">S_IRWXG</span> <span class="o">|</span> <span class="n">S_IRWXO</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">num_aces</span> <span class="o">&gt;</span> <span class="n">ULONG_MAX</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">cifs_ace</span> <span class="o">*</span><span class="p">))</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="n">ppace</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">num_aces</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">cifs_ace</span> <span class="o">*</span><span class="p">),</span>
				<span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ppace</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">cERROR</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;DACL memory allocation error&quot;</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">num_aces</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ppace</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">cifs_ace</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">acl_base</span> <span class="o">+</span> <span class="n">acl_size</span><span class="p">);</span>
<span class="cp">#ifdef CONFIG_CIFS_DEBUG2</span>
			<span class="n">dump_ace</span><span class="p">(</span><span class="n">ppace</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">end_of_acl</span><span class="p">);</span>
<span class="cp">#endif</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">compare_sids</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">ppace</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">sid</span><span class="p">),</span> <span class="n">pownersid</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">access_flags_to_mode</span><span class="p">(</span><span class="n">ppace</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">access_req</span><span class="p">,</span>
						     <span class="n">ppace</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">,</span>
						     <span class="o">&amp;</span><span class="n">fattr</span><span class="o">-&gt;</span><span class="n">cf_mode</span><span class="p">,</span>
						     <span class="o">&amp;</span><span class="n">user_mask</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">compare_sids</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">ppace</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">sid</span><span class="p">),</span> <span class="n">pgrpsid</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">access_flags_to_mode</span><span class="p">(</span><span class="n">ppace</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">access_req</span><span class="p">,</span>
						     <span class="n">ppace</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">,</span>
						     <span class="o">&amp;</span><span class="n">fattr</span><span class="o">-&gt;</span><span class="n">cf_mode</span><span class="p">,</span>
						     <span class="o">&amp;</span><span class="n">group_mask</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">compare_sids</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">ppace</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">sid</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">sid_everyone</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">access_flags_to_mode</span><span class="p">(</span><span class="n">ppace</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">access_req</span><span class="p">,</span>
						     <span class="n">ppace</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">,</span>
						     <span class="o">&amp;</span><span class="n">fattr</span><span class="o">-&gt;</span><span class="n">cf_mode</span><span class="p">,</span>
						     <span class="o">&amp;</span><span class="n">other_mask</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">compare_sids</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">ppace</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">sid</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">sid_authusers</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">access_flags_to_mode</span><span class="p">(</span><span class="n">ppace</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">access_req</span><span class="p">,</span>
						     <span class="n">ppace</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">,</span>
						     <span class="o">&amp;</span><span class="n">fattr</span><span class="o">-&gt;</span><span class="n">cf_mode</span><span class="p">,</span>
						     <span class="o">&amp;</span><span class="n">other_mask</span><span class="p">);</span>


<span class="cm">/*			memcpy((void *)(&amp;(cifscred-&gt;aces[i])),</span>
<span class="cm">				(void *)ppace[i],</span>
<span class="cm">				sizeof(struct cifs_ace)); */</span>

			<span class="n">acl_base</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">ppace</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
			<span class="n">acl_size</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">ppace</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">kfree</span><span class="p">(</span><span class="n">ppace</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">set_chmod_dacl</span><span class="p">(</span><span class="k">struct</span> <span class="n">cifs_acl</span> <span class="o">*</span><span class="n">pndacl</span><span class="p">,</span> <span class="k">struct</span> <span class="n">cifs_sid</span> <span class="o">*</span><span class="n">pownersid</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">cifs_sid</span> <span class="o">*</span><span class="n">pgrpsid</span><span class="p">,</span> <span class="n">__u64</span> <span class="n">nmode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cifs_acl</span> <span class="o">*</span><span class="n">pnndacl</span><span class="p">;</span>

	<span class="n">pnndacl</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">cifs_acl</span> <span class="o">*</span><span class="p">)((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">pndacl</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">cifs_acl</span><span class="p">));</span>

	<span class="n">size</span> <span class="o">+=</span> <span class="n">fill_ace_for_sid</span><span class="p">((</span><span class="k">struct</span> <span class="n">cifs_ace</span> <span class="o">*</span><span class="p">)</span> <span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">pnndacl</span> <span class="o">+</span> <span class="n">size</span><span class="p">),</span>
					<span class="n">pownersid</span><span class="p">,</span> <span class="n">nmode</span><span class="p">,</span> <span class="n">S_IRWXU</span><span class="p">);</span>
	<span class="n">size</span> <span class="o">+=</span> <span class="n">fill_ace_for_sid</span><span class="p">((</span><span class="k">struct</span> <span class="n">cifs_ace</span> <span class="o">*</span><span class="p">)((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">pnndacl</span> <span class="o">+</span> <span class="n">size</span><span class="p">),</span>
					<span class="n">pgrpsid</span><span class="p">,</span> <span class="n">nmode</span><span class="p">,</span> <span class="n">S_IRWXG</span><span class="p">);</span>
	<span class="n">size</span> <span class="o">+=</span> <span class="n">fill_ace_for_sid</span><span class="p">((</span><span class="k">struct</span> <span class="n">cifs_ace</span> <span class="o">*</span><span class="p">)((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">pnndacl</span> <span class="o">+</span> <span class="n">size</span><span class="p">),</span>
					 <span class="o">&amp;</span><span class="n">sid_everyone</span><span class="p">,</span> <span class="n">nmode</span><span class="p">,</span> <span class="n">S_IRWXO</span><span class="p">);</span>

	<span class="n">pndacl</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">size</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">cifs_acl</span><span class="p">));</span>
	<span class="n">pndacl</span><span class="o">-&gt;</span><span class="n">num_aces</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="mi">3</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">parse_sid</span><span class="p">(</span><span class="k">struct</span> <span class="n">cifs_sid</span> <span class="o">*</span><span class="n">psid</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">end_of_acl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* BB need to add parm so we can store the SID BB */</span>

	<span class="cm">/* validate that we do not go past end of ACL - sid must be at least 8</span>
<span class="cm">	   bytes long (assuming no sub-auths - e.g. the null SID */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">end_of_acl</span> <span class="o">&lt;</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">psid</span> <span class="o">+</span> <span class="mi">8</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cERROR</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;ACL too small to parse SID %p&quot;</span><span class="p">,</span> <span class="n">psid</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">psid</span><span class="o">-&gt;</span><span class="n">num_subauth</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#ifdef CONFIG_CIFS_DEBUG2</span>
		<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
		<span class="n">cFYI</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;SID revision %d num_auth %d&quot;</span><span class="p">,</span>
			<span class="n">psid</span><span class="o">-&gt;</span><span class="n">revision</span><span class="p">,</span> <span class="n">psid</span><span class="o">-&gt;</span><span class="n">num_subauth</span><span class="p">);</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">psid</span><span class="o">-&gt;</span><span class="n">num_subauth</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">cFYI</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;SID sub_auth[%d]: 0x%x &quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span>
				<span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">psid</span><span class="o">-&gt;</span><span class="n">sub_auth</span><span class="p">[</span><span class="n">i</span><span class="p">]));</span>
		<span class="p">}</span>

		<span class="cm">/* BB add length check to make sure that we do not have huge</span>
<span class="cm">			num auths and therefore go off the end */</span>
		<span class="n">cFYI</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;RID 0x%x&quot;</span><span class="p">,</span>
			<span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">psid</span><span class="o">-&gt;</span><span class="n">sub_auth</span><span class="p">[</span><span class="n">psid</span><span class="o">-&gt;</span><span class="n">num_subauth</span><span class="o">-</span><span class="mi">1</span><span class="p">]));</span>
<span class="cp">#endif</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/* Convert CIFS ACL to POSIX form */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">parse_sec_desc</span><span class="p">(</span><span class="k">struct</span> <span class="n">cifs_sb_info</span> <span class="o">*</span><span class="n">cifs_sb</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">cifs_ntsd</span> <span class="o">*</span><span class="n">pntsd</span><span class="p">,</span> <span class="kt">int</span> <span class="n">acl_len</span><span class="p">,</span> <span class="k">struct</span> <span class="n">cifs_fattr</span> <span class="o">*</span><span class="n">fattr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cifs_sid</span> <span class="o">*</span><span class="n">owner_sid_ptr</span><span class="p">,</span> <span class="o">*</span><span class="n">group_sid_ptr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cifs_acl</span> <span class="o">*</span><span class="n">dacl_ptr</span><span class="p">;</span> <span class="cm">/* no need for SACL ptr */</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">end_of_acl</span> <span class="o">=</span> <span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">pntsd</span><span class="p">)</span> <span class="o">+</span> <span class="n">acl_len</span><span class="p">;</span>
	<span class="n">__u32</span> <span class="n">dacloffset</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pntsd</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="n">owner_sid_ptr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">cifs_sid</span> <span class="o">*</span><span class="p">)((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">pntsd</span> <span class="o">+</span>
				<span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">pntsd</span><span class="o">-&gt;</span><span class="n">osidoffset</span><span class="p">));</span>
	<span class="n">group_sid_ptr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">cifs_sid</span> <span class="o">*</span><span class="p">)((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">pntsd</span> <span class="o">+</span>
				<span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">pntsd</span><span class="o">-&gt;</span><span class="n">gsidoffset</span><span class="p">));</span>
	<span class="n">dacloffset</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">pntsd</span><span class="o">-&gt;</span><span class="n">dacloffset</span><span class="p">);</span>
	<span class="n">dacl_ptr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">cifs_acl</span> <span class="o">*</span><span class="p">)((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">pntsd</span> <span class="o">+</span> <span class="n">dacloffset</span><span class="p">);</span>
	<span class="n">cFYI</span><span class="p">(</span><span class="n">DBG2</span><span class="p">,</span> <span class="s">&quot;revision %d type 0x%x ooffset 0x%x goffset 0x%x &quot;</span>
		 <span class="s">&quot;sacloffset 0x%x dacloffset 0x%x&quot;</span><span class="p">,</span>
		 <span class="n">pntsd</span><span class="o">-&gt;</span><span class="n">revision</span><span class="p">,</span> <span class="n">pntsd</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">,</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">pntsd</span><span class="o">-&gt;</span><span class="n">osidoffset</span><span class="p">),</span>
		 <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">pntsd</span><span class="o">-&gt;</span><span class="n">gsidoffset</span><span class="p">),</span>
		 <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">pntsd</span><span class="o">-&gt;</span><span class="n">sacloffset</span><span class="p">),</span> <span class="n">dacloffset</span><span class="p">);</span>
<span class="cm">/*	cifs_dump_mem(&quot;owner_sid: &quot;, owner_sid_ptr, 64); */</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">parse_sid</span><span class="p">(</span><span class="n">owner_sid_ptr</span><span class="p">,</span> <span class="n">end_of_acl</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cFYI</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;%s: Error %d parsing Owner SID&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">sid_to_id</span><span class="p">(</span><span class="n">cifs_sb</span><span class="p">,</span> <span class="n">owner_sid_ptr</span><span class="p">,</span> <span class="n">fattr</span><span class="p">,</span> <span class="n">SIDOWNER</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cFYI</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;%s: Error %d mapping Owner SID to uid&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">parse_sid</span><span class="p">(</span><span class="n">group_sid_ptr</span><span class="p">,</span> <span class="n">end_of_acl</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cFYI</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;%s: Error %d mapping Owner SID to gid&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">sid_to_id</span><span class="p">(</span><span class="n">cifs_sb</span><span class="p">,</span> <span class="n">group_sid_ptr</span><span class="p">,</span> <span class="n">fattr</span><span class="p">,</span> <span class="n">SIDGROUP</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cFYI</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;%s: Error %d mapping Group SID to gid&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dacloffset</span><span class="p">)</span>
		<span class="n">parse_dacl</span><span class="p">(</span><span class="n">dacl_ptr</span><span class="p">,</span> <span class="n">end_of_acl</span><span class="p">,</span> <span class="n">owner_sid_ptr</span><span class="p">,</span>
			   <span class="n">group_sid_ptr</span><span class="p">,</span> <span class="n">fattr</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">cFYI</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;no ACL&quot;</span><span class="p">);</span> <span class="cm">/* BB grant all or default perms? */</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Convert permission bits from mode to equivalent CIFS ACL */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">build_sec_desc</span><span class="p">(</span><span class="k">struct</span> <span class="n">cifs_ntsd</span> <span class="o">*</span><span class="n">pntsd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">cifs_ntsd</span> <span class="o">*</span><span class="n">pnntsd</span><span class="p">,</span>
	<span class="n">__u32</span> <span class="n">secdesclen</span><span class="p">,</span> <span class="n">__u64</span> <span class="n">nmode</span><span class="p">,</span> <span class="n">uid_t</span> <span class="n">uid</span><span class="p">,</span> <span class="n">gid_t</span> <span class="n">gid</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">aclflag</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">__u32</span> <span class="n">dacloffset</span><span class="p">;</span>
	<span class="n">__u32</span> <span class="n">ndacloffset</span><span class="p">;</span>
	<span class="n">__u32</span> <span class="n">sidsoffset</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cifs_sid</span> <span class="o">*</span><span class="n">owner_sid_ptr</span><span class="p">,</span> <span class="o">*</span><span class="n">group_sid_ptr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cifs_sid</span> <span class="o">*</span><span class="n">nowner_sid_ptr</span><span class="p">,</span> <span class="o">*</span><span class="n">ngroup_sid_ptr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cifs_acl</span> <span class="o">*</span><span class="n">dacl_ptr</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>  <span class="cm">/* no need for SACL ptr */</span>
	<span class="k">struct</span> <span class="n">cifs_acl</span> <span class="o">*</span><span class="n">ndacl_ptr</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span> <span class="cm">/* no need for SACL ptr */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nmode</span> <span class="o">!=</span> <span class="n">NO_CHANGE_64</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* chmod */</span>
		<span class="n">owner_sid_ptr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">cifs_sid</span> <span class="o">*</span><span class="p">)((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">pntsd</span> <span class="o">+</span>
				<span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">pntsd</span><span class="o">-&gt;</span><span class="n">osidoffset</span><span class="p">));</span>
		<span class="n">group_sid_ptr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">cifs_sid</span> <span class="o">*</span><span class="p">)((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">pntsd</span> <span class="o">+</span>
				<span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">pntsd</span><span class="o">-&gt;</span><span class="n">gsidoffset</span><span class="p">));</span>
		<span class="n">dacloffset</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">pntsd</span><span class="o">-&gt;</span><span class="n">dacloffset</span><span class="p">);</span>
		<span class="n">dacl_ptr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">cifs_acl</span> <span class="o">*</span><span class="p">)((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">pntsd</span> <span class="o">+</span> <span class="n">dacloffset</span><span class="p">);</span>
		<span class="n">ndacloffset</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">cifs_ntsd</span><span class="p">);</span>
		<span class="n">ndacl_ptr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">cifs_acl</span> <span class="o">*</span><span class="p">)((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">pnntsd</span> <span class="o">+</span> <span class="n">ndacloffset</span><span class="p">);</span>
		<span class="n">ndacl_ptr</span><span class="o">-&gt;</span><span class="n">revision</span> <span class="o">=</span> <span class="n">dacl_ptr</span><span class="o">-&gt;</span><span class="n">revision</span><span class="p">;</span>
		<span class="n">ndacl_ptr</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">ndacl_ptr</span><span class="o">-&gt;</span><span class="n">num_aces</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">rc</span> <span class="o">=</span> <span class="n">set_chmod_dacl</span><span class="p">(</span><span class="n">ndacl_ptr</span><span class="p">,</span> <span class="n">owner_sid_ptr</span><span class="p">,</span> <span class="n">group_sid_ptr</span><span class="p">,</span>
					<span class="n">nmode</span><span class="p">);</span>
		<span class="n">sidsoffset</span> <span class="o">=</span> <span class="n">ndacloffset</span> <span class="o">+</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">ndacl_ptr</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">);</span>
		<span class="cm">/* copy sec desc control portion &amp; owner and group sids */</span>
		<span class="n">copy_sec_desc</span><span class="p">(</span><span class="n">pntsd</span><span class="p">,</span> <span class="n">pnntsd</span><span class="p">,</span> <span class="n">sidsoffset</span><span class="p">);</span>
		<span class="o">*</span><span class="n">aclflag</span> <span class="o">=</span> <span class="n">CIFS_ACL_DACL</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">pnntsd</span><span class="p">,</span> <span class="n">pntsd</span><span class="p">,</span> <span class="n">secdesclen</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">uid</span> <span class="o">!=</span> <span class="n">NO_CHANGE_32</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* chown */</span>
			<span class="n">owner_sid_ptr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">cifs_sid</span> <span class="o">*</span><span class="p">)((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">pnntsd</span> <span class="o">+</span>
					<span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">pnntsd</span><span class="o">-&gt;</span><span class="n">osidoffset</span><span class="p">));</span>
			<span class="n">nowner_sid_ptr</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">cifs_sid</span><span class="p">),</span>
								<span class="n">GFP_KERNEL</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">nowner_sid_ptr</span><span class="p">)</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="n">id_to_sid</span><span class="p">(</span><span class="n">uid</span><span class="p">,</span> <span class="n">SIDOWNER</span><span class="p">,</span> <span class="n">nowner_sid_ptr</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">cFYI</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;%s: Mapping error %d for owner id %d&quot;</span><span class="p">,</span>
						<span class="n">__func__</span><span class="p">,</span> <span class="n">rc</span><span class="p">,</span> <span class="n">uid</span><span class="p">);</span>
				<span class="n">kfree</span><span class="p">(</span><span class="n">nowner_sid_ptr</span><span class="p">);</span>
				<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">owner_sid_ptr</span><span class="p">,</span> <span class="n">nowner_sid_ptr</span><span class="p">,</span>
					<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">cifs_sid</span><span class="p">));</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">nowner_sid_ptr</span><span class="p">);</span>
			<span class="o">*</span><span class="n">aclflag</span> <span class="o">=</span> <span class="n">CIFS_ACL_OWNER</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">gid</span> <span class="o">!=</span> <span class="n">NO_CHANGE_32</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* chgrp */</span>
			<span class="n">group_sid_ptr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">cifs_sid</span> <span class="o">*</span><span class="p">)((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">pnntsd</span> <span class="o">+</span>
					<span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">pnntsd</span><span class="o">-&gt;</span><span class="n">gsidoffset</span><span class="p">));</span>
			<span class="n">ngroup_sid_ptr</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">cifs_sid</span><span class="p">),</span>
								<span class="n">GFP_KERNEL</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ngroup_sid_ptr</span><span class="p">)</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="n">id_to_sid</span><span class="p">(</span><span class="n">gid</span><span class="p">,</span> <span class="n">SIDGROUP</span><span class="p">,</span> <span class="n">ngroup_sid_ptr</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">cFYI</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;%s: Mapping error %d for group id %d&quot;</span><span class="p">,</span>
						<span class="n">__func__</span><span class="p">,</span> <span class="n">rc</span><span class="p">,</span> <span class="n">gid</span><span class="p">);</span>
				<span class="n">kfree</span><span class="p">(</span><span class="n">ngroup_sid_ptr</span><span class="p">);</span>
				<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">group_sid_ptr</span><span class="p">,</span> <span class="n">ngroup_sid_ptr</span><span class="p">,</span>
					<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">cifs_sid</span><span class="p">));</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">ngroup_sid_ptr</span><span class="p">);</span>
			<span class="o">*</span><span class="n">aclflag</span> <span class="o">=</span> <span class="n">CIFS_ACL_GROUP</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">cifs_ntsd</span> <span class="o">*</span><span class="nf">get_cifs_acl_by_fid</span><span class="p">(</span><span class="k">struct</span> <span class="n">cifs_sb_info</span> <span class="o">*</span><span class="n">cifs_sb</span><span class="p">,</span>
		<span class="n">__u16</span> <span class="n">fid</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">pacllen</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cifs_ntsd</span> <span class="o">*</span><span class="n">pntsd</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">xid</span><span class="p">,</span> <span class="n">rc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tcon_link</span> <span class="o">*</span><span class="n">tlink</span> <span class="o">=</span> <span class="n">cifs_sb_tlink</span><span class="p">(</span><span class="n">cifs_sb</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">tlink</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">ERR_CAST</span><span class="p">(</span><span class="n">tlink</span><span class="p">);</span>

	<span class="n">xid</span> <span class="o">=</span> <span class="n">GetXid</span><span class="p">();</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">CIFSSMBGetCIFSACL</span><span class="p">(</span><span class="n">xid</span><span class="p">,</span> <span class="n">tlink_tcon</span><span class="p">(</span><span class="n">tlink</span><span class="p">),</span> <span class="n">fid</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pntsd</span><span class="p">,</span> <span class="n">pacllen</span><span class="p">);</span>
	<span class="n">FreeXid</span><span class="p">(</span><span class="n">xid</span><span class="p">);</span>

	<span class="n">cifs_put_tlink</span><span class="p">(</span><span class="n">tlink</span><span class="p">);</span>

	<span class="n">cFYI</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;%s: rc = %d ACL len %d&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">rc</span><span class="p">,</span> <span class="o">*</span><span class="n">pacllen</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="n">rc</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">pntsd</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">cifs_ntsd</span> <span class="o">*</span><span class="nf">get_cifs_acl_by_path</span><span class="p">(</span><span class="k">struct</span> <span class="n">cifs_sb_info</span> <span class="o">*</span><span class="n">cifs_sb</span><span class="p">,</span>
		<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">path</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">pacllen</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cifs_ntsd</span> <span class="o">*</span><span class="n">pntsd</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">oplock</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">xid</span><span class="p">,</span> <span class="n">rc</span><span class="p">,</span> <span class="n">create_options</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">__u16</span> <span class="n">fid</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cifs_tcon</span> <span class="o">*</span><span class="n">tcon</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tcon_link</span> <span class="o">*</span><span class="n">tlink</span> <span class="o">=</span> <span class="n">cifs_sb_tlink</span><span class="p">(</span><span class="n">cifs_sb</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">tlink</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">ERR_CAST</span><span class="p">(</span><span class="n">tlink</span><span class="p">);</span>

	<span class="n">tcon</span> <span class="o">=</span> <span class="n">tlink_tcon</span><span class="p">(</span><span class="n">tlink</span><span class="p">);</span>
	<span class="n">xid</span> <span class="o">=</span> <span class="n">GetXid</span><span class="p">();</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">backup_cred</span><span class="p">(</span><span class="n">cifs_sb</span><span class="p">))</span>
		<span class="n">create_options</span> <span class="o">|=</span> <span class="n">CREATE_OPEN_BACKUP_INTENT</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">CIFSSMBOpen</span><span class="p">(</span><span class="n">xid</span><span class="p">,</span> <span class="n">tcon</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">FILE_OPEN</span><span class="p">,</span> <span class="n">READ_CONTROL</span><span class="p">,</span>
			<span class="n">create_options</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fid</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">oplock</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">cifs_sb</span><span class="o">-&gt;</span><span class="n">local_nls</span><span class="p">,</span>
			<span class="n">cifs_sb</span><span class="o">-&gt;</span><span class="n">mnt_cifs_flags</span> <span class="o">&amp;</span> <span class="n">CIFS_MOUNT_MAP_SPECIAL_CHR</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">CIFSSMBGetCIFSACL</span><span class="p">(</span><span class="n">xid</span><span class="p">,</span> <span class="n">tcon</span><span class="p">,</span> <span class="n">fid</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pntsd</span><span class="p">,</span> <span class="n">pacllen</span><span class="p">);</span>
		<span class="n">CIFSSMBClose</span><span class="p">(</span><span class="n">xid</span><span class="p">,</span> <span class="n">tcon</span><span class="p">,</span> <span class="n">fid</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">cifs_put_tlink</span><span class="p">(</span><span class="n">tlink</span><span class="p">);</span>
	<span class="n">FreeXid</span><span class="p">(</span><span class="n">xid</span><span class="p">);</span>

	<span class="n">cFYI</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;%s: rc = %d ACL len %d&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">rc</span><span class="p">,</span> <span class="o">*</span><span class="n">pacllen</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="n">rc</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">pntsd</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Retrieve an ACL from the server */</span>
<span class="k">struct</span> <span class="n">cifs_ntsd</span> <span class="o">*</span><span class="nf">get_cifs_acl</span><span class="p">(</span><span class="k">struct</span> <span class="n">cifs_sb_info</span> <span class="o">*</span><span class="n">cifs_sb</span><span class="p">,</span>
				      <span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">path</span><span class="p">,</span>
				      <span class="n">u32</span> <span class="o">*</span><span class="n">pacllen</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cifs_ntsd</span> <span class="o">*</span><span class="n">pntsd</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cifsFileInfo</span> <span class="o">*</span><span class="n">open_file</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">inode</span><span class="p">)</span>
		<span class="n">open_file</span> <span class="o">=</span> <span class="n">find_readable_file</span><span class="p">(</span><span class="n">CIFS_I</span><span class="p">(</span><span class="n">inode</span><span class="p">),</span> <span class="nb">true</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">open_file</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">get_cifs_acl_by_path</span><span class="p">(</span><span class="n">cifs_sb</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">pacllen</span><span class="p">);</span>

	<span class="n">pntsd</span> <span class="o">=</span> <span class="n">get_cifs_acl_by_fid</span><span class="p">(</span><span class="n">cifs_sb</span><span class="p">,</span> <span class="n">open_file</span><span class="o">-&gt;</span><span class="n">netfid</span><span class="p">,</span> <span class="n">pacllen</span><span class="p">);</span>
	<span class="n">cifsFileInfo_put</span><span class="p">(</span><span class="n">open_file</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">pntsd</span><span class="p">;</span>
<span class="p">}</span>

 <span class="cm">/* Set an ACL on the server */</span>
<span class="kt">int</span> <span class="nf">set_cifs_acl</span><span class="p">(</span><span class="k">struct</span> <span class="n">cifs_ntsd</span> <span class="o">*</span><span class="n">pnntsd</span><span class="p">,</span> <span class="n">__u32</span> <span class="n">acllen</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">path</span><span class="p">,</span> <span class="kt">int</span> <span class="n">aclflag</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">oplock</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">xid</span><span class="p">,</span> <span class="n">rc</span><span class="p">,</span> <span class="n">access_flags</span><span class="p">,</span> <span class="n">create_options</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">__u16</span> <span class="n">fid</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cifs_tcon</span> <span class="o">*</span><span class="n">tcon</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cifs_sb_info</span> <span class="o">*</span><span class="n">cifs_sb</span> <span class="o">=</span> <span class="n">CIFS_SB</span><span class="p">(</span><span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_sb</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">tcon_link</span> <span class="o">*</span><span class="n">tlink</span> <span class="o">=</span> <span class="n">cifs_sb_tlink</span><span class="p">(</span><span class="n">cifs_sb</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">tlink</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">tlink</span><span class="p">);</span>

	<span class="n">tcon</span> <span class="o">=</span> <span class="n">tlink_tcon</span><span class="p">(</span><span class="n">tlink</span><span class="p">);</span>
	<span class="n">xid</span> <span class="o">=</span> <span class="n">GetXid</span><span class="p">();</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">backup_cred</span><span class="p">(</span><span class="n">cifs_sb</span><span class="p">))</span>
		<span class="n">create_options</span> <span class="o">|=</span> <span class="n">CREATE_OPEN_BACKUP_INTENT</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">aclflag</span> <span class="o">==</span> <span class="n">CIFS_ACL_OWNER</span> <span class="o">||</span> <span class="n">aclflag</span> <span class="o">==</span> <span class="n">CIFS_ACL_GROUP</span><span class="p">)</span>
		<span class="n">access_flags</span> <span class="o">=</span> <span class="n">WRITE_OWNER</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">access_flags</span> <span class="o">=</span> <span class="n">WRITE_DAC</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">CIFSSMBOpen</span><span class="p">(</span><span class="n">xid</span><span class="p">,</span> <span class="n">tcon</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">FILE_OPEN</span><span class="p">,</span> <span class="n">access_flags</span><span class="p">,</span>
			<span class="n">create_options</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fid</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">oplock</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">cifs_sb</span><span class="o">-&gt;</span><span class="n">local_nls</span><span class="p">,</span>
			<span class="n">cifs_sb</span><span class="o">-&gt;</span><span class="n">mnt_cifs_flags</span> <span class="o">&amp;</span> <span class="n">CIFS_MOUNT_MAP_SPECIAL_CHR</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cERROR</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;Unable to open file to set ACL&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">CIFSSMBSetCIFSACL</span><span class="p">(</span><span class="n">xid</span><span class="p">,</span> <span class="n">tcon</span><span class="p">,</span> <span class="n">fid</span><span class="p">,</span> <span class="n">pnntsd</span><span class="p">,</span> <span class="n">acllen</span><span class="p">,</span> <span class="n">aclflag</span><span class="p">);</span>
	<span class="n">cFYI</span><span class="p">(</span><span class="n">DBG2</span><span class="p">,</span> <span class="s">&quot;SetCIFSACL rc = %d&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>

	<span class="n">CIFSSMBClose</span><span class="p">(</span><span class="n">xid</span><span class="p">,</span> <span class="n">tcon</span><span class="p">,</span> <span class="n">fid</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="n">FreeXid</span><span class="p">(</span><span class="n">xid</span><span class="p">);</span>
	<span class="n">cifs_put_tlink</span><span class="p">(</span><span class="n">tlink</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Translate the CIFS ACL (simlar to NTFS ACL) for a file into mode bits */</span>
<span class="kt">int</span>
<span class="nf">cifs_acl_to_fattr</span><span class="p">(</span><span class="k">struct</span> <span class="n">cifs_sb_info</span> <span class="o">*</span><span class="n">cifs_sb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">cifs_fattr</span> <span class="o">*</span><span class="n">fattr</span><span class="p">,</span>
		  <span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">path</span><span class="p">,</span> <span class="k">const</span> <span class="n">__u16</span> <span class="o">*</span><span class="n">pfid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cifs_ntsd</span> <span class="o">*</span><span class="n">pntsd</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">acllen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">cFYI</span><span class="p">(</span><span class="n">DBG2</span><span class="p">,</span> <span class="s">&quot;converting ACL to mode for %s&quot;</span><span class="p">,</span> <span class="n">path</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pfid</span><span class="p">)</span>
		<span class="n">pntsd</span> <span class="o">=</span> <span class="n">get_cifs_acl_by_fid</span><span class="p">(</span><span class="n">cifs_sb</span><span class="p">,</span> <span class="o">*</span><span class="n">pfid</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">acllen</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">pntsd</span> <span class="o">=</span> <span class="n">get_cifs_acl</span><span class="p">(</span><span class="n">cifs_sb</span><span class="p">,</span> <span class="n">inode</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">acllen</span><span class="p">);</span>

	<span class="cm">/* if we can retrieve the ACL, now parse Access Control Entries, ACEs */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">pntsd</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">pntsd</span><span class="p">);</span>
		<span class="n">cERROR</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;%s: error %d getting sec desc&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">parse_sec_desc</span><span class="p">(</span><span class="n">cifs_sb</span><span class="p">,</span> <span class="n">pntsd</span><span class="p">,</span> <span class="n">acllen</span><span class="p">,</span> <span class="n">fattr</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">pntsd</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
			<span class="n">cERROR</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;parse sec desc failed rc = %d&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Convert mode bits to an ACL so we can update the ACL on the server */</span>
<span class="kt">int</span>
<span class="nf">id_mode_to_cifs_acl</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">path</span><span class="p">,</span> <span class="n">__u64</span> <span class="n">nmode</span><span class="p">,</span>
			<span class="n">uid_t</span> <span class="n">uid</span><span class="p">,</span> <span class="n">gid_t</span> <span class="n">gid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">aclflag</span> <span class="o">=</span> <span class="n">CIFS_ACL_DACL</span><span class="p">;</span> <span class="cm">/* default flag to set */</span>
	<span class="n">__u32</span> <span class="n">secdesclen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cifs_ntsd</span> <span class="o">*</span><span class="n">pntsd</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span> <span class="cm">/* acl obtained from server */</span>
	<span class="k">struct</span> <span class="n">cifs_ntsd</span> <span class="o">*</span><span class="n">pnntsd</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span> <span class="cm">/* modified acl to be sent to server */</span>

	<span class="n">cFYI</span><span class="p">(</span><span class="n">DBG2</span><span class="p">,</span> <span class="s">&quot;set ACL from mode for %s&quot;</span><span class="p">,</span> <span class="n">path</span><span class="p">);</span>

	<span class="cm">/* Get the security descriptor */</span>
	<span class="n">pntsd</span> <span class="o">=</span> <span class="n">get_cifs_acl</span><span class="p">(</span><span class="n">CIFS_SB</span><span class="p">(</span><span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_sb</span><span class="p">),</span> <span class="n">inode</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">secdesclen</span><span class="p">);</span>

	<span class="cm">/* Add three ACEs for owner, group, everyone getting rid of</span>
<span class="cm">	   other ACEs as chmod disables ACEs and set the security descriptor */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">pntsd</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">pntsd</span><span class="p">);</span>
		<span class="n">cERROR</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;%s: error %d getting sec desc&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* allocate memory for the smb header,</span>
<span class="cm">		   set security descriptor request security descriptor</span>
<span class="cm">		   parameters, and secuirty descriptor itself */</span>

		<span class="n">secdesclen</span> <span class="o">=</span> <span class="n">secdesclen</span> <span class="o">&lt;</span> <span class="n">DEFSECDESCLEN</span> <span class="o">?</span>
					<span class="n">DEFSECDESCLEN</span> <span class="o">:</span> <span class="n">secdesclen</span><span class="p">;</span>
		<span class="n">pnntsd</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">secdesclen</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pnntsd</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">cERROR</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;Unable to allocate security descriptor&quot;</span><span class="p">);</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">pntsd</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">rc</span> <span class="o">=</span> <span class="n">build_sec_desc</span><span class="p">(</span><span class="n">pntsd</span><span class="p">,</span> <span class="n">pnntsd</span><span class="p">,</span> <span class="n">secdesclen</span><span class="p">,</span> <span class="n">nmode</span><span class="p">,</span> <span class="n">uid</span><span class="p">,</span> <span class="n">gid</span><span class="p">,</span>
					<span class="o">&amp;</span><span class="n">aclflag</span><span class="p">);</span>

		<span class="n">cFYI</span><span class="p">(</span><span class="n">DBG2</span><span class="p">,</span> <span class="s">&quot;build_sec_desc rc: %d&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Set the security descriptor */</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="n">set_cifs_acl</span><span class="p">(</span><span class="n">pnntsd</span><span class="p">,</span> <span class="n">secdesclen</span><span class="p">,</span> <span class="n">inode</span><span class="p">,</span>
						<span class="n">path</span><span class="p">,</span> <span class="n">aclflag</span><span class="p">);</span>
			<span class="n">cFYI</span><span class="p">(</span><span class="n">DBG2</span><span class="p">,</span> <span class="s">&quot;set_cifs_acl rc: %d&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">kfree</span><span class="p">(</span><span class="n">pnntsd</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">pntsd</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
